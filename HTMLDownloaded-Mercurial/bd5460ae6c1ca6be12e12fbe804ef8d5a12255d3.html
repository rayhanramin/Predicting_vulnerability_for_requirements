<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 21248:bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3" />
<meta property="og:url" content="/comm-central/rev/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3" />
<meta property="og:description" content="Bug 1199855 - Add Matrix as a supported protocol: Part 1 - Import Matrix JS SDK from github.com/matrix-org. r=clokep" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3">shortlog</a> |
<a href="/comm-central/log/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3">files</a> |
changeset |
<a href="/comm-central/raw-rev/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3">raw</a>  | <a href="/comm-central/archive/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1199855">Bug 1199855</a> - Add Matrix as a supported protocol: Part 1 - Import Matrix JS SDK from github.com/matrix-org. r=clokep
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#70;&#114;&#195;&#169;&#100;&#195;&#169;&#114;&#105;&#99;&#32;&#87;&#97;&#110;&#103;&#32;&#60;&#102;&#114;&#101;&#100;&#46;&#119;&#97;&#110;&#103;&#64;&#102;&#114;&#101;&#101;&#46;&#102;&#114;&#62;</td></tr>
<tr><td></td><td class="date age">Thu, 02 Mar 2017 12:58:00 +0100</td></tr>

<tr>
 <td>changeset 21248</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3">bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3</a></td>
</tr>



<tr>
<td>parent 21247</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/84e007d226a212a9e79d93fb644aa6a7e57d60a7">84e007d226a212a9e79d93fb644aa6a7e57d60a7</a>
</td>
</tr>

<tr>
<td>child 21249</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/b99d93143c49b92aaf252143ff1a64a8c38ec28b">b99d93143c49b92aaf252143ff1a64a8c38ec28b</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3">12907</a></td></tr>
<tr><td>push user</td><td>mozilla@jorgk.com</td></tr>
<tr><td>push date</td><td class="date age">Fri, 03 Mar 2017 00:15:51 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@e32e7215e0e7 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=e32e7215e0e726eeef616940d4e57b3db70755e6">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=e32e7215e0e726eeef616940d4e57b3db70755e6&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=e32e7215e0e726eeef616940d4e57b3db70755e6&newProject=comm-central&newRevision=bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=e32e7215e0e726eeef616940d4e57b3db70755e6&newProject=comm-central&newRevision=bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=e32e7215e0e726eeef616940d4e57b3db70755e6&newProject=comm-central&newRevision=bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28clokep%29&revcount=50">clokep</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1199855">1199855</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1199855">Bug 1199855</a> - Add Matrix as a supported protocol: Part 1 - Import Matrix JS SDK from github.com/matrix-org. r=clokep</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/README.txt">chat/protocols/matrix/matrix-sdk/README.txt</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/README.txt">file</a> |
<a href="/comm-central/annotate/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/README.txt">annotate</a> |
<a href="/comm-central/diff/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/README.txt">diff</a> |
<a href="/comm-central/comparison/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/README.txt">comparison</a> |
<a href="/comm-central/log/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/README.txt">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/another-json/another-json.js">chat/protocols/matrix/matrix-sdk/another-json/another-json.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/another-json/another-json.js">file</a> |
<a href="/comm-central/annotate/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/another-json/another-json.js">annotate</a> |
<a href="/comm-central/diff/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/another-json/another-json.js">diff</a> |
<a href="/comm-central/comparison/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/another-json/another-json.js">comparison</a> |
<a href="/comm-central/log/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/another-json/another-json.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/base-apis.js">chat/protocols/matrix/matrix-sdk/base-apis.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/base-apis.js">file</a> |
<a href="/comm-central/annotate/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/base-apis.js">annotate</a> |
<a href="/comm-central/diff/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/base-apis.js">diff</a> |
<a href="/comm-central/comparison/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/base-apis.js">comparison</a> |
<a href="/comm-central/log/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/base-apis.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/browser-request/index.js">chat/protocols/matrix/matrix-sdk/browser-request/index.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/browser-request/index.js">file</a> |
<a href="/comm-central/annotate/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/browser-request/index.js">annotate</a> |
<a href="/comm-central/diff/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/browser-request/index.js">diff</a> |
<a href="/comm-central/comparison/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/browser-request/index.js">comparison</a> |
<a href="/comm-central/log/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/browser-request/index.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/browserify/events.js">chat/protocols/matrix/matrix-sdk/browserify/events.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/browserify/events.js">file</a> |
<a href="/comm-central/annotate/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/browserify/events.js">annotate</a> |
<a href="/comm-central/diff/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/browserify/events.js">diff</a> |
<a href="/comm-central/comparison/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/browserify/events.js">comparison</a> |
<a href="/comm-central/log/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/browserify/events.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/browserify/punycode.js">chat/protocols/matrix/matrix-sdk/browserify/punycode.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/browserify/punycode.js">file</a> |
<a href="/comm-central/annotate/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/browserify/punycode.js">annotate</a> |
<a href="/comm-central/diff/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/browserify/punycode.js">diff</a> |
<a href="/comm-central/comparison/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/browserify/punycode.js">comparison</a> |
<a href="/comm-central/log/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/browserify/punycode.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/browserify/querystring/decode.js">chat/protocols/matrix/matrix-sdk/browserify/querystring/decode.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/browserify/querystring/decode.js">file</a> |
<a href="/comm-central/annotate/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/browserify/querystring/decode.js">annotate</a> |
<a href="/comm-central/diff/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/browserify/querystring/decode.js">diff</a> |
<a href="/comm-central/comparison/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/browserify/querystring/decode.js">comparison</a> |
<a href="/comm-central/log/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/browserify/querystring/decode.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/browserify/querystring/encode.js">chat/protocols/matrix/matrix-sdk/browserify/querystring/encode.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/browserify/querystring/encode.js">file</a> |
<a href="/comm-central/annotate/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/browserify/querystring/encode.js">annotate</a> |
<a href="/comm-central/diff/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/browserify/querystring/encode.js">diff</a> |
<a href="/comm-central/comparison/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/browserify/querystring/encode.js">comparison</a> |
<a href="/comm-central/log/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/browserify/querystring/encode.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/browserify/querystring/index.js">chat/protocols/matrix/matrix-sdk/browserify/querystring/index.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/browserify/querystring/index.js">file</a> |
<a href="/comm-central/annotate/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/browserify/querystring/index.js">annotate</a> |
<a href="/comm-central/diff/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/browserify/querystring/index.js">diff</a> |
<a href="/comm-central/comparison/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/browserify/querystring/index.js">comparison</a> |
<a href="/comm-central/log/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/browserify/querystring/index.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/browserify/url.js">chat/protocols/matrix/matrix-sdk/browserify/url.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/browserify/url.js">file</a> |
<a href="/comm-central/annotate/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/browserify/url.js">annotate</a> |
<a href="/comm-central/diff/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/browserify/url.js">diff</a> |
<a href="/comm-central/comparison/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/browserify/url.js">comparison</a> |
<a href="/comm-central/log/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/browserify/url.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/client.js">chat/protocols/matrix/matrix-sdk/client.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/client.js">file</a> |
<a href="/comm-central/annotate/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/client.js">annotate</a> |
<a href="/comm-central/diff/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/client.js">diff</a> |
<a href="/comm-central/comparison/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/client.js">comparison</a> |
<a href="/comm-central/log/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/client.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/content-repo.js">chat/protocols/matrix/matrix-sdk/content-repo.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/content-repo.js">file</a> |
<a href="/comm-central/annotate/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/content-repo.js">annotate</a> |
<a href="/comm-central/diff/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/content-repo.js">diff</a> |
<a href="/comm-central/comparison/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/content-repo.js">comparison</a> |
<a href="/comm-central/log/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/content-repo.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/crypto/OlmDevice.js">chat/protocols/matrix/matrix-sdk/crypto/OlmDevice.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/crypto/OlmDevice.js">file</a> |
<a href="/comm-central/annotate/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/crypto/OlmDevice.js">annotate</a> |
<a href="/comm-central/diff/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/crypto/OlmDevice.js">diff</a> |
<a href="/comm-central/comparison/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/crypto/OlmDevice.js">comparison</a> |
<a href="/comm-central/log/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/crypto/OlmDevice.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/crypto/algorithms/base.js">chat/protocols/matrix/matrix-sdk/crypto/algorithms/base.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/crypto/algorithms/base.js">file</a> |
<a href="/comm-central/annotate/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/crypto/algorithms/base.js">annotate</a> |
<a href="/comm-central/diff/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/crypto/algorithms/base.js">diff</a> |
<a href="/comm-central/comparison/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/crypto/algorithms/base.js">comparison</a> |
<a href="/comm-central/log/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/crypto/algorithms/base.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/crypto/algorithms/index.js">chat/protocols/matrix/matrix-sdk/crypto/algorithms/index.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/crypto/algorithms/index.js">file</a> |
<a href="/comm-central/annotate/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/crypto/algorithms/index.js">annotate</a> |
<a href="/comm-central/diff/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/crypto/algorithms/index.js">diff</a> |
<a href="/comm-central/comparison/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/crypto/algorithms/index.js">comparison</a> |
<a href="/comm-central/log/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/crypto/algorithms/index.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/crypto/algorithms/megolm.js">chat/protocols/matrix/matrix-sdk/crypto/algorithms/megolm.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/crypto/algorithms/megolm.js">file</a> |
<a href="/comm-central/annotate/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/crypto/algorithms/megolm.js">annotate</a> |
<a href="/comm-central/diff/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/crypto/algorithms/megolm.js">diff</a> |
<a href="/comm-central/comparison/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/crypto/algorithms/megolm.js">comparison</a> |
<a href="/comm-central/log/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/crypto/algorithms/megolm.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/crypto/algorithms/olm.js">chat/protocols/matrix/matrix-sdk/crypto/algorithms/olm.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/crypto/algorithms/olm.js">file</a> |
<a href="/comm-central/annotate/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/crypto/algorithms/olm.js">annotate</a> |
<a href="/comm-central/diff/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/crypto/algorithms/olm.js">diff</a> |
<a href="/comm-central/comparison/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/crypto/algorithms/olm.js">comparison</a> |
<a href="/comm-central/log/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/crypto/algorithms/olm.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/crypto/deviceinfo.js">chat/protocols/matrix/matrix-sdk/crypto/deviceinfo.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/crypto/deviceinfo.js">file</a> |
<a href="/comm-central/annotate/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/crypto/deviceinfo.js">annotate</a> |
<a href="/comm-central/diff/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/crypto/deviceinfo.js">diff</a> |
<a href="/comm-central/comparison/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/crypto/deviceinfo.js">comparison</a> |
<a href="/comm-central/log/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/crypto/deviceinfo.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/crypto/index.js">chat/protocols/matrix/matrix-sdk/crypto/index.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/crypto/index.js">file</a> |
<a href="/comm-central/annotate/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/crypto/index.js">annotate</a> |
<a href="/comm-central/diff/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/crypto/index.js">diff</a> |
<a href="/comm-central/comparison/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/crypto/index.js">comparison</a> |
<a href="/comm-central/log/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/crypto/index.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/crypto/olmlib.js">chat/protocols/matrix/matrix-sdk/crypto/olmlib.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/crypto/olmlib.js">file</a> |
<a href="/comm-central/annotate/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/crypto/olmlib.js">annotate</a> |
<a href="/comm-central/diff/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/crypto/olmlib.js">diff</a> |
<a href="/comm-central/comparison/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/crypto/olmlib.js">comparison</a> |
<a href="/comm-central/log/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/crypto/olmlib.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/filter-component.js">chat/protocols/matrix/matrix-sdk/filter-component.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/filter-component.js">file</a> |
<a href="/comm-central/annotate/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/filter-component.js">annotate</a> |
<a href="/comm-central/diff/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/filter-component.js">diff</a> |
<a href="/comm-central/comparison/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/filter-component.js">comparison</a> |
<a href="/comm-central/log/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/filter-component.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/filter.js">chat/protocols/matrix/matrix-sdk/filter.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/filter.js">file</a> |
<a href="/comm-central/annotate/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/filter.js">annotate</a> |
<a href="/comm-central/diff/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/filter.js">diff</a> |
<a href="/comm-central/comparison/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/filter.js">comparison</a> |
<a href="/comm-central/log/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/filter.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/http-api.js">chat/protocols/matrix/matrix-sdk/http-api.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/http-api.js">file</a> |
<a href="/comm-central/annotate/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/http-api.js">annotate</a> |
<a href="/comm-central/diff/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/http-api.js">diff</a> |
<a href="/comm-central/comparison/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/http-api.js">comparison</a> |
<a href="/comm-central/log/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/http-api.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/interactive-auth.js">chat/protocols/matrix/matrix-sdk/interactive-auth.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/interactive-auth.js">file</a> |
<a href="/comm-central/annotate/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/interactive-auth.js">annotate</a> |
<a href="/comm-central/diff/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/interactive-auth.js">diff</a> |
<a href="/comm-central/comparison/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/interactive-auth.js">comparison</a> |
<a href="/comm-central/log/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/interactive-auth.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/matrix.js">chat/protocols/matrix/matrix-sdk/matrix.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/matrix.js">file</a> |
<a href="/comm-central/annotate/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/matrix.js">annotate</a> |
<a href="/comm-central/diff/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/matrix.js">diff</a> |
<a href="/comm-central/comparison/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/matrix.js">comparison</a> |
<a href="/comm-central/log/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/matrix.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/models/event-context.js">chat/protocols/matrix/matrix-sdk/models/event-context.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/models/event-context.js">file</a> |
<a href="/comm-central/annotate/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/models/event-context.js">annotate</a> |
<a href="/comm-central/diff/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/models/event-context.js">diff</a> |
<a href="/comm-central/comparison/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/models/event-context.js">comparison</a> |
<a href="/comm-central/log/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/models/event-context.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/models/event-timeline-set.js">chat/protocols/matrix/matrix-sdk/models/event-timeline-set.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/models/event-timeline-set.js">file</a> |
<a href="/comm-central/annotate/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/models/event-timeline-set.js">annotate</a> |
<a href="/comm-central/diff/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/models/event-timeline-set.js">diff</a> |
<a href="/comm-central/comparison/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/models/event-timeline-set.js">comparison</a> |
<a href="/comm-central/log/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/models/event-timeline-set.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/models/event-timeline.js">chat/protocols/matrix/matrix-sdk/models/event-timeline.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/models/event-timeline.js">file</a> |
<a href="/comm-central/annotate/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/models/event-timeline.js">annotate</a> |
<a href="/comm-central/diff/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/models/event-timeline.js">diff</a> |
<a href="/comm-central/comparison/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/models/event-timeline.js">comparison</a> |
<a href="/comm-central/log/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/models/event-timeline.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/models/event.js">chat/protocols/matrix/matrix-sdk/models/event.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/models/event.js">file</a> |
<a href="/comm-central/annotate/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/models/event.js">annotate</a> |
<a href="/comm-central/diff/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/models/event.js">diff</a> |
<a href="/comm-central/comparison/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/models/event.js">comparison</a> |
<a href="/comm-central/log/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/models/event.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/models/room-member.js">chat/protocols/matrix/matrix-sdk/models/room-member.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/models/room-member.js">file</a> |
<a href="/comm-central/annotate/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/models/room-member.js">annotate</a> |
<a href="/comm-central/diff/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/models/room-member.js">diff</a> |
<a href="/comm-central/comparison/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/models/room-member.js">comparison</a> |
<a href="/comm-central/log/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/models/room-member.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/models/room-state.js">chat/protocols/matrix/matrix-sdk/models/room-state.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/models/room-state.js">file</a> |
<a href="/comm-central/annotate/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/models/room-state.js">annotate</a> |
<a href="/comm-central/diff/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/models/room-state.js">diff</a> |
<a href="/comm-central/comparison/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/models/room-state.js">comparison</a> |
<a href="/comm-central/log/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/models/room-state.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/models/room-summary.js">chat/protocols/matrix/matrix-sdk/models/room-summary.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/models/room-summary.js">file</a> |
<a href="/comm-central/annotate/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/models/room-summary.js">annotate</a> |
<a href="/comm-central/diff/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/models/room-summary.js">diff</a> |
<a href="/comm-central/comparison/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/models/room-summary.js">comparison</a> |
<a href="/comm-central/log/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/models/room-summary.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/models/room.js">chat/protocols/matrix/matrix-sdk/models/room.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/models/room.js">file</a> |
<a href="/comm-central/annotate/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/models/room.js">annotate</a> |
<a href="/comm-central/diff/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/models/room.js">diff</a> |
<a href="/comm-central/comparison/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/models/room.js">comparison</a> |
<a href="/comm-central/log/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/models/room.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/models/search-result.js">chat/protocols/matrix/matrix-sdk/models/search-result.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/models/search-result.js">file</a> |
<a href="/comm-central/annotate/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/models/search-result.js">annotate</a> |
<a href="/comm-central/diff/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/models/search-result.js">diff</a> |
<a href="/comm-central/comparison/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/models/search-result.js">comparison</a> |
<a href="/comm-central/log/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/models/search-result.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/models/user.js">chat/protocols/matrix/matrix-sdk/models/user.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/models/user.js">file</a> |
<a href="/comm-central/annotate/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/models/user.js">annotate</a> |
<a href="/comm-central/diff/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/models/user.js">diff</a> |
<a href="/comm-central/comparison/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/models/user.js">comparison</a> |
<a href="/comm-central/log/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/models/user.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/pushprocessor.js">chat/protocols/matrix/matrix-sdk/pushprocessor.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/pushprocessor.js">file</a> |
<a href="/comm-central/annotate/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/pushprocessor.js">annotate</a> |
<a href="/comm-central/diff/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/pushprocessor.js">diff</a> |
<a href="/comm-central/comparison/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/pushprocessor.js">comparison</a> |
<a href="/comm-central/log/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/pushprocessor.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/q/q.js">chat/protocols/matrix/matrix-sdk/q/q.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/q/q.js">file</a> |
<a href="/comm-central/annotate/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/q/q.js">annotate</a> |
<a href="/comm-central/diff/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/q/q.js">diff</a> |
<a href="/comm-central/comparison/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/q/q.js">comparison</a> |
<a href="/comm-central/log/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/q/q.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/q/queue.js">chat/protocols/matrix/matrix-sdk/q/queue.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/q/queue.js">file</a> |
<a href="/comm-central/annotate/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/q/queue.js">annotate</a> |
<a href="/comm-central/diff/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/q/queue.js">diff</a> |
<a href="/comm-central/comparison/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/q/queue.js">comparison</a> |
<a href="/comm-central/log/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/q/queue.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/realtime-callbacks.js">chat/protocols/matrix/matrix-sdk/realtime-callbacks.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/realtime-callbacks.js">file</a> |
<a href="/comm-central/annotate/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/realtime-callbacks.js">annotate</a> |
<a href="/comm-central/diff/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/realtime-callbacks.js">diff</a> |
<a href="/comm-central/comparison/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/realtime-callbacks.js">comparison</a> |
<a href="/comm-central/log/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/realtime-callbacks.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/scheduler.js">chat/protocols/matrix/matrix-sdk/scheduler.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/scheduler.js">file</a> |
<a href="/comm-central/annotate/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/scheduler.js">annotate</a> |
<a href="/comm-central/diff/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/scheduler.js">diff</a> |
<a href="/comm-central/comparison/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/scheduler.js">comparison</a> |
<a href="/comm-central/log/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/scheduler.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/store/memory.js">chat/protocols/matrix/matrix-sdk/store/memory.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/store/memory.js">file</a> |
<a href="/comm-central/annotate/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/store/memory.js">annotate</a> |
<a href="/comm-central/diff/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/store/memory.js">diff</a> |
<a href="/comm-central/comparison/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/store/memory.js">comparison</a> |
<a href="/comm-central/log/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/store/memory.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/store/session/webstorage.js">chat/protocols/matrix/matrix-sdk/store/session/webstorage.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/store/session/webstorage.js">file</a> |
<a href="/comm-central/annotate/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/store/session/webstorage.js">annotate</a> |
<a href="/comm-central/diff/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/store/session/webstorage.js">diff</a> |
<a href="/comm-central/comparison/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/store/session/webstorage.js">comparison</a> |
<a href="/comm-central/log/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/store/session/webstorage.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/store/stub.js">chat/protocols/matrix/matrix-sdk/store/stub.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/store/stub.js">file</a> |
<a href="/comm-central/annotate/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/store/stub.js">annotate</a> |
<a href="/comm-central/diff/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/store/stub.js">diff</a> |
<a href="/comm-central/comparison/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/store/stub.js">comparison</a> |
<a href="/comm-central/log/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/store/stub.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/store/webstorage.js">chat/protocols/matrix/matrix-sdk/store/webstorage.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/store/webstorage.js">file</a> |
<a href="/comm-central/annotate/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/store/webstorage.js">annotate</a> |
<a href="/comm-central/diff/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/store/webstorage.js">diff</a> |
<a href="/comm-central/comparison/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/store/webstorage.js">comparison</a> |
<a href="/comm-central/log/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/store/webstorage.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/sync.js">chat/protocols/matrix/matrix-sdk/sync.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/sync.js">file</a> |
<a href="/comm-central/annotate/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/sync.js">annotate</a> |
<a href="/comm-central/diff/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/sync.js">diff</a> |
<a href="/comm-central/comparison/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/sync.js">comparison</a> |
<a href="/comm-central/log/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/sync.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/timeline-window.js">chat/protocols/matrix/matrix-sdk/timeline-window.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/timeline-window.js">file</a> |
<a href="/comm-central/annotate/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/timeline-window.js">annotate</a> |
<a href="/comm-central/diff/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/timeline-window.js">diff</a> |
<a href="/comm-central/comparison/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/timeline-window.js">comparison</a> |
<a href="/comm-central/log/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/timeline-window.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/utils.js">chat/protocols/matrix/matrix-sdk/utils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/utils.js">file</a> |
<a href="/comm-central/annotate/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/utils.js">annotate</a> |
<a href="/comm-central/diff/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/utils.js">diff</a> |
<a href="/comm-central/comparison/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/utils.js">comparison</a> |
<a href="/comm-central/log/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/utils.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/webrtc/call.js">chat/protocols/matrix/matrix-sdk/webrtc/call.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/webrtc/call.js">file</a> |
<a href="/comm-central/annotate/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/webrtc/call.js">annotate</a> |
<a href="/comm-central/diff/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/webrtc/call.js">diff</a> |
<a href="/comm-central/comparison/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/webrtc/call.js">comparison</a> |
<a href="/comm-central/log/bd5460ae6c1ca6be12e12fbe804ef8d5a12255d3/chat/protocols/matrix/matrix-sdk/webrtc/call.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1">new file mode 100644</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineminus">--- /dev/null</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineplus">+++ b/chat/protocols/matrix/matrix-sdk/README.txt</span>
<a href="#l1.4"></a><span id="l1.4" class="difflineat">@@ -0,0 +1,22 @@</span>
<a href="#l1.5"></a><span id="l1.5" class="difflineplus">+This directory contains the Matrix Client-Server SDK for Javascript available</span>
<a href="#l1.6"></a><span id="l1.6" class="difflineplus">+at https://github.com/matrix-org/matrix-js-sdk/. Current version is v0.7.0.</span>
<a href="#l1.7"></a><span id="l1.7" class="difflineplus">+</span>
<a href="#l1.8"></a><span id="l1.8" class="difflineplus">+In addition, the following npm dependencies are included:</span>
<a href="#l1.9"></a><span id="l1.9" class="difflineplus">+</span>
<a href="#l1.10"></a><span id="l1.10" class="difflineplus">+* another-json/: https://www.npmjs.com/package/another-json/</span>
<a href="#l1.11"></a><span id="l1.11" class="difflineplus">+* browser-request/: https://www.npmjs.com/package/browser-request</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+* browserify/: https://www.npmjs.com/package/browserify</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+  * browserify/events.js: https://www.npmjs.com/package/events</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+  * browserify/punycode.js: https://github.com/bestiejs/punycode.js</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+  * browserify/querystring/: https://www.npmjs.com/package/querystring-es3</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineplus">+  * browserify/url/: https://www.npmjs.com/package/url</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineplus">+* q/: https://www.npmjs.com/package/q</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineplus">+</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineplus">+There is not any automated way to update the libraries. Files have been obtained</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineplus">+by downloading the matrix-js-sdk release, compiling it with npm (to obtain the</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineplus">+dependencies), excluding some unneeded files from the dependencies and</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineplus">+optionally adding copyright notices from the original repository mentioned on</span>
<a href="#l1.23"></a><span id="l1.23" class="difflineplus">+the npm page.</span>
<a href="#l1.24"></a><span id="l1.24" class="difflineplus">+</span>
<a href="#l1.25"></a><span id="l1.25" class="difflineplus">+To make the whole thing work, some file paths and global variables are defined</span>
<a href="#l1.26"></a><span id="l1.26" class="difflineplus">+in chat/protocols/matrix/matrix-sdk.jsm.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1">new file mode 100644</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineminus">--- /dev/null</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineplus">+++ b/chat/protocols/matrix/matrix-sdk/another-json/another-json.js</span>
<a href="#l2.4"></a><span id="l2.4" class="difflineat">@@ -0,0 +1,93 @@</span>
<a href="#l2.5"></a><span id="l2.5" class="difflineplus">+/* Copyright 2015 Mark Haines</span>
<a href="#l2.6"></a><span id="l2.6" class="difflineplus">+ *</span>
<a href="#l2.7"></a><span id="l2.7" class="difflineplus">+ * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<a href="#l2.8"></a><span id="l2.8" class="difflineplus">+ * you may not use this file except in compliance with the License.</span>
<a href="#l2.9"></a><span id="l2.9" class="difflineplus">+ *  You may obtain a copy of the License at</span>
<a href="#l2.10"></a><span id="l2.10" class="difflineplus">+ *</span>
<a href="#l2.11"></a><span id="l2.11" class="difflineplus">+ * http://www.apache.org/licenses/LICENSE-2.0</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+ *</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+ * Unless required by applicable law or agreed to in writing, software</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+ * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineplus">+ * See the License for the specific language governing permissions and</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineplus">+ * limitations under the License.</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineplus">+ */</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineplus">+</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineplus">+'use strict';</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineplus">+</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineplus">+var escaped = /[\\\&quot;\x00-\x1F]/g;</span>
<a href="#l2.23"></a><span id="l2.23" class="difflineplus">+var escapes = {};</span>
<a href="#l2.24"></a><span id="l2.24" class="difflineplus">+for (var i = 0; i &lt; 0x20; ++i) {</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineplus">+    escapes[String.fromCharCode(i)] = (</span>
<a href="#l2.26"></a><span id="l2.26" class="difflineplus">+        '\\U' + ('0000' + i.toString(16)).slice(-4).toUpperCase()</span>
<a href="#l2.27"></a><span id="l2.27" class="difflineplus">+    );</span>
<a href="#l2.28"></a><span id="l2.28" class="difflineplus">+}</span>
<a href="#l2.29"></a><span id="l2.29" class="difflineplus">+escapes['\b'] = '\\b';</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineplus">+escapes['\t'] = '\\t';</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineplus">+escapes['\n'] = '\\n';</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineplus">+escapes['\f'] = '\\f';</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineplus">+escapes['\r'] = '\\r';</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineplus">+escapes['\&quot;'] = '\\\&quot;';</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineplus">+escapes['\\'] = '\\\\';</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineplus">+</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineplus">+function escapeString(value) {</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineplus">+    escaped.lastIndex = 0;</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineplus">+    return value.replace(escaped, function(c) { return escapes[c]; });</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineplus">+}</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineplus">+</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineplus">+function stringify(value) {</span>
<a href="#l2.43"></a><span id="l2.43" class="difflineplus">+    switch (typeof value) {</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineplus">+        case 'string':</span>
<a href="#l2.45"></a><span id="l2.45" class="difflineplus">+            return '&quot;' + escapeString(value) + '&quot;';</span>
<a href="#l2.46"></a><span id="l2.46" class="difflineplus">+        case 'number':</span>
<a href="#l2.47"></a><span id="l2.47" class="difflineplus">+            return isFinite(value) ? value : 'null';</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineplus">+        case 'boolean':</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineplus">+            return value;</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineplus">+        case 'object':</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineplus">+            if (value === null) {</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineplus">+                return 'null';</span>
<a href="#l2.53"></a><span id="l2.53" class="difflineplus">+            }</span>
<a href="#l2.54"></a><span id="l2.54" class="difflineplus">+            if (Array.isArray(value)) {</span>
<a href="#l2.55"></a><span id="l2.55" class="difflineplus">+                return stringifyArray(value);</span>
<a href="#l2.56"></a><span id="l2.56" class="difflineplus">+            }</span>
<a href="#l2.57"></a><span id="l2.57" class="difflineplus">+            return stringifyObject(value);</span>
<a href="#l2.58"></a><span id="l2.58" class="difflineplus">+        default:</span>
<a href="#l2.59"></a><span id="l2.59" class="difflineplus">+            throw new Error('Cannot stringify: ' + typeof value);</span>
<a href="#l2.60"></a><span id="l2.60" class="difflineplus">+    }</span>
<a href="#l2.61"></a><span id="l2.61" class="difflineplus">+}</span>
<a href="#l2.62"></a><span id="l2.62" class="difflineplus">+</span>
<a href="#l2.63"></a><span id="l2.63" class="difflineplus">+function stringifyArray(array) {</span>
<a href="#l2.64"></a><span id="l2.64" class="difflineplus">+    var sep = '[';</span>
<a href="#l2.65"></a><span id="l2.65" class="difflineplus">+    var result = '';</span>
<a href="#l2.66"></a><span id="l2.66" class="difflineplus">+    for (var i = 0; i &lt; array.length; ++i) {</span>
<a href="#l2.67"></a><span id="l2.67" class="difflineplus">+        result += sep;</span>
<a href="#l2.68"></a><span id="l2.68" class="difflineplus">+        sep = ',';</span>
<a href="#l2.69"></a><span id="l2.69" class="difflineplus">+        result += stringify(array[i]);</span>
<a href="#l2.70"></a><span id="l2.70" class="difflineplus">+    }</span>
<a href="#l2.71"></a><span id="l2.71" class="difflineplus">+    if (sep != ',') {</span>
<a href="#l2.72"></a><span id="l2.72" class="difflineplus">+        return '[]';</span>
<a href="#l2.73"></a><span id="l2.73" class="difflineplus">+    } else {</span>
<a href="#l2.74"></a><span id="l2.74" class="difflineplus">+        return result + ']';</span>
<a href="#l2.75"></a><span id="l2.75" class="difflineplus">+    }</span>
<a href="#l2.76"></a><span id="l2.76" class="difflineplus">+}</span>
<a href="#l2.77"></a><span id="l2.77" class="difflineplus">+</span>
<a href="#l2.78"></a><span id="l2.78" class="difflineplus">+function stringifyObject(object) {</span>
<a href="#l2.79"></a><span id="l2.79" class="difflineplus">+    var sep = '{';</span>
<a href="#l2.80"></a><span id="l2.80" class="difflineplus">+    var result = '';</span>
<a href="#l2.81"></a><span id="l2.81" class="difflineplus">+    var keys = Object.keys(object);</span>
<a href="#l2.82"></a><span id="l2.82" class="difflineplus">+    keys.sort();</span>
<a href="#l2.83"></a><span id="l2.83" class="difflineplus">+    for (var i = 0; i &lt; keys.length; ++i) {</span>
<a href="#l2.84"></a><span id="l2.84" class="difflineplus">+        var key = keys[i];</span>
<a href="#l2.85"></a><span id="l2.85" class="difflineplus">+        result += sep + '&quot;' + escapeString(key) + '&quot;:';</span>
<a href="#l2.86"></a><span id="l2.86" class="difflineplus">+        sep = ',';</span>
<a href="#l2.87"></a><span id="l2.87" class="difflineplus">+        result += stringify(object[key]);</span>
<a href="#l2.88"></a><span id="l2.88" class="difflineplus">+    }</span>
<a href="#l2.89"></a><span id="l2.89" class="difflineplus">+    if (sep != ',') {</span>
<a href="#l2.90"></a><span id="l2.90" class="difflineplus">+        return '{}';</span>
<a href="#l2.91"></a><span id="l2.91" class="difflineplus">+    } else {</span>
<a href="#l2.92"></a><span id="l2.92" class="difflineplus">+        return result + '}';</span>
<a href="#l2.93"></a><span id="l2.93" class="difflineplus">+    }</span>
<a href="#l2.94"></a><span id="l2.94" class="difflineplus">+}</span>
<a href="#l2.95"></a><span id="l2.95" class="difflineplus">+</span>
<a href="#l2.96"></a><span id="l2.96" class="difflineplus">+/** */</span>
<a href="#l2.97"></a><span id="l2.97" class="difflineplus">+module.exports = {stringify: stringify};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1">new file mode 100644</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineminus">--- /dev/null</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineplus">+++ b/chat/protocols/matrix/matrix-sdk/base-apis.js</span>
<a href="#l3.4"></a><span id="l3.4" class="difflineat">@@ -0,0 +1,1134 @@</span>
<a href="#l3.5"></a><span id="l3.5" class="difflineplus">+/*</span>
<a href="#l3.6"></a><span id="l3.6" class="difflineplus">+Copyright 2015, 2016 OpenMarket Ltd</span>
<a href="#l3.7"></a><span id="l3.7" class="difflineplus">+</span>
<a href="#l3.8"></a><span id="l3.8" class="difflineplus">+Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<a href="#l3.9"></a><span id="l3.9" class="difflineplus">+you may not use this file except in compliance with the License.</span>
<a href="#l3.10"></a><span id="l3.10" class="difflineplus">+You may obtain a copy of the License at</span>
<a href="#l3.11"></a><span id="l3.11" class="difflineplus">+</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+    http://www.apache.org/licenses/LICENSE-2.0</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+Unless required by applicable law or agreed to in writing, software</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineplus">+See the License for the specific language governing permissions and</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineplus">+limitations under the License.</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineplus">+*/</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineplus">+&quot;use strict&quot;;</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineplus">+</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineplus">+/**</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineplus">+ * This is an internal module. MatrixBaseApis is currently only meant to be used</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineplus">+ * by {@link client~MatrixClient}.</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineplus">+ *</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineplus">+ * @module base-apis</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineplus">+ */</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineplus">+</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineplus">+var httpApi = require(&quot;./http-api&quot;);</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineplus">+var utils = require(&quot;./utils&quot;);</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineplus">+</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineplus">+/**</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineplus">+ * Low-level wrappers for the Matrix APIs</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineplus">+ *</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineplus">+ * @constructor</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineplus">+ *</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineplus">+ * @param {Object} opts Configuration options</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineplus">+ *</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineplus">+ * @param {string} opts.baseUrl Required. The base URL to the client-server</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineplus">+ * HTTP API.</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineplus">+ *</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineplus">+ * @param {string} opts.idBaseUrl Optional. The base identity server URL for</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineplus">+ * identity server requests.</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineplus">+ *</span>
<a href="#l3.45"></a><span id="l3.45" class="difflineplus">+ * @param {Function} opts.request Required. The function to invoke for HTTP</span>
<a href="#l3.46"></a><span id="l3.46" class="difflineplus">+ * requests. The value of this property is typically &lt;code&gt;require(&quot;request&quot;)</span>
<a href="#l3.47"></a><span id="l3.47" class="difflineplus">+ * &lt;/code&gt; as it returns a function which meets the required interface. See</span>
<a href="#l3.48"></a><span id="l3.48" class="difflineplus">+ * {@link requestFunction} for more information.</span>
<a href="#l3.49"></a><span id="l3.49" class="difflineplus">+ *</span>
<a href="#l3.50"></a><span id="l3.50" class="difflineplus">+ * @param {string} opts.accessToken The access_token for this user.</span>
<a href="#l3.51"></a><span id="l3.51" class="difflineplus">+ *</span>
<a href="#l3.52"></a><span id="l3.52" class="difflineplus">+ * @param {Object} opts.queryParams Optional. Extra query parameters to append</span>
<a href="#l3.53"></a><span id="l3.53" class="difflineplus">+ * to all requests with this client. Useful for application services which require</span>
<a href="#l3.54"></a><span id="l3.54" class="difflineplus">+ * &lt;code&gt;?user_id=&lt;/code&gt;.</span>
<a href="#l3.55"></a><span id="l3.55" class="difflineplus">+ *</span>
<a href="#l3.56"></a><span id="l3.56" class="difflineplus">+ */</span>
<a href="#l3.57"></a><span id="l3.57" class="difflineplus">+function MatrixBaseApis(opts) {</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineplus">+    utils.checkObjectHasKeys(opts, [&quot;baseUrl&quot;, &quot;request&quot;]);</span>
<a href="#l3.59"></a><span id="l3.59" class="difflineplus">+</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineplus">+    this.baseUrl = opts.baseUrl;</span>
<a href="#l3.61"></a><span id="l3.61" class="difflineplus">+    this.idBaseUrl = opts.idBaseUrl;</span>
<a href="#l3.62"></a><span id="l3.62" class="difflineplus">+</span>
<a href="#l3.63"></a><span id="l3.63" class="difflineplus">+    var httpOpts = {</span>
<a href="#l3.64"></a><span id="l3.64" class="difflineplus">+        baseUrl: opts.baseUrl,</span>
<a href="#l3.65"></a><span id="l3.65" class="difflineplus">+        idBaseUrl: opts.idBaseUrl,</span>
<a href="#l3.66"></a><span id="l3.66" class="difflineplus">+        accessToken: opts.accessToken,</span>
<a href="#l3.67"></a><span id="l3.67" class="difflineplus">+        request: opts.request,</span>
<a href="#l3.68"></a><span id="l3.68" class="difflineplus">+        prefix: httpApi.PREFIX_R0,</span>
<a href="#l3.69"></a><span id="l3.69" class="difflineplus">+        onlyData: true,</span>
<a href="#l3.70"></a><span id="l3.70" class="difflineplus">+        extraParams: opts.queryParams</span>
<a href="#l3.71"></a><span id="l3.71" class="difflineplus">+    };</span>
<a href="#l3.72"></a><span id="l3.72" class="difflineplus">+    this._http = new httpApi.MatrixHttpApi(this, httpOpts);</span>
<a href="#l3.73"></a><span id="l3.73" class="difflineplus">+</span>
<a href="#l3.74"></a><span id="l3.74" class="difflineplus">+    this._txnCtr = 0;</span>
<a href="#l3.75"></a><span id="l3.75" class="difflineplus">+}</span>
<a href="#l3.76"></a><span id="l3.76" class="difflineplus">+</span>
<a href="#l3.77"></a><span id="l3.77" class="difflineplus">+/**</span>
<a href="#l3.78"></a><span id="l3.78" class="difflineplus">+ * Get the Homeserver URL of this client</span>
<a href="#l3.79"></a><span id="l3.79" class="difflineplus">+ * @return {string} Homeserver URL of this client</span>
<a href="#l3.80"></a><span id="l3.80" class="difflineplus">+ */</span>
<a href="#l3.81"></a><span id="l3.81" class="difflineplus">+MatrixBaseApis.prototype.getHomeserverUrl = function() {</span>
<a href="#l3.82"></a><span id="l3.82" class="difflineplus">+    return this.baseUrl;</span>
<a href="#l3.83"></a><span id="l3.83" class="difflineplus">+};</span>
<a href="#l3.84"></a><span id="l3.84" class="difflineplus">+</span>
<a href="#l3.85"></a><span id="l3.85" class="difflineplus">+/**</span>
<a href="#l3.86"></a><span id="l3.86" class="difflineplus">+ * Get the Identity Server URL of this client</span>
<a href="#l3.87"></a><span id="l3.87" class="difflineplus">+ * @return {string} Identity Server URL of this client</span>
<a href="#l3.88"></a><span id="l3.88" class="difflineplus">+ */</span>
<a href="#l3.89"></a><span id="l3.89" class="difflineplus">+MatrixBaseApis.prototype.getIdentityServerUrl = function() {</span>
<a href="#l3.90"></a><span id="l3.90" class="difflineplus">+    return this.idBaseUrl;</span>
<a href="#l3.91"></a><span id="l3.91" class="difflineplus">+};</span>
<a href="#l3.92"></a><span id="l3.92" class="difflineplus">+</span>
<a href="#l3.93"></a><span id="l3.93" class="difflineplus">+/**</span>
<a href="#l3.94"></a><span id="l3.94" class="difflineplus">+ * Get the access token associated with this account.</span>
<a href="#l3.95"></a><span id="l3.95" class="difflineplus">+ * @return {?String} The access_token or null</span>
<a href="#l3.96"></a><span id="l3.96" class="difflineplus">+ */</span>
<a href="#l3.97"></a><span id="l3.97" class="difflineplus">+MatrixBaseApis.prototype.getAccessToken = function() {</span>
<a href="#l3.98"></a><span id="l3.98" class="difflineplus">+    return this._http.opts.accessToken || null;</span>
<a href="#l3.99"></a><span id="l3.99" class="difflineplus">+};</span>
<a href="#l3.100"></a><span id="l3.100" class="difflineplus">+</span>
<a href="#l3.101"></a><span id="l3.101" class="difflineplus">+/**</span>
<a href="#l3.102"></a><span id="l3.102" class="difflineplus">+ * @return {boolean} true if there is a valid access_token for this client.</span>
<a href="#l3.103"></a><span id="l3.103" class="difflineplus">+ */</span>
<a href="#l3.104"></a><span id="l3.104" class="difflineplus">+MatrixBaseApis.prototype.isLoggedIn = function() {</span>
<a href="#l3.105"></a><span id="l3.105" class="difflineplus">+    return this._http.opts.accessToken !== undefined;</span>
<a href="#l3.106"></a><span id="l3.106" class="difflineplus">+};</span>
<a href="#l3.107"></a><span id="l3.107" class="difflineplus">+</span>
<a href="#l3.108"></a><span id="l3.108" class="difflineplus">+/**</span>
<a href="#l3.109"></a><span id="l3.109" class="difflineplus">+ * Make up a new transaction id</span>
<a href="#l3.110"></a><span id="l3.110" class="difflineplus">+ *</span>
<a href="#l3.111"></a><span id="l3.111" class="difflineplus">+ * @return {string} a new, unique, transaction id</span>
<a href="#l3.112"></a><span id="l3.112" class="difflineplus">+ */</span>
<a href="#l3.113"></a><span id="l3.113" class="difflineplus">+MatrixBaseApis.prototype.makeTxnId = function() {</span>
<a href="#l3.114"></a><span id="l3.114" class="difflineplus">+    return &quot;m&quot; + new Date().getTime() + &quot;.&quot; + (this._txnCtr++);</span>
<a href="#l3.115"></a><span id="l3.115" class="difflineplus">+};</span>
<a href="#l3.116"></a><span id="l3.116" class="difflineplus">+</span>
<a href="#l3.117"></a><span id="l3.117" class="difflineplus">+</span>
<a href="#l3.118"></a><span id="l3.118" class="difflineplus">+// Registration/Login operations</span>
<a href="#l3.119"></a><span id="l3.119" class="difflineplus">+// =============================</span>
<a href="#l3.120"></a><span id="l3.120" class="difflineplus">+</span>
<a href="#l3.121"></a><span id="l3.121" class="difflineplus">+/**</span>
<a href="#l3.122"></a><span id="l3.122" class="difflineplus">+ * @param {string} username</span>
<a href="#l3.123"></a><span id="l3.123" class="difflineplus">+ * @param {string} password</span>
<a href="#l3.124"></a><span id="l3.124" class="difflineplus">+ * @param {string} sessionId</span>
<a href="#l3.125"></a><span id="l3.125" class="difflineplus">+ * @param {Object} auth</span>
<a href="#l3.126"></a><span id="l3.126" class="difflineplus">+ * @param {boolean} bindEmail</span>
<a href="#l3.127"></a><span id="l3.127" class="difflineplus">+ * @param {string} guestAccessToken</span>
<a href="#l3.128"></a><span id="l3.128" class="difflineplus">+ * @param {module:client.callback} callback Optional.</span>
<a href="#l3.129"></a><span id="l3.129" class="difflineplus">+ * @return {module:client.Promise} Resolves: TODO</span>
<a href="#l3.130"></a><span id="l3.130" class="difflineplus">+ * @return {module:http-api.MatrixError} Rejects: with an error response.</span>
<a href="#l3.131"></a><span id="l3.131" class="difflineplus">+ */</span>
<a href="#l3.132"></a><span id="l3.132" class="difflineplus">+MatrixBaseApis.prototype.register = function(</span>
<a href="#l3.133"></a><span id="l3.133" class="difflineplus">+    username, password,</span>
<a href="#l3.134"></a><span id="l3.134" class="difflineplus">+    sessionId, auth, bindEmail, guestAccessToken,</span>
<a href="#l3.135"></a><span id="l3.135" class="difflineplus">+    callback</span>
<a href="#l3.136"></a><span id="l3.136" class="difflineplus">+) {</span>
<a href="#l3.137"></a><span id="l3.137" class="difflineplus">+    if (auth === undefined) { auth = {}; }</span>
<a href="#l3.138"></a><span id="l3.138" class="difflineplus">+    if (sessionId) { auth.session = sessionId; }</span>
<a href="#l3.139"></a><span id="l3.139" class="difflineplus">+</span>
<a href="#l3.140"></a><span id="l3.140" class="difflineplus">+    var params = {</span>
<a href="#l3.141"></a><span id="l3.141" class="difflineplus">+        auth: auth</span>
<a href="#l3.142"></a><span id="l3.142" class="difflineplus">+    };</span>
<a href="#l3.143"></a><span id="l3.143" class="difflineplus">+    if (username !== undefined &amp;&amp; username !== null) { params.username = username; }</span>
<a href="#l3.144"></a><span id="l3.144" class="difflineplus">+    if (password !== undefined &amp;&amp; password !== null) { params.password = password; }</span>
<a href="#l3.145"></a><span id="l3.145" class="difflineplus">+    if (bindEmail !== undefined &amp;&amp; bindEmail !== null) { params.bind_email = bindEmail; }</span>
<a href="#l3.146"></a><span id="l3.146" class="difflineplus">+    if (guestAccessToken !== undefined &amp;&amp; guestAccessToken !== null) {</span>
<a href="#l3.147"></a><span id="l3.147" class="difflineplus">+        params.guest_access_token = guestAccessToken;</span>
<a href="#l3.148"></a><span id="l3.148" class="difflineplus">+    }</span>
<a href="#l3.149"></a><span id="l3.149" class="difflineplus">+</span>
<a href="#l3.150"></a><span id="l3.150" class="difflineplus">+    return this.registerRequest(params, undefined, callback);</span>
<a href="#l3.151"></a><span id="l3.151" class="difflineplus">+};</span>
<a href="#l3.152"></a><span id="l3.152" class="difflineplus">+</span>
<a href="#l3.153"></a><span id="l3.153" class="difflineplus">+/**</span>
<a href="#l3.154"></a><span id="l3.154" class="difflineplus">+ * Register a guest account.</span>
<a href="#l3.155"></a><span id="l3.155" class="difflineplus">+ * @param {Object=} opts Registration options</span>
<a href="#l3.156"></a><span id="l3.156" class="difflineplus">+ * @param {Object} opts.body JSON HTTP body to provide.</span>
<a href="#l3.157"></a><span id="l3.157" class="difflineplus">+ * @param {module:client.callback} callback Optional.</span>
<a href="#l3.158"></a><span id="l3.158" class="difflineplus">+ * @return {module:client.Promise} Resolves: TODO</span>
<a href="#l3.159"></a><span id="l3.159" class="difflineplus">+ * @return {module:http-api.MatrixError} Rejects: with an error response.</span>
<a href="#l3.160"></a><span id="l3.160" class="difflineplus">+ */</span>
<a href="#l3.161"></a><span id="l3.161" class="difflineplus">+MatrixBaseApis.prototype.registerGuest = function(opts, callback) {</span>
<a href="#l3.162"></a><span id="l3.162" class="difflineplus">+    opts = opts || {};</span>
<a href="#l3.163"></a><span id="l3.163" class="difflineplus">+    opts.body = opts.body || {};</span>
<a href="#l3.164"></a><span id="l3.164" class="difflineplus">+    return this.registerRequest(opts.body, &quot;guest&quot;, callback);</span>
<a href="#l3.165"></a><span id="l3.165" class="difflineplus">+};</span>
<a href="#l3.166"></a><span id="l3.166" class="difflineplus">+</span>
<a href="#l3.167"></a><span id="l3.167" class="difflineplus">+/**</span>
<a href="#l3.168"></a><span id="l3.168" class="difflineplus">+ * @param {Object} data   parameters for registration request</span>
<a href="#l3.169"></a><span id="l3.169" class="difflineplus">+ * @param {string=} kind  type of user to register. may be &quot;guest&quot;</span>
<a href="#l3.170"></a><span id="l3.170" class="difflineplus">+ * @param {module:client.callback=} callback</span>
<a href="#l3.171"></a><span id="l3.171" class="difflineplus">+ * @return {module:client.Promise} Resolves: to the /register response</span>
<a href="#l3.172"></a><span id="l3.172" class="difflineplus">+ * @return {module:http-api.MatrixError} Rejects: with an error response.</span>
<a href="#l3.173"></a><span id="l3.173" class="difflineplus">+ */</span>
<a href="#l3.174"></a><span id="l3.174" class="difflineplus">+MatrixBaseApis.prototype.registerRequest = function(data, kind, callback) {</span>
<a href="#l3.175"></a><span id="l3.175" class="difflineplus">+    var params = {};</span>
<a href="#l3.176"></a><span id="l3.176" class="difflineplus">+    if (kind) { params.kind = kind; }</span>
<a href="#l3.177"></a><span id="l3.177" class="difflineplus">+</span>
<a href="#l3.178"></a><span id="l3.178" class="difflineplus">+    return this._http.request(</span>
<a href="#l3.179"></a><span id="l3.179" class="difflineplus">+        callback, &quot;POST&quot;, &quot;/register&quot;, params, data</span>
<a href="#l3.180"></a><span id="l3.180" class="difflineplus">+    );</span>
<a href="#l3.181"></a><span id="l3.181" class="difflineplus">+};</span>
<a href="#l3.182"></a><span id="l3.182" class="difflineplus">+</span>
<a href="#l3.183"></a><span id="l3.183" class="difflineplus">+/**</span>
<a href="#l3.184"></a><span id="l3.184" class="difflineplus">+ * @param {module:client.callback} callback Optional.</span>
<a href="#l3.185"></a><span id="l3.185" class="difflineplus">+ * @return {module:client.Promise} Resolves: TODO</span>
<a href="#l3.186"></a><span id="l3.186" class="difflineplus">+ * @return {module:http-api.MatrixError} Rejects: with an error response.</span>
<a href="#l3.187"></a><span id="l3.187" class="difflineplus">+ */</span>
<a href="#l3.188"></a><span id="l3.188" class="difflineplus">+MatrixBaseApis.prototype.loginFlows = function(callback) {</span>
<a href="#l3.189"></a><span id="l3.189" class="difflineplus">+    return this._http.request(callback, &quot;GET&quot;, &quot;/login&quot;);</span>
<a href="#l3.190"></a><span id="l3.190" class="difflineplus">+};</span>
<a href="#l3.191"></a><span id="l3.191" class="difflineplus">+</span>
<a href="#l3.192"></a><span id="l3.192" class="difflineplus">+/**</span>
<a href="#l3.193"></a><span id="l3.193" class="difflineplus">+ * @param {string} loginType</span>
<a href="#l3.194"></a><span id="l3.194" class="difflineplus">+ * @param {Object} data</span>
<a href="#l3.195"></a><span id="l3.195" class="difflineplus">+ * @param {module:client.callback} callback Optional.</span>
<a href="#l3.196"></a><span id="l3.196" class="difflineplus">+ * @return {module:client.Promise} Resolves: TODO</span>
<a href="#l3.197"></a><span id="l3.197" class="difflineplus">+ * @return {module:http-api.MatrixError} Rejects: with an error response.</span>
<a href="#l3.198"></a><span id="l3.198" class="difflineplus">+ */</span>
<a href="#l3.199"></a><span id="l3.199" class="difflineplus">+MatrixBaseApis.prototype.login = function(loginType, data, callback) {</span>
<a href="#l3.200"></a><span id="l3.200" class="difflineplus">+    var login_data = {</span>
<a href="#l3.201"></a><span id="l3.201" class="difflineplus">+        type: loginType,</span>
<a href="#l3.202"></a><span id="l3.202" class="difflineplus">+    };</span>
<a href="#l3.203"></a><span id="l3.203" class="difflineplus">+</span>
<a href="#l3.204"></a><span id="l3.204" class="difflineplus">+    // merge data into login_data</span>
<a href="#l3.205"></a><span id="l3.205" class="difflineplus">+    utils.extend(login_data, data);</span>
<a href="#l3.206"></a><span id="l3.206" class="difflineplus">+</span>
<a href="#l3.207"></a><span id="l3.207" class="difflineplus">+    return this._http.authedRequest(</span>
<a href="#l3.208"></a><span id="l3.208" class="difflineplus">+        callback, &quot;POST&quot;, &quot;/login&quot;, undefined, login_data</span>
<a href="#l3.209"></a><span id="l3.209" class="difflineplus">+    );</span>
<a href="#l3.210"></a><span id="l3.210" class="difflineplus">+};</span>
<a href="#l3.211"></a><span id="l3.211" class="difflineplus">+</span>
<a href="#l3.212"></a><span id="l3.212" class="difflineplus">+/**</span>
<a href="#l3.213"></a><span id="l3.213" class="difflineplus">+ * @param {string} user</span>
<a href="#l3.214"></a><span id="l3.214" class="difflineplus">+ * @param {string} password</span>
<a href="#l3.215"></a><span id="l3.215" class="difflineplus">+ * @param {module:client.callback} callback Optional.</span>
<a href="#l3.216"></a><span id="l3.216" class="difflineplus">+ * @return {module:client.Promise} Resolves: TODO</span>
<a href="#l3.217"></a><span id="l3.217" class="difflineplus">+ * @return {module:http-api.MatrixError} Rejects: with an error response.</span>
<a href="#l3.218"></a><span id="l3.218" class="difflineplus">+ */</span>
<a href="#l3.219"></a><span id="l3.219" class="difflineplus">+MatrixBaseApis.prototype.loginWithPassword = function(user, password, callback) {</span>
<a href="#l3.220"></a><span id="l3.220" class="difflineplus">+    return this.login(&quot;m.login.password&quot;, {</span>
<a href="#l3.221"></a><span id="l3.221" class="difflineplus">+        user: user,</span>
<a href="#l3.222"></a><span id="l3.222" class="difflineplus">+        password: password</span>
<a href="#l3.223"></a><span id="l3.223" class="difflineplus">+    }, callback);</span>
<a href="#l3.224"></a><span id="l3.224" class="difflineplus">+};</span>
<a href="#l3.225"></a><span id="l3.225" class="difflineplus">+</span>
<a href="#l3.226"></a><span id="l3.226" class="difflineplus">+/**</span>
<a href="#l3.227"></a><span id="l3.227" class="difflineplus">+ * @param {string} relayState URL Callback after SAML2 Authentication</span>
<a href="#l3.228"></a><span id="l3.228" class="difflineplus">+ * @param {module:client.callback} callback Optional.</span>
<a href="#l3.229"></a><span id="l3.229" class="difflineplus">+ * @return {module:client.Promise} Resolves: TODO</span>
<a href="#l3.230"></a><span id="l3.230" class="difflineplus">+ * @return {module:http-api.MatrixError} Rejects: with an error response.</span>
<a href="#l3.231"></a><span id="l3.231" class="difflineplus">+ */</span>
<a href="#l3.232"></a><span id="l3.232" class="difflineplus">+MatrixBaseApis.prototype.loginWithSAML2 = function(relayState, callback) {</span>
<a href="#l3.233"></a><span id="l3.233" class="difflineplus">+    return this.login(&quot;m.login.saml2&quot;, {</span>
<a href="#l3.234"></a><span id="l3.234" class="difflineplus">+        relay_state: relayState</span>
<a href="#l3.235"></a><span id="l3.235" class="difflineplus">+    }, callback);</span>
<a href="#l3.236"></a><span id="l3.236" class="difflineplus">+};</span>
<a href="#l3.237"></a><span id="l3.237" class="difflineplus">+</span>
<a href="#l3.238"></a><span id="l3.238" class="difflineplus">+/**</span>
<a href="#l3.239"></a><span id="l3.239" class="difflineplus">+ * @param {string} redirectUrl The URL to redirect to after the HS</span>
<a href="#l3.240"></a><span id="l3.240" class="difflineplus">+ * authenticates with CAS.</span>
<a href="#l3.241"></a><span id="l3.241" class="difflineplus">+ * @return {string} The HS URL to hit to begin the CAS login process.</span>
<a href="#l3.242"></a><span id="l3.242" class="difflineplus">+ */</span>
<a href="#l3.243"></a><span id="l3.243" class="difflineplus">+MatrixBaseApis.prototype.getCasLoginUrl = function(redirectUrl) {</span>
<a href="#l3.244"></a><span id="l3.244" class="difflineplus">+    return this._http.getUrl(&quot;/login/cas/redirect&quot;, {</span>
<a href="#l3.245"></a><span id="l3.245" class="difflineplus">+        &quot;redirectUrl&quot;: redirectUrl</span>
<a href="#l3.246"></a><span id="l3.246" class="difflineplus">+    }, httpApi.PREFIX_UNSTABLE);</span>
<a href="#l3.247"></a><span id="l3.247" class="difflineplus">+};</span>
<a href="#l3.248"></a><span id="l3.248" class="difflineplus">+</span>
<a href="#l3.249"></a><span id="l3.249" class="difflineplus">+/**</span>
<a href="#l3.250"></a><span id="l3.250" class="difflineplus">+ * @param {string} token Login token previously received from homeserver</span>
<a href="#l3.251"></a><span id="l3.251" class="difflineplus">+ * @param {module:client.callback} callback Optional.</span>
<a href="#l3.252"></a><span id="l3.252" class="difflineplus">+ * @return {module:client.Promise} Resolves: TODO</span>
<a href="#l3.253"></a><span id="l3.253" class="difflineplus">+ * @return {module:http-api.MatrixError} Rejects: with an error response.</span>
<a href="#l3.254"></a><span id="l3.254" class="difflineplus">+ */</span>
<a href="#l3.255"></a><span id="l3.255" class="difflineplus">+MatrixBaseApis.prototype.loginWithToken = function(token, callback) {</span>
<a href="#l3.256"></a><span id="l3.256" class="difflineplus">+    return this.login(&quot;m.login.token&quot;, {</span>
<a href="#l3.257"></a><span id="l3.257" class="difflineplus">+        token: token</span>
<a href="#l3.258"></a><span id="l3.258" class="difflineplus">+    }, callback);</span>
<a href="#l3.259"></a><span id="l3.259" class="difflineplus">+};</span>
<a href="#l3.260"></a><span id="l3.260" class="difflineplus">+</span>
<a href="#l3.261"></a><span id="l3.261" class="difflineplus">+</span>
<a href="#l3.262"></a><span id="l3.262" class="difflineplus">+/**</span>
<a href="#l3.263"></a><span id="l3.263" class="difflineplus">+ * Logs out the current session.</span>
<a href="#l3.264"></a><span id="l3.264" class="difflineplus">+ * Obviously, further calls that require authorisation should fail after this</span>
<a href="#l3.265"></a><span id="l3.265" class="difflineplus">+ * method is called. The state of the MatrixClient object is not affected:</span>
<a href="#l3.266"></a><span id="l3.266" class="difflineplus">+ * it is up to the caller to either reset or destroy the MatrixClient after</span>
<a href="#l3.267"></a><span id="l3.267" class="difflineplus">+ * this method succeeds.</span>
<a href="#l3.268"></a><span id="l3.268" class="difflineplus">+ * @param {module:client.callback} callback Optional.</span>
<a href="#l3.269"></a><span id="l3.269" class="difflineplus">+ * @return {module:client.Promise} Resolves: On success, the empty object</span>
<a href="#l3.270"></a><span id="l3.270" class="difflineplus">+ */</span>
<a href="#l3.271"></a><span id="l3.271" class="difflineplus">+MatrixBaseApis.prototype.logout = function(callback) {</span>
<a href="#l3.272"></a><span id="l3.272" class="difflineplus">+    return this._http.authedRequest(</span>
<a href="#l3.273"></a><span id="l3.273" class="difflineplus">+        callback, &quot;POST&quot;, '/logout'</span>
<a href="#l3.274"></a><span id="l3.274" class="difflineplus">+    );</span>
<a href="#l3.275"></a><span id="l3.275" class="difflineplus">+};</span>
<a href="#l3.276"></a><span id="l3.276" class="difflineplus">+</span>
<a href="#l3.277"></a><span id="l3.277" class="difflineplus">+/**</span>
<a href="#l3.278"></a><span id="l3.278" class="difflineplus">+ * Deactivates the logged-in account.</span>
<a href="#l3.279"></a><span id="l3.279" class="difflineplus">+ * Obviously, further calls that require authorisation should fail after this</span>
<a href="#l3.280"></a><span id="l3.280" class="difflineplus">+ * method is called. The state of the MatrixClient object is not affected:</span>
<a href="#l3.281"></a><span id="l3.281" class="difflineplus">+ * it is up to the caller to either reset or destroy the MatrixClient after</span>
<a href="#l3.282"></a><span id="l3.282" class="difflineplus">+ * this method succeeds.</span>
<a href="#l3.283"></a><span id="l3.283" class="difflineplus">+ * @param {object} auth Optional. Auth data to supply for User-Interactive auth.</span>
<a href="#l3.284"></a><span id="l3.284" class="difflineplus">+ * @param {module:client.callback} callback Optional.</span>
<a href="#l3.285"></a><span id="l3.285" class="difflineplus">+ * @return {module:client.Promise} Resolves: On success, the empty object</span>
<a href="#l3.286"></a><span id="l3.286" class="difflineplus">+ */</span>
<a href="#l3.287"></a><span id="l3.287" class="difflineplus">+MatrixBaseApis.prototype.deactivateAccount = function(auth, callback) {</span>
<a href="#l3.288"></a><span id="l3.288" class="difflineplus">+    var body = {};</span>
<a href="#l3.289"></a><span id="l3.289" class="difflineplus">+    if (auth) {</span>
<a href="#l3.290"></a><span id="l3.290" class="difflineplus">+        body = {</span>
<a href="#l3.291"></a><span id="l3.291" class="difflineplus">+            auth: auth,</span>
<a href="#l3.292"></a><span id="l3.292" class="difflineplus">+        };</span>
<a href="#l3.293"></a><span id="l3.293" class="difflineplus">+    }</span>
<a href="#l3.294"></a><span id="l3.294" class="difflineplus">+    return this._http.authedRequestWithPrefix(</span>
<a href="#l3.295"></a><span id="l3.295" class="difflineplus">+        callback, &quot;POST&quot;, '/account/deactivate', undefined, body, httpApi.PREFIX_UNSTABLE</span>
<a href="#l3.296"></a><span id="l3.296" class="difflineplus">+    );</span>
<a href="#l3.297"></a><span id="l3.297" class="difflineplus">+};</span>
<a href="#l3.298"></a><span id="l3.298" class="difflineplus">+</span>
<a href="#l3.299"></a><span id="l3.299" class="difflineplus">+/**</span>
<a href="#l3.300"></a><span id="l3.300" class="difflineplus">+ * Get the fallback URL to use for unknown interactive-auth stages.</span>
<a href="#l3.301"></a><span id="l3.301" class="difflineplus">+ *</span>
<a href="#l3.302"></a><span id="l3.302" class="difflineplus">+ * @param {string} loginType     the type of stage being attempted</span>
<a href="#l3.303"></a><span id="l3.303" class="difflineplus">+ * @param {string} authSessionId the auth session ID provided by the homeserver</span>
<a href="#l3.304"></a><span id="l3.304" class="difflineplus">+ *</span>
<a href="#l3.305"></a><span id="l3.305" class="difflineplus">+ * @return {string} HS URL to hit to for the fallback interface</span>
<a href="#l3.306"></a><span id="l3.306" class="difflineplus">+ */</span>
<a href="#l3.307"></a><span id="l3.307" class="difflineplus">+MatrixBaseApis.prototype.getFallbackAuthUrl = function(loginType, authSessionId) {</span>
<a href="#l3.308"></a><span id="l3.308" class="difflineplus">+    var path = utils.encodeUri(&quot;/auth/$loginType/fallback/web&quot;, {</span>
<a href="#l3.309"></a><span id="l3.309" class="difflineplus">+        $loginType: loginType,</span>
<a href="#l3.310"></a><span id="l3.310" class="difflineplus">+    });</span>
<a href="#l3.311"></a><span id="l3.311" class="difflineplus">+</span>
<a href="#l3.312"></a><span id="l3.312" class="difflineplus">+    return this._http.getUrl(path, {</span>
<a href="#l3.313"></a><span id="l3.313" class="difflineplus">+        session: authSessionId,</span>
<a href="#l3.314"></a><span id="l3.314" class="difflineplus">+    }, httpApi.PREFIX_R0);</span>
<a href="#l3.315"></a><span id="l3.315" class="difflineplus">+};</span>
<a href="#l3.316"></a><span id="l3.316" class="difflineplus">+</span>
<a href="#l3.317"></a><span id="l3.317" class="difflineplus">+// Room operations</span>
<a href="#l3.318"></a><span id="l3.318" class="difflineplus">+// ===============</span>
<a href="#l3.319"></a><span id="l3.319" class="difflineplus">+</span>
<a href="#l3.320"></a><span id="l3.320" class="difflineplus">+/**</span>
<a href="#l3.321"></a><span id="l3.321" class="difflineplus">+ * Create a new room.</span>
<a href="#l3.322"></a><span id="l3.322" class="difflineplus">+ * @param {Object} options a list of options to pass to the /createRoom API.</span>
<a href="#l3.323"></a><span id="l3.323" class="difflineplus">+ * @param {string} options.room_alias_name The alias localpart to assign to</span>
<a href="#l3.324"></a><span id="l3.324" class="difflineplus">+ * this room.</span>
<a href="#l3.325"></a><span id="l3.325" class="difflineplus">+ * @param {string} options.visibility Either 'public' or 'private'.</span>
<a href="#l3.326"></a><span id="l3.326" class="difflineplus">+ * @param {string[]} options.invite A list of user IDs to invite to this room.</span>
<a href="#l3.327"></a><span id="l3.327" class="difflineplus">+ * @param {string} options.name The name to give this room.</span>
<a href="#l3.328"></a><span id="l3.328" class="difflineplus">+ * @param {string} options.topic The topic to give this room.</span>
<a href="#l3.329"></a><span id="l3.329" class="difflineplus">+ * @param {module:client.callback} callback Optional.</span>
<a href="#l3.330"></a><span id="l3.330" class="difflineplus">+ * @return {module:client.Promise} Resolves: &lt;code&gt;{room_id: {string},</span>
<a href="#l3.331"></a><span id="l3.331" class="difflineplus">+ * room_alias: {string(opt)}}&lt;/code&gt;</span>
<a href="#l3.332"></a><span id="l3.332" class="difflineplus">+ * @return {module:http-api.MatrixError} Rejects: with an error response.</span>
<a href="#l3.333"></a><span id="l3.333" class="difflineplus">+ */</span>
<a href="#l3.334"></a><span id="l3.334" class="difflineplus">+MatrixBaseApis.prototype.createRoom = function(options, callback) {</span>
<a href="#l3.335"></a><span id="l3.335" class="difflineplus">+    // valid options include: room_alias_name, visibility, invite</span>
<a href="#l3.336"></a><span id="l3.336" class="difflineplus">+    return this._http.authedRequest(</span>
<a href="#l3.337"></a><span id="l3.337" class="difflineplus">+        callback, &quot;POST&quot;, &quot;/createRoom&quot;, undefined, options</span>
<a href="#l3.338"></a><span id="l3.338" class="difflineplus">+    );</span>
<a href="#l3.339"></a><span id="l3.339" class="difflineplus">+};</span>
<a href="#l3.340"></a><span id="l3.340" class="difflineplus">+</span>
<a href="#l3.341"></a><span id="l3.341" class="difflineplus">+/**</span>
<a href="#l3.342"></a><span id="l3.342" class="difflineplus">+ * @param {string} roomId</span>
<a href="#l3.343"></a><span id="l3.343" class="difflineplus">+ * @param {module:client.callback} callback Optional.</span>
<a href="#l3.344"></a><span id="l3.344" class="difflineplus">+ * @return {module:client.Promise} Resolves: TODO</span>
<a href="#l3.345"></a><span id="l3.345" class="difflineplus">+ * @return {module:http-api.MatrixError} Rejects: with an error response.</span>
<a href="#l3.346"></a><span id="l3.346" class="difflineplus">+ */</span>
<a href="#l3.347"></a><span id="l3.347" class="difflineplus">+MatrixBaseApis.prototype.roomState = function(roomId, callback) {</span>
<a href="#l3.348"></a><span id="l3.348" class="difflineplus">+    var path = utils.encodeUri(&quot;/rooms/$roomId/state&quot;, {$roomId: roomId});</span>
<a href="#l3.349"></a><span id="l3.349" class="difflineplus">+    return this._http.authedRequest(callback, &quot;GET&quot;, path);</span>
<a href="#l3.350"></a><span id="l3.350" class="difflineplus">+};</span>
<a href="#l3.351"></a><span id="l3.351" class="difflineplus">+</span>
<a href="#l3.352"></a><span id="l3.352" class="difflineplus">+/**</span>
<a href="#l3.353"></a><span id="l3.353" class="difflineplus">+ * Retrieve a state event.</span>
<a href="#l3.354"></a><span id="l3.354" class="difflineplus">+ * @param {string} roomId</span>
<a href="#l3.355"></a><span id="l3.355" class="difflineplus">+ * @param {string} eventType</span>
<a href="#l3.356"></a><span id="l3.356" class="difflineplus">+ * @param {string} stateKey</span>
<a href="#l3.357"></a><span id="l3.357" class="difflineplus">+ * @param {module:client.callback} callback Optional.</span>
<a href="#l3.358"></a><span id="l3.358" class="difflineplus">+ * @return {module:client.Promise} Resolves: TODO</span>
<a href="#l3.359"></a><span id="l3.359" class="difflineplus">+ * @return {module:http-api.MatrixError} Rejects: with an error response.</span>
<a href="#l3.360"></a><span id="l3.360" class="difflineplus">+ */</span>
<a href="#l3.361"></a><span id="l3.361" class="difflineplus">+MatrixBaseApis.prototype.getStateEvent = function(roomId, eventType, stateKey, callback) {</span>
<a href="#l3.362"></a><span id="l3.362" class="difflineplus">+    var pathParams = {</span>
<a href="#l3.363"></a><span id="l3.363" class="difflineplus">+        $roomId: roomId,</span>
<a href="#l3.364"></a><span id="l3.364" class="difflineplus">+        $eventType: eventType,</span>
<a href="#l3.365"></a><span id="l3.365" class="difflineplus">+        $stateKey: stateKey</span>
<a href="#l3.366"></a><span id="l3.366" class="difflineplus">+    };</span>
<a href="#l3.367"></a><span id="l3.367" class="difflineplus">+    var path = utils.encodeUri(&quot;/rooms/$roomId/state/$eventType&quot;, pathParams);</span>
<a href="#l3.368"></a><span id="l3.368" class="difflineplus">+    if (stateKey !== undefined) {</span>
<a href="#l3.369"></a><span id="l3.369" class="difflineplus">+        path = utils.encodeUri(path + &quot;/$stateKey&quot;, pathParams);</span>
<a href="#l3.370"></a><span id="l3.370" class="difflineplus">+    }</span>
<a href="#l3.371"></a><span id="l3.371" class="difflineplus">+    return this._http.authedRequest(</span>
<a href="#l3.372"></a><span id="l3.372" class="difflineplus">+        callback, &quot;GET&quot;, path</span>
<a href="#l3.373"></a><span id="l3.373" class="difflineplus">+    );</span>
<a href="#l3.374"></a><span id="l3.374" class="difflineplus">+};</span>
<a href="#l3.375"></a><span id="l3.375" class="difflineplus">+</span>
<a href="#l3.376"></a><span id="l3.376" class="difflineplus">+/**</span>
<a href="#l3.377"></a><span id="l3.377" class="difflineplus">+ * @param {string} roomId</span>
<a href="#l3.378"></a><span id="l3.378" class="difflineplus">+ * @param {string} eventType</span>
<a href="#l3.379"></a><span id="l3.379" class="difflineplus">+ * @param {Object} content</span>
<a href="#l3.380"></a><span id="l3.380" class="difflineplus">+ * @param {string} stateKey</span>
<a href="#l3.381"></a><span id="l3.381" class="difflineplus">+ * @param {module:client.callback} callback Optional.</span>
<a href="#l3.382"></a><span id="l3.382" class="difflineplus">+ * @return {module:client.Promise} Resolves: TODO</span>
<a href="#l3.383"></a><span id="l3.383" class="difflineplus">+ * @return {module:http-api.MatrixError} Rejects: with an error response.</span>
<a href="#l3.384"></a><span id="l3.384" class="difflineplus">+ */</span>
<a href="#l3.385"></a><span id="l3.385" class="difflineplus">+MatrixBaseApis.prototype.sendStateEvent = function(roomId, eventType, content, stateKey,</span>
<a href="#l3.386"></a><span id="l3.386" class="difflineplus">+                                                 callback) {</span>
<a href="#l3.387"></a><span id="l3.387" class="difflineplus">+    var pathParams = {</span>
<a href="#l3.388"></a><span id="l3.388" class="difflineplus">+        $roomId: roomId,</span>
<a href="#l3.389"></a><span id="l3.389" class="difflineplus">+        $eventType: eventType,</span>
<a href="#l3.390"></a><span id="l3.390" class="difflineplus">+        $stateKey: stateKey</span>
<a href="#l3.391"></a><span id="l3.391" class="difflineplus">+    };</span>
<a href="#l3.392"></a><span id="l3.392" class="difflineplus">+    var path = utils.encodeUri(&quot;/rooms/$roomId/state/$eventType&quot;, pathParams);</span>
<a href="#l3.393"></a><span id="l3.393" class="difflineplus">+    if (stateKey !== undefined) {</span>
<a href="#l3.394"></a><span id="l3.394" class="difflineplus">+        path = utils.encodeUri(path + &quot;/$stateKey&quot;, pathParams);</span>
<a href="#l3.395"></a><span id="l3.395" class="difflineplus">+    }</span>
<a href="#l3.396"></a><span id="l3.396" class="difflineplus">+    return this._http.authedRequest(</span>
<a href="#l3.397"></a><span id="l3.397" class="difflineplus">+        callback, &quot;PUT&quot;, path, undefined, content</span>
<a href="#l3.398"></a><span id="l3.398" class="difflineplus">+    );</span>
<a href="#l3.399"></a><span id="l3.399" class="difflineplus">+};</span>
<a href="#l3.400"></a><span id="l3.400" class="difflineplus">+</span>
<a href="#l3.401"></a><span id="l3.401" class="difflineplus">+/**</span>
<a href="#l3.402"></a><span id="l3.402" class="difflineplus">+ * @param {string} roomId</span>
<a href="#l3.403"></a><span id="l3.403" class="difflineplus">+ * @param {string} eventId</span>
<a href="#l3.404"></a><span id="l3.404" class="difflineplus">+ * @param {module:client.callback} callback Optional.</span>
<a href="#l3.405"></a><span id="l3.405" class="difflineplus">+ * @return {module:client.Promise} Resolves: TODO</span>
<a href="#l3.406"></a><span id="l3.406" class="difflineplus">+ * @return {module:http-api.MatrixError} Rejects: with an error response.</span>
<a href="#l3.407"></a><span id="l3.407" class="difflineplus">+ */</span>
<a href="#l3.408"></a><span id="l3.408" class="difflineplus">+MatrixBaseApis.prototype.redactEvent = function(roomId, eventId, callback) {</span>
<a href="#l3.409"></a><span id="l3.409" class="difflineplus">+    var path = utils.encodeUri(&quot;/rooms/$roomId/redact/$eventId&quot;, {</span>
<a href="#l3.410"></a><span id="l3.410" class="difflineplus">+        $roomId: roomId,</span>
<a href="#l3.411"></a><span id="l3.411" class="difflineplus">+        $eventId: eventId</span>
<a href="#l3.412"></a><span id="l3.412" class="difflineplus">+    });</span>
<a href="#l3.413"></a><span id="l3.413" class="difflineplus">+    return this._http.authedRequest(callback, &quot;POST&quot;, path, undefined, {});</span>
<a href="#l3.414"></a><span id="l3.414" class="difflineplus">+};</span>
<a href="#l3.415"></a><span id="l3.415" class="difflineplus">+</span>
<a href="#l3.416"></a><span id="l3.416" class="difflineplus">+/**</span>
<a href="#l3.417"></a><span id="l3.417" class="difflineplus">+ * @param {string} roomId</span>
<a href="#l3.418"></a><span id="l3.418" class="difflineplus">+ * @param {Number} limit</span>
<a href="#l3.419"></a><span id="l3.419" class="difflineplus">+ * @param {module:client.callback} callback Optional.</span>
<a href="#l3.420"></a><span id="l3.420" class="difflineplus">+ * @return {module:client.Promise} Resolves: TODO</span>
<a href="#l3.421"></a><span id="l3.421" class="difflineplus">+ * @return {module:http-api.MatrixError} Rejects: with an error response.</span>
<a href="#l3.422"></a><span id="l3.422" class="difflineplus">+ */</span>
<a href="#l3.423"></a><span id="l3.423" class="difflineplus">+MatrixBaseApis.prototype.roomInitialSync = function(roomId, limit, callback) {</span>
<a href="#l3.424"></a><span id="l3.424" class="difflineplus">+    if (utils.isFunction(limit)) { callback = limit; limit = undefined; }</span>
<a href="#l3.425"></a><span id="l3.425" class="difflineplus">+    var path = utils.encodeUri(&quot;/rooms/$roomId/initialSync&quot;,</span>
<a href="#l3.426"></a><span id="l3.426" class="difflineplus">+        {$roomId: roomId}</span>
<a href="#l3.427"></a><span id="l3.427" class="difflineplus">+    );</span>
<a href="#l3.428"></a><span id="l3.428" class="difflineplus">+    if (!limit) {</span>
<a href="#l3.429"></a><span id="l3.429" class="difflineplus">+        limit = 30;</span>
<a href="#l3.430"></a><span id="l3.430" class="difflineplus">+    }</span>
<a href="#l3.431"></a><span id="l3.431" class="difflineplus">+    return this._http.authedRequest(</span>
<a href="#l3.432"></a><span id="l3.432" class="difflineplus">+        callback, &quot;GET&quot;, path, { limit: limit }</span>
<a href="#l3.433"></a><span id="l3.433" class="difflineplus">+    );</span>
<a href="#l3.434"></a><span id="l3.434" class="difflineplus">+};</span>
<a href="#l3.435"></a><span id="l3.435" class="difflineplus">+</span>
<a href="#l3.436"></a><span id="l3.436" class="difflineplus">+</span>
<a href="#l3.437"></a><span id="l3.437" class="difflineplus">+// Room Directory operations</span>
<a href="#l3.438"></a><span id="l3.438" class="difflineplus">+// =========================</span>
<a href="#l3.439"></a><span id="l3.439" class="difflineplus">+</span>
<a href="#l3.440"></a><span id="l3.440" class="difflineplus">+/**</span>
<a href="#l3.441"></a><span id="l3.441" class="difflineplus">+ * @param {string} options.server The remote server to query for the room list.</span>
<a href="#l3.442"></a><span id="l3.442" class="difflineplus">+ *                                Optional. If unspecified, get the local home</span>
<a href="#l3.443"></a><span id="l3.443" class="difflineplus">+ *                                server's public room list.</span>
<a href="#l3.444"></a><span id="l3.444" class="difflineplus">+ * @param {number} options.limit Maximum number of entries to return</span>
<a href="#l3.445"></a><span id="l3.445" class="difflineplus">+ * @param {string} options.since Token to paginate from</span>
<a href="#l3.446"></a><span id="l3.446" class="difflineplus">+ * @param {object} options.filter Filter parameters</span>
<a href="#l3.447"></a><span id="l3.447" class="difflineplus">+ * @param {string} options.filter.generic_search_term String to search for</span>
<a href="#l3.448"></a><span id="l3.448" class="difflineplus">+ * @param {module:client.callback} callback Optional.</span>
<a href="#l3.449"></a><span id="l3.449" class="difflineplus">+ * @return {module:client.Promise} Resolves: TODO</span>
<a href="#l3.450"></a><span id="l3.450" class="difflineplus">+ * @return {module:http-api.MatrixError} Rejects: with an error response.</span>
<a href="#l3.451"></a><span id="l3.451" class="difflineplus">+ */</span>
<a href="#l3.452"></a><span id="l3.452" class="difflineplus">+MatrixBaseApis.prototype.publicRooms = function(options, callback) {</span>
<a href="#l3.453"></a><span id="l3.453" class="difflineplus">+    if (typeof(options) == 'function') {</span>
<a href="#l3.454"></a><span id="l3.454" class="difflineplus">+        callback = options;</span>
<a href="#l3.455"></a><span id="l3.455" class="difflineplus">+        options = {};</span>
<a href="#l3.456"></a><span id="l3.456" class="difflineplus">+    }</span>
<a href="#l3.457"></a><span id="l3.457" class="difflineplus">+    if (options === undefined) {</span>
<a href="#l3.458"></a><span id="l3.458" class="difflineplus">+        options = {};</span>
<a href="#l3.459"></a><span id="l3.459" class="difflineplus">+    }</span>
<a href="#l3.460"></a><span id="l3.460" class="difflineplus">+</span>
<a href="#l3.461"></a><span id="l3.461" class="difflineplus">+    var query_params = {};</span>
<a href="#l3.462"></a><span id="l3.462" class="difflineplus">+    if (options.server) {</span>
<a href="#l3.463"></a><span id="l3.463" class="difflineplus">+        query_params.server = options.server;</span>
<a href="#l3.464"></a><span id="l3.464" class="difflineplus">+        delete options.server;</span>
<a href="#l3.465"></a><span id="l3.465" class="difflineplus">+    }</span>
<a href="#l3.466"></a><span id="l3.466" class="difflineplus">+</span>
<a href="#l3.467"></a><span id="l3.467" class="difflineplus">+    if (Object.keys(options).length === 0 &amp;&amp; Object.keys(query_params).length === 0) {</span>
<a href="#l3.468"></a><span id="l3.468" class="difflineplus">+        return this._http.authedRequest(callback, &quot;GET&quot;, &quot;/publicRooms&quot;);</span>
<a href="#l3.469"></a><span id="l3.469" class="difflineplus">+    } else {</span>
<a href="#l3.470"></a><span id="l3.470" class="difflineplus">+        return this._http.authedRequest(</span>
<a href="#l3.471"></a><span id="l3.471" class="difflineplus">+            callback, &quot;POST&quot;, &quot;/publicRooms&quot;, query_params, options</span>
<a href="#l3.472"></a><span id="l3.472" class="difflineplus">+        );</span>
<a href="#l3.473"></a><span id="l3.473" class="difflineplus">+    }</span>
<a href="#l3.474"></a><span id="l3.474" class="difflineplus">+};</span>
<a href="#l3.475"></a><span id="l3.475" class="difflineplus">+</span>
<a href="#l3.476"></a><span id="l3.476" class="difflineplus">+/**</span>
<a href="#l3.477"></a><span id="l3.477" class="difflineplus">+ * Create an alias to room ID mapping.</span>
<a href="#l3.478"></a><span id="l3.478" class="difflineplus">+ * @param {string} alias The room alias to create.</span>
<a href="#l3.479"></a><span id="l3.479" class="difflineplus">+ * @param {string} roomId The room ID to link the alias to.</span>
<a href="#l3.480"></a><span id="l3.480" class="difflineplus">+ * @param {module:client.callback} callback Optional.</span>
<a href="#l3.481"></a><span id="l3.481" class="difflineplus">+ * @return {module:client.Promise} Resolves: TODO.</span>
<a href="#l3.482"></a><span id="l3.482" class="difflineplus">+ * @return {module:http-api.MatrixError} Rejects: with an error response.</span>
<a href="#l3.483"></a><span id="l3.483" class="difflineplus">+ */</span>
<a href="#l3.484"></a><span id="l3.484" class="difflineplus">+MatrixBaseApis.prototype.createAlias = function(alias, roomId, callback) {</span>
<a href="#l3.485"></a><span id="l3.485" class="difflineplus">+    var path = utils.encodeUri(&quot;/directory/room/$alias&quot;, {</span>
<a href="#l3.486"></a><span id="l3.486" class="difflineplus">+        $alias: alias</span>
<a href="#l3.487"></a><span id="l3.487" class="difflineplus">+    });</span>
<a href="#l3.488"></a><span id="l3.488" class="difflineplus">+    var data = {</span>
<a href="#l3.489"></a><span id="l3.489" class="difflineplus">+        room_id: roomId</span>
<a href="#l3.490"></a><span id="l3.490" class="difflineplus">+    };</span>
<a href="#l3.491"></a><span id="l3.491" class="difflineplus">+    return this._http.authedRequest(</span>
<a href="#l3.492"></a><span id="l3.492" class="difflineplus">+        callback, &quot;PUT&quot;, path, undefined, data</span>
<a href="#l3.493"></a><span id="l3.493" class="difflineplus">+    );</span>
<a href="#l3.494"></a><span id="l3.494" class="difflineplus">+};</span>
<a href="#l3.495"></a><span id="l3.495" class="difflineplus">+</span>
<a href="#l3.496"></a><span id="l3.496" class="difflineplus">+/**</span>
<a href="#l3.497"></a><span id="l3.497" class="difflineplus">+ * Delete an alias to room ID mapping.  This alias must be on your local server</span>
<a href="#l3.498"></a><span id="l3.498" class="difflineplus">+ * and you must have sufficient access to do this operation.</span>
<a href="#l3.499"></a><span id="l3.499" class="difflineplus">+ * @param {string} alias The room alias to delete.</span>
<a href="#l3.500"></a><span id="l3.500" class="difflineplus">+ * @param {module:client.callback} callback Optional.</span>
<a href="#l3.501"></a><span id="l3.501" class="difflineplus">+ * @return {module:client.Promise} Resolves: TODO.</span>
<a href="#l3.502"></a><span id="l3.502" class="difflineplus">+ * @return {module:http-api.MatrixError} Rejects: with an error response.</span>
<a href="#l3.503"></a><span id="l3.503" class="difflineplus">+ */</span>
<a href="#l3.504"></a><span id="l3.504" class="difflineplus">+MatrixBaseApis.prototype.deleteAlias = function(alias, callback) {</span>
<a href="#l3.505"></a><span id="l3.505" class="difflineplus">+    var path = utils.encodeUri(&quot;/directory/room/$alias&quot;, {</span>
<a href="#l3.506"></a><span id="l3.506" class="difflineplus">+        $alias: alias</span>
<a href="#l3.507"></a><span id="l3.507" class="difflineplus">+    });</span>
<a href="#l3.508"></a><span id="l3.508" class="difflineplus">+    return this._http.authedRequest(</span>
<a href="#l3.509"></a><span id="l3.509" class="difflineplus">+        callback, &quot;DELETE&quot;, path, undefined, undefined</span>
<a href="#l3.510"></a><span id="l3.510" class="difflineplus">+    );</span>
<a href="#l3.511"></a><span id="l3.511" class="difflineplus">+};</span>
<a href="#l3.512"></a><span id="l3.512" class="difflineplus">+</span>
<a href="#l3.513"></a><span id="l3.513" class="difflineplus">+/**</span>
<a href="#l3.514"></a><span id="l3.514" class="difflineplus">+ * Get room info for the given alias.</span>
<a href="#l3.515"></a><span id="l3.515" class="difflineplus">+ * @param {string} alias The room alias to resolve.</span>
<a href="#l3.516"></a><span id="l3.516" class="difflineplus">+ * @param {module:client.callback} callback Optional.</span>
<a href="#l3.517"></a><span id="l3.517" class="difflineplus">+ * @return {module:client.Promise} Resolves: Object with room_id and servers.</span>
<a href="#l3.518"></a><span id="l3.518" class="difflineplus">+ * @return {module:http-api.MatrixError} Rejects: with an error response.</span>
<a href="#l3.519"></a><span id="l3.519" class="difflineplus">+ */</span>
<a href="#l3.520"></a><span id="l3.520" class="difflineplus">+MatrixBaseApis.prototype.getRoomIdForAlias = function(alias, callback) {</span>
<a href="#l3.521"></a><span id="l3.521" class="difflineplus">+    // TODO: deprecate this or resolveRoomAlias</span>
<a href="#l3.522"></a><span id="l3.522" class="difflineplus">+    var path = utils.encodeUri(&quot;/directory/room/$alias&quot;, {</span>
<a href="#l3.523"></a><span id="l3.523" class="difflineplus">+        $alias: alias</span>
<a href="#l3.524"></a><span id="l3.524" class="difflineplus">+    });</span>
<a href="#l3.525"></a><span id="l3.525" class="difflineplus">+    return this._http.authedRequest(</span>
<a href="#l3.526"></a><span id="l3.526" class="difflineplus">+        callback, &quot;GET&quot;, path</span>
<a href="#l3.527"></a><span id="l3.527" class="difflineplus">+    );</span>
<a href="#l3.528"></a><span id="l3.528" class="difflineplus">+};</span>
<a href="#l3.529"></a><span id="l3.529" class="difflineplus">+</span>
<a href="#l3.530"></a><span id="l3.530" class="difflineplus">+/**</span>
<a href="#l3.531"></a><span id="l3.531" class="difflineplus">+ * @param {string} roomAlias</span>
<a href="#l3.532"></a><span id="l3.532" class="difflineplus">+ * @param {module:client.callback} callback Optional.</span>
<a href="#l3.533"></a><span id="l3.533" class="difflineplus">+ * @return {module:client.Promise} Resolves: TODO</span>
<a href="#l3.534"></a><span id="l3.534" class="difflineplus">+ * @return {module:http-api.MatrixError} Rejects: with an error response.</span>
<a href="#l3.535"></a><span id="l3.535" class="difflineplus">+ */</span>
<a href="#l3.536"></a><span id="l3.536" class="difflineplus">+MatrixBaseApis.prototype.resolveRoomAlias = function(roomAlias, callback) {</span>
<a href="#l3.537"></a><span id="l3.537" class="difflineplus">+    // TODO: deprecate this or getRoomIdForAlias</span>
<a href="#l3.538"></a><span id="l3.538" class="difflineplus">+    var path = utils.encodeUri(&quot;/directory/room/$alias&quot;, {$alias: roomAlias});</span>
<a href="#l3.539"></a><span id="l3.539" class="difflineplus">+    return this._http.request(callback, &quot;GET&quot;, path);</span>
<a href="#l3.540"></a><span id="l3.540" class="difflineplus">+};</span>
<a href="#l3.541"></a><span id="l3.541" class="difflineplus">+</span>
<a href="#l3.542"></a><span id="l3.542" class="difflineplus">+/**</span>
<a href="#l3.543"></a><span id="l3.543" class="difflineplus">+ * Get the visibility of a room in the current HS's room directory</span>
<a href="#l3.544"></a><span id="l3.544" class="difflineplus">+ * @param {string} roomId</span>
<a href="#l3.545"></a><span id="l3.545" class="difflineplus">+ * @param {module:client.callback} callback Optional.</span>
<a href="#l3.546"></a><span id="l3.546" class="difflineplus">+ * @return {module:client.Promise} Resolves: TODO</span>
<a href="#l3.547"></a><span id="l3.547" class="difflineplus">+ * @return {module:http-api.MatrixError} Rejects: with an error response.</span>
<a href="#l3.548"></a><span id="l3.548" class="difflineplus">+ */</span>
<a href="#l3.549"></a><span id="l3.549" class="difflineplus">+MatrixBaseApis.prototype.getRoomDirectoryVisibility =</span>
<a href="#l3.550"></a><span id="l3.550" class="difflineplus">+                                function(roomId, callback) {</span>
<a href="#l3.551"></a><span id="l3.551" class="difflineplus">+    var path = utils.encodeUri(&quot;/directory/list/room/$roomId&quot;, {</span>
<a href="#l3.552"></a><span id="l3.552" class="difflineplus">+        $roomId: roomId</span>
<a href="#l3.553"></a><span id="l3.553" class="difflineplus">+    });</span>
<a href="#l3.554"></a><span id="l3.554" class="difflineplus">+    return this._http.authedRequest(callback, &quot;GET&quot;, path);</span>
<a href="#l3.555"></a><span id="l3.555" class="difflineplus">+};</span>
<a href="#l3.556"></a><span id="l3.556" class="difflineplus">+</span>
<a href="#l3.557"></a><span id="l3.557" class="difflineplus">+/**</span>
<a href="#l3.558"></a><span id="l3.558" class="difflineplus">+ * Set the visbility of a room in the current HS's room directory</span>
<a href="#l3.559"></a><span id="l3.559" class="difflineplus">+ * @param {string} roomId</span>
<a href="#l3.560"></a><span id="l3.560" class="difflineplus">+ * @param {string} visibility &quot;public&quot; to make the room visible</span>
<a href="#l3.561"></a><span id="l3.561" class="difflineplus">+ *                 in the public directory, or &quot;private&quot; to make</span>
<a href="#l3.562"></a><span id="l3.562" class="difflineplus">+ *                 it invisible.</span>
<a href="#l3.563"></a><span id="l3.563" class="difflineplus">+ * @param {module:client.callback} callback Optional.</span>
<a href="#l3.564"></a><span id="l3.564" class="difflineplus">+ * @return {module:client.Promise} Resolves: result object</span>
<a href="#l3.565"></a><span id="l3.565" class="difflineplus">+ * @return {module:http-api.MatrixError} Rejects: with an error response.</span>
<a href="#l3.566"></a><span id="l3.566" class="difflineplus">+ */</span>
<a href="#l3.567"></a><span id="l3.567" class="difflineplus">+MatrixBaseApis.prototype.setRoomDirectoryVisibility =</span>
<a href="#l3.568"></a><span id="l3.568" class="difflineplus">+                                function(roomId, visibility, callback) {</span>
<a href="#l3.569"></a><span id="l3.569" class="difflineplus">+    var path = utils.encodeUri(&quot;/directory/list/room/$roomId&quot;, {</span>
<a href="#l3.570"></a><span id="l3.570" class="difflineplus">+        $roomId: roomId</span>
<a href="#l3.571"></a><span id="l3.571" class="difflineplus">+    });</span>
<a href="#l3.572"></a><span id="l3.572" class="difflineplus">+    return this._http.authedRequest(</span>
<a href="#l3.573"></a><span id="l3.573" class="difflineplus">+        callback, &quot;PUT&quot;, path, undefined, { &quot;visibility&quot;: visibility }</span>
<a href="#l3.574"></a><span id="l3.574" class="difflineplus">+    );</span>
<a href="#l3.575"></a><span id="l3.575" class="difflineplus">+};</span>
<a href="#l3.576"></a><span id="l3.576" class="difflineplus">+</span>
<a href="#l3.577"></a><span id="l3.577" class="difflineplus">+</span>
<a href="#l3.578"></a><span id="l3.578" class="difflineplus">+// Media operations</span>
<a href="#l3.579"></a><span id="l3.579" class="difflineplus">+// ================</span>
<a href="#l3.580"></a><span id="l3.580" class="difflineplus">+</span>
<a href="#l3.581"></a><span id="l3.581" class="difflineplus">+/**</span>
<a href="#l3.582"></a><span id="l3.582" class="difflineplus">+ * Upload a file to the media repository on the home server.</span>
<a href="#l3.583"></a><span id="l3.583" class="difflineplus">+ *</span>
<a href="#l3.584"></a><span id="l3.584" class="difflineplus">+ * @param {object} file The object to upload. On a browser, something that</span>
<a href="#l3.585"></a><span id="l3.585" class="difflineplus">+ *   can be sent to XMLHttpRequest.send (typically a File).  Under node.js,</span>
<a href="#l3.586"></a><span id="l3.586" class="difflineplus">+ *   a a Buffer, String or ReadStream.</span>
<a href="#l3.587"></a><span id="l3.587" class="difflineplus">+ *</span>
<a href="#l3.588"></a><span id="l3.588" class="difflineplus">+ * @param {object} opts  options object</span>
<a href="#l3.589"></a><span id="l3.589" class="difflineplus">+ *</span>
<a href="#l3.590"></a><span id="l3.590" class="difflineplus">+ * @param {string=} opts.name   Name to give the file on the server. Defaults</span>
<a href="#l3.591"></a><span id="l3.591" class="difflineplus">+ *   to &lt;tt&gt;file.name&lt;/tt&gt;.</span>
<a href="#l3.592"></a><span id="l3.592" class="difflineplus">+ *</span>
<a href="#l3.593"></a><span id="l3.593" class="difflineplus">+ * @param {string=} opts.type   Content-type for the upload. Defaults to</span>
<a href="#l3.594"></a><span id="l3.594" class="difflineplus">+ *   &lt;tt&gt;file.type&lt;/tt&gt;, or &lt;tt&gt;applicaton/octet-stream&lt;/tt&gt;.</span>
<a href="#l3.595"></a><span id="l3.595" class="difflineplus">+ *</span>
<a href="#l3.596"></a><span id="l3.596" class="difflineplus">+ * @param {boolean=} opts.rawResponse Return the raw body, rather than</span>
<a href="#l3.597"></a><span id="l3.597" class="difflineplus">+ *   parsing the JSON. Defaults to false (except on node.js, where it</span>
<a href="#l3.598"></a><span id="l3.598" class="difflineplus">+ *   defaults to true for backwards compatibility).</span>
<a href="#l3.599"></a><span id="l3.599" class="difflineplus">+ *</span>
<a href="#l3.600"></a><span id="l3.600" class="difflineplus">+ * @param {boolean=} opts.onlyContentUri Just return the content URI,</span>
<a href="#l3.601"></a><span id="l3.601" class="difflineplus">+ *   rather than the whole body. Defaults to false (except on browsers,</span>
<a href="#l3.602"></a><span id="l3.602" class="difflineplus">+ *   where it defaults to true for backwards compatibility). Ignored if</span>
<a href="#l3.603"></a><span id="l3.603" class="difflineplus">+ *   opts.rawResponse is true.</span>
<a href="#l3.604"></a><span id="l3.604" class="difflineplus">+ *</span>
<a href="#l3.605"></a><span id="l3.605" class="difflineplus">+ * @param {Function=} opts.callback Deprecated. Optional. The callback to</span>
<a href="#l3.606"></a><span id="l3.606" class="difflineplus">+ *    invoke on success/failure. See the promise return values for more</span>
<a href="#l3.607"></a><span id="l3.607" class="difflineplus">+ *    information.</span>
<a href="#l3.608"></a><span id="l3.608" class="difflineplus">+ *</span>
<a href="#l3.609"></a><span id="l3.609" class="difflineplus">+ * @return {module:client.Promise} Resolves to response object, as</span>
<a href="#l3.610"></a><span id="l3.610" class="difflineplus">+ *    determined by this.opts.onlyData, opts.rawResponse, and</span>
<a href="#l3.611"></a><span id="l3.611" class="difflineplus">+ *    opts.onlyContentUri.  Rejects with an error (usually a MatrixError).</span>
<a href="#l3.612"></a><span id="l3.612" class="difflineplus">+ */</span>
<a href="#l3.613"></a><span id="l3.613" class="difflineplus">+MatrixBaseApis.prototype.uploadContent = function(file, opts) {</span>
<a href="#l3.614"></a><span id="l3.614" class="difflineplus">+    return this._http.uploadContent(file, opts);</span>
<a href="#l3.615"></a><span id="l3.615" class="difflineplus">+};</span>
<a href="#l3.616"></a><span id="l3.616" class="difflineplus">+</span>
<a href="#l3.617"></a><span id="l3.617" class="difflineplus">+/**</span>
<a href="#l3.618"></a><span id="l3.618" class="difflineplus">+ * Cancel a file upload in progress</span>
<a href="#l3.619"></a><span id="l3.619" class="difflineplus">+ * @param {module:client.Promise} promise The promise returned from uploadContent</span>
<a href="#l3.620"></a><span id="l3.620" class="difflineplus">+ * @return {boolean} true if canceled, otherwise false</span>
<a href="#l3.621"></a><span id="l3.621" class="difflineplus">+ */</span>
<a href="#l3.622"></a><span id="l3.622" class="difflineplus">+MatrixBaseApis.prototype.cancelUpload = function(promise) {</span>
<a href="#l3.623"></a><span id="l3.623" class="difflineplus">+    return this._http.cancelUpload(promise);</span>
<a href="#l3.624"></a><span id="l3.624" class="difflineplus">+};</span>
<a href="#l3.625"></a><span id="l3.625" class="difflineplus">+</span>
<a href="#l3.626"></a><span id="l3.626" class="difflineplus">+/**</span>
<a href="#l3.627"></a><span id="l3.627" class="difflineplus">+ * Get a list of all file uploads in progress</span>
<a href="#l3.628"></a><span id="l3.628" class="difflineplus">+ * @return {array} Array of objects representing current uploads.</span>
<a href="#l3.629"></a><span id="l3.629" class="difflineplus">+ * Currently in progress is element 0. Keys:</span>
<a href="#l3.630"></a><span id="l3.630" class="difflineplus">+ *  - promise: The promise associated with the upload</span>
<a href="#l3.631"></a><span id="l3.631" class="difflineplus">+ *  - loaded: Number of bytes uploaded</span>
<a href="#l3.632"></a><span id="l3.632" class="difflineplus">+ *  - total: Total number of bytes to upload</span>
<a href="#l3.633"></a><span id="l3.633" class="difflineplus">+ */</span>
<a href="#l3.634"></a><span id="l3.634" class="difflineplus">+MatrixBaseApis.prototype.getCurrentUploads = function() {</span>
<a href="#l3.635"></a><span id="l3.635" class="difflineplus">+    return this._http.getCurrentUploads();</span>
<a href="#l3.636"></a><span id="l3.636" class="difflineplus">+};</span>
<a href="#l3.637"></a><span id="l3.637" class="difflineplus">+</span>
<a href="#l3.638"></a><span id="l3.638" class="difflineplus">+</span>
<a href="#l3.639"></a><span id="l3.639" class="difflineplus">+// Profile operations</span>
<a href="#l3.640"></a><span id="l3.640" class="difflineplus">+// ==================</span>
<a href="#l3.641"></a><span id="l3.641" class="difflineplus">+</span>
<a href="#l3.642"></a><span id="l3.642" class="difflineplus">+/**</span>
<a href="#l3.643"></a><span id="l3.643" class="difflineplus">+ * @param {string} userId</span>
<a href="#l3.644"></a><span id="l3.644" class="difflineplus">+ * @param {string} info The kind of info to retrieve (e.g. 'displayname',</span>
<a href="#l3.645"></a><span id="l3.645" class="difflineplus">+ * 'avatar_url').</span>
<a href="#l3.646"></a><span id="l3.646" class="difflineplus">+ * @param {module:client.callback} callback Optional.</span>
<a href="#l3.647"></a><span id="l3.647" class="difflineplus">+ * @return {module:client.Promise} Resolves: TODO</span>
<a href="#l3.648"></a><span id="l3.648" class="difflineplus">+ * @return {module:http-api.MatrixError} Rejects: with an error response.</span>
<a href="#l3.649"></a><span id="l3.649" class="difflineplus">+ */</span>
<a href="#l3.650"></a><span id="l3.650" class="difflineplus">+MatrixBaseApis.prototype.getProfileInfo = function(userId, info, callback) {</span>
<a href="#l3.651"></a><span id="l3.651" class="difflineplus">+    if (utils.isFunction(info)) { callback = info; info = undefined; }</span>
<a href="#l3.652"></a><span id="l3.652" class="difflineplus">+</span>
<a href="#l3.653"></a><span id="l3.653" class="difflineplus">+    var path = info ?</span>
<a href="#l3.654"></a><span id="l3.654" class="difflineplus">+    utils.encodeUri(&quot;/profile/$userId/$info&quot;,</span>
<a href="#l3.655"></a><span id="l3.655" class="difflineplus">+             { $userId: userId, $info: info }) :</span>
<a href="#l3.656"></a><span id="l3.656" class="difflineplus">+    utils.encodeUri(&quot;/profile/$userId&quot;,</span>
<a href="#l3.657"></a><span id="l3.657" class="difflineplus">+             { $userId: userId });</span>
<a href="#l3.658"></a><span id="l3.658" class="difflineplus">+    return this._http.authedRequest(callback, &quot;GET&quot;, path);</span>
<a href="#l3.659"></a><span id="l3.659" class="difflineplus">+};</span>
<a href="#l3.660"></a><span id="l3.660" class="difflineplus">+</span>
<a href="#l3.661"></a><span id="l3.661" class="difflineplus">+</span>
<a href="#l3.662"></a><span id="l3.662" class="difflineplus">+// Account operations</span>
<a href="#l3.663"></a><span id="l3.663" class="difflineplus">+// ==================</span>
<a href="#l3.664"></a><span id="l3.664" class="difflineplus">+</span>
<a href="#l3.665"></a><span id="l3.665" class="difflineplus">+/**</span>
<a href="#l3.666"></a><span id="l3.666" class="difflineplus">+ * @param {module:client.callback} callback Optional.</span>
<a href="#l3.667"></a><span id="l3.667" class="difflineplus">+ * @return {module:client.Promise} Resolves: TODO</span>
<a href="#l3.668"></a><span id="l3.668" class="difflineplus">+ * @return {module:http-api.MatrixError} Rejects: with an error response.</span>
<a href="#l3.669"></a><span id="l3.669" class="difflineplus">+ */</span>
<a href="#l3.670"></a><span id="l3.670" class="difflineplus">+MatrixBaseApis.prototype.getThreePids = function(callback) {</span>
<a href="#l3.671"></a><span id="l3.671" class="difflineplus">+    var path = &quot;/account/3pid&quot;;</span>
<a href="#l3.672"></a><span id="l3.672" class="difflineplus">+    return this._http.authedRequest(</span>
<a href="#l3.673"></a><span id="l3.673" class="difflineplus">+        callback, &quot;GET&quot;, path, undefined, undefined</span>
<a href="#l3.674"></a><span id="l3.674" class="difflineplus">+    );</span>
<a href="#l3.675"></a><span id="l3.675" class="difflineplus">+};</span>
<a href="#l3.676"></a><span id="l3.676" class="difflineplus">+</span>
<a href="#l3.677"></a><span id="l3.677" class="difflineplus">+/**</span>
<a href="#l3.678"></a><span id="l3.678" class="difflineplus">+ * @param {Object} creds</span>
<a href="#l3.679"></a><span id="l3.679" class="difflineplus">+ * @param {boolean} bind</span>
<a href="#l3.680"></a><span id="l3.680" class="difflineplus">+ * @param {module:client.callback} callback Optional.</span>
<a href="#l3.681"></a><span id="l3.681" class="difflineplus">+ * @return {module:client.Promise} Resolves: TODO</span>
<a href="#l3.682"></a><span id="l3.682" class="difflineplus">+ * @return {module:http-api.MatrixError} Rejects: with an error response.</span>
<a href="#l3.683"></a><span id="l3.683" class="difflineplus">+ */</span>
<a href="#l3.684"></a><span id="l3.684" class="difflineplus">+MatrixBaseApis.prototype.addThreePid = function(creds, bind, callback) {</span>
<a href="#l3.685"></a><span id="l3.685" class="difflineplus">+    var path = &quot;/account/3pid&quot;;</span>
<a href="#l3.686"></a><span id="l3.686" class="difflineplus">+    var data = {</span>
<a href="#l3.687"></a><span id="l3.687" class="difflineplus">+        'threePidCreds': creds,</span>
<a href="#l3.688"></a><span id="l3.688" class="difflineplus">+        'bind': bind</span>
<a href="#l3.689"></a><span id="l3.689" class="difflineplus">+    };</span>
<a href="#l3.690"></a><span id="l3.690" class="difflineplus">+    return this._http.authedRequest(</span>
<a href="#l3.691"></a><span id="l3.691" class="difflineplus">+        callback, &quot;POST&quot;, path, null, data</span>
<a href="#l3.692"></a><span id="l3.692" class="difflineplus">+    );</span>
<a href="#l3.693"></a><span id="l3.693" class="difflineplus">+};</span>
<a href="#l3.694"></a><span id="l3.694" class="difflineplus">+</span>
<a href="#l3.695"></a><span id="l3.695" class="difflineplus">+/**</span>
<a href="#l3.696"></a><span id="l3.696" class="difflineplus">+ * Make a request to change your password.</span>
<a href="#l3.697"></a><span id="l3.697" class="difflineplus">+ * @param {Object} authDict</span>
<a href="#l3.698"></a><span id="l3.698" class="difflineplus">+ * @param {string} newPassword The new desired password.</span>
<a href="#l3.699"></a><span id="l3.699" class="difflineplus">+ * @param {module:client.callback} callback Optional.</span>
<a href="#l3.700"></a><span id="l3.700" class="difflineplus">+ * @return {module:client.Promise} Resolves: TODO</span>
<a href="#l3.701"></a><span id="l3.701" class="difflineplus">+ * @return {module:http-api.MatrixError} Rejects: with an error response.</span>
<a href="#l3.702"></a><span id="l3.702" class="difflineplus">+ */</span>
<a href="#l3.703"></a><span id="l3.703" class="difflineplus">+MatrixBaseApis.prototype.setPassword = function(authDict, newPassword, callback) {</span>
<a href="#l3.704"></a><span id="l3.704" class="difflineplus">+    var path = &quot;/account/password&quot;;</span>
<a href="#l3.705"></a><span id="l3.705" class="difflineplus">+    var data = {</span>
<a href="#l3.706"></a><span id="l3.706" class="difflineplus">+        'auth': authDict,</span>
<a href="#l3.707"></a><span id="l3.707" class="difflineplus">+        'new_password': newPassword</span>
<a href="#l3.708"></a><span id="l3.708" class="difflineplus">+    };</span>
<a href="#l3.709"></a><span id="l3.709" class="difflineplus">+</span>
<a href="#l3.710"></a><span id="l3.710" class="difflineplus">+    return this._http.authedRequest(</span>
<a href="#l3.711"></a><span id="l3.711" class="difflineplus">+        callback, &quot;POST&quot;, path, null, data</span>
<a href="#l3.712"></a><span id="l3.712" class="difflineplus">+    );</span>
<a href="#l3.713"></a><span id="l3.713" class="difflineplus">+};</span>
<a href="#l3.714"></a><span id="l3.714" class="difflineplus">+</span>
<a href="#l3.715"></a><span id="l3.715" class="difflineplus">+</span>
<a href="#l3.716"></a><span id="l3.716" class="difflineplus">+// Device operations</span>
<a href="#l3.717"></a><span id="l3.717" class="difflineplus">+// =================</span>
<a href="#l3.718"></a><span id="l3.718" class="difflineplus">+</span>
<a href="#l3.719"></a><span id="l3.719" class="difflineplus">+/**</span>
<a href="#l3.720"></a><span id="l3.720" class="difflineplus">+ * Gets all devices recorded for the logged-in user</span>
<a href="#l3.721"></a><span id="l3.721" class="difflineplus">+ * @return {module:client.Promise} Resolves: result object</span>
<a href="#l3.722"></a><span id="l3.722" class="difflineplus">+ * @return {module:http-api.MatrixError} Rejects: with an error response.</span>
<a href="#l3.723"></a><span id="l3.723" class="difflineplus">+ */</span>
<a href="#l3.724"></a><span id="l3.724" class="difflineplus">+MatrixBaseApis.prototype.getDevices = function() {</span>
<a href="#l3.725"></a><span id="l3.725" class="difflineplus">+    var path = &quot;/devices&quot;;</span>
<a href="#l3.726"></a><span id="l3.726" class="difflineplus">+    return this._http.authedRequestWithPrefix(</span>
<a href="#l3.727"></a><span id="l3.727" class="difflineplus">+        undefined, &quot;GET&quot;, path, undefined, undefined,</span>
<a href="#l3.728"></a><span id="l3.728" class="difflineplus">+        httpApi.PREFIX_UNSTABLE</span>
<a href="#l3.729"></a><span id="l3.729" class="difflineplus">+    );</span>
<a href="#l3.730"></a><span id="l3.730" class="difflineplus">+};</span>
<a href="#l3.731"></a><span id="l3.731" class="difflineplus">+</span>
<a href="#l3.732"></a><span id="l3.732" class="difflineplus">+/**</span>
<a href="#l3.733"></a><span id="l3.733" class="difflineplus">+ * Update the given device</span>
<a href="#l3.734"></a><span id="l3.734" class="difflineplus">+ *</span>
<a href="#l3.735"></a><span id="l3.735" class="difflineplus">+ * @param {string} device_id  device to update</span>
<a href="#l3.736"></a><span id="l3.736" class="difflineplus">+ * @param {Object} body       body of request</span>
<a href="#l3.737"></a><span id="l3.737" class="difflineplus">+ * @return {module:client.Promise} Resolves: result object</span>
<a href="#l3.738"></a><span id="l3.738" class="difflineplus">+ * @return {module:http-api.MatrixError} Rejects: with an error response.</span>
<a href="#l3.739"></a><span id="l3.739" class="difflineplus">+ */</span>
<a href="#l3.740"></a><span id="l3.740" class="difflineplus">+MatrixBaseApis.prototype.setDeviceDetails = function(device_id, body) {</span>
<a href="#l3.741"></a><span id="l3.741" class="difflineplus">+    var path = utils.encodeUri(&quot;/devices/$device_id&quot;, {</span>
<a href="#l3.742"></a><span id="l3.742" class="difflineplus">+        $device_id: device_id,</span>
<a href="#l3.743"></a><span id="l3.743" class="difflineplus">+    });</span>
<a href="#l3.744"></a><span id="l3.744" class="difflineplus">+</span>
<a href="#l3.745"></a><span id="l3.745" class="difflineplus">+</span>
<a href="#l3.746"></a><span id="l3.746" class="difflineplus">+    return this._http.authedRequestWithPrefix(</span>
<a href="#l3.747"></a><span id="l3.747" class="difflineplus">+        undefined, &quot;PUT&quot;, path, undefined, body,</span>
<a href="#l3.748"></a><span id="l3.748" class="difflineplus">+        httpApi.PREFIX_UNSTABLE</span>
<a href="#l3.749"></a><span id="l3.749" class="difflineplus">+    );</span>
<a href="#l3.750"></a><span id="l3.750" class="difflineplus">+};</span>
<a href="#l3.751"></a><span id="l3.751" class="difflineplus">+</span>
<a href="#l3.752"></a><span id="l3.752" class="difflineplus">+/**</span>
<a href="#l3.753"></a><span id="l3.753" class="difflineplus">+ * Delete the given device</span>
<a href="#l3.754"></a><span id="l3.754" class="difflineplus">+ *</span>
<a href="#l3.755"></a><span id="l3.755" class="difflineplus">+ * @param {string} device_id  device to delete</span>
<a href="#l3.756"></a><span id="l3.756" class="difflineplus">+ * @param {object} auth Optional. Auth data to supply for User-Interactive auth.</span>
<a href="#l3.757"></a><span id="l3.757" class="difflineplus">+ * @return {module:client.Promise} Resolves: result object</span>
<a href="#l3.758"></a><span id="l3.758" class="difflineplus">+ * @return {module:http-api.MatrixError} Rejects: with an error response.</span>
<a href="#l3.759"></a><span id="l3.759" class="difflineplus">+ */</span>
<a href="#l3.760"></a><span id="l3.760" class="difflineplus">+MatrixBaseApis.prototype.deleteDevice = function(device_id, auth) {</span>
<a href="#l3.761"></a><span id="l3.761" class="difflineplus">+    var path = utils.encodeUri(&quot;/devices/$device_id&quot;, {</span>
<a href="#l3.762"></a><span id="l3.762" class="difflineplus">+        $device_id: device_id,</span>
<a href="#l3.763"></a><span id="l3.763" class="difflineplus">+    });</span>
<a href="#l3.764"></a><span id="l3.764" class="difflineplus">+</span>
<a href="#l3.765"></a><span id="l3.765" class="difflineplus">+    var body = {};</span>
<a href="#l3.766"></a><span id="l3.766" class="difflineplus">+</span>
<a href="#l3.767"></a><span id="l3.767" class="difflineplus">+    if (auth) {</span>
<a href="#l3.768"></a><span id="l3.768" class="difflineplus">+        body.auth = auth;</span>
<a href="#l3.769"></a><span id="l3.769" class="difflineplus">+    }</span>
<a href="#l3.770"></a><span id="l3.770" class="difflineplus">+</span>
<a href="#l3.771"></a><span id="l3.771" class="difflineplus">+    return this._http.authedRequestWithPrefix(</span>
<a href="#l3.772"></a><span id="l3.772" class="difflineplus">+        undefined, &quot;DELETE&quot;, path, undefined, body,</span>
<a href="#l3.773"></a><span id="l3.773" class="difflineplus">+        httpApi.PREFIX_UNSTABLE</span>
<a href="#l3.774"></a><span id="l3.774" class="difflineplus">+    );</span>
<a href="#l3.775"></a><span id="l3.775" class="difflineplus">+};</span>
<a href="#l3.776"></a><span id="l3.776" class="difflineplus">+</span>
<a href="#l3.777"></a><span id="l3.777" class="difflineplus">+</span>
<a href="#l3.778"></a><span id="l3.778" class="difflineplus">+// Push operations</span>
<a href="#l3.779"></a><span id="l3.779" class="difflineplus">+// ===============</span>
<a href="#l3.780"></a><span id="l3.780" class="difflineplus">+</span>
<a href="#l3.781"></a><span id="l3.781" class="difflineplus">+/**</span>
<a href="#l3.782"></a><span id="l3.782" class="difflineplus">+ * Gets all pushers registered for the logged-in user</span>
<a href="#l3.783"></a><span id="l3.783" class="difflineplus">+ *</span>
<a href="#l3.784"></a><span id="l3.784" class="difflineplus">+ * @param {module:client.callback} callback Optional.</span>
<a href="#l3.785"></a><span id="l3.785" class="difflineplus">+ * @return {module:client.Promise} Resolves: Array of objects representing pushers</span>
<a href="#l3.786"></a><span id="l3.786" class="difflineplus">+ * @return {module:http-api.MatrixError} Rejects: with an error response.</span>
<a href="#l3.787"></a><span id="l3.787" class="difflineplus">+ */</span>
<a href="#l3.788"></a><span id="l3.788" class="difflineplus">+MatrixBaseApis.prototype.getPushers = function(callback) {</span>
<a href="#l3.789"></a><span id="l3.789" class="difflineplus">+    var path = &quot;/pushers&quot;;</span>
<a href="#l3.790"></a><span id="l3.790" class="difflineplus">+    return this._http.authedRequest(</span>
<a href="#l3.791"></a><span id="l3.791" class="difflineplus">+        callback, &quot;GET&quot;, path, undefined, undefined</span>
<a href="#l3.792"></a><span id="l3.792" class="difflineplus">+    );</span>
<a href="#l3.793"></a><span id="l3.793" class="difflineplus">+};</span>
<a href="#l3.794"></a><span id="l3.794" class="difflineplus">+</span>
<a href="#l3.795"></a><span id="l3.795" class="difflineplus">+/**</span>
<a href="#l3.796"></a><span id="l3.796" class="difflineplus">+ * Adds a new pusher or updates an existing pusher</span>
<a href="#l3.797"></a><span id="l3.797" class="difflineplus">+ *</span>
<a href="#l3.798"></a><span id="l3.798" class="difflineplus">+ * @param {Object} pusher Object representing a pusher</span>
<a href="#l3.799"></a><span id="l3.799" class="difflineplus">+ * @param {module:client.callback} callback Optional.</span>
<a href="#l3.800"></a><span id="l3.800" class="difflineplus">+ * @return {module:client.Promise} Resolves: Empty json object on success</span>
<a href="#l3.801"></a><span id="l3.801" class="difflineplus">+ * @return {module:http-api.MatrixError} Rejects: with an error response.</span>
<a href="#l3.802"></a><span id="l3.802" class="difflineplus">+ */</span>
<a href="#l3.803"></a><span id="l3.803" class="difflineplus">+MatrixBaseApis.prototype.setPusher = function(pusher, callback) {</span>
<a href="#l3.804"></a><span id="l3.804" class="difflineplus">+    var path = &quot;/pushers/set&quot;;</span>
<a href="#l3.805"></a><span id="l3.805" class="difflineplus">+    return this._http.authedRequest(</span>
<a href="#l3.806"></a><span id="l3.806" class="difflineplus">+        callback, &quot;POST&quot;, path, null, pusher</span>
<a href="#l3.807"></a><span id="l3.807" class="difflineplus">+    );</span>
<a href="#l3.808"></a><span id="l3.808" class="difflineplus">+};</span>
<a href="#l3.809"></a><span id="l3.809" class="difflineplus">+</span>
<a href="#l3.810"></a><span id="l3.810" class="difflineplus">+/**</span>
<a href="#l3.811"></a><span id="l3.811" class="difflineplus">+ * @param {module:client.callback} callback Optional.</span>
<a href="#l3.812"></a><span id="l3.812" class="difflineplus">+ * @return {module:client.Promise} Resolves: TODO</span>
<a href="#l3.813"></a><span id="l3.813" class="difflineplus">+ * @return {module:http-api.MatrixError} Rejects: with an error response.</span>
<a href="#l3.814"></a><span id="l3.814" class="difflineplus">+ */</span>
<a href="#l3.815"></a><span id="l3.815" class="difflineplus">+MatrixBaseApis.prototype.getPushRules = function(callback) {</span>
<a href="#l3.816"></a><span id="l3.816" class="difflineplus">+    return this._http.authedRequest(callback, &quot;GET&quot;, &quot;/pushrules/&quot;);</span>
<a href="#l3.817"></a><span id="l3.817" class="difflineplus">+};</span>
<a href="#l3.818"></a><span id="l3.818" class="difflineplus">+</span>
<a href="#l3.819"></a><span id="l3.819" class="difflineplus">+/**</span>
<a href="#l3.820"></a><span id="l3.820" class="difflineplus">+ * @param {string} scope</span>
<a href="#l3.821"></a><span id="l3.821" class="difflineplus">+ * @param {string} kind</span>
<a href="#l3.822"></a><span id="l3.822" class="difflineplus">+ * @param {string} ruleId</span>
<a href="#l3.823"></a><span id="l3.823" class="difflineplus">+ * @param {Object} body</span>
<a href="#l3.824"></a><span id="l3.824" class="difflineplus">+ * @param {module:client.callback} callback Optional.</span>
<a href="#l3.825"></a><span id="l3.825" class="difflineplus">+ * @return {module:client.Promise} Resolves: TODO</span>
<a href="#l3.826"></a><span id="l3.826" class="difflineplus">+ * @return {module:http-api.MatrixError} Rejects: with an error response.</span>
<a href="#l3.827"></a><span id="l3.827" class="difflineplus">+ */</span>
<a href="#l3.828"></a><span id="l3.828" class="difflineplus">+MatrixBaseApis.prototype.addPushRule = function(scope, kind, ruleId, body, callback) {</span>
<a href="#l3.829"></a><span id="l3.829" class="difflineplus">+    // NB. Scope not uri encoded because devices need the '/'</span>
<a href="#l3.830"></a><span id="l3.830" class="difflineplus">+    var path = utils.encodeUri(&quot;/pushrules/&quot; + scope + &quot;/$kind/$ruleId&quot;, {</span>
<a href="#l3.831"></a><span id="l3.831" class="difflineplus">+        $kind: kind,</span>
<a href="#l3.832"></a><span id="l3.832" class="difflineplus">+        $ruleId: ruleId</span>
<a href="#l3.833"></a><span id="l3.833" class="difflineplus">+    });</span>
<a href="#l3.834"></a><span id="l3.834" class="difflineplus">+    return this._http.authedRequest(</span>
<a href="#l3.835"></a><span id="l3.835" class="difflineplus">+        callback, &quot;PUT&quot;, path, undefined, body</span>
<a href="#l3.836"></a><span id="l3.836" class="difflineplus">+    );</span>
<a href="#l3.837"></a><span id="l3.837" class="difflineplus">+};</span>
<a href="#l3.838"></a><span id="l3.838" class="difflineplus">+</span>
<a href="#l3.839"></a><span id="l3.839" class="difflineplus">+/**</span>
<a href="#l3.840"></a><span id="l3.840" class="difflineplus">+ * @param {string} scope</span>
<a href="#l3.841"></a><span id="l3.841" class="difflineplus">+ * @param {string} kind</span>
<a href="#l3.842"></a><span id="l3.842" class="difflineplus">+ * @param {string} ruleId</span>
<a href="#l3.843"></a><span id="l3.843" class="difflineplus">+ * @param {module:client.callback} callback Optional.</span>
<a href="#l3.844"></a><span id="l3.844" class="difflineplus">+ * @return {module:client.Promise} Resolves: TODO</span>
<a href="#l3.845"></a><span id="l3.845" class="difflineplus">+ * @return {module:http-api.MatrixError} Rejects: with an error response.</span>
<a href="#l3.846"></a><span id="l3.846" class="difflineplus">+ */</span>
<a href="#l3.847"></a><span id="l3.847" class="difflineplus">+MatrixBaseApis.prototype.deletePushRule = function(scope, kind, ruleId, callback) {</span>
<a href="#l3.848"></a><span id="l3.848" class="difflineplus">+    // NB. Scope not uri encoded because devices need the '/'</span>
<a href="#l3.849"></a><span id="l3.849" class="difflineplus">+    var path = utils.encodeUri(&quot;/pushrules/&quot; + scope + &quot;/$kind/$ruleId&quot;, {</span>
<a href="#l3.850"></a><span id="l3.850" class="difflineplus">+        $kind: kind,</span>
<a href="#l3.851"></a><span id="l3.851" class="difflineplus">+        $ruleId: ruleId</span>
<a href="#l3.852"></a><span id="l3.852" class="difflineplus">+    });</span>
<a href="#l3.853"></a><span id="l3.853" class="difflineplus">+    return this._http.authedRequest(callback, &quot;DELETE&quot;, path);</span>
<a href="#l3.854"></a><span id="l3.854" class="difflineplus">+};</span>
<a href="#l3.855"></a><span id="l3.855" class="difflineplus">+</span>
<a href="#l3.856"></a><span id="l3.856" class="difflineplus">+/**</span>
<a href="#l3.857"></a><span id="l3.857" class="difflineplus">+ * Enable or disable a push notification rule.</span>
<a href="#l3.858"></a><span id="l3.858" class="difflineplus">+ * @param {string} scope</span>
<a href="#l3.859"></a><span id="l3.859" class="difflineplus">+ * @param {string} kind</span>
<a href="#l3.860"></a><span id="l3.860" class="difflineplus">+ * @param {string} ruleId</span>
<a href="#l3.861"></a><span id="l3.861" class="difflineplus">+ * @param {boolean} enabled</span>
<a href="#l3.862"></a><span id="l3.862" class="difflineplus">+ * @param {module:client.callback} callback Optional.</span>
<a href="#l3.863"></a><span id="l3.863" class="difflineplus">+ * @return {module:client.Promise} Resolves: result object</span>
<a href="#l3.864"></a><span id="l3.864" class="difflineplus">+ * @return {module:http-api.MatrixError} Rejects: with an error response.</span>
<a href="#l3.865"></a><span id="l3.865" class="difflineplus">+ */</span>
<a href="#l3.866"></a><span id="l3.866" class="difflineplus">+MatrixBaseApis.prototype.setPushRuleEnabled = function(scope, kind,</span>
<a href="#l3.867"></a><span id="l3.867" class="difflineplus">+                                                     ruleId, enabled, callback) {</span>
<a href="#l3.868"></a><span id="l3.868" class="difflineplus">+    var path = utils.encodeUri(&quot;/pushrules/&quot; + scope + &quot;/$kind/$ruleId/enabled&quot;, {</span>
<a href="#l3.869"></a><span id="l3.869" class="difflineplus">+        $kind: kind,</span>
<a href="#l3.870"></a><span id="l3.870" class="difflineplus">+        $ruleId: ruleId</span>
<a href="#l3.871"></a><span id="l3.871" class="difflineplus">+    });</span>
<a href="#l3.872"></a><span id="l3.872" class="difflineplus">+    return this._http.authedRequest(</span>
<a href="#l3.873"></a><span id="l3.873" class="difflineplus">+        callback, &quot;PUT&quot;, path, undefined, {&quot;enabled&quot;: enabled}</span>
<a href="#l3.874"></a><span id="l3.874" class="difflineplus">+    );</span>
<a href="#l3.875"></a><span id="l3.875" class="difflineplus">+};</span>
<a href="#l3.876"></a><span id="l3.876" class="difflineplus">+</span>
<a href="#l3.877"></a><span id="l3.877" class="difflineplus">+/**</span>
<a href="#l3.878"></a><span id="l3.878" class="difflineplus">+ * Set the actions for a push notification rule.</span>
<a href="#l3.879"></a><span id="l3.879" class="difflineplus">+ * @param {string} scope</span>
<a href="#l3.880"></a><span id="l3.880" class="difflineplus">+ * @param {string} kind</span>
<a href="#l3.881"></a><span id="l3.881" class="difflineplus">+ * @param {string} ruleId</span>
<a href="#l3.882"></a><span id="l3.882" class="difflineplus">+ * @param {array} actions</span>
<a href="#l3.883"></a><span id="l3.883" class="difflineplus">+ * @param {module:client.callback} callback Optional.</span>
<a href="#l3.884"></a><span id="l3.884" class="difflineplus">+ * @return {module:client.Promise} Resolves: result object</span>
<a href="#l3.885"></a><span id="l3.885" class="difflineplus">+ * @return {module:http-api.MatrixError} Rejects: with an error response.</span>
<a href="#l3.886"></a><span id="l3.886" class="difflineplus">+ */</span>
<a href="#l3.887"></a><span id="l3.887" class="difflineplus">+MatrixBaseApis.prototype.setPushRuleActions = function(scope, kind,</span>
<a href="#l3.888"></a><span id="l3.888" class="difflineplus">+                                                     ruleId, actions, callback) {</span>
<a href="#l3.889"></a><span id="l3.889" class="difflineplus">+    var path = utils.encodeUri(&quot;/pushrules/&quot; + scope + &quot;/$kind/$ruleId/actions&quot;, {</span>
<a href="#l3.890"></a><span id="l3.890" class="difflineplus">+        $kind: kind,</span>
<a href="#l3.891"></a><span id="l3.891" class="difflineplus">+        $ruleId: ruleId</span>
<a href="#l3.892"></a><span id="l3.892" class="difflineplus">+    });</span>
<a href="#l3.893"></a><span id="l3.893" class="difflineplus">+    return this._http.authedRequest(</span>
<a href="#l3.894"></a><span id="l3.894" class="difflineplus">+        callback, &quot;PUT&quot;, path, undefined, {&quot;actions&quot;: actions}</span>
<a href="#l3.895"></a><span id="l3.895" class="difflineplus">+    );</span>
<a href="#l3.896"></a><span id="l3.896" class="difflineplus">+};</span>
<a href="#l3.897"></a><span id="l3.897" class="difflineplus">+</span>
<a href="#l3.898"></a><span id="l3.898" class="difflineplus">+</span>
<a href="#l3.899"></a><span id="l3.899" class="difflineplus">+// Search</span>
<a href="#l3.900"></a><span id="l3.900" class="difflineplus">+// ======</span>
<a href="#l3.901"></a><span id="l3.901" class="difflineplus">+</span>
<a href="#l3.902"></a><span id="l3.902" class="difflineplus">+/**</span>
<a href="#l3.903"></a><span id="l3.903" class="difflineplus">+ * Perform a server-side search.</span>
<a href="#l3.904"></a><span id="l3.904" class="difflineplus">+ * @param {Object} opts</span>
<a href="#l3.905"></a><span id="l3.905" class="difflineplus">+ * @param {string} opts.next_batch the batch token to pass in the query string</span>
<a href="#l3.906"></a><span id="l3.906" class="difflineplus">+ * @param {Object} opts.body the JSON object to pass to the request body.</span>
<a href="#l3.907"></a><span id="l3.907" class="difflineplus">+ * @param {module:client.callback} callback Optional.</span>
<a href="#l3.908"></a><span id="l3.908" class="difflineplus">+ * @return {module:client.Promise} Resolves: TODO</span>
<a href="#l3.909"></a><span id="l3.909" class="difflineplus">+ * @return {module:http-api.MatrixError} Rejects: with an error response.</span>
<a href="#l3.910"></a><span id="l3.910" class="difflineplus">+ */</span>
<a href="#l3.911"></a><span id="l3.911" class="difflineplus">+MatrixBaseApis.prototype.search = function(opts, callback) {</span>
<a href="#l3.912"></a><span id="l3.912" class="difflineplus">+    var queryparams = {};</span>
<a href="#l3.913"></a><span id="l3.913" class="difflineplus">+    if (opts.next_batch) {</span>
<a href="#l3.914"></a><span id="l3.914" class="difflineplus">+        queryparams.next_batch = opts.next_batch;</span>
<a href="#l3.915"></a><span id="l3.915" class="difflineplus">+    }</span>
<a href="#l3.916"></a><span id="l3.916" class="difflineplus">+    return this._http.authedRequest(</span>
<a href="#l3.917"></a><span id="l3.917" class="difflineplus">+        callback, &quot;POST&quot;, &quot;/search&quot;, queryparams, opts.body</span>
<a href="#l3.918"></a><span id="l3.918" class="difflineplus">+    );</span>
<a href="#l3.919"></a><span id="l3.919" class="difflineplus">+};</span>
<a href="#l3.920"></a><span id="l3.920" class="difflineplus">+</span>
<a href="#l3.921"></a><span id="l3.921" class="difflineplus">+// Crypto</span>
<a href="#l3.922"></a><span id="l3.922" class="difflineplus">+// ======</span>
<a href="#l3.923"></a><span id="l3.923" class="difflineplus">+</span>
<a href="#l3.924"></a><span id="l3.924" class="difflineplus">+/**</span>
<a href="#l3.925"></a><span id="l3.925" class="difflineplus">+ * Upload keys</span>
<a href="#l3.926"></a><span id="l3.926" class="difflineplus">+ *</span>
<a href="#l3.927"></a><span id="l3.927" class="difflineplus">+ * @param {Object} content  body of upload request</span>
<a href="#l3.928"></a><span id="l3.928" class="difflineplus">+ *</span>
<a href="#l3.929"></a><span id="l3.929" class="difflineplus">+ * @param {Object=} opts</span>
<a href="#l3.930"></a><span id="l3.930" class="difflineplus">+ *</span>
<a href="#l3.931"></a><span id="l3.931" class="difflineplus">+ * @param {string=} opts.device_id  explicit device_id to use for upload</span>
<a href="#l3.932"></a><span id="l3.932" class="difflineplus">+ *    (default is to use the same as that used during auth).</span>
<a href="#l3.933"></a><span id="l3.933" class="difflineplus">+ *</span>
<a href="#l3.934"></a><span id="l3.934" class="difflineplus">+ * @param {module:client.callback=} callback</span>
<a href="#l3.935"></a><span id="l3.935" class="difflineplus">+ *</span>
<a href="#l3.936"></a><span id="l3.936" class="difflineplus">+ * @return {module:client.Promise} Resolves: result object. Rejects: with</span>
<a href="#l3.937"></a><span id="l3.937" class="difflineplus">+ *     an error response ({@link module:http-api.MatrixError}).</span>
<a href="#l3.938"></a><span id="l3.938" class="difflineplus">+ */</span>
<a href="#l3.939"></a><span id="l3.939" class="difflineplus">+MatrixBaseApis.prototype.uploadKeysRequest = function(content, opts, callback) {</span>
<a href="#l3.940"></a><span id="l3.940" class="difflineplus">+    opts = opts || {};</span>
<a href="#l3.941"></a><span id="l3.941" class="difflineplus">+    var deviceId = opts.device_id;</span>
<a href="#l3.942"></a><span id="l3.942" class="difflineplus">+    var path;</span>
<a href="#l3.943"></a><span id="l3.943" class="difflineplus">+    if (deviceId) {</span>
<a href="#l3.944"></a><span id="l3.944" class="difflineplus">+        path = utils.encodeUri(&quot;/keys/upload/$deviceId&quot;, {</span>
<a href="#l3.945"></a><span id="l3.945" class="difflineplus">+            $deviceId: deviceId,</span>
<a href="#l3.946"></a><span id="l3.946" class="difflineplus">+        });</span>
<a href="#l3.947"></a><span id="l3.947" class="difflineplus">+    } else {</span>
<a href="#l3.948"></a><span id="l3.948" class="difflineplus">+        path = &quot;/keys/upload&quot;;</span>
<a href="#l3.949"></a><span id="l3.949" class="difflineplus">+    }</span>
<a href="#l3.950"></a><span id="l3.950" class="difflineplus">+    return this._http.authedRequestWithPrefix(</span>
<a href="#l3.951"></a><span id="l3.951" class="difflineplus">+        callback, &quot;POST&quot;, path, undefined, content, httpApi.PREFIX_UNSTABLE</span>
<a href="#l3.952"></a><span id="l3.952" class="difflineplus">+    );</span>
<a href="#l3.953"></a><span id="l3.953" class="difflineplus">+};</span>
<a href="#l3.954"></a><span id="l3.954" class="difflineplus">+</span>
<a href="#l3.955"></a><span id="l3.955" class="difflineplus">+/**</span>
<a href="#l3.956"></a><span id="l3.956" class="difflineplus">+ * Download device keys</span>
<a href="#l3.957"></a><span id="l3.957" class="difflineplus">+ *</span>
<a href="#l3.958"></a><span id="l3.958" class="difflineplus">+ * @param {string[]} userIds  list of users to get keys for</span>
<a href="#l3.959"></a><span id="l3.959" class="difflineplus">+ *</span>
<a href="#l3.960"></a><span id="l3.960" class="difflineplus">+ * @param {module:client.callback=} callback</span>
<a href="#l3.961"></a><span id="l3.961" class="difflineplus">+ *</span>
<a href="#l3.962"></a><span id="l3.962" class="difflineplus">+ * @return {module:client.Promise} Resolves: result object. Rejects: with</span>
<a href="#l3.963"></a><span id="l3.963" class="difflineplus">+ *     an error response ({@link module:http-api.MatrixError}).</span>
<a href="#l3.964"></a><span id="l3.964" class="difflineplus">+ */</span>
<a href="#l3.965"></a><span id="l3.965" class="difflineplus">+MatrixBaseApis.prototype.downloadKeysForUsers = function(userIds, callback) {</span>
<a href="#l3.966"></a><span id="l3.966" class="difflineplus">+    var downloadQuery = {};</span>
<a href="#l3.967"></a><span id="l3.967" class="difflineplus">+</span>
<a href="#l3.968"></a><span id="l3.968" class="difflineplus">+    for (var i = 0; i &lt; userIds.length; ++i) {</span>
<a href="#l3.969"></a><span id="l3.969" class="difflineplus">+        downloadQuery[userIds[i]] = {};</span>
<a href="#l3.970"></a><span id="l3.970" class="difflineplus">+    }</span>
<a href="#l3.971"></a><span id="l3.971" class="difflineplus">+    var content = {device_keys: downloadQuery};</span>
<a href="#l3.972"></a><span id="l3.972" class="difflineplus">+    return this._http.authedRequestWithPrefix(</span>
<a href="#l3.973"></a><span id="l3.973" class="difflineplus">+        callback, &quot;POST&quot;, &quot;/keys/query&quot;, undefined, content,</span>
<a href="#l3.974"></a><span id="l3.974" class="difflineplus">+        httpApi.PREFIX_UNSTABLE</span>
<a href="#l3.975"></a><span id="l3.975" class="difflineplus">+    );</span>
<a href="#l3.976"></a><span id="l3.976" class="difflineplus">+};</span>
<a href="#l3.977"></a><span id="l3.977" class="difflineplus">+</span>
<a href="#l3.978"></a><span id="l3.978" class="difflineplus">+/**</span>
<a href="#l3.979"></a><span id="l3.979" class="difflineplus">+ * Claim one-time keys</span>
<a href="#l3.980"></a><span id="l3.980" class="difflineplus">+ *</span>
<a href="#l3.981"></a><span id="l3.981" class="difflineplus">+ * @param {string[][]} devices  a list of [userId, deviceId] pairs</span>
<a href="#l3.982"></a><span id="l3.982" class="difflineplus">+ *</span>
<a href="#l3.983"></a><span id="l3.983" class="difflineplus">+ * @param {string} [key_algorithm = signed_curve25519]  desired key type</span>
<a href="#l3.984"></a><span id="l3.984" class="difflineplus">+ *</span>
<a href="#l3.985"></a><span id="l3.985" class="difflineplus">+ * @return {module:client.Promise} Resolves: result object. Rejects: with</span>
<a href="#l3.986"></a><span id="l3.986" class="difflineplus">+ *     an error response ({@link module:http-api.MatrixError}).</span>
<a href="#l3.987"></a><span id="l3.987" class="difflineplus">+ */</span>
<a href="#l3.988"></a><span id="l3.988" class="difflineplus">+MatrixBaseApis.prototype.claimOneTimeKeys = function(devices, key_algorithm) {</span>
<a href="#l3.989"></a><span id="l3.989" class="difflineplus">+    var queries = {};</span>
<a href="#l3.990"></a><span id="l3.990" class="difflineplus">+</span>
<a href="#l3.991"></a><span id="l3.991" class="difflineplus">+    if (key_algorithm === undefined) {</span>
<a href="#l3.992"></a><span id="l3.992" class="difflineplus">+        key_algorithm = &quot;signed_curve25519&quot;;</span>
<a href="#l3.993"></a><span id="l3.993" class="difflineplus">+    }</span>
<a href="#l3.994"></a><span id="l3.994" class="difflineplus">+</span>
<a href="#l3.995"></a><span id="l3.995" class="difflineplus">+    for (var i = 0; i &lt; devices.length; ++i) {</span>
<a href="#l3.996"></a><span id="l3.996" class="difflineplus">+        var userId = devices[i][0];</span>
<a href="#l3.997"></a><span id="l3.997" class="difflineplus">+        var deviceId = devices[i][1];</span>
<a href="#l3.998"></a><span id="l3.998" class="difflineplus">+        var query = queries[userId] || {};</span>
<a href="#l3.999"></a><span id="l3.999" class="difflineplus">+        queries[userId] = query;</span>
<a href="#l3.1000"></a><span id="l3.1000" class="difflineplus">+        query[deviceId] = key_algorithm;</span>
<a href="#l3.1001"></a><span id="l3.1001" class="difflineplus">+    }</span>
<a href="#l3.1002"></a><span id="l3.1002" class="difflineplus">+    var content = {one_time_keys: queries};</span>
<a href="#l3.1003"></a><span id="l3.1003" class="difflineplus">+    return this._http.authedRequestWithPrefix(</span>
<a href="#l3.1004"></a><span id="l3.1004" class="difflineplus">+        undefined, &quot;POST&quot;, &quot;/keys/claim&quot;, undefined, content,</span>
<a href="#l3.1005"></a><span id="l3.1005" class="difflineplus">+        httpApi.PREFIX_UNSTABLE</span>
<a href="#l3.1006"></a><span id="l3.1006" class="difflineplus">+    );</span>
<a href="#l3.1007"></a><span id="l3.1007" class="difflineplus">+};</span>
<a href="#l3.1008"></a><span id="l3.1008" class="difflineplus">+</span>
<a href="#l3.1009"></a><span id="l3.1009" class="difflineplus">+</span>
<a href="#l3.1010"></a><span id="l3.1010" class="difflineplus">+// Identity Server Operations</span>
<a href="#l3.1011"></a><span id="l3.1011" class="difflineplus">+// ==========================</span>
<a href="#l3.1012"></a><span id="l3.1012" class="difflineplus">+</span>
<a href="#l3.1013"></a><span id="l3.1013" class="difflineplus">+/**</span>
<a href="#l3.1014"></a><span id="l3.1014" class="difflineplus">+ * Requests an email verification token directly from an Identity Server.</span>
<a href="#l3.1015"></a><span id="l3.1015" class="difflineplus">+ *</span>
<a href="#l3.1016"></a><span id="l3.1016" class="difflineplus">+ * Note that the Home Server offers APIs to proxy this API for specific</span>
<a href="#l3.1017"></a><span id="l3.1017" class="difflineplus">+ * situations, allowing for better feedback to the user.</span>
<a href="#l3.1018"></a><span id="l3.1018" class="difflineplus">+ *</span>
<a href="#l3.1019"></a><span id="l3.1019" class="difflineplus">+ * @param {string} email The email address to request a token for</span>
<a href="#l3.1020"></a><span id="l3.1020" class="difflineplus">+ * @param {string} clientSecret A secret binary string generated by the client.</span>
<a href="#l3.1021"></a><span id="l3.1021" class="difflineplus">+ *                 It is recommended this be around 16 ASCII characters.</span>
<a href="#l3.1022"></a><span id="l3.1022" class="difflineplus">+ * @param {number} sendAttempt If an identity server sees a duplicate request</span>
<a href="#l3.1023"></a><span id="l3.1023" class="difflineplus">+ *                 with the same sendAttempt, it will not send another email.</span>
<a href="#l3.1024"></a><span id="l3.1024" class="difflineplus">+ *                 To request another email to be sent, use a larger value for</span>
<a href="#l3.1025"></a><span id="l3.1025" class="difflineplus">+ *                 the sendAttempt param as was used in the previous request.</span>
<a href="#l3.1026"></a><span id="l3.1026" class="difflineplus">+ * @param {string} nextLink Optional If specified, the client will be redirected</span>
<a href="#l3.1027"></a><span id="l3.1027" class="difflineplus">+ *                 to this link after validation.</span>
<a href="#l3.1028"></a><span id="l3.1028" class="difflineplus">+ * @param {module:client.callback} callback Optional.</span>
<a href="#l3.1029"></a><span id="l3.1029" class="difflineplus">+ * @return {module:client.Promise} Resolves: TODO</span>
<a href="#l3.1030"></a><span id="l3.1030" class="difflineplus">+ * @return {module:http-api.MatrixError} Rejects: with an error response.</span>
<a href="#l3.1031"></a><span id="l3.1031" class="difflineplus">+ * @throws Error if No ID server is set</span>
<a href="#l3.1032"></a><span id="l3.1032" class="difflineplus">+ */</span>
<a href="#l3.1033"></a><span id="l3.1033" class="difflineplus">+MatrixBaseApis.prototype.requestEmailToken = function(email, clientSecret,</span>
<a href="#l3.1034"></a><span id="l3.1034" class="difflineplus">+                                                    sendAttempt, nextLink, callback) {</span>
<a href="#l3.1035"></a><span id="l3.1035" class="difflineplus">+    var params = {</span>
<a href="#l3.1036"></a><span id="l3.1036" class="difflineplus">+        client_secret: clientSecret,</span>
<a href="#l3.1037"></a><span id="l3.1037" class="difflineplus">+        email: email,</span>
<a href="#l3.1038"></a><span id="l3.1038" class="difflineplus">+        send_attempt: sendAttempt,</span>
<a href="#l3.1039"></a><span id="l3.1039" class="difflineplus">+        next_link: nextLink</span>
<a href="#l3.1040"></a><span id="l3.1040" class="difflineplus">+    };</span>
<a href="#l3.1041"></a><span id="l3.1041" class="difflineplus">+    return this._http.idServerRequest(</span>
<a href="#l3.1042"></a><span id="l3.1042" class="difflineplus">+        callback, &quot;POST&quot;, &quot;/validate/email/requestToken&quot;,</span>
<a href="#l3.1043"></a><span id="l3.1043" class="difflineplus">+        params, httpApi.PREFIX_IDENTITY_V1</span>
<a href="#l3.1044"></a><span id="l3.1044" class="difflineplus">+    );</span>
<a href="#l3.1045"></a><span id="l3.1045" class="difflineplus">+};</span>
<a href="#l3.1046"></a><span id="l3.1046" class="difflineplus">+</span>
<a href="#l3.1047"></a><span id="l3.1047" class="difflineplus">+/**</span>
<a href="#l3.1048"></a><span id="l3.1048" class="difflineplus">+ * Looks up the public Matrix ID mapping for a given 3rd party</span>
<a href="#l3.1049"></a><span id="l3.1049" class="difflineplus">+ * identifier from the Identity Server</span>
<a href="#l3.1050"></a><span id="l3.1050" class="difflineplus">+ * @param {string} medium The medium of the threepid, eg. 'email'</span>
<a href="#l3.1051"></a><span id="l3.1051" class="difflineplus">+ * @param {string} address The textual address of the threepid</span>
<a href="#l3.1052"></a><span id="l3.1052" class="difflineplus">+ * @param {module:client.callback} callback Optional.</span>
<a href="#l3.1053"></a><span id="l3.1053" class="difflineplus">+ * @return {module:client.Promise} Resolves: A threepid mapping</span>
<a href="#l3.1054"></a><span id="l3.1054" class="difflineplus">+ *                                 object or the empty object if no mapping</span>
<a href="#l3.1055"></a><span id="l3.1055" class="difflineplus">+ *                                 exists</span>
<a href="#l3.1056"></a><span id="l3.1056" class="difflineplus">+ * @return {module:http-api.MatrixError} Rejects: with an error response.</span>
<a href="#l3.1057"></a><span id="l3.1057" class="difflineplus">+ */</span>
<a href="#l3.1058"></a><span id="l3.1058" class="difflineplus">+MatrixBaseApis.prototype.lookupThreePid = function(medium, address, callback) {</span>
<a href="#l3.1059"></a><span id="l3.1059" class="difflineplus">+    var params = {</span>
<a href="#l3.1060"></a><span id="l3.1060" class="difflineplus">+        medium: medium,</span>
<a href="#l3.1061"></a><span id="l3.1061" class="difflineplus">+        address: address,</span>
<a href="#l3.1062"></a><span id="l3.1062" class="difflineplus">+    };</span>
<a href="#l3.1063"></a><span id="l3.1063" class="difflineplus">+    return this._http.idServerRequest(</span>
<a href="#l3.1064"></a><span id="l3.1064" class="difflineplus">+        callback, &quot;GET&quot;, &quot;/lookup&quot;,</span>
<a href="#l3.1065"></a><span id="l3.1065" class="difflineplus">+        params, httpApi.PREFIX_IDENTITY_V1</span>
<a href="#l3.1066"></a><span id="l3.1066" class="difflineplus">+    );</span>
<a href="#l3.1067"></a><span id="l3.1067" class="difflineplus">+};</span>
<a href="#l3.1068"></a><span id="l3.1068" class="difflineplus">+</span>
<a href="#l3.1069"></a><span id="l3.1069" class="difflineplus">+</span>
<a href="#l3.1070"></a><span id="l3.1070" class="difflineplus">+// Direct-to-device messaging</span>
<a href="#l3.1071"></a><span id="l3.1071" class="difflineplus">+// ==========================</span>
<a href="#l3.1072"></a><span id="l3.1072" class="difflineplus">+</span>
<a href="#l3.1073"></a><span id="l3.1073" class="difflineplus">+/**</span>
<a href="#l3.1074"></a><span id="l3.1074" class="difflineplus">+ * Send an event to a specific list of devices</span>
<a href="#l3.1075"></a><span id="l3.1075" class="difflineplus">+ *</span>
<a href="#l3.1076"></a><span id="l3.1076" class="difflineplus">+ * @param {string} eventType  type of event to send</span>
<a href="#l3.1077"></a><span id="l3.1077" class="difflineplus">+ * @param {Object.&lt;string, Object&lt;string, Object&gt;&gt;} contentMap</span>
<a href="#l3.1078"></a><span id="l3.1078" class="difflineplus">+ *    content to send. Map from user_id to device_id to content object.</span>
<a href="#l3.1079"></a><span id="l3.1079" class="difflineplus">+ * @param {string=} txnId     transaction id. One will be made up if not</span>
<a href="#l3.1080"></a><span id="l3.1080" class="difflineplus">+ *    supplied.</span>
<a href="#l3.1081"></a><span id="l3.1081" class="difflineplus">+ * @return {module:client.Promise} Resolves to the result object</span>
<a href="#l3.1082"></a><span id="l3.1082" class="difflineplus">+ */</span>
<a href="#l3.1083"></a><span id="l3.1083" class="difflineplus">+MatrixBaseApis.prototype.sendToDevice = function(</span>
<a href="#l3.1084"></a><span id="l3.1084" class="difflineplus">+    eventType, contentMap, txnId</span>
<a href="#l3.1085"></a><span id="l3.1085" class="difflineplus">+) {</span>
<a href="#l3.1086"></a><span id="l3.1086" class="difflineplus">+    var path = utils.encodeUri(&quot;/sendToDevice/$eventType/$txnId&quot;, {</span>
<a href="#l3.1087"></a><span id="l3.1087" class="difflineplus">+        $eventType: eventType,</span>
<a href="#l3.1088"></a><span id="l3.1088" class="difflineplus">+        $txnId: txnId ? txnId : this.makeTxnId(),</span>
<a href="#l3.1089"></a><span id="l3.1089" class="difflineplus">+    });</span>
<a href="#l3.1090"></a><span id="l3.1090" class="difflineplus">+</span>
<a href="#l3.1091"></a><span id="l3.1091" class="difflineplus">+    var body = {</span>
<a href="#l3.1092"></a><span id="l3.1092" class="difflineplus">+        messages: contentMap,</span>
<a href="#l3.1093"></a><span id="l3.1093" class="difflineplus">+    };</span>
<a href="#l3.1094"></a><span id="l3.1094" class="difflineplus">+</span>
<a href="#l3.1095"></a><span id="l3.1095" class="difflineplus">+    return this._http.authedRequestWithPrefix(</span>
<a href="#l3.1096"></a><span id="l3.1096" class="difflineplus">+        undefined, &quot;PUT&quot;, path, undefined, body,</span>
<a href="#l3.1097"></a><span id="l3.1097" class="difflineplus">+        httpApi.PREFIX_UNSTABLE</span>
<a href="#l3.1098"></a><span id="l3.1098" class="difflineplus">+    );</span>
<a href="#l3.1099"></a><span id="l3.1099" class="difflineplus">+};</span>
<a href="#l3.1100"></a><span id="l3.1100" class="difflineplus">+</span>
<a href="#l3.1101"></a><span id="l3.1101" class="difflineplus">+// Third party Lookup API</span>
<a href="#l3.1102"></a><span id="l3.1102" class="difflineplus">+// ======================</span>
<a href="#l3.1103"></a><span id="l3.1103" class="difflineplus">+</span>
<a href="#l3.1104"></a><span id="l3.1104" class="difflineplus">+/**</span>
<a href="#l3.1105"></a><span id="l3.1105" class="difflineplus">+ * Get the third party protocols that can be reached using</span>
<a href="#l3.1106"></a><span id="l3.1106" class="difflineplus">+ * this HS</span>
<a href="#l3.1107"></a><span id="l3.1107" class="difflineplus">+ * @return {module:client.Promise} Resolves to the result object</span>
<a href="#l3.1108"></a><span id="l3.1108" class="difflineplus">+ */</span>
<a href="#l3.1109"></a><span id="l3.1109" class="difflineplus">+MatrixBaseApis.prototype.getThirdpartyProtocols = function() {</span>
<a href="#l3.1110"></a><span id="l3.1110" class="difflineplus">+    return this._http.authedRequestWithPrefix(</span>
<a href="#l3.1111"></a><span id="l3.1111" class="difflineplus">+        undefined, &quot;GET&quot;, &quot;/thirdparty/protocols&quot;, undefined, undefined,</span>
<a href="#l3.1112"></a><span id="l3.1112" class="difflineplus">+        httpApi.PREFIX_UNSTABLE</span>
<a href="#l3.1113"></a><span id="l3.1113" class="difflineplus">+    );</span>
<a href="#l3.1114"></a><span id="l3.1114" class="difflineplus">+};</span>
<a href="#l3.1115"></a><span id="l3.1115" class="difflineplus">+</span>
<a href="#l3.1116"></a><span id="l3.1116" class="difflineplus">+/**</span>
<a href="#l3.1117"></a><span id="l3.1117" class="difflineplus">+ * Get information on how a specific place on a third party protocol</span>
<a href="#l3.1118"></a><span id="l3.1118" class="difflineplus">+ * may be reached.</span>
<a href="#l3.1119"></a><span id="l3.1119" class="difflineplus">+ * @param {string} protocol The protocol given in getThirdpartyProtocols()</span>
<a href="#l3.1120"></a><span id="l3.1120" class="difflineplus">+ * @param {object} params Protocol-specific parameters, as given in th</span>
<a href="#l3.1121"></a><span id="l3.1121" class="difflineplus">+ *                        response to getThirdpartyProtocols()</span>
<a href="#l3.1122"></a><span id="l3.1122" class="difflineplus">+ * @return {module:client.Promise} Resolves to the result object</span>
<a href="#l3.1123"></a><span id="l3.1123" class="difflineplus">+ */</span>
<a href="#l3.1124"></a><span id="l3.1124" class="difflineplus">+MatrixBaseApis.prototype.getThirdpartyLocation = function(protocol, params) {</span>
<a href="#l3.1125"></a><span id="l3.1125" class="difflineplus">+    var path = utils.encodeUri(&quot;/thirdparty/location/$protocol&quot;, {</span>
<a href="#l3.1126"></a><span id="l3.1126" class="difflineplus">+        $protocol: protocol</span>
<a href="#l3.1127"></a><span id="l3.1127" class="difflineplus">+    });</span>
<a href="#l3.1128"></a><span id="l3.1128" class="difflineplus">+</span>
<a href="#l3.1129"></a><span id="l3.1129" class="difflineplus">+    return this._http.authedRequestWithPrefix(</span>
<a href="#l3.1130"></a><span id="l3.1130" class="difflineplus">+        undefined, &quot;GET&quot;, path, params, undefined,</span>
<a href="#l3.1131"></a><span id="l3.1131" class="difflineplus">+        httpApi.PREFIX_UNSTABLE</span>
<a href="#l3.1132"></a><span id="l3.1132" class="difflineplus">+    );</span>
<a href="#l3.1133"></a><span id="l3.1133" class="difflineplus">+};</span>
<a href="#l3.1134"></a><span id="l3.1134" class="difflineplus">+</span>
<a href="#l3.1135"></a><span id="l3.1135" class="difflineplus">+/**</span>
<a href="#l3.1136"></a><span id="l3.1136" class="difflineplus">+ * MatrixBaseApis object</span>
<a href="#l3.1137"></a><span id="l3.1137" class="difflineplus">+ */</span>
<a href="#l3.1138"></a><span id="l3.1138" class="difflineplus">+module.exports = MatrixBaseApis;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1">new file mode 100644</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineminus">--- /dev/null</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineplus">+++ b/chat/protocols/matrix/matrix-sdk/browser-request/index.js</span>
<a href="#l4.4"></a><span id="l4.4" class="difflineat">@@ -0,0 +1,494 @@</span>
<a href="#l4.5"></a><span id="l4.5" class="difflineplus">+// Browser Request</span>
<a href="#l4.6"></a><span id="l4.6" class="difflineplus">+//</span>
<a href="#l4.7"></a><span id="l4.7" class="difflineplus">+// Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<a href="#l4.8"></a><span id="l4.8" class="difflineplus">+// you may not use this file except in compliance with the License.</span>
<a href="#l4.9"></a><span id="l4.9" class="difflineplus">+// You may obtain a copy of the License at</span>
<a href="#l4.10"></a><span id="l4.10" class="difflineplus">+//</span>
<a href="#l4.11"></a><span id="l4.11" class="difflineplus">+//     http://www.apache.org/licenses/LICENSE-2.0</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+//</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+// Unless required by applicable law or agreed to in writing, software</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+// distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineplus">+// See the License for the specific language governing permissions and</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineplus">+// limitations under the License.</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineplus">+</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineplus">+// UMD HEADER START </span>
<a href="#l4.20"></a><span id="l4.20" class="difflineplus">+(function (root, factory) {</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineplus">+    if (typeof define === 'function' &amp;&amp; define.amd) {</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineplus">+        // AMD. Register as an anonymous module.</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineplus">+        define([], factory);</span>
<a href="#l4.24"></a><span id="l4.24" class="difflineplus">+    } else if (typeof exports === 'object') {</span>
<a href="#l4.25"></a><span id="l4.25" class="difflineplus">+        // Node. Does not work with strict CommonJS, but</span>
<a href="#l4.26"></a><span id="l4.26" class="difflineplus">+        // only CommonJS-like enviroments that support module.exports,</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineplus">+        // like Node.</span>
<a href="#l4.28"></a><span id="l4.28" class="difflineplus">+        module.exports = factory();</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineplus">+    } else {</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineplus">+        // Browser globals (root is window)</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineplus">+        root.returnExports = factory();</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineplus">+  }</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineplus">+}(this, function () {</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineplus">+// UMD HEADER END</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineplus">+</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineplus">+var XHR = XMLHttpRequest</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineplus">+if (!XHR) throw new Error('missing XMLHttpRequest')</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineplus">+request.log = {</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineplus">+  'trace': noop, 'debug': noop, 'info': noop, 'warn': noop, 'error': noop</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineplus">+}</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineplus">+</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineplus">+var DEFAULT_TIMEOUT = 3 * 60 * 1000 // 3 minutes</span>
<a href="#l4.43"></a><span id="l4.43" class="difflineplus">+</span>
<a href="#l4.44"></a><span id="l4.44" class="difflineplus">+//</span>
<a href="#l4.45"></a><span id="l4.45" class="difflineplus">+// request</span>
<a href="#l4.46"></a><span id="l4.46" class="difflineplus">+//</span>
<a href="#l4.47"></a><span id="l4.47" class="difflineplus">+</span>
<a href="#l4.48"></a><span id="l4.48" class="difflineplus">+function request(options, callback) {</span>
<a href="#l4.49"></a><span id="l4.49" class="difflineplus">+  // The entry-point to the API: prep the options object and pass the real work to run_xhr.</span>
<a href="#l4.50"></a><span id="l4.50" class="difflineplus">+  if(typeof callback !== 'function')</span>
<a href="#l4.51"></a><span id="l4.51" class="difflineplus">+    throw new Error('Bad callback given: ' + callback)</span>
<a href="#l4.52"></a><span id="l4.52" class="difflineplus">+</span>
<a href="#l4.53"></a><span id="l4.53" class="difflineplus">+  if(!options)</span>
<a href="#l4.54"></a><span id="l4.54" class="difflineplus">+    throw new Error('No options given')</span>
<a href="#l4.55"></a><span id="l4.55" class="difflineplus">+</span>
<a href="#l4.56"></a><span id="l4.56" class="difflineplus">+  var options_onResponse = options.onResponse; // Save this for later.</span>
<a href="#l4.57"></a><span id="l4.57" class="difflineplus">+</span>
<a href="#l4.58"></a><span id="l4.58" class="difflineplus">+  if(typeof options === 'string')</span>
<a href="#l4.59"></a><span id="l4.59" class="difflineplus">+    options = {'uri':options};</span>
<a href="#l4.60"></a><span id="l4.60" class="difflineplus">+  else</span>
<a href="#l4.61"></a><span id="l4.61" class="difflineplus">+    options = JSON.parse(JSON.stringify(options)); // Use a duplicate for mutating.</span>
<a href="#l4.62"></a><span id="l4.62" class="difflineplus">+</span>
<a href="#l4.63"></a><span id="l4.63" class="difflineplus">+  options.onResponse = options_onResponse // And put it back.</span>
<a href="#l4.64"></a><span id="l4.64" class="difflineplus">+</span>
<a href="#l4.65"></a><span id="l4.65" class="difflineplus">+  if (options.verbose) request.log = getLogger();</span>
<a href="#l4.66"></a><span id="l4.66" class="difflineplus">+</span>
<a href="#l4.67"></a><span id="l4.67" class="difflineplus">+  if(options.url) {</span>
<a href="#l4.68"></a><span id="l4.68" class="difflineplus">+    options.uri = options.url;</span>
<a href="#l4.69"></a><span id="l4.69" class="difflineplus">+    delete options.url;</span>
<a href="#l4.70"></a><span id="l4.70" class="difflineplus">+  }</span>
<a href="#l4.71"></a><span id="l4.71" class="difflineplus">+</span>
<a href="#l4.72"></a><span id="l4.72" class="difflineplus">+  if(!options.uri &amp;&amp; options.uri !== &quot;&quot;)</span>
<a href="#l4.73"></a><span id="l4.73" class="difflineplus">+    throw new Error(&quot;options.uri is a required argument&quot;);</span>
<a href="#l4.74"></a><span id="l4.74" class="difflineplus">+</span>
<a href="#l4.75"></a><span id="l4.75" class="difflineplus">+  if(typeof options.uri != &quot;string&quot;)</span>
<a href="#l4.76"></a><span id="l4.76" class="difflineplus">+    throw new Error(&quot;options.uri must be a string&quot;);</span>
<a href="#l4.77"></a><span id="l4.77" class="difflineplus">+</span>
<a href="#l4.78"></a><span id="l4.78" class="difflineplus">+  var unsupported_options = ['proxy', '_redirectsFollowed', 'maxRedirects', 'followRedirect']</span>
<a href="#l4.79"></a><span id="l4.79" class="difflineplus">+  for (var i = 0; i &lt; unsupported_options.length; i++)</span>
<a href="#l4.80"></a><span id="l4.80" class="difflineplus">+    if(options[ unsupported_options[i] ])</span>
<a href="#l4.81"></a><span id="l4.81" class="difflineplus">+      throw new Error(&quot;options.&quot; + unsupported_options[i] + &quot; is not supported&quot;)</span>
<a href="#l4.82"></a><span id="l4.82" class="difflineplus">+</span>
<a href="#l4.83"></a><span id="l4.83" class="difflineplus">+  options.callback = callback</span>
<a href="#l4.84"></a><span id="l4.84" class="difflineplus">+  options.method = options.method || 'GET';</span>
<a href="#l4.85"></a><span id="l4.85" class="difflineplus">+  options.headers = options.headers || {};</span>
<a href="#l4.86"></a><span id="l4.86" class="difflineplus">+  options.body    = options.body || null</span>
<a href="#l4.87"></a><span id="l4.87" class="difflineplus">+  options.timeout = options.timeout || request.DEFAULT_TIMEOUT</span>
<a href="#l4.88"></a><span id="l4.88" class="difflineplus">+</span>
<a href="#l4.89"></a><span id="l4.89" class="difflineplus">+  if(options.headers.host)</span>
<a href="#l4.90"></a><span id="l4.90" class="difflineplus">+    throw new Error(&quot;Options.headers.host is not supported&quot;);</span>
<a href="#l4.91"></a><span id="l4.91" class="difflineplus">+</span>
<a href="#l4.92"></a><span id="l4.92" class="difflineplus">+  if(options.json) {</span>
<a href="#l4.93"></a><span id="l4.93" class="difflineplus">+    options.headers.accept = options.headers.accept || 'application/json'</span>
<a href="#l4.94"></a><span id="l4.94" class="difflineplus">+    if(options.method !== 'GET')</span>
<a href="#l4.95"></a><span id="l4.95" class="difflineplus">+      options.headers['content-type'] = 'application/json'</span>
<a href="#l4.96"></a><span id="l4.96" class="difflineplus">+</span>
<a href="#l4.97"></a><span id="l4.97" class="difflineplus">+    if(typeof options.json !== 'boolean')</span>
<a href="#l4.98"></a><span id="l4.98" class="difflineplus">+      options.body = JSON.stringify(options.json)</span>
<a href="#l4.99"></a><span id="l4.99" class="difflineplus">+    else if(typeof options.body !== 'string')</span>
<a href="#l4.100"></a><span id="l4.100" class="difflineplus">+      options.body = JSON.stringify(options.body)</span>
<a href="#l4.101"></a><span id="l4.101" class="difflineplus">+  }</span>
<a href="#l4.102"></a><span id="l4.102" class="difflineplus">+  </span>
<a href="#l4.103"></a><span id="l4.103" class="difflineplus">+  //BEGIN QS Hack</span>
<a href="#l4.104"></a><span id="l4.104" class="difflineplus">+  var serialize = function(obj) {</span>
<a href="#l4.105"></a><span id="l4.105" class="difflineplus">+    var str = [];</span>
<a href="#l4.106"></a><span id="l4.106" class="difflineplus">+    for(var p in obj)</span>
<a href="#l4.107"></a><span id="l4.107" class="difflineplus">+      if (obj.hasOwnProperty(p)) {</span>
<a href="#l4.108"></a><span id="l4.108" class="difflineplus">+        str.push(encodeURIComponent(p) + &quot;=&quot; + encodeURIComponent(obj[p]));</span>
<a href="#l4.109"></a><span id="l4.109" class="difflineplus">+      }</span>
<a href="#l4.110"></a><span id="l4.110" class="difflineplus">+    return str.join(&quot;&amp;&quot;);</span>
<a href="#l4.111"></a><span id="l4.111" class="difflineplus">+  }</span>
<a href="#l4.112"></a><span id="l4.112" class="difflineplus">+  </span>
<a href="#l4.113"></a><span id="l4.113" class="difflineplus">+  if(options.qs){</span>
<a href="#l4.114"></a><span id="l4.114" class="difflineplus">+    var qs = (typeof options.qs == 'string')? options.qs : serialize(options.qs);</span>
<a href="#l4.115"></a><span id="l4.115" class="difflineplus">+    if(options.uri.indexOf('?') !== -1){ //no get params</span>
<a href="#l4.116"></a><span id="l4.116" class="difflineplus">+        options.uri = options.uri+'&amp;'+qs;</span>
<a href="#l4.117"></a><span id="l4.117" class="difflineplus">+    }else{ //existing get params</span>
<a href="#l4.118"></a><span id="l4.118" class="difflineplus">+        options.uri = options.uri+'?'+qs;</span>
<a href="#l4.119"></a><span id="l4.119" class="difflineplus">+    }</span>
<a href="#l4.120"></a><span id="l4.120" class="difflineplus">+  }</span>
<a href="#l4.121"></a><span id="l4.121" class="difflineplus">+  //END QS Hack</span>
<a href="#l4.122"></a><span id="l4.122" class="difflineplus">+  </span>
<a href="#l4.123"></a><span id="l4.123" class="difflineplus">+  //BEGIN FORM Hack</span>
<a href="#l4.124"></a><span id="l4.124" class="difflineplus">+  var multipart = function(obj) {</span>
<a href="#l4.125"></a><span id="l4.125" class="difflineplus">+    //todo: support file type (useful?)</span>
<a href="#l4.126"></a><span id="l4.126" class="difflineplus">+    var result = {};</span>
<a href="#l4.127"></a><span id="l4.127" class="difflineplus">+    result.boundry = '-------------------------------'+Math.floor(Math.random()*1000000000);</span>
<a href="#l4.128"></a><span id="l4.128" class="difflineplus">+    var lines = [];</span>
<a href="#l4.129"></a><span id="l4.129" class="difflineplus">+    for(var p in obj){</span>
<a href="#l4.130"></a><span id="l4.130" class="difflineplus">+        if (obj.hasOwnProperty(p)) {</span>
<a href="#l4.131"></a><span id="l4.131" class="difflineplus">+            lines.push(</span>
<a href="#l4.132"></a><span id="l4.132" class="difflineplus">+                '--'+result.boundry+&quot;\n&quot;+</span>
<a href="#l4.133"></a><span id="l4.133" class="difflineplus">+                'Content-Disposition: form-data; name=&quot;'+p+'&quot;'+&quot;\n&quot;+</span>
<a href="#l4.134"></a><span id="l4.134" class="difflineplus">+                &quot;\n&quot;+</span>
<a href="#l4.135"></a><span id="l4.135" class="difflineplus">+                obj[p]+&quot;\n&quot;</span>
<a href="#l4.136"></a><span id="l4.136" class="difflineplus">+            );</span>
<a href="#l4.137"></a><span id="l4.137" class="difflineplus">+        }</span>
<a href="#l4.138"></a><span id="l4.138" class="difflineplus">+    }</span>
<a href="#l4.139"></a><span id="l4.139" class="difflineplus">+    lines.push( '--'+result.boundry+'--' );</span>
<a href="#l4.140"></a><span id="l4.140" class="difflineplus">+    result.body = lines.join('');</span>
<a href="#l4.141"></a><span id="l4.141" class="difflineplus">+    result.length = result.body.length;</span>
<a href="#l4.142"></a><span id="l4.142" class="difflineplus">+    result.type = 'multipart/form-data; boundary='+result.boundry;</span>
<a href="#l4.143"></a><span id="l4.143" class="difflineplus">+    return result;</span>
<a href="#l4.144"></a><span id="l4.144" class="difflineplus">+  }</span>
<a href="#l4.145"></a><span id="l4.145" class="difflineplus">+  </span>
<a href="#l4.146"></a><span id="l4.146" class="difflineplus">+  if(options.form){</span>
<a href="#l4.147"></a><span id="l4.147" class="difflineplus">+    if(typeof options.form == 'string') throw('form name unsupported');</span>
<a href="#l4.148"></a><span id="l4.148" class="difflineplus">+    if(options.method === 'POST'){</span>
<a href="#l4.149"></a><span id="l4.149" class="difflineplus">+        var encoding = (options.encoding || 'application/x-www-form-urlencoded').toLowerCase();</span>
<a href="#l4.150"></a><span id="l4.150" class="difflineplus">+        options.headers['content-type'] = encoding;</span>
<a href="#l4.151"></a><span id="l4.151" class="difflineplus">+        switch(encoding){</span>
<a href="#l4.152"></a><span id="l4.152" class="difflineplus">+            case 'application/x-www-form-urlencoded':</span>
<a href="#l4.153"></a><span id="l4.153" class="difflineplus">+                options.body = serialize(options.form).replace(/%20/g, &quot;+&quot;);</span>
<a href="#l4.154"></a><span id="l4.154" class="difflineplus">+                break;</span>
<a href="#l4.155"></a><span id="l4.155" class="difflineplus">+            case 'multipart/form-data':</span>
<a href="#l4.156"></a><span id="l4.156" class="difflineplus">+                var multi = multipart(options.form);</span>
<a href="#l4.157"></a><span id="l4.157" class="difflineplus">+                //options.headers['content-length'] = multi.length;</span>
<a href="#l4.158"></a><span id="l4.158" class="difflineplus">+                options.body = multi.body;</span>
<a href="#l4.159"></a><span id="l4.159" class="difflineplus">+                options.headers['content-type'] = multi.type;</span>
<a href="#l4.160"></a><span id="l4.160" class="difflineplus">+                break;</span>
<a href="#l4.161"></a><span id="l4.161" class="difflineplus">+            default : throw new Error('unsupported encoding:'+encoding);</span>
<a href="#l4.162"></a><span id="l4.162" class="difflineplus">+        }</span>
<a href="#l4.163"></a><span id="l4.163" class="difflineplus">+    }</span>
<a href="#l4.164"></a><span id="l4.164" class="difflineplus">+  }</span>
<a href="#l4.165"></a><span id="l4.165" class="difflineplus">+  //END FORM Hack</span>
<a href="#l4.166"></a><span id="l4.166" class="difflineplus">+</span>
<a href="#l4.167"></a><span id="l4.167" class="difflineplus">+  // If onResponse is boolean true, call back immediately when the response is known,</span>
<a href="#l4.168"></a><span id="l4.168" class="difflineplus">+  // not when the full request is complete.</span>
<a href="#l4.169"></a><span id="l4.169" class="difflineplus">+  options.onResponse = options.onResponse || noop</span>
<a href="#l4.170"></a><span id="l4.170" class="difflineplus">+  if(options.onResponse === true) {</span>
<a href="#l4.171"></a><span id="l4.171" class="difflineplus">+    options.onResponse = callback</span>
<a href="#l4.172"></a><span id="l4.172" class="difflineplus">+    options.callback = noop</span>
<a href="#l4.173"></a><span id="l4.173" class="difflineplus">+  }</span>
<a href="#l4.174"></a><span id="l4.174" class="difflineplus">+</span>
<a href="#l4.175"></a><span id="l4.175" class="difflineplus">+  // XXX Browsers do not like this.</span>
<a href="#l4.176"></a><span id="l4.176" class="difflineplus">+  //if(options.body)</span>
<a href="#l4.177"></a><span id="l4.177" class="difflineplus">+  //  options.headers['content-length'] = options.body.length;</span>
<a href="#l4.178"></a><span id="l4.178" class="difflineplus">+</span>
<a href="#l4.179"></a><span id="l4.179" class="difflineplus">+  // HTTP basic authentication</span>
<a href="#l4.180"></a><span id="l4.180" class="difflineplus">+  if(!options.headers.authorization &amp;&amp; options.auth)</span>
<a href="#l4.181"></a><span id="l4.181" class="difflineplus">+    options.headers.authorization = 'Basic ' + b64_enc(options.auth.username + ':' + options.auth.password);</span>
<a href="#l4.182"></a><span id="l4.182" class="difflineplus">+</span>
<a href="#l4.183"></a><span id="l4.183" class="difflineplus">+  return run_xhr(options)</span>
<a href="#l4.184"></a><span id="l4.184" class="difflineplus">+}</span>
<a href="#l4.185"></a><span id="l4.185" class="difflineplus">+</span>
<a href="#l4.186"></a><span id="l4.186" class="difflineplus">+var req_seq = 0</span>
<a href="#l4.187"></a><span id="l4.187" class="difflineplus">+function run_xhr(options) {</span>
<a href="#l4.188"></a><span id="l4.188" class="difflineplus">+  var xhr = new XHR</span>
<a href="#l4.189"></a><span id="l4.189" class="difflineplus">+    , timed_out = false</span>
<a href="#l4.190"></a><span id="l4.190" class="difflineplus">+    , is_cors = is_crossDomain(options.uri)</span>
<a href="#l4.191"></a><span id="l4.191" class="difflineplus">+    , supports_cors = ('withCredentials' in xhr)</span>
<a href="#l4.192"></a><span id="l4.192" class="difflineplus">+</span>
<a href="#l4.193"></a><span id="l4.193" class="difflineplus">+  req_seq += 1</span>
<a href="#l4.194"></a><span id="l4.194" class="difflineplus">+  xhr.seq_id = req_seq</span>
<a href="#l4.195"></a><span id="l4.195" class="difflineplus">+  xhr.id = req_seq + ': ' + options.method + ' ' + options.uri</span>
<a href="#l4.196"></a><span id="l4.196" class="difflineplus">+  xhr._id = xhr.id // I know I will type &quot;_id&quot; from habit all the time.</span>
<a href="#l4.197"></a><span id="l4.197" class="difflineplus">+</span>
<a href="#l4.198"></a><span id="l4.198" class="difflineplus">+  if(is_cors &amp;&amp; !supports_cors) {</span>
<a href="#l4.199"></a><span id="l4.199" class="difflineplus">+    var cors_err = new Error('Browser does not support cross-origin request: ' + options.uri)</span>
<a href="#l4.200"></a><span id="l4.200" class="difflineplus">+    cors_err.cors = 'unsupported'</span>
<a href="#l4.201"></a><span id="l4.201" class="difflineplus">+    return options.callback(cors_err, xhr)</span>
<a href="#l4.202"></a><span id="l4.202" class="difflineplus">+  }</span>
<a href="#l4.203"></a><span id="l4.203" class="difflineplus">+</span>
<a href="#l4.204"></a><span id="l4.204" class="difflineplus">+  xhr.timeoutTimer = setTimeout(too_late, options.timeout)</span>
<a href="#l4.205"></a><span id="l4.205" class="difflineplus">+  function too_late() {</span>
<a href="#l4.206"></a><span id="l4.206" class="difflineplus">+    timed_out = true</span>
<a href="#l4.207"></a><span id="l4.207" class="difflineplus">+    var er = new Error('ETIMEDOUT')</span>
<a href="#l4.208"></a><span id="l4.208" class="difflineplus">+    er.code = 'ETIMEDOUT'</span>
<a href="#l4.209"></a><span id="l4.209" class="difflineplus">+    er.duration = options.timeout</span>
<a href="#l4.210"></a><span id="l4.210" class="difflineplus">+</span>
<a href="#l4.211"></a><span id="l4.211" class="difflineplus">+    request.log.error('Timeout', { 'id':xhr._id, 'milliseconds':options.timeout })</span>
<a href="#l4.212"></a><span id="l4.212" class="difflineplus">+    return options.callback(er, xhr)</span>
<a href="#l4.213"></a><span id="l4.213" class="difflineplus">+  }</span>
<a href="#l4.214"></a><span id="l4.214" class="difflineplus">+</span>
<a href="#l4.215"></a><span id="l4.215" class="difflineplus">+  // Some states can be skipped over, so remember what is still incomplete.</span>
<a href="#l4.216"></a><span id="l4.216" class="difflineplus">+  var did = {'response':false, 'loading':false, 'end':false}</span>
<a href="#l4.217"></a><span id="l4.217" class="difflineplus">+</span>
<a href="#l4.218"></a><span id="l4.218" class="difflineplus">+  xhr.onreadystatechange = on_state_change</span>
<a href="#l4.219"></a><span id="l4.219" class="difflineplus">+  xhr.open(options.method, options.uri, true) // asynchronous</span>
<a href="#l4.220"></a><span id="l4.220" class="difflineplus">+  if(is_cors)</span>
<a href="#l4.221"></a><span id="l4.221" class="difflineplus">+    xhr.withCredentials = !! options.withCredentials</span>
<a href="#l4.222"></a><span id="l4.222" class="difflineplus">+  xhr.send(options.body)</span>
<a href="#l4.223"></a><span id="l4.223" class="difflineplus">+  return xhr</span>
<a href="#l4.224"></a><span id="l4.224" class="difflineplus">+</span>
<a href="#l4.225"></a><span id="l4.225" class="difflineplus">+  function on_state_change(event) {</span>
<a href="#l4.226"></a><span id="l4.226" class="difflineplus">+    if(timed_out)</span>
<a href="#l4.227"></a><span id="l4.227" class="difflineplus">+      return request.log.debug('Ignoring timed out state change', {'state':xhr.readyState, 'id':xhr.id})</span>
<a href="#l4.228"></a><span id="l4.228" class="difflineplus">+</span>
<a href="#l4.229"></a><span id="l4.229" class="difflineplus">+    request.log.debug('State change', {'state':xhr.readyState, 'id':xhr.id, 'timed_out':timed_out})</span>
<a href="#l4.230"></a><span id="l4.230" class="difflineplus">+</span>
<a href="#l4.231"></a><span id="l4.231" class="difflineplus">+    if(xhr.readyState === XHR.OPENED) {</span>
<a href="#l4.232"></a><span id="l4.232" class="difflineplus">+      request.log.debug('Request started', {'id':xhr.id})</span>
<a href="#l4.233"></a><span id="l4.233" class="difflineplus">+      for (var key in options.headers)</span>
<a href="#l4.234"></a><span id="l4.234" class="difflineplus">+        xhr.setRequestHeader(key, options.headers[key])</span>
<a href="#l4.235"></a><span id="l4.235" class="difflineplus">+    }</span>
<a href="#l4.236"></a><span id="l4.236" class="difflineplus">+</span>
<a href="#l4.237"></a><span id="l4.237" class="difflineplus">+    else if(xhr.readyState === XHR.HEADERS_RECEIVED)</span>
<a href="#l4.238"></a><span id="l4.238" class="difflineplus">+      on_response()</span>
<a href="#l4.239"></a><span id="l4.239" class="difflineplus">+</span>
<a href="#l4.240"></a><span id="l4.240" class="difflineplus">+    else if(xhr.readyState === XHR.LOADING) {</span>
<a href="#l4.241"></a><span id="l4.241" class="difflineplus">+      on_response()</span>
<a href="#l4.242"></a><span id="l4.242" class="difflineplus">+      on_loading()</span>
<a href="#l4.243"></a><span id="l4.243" class="difflineplus">+    }</span>
<a href="#l4.244"></a><span id="l4.244" class="difflineplus">+</span>
<a href="#l4.245"></a><span id="l4.245" class="difflineplus">+    else if(xhr.readyState === XHR.DONE) {</span>
<a href="#l4.246"></a><span id="l4.246" class="difflineplus">+      on_response()</span>
<a href="#l4.247"></a><span id="l4.247" class="difflineplus">+      on_loading()</span>
<a href="#l4.248"></a><span id="l4.248" class="difflineplus">+      on_end()</span>
<a href="#l4.249"></a><span id="l4.249" class="difflineplus">+    }</span>
<a href="#l4.250"></a><span id="l4.250" class="difflineplus">+  }</span>
<a href="#l4.251"></a><span id="l4.251" class="difflineplus">+</span>
<a href="#l4.252"></a><span id="l4.252" class="difflineplus">+  function on_response() {</span>
<a href="#l4.253"></a><span id="l4.253" class="difflineplus">+    if(did.response)</span>
<a href="#l4.254"></a><span id="l4.254" class="difflineplus">+      return</span>
<a href="#l4.255"></a><span id="l4.255" class="difflineplus">+</span>
<a href="#l4.256"></a><span id="l4.256" class="difflineplus">+    did.response = true</span>
<a href="#l4.257"></a><span id="l4.257" class="difflineplus">+    request.log.debug('Got response', {'id':xhr.id, 'status':xhr.status})</span>
<a href="#l4.258"></a><span id="l4.258" class="difflineplus">+    clearTimeout(xhr.timeoutTimer)</span>
<a href="#l4.259"></a><span id="l4.259" class="difflineplus">+    xhr.statusCode = xhr.status // Node request compatibility</span>
<a href="#l4.260"></a><span id="l4.260" class="difflineplus">+</span>
<a href="#l4.261"></a><span id="l4.261" class="difflineplus">+    // Detect failed CORS requests.</span>
<a href="#l4.262"></a><span id="l4.262" class="difflineplus">+    if(is_cors &amp;&amp; xhr.statusCode == 0) {</span>
<a href="#l4.263"></a><span id="l4.263" class="difflineplus">+      var cors_err = new Error('CORS request rejected: ' + options.uri)</span>
<a href="#l4.264"></a><span id="l4.264" class="difflineplus">+      cors_err.cors = 'rejected'</span>
<a href="#l4.265"></a><span id="l4.265" class="difflineplus">+</span>
<a href="#l4.266"></a><span id="l4.266" class="difflineplus">+      // Do not process this request further.</span>
<a href="#l4.267"></a><span id="l4.267" class="difflineplus">+      did.loading = true</span>
<a href="#l4.268"></a><span id="l4.268" class="difflineplus">+      did.end = true</span>
<a href="#l4.269"></a><span id="l4.269" class="difflineplus">+</span>
<a href="#l4.270"></a><span id="l4.270" class="difflineplus">+      return options.callback(cors_err, xhr)</span>
<a href="#l4.271"></a><span id="l4.271" class="difflineplus">+    }</span>
<a href="#l4.272"></a><span id="l4.272" class="difflineplus">+</span>
<a href="#l4.273"></a><span id="l4.273" class="difflineplus">+    options.onResponse(null, xhr)</span>
<a href="#l4.274"></a><span id="l4.274" class="difflineplus">+  }</span>
<a href="#l4.275"></a><span id="l4.275" class="difflineplus">+</span>
<a href="#l4.276"></a><span id="l4.276" class="difflineplus">+  function on_loading() {</span>
<a href="#l4.277"></a><span id="l4.277" class="difflineplus">+    if(did.loading)</span>
<a href="#l4.278"></a><span id="l4.278" class="difflineplus">+      return</span>
<a href="#l4.279"></a><span id="l4.279" class="difflineplus">+</span>
<a href="#l4.280"></a><span id="l4.280" class="difflineplus">+    did.loading = true</span>
<a href="#l4.281"></a><span id="l4.281" class="difflineplus">+    request.log.debug('Response body loading', {'id':xhr.id})</span>
<a href="#l4.282"></a><span id="l4.282" class="difflineplus">+    // TODO: Maybe simulate &quot;data&quot; events by watching xhr.responseText</span>
<a href="#l4.283"></a><span id="l4.283" class="difflineplus">+  }</span>
<a href="#l4.284"></a><span id="l4.284" class="difflineplus">+</span>
<a href="#l4.285"></a><span id="l4.285" class="difflineplus">+  function on_end() {</span>
<a href="#l4.286"></a><span id="l4.286" class="difflineplus">+    if(did.end)</span>
<a href="#l4.287"></a><span id="l4.287" class="difflineplus">+      return</span>
<a href="#l4.288"></a><span id="l4.288" class="difflineplus">+</span>
<a href="#l4.289"></a><span id="l4.289" class="difflineplus">+    did.end = true</span>
<a href="#l4.290"></a><span id="l4.290" class="difflineplus">+    request.log.debug('Request done', {'id':xhr.id})</span>
<a href="#l4.291"></a><span id="l4.291" class="difflineplus">+</span>
<a href="#l4.292"></a><span id="l4.292" class="difflineplus">+    xhr.body = xhr.responseText</span>
<a href="#l4.293"></a><span id="l4.293" class="difflineplus">+    if(options.json) {</span>
<a href="#l4.294"></a><span id="l4.294" class="difflineplus">+      try        { xhr.body = JSON.parse(xhr.responseText) }</span>
<a href="#l4.295"></a><span id="l4.295" class="difflineplus">+      catch (er) { return options.callback(er, xhr)        }</span>
<a href="#l4.296"></a><span id="l4.296" class="difflineplus">+    }</span>
<a href="#l4.297"></a><span id="l4.297" class="difflineplus">+</span>
<a href="#l4.298"></a><span id="l4.298" class="difflineplus">+    options.callback(null, xhr, xhr.body)</span>
<a href="#l4.299"></a><span id="l4.299" class="difflineplus">+  }</span>
<a href="#l4.300"></a><span id="l4.300" class="difflineplus">+</span>
<a href="#l4.301"></a><span id="l4.301" class="difflineplus">+} // request</span>
<a href="#l4.302"></a><span id="l4.302" class="difflineplus">+</span>
<a href="#l4.303"></a><span id="l4.303" class="difflineplus">+request.withCredentials = false;</span>
<a href="#l4.304"></a><span id="l4.304" class="difflineplus">+request.DEFAULT_TIMEOUT = DEFAULT_TIMEOUT;</span>
<a href="#l4.305"></a><span id="l4.305" class="difflineplus">+</span>
<a href="#l4.306"></a><span id="l4.306" class="difflineplus">+//</span>
<a href="#l4.307"></a><span id="l4.307" class="difflineplus">+// defaults</span>
<a href="#l4.308"></a><span id="l4.308" class="difflineplus">+//</span>
<a href="#l4.309"></a><span id="l4.309" class="difflineplus">+</span>
<a href="#l4.310"></a><span id="l4.310" class="difflineplus">+request.defaults = function(options, requester) {</span>
<a href="#l4.311"></a><span id="l4.311" class="difflineplus">+  var def = function (method) {</span>
<a href="#l4.312"></a><span id="l4.312" class="difflineplus">+    var d = function (params, callback) {</span>
<a href="#l4.313"></a><span id="l4.313" class="difflineplus">+      if(typeof params === 'string')</span>
<a href="#l4.314"></a><span id="l4.314" class="difflineplus">+        params = {'uri': params};</span>
<a href="#l4.315"></a><span id="l4.315" class="difflineplus">+      else {</span>
<a href="#l4.316"></a><span id="l4.316" class="difflineplus">+        params = JSON.parse(JSON.stringify(params));</span>
<a href="#l4.317"></a><span id="l4.317" class="difflineplus">+      }</span>
<a href="#l4.318"></a><span id="l4.318" class="difflineplus">+      for (var i in options) {</span>
<a href="#l4.319"></a><span id="l4.319" class="difflineplus">+        if (params[i] === undefined) params[i] = options[i]</span>
<a href="#l4.320"></a><span id="l4.320" class="difflineplus">+      }</span>
<a href="#l4.321"></a><span id="l4.321" class="difflineplus">+      return method(params, callback)</span>
<a href="#l4.322"></a><span id="l4.322" class="difflineplus">+    }</span>
<a href="#l4.323"></a><span id="l4.323" class="difflineplus">+    return d</span>
<a href="#l4.324"></a><span id="l4.324" class="difflineplus">+  }</span>
<a href="#l4.325"></a><span id="l4.325" class="difflineplus">+  var de = def(request)</span>
<a href="#l4.326"></a><span id="l4.326" class="difflineplus">+  de.get = def(request.get)</span>
<a href="#l4.327"></a><span id="l4.327" class="difflineplus">+  de.post = def(request.post)</span>
<a href="#l4.328"></a><span id="l4.328" class="difflineplus">+  de.put = def(request.put)</span>
<a href="#l4.329"></a><span id="l4.329" class="difflineplus">+  de.head = def(request.head)</span>
<a href="#l4.330"></a><span id="l4.330" class="difflineplus">+  return de</span>
<a href="#l4.331"></a><span id="l4.331" class="difflineplus">+}</span>
<a href="#l4.332"></a><span id="l4.332" class="difflineplus">+</span>
<a href="#l4.333"></a><span id="l4.333" class="difflineplus">+//</span>
<a href="#l4.334"></a><span id="l4.334" class="difflineplus">+// HTTP method shortcuts</span>
<a href="#l4.335"></a><span id="l4.335" class="difflineplus">+//</span>
<a href="#l4.336"></a><span id="l4.336" class="difflineplus">+</span>
<a href="#l4.337"></a><span id="l4.337" class="difflineplus">+var shortcuts = [ 'get', 'put', 'post', 'head' ];</span>
<a href="#l4.338"></a><span id="l4.338" class="difflineplus">+shortcuts.forEach(function(shortcut) {</span>
<a href="#l4.339"></a><span id="l4.339" class="difflineplus">+  var method = shortcut.toUpperCase();</span>
<a href="#l4.340"></a><span id="l4.340" class="difflineplus">+  var func   = shortcut.toLowerCase();</span>
<a href="#l4.341"></a><span id="l4.341" class="difflineplus">+</span>
<a href="#l4.342"></a><span id="l4.342" class="difflineplus">+  request[func] = function(opts) {</span>
<a href="#l4.343"></a><span id="l4.343" class="difflineplus">+    if(typeof opts === 'string')</span>
<a href="#l4.344"></a><span id="l4.344" class="difflineplus">+      opts = {'method':method, 'uri':opts};</span>
<a href="#l4.345"></a><span id="l4.345" class="difflineplus">+    else {</span>
<a href="#l4.346"></a><span id="l4.346" class="difflineplus">+      opts = JSON.parse(JSON.stringify(opts));</span>
<a href="#l4.347"></a><span id="l4.347" class="difflineplus">+      opts.method = method;</span>
<a href="#l4.348"></a><span id="l4.348" class="difflineplus">+    }</span>
<a href="#l4.349"></a><span id="l4.349" class="difflineplus">+</span>
<a href="#l4.350"></a><span id="l4.350" class="difflineplus">+    var args = [opts].concat(Array.prototype.slice.apply(arguments, [1]));</span>
<a href="#l4.351"></a><span id="l4.351" class="difflineplus">+    return request.apply(this, args);</span>
<a href="#l4.352"></a><span id="l4.352" class="difflineplus">+  }</span>
<a href="#l4.353"></a><span id="l4.353" class="difflineplus">+})</span>
<a href="#l4.354"></a><span id="l4.354" class="difflineplus">+</span>
<a href="#l4.355"></a><span id="l4.355" class="difflineplus">+//</span>
<a href="#l4.356"></a><span id="l4.356" class="difflineplus">+// CouchDB shortcut</span>
<a href="#l4.357"></a><span id="l4.357" class="difflineplus">+//</span>
<a href="#l4.358"></a><span id="l4.358" class="difflineplus">+</span>
<a href="#l4.359"></a><span id="l4.359" class="difflineplus">+request.couch = function(options, callback) {</span>
<a href="#l4.360"></a><span id="l4.360" class="difflineplus">+  if(typeof options === 'string')</span>
<a href="#l4.361"></a><span id="l4.361" class="difflineplus">+    options = {'uri':options}</span>
<a href="#l4.362"></a><span id="l4.362" class="difflineplus">+</span>
<a href="#l4.363"></a><span id="l4.363" class="difflineplus">+  // Just use the request API to do JSON.</span>
<a href="#l4.364"></a><span id="l4.364" class="difflineplus">+  options.json = true</span>
<a href="#l4.365"></a><span id="l4.365" class="difflineplus">+  if(options.body)</span>
<a href="#l4.366"></a><span id="l4.366" class="difflineplus">+    options.json = options.body</span>
<a href="#l4.367"></a><span id="l4.367" class="difflineplus">+  delete options.body</span>
<a href="#l4.368"></a><span id="l4.368" class="difflineplus">+</span>
<a href="#l4.369"></a><span id="l4.369" class="difflineplus">+  callback = callback || noop</span>
<a href="#l4.370"></a><span id="l4.370" class="difflineplus">+</span>
<a href="#l4.371"></a><span id="l4.371" class="difflineplus">+  var xhr = request(options, couch_handler)</span>
<a href="#l4.372"></a><span id="l4.372" class="difflineplus">+  return xhr</span>
<a href="#l4.373"></a><span id="l4.373" class="difflineplus">+</span>
<a href="#l4.374"></a><span id="l4.374" class="difflineplus">+  function couch_handler(er, resp, body) {</span>
<a href="#l4.375"></a><span id="l4.375" class="difflineplus">+    if(er)</span>
<a href="#l4.376"></a><span id="l4.376" class="difflineplus">+      return callback(er, resp, body)</span>
<a href="#l4.377"></a><span id="l4.377" class="difflineplus">+</span>
<a href="#l4.378"></a><span id="l4.378" class="difflineplus">+    if((resp.statusCode &lt; 200 || resp.statusCode &gt; 299) &amp;&amp; body.error) {</span>
<a href="#l4.379"></a><span id="l4.379" class="difflineplus">+      // The body is a Couch JSON object indicating the error.</span>
<a href="#l4.380"></a><span id="l4.380" class="difflineplus">+      er = new Error('CouchDB error: ' + (body.error.reason || body.error.error))</span>
<a href="#l4.381"></a><span id="l4.381" class="difflineplus">+      for (var key in body)</span>
<a href="#l4.382"></a><span id="l4.382" class="difflineplus">+        er[key] = body[key]</span>
<a href="#l4.383"></a><span id="l4.383" class="difflineplus">+      return callback(er, resp, body);</span>
<a href="#l4.384"></a><span id="l4.384" class="difflineplus">+    }</span>
<a href="#l4.385"></a><span id="l4.385" class="difflineplus">+</span>
<a href="#l4.386"></a><span id="l4.386" class="difflineplus">+    return callback(er, resp, body);</span>
<a href="#l4.387"></a><span id="l4.387" class="difflineplus">+  }</span>
<a href="#l4.388"></a><span id="l4.388" class="difflineplus">+}</span>
<a href="#l4.389"></a><span id="l4.389" class="difflineplus">+</span>
<a href="#l4.390"></a><span id="l4.390" class="difflineplus">+//</span>
<a href="#l4.391"></a><span id="l4.391" class="difflineplus">+// Utility</span>
<a href="#l4.392"></a><span id="l4.392" class="difflineplus">+//</span>
<a href="#l4.393"></a><span id="l4.393" class="difflineplus">+</span>
<a href="#l4.394"></a><span id="l4.394" class="difflineplus">+function noop() {}</span>
<a href="#l4.395"></a><span id="l4.395" class="difflineplus">+</span>
<a href="#l4.396"></a><span id="l4.396" class="difflineplus">+function getLogger() {</span>
<a href="#l4.397"></a><span id="l4.397" class="difflineplus">+  var logger = {}</span>
<a href="#l4.398"></a><span id="l4.398" class="difflineplus">+    , levels = ['trace', 'debug', 'info', 'warn', 'error']</span>
<a href="#l4.399"></a><span id="l4.399" class="difflineplus">+    , level, i</span>
<a href="#l4.400"></a><span id="l4.400" class="difflineplus">+</span>
<a href="#l4.401"></a><span id="l4.401" class="difflineplus">+  for(i = 0; i &lt; levels.length; i++) {</span>
<a href="#l4.402"></a><span id="l4.402" class="difflineplus">+    level = levels[i]</span>
<a href="#l4.403"></a><span id="l4.403" class="difflineplus">+</span>
<a href="#l4.404"></a><span id="l4.404" class="difflineplus">+    logger[level] = noop</span>
<a href="#l4.405"></a><span id="l4.405" class="difflineplus">+    if(typeof console !== 'undefined' &amp;&amp; console &amp;&amp; console[level])</span>
<a href="#l4.406"></a><span id="l4.406" class="difflineplus">+      logger[level] = formatted(console, level)</span>
<a href="#l4.407"></a><span id="l4.407" class="difflineplus">+  }</span>
<a href="#l4.408"></a><span id="l4.408" class="difflineplus">+</span>
<a href="#l4.409"></a><span id="l4.409" class="difflineplus">+  return logger</span>
<a href="#l4.410"></a><span id="l4.410" class="difflineplus">+}</span>
<a href="#l4.411"></a><span id="l4.411" class="difflineplus">+</span>
<a href="#l4.412"></a><span id="l4.412" class="difflineplus">+function formatted(obj, method) {</span>
<a href="#l4.413"></a><span id="l4.413" class="difflineplus">+  return formatted_logger</span>
<a href="#l4.414"></a><span id="l4.414" class="difflineplus">+</span>
<a href="#l4.415"></a><span id="l4.415" class="difflineplus">+  function formatted_logger(str, context) {</span>
<a href="#l4.416"></a><span id="l4.416" class="difflineplus">+    if(typeof context === 'object')</span>
<a href="#l4.417"></a><span id="l4.417" class="difflineplus">+      str += ' ' + JSON.stringify(context)</span>
<a href="#l4.418"></a><span id="l4.418" class="difflineplus">+</span>
<a href="#l4.419"></a><span id="l4.419" class="difflineplus">+    return obj[method].call(obj, str)</span>
<a href="#l4.420"></a><span id="l4.420" class="difflineplus">+  }</span>
<a href="#l4.421"></a><span id="l4.421" class="difflineplus">+}</span>
<a href="#l4.422"></a><span id="l4.422" class="difflineplus">+</span>
<a href="#l4.423"></a><span id="l4.423" class="difflineplus">+// Return whether a URL is a cross-domain request.</span>
<a href="#l4.424"></a><span id="l4.424" class="difflineplus">+function is_crossDomain(url) {</span>
<a href="#l4.425"></a><span id="l4.425" class="difflineplus">+  var rurl = /^([\w\+\.\-]+:)(?:\/\/([^\/?#:]*)(?::(\d+))?)?/</span>
<a href="#l4.426"></a><span id="l4.426" class="difflineplus">+</span>
<a href="#l4.427"></a><span id="l4.427" class="difflineplus">+  // jQuery #8138, IE may throw an exception when accessing</span>
<a href="#l4.428"></a><span id="l4.428" class="difflineplus">+  // a field from window.location if document.domain has been set</span>
<a href="#l4.429"></a><span id="l4.429" class="difflineplus">+  var ajaxLocation</span>
<a href="#l4.430"></a><span id="l4.430" class="difflineplus">+  try { ajaxLocation = location.href }</span>
<a href="#l4.431"></a><span id="l4.431" class="difflineplus">+  catch (e) {</span>
<a href="#l4.432"></a><span id="l4.432" class="difflineplus">+    // Use the href attribute of an A element since IE will modify it given document.location</span>
<a href="#l4.433"></a><span id="l4.433" class="difflineplus">+    ajaxLocation = document.createElement( &quot;a&quot; );</span>
<a href="#l4.434"></a><span id="l4.434" class="difflineplus">+    ajaxLocation.href = &quot;&quot;;</span>
<a href="#l4.435"></a><span id="l4.435" class="difflineplus">+    ajaxLocation = ajaxLocation.href;</span>
<a href="#l4.436"></a><span id="l4.436" class="difflineplus">+  }</span>
<a href="#l4.437"></a><span id="l4.437" class="difflineplus">+</span>
<a href="#l4.438"></a><span id="l4.438" class="difflineplus">+  var ajaxLocParts = rurl.exec(ajaxLocation.toLowerCase()) || []</span>
<a href="#l4.439"></a><span id="l4.439" class="difflineplus">+    , parts = rurl.exec(url.toLowerCase() )</span>
<a href="#l4.440"></a><span id="l4.440" class="difflineplus">+</span>
<a href="#l4.441"></a><span id="l4.441" class="difflineplus">+  var result = !!(</span>
<a href="#l4.442"></a><span id="l4.442" class="difflineplus">+    parts &amp;&amp;</span>
<a href="#l4.443"></a><span id="l4.443" class="difflineplus">+    (  parts[1] != ajaxLocParts[1]</span>
<a href="#l4.444"></a><span id="l4.444" class="difflineplus">+    || parts[2] != ajaxLocParts[2]</span>
<a href="#l4.445"></a><span id="l4.445" class="difflineplus">+    || (parts[3] || (parts[1] === &quot;http:&quot; ? 80 : 443)) != (ajaxLocParts[3] || (ajaxLocParts[1] === &quot;http:&quot; ? 80 : 443))</span>
<a href="#l4.446"></a><span id="l4.446" class="difflineplus">+    )</span>
<a href="#l4.447"></a><span id="l4.447" class="difflineplus">+  )</span>
<a href="#l4.448"></a><span id="l4.448" class="difflineplus">+</span>
<a href="#l4.449"></a><span id="l4.449" class="difflineplus">+  //console.debug('is_crossDomain('+url+') -&gt; ' + result)</span>
<a href="#l4.450"></a><span id="l4.450" class="difflineplus">+  return result</span>
<a href="#l4.451"></a><span id="l4.451" class="difflineplus">+}</span>
<a href="#l4.452"></a><span id="l4.452" class="difflineplus">+</span>
<a href="#l4.453"></a><span id="l4.453" class="difflineplus">+// MIT License from http://phpjs.org/functions/base64_encode:358</span>
<a href="#l4.454"></a><span id="l4.454" class="difflineplus">+function b64_enc (data) {</span>
<a href="#l4.455"></a><span id="l4.455" class="difflineplus">+    // Encodes string using MIME base64 algorithm</span>
<a href="#l4.456"></a><span id="l4.456" class="difflineplus">+    var b64 = &quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=&quot;;</span>
<a href="#l4.457"></a><span id="l4.457" class="difflineplus">+    var o1, o2, o3, h1, h2, h3, h4, bits, i = 0, ac = 0, enc=&quot;&quot;, tmp_arr = [];</span>
<a href="#l4.458"></a><span id="l4.458" class="difflineplus">+</span>
<a href="#l4.459"></a><span id="l4.459" class="difflineplus">+    if (!data) {</span>
<a href="#l4.460"></a><span id="l4.460" class="difflineplus">+        return data;</span>
<a href="#l4.461"></a><span id="l4.461" class="difflineplus">+    }</span>
<a href="#l4.462"></a><span id="l4.462" class="difflineplus">+</span>
<a href="#l4.463"></a><span id="l4.463" class="difflineplus">+    // assume utf8 data</span>
<a href="#l4.464"></a><span id="l4.464" class="difflineplus">+    // data = this.utf8_encode(data+'');</span>
<a href="#l4.465"></a><span id="l4.465" class="difflineplus">+</span>
<a href="#l4.466"></a><span id="l4.466" class="difflineplus">+    do { // pack three octets into four hexets</span>
<a href="#l4.467"></a><span id="l4.467" class="difflineplus">+        o1 = data.charCodeAt(i++);</span>
<a href="#l4.468"></a><span id="l4.468" class="difflineplus">+        o2 = data.charCodeAt(i++);</span>
<a href="#l4.469"></a><span id="l4.469" class="difflineplus">+        o3 = data.charCodeAt(i++);</span>
<a href="#l4.470"></a><span id="l4.470" class="difflineplus">+</span>
<a href="#l4.471"></a><span id="l4.471" class="difflineplus">+        bits = o1&lt;&lt;16 | o2&lt;&lt;8 | o3;</span>
<a href="#l4.472"></a><span id="l4.472" class="difflineplus">+</span>
<a href="#l4.473"></a><span id="l4.473" class="difflineplus">+        h1 = bits&gt;&gt;18 &amp; 0x3f;</span>
<a href="#l4.474"></a><span id="l4.474" class="difflineplus">+        h2 = bits&gt;&gt;12 &amp; 0x3f;</span>
<a href="#l4.475"></a><span id="l4.475" class="difflineplus">+        h3 = bits&gt;&gt;6 &amp; 0x3f;</span>
<a href="#l4.476"></a><span id="l4.476" class="difflineplus">+        h4 = bits &amp; 0x3f;</span>
<a href="#l4.477"></a><span id="l4.477" class="difflineplus">+</span>
<a href="#l4.478"></a><span id="l4.478" class="difflineplus">+        // use hexets to index into b64, and append result to encoded string</span>
<a href="#l4.479"></a><span id="l4.479" class="difflineplus">+        tmp_arr[ac++] = b64.charAt(h1) + b64.charAt(h2) + b64.charAt(h3) + b64.charAt(h4);</span>
<a href="#l4.480"></a><span id="l4.480" class="difflineplus">+    } while (i &lt; data.length);</span>
<a href="#l4.481"></a><span id="l4.481" class="difflineplus">+</span>
<a href="#l4.482"></a><span id="l4.482" class="difflineplus">+    enc = tmp_arr.join('');</span>
<a href="#l4.483"></a><span id="l4.483" class="difflineplus">+</span>
<a href="#l4.484"></a><span id="l4.484" class="difflineplus">+    switch (data.length % 3) {</span>
<a href="#l4.485"></a><span id="l4.485" class="difflineplus">+        case 1:</span>
<a href="#l4.486"></a><span id="l4.486" class="difflineplus">+            enc = enc.slice(0, -2) + '==';</span>
<a href="#l4.487"></a><span id="l4.487" class="difflineplus">+        break;</span>
<a href="#l4.488"></a><span id="l4.488" class="difflineplus">+        case 2:</span>
<a href="#l4.489"></a><span id="l4.489" class="difflineplus">+            enc = enc.slice(0, -1) + '=';</span>
<a href="#l4.490"></a><span id="l4.490" class="difflineplus">+        break;</span>
<a href="#l4.491"></a><span id="l4.491" class="difflineplus">+    }</span>
<a href="#l4.492"></a><span id="l4.492" class="difflineplus">+</span>
<a href="#l4.493"></a><span id="l4.493" class="difflineplus">+    return enc;</span>
<a href="#l4.494"></a><span id="l4.494" class="difflineplus">+}</span>
<a href="#l4.495"></a><span id="l4.495" class="difflineplus">+    return request;</span>
<a href="#l4.496"></a><span id="l4.496" class="difflineplus">+//UMD FOOTER START</span>
<a href="#l4.497"></a><span id="l4.497" class="difflineplus">+}));</span>
<a href="#l4.498"></a><span id="l4.498" class="difflineplus">+//UMD FOOTER END</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1">new file mode 100644</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineminus">--- /dev/null</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineplus">+++ b/chat/protocols/matrix/matrix-sdk/browserify/events.js</span>
<a href="#l5.4"></a><span id="l5.4" class="difflineat">@@ -0,0 +1,301 @@</span>
<a href="#l5.5"></a><span id="l5.5" class="difflineplus">+// Copyright Joyent, Inc. and other Node contributors.</span>
<a href="#l5.6"></a><span id="l5.6" class="difflineplus">+//</span>
<a href="#l5.7"></a><span id="l5.7" class="difflineplus">+// Permission is hereby granted, free of charge, to any person obtaining a</span>
<a href="#l5.8"></a><span id="l5.8" class="difflineplus">+// copy of this software and associated documentation files (the</span>
<a href="#l5.9"></a><span id="l5.9" class="difflineplus">+// &quot;Software&quot;), to deal in the Software without restriction, including</span>
<a href="#l5.10"></a><span id="l5.10" class="difflineplus">+// without limitation the rights to use, copy, modify, merge, publish,</span>
<a href="#l5.11"></a><span id="l5.11" class="difflineplus">+// distribute, sublicense, and/or sell copies of the Software, and to permit</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+// persons to whom the Software is furnished to do so, subject to the</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+// following conditions:</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+//</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineplus">+// The above copyright notice and this permission notice shall be included</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineplus">+// in all copies or substantial portions of the Software.</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineplus">+//</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineplus">+// THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineplus">+// OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineplus">+// MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineplus">+// NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineplus">+// DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR</span>
<a href="#l5.23"></a><span id="l5.23" class="difflineplus">+// OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE</span>
<a href="#l5.24"></a><span id="l5.24" class="difflineplus">+// USE OR OTHER DEALINGS IN THE SOFTWARE.</span>
<a href="#l5.25"></a><span id="l5.25" class="difflineplus">+</span>
<a href="#l5.26"></a><span id="l5.26" class="difflineplus">+function EventEmitter() {</span>
<a href="#l5.27"></a><span id="l5.27" class="difflineplus">+  this._events = this._events || {};</span>
<a href="#l5.28"></a><span id="l5.28" class="difflineplus">+  this._maxListeners = this._maxListeners || undefined;</span>
<a href="#l5.29"></a><span id="l5.29" class="difflineplus">+}</span>
<a href="#l5.30"></a><span id="l5.30" class="difflineplus">+module.exports = EventEmitter;</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineplus">+</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineplus">+// Backwards-compat with node 0.10.x</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineplus">+EventEmitter.EventEmitter = EventEmitter;</span>
<a href="#l5.34"></a><span id="l5.34" class="difflineplus">+</span>
<a href="#l5.35"></a><span id="l5.35" class="difflineplus">+EventEmitter.prototype._events = undefined;</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineplus">+EventEmitter.prototype._maxListeners = undefined;</span>
<a href="#l5.37"></a><span id="l5.37" class="difflineplus">+</span>
<a href="#l5.38"></a><span id="l5.38" class="difflineplus">+// By default EventEmitters will print a warning if more than 10 listeners are</span>
<a href="#l5.39"></a><span id="l5.39" class="difflineplus">+// added to it. This is a useful default which helps finding memory leaks.</span>
<a href="#l5.40"></a><span id="l5.40" class="difflineplus">+EventEmitter.defaultMaxListeners = 10;</span>
<a href="#l5.41"></a><span id="l5.41" class="difflineplus">+</span>
<a href="#l5.42"></a><span id="l5.42" class="difflineplus">+// Obviously not all Emitters should be limited to 10. This function allows</span>
<a href="#l5.43"></a><span id="l5.43" class="difflineplus">+// that to be increased. Set to zero for unlimited.</span>
<a href="#l5.44"></a><span id="l5.44" class="difflineplus">+EventEmitter.prototype.setMaxListeners = function(n) {</span>
<a href="#l5.45"></a><span id="l5.45" class="difflineplus">+  if (!isNumber(n) || n &lt; 0 || isNaN(n))</span>
<a href="#l5.46"></a><span id="l5.46" class="difflineplus">+    throw TypeError('n must be a positive number');</span>
<a href="#l5.47"></a><span id="l5.47" class="difflineplus">+  this._maxListeners = n;</span>
<a href="#l5.48"></a><span id="l5.48" class="difflineplus">+  return this;</span>
<a href="#l5.49"></a><span id="l5.49" class="difflineplus">+};</span>
<a href="#l5.50"></a><span id="l5.50" class="difflineplus">+</span>
<a href="#l5.51"></a><span id="l5.51" class="difflineplus">+EventEmitter.prototype.emit = function(type) {</span>
<a href="#l5.52"></a><span id="l5.52" class="difflineplus">+  var er, handler, len, args, i, listeners;</span>
<a href="#l5.53"></a><span id="l5.53" class="difflineplus">+</span>
<a href="#l5.54"></a><span id="l5.54" class="difflineplus">+  if (!this._events)</span>
<a href="#l5.55"></a><span id="l5.55" class="difflineplus">+    this._events = {};</span>
<a href="#l5.56"></a><span id="l5.56" class="difflineplus">+</span>
<a href="#l5.57"></a><span id="l5.57" class="difflineplus">+  // If there is no 'error' event listener then throw.</span>
<a href="#l5.58"></a><span id="l5.58" class="difflineplus">+  if (type === 'error') {</span>
<a href="#l5.59"></a><span id="l5.59" class="difflineplus">+    if (!this._events.error ||</span>
<a href="#l5.60"></a><span id="l5.60" class="difflineplus">+        (isObject(this._events.error) &amp;&amp; !this._events.error.length)) {</span>
<a href="#l5.61"></a><span id="l5.61" class="difflineplus">+      er = arguments[1];</span>
<a href="#l5.62"></a><span id="l5.62" class="difflineplus">+      if (er instanceof Error) {</span>
<a href="#l5.63"></a><span id="l5.63" class="difflineplus">+        throw er; // Unhandled 'error' event</span>
<a href="#l5.64"></a><span id="l5.64" class="difflineplus">+      }</span>
<a href="#l5.65"></a><span id="l5.65" class="difflineplus">+      throw TypeError('Uncaught, unspecified &quot;error&quot; event.');</span>
<a href="#l5.66"></a><span id="l5.66" class="difflineplus">+    }</span>
<a href="#l5.67"></a><span id="l5.67" class="difflineplus">+  }</span>
<a href="#l5.68"></a><span id="l5.68" class="difflineplus">+</span>
<a href="#l5.69"></a><span id="l5.69" class="difflineplus">+  handler = this._events[type];</span>
<a href="#l5.70"></a><span id="l5.70" class="difflineplus">+</span>
<a href="#l5.71"></a><span id="l5.71" class="difflineplus">+  if (isUndefined(handler))</span>
<a href="#l5.72"></a><span id="l5.72" class="difflineplus">+    return false;</span>
<a href="#l5.73"></a><span id="l5.73" class="difflineplus">+</span>
<a href="#l5.74"></a><span id="l5.74" class="difflineplus">+  if (isFunction(handler)) {</span>
<a href="#l5.75"></a><span id="l5.75" class="difflineplus">+    switch (arguments.length) {</span>
<a href="#l5.76"></a><span id="l5.76" class="difflineplus">+      // fast cases</span>
<a href="#l5.77"></a><span id="l5.77" class="difflineplus">+      case 1:</span>
<a href="#l5.78"></a><span id="l5.78" class="difflineplus">+        handler.call(this);</span>
<a href="#l5.79"></a><span id="l5.79" class="difflineplus">+        break;</span>
<a href="#l5.80"></a><span id="l5.80" class="difflineplus">+      case 2:</span>
<a href="#l5.81"></a><span id="l5.81" class="difflineplus">+        handler.call(this, arguments[1]);</span>
<a href="#l5.82"></a><span id="l5.82" class="difflineplus">+        break;</span>
<a href="#l5.83"></a><span id="l5.83" class="difflineplus">+      case 3:</span>
<a href="#l5.84"></a><span id="l5.84" class="difflineplus">+        handler.call(this, arguments[1], arguments[2]);</span>
<a href="#l5.85"></a><span id="l5.85" class="difflineplus">+        break;</span>
<a href="#l5.86"></a><span id="l5.86" class="difflineplus">+      // slower</span>
<a href="#l5.87"></a><span id="l5.87" class="difflineplus">+      default:</span>
<a href="#l5.88"></a><span id="l5.88" class="difflineplus">+        len = arguments.length;</span>
<a href="#l5.89"></a><span id="l5.89" class="difflineplus">+        args = new Array(len - 1);</span>
<a href="#l5.90"></a><span id="l5.90" class="difflineplus">+        for (i = 1; i &lt; len; i++)</span>
<a href="#l5.91"></a><span id="l5.91" class="difflineplus">+          args[i - 1] = arguments[i];</span>
<a href="#l5.92"></a><span id="l5.92" class="difflineplus">+        handler.apply(this, args);</span>
<a href="#l5.93"></a><span id="l5.93" class="difflineplus">+    }</span>
<a href="#l5.94"></a><span id="l5.94" class="difflineplus">+  } else if (isObject(handler)) {</span>
<a href="#l5.95"></a><span id="l5.95" class="difflineplus">+    len = arguments.length;</span>
<a href="#l5.96"></a><span id="l5.96" class="difflineplus">+    args = new Array(len - 1);</span>
<a href="#l5.97"></a><span id="l5.97" class="difflineplus">+    for (i = 1; i &lt; len; i++)</span>
<a href="#l5.98"></a><span id="l5.98" class="difflineplus">+      args[i - 1] = arguments[i];</span>
<a href="#l5.99"></a><span id="l5.99" class="difflineplus">+</span>
<a href="#l5.100"></a><span id="l5.100" class="difflineplus">+    listeners = handler.slice();</span>
<a href="#l5.101"></a><span id="l5.101" class="difflineplus">+    len = listeners.length;</span>
<a href="#l5.102"></a><span id="l5.102" class="difflineplus">+    for (i = 0; i &lt; len; i++)</span>
<a href="#l5.103"></a><span id="l5.103" class="difflineplus">+      listeners[i].apply(this, args);</span>
<a href="#l5.104"></a><span id="l5.104" class="difflineplus">+  }</span>
<a href="#l5.105"></a><span id="l5.105" class="difflineplus">+</span>
<a href="#l5.106"></a><span id="l5.106" class="difflineplus">+  return true;</span>
<a href="#l5.107"></a><span id="l5.107" class="difflineplus">+};</span>
<a href="#l5.108"></a><span id="l5.108" class="difflineplus">+</span>
<a href="#l5.109"></a><span id="l5.109" class="difflineplus">+EventEmitter.prototype.addListener = function(type, listener) {</span>
<a href="#l5.110"></a><span id="l5.110" class="difflineplus">+  var m;</span>
<a href="#l5.111"></a><span id="l5.111" class="difflineplus">+</span>
<a href="#l5.112"></a><span id="l5.112" class="difflineplus">+  if (!isFunction(listener))</span>
<a href="#l5.113"></a><span id="l5.113" class="difflineplus">+    throw TypeError('listener must be a function');</span>
<a href="#l5.114"></a><span id="l5.114" class="difflineplus">+</span>
<a href="#l5.115"></a><span id="l5.115" class="difflineplus">+  if (!this._events)</span>
<a href="#l5.116"></a><span id="l5.116" class="difflineplus">+    this._events = {};</span>
<a href="#l5.117"></a><span id="l5.117" class="difflineplus">+</span>
<a href="#l5.118"></a><span id="l5.118" class="difflineplus">+  // To avoid recursion in the case that type === &quot;newListener&quot;! Before</span>
<a href="#l5.119"></a><span id="l5.119" class="difflineplus">+  // adding it to the listeners, first emit &quot;newListener&quot;.</span>
<a href="#l5.120"></a><span id="l5.120" class="difflineplus">+  if (this._events.newListener)</span>
<a href="#l5.121"></a><span id="l5.121" class="difflineplus">+    this.emit('newListener', type,</span>
<a href="#l5.122"></a><span id="l5.122" class="difflineplus">+              isFunction(listener.listener) ?</span>
<a href="#l5.123"></a><span id="l5.123" class="difflineplus">+              listener.listener : listener);</span>
<a href="#l5.124"></a><span id="l5.124" class="difflineplus">+</span>
<a href="#l5.125"></a><span id="l5.125" class="difflineplus">+  if (!this._events[type])</span>
<a href="#l5.126"></a><span id="l5.126" class="difflineplus">+    // Optimize the case of one listener. Don't need the extra array object.</span>
<a href="#l5.127"></a><span id="l5.127" class="difflineplus">+    this._events[type] = listener;</span>
<a href="#l5.128"></a><span id="l5.128" class="difflineplus">+  else if (isObject(this._events[type]))</span>
<a href="#l5.129"></a><span id="l5.129" class="difflineplus">+    // If we've already got an array, just append.</span>
<a href="#l5.130"></a><span id="l5.130" class="difflineplus">+    this._events[type].push(listener);</span>
<a href="#l5.131"></a><span id="l5.131" class="difflineplus">+  else</span>
<a href="#l5.132"></a><span id="l5.132" class="difflineplus">+    // Adding the second element, need to change to array.</span>
<a href="#l5.133"></a><span id="l5.133" class="difflineplus">+    this._events[type] = [this._events[type], listener];</span>
<a href="#l5.134"></a><span id="l5.134" class="difflineplus">+</span>
<a href="#l5.135"></a><span id="l5.135" class="difflineplus">+  // Check for listener leak</span>
<a href="#l5.136"></a><span id="l5.136" class="difflineplus">+  if (isObject(this._events[type]) &amp;&amp; !this._events[type].warned) {</span>
<a href="#l5.137"></a><span id="l5.137" class="difflineplus">+    var m;</span>
<a href="#l5.138"></a><span id="l5.138" class="difflineplus">+    if (!isUndefined(this._maxListeners)) {</span>
<a href="#l5.139"></a><span id="l5.139" class="difflineplus">+      m = this._maxListeners;</span>
<a href="#l5.140"></a><span id="l5.140" class="difflineplus">+    } else {</span>
<a href="#l5.141"></a><span id="l5.141" class="difflineplus">+      m = EventEmitter.defaultMaxListeners;</span>
<a href="#l5.142"></a><span id="l5.142" class="difflineplus">+    }</span>
<a href="#l5.143"></a><span id="l5.143" class="difflineplus">+</span>
<a href="#l5.144"></a><span id="l5.144" class="difflineplus">+    if (m &amp;&amp; m &gt; 0 &amp;&amp; this._events[type].length &gt; m) {</span>
<a href="#l5.145"></a><span id="l5.145" class="difflineplus">+      this._events[type].warned = true;</span>
<a href="#l5.146"></a><span id="l5.146" class="difflineplus">+      console.error('(node) warning: possible EventEmitter memory ' +</span>
<a href="#l5.147"></a><span id="l5.147" class="difflineplus">+                    'leak detected. %d listeners added. ' +</span>
<a href="#l5.148"></a><span id="l5.148" class="difflineplus">+                    'Use emitter.setMaxListeners() to increase limit.',</span>
<a href="#l5.149"></a><span id="l5.149" class="difflineplus">+                    this._events[type].length);</span>
<a href="#l5.150"></a><span id="l5.150" class="difflineplus">+      if (typeof console.trace === 'function') {</span>
<a href="#l5.151"></a><span id="l5.151" class="difflineplus">+        // not supported in IE 10</span>
<a href="#l5.152"></a><span id="l5.152" class="difflineplus">+        console.trace();</span>
<a href="#l5.153"></a><span id="l5.153" class="difflineplus">+      }</span>
<a href="#l5.154"></a><span id="l5.154" class="difflineplus">+    }</span>
<a href="#l5.155"></a><span id="l5.155" class="difflineplus">+  }</span>
<a href="#l5.156"></a><span id="l5.156" class="difflineplus">+</span>
<a href="#l5.157"></a><span id="l5.157" class="difflineplus">+  return this;</span>
<a href="#l5.158"></a><span id="l5.158" class="difflineplus">+};</span>
<a href="#l5.159"></a><span id="l5.159" class="difflineplus">+</span>
<a href="#l5.160"></a><span id="l5.160" class="difflineplus">+EventEmitter.prototype.on = EventEmitter.prototype.addListener;</span>
<a href="#l5.161"></a><span id="l5.161" class="difflineplus">+</span>
<a href="#l5.162"></a><span id="l5.162" class="difflineplus">+EventEmitter.prototype.once = function(type, listener) {</span>
<a href="#l5.163"></a><span id="l5.163" class="difflineplus">+  if (!isFunction(listener))</span>
<a href="#l5.164"></a><span id="l5.164" class="difflineplus">+    throw TypeError('listener must be a function');</span>
<a href="#l5.165"></a><span id="l5.165" class="difflineplus">+</span>
<a href="#l5.166"></a><span id="l5.166" class="difflineplus">+  var fired = false;</span>
<a href="#l5.167"></a><span id="l5.167" class="difflineplus">+</span>
<a href="#l5.168"></a><span id="l5.168" class="difflineplus">+  function g() {</span>
<a href="#l5.169"></a><span id="l5.169" class="difflineplus">+    this.removeListener(type, g);</span>
<a href="#l5.170"></a><span id="l5.170" class="difflineplus">+</span>
<a href="#l5.171"></a><span id="l5.171" class="difflineplus">+    if (!fired) {</span>
<a href="#l5.172"></a><span id="l5.172" class="difflineplus">+      fired = true;</span>
<a href="#l5.173"></a><span id="l5.173" class="difflineplus">+      listener.apply(this, arguments);</span>
<a href="#l5.174"></a><span id="l5.174" class="difflineplus">+    }</span>
<a href="#l5.175"></a><span id="l5.175" class="difflineplus">+  }</span>
<a href="#l5.176"></a><span id="l5.176" class="difflineplus">+</span>
<a href="#l5.177"></a><span id="l5.177" class="difflineplus">+  g.listener = listener;</span>
<a href="#l5.178"></a><span id="l5.178" class="difflineplus">+  this.on(type, g);</span>
<a href="#l5.179"></a><span id="l5.179" class="difflineplus">+</span>
<a href="#l5.180"></a><span id="l5.180" class="difflineplus">+  return this;</span>
<a href="#l5.181"></a><span id="l5.181" class="difflineplus">+};</span>
<a href="#l5.182"></a><span id="l5.182" class="difflineplus">+</span>
<a href="#l5.183"></a><span id="l5.183" class="difflineplus">+// emits a 'removeListener' event iff the listener was removed</span>
<a href="#l5.184"></a><span id="l5.184" class="difflineplus">+EventEmitter.prototype.removeListener = function(type, listener) {</span>
<a href="#l5.185"></a><span id="l5.185" class="difflineplus">+  var list, position, length, i;</span>
<a href="#l5.186"></a><span id="l5.186" class="difflineplus">+</span>
<a href="#l5.187"></a><span id="l5.187" class="difflineplus">+  if (!isFunction(listener))</span>
<a href="#l5.188"></a><span id="l5.188" class="difflineplus">+    throw TypeError('listener must be a function');</span>
<a href="#l5.189"></a><span id="l5.189" class="difflineplus">+</span>
<a href="#l5.190"></a><span id="l5.190" class="difflineplus">+  if (!this._events || !this._events[type])</span>
<a href="#l5.191"></a><span id="l5.191" class="difflineplus">+    return this;</span>
<a href="#l5.192"></a><span id="l5.192" class="difflineplus">+</span>
<a href="#l5.193"></a><span id="l5.193" class="difflineplus">+  list = this._events[type];</span>
<a href="#l5.194"></a><span id="l5.194" class="difflineplus">+  length = list.length;</span>
<a href="#l5.195"></a><span id="l5.195" class="difflineplus">+  position = -1;</span>
<a href="#l5.196"></a><span id="l5.196" class="difflineplus">+</span>
<a href="#l5.197"></a><span id="l5.197" class="difflineplus">+  if (list === listener ||</span>
<a href="#l5.198"></a><span id="l5.198" class="difflineplus">+      (isFunction(list.listener) &amp;&amp; list.listener === listener)) {</span>
<a href="#l5.199"></a><span id="l5.199" class="difflineplus">+    delete this._events[type];</span>
<a href="#l5.200"></a><span id="l5.200" class="difflineplus">+    if (this._events.removeListener)</span>
<a href="#l5.201"></a><span id="l5.201" class="difflineplus">+      this.emit('removeListener', type, listener);</span>
<a href="#l5.202"></a><span id="l5.202" class="difflineplus">+</span>
<a href="#l5.203"></a><span id="l5.203" class="difflineplus">+  } else if (isObject(list)) {</span>
<a href="#l5.204"></a><span id="l5.204" class="difflineplus">+    for (i = length; i-- &gt; 0;) {</span>
<a href="#l5.205"></a><span id="l5.205" class="difflineplus">+      if (list[i] === listener ||</span>
<a href="#l5.206"></a><span id="l5.206" class="difflineplus">+          (list[i].listener &amp;&amp; list[i].listener === listener)) {</span>
<a href="#l5.207"></a><span id="l5.207" class="difflineplus">+        position = i;</span>
<a href="#l5.208"></a><span id="l5.208" class="difflineplus">+        break;</span>
<a href="#l5.209"></a><span id="l5.209" class="difflineplus">+      }</span>
<a href="#l5.210"></a><span id="l5.210" class="difflineplus">+    }</span>
<a href="#l5.211"></a><span id="l5.211" class="difflineplus">+</span>
<a href="#l5.212"></a><span id="l5.212" class="difflineplus">+    if (position &lt; 0)</span>
<a href="#l5.213"></a><span id="l5.213" class="difflineplus">+      return this;</span>
<a href="#l5.214"></a><span id="l5.214" class="difflineplus">+</span>
<a href="#l5.215"></a><span id="l5.215" class="difflineplus">+    if (list.length === 1) {</span>
<a href="#l5.216"></a><span id="l5.216" class="difflineplus">+      list.length = 0;</span>
<a href="#l5.217"></a><span id="l5.217" class="difflineplus">+      delete this._events[type];</span>
<a href="#l5.218"></a><span id="l5.218" class="difflineplus">+    } else {</span>
<a href="#l5.219"></a><span id="l5.219" class="difflineplus">+      list.splice(position, 1);</span>
<a href="#l5.220"></a><span id="l5.220" class="difflineplus">+    }</span>
<a href="#l5.221"></a><span id="l5.221" class="difflineplus">+</span>
<a href="#l5.222"></a><span id="l5.222" class="difflineplus">+    if (this._events.removeListener)</span>
<a href="#l5.223"></a><span id="l5.223" class="difflineplus">+      this.emit('removeListener', type, listener);</span>
<a href="#l5.224"></a><span id="l5.224" class="difflineplus">+  }</span>
<a href="#l5.225"></a><span id="l5.225" class="difflineplus">+</span>
<a href="#l5.226"></a><span id="l5.226" class="difflineplus">+  return this;</span>
<a href="#l5.227"></a><span id="l5.227" class="difflineplus">+};</span>
<a href="#l5.228"></a><span id="l5.228" class="difflineplus">+</span>
<a href="#l5.229"></a><span id="l5.229" class="difflineplus">+EventEmitter.prototype.removeAllListeners = function(type) {</span>
<a href="#l5.230"></a><span id="l5.230" class="difflineplus">+  var key, listeners;</span>
<a href="#l5.231"></a><span id="l5.231" class="difflineplus">+</span>
<a href="#l5.232"></a><span id="l5.232" class="difflineplus">+  if (!this._events)</span>
<a href="#l5.233"></a><span id="l5.233" class="difflineplus">+    return this;</span>
<a href="#l5.234"></a><span id="l5.234" class="difflineplus">+</span>
<a href="#l5.235"></a><span id="l5.235" class="difflineplus">+  // not listening for removeListener, no need to emit</span>
<a href="#l5.236"></a><span id="l5.236" class="difflineplus">+  if (!this._events.removeListener) {</span>
<a href="#l5.237"></a><span id="l5.237" class="difflineplus">+    if (arguments.length === 0)</span>
<a href="#l5.238"></a><span id="l5.238" class="difflineplus">+      this._events = {};</span>
<a href="#l5.239"></a><span id="l5.239" class="difflineplus">+    else if (this._events[type])</span>
<a href="#l5.240"></a><span id="l5.240" class="difflineplus">+      delete this._events[type];</span>
<a href="#l5.241"></a><span id="l5.241" class="difflineplus">+    return this;</span>
<a href="#l5.242"></a><span id="l5.242" class="difflineplus">+  }</span>
<a href="#l5.243"></a><span id="l5.243" class="difflineplus">+</span>
<a href="#l5.244"></a><span id="l5.244" class="difflineplus">+  // emit removeListener for all listeners on all events</span>
<a href="#l5.245"></a><span id="l5.245" class="difflineplus">+  if (arguments.length === 0) {</span>
<a href="#l5.246"></a><span id="l5.246" class="difflineplus">+    for (key in this._events) {</span>
<a href="#l5.247"></a><span id="l5.247" class="difflineplus">+      if (key === 'removeListener') continue;</span>
<a href="#l5.248"></a><span id="l5.248" class="difflineplus">+      this.removeAllListeners(key);</span>
<a href="#l5.249"></a><span id="l5.249" class="difflineplus">+    }</span>
<a href="#l5.250"></a><span id="l5.250" class="difflineplus">+    this.removeAllListeners('removeListener');</span>
<a href="#l5.251"></a><span id="l5.251" class="difflineplus">+    this._events = {};</span>
<a href="#l5.252"></a><span id="l5.252" class="difflineplus">+    return this;</span>
<a href="#l5.253"></a><span id="l5.253" class="difflineplus">+  }</span>
<a href="#l5.254"></a><span id="l5.254" class="difflineplus">+</span>
<a href="#l5.255"></a><span id="l5.255" class="difflineplus">+  listeners = this._events[type];</span>
<a href="#l5.256"></a><span id="l5.256" class="difflineplus">+</span>
<a href="#l5.257"></a><span id="l5.257" class="difflineplus">+  if (isFunction(listeners)) {</span>
<a href="#l5.258"></a><span id="l5.258" class="difflineplus">+    this.removeListener(type, listeners);</span>
<a href="#l5.259"></a><span id="l5.259" class="difflineplus">+  } else {</span>
<a href="#l5.260"></a><span id="l5.260" class="difflineplus">+    // LIFO order</span>
<a href="#l5.261"></a><span id="l5.261" class="difflineplus">+    while (listeners.length)</span>
<a href="#l5.262"></a><span id="l5.262" class="difflineplus">+      this.removeListener(type, listeners[listeners.length - 1]);</span>
<a href="#l5.263"></a><span id="l5.263" class="difflineplus">+  }</span>
<a href="#l5.264"></a><span id="l5.264" class="difflineplus">+  delete this._events[type];</span>
<a href="#l5.265"></a><span id="l5.265" class="difflineplus">+</span>
<a href="#l5.266"></a><span id="l5.266" class="difflineplus">+  return this;</span>
<a href="#l5.267"></a><span id="l5.267" class="difflineplus">+};</span>
<a href="#l5.268"></a><span id="l5.268" class="difflineplus">+</span>
<a href="#l5.269"></a><span id="l5.269" class="difflineplus">+EventEmitter.prototype.listeners = function(type) {</span>
<a href="#l5.270"></a><span id="l5.270" class="difflineplus">+  var ret;</span>
<a href="#l5.271"></a><span id="l5.271" class="difflineplus">+  if (!this._events || !this._events[type])</span>
<a href="#l5.272"></a><span id="l5.272" class="difflineplus">+    ret = [];</span>
<a href="#l5.273"></a><span id="l5.273" class="difflineplus">+  else if (isFunction(this._events[type]))</span>
<a href="#l5.274"></a><span id="l5.274" class="difflineplus">+    ret = [this._events[type]];</span>
<a href="#l5.275"></a><span id="l5.275" class="difflineplus">+  else</span>
<a href="#l5.276"></a><span id="l5.276" class="difflineplus">+    ret = this._events[type].slice();</span>
<a href="#l5.277"></a><span id="l5.277" class="difflineplus">+  return ret;</span>
<a href="#l5.278"></a><span id="l5.278" class="difflineplus">+};</span>
<a href="#l5.279"></a><span id="l5.279" class="difflineplus">+</span>
<a href="#l5.280"></a><span id="l5.280" class="difflineplus">+EventEmitter.listenerCount = function(emitter, type) {</span>
<a href="#l5.281"></a><span id="l5.281" class="difflineplus">+  var ret;</span>
<a href="#l5.282"></a><span id="l5.282" class="difflineplus">+  if (!emitter._events || !emitter._events[type])</span>
<a href="#l5.283"></a><span id="l5.283" class="difflineplus">+    ret = 0;</span>
<a href="#l5.284"></a><span id="l5.284" class="difflineplus">+  else if (isFunction(emitter._events[type]))</span>
<a href="#l5.285"></a><span id="l5.285" class="difflineplus">+    ret = 1;</span>
<a href="#l5.286"></a><span id="l5.286" class="difflineplus">+  else</span>
<a href="#l5.287"></a><span id="l5.287" class="difflineplus">+    ret = emitter._events[type].length;</span>
<a href="#l5.288"></a><span id="l5.288" class="difflineplus">+  return ret;</span>
<a href="#l5.289"></a><span id="l5.289" class="difflineplus">+};</span>
<a href="#l5.290"></a><span id="l5.290" class="difflineplus">+</span>
<a href="#l5.291"></a><span id="l5.291" class="difflineplus">+function isFunction(arg) {</span>
<a href="#l5.292"></a><span id="l5.292" class="difflineplus">+  return typeof arg === 'function';</span>
<a href="#l5.293"></a><span id="l5.293" class="difflineplus">+}</span>
<a href="#l5.294"></a><span id="l5.294" class="difflineplus">+</span>
<a href="#l5.295"></a><span id="l5.295" class="difflineplus">+function isNumber(arg) {</span>
<a href="#l5.296"></a><span id="l5.296" class="difflineplus">+  return typeof arg === 'number';</span>
<a href="#l5.297"></a><span id="l5.297" class="difflineplus">+}</span>
<a href="#l5.298"></a><span id="l5.298" class="difflineplus">+</span>
<a href="#l5.299"></a><span id="l5.299" class="difflineplus">+function isObject(arg) {</span>
<a href="#l5.300"></a><span id="l5.300" class="difflineplus">+  return typeof arg === 'object' &amp;&amp; arg !== null;</span>
<a href="#l5.301"></a><span id="l5.301" class="difflineplus">+}</span>
<a href="#l5.302"></a><span id="l5.302" class="difflineplus">+</span>
<a href="#l5.303"></a><span id="l5.303" class="difflineplus">+function isUndefined(arg) {</span>
<a href="#l5.304"></a><span id="l5.304" class="difflineplus">+  return arg === void 0;</span>
<a href="#l5.305"></a><span id="l5.305" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1">new file mode 100644</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineminus">--- /dev/null</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineplus">+++ b/chat/protocols/matrix/matrix-sdk/browserify/punycode.js</span>
<a href="#l6.4"></a><span id="l6.4" class="difflineat">@@ -0,0 +1,552 @@</span>
<a href="#l6.5"></a><span id="l6.5" class="difflineplus">+/*</span>
<a href="#l6.6"></a><span id="l6.6" class="difflineplus">+Copyright Mathias Bynens &lt;https://mathiasbynens.be/&gt;</span>
<a href="#l6.7"></a><span id="l6.7" class="difflineplus">+</span>
<a href="#l6.8"></a><span id="l6.8" class="difflineplus">+Permission is hereby granted, free of charge, to any person obtaining</span>
<a href="#l6.9"></a><span id="l6.9" class="difflineplus">+a copy of this software and associated documentation files (the</span>
<a href="#l6.10"></a><span id="l6.10" class="difflineplus">+&quot;Software&quot;), to deal in the Software without restriction, including</span>
<a href="#l6.11"></a><span id="l6.11" class="difflineplus">+without limitation the rights to use, copy, modify, merge, publish,</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineplus">+distribute, sublicense, and/or sell copies of the Software, and to</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+permit persons to whom the Software is furnished to do so, subject to</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+the following conditions:</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineplus">+</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineplus">+The above copyright notice and this permission notice shall be</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineplus">+included in all copies or substantial portions of the Software.</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineplus">+</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineplus">+THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND,</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineplus">+EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineplus">+MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineplus">+NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineplus">+LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineplus">+OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION</span>
<a href="#l6.25"></a><span id="l6.25" class="difflineplus">+WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.</span>
<a href="#l6.26"></a><span id="l6.26" class="difflineplus">+*/</span>
<a href="#l6.27"></a><span id="l6.27" class="difflineplus">+/*! https://mths.be/punycode v1.3.2 by @mathias */</span>
<a href="#l6.28"></a><span id="l6.28" class="difflineplus">+;(function(root) {</span>
<a href="#l6.29"></a><span id="l6.29" class="difflineplus">+</span>
<a href="#l6.30"></a><span id="l6.30" class="difflineplus">+	/** Detect free variables */</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineplus">+	var freeExports = typeof exports == 'object' &amp;&amp; exports &amp;&amp;</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineplus">+		!exports.nodeType &amp;&amp; exports;</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineplus">+	var freeModule = typeof module == 'object' &amp;&amp; module &amp;&amp;</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineplus">+		!module.nodeType &amp;&amp; module;</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineplus">+	var freeGlobal = typeof global == 'object' &amp;&amp; global;</span>
<a href="#l6.36"></a><span id="l6.36" class="difflineplus">+	if (</span>
<a href="#l6.37"></a><span id="l6.37" class="difflineplus">+		freeGlobal.global === freeGlobal ||</span>
<a href="#l6.38"></a><span id="l6.38" class="difflineplus">+		freeGlobal.window === freeGlobal ||</span>
<a href="#l6.39"></a><span id="l6.39" class="difflineplus">+		freeGlobal.self === freeGlobal</span>
<a href="#l6.40"></a><span id="l6.40" class="difflineplus">+	) {</span>
<a href="#l6.41"></a><span id="l6.41" class="difflineplus">+		root = freeGlobal;</span>
<a href="#l6.42"></a><span id="l6.42" class="difflineplus">+	}</span>
<a href="#l6.43"></a><span id="l6.43" class="difflineplus">+</span>
<a href="#l6.44"></a><span id="l6.44" class="difflineplus">+	/**</span>
<a href="#l6.45"></a><span id="l6.45" class="difflineplus">+	 * The `punycode` object.</span>
<a href="#l6.46"></a><span id="l6.46" class="difflineplus">+	 * @name punycode</span>
<a href="#l6.47"></a><span id="l6.47" class="difflineplus">+	 * @type Object</span>
<a href="#l6.48"></a><span id="l6.48" class="difflineplus">+	 */</span>
<a href="#l6.49"></a><span id="l6.49" class="difflineplus">+	var punycode,</span>
<a href="#l6.50"></a><span id="l6.50" class="difflineplus">+</span>
<a href="#l6.51"></a><span id="l6.51" class="difflineplus">+	/** Highest positive signed 32-bit float value */</span>
<a href="#l6.52"></a><span id="l6.52" class="difflineplus">+	maxInt = 2147483647, // aka. 0x7FFFFFFF or 2^31-1</span>
<a href="#l6.53"></a><span id="l6.53" class="difflineplus">+</span>
<a href="#l6.54"></a><span id="l6.54" class="difflineplus">+	/** Bootstring parameters */</span>
<a href="#l6.55"></a><span id="l6.55" class="difflineplus">+	base = 36,</span>
<a href="#l6.56"></a><span id="l6.56" class="difflineplus">+	tMin = 1,</span>
<a href="#l6.57"></a><span id="l6.57" class="difflineplus">+	tMax = 26,</span>
<a href="#l6.58"></a><span id="l6.58" class="difflineplus">+	skew = 38,</span>
<a href="#l6.59"></a><span id="l6.59" class="difflineplus">+	damp = 700,</span>
<a href="#l6.60"></a><span id="l6.60" class="difflineplus">+	initialBias = 72,</span>
<a href="#l6.61"></a><span id="l6.61" class="difflineplus">+	initialN = 128, // 0x80</span>
<a href="#l6.62"></a><span id="l6.62" class="difflineplus">+	delimiter = '-', // '\x2D'</span>
<a href="#l6.63"></a><span id="l6.63" class="difflineplus">+</span>
<a href="#l6.64"></a><span id="l6.64" class="difflineplus">+	/** Regular expressions */</span>
<a href="#l6.65"></a><span id="l6.65" class="difflineplus">+	regexPunycode = /^xn--/,</span>
<a href="#l6.66"></a><span id="l6.66" class="difflineplus">+	regexNonASCII = /[^\x20-\x7E]/, // unprintable ASCII chars + non-ASCII chars</span>
<a href="#l6.67"></a><span id="l6.67" class="difflineplus">+	regexSeparators = /[\x2E\u3002\uFF0E\uFF61]/g, // RFC 3490 separators</span>
<a href="#l6.68"></a><span id="l6.68" class="difflineplus">+</span>
<a href="#l6.69"></a><span id="l6.69" class="difflineplus">+	/** Error messages */</span>
<a href="#l6.70"></a><span id="l6.70" class="difflineplus">+	errors = {</span>
<a href="#l6.71"></a><span id="l6.71" class="difflineplus">+		'overflow': 'Overflow: input needs wider integers to process',</span>
<a href="#l6.72"></a><span id="l6.72" class="difflineplus">+		'not-basic': 'Illegal input &gt;= 0x80 (not a basic code point)',</span>
<a href="#l6.73"></a><span id="l6.73" class="difflineplus">+		'invalid-input': 'Invalid input'</span>
<a href="#l6.74"></a><span id="l6.74" class="difflineplus">+	},</span>
<a href="#l6.75"></a><span id="l6.75" class="difflineplus">+</span>
<a href="#l6.76"></a><span id="l6.76" class="difflineplus">+	/** Convenience shortcuts */</span>
<a href="#l6.77"></a><span id="l6.77" class="difflineplus">+	baseMinusTMin = base - tMin,</span>
<a href="#l6.78"></a><span id="l6.78" class="difflineplus">+	floor = Math.floor,</span>
<a href="#l6.79"></a><span id="l6.79" class="difflineplus">+	stringFromCharCode = String.fromCharCode,</span>
<a href="#l6.80"></a><span id="l6.80" class="difflineplus">+</span>
<a href="#l6.81"></a><span id="l6.81" class="difflineplus">+	/** Temporary variable */</span>
<a href="#l6.82"></a><span id="l6.82" class="difflineplus">+	key;</span>
<a href="#l6.83"></a><span id="l6.83" class="difflineplus">+</span>
<a href="#l6.84"></a><span id="l6.84" class="difflineplus">+	/*--------------------------------------------------------------------------*/</span>
<a href="#l6.85"></a><span id="l6.85" class="difflineplus">+</span>
<a href="#l6.86"></a><span id="l6.86" class="difflineplus">+	/**</span>
<a href="#l6.87"></a><span id="l6.87" class="difflineplus">+	 * A generic error utility function.</span>
<a href="#l6.88"></a><span id="l6.88" class="difflineplus">+	 * @private</span>
<a href="#l6.89"></a><span id="l6.89" class="difflineplus">+	 * @param {String} type The error type.</span>
<a href="#l6.90"></a><span id="l6.90" class="difflineplus">+	 * @returns {Error} Throws a `RangeError` with the applicable error message.</span>
<a href="#l6.91"></a><span id="l6.91" class="difflineplus">+	 */</span>
<a href="#l6.92"></a><span id="l6.92" class="difflineplus">+	function error(type) {</span>
<a href="#l6.93"></a><span id="l6.93" class="difflineplus">+		throw RangeError(errors[type]);</span>
<a href="#l6.94"></a><span id="l6.94" class="difflineplus">+	}</span>
<a href="#l6.95"></a><span id="l6.95" class="difflineplus">+</span>
<a href="#l6.96"></a><span id="l6.96" class="difflineplus">+	/**</span>
<a href="#l6.97"></a><span id="l6.97" class="difflineplus">+	 * A generic `Array#map` utility function.</span>
<a href="#l6.98"></a><span id="l6.98" class="difflineplus">+	 * @private</span>
<a href="#l6.99"></a><span id="l6.99" class="difflineplus">+	 * @param {Array} array The array to iterate over.</span>
<a href="#l6.100"></a><span id="l6.100" class="difflineplus">+	 * @param {Function} callback The function that gets called for every array</span>
<a href="#l6.101"></a><span id="l6.101" class="difflineplus">+	 * item.</span>
<a href="#l6.102"></a><span id="l6.102" class="difflineplus">+	 * @returns {Array} A new array of values returned by the callback function.</span>
<a href="#l6.103"></a><span id="l6.103" class="difflineplus">+	 */</span>
<a href="#l6.104"></a><span id="l6.104" class="difflineplus">+	function map(array, fn) {</span>
<a href="#l6.105"></a><span id="l6.105" class="difflineplus">+		var length = array.length;</span>
<a href="#l6.106"></a><span id="l6.106" class="difflineplus">+		var result = [];</span>
<a href="#l6.107"></a><span id="l6.107" class="difflineplus">+		while (length--) {</span>
<a href="#l6.108"></a><span id="l6.108" class="difflineplus">+			result[length] = fn(array[length]);</span>
<a href="#l6.109"></a><span id="l6.109" class="difflineplus">+		}</span>
<a href="#l6.110"></a><span id="l6.110" class="difflineplus">+		return result;</span>
<a href="#l6.111"></a><span id="l6.111" class="difflineplus">+	}</span>
<a href="#l6.112"></a><span id="l6.112" class="difflineplus">+</span>
<a href="#l6.113"></a><span id="l6.113" class="difflineplus">+	/**</span>
<a href="#l6.114"></a><span id="l6.114" class="difflineplus">+	 * A simple `Array#map`-like wrapper to work with domain name strings or email</span>
<a href="#l6.115"></a><span id="l6.115" class="difflineplus">+	 * addresses.</span>
<a href="#l6.116"></a><span id="l6.116" class="difflineplus">+	 * @private</span>
<a href="#l6.117"></a><span id="l6.117" class="difflineplus">+	 * @param {String} domain The domain name or email address.</span>
<a href="#l6.118"></a><span id="l6.118" class="difflineplus">+	 * @param {Function} callback The function that gets called for every</span>
<a href="#l6.119"></a><span id="l6.119" class="difflineplus">+	 * character.</span>
<a href="#l6.120"></a><span id="l6.120" class="difflineplus">+	 * @returns {Array} A new string of characters returned by the callback</span>
<a href="#l6.121"></a><span id="l6.121" class="difflineplus">+	 * function.</span>
<a href="#l6.122"></a><span id="l6.122" class="difflineplus">+	 */</span>
<a href="#l6.123"></a><span id="l6.123" class="difflineplus">+	function mapDomain(string, fn) {</span>
<a href="#l6.124"></a><span id="l6.124" class="difflineplus">+		var parts = string.split('@');</span>
<a href="#l6.125"></a><span id="l6.125" class="difflineplus">+		var result = '';</span>
<a href="#l6.126"></a><span id="l6.126" class="difflineplus">+		if (parts.length &gt; 1) {</span>
<a href="#l6.127"></a><span id="l6.127" class="difflineplus">+			// In email addresses, only the domain name should be punycoded. Leave</span>
<a href="#l6.128"></a><span id="l6.128" class="difflineplus">+			// the local part (i.e. everything up to `@`) intact.</span>
<a href="#l6.129"></a><span id="l6.129" class="difflineplus">+			result = parts[0] + '@';</span>
<a href="#l6.130"></a><span id="l6.130" class="difflineplus">+			string = parts[1];</span>
<a href="#l6.131"></a><span id="l6.131" class="difflineplus">+		}</span>
<a href="#l6.132"></a><span id="l6.132" class="difflineplus">+		// Avoid `split(regex)` for IE8 compatibility. See #17.</span>
<a href="#l6.133"></a><span id="l6.133" class="difflineplus">+		string = string.replace(regexSeparators, '\x2E');</span>
<a href="#l6.134"></a><span id="l6.134" class="difflineplus">+		var labels = string.split('.');</span>
<a href="#l6.135"></a><span id="l6.135" class="difflineplus">+		var encoded = map(labels, fn).join('.');</span>
<a href="#l6.136"></a><span id="l6.136" class="difflineplus">+		return result + encoded;</span>
<a href="#l6.137"></a><span id="l6.137" class="difflineplus">+	}</span>
<a href="#l6.138"></a><span id="l6.138" class="difflineplus">+</span>
<a href="#l6.139"></a><span id="l6.139" class="difflineplus">+	/**</span>
<a href="#l6.140"></a><span id="l6.140" class="difflineplus">+	 * Creates an array containing the numeric code points of each Unicode</span>
<a href="#l6.141"></a><span id="l6.141" class="difflineplus">+	 * character in the string. While JavaScript uses UCS-2 internally,</span>
<a href="#l6.142"></a><span id="l6.142" class="difflineplus">+	 * this function will convert a pair of surrogate halves (each of which</span>
<a href="#l6.143"></a><span id="l6.143" class="difflineplus">+	 * UCS-2 exposes as separate characters) into a single code point,</span>
<a href="#l6.144"></a><span id="l6.144" class="difflineplus">+	 * matching UTF-16.</span>
<a href="#l6.145"></a><span id="l6.145" class="difflineplus">+	 * @see `punycode.ucs2.encode`</span>
<a href="#l6.146"></a><span id="l6.146" class="difflineplus">+	 * @see &lt;https://mathiasbynens.be/notes/javascript-encoding&gt;</span>
<a href="#l6.147"></a><span id="l6.147" class="difflineplus">+	 * @memberOf punycode.ucs2</span>
<a href="#l6.148"></a><span id="l6.148" class="difflineplus">+	 * @name decode</span>
<a href="#l6.149"></a><span id="l6.149" class="difflineplus">+	 * @param {String} string The Unicode input string (UCS-2).</span>
<a href="#l6.150"></a><span id="l6.150" class="difflineplus">+	 * @returns {Array} The new array of code points.</span>
<a href="#l6.151"></a><span id="l6.151" class="difflineplus">+	 */</span>
<a href="#l6.152"></a><span id="l6.152" class="difflineplus">+	function ucs2decode(string) {</span>
<a href="#l6.153"></a><span id="l6.153" class="difflineplus">+		var output = [],</span>
<a href="#l6.154"></a><span id="l6.154" class="difflineplus">+		    counter = 0,</span>
<a href="#l6.155"></a><span id="l6.155" class="difflineplus">+		    length = string.length,</span>
<a href="#l6.156"></a><span id="l6.156" class="difflineplus">+		    value,</span>
<a href="#l6.157"></a><span id="l6.157" class="difflineplus">+		    extra;</span>
<a href="#l6.158"></a><span id="l6.158" class="difflineplus">+		while (counter &lt; length) {</span>
<a href="#l6.159"></a><span id="l6.159" class="difflineplus">+			value = string.charCodeAt(counter++);</span>
<a href="#l6.160"></a><span id="l6.160" class="difflineplus">+			if (value &gt;= 0xD800 &amp;&amp; value &lt;= 0xDBFF &amp;&amp; counter &lt; length) {</span>
<a href="#l6.161"></a><span id="l6.161" class="difflineplus">+				// high surrogate, and there is a next character</span>
<a href="#l6.162"></a><span id="l6.162" class="difflineplus">+				extra = string.charCodeAt(counter++);</span>
<a href="#l6.163"></a><span id="l6.163" class="difflineplus">+				if ((extra &amp; 0xFC00) == 0xDC00) { // low surrogate</span>
<a href="#l6.164"></a><span id="l6.164" class="difflineplus">+					output.push(((value &amp; 0x3FF) &lt;&lt; 10) + (extra &amp; 0x3FF) + 0x10000);</span>
<a href="#l6.165"></a><span id="l6.165" class="difflineplus">+				} else {</span>
<a href="#l6.166"></a><span id="l6.166" class="difflineplus">+					// unmatched surrogate; only append this code unit, in case the next</span>
<a href="#l6.167"></a><span id="l6.167" class="difflineplus">+					// code unit is the high surrogate of a surrogate pair</span>
<a href="#l6.168"></a><span id="l6.168" class="difflineplus">+					output.push(value);</span>
<a href="#l6.169"></a><span id="l6.169" class="difflineplus">+					counter--;</span>
<a href="#l6.170"></a><span id="l6.170" class="difflineplus">+				}</span>
<a href="#l6.171"></a><span id="l6.171" class="difflineplus">+			} else {</span>
<a href="#l6.172"></a><span id="l6.172" class="difflineplus">+				output.push(value);</span>
<a href="#l6.173"></a><span id="l6.173" class="difflineplus">+			}</span>
<a href="#l6.174"></a><span id="l6.174" class="difflineplus">+		}</span>
<a href="#l6.175"></a><span id="l6.175" class="difflineplus">+		return output;</span>
<a href="#l6.176"></a><span id="l6.176" class="difflineplus">+	}</span>
<a href="#l6.177"></a><span id="l6.177" class="difflineplus">+</span>
<a href="#l6.178"></a><span id="l6.178" class="difflineplus">+	/**</span>
<a href="#l6.179"></a><span id="l6.179" class="difflineplus">+	 * Creates a string based on an array of numeric code points.</span>
<a href="#l6.180"></a><span id="l6.180" class="difflineplus">+	 * @see `punycode.ucs2.decode`</span>
<a href="#l6.181"></a><span id="l6.181" class="difflineplus">+	 * @memberOf punycode.ucs2</span>
<a href="#l6.182"></a><span id="l6.182" class="difflineplus">+	 * @name encode</span>
<a href="#l6.183"></a><span id="l6.183" class="difflineplus">+	 * @param {Array} codePoints The array of numeric code points.</span>
<a href="#l6.184"></a><span id="l6.184" class="difflineplus">+	 * @returns {String} The new Unicode string (UCS-2).</span>
<a href="#l6.185"></a><span id="l6.185" class="difflineplus">+	 */</span>
<a href="#l6.186"></a><span id="l6.186" class="difflineplus">+	function ucs2encode(array) {</span>
<a href="#l6.187"></a><span id="l6.187" class="difflineplus">+		return map(array, function(value) {</span>
<a href="#l6.188"></a><span id="l6.188" class="difflineplus">+			var output = '';</span>
<a href="#l6.189"></a><span id="l6.189" class="difflineplus">+			if (value &gt; 0xFFFF) {</span>
<a href="#l6.190"></a><span id="l6.190" class="difflineplus">+				value -= 0x10000;</span>
<a href="#l6.191"></a><span id="l6.191" class="difflineplus">+				output += stringFromCharCode(value &gt;&gt;&gt; 10 &amp; 0x3FF | 0xD800);</span>
<a href="#l6.192"></a><span id="l6.192" class="difflineplus">+				value = 0xDC00 | value &amp; 0x3FF;</span>
<a href="#l6.193"></a><span id="l6.193" class="difflineplus">+			}</span>
<a href="#l6.194"></a><span id="l6.194" class="difflineplus">+			output += stringFromCharCode(value);</span>
<a href="#l6.195"></a><span id="l6.195" class="difflineplus">+			return output;</span>
<a href="#l6.196"></a><span id="l6.196" class="difflineplus">+		}).join('');</span>
<a href="#l6.197"></a><span id="l6.197" class="difflineplus">+	}</span>
<a href="#l6.198"></a><span id="l6.198" class="difflineplus">+</span>
<a href="#l6.199"></a><span id="l6.199" class="difflineplus">+	/**</span>
<a href="#l6.200"></a><span id="l6.200" class="difflineplus">+	 * Converts a basic code point into a digit/integer.</span>
<a href="#l6.201"></a><span id="l6.201" class="difflineplus">+	 * @see `digitToBasic()`</span>
<a href="#l6.202"></a><span id="l6.202" class="difflineplus">+	 * @private</span>
<a href="#l6.203"></a><span id="l6.203" class="difflineplus">+	 * @param {Number} codePoint The basic numeric code point value.</span>
<a href="#l6.204"></a><span id="l6.204" class="difflineplus">+	 * @returns {Number} The numeric value of a basic code point (for use in</span>
<a href="#l6.205"></a><span id="l6.205" class="difflineplus">+	 * representing integers) in the range `0` to `base - 1`, or `base` if</span>
<a href="#l6.206"></a><span id="l6.206" class="difflineplus">+	 * the code point does not represent a value.</span>
<a href="#l6.207"></a><span id="l6.207" class="difflineplus">+	 */</span>
<a href="#l6.208"></a><span id="l6.208" class="difflineplus">+	function basicToDigit(codePoint) {</span>
<a href="#l6.209"></a><span id="l6.209" class="difflineplus">+		if (codePoint - 48 &lt; 10) {</span>
<a href="#l6.210"></a><span id="l6.210" class="difflineplus">+			return codePoint - 22;</span>
<a href="#l6.211"></a><span id="l6.211" class="difflineplus">+		}</span>
<a href="#l6.212"></a><span id="l6.212" class="difflineplus">+		if (codePoint - 65 &lt; 26) {</span>
<a href="#l6.213"></a><span id="l6.213" class="difflineplus">+			return codePoint - 65;</span>
<a href="#l6.214"></a><span id="l6.214" class="difflineplus">+		}</span>
<a href="#l6.215"></a><span id="l6.215" class="difflineplus">+		if (codePoint - 97 &lt; 26) {</span>
<a href="#l6.216"></a><span id="l6.216" class="difflineplus">+			return codePoint - 97;</span>
<a href="#l6.217"></a><span id="l6.217" class="difflineplus">+		}</span>
<a href="#l6.218"></a><span id="l6.218" class="difflineplus">+		return base;</span>
<a href="#l6.219"></a><span id="l6.219" class="difflineplus">+	}</span>
<a href="#l6.220"></a><span id="l6.220" class="difflineplus">+</span>
<a href="#l6.221"></a><span id="l6.221" class="difflineplus">+	/**</span>
<a href="#l6.222"></a><span id="l6.222" class="difflineplus">+	 * Converts a digit/integer into a basic code point.</span>
<a href="#l6.223"></a><span id="l6.223" class="difflineplus">+	 * @see `basicToDigit()`</span>
<a href="#l6.224"></a><span id="l6.224" class="difflineplus">+	 * @private</span>
<a href="#l6.225"></a><span id="l6.225" class="difflineplus">+	 * @param {Number} digit The numeric value of a basic code point.</span>
<a href="#l6.226"></a><span id="l6.226" class="difflineplus">+	 * @returns {Number} The basic code point whose value (when used for</span>
<a href="#l6.227"></a><span id="l6.227" class="difflineplus">+	 * representing integers) is `digit`, which needs to be in the range</span>
<a href="#l6.228"></a><span id="l6.228" class="difflineplus">+	 * `0` to `base - 1`. If `flag` is non-zero, the uppercase form is</span>
<a href="#l6.229"></a><span id="l6.229" class="difflineplus">+	 * used; else, the lowercase form is used. The behavior is undefined</span>
<a href="#l6.230"></a><span id="l6.230" class="difflineplus">+	 * if `flag` is non-zero and `digit` has no uppercase form.</span>
<a href="#l6.231"></a><span id="l6.231" class="difflineplus">+	 */</span>
<a href="#l6.232"></a><span id="l6.232" class="difflineplus">+	function digitToBasic(digit, flag) {</span>
<a href="#l6.233"></a><span id="l6.233" class="difflineplus">+		//  0..25 map to ASCII a..z or A..Z</span>
<a href="#l6.234"></a><span id="l6.234" class="difflineplus">+		// 26..35 map to ASCII 0..9</span>
<a href="#l6.235"></a><span id="l6.235" class="difflineplus">+		return digit + 22 + 75 * (digit &lt; 26) - ((flag != 0) &lt;&lt; 5);</span>
<a href="#l6.236"></a><span id="l6.236" class="difflineplus">+	}</span>
<a href="#l6.237"></a><span id="l6.237" class="difflineplus">+</span>
<a href="#l6.238"></a><span id="l6.238" class="difflineplus">+	/**</span>
<a href="#l6.239"></a><span id="l6.239" class="difflineplus">+	 * Bias adaptation function as per section 3.4 of RFC 3492.</span>
<a href="#l6.240"></a><span id="l6.240" class="difflineplus">+	 * http://tools.ietf.org/html/rfc3492#section-3.4</span>
<a href="#l6.241"></a><span id="l6.241" class="difflineplus">+	 * @private</span>
<a href="#l6.242"></a><span id="l6.242" class="difflineplus">+	 */</span>
<a href="#l6.243"></a><span id="l6.243" class="difflineplus">+	function adapt(delta, numPoints, firstTime) {</span>
<a href="#l6.244"></a><span id="l6.244" class="difflineplus">+		var k = 0;</span>
<a href="#l6.245"></a><span id="l6.245" class="difflineplus">+		delta = firstTime ? floor(delta / damp) : delta &gt;&gt; 1;</span>
<a href="#l6.246"></a><span id="l6.246" class="difflineplus">+		delta += floor(delta / numPoints);</span>
<a href="#l6.247"></a><span id="l6.247" class="difflineplus">+		for (/* no initialization */; delta &gt; baseMinusTMin * tMax &gt;&gt; 1; k += base) {</span>
<a href="#l6.248"></a><span id="l6.248" class="difflineplus">+			delta = floor(delta / baseMinusTMin);</span>
<a href="#l6.249"></a><span id="l6.249" class="difflineplus">+		}</span>
<a href="#l6.250"></a><span id="l6.250" class="difflineplus">+		return floor(k + (baseMinusTMin + 1) * delta / (delta + skew));</span>
<a href="#l6.251"></a><span id="l6.251" class="difflineplus">+	}</span>
<a href="#l6.252"></a><span id="l6.252" class="difflineplus">+</span>
<a href="#l6.253"></a><span id="l6.253" class="difflineplus">+	/**</span>
<a href="#l6.254"></a><span id="l6.254" class="difflineplus">+	 * Converts a Punycode string of ASCII-only symbols to a string of Unicode</span>
<a href="#l6.255"></a><span id="l6.255" class="difflineplus">+	 * symbols.</span>
<a href="#l6.256"></a><span id="l6.256" class="difflineplus">+	 * @memberOf punycode</span>
<a href="#l6.257"></a><span id="l6.257" class="difflineplus">+	 * @param {String} input The Punycode string of ASCII-only symbols.</span>
<a href="#l6.258"></a><span id="l6.258" class="difflineplus">+	 * @returns {String} The resulting string of Unicode symbols.</span>
<a href="#l6.259"></a><span id="l6.259" class="difflineplus">+	 */</span>
<a href="#l6.260"></a><span id="l6.260" class="difflineplus">+	function decode(input) {</span>
<a href="#l6.261"></a><span id="l6.261" class="difflineplus">+		// Don't use UCS-2</span>
<a href="#l6.262"></a><span id="l6.262" class="difflineplus">+		var output = [],</span>
<a href="#l6.263"></a><span id="l6.263" class="difflineplus">+		    inputLength = input.length,</span>
<a href="#l6.264"></a><span id="l6.264" class="difflineplus">+		    out,</span>
<a href="#l6.265"></a><span id="l6.265" class="difflineplus">+		    i = 0,</span>
<a href="#l6.266"></a><span id="l6.266" class="difflineplus">+		    n = initialN,</span>
<a href="#l6.267"></a><span id="l6.267" class="difflineplus">+		    bias = initialBias,</span>
<a href="#l6.268"></a><span id="l6.268" class="difflineplus">+		    basic,</span>
<a href="#l6.269"></a><span id="l6.269" class="difflineplus">+		    j,</span>
<a href="#l6.270"></a><span id="l6.270" class="difflineplus">+		    index,</span>
<a href="#l6.271"></a><span id="l6.271" class="difflineplus">+		    oldi,</span>
<a href="#l6.272"></a><span id="l6.272" class="difflineplus">+		    w,</span>
<a href="#l6.273"></a><span id="l6.273" class="difflineplus">+		    k,</span>
<a href="#l6.274"></a><span id="l6.274" class="difflineplus">+		    digit,</span>
<a href="#l6.275"></a><span id="l6.275" class="difflineplus">+		    t,</span>
<a href="#l6.276"></a><span id="l6.276" class="difflineplus">+		    /** Cached calculation results */</span>
<a href="#l6.277"></a><span id="l6.277" class="difflineplus">+		    baseMinusT;</span>
<a href="#l6.278"></a><span id="l6.278" class="difflineplus">+</span>
<a href="#l6.279"></a><span id="l6.279" class="difflineplus">+		// Handle the basic code points: let `basic` be the number of input code</span>
<a href="#l6.280"></a><span id="l6.280" class="difflineplus">+		// points before the last delimiter, or `0` if there is none, then copy</span>
<a href="#l6.281"></a><span id="l6.281" class="difflineplus">+		// the first basic code points to the output.</span>
<a href="#l6.282"></a><span id="l6.282" class="difflineplus">+</span>
<a href="#l6.283"></a><span id="l6.283" class="difflineplus">+		basic = input.lastIndexOf(delimiter);</span>
<a href="#l6.284"></a><span id="l6.284" class="difflineplus">+		if (basic &lt; 0) {</span>
<a href="#l6.285"></a><span id="l6.285" class="difflineplus">+			basic = 0;</span>
<a href="#l6.286"></a><span id="l6.286" class="difflineplus">+		}</span>
<a href="#l6.287"></a><span id="l6.287" class="difflineplus">+</span>
<a href="#l6.288"></a><span id="l6.288" class="difflineplus">+		for (j = 0; j &lt; basic; ++j) {</span>
<a href="#l6.289"></a><span id="l6.289" class="difflineplus">+			// if it's not a basic code point</span>
<a href="#l6.290"></a><span id="l6.290" class="difflineplus">+			if (input.charCodeAt(j) &gt;= 0x80) {</span>
<a href="#l6.291"></a><span id="l6.291" class="difflineplus">+				error('not-basic');</span>
<a href="#l6.292"></a><span id="l6.292" class="difflineplus">+			}</span>
<a href="#l6.293"></a><span id="l6.293" class="difflineplus">+			output.push(input.charCodeAt(j));</span>
<a href="#l6.294"></a><span id="l6.294" class="difflineplus">+		}</span>
<a href="#l6.295"></a><span id="l6.295" class="difflineplus">+</span>
<a href="#l6.296"></a><span id="l6.296" class="difflineplus">+		// Main decoding loop: start just after the last delimiter if any basic code</span>
<a href="#l6.297"></a><span id="l6.297" class="difflineplus">+		// points were copied; start at the beginning otherwise.</span>
<a href="#l6.298"></a><span id="l6.298" class="difflineplus">+</span>
<a href="#l6.299"></a><span id="l6.299" class="difflineplus">+		for (index = basic &gt; 0 ? basic + 1 : 0; index &lt; inputLength; /* no final expression */) {</span>
<a href="#l6.300"></a><span id="l6.300" class="difflineplus">+</span>
<a href="#l6.301"></a><span id="l6.301" class="difflineplus">+			// `index` is the index of the next character to be consumed.</span>
<a href="#l6.302"></a><span id="l6.302" class="difflineplus">+			// Decode a generalized variable-length integer into `delta`,</span>
<a href="#l6.303"></a><span id="l6.303" class="difflineplus">+			// which gets added to `i`. The overflow checking is easier</span>
<a href="#l6.304"></a><span id="l6.304" class="difflineplus">+			// if we increase `i` as we go, then subtract off its starting</span>
<a href="#l6.305"></a><span id="l6.305" class="difflineplus">+			// value at the end to obtain `delta`.</span>
<a href="#l6.306"></a><span id="l6.306" class="difflineplus">+			for (oldi = i, w = 1, k = base; /* no condition */; k += base) {</span>
<a href="#l6.307"></a><span id="l6.307" class="difflineplus">+</span>
<a href="#l6.308"></a><span id="l6.308" class="difflineplus">+				if (index &gt;= inputLength) {</span>
<a href="#l6.309"></a><span id="l6.309" class="difflineplus">+					error('invalid-input');</span>
<a href="#l6.310"></a><span id="l6.310" class="difflineplus">+				}</span>
<a href="#l6.311"></a><span id="l6.311" class="difflineplus">+</span>
<a href="#l6.312"></a><span id="l6.312" class="difflineplus">+				digit = basicToDigit(input.charCodeAt(index++));</span>
<a href="#l6.313"></a><span id="l6.313" class="difflineplus">+</span>
<a href="#l6.314"></a><span id="l6.314" class="difflineplus">+				if (digit &gt;= base || digit &gt; floor((maxInt - i) / w)) {</span>
<a href="#l6.315"></a><span id="l6.315" class="difflineplus">+					error('overflow');</span>
<a href="#l6.316"></a><span id="l6.316" class="difflineplus">+				}</span>
<a href="#l6.317"></a><span id="l6.317" class="difflineplus">+</span>
<a href="#l6.318"></a><span id="l6.318" class="difflineplus">+				i += digit * w;</span>
<a href="#l6.319"></a><span id="l6.319" class="difflineplus">+				t = k &lt;= bias ? tMin : (k &gt;= bias + tMax ? tMax : k - bias);</span>
<a href="#l6.320"></a><span id="l6.320" class="difflineplus">+</span>
<a href="#l6.321"></a><span id="l6.321" class="difflineplus">+				if (digit &lt; t) {</span>
<a href="#l6.322"></a><span id="l6.322" class="difflineplus">+					break;</span>
<a href="#l6.323"></a><span id="l6.323" class="difflineplus">+				}</span>
<a href="#l6.324"></a><span id="l6.324" class="difflineplus">+</span>
<a href="#l6.325"></a><span id="l6.325" class="difflineplus">+				baseMinusT = base - t;</span>
<a href="#l6.326"></a><span id="l6.326" class="difflineplus">+				if (w &gt; floor(maxInt / baseMinusT)) {</span>
<a href="#l6.327"></a><span id="l6.327" class="difflineplus">+					error('overflow');</span>
<a href="#l6.328"></a><span id="l6.328" class="difflineplus">+				}</span>
<a href="#l6.329"></a><span id="l6.329" class="difflineplus">+</span>
<a href="#l6.330"></a><span id="l6.330" class="difflineplus">+				w *= baseMinusT;</span>
<a href="#l6.331"></a><span id="l6.331" class="difflineplus">+</span>
<a href="#l6.332"></a><span id="l6.332" class="difflineplus">+			}</span>
<a href="#l6.333"></a><span id="l6.333" class="difflineplus">+</span>
<a href="#l6.334"></a><span id="l6.334" class="difflineplus">+			out = output.length + 1;</span>
<a href="#l6.335"></a><span id="l6.335" class="difflineplus">+			bias = adapt(i - oldi, out, oldi == 0);</span>
<a href="#l6.336"></a><span id="l6.336" class="difflineplus">+</span>
<a href="#l6.337"></a><span id="l6.337" class="difflineplus">+			// `i` was supposed to wrap around from `out` to `0`,</span>
<a href="#l6.338"></a><span id="l6.338" class="difflineplus">+			// incrementing `n` each time, so we'll fix that now:</span>
<a href="#l6.339"></a><span id="l6.339" class="difflineplus">+			if (floor(i / out) &gt; maxInt - n) {</span>
<a href="#l6.340"></a><span id="l6.340" class="difflineplus">+				error('overflow');</span>
<a href="#l6.341"></a><span id="l6.341" class="difflineplus">+			}</span>
<a href="#l6.342"></a><span id="l6.342" class="difflineplus">+</span>
<a href="#l6.343"></a><span id="l6.343" class="difflineplus">+			n += floor(i / out);</span>
<a href="#l6.344"></a><span id="l6.344" class="difflineplus">+			i %= out;</span>
<a href="#l6.345"></a><span id="l6.345" class="difflineplus">+</span>
<a href="#l6.346"></a><span id="l6.346" class="difflineplus">+			// Insert `n` at position `i` of the output</span>
<a href="#l6.347"></a><span id="l6.347" class="difflineplus">+			output.splice(i++, 0, n);</span>
<a href="#l6.348"></a><span id="l6.348" class="difflineplus">+</span>
<a href="#l6.349"></a><span id="l6.349" class="difflineplus">+		}</span>
<a href="#l6.350"></a><span id="l6.350" class="difflineplus">+</span>
<a href="#l6.351"></a><span id="l6.351" class="difflineplus">+		return ucs2encode(output);</span>
<a href="#l6.352"></a><span id="l6.352" class="difflineplus">+	}</span>
<a href="#l6.353"></a><span id="l6.353" class="difflineplus">+</span>
<a href="#l6.354"></a><span id="l6.354" class="difflineplus">+	/**</span>
<a href="#l6.355"></a><span id="l6.355" class="difflineplus">+	 * Converts a string of Unicode symbols (e.g. a domain name label) to a</span>
<a href="#l6.356"></a><span id="l6.356" class="difflineplus">+	 * Punycode string of ASCII-only symbols.</span>
<a href="#l6.357"></a><span id="l6.357" class="difflineplus">+	 * @memberOf punycode</span>
<a href="#l6.358"></a><span id="l6.358" class="difflineplus">+	 * @param {String} input The string of Unicode symbols.</span>
<a href="#l6.359"></a><span id="l6.359" class="difflineplus">+	 * @returns {String} The resulting Punycode string of ASCII-only symbols.</span>
<a href="#l6.360"></a><span id="l6.360" class="difflineplus">+	 */</span>
<a href="#l6.361"></a><span id="l6.361" class="difflineplus">+	function encode(input) {</span>
<a href="#l6.362"></a><span id="l6.362" class="difflineplus">+		var n,</span>
<a href="#l6.363"></a><span id="l6.363" class="difflineplus">+		    delta,</span>
<a href="#l6.364"></a><span id="l6.364" class="difflineplus">+		    handledCPCount,</span>
<a href="#l6.365"></a><span id="l6.365" class="difflineplus">+		    basicLength,</span>
<a href="#l6.366"></a><span id="l6.366" class="difflineplus">+		    bias,</span>
<a href="#l6.367"></a><span id="l6.367" class="difflineplus">+		    j,</span>
<a href="#l6.368"></a><span id="l6.368" class="difflineplus">+		    m,</span>
<a href="#l6.369"></a><span id="l6.369" class="difflineplus">+		    q,</span>
<a href="#l6.370"></a><span id="l6.370" class="difflineplus">+		    k,</span>
<a href="#l6.371"></a><span id="l6.371" class="difflineplus">+		    t,</span>
<a href="#l6.372"></a><span id="l6.372" class="difflineplus">+		    currentValue,</span>
<a href="#l6.373"></a><span id="l6.373" class="difflineplus">+		    output = [],</span>
<a href="#l6.374"></a><span id="l6.374" class="difflineplus">+		    /** `inputLength` will hold the number of code points in `input`. */</span>
<a href="#l6.375"></a><span id="l6.375" class="difflineplus">+		    inputLength,</span>
<a href="#l6.376"></a><span id="l6.376" class="difflineplus">+		    /** Cached calculation results */</span>
<a href="#l6.377"></a><span id="l6.377" class="difflineplus">+		    handledCPCountPlusOne,</span>
<a href="#l6.378"></a><span id="l6.378" class="difflineplus">+		    baseMinusT,</span>
<a href="#l6.379"></a><span id="l6.379" class="difflineplus">+		    qMinusT;</span>
<a href="#l6.380"></a><span id="l6.380" class="difflineplus">+</span>
<a href="#l6.381"></a><span id="l6.381" class="difflineplus">+		// Convert the input in UCS-2 to Unicode</span>
<a href="#l6.382"></a><span id="l6.382" class="difflineplus">+		input = ucs2decode(input);</span>
<a href="#l6.383"></a><span id="l6.383" class="difflineplus">+</span>
<a href="#l6.384"></a><span id="l6.384" class="difflineplus">+		// Cache the length</span>
<a href="#l6.385"></a><span id="l6.385" class="difflineplus">+		inputLength = input.length;</span>
<a href="#l6.386"></a><span id="l6.386" class="difflineplus">+</span>
<a href="#l6.387"></a><span id="l6.387" class="difflineplus">+		// Initialize the state</span>
<a href="#l6.388"></a><span id="l6.388" class="difflineplus">+		n = initialN;</span>
<a href="#l6.389"></a><span id="l6.389" class="difflineplus">+		delta = 0;</span>
<a href="#l6.390"></a><span id="l6.390" class="difflineplus">+		bias = initialBias;</span>
<a href="#l6.391"></a><span id="l6.391" class="difflineplus">+</span>
<a href="#l6.392"></a><span id="l6.392" class="difflineplus">+		// Handle the basic code points</span>
<a href="#l6.393"></a><span id="l6.393" class="difflineplus">+		for (j = 0; j &lt; inputLength; ++j) {</span>
<a href="#l6.394"></a><span id="l6.394" class="difflineplus">+			currentValue = input[j];</span>
<a href="#l6.395"></a><span id="l6.395" class="difflineplus">+			if (currentValue &lt; 0x80) {</span>
<a href="#l6.396"></a><span id="l6.396" class="difflineplus">+				output.push(stringFromCharCode(currentValue));</span>
<a href="#l6.397"></a><span id="l6.397" class="difflineplus">+			}</span>
<a href="#l6.398"></a><span id="l6.398" class="difflineplus">+		}</span>
<a href="#l6.399"></a><span id="l6.399" class="difflineplus">+</span>
<a href="#l6.400"></a><span id="l6.400" class="difflineplus">+		handledCPCount = basicLength = output.length;</span>
<a href="#l6.401"></a><span id="l6.401" class="difflineplus">+</span>
<a href="#l6.402"></a><span id="l6.402" class="difflineplus">+		// `handledCPCount` is the number of code points that have been handled;</span>
<a href="#l6.403"></a><span id="l6.403" class="difflineplus">+		// `basicLength` is the number of basic code points.</span>
<a href="#l6.404"></a><span id="l6.404" class="difflineplus">+</span>
<a href="#l6.405"></a><span id="l6.405" class="difflineplus">+		// Finish the basic string - if it is not empty - with a delimiter</span>
<a href="#l6.406"></a><span id="l6.406" class="difflineplus">+		if (basicLength) {</span>
<a href="#l6.407"></a><span id="l6.407" class="difflineplus">+			output.push(delimiter);</span>
<a href="#l6.408"></a><span id="l6.408" class="difflineplus">+		}</span>
<a href="#l6.409"></a><span id="l6.409" class="difflineplus">+</span>
<a href="#l6.410"></a><span id="l6.410" class="difflineplus">+		// Main encoding loop:</span>
<a href="#l6.411"></a><span id="l6.411" class="difflineplus">+		while (handledCPCount &lt; inputLength) {</span>
<a href="#l6.412"></a><span id="l6.412" class="difflineplus">+</span>
<a href="#l6.413"></a><span id="l6.413" class="difflineplus">+			// All non-basic code points &lt; n have been handled already. Find the next</span>
<a href="#l6.414"></a><span id="l6.414" class="difflineplus">+			// larger one:</span>
<a href="#l6.415"></a><span id="l6.415" class="difflineplus">+			for (m = maxInt, j = 0; j &lt; inputLength; ++j) {</span>
<a href="#l6.416"></a><span id="l6.416" class="difflineplus">+				currentValue = input[j];</span>
<a href="#l6.417"></a><span id="l6.417" class="difflineplus">+				if (currentValue &gt;= n &amp;&amp; currentValue &lt; m) {</span>
<a href="#l6.418"></a><span id="l6.418" class="difflineplus">+					m = currentValue;</span>
<a href="#l6.419"></a><span id="l6.419" class="difflineplus">+				}</span>
<a href="#l6.420"></a><span id="l6.420" class="difflineplus">+			}</span>
<a href="#l6.421"></a><span id="l6.421" class="difflineplus">+</span>
<a href="#l6.422"></a><span id="l6.422" class="difflineplus">+			// Increase `delta` enough to advance the decoder's &lt;n,i&gt; state to &lt;m,0&gt;,</span>
<a href="#l6.423"></a><span id="l6.423" class="difflineplus">+			// but guard against overflow</span>
<a href="#l6.424"></a><span id="l6.424" class="difflineplus">+			handledCPCountPlusOne = handledCPCount + 1;</span>
<a href="#l6.425"></a><span id="l6.425" class="difflineplus">+			if (m - n &gt; floor((maxInt - delta) / handledCPCountPlusOne)) {</span>
<a href="#l6.426"></a><span id="l6.426" class="difflineplus">+				error('overflow');</span>
<a href="#l6.427"></a><span id="l6.427" class="difflineplus">+			}</span>
<a href="#l6.428"></a><span id="l6.428" class="difflineplus">+</span>
<a href="#l6.429"></a><span id="l6.429" class="difflineplus">+			delta += (m - n) * handledCPCountPlusOne;</span>
<a href="#l6.430"></a><span id="l6.430" class="difflineplus">+			n = m;</span>
<a href="#l6.431"></a><span id="l6.431" class="difflineplus">+</span>
<a href="#l6.432"></a><span id="l6.432" class="difflineplus">+			for (j = 0; j &lt; inputLength; ++j) {</span>
<a href="#l6.433"></a><span id="l6.433" class="difflineplus">+				currentValue = input[j];</span>
<a href="#l6.434"></a><span id="l6.434" class="difflineplus">+</span>
<a href="#l6.435"></a><span id="l6.435" class="difflineplus">+				if (currentValue &lt; n &amp;&amp; ++delta &gt; maxInt) {</span>
<a href="#l6.436"></a><span id="l6.436" class="difflineplus">+					error('overflow');</span>
<a href="#l6.437"></a><span id="l6.437" class="difflineplus">+				}</span>
<a href="#l6.438"></a><span id="l6.438" class="difflineplus">+</span>
<a href="#l6.439"></a><span id="l6.439" class="difflineplus">+				if (currentValue == n) {</span>
<a href="#l6.440"></a><span id="l6.440" class="difflineplus">+					// Represent delta as a generalized variable-length integer</span>
<a href="#l6.441"></a><span id="l6.441" class="difflineplus">+					for (q = delta, k = base; /* no condition */; k += base) {</span>
<a href="#l6.442"></a><span id="l6.442" class="difflineplus">+						t = k &lt;= bias ? tMin : (k &gt;= bias + tMax ? tMax : k - bias);</span>
<a href="#l6.443"></a><span id="l6.443" class="difflineplus">+						if (q &lt; t) {</span>
<a href="#l6.444"></a><span id="l6.444" class="difflineplus">+							break;</span>
<a href="#l6.445"></a><span id="l6.445" class="difflineplus">+						}</span>
<a href="#l6.446"></a><span id="l6.446" class="difflineplus">+						qMinusT = q - t;</span>
<a href="#l6.447"></a><span id="l6.447" class="difflineplus">+						baseMinusT = base - t;</span>
<a href="#l6.448"></a><span id="l6.448" class="difflineplus">+						output.push(</span>
<a href="#l6.449"></a><span id="l6.449" class="difflineplus">+							stringFromCharCode(digitToBasic(t + qMinusT % baseMinusT, 0))</span>
<a href="#l6.450"></a><span id="l6.450" class="difflineplus">+						);</span>
<a href="#l6.451"></a><span id="l6.451" class="difflineplus">+						q = floor(qMinusT / baseMinusT);</span>
<a href="#l6.452"></a><span id="l6.452" class="difflineplus">+					}</span>
<a href="#l6.453"></a><span id="l6.453" class="difflineplus">+</span>
<a href="#l6.454"></a><span id="l6.454" class="difflineplus">+					output.push(stringFromCharCode(digitToBasic(q, 0)));</span>
<a href="#l6.455"></a><span id="l6.455" class="difflineplus">+					bias = adapt(delta, handledCPCountPlusOne, handledCPCount == basicLength);</span>
<a href="#l6.456"></a><span id="l6.456" class="difflineplus">+					delta = 0;</span>
<a href="#l6.457"></a><span id="l6.457" class="difflineplus">+					++handledCPCount;</span>
<a href="#l6.458"></a><span id="l6.458" class="difflineplus">+				}</span>
<a href="#l6.459"></a><span id="l6.459" class="difflineplus">+			}</span>
<a href="#l6.460"></a><span id="l6.460" class="difflineplus">+</span>
<a href="#l6.461"></a><span id="l6.461" class="difflineplus">+			++delta;</span>
<a href="#l6.462"></a><span id="l6.462" class="difflineplus">+			++n;</span>
<a href="#l6.463"></a><span id="l6.463" class="difflineplus">+</span>
<a href="#l6.464"></a><span id="l6.464" class="difflineplus">+		}</span>
<a href="#l6.465"></a><span id="l6.465" class="difflineplus">+		return output.join('');</span>
<a href="#l6.466"></a><span id="l6.466" class="difflineplus">+	}</span>
<a href="#l6.467"></a><span id="l6.467" class="difflineplus">+</span>
<a href="#l6.468"></a><span id="l6.468" class="difflineplus">+	/**</span>
<a href="#l6.469"></a><span id="l6.469" class="difflineplus">+	 * Converts a Punycode string representing a domain name or an email address</span>
<a href="#l6.470"></a><span id="l6.470" class="difflineplus">+	 * to Unicode. Only the Punycoded parts of the input will be converted, i.e.</span>
<a href="#l6.471"></a><span id="l6.471" class="difflineplus">+	 * it doesn't matter if you call it on a string that has already been</span>
<a href="#l6.472"></a><span id="l6.472" class="difflineplus">+	 * converted to Unicode.</span>
<a href="#l6.473"></a><span id="l6.473" class="difflineplus">+	 * @memberOf punycode</span>
<a href="#l6.474"></a><span id="l6.474" class="difflineplus">+	 * @param {String} input The Punycoded domain name or email address to</span>
<a href="#l6.475"></a><span id="l6.475" class="difflineplus">+	 * convert to Unicode.</span>
<a href="#l6.476"></a><span id="l6.476" class="difflineplus">+	 * @returns {String} The Unicode representation of the given Punycode</span>
<a href="#l6.477"></a><span id="l6.477" class="difflineplus">+	 * string.</span>
<a href="#l6.478"></a><span id="l6.478" class="difflineplus">+	 */</span>
<a href="#l6.479"></a><span id="l6.479" class="difflineplus">+	function toUnicode(input) {</span>
<a href="#l6.480"></a><span id="l6.480" class="difflineplus">+		return mapDomain(input, function(string) {</span>
<a href="#l6.481"></a><span id="l6.481" class="difflineplus">+			return regexPunycode.test(string)</span>
<a href="#l6.482"></a><span id="l6.482" class="difflineplus">+				? decode(string.slice(4).toLowerCase())</span>
<a href="#l6.483"></a><span id="l6.483" class="difflineplus">+				: string;</span>
<a href="#l6.484"></a><span id="l6.484" class="difflineplus">+		});</span>
<a href="#l6.485"></a><span id="l6.485" class="difflineplus">+	}</span>
<a href="#l6.486"></a><span id="l6.486" class="difflineplus">+</span>
<a href="#l6.487"></a><span id="l6.487" class="difflineplus">+	/**</span>
<a href="#l6.488"></a><span id="l6.488" class="difflineplus">+	 * Converts a Unicode string representing a domain name or an email address to</span>
<a href="#l6.489"></a><span id="l6.489" class="difflineplus">+	 * Punycode. Only the non-ASCII parts of the domain name will be converted,</span>
<a href="#l6.490"></a><span id="l6.490" class="difflineplus">+	 * i.e. it doesn't matter if you call it with a domain that's already in</span>
<a href="#l6.491"></a><span id="l6.491" class="difflineplus">+	 * ASCII.</span>
<a href="#l6.492"></a><span id="l6.492" class="difflineplus">+	 * @memberOf punycode</span>
<a href="#l6.493"></a><span id="l6.493" class="difflineplus">+	 * @param {String} input The domain name or email address to convert, as a</span>
<a href="#l6.494"></a><span id="l6.494" class="difflineplus">+	 * Unicode string.</span>
<a href="#l6.495"></a><span id="l6.495" class="difflineplus">+	 * @returns {String} The Punycode representation of the given domain name or</span>
<a href="#l6.496"></a><span id="l6.496" class="difflineplus">+	 * email address.</span>
<a href="#l6.497"></a><span id="l6.497" class="difflineplus">+	 */</span>
<a href="#l6.498"></a><span id="l6.498" class="difflineplus">+	function toASCII(input) {</span>
<a href="#l6.499"></a><span id="l6.499" class="difflineplus">+		return mapDomain(input, function(string) {</span>
<a href="#l6.500"></a><span id="l6.500" class="difflineplus">+			return regexNonASCII.test(string)</span>
<a href="#l6.501"></a><span id="l6.501" class="difflineplus">+				? 'xn--' + encode(string)</span>
<a href="#l6.502"></a><span id="l6.502" class="difflineplus">+				: string;</span>
<a href="#l6.503"></a><span id="l6.503" class="difflineplus">+		});</span>
<a href="#l6.504"></a><span id="l6.504" class="difflineplus">+	}</span>
<a href="#l6.505"></a><span id="l6.505" class="difflineplus">+</span>
<a href="#l6.506"></a><span id="l6.506" class="difflineplus">+	/*--------------------------------------------------------------------------*/</span>
<a href="#l6.507"></a><span id="l6.507" class="difflineplus">+</span>
<a href="#l6.508"></a><span id="l6.508" class="difflineplus">+	/** Define the public API */</span>
<a href="#l6.509"></a><span id="l6.509" class="difflineplus">+	punycode = {</span>
<a href="#l6.510"></a><span id="l6.510" class="difflineplus">+		/**</span>
<a href="#l6.511"></a><span id="l6.511" class="difflineplus">+		 * A string representing the current Punycode.js version number.</span>
<a href="#l6.512"></a><span id="l6.512" class="difflineplus">+		 * @memberOf punycode</span>
<a href="#l6.513"></a><span id="l6.513" class="difflineplus">+		 * @type String</span>
<a href="#l6.514"></a><span id="l6.514" class="difflineplus">+		 */</span>
<a href="#l6.515"></a><span id="l6.515" class="difflineplus">+		'version': '1.3.2',</span>
<a href="#l6.516"></a><span id="l6.516" class="difflineplus">+		/**</span>
<a href="#l6.517"></a><span id="l6.517" class="difflineplus">+		 * An object of methods to convert from JavaScript's internal character</span>
<a href="#l6.518"></a><span id="l6.518" class="difflineplus">+		 * representation (UCS-2) to Unicode code points, and back.</span>
<a href="#l6.519"></a><span id="l6.519" class="difflineplus">+		 * @see &lt;https://mathiasbynens.be/notes/javascript-encoding&gt;</span>
<a href="#l6.520"></a><span id="l6.520" class="difflineplus">+		 * @memberOf punycode</span>
<a href="#l6.521"></a><span id="l6.521" class="difflineplus">+		 * @type Object</span>
<a href="#l6.522"></a><span id="l6.522" class="difflineplus">+		 */</span>
<a href="#l6.523"></a><span id="l6.523" class="difflineplus">+		'ucs2': {</span>
<a href="#l6.524"></a><span id="l6.524" class="difflineplus">+			'decode': ucs2decode,</span>
<a href="#l6.525"></a><span id="l6.525" class="difflineplus">+			'encode': ucs2encode</span>
<a href="#l6.526"></a><span id="l6.526" class="difflineplus">+		},</span>
<a href="#l6.527"></a><span id="l6.527" class="difflineplus">+		'decode': decode,</span>
<a href="#l6.528"></a><span id="l6.528" class="difflineplus">+		'encode': encode,</span>
<a href="#l6.529"></a><span id="l6.529" class="difflineplus">+		'toASCII': toASCII,</span>
<a href="#l6.530"></a><span id="l6.530" class="difflineplus">+		'toUnicode': toUnicode</span>
<a href="#l6.531"></a><span id="l6.531" class="difflineplus">+	};</span>
<a href="#l6.532"></a><span id="l6.532" class="difflineplus">+</span>
<a href="#l6.533"></a><span id="l6.533" class="difflineplus">+	/** Expose `punycode` */</span>
<a href="#l6.534"></a><span id="l6.534" class="difflineplus">+	// Some AMD build optimizers, like r.js, check for specific condition patterns</span>
<a href="#l6.535"></a><span id="l6.535" class="difflineplus">+	// like the following:</span>
<a href="#l6.536"></a><span id="l6.536" class="difflineplus">+	if (</span>
<a href="#l6.537"></a><span id="l6.537" class="difflineplus">+		typeof define == 'function' &amp;&amp;</span>
<a href="#l6.538"></a><span id="l6.538" class="difflineplus">+		typeof define.amd == 'object' &amp;&amp;</span>
<a href="#l6.539"></a><span id="l6.539" class="difflineplus">+		define.amd</span>
<a href="#l6.540"></a><span id="l6.540" class="difflineplus">+	) {</span>
<a href="#l6.541"></a><span id="l6.541" class="difflineplus">+		define('punycode', function() {</span>
<a href="#l6.542"></a><span id="l6.542" class="difflineplus">+			return punycode;</span>
<a href="#l6.543"></a><span id="l6.543" class="difflineplus">+		});</span>
<a href="#l6.544"></a><span id="l6.544" class="difflineplus">+	} else if (freeExports &amp;&amp; freeModule) {</span>
<a href="#l6.545"></a><span id="l6.545" class="difflineplus">+		if (module.exports == freeExports) { // in Node.js or RingoJS v0.8.0+</span>
<a href="#l6.546"></a><span id="l6.546" class="difflineplus">+			freeModule.exports = punycode;</span>
<a href="#l6.547"></a><span id="l6.547" class="difflineplus">+		} else { // in Narwhal or RingoJS v0.7.0-</span>
<a href="#l6.548"></a><span id="l6.548" class="difflineplus">+			for (key in punycode) {</span>
<a href="#l6.549"></a><span id="l6.549" class="difflineplus">+				punycode.hasOwnProperty(key) &amp;&amp; (freeExports[key] = punycode[key]);</span>
<a href="#l6.550"></a><span id="l6.550" class="difflineplus">+			}</span>
<a href="#l6.551"></a><span id="l6.551" class="difflineplus">+		}</span>
<a href="#l6.552"></a><span id="l6.552" class="difflineplus">+	} else { // in Rhino or a web browser</span>
<a href="#l6.553"></a><span id="l6.553" class="difflineplus">+		root.punycode = punycode;</span>
<a href="#l6.554"></a><span id="l6.554" class="difflineplus">+	}</span>
<a href="#l6.555"></a><span id="l6.555" class="difflineplus">+</span>
<a href="#l6.556"></a><span id="l6.556" class="difflineplus">+}(this));</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1">new file mode 100644</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineminus">--- /dev/null</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineplus">+++ b/chat/protocols/matrix/matrix-sdk/browserify/querystring/decode.js</span>
<a href="#l7.4"></a><span id="l7.4" class="difflineat">@@ -0,0 +1,80 @@</span>
<a href="#l7.5"></a><span id="l7.5" class="difflineplus">+// Copyright Joyent, Inc. and other Node contributors.</span>
<a href="#l7.6"></a><span id="l7.6" class="difflineplus">+//</span>
<a href="#l7.7"></a><span id="l7.7" class="difflineplus">+// Permission is hereby granted, free of charge, to any person obtaining a</span>
<a href="#l7.8"></a><span id="l7.8" class="difflineplus">+// copy of this software and associated documentation files (the</span>
<a href="#l7.9"></a><span id="l7.9" class="difflineplus">+// &quot;Software&quot;), to deal in the Software without restriction, including</span>
<a href="#l7.10"></a><span id="l7.10" class="difflineplus">+// without limitation the rights to use, copy, modify, merge, publish,</span>
<a href="#l7.11"></a><span id="l7.11" class="difflineplus">+// distribute, sublicense, and/or sell copies of the Software, and to permit</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineplus">+// persons to whom the Software is furnished to do so, subject to the</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+// following conditions:</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+//</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+// The above copyright notice and this permission notice shall be included</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineplus">+// in all copies or substantial portions of the Software.</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineplus">+//</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineplus">+// THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineplus">+// OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineplus">+// MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineplus">+// NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineplus">+// DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineplus">+// OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineplus">+// USE OR OTHER DEALINGS IN THE SOFTWARE.</span>
<a href="#l7.25"></a><span id="l7.25" class="difflineplus">+</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineplus">+'use strict';</span>
<a href="#l7.27"></a><span id="l7.27" class="difflineplus">+</span>
<a href="#l7.28"></a><span id="l7.28" class="difflineplus">+// If obj.hasOwnProperty has been overridden, then calling</span>
<a href="#l7.29"></a><span id="l7.29" class="difflineplus">+// obj.hasOwnProperty(prop) will break.</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineplus">+// See: https://github.com/joyent/node/issues/1707</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineplus">+function hasOwnProperty(obj, prop) {</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineplus">+  return Object.prototype.hasOwnProperty.call(obj, prop);</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineplus">+}</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineplus">+</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineplus">+module.exports = function(qs, sep, eq, options) {</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineplus">+  sep = sep || '&amp;';</span>
<a href="#l7.37"></a><span id="l7.37" class="difflineplus">+  eq = eq || '=';</span>
<a href="#l7.38"></a><span id="l7.38" class="difflineplus">+  var obj = {};</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineplus">+</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineplus">+  if (typeof qs !== 'string' || qs.length === 0) {</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineplus">+    return obj;</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineplus">+  }</span>
<a href="#l7.43"></a><span id="l7.43" class="difflineplus">+</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineplus">+  var regexp = /\+/g;</span>
<a href="#l7.45"></a><span id="l7.45" class="difflineplus">+  qs = qs.split(sep);</span>
<a href="#l7.46"></a><span id="l7.46" class="difflineplus">+</span>
<a href="#l7.47"></a><span id="l7.47" class="difflineplus">+  var maxKeys = 1000;</span>
<a href="#l7.48"></a><span id="l7.48" class="difflineplus">+  if (options &amp;&amp; typeof options.maxKeys === 'number') {</span>
<a href="#l7.49"></a><span id="l7.49" class="difflineplus">+    maxKeys = options.maxKeys;</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineplus">+  }</span>
<a href="#l7.51"></a><span id="l7.51" class="difflineplus">+</span>
<a href="#l7.52"></a><span id="l7.52" class="difflineplus">+  var len = qs.length;</span>
<a href="#l7.53"></a><span id="l7.53" class="difflineplus">+  // maxKeys &lt;= 0 means that we should not limit keys count</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineplus">+  if (maxKeys &gt; 0 &amp;&amp; len &gt; maxKeys) {</span>
<a href="#l7.55"></a><span id="l7.55" class="difflineplus">+    len = maxKeys;</span>
<a href="#l7.56"></a><span id="l7.56" class="difflineplus">+  }</span>
<a href="#l7.57"></a><span id="l7.57" class="difflineplus">+</span>
<a href="#l7.58"></a><span id="l7.58" class="difflineplus">+  for (var i = 0; i &lt; len; ++i) {</span>
<a href="#l7.59"></a><span id="l7.59" class="difflineplus">+    var x = qs[i].replace(regexp, '%20'),</span>
<a href="#l7.60"></a><span id="l7.60" class="difflineplus">+        idx = x.indexOf(eq),</span>
<a href="#l7.61"></a><span id="l7.61" class="difflineplus">+        kstr, vstr, k, v;</span>
<a href="#l7.62"></a><span id="l7.62" class="difflineplus">+</span>
<a href="#l7.63"></a><span id="l7.63" class="difflineplus">+    if (idx &gt;= 0) {</span>
<a href="#l7.64"></a><span id="l7.64" class="difflineplus">+      kstr = x.substr(0, idx);</span>
<a href="#l7.65"></a><span id="l7.65" class="difflineplus">+      vstr = x.substr(idx + 1);</span>
<a href="#l7.66"></a><span id="l7.66" class="difflineplus">+    } else {</span>
<a href="#l7.67"></a><span id="l7.67" class="difflineplus">+      kstr = x;</span>
<a href="#l7.68"></a><span id="l7.68" class="difflineplus">+      vstr = '';</span>
<a href="#l7.69"></a><span id="l7.69" class="difflineplus">+    }</span>
<a href="#l7.70"></a><span id="l7.70" class="difflineplus">+</span>
<a href="#l7.71"></a><span id="l7.71" class="difflineplus">+    k = decodeURIComponent(kstr);</span>
<a href="#l7.72"></a><span id="l7.72" class="difflineplus">+    v = decodeURIComponent(vstr);</span>
<a href="#l7.73"></a><span id="l7.73" class="difflineplus">+</span>
<a href="#l7.74"></a><span id="l7.74" class="difflineplus">+    if (!hasOwnProperty(obj, k)) {</span>
<a href="#l7.75"></a><span id="l7.75" class="difflineplus">+      obj[k] = v;</span>
<a href="#l7.76"></a><span id="l7.76" class="difflineplus">+    } else if (Array.isArray(obj[k])) {</span>
<a href="#l7.77"></a><span id="l7.77" class="difflineplus">+      obj[k].push(v);</span>
<a href="#l7.78"></a><span id="l7.78" class="difflineplus">+    } else {</span>
<a href="#l7.79"></a><span id="l7.79" class="difflineplus">+      obj[k] = [obj[k], v];</span>
<a href="#l7.80"></a><span id="l7.80" class="difflineplus">+    }</span>
<a href="#l7.81"></a><span id="l7.81" class="difflineplus">+  }</span>
<a href="#l7.82"></a><span id="l7.82" class="difflineplus">+</span>
<a href="#l7.83"></a><span id="l7.83" class="difflineplus">+  return obj;</span>
<a href="#l7.84"></a><span id="l7.84" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1">new file mode 100644</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineminus">--- /dev/null</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineplus">+++ b/chat/protocols/matrix/matrix-sdk/browserify/querystring/encode.js</span>
<a href="#l8.4"></a><span id="l8.4" class="difflineat">@@ -0,0 +1,64 @@</span>
<a href="#l8.5"></a><span id="l8.5" class="difflineplus">+// Copyright Joyent, Inc. and other Node contributors.</span>
<a href="#l8.6"></a><span id="l8.6" class="difflineplus">+//</span>
<a href="#l8.7"></a><span id="l8.7" class="difflineplus">+// Permission is hereby granted, free of charge, to any person obtaining a</span>
<a href="#l8.8"></a><span id="l8.8" class="difflineplus">+// copy of this software and associated documentation files (the</span>
<a href="#l8.9"></a><span id="l8.9" class="difflineplus">+// &quot;Software&quot;), to deal in the Software without restriction, including</span>
<a href="#l8.10"></a><span id="l8.10" class="difflineplus">+// without limitation the rights to use, copy, modify, merge, publish,</span>
<a href="#l8.11"></a><span id="l8.11" class="difflineplus">+// distribute, sublicense, and/or sell copies of the Software, and to permit</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+// persons to whom the Software is furnished to do so, subject to the</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+// following conditions:</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineplus">+//</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineplus">+// The above copyright notice and this permission notice shall be included</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineplus">+// in all copies or substantial portions of the Software.</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineplus">+//</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineplus">+// THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS</span>
<a href="#l8.19"></a><span id="l8.19" class="difflineplus">+// OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF</span>
<a href="#l8.20"></a><span id="l8.20" class="difflineplus">+// MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineplus">+// NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineplus">+// DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR</span>
<a href="#l8.23"></a><span id="l8.23" class="difflineplus">+// OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE</span>
<a href="#l8.24"></a><span id="l8.24" class="difflineplus">+// USE OR OTHER DEALINGS IN THE SOFTWARE.</span>
<a href="#l8.25"></a><span id="l8.25" class="difflineplus">+</span>
<a href="#l8.26"></a><span id="l8.26" class="difflineplus">+'use strict';</span>
<a href="#l8.27"></a><span id="l8.27" class="difflineplus">+</span>
<a href="#l8.28"></a><span id="l8.28" class="difflineplus">+var stringifyPrimitive = function(v) {</span>
<a href="#l8.29"></a><span id="l8.29" class="difflineplus">+  switch (typeof v) {</span>
<a href="#l8.30"></a><span id="l8.30" class="difflineplus">+    case 'string':</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineplus">+      return v;</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineplus">+</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineplus">+    case 'boolean':</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineplus">+      return v ? 'true' : 'false';</span>
<a href="#l8.35"></a><span id="l8.35" class="difflineplus">+</span>
<a href="#l8.36"></a><span id="l8.36" class="difflineplus">+    case 'number':</span>
<a href="#l8.37"></a><span id="l8.37" class="difflineplus">+      return isFinite(v) ? v : '';</span>
<a href="#l8.38"></a><span id="l8.38" class="difflineplus">+</span>
<a href="#l8.39"></a><span id="l8.39" class="difflineplus">+    default:</span>
<a href="#l8.40"></a><span id="l8.40" class="difflineplus">+      return '';</span>
<a href="#l8.41"></a><span id="l8.41" class="difflineplus">+  }</span>
<a href="#l8.42"></a><span id="l8.42" class="difflineplus">+};</span>
<a href="#l8.43"></a><span id="l8.43" class="difflineplus">+</span>
<a href="#l8.44"></a><span id="l8.44" class="difflineplus">+module.exports = function(obj, sep, eq, name) {</span>
<a href="#l8.45"></a><span id="l8.45" class="difflineplus">+  sep = sep || '&amp;';</span>
<a href="#l8.46"></a><span id="l8.46" class="difflineplus">+  eq = eq || '=';</span>
<a href="#l8.47"></a><span id="l8.47" class="difflineplus">+  if (obj === null) {</span>
<a href="#l8.48"></a><span id="l8.48" class="difflineplus">+    obj = undefined;</span>
<a href="#l8.49"></a><span id="l8.49" class="difflineplus">+  }</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineplus">+</span>
<a href="#l8.51"></a><span id="l8.51" class="difflineplus">+  if (typeof obj === 'object') {</span>
<a href="#l8.52"></a><span id="l8.52" class="difflineplus">+    return Object.keys(obj).map(function(k) {</span>
<a href="#l8.53"></a><span id="l8.53" class="difflineplus">+      var ks = encodeURIComponent(stringifyPrimitive(k)) + eq;</span>
<a href="#l8.54"></a><span id="l8.54" class="difflineplus">+      if (Array.isArray(obj[k])) {</span>
<a href="#l8.55"></a><span id="l8.55" class="difflineplus">+        return obj[k].map(function(v) {</span>
<a href="#l8.56"></a><span id="l8.56" class="difflineplus">+          return ks + encodeURIComponent(stringifyPrimitive(v));</span>
<a href="#l8.57"></a><span id="l8.57" class="difflineplus">+        }).join(sep);</span>
<a href="#l8.58"></a><span id="l8.58" class="difflineplus">+      } else {</span>
<a href="#l8.59"></a><span id="l8.59" class="difflineplus">+        return ks + encodeURIComponent(stringifyPrimitive(obj[k]));</span>
<a href="#l8.60"></a><span id="l8.60" class="difflineplus">+      }</span>
<a href="#l8.61"></a><span id="l8.61" class="difflineplus">+    }).join(sep);</span>
<a href="#l8.62"></a><span id="l8.62" class="difflineplus">+</span>
<a href="#l8.63"></a><span id="l8.63" class="difflineplus">+  }</span>
<a href="#l8.64"></a><span id="l8.64" class="difflineplus">+</span>
<a href="#l8.65"></a><span id="l8.65" class="difflineplus">+  if (!name) return '';</span>
<a href="#l8.66"></a><span id="l8.66" class="difflineplus">+  return encodeURIComponent(stringifyPrimitive(name)) + eq +</span>
<a href="#l8.67"></a><span id="l8.67" class="difflineplus">+         encodeURIComponent(stringifyPrimitive(obj));</span>
<a href="#l8.68"></a><span id="l8.68" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1">new file mode 100644</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineminus">--- /dev/null</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineplus">+++ b/chat/protocols/matrix/matrix-sdk/browserify/querystring/index.js</span>
<a href="#l9.4"></a><span id="l9.4" class="difflineat">@@ -0,0 +1,24 @@</span>
<a href="#l9.5"></a><span id="l9.5" class="difflineplus">+/*</span>
<a href="#l9.6"></a><span id="l9.6" class="difflineplus">+Copyright 2012 Irakli Gozalishvili. All rights reserved.</span>
<a href="#l9.7"></a><span id="l9.7" class="difflineplus">+Permission is hereby granted, free of charge, to any person obtaining a copy</span>
<a href="#l9.8"></a><span id="l9.8" class="difflineplus">+of this software and associated documentation files (the &quot;Software&quot;), to</span>
<a href="#l9.9"></a><span id="l9.9" class="difflineplus">+deal in the Software without restriction, including without limitation the</span>
<a href="#l9.10"></a><span id="l9.10" class="difflineplus">+rights to use, copy, modify, merge, publish, distribute, sublicense, and/or</span>
<a href="#l9.11"></a><span id="l9.11" class="difflineplus">+sell copies of the Software, and to permit persons to whom the Software is</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineplus">+furnished to do so, subject to the following conditions:</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineplus">+The above copyright notice and this permission notice shall be included in</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineplus">+all copies or substantial portions of the Software.</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineplus">+</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineplus">+THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineplus">+IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span>
<a href="#l9.19"></a><span id="l9.19" class="difflineplus">+FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE</span>
<a href="#l9.20"></a><span id="l9.20" class="difflineplus">+AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineplus">+LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineplus">+FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS</span>
<a href="#l9.23"></a><span id="l9.23" class="difflineplus">+IN THE SOFTWARE.</span>
<a href="#l9.24"></a><span id="l9.24" class="difflineplus">+*/</span>
<a href="#l9.25"></a><span id="l9.25" class="difflineplus">+'use strict';</span>
<a href="#l9.26"></a><span id="l9.26" class="difflineplus">+</span>
<a href="#l9.27"></a><span id="l9.27" class="difflineplus">+exports.decode = exports.parse = require('./decode');</span>
<a href="#l9.28"></a><span id="l9.28" class="difflineplus">+exports.encode = exports.stringify = require('./encode');</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1">new file mode 100644</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineminus">--- /dev/null</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineplus">+++ b/chat/protocols/matrix/matrix-sdk/browserify/url.js</span>
<a href="#l10.4"></a><span id="l10.4" class="difflineat">@@ -0,0 +1,707 @@</span>
<a href="#l10.5"></a><span id="l10.5" class="difflineplus">+// Copyright Joyent, Inc. and other Node contributors.</span>
<a href="#l10.6"></a><span id="l10.6" class="difflineplus">+//</span>
<a href="#l10.7"></a><span id="l10.7" class="difflineplus">+// Permission is hereby granted, free of charge, to any person obtaining a</span>
<a href="#l10.8"></a><span id="l10.8" class="difflineplus">+// copy of this software and associated documentation files (the</span>
<a href="#l10.9"></a><span id="l10.9" class="difflineplus">+// &quot;Software&quot;), to deal in the Software without restriction, including</span>
<a href="#l10.10"></a><span id="l10.10" class="difflineplus">+// without limitation the rights to use, copy, modify, merge, publish,</span>
<a href="#l10.11"></a><span id="l10.11" class="difflineplus">+// distribute, sublicense, and/or sell copies of the Software, and to permit</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineplus">+// persons to whom the Software is furnished to do so, subject to the</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+// following conditions:</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineplus">+//</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineplus">+// The above copyright notice and this permission notice shall be included</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineplus">+// in all copies or substantial portions of the Software.</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineplus">+//</span>
<a href="#l10.18"></a><span id="l10.18" class="difflineplus">+// THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS</span>
<a href="#l10.19"></a><span id="l10.19" class="difflineplus">+// OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF</span>
<a href="#l10.20"></a><span id="l10.20" class="difflineplus">+// MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN</span>
<a href="#l10.21"></a><span id="l10.21" class="difflineplus">+// NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,</span>
<a href="#l10.22"></a><span id="l10.22" class="difflineplus">+// DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR</span>
<a href="#l10.23"></a><span id="l10.23" class="difflineplus">+// OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE</span>
<a href="#l10.24"></a><span id="l10.24" class="difflineplus">+// USE OR OTHER DEALINGS IN THE SOFTWARE.</span>
<a href="#l10.25"></a><span id="l10.25" class="difflineplus">+</span>
<a href="#l10.26"></a><span id="l10.26" class="difflineplus">+var punycode = require('punycode');</span>
<a href="#l10.27"></a><span id="l10.27" class="difflineplus">+</span>
<a href="#l10.28"></a><span id="l10.28" class="difflineplus">+exports.parse = urlParse;</span>
<a href="#l10.29"></a><span id="l10.29" class="difflineplus">+exports.resolve = urlResolve;</span>
<a href="#l10.30"></a><span id="l10.30" class="difflineplus">+exports.resolveObject = urlResolveObject;</span>
<a href="#l10.31"></a><span id="l10.31" class="difflineplus">+exports.format = urlFormat;</span>
<a href="#l10.32"></a><span id="l10.32" class="difflineplus">+</span>
<a href="#l10.33"></a><span id="l10.33" class="difflineplus">+exports.Url = Url;</span>
<a href="#l10.34"></a><span id="l10.34" class="difflineplus">+</span>
<a href="#l10.35"></a><span id="l10.35" class="difflineplus">+function Url() {</span>
<a href="#l10.36"></a><span id="l10.36" class="difflineplus">+  this.protocol = null;</span>
<a href="#l10.37"></a><span id="l10.37" class="difflineplus">+  this.slashes = null;</span>
<a href="#l10.38"></a><span id="l10.38" class="difflineplus">+  this.auth = null;</span>
<a href="#l10.39"></a><span id="l10.39" class="difflineplus">+  this.host = null;</span>
<a href="#l10.40"></a><span id="l10.40" class="difflineplus">+  this.port = null;</span>
<a href="#l10.41"></a><span id="l10.41" class="difflineplus">+  this.hostname = null;</span>
<a href="#l10.42"></a><span id="l10.42" class="difflineplus">+  this.hash = null;</span>
<a href="#l10.43"></a><span id="l10.43" class="difflineplus">+  this.search = null;</span>
<a href="#l10.44"></a><span id="l10.44" class="difflineplus">+  this.query = null;</span>
<a href="#l10.45"></a><span id="l10.45" class="difflineplus">+  this.pathname = null;</span>
<a href="#l10.46"></a><span id="l10.46" class="difflineplus">+  this.path = null;</span>
<a href="#l10.47"></a><span id="l10.47" class="difflineplus">+  this.href = null;</span>
<a href="#l10.48"></a><span id="l10.48" class="difflineplus">+}</span>
<a href="#l10.49"></a><span id="l10.49" class="difflineplus">+</span>
<a href="#l10.50"></a><span id="l10.50" class="difflineplus">+// Reference: RFC 3986, RFC 1808, RFC 2396</span>
<a href="#l10.51"></a><span id="l10.51" class="difflineplus">+</span>
<a href="#l10.52"></a><span id="l10.52" class="difflineplus">+// define these here so at least they only have to be</span>
<a href="#l10.53"></a><span id="l10.53" class="difflineplus">+// compiled once on the first module load.</span>
<a href="#l10.54"></a><span id="l10.54" class="difflineplus">+var protocolPattern = /^([a-z0-9.+-]+:)/i,</span>
<a href="#l10.55"></a><span id="l10.55" class="difflineplus">+    portPattern = /:[0-9]*$/,</span>
<a href="#l10.56"></a><span id="l10.56" class="difflineplus">+</span>
<a href="#l10.57"></a><span id="l10.57" class="difflineplus">+    // RFC 2396: characters reserved for delimiting URLs.</span>
<a href="#l10.58"></a><span id="l10.58" class="difflineplus">+    // We actually just auto-escape these.</span>
<a href="#l10.59"></a><span id="l10.59" class="difflineplus">+    delims = ['&lt;', '&gt;', '&quot;', '`', ' ', '\r', '\n', '\t'],</span>
<a href="#l10.60"></a><span id="l10.60" class="difflineplus">+</span>
<a href="#l10.61"></a><span id="l10.61" class="difflineplus">+    // RFC 2396: characters not allowed for various reasons.</span>
<a href="#l10.62"></a><span id="l10.62" class="difflineplus">+    unwise = ['{', '}', '|', '\\', '^', '`'].concat(delims),</span>
<a href="#l10.63"></a><span id="l10.63" class="difflineplus">+</span>
<a href="#l10.64"></a><span id="l10.64" class="difflineplus">+    // Allowed by RFCs, but cause of XSS attacks.  Always escape these.</span>
<a href="#l10.65"></a><span id="l10.65" class="difflineplus">+    autoEscape = ['\''].concat(unwise),</span>
<a href="#l10.66"></a><span id="l10.66" class="difflineplus">+    // Characters that are never ever allowed in a hostname.</span>
<a href="#l10.67"></a><span id="l10.67" class="difflineplus">+    // Note that any invalid chars are also handled, but these</span>
<a href="#l10.68"></a><span id="l10.68" class="difflineplus">+    // are the ones that are *expected* to be seen, so we fast-path</span>
<a href="#l10.69"></a><span id="l10.69" class="difflineplus">+    // them.</span>
<a href="#l10.70"></a><span id="l10.70" class="difflineplus">+    nonHostChars = ['%', '/', '?', ';', '#'].concat(autoEscape),</span>
<a href="#l10.71"></a><span id="l10.71" class="difflineplus">+    hostEndingChars = ['/', '?', '#'],</span>
<a href="#l10.72"></a><span id="l10.72" class="difflineplus">+    hostnameMaxLen = 255,</span>
<a href="#l10.73"></a><span id="l10.73" class="difflineplus">+    hostnamePartPattern = /^[a-z0-9A-Z_-]{0,63}$/,</span>
<a href="#l10.74"></a><span id="l10.74" class="difflineplus">+    hostnamePartStart = /^([a-z0-9A-Z_-]{0,63})(.*)$/,</span>
<a href="#l10.75"></a><span id="l10.75" class="difflineplus">+    // protocols that can allow &quot;unsafe&quot; and &quot;unwise&quot; chars.</span>
<a href="#l10.76"></a><span id="l10.76" class="difflineplus">+    unsafeProtocol = {</span>
<a href="#l10.77"></a><span id="l10.77" class="difflineplus">+      'javascript': true,</span>
<a href="#l10.78"></a><span id="l10.78" class="difflineplus">+      'javascript:': true</span>
<a href="#l10.79"></a><span id="l10.79" class="difflineplus">+    },</span>
<a href="#l10.80"></a><span id="l10.80" class="difflineplus">+    // protocols that never have a hostname.</span>
<a href="#l10.81"></a><span id="l10.81" class="difflineplus">+    hostlessProtocol = {</span>
<a href="#l10.82"></a><span id="l10.82" class="difflineplus">+      'javascript': true,</span>
<a href="#l10.83"></a><span id="l10.83" class="difflineplus">+      'javascript:': true</span>
<a href="#l10.84"></a><span id="l10.84" class="difflineplus">+    },</span>
<a href="#l10.85"></a><span id="l10.85" class="difflineplus">+    // protocols that always contain a // bit.</span>
<a href="#l10.86"></a><span id="l10.86" class="difflineplus">+    slashedProtocol = {</span>
<a href="#l10.87"></a><span id="l10.87" class="difflineplus">+      'http': true,</span>
<a href="#l10.88"></a><span id="l10.88" class="difflineplus">+      'https': true,</span>
<a href="#l10.89"></a><span id="l10.89" class="difflineplus">+      'ftp': true,</span>
<a href="#l10.90"></a><span id="l10.90" class="difflineplus">+      'gopher': true,</span>
<a href="#l10.91"></a><span id="l10.91" class="difflineplus">+      'file': true,</span>
<a href="#l10.92"></a><span id="l10.92" class="difflineplus">+      'http:': true,</span>
<a href="#l10.93"></a><span id="l10.93" class="difflineplus">+      'https:': true,</span>
<a href="#l10.94"></a><span id="l10.94" class="difflineplus">+      'ftp:': true,</span>
<a href="#l10.95"></a><span id="l10.95" class="difflineplus">+      'gopher:': true,</span>
<a href="#l10.96"></a><span id="l10.96" class="difflineplus">+      'file:': true</span>
<a href="#l10.97"></a><span id="l10.97" class="difflineplus">+    },</span>
<a href="#l10.98"></a><span id="l10.98" class="difflineplus">+    querystring = require('querystring');</span>
<a href="#l10.99"></a><span id="l10.99" class="difflineplus">+</span>
<a href="#l10.100"></a><span id="l10.100" class="difflineplus">+function urlParse(url, parseQueryString, slashesDenoteHost) {</span>
<a href="#l10.101"></a><span id="l10.101" class="difflineplus">+  if (url &amp;&amp; isObject(url) &amp;&amp; url instanceof Url) return url;</span>
<a href="#l10.102"></a><span id="l10.102" class="difflineplus">+</span>
<a href="#l10.103"></a><span id="l10.103" class="difflineplus">+  var u = new Url;</span>
<a href="#l10.104"></a><span id="l10.104" class="difflineplus">+  u.parse(url, parseQueryString, slashesDenoteHost);</span>
<a href="#l10.105"></a><span id="l10.105" class="difflineplus">+  return u;</span>
<a href="#l10.106"></a><span id="l10.106" class="difflineplus">+}</span>
<a href="#l10.107"></a><span id="l10.107" class="difflineplus">+</span>
<a href="#l10.108"></a><span id="l10.108" class="difflineplus">+Url.prototype.parse = function(url, parseQueryString, slashesDenoteHost) {</span>
<a href="#l10.109"></a><span id="l10.109" class="difflineplus">+  if (!isString(url)) {</span>
<a href="#l10.110"></a><span id="l10.110" class="difflineplus">+    throw new TypeError(&quot;Parameter 'url' must be a string, not &quot; + typeof url);</span>
<a href="#l10.111"></a><span id="l10.111" class="difflineplus">+  }</span>
<a href="#l10.112"></a><span id="l10.112" class="difflineplus">+</span>
<a href="#l10.113"></a><span id="l10.113" class="difflineplus">+  var rest = url;</span>
<a href="#l10.114"></a><span id="l10.114" class="difflineplus">+</span>
<a href="#l10.115"></a><span id="l10.115" class="difflineplus">+  // trim before proceeding.</span>
<a href="#l10.116"></a><span id="l10.116" class="difflineplus">+  // This is to support parse stuff like &quot;  http://foo.com  \n&quot;</span>
<a href="#l10.117"></a><span id="l10.117" class="difflineplus">+  rest = rest.trim();</span>
<a href="#l10.118"></a><span id="l10.118" class="difflineplus">+</span>
<a href="#l10.119"></a><span id="l10.119" class="difflineplus">+  var proto = protocolPattern.exec(rest);</span>
<a href="#l10.120"></a><span id="l10.120" class="difflineplus">+  if (proto) {</span>
<a href="#l10.121"></a><span id="l10.121" class="difflineplus">+    proto = proto[0];</span>
<a href="#l10.122"></a><span id="l10.122" class="difflineplus">+    var lowerProto = proto.toLowerCase();</span>
<a href="#l10.123"></a><span id="l10.123" class="difflineplus">+    this.protocol = lowerProto;</span>
<a href="#l10.124"></a><span id="l10.124" class="difflineplus">+    rest = rest.substr(proto.length);</span>
<a href="#l10.125"></a><span id="l10.125" class="difflineplus">+  }</span>
<a href="#l10.126"></a><span id="l10.126" class="difflineplus">+</span>
<a href="#l10.127"></a><span id="l10.127" class="difflineplus">+  // figure out if it's got a host</span>
<a href="#l10.128"></a><span id="l10.128" class="difflineplus">+  // user@server is *always* interpreted as a hostname, and url</span>
<a href="#l10.129"></a><span id="l10.129" class="difflineplus">+  // resolution will treat //foo/bar as host=foo,path=bar because that's</span>
<a href="#l10.130"></a><span id="l10.130" class="difflineplus">+  // how the browser resolves relative URLs.</span>
<a href="#l10.131"></a><span id="l10.131" class="difflineplus">+  if (slashesDenoteHost || proto || rest.match(/^\/\/[^@\/]+@[^@\/]+/)) {</span>
<a href="#l10.132"></a><span id="l10.132" class="difflineplus">+    var slashes = rest.substr(0, 2) === '//';</span>
<a href="#l10.133"></a><span id="l10.133" class="difflineplus">+    if (slashes &amp;&amp; !(proto &amp;&amp; hostlessProtocol[proto])) {</span>
<a href="#l10.134"></a><span id="l10.134" class="difflineplus">+      rest = rest.substr(2);</span>
<a href="#l10.135"></a><span id="l10.135" class="difflineplus">+      this.slashes = true;</span>
<a href="#l10.136"></a><span id="l10.136" class="difflineplus">+    }</span>
<a href="#l10.137"></a><span id="l10.137" class="difflineplus">+  }</span>
<a href="#l10.138"></a><span id="l10.138" class="difflineplus">+</span>
<a href="#l10.139"></a><span id="l10.139" class="difflineplus">+  if (!hostlessProtocol[proto] &amp;&amp;</span>
<a href="#l10.140"></a><span id="l10.140" class="difflineplus">+      (slashes || (proto &amp;&amp; !slashedProtocol[proto]))) {</span>
<a href="#l10.141"></a><span id="l10.141" class="difflineplus">+</span>
<a href="#l10.142"></a><span id="l10.142" class="difflineplus">+    // there's a hostname.</span>
<a href="#l10.143"></a><span id="l10.143" class="difflineplus">+    // the first instance of /, ?, ;, or # ends the host.</span>
<a href="#l10.144"></a><span id="l10.144" class="difflineplus">+    //</span>
<a href="#l10.145"></a><span id="l10.145" class="difflineplus">+    // If there is an @ in the hostname, then non-host chars *are* allowed</span>
<a href="#l10.146"></a><span id="l10.146" class="difflineplus">+    // to the left of the last @ sign, unless some host-ending character</span>
<a href="#l10.147"></a><span id="l10.147" class="difflineplus">+    // comes *before* the @-sign.</span>
<a href="#l10.148"></a><span id="l10.148" class="difflineplus">+    // URLs are obnoxious.</span>
<a href="#l10.149"></a><span id="l10.149" class="difflineplus">+    //</span>
<a href="#l10.150"></a><span id="l10.150" class="difflineplus">+    // ex:</span>
<a href="#l10.151"></a><span id="l10.151" class="difflineplus">+    // http://a@b@c/ =&gt; user:a@b host:c</span>
<a href="#l10.152"></a><span id="l10.152" class="difflineplus">+    // http://a@b?@c =&gt; user:a host:c path:/?@c</span>
<a href="#l10.153"></a><span id="l10.153" class="difflineplus">+</span>
<a href="#l10.154"></a><span id="l10.154" class="difflineplus">+    // v0.12 TODO(isaacs): This is not quite how Chrome does things.</span>
<a href="#l10.155"></a><span id="l10.155" class="difflineplus">+    // Review our test case against browsers more comprehensively.</span>
<a href="#l10.156"></a><span id="l10.156" class="difflineplus">+</span>
<a href="#l10.157"></a><span id="l10.157" class="difflineplus">+    // find the first instance of any hostEndingChars</span>
<a href="#l10.158"></a><span id="l10.158" class="difflineplus">+    var hostEnd = -1;</span>
<a href="#l10.159"></a><span id="l10.159" class="difflineplus">+    for (var i = 0; i &lt; hostEndingChars.length; i++) {</span>
<a href="#l10.160"></a><span id="l10.160" class="difflineplus">+      var hec = rest.indexOf(hostEndingChars[i]);</span>
<a href="#l10.161"></a><span id="l10.161" class="difflineplus">+      if (hec !== -1 &amp;&amp; (hostEnd === -1 || hec &lt; hostEnd))</span>
<a href="#l10.162"></a><span id="l10.162" class="difflineplus">+        hostEnd = hec;</span>
<a href="#l10.163"></a><span id="l10.163" class="difflineplus">+    }</span>
<a href="#l10.164"></a><span id="l10.164" class="difflineplus">+</span>
<a href="#l10.165"></a><span id="l10.165" class="difflineplus">+    // at this point, either we have an explicit point where the</span>
<a href="#l10.166"></a><span id="l10.166" class="difflineplus">+    // auth portion cannot go past, or the last @ char is the decider.</span>
<a href="#l10.167"></a><span id="l10.167" class="difflineplus">+    var auth, atSign;</span>
<a href="#l10.168"></a><span id="l10.168" class="difflineplus">+    if (hostEnd === -1) {</span>
<a href="#l10.169"></a><span id="l10.169" class="difflineplus">+      // atSign can be anywhere.</span>
<a href="#l10.170"></a><span id="l10.170" class="difflineplus">+      atSign = rest.lastIndexOf('@');</span>
<a href="#l10.171"></a><span id="l10.171" class="difflineplus">+    } else {</span>
<a href="#l10.172"></a><span id="l10.172" class="difflineplus">+      // atSign must be in auth portion.</span>
<a href="#l10.173"></a><span id="l10.173" class="difflineplus">+      // http://a@b/c@d =&gt; host:b auth:a path:/c@d</span>
<a href="#l10.174"></a><span id="l10.174" class="difflineplus">+      atSign = rest.lastIndexOf('@', hostEnd);</span>
<a href="#l10.175"></a><span id="l10.175" class="difflineplus">+    }</span>
<a href="#l10.176"></a><span id="l10.176" class="difflineplus">+</span>
<a href="#l10.177"></a><span id="l10.177" class="difflineplus">+    // Now we have a portion which is definitely the auth.</span>
<a href="#l10.178"></a><span id="l10.178" class="difflineplus">+    // Pull that off.</span>
<a href="#l10.179"></a><span id="l10.179" class="difflineplus">+    if (atSign !== -1) {</span>
<a href="#l10.180"></a><span id="l10.180" class="difflineplus">+      auth = rest.slice(0, atSign);</span>
<a href="#l10.181"></a><span id="l10.181" class="difflineplus">+      rest = rest.slice(atSign + 1);</span>
<a href="#l10.182"></a><span id="l10.182" class="difflineplus">+      this.auth = decodeURIComponent(auth);</span>
<a href="#l10.183"></a><span id="l10.183" class="difflineplus">+    }</span>
<a href="#l10.184"></a><span id="l10.184" class="difflineplus">+</span>
<a href="#l10.185"></a><span id="l10.185" class="difflineplus">+    // the host is the remaining to the left of the first non-host char</span>
<a href="#l10.186"></a><span id="l10.186" class="difflineplus">+    hostEnd = -1;</span>
<a href="#l10.187"></a><span id="l10.187" class="difflineplus">+    for (var i = 0; i &lt; nonHostChars.length; i++) {</span>
<a href="#l10.188"></a><span id="l10.188" class="difflineplus">+      var hec = rest.indexOf(nonHostChars[i]);</span>
<a href="#l10.189"></a><span id="l10.189" class="difflineplus">+      if (hec !== -1 &amp;&amp; (hostEnd === -1 || hec &lt; hostEnd))</span>
<a href="#l10.190"></a><span id="l10.190" class="difflineplus">+        hostEnd = hec;</span>
<a href="#l10.191"></a><span id="l10.191" class="difflineplus">+    }</span>
<a href="#l10.192"></a><span id="l10.192" class="difflineplus">+    // if we still have not hit it, then the entire thing is a host.</span>
<a href="#l10.193"></a><span id="l10.193" class="difflineplus">+    if (hostEnd === -1)</span>
<a href="#l10.194"></a><span id="l10.194" class="difflineplus">+      hostEnd = rest.length;</span>
<a href="#l10.195"></a><span id="l10.195" class="difflineplus">+</span>
<a href="#l10.196"></a><span id="l10.196" class="difflineplus">+    this.host = rest.slice(0, hostEnd);</span>
<a href="#l10.197"></a><span id="l10.197" class="difflineplus">+    rest = rest.slice(hostEnd);</span>
<a href="#l10.198"></a><span id="l10.198" class="difflineplus">+</span>
<a href="#l10.199"></a><span id="l10.199" class="difflineplus">+    // pull out port.</span>
<a href="#l10.200"></a><span id="l10.200" class="difflineplus">+    this.parseHost();</span>
<a href="#l10.201"></a><span id="l10.201" class="difflineplus">+</span>
<a href="#l10.202"></a><span id="l10.202" class="difflineplus">+    // we've indicated that there is a hostname,</span>
<a href="#l10.203"></a><span id="l10.203" class="difflineplus">+    // so even if it's empty, it has to be present.</span>
<a href="#l10.204"></a><span id="l10.204" class="difflineplus">+    this.hostname = this.hostname || '';</span>
<a href="#l10.205"></a><span id="l10.205" class="difflineplus">+</span>
<a href="#l10.206"></a><span id="l10.206" class="difflineplus">+    // if hostname begins with [ and ends with ]</span>
<a href="#l10.207"></a><span id="l10.207" class="difflineplus">+    // assume that it's an IPv6 address.</span>
<a href="#l10.208"></a><span id="l10.208" class="difflineplus">+    var ipv6Hostname = this.hostname[0] === '[' &amp;&amp;</span>
<a href="#l10.209"></a><span id="l10.209" class="difflineplus">+        this.hostname[this.hostname.length - 1] === ']';</span>
<a href="#l10.210"></a><span id="l10.210" class="difflineplus">+</span>
<a href="#l10.211"></a><span id="l10.211" class="difflineplus">+    // validate a little.</span>
<a href="#l10.212"></a><span id="l10.212" class="difflineplus">+    if (!ipv6Hostname) {</span>
<a href="#l10.213"></a><span id="l10.213" class="difflineplus">+      var hostparts = this.hostname.split(/\./);</span>
<a href="#l10.214"></a><span id="l10.214" class="difflineplus">+      for (var i = 0, l = hostparts.length; i &lt; l; i++) {</span>
<a href="#l10.215"></a><span id="l10.215" class="difflineplus">+        var part = hostparts[i];</span>
<a href="#l10.216"></a><span id="l10.216" class="difflineplus">+        if (!part) continue;</span>
<a href="#l10.217"></a><span id="l10.217" class="difflineplus">+        if (!part.match(hostnamePartPattern)) {</span>
<a href="#l10.218"></a><span id="l10.218" class="difflineplus">+          var newpart = '';</span>
<a href="#l10.219"></a><span id="l10.219" class="difflineplus">+          for (var j = 0, k = part.length; j &lt; k; j++) {</span>
<a href="#l10.220"></a><span id="l10.220" class="difflineplus">+            if (part.charCodeAt(j) &gt; 127) {</span>
<a href="#l10.221"></a><span id="l10.221" class="difflineplus">+              // we replace non-ASCII char with a temporary placeholder</span>
<a href="#l10.222"></a><span id="l10.222" class="difflineplus">+              // we need this to make sure size of hostname is not</span>
<a href="#l10.223"></a><span id="l10.223" class="difflineplus">+              // broken by replacing non-ASCII by nothing</span>
<a href="#l10.224"></a><span id="l10.224" class="difflineplus">+              newpart += 'x';</span>
<a href="#l10.225"></a><span id="l10.225" class="difflineplus">+            } else {</span>
<a href="#l10.226"></a><span id="l10.226" class="difflineplus">+              newpart += part[j];</span>
<a href="#l10.227"></a><span id="l10.227" class="difflineplus">+            }</span>
<a href="#l10.228"></a><span id="l10.228" class="difflineplus">+          }</span>
<a href="#l10.229"></a><span id="l10.229" class="difflineplus">+          // we test again with ASCII char only</span>
<a href="#l10.230"></a><span id="l10.230" class="difflineplus">+          if (!newpart.match(hostnamePartPattern)) {</span>
<a href="#l10.231"></a><span id="l10.231" class="difflineplus">+            var validParts = hostparts.slice(0, i);</span>
<a href="#l10.232"></a><span id="l10.232" class="difflineplus">+            var notHost = hostparts.slice(i + 1);</span>
<a href="#l10.233"></a><span id="l10.233" class="difflineplus">+            var bit = part.match(hostnamePartStart);</span>
<a href="#l10.234"></a><span id="l10.234" class="difflineplus">+            if (bit) {</span>
<a href="#l10.235"></a><span id="l10.235" class="difflineplus">+              validParts.push(bit[1]);</span>
<a href="#l10.236"></a><span id="l10.236" class="difflineplus">+              notHost.unshift(bit[2]);</span>
<a href="#l10.237"></a><span id="l10.237" class="difflineplus">+            }</span>
<a href="#l10.238"></a><span id="l10.238" class="difflineplus">+            if (notHost.length) {</span>
<a href="#l10.239"></a><span id="l10.239" class="difflineplus">+              rest = '/' + notHost.join('.') + rest;</span>
<a href="#l10.240"></a><span id="l10.240" class="difflineplus">+            }</span>
<a href="#l10.241"></a><span id="l10.241" class="difflineplus">+            this.hostname = validParts.join('.');</span>
<a href="#l10.242"></a><span id="l10.242" class="difflineplus">+            break;</span>
<a href="#l10.243"></a><span id="l10.243" class="difflineplus">+          }</span>
<a href="#l10.244"></a><span id="l10.244" class="difflineplus">+        }</span>
<a href="#l10.245"></a><span id="l10.245" class="difflineplus">+      }</span>
<a href="#l10.246"></a><span id="l10.246" class="difflineplus">+    }</span>
<a href="#l10.247"></a><span id="l10.247" class="difflineplus">+</span>
<a href="#l10.248"></a><span id="l10.248" class="difflineplus">+    if (this.hostname.length &gt; hostnameMaxLen) {</span>
<a href="#l10.249"></a><span id="l10.249" class="difflineplus">+      this.hostname = '';</span>
<a href="#l10.250"></a><span id="l10.250" class="difflineplus">+    } else {</span>
<a href="#l10.251"></a><span id="l10.251" class="difflineplus">+      // hostnames are always lower case.</span>
<a href="#l10.252"></a><span id="l10.252" class="difflineplus">+      this.hostname = this.hostname.toLowerCase();</span>
<a href="#l10.253"></a><span id="l10.253" class="difflineplus">+    }</span>
<a href="#l10.254"></a><span id="l10.254" class="difflineplus">+</span>
<a href="#l10.255"></a><span id="l10.255" class="difflineplus">+    if (!ipv6Hostname) {</span>
<a href="#l10.256"></a><span id="l10.256" class="difflineplus">+      // IDNA Support: Returns a puny coded representation of &quot;domain&quot;.</span>
<a href="#l10.257"></a><span id="l10.257" class="difflineplus">+      // It only converts the part of the domain name that</span>
<a href="#l10.258"></a><span id="l10.258" class="difflineplus">+      // has non ASCII characters. I.e. it dosent matter if</span>
<a href="#l10.259"></a><span id="l10.259" class="difflineplus">+      // you call it with a domain that already is in ASCII.</span>
<a href="#l10.260"></a><span id="l10.260" class="difflineplus">+      var domainArray = this.hostname.split('.');</span>
<a href="#l10.261"></a><span id="l10.261" class="difflineplus">+      var newOut = [];</span>
<a href="#l10.262"></a><span id="l10.262" class="difflineplus">+      for (var i = 0; i &lt; domainArray.length; ++i) {</span>
<a href="#l10.263"></a><span id="l10.263" class="difflineplus">+        var s = domainArray[i];</span>
<a href="#l10.264"></a><span id="l10.264" class="difflineplus">+        newOut.push(s.match(/[^A-Za-z0-9_-]/) ?</span>
<a href="#l10.265"></a><span id="l10.265" class="difflineplus">+            'xn--' + punycode.encode(s) : s);</span>
<a href="#l10.266"></a><span id="l10.266" class="difflineplus">+      }</span>
<a href="#l10.267"></a><span id="l10.267" class="difflineplus">+      this.hostname = newOut.join('.');</span>
<a href="#l10.268"></a><span id="l10.268" class="difflineplus">+    }</span>
<a href="#l10.269"></a><span id="l10.269" class="difflineplus">+</span>
<a href="#l10.270"></a><span id="l10.270" class="difflineplus">+    var p = this.port ? ':' + this.port : '';</span>
<a href="#l10.271"></a><span id="l10.271" class="difflineplus">+    var h = this.hostname || '';</span>
<a href="#l10.272"></a><span id="l10.272" class="difflineplus">+    this.host = h + p;</span>
<a href="#l10.273"></a><span id="l10.273" class="difflineplus">+    this.href += this.host;</span>
<a href="#l10.274"></a><span id="l10.274" class="difflineplus">+</span>
<a href="#l10.275"></a><span id="l10.275" class="difflineplus">+    // strip [ and ] from the hostname</span>
<a href="#l10.276"></a><span id="l10.276" class="difflineplus">+    // the host field still retains them, though</span>
<a href="#l10.277"></a><span id="l10.277" class="difflineplus">+    if (ipv6Hostname) {</span>
<a href="#l10.278"></a><span id="l10.278" class="difflineplus">+      this.hostname = this.hostname.substr(1, this.hostname.length - 2);</span>
<a href="#l10.279"></a><span id="l10.279" class="difflineplus">+      if (rest[0] !== '/') {</span>
<a href="#l10.280"></a><span id="l10.280" class="difflineplus">+        rest = '/' + rest;</span>
<a href="#l10.281"></a><span id="l10.281" class="difflineplus">+      }</span>
<a href="#l10.282"></a><span id="l10.282" class="difflineplus">+    }</span>
<a href="#l10.283"></a><span id="l10.283" class="difflineplus">+  }</span>
<a href="#l10.284"></a><span id="l10.284" class="difflineplus">+</span>
<a href="#l10.285"></a><span id="l10.285" class="difflineplus">+  // now rest is set to the post-host stuff.</span>
<a href="#l10.286"></a><span id="l10.286" class="difflineplus">+  // chop off any delim chars.</span>
<a href="#l10.287"></a><span id="l10.287" class="difflineplus">+  if (!unsafeProtocol[lowerProto]) {</span>
<a href="#l10.288"></a><span id="l10.288" class="difflineplus">+</span>
<a href="#l10.289"></a><span id="l10.289" class="difflineplus">+    // First, make 100% sure that any &quot;autoEscape&quot; chars get</span>
<a href="#l10.290"></a><span id="l10.290" class="difflineplus">+    // escaped, even if encodeURIComponent doesn't think they</span>
<a href="#l10.291"></a><span id="l10.291" class="difflineplus">+    // need to be.</span>
<a href="#l10.292"></a><span id="l10.292" class="difflineplus">+    for (var i = 0, l = autoEscape.length; i &lt; l; i++) {</span>
<a href="#l10.293"></a><span id="l10.293" class="difflineplus">+      var ae = autoEscape[i];</span>
<a href="#l10.294"></a><span id="l10.294" class="difflineplus">+      var esc = encodeURIComponent(ae);</span>
<a href="#l10.295"></a><span id="l10.295" class="difflineplus">+      if (esc === ae) {</span>
<a href="#l10.296"></a><span id="l10.296" class="difflineplus">+        esc = escape(ae);</span>
<a href="#l10.297"></a><span id="l10.297" class="difflineplus">+      }</span>
<a href="#l10.298"></a><span id="l10.298" class="difflineplus">+      rest = rest.split(ae).join(esc);</span>
<a href="#l10.299"></a><span id="l10.299" class="difflineplus">+    }</span>
<a href="#l10.300"></a><span id="l10.300" class="difflineplus">+  }</span>
<a href="#l10.301"></a><span id="l10.301" class="difflineplus">+</span>
<a href="#l10.302"></a><span id="l10.302" class="difflineplus">+</span>
<a href="#l10.303"></a><span id="l10.303" class="difflineplus">+  // chop off from the tail first.</span>
<a href="#l10.304"></a><span id="l10.304" class="difflineplus">+  var hash = rest.indexOf('#');</span>
<a href="#l10.305"></a><span id="l10.305" class="difflineplus">+  if (hash !== -1) {</span>
<a href="#l10.306"></a><span id="l10.306" class="difflineplus">+    // got a fragment string.</span>
<a href="#l10.307"></a><span id="l10.307" class="difflineplus">+    this.hash = rest.substr(hash);</span>
<a href="#l10.308"></a><span id="l10.308" class="difflineplus">+    rest = rest.slice(0, hash);</span>
<a href="#l10.309"></a><span id="l10.309" class="difflineplus">+  }</span>
<a href="#l10.310"></a><span id="l10.310" class="difflineplus">+  var qm = rest.indexOf('?');</span>
<a href="#l10.311"></a><span id="l10.311" class="difflineplus">+  if (qm !== -1) {</span>
<a href="#l10.312"></a><span id="l10.312" class="difflineplus">+    this.search = rest.substr(qm);</span>
<a href="#l10.313"></a><span id="l10.313" class="difflineplus">+    this.query = rest.substr(qm + 1);</span>
<a href="#l10.314"></a><span id="l10.314" class="difflineplus">+    if (parseQueryString) {</span>
<a href="#l10.315"></a><span id="l10.315" class="difflineplus">+      this.query = querystring.parse(this.query);</span>
<a href="#l10.316"></a><span id="l10.316" class="difflineplus">+    }</span>
<a href="#l10.317"></a><span id="l10.317" class="difflineplus">+    rest = rest.slice(0, qm);</span>
<a href="#l10.318"></a><span id="l10.318" class="difflineplus">+  } else if (parseQueryString) {</span>
<a href="#l10.319"></a><span id="l10.319" class="difflineplus">+    // no query string, but parseQueryString still requested</span>
<a href="#l10.320"></a><span id="l10.320" class="difflineplus">+    this.search = '';</span>
<a href="#l10.321"></a><span id="l10.321" class="difflineplus">+    this.query = {};</span>
<a href="#l10.322"></a><span id="l10.322" class="difflineplus">+  }</span>
<a href="#l10.323"></a><span id="l10.323" class="difflineplus">+  if (rest) this.pathname = rest;</span>
<a href="#l10.324"></a><span id="l10.324" class="difflineplus">+  if (slashedProtocol[lowerProto] &amp;&amp;</span>
<a href="#l10.325"></a><span id="l10.325" class="difflineplus">+      this.hostname &amp;&amp; !this.pathname) {</span>
<a href="#l10.326"></a><span id="l10.326" class="difflineplus">+    this.pathname = '/';</span>
<a href="#l10.327"></a><span id="l10.327" class="difflineplus">+  }</span>
<a href="#l10.328"></a><span id="l10.328" class="difflineplus">+</span>
<a href="#l10.329"></a><span id="l10.329" class="difflineplus">+  //to support http.request</span>
<a href="#l10.330"></a><span id="l10.330" class="difflineplus">+  if (this.pathname || this.search) {</span>
<a href="#l10.331"></a><span id="l10.331" class="difflineplus">+    var p = this.pathname || '';</span>
<a href="#l10.332"></a><span id="l10.332" class="difflineplus">+    var s = this.search || '';</span>
<a href="#l10.333"></a><span id="l10.333" class="difflineplus">+    this.path = p + s;</span>
<a href="#l10.334"></a><span id="l10.334" class="difflineplus">+  }</span>
<a href="#l10.335"></a><span id="l10.335" class="difflineplus">+</span>
<a href="#l10.336"></a><span id="l10.336" class="difflineplus">+  // finally, reconstruct the href based on what has been validated.</span>
<a href="#l10.337"></a><span id="l10.337" class="difflineplus">+  this.href = this.format();</span>
<a href="#l10.338"></a><span id="l10.338" class="difflineplus">+  return this;</span>
<a href="#l10.339"></a><span id="l10.339" class="difflineplus">+};</span>
<a href="#l10.340"></a><span id="l10.340" class="difflineplus">+</span>
<a href="#l10.341"></a><span id="l10.341" class="difflineplus">+// format a parsed object into a url string</span>
<a href="#l10.342"></a><span id="l10.342" class="difflineplus">+function urlFormat(obj) {</span>
<a href="#l10.343"></a><span id="l10.343" class="difflineplus">+  // ensure it's an object, and not a string url.</span>
<a href="#l10.344"></a><span id="l10.344" class="difflineplus">+  // If it's an obj, this is a no-op.</span>
<a href="#l10.345"></a><span id="l10.345" class="difflineplus">+  // this way, you can call url_format() on strings</span>
<a href="#l10.346"></a><span id="l10.346" class="difflineplus">+  // to clean up potentially wonky urls.</span>
<a href="#l10.347"></a><span id="l10.347" class="difflineplus">+  if (isString(obj)) obj = urlParse(obj);</span>
<a href="#l10.348"></a><span id="l10.348" class="difflineplus">+  if (!(obj instanceof Url)) return Url.prototype.format.call(obj);</span>
<a href="#l10.349"></a><span id="l10.349" class="difflineplus">+  return obj.format();</span>
<a href="#l10.350"></a><span id="l10.350" class="difflineplus">+}</span>
<a href="#l10.351"></a><span id="l10.351" class="difflineplus">+</span>
<a href="#l10.352"></a><span id="l10.352" class="difflineplus">+Url.prototype.format = function() {</span>
<a href="#l10.353"></a><span id="l10.353" class="difflineplus">+  var auth = this.auth || '';</span>
<a href="#l10.354"></a><span id="l10.354" class="difflineplus">+  if (auth) {</span>
<a href="#l10.355"></a><span id="l10.355" class="difflineplus">+    auth = encodeURIComponent(auth);</span>
<a href="#l10.356"></a><span id="l10.356" class="difflineplus">+    auth = auth.replace(/%3A/i, ':');</span>
<a href="#l10.357"></a><span id="l10.357" class="difflineplus">+    auth += '@';</span>
<a href="#l10.358"></a><span id="l10.358" class="difflineplus">+  }</span>
<a href="#l10.359"></a><span id="l10.359" class="difflineplus">+</span>
<a href="#l10.360"></a><span id="l10.360" class="difflineplus">+  var protocol = this.protocol || '',</span>
<a href="#l10.361"></a><span id="l10.361" class="difflineplus">+      pathname = this.pathname || '',</span>
<a href="#l10.362"></a><span id="l10.362" class="difflineplus">+      hash = this.hash || '',</span>
<a href="#l10.363"></a><span id="l10.363" class="difflineplus">+      host = false,</span>
<a href="#l10.364"></a><span id="l10.364" class="difflineplus">+      query = '';</span>
<a href="#l10.365"></a><span id="l10.365" class="difflineplus">+</span>
<a href="#l10.366"></a><span id="l10.366" class="difflineplus">+  if (this.host) {</span>
<a href="#l10.367"></a><span id="l10.367" class="difflineplus">+    host = auth + this.host;</span>
<a href="#l10.368"></a><span id="l10.368" class="difflineplus">+  } else if (this.hostname) {</span>
<a href="#l10.369"></a><span id="l10.369" class="difflineplus">+    host = auth + (this.hostname.indexOf(':') === -1 ?</span>
<a href="#l10.370"></a><span id="l10.370" class="difflineplus">+        this.hostname :</span>
<a href="#l10.371"></a><span id="l10.371" class="difflineplus">+        '[' + this.hostname + ']');</span>
<a href="#l10.372"></a><span id="l10.372" class="difflineplus">+    if (this.port) {</span>
<a href="#l10.373"></a><span id="l10.373" class="difflineplus">+      host += ':' + this.port;</span>
<a href="#l10.374"></a><span id="l10.374" class="difflineplus">+    }</span>
<a href="#l10.375"></a><span id="l10.375" class="difflineplus">+  }</span>
<a href="#l10.376"></a><span id="l10.376" class="difflineplus">+</span>
<a href="#l10.377"></a><span id="l10.377" class="difflineplus">+  if (this.query &amp;&amp;</span>
<a href="#l10.378"></a><span id="l10.378" class="difflineplus">+      isObject(this.query) &amp;&amp;</span>
<a href="#l10.379"></a><span id="l10.379" class="difflineplus">+      Object.keys(this.query).length) {</span>
<a href="#l10.380"></a><span id="l10.380" class="difflineplus">+    query = querystring.stringify(this.query);</span>
<a href="#l10.381"></a><span id="l10.381" class="difflineplus">+  }</span>
<a href="#l10.382"></a><span id="l10.382" class="difflineplus">+</span>
<a href="#l10.383"></a><span id="l10.383" class="difflineplus">+  var search = this.search || (query &amp;&amp; ('?' + query)) || '';</span>
<a href="#l10.384"></a><span id="l10.384" class="difflineplus">+</span>
<a href="#l10.385"></a><span id="l10.385" class="difflineplus">+  if (protocol &amp;&amp; protocol.substr(-1) !== ':') protocol += ':';</span>
<a href="#l10.386"></a><span id="l10.386" class="difflineplus">+</span>
<a href="#l10.387"></a><span id="l10.387" class="difflineplus">+  // only the slashedProtocols get the //.  Not mailto:, xmpp:, etc.</span>
<a href="#l10.388"></a><span id="l10.388" class="difflineplus">+  // unless they had them to begin with.</span>
<a href="#l10.389"></a><span id="l10.389" class="difflineplus">+  if (this.slashes ||</span>
<a href="#l10.390"></a><span id="l10.390" class="difflineplus">+      (!protocol || slashedProtocol[protocol]) &amp;&amp; host !== false) {</span>
<a href="#l10.391"></a><span id="l10.391" class="difflineplus">+    host = '//' + (host || '');</span>
<a href="#l10.392"></a><span id="l10.392" class="difflineplus">+    if (pathname &amp;&amp; pathname.charAt(0) !== '/') pathname = '/' + pathname;</span>
<a href="#l10.393"></a><span id="l10.393" class="difflineplus">+  } else if (!host) {</span>
<a href="#l10.394"></a><span id="l10.394" class="difflineplus">+    host = '';</span>
<a href="#l10.395"></a><span id="l10.395" class="difflineplus">+  }</span>
<a href="#l10.396"></a><span id="l10.396" class="difflineplus">+</span>
<a href="#l10.397"></a><span id="l10.397" class="difflineplus">+  if (hash &amp;&amp; hash.charAt(0) !== '#') hash = '#' + hash;</span>
<a href="#l10.398"></a><span id="l10.398" class="difflineplus">+  if (search &amp;&amp; search.charAt(0) !== '?') search = '?' + search;</span>
<a href="#l10.399"></a><span id="l10.399" class="difflineplus">+</span>
<a href="#l10.400"></a><span id="l10.400" class="difflineplus">+  pathname = pathname.replace(/[?#]/g, function(match) {</span>
<a href="#l10.401"></a><span id="l10.401" class="difflineplus">+    return encodeURIComponent(match);</span>
<a href="#l10.402"></a><span id="l10.402" class="difflineplus">+  });</span>
<a href="#l10.403"></a><span id="l10.403" class="difflineplus">+  search = search.replace('#', '%23');</span>
<a href="#l10.404"></a><span id="l10.404" class="difflineplus">+</span>
<a href="#l10.405"></a><span id="l10.405" class="difflineplus">+  return protocol + host + pathname + search + hash;</span>
<a href="#l10.406"></a><span id="l10.406" class="difflineplus">+};</span>
<a href="#l10.407"></a><span id="l10.407" class="difflineplus">+</span>
<a href="#l10.408"></a><span id="l10.408" class="difflineplus">+function urlResolve(source, relative) {</span>
<a href="#l10.409"></a><span id="l10.409" class="difflineplus">+  return urlParse(source, false, true).resolve(relative);</span>
<a href="#l10.410"></a><span id="l10.410" class="difflineplus">+}</span>
<a href="#l10.411"></a><span id="l10.411" class="difflineplus">+</span>
<a href="#l10.412"></a><span id="l10.412" class="difflineplus">+Url.prototype.resolve = function(relative) {</span>
<a href="#l10.413"></a><span id="l10.413" class="difflineplus">+  return this.resolveObject(urlParse(relative, false, true)).format();</span>
<a href="#l10.414"></a><span id="l10.414" class="difflineplus">+};</span>
<a href="#l10.415"></a><span id="l10.415" class="difflineplus">+</span>
<a href="#l10.416"></a><span id="l10.416" class="difflineplus">+function urlResolveObject(source, relative) {</span>
<a href="#l10.417"></a><span id="l10.417" class="difflineplus">+  if (!source) return relative;</span>
<a href="#l10.418"></a><span id="l10.418" class="difflineplus">+  return urlParse(source, false, true).resolveObject(relative);</span>
<a href="#l10.419"></a><span id="l10.419" class="difflineplus">+}</span>
<a href="#l10.420"></a><span id="l10.420" class="difflineplus">+</span>
<a href="#l10.421"></a><span id="l10.421" class="difflineplus">+Url.prototype.resolveObject = function(relative) {</span>
<a href="#l10.422"></a><span id="l10.422" class="difflineplus">+  if (isString(relative)) {</span>
<a href="#l10.423"></a><span id="l10.423" class="difflineplus">+    var rel = new Url();</span>
<a href="#l10.424"></a><span id="l10.424" class="difflineplus">+    rel.parse(relative, false, true);</span>
<a href="#l10.425"></a><span id="l10.425" class="difflineplus">+    relative = rel;</span>
<a href="#l10.426"></a><span id="l10.426" class="difflineplus">+  }</span>
<a href="#l10.427"></a><span id="l10.427" class="difflineplus">+</span>
<a href="#l10.428"></a><span id="l10.428" class="difflineplus">+  var result = new Url();</span>
<a href="#l10.429"></a><span id="l10.429" class="difflineplus">+  Object.keys(this).forEach(function(k) {</span>
<a href="#l10.430"></a><span id="l10.430" class="difflineplus">+    result[k] = this[k];</span>
<a href="#l10.431"></a><span id="l10.431" class="difflineplus">+  }, this);</span>
<a href="#l10.432"></a><span id="l10.432" class="difflineplus">+</span>
<a href="#l10.433"></a><span id="l10.433" class="difflineplus">+  // hash is always overridden, no matter what.</span>
<a href="#l10.434"></a><span id="l10.434" class="difflineplus">+  // even href=&quot;&quot; will remove it.</span>
<a href="#l10.435"></a><span id="l10.435" class="difflineplus">+  result.hash = relative.hash;</span>
<a href="#l10.436"></a><span id="l10.436" class="difflineplus">+</span>
<a href="#l10.437"></a><span id="l10.437" class="difflineplus">+  // if the relative url is empty, then there's nothing left to do here.</span>
<a href="#l10.438"></a><span id="l10.438" class="difflineplus">+  if (relative.href === '') {</span>
<a href="#l10.439"></a><span id="l10.439" class="difflineplus">+    result.href = result.format();</span>
<a href="#l10.440"></a><span id="l10.440" class="difflineplus">+    return result;</span>
<a href="#l10.441"></a><span id="l10.441" class="difflineplus">+  }</span>
<a href="#l10.442"></a><span id="l10.442" class="difflineplus">+</span>
<a href="#l10.443"></a><span id="l10.443" class="difflineplus">+  // hrefs like //foo/bar always cut to the protocol.</span>
<a href="#l10.444"></a><span id="l10.444" class="difflineplus">+  if (relative.slashes &amp;&amp; !relative.protocol) {</span>
<a href="#l10.445"></a><span id="l10.445" class="difflineplus">+    // take everything except the protocol from relative</span>
<a href="#l10.446"></a><span id="l10.446" class="difflineplus">+    Object.keys(relative).forEach(function(k) {</span>
<a href="#l10.447"></a><span id="l10.447" class="difflineplus">+      if (k !== 'protocol')</span>
<a href="#l10.448"></a><span id="l10.448" class="difflineplus">+        result[k] = relative[k];</span>
<a href="#l10.449"></a><span id="l10.449" class="difflineplus">+    });</span>
<a href="#l10.450"></a><span id="l10.450" class="difflineplus">+</span>
<a href="#l10.451"></a><span id="l10.451" class="difflineplus">+    //urlParse appends trailing / to urls like http://www.example.com</span>
<a href="#l10.452"></a><span id="l10.452" class="difflineplus">+    if (slashedProtocol[result.protocol] &amp;&amp;</span>
<a href="#l10.453"></a><span id="l10.453" class="difflineplus">+        result.hostname &amp;&amp; !result.pathname) {</span>
<a href="#l10.454"></a><span id="l10.454" class="difflineplus">+      result.path = result.pathname = '/';</span>
<a href="#l10.455"></a><span id="l10.455" class="difflineplus">+    }</span>
<a href="#l10.456"></a><span id="l10.456" class="difflineplus">+</span>
<a href="#l10.457"></a><span id="l10.457" class="difflineplus">+    result.href = result.format();</span>
<a href="#l10.458"></a><span id="l10.458" class="difflineplus">+    return result;</span>
<a href="#l10.459"></a><span id="l10.459" class="difflineplus">+  }</span>
<a href="#l10.460"></a><span id="l10.460" class="difflineplus">+</span>
<a href="#l10.461"></a><span id="l10.461" class="difflineplus">+  if (relative.protocol &amp;&amp; relative.protocol !== result.protocol) {</span>
<a href="#l10.462"></a><span id="l10.462" class="difflineplus">+    // if it's a known url protocol, then changing</span>
<a href="#l10.463"></a><span id="l10.463" class="difflineplus">+    // the protocol does weird things</span>
<a href="#l10.464"></a><span id="l10.464" class="difflineplus">+    // first, if it's not file:, then we MUST have a host,</span>
<a href="#l10.465"></a><span id="l10.465" class="difflineplus">+    // and if there was a path</span>
<a href="#l10.466"></a><span id="l10.466" class="difflineplus">+    // to begin with, then we MUST have a path.</span>
<a href="#l10.467"></a><span id="l10.467" class="difflineplus">+    // if it is file:, then the host is dropped,</span>
<a href="#l10.468"></a><span id="l10.468" class="difflineplus">+    // because that's known to be hostless.</span>
<a href="#l10.469"></a><span id="l10.469" class="difflineplus">+    // anything else is assumed to be absolute.</span>
<a href="#l10.470"></a><span id="l10.470" class="difflineplus">+    if (!slashedProtocol[relative.protocol]) {</span>
<a href="#l10.471"></a><span id="l10.471" class="difflineplus">+      Object.keys(relative).forEach(function(k) {</span>
<a href="#l10.472"></a><span id="l10.472" class="difflineplus">+        result[k] = relative[k];</span>
<a href="#l10.473"></a><span id="l10.473" class="difflineplus">+      });</span>
<a href="#l10.474"></a><span id="l10.474" class="difflineplus">+      result.href = result.format();</span>
<a href="#l10.475"></a><span id="l10.475" class="difflineplus">+      return result;</span>
<a href="#l10.476"></a><span id="l10.476" class="difflineplus">+    }</span>
<a href="#l10.477"></a><span id="l10.477" class="difflineplus">+</span>
<a href="#l10.478"></a><span id="l10.478" class="difflineplus">+    result.protocol = relative.protocol;</span>
<a href="#l10.479"></a><span id="l10.479" class="difflineplus">+    if (!relative.host &amp;&amp; !hostlessProtocol[relative.protocol]) {</span>
<a href="#l10.480"></a><span id="l10.480" class="difflineplus">+      var relPath = (relative.pathname || '').split('/');</span>
<a href="#l10.481"></a><span id="l10.481" class="difflineplus">+      while (relPath.length &amp;&amp; !(relative.host = relPath.shift()));</span>
<a href="#l10.482"></a><span id="l10.482" class="difflineplus">+      if (!relative.host) relative.host = '';</span>
<a href="#l10.483"></a><span id="l10.483" class="difflineplus">+      if (!relative.hostname) relative.hostname = '';</span>
<a href="#l10.484"></a><span id="l10.484" class="difflineplus">+      if (relPath[0] !== '') relPath.unshift('');</span>
<a href="#l10.485"></a><span id="l10.485" class="difflineplus">+      if (relPath.length &lt; 2) relPath.unshift('');</span>
<a href="#l10.486"></a><span id="l10.486" class="difflineplus">+      result.pathname = relPath.join('/');</span>
<a href="#l10.487"></a><span id="l10.487" class="difflineplus">+    } else {</span>
<a href="#l10.488"></a><span id="l10.488" class="difflineplus">+      result.pathname = relative.pathname;</span>
<a href="#l10.489"></a><span id="l10.489" class="difflineplus">+    }</span>
<a href="#l10.490"></a><span id="l10.490" class="difflineplus">+    result.search = relative.search;</span>
<a href="#l10.491"></a><span id="l10.491" class="difflineplus">+    result.query = relative.query;</span>
<a href="#l10.492"></a><span id="l10.492" class="difflineplus">+    result.host = relative.host || '';</span>
<a href="#l10.493"></a><span id="l10.493" class="difflineplus">+    result.auth = relative.auth;</span>
<a href="#l10.494"></a><span id="l10.494" class="difflineplus">+    result.hostname = relative.hostname || relative.host;</span>
<a href="#l10.495"></a><span id="l10.495" class="difflineplus">+    result.port = relative.port;</span>
<a href="#l10.496"></a><span id="l10.496" class="difflineplus">+    // to support http.request</span>
<a href="#l10.497"></a><span id="l10.497" class="difflineplus">+    if (result.pathname || result.search) {</span>
<a href="#l10.498"></a><span id="l10.498" class="difflineplus">+      var p = result.pathname || '';</span>
<a href="#l10.499"></a><span id="l10.499" class="difflineplus">+      var s = result.search || '';</span>
<a href="#l10.500"></a><span id="l10.500" class="difflineplus">+      result.path = p + s;</span>
<a href="#l10.501"></a><span id="l10.501" class="difflineplus">+    }</span>
<a href="#l10.502"></a><span id="l10.502" class="difflineplus">+    result.slashes = result.slashes || relative.slashes;</span>
<a href="#l10.503"></a><span id="l10.503" class="difflineplus">+    result.href = result.format();</span>
<a href="#l10.504"></a><span id="l10.504" class="difflineplus">+    return result;</span>
<a href="#l10.505"></a><span id="l10.505" class="difflineplus">+  }</span>
<a href="#l10.506"></a><span id="l10.506" class="difflineplus">+</span>
<a href="#l10.507"></a><span id="l10.507" class="difflineplus">+  var isSourceAbs = (result.pathname &amp;&amp; result.pathname.charAt(0) === '/'),</span>
<a href="#l10.508"></a><span id="l10.508" class="difflineplus">+      isRelAbs = (</span>
<a href="#l10.509"></a><span id="l10.509" class="difflineplus">+          relative.host ||</span>
<a href="#l10.510"></a><span id="l10.510" class="difflineplus">+          relative.pathname &amp;&amp; relative.pathname.charAt(0) === '/'</span>
<a href="#l10.511"></a><span id="l10.511" class="difflineplus">+      ),</span>
<a href="#l10.512"></a><span id="l10.512" class="difflineplus">+      mustEndAbs = (isRelAbs || isSourceAbs ||</span>
<a href="#l10.513"></a><span id="l10.513" class="difflineplus">+                    (result.host &amp;&amp; relative.pathname)),</span>
<a href="#l10.514"></a><span id="l10.514" class="difflineplus">+      removeAllDots = mustEndAbs,</span>
<a href="#l10.515"></a><span id="l10.515" class="difflineplus">+      srcPath = result.pathname &amp;&amp; result.pathname.split('/') || [],</span>
<a href="#l10.516"></a><span id="l10.516" class="difflineplus">+      relPath = relative.pathname &amp;&amp; relative.pathname.split('/') || [],</span>
<a href="#l10.517"></a><span id="l10.517" class="difflineplus">+      psychotic = result.protocol &amp;&amp; !slashedProtocol[result.protocol];</span>
<a href="#l10.518"></a><span id="l10.518" class="difflineplus">+</span>
<a href="#l10.519"></a><span id="l10.519" class="difflineplus">+  // if the url is a non-slashed url, then relative</span>
<a href="#l10.520"></a><span id="l10.520" class="difflineplus">+  // links like ../.. should be able</span>
<a href="#l10.521"></a><span id="l10.521" class="difflineplus">+  // to crawl up to the hostname, as well.  This is strange.</span>
<a href="#l10.522"></a><span id="l10.522" class="difflineplus">+  // result.protocol has already been set by now.</span>
<a href="#l10.523"></a><span id="l10.523" class="difflineplus">+  // Later on, put the first path part into the host field.</span>
<a href="#l10.524"></a><span id="l10.524" class="difflineplus">+  if (psychotic) {</span>
<a href="#l10.525"></a><span id="l10.525" class="difflineplus">+    result.hostname = '';</span>
<a href="#l10.526"></a><span id="l10.526" class="difflineplus">+    result.port = null;</span>
<a href="#l10.527"></a><span id="l10.527" class="difflineplus">+    if (result.host) {</span>
<a href="#l10.528"></a><span id="l10.528" class="difflineplus">+      if (srcPath[0] === '') srcPath[0] = result.host;</span>
<a href="#l10.529"></a><span id="l10.529" class="difflineplus">+      else srcPath.unshift(result.host);</span>
<a href="#l10.530"></a><span id="l10.530" class="difflineplus">+    }</span>
<a href="#l10.531"></a><span id="l10.531" class="difflineplus">+    result.host = '';</span>
<a href="#l10.532"></a><span id="l10.532" class="difflineplus">+    if (relative.protocol) {</span>
<a href="#l10.533"></a><span id="l10.533" class="difflineplus">+      relative.hostname = null;</span>
<a href="#l10.534"></a><span id="l10.534" class="difflineplus">+      relative.port = null;</span>
<a href="#l10.535"></a><span id="l10.535" class="difflineplus">+      if (relative.host) {</span>
<a href="#l10.536"></a><span id="l10.536" class="difflineplus">+        if (relPath[0] === '') relPath[0] = relative.host;</span>
<a href="#l10.537"></a><span id="l10.537" class="difflineplus">+        else relPath.unshift(relative.host);</span>
<a href="#l10.538"></a><span id="l10.538" class="difflineplus">+      }</span>
<a href="#l10.539"></a><span id="l10.539" class="difflineplus">+      relative.host = null;</span>
<a href="#l10.540"></a><span id="l10.540" class="difflineplus">+    }</span>
<a href="#l10.541"></a><span id="l10.541" class="difflineplus">+    mustEndAbs = mustEndAbs &amp;&amp; (relPath[0] === '' || srcPath[0] === '');</span>
<a href="#l10.542"></a><span id="l10.542" class="difflineplus">+  }</span>
<a href="#l10.543"></a><span id="l10.543" class="difflineplus">+</span>
<a href="#l10.544"></a><span id="l10.544" class="difflineplus">+  if (isRelAbs) {</span>
<a href="#l10.545"></a><span id="l10.545" class="difflineplus">+    // it's absolute.</span>
<a href="#l10.546"></a><span id="l10.546" class="difflineplus">+    result.host = (relative.host || relative.host === '') ?</span>
<a href="#l10.547"></a><span id="l10.547" class="difflineplus">+                  relative.host : result.host;</span>
<a href="#l10.548"></a><span id="l10.548" class="difflineplus">+    result.hostname = (relative.hostname || relative.hostname === '') ?</span>
<a href="#l10.549"></a><span id="l10.549" class="difflineplus">+                      relative.hostname : result.hostname;</span>
<a href="#l10.550"></a><span id="l10.550" class="difflineplus">+    result.search = relative.search;</span>
<a href="#l10.551"></a><span id="l10.551" class="difflineplus">+    result.query = relative.query;</span>
<a href="#l10.552"></a><span id="l10.552" class="difflineplus">+    srcPath = relPath;</span>
<a href="#l10.553"></a><span id="l10.553" class="difflineplus">+    // fall through to the dot-handling below.</span>
<a href="#l10.554"></a><span id="l10.554" class="difflineplus">+  } else if (relPath.length) {</span>
<a href="#l10.555"></a><span id="l10.555" class="difflineplus">+    // it's relative</span>
<a href="#l10.556"></a><span id="l10.556" class="difflineplus">+    // throw away the existing file, and take the new path instead.</span>
<a href="#l10.557"></a><span id="l10.557" class="difflineplus">+    if (!srcPath) srcPath = [];</span>
<a href="#l10.558"></a><span id="l10.558" class="difflineplus">+    srcPath.pop();</span>
<a href="#l10.559"></a><span id="l10.559" class="difflineplus">+    srcPath = srcPath.concat(relPath);</span>
<a href="#l10.560"></a><span id="l10.560" class="difflineplus">+    result.search = relative.search;</span>
<a href="#l10.561"></a><span id="l10.561" class="difflineplus">+    result.query = relative.query;</span>
<a href="#l10.562"></a><span id="l10.562" class="difflineplus">+  } else if (!isNullOrUndefined(relative.search)) {</span>
<a href="#l10.563"></a><span id="l10.563" class="difflineplus">+    // just pull out the search.</span>
<a href="#l10.564"></a><span id="l10.564" class="difflineplus">+    // like href='?foo'.</span>
<a href="#l10.565"></a><span id="l10.565" class="difflineplus">+    // Put this after the other two cases because it simplifies the booleans</span>
<a href="#l10.566"></a><span id="l10.566" class="difflineplus">+    if (psychotic) {</span>
<a href="#l10.567"></a><span id="l10.567" class="difflineplus">+      result.hostname = result.host = srcPath.shift();</span>
<a href="#l10.568"></a><span id="l10.568" class="difflineplus">+      //occationaly the auth can get stuck only in host</span>
<a href="#l10.569"></a><span id="l10.569" class="difflineplus">+      //this especialy happens in cases like</span>
<a href="#l10.570"></a><span id="l10.570" class="difflineplus">+      //url.resolveObject('mailto:local1@domain1', 'local2@domain2')</span>
<a href="#l10.571"></a><span id="l10.571" class="difflineplus">+      var authInHost = result.host &amp;&amp; result.host.indexOf('@') &gt; 0 ?</span>
<a href="#l10.572"></a><span id="l10.572" class="difflineplus">+                       result.host.split('@') : false;</span>
<a href="#l10.573"></a><span id="l10.573" class="difflineplus">+      if (authInHost) {</span>
<a href="#l10.574"></a><span id="l10.574" class="difflineplus">+        result.auth = authInHost.shift();</span>
<a href="#l10.575"></a><span id="l10.575" class="difflineplus">+        result.host = result.hostname = authInHost.shift();</span>
<a href="#l10.576"></a><span id="l10.576" class="difflineplus">+      }</span>
<a href="#l10.577"></a><span id="l10.577" class="difflineplus">+    }</span>
<a href="#l10.578"></a><span id="l10.578" class="difflineplus">+    result.search = relative.search;</span>
<a href="#l10.579"></a><span id="l10.579" class="difflineplus">+    result.query = relative.query;</span>
<a href="#l10.580"></a><span id="l10.580" class="difflineplus">+    //to support http.request</span>
<a href="#l10.581"></a><span id="l10.581" class="difflineplus">+    if (!isNull(result.pathname) || !isNull(result.search)) {</span>
<a href="#l10.582"></a><span id="l10.582" class="difflineplus">+      result.path = (result.pathname ? result.pathname : '') +</span>
<a href="#l10.583"></a><span id="l10.583" class="difflineplus">+                    (result.search ? result.search : '');</span>
<a href="#l10.584"></a><span id="l10.584" class="difflineplus">+    }</span>
<a href="#l10.585"></a><span id="l10.585" class="difflineplus">+    result.href = result.format();</span>
<a href="#l10.586"></a><span id="l10.586" class="difflineplus">+    return result;</span>
<a href="#l10.587"></a><span id="l10.587" class="difflineplus">+  }</span>
<a href="#l10.588"></a><span id="l10.588" class="difflineplus">+</span>
<a href="#l10.589"></a><span id="l10.589" class="difflineplus">+  if (!srcPath.length) {</span>
<a href="#l10.590"></a><span id="l10.590" class="difflineplus">+    // no path at all.  easy.</span>
<a href="#l10.591"></a><span id="l10.591" class="difflineplus">+    // we've already handled the other stuff above.</span>
<a href="#l10.592"></a><span id="l10.592" class="difflineplus">+    result.pathname = null;</span>
<a href="#l10.593"></a><span id="l10.593" class="difflineplus">+    //to support http.request</span>
<a href="#l10.594"></a><span id="l10.594" class="difflineplus">+    if (result.search) {</span>
<a href="#l10.595"></a><span id="l10.595" class="difflineplus">+      result.path = '/' + result.search;</span>
<a href="#l10.596"></a><span id="l10.596" class="difflineplus">+    } else {</span>
<a href="#l10.597"></a><span id="l10.597" class="difflineplus">+      result.path = null;</span>
<a href="#l10.598"></a><span id="l10.598" class="difflineplus">+    }</span>
<a href="#l10.599"></a><span id="l10.599" class="difflineplus">+    result.href = result.format();</span>
<a href="#l10.600"></a><span id="l10.600" class="difflineplus">+    return result;</span>
<a href="#l10.601"></a><span id="l10.601" class="difflineplus">+  }</span>
<a href="#l10.602"></a><span id="l10.602" class="difflineplus">+</span>
<a href="#l10.603"></a><span id="l10.603" class="difflineplus">+  // if a url ENDs in . or .., then it must get a trailing slash.</span>
<a href="#l10.604"></a><span id="l10.604" class="difflineplus">+  // however, if it ends in anything else non-slashy,</span>
<a href="#l10.605"></a><span id="l10.605" class="difflineplus">+  // then it must NOT get a trailing slash.</span>
<a href="#l10.606"></a><span id="l10.606" class="difflineplus">+  var last = srcPath.slice(-1)[0];</span>
<a href="#l10.607"></a><span id="l10.607" class="difflineplus">+  var hasTrailingSlash = (</span>
<a href="#l10.608"></a><span id="l10.608" class="difflineplus">+      (result.host || relative.host) &amp;&amp; (last === '.' || last === '..') ||</span>
<a href="#l10.609"></a><span id="l10.609" class="difflineplus">+      last === '');</span>
<a href="#l10.610"></a><span id="l10.610" class="difflineplus">+</span>
<a href="#l10.611"></a><span id="l10.611" class="difflineplus">+  // strip single dots, resolve double dots to parent dir</span>
<a href="#l10.612"></a><span id="l10.612" class="difflineplus">+  // if the path tries to go above the root, `up` ends up &gt; 0</span>
<a href="#l10.613"></a><span id="l10.613" class="difflineplus">+  var up = 0;</span>
<a href="#l10.614"></a><span id="l10.614" class="difflineplus">+  for (var i = srcPath.length; i &gt;= 0; i--) {</span>
<a href="#l10.615"></a><span id="l10.615" class="difflineplus">+    last = srcPath[i];</span>
<a href="#l10.616"></a><span id="l10.616" class="difflineplus">+    if (last == '.') {</span>
<a href="#l10.617"></a><span id="l10.617" class="difflineplus">+      srcPath.splice(i, 1);</span>
<a href="#l10.618"></a><span id="l10.618" class="difflineplus">+    } else if (last === '..') {</span>
<a href="#l10.619"></a><span id="l10.619" class="difflineplus">+      srcPath.splice(i, 1);</span>
<a href="#l10.620"></a><span id="l10.620" class="difflineplus">+      up++;</span>
<a href="#l10.621"></a><span id="l10.621" class="difflineplus">+    } else if (up) {</span>
<a href="#l10.622"></a><span id="l10.622" class="difflineplus">+      srcPath.splice(i, 1);</span>
<a href="#l10.623"></a><span id="l10.623" class="difflineplus">+      up--;</span>
<a href="#l10.624"></a><span id="l10.624" class="difflineplus">+    }</span>
<a href="#l10.625"></a><span id="l10.625" class="difflineplus">+  }</span>
<a href="#l10.626"></a><span id="l10.626" class="difflineplus">+</span>
<a href="#l10.627"></a><span id="l10.627" class="difflineplus">+  // if the path is allowed to go above the root, restore leading ..s</span>
<a href="#l10.628"></a><span id="l10.628" class="difflineplus">+  if (!mustEndAbs &amp;&amp; !removeAllDots) {</span>
<a href="#l10.629"></a><span id="l10.629" class="difflineplus">+    for (; up--; up) {</span>
<a href="#l10.630"></a><span id="l10.630" class="difflineplus">+      srcPath.unshift('..');</span>
<a href="#l10.631"></a><span id="l10.631" class="difflineplus">+    }</span>
<a href="#l10.632"></a><span id="l10.632" class="difflineplus">+  }</span>
<a href="#l10.633"></a><span id="l10.633" class="difflineplus">+</span>
<a href="#l10.634"></a><span id="l10.634" class="difflineplus">+  if (mustEndAbs &amp;&amp; srcPath[0] !== '' &amp;&amp;</span>
<a href="#l10.635"></a><span id="l10.635" class="difflineplus">+      (!srcPath[0] || srcPath[0].charAt(0) !== '/')) {</span>
<a href="#l10.636"></a><span id="l10.636" class="difflineplus">+    srcPath.unshift('');</span>
<a href="#l10.637"></a><span id="l10.637" class="difflineplus">+  }</span>
<a href="#l10.638"></a><span id="l10.638" class="difflineplus">+</span>
<a href="#l10.639"></a><span id="l10.639" class="difflineplus">+  if (hasTrailingSlash &amp;&amp; (srcPath.join('/').substr(-1) !== '/')) {</span>
<a href="#l10.640"></a><span id="l10.640" class="difflineplus">+    srcPath.push('');</span>
<a href="#l10.641"></a><span id="l10.641" class="difflineplus">+  }</span>
<a href="#l10.642"></a><span id="l10.642" class="difflineplus">+</span>
<a href="#l10.643"></a><span id="l10.643" class="difflineplus">+  var isAbsolute = srcPath[0] === '' ||</span>
<a href="#l10.644"></a><span id="l10.644" class="difflineplus">+      (srcPath[0] &amp;&amp; srcPath[0].charAt(0) === '/');</span>
<a href="#l10.645"></a><span id="l10.645" class="difflineplus">+</span>
<a href="#l10.646"></a><span id="l10.646" class="difflineplus">+  // put the host back</span>
<a href="#l10.647"></a><span id="l10.647" class="difflineplus">+  if (psychotic) {</span>
<a href="#l10.648"></a><span id="l10.648" class="difflineplus">+    result.hostname = result.host = isAbsolute ? '' :</span>
<a href="#l10.649"></a><span id="l10.649" class="difflineplus">+                                    srcPath.length ? srcPath.shift() : '';</span>
<a href="#l10.650"></a><span id="l10.650" class="difflineplus">+    //occationaly the auth can get stuck only in host</span>
<a href="#l10.651"></a><span id="l10.651" class="difflineplus">+    //this especialy happens in cases like</span>
<a href="#l10.652"></a><span id="l10.652" class="difflineplus">+    //url.resolveObject('mailto:local1@domain1', 'local2@domain2')</span>
<a href="#l10.653"></a><span id="l10.653" class="difflineplus">+    var authInHost = result.host &amp;&amp; result.host.indexOf('@') &gt; 0 ?</span>
<a href="#l10.654"></a><span id="l10.654" class="difflineplus">+                     result.host.split('@') : false;</span>
<a href="#l10.655"></a><span id="l10.655" class="difflineplus">+    if (authInHost) {</span>
<a href="#l10.656"></a><span id="l10.656" class="difflineplus">+      result.auth = authInHost.shift();</span>
<a href="#l10.657"></a><span id="l10.657" class="difflineplus">+      result.host = result.hostname = authInHost.shift();</span>
<a href="#l10.658"></a><span id="l10.658" class="difflineplus">+    }</span>
<a href="#l10.659"></a><span id="l10.659" class="difflineplus">+  }</span>
<a href="#l10.660"></a><span id="l10.660" class="difflineplus">+</span>
<a href="#l10.661"></a><span id="l10.661" class="difflineplus">+  mustEndAbs = mustEndAbs || (result.host &amp;&amp; srcPath.length);</span>
<a href="#l10.662"></a><span id="l10.662" class="difflineplus">+</span>
<a href="#l10.663"></a><span id="l10.663" class="difflineplus">+  if (mustEndAbs &amp;&amp; !isAbsolute) {</span>
<a href="#l10.664"></a><span id="l10.664" class="difflineplus">+    srcPath.unshift('');</span>
<a href="#l10.665"></a><span id="l10.665" class="difflineplus">+  }</span>
<a href="#l10.666"></a><span id="l10.666" class="difflineplus">+</span>
<a href="#l10.667"></a><span id="l10.667" class="difflineplus">+  if (!srcPath.length) {</span>
<a href="#l10.668"></a><span id="l10.668" class="difflineplus">+    result.pathname = null;</span>
<a href="#l10.669"></a><span id="l10.669" class="difflineplus">+    result.path = null;</span>
<a href="#l10.670"></a><span id="l10.670" class="difflineplus">+  } else {</span>
<a href="#l10.671"></a><span id="l10.671" class="difflineplus">+    result.pathname = srcPath.join('/');</span>
<a href="#l10.672"></a><span id="l10.672" class="difflineplus">+  }</span>
<a href="#l10.673"></a><span id="l10.673" class="difflineplus">+</span>
<a href="#l10.674"></a><span id="l10.674" class="difflineplus">+  //to support request.http</span>
<a href="#l10.675"></a><span id="l10.675" class="difflineplus">+  if (!isNull(result.pathname) || !isNull(result.search)) {</span>
<a href="#l10.676"></a><span id="l10.676" class="difflineplus">+    result.path = (result.pathname ? result.pathname : '') +</span>
<a href="#l10.677"></a><span id="l10.677" class="difflineplus">+                  (result.search ? result.search : '');</span>
<a href="#l10.678"></a><span id="l10.678" class="difflineplus">+  }</span>
<a href="#l10.679"></a><span id="l10.679" class="difflineplus">+  result.auth = relative.auth || result.auth;</span>
<a href="#l10.680"></a><span id="l10.680" class="difflineplus">+  result.slashes = result.slashes || relative.slashes;</span>
<a href="#l10.681"></a><span id="l10.681" class="difflineplus">+  result.href = result.format();</span>
<a href="#l10.682"></a><span id="l10.682" class="difflineplus">+  return result;</span>
<a href="#l10.683"></a><span id="l10.683" class="difflineplus">+};</span>
<a href="#l10.684"></a><span id="l10.684" class="difflineplus">+</span>
<a href="#l10.685"></a><span id="l10.685" class="difflineplus">+Url.prototype.parseHost = function() {</span>
<a href="#l10.686"></a><span id="l10.686" class="difflineplus">+  var host = this.host;</span>
<a href="#l10.687"></a><span id="l10.687" class="difflineplus">+  var port = portPattern.exec(host);</span>
<a href="#l10.688"></a><span id="l10.688" class="difflineplus">+  if (port) {</span>
<a href="#l10.689"></a><span id="l10.689" class="difflineplus">+    port = port[0];</span>
<a href="#l10.690"></a><span id="l10.690" class="difflineplus">+    if (port !== ':') {</span>
<a href="#l10.691"></a><span id="l10.691" class="difflineplus">+      this.port = port.substr(1);</span>
<a href="#l10.692"></a><span id="l10.692" class="difflineplus">+    }</span>
<a href="#l10.693"></a><span id="l10.693" class="difflineplus">+    host = host.substr(0, host.length - port.length);</span>
<a href="#l10.694"></a><span id="l10.694" class="difflineplus">+  }</span>
<a href="#l10.695"></a><span id="l10.695" class="difflineplus">+  if (host) this.hostname = host;</span>
<a href="#l10.696"></a><span id="l10.696" class="difflineplus">+};</span>
<a href="#l10.697"></a><span id="l10.697" class="difflineplus">+</span>
<a href="#l10.698"></a><span id="l10.698" class="difflineplus">+function isString(arg) {</span>
<a href="#l10.699"></a><span id="l10.699" class="difflineplus">+  return typeof arg === &quot;string&quot;;</span>
<a href="#l10.700"></a><span id="l10.700" class="difflineplus">+}</span>
<a href="#l10.701"></a><span id="l10.701" class="difflineplus">+</span>
<a href="#l10.702"></a><span id="l10.702" class="difflineplus">+function isObject(arg) {</span>
<a href="#l10.703"></a><span id="l10.703" class="difflineplus">+  return typeof arg === 'object' &amp;&amp; arg !== null;</span>
<a href="#l10.704"></a><span id="l10.704" class="difflineplus">+}</span>
<a href="#l10.705"></a><span id="l10.705" class="difflineplus">+</span>
<a href="#l10.706"></a><span id="l10.706" class="difflineplus">+function isNull(arg) {</span>
<a href="#l10.707"></a><span id="l10.707" class="difflineplus">+  return arg === null;</span>
<a href="#l10.708"></a><span id="l10.708" class="difflineplus">+}</span>
<a href="#l10.709"></a><span id="l10.709" class="difflineplus">+function isNullOrUndefined(arg) {</span>
<a href="#l10.710"></a><span id="l10.710" class="difflineplus">+  return  arg == null;</span>
<a href="#l10.711"></a><span id="l10.711" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1">new file mode 100644</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineminus">--- /dev/null</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineplus">+++ b/chat/protocols/matrix/matrix-sdk/client.js</span>
<a href="#l11.4"></a><span id="l11.4" class="difflineat">@@ -0,0 +1,3132 @@</span>
<a href="#l11.5"></a><span id="l11.5" class="difflineplus">+/*</span>
<a href="#l11.6"></a><span id="l11.6" class="difflineplus">+Copyright 2015, 2016 OpenMarket Ltd</span>
<a href="#l11.7"></a><span id="l11.7" class="difflineplus">+</span>
<a href="#l11.8"></a><span id="l11.8" class="difflineplus">+Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<a href="#l11.9"></a><span id="l11.9" class="difflineplus">+you may not use this file except in compliance with the License.</span>
<a href="#l11.10"></a><span id="l11.10" class="difflineplus">+You may obtain a copy of the License at</span>
<a href="#l11.11"></a><span id="l11.11" class="difflineplus">+</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineplus">+    http://www.apache.org/licenses/LICENSE-2.0</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineplus">+Unless required by applicable law or agreed to in writing, software</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineplus">+distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<a href="#l11.16"></a><span id="l11.16" class="difflineplus">+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<a href="#l11.17"></a><span id="l11.17" class="difflineplus">+See the License for the specific language governing permissions and</span>
<a href="#l11.18"></a><span id="l11.18" class="difflineplus">+limitations under the License.</span>
<a href="#l11.19"></a><span id="l11.19" class="difflineplus">+*/</span>
<a href="#l11.20"></a><span id="l11.20" class="difflineplus">+&quot;use strict&quot;;</span>
<a href="#l11.21"></a><span id="l11.21" class="difflineplus">+</span>
<a href="#l11.22"></a><span id="l11.22" class="difflineplus">+var PushProcessor = require('./pushprocessor');</span>
<a href="#l11.23"></a><span id="l11.23" class="difflineplus">+</span>
<a href="#l11.24"></a><span id="l11.24" class="difflineplus">+/**</span>
<a href="#l11.25"></a><span id="l11.25" class="difflineplus">+ * This is an internal module. See {@link MatrixClient} for the public class.</span>
<a href="#l11.26"></a><span id="l11.26" class="difflineplus">+ * @module client</span>
<a href="#l11.27"></a><span id="l11.27" class="difflineplus">+ */</span>
<a href="#l11.28"></a><span id="l11.28" class="difflineplus">+var EventEmitter = require(&quot;events&quot;).EventEmitter;</span>
<a href="#l11.29"></a><span id="l11.29" class="difflineplus">+var q = require(&quot;q&quot;);</span>
<a href="#l11.30"></a><span id="l11.30" class="difflineplus">+var url = require('url');</span>
<a href="#l11.31"></a><span id="l11.31" class="difflineplus">+</span>
<a href="#l11.32"></a><span id="l11.32" class="difflineplus">+var httpApi = require(&quot;./http-api&quot;);</span>
<a href="#l11.33"></a><span id="l11.33" class="difflineplus">+var MatrixEvent = require(&quot;./models/event&quot;).MatrixEvent;</span>
<a href="#l11.34"></a><span id="l11.34" class="difflineplus">+var EventStatus = require(&quot;./models/event&quot;).EventStatus;</span>
<a href="#l11.35"></a><span id="l11.35" class="difflineplus">+var EventTimeline = require(&quot;./models/event-timeline&quot;);</span>
<a href="#l11.36"></a><span id="l11.36" class="difflineplus">+var SearchResult = require(&quot;./models/search-result&quot;);</span>
<a href="#l11.37"></a><span id="l11.37" class="difflineplus">+var StubStore = require(&quot;./store/stub&quot;);</span>
<a href="#l11.38"></a><span id="l11.38" class="difflineplus">+var webRtcCall = require(&quot;./webrtc/call&quot;);</span>
<a href="#l11.39"></a><span id="l11.39" class="difflineplus">+var utils = require(&quot;./utils&quot;);</span>
<a href="#l11.40"></a><span id="l11.40" class="difflineplus">+var contentRepo = require(&quot;./content-repo&quot;);</span>
<a href="#l11.41"></a><span id="l11.41" class="difflineplus">+var Filter = require(&quot;./filter&quot;);</span>
<a href="#l11.42"></a><span id="l11.42" class="difflineplus">+var SyncApi = require(&quot;./sync&quot;);</span>
<a href="#l11.43"></a><span id="l11.43" class="difflineplus">+var MatrixBaseApis = require(&quot;./base-apis&quot;);</span>
<a href="#l11.44"></a><span id="l11.44" class="difflineplus">+var MatrixError = httpApi.MatrixError;</span>
<a href="#l11.45"></a><span id="l11.45" class="difflineplus">+</span>
<a href="#l11.46"></a><span id="l11.46" class="difflineplus">+var SCROLLBACK_DELAY_MS = 3000;</span>
<a href="#l11.47"></a><span id="l11.47" class="difflineplus">+var CRYPTO_ENABLED = false;</span>
<a href="#l11.48"></a><span id="l11.48" class="difflineplus">+</span>
<a href="#l11.49"></a><span id="l11.49" class="difflineplus">+try {</span>
<a href="#l11.50"></a><span id="l11.50" class="difflineplus">+    var Crypto = require(&quot;./crypto&quot;);</span>
<a href="#l11.51"></a><span id="l11.51" class="difflineplus">+    CRYPTO_ENABLED = true;</span>
<a href="#l11.52"></a><span id="l11.52" class="difflineplus">+} catch (e) {</span>
<a href="#l11.53"></a><span id="l11.53" class="difflineplus">+    console.error(&quot;olm load error&quot;, e);</span>
<a href="#l11.54"></a><span id="l11.54" class="difflineplus">+    // Olm not installed.</span>
<a href="#l11.55"></a><span id="l11.55" class="difflineplus">+}</span>
<a href="#l11.56"></a><span id="l11.56" class="difflineplus">+</span>
<a href="#l11.57"></a><span id="l11.57" class="difflineplus">+/**</span>
<a href="#l11.58"></a><span id="l11.58" class="difflineplus">+ * Construct a Matrix Client. Only directly construct this if you want to use</span>
<a href="#l11.59"></a><span id="l11.59" class="difflineplus">+ * custom modules. Normally, {@link createClient} should be used</span>
<a href="#l11.60"></a><span id="l11.60" class="difflineplus">+ * as it specifies 'sensible' defaults for these modules.</span>
<a href="#l11.61"></a><span id="l11.61" class="difflineplus">+ * @constructor</span>
<a href="#l11.62"></a><span id="l11.62" class="difflineplus">+ * @extends {external:EventEmitter}</span>
<a href="#l11.63"></a><span id="l11.63" class="difflineplus">+ * @extends {module:base-apis~MatrixBaseApis}</span>
<a href="#l11.64"></a><span id="l11.64" class="difflineplus">+ *</span>
<a href="#l11.65"></a><span id="l11.65" class="difflineplus">+ * @param {Object} opts The configuration options for this client.</span>
<a href="#l11.66"></a><span id="l11.66" class="difflineplus">+ * @param {string} opts.baseUrl Required. The base URL to the client-server</span>
<a href="#l11.67"></a><span id="l11.67" class="difflineplus">+ * HTTP API.</span>
<a href="#l11.68"></a><span id="l11.68" class="difflineplus">+ * @param {string} opts.idBaseUrl Optional. The base identity server URL for</span>
<a href="#l11.69"></a><span id="l11.69" class="difflineplus">+ * identity server requests.</span>
<a href="#l11.70"></a><span id="l11.70" class="difflineplus">+ * @param {Function} opts.request Required. The function to invoke for HTTP</span>
<a href="#l11.71"></a><span id="l11.71" class="difflineplus">+ * requests. The value of this property is typically &lt;code&gt;require(&quot;request&quot;)</span>
<a href="#l11.72"></a><span id="l11.72" class="difflineplus">+ * &lt;/code&gt; as it returns a function which meets the required interface. See</span>
<a href="#l11.73"></a><span id="l11.73" class="difflineplus">+ * {@link requestFunction} for more information.</span>
<a href="#l11.74"></a><span id="l11.74" class="difflineplus">+ *</span>
<a href="#l11.75"></a><span id="l11.75" class="difflineplus">+ * @param {string} opts.accessToken The access_token for this user.</span>
<a href="#l11.76"></a><span id="l11.76" class="difflineplus">+ *</span>
<a href="#l11.77"></a><span id="l11.77" class="difflineplus">+ * @param {string} opts.userId The user ID for this user.</span>
<a href="#l11.78"></a><span id="l11.78" class="difflineplus">+ *</span>
<a href="#l11.79"></a><span id="l11.79" class="difflineplus">+ * @param {Object=} opts.store The data store to use. If not specified,</span>
<a href="#l11.80"></a><span id="l11.80" class="difflineplus">+ * this client will not store any HTTP responses.</span>
<a href="#l11.81"></a><span id="l11.81" class="difflineplus">+ *</span>
<a href="#l11.82"></a><span id="l11.82" class="difflineplus">+ * @param {string=} opts.deviceId A unique identifier for this device; used for</span>
<a href="#l11.83"></a><span id="l11.83" class="difflineplus">+ *    tracking things like crypto keys and access tokens.  If not specified,</span>
<a href="#l11.84"></a><span id="l11.84" class="difflineplus">+ *    end-to-end crypto will be disabled.</span>
<a href="#l11.85"></a><span id="l11.85" class="difflineplus">+ *</span>
<a href="#l11.86"></a><span id="l11.86" class="difflineplus">+ * @param {Object=} opts.sessionStore A store to be used for end-to-end crypto</span>
<a href="#l11.87"></a><span id="l11.87" class="difflineplus">+ *    session data. This should be a {@link</span>
<a href="#l11.88"></a><span id="l11.88" class="difflineplus">+ *    module:store/session/webstorage~WebStorageSessionStore|WebStorageSessionStore},</span>
<a href="#l11.89"></a><span id="l11.89" class="difflineplus">+ *    or an object implementing the same interface. If not specified,</span>
<a href="#l11.90"></a><span id="l11.90" class="difflineplus">+ *    end-to-end crypto will be disabled.</span>
<a href="#l11.91"></a><span id="l11.91" class="difflineplus">+ *</span>
<a href="#l11.92"></a><span id="l11.92" class="difflineplus">+ * @param {Object} opts.scheduler Optional. The scheduler to use. If not</span>
<a href="#l11.93"></a><span id="l11.93" class="difflineplus">+ * specified, this client will not retry requests on failure. This client</span>
<a href="#l11.94"></a><span id="l11.94" class="difflineplus">+ * will supply its own processing function to</span>
<a href="#l11.95"></a><span id="l11.95" class="difflineplus">+ * {@link module:scheduler~MatrixScheduler#setProcessFunction}.</span>
<a href="#l11.96"></a><span id="l11.96" class="difflineplus">+ *</span>
<a href="#l11.97"></a><span id="l11.97" class="difflineplus">+ * @param {Object} opts.queryParams Optional. Extra query parameters to append</span>
<a href="#l11.98"></a><span id="l11.98" class="difflineplus">+ * to all requests with this client. Useful for application services which require</span>
<a href="#l11.99"></a><span id="l11.99" class="difflineplus">+ * &lt;code&gt;?user_id=&lt;/code&gt;.</span>
<a href="#l11.100"></a><span id="l11.100" class="difflineplus">+ *</span>
<a href="#l11.101"></a><span id="l11.101" class="difflineplus">+ * @param {boolean} [opts.timelineSupport = false] Set to true to enable</span>
<a href="#l11.102"></a><span id="l11.102" class="difflineplus">+ * improved timeline support ({@link</span>
<a href="#l11.103"></a><span id="l11.103" class="difflineplus">+ * module:client~MatrixClient#getEventTimeline getEventTimeline}). It is</span>
<a href="#l11.104"></a><span id="l11.104" class="difflineplus">+ * disabled by default for compatibility with older clients - in particular to</span>
<a href="#l11.105"></a><span id="l11.105" class="difflineplus">+ * maintain support for back-paginating the live timeline after a '/sync'</span>
<a href="#l11.106"></a><span id="l11.106" class="difflineplus">+ * result with a gap.</span>
<a href="#l11.107"></a><span id="l11.107" class="difflineplus">+ */</span>
<a href="#l11.108"></a><span id="l11.108" class="difflineplus">+function MatrixClient(opts) {</span>
<a href="#l11.109"></a><span id="l11.109" class="difflineplus">+    MatrixBaseApis.call(this, opts);</span>
<a href="#l11.110"></a><span id="l11.110" class="difflineplus">+</span>
<a href="#l11.111"></a><span id="l11.111" class="difflineplus">+    this.store = opts.store || new StubStore();</span>
<a href="#l11.112"></a><span id="l11.112" class="difflineplus">+</span>
<a href="#l11.113"></a><span id="l11.113" class="difflineplus">+    this.deviceId = opts.deviceId || null;</span>
<a href="#l11.114"></a><span id="l11.114" class="difflineplus">+</span>
<a href="#l11.115"></a><span id="l11.115" class="difflineplus">+    var userId = (opts.userId || null);</span>
<a href="#l11.116"></a><span id="l11.116" class="difflineplus">+    this.credentials = {</span>
<a href="#l11.117"></a><span id="l11.117" class="difflineplus">+        userId: userId,</span>
<a href="#l11.118"></a><span id="l11.118" class="difflineplus">+    };</span>
<a href="#l11.119"></a><span id="l11.119" class="difflineplus">+</span>
<a href="#l11.120"></a><span id="l11.120" class="difflineplus">+    this.scheduler = opts.scheduler;</span>
<a href="#l11.121"></a><span id="l11.121" class="difflineplus">+    if (this.scheduler) {</span>
<a href="#l11.122"></a><span id="l11.122" class="difflineplus">+        var self = this;</span>
<a href="#l11.123"></a><span id="l11.123" class="difflineplus">+        this.scheduler.setProcessFunction(function(eventToSend) {</span>
<a href="#l11.124"></a><span id="l11.124" class="difflineplus">+            var room = self.getRoom(eventToSend.getRoomId());</span>
<a href="#l11.125"></a><span id="l11.125" class="difflineplus">+            if (eventToSend.status !== EventStatus.SENDING) {</span>
<a href="#l11.126"></a><span id="l11.126" class="difflineplus">+                _updatePendingEventStatus(room, eventToSend,</span>
<a href="#l11.127"></a><span id="l11.127" class="difflineplus">+                                          EventStatus.SENDING);</span>
<a href="#l11.128"></a><span id="l11.128" class="difflineplus">+            }</span>
<a href="#l11.129"></a><span id="l11.129" class="difflineplus">+            return _sendEventHttpRequest(self, eventToSend);</span>
<a href="#l11.130"></a><span id="l11.130" class="difflineplus">+        });</span>
<a href="#l11.131"></a><span id="l11.131" class="difflineplus">+    }</span>
<a href="#l11.132"></a><span id="l11.132" class="difflineplus">+    this.clientRunning = false;</span>
<a href="#l11.133"></a><span id="l11.133" class="difflineplus">+</span>
<a href="#l11.134"></a><span id="l11.134" class="difflineplus">+    this.callList = {</span>
<a href="#l11.135"></a><span id="l11.135" class="difflineplus">+        // callId: MatrixCall</span>
<a href="#l11.136"></a><span id="l11.136" class="difflineplus">+    };</span>
<a href="#l11.137"></a><span id="l11.137" class="difflineplus">+</span>
<a href="#l11.138"></a><span id="l11.138" class="difflineplus">+    // try constructing a MatrixCall to see if we are running in an environment</span>
<a href="#l11.139"></a><span id="l11.139" class="difflineplus">+    // which has WebRTC. If we are, listen for and handle m.call.* events.</span>
<a href="#l11.140"></a><span id="l11.140" class="difflineplus">+    var call = webRtcCall.createNewMatrixCall(this);</span>
<a href="#l11.141"></a><span id="l11.141" class="difflineplus">+    this._supportsVoip = false;</span>
<a href="#l11.142"></a><span id="l11.142" class="difflineplus">+    if (call) {</span>
<a href="#l11.143"></a><span id="l11.143" class="difflineplus">+        setupCallEventHandler(this);</span>
<a href="#l11.144"></a><span id="l11.144" class="difflineplus">+        this._supportsVoip = true;</span>
<a href="#l11.145"></a><span id="l11.145" class="difflineplus">+    }</span>
<a href="#l11.146"></a><span id="l11.146" class="difflineplus">+    this._syncingRetry = null;</span>
<a href="#l11.147"></a><span id="l11.147" class="difflineplus">+    this._syncApi = null;</span>
<a href="#l11.148"></a><span id="l11.148" class="difflineplus">+    this._peekSync = null;</span>
<a href="#l11.149"></a><span id="l11.149" class="difflineplus">+    this._isGuest = false;</span>
<a href="#l11.150"></a><span id="l11.150" class="difflineplus">+    this._ongoingScrollbacks = {};</span>
<a href="#l11.151"></a><span id="l11.151" class="difflineplus">+    this.timelineSupport = Boolean(opts.timelineSupport);</span>
<a href="#l11.152"></a><span id="l11.152" class="difflineplus">+    this.urlPreviewCache = {};</span>
<a href="#l11.153"></a><span id="l11.153" class="difflineplus">+    this._notifTimelineSet = null;</span>
<a href="#l11.154"></a><span id="l11.154" class="difflineplus">+</span>
<a href="#l11.155"></a><span id="l11.155" class="difflineplus">+    this._crypto = null;</span>
<a href="#l11.156"></a><span id="l11.156" class="difflineplus">+    if (CRYPTO_ENABLED &amp;&amp; opts.sessionStore !== null &amp;&amp;</span>
<a href="#l11.157"></a><span id="l11.157" class="difflineplus">+            userId !== null &amp;&amp; this.deviceId !== null) {</span>
<a href="#l11.158"></a><span id="l11.158" class="difflineplus">+        this._crypto = new Crypto(</span>
<a href="#l11.159"></a><span id="l11.159" class="difflineplus">+            this, this,</span>
<a href="#l11.160"></a><span id="l11.160" class="difflineplus">+            opts.sessionStore,</span>
<a href="#l11.161"></a><span id="l11.161" class="difflineplus">+            userId, this.deviceId</span>
<a href="#l11.162"></a><span id="l11.162" class="difflineplus">+        );</span>
<a href="#l11.163"></a><span id="l11.163" class="difflineplus">+</span>
<a href="#l11.164"></a><span id="l11.164" class="difflineplus">+        this.olmVersion = Crypto.getOlmVersion();</span>
<a href="#l11.165"></a><span id="l11.165" class="difflineplus">+    }</span>
<a href="#l11.166"></a><span id="l11.166" class="difflineplus">+}</span>
<a href="#l11.167"></a><span id="l11.167" class="difflineplus">+utils.inherits(MatrixClient, EventEmitter);</span>
<a href="#l11.168"></a><span id="l11.168" class="difflineplus">+utils.extend(MatrixClient.prototype, MatrixBaseApis.prototype);</span>
<a href="#l11.169"></a><span id="l11.169" class="difflineplus">+</span>
<a href="#l11.170"></a><span id="l11.170" class="difflineplus">+/**</span>
<a href="#l11.171"></a><span id="l11.171" class="difflineplus">+ * Get the domain for this client's MXID</span>
<a href="#l11.172"></a><span id="l11.172" class="difflineplus">+ * @return {?string} Domain of this MXID</span>
<a href="#l11.173"></a><span id="l11.173" class="difflineplus">+ */</span>
<a href="#l11.174"></a><span id="l11.174" class="difflineplus">+MatrixClient.prototype.getDomain = function() {</span>
<a href="#l11.175"></a><span id="l11.175" class="difflineplus">+    if (this.credentials &amp;&amp; this.credentials.userId) {</span>
<a href="#l11.176"></a><span id="l11.176" class="difflineplus">+        return this.credentials.userId.replace(/^.*?:/, '');</span>
<a href="#l11.177"></a><span id="l11.177" class="difflineplus">+    }</span>
<a href="#l11.178"></a><span id="l11.178" class="difflineplus">+    return null;</span>
<a href="#l11.179"></a><span id="l11.179" class="difflineplus">+};</span>
<a href="#l11.180"></a><span id="l11.180" class="difflineplus">+</span>
<a href="#l11.181"></a><span id="l11.181" class="difflineplus">+/**</span>
<a href="#l11.182"></a><span id="l11.182" class="difflineplus">+ * Get the local part of the current user ID e.g. &quot;foo&quot; in &quot;@foo:bar&quot;.</span>
<a href="#l11.183"></a><span id="l11.183" class="difflineplus">+ * @return {?string} The user ID localpart or null.</span>
<a href="#l11.184"></a><span id="l11.184" class="difflineplus">+ */</span>
<a href="#l11.185"></a><span id="l11.185" class="difflineplus">+MatrixClient.prototype.getUserIdLocalpart = function() {</span>
<a href="#l11.186"></a><span id="l11.186" class="difflineplus">+    if (this.credentials &amp;&amp; this.credentials.userId) {</span>
<a href="#l11.187"></a><span id="l11.187" class="difflineplus">+        return this.credentials.userId.split(&quot;:&quot;)[0].substring(1);</span>
<a href="#l11.188"></a><span id="l11.188" class="difflineplus">+    }</span>
<a href="#l11.189"></a><span id="l11.189" class="difflineplus">+    return null;</span>
<a href="#l11.190"></a><span id="l11.190" class="difflineplus">+};</span>
<a href="#l11.191"></a><span id="l11.191" class="difflineplus">+</span>
<a href="#l11.192"></a><span id="l11.192" class="difflineplus">+/**</span>
<a href="#l11.193"></a><span id="l11.193" class="difflineplus">+ * Get the device ID of this client</span>
<a href="#l11.194"></a><span id="l11.194" class="difflineplus">+ * @return {?string} device ID</span>
<a href="#l11.195"></a><span id="l11.195" class="difflineplus">+ */</span>
<a href="#l11.196"></a><span id="l11.196" class="difflineplus">+MatrixClient.prototype.getDeviceId = function() {</span>
<a href="#l11.197"></a><span id="l11.197" class="difflineplus">+    return this.deviceId;</span>
<a href="#l11.198"></a><span id="l11.198" class="difflineplus">+};</span>
<a href="#l11.199"></a><span id="l11.199" class="difflineplus">+</span>
<a href="#l11.200"></a><span id="l11.200" class="difflineplus">+</span>
<a href="#l11.201"></a><span id="l11.201" class="difflineplus">+/**</span>
<a href="#l11.202"></a><span id="l11.202" class="difflineplus">+ * Check if the runtime environment supports VoIP calling.</span>
<a href="#l11.203"></a><span id="l11.203" class="difflineplus">+ * @return {boolean} True if VoIP is supported.</span>
<a href="#l11.204"></a><span id="l11.204" class="difflineplus">+ */</span>
<a href="#l11.205"></a><span id="l11.205" class="difflineplus">+MatrixClient.prototype.supportsVoip = function() {</span>
<a href="#l11.206"></a><span id="l11.206" class="difflineplus">+    return this._supportsVoip;</span>
<a href="#l11.207"></a><span id="l11.207" class="difflineplus">+};</span>
<a href="#l11.208"></a><span id="l11.208" class="difflineplus">+</span>
<a href="#l11.209"></a><span id="l11.209" class="difflineplus">+/**</span>
<a href="#l11.210"></a><span id="l11.210" class="difflineplus">+ * Get the current sync state.</span>
<a href="#l11.211"></a><span id="l11.211" class="difflineplus">+ * @return {?string} the sync state, which may be null.</span>
<a href="#l11.212"></a><span id="l11.212" class="difflineplus">+ * @see module:client~MatrixClient#event:&quot;sync&quot;</span>
<a href="#l11.213"></a><span id="l11.213" class="difflineplus">+ */</span>
<a href="#l11.214"></a><span id="l11.214" class="difflineplus">+MatrixClient.prototype.getSyncState = function() {</span>
<a href="#l11.215"></a><span id="l11.215" class="difflineplus">+    if (!this._syncApi) { return null; }</span>
<a href="#l11.216"></a><span id="l11.216" class="difflineplus">+    return this._syncApi.getSyncState();</span>
<a href="#l11.217"></a><span id="l11.217" class="difflineplus">+};</span>
<a href="#l11.218"></a><span id="l11.218" class="difflineplus">+</span>
<a href="#l11.219"></a><span id="l11.219" class="difflineplus">+/**</span>
<a href="#l11.220"></a><span id="l11.220" class="difflineplus">+ * Return whether the client is configured for a guest account.</span>
<a href="#l11.221"></a><span id="l11.221" class="difflineplus">+ * @return {boolean} True if this is a guest access_token (or no token is supplied).</span>
<a href="#l11.222"></a><span id="l11.222" class="difflineplus">+ */</span>
<a href="#l11.223"></a><span id="l11.223" class="difflineplus">+MatrixClient.prototype.isGuest = function() {</span>
<a href="#l11.224"></a><span id="l11.224" class="difflineplus">+    return this._isGuest;</span>
<a href="#l11.225"></a><span id="l11.225" class="difflineplus">+};</span>
<a href="#l11.226"></a><span id="l11.226" class="difflineplus">+</span>
<a href="#l11.227"></a><span id="l11.227" class="difflineplus">+/**</span>
<a href="#l11.228"></a><span id="l11.228" class="difflineplus">+ * Return the provided scheduler, if any.</span>
<a href="#l11.229"></a><span id="l11.229" class="difflineplus">+ * @return {?module:scheduler~MatrixScheduler} The scheduler or null</span>
<a href="#l11.230"></a><span id="l11.230" class="difflineplus">+ */</span>
<a href="#l11.231"></a><span id="l11.231" class="difflineplus">+MatrixClient.prototype.getScheduler = function() {</span>
<a href="#l11.232"></a><span id="l11.232" class="difflineplus">+    return this.scheduler;</span>
<a href="#l11.233"></a><span id="l11.233" class="difflineplus">+};</span>
<a href="#l11.234"></a><span id="l11.234" class="difflineplus">+</span>
<a href="#l11.235"></a><span id="l11.235" class="difflineplus">+/**</span>
<a href="#l11.236"></a><span id="l11.236" class="difflineplus">+ * Set whether this client is a guest account. &lt;b&gt;This method is experimental</span>
<a href="#l11.237"></a><span id="l11.237" class="difflineplus">+ * and may change without warning.&lt;/b&gt;</span>
<a href="#l11.238"></a><span id="l11.238" class="difflineplus">+ * @param {boolean} isGuest True if this is a guest account.</span>
<a href="#l11.239"></a><span id="l11.239" class="difflineplus">+ */</span>
<a href="#l11.240"></a><span id="l11.240" class="difflineplus">+MatrixClient.prototype.setGuest = function(isGuest) {</span>
<a href="#l11.241"></a><span id="l11.241" class="difflineplus">+    // EXPERIMENTAL:</span>
<a href="#l11.242"></a><span id="l11.242" class="difflineplus">+    // If the token is a macaroon, it should be encoded in it that it is a 'guest'</span>
<a href="#l11.243"></a><span id="l11.243" class="difflineplus">+    // access token, which means that the SDK can determine this entirely without</span>
<a href="#l11.244"></a><span id="l11.244" class="difflineplus">+    // the dev manually flipping this flag.</span>
<a href="#l11.245"></a><span id="l11.245" class="difflineplus">+    this._isGuest = isGuest;</span>
<a href="#l11.246"></a><span id="l11.246" class="difflineplus">+};</span>
<a href="#l11.247"></a><span id="l11.247" class="difflineplus">+</span>
<a href="#l11.248"></a><span id="l11.248" class="difflineplus">+/**</span>
<a href="#l11.249"></a><span id="l11.249" class="difflineplus">+ * Retry a backed off syncing request immediately. This should only be used when</span>
<a href="#l11.250"></a><span id="l11.250" class="difflineplus">+ * the user &lt;b&gt;explicitly&lt;/b&gt; attempts to retry their lost connection.</span>
<a href="#l11.251"></a><span id="l11.251" class="difflineplus">+ * @return {boolean} True if this resulted in a request being retried.</span>
<a href="#l11.252"></a><span id="l11.252" class="difflineplus">+ */</span>
<a href="#l11.253"></a><span id="l11.253" class="difflineplus">+MatrixClient.prototype.retryImmediately = function() {</span>
<a href="#l11.254"></a><span id="l11.254" class="difflineplus">+    return this._syncApi.retryImmediately();</span>
<a href="#l11.255"></a><span id="l11.255" class="difflineplus">+};</span>
<a href="#l11.256"></a><span id="l11.256" class="difflineplus">+</span>
<a href="#l11.257"></a><span id="l11.257" class="difflineplus">+/**</span>
<a href="#l11.258"></a><span id="l11.258" class="difflineplus">+ * Return the global notification EventTimelineSet, if any</span>
<a href="#l11.259"></a><span id="l11.259" class="difflineplus">+ *</span>
<a href="#l11.260"></a><span id="l11.260" class="difflineplus">+ * @return {EventTimelineSet} the globl notification EventTimelineSet</span>
<a href="#l11.261"></a><span id="l11.261" class="difflineplus">+ */</span>
<a href="#l11.262"></a><span id="l11.262" class="difflineplus">+MatrixClient.prototype.getNotifTimelineSet = function() {</span>
<a href="#l11.263"></a><span id="l11.263" class="difflineplus">+    return this._notifTimelineSet;</span>
<a href="#l11.264"></a><span id="l11.264" class="difflineplus">+};</span>
<a href="#l11.265"></a><span id="l11.265" class="difflineplus">+</span>
<a href="#l11.266"></a><span id="l11.266" class="difflineplus">+/**</span>
<a href="#l11.267"></a><span id="l11.267" class="difflineplus">+ * Set the global notification EventTimelineSet</span>
<a href="#l11.268"></a><span id="l11.268" class="difflineplus">+ *</span>
<a href="#l11.269"></a><span id="l11.269" class="difflineplus">+ * @param {EventTimelineSet} notifTimelineSet</span>
<a href="#l11.270"></a><span id="l11.270" class="difflineplus">+ */</span>
<a href="#l11.271"></a><span id="l11.271" class="difflineplus">+MatrixClient.prototype.setNotifTimelineSet = function(notifTimelineSet) {</span>
<a href="#l11.272"></a><span id="l11.272" class="difflineplus">+    this._notifTimelineSet = notifTimelineSet;</span>
<a href="#l11.273"></a><span id="l11.273" class="difflineplus">+};</span>
<a href="#l11.274"></a><span id="l11.274" class="difflineplus">+</span>
<a href="#l11.275"></a><span id="l11.275" class="difflineplus">+// Crypto bits</span>
<a href="#l11.276"></a><span id="l11.276" class="difflineplus">+// ===========</span>
<a href="#l11.277"></a><span id="l11.277" class="difflineplus">+</span>
<a href="#l11.278"></a><span id="l11.278" class="difflineplus">+/**</span>
<a href="#l11.279"></a><span id="l11.279" class="difflineplus">+ * Is end-to-end crypto enabled for this client.</span>
<a href="#l11.280"></a><span id="l11.280" class="difflineplus">+ * @return {boolean} True if end-to-end is enabled.</span>
<a href="#l11.281"></a><span id="l11.281" class="difflineplus">+ */</span>
<a href="#l11.282"></a><span id="l11.282" class="difflineplus">+MatrixClient.prototype.isCryptoEnabled = function() {</span>
<a href="#l11.283"></a><span id="l11.283" class="difflineplus">+    return this._crypto !== null;</span>
<a href="#l11.284"></a><span id="l11.284" class="difflineplus">+};</span>
<a href="#l11.285"></a><span id="l11.285" class="difflineplus">+</span>
<a href="#l11.286"></a><span id="l11.286" class="difflineplus">+</span>
<a href="#l11.287"></a><span id="l11.287" class="difflineplus">+/**</span>
<a href="#l11.288"></a><span id="l11.288" class="difflineplus">+ * Get the Ed25519 key for this device</span>
<a href="#l11.289"></a><span id="l11.289" class="difflineplus">+ *</span>
<a href="#l11.290"></a><span id="l11.290" class="difflineplus">+ * @return {?string} base64-encoded ed25519 key. Null if crypto is</span>
<a href="#l11.291"></a><span id="l11.291" class="difflineplus">+ *    disabled.</span>
<a href="#l11.292"></a><span id="l11.292" class="difflineplus">+ */</span>
<a href="#l11.293"></a><span id="l11.293" class="difflineplus">+MatrixClient.prototype.getDeviceEd25519Key = function() {</span>
<a href="#l11.294"></a><span id="l11.294" class="difflineplus">+    if (!this._crypto) {</span>
<a href="#l11.295"></a><span id="l11.295" class="difflineplus">+        return null;</span>
<a href="#l11.296"></a><span id="l11.296" class="difflineplus">+    }</span>
<a href="#l11.297"></a><span id="l11.297" class="difflineplus">+    return this._crypto.getDeviceEd25519Key();</span>
<a href="#l11.298"></a><span id="l11.298" class="difflineplus">+};</span>
<a href="#l11.299"></a><span id="l11.299" class="difflineplus">+</span>
<a href="#l11.300"></a><span id="l11.300" class="difflineplus">+/**</span>
<a href="#l11.301"></a><span id="l11.301" class="difflineplus">+ * Upload the device keys to the homeserver and ensure that the</span>
<a href="#l11.302"></a><span id="l11.302" class="difflineplus">+ * homeserver has enough one-time keys.</span>
<a href="#l11.303"></a><span id="l11.303" class="difflineplus">+ * @param {number} maxKeys The maximum number of keys to generate</span>
<a href="#l11.304"></a><span id="l11.304" class="difflineplus">+ * @return {object} A promise that will resolve when the keys are uploaded.</span>
<a href="#l11.305"></a><span id="l11.305" class="difflineplus">+ */</span>
<a href="#l11.306"></a><span id="l11.306" class="difflineplus">+MatrixClient.prototype.uploadKeys = function(maxKeys) {</span>
<a href="#l11.307"></a><span id="l11.307" class="difflineplus">+    if (this._crypto === null) {</span>
<a href="#l11.308"></a><span id="l11.308" class="difflineplus">+        throw new Error(&quot;End-to-end encryption disabled&quot;);</span>
<a href="#l11.309"></a><span id="l11.309" class="difflineplus">+    }</span>
<a href="#l11.310"></a><span id="l11.310" class="difflineplus">+</span>
<a href="#l11.311"></a><span id="l11.311" class="difflineplus">+    return this._crypto.uploadKeys(maxKeys);</span>
<a href="#l11.312"></a><span id="l11.312" class="difflineplus">+};</span>
<a href="#l11.313"></a><span id="l11.313" class="difflineplus">+</span>
<a href="#l11.314"></a><span id="l11.314" class="difflineplus">+/**</span>
<a href="#l11.315"></a><span id="l11.315" class="difflineplus">+ * Download the keys for a list of users and stores the keys in the session</span>
<a href="#l11.316"></a><span id="l11.316" class="difflineplus">+ * store.</span>
<a href="#l11.317"></a><span id="l11.317" class="difflineplus">+ * @param {Array} userIds The users to fetch.</span>
<a href="#l11.318"></a><span id="l11.318" class="difflineplus">+ * @param {bool} forceDownload Always download the keys even if cached.</span>
<a href="#l11.319"></a><span id="l11.319" class="difflineplus">+ *</span>
<a href="#l11.320"></a><span id="l11.320" class="difflineplus">+ * @return {Promise} A promise which resolves to a map userId-&gt;deviceId-&gt;{@link</span>
<a href="#l11.321"></a><span id="l11.321" class="difflineplus">+ * module:crypto~DeviceInfo|DeviceInfo}.</span>
<a href="#l11.322"></a><span id="l11.322" class="difflineplus">+ */</span>
<a href="#l11.323"></a><span id="l11.323" class="difflineplus">+MatrixClient.prototype.downloadKeys = function(userIds, forceDownload) {</span>
<a href="#l11.324"></a><span id="l11.324" class="difflineplus">+    if (this._crypto === null) {</span>
<a href="#l11.325"></a><span id="l11.325" class="difflineplus">+        return q.reject(new Error(&quot;End-to-end encryption disabled&quot;));</span>
<a href="#l11.326"></a><span id="l11.326" class="difflineplus">+    }</span>
<a href="#l11.327"></a><span id="l11.327" class="difflineplus">+    return this._crypto.downloadKeys(userIds, forceDownload);</span>
<a href="#l11.328"></a><span id="l11.328" class="difflineplus">+};</span>
<a href="#l11.329"></a><span id="l11.329" class="difflineplus">+</span>
<a href="#l11.330"></a><span id="l11.330" class="difflineplus">+/**</span>
<a href="#l11.331"></a><span id="l11.331" class="difflineplus">+ * List the stored device keys for a user id</span>
<a href="#l11.332"></a><span id="l11.332" class="difflineplus">+ *</span>
<a href="#l11.333"></a><span id="l11.333" class="difflineplus">+ * @deprecated prefer {@link module:client#getStoredDevicesForUser}</span>
<a href="#l11.334"></a><span id="l11.334" class="difflineplus">+ *</span>
<a href="#l11.335"></a><span id="l11.335" class="difflineplus">+ * @param {string} userId the user to list keys for.</span>
<a href="#l11.336"></a><span id="l11.336" class="difflineplus">+ *</span>
<a href="#l11.337"></a><span id="l11.337" class="difflineplus">+ * @return {object[]} list of devices with &quot;id&quot;, &quot;verified&quot;, &quot;blocked&quot;,</span>
<a href="#l11.338"></a><span id="l11.338" class="difflineplus">+ *    &quot;key&quot;, and &quot;display_name&quot; parameters.</span>
<a href="#l11.339"></a><span id="l11.339" class="difflineplus">+ */</span>
<a href="#l11.340"></a><span id="l11.340" class="difflineplus">+MatrixClient.prototype.listDeviceKeys = function(userId) {</span>
<a href="#l11.341"></a><span id="l11.341" class="difflineplus">+    if (this._crypto === null) {</span>
<a href="#l11.342"></a><span id="l11.342" class="difflineplus">+        throw new Error(&quot;End-to-end encryption disabled&quot;);</span>
<a href="#l11.343"></a><span id="l11.343" class="difflineplus">+    }</span>
<a href="#l11.344"></a><span id="l11.344" class="difflineplus">+    return this._crypto.listDeviceKeys(userId);</span>
<a href="#l11.345"></a><span id="l11.345" class="difflineplus">+};</span>
<a href="#l11.346"></a><span id="l11.346" class="difflineplus">+</span>
<a href="#l11.347"></a><span id="l11.347" class="difflineplus">+/**</span>
<a href="#l11.348"></a><span id="l11.348" class="difflineplus">+ * Get the stored device keys for a user id</span>
<a href="#l11.349"></a><span id="l11.349" class="difflineplus">+ *</span>
<a href="#l11.350"></a><span id="l11.350" class="difflineplus">+ * @param {string} userId the user to list keys for.</span>
<a href="#l11.351"></a><span id="l11.351" class="difflineplus">+ *</span>
<a href="#l11.352"></a><span id="l11.352" class="difflineplus">+ * @return {module:crypto-deviceinfo[]} list of devices</span>
<a href="#l11.353"></a><span id="l11.353" class="difflineplus">+ */</span>
<a href="#l11.354"></a><span id="l11.354" class="difflineplus">+MatrixClient.prototype.getStoredDevicesForUser = function(userId) {</span>
<a href="#l11.355"></a><span id="l11.355" class="difflineplus">+    if (this._crypto === null) {</span>
<a href="#l11.356"></a><span id="l11.356" class="difflineplus">+        throw new Error(&quot;End-to-end encryption disabled&quot;);</span>
<a href="#l11.357"></a><span id="l11.357" class="difflineplus">+    }</span>
<a href="#l11.358"></a><span id="l11.358" class="difflineplus">+    return this._crypto.getStoredDevicesForUser(userId) || [];</span>
<a href="#l11.359"></a><span id="l11.359" class="difflineplus">+};</span>
<a href="#l11.360"></a><span id="l11.360" class="difflineplus">+</span>
<a href="#l11.361"></a><span id="l11.361" class="difflineplus">+</span>
<a href="#l11.362"></a><span id="l11.362" class="difflineplus">+</span>
<a href="#l11.363"></a><span id="l11.363" class="difflineplus">+/**</span>
<a href="#l11.364"></a><span id="l11.364" class="difflineplus">+ * Mark the given device as verified</span>
<a href="#l11.365"></a><span id="l11.365" class="difflineplus">+ *</span>
<a href="#l11.366"></a><span id="l11.366" class="difflineplus">+ * @param {string} userId owner of the device</span>
<a href="#l11.367"></a><span id="l11.367" class="difflineplus">+ * @param {string} deviceId unique identifier for the device</span>
<a href="#l11.368"></a><span id="l11.368" class="difflineplus">+ *</span>
<a href="#l11.369"></a><span id="l11.369" class="difflineplus">+ * @param {boolean=} verified whether to mark the device as verified. defaults</span>
<a href="#l11.370"></a><span id="l11.370" class="difflineplus">+ *   to 'true'.</span>
<a href="#l11.371"></a><span id="l11.371" class="difflineplus">+ *</span>
<a href="#l11.372"></a><span id="l11.372" class="difflineplus">+ * @fires module:client~event:MatrixClient&quot;deviceVerificationChanged&quot;</span>
<a href="#l11.373"></a><span id="l11.373" class="difflineplus">+ */</span>
<a href="#l11.374"></a><span id="l11.374" class="difflineplus">+MatrixClient.prototype.setDeviceVerified = function(userId, deviceId, verified) {</span>
<a href="#l11.375"></a><span id="l11.375" class="difflineplus">+    if (verified === undefined) {</span>
<a href="#l11.376"></a><span id="l11.376" class="difflineplus">+        verified = true;</span>
<a href="#l11.377"></a><span id="l11.377" class="difflineplus">+    }</span>
<a href="#l11.378"></a><span id="l11.378" class="difflineplus">+    _setDeviceVerification(this, userId, deviceId, verified, null);</span>
<a href="#l11.379"></a><span id="l11.379" class="difflineplus">+};</span>
<a href="#l11.380"></a><span id="l11.380" class="difflineplus">+</span>
<a href="#l11.381"></a><span id="l11.381" class="difflineplus">+</span>
<a href="#l11.382"></a><span id="l11.382" class="difflineplus">+/**</span>
<a href="#l11.383"></a><span id="l11.383" class="difflineplus">+ * Mark the given device as blocked/unblocked</span>
<a href="#l11.384"></a><span id="l11.384" class="difflineplus">+ *</span>
<a href="#l11.385"></a><span id="l11.385" class="difflineplus">+ * @param {string} userId owner of the device</span>
<a href="#l11.386"></a><span id="l11.386" class="difflineplus">+ * @param {string} deviceId unique identifier for the device</span>
<a href="#l11.387"></a><span id="l11.387" class="difflineplus">+ *</span>
<a href="#l11.388"></a><span id="l11.388" class="difflineplus">+ * @param {boolean=} blocked whether to mark the device as blocked. defaults</span>
<a href="#l11.389"></a><span id="l11.389" class="difflineplus">+ *   to 'true'.</span>
<a href="#l11.390"></a><span id="l11.390" class="difflineplus">+ *</span>
<a href="#l11.391"></a><span id="l11.391" class="difflineplus">+ * @fires module:client~event:MatrixClient&quot;deviceVerificationChanged&quot;</span>
<a href="#l11.392"></a><span id="l11.392" class="difflineplus">+ */</span>
<a href="#l11.393"></a><span id="l11.393" class="difflineplus">+MatrixClient.prototype.setDeviceBlocked = function(userId, deviceId, blocked) {</span>
<a href="#l11.394"></a><span id="l11.394" class="difflineplus">+    if (blocked === undefined) {</span>
<a href="#l11.395"></a><span id="l11.395" class="difflineplus">+        blocked = true;</span>
<a href="#l11.396"></a><span id="l11.396" class="difflineplus">+    }</span>
<a href="#l11.397"></a><span id="l11.397" class="difflineplus">+    _setDeviceVerification(this, userId, deviceId, null, blocked);</span>
<a href="#l11.398"></a><span id="l11.398" class="difflineplus">+};</span>
<a href="#l11.399"></a><span id="l11.399" class="difflineplus">+</span>
<a href="#l11.400"></a><span id="l11.400" class="difflineplus">+function _setDeviceVerification(client, userId, deviceId, verified, blocked) {</span>
<a href="#l11.401"></a><span id="l11.401" class="difflineplus">+    if (!client._crypto) {</span>
<a href="#l11.402"></a><span id="l11.402" class="difflineplus">+        throw new Error(&quot;End-to-End encryption disabled&quot;);</span>
<a href="#l11.403"></a><span id="l11.403" class="difflineplus">+    }</span>
<a href="#l11.404"></a><span id="l11.404" class="difflineplus">+    client._crypto.setDeviceVerification(userId, deviceId, verified, blocked);</span>
<a href="#l11.405"></a><span id="l11.405" class="difflineplus">+    client.emit(&quot;deviceVerificationChanged&quot;, userId, deviceId);</span>
<a href="#l11.406"></a><span id="l11.406" class="difflineplus">+}</span>
<a href="#l11.407"></a><span id="l11.407" class="difflineplus">+</span>
<a href="#l11.408"></a><span id="l11.408" class="difflineplus">+/**</span>
<a href="#l11.409"></a><span id="l11.409" class="difflineplus">+ * Get e2e information on the device that sent an event</span>
<a href="#l11.410"></a><span id="l11.410" class="difflineplus">+ *</span>
<a href="#l11.411"></a><span id="l11.411" class="difflineplus">+ * @param {MatrixEvent} event event to be checked</span>
<a href="#l11.412"></a><span id="l11.412" class="difflineplus">+ *</span>
<a href="#l11.413"></a><span id="l11.413" class="difflineplus">+ * @return {module:crypto/deviceinfo?}</span>
<a href="#l11.414"></a><span id="l11.414" class="difflineplus">+ */</span>
<a href="#l11.415"></a><span id="l11.415" class="difflineplus">+MatrixClient.prototype.getEventSenderDeviceInfo = function(event) {</span>
<a href="#l11.416"></a><span id="l11.416" class="difflineplus">+    if (!this._crypto) {</span>
<a href="#l11.417"></a><span id="l11.417" class="difflineplus">+        return null;</span>
<a href="#l11.418"></a><span id="l11.418" class="difflineplus">+    }</span>
<a href="#l11.419"></a><span id="l11.419" class="difflineplus">+</span>
<a href="#l11.420"></a><span id="l11.420" class="difflineplus">+    return this._crypto.getEventSenderDeviceInfo(event);</span>
<a href="#l11.421"></a><span id="l11.421" class="difflineplus">+};</span>
<a href="#l11.422"></a><span id="l11.422" class="difflineplus">+</span>
<a href="#l11.423"></a><span id="l11.423" class="difflineplus">+/**</span>
<a href="#l11.424"></a><span id="l11.424" class="difflineplus">+ * Check if the sender of an event is verified</span>
<a href="#l11.425"></a><span id="l11.425" class="difflineplus">+ *</span>
<a href="#l11.426"></a><span id="l11.426" class="difflineplus">+ * @param {MatrixEvent} event event to be checked</span>
<a href="#l11.427"></a><span id="l11.427" class="difflineplus">+ *</span>
<a href="#l11.428"></a><span id="l11.428" class="difflineplus">+ * @return {boolean} true if the sender of this event has been verified using</span>
<a href="#l11.429"></a><span id="l11.429" class="difflineplus">+ * {@link module:client~MatrixClient#setDeviceVerified|setDeviceVerified}.</span>
<a href="#l11.430"></a><span id="l11.430" class="difflineplus">+ */</span>
<a href="#l11.431"></a><span id="l11.431" class="difflineplus">+MatrixClient.prototype.isEventSenderVerified = function(event) {</span>
<a href="#l11.432"></a><span id="l11.432" class="difflineplus">+    var device = this.getEventSenderDeviceInfo(event);</span>
<a href="#l11.433"></a><span id="l11.433" class="difflineplus">+    if (!device) {</span>
<a href="#l11.434"></a><span id="l11.434" class="difflineplus">+        return false;</span>
<a href="#l11.435"></a><span id="l11.435" class="difflineplus">+    }</span>
<a href="#l11.436"></a><span id="l11.436" class="difflineplus">+    return device.isVerified();</span>
<a href="#l11.437"></a><span id="l11.437" class="difflineplus">+};</span>
<a href="#l11.438"></a><span id="l11.438" class="difflineplus">+</span>
<a href="#l11.439"></a><span id="l11.439" class="difflineplus">+/**</span>
<a href="#l11.440"></a><span id="l11.440" class="difflineplus">+ * Enable end-to-end encryption for a room.</span>
<a href="#l11.441"></a><span id="l11.441" class="difflineplus">+ * @param {string} roomId The room ID to enable encryption in.</span>
<a href="#l11.442"></a><span id="l11.442" class="difflineplus">+ * @param {object} config The encryption config for the room.</span>
<a href="#l11.443"></a><span id="l11.443" class="difflineplus">+ * @return {Object} A promise that will resolve when encryption is setup.</span>
<a href="#l11.444"></a><span id="l11.444" class="difflineplus">+ */</span>
<a href="#l11.445"></a><span id="l11.445" class="difflineplus">+MatrixClient.prototype.setRoomEncryption = function(roomId, config) {</span>
<a href="#l11.446"></a><span id="l11.446" class="difflineplus">+    if (!this._crypto) {</span>
<a href="#l11.447"></a><span id="l11.447" class="difflineplus">+        throw new Error(&quot;End-to-End encryption disabled&quot;);</span>
<a href="#l11.448"></a><span id="l11.448" class="difflineplus">+    }</span>
<a href="#l11.449"></a><span id="l11.449" class="difflineplus">+    this._crypto.setRoomEncryption(roomId, config);</span>
<a href="#l11.450"></a><span id="l11.450" class="difflineplus">+    return q();</span>
<a href="#l11.451"></a><span id="l11.451" class="difflineplus">+};</span>
<a href="#l11.452"></a><span id="l11.452" class="difflineplus">+</span>
<a href="#l11.453"></a><span id="l11.453" class="difflineplus">+/**</span>
<a href="#l11.454"></a><span id="l11.454" class="difflineplus">+ * Whether encryption is enabled for a room.</span>
<a href="#l11.455"></a><span id="l11.455" class="difflineplus">+ * @param {string} roomId the room id to query.</span>
<a href="#l11.456"></a><span id="l11.456" class="difflineplus">+ * @return {bool} whether encryption is enabled.</span>
<a href="#l11.457"></a><span id="l11.457" class="difflineplus">+ */</span>
<a href="#l11.458"></a><span id="l11.458" class="difflineplus">+MatrixClient.prototype.isRoomEncrypted = function(roomId) {</span>
<a href="#l11.459"></a><span id="l11.459" class="difflineplus">+    if (!this._crypto) {</span>
<a href="#l11.460"></a><span id="l11.460" class="difflineplus">+        return false;</span>
<a href="#l11.461"></a><span id="l11.461" class="difflineplus">+    }</span>
<a href="#l11.462"></a><span id="l11.462" class="difflineplus">+</span>
<a href="#l11.463"></a><span id="l11.463" class="difflineplus">+    return this._crypto.isRoomEncrypted(roomId);</span>
<a href="#l11.464"></a><span id="l11.464" class="difflineplus">+};</span>
<a href="#l11.465"></a><span id="l11.465" class="difflineplus">+</span>
<a href="#l11.466"></a><span id="l11.466" class="difflineplus">+/**</span>
<a href="#l11.467"></a><span id="l11.467" class="difflineplus">+ * Decrypt a received event according to the algorithm specified in the event.</span>
<a href="#l11.468"></a><span id="l11.468" class="difflineplus">+ *</span>
<a href="#l11.469"></a><span id="l11.469" class="difflineplus">+ * @param {MatrixClient} client</span>
<a href="#l11.470"></a><span id="l11.470" class="difflineplus">+ * @param {MatrixEvent} event</span>
<a href="#l11.471"></a><span id="l11.471" class="difflineplus">+ */</span>
<a href="#l11.472"></a><span id="l11.472" class="difflineplus">+function _decryptEvent(client, event) {</span>
<a href="#l11.473"></a><span id="l11.473" class="difflineplus">+    if (!client._crypto) {</span>
<a href="#l11.474"></a><span id="l11.474" class="difflineplus">+        _badEncryptedMessage(event, &quot;**Encryption not enabled**&quot;);</span>
<a href="#l11.475"></a><span id="l11.475" class="difflineplus">+        return;</span>
<a href="#l11.476"></a><span id="l11.476" class="difflineplus">+    }</span>
<a href="#l11.477"></a><span id="l11.477" class="difflineplus">+</span>
<a href="#l11.478"></a><span id="l11.478" class="difflineplus">+    try {</span>
<a href="#l11.479"></a><span id="l11.479" class="difflineplus">+        client._crypto.decryptEvent(event);</span>
<a href="#l11.480"></a><span id="l11.480" class="difflineplus">+    } catch (e) {</span>
<a href="#l11.481"></a><span id="l11.481" class="difflineplus">+        if (!(e instanceof Crypto.DecryptionError)) {</span>
<a href="#l11.482"></a><span id="l11.482" class="difflineplus">+            throw e;</span>
<a href="#l11.483"></a><span id="l11.483" class="difflineplus">+        }</span>
<a href="#l11.484"></a><span id="l11.484" class="difflineplus">+        _badEncryptedMessage(event, &quot;**&quot; + e.message + &quot;**&quot;);</span>
<a href="#l11.485"></a><span id="l11.485" class="difflineplus">+        return;</span>
<a href="#l11.486"></a><span id="l11.486" class="difflineplus">+    }</span>
<a href="#l11.487"></a><span id="l11.487" class="difflineplus">+}</span>
<a href="#l11.488"></a><span id="l11.488" class="difflineplus">+</span>
<a href="#l11.489"></a><span id="l11.489" class="difflineplus">+function _badEncryptedMessage(event, reason) {</span>
<a href="#l11.490"></a><span id="l11.490" class="difflineplus">+    event.setClearData({</span>
<a href="#l11.491"></a><span id="l11.491" class="difflineplus">+        type: &quot;m.room.message&quot;,</span>
<a href="#l11.492"></a><span id="l11.492" class="difflineplus">+        content: {</span>
<a href="#l11.493"></a><span id="l11.493" class="difflineplus">+            msgtype: &quot;m.bad.encrypted&quot;,</span>
<a href="#l11.494"></a><span id="l11.494" class="difflineplus">+            body: reason,</span>
<a href="#l11.495"></a><span id="l11.495" class="difflineplus">+        },</span>
<a href="#l11.496"></a><span id="l11.496" class="difflineplus">+    });</span>
<a href="#l11.497"></a><span id="l11.497" class="difflineplus">+}</span>
<a href="#l11.498"></a><span id="l11.498" class="difflineplus">+</span>
<a href="#l11.499"></a><span id="l11.499" class="difflineplus">+// Room ops</span>
<a href="#l11.500"></a><span id="l11.500" class="difflineplus">+// ========</span>
<a href="#l11.501"></a><span id="l11.501" class="difflineplus">+</span>
<a href="#l11.502"></a><span id="l11.502" class="difflineplus">+/**</span>
<a href="#l11.503"></a><span id="l11.503" class="difflineplus">+ * Get the room for the given room ID.</span>
<a href="#l11.504"></a><span id="l11.504" class="difflineplus">+ * This function will return a valid room for any room for which a Room event</span>
<a href="#l11.505"></a><span id="l11.505" class="difflineplus">+ * has been emitted. Note in particular that other events, eg. RoomState.members</span>
<a href="#l11.506"></a><span id="l11.506" class="difflineplus">+ * will be emitted for a room before this function will return the given room.</span>
<a href="#l11.507"></a><span id="l11.507" class="difflineplus">+ * @param {string} roomId The room ID</span>
<a href="#l11.508"></a><span id="l11.508" class="difflineplus">+ * @return {Room} The Room or null if it doesn't exist or there is no data store.</span>
<a href="#l11.509"></a><span id="l11.509" class="difflineplus">+ */</span>
<a href="#l11.510"></a><span id="l11.510" class="difflineplus">+MatrixClient.prototype.getRoom = function(roomId) {</span>
<a href="#l11.511"></a><span id="l11.511" class="difflineplus">+    return this.store.getRoom(roomId);</span>
<a href="#l11.512"></a><span id="l11.512" class="difflineplus">+};</span>
<a href="#l11.513"></a><span id="l11.513" class="difflineplus">+</span>
<a href="#l11.514"></a><span id="l11.514" class="difflineplus">+/**</span>
<a href="#l11.515"></a><span id="l11.515" class="difflineplus">+ * Retrieve all known rooms.</span>
<a href="#l11.516"></a><span id="l11.516" class="difflineplus">+ * @return {Room[]} A list of rooms, or an empty list if there is no data store.</span>
<a href="#l11.517"></a><span id="l11.517" class="difflineplus">+ */</span>
<a href="#l11.518"></a><span id="l11.518" class="difflineplus">+MatrixClient.prototype.getRooms = function() {</span>
<a href="#l11.519"></a><span id="l11.519" class="difflineplus">+    return this.store.getRooms();</span>
<a href="#l11.520"></a><span id="l11.520" class="difflineplus">+};</span>
<a href="#l11.521"></a><span id="l11.521" class="difflineplus">+</span>
<a href="#l11.522"></a><span id="l11.522" class="difflineplus">+/**</span>
<a href="#l11.523"></a><span id="l11.523" class="difflineplus">+ * Retrieve a user.</span>
<a href="#l11.524"></a><span id="l11.524" class="difflineplus">+ * @param {string} userId The user ID to retrieve.</span>
<a href="#l11.525"></a><span id="l11.525" class="difflineplus">+ * @return {?User} A user or null if there is no data store or the user does</span>
<a href="#l11.526"></a><span id="l11.526" class="difflineplus">+ * not exist.</span>
<a href="#l11.527"></a><span id="l11.527" class="difflineplus">+ */</span>
<a href="#l11.528"></a><span id="l11.528" class="difflineplus">+MatrixClient.prototype.getUser = function(userId) {</span>
<a href="#l11.529"></a><span id="l11.529" class="difflineplus">+    return this.store.getUser(userId);</span>
<a href="#l11.530"></a><span id="l11.530" class="difflineplus">+};</span>
<a href="#l11.531"></a><span id="l11.531" class="difflineplus">+</span>
<a href="#l11.532"></a><span id="l11.532" class="difflineplus">+/**</span>
<a href="#l11.533"></a><span id="l11.533" class="difflineplus">+ * Retrieve all known users.</span>
<a href="#l11.534"></a><span id="l11.534" class="difflineplus">+ * @return {User[]} A list of users, or an empty list if there is no data store.</span>
<a href="#l11.535"></a><span id="l11.535" class="difflineplus">+ */</span>
<a href="#l11.536"></a><span id="l11.536" class="difflineplus">+MatrixClient.prototype.getUsers = function() {</span>
<a href="#l11.537"></a><span id="l11.537" class="difflineplus">+    return this.store.getUsers();</span>
<a href="#l11.538"></a><span id="l11.538" class="difflineplus">+};</span>
<a href="#l11.539"></a><span id="l11.539" class="difflineplus">+</span>
<a href="#l11.540"></a><span id="l11.540" class="difflineplus">+// User Account Data operations</span>
<a href="#l11.541"></a><span id="l11.541" class="difflineplus">+// ============================</span>
<a href="#l11.542"></a><span id="l11.542" class="difflineplus">+</span>
<a href="#l11.543"></a><span id="l11.543" class="difflineplus">+/**</span>
<a href="#l11.544"></a><span id="l11.544" class="difflineplus">+ * Set account data event for the current user.</span>
<a href="#l11.545"></a><span id="l11.545" class="difflineplus">+ * @param {string} eventType The event type</span>
<a href="#l11.546"></a><span id="l11.546" class="difflineplus">+ * @param {Object} content the contents object for the event</span>
<a href="#l11.547"></a><span id="l11.547" class="difflineplus">+ * @param {module:client.callback} callback Optional.</span>
<a href="#l11.548"></a><span id="l11.548" class="difflineplus">+ * @return {module:client.Promise} Resolves: TODO</span>
<a href="#l11.549"></a><span id="l11.549" class="difflineplus">+ * @return {module:http-api.MatrixError} Rejects: with an error response.</span>
<a href="#l11.550"></a><span id="l11.550" class="difflineplus">+ */</span>
<a href="#l11.551"></a><span id="l11.551" class="difflineplus">+MatrixClient.prototype.setAccountData = function(eventType, contents, callback) {</span>
<a href="#l11.552"></a><span id="l11.552" class="difflineplus">+    var path = utils.encodeUri(&quot;/user/$userId/account_data/$type&quot;, {</span>
<a href="#l11.553"></a><span id="l11.553" class="difflineplus">+        $userId: this.credentials.userId,</span>
<a href="#l11.554"></a><span id="l11.554" class="difflineplus">+        $type: eventType,</span>
<a href="#l11.555"></a><span id="l11.555" class="difflineplus">+    });</span>
<a href="#l11.556"></a><span id="l11.556" class="difflineplus">+    return this._http.authedRequest(</span>
<a href="#l11.557"></a><span id="l11.557" class="difflineplus">+        callback, &quot;PUT&quot;, path, undefined, contents</span>
<a href="#l11.558"></a><span id="l11.558" class="difflineplus">+    );</span>
<a href="#l11.559"></a><span id="l11.559" class="difflineplus">+};</span>
<a href="#l11.560"></a><span id="l11.560" class="difflineplus">+</span>
<a href="#l11.561"></a><span id="l11.561" class="difflineplus">+/**</span>
<a href="#l11.562"></a><span id="l11.562" class="difflineplus">+ * Get account data event of given type for the current user.</span>
<a href="#l11.563"></a><span id="l11.563" class="difflineplus">+ * @param {string} eventType The event type</span>
<a href="#l11.564"></a><span id="l11.564" class="difflineplus">+ * @param {module:client.callback} callback Optional.</span>
<a href="#l11.565"></a><span id="l11.565" class="difflineplus">+ * @return {?object} The contents of the given account data event</span>
<a href="#l11.566"></a><span id="l11.566" class="difflineplus">+ */</span>
<a href="#l11.567"></a><span id="l11.567" class="difflineplus">+MatrixClient.prototype.getAccountData = function(eventType) {</span>
<a href="#l11.568"></a><span id="l11.568" class="difflineplus">+    return this.store.getAccountData(eventType);</span>
<a href="#l11.569"></a><span id="l11.569" class="difflineplus">+};</span>
<a href="#l11.570"></a><span id="l11.570" class="difflineplus">+</span>
<a href="#l11.571"></a><span id="l11.571" class="difflineplus">+// Room operations</span>
<a href="#l11.572"></a><span id="l11.572" class="difflineplus">+// ===============</span>
<a href="#l11.573"></a><span id="l11.573" class="difflineplus">+</span>
<a href="#l11.574"></a><span id="l11.574" class="difflineplus">+/**</span>
<a href="#l11.575"></a><span id="l11.575" class="difflineplus">+ * Join a room. If you have already joined the room, this will no-op.</span>
<a href="#l11.576"></a><span id="l11.576" class="difflineplus">+ * @param {string} roomIdOrAlias The room ID or room alias to join.</span>
<a href="#l11.577"></a><span id="l11.577" class="difflineplus">+ * @param {Object} opts Options when joining the room.</span>
<a href="#l11.578"></a><span id="l11.578" class="difflineplus">+ * @param {boolean} opts.syncRoom True to do a room initial sync on the resulting</span>
<a href="#l11.579"></a><span id="l11.579" class="difflineplus">+ * room. If false, the &lt;strong&gt;returned Room object will have no current state.</span>
<a href="#l11.580"></a><span id="l11.580" class="difflineplus">+ * &lt;/strong&gt; Default: true.</span>
<a href="#l11.581"></a><span id="l11.581" class="difflineplus">+ * @param {boolean} opts.inviteSignUrl If the caller has a keypair 3pid invite,</span>
<a href="#l11.582"></a><span id="l11.582" class="difflineplus">+ *                                     the signing URL is passed in this parameter.</span>
<a href="#l11.583"></a><span id="l11.583" class="difflineplus">+ * @param {module:client.callback} callback Optional.</span>
<a href="#l11.584"></a><span id="l11.584" class="difflineplus">+ * @return {module:client.Promise} Resolves: Room object.</span>
<a href="#l11.585"></a><span id="l11.585" class="difflineplus">+ * @return {module:http-api.MatrixError} Rejects: with an error response.</span>
<a href="#l11.586"></a><span id="l11.586" class="difflineplus">+ */</span>
<a href="#l11.587"></a><span id="l11.587" class="difflineplus">+MatrixClient.prototype.joinRoom = function(roomIdOrAlias, opts, callback) {</span>
<a href="#l11.588"></a><span id="l11.588" class="difflineplus">+    // to help people when upgrading..</span>
<a href="#l11.589"></a><span id="l11.589" class="difflineplus">+    if (utils.isFunction(opts)) {</span>
<a href="#l11.590"></a><span id="l11.590" class="difflineplus">+        throw new Error(&quot;Expected 'opts' object, got function.&quot;);</span>
<a href="#l11.591"></a><span id="l11.591" class="difflineplus">+    }</span>
<a href="#l11.592"></a><span id="l11.592" class="difflineplus">+    opts = opts || {};</span>
<a href="#l11.593"></a><span id="l11.593" class="difflineplus">+    if (opts.syncRoom === undefined) { opts.syncRoom = true; }</span>
<a href="#l11.594"></a><span id="l11.594" class="difflineplus">+</span>
<a href="#l11.595"></a><span id="l11.595" class="difflineplus">+    var room = this.getRoom(roomIdOrAlias);</span>
<a href="#l11.596"></a><span id="l11.596" class="difflineplus">+    if (room &amp;&amp; room.hasMembershipState(this.credentials.userId, &quot;join&quot;)) {</span>
<a href="#l11.597"></a><span id="l11.597" class="difflineplus">+        return q(room);</span>
<a href="#l11.598"></a><span id="l11.598" class="difflineplus">+    }</span>
<a href="#l11.599"></a><span id="l11.599" class="difflineplus">+</span>
<a href="#l11.600"></a><span id="l11.600" class="difflineplus">+    var sign_promise = q();</span>
<a href="#l11.601"></a><span id="l11.601" class="difflineplus">+</span>
<a href="#l11.602"></a><span id="l11.602" class="difflineplus">+    if (opts.inviteSignUrl) {</span>
<a href="#l11.603"></a><span id="l11.603" class="difflineplus">+        sign_promise = this._http.requestOtherUrl(</span>
<a href="#l11.604"></a><span id="l11.604" class="difflineplus">+            undefined, 'POST',</span>
<a href="#l11.605"></a><span id="l11.605" class="difflineplus">+            opts.inviteSignUrl, { mxid: this.credentials.userId }</span>
<a href="#l11.606"></a><span id="l11.606" class="difflineplus">+        );</span>
<a href="#l11.607"></a><span id="l11.607" class="difflineplus">+    }</span>
<a href="#l11.608"></a><span id="l11.608" class="difflineplus">+</span>
<a href="#l11.609"></a><span id="l11.609" class="difflineplus">+    var defer = q.defer();</span>
<a href="#l11.610"></a><span id="l11.610" class="difflineplus">+</span>
<a href="#l11.611"></a><span id="l11.611" class="difflineplus">+    var self = this;</span>
<a href="#l11.612"></a><span id="l11.612" class="difflineplus">+    sign_promise.then(function(signed_invite_object) {</span>
<a href="#l11.613"></a><span id="l11.613" class="difflineplus">+        var data = {};</span>
<a href="#l11.614"></a><span id="l11.614" class="difflineplus">+        if (signed_invite_object) {</span>
<a href="#l11.615"></a><span id="l11.615" class="difflineplus">+            data.third_party_signed = signed_invite_object;</span>
<a href="#l11.616"></a><span id="l11.616" class="difflineplus">+        }</span>
<a href="#l11.617"></a><span id="l11.617" class="difflineplus">+</span>
<a href="#l11.618"></a><span id="l11.618" class="difflineplus">+        var path = utils.encodeUri(&quot;/join/$roomid&quot;, { $roomid: roomIdOrAlias});</span>
<a href="#l11.619"></a><span id="l11.619" class="difflineplus">+        return self._http.authedRequest(undefined, &quot;POST&quot;, path, undefined, data);</span>
<a href="#l11.620"></a><span id="l11.620" class="difflineplus">+    }).then(function(res) {</span>
<a href="#l11.621"></a><span id="l11.621" class="difflineplus">+        var roomId = res.room_id;</span>
<a href="#l11.622"></a><span id="l11.622" class="difflineplus">+        var syncApi = new SyncApi(self, self._clientOpts);</span>
<a href="#l11.623"></a><span id="l11.623" class="difflineplus">+        var room = syncApi.createRoom(roomId);</span>
<a href="#l11.624"></a><span id="l11.624" class="difflineplus">+        if (opts.syncRoom) {</span>
<a href="#l11.625"></a><span id="l11.625" class="difflineplus">+            // v2 will do this for us</span>
<a href="#l11.626"></a><span id="l11.626" class="difflineplus">+            // return syncApi.syncRoom(room);</span>
<a href="#l11.627"></a><span id="l11.627" class="difflineplus">+        }</span>
<a href="#l11.628"></a><span id="l11.628" class="difflineplus">+        return q(room);</span>
<a href="#l11.629"></a><span id="l11.629" class="difflineplus">+    }).done(function(room) {</span>
<a href="#l11.630"></a><span id="l11.630" class="difflineplus">+        _resolve(callback, defer, room);</span>
<a href="#l11.631"></a><span id="l11.631" class="difflineplus">+    }, function(err) {</span>
<a href="#l11.632"></a><span id="l11.632" class="difflineplus">+        _reject(callback, defer, err);</span>
<a href="#l11.633"></a><span id="l11.633" class="difflineplus">+    });</span>
<a href="#l11.634"></a><span id="l11.634" class="difflineplus">+    return defer.promise;</span>
<a href="#l11.635"></a><span id="l11.635" class="difflineplus">+};</span>
<a href="#l11.636"></a><span id="l11.636" class="difflineplus">+</span>
<a href="#l11.637"></a><span id="l11.637" class="difflineplus">+/**</span>
<a href="#l11.638"></a><span id="l11.638" class="difflineplus">+ * Resend an event.</span>
<a href="#l11.639"></a><span id="l11.639" class="difflineplus">+ * @param {MatrixEvent} event The event to resend.</span>
<a href="#l11.640"></a><span id="l11.640" class="difflineplus">+ * @param {Room} room Optional. The room the event is in. Will update the</span>
<a href="#l11.641"></a><span id="l11.641" class="difflineplus">+ * timeline entry if provided.</span>
<a href="#l11.642"></a><span id="l11.642" class="difflineplus">+ * @return {module:client.Promise} Resolves: TODO</span>
<a href="#l11.643"></a><span id="l11.643" class="difflineplus">+ * @return {module:http-api.MatrixError} Rejects: with an error response.</span>
<a href="#l11.644"></a><span id="l11.644" class="difflineplus">+ */</span>
<a href="#l11.645"></a><span id="l11.645" class="difflineplus">+MatrixClient.prototype.resendEvent = function(event, room) {</span>
<a href="#l11.646"></a><span id="l11.646" class="difflineplus">+    _updatePendingEventStatus(room, event, EventStatus.SENDING);</span>
<a href="#l11.647"></a><span id="l11.647" class="difflineplus">+    return _sendEvent(this, room, event);</span>
<a href="#l11.648"></a><span id="l11.648" class="difflineplus">+};</span>
<a href="#l11.649"></a><span id="l11.649" class="difflineplus">+</span>
<a href="#l11.650"></a><span id="l11.650" class="difflineplus">+/**</span>
<a href="#l11.651"></a><span id="l11.651" class="difflineplus">+ * Cancel a queued or unsent event.</span>
<a href="#l11.652"></a><span id="l11.652" class="difflineplus">+ *</span>
<a href="#l11.653"></a><span id="l11.653" class="difflineplus">+ * @param {MatrixEvent} event   Event to cancel</span>
<a href="#l11.654"></a><span id="l11.654" class="difflineplus">+ * @throws Error if the event is not in QUEUED or NOT_SENT state</span>
<a href="#l11.655"></a><span id="l11.655" class="difflineplus">+ */</span>
<a href="#l11.656"></a><span id="l11.656" class="difflineplus">+MatrixClient.prototype.cancelPendingEvent = function(event) {</span>
<a href="#l11.657"></a><span id="l11.657" class="difflineplus">+    if ([EventStatus.QUEUED, EventStatus.NOT_SENT].indexOf(event.status) &lt; 0) {</span>
<a href="#l11.658"></a><span id="l11.658" class="difflineplus">+        throw new Error(&quot;cannot cancel an event with status &quot; + event.status);</span>
<a href="#l11.659"></a><span id="l11.659" class="difflineplus">+    }</span>
<a href="#l11.660"></a><span id="l11.660" class="difflineplus">+</span>
<a href="#l11.661"></a><span id="l11.661" class="difflineplus">+    // first tell the scheduler to forget about it, if it's queued</span>
<a href="#l11.662"></a><span id="l11.662" class="difflineplus">+    if (this.scheduler) {</span>
<a href="#l11.663"></a><span id="l11.663" class="difflineplus">+        this.scheduler.removeEventFromQueue(event);</span>
<a href="#l11.664"></a><span id="l11.664" class="difflineplus">+    }</span>
<a href="#l11.665"></a><span id="l11.665" class="difflineplus">+</span>
<a href="#l11.666"></a><span id="l11.666" class="difflineplus">+    // then tell the room about the change of state, which will remove it</span>
<a href="#l11.667"></a><span id="l11.667" class="difflineplus">+    // from the room's list of pending events.</span>
<a href="#l11.668"></a><span id="l11.668" class="difflineplus">+    var room = this.getRoom(event.getRoomId());</span>
<a href="#l11.669"></a><span id="l11.669" class="difflineplus">+    _updatePendingEventStatus(room, event, EventStatus.CANCELLED);</span>
<a href="#l11.670"></a><span id="l11.670" class="difflineplus">+};</span>
<a href="#l11.671"></a><span id="l11.671" class="difflineplus">+</span>
<a href="#l11.672"></a><span id="l11.672" class="difflineplus">+/**</span>
<a href="#l11.673"></a><span id="l11.673" class="difflineplus">+ * @param {string} roomId</span>
<a href="#l11.674"></a><span id="l11.674" class="difflineplus">+ * @param {string} name</span>
<a href="#l11.675"></a><span id="l11.675" class="difflineplus">+ * @param {module:client.callback} callback Optional.</span>
<a href="#l11.676"></a><span id="l11.676" class="difflineplus">+ * @return {module:client.Promise} Resolves: TODO</span>
<a href="#l11.677"></a><span id="l11.677" class="difflineplus">+ * @return {module:http-api.MatrixError} Rejects: with an error response.</span>
<a href="#l11.678"></a><span id="l11.678" class="difflineplus">+ */</span>
<a href="#l11.679"></a><span id="l11.679" class="difflineplus">+MatrixClient.prototype.setRoomName = function(roomId, name, callback) {</span>
<a href="#l11.680"></a><span id="l11.680" class="difflineplus">+    return this.sendStateEvent(roomId, &quot;m.room.name&quot;, {name: name},</span>
<a href="#l11.681"></a><span id="l11.681" class="difflineplus">+                               undefined, callback);</span>
<a href="#l11.682"></a><span id="l11.682" class="difflineplus">+};</span>
<a href="#l11.683"></a><span id="l11.683" class="difflineplus">+</span>
<a href="#l11.684"></a><span id="l11.684" class="difflineplus">+/**</span>
<a href="#l11.685"></a><span id="l11.685" class="difflineplus">+ * @param {string} roomId</span>
<a href="#l11.686"></a><span id="l11.686" class="difflineplus">+ * @param {string} topic</span>
<a href="#l11.687"></a><span id="l11.687" class="difflineplus">+ * @param {module:client.callback} callback Optional.</span>
<a href="#l11.688"></a><span id="l11.688" class="difflineplus">+ * @return {module:client.Promise} Resolves: TODO</span>
<a href="#l11.689"></a><span id="l11.689" class="difflineplus">+ * @return {module:http-api.MatrixError} Rejects: with an error response.</span>
<a href="#l11.690"></a><span id="l11.690" class="difflineplus">+ */</span>
<a href="#l11.691"></a><span id="l11.691" class="difflineplus">+MatrixClient.prototype.setRoomTopic = function(roomId, topic, callback) {</span>
<a href="#l11.692"></a><span id="l11.692" class="difflineplus">+    return this.sendStateEvent(roomId, &quot;m.room.topic&quot;, {topic: topic},</span>
<a href="#l11.693"></a><span id="l11.693" class="difflineplus">+                               undefined, callback);</span>
<a href="#l11.694"></a><span id="l11.694" class="difflineplus">+};</span>
<a href="#l11.695"></a><span id="l11.695" class="difflineplus">+</span>
<a href="#l11.696"></a><span id="l11.696" class="difflineplus">+/**</span>
<a href="#l11.697"></a><span id="l11.697" class="difflineplus">+ * @param {string} roomId</span>
<a href="#l11.698"></a><span id="l11.698" class="difflineplus">+ * @param {module:client.callback} callback Optional.</span>
<a href="#l11.699"></a><span id="l11.699" class="difflineplus">+ * @return {module:client.Promise} Resolves: TODO</span>
<a href="#l11.700"></a><span id="l11.700" class="difflineplus">+ * @return {module:http-api.MatrixError} Rejects: with an error response.</span>
<a href="#l11.701"></a><span id="l11.701" class="difflineplus">+ */</span>
<a href="#l11.702"></a><span id="l11.702" class="difflineplus">+MatrixClient.prototype.getRoomTags = function(roomId, callback) {</span>
<a href="#l11.703"></a><span id="l11.703" class="difflineplus">+    var path = utils.encodeUri(&quot;/user/$userId/rooms/$roomId/tags/&quot;, {</span>
<a href="#l11.704"></a><span id="l11.704" class="difflineplus">+        $userId: this.credentials.userId,</span>
<a href="#l11.705"></a><span id="l11.705" class="difflineplus">+        $roomId: roomId,</span>
<a href="#l11.706"></a><span id="l11.706" class="difflineplus">+    });</span>
<a href="#l11.707"></a><span id="l11.707" class="difflineplus">+    return this._http.authedRequest(</span>
<a href="#l11.708"></a><span id="l11.708" class="difflineplus">+        callback, &quot;GET&quot;, path, undefined</span>
<a href="#l11.709"></a><span id="l11.709" class="difflineplus">+    );</span>
<a href="#l11.710"></a><span id="l11.710" class="difflineplus">+};</span>
<a href="#l11.711"></a><span id="l11.711" class="difflineplus">+</span>
<a href="#l11.712"></a><span id="l11.712" class="difflineplus">+/**</span>
<a href="#l11.713"></a><span id="l11.713" class="difflineplus">+ * @param {string} roomId</span>
<a href="#l11.714"></a><span id="l11.714" class="difflineplus">+ * @param {string} tagName name of room tag to be set</span>
<a href="#l11.715"></a><span id="l11.715" class="difflineplus">+ * @param {object} metadata associated with that tag to be stored</span>
<a href="#l11.716"></a><span id="l11.716" class="difflineplus">+ * @param {module:client.callback} callback Optional.</span>
<a href="#l11.717"></a><span id="l11.717" class="difflineplus">+ * @return {module:client.Promise} Resolves: TODO</span>
<a href="#l11.718"></a><span id="l11.718" class="difflineplus">+ * @return {module:http-api.MatrixError} Rejects: with an error response.</span>
<a href="#l11.719"></a><span id="l11.719" class="difflineplus">+ */</span>
<a href="#l11.720"></a><span id="l11.720" class="difflineplus">+MatrixClient.prototype.setRoomTag = function(roomId, tagName, metadata, callback) {</span>
<a href="#l11.721"></a><span id="l11.721" class="difflineplus">+    var path = utils.encodeUri(&quot;/user/$userId/rooms/$roomId/tags/$tag&quot;, {</span>
<a href="#l11.722"></a><span id="l11.722" class="difflineplus">+        $userId: this.credentials.userId,</span>
<a href="#l11.723"></a><span id="l11.723" class="difflineplus">+        $roomId: roomId,</span>
<a href="#l11.724"></a><span id="l11.724" class="difflineplus">+        $tag: tagName,</span>
<a href="#l11.725"></a><span id="l11.725" class="difflineplus">+    });</span>
<a href="#l11.726"></a><span id="l11.726" class="difflineplus">+    return this._http.authedRequest(</span>
<a href="#l11.727"></a><span id="l11.727" class="difflineplus">+        callback, &quot;PUT&quot;, path, undefined, metadata</span>
<a href="#l11.728"></a><span id="l11.728" class="difflineplus">+    );</span>
<a href="#l11.729"></a><span id="l11.729" class="difflineplus">+};</span>
<a href="#l11.730"></a><span id="l11.730" class="difflineplus">+</span>
<a href="#l11.731"></a><span id="l11.731" class="difflineplus">+/**</span>
<a href="#l11.732"></a><span id="l11.732" class="difflineplus">+ * @param {string} roomId</span>
<a href="#l11.733"></a><span id="l11.733" class="difflineplus">+ * @param {string} tagName name of room tag to be removed</span>
<a href="#l11.734"></a><span id="l11.734" class="difflineplus">+ * @param {module:client.callback} callback Optional.</span>
<a href="#l11.735"></a><span id="l11.735" class="difflineplus">+ * @return {module:client.Promise} Resolves: TODO</span>
<a href="#l11.736"></a><span id="l11.736" class="difflineplus">+ * @return {module:http-api.MatrixError} Rejects: with an error response.</span>
<a href="#l11.737"></a><span id="l11.737" class="difflineplus">+ */</span>
<a href="#l11.738"></a><span id="l11.738" class="difflineplus">+MatrixClient.prototype.deleteRoomTag = function(roomId, tagName, callback) {</span>
<a href="#l11.739"></a><span id="l11.739" class="difflineplus">+    var path = utils.encodeUri(&quot;/user/$userId/rooms/$roomId/tags/$tag&quot;, {</span>
<a href="#l11.740"></a><span id="l11.740" class="difflineplus">+        $userId: this.credentials.userId,</span>
<a href="#l11.741"></a><span id="l11.741" class="difflineplus">+        $roomId: roomId,</span>
<a href="#l11.742"></a><span id="l11.742" class="difflineplus">+        $tag: tagName,</span>
<a href="#l11.743"></a><span id="l11.743" class="difflineplus">+    });</span>
<a href="#l11.744"></a><span id="l11.744" class="difflineplus">+    return this._http.authedRequest(</span>
<a href="#l11.745"></a><span id="l11.745" class="difflineplus">+        callback, &quot;DELETE&quot;, path, undefined, undefined</span>
<a href="#l11.746"></a><span id="l11.746" class="difflineplus">+    );</span>
<a href="#l11.747"></a><span id="l11.747" class="difflineplus">+};</span>
<a href="#l11.748"></a><span id="l11.748" class="difflineplus">+</span>
<a href="#l11.749"></a><span id="l11.749" class="difflineplus">+/**</span>
<a href="#l11.750"></a><span id="l11.750" class="difflineplus">+ * @param {string} roomId</span>
<a href="#l11.751"></a><span id="l11.751" class="difflineplus">+ * @param {string} eventType event type to be set</span>
<a href="#l11.752"></a><span id="l11.752" class="difflineplus">+ * @param {object} content event content</span>
<a href="#l11.753"></a><span id="l11.753" class="difflineplus">+ * @param {module:client.callback} callback Optional.</span>
<a href="#l11.754"></a><span id="l11.754" class="difflineplus">+ * @return {module:client.Promise} Resolves: TODO</span>
<a href="#l11.755"></a><span id="l11.755" class="difflineplus">+ * @return {module:http-api.MatrixError} Rejects: with an error response.</span>
<a href="#l11.756"></a><span id="l11.756" class="difflineplus">+ */</span>
<a href="#l11.757"></a><span id="l11.757" class="difflineplus">+MatrixClient.prototype.setRoomAccountData = function(roomId, eventType,</span>
<a href="#l11.758"></a><span id="l11.758" class="difflineplus">+                                                     content, callback) {</span>
<a href="#l11.759"></a><span id="l11.759" class="difflineplus">+    var path = utils.encodeUri(&quot;/user/$userId/rooms/$roomId/account_data/$type&quot;, {</span>
<a href="#l11.760"></a><span id="l11.760" class="difflineplus">+        $userId: this.credentials.userId,</span>
<a href="#l11.761"></a><span id="l11.761" class="difflineplus">+        $roomId: roomId,</span>
<a href="#l11.762"></a><span id="l11.762" class="difflineplus">+        $type: eventType,</span>
<a href="#l11.763"></a><span id="l11.763" class="difflineplus">+    });</span>
<a href="#l11.764"></a><span id="l11.764" class="difflineplus">+    return this._http.authedRequest(</span>
<a href="#l11.765"></a><span id="l11.765" class="difflineplus">+        callback, &quot;PUT&quot;, path, undefined, content</span>
<a href="#l11.766"></a><span id="l11.766" class="difflineplus">+    );</span>
<a href="#l11.767"></a><span id="l11.767" class="difflineplus">+};</span>
<a href="#l11.768"></a><span id="l11.768" class="difflineplus">+</span>
<a href="#l11.769"></a><span id="l11.769" class="difflineplus">+/**</span>
<a href="#l11.770"></a><span id="l11.770" class="difflineplus">+ * Set a user's power level.</span>
<a href="#l11.771"></a><span id="l11.771" class="difflineplus">+ * @param {string} roomId</span>
<a href="#l11.772"></a><span id="l11.772" class="difflineplus">+ * @param {string} userId</span>
<a href="#l11.773"></a><span id="l11.773" class="difflineplus">+ * @param {Number} powerLevel</span>
<a href="#l11.774"></a><span id="l11.774" class="difflineplus">+ * @param {MatrixEvent} event</span>
<a href="#l11.775"></a><span id="l11.775" class="difflineplus">+ * @param {module:client.callback} callback Optional.</span>
<a href="#l11.776"></a><span id="l11.776" class="difflineplus">+ * @return {module:client.Promise} Resolves: TODO</span>
<a href="#l11.777"></a><span id="l11.777" class="difflineplus">+ * @return {module:http-api.MatrixError} Rejects: with an error response.</span>
<a href="#l11.778"></a><span id="l11.778" class="difflineplus">+ */</span>
<a href="#l11.779"></a><span id="l11.779" class="difflineplus">+MatrixClient.prototype.setPowerLevel = function(roomId, userId, powerLevel,</span>
<a href="#l11.780"></a><span id="l11.780" class="difflineplus">+                                                event, callback) {</span>
<a href="#l11.781"></a><span id="l11.781" class="difflineplus">+    var content = {</span>
<a href="#l11.782"></a><span id="l11.782" class="difflineplus">+        users: {}</span>
<a href="#l11.783"></a><span id="l11.783" class="difflineplus">+    };</span>
<a href="#l11.784"></a><span id="l11.784" class="difflineplus">+    if (event &amp;&amp; event.getType() === &quot;m.room.power_levels&quot;) {</span>
<a href="#l11.785"></a><span id="l11.785" class="difflineplus">+        // take a copy of the content to ensure we don't corrupt</span>
<a href="#l11.786"></a><span id="l11.786" class="difflineplus">+        // existing client state with a failed power level change</span>
<a href="#l11.787"></a><span id="l11.787" class="difflineplus">+        content = utils.deepCopy(event.getContent());</span>
<a href="#l11.788"></a><span id="l11.788" class="difflineplus">+    }</span>
<a href="#l11.789"></a><span id="l11.789" class="difflineplus">+    content.users[userId] = powerLevel;</span>
<a href="#l11.790"></a><span id="l11.790" class="difflineplus">+    var path = utils.encodeUri(&quot;/rooms/$roomId/state/m.room.power_levels&quot;, {</span>
<a href="#l11.791"></a><span id="l11.791" class="difflineplus">+        $roomId: roomId</span>
<a href="#l11.792"></a><span id="l11.792" class="difflineplus">+    });</span>
<a href="#l11.793"></a><span id="l11.793" class="difflineplus">+    return this._http.authedRequest(</span>
<a href="#l11.794"></a><span id="l11.794" class="difflineplus">+        callback, &quot;PUT&quot;, path, undefined, content</span>
<a href="#l11.795"></a><span id="l11.795" class="difflineplus">+    );</span>
<a href="#l11.796"></a><span id="l11.796" class="difflineplus">+};</span>
<a href="#l11.797"></a><span id="l11.797" class="difflineplus">+</span>
<a href="#l11.798"></a><span id="l11.798" class="difflineplus">+/**</span>
<a href="#l11.799"></a><span id="l11.799" class="difflineplus">+ * @param {string} roomId</span>
<a href="#l11.800"></a><span id="l11.800" class="difflineplus">+ * @param {string} eventType</span>
<a href="#l11.801"></a><span id="l11.801" class="difflineplus">+ * @param {Object} content</span>
<a href="#l11.802"></a><span id="l11.802" class="difflineplus">+ * @param {string} txnId Optional.</span>
<a href="#l11.803"></a><span id="l11.803" class="difflineplus">+ * @param {module:client.callback} callback Optional.</span>
<a href="#l11.804"></a><span id="l11.804" class="difflineplus">+ * @return {module:client.Promise} Resolves: TODO</span>
<a href="#l11.805"></a><span id="l11.805" class="difflineplus">+ * @return {module:http-api.MatrixError} Rejects: with an error response.</span>
<a href="#l11.806"></a><span id="l11.806" class="difflineplus">+ */</span>
<a href="#l11.807"></a><span id="l11.807" class="difflineplus">+MatrixClient.prototype.sendEvent = function(roomId, eventType, content, txnId,</span>
<a href="#l11.808"></a><span id="l11.808" class="difflineplus">+                                            callback) {</span>
<a href="#l11.809"></a><span id="l11.809" class="difflineplus">+    if (utils.isFunction(txnId)) { callback = txnId; txnId = undefined; }</span>
<a href="#l11.810"></a><span id="l11.810" class="difflineplus">+</span>
<a href="#l11.811"></a><span id="l11.811" class="difflineplus">+    if (!txnId) {</span>
<a href="#l11.812"></a><span id="l11.812" class="difflineplus">+        txnId = this.makeTxnId();</span>
<a href="#l11.813"></a><span id="l11.813" class="difflineplus">+    }</span>
<a href="#l11.814"></a><span id="l11.814" class="difflineplus">+</span>
<a href="#l11.815"></a><span id="l11.815" class="difflineplus">+    // we always construct a MatrixEvent when sending because the store and</span>
<a href="#l11.816"></a><span id="l11.816" class="difflineplus">+    // scheduler use them. We'll extract the params back out if it turns out</span>
<a href="#l11.817"></a><span id="l11.817" class="difflineplus">+    // the client has no scheduler or store.</span>
<a href="#l11.818"></a><span id="l11.818" class="difflineplus">+    var room = this.getRoom(roomId);</span>
<a href="#l11.819"></a><span id="l11.819" class="difflineplus">+    var localEvent = new MatrixEvent({</span>
<a href="#l11.820"></a><span id="l11.820" class="difflineplus">+        event_id: &quot;~&quot; + roomId + &quot;:&quot; + txnId,</span>
<a href="#l11.821"></a><span id="l11.821" class="difflineplus">+        user_id: this.credentials.userId,</span>
<a href="#l11.822"></a><span id="l11.822" class="difflineplus">+        room_id: roomId,</span>
<a href="#l11.823"></a><span id="l11.823" class="difflineplus">+        type: eventType,</span>
<a href="#l11.824"></a><span id="l11.824" class="difflineplus">+        origin_server_ts: new Date().getTime(),</span>
<a href="#l11.825"></a><span id="l11.825" class="difflineplus">+        content: content</span>
<a href="#l11.826"></a><span id="l11.826" class="difflineplus">+    });</span>
<a href="#l11.827"></a><span id="l11.827" class="difflineplus">+    localEvent._txnId = txnId;</span>
<a href="#l11.828"></a><span id="l11.828" class="difflineplus">+    localEvent.status = EventStatus.SENDING;</span>
<a href="#l11.829"></a><span id="l11.829" class="difflineplus">+</span>
<a href="#l11.830"></a><span id="l11.830" class="difflineplus">+    // add this event immediately to the local store as 'sending'.</span>
<a href="#l11.831"></a><span id="l11.831" class="difflineplus">+    if (room) {</span>
<a href="#l11.832"></a><span id="l11.832" class="difflineplus">+        room.addPendingEvent(localEvent, txnId);</span>
<a href="#l11.833"></a><span id="l11.833" class="difflineplus">+    }</span>
<a href="#l11.834"></a><span id="l11.834" class="difflineplus">+</span>
<a href="#l11.835"></a><span id="l11.835" class="difflineplus">+    return _sendEvent(this, room, localEvent, callback);</span>
<a href="#l11.836"></a><span id="l11.836" class="difflineplus">+};</span>
<a href="#l11.837"></a><span id="l11.837" class="difflineplus">+</span>
<a href="#l11.838"></a><span id="l11.838" class="difflineplus">+</span>
<a href="#l11.839"></a><span id="l11.839" class="difflineplus">+// encrypts the event if necessary</span>
<a href="#l11.840"></a><span id="l11.840" class="difflineplus">+// adds the event to the queue, or sends it</span>
<a href="#l11.841"></a><span id="l11.841" class="difflineplus">+// marks the event as sent/unsent</span>
<a href="#l11.842"></a><span id="l11.842" class="difflineplus">+// returns a promise which resolves with the result of the send request</span>
<a href="#l11.843"></a><span id="l11.843" class="difflineplus">+function _sendEvent(client, room, event, callback) {</span>
<a href="#l11.844"></a><span id="l11.844" class="difflineplus">+    // Add an extra q() to turn synchronous exceptions into promise rejections,</span>
<a href="#l11.845"></a><span id="l11.845" class="difflineplus">+    // so that we can handle synchronous and asynchronous exceptions with the</span>
<a href="#l11.846"></a><span id="l11.846" class="difflineplus">+    // same code path.</span>
<a href="#l11.847"></a><span id="l11.847" class="difflineplus">+    return q().then(function() {</span>
<a href="#l11.848"></a><span id="l11.848" class="difflineplus">+        var encryptionPromise = null;</span>
<a href="#l11.849"></a><span id="l11.849" class="difflineplus">+        if (client._crypto) {</span>
<a href="#l11.850"></a><span id="l11.850" class="difflineplus">+            encryptionPromise = client._crypto.encryptEventIfNeeded(event, room);</span>
<a href="#l11.851"></a><span id="l11.851" class="difflineplus">+        }</span>
<a href="#l11.852"></a><span id="l11.852" class="difflineplus">+        if (encryptionPromise) {</span>
<a href="#l11.853"></a><span id="l11.853" class="difflineplus">+            _updatePendingEventStatus(room, event, EventStatus.ENCRYPTING);</span>
<a href="#l11.854"></a><span id="l11.854" class="difflineplus">+            encryptionPromise = encryptionPromise.then(function() {</span>
<a href="#l11.855"></a><span id="l11.855" class="difflineplus">+                _updatePendingEventStatus(room, event, EventStatus.SENDING);</span>
<a href="#l11.856"></a><span id="l11.856" class="difflineplus">+            });</span>
<a href="#l11.857"></a><span id="l11.857" class="difflineplus">+        }</span>
<a href="#l11.858"></a><span id="l11.858" class="difflineplus">+        return encryptionPromise;</span>
<a href="#l11.859"></a><span id="l11.859" class="difflineplus">+    }).then(function() {</span>
<a href="#l11.860"></a><span id="l11.860" class="difflineplus">+        var promise;</span>
<a href="#l11.861"></a><span id="l11.861" class="difflineplus">+        // this event may be queued</span>
<a href="#l11.862"></a><span id="l11.862" class="difflineplus">+        if (client.scheduler) {</span>
<a href="#l11.863"></a><span id="l11.863" class="difflineplus">+            // if this returns a promsie then the scheduler has control now and will</span>
<a href="#l11.864"></a><span id="l11.864" class="difflineplus">+            // resolve/reject when it is done. Internally, the scheduler will invoke</span>
<a href="#l11.865"></a><span id="l11.865" class="difflineplus">+            // processFn which is set to this._sendEventHttpRequest so the same code</span>
<a href="#l11.866"></a><span id="l11.866" class="difflineplus">+            // path is executed regardless.</span>
<a href="#l11.867"></a><span id="l11.867" class="difflineplus">+            promise = client.scheduler.queueEvent(event);</span>
<a href="#l11.868"></a><span id="l11.868" class="difflineplus">+            if (promise &amp;&amp; client.scheduler.getQueueForEvent(event).length &gt; 1) {</span>
<a href="#l11.869"></a><span id="l11.869" class="difflineplus">+                // event is processed FIFO so if the length is 2 or more we know</span>
<a href="#l11.870"></a><span id="l11.870" class="difflineplus">+                // this event is stuck behind an earlier event.</span>
<a href="#l11.871"></a><span id="l11.871" class="difflineplus">+                _updatePendingEventStatus(room, event, EventStatus.QUEUED);</span>
<a href="#l11.872"></a><span id="l11.872" class="difflineplus">+            }</span>
<a href="#l11.873"></a><span id="l11.873" class="difflineplus">+        }</span>
<a href="#l11.874"></a><span id="l11.874" class="difflineplus">+</span>
<a href="#l11.875"></a><span id="l11.875" class="difflineplus">+        if (!promise) {</span>
<a href="#l11.876"></a><span id="l11.876" class="difflineplus">+            promise = _sendEventHttpRequest(client, event);</span>
<a href="#l11.877"></a><span id="l11.877" class="difflineplus">+        }</span>
<a href="#l11.878"></a><span id="l11.878" class="difflineplus">+        return promise;</span>
<a href="#l11.879"></a><span id="l11.879" class="difflineplus">+    }).then(function(res) {  // the request was sent OK</span>
<a href="#l11.880"></a><span id="l11.880" class="difflineplus">+        if (room) {</span>
<a href="#l11.881"></a><span id="l11.881" class="difflineplus">+            room.updatePendingEvent(event, EventStatus.SENT, res.event_id);</span>
<a href="#l11.882"></a><span id="l11.882" class="difflineplus">+        }</span>
<a href="#l11.883"></a><span id="l11.883" class="difflineplus">+        if (callback) {</span>
<a href="#l11.884"></a><span id="l11.884" class="difflineplus">+            callback(null, res);</span>
<a href="#l11.885"></a><span id="l11.885" class="difflineplus">+        }</span>
<a href="#l11.886"></a><span id="l11.886" class="difflineplus">+        return res;</span>
<a href="#l11.887"></a><span id="l11.887" class="difflineplus">+    }, function(err) {</span>
<a href="#l11.888"></a><span id="l11.888" class="difflineplus">+        // the request failed to send.</span>
<a href="#l11.889"></a><span id="l11.889" class="difflineplus">+        console.error(&quot;Error sending event&quot;, err.stack || err);</span>
<a href="#l11.890"></a><span id="l11.890" class="difflineplus">+</span>
<a href="#l11.891"></a><span id="l11.891" class="difflineplus">+        try {</span>
<a href="#l11.892"></a><span id="l11.892" class="difflineplus">+            _updatePendingEventStatus(room, event, EventStatus.NOT_SENT);</span>
<a href="#l11.893"></a><span id="l11.893" class="difflineplus">+</span>
<a href="#l11.894"></a><span id="l11.894" class="difflineplus">+            if (callback) {</span>
<a href="#l11.895"></a><span id="l11.895" class="difflineplus">+                callback(err);</span>
<a href="#l11.896"></a><span id="l11.896" class="difflineplus">+            }</span>
<a href="#l11.897"></a><span id="l11.897" class="difflineplus">+        } catch (err2) {</span>
<a href="#l11.898"></a><span id="l11.898" class="difflineplus">+            console.error(&quot;Exception in error handler!&quot;, err2.stack || err);</span>
<a href="#l11.899"></a><span id="l11.899" class="difflineplus">+        }</span>
<a href="#l11.900"></a><span id="l11.900" class="difflineplus">+        throw err;</span>
<a href="#l11.901"></a><span id="l11.901" class="difflineplus">+    });</span>
<a href="#l11.902"></a><span id="l11.902" class="difflineplus">+}</span>
<a href="#l11.903"></a><span id="l11.903" class="difflineplus">+</span>
<a href="#l11.904"></a><span id="l11.904" class="difflineplus">+function _updatePendingEventStatus(room, event, newStatus) {</span>
<a href="#l11.905"></a><span id="l11.905" class="difflineplus">+    if (room) {</span>
<a href="#l11.906"></a><span id="l11.906" class="difflineplus">+        room.updatePendingEvent(event, newStatus);</span>
<a href="#l11.907"></a><span id="l11.907" class="difflineplus">+    } else {</span>
<a href="#l11.908"></a><span id="l11.908" class="difflineplus">+        event.status = newStatus;</span>
<a href="#l11.909"></a><span id="l11.909" class="difflineplus">+    }</span>
<a href="#l11.910"></a><span id="l11.910" class="difflineplus">+}</span>
<a href="#l11.911"></a><span id="l11.911" class="difflineplus">+</span>
<a href="#l11.912"></a><span id="l11.912" class="difflineplus">+function _sendEventHttpRequest(client, event) {</span>
<a href="#l11.913"></a><span id="l11.913" class="difflineplus">+    var txnId = event._txnId ? event._txnId : client.makeTxnId();</span>
<a href="#l11.914"></a><span id="l11.914" class="difflineplus">+</span>
<a href="#l11.915"></a><span id="l11.915" class="difflineplus">+    var pathParams = {</span>
<a href="#l11.916"></a><span id="l11.916" class="difflineplus">+        $roomId: event.getRoomId(),</span>
<a href="#l11.917"></a><span id="l11.917" class="difflineplus">+        $eventType: event.getWireType(),</span>
<a href="#l11.918"></a><span id="l11.918" class="difflineplus">+        $stateKey: event.getStateKey(),</span>
<a href="#l11.919"></a><span id="l11.919" class="difflineplus">+        $txnId: txnId,</span>
<a href="#l11.920"></a><span id="l11.920" class="difflineplus">+    };</span>
<a href="#l11.921"></a><span id="l11.921" class="difflineplus">+</span>
<a href="#l11.922"></a><span id="l11.922" class="difflineplus">+    var path;</span>
<a href="#l11.923"></a><span id="l11.923" class="difflineplus">+</span>
<a href="#l11.924"></a><span id="l11.924" class="difflineplus">+    if (event.isState()) {</span>
<a href="#l11.925"></a><span id="l11.925" class="difflineplus">+        var pathTemplate = &quot;/rooms/$roomId/state/$eventType&quot;;</span>
<a href="#l11.926"></a><span id="l11.926" class="difflineplus">+        if (event.getStateKey() &amp;&amp; event.getStateKey().length &gt; 0) {</span>
<a href="#l11.927"></a><span id="l11.927" class="difflineplus">+            pathTemplate = &quot;/rooms/$roomId/state/$eventType/$stateKey&quot;;</span>
<a href="#l11.928"></a><span id="l11.928" class="difflineplus">+        }</span>
<a href="#l11.929"></a><span id="l11.929" class="difflineplus">+        path = utils.encodeUri(pathTemplate, pathParams);</span>
<a href="#l11.930"></a><span id="l11.930" class="difflineplus">+    }</span>
<a href="#l11.931"></a><span id="l11.931" class="difflineplus">+    else {</span>
<a href="#l11.932"></a><span id="l11.932" class="difflineplus">+        path = utils.encodeUri(</span>
<a href="#l11.933"></a><span id="l11.933" class="difflineplus">+            &quot;/rooms/$roomId/send/$eventType/$txnId&quot;, pathParams</span>
<a href="#l11.934"></a><span id="l11.934" class="difflineplus">+        );</span>
<a href="#l11.935"></a><span id="l11.935" class="difflineplus">+    }</span>
<a href="#l11.936"></a><span id="l11.936" class="difflineplus">+</span>
<a href="#l11.937"></a><span id="l11.937" class="difflineplus">+    return client._http.authedRequest(</span>
<a href="#l11.938"></a><span id="l11.938" class="difflineplus">+        undefined, &quot;PUT&quot;, path, undefined, event.getWireContent()</span>
<a href="#l11.939"></a><span id="l11.939" class="difflineplus">+    );</span>
<a href="#l11.940"></a><span id="l11.940" class="difflineplus">+}</span>
<a href="#l11.941"></a><span id="l11.941" class="difflineplus">+</span>
<a href="#l11.942"></a><span id="l11.942" class="difflineplus">+/**</span>
<a href="#l11.943"></a><span id="l11.943" class="difflineplus">+ * @param {string} roomId</span>
<a href="#l11.944"></a><span id="l11.944" class="difflineplus">+ * @param {Object} content</span>
<a href="#l11.945"></a><span id="l11.945" class="difflineplus">+ * @param {string} txnId Optional.</span>
<a href="#l11.946"></a><span id="l11.946" class="difflineplus">+ * @param {module:client.callback} callback Optional.</span>
<a href="#l11.947"></a><span id="l11.947" class="difflineplus">+ * @return {module:client.Promise} Resolves: TODO</span>
<a href="#l11.948"></a><span id="l11.948" class="difflineplus">+ * @return {module:http-api.MatrixError} Rejects: with an error response.</span>
<a href="#l11.949"></a><span id="l11.949" class="difflineplus">+ */</span>
<a href="#l11.950"></a><span id="l11.950" class="difflineplus">+MatrixClient.prototype.sendMessage = function(roomId, content, txnId, callback) {</span>
<a href="#l11.951"></a><span id="l11.951" class="difflineplus">+    if (utils.isFunction(txnId)) { callback = txnId; txnId = undefined; }</span>
<a href="#l11.952"></a><span id="l11.952" class="difflineplus">+    return this.sendEvent(</span>
<a href="#l11.953"></a><span id="l11.953" class="difflineplus">+        roomId, &quot;m.room.message&quot;, content, txnId, callback</span>
<a href="#l11.954"></a><span id="l11.954" class="difflineplus">+    );</span>
<a href="#l11.955"></a><span id="l11.955" class="difflineplus">+};</span>
<a href="#l11.956"></a><span id="l11.956" class="difflineplus">+</span>
<a href="#l11.957"></a><span id="l11.957" class="difflineplus">+/**</span>
<a href="#l11.958"></a><span id="l11.958" class="difflineplus">+ * @param {string} roomId</span>
<a href="#l11.959"></a><span id="l11.959" class="difflineplus">+ * @param {string} body</span>
<a href="#l11.960"></a><span id="l11.960" class="difflineplus">+ * @param {string} txnId Optional.</span>
<a href="#l11.961"></a><span id="l11.961" class="difflineplus">+ * @param {module:client.callback} callback Optional.</span>
<a href="#l11.962"></a><span id="l11.962" class="difflineplus">+ * @return {module:client.Promise} Resolves: TODO</span>
<a href="#l11.963"></a><span id="l11.963" class="difflineplus">+ * @return {module:http-api.MatrixError} Rejects: with an error response.</span>
<a href="#l11.964"></a><span id="l11.964" class="difflineplus">+ */</span>
<a href="#l11.965"></a><span id="l11.965" class="difflineplus">+MatrixClient.prototype.sendTextMessage = function(roomId, body, txnId, callback) {</span>
<a href="#l11.966"></a><span id="l11.966" class="difflineplus">+    var content = {</span>
<a href="#l11.967"></a><span id="l11.967" class="difflineplus">+         msgtype: &quot;m.text&quot;,</span>
<a href="#l11.968"></a><span id="l11.968" class="difflineplus">+         body: body</span>
<a href="#l11.969"></a><span id="l11.969" class="difflineplus">+    };</span>
<a href="#l11.970"></a><span id="l11.970" class="difflineplus">+    return this.sendMessage(roomId, content, txnId, callback);</span>
<a href="#l11.971"></a><span id="l11.971" class="difflineplus">+};</span>
<a href="#l11.972"></a><span id="l11.972" class="difflineplus">+</span>
<a href="#l11.973"></a><span id="l11.973" class="difflineplus">+/**</span>
<a href="#l11.974"></a><span id="l11.974" class="difflineplus">+ * @param {string} roomId</span>
<a href="#l11.975"></a><span id="l11.975" class="difflineplus">+ * @param {string} body</span>
<a href="#l11.976"></a><span id="l11.976" class="difflineplus">+ * @param {string} txnId Optional.</span>
<a href="#l11.977"></a><span id="l11.977" class="difflineplus">+ * @param {module:client.callback} callback Optional.</span>
<a href="#l11.978"></a><span id="l11.978" class="difflineplus">+ * @return {module:client.Promise} Resolves: TODO</span>
<a href="#l11.979"></a><span id="l11.979" class="difflineplus">+ * @return {module:http-api.MatrixError} Rejects: with an error response.</span>
<a href="#l11.980"></a><span id="l11.980" class="difflineplus">+ */</span>
<a href="#l11.981"></a><span id="l11.981" class="difflineplus">+MatrixClient.prototype.sendNotice = function(roomId, body, txnId, callback) {</span>
<a href="#l11.982"></a><span id="l11.982" class="difflineplus">+    var content = {</span>
<a href="#l11.983"></a><span id="l11.983" class="difflineplus">+         msgtype: &quot;m.notice&quot;,</span>
<a href="#l11.984"></a><span id="l11.984" class="difflineplus">+         body: body</span>
<a href="#l11.985"></a><span id="l11.985" class="difflineplus">+    };</span>
<a href="#l11.986"></a><span id="l11.986" class="difflineplus">+    return this.sendMessage(roomId, content, txnId, callback);</span>
<a href="#l11.987"></a><span id="l11.987" class="difflineplus">+};</span>
<a href="#l11.988"></a><span id="l11.988" class="difflineplus">+</span>
<a href="#l11.989"></a><span id="l11.989" class="difflineplus">+/**</span>
<a href="#l11.990"></a><span id="l11.990" class="difflineplus">+ * @param {string} roomId</span>
<a href="#l11.991"></a><span id="l11.991" class="difflineplus">+ * @param {string} body</span>
<a href="#l11.992"></a><span id="l11.992" class="difflineplus">+ * @param {string} txnId Optional.</span>
<a href="#l11.993"></a><span id="l11.993" class="difflineplus">+ * @param {module:client.callback} callback Optional.</span>
<a href="#l11.994"></a><span id="l11.994" class="difflineplus">+ * @return {module:client.Promise} Resolves: TODO</span>
<a href="#l11.995"></a><span id="l11.995" class="difflineplus">+ * @return {module:http-api.MatrixError} Rejects: with an error response.</span>
<a href="#l11.996"></a><span id="l11.996" class="difflineplus">+ */</span>
<a href="#l11.997"></a><span id="l11.997" class="difflineplus">+MatrixClient.prototype.sendEmoteMessage = function(roomId, body, txnId, callback) {</span>
<a href="#l11.998"></a><span id="l11.998" class="difflineplus">+    var content = {</span>
<a href="#l11.999"></a><span id="l11.999" class="difflineplus">+         msgtype: &quot;m.emote&quot;,</span>
<a href="#l11.1000"></a><span id="l11.1000" class="difflineplus">+         body: body</span>
<a href="#l11.1001"></a><span id="l11.1001" class="difflineplus">+    };</span>
<a href="#l11.1002"></a><span id="l11.1002" class="difflineplus">+    return this.sendMessage(roomId, content, txnId, callback);</span>
<a href="#l11.1003"></a><span id="l11.1003" class="difflineplus">+};</span>
<a href="#l11.1004"></a><span id="l11.1004" class="difflineplus">+</span>
<a href="#l11.1005"></a><span id="l11.1005" class="difflineplus">+/**</span>
<a href="#l11.1006"></a><span id="l11.1006" class="difflineplus">+ * @param {string} roomId</span>
<a href="#l11.1007"></a><span id="l11.1007" class="difflineplus">+ * @param {string} url</span>
<a href="#l11.1008"></a><span id="l11.1008" class="difflineplus">+ * @param {Object} info</span>
<a href="#l11.1009"></a><span id="l11.1009" class="difflineplus">+ * @param {string} text</span>
<a href="#l11.1010"></a><span id="l11.1010" class="difflineplus">+ * @param {module:client.callback} callback Optional.</span>
<a href="#l11.1011"></a><span id="l11.1011" class="difflineplus">+ * @return {module:client.Promise} Resolves: TODO</span>
<a href="#l11.1012"></a><span id="l11.1012" class="difflineplus">+ * @return {module:http-api.MatrixError} Rejects: with an error response.</span>
<a href="#l11.1013"></a><span id="l11.1013" class="difflineplus">+ */</span>
<a href="#l11.1014"></a><span id="l11.1014" class="difflineplus">+MatrixClient.prototype.sendImageMessage = function(roomId, url, info, text, callback) {</span>
<a href="#l11.1015"></a><span id="l11.1015" class="difflineplus">+    if (utils.isFunction(text)) { callback = text; text = undefined; }</span>
<a href="#l11.1016"></a><span id="l11.1016" class="difflineplus">+    if (!text) { text = &quot;Image&quot;; }</span>
<a href="#l11.1017"></a><span id="l11.1017" class="difflineplus">+    var content = {</span>
<a href="#l11.1018"></a><span id="l11.1018" class="difflineplus">+         msgtype: &quot;m.image&quot;,</span>
<a href="#l11.1019"></a><span id="l11.1019" class="difflineplus">+         url: url,</span>
<a href="#l11.1020"></a><span id="l11.1020" class="difflineplus">+         info: info,</span>
<a href="#l11.1021"></a><span id="l11.1021" class="difflineplus">+         body: text</span>
<a href="#l11.1022"></a><span id="l11.1022" class="difflineplus">+    };</span>
<a href="#l11.1023"></a><span id="l11.1023" class="difflineplus">+    return this.sendMessage(roomId, content, callback);</span>
<a href="#l11.1024"></a><span id="l11.1024" class="difflineplus">+};</span>
<a href="#l11.1025"></a><span id="l11.1025" class="difflineplus">+</span>
<a href="#l11.1026"></a><span id="l11.1026" class="difflineplus">+/**</span>
<a href="#l11.1027"></a><span id="l11.1027" class="difflineplus">+ * @param {string} roomId</span>
<a href="#l11.1028"></a><span id="l11.1028" class="difflineplus">+ * @param {string} body</span>
<a href="#l11.1029"></a><span id="l11.1029" class="difflineplus">+ * @param {string} htmlBody</span>
<a href="#l11.1030"></a><span id="l11.1030" class="difflineplus">+ * @param {module:client.callback} callback Optional.</span>
<a href="#l11.1031"></a><span id="l11.1031" class="difflineplus">+ * @return {module:client.Promise} Resolves: TODO</span>
<a href="#l11.1032"></a><span id="l11.1032" class="difflineplus">+ * @return {module:http-api.MatrixError} Rejects: with an error response.</span>
<a href="#l11.1033"></a><span id="l11.1033" class="difflineplus">+ */</span>
<a href="#l11.1034"></a><span id="l11.1034" class="difflineplus">+MatrixClient.prototype.sendHtmlMessage = function(roomId, body, htmlBody, callback) {</span>
<a href="#l11.1035"></a><span id="l11.1035" class="difflineplus">+    var content = {</span>
<a href="#l11.1036"></a><span id="l11.1036" class="difflineplus">+        msgtype: &quot;m.text&quot;,</span>
<a href="#l11.1037"></a><span id="l11.1037" class="difflineplus">+        format: &quot;org.matrix.custom.html&quot;,</span>
<a href="#l11.1038"></a><span id="l11.1038" class="difflineplus">+        body: body,</span>
<a href="#l11.1039"></a><span id="l11.1039" class="difflineplus">+        formatted_body: htmlBody</span>
<a href="#l11.1040"></a><span id="l11.1040" class="difflineplus">+    };</span>
<a href="#l11.1041"></a><span id="l11.1041" class="difflineplus">+    return this.sendMessage(roomId, content, callback);</span>
<a href="#l11.1042"></a><span id="l11.1042" class="difflineplus">+};</span>
<a href="#l11.1043"></a><span id="l11.1043" class="difflineplus">+</span>
<a href="#l11.1044"></a><span id="l11.1044" class="difflineplus">+/**</span>
<a href="#l11.1045"></a><span id="l11.1045" class="difflineplus">+ * @param {string} roomId</span>
<a href="#l11.1046"></a><span id="l11.1046" class="difflineplus">+ * @param {string} body</span>
<a href="#l11.1047"></a><span id="l11.1047" class="difflineplus">+ * @param {string} htmlBody</span>
<a href="#l11.1048"></a><span id="l11.1048" class="difflineplus">+ * @param {module:client.callback} callback Optional.</span>
<a href="#l11.1049"></a><span id="l11.1049" class="difflineplus">+ * @return {module:client.Promise} Resolves: TODO</span>
<a href="#l11.1050"></a><span id="l11.1050" class="difflineplus">+ * @return {module:http-api.MatrixError} Rejects: with an error response.</span>
<a href="#l11.1051"></a><span id="l11.1051" class="difflineplus">+ */</span>
<a href="#l11.1052"></a><span id="l11.1052" class="difflineplus">+MatrixClient.prototype.sendHtmlNotice = function(roomId, body, htmlBody, callback) {</span>
<a href="#l11.1053"></a><span id="l11.1053" class="difflineplus">+    var content = {</span>
<a href="#l11.1054"></a><span id="l11.1054" class="difflineplus">+        msgtype: &quot;m.notice&quot;,</span>
<a href="#l11.1055"></a><span id="l11.1055" class="difflineplus">+        format: &quot;org.matrix.custom.html&quot;,</span>
<a href="#l11.1056"></a><span id="l11.1056" class="difflineplus">+        body: body,</span>
<a href="#l11.1057"></a><span id="l11.1057" class="difflineplus">+        formatted_body: htmlBody</span>
<a href="#l11.1058"></a><span id="l11.1058" class="difflineplus">+    };</span>
<a href="#l11.1059"></a><span id="l11.1059" class="difflineplus">+    return this.sendMessage(roomId, content, callback);</span>
<a href="#l11.1060"></a><span id="l11.1060" class="difflineplus">+};</span>
<a href="#l11.1061"></a><span id="l11.1061" class="difflineplus">+</span>
<a href="#l11.1062"></a><span id="l11.1062" class="difflineplus">+/**</span>
<a href="#l11.1063"></a><span id="l11.1063" class="difflineplus">+ * @param {string} roomId</span>
<a href="#l11.1064"></a><span id="l11.1064" class="difflineplus">+ * @param {string} body</span>
<a href="#l11.1065"></a><span id="l11.1065" class="difflineplus">+ * @param {string} htmlBody</span>
<a href="#l11.1066"></a><span id="l11.1066" class="difflineplus">+ * @param {module:client.callback} callback Optional.</span>
<a href="#l11.1067"></a><span id="l11.1067" class="difflineplus">+ * @return {module:client.Promise} Resolves: TODO</span>
<a href="#l11.1068"></a><span id="l11.1068" class="difflineplus">+ * @return {module:http-api.MatrixError} Rejects: with an error response.</span>
<a href="#l11.1069"></a><span id="l11.1069" class="difflineplus">+ */</span>
<a href="#l11.1070"></a><span id="l11.1070" class="difflineplus">+MatrixClient.prototype.sendHtmlEmote = function(roomId, body, htmlBody, callback) {</span>
<a href="#l11.1071"></a><span id="l11.1071" class="difflineplus">+    var content = {</span>
<a href="#l11.1072"></a><span id="l11.1072" class="difflineplus">+        msgtype: &quot;m.emote&quot;,</span>
<a href="#l11.1073"></a><span id="l11.1073" class="difflineplus">+        format: &quot;org.matrix.custom.html&quot;,</span>
<a href="#l11.1074"></a><span id="l11.1074" class="difflineplus">+        body: body,</span>
<a href="#l11.1075"></a><span id="l11.1075" class="difflineplus">+        formatted_body: htmlBody</span>
<a href="#l11.1076"></a><span id="l11.1076" class="difflineplus">+    };</span>
<a href="#l11.1077"></a><span id="l11.1077" class="difflineplus">+    return this.sendMessage(roomId, content, callback);</span>
<a href="#l11.1078"></a><span id="l11.1078" class="difflineplus">+};</span>
<a href="#l11.1079"></a><span id="l11.1079" class="difflineplus">+</span>
<a href="#l11.1080"></a><span id="l11.1080" class="difflineplus">+/**</span>
<a href="#l11.1081"></a><span id="l11.1081" class="difflineplus">+ * Send a receipt.</span>
<a href="#l11.1082"></a><span id="l11.1082" class="difflineplus">+ * @param {Event} event The event being acknowledged</span>
<a href="#l11.1083"></a><span id="l11.1083" class="difflineplus">+ * @param {string} receiptType The kind of receipt e.g. &quot;m.read&quot;</span>
<a href="#l11.1084"></a><span id="l11.1084" class="difflineplus">+ * @param {module:client.callback} callback Optional.</span>
<a href="#l11.1085"></a><span id="l11.1085" class="difflineplus">+ * @return {module:client.Promise} Resolves: TODO</span>
<a href="#l11.1086"></a><span id="l11.1086" class="difflineplus">+ * @return {module:http-api.MatrixError} Rejects: with an error response.</span>
<a href="#l11.1087"></a><span id="l11.1087" class="difflineplus">+ */</span>
<a href="#l11.1088"></a><span id="l11.1088" class="difflineplus">+MatrixClient.prototype.sendReceipt = function(event, receiptType, callback) {</span>
<a href="#l11.1089"></a><span id="l11.1089" class="difflineplus">+    if (this.isGuest()) {</span>
<a href="#l11.1090"></a><span id="l11.1090" class="difflineplus">+        return q({}); // guests cannot send receipts so don't bother.</span>
<a href="#l11.1091"></a><span id="l11.1091" class="difflineplus">+    }</span>
<a href="#l11.1092"></a><span id="l11.1092" class="difflineplus">+</span>
<a href="#l11.1093"></a><span id="l11.1093" class="difflineplus">+    var path = utils.encodeUri(&quot;/rooms/$roomId/receipt/$receiptType/$eventId&quot;, {</span>
<a href="#l11.1094"></a><span id="l11.1094" class="difflineplus">+        $roomId: event.getRoomId(),</span>
<a href="#l11.1095"></a><span id="l11.1095" class="difflineplus">+        $receiptType: receiptType,</span>
<a href="#l11.1096"></a><span id="l11.1096" class="difflineplus">+        $eventId: event.getId()</span>
<a href="#l11.1097"></a><span id="l11.1097" class="difflineplus">+    });</span>
<a href="#l11.1098"></a><span id="l11.1098" class="difflineplus">+    var promise = this._http.authedRequest(</span>
<a href="#l11.1099"></a><span id="l11.1099" class="difflineplus">+        callback, &quot;POST&quot;, path, undefined, {}</span>
<a href="#l11.1100"></a><span id="l11.1100" class="difflineplus">+    );</span>
<a href="#l11.1101"></a><span id="l11.1101" class="difflineplus">+</span>
<a href="#l11.1102"></a><span id="l11.1102" class="difflineplus">+    var room = this.getRoom(event.getRoomId());</span>
<a href="#l11.1103"></a><span id="l11.1103" class="difflineplus">+    if (room) {</span>
<a href="#l11.1104"></a><span id="l11.1104" class="difflineplus">+        room._addLocalEchoReceipt(this.credentials.userId, event, receiptType);</span>
<a href="#l11.1105"></a><span id="l11.1105" class="difflineplus">+    }</span>
<a href="#l11.1106"></a><span id="l11.1106" class="difflineplus">+    return promise;</span>
<a href="#l11.1107"></a><span id="l11.1107" class="difflineplus">+};</span>
<a href="#l11.1108"></a><span id="l11.1108" class="difflineplus">+</span>
<a href="#l11.1109"></a><span id="l11.1109" class="difflineplus">+/**</span>
<a href="#l11.1110"></a><span id="l11.1110" class="difflineplus">+ * Send a read receipt.</span>
<a href="#l11.1111"></a><span id="l11.1111" class="difflineplus">+ * @param {Event} event The event that has been read.</span>
<a href="#l11.1112"></a><span id="l11.1112" class="difflineplus">+ * @param {module:client.callback} callback Optional.</span>
<a href="#l11.1113"></a><span id="l11.1113" class="difflineplus">+ * @return {module:client.Promise} Resolves: TODO</span>
<a href="#l11.1114"></a><span id="l11.1114" class="difflineplus">+ * @return {module:http-api.MatrixError} Rejects: with an error response.</span>
<a href="#l11.1115"></a><span id="l11.1115" class="difflineplus">+ */</span>
<a href="#l11.1116"></a><span id="l11.1116" class="difflineplus">+MatrixClient.prototype.sendReadReceipt = function(event, callback) {</span>
<a href="#l11.1117"></a><span id="l11.1117" class="difflineplus">+    return this.sendReceipt(event, &quot;m.read&quot;, callback);</span>
<a href="#l11.1118"></a><span id="l11.1118" class="difflineplus">+};</span>
<a href="#l11.1119"></a><span id="l11.1119" class="difflineplus">+</span>
<a href="#l11.1120"></a><span id="l11.1120" class="difflineplus">+</span>
<a href="#l11.1121"></a><span id="l11.1121" class="difflineplus">+/**</span>
<a href="#l11.1122"></a><span id="l11.1122" class="difflineplus">+ * Get a preview of the given URL as of (roughly) the given point in time,</span>
<a href="#l11.1123"></a><span id="l11.1123" class="difflineplus">+ * described as an object with OpenGraph keys and associated values.</span>
<a href="#l11.1124"></a><span id="l11.1124" class="difflineplus">+ * Attributes may be synthesized where actual OG metadata is lacking.</span>
<a href="#l11.1125"></a><span id="l11.1125" class="difflineplus">+ * Caches results to prevent hammering the server.</span>
<a href="#l11.1126"></a><span id="l11.1126" class="difflineplus">+ * @param {string} url The URL to get preview data for</span>
<a href="#l11.1127"></a><span id="l11.1127" class="difflineplus">+ * @param {Number} ts The preferred point in time that the preview should</span>
<a href="#l11.1128"></a><span id="l11.1128" class="difflineplus">+ * describe (ms since epoch).  The preview returned will either be the most</span>
<a href="#l11.1129"></a><span id="l11.1129" class="difflineplus">+ * recent one preceding this timestamp if available, or failing that the next</span>
<a href="#l11.1130"></a><span id="l11.1130" class="difflineplus">+ * most recent available preview.</span>
<a href="#l11.1131"></a><span id="l11.1131" class="difflineplus">+ * @param {module:client.callback} callback Optional.</span>
<a href="#l11.1132"></a><span id="l11.1132" class="difflineplus">+ * @return {module:client.Promise} Resolves: Object of OG metadata.</span>
<a href="#l11.1133"></a><span id="l11.1133" class="difflineplus">+ * @return {module:http-api.MatrixError} Rejects: with an error response.</span>
<a href="#l11.1134"></a><span id="l11.1134" class="difflineplus">+ * May return synthesized attributes if the URL lacked OG meta.</span>
<a href="#l11.1135"></a><span id="l11.1135" class="difflineplus">+ */</span>
<a href="#l11.1136"></a><span id="l11.1136" class="difflineplus">+MatrixClient.prototype.getUrlPreview = function(url, ts, callback) {</span>
<a href="#l11.1137"></a><span id="l11.1137" class="difflineplus">+    var key = ts + &quot;_&quot; + url;</span>
<a href="#l11.1138"></a><span id="l11.1138" class="difflineplus">+    var og = this.urlPreviewCache[key];</span>
<a href="#l11.1139"></a><span id="l11.1139" class="difflineplus">+    if (og) {</span>
<a href="#l11.1140"></a><span id="l11.1140" class="difflineplus">+        return q(og);</span>
<a href="#l11.1141"></a><span id="l11.1141" class="difflineplus">+    }</span>
<a href="#l11.1142"></a><span id="l11.1142" class="difflineplus">+</span>
<a href="#l11.1143"></a><span id="l11.1143" class="difflineplus">+    var self = this;</span>
<a href="#l11.1144"></a><span id="l11.1144" class="difflineplus">+    return this._http.authedRequestWithPrefix(</span>
<a href="#l11.1145"></a><span id="l11.1145" class="difflineplus">+        callback, &quot;GET&quot;, &quot;/preview_url&quot;, {</span>
<a href="#l11.1146"></a><span id="l11.1146" class="difflineplus">+            url: url,</span>
<a href="#l11.1147"></a><span id="l11.1147" class="difflineplus">+            ts: ts,</span>
<a href="#l11.1148"></a><span id="l11.1148" class="difflineplus">+        }, undefined, httpApi.PREFIX_MEDIA_R0</span>
<a href="#l11.1149"></a><span id="l11.1149" class="difflineplus">+    ).then(function(response) {</span>
<a href="#l11.1150"></a><span id="l11.1150" class="difflineplus">+        // TODO: expire cache occasionally</span>
<a href="#l11.1151"></a><span id="l11.1151" class="difflineplus">+        self.urlPreviewCache[key] = response;</span>
<a href="#l11.1152"></a><span id="l11.1152" class="difflineplus">+        return response;</span>
<a href="#l11.1153"></a><span id="l11.1153" class="difflineplus">+    });</span>
<a href="#l11.1154"></a><span id="l11.1154" class="difflineplus">+};</span>
<a href="#l11.1155"></a><span id="l11.1155" class="difflineplus">+</span>
<a href="#l11.1156"></a><span id="l11.1156" class="difflineplus">+/**</span>
<a href="#l11.1157"></a><span id="l11.1157" class="difflineplus">+ * @param {string} roomId</span>
<a href="#l11.1158"></a><span id="l11.1158" class="difflineplus">+ * @param {boolean} isTyping</span>
<a href="#l11.1159"></a><span id="l11.1159" class="difflineplus">+ * @param {Number} timeoutMs</span>
<a href="#l11.1160"></a><span id="l11.1160" class="difflineplus">+ * @param {module:client.callback} callback Optional.</span>
<a href="#l11.1161"></a><span id="l11.1161" class="difflineplus">+ * @return {module:client.Promise} Resolves: TODO</span>
<a href="#l11.1162"></a><span id="l11.1162" class="difflineplus">+ * @return {module:http-api.MatrixError} Rejects: with an error response.</span>
<a href="#l11.1163"></a><span id="l11.1163" class="difflineplus">+ */</span>
<a href="#l11.1164"></a><span id="l11.1164" class="difflineplus">+MatrixClient.prototype.sendTyping = function(roomId, isTyping, timeoutMs, callback) {</span>
<a href="#l11.1165"></a><span id="l11.1165" class="difflineplus">+    if (this.isGuest()) {</span>
<a href="#l11.1166"></a><span id="l11.1166" class="difflineplus">+        return q({}); // guests cannot send typing notifications so don't bother.</span>
<a href="#l11.1167"></a><span id="l11.1167" class="difflineplus">+    }</span>
<a href="#l11.1168"></a><span id="l11.1168" class="difflineplus">+</span>
<a href="#l11.1169"></a><span id="l11.1169" class="difflineplus">+    var path = utils.encodeUri(&quot;/rooms/$roomId/typing/$userId&quot;, {</span>
<a href="#l11.1170"></a><span id="l11.1170" class="difflineplus">+        $roomId: roomId,</span>
<a href="#l11.1171"></a><span id="l11.1171" class="difflineplus">+        $userId: this.credentials.userId</span>
<a href="#l11.1172"></a><span id="l11.1172" class="difflineplus">+    });</span>
<a href="#l11.1173"></a><span id="l11.1173" class="difflineplus">+    var data = {</span>
<a href="#l11.1174"></a><span id="l11.1174" class="difflineplus">+        typing: isTyping</span>
<a href="#l11.1175"></a><span id="l11.1175" class="difflineplus">+    };</span>
<a href="#l11.1176"></a><span id="l11.1176" class="difflineplus">+    if (isTyping) {</span>
<a href="#l11.1177"></a><span id="l11.1177" class="difflineplus">+        data.timeout = timeoutMs ? timeoutMs : 20000;</span>
<a href="#l11.1178"></a><span id="l11.1178" class="difflineplus">+    }</span>
<a href="#l11.1179"></a><span id="l11.1179" class="difflineplus">+    return this._http.authedRequest(</span>
<a href="#l11.1180"></a><span id="l11.1180" class="difflineplus">+        callback, &quot;PUT&quot;, path, undefined, data</span>
<a href="#l11.1181"></a><span id="l11.1181" class="difflineplus">+    );</span>
<a href="#l11.1182"></a><span id="l11.1182" class="difflineplus">+};</span>
<a href="#l11.1183"></a><span id="l11.1183" class="difflineplus">+</span>
<a href="#l11.1184"></a><span id="l11.1184" class="difflineplus">+/**</span>
<a href="#l11.1185"></a><span id="l11.1185" class="difflineplus">+ * @param {string} roomId</span>
<a href="#l11.1186"></a><span id="l11.1186" class="difflineplus">+ * @param {string} userId</span>
<a href="#l11.1187"></a><span id="l11.1187" class="difflineplus">+ * @param {module:client.callback} callback Optional.</span>
<a href="#l11.1188"></a><span id="l11.1188" class="difflineplus">+ * @return {module:client.Promise} Resolves: TODO</span>
<a href="#l11.1189"></a><span id="l11.1189" class="difflineplus">+ * @return {module:http-api.MatrixError} Rejects: with an error response.</span>
<a href="#l11.1190"></a><span id="l11.1190" class="difflineplus">+ */</span>
<a href="#l11.1191"></a><span id="l11.1191" class="difflineplus">+MatrixClient.prototype.invite = function(roomId, userId, callback) {</span>
<a href="#l11.1192"></a><span id="l11.1192" class="difflineplus">+    return _membershipChange(this, roomId, userId, &quot;invite&quot;, undefined,</span>
<a href="#l11.1193"></a><span id="l11.1193" class="difflineplus">+        callback);</span>
<a href="#l11.1194"></a><span id="l11.1194" class="difflineplus">+};</span>
<a href="#l11.1195"></a><span id="l11.1195" class="difflineplus">+</span>
<a href="#l11.1196"></a><span id="l11.1196" class="difflineplus">+/**</span>
<a href="#l11.1197"></a><span id="l11.1197" class="difflineplus">+ * Invite a user to a room based on their email address.</span>
<a href="#l11.1198"></a><span id="l11.1198" class="difflineplus">+ * @param {string} roomId The room to invite the user to.</span>
<a href="#l11.1199"></a><span id="l11.1199" class="difflineplus">+ * @param {string} email The email address to invite.</span>
<a href="#l11.1200"></a><span id="l11.1200" class="difflineplus">+ * @param {module:client.callback} callback Optional.</span>
<a href="#l11.1201"></a><span id="l11.1201" class="difflineplus">+ * @return {module:client.Promise} Resolves: TODO</span>
<a href="#l11.1202"></a><span id="l11.1202" class="difflineplus">+ * @return {module:http-api.MatrixError} Rejects: with an error response.</span>
<a href="#l11.1203"></a><span id="l11.1203" class="difflineplus">+ */</span>
<a href="#l11.1204"></a><span id="l11.1204" class="difflineplus">+MatrixClient.prototype.inviteByEmail = function(roomId, email, callback) {</span>
<a href="#l11.1205"></a><span id="l11.1205" class="difflineplus">+    return this.inviteByThreePid(</span>
<a href="#l11.1206"></a><span id="l11.1206" class="difflineplus">+        roomId, &quot;email&quot;, email, callback</span>
<a href="#l11.1207"></a><span id="l11.1207" class="difflineplus">+    );</span>
<a href="#l11.1208"></a><span id="l11.1208" class="difflineplus">+};</span>
<a href="#l11.1209"></a><span id="l11.1209" class="difflineplus">+</span>
<a href="#l11.1210"></a><span id="l11.1210" class="difflineplus">+/**</span>
<a href="#l11.1211"></a><span id="l11.1211" class="difflineplus">+ * Invite a user to a room based on a third-party identifier.</span>
<a href="#l11.1212"></a><span id="l11.1212" class="difflineplus">+ * @param {string} roomId The room to invite the user to.</span>
<a href="#l11.1213"></a><span id="l11.1213" class="difflineplus">+ * @param {string} medium The medium to invite the user e.g. &quot;email&quot;.</span>
<a href="#l11.1214"></a><span id="l11.1214" class="difflineplus">+ * @param {string} address The address for the specified medium.</span>
<a href="#l11.1215"></a><span id="l11.1215" class="difflineplus">+ * @param {module:client.callback} callback Optional.</span>
<a href="#l11.1216"></a><span id="l11.1216" class="difflineplus">+ * @return {module:client.Promise} Resolves: TODO</span>
<a href="#l11.1217"></a><span id="l11.1217" class="difflineplus">+ * @return {module:http-api.MatrixError} Rejects: with an error response.</span>
<a href="#l11.1218"></a><span id="l11.1218" class="difflineplus">+ */</span>
<a href="#l11.1219"></a><span id="l11.1219" class="difflineplus">+MatrixClient.prototype.inviteByThreePid = function(roomId, medium, address, callback) {</span>
<a href="#l11.1220"></a><span id="l11.1220" class="difflineplus">+    var path = utils.encodeUri(</span>
<a href="#l11.1221"></a><span id="l11.1221" class="difflineplus">+        &quot;/rooms/$roomId/invite&quot;,</span>
<a href="#l11.1222"></a><span id="l11.1222" class="difflineplus">+        { $roomId: roomId }</span>
<a href="#l11.1223"></a><span id="l11.1223" class="difflineplus">+    );</span>
<a href="#l11.1224"></a><span id="l11.1224" class="difflineplus">+</span>
<a href="#l11.1225"></a><span id="l11.1225" class="difflineplus">+    var identityServerUrl = this.getIdentityServerUrl();</span>
<a href="#l11.1226"></a><span id="l11.1226" class="difflineplus">+    if (!identityServerUrl) {</span>
<a href="#l11.1227"></a><span id="l11.1227" class="difflineplus">+        return q.reject(new MatrixError({</span>
<a href="#l11.1228"></a><span id="l11.1228" class="difflineplus">+            error: &quot;No supplied identity server URL&quot;,</span>
<a href="#l11.1229"></a><span id="l11.1229" class="difflineplus">+            errcode: &quot;ORG.MATRIX.JSSDK_MISSING_PARAM&quot;</span>
<a href="#l11.1230"></a><span id="l11.1230" class="difflineplus">+        }));</span>
<a href="#l11.1231"></a><span id="l11.1231" class="difflineplus">+    }</span>
<a href="#l11.1232"></a><span id="l11.1232" class="difflineplus">+    if (identityServerUrl.indexOf(&quot;http://&quot;) === 0 ||</span>
<a href="#l11.1233"></a><span id="l11.1233" class="difflineplus">+            identityServerUrl.indexOf(&quot;https://&quot;) === 0) {</span>
<a href="#l11.1234"></a><span id="l11.1234" class="difflineplus">+        // this request must not have the protocol part because reasons</span>
<a href="#l11.1235"></a><span id="l11.1235" class="difflineplus">+        identityServerUrl = identityServerUrl.split(&quot;://&quot;)[1];</span>
<a href="#l11.1236"></a><span id="l11.1236" class="difflineplus">+    }</span>
<a href="#l11.1237"></a><span id="l11.1237" class="difflineplus">+</span>
<a href="#l11.1238"></a><span id="l11.1238" class="difflineplus">+    return this._http.authedRequest(callback, &quot;POST&quot;, path, undefined, {</span>
<a href="#l11.1239"></a><span id="l11.1239" class="difflineplus">+        id_server: identityServerUrl,</span>
<a href="#l11.1240"></a><span id="l11.1240" class="difflineplus">+        medium: medium,</span>
<a href="#l11.1241"></a><span id="l11.1241" class="difflineplus">+        address: address</span>
<a href="#l11.1242"></a><span id="l11.1242" class="difflineplus">+    });</span>
<a href="#l11.1243"></a><span id="l11.1243" class="difflineplus">+};</span>
<a href="#l11.1244"></a><span id="l11.1244" class="difflineplus">+</span>
<a href="#l11.1245"></a><span id="l11.1245" class="difflineplus">+/**</span>
<a href="#l11.1246"></a><span id="l11.1246" class="difflineplus">+ * @param {string} roomId</span>
<a href="#l11.1247"></a><span id="l11.1247" class="difflineplus">+ * @param {module:client.callback} callback Optional.</span>
<a href="#l11.1248"></a><span id="l11.1248" class="difflineplus">+ * @return {module:client.Promise} Resolves: TODO</span>
<a href="#l11.1249"></a><span id="l11.1249" class="difflineplus">+ * @return {module:http-api.MatrixError} Rejects: with an error response.</span>
<a href="#l11.1250"></a><span id="l11.1250" class="difflineplus">+ */</span>
<a href="#l11.1251"></a><span id="l11.1251" class="difflineplus">+MatrixClient.prototype.leave = function(roomId, callback) {</span>
<a href="#l11.1252"></a><span id="l11.1252" class="difflineplus">+    return _membershipChange(this, roomId, undefined, &quot;leave&quot;, undefined,</span>
<a href="#l11.1253"></a><span id="l11.1253" class="difflineplus">+        callback);</span>
<a href="#l11.1254"></a><span id="l11.1254" class="difflineplus">+};</span>
<a href="#l11.1255"></a><span id="l11.1255" class="difflineplus">+</span>
<a href="#l11.1256"></a><span id="l11.1256" class="difflineplus">+/**</span>
<a href="#l11.1257"></a><span id="l11.1257" class="difflineplus">+ * @param {string} roomId</span>
<a href="#l11.1258"></a><span id="l11.1258" class="difflineplus">+ * @param {string} userId</span>
<a href="#l11.1259"></a><span id="l11.1259" class="difflineplus">+ * @param {string} reason Optional.</span>
<a href="#l11.1260"></a><span id="l11.1260" class="difflineplus">+ * @param {module:client.callback} callback Optional.</span>
<a href="#l11.1261"></a><span id="l11.1261" class="difflineplus">+ * @return {module:client.Promise} Resolves: TODO</span>
<a href="#l11.1262"></a><span id="l11.1262" class="difflineplus">+ * @return {module:http-api.MatrixError} Rejects: with an error response.</span>
<a href="#l11.1263"></a><span id="l11.1263" class="difflineplus">+ */</span>
<a href="#l11.1264"></a><span id="l11.1264" class="difflineplus">+MatrixClient.prototype.ban = function(roomId, userId, reason, callback) {</span>
<a href="#l11.1265"></a><span id="l11.1265" class="difflineplus">+    return _membershipChange(this, roomId, userId, &quot;ban&quot;, reason,</span>
<a href="#l11.1266"></a><span id="l11.1266" class="difflineplus">+        callback);</span>
<a href="#l11.1267"></a><span id="l11.1267" class="difflineplus">+};</span>
<a href="#l11.1268"></a><span id="l11.1268" class="difflineplus">+</span>
<a href="#l11.1269"></a><span id="l11.1269" class="difflineplus">+/**</span>
<a href="#l11.1270"></a><span id="l11.1270" class="difflineplus">+ * @param {string} roomId</span>
<a href="#l11.1271"></a><span id="l11.1271" class="difflineplus">+ * @param {boolean} deleteRoom True to delete the room from the store on success.</span>
<a href="#l11.1272"></a><span id="l11.1272" class="difflineplus">+ * Default: true.</span>
<a href="#l11.1273"></a><span id="l11.1273" class="difflineplus">+ * @param {module:client.callback} callback Optional.</span>
<a href="#l11.1274"></a><span id="l11.1274" class="difflineplus">+ * @return {module:client.Promise} Resolves: TODO</span>
<a href="#l11.1275"></a><span id="l11.1275" class="difflineplus">+ * @return {module:http-api.MatrixError} Rejects: with an error response.</span>
<a href="#l11.1276"></a><span id="l11.1276" class="difflineplus">+ */</span>
<a href="#l11.1277"></a><span id="l11.1277" class="difflineplus">+MatrixClient.prototype.forget = function(roomId, deleteRoom, callback) {</span>
<a href="#l11.1278"></a><span id="l11.1278" class="difflineplus">+    if (deleteRoom === undefined) {</span>
<a href="#l11.1279"></a><span id="l11.1279" class="difflineplus">+        deleteRoom = true;</span>
<a href="#l11.1280"></a><span id="l11.1280" class="difflineplus">+    }</span>
<a href="#l11.1281"></a><span id="l11.1281" class="difflineplus">+    var promise = _membershipChange(this, roomId, undefined, &quot;forget&quot;, undefined,</span>
<a href="#l11.1282"></a><span id="l11.1282" class="difflineplus">+        callback);</span>
<a href="#l11.1283"></a><span id="l11.1283" class="difflineplus">+    if (!deleteRoom) {</span>
<a href="#l11.1284"></a><span id="l11.1284" class="difflineplus">+        return promise;</span>
<a href="#l11.1285"></a><span id="l11.1285" class="difflineplus">+    }</span>
<a href="#l11.1286"></a><span id="l11.1286" class="difflineplus">+    var self = this;</span>
<a href="#l11.1287"></a><span id="l11.1287" class="difflineplus">+    return promise.then(function(response) {</span>
<a href="#l11.1288"></a><span id="l11.1288" class="difflineplus">+        self.store.removeRoom(roomId);</span>
<a href="#l11.1289"></a><span id="l11.1289" class="difflineplus">+        self.emit(&quot;deleteRoom&quot;, roomId);</span>
<a href="#l11.1290"></a><span id="l11.1290" class="difflineplus">+        return response;</span>
<a href="#l11.1291"></a><span id="l11.1291" class="difflineplus">+    });</span>
<a href="#l11.1292"></a><span id="l11.1292" class="difflineplus">+};</span>
<a href="#l11.1293"></a><span id="l11.1293" class="difflineplus">+</span>
<a href="#l11.1294"></a><span id="l11.1294" class="difflineplus">+/**</span>
<a href="#l11.1295"></a><span id="l11.1295" class="difflineplus">+ * @param {string} roomId</span>
<a href="#l11.1296"></a><span id="l11.1296" class="difflineplus">+ * @param {string} userId</span>
<a href="#l11.1297"></a><span id="l11.1297" class="difflineplus">+ * @param {module:client.callback} callback Optional.</span>
<a href="#l11.1298"></a><span id="l11.1298" class="difflineplus">+ * @return {module:client.Promise} Resolves: TODO</span>
<a href="#l11.1299"></a><span id="l11.1299" class="difflineplus">+ * @return {module:http-api.MatrixError} Rejects: with an error response.</span>
<a href="#l11.1300"></a><span id="l11.1300" class="difflineplus">+ */</span>
<a href="#l11.1301"></a><span id="l11.1301" class="difflineplus">+MatrixClient.prototype.unban = function(roomId, userId, callback) {</span>
<a href="#l11.1302"></a><span id="l11.1302" class="difflineplus">+    // unbanning = set their state to leave</span>
<a href="#l11.1303"></a><span id="l11.1303" class="difflineplus">+    return _setMembershipState(</span>
<a href="#l11.1304"></a><span id="l11.1304" class="difflineplus">+        this, roomId, userId, &quot;leave&quot;, undefined, callback</span>
<a href="#l11.1305"></a><span id="l11.1305" class="difflineplus">+    );</span>
<a href="#l11.1306"></a><span id="l11.1306" class="difflineplus">+};</span>
<a href="#l11.1307"></a><span id="l11.1307" class="difflineplus">+</span>
<a href="#l11.1308"></a><span id="l11.1308" class="difflineplus">+/**</span>
<a href="#l11.1309"></a><span id="l11.1309" class="difflineplus">+ * @param {string} roomId</span>
<a href="#l11.1310"></a><span id="l11.1310" class="difflineplus">+ * @param {string} userId</span>
<a href="#l11.1311"></a><span id="l11.1311" class="difflineplus">+ * @param {string} reason Optional.</span>
<a href="#l11.1312"></a><span id="l11.1312" class="difflineplus">+ * @param {module:client.callback} callback Optional.</span>
<a href="#l11.1313"></a><span id="l11.1313" class="difflineplus">+ * @return {module:client.Promise} Resolves: TODO</span>
<a href="#l11.1314"></a><span id="l11.1314" class="difflineplus">+ * @return {module:http-api.MatrixError} Rejects: with an error response.</span>
<a href="#l11.1315"></a><span id="l11.1315" class="difflineplus">+ */</span>
<a href="#l11.1316"></a><span id="l11.1316" class="difflineplus">+MatrixClient.prototype.kick = function(roomId, userId, reason, callback) {</span>
<a href="#l11.1317"></a><span id="l11.1317" class="difflineplus">+    return _setMembershipState(</span>
<a href="#l11.1318"></a><span id="l11.1318" class="difflineplus">+        this, roomId, userId, &quot;leave&quot;, reason, callback</span>
<a href="#l11.1319"></a><span id="l11.1319" class="difflineplus">+    );</span>
<a href="#l11.1320"></a><span id="l11.1320" class="difflineplus">+};</span>
<a href="#l11.1321"></a><span id="l11.1321" class="difflineplus">+</span>
<a href="#l11.1322"></a><span id="l11.1322" class="difflineplus">+/**</span>
<a href="#l11.1323"></a><span id="l11.1323" class="difflineplus">+ * This is an internal method.</span>
<a href="#l11.1324"></a><span id="l11.1324" class="difflineplus">+ * @param {MatrixClient} client</span>
<a href="#l11.1325"></a><span id="l11.1325" class="difflineplus">+ * @param {string} roomId</span>
<a href="#l11.1326"></a><span id="l11.1326" class="difflineplus">+ * @param {string} userId</span>
<a href="#l11.1327"></a><span id="l11.1327" class="difflineplus">+ * @param {string} membershipValue</span>
<a href="#l11.1328"></a><span id="l11.1328" class="difflineplus">+ * @param {string} reason</span>
<a href="#l11.1329"></a><span id="l11.1329" class="difflineplus">+ * @param {module:client.callback} callback Optional.</span>
<a href="#l11.1330"></a><span id="l11.1330" class="difflineplus">+ * @return {module:client.Promise} Resolves: TODO</span>
<a href="#l11.1331"></a><span id="l11.1331" class="difflineplus">+ * @return {module:http-api.MatrixError} Rejects: with an error response.</span>
<a href="#l11.1332"></a><span id="l11.1332" class="difflineplus">+ */</span>
<a href="#l11.1333"></a><span id="l11.1333" class="difflineplus">+function _setMembershipState(client, roomId, userId, membershipValue, reason,</span>
<a href="#l11.1334"></a><span id="l11.1334" class="difflineplus">+                             callback) {</span>
<a href="#l11.1335"></a><span id="l11.1335" class="difflineplus">+    if (utils.isFunction(reason)) { callback = reason; reason = undefined; }</span>
<a href="#l11.1336"></a><span id="l11.1336" class="difflineplus">+</span>
<a href="#l11.1337"></a><span id="l11.1337" class="difflineplus">+    var path = utils.encodeUri(</span>
<a href="#l11.1338"></a><span id="l11.1338" class="difflineplus">+        &quot;/rooms/$roomId/state/m.room.member/$userId&quot;,</span>
<a href="#l11.1339"></a><span id="l11.1339" class="difflineplus">+        { $roomId: roomId, $userId: userId}</span>
<a href="#l11.1340"></a><span id="l11.1340" class="difflineplus">+    );</span>
<a href="#l11.1341"></a><span id="l11.1341" class="difflineplus">+</span>
<a href="#l11.1342"></a><span id="l11.1342" class="difflineplus">+    return client._http.authedRequest(callback, &quot;PUT&quot;, path, undefined, {</span>
<a href="#l11.1343"></a><span id="l11.1343" class="difflineplus">+        membership: membershipValue,</span>
<a href="#l11.1344"></a><span id="l11.1344" class="difflineplus">+        reason: reason</span>
<a href="#l11.1345"></a><span id="l11.1345" class="difflineplus">+    });</span>
<a href="#l11.1346"></a><span id="l11.1346" class="difflineplus">+}</span>
<a href="#l11.1347"></a><span id="l11.1347" class="difflineplus">+</span>
<a href="#l11.1348"></a><span id="l11.1348" class="difflineplus">+/**</span>
<a href="#l11.1349"></a><span id="l11.1349" class="difflineplus">+ * This is an internal method.</span>
<a href="#l11.1350"></a><span id="l11.1350" class="difflineplus">+ * @param {MatrixClient} client</span>
<a href="#l11.1351"></a><span id="l11.1351" class="difflineplus">+ * @param {string} roomId</span>
<a href="#l11.1352"></a><span id="l11.1352" class="difflineplus">+ * @param {string} userId</span>
<a href="#l11.1353"></a><span id="l11.1353" class="difflineplus">+ * @param {string} membership</span>
<a href="#l11.1354"></a><span id="l11.1354" class="difflineplus">+ * @param {string} reason</span>
<a href="#l11.1355"></a><span id="l11.1355" class="difflineplus">+ * @param {module:client.callback} callback Optional.</span>
<a href="#l11.1356"></a><span id="l11.1356" class="difflineplus">+ * @return {module:client.Promise} Resolves: TODO</span>
<a href="#l11.1357"></a><span id="l11.1357" class="difflineplus">+ * @return {module:http-api.MatrixError} Rejects: with an error response.</span>
<a href="#l11.1358"></a><span id="l11.1358" class="difflineplus">+ */</span>
<a href="#l11.1359"></a><span id="l11.1359" class="difflineplus">+function _membershipChange(client, roomId, userId, membership, reason, callback) {</span>
<a href="#l11.1360"></a><span id="l11.1360" class="difflineplus">+    if (utils.isFunction(reason)) { callback = reason; reason = undefined; }</span>
<a href="#l11.1361"></a><span id="l11.1361" class="difflineplus">+</span>
<a href="#l11.1362"></a><span id="l11.1362" class="difflineplus">+    var path = utils.encodeUri(&quot;/rooms/$room_id/$membership&quot;, {</span>
<a href="#l11.1363"></a><span id="l11.1363" class="difflineplus">+        $room_id: roomId,</span>
<a href="#l11.1364"></a><span id="l11.1364" class="difflineplus">+        $membership: membership</span>
<a href="#l11.1365"></a><span id="l11.1365" class="difflineplus">+    });</span>
<a href="#l11.1366"></a><span id="l11.1366" class="difflineplus">+    return client._http.authedRequest(</span>
<a href="#l11.1367"></a><span id="l11.1367" class="difflineplus">+        callback, &quot;POST&quot;, path, undefined, {</span>
<a href="#l11.1368"></a><span id="l11.1368" class="difflineplus">+            user_id: userId,  // may be undefined e.g. on leave</span>
<a href="#l11.1369"></a><span id="l11.1369" class="difflineplus">+            reason: reason</span>
<a href="#l11.1370"></a><span id="l11.1370" class="difflineplus">+        }</span>
<a href="#l11.1371"></a><span id="l11.1371" class="difflineplus">+    );</span>
<a href="#l11.1372"></a><span id="l11.1372" class="difflineplus">+}</span>
<a href="#l11.1373"></a><span id="l11.1373" class="difflineplus">+</span>
<a href="#l11.1374"></a><span id="l11.1374" class="difflineplus">+/**</span>
<a href="#l11.1375"></a><span id="l11.1375" class="difflineplus">+ * Obtain a dict of actions which should be performed for this event according</span>
<a href="#l11.1376"></a><span id="l11.1376" class="difflineplus">+ * to the push rules for this user.  Caches the dict on the event.</span>
<a href="#l11.1377"></a><span id="l11.1377" class="difflineplus">+ * @param {MatrixEvent} event The event to get push actions for.</span>
<a href="#l11.1378"></a><span id="l11.1378" class="difflineplus">+ * @return {module:pushprocessor~PushAction} A dict of actions to perform.</span>
<a href="#l11.1379"></a><span id="l11.1379" class="difflineplus">+ */</span>
<a href="#l11.1380"></a><span id="l11.1380" class="difflineplus">+MatrixClient.prototype.getPushActionsForEvent = function(event) {</span>
<a href="#l11.1381"></a><span id="l11.1381" class="difflineplus">+    if (!event.getPushActions()) {</span>
<a href="#l11.1382"></a><span id="l11.1382" class="difflineplus">+        var pushProcessor = new PushProcessor(this);</span>
<a href="#l11.1383"></a><span id="l11.1383" class="difflineplus">+        event.setPushActions(pushProcessor.actionsForEvent(event));</span>
<a href="#l11.1384"></a><span id="l11.1384" class="difflineplus">+    }</span>
<a href="#l11.1385"></a><span id="l11.1385" class="difflineplus">+    return event.getPushActions();</span>
<a href="#l11.1386"></a><span id="l11.1386" class="difflineplus">+};</span>
<a href="#l11.1387"></a><span id="l11.1387" class="difflineplus">+</span>
<a href="#l11.1388"></a><span id="l11.1388" class="difflineplus">+// Profile operations</span>
<a href="#l11.1389"></a><span id="l11.1389" class="difflineplus">+// ==================</span>
<a href="#l11.1390"></a><span id="l11.1390" class="difflineplus">+</span>
<a href="#l11.1391"></a><span id="l11.1391" class="difflineplus">+/**</span>
<a href="#l11.1392"></a><span id="l11.1392" class="difflineplus">+ * @param {string} info The kind of info to set (e.g. 'avatar_url')</span>
<a href="#l11.1393"></a><span id="l11.1393" class="difflineplus">+ * @param {Object} data The JSON object to set.</span>
<a href="#l11.1394"></a><span id="l11.1394" class="difflineplus">+ * @param {module:client.callback} callback Optional.</span>
<a href="#l11.1395"></a><span id="l11.1395" class="difflineplus">+ * @return {module:client.Promise} Resolves: TODO</span>
<a href="#l11.1396"></a><span id="l11.1396" class="difflineplus">+ * @return {module:http-api.MatrixError} Rejects: with an error response.</span>
<a href="#l11.1397"></a><span id="l11.1397" class="difflineplus">+ */</span>
<a href="#l11.1398"></a><span id="l11.1398" class="difflineplus">+MatrixClient.prototype.setProfileInfo = function(info, data, callback) {</span>
<a href="#l11.1399"></a><span id="l11.1399" class="difflineplus">+    var path = utils.encodeUri(&quot;/profile/$userId/$info&quot;, {</span>
<a href="#l11.1400"></a><span id="l11.1400" class="difflineplus">+        $userId: this.credentials.userId,</span>
<a href="#l11.1401"></a><span id="l11.1401" class="difflineplus">+        $info: info</span>
<a href="#l11.1402"></a><span id="l11.1402" class="difflineplus">+    });</span>
<a href="#l11.1403"></a><span id="l11.1403" class="difflineplus">+    return this._http.authedRequest(</span>
<a href="#l11.1404"></a><span id="l11.1404" class="difflineplus">+        callback, &quot;PUT&quot;, path, undefined, data</span>
<a href="#l11.1405"></a><span id="l11.1405" class="difflineplus">+    );</span>
<a href="#l11.1406"></a><span id="l11.1406" class="difflineplus">+};</span>
<a href="#l11.1407"></a><span id="l11.1407" class="difflineplus">+</span>
<a href="#l11.1408"></a><span id="l11.1408" class="difflineplus">+/**</span>
<a href="#l11.1409"></a><span id="l11.1409" class="difflineplus">+ * @param {string} name</span>
<a href="#l11.1410"></a><span id="l11.1410" class="difflineplus">+ * @param {module:client.callback} callback Optional.</span>
<a href="#l11.1411"></a><span id="l11.1411" class="difflineplus">+ * @return {module:client.Promise} Resolves: TODO</span>
<a href="#l11.1412"></a><span id="l11.1412" class="difflineplus">+ * @return {module:http-api.MatrixError} Rejects: with an error response.</span>
<a href="#l11.1413"></a><span id="l11.1413" class="difflineplus">+ */</span>
<a href="#l11.1414"></a><span id="l11.1414" class="difflineplus">+MatrixClient.prototype.setDisplayName = function(name, callback) {</span>
<a href="#l11.1415"></a><span id="l11.1415" class="difflineplus">+    return this.setProfileInfo(</span>
<a href="#l11.1416"></a><span id="l11.1416" class="difflineplus">+        &quot;displayname&quot;, { displayname: name }, callback</span>
<a href="#l11.1417"></a><span id="l11.1417" class="difflineplus">+    );</span>
<a href="#l11.1418"></a><span id="l11.1418" class="difflineplus">+};</span>
<a href="#l11.1419"></a><span id="l11.1419" class="difflineplus">+</span>
<a href="#l11.1420"></a><span id="l11.1420" class="difflineplus">+/**</span>
<a href="#l11.1421"></a><span id="l11.1421" class="difflineplus">+ * @param {string} url</span>
<a href="#l11.1422"></a><span id="l11.1422" class="difflineplus">+ * @param {module:client.callback} callback Optional.</span>
<a href="#l11.1423"></a><span id="l11.1423" class="difflineplus">+ * @return {module:client.Promise} Resolves: TODO</span>
<a href="#l11.1424"></a><span id="l11.1424" class="difflineplus">+ * @return {module:http-api.MatrixError} Rejects: with an error response.</span>
<a href="#l11.1425"></a><span id="l11.1425" class="difflineplus">+ */</span>
<a href="#l11.1426"></a><span id="l11.1426" class="difflineplus">+MatrixClient.prototype.setAvatarUrl = function(url, callback) {</span>
<a href="#l11.1427"></a><span id="l11.1427" class="difflineplus">+    return this.setProfileInfo(</span>
<a href="#l11.1428"></a><span id="l11.1428" class="difflineplus">+        &quot;avatar_url&quot;, { avatar_url: url }, callback</span>
<a href="#l11.1429"></a><span id="l11.1429" class="difflineplus">+    );</span>
<a href="#l11.1430"></a><span id="l11.1430" class="difflineplus">+};</span>
<a href="#l11.1431"></a><span id="l11.1431" class="difflineplus">+</span>
<a href="#l11.1432"></a><span id="l11.1432" class="difflineplus">+/**</span>
<a href="#l11.1433"></a><span id="l11.1433" class="difflineplus">+ * Turn an MXC URL into an HTTP one. &lt;strong&gt;This method is experimental and</span>
<a href="#l11.1434"></a><span id="l11.1434" class="difflineplus">+ * may change.&lt;/strong&gt;</span>
<a href="#l11.1435"></a><span id="l11.1435" class="difflineplus">+ * @param {string} mxcUrl The MXC URL</span>
<a href="#l11.1436"></a><span id="l11.1436" class="difflineplus">+ * @param {Number} width The desired width of the thumbnail.</span>
<a href="#l11.1437"></a><span id="l11.1437" class="difflineplus">+ * @param {Number} height The desired height of the thumbnail.</span>
<a href="#l11.1438"></a><span id="l11.1438" class="difflineplus">+ * @param {string} resizeMethod The thumbnail resize method to use, either</span>
<a href="#l11.1439"></a><span id="l11.1439" class="difflineplus">+ * &quot;crop&quot; or &quot;scale&quot;.</span>
<a href="#l11.1440"></a><span id="l11.1440" class="difflineplus">+ * @param {Boolean} allowDirectLinks If true, return any non-mxc URLs</span>
<a href="#l11.1441"></a><span id="l11.1441" class="difflineplus">+ * directly. Fetching such URLs will leak information about the user to</span>
<a href="#l11.1442"></a><span id="l11.1442" class="difflineplus">+ * anyone they share a room with. If false, will return null for such URLs.</span>
<a href="#l11.1443"></a><span id="l11.1443" class="difflineplus">+ * @return {?string} the avatar URL or null.</span>
<a href="#l11.1444"></a><span id="l11.1444" class="difflineplus">+ */</span>
<a href="#l11.1445"></a><span id="l11.1445" class="difflineplus">+MatrixClient.prototype.mxcUrlToHttp =</span>
<a href="#l11.1446"></a><span id="l11.1446" class="difflineplus">+        function(mxcUrl, width, height, resizeMethod, allowDirectLinks) {</span>
<a href="#l11.1447"></a><span id="l11.1447" class="difflineplus">+    return contentRepo.getHttpUriForMxc(</span>
<a href="#l11.1448"></a><span id="l11.1448" class="difflineplus">+        this.baseUrl, mxcUrl, width, height, resizeMethod, allowDirectLinks</span>
<a href="#l11.1449"></a><span id="l11.1449" class="difflineplus">+    );</span>
<a href="#l11.1450"></a><span id="l11.1450" class="difflineplus">+};</span>
<a href="#l11.1451"></a><span id="l11.1451" class="difflineplus">+</span>
<a href="#l11.1452"></a><span id="l11.1452" class="difflineplus">+/**</span>
<a href="#l11.1453"></a><span id="l11.1453" class="difflineplus">+ * @param {Object} opts Options to apply</span>
<a href="#l11.1454"></a><span id="l11.1454" class="difflineplus">+ * @param {string} opts.presence One of &quot;online&quot;, &quot;offline&quot; or &quot;unavailable&quot;</span>
<a href="#l11.1455"></a><span id="l11.1455" class="difflineplus">+ * @param {string} opts.status_msg The status message to attach.</span>
<a href="#l11.1456"></a><span id="l11.1456" class="difflineplus">+ * @param {module:client.callback} callback Optional.</span>
<a href="#l11.1457"></a><span id="l11.1457" class="difflineplus">+ * @return {module:client.Promise} Resolves: TODO</span>
<a href="#l11.1458"></a><span id="l11.1458" class="difflineplus">+ * @return {module:http-api.MatrixError} Rejects: with an error response.</span>
<a href="#l11.1459"></a><span id="l11.1459" class="difflineplus">+ * @throws If 'presence' isn't a valid presence enum value.</span>
<a href="#l11.1460"></a><span id="l11.1460" class="difflineplus">+ */</span>
<a href="#l11.1461"></a><span id="l11.1461" class="difflineplus">+MatrixClient.prototype.setPresence = function(opts, callback) {</span>
<a href="#l11.1462"></a><span id="l11.1462" class="difflineplus">+    var path = utils.encodeUri(&quot;/presence/$userId/status&quot;, {</span>
<a href="#l11.1463"></a><span id="l11.1463" class="difflineplus">+        $userId: this.credentials.userId</span>
<a href="#l11.1464"></a><span id="l11.1464" class="difflineplus">+    });</span>
<a href="#l11.1465"></a><span id="l11.1465" class="difflineplus">+</span>
<a href="#l11.1466"></a><span id="l11.1466" class="difflineplus">+    if (typeof opts === &quot;string&quot;) {</span>
<a href="#l11.1467"></a><span id="l11.1467" class="difflineplus">+      opts = { presence: opts };</span>
<a href="#l11.1468"></a><span id="l11.1468" class="difflineplus">+    }</span>
<a href="#l11.1469"></a><span id="l11.1469" class="difflineplus">+</span>
<a href="#l11.1470"></a><span id="l11.1470" class="difflineplus">+    var validStates = [&quot;offline&quot;, &quot;online&quot;, &quot;unavailable&quot;];</span>
<a href="#l11.1471"></a><span id="l11.1471" class="difflineplus">+    if (validStates.indexOf(opts.presence) == -1) {</span>
<a href="#l11.1472"></a><span id="l11.1472" class="difflineplus">+        throw new Error(&quot;Bad presence value: &quot; + opts.presence);</span>
<a href="#l11.1473"></a><span id="l11.1473" class="difflineplus">+    }</span>
<a href="#l11.1474"></a><span id="l11.1474" class="difflineplus">+    return this._http.authedRequest(</span>
<a href="#l11.1475"></a><span id="l11.1475" class="difflineplus">+        callback, &quot;PUT&quot;, path, undefined, opts</span>
<a href="#l11.1476"></a><span id="l11.1476" class="difflineplus">+    );</span>
<a href="#l11.1477"></a><span id="l11.1477" class="difflineplus">+};</span>
<a href="#l11.1478"></a><span id="l11.1478" class="difflineplus">+</span>
<a href="#l11.1479"></a><span id="l11.1479" class="difflineplus">+/**</span>
<a href="#l11.1480"></a><span id="l11.1480" class="difflineplus">+ * Retrieve older messages from the given room and put them in the timeline.</span>
<a href="#l11.1481"></a><span id="l11.1481" class="difflineplus">+ *</span>
<a href="#l11.1482"></a><span id="l11.1482" class="difflineplus">+ * If this is called multiple times whilst a request is ongoing, the &lt;i&gt;same&lt;/i&gt;</span>
<a href="#l11.1483"></a><span id="l11.1483" class="difflineplus">+ * Promise will be returned. If there was a problem requesting scrollback, there</span>
<a href="#l11.1484"></a><span id="l11.1484" class="difflineplus">+ * will be a small delay before another request can be made (to prevent tight-looping</span>
<a href="#l11.1485"></a><span id="l11.1485" class="difflineplus">+ * when there is no connection).</span>
<a href="#l11.1486"></a><span id="l11.1486" class="difflineplus">+ *</span>
<a href="#l11.1487"></a><span id="l11.1487" class="difflineplus">+ * @param {Room} room The room to get older messages in.</span>
<a href="#l11.1488"></a><span id="l11.1488" class="difflineplus">+ * @param {Integer} limit Optional. The maximum number of previous events to</span>
<a href="#l11.1489"></a><span id="l11.1489" class="difflineplus">+ * pull in. Default: 30.</span>
<a href="#l11.1490"></a><span id="l11.1490" class="difflineplus">+ * @param {module:client.callback} callback Optional.</span>
<a href="#l11.1491"></a><span id="l11.1491" class="difflineplus">+ * @return {module:client.Promise} Resolves: Room. If you are at the beginning</span>
<a href="#l11.1492"></a><span id="l11.1492" class="difflineplus">+ * of the timeline, &lt;code&gt;Room.oldState.paginationToken&lt;/code&gt; will be</span>
<a href="#l11.1493"></a><span id="l11.1493" class="difflineplus">+ * &lt;code&gt;null&lt;/code&gt;.</span>
<a href="#l11.1494"></a><span id="l11.1494" class="difflineplus">+ * @return {module:http-api.MatrixError} Rejects: with an error response.</span>
<a href="#l11.1495"></a><span id="l11.1495" class="difflineplus">+ */</span>
<a href="#l11.1496"></a><span id="l11.1496" class="difflineplus">+MatrixClient.prototype.scrollback = function(room, limit, callback) {</span>
<a href="#l11.1497"></a><span id="l11.1497" class="difflineplus">+    if (utils.isFunction(limit)) { callback = limit; limit = undefined; }</span>
<a href="#l11.1498"></a><span id="l11.1498" class="difflineplus">+    limit = limit || 30;</span>
<a href="#l11.1499"></a><span id="l11.1499" class="difflineplus">+    var timeToWaitMs = 0;</span>
<a href="#l11.1500"></a><span id="l11.1500" class="difflineplus">+</span>
<a href="#l11.1501"></a><span id="l11.1501" class="difflineplus">+    var info = this._ongoingScrollbacks[room.roomId] || {};</span>
<a href="#l11.1502"></a><span id="l11.1502" class="difflineplus">+    if (info.promise) {</span>
<a href="#l11.1503"></a><span id="l11.1503" class="difflineplus">+        return info.promise;</span>
<a href="#l11.1504"></a><span id="l11.1504" class="difflineplus">+    }</span>
<a href="#l11.1505"></a><span id="l11.1505" class="difflineplus">+    else if (info.errorTs) {</span>
<a href="#l11.1506"></a><span id="l11.1506" class="difflineplus">+        var timeWaitedMs = Date.now() - info.errorTs;</span>
<a href="#l11.1507"></a><span id="l11.1507" class="difflineplus">+        timeToWaitMs = Math.max(SCROLLBACK_DELAY_MS - timeWaitedMs, 0);</span>
<a href="#l11.1508"></a><span id="l11.1508" class="difflineplus">+    }</span>
<a href="#l11.1509"></a><span id="l11.1509" class="difflineplus">+</span>
<a href="#l11.1510"></a><span id="l11.1510" class="difflineplus">+    if (room.oldState.paginationToken === null) {</span>
<a href="#l11.1511"></a><span id="l11.1511" class="difflineplus">+        return q(room); // already at the start.</span>
<a href="#l11.1512"></a><span id="l11.1512" class="difflineplus">+    }</span>
<a href="#l11.1513"></a><span id="l11.1513" class="difflineplus">+    // attempt to grab more events from the store first</span>
<a href="#l11.1514"></a><span id="l11.1514" class="difflineplus">+    var numAdded = this.store.scrollback(room, limit).length;</span>
<a href="#l11.1515"></a><span id="l11.1515" class="difflineplus">+    if (numAdded === limit) {</span>
<a href="#l11.1516"></a><span id="l11.1516" class="difflineplus">+        // store contained everything we needed.</span>
<a href="#l11.1517"></a><span id="l11.1517" class="difflineplus">+        return q(room);</span>
<a href="#l11.1518"></a><span id="l11.1518" class="difflineplus">+    }</span>
<a href="#l11.1519"></a><span id="l11.1519" class="difflineplus">+    // reduce the required number of events appropriately</span>
<a href="#l11.1520"></a><span id="l11.1520" class="difflineplus">+    limit = limit - numAdded;</span>
<a href="#l11.1521"></a><span id="l11.1521" class="difflineplus">+</span>
<a href="#l11.1522"></a><span id="l11.1522" class="difflineplus">+    var path = utils.encodeUri(</span>
<a href="#l11.1523"></a><span id="l11.1523" class="difflineplus">+        &quot;/rooms/$roomId/messages&quot;, {$roomId: room.roomId}</span>
<a href="#l11.1524"></a><span id="l11.1524" class="difflineplus">+    );</span>
<a href="#l11.1525"></a><span id="l11.1525" class="difflineplus">+    var params = {</span>
<a href="#l11.1526"></a><span id="l11.1526" class="difflineplus">+        from: room.oldState.paginationToken,</span>
<a href="#l11.1527"></a><span id="l11.1527" class="difflineplus">+        limit: limit,</span>
<a href="#l11.1528"></a><span id="l11.1528" class="difflineplus">+        dir: 'b'</span>
<a href="#l11.1529"></a><span id="l11.1529" class="difflineplus">+    };</span>
<a href="#l11.1530"></a><span id="l11.1530" class="difflineplus">+    var defer = q.defer();</span>
<a href="#l11.1531"></a><span id="l11.1531" class="difflineplus">+    info = {</span>
<a href="#l11.1532"></a><span id="l11.1532" class="difflineplus">+        promise: defer.promise,</span>
<a href="#l11.1533"></a><span id="l11.1533" class="difflineplus">+        errorTs: null</span>
<a href="#l11.1534"></a><span id="l11.1534" class="difflineplus">+    };</span>
<a href="#l11.1535"></a><span id="l11.1535" class="difflineplus">+    var self = this;</span>
<a href="#l11.1536"></a><span id="l11.1536" class="difflineplus">+    // wait for a time before doing this request</span>
<a href="#l11.1537"></a><span id="l11.1537" class="difflineplus">+    // (which may be 0 in order not to special case the code paths)</span>
<a href="#l11.1538"></a><span id="l11.1538" class="difflineplus">+    q.delay(timeToWaitMs).then(function() {</span>
<a href="#l11.1539"></a><span id="l11.1539" class="difflineplus">+        return self._http.authedRequest(callback, &quot;GET&quot;, path, params);</span>
<a href="#l11.1540"></a><span id="l11.1540" class="difflineplus">+    }).done(function(res) {</span>
<a href="#l11.1541"></a><span id="l11.1541" class="difflineplus">+        var matrixEvents = utils.map(res.chunk, _PojoToMatrixEventMapper(self));</span>
<a href="#l11.1542"></a><span id="l11.1542" class="difflineplus">+        room.addEventsToTimeline(matrixEvents, true, room.getLiveTimeline());</span>
<a href="#l11.1543"></a><span id="l11.1543" class="difflineplus">+        room.oldState.paginationToken = res.end;</span>
<a href="#l11.1544"></a><span id="l11.1544" class="difflineplus">+        if (res.chunk.length === 0) {</span>
<a href="#l11.1545"></a><span id="l11.1545" class="difflineplus">+            room.oldState.paginationToken = null;</span>
<a href="#l11.1546"></a><span id="l11.1546" class="difflineplus">+        }</span>
<a href="#l11.1547"></a><span id="l11.1547" class="difflineplus">+        self.store.storeEvents(room, matrixEvents, res.end, true);</span>
<a href="#l11.1548"></a><span id="l11.1548" class="difflineplus">+        self._ongoingScrollbacks[room.roomId] = null;</span>
<a href="#l11.1549"></a><span id="l11.1549" class="difflineplus">+        _resolve(callback, defer, room);</span>
<a href="#l11.1550"></a><span id="l11.1550" class="difflineplus">+    }, function(err) {</span>
<a href="#l11.1551"></a><span id="l11.1551" class="difflineplus">+        self._ongoingScrollbacks[room.roomId] = {</span>
<a href="#l11.1552"></a><span id="l11.1552" class="difflineplus">+            errorTs: Date.now()</span>
<a href="#l11.1553"></a><span id="l11.1553" class="difflineplus">+        };</span>
<a href="#l11.1554"></a><span id="l11.1554" class="difflineplus">+        _reject(callback, defer, err);</span>
<a href="#l11.1555"></a><span id="l11.1555" class="difflineplus">+    });</span>
<a href="#l11.1556"></a><span id="l11.1556" class="difflineplus">+    this._ongoingScrollbacks[room.roomId] = info;</span>
<a href="#l11.1557"></a><span id="l11.1557" class="difflineplus">+    return defer.promise;</span>
<a href="#l11.1558"></a><span id="l11.1558" class="difflineplus">+};</span>
<a href="#l11.1559"></a><span id="l11.1559" class="difflineplus">+</span>
<a href="#l11.1560"></a><span id="l11.1560" class="difflineplus">+/**</span>
<a href="#l11.1561"></a><span id="l11.1561" class="difflineplus">+ * Take an EventContext, and back/forward-fill results.</span>
<a href="#l11.1562"></a><span id="l11.1562" class="difflineplus">+ *</span>
<a href="#l11.1563"></a><span id="l11.1563" class="difflineplus">+ * @param {module:models/event-context.EventContext} eventContext  context</span>
<a href="#l11.1564"></a><span id="l11.1564" class="difflineplus">+ *    object to be updated</span>
<a href="#l11.1565"></a><span id="l11.1565" class="difflineplus">+ * @param {Object}  opts</span>
<a href="#l11.1566"></a><span id="l11.1566" class="difflineplus">+ * @param {boolean} opts.backwards  true to fill backwards, false to go forwards</span>
<a href="#l11.1567"></a><span id="l11.1567" class="difflineplus">+ * @param {boolean} opts.limit      number of events to request</span>
<a href="#l11.1568"></a><span id="l11.1568" class="difflineplus">+ *</span>
<a href="#l11.1569"></a><span id="l11.1569" class="difflineplus">+ * @return {module:client.Promise} Resolves: updated EventContext object</span>
<a href="#l11.1570"></a><span id="l11.1570" class="difflineplus">+ * @return {Error} Rejects: with an error response.</span>
<a href="#l11.1571"></a><span id="l11.1571" class="difflineplus">+ */</span>
<a href="#l11.1572"></a><span id="l11.1572" class="difflineplus">+MatrixClient.prototype.paginateEventContext = function(eventContext, opts) {</span>
<a href="#l11.1573"></a><span id="l11.1573" class="difflineplus">+    // TODO: we should implement a backoff (as per scrollback()) to deal more</span>
<a href="#l11.1574"></a><span id="l11.1574" class="difflineplus">+    // nicely with HTTP errors.</span>
<a href="#l11.1575"></a><span id="l11.1575" class="difflineplus">+    opts = opts || {};</span>
<a href="#l11.1576"></a><span id="l11.1576" class="difflineplus">+    var backwards = opts.backwards || false;</span>
<a href="#l11.1577"></a><span id="l11.1577" class="difflineplus">+</span>
<a href="#l11.1578"></a><span id="l11.1578" class="difflineplus">+    var token = eventContext.getPaginateToken(backwards);</span>
<a href="#l11.1579"></a><span id="l11.1579" class="difflineplus">+    if (!token) {</span>
<a href="#l11.1580"></a><span id="l11.1580" class="difflineplus">+        // no more results.</span>
<a href="#l11.1581"></a><span id="l11.1581" class="difflineplus">+        return q.reject(new Error(&quot;No paginate token&quot;));</span>
<a href="#l11.1582"></a><span id="l11.1582" class="difflineplus">+    }</span>
<a href="#l11.1583"></a><span id="l11.1583" class="difflineplus">+</span>
<a href="#l11.1584"></a><span id="l11.1584" class="difflineplus">+    var dir = backwards ? 'b' : 'f';</span>
<a href="#l11.1585"></a><span id="l11.1585" class="difflineplus">+    var pendingRequest = eventContext._paginateRequests[dir];</span>
<a href="#l11.1586"></a><span id="l11.1586" class="difflineplus">+</span>
<a href="#l11.1587"></a><span id="l11.1587" class="difflineplus">+    if (pendingRequest) {</span>
<a href="#l11.1588"></a><span id="l11.1588" class="difflineplus">+        // already a request in progress - return the existing promise</span>
<a href="#l11.1589"></a><span id="l11.1589" class="difflineplus">+        return pendingRequest;</span>
<a href="#l11.1590"></a><span id="l11.1590" class="difflineplus">+    }</span>
<a href="#l11.1591"></a><span id="l11.1591" class="difflineplus">+</span>
<a href="#l11.1592"></a><span id="l11.1592" class="difflineplus">+    var path = utils.encodeUri(</span>
<a href="#l11.1593"></a><span id="l11.1593" class="difflineplus">+        &quot;/rooms/$roomId/messages&quot;, {$roomId: eventContext.getEvent().getRoomId()}</span>
<a href="#l11.1594"></a><span id="l11.1594" class="difflineplus">+    );</span>
<a href="#l11.1595"></a><span id="l11.1595" class="difflineplus">+    var params = {</span>
<a href="#l11.1596"></a><span id="l11.1596" class="difflineplus">+        from: token,</span>
<a href="#l11.1597"></a><span id="l11.1597" class="difflineplus">+        limit: ('limit' in opts) ? opts.limit : 30,</span>
<a href="#l11.1598"></a><span id="l11.1598" class="difflineplus">+        dir: dir</span>
<a href="#l11.1599"></a><span id="l11.1599" class="difflineplus">+    };</span>
<a href="#l11.1600"></a><span id="l11.1600" class="difflineplus">+</span>
<a href="#l11.1601"></a><span id="l11.1601" class="difflineplus">+    var self = this;</span>
<a href="#l11.1602"></a><span id="l11.1602" class="difflineplus">+    var promise =</span>
<a href="#l11.1603"></a><span id="l11.1603" class="difflineplus">+        self._http.authedRequest(undefined, &quot;GET&quot;, path, params</span>
<a href="#l11.1604"></a><span id="l11.1604" class="difflineplus">+    ).then(function(res) {</span>
<a href="#l11.1605"></a><span id="l11.1605" class="difflineplus">+        var token = res.end;</span>
<a href="#l11.1606"></a><span id="l11.1606" class="difflineplus">+        if (res.chunk.length === 0) {</span>
<a href="#l11.1607"></a><span id="l11.1607" class="difflineplus">+            token = null;</span>
<a href="#l11.1608"></a><span id="l11.1608" class="difflineplus">+        } else {</span>
<a href="#l11.1609"></a><span id="l11.1609" class="difflineplus">+            var matrixEvents = utils.map(res.chunk, self.getEventMapper());</span>
<a href="#l11.1610"></a><span id="l11.1610" class="difflineplus">+            if (backwards) {</span>
<a href="#l11.1611"></a><span id="l11.1611" class="difflineplus">+                // eventContext expects the events in timeline order, but</span>
<a href="#l11.1612"></a><span id="l11.1612" class="difflineplus">+                // back-pagination returns them in reverse order.</span>
<a href="#l11.1613"></a><span id="l11.1613" class="difflineplus">+                matrixEvents.reverse();</span>
<a href="#l11.1614"></a><span id="l11.1614" class="difflineplus">+            }</span>
<a href="#l11.1615"></a><span id="l11.1615" class="difflineplus">+            eventContext.addEvents(matrixEvents, backwards);</span>
<a href="#l11.1616"></a><span id="l11.1616" class="difflineplus">+        }</span>
<a href="#l11.1617"></a><span id="l11.1617" class="difflineplus">+        eventContext.setPaginateToken(token, backwards);</span>
<a href="#l11.1618"></a><span id="l11.1618" class="difflineplus">+        return eventContext;</span>
<a href="#l11.1619"></a><span id="l11.1619" class="difflineplus">+    }).finally(function() {</span>
<a href="#l11.1620"></a><span id="l11.1620" class="difflineplus">+        eventContext._paginateRequests[dir] = null;</span>
<a href="#l11.1621"></a><span id="l11.1621" class="difflineplus">+    });</span>
<a href="#l11.1622"></a><span id="l11.1622" class="difflineplus">+    eventContext._paginateRequests[dir] = promise;</span>
<a href="#l11.1623"></a><span id="l11.1623" class="difflineplus">+</span>
<a href="#l11.1624"></a><span id="l11.1624" class="difflineplus">+    return promise;</span>
<a href="#l11.1625"></a><span id="l11.1625" class="difflineplus">+};</span>
<a href="#l11.1626"></a><span id="l11.1626" class="difflineplus">+</span>
<a href="#l11.1627"></a><span id="l11.1627" class="difflineplus">+/**</span>
<a href="#l11.1628"></a><span id="l11.1628" class="difflineplus">+ * Get an EventTimeline for the given event</span>
<a href="#l11.1629"></a><span id="l11.1629" class="difflineplus">+ *</span>
<a href="#l11.1630"></a><span id="l11.1630" class="difflineplus">+ * &lt;p&gt;If the EventTimelineSet object already has the given event in its store, the</span>
<a href="#l11.1631"></a><span id="l11.1631" class="difflineplus">+ * corresponding timeline will be returned. Otherwise, a /context request is</span>
<a href="#l11.1632"></a><span id="l11.1632" class="difflineplus">+ * made, and used to construct an EventTimeline.</span>
<a href="#l11.1633"></a><span id="l11.1633" class="difflineplus">+ *</span>
<a href="#l11.1634"></a><span id="l11.1634" class="difflineplus">+ * @param {EventTimelineSet} timelineSet  The timelineSet to look for the event in</span>
<a href="#l11.1635"></a><span id="l11.1635" class="difflineplus">+ * @param {string} eventId  The ID of the event to look for</span>
<a href="#l11.1636"></a><span id="l11.1636" class="difflineplus">+ *</span>
<a href="#l11.1637"></a><span id="l11.1637" class="difflineplus">+ * @return {module:client.Promise} Resolves:</span>
<a href="#l11.1638"></a><span id="l11.1638" class="difflineplus">+ *    {@link module:models/event-timeline~EventTimeline} including the given</span>
<a href="#l11.1639"></a><span id="l11.1639" class="difflineplus">+ *    event</span>
<a href="#l11.1640"></a><span id="l11.1640" class="difflineplus">+ */</span>
<a href="#l11.1641"></a><span id="l11.1641" class="difflineplus">+MatrixClient.prototype.getEventTimeline = function(timelineSet, eventId) {</span>
<a href="#l11.1642"></a><span id="l11.1642" class="difflineplus">+    // don't allow any timeline support unless it's been enabled.</span>
<a href="#l11.1643"></a><span id="l11.1643" class="difflineplus">+    if (!this.timelineSupport) {</span>
<a href="#l11.1644"></a><span id="l11.1644" class="difflineplus">+        throw new Error(&quot;timeline support is disabled. Set the 'timelineSupport'&quot; +</span>
<a href="#l11.1645"></a><span id="l11.1645" class="difflineplus">+                    &quot; parameter to true when creating MatrixClient to enable&quot; +</span>
<a href="#l11.1646"></a><span id="l11.1646" class="difflineplus">+                    &quot; it.&quot;);</span>
<a href="#l11.1647"></a><span id="l11.1647" class="difflineplus">+    }</span>
<a href="#l11.1648"></a><span id="l11.1648" class="difflineplus">+</span>
<a href="#l11.1649"></a><span id="l11.1649" class="difflineplus">+    if (timelineSet.getTimelineForEvent(eventId)) {</span>
<a href="#l11.1650"></a><span id="l11.1650" class="difflineplus">+        return q(timelineSet.getTimelineForEvent(eventId));</span>
<a href="#l11.1651"></a><span id="l11.1651" class="difflineplus">+    }</span>
<a href="#l11.1652"></a><span id="l11.1652" class="difflineplus">+</span>
<a href="#l11.1653"></a><span id="l11.1653" class="difflineplus">+    var path = utils.encodeUri(</span>
<a href="#l11.1654"></a><span id="l11.1654" class="difflineplus">+        &quot;/rooms/$roomId/context/$eventId&quot;, {</span>
<a href="#l11.1655"></a><span id="l11.1655" class="difflineplus">+            $roomId: timelineSet.room.roomId,</span>
<a href="#l11.1656"></a><span id="l11.1656" class="difflineplus">+            $eventId: eventId,</span>
<a href="#l11.1657"></a><span id="l11.1657" class="difflineplus">+        }</span>
<a href="#l11.1658"></a><span id="l11.1658" class="difflineplus">+    );</span>
<a href="#l11.1659"></a><span id="l11.1659" class="difflineplus">+</span>
<a href="#l11.1660"></a><span id="l11.1660" class="difflineplus">+    // TODO: we should implement a backoff (as per scrollback()) to deal more</span>
<a href="#l11.1661"></a><span id="l11.1661" class="difflineplus">+    // nicely with HTTP errors.</span>
<a href="#l11.1662"></a><span id="l11.1662" class="difflineplus">+    var self = this;</span>
<a href="#l11.1663"></a><span id="l11.1663" class="difflineplus">+    var promise =</span>
<a href="#l11.1664"></a><span id="l11.1664" class="difflineplus">+        self._http.authedRequest(undefined, &quot;GET&quot;, path</span>
<a href="#l11.1665"></a><span id="l11.1665" class="difflineplus">+    ).then(function(res) {</span>
<a href="#l11.1666"></a><span id="l11.1666" class="difflineplus">+        if (!res.event) {</span>
<a href="#l11.1667"></a><span id="l11.1667" class="difflineplus">+            throw new Error(&quot;'event' not in '/context' result - homeserver too old?&quot;);</span>
<a href="#l11.1668"></a><span id="l11.1668" class="difflineplus">+        }</span>
<a href="#l11.1669"></a><span id="l11.1669" class="difflineplus">+</span>
<a href="#l11.1670"></a><span id="l11.1670" class="difflineplus">+        // by the time the request completes, the event might have ended up in</span>
<a href="#l11.1671"></a><span id="l11.1671" class="difflineplus">+        // the timeline.</span>
<a href="#l11.1672"></a><span id="l11.1672" class="difflineplus">+        if (timelineSet.getTimelineForEvent(eventId)) {</span>
<a href="#l11.1673"></a><span id="l11.1673" class="difflineplus">+            return timelineSet.getTimelineForEvent(eventId);</span>
<a href="#l11.1674"></a><span id="l11.1674" class="difflineplus">+        }</span>
<a href="#l11.1675"></a><span id="l11.1675" class="difflineplus">+</span>
<a href="#l11.1676"></a><span id="l11.1676" class="difflineplus">+        // we start with the last event, since that's the point at which we</span>
<a href="#l11.1677"></a><span id="l11.1677" class="difflineplus">+        // have known state.</span>
<a href="#l11.1678"></a><span id="l11.1678" class="difflineplus">+        // events_after is already backwards; events_before is forwards.</span>
<a href="#l11.1679"></a><span id="l11.1679" class="difflineplus">+        res.events_after.reverse();</span>
<a href="#l11.1680"></a><span id="l11.1680" class="difflineplus">+        var events = res.events_after</span>
<a href="#l11.1681"></a><span id="l11.1681" class="difflineplus">+            .concat([res.event])</span>
<a href="#l11.1682"></a><span id="l11.1682" class="difflineplus">+            .concat(res.events_before);</span>
<a href="#l11.1683"></a><span id="l11.1683" class="difflineplus">+        var matrixEvents = utils.map(events, self.getEventMapper());</span>
<a href="#l11.1684"></a><span id="l11.1684" class="difflineplus">+</span>
<a href="#l11.1685"></a><span id="l11.1685" class="difflineplus">+        var timeline = timelineSet.getTimelineForEvent(matrixEvents[0].getId());</span>
<a href="#l11.1686"></a><span id="l11.1686" class="difflineplus">+        if (!timeline) {</span>
<a href="#l11.1687"></a><span id="l11.1687" class="difflineplus">+            timeline = timelineSet.addTimeline();</span>
<a href="#l11.1688"></a><span id="l11.1688" class="difflineplus">+            timeline.initialiseState(utils.map(res.state,</span>
<a href="#l11.1689"></a><span id="l11.1689" class="difflineplus">+                                               self.getEventMapper()));</span>
<a href="#l11.1690"></a><span id="l11.1690" class="difflineplus">+            timeline.getState(EventTimeline.FORWARDS).paginationToken = res.end;</span>
<a href="#l11.1691"></a><span id="l11.1691" class="difflineplus">+        }</span>
<a href="#l11.1692"></a><span id="l11.1692" class="difflineplus">+        timelineSet.addEventsToTimeline(matrixEvents, true, timeline, res.start);</span>
<a href="#l11.1693"></a><span id="l11.1693" class="difflineplus">+</span>
<a href="#l11.1694"></a><span id="l11.1694" class="difflineplus">+        // there is no guarantee that the event ended up in &quot;timeline&quot; (we</span>
<a href="#l11.1695"></a><span id="l11.1695" class="difflineplus">+        // might have switched to a neighbouring timeline) - so check the</span>
<a href="#l11.1696"></a><span id="l11.1696" class="difflineplus">+        // room's index again. On the other hand, there's no guarantee the</span>
<a href="#l11.1697"></a><span id="l11.1697" class="difflineplus">+        // event ended up anywhere, if it was later redacted, so we just</span>
<a href="#l11.1698"></a><span id="l11.1698" class="difflineplus">+        // return the timeline we first thought of.</span>
<a href="#l11.1699"></a><span id="l11.1699" class="difflineplus">+        var tl = timelineSet.getTimelineForEvent(eventId) || timeline;</span>
<a href="#l11.1700"></a><span id="l11.1700" class="difflineplus">+        return tl;</span>
<a href="#l11.1701"></a><span id="l11.1701" class="difflineplus">+    });</span>
<a href="#l11.1702"></a><span id="l11.1702" class="difflineplus">+    return promise;</span>
<a href="#l11.1703"></a><span id="l11.1703" class="difflineplus">+};</span>
<a href="#l11.1704"></a><span id="l11.1704" class="difflineplus">+</span>
<a href="#l11.1705"></a><span id="l11.1705" class="difflineplus">+</span>
<a href="#l11.1706"></a><span id="l11.1706" class="difflineplus">+/**</span>
<a href="#l11.1707"></a><span id="l11.1707" class="difflineplus">+ * Take an EventTimeline, and back/forward-fill results.</span>
<a href="#l11.1708"></a><span id="l11.1708" class="difflineplus">+ *</span>
<a href="#l11.1709"></a><span id="l11.1709" class="difflineplus">+ * @param {module:models/event-timeline~EventTimeline} eventTimeline timeline</span>
<a href="#l11.1710"></a><span id="l11.1710" class="difflineplus">+ *    object to be updated</span>
<a href="#l11.1711"></a><span id="l11.1711" class="difflineplus">+ * @param {Object}   [opts]</span>
<a href="#l11.1712"></a><span id="l11.1712" class="difflineplus">+ * @param {bool}     [opts.backwards = false]  true to fill backwards,</span>
<a href="#l11.1713"></a><span id="l11.1713" class="difflineplus">+ *    false to go forwards</span>
<a href="#l11.1714"></a><span id="l11.1714" class="difflineplus">+ * @param {number}   [opts.limit = 30]         number of events to request</span>
<a href="#l11.1715"></a><span id="l11.1715" class="difflineplus">+ *</span>
<a href="#l11.1716"></a><span id="l11.1716" class="difflineplus">+ * @return {module:client.Promise} Resolves to a boolean: false if there are no</span>
<a href="#l11.1717"></a><span id="l11.1717" class="difflineplus">+ *    events and we reached either end of the timeline; else true.</span>
<a href="#l11.1718"></a><span id="l11.1718" class="difflineplus">+ */</span>
<a href="#l11.1719"></a><span id="l11.1719" class="difflineplus">+MatrixClient.prototype.paginateEventTimeline = function(eventTimeline, opts) {</span>
<a href="#l11.1720"></a><span id="l11.1720" class="difflineplus">+    var isNotifTimeline = (eventTimeline.getTimelineSet() === this._notifTimelineSet);</span>
<a href="#l11.1721"></a><span id="l11.1721" class="difflineplus">+</span>
<a href="#l11.1722"></a><span id="l11.1722" class="difflineplus">+    // TODO: we should implement a backoff (as per scrollback()) to deal more</span>
<a href="#l11.1723"></a><span id="l11.1723" class="difflineplus">+    // nicely with HTTP errors.</span>
<a href="#l11.1724"></a><span id="l11.1724" class="difflineplus">+    opts = opts || {};</span>
<a href="#l11.1725"></a><span id="l11.1725" class="difflineplus">+    var backwards = opts.backwards || false;</span>
<a href="#l11.1726"></a><span id="l11.1726" class="difflineplus">+</span>
<a href="#l11.1727"></a><span id="l11.1727" class="difflineplus">+    if (isNotifTimeline) {</span>
<a href="#l11.1728"></a><span id="l11.1728" class="difflineplus">+        if (!backwards) {</span>
<a href="#l11.1729"></a><span id="l11.1729" class="difflineplus">+            throw new Error(&quot;paginateNotifTimeline can only paginate backwards&quot;);</span>
<a href="#l11.1730"></a><span id="l11.1730" class="difflineplus">+        }</span>
<a href="#l11.1731"></a><span id="l11.1731" class="difflineplus">+    }</span>
<a href="#l11.1732"></a><span id="l11.1732" class="difflineplus">+</span>
<a href="#l11.1733"></a><span id="l11.1733" class="difflineplus">+    var dir = backwards ? EventTimeline.BACKWARDS : EventTimeline.FORWARDS;</span>
<a href="#l11.1734"></a><span id="l11.1734" class="difflineplus">+</span>
<a href="#l11.1735"></a><span id="l11.1735" class="difflineplus">+    var token = eventTimeline.getPaginationToken(dir);</span>
<a href="#l11.1736"></a><span id="l11.1736" class="difflineplus">+    if (!token) {</span>
<a href="#l11.1737"></a><span id="l11.1737" class="difflineplus">+        // no token - no results.</span>
<a href="#l11.1738"></a><span id="l11.1738" class="difflineplus">+        return q(false);</span>
<a href="#l11.1739"></a><span id="l11.1739" class="difflineplus">+    }</span>
<a href="#l11.1740"></a><span id="l11.1740" class="difflineplus">+</span>
<a href="#l11.1741"></a><span id="l11.1741" class="difflineplus">+    var pendingRequest = eventTimeline._paginationRequests[dir];</span>
<a href="#l11.1742"></a><span id="l11.1742" class="difflineplus">+</span>
<a href="#l11.1743"></a><span id="l11.1743" class="difflineplus">+    if (pendingRequest) {</span>
<a href="#l11.1744"></a><span id="l11.1744" class="difflineplus">+        // already a request in progress - return the existing promise</span>
<a href="#l11.1745"></a><span id="l11.1745" class="difflineplus">+        return pendingRequest;</span>
<a href="#l11.1746"></a><span id="l11.1746" class="difflineplus">+    }</span>
<a href="#l11.1747"></a><span id="l11.1747" class="difflineplus">+</span>
<a href="#l11.1748"></a><span id="l11.1748" class="difflineplus">+    var path, params, promise;</span>
<a href="#l11.1749"></a><span id="l11.1749" class="difflineplus">+    var self = this;</span>
<a href="#l11.1750"></a><span id="l11.1750" class="difflineplus">+</span>
<a href="#l11.1751"></a><span id="l11.1751" class="difflineplus">+    if (isNotifTimeline) {</span>
<a href="#l11.1752"></a><span id="l11.1752" class="difflineplus">+        path = &quot;/notifications&quot;;</span>
<a href="#l11.1753"></a><span id="l11.1753" class="difflineplus">+        params = {</span>
<a href="#l11.1754"></a><span id="l11.1754" class="difflineplus">+            limit: ('limit' in opts) ? opts.limit : 30,</span>
<a href="#l11.1755"></a><span id="l11.1755" class="difflineplus">+            only: 'highlight',</span>
<a href="#l11.1756"></a><span id="l11.1756" class="difflineplus">+        };</span>
<a href="#l11.1757"></a><span id="l11.1757" class="difflineplus">+</span>
<a href="#l11.1758"></a><span id="l11.1758" class="difflineplus">+        if (token &amp;&amp; token !== &quot;end&quot;) {</span>
<a href="#l11.1759"></a><span id="l11.1759" class="difflineplus">+            params.from = token;</span>
<a href="#l11.1760"></a><span id="l11.1760" class="difflineplus">+        }</span>
<a href="#l11.1761"></a><span id="l11.1761" class="difflineplus">+</span>
<a href="#l11.1762"></a><span id="l11.1762" class="difflineplus">+        promise =</span>
<a href="#l11.1763"></a><span id="l11.1763" class="difflineplus">+            this._http.authedRequestWithPrefix(undefined, &quot;GET&quot;, path, params,</span>
<a href="#l11.1764"></a><span id="l11.1764" class="difflineplus">+                undefined, httpApi.PREFIX_UNSTABLE</span>
<a href="#l11.1765"></a><span id="l11.1765" class="difflineplus">+        ).then(function(res) {</span>
<a href="#l11.1766"></a><span id="l11.1766" class="difflineplus">+            var token = res.next_token;</span>
<a href="#l11.1767"></a><span id="l11.1767" class="difflineplus">+            var matrixEvents = [];</span>
<a href="#l11.1768"></a><span id="l11.1768" class="difflineplus">+</span>
<a href="#l11.1769"></a><span id="l11.1769" class="difflineplus">+            for (var i = 0; i &lt; res.notifications.length; i++) {</span>
<a href="#l11.1770"></a><span id="l11.1770" class="difflineplus">+                var notification = res.notifications[i];</span>
<a href="#l11.1771"></a><span id="l11.1771" class="difflineplus">+                var event = self.getEventMapper()(notification.event);</span>
<a href="#l11.1772"></a><span id="l11.1772" class="difflineplus">+                event.setPushActions(</span>
<a href="#l11.1773"></a><span id="l11.1773" class="difflineplus">+                    PushProcessor.actionListToActionsObject(notification.actions)</span>
<a href="#l11.1774"></a><span id="l11.1774" class="difflineplus">+                );</span>
<a href="#l11.1775"></a><span id="l11.1775" class="difflineplus">+                event.event.room_id = notification.room_id; // XXX: gutwrenching</span>
<a href="#l11.1776"></a><span id="l11.1776" class="difflineplus">+                matrixEvents[i] = event;</span>
<a href="#l11.1777"></a><span id="l11.1777" class="difflineplus">+            }</span>
<a href="#l11.1778"></a><span id="l11.1778" class="difflineplus">+</span>
<a href="#l11.1779"></a><span id="l11.1779" class="difflineplus">+            eventTimeline.getTimelineSet()</span>
<a href="#l11.1780"></a><span id="l11.1780" class="difflineplus">+                .addEventsToTimeline(matrixEvents, backwards, eventTimeline, token);</span>
<a href="#l11.1781"></a><span id="l11.1781" class="difflineplus">+</span>
<a href="#l11.1782"></a><span id="l11.1782" class="difflineplus">+            // if we've hit the end of the timeline, we need to stop trying to</span>
<a href="#l11.1783"></a><span id="l11.1783" class="difflineplus">+            // paginate. We need to keep the 'forwards' token though, to make sure</span>
<a href="#l11.1784"></a><span id="l11.1784" class="difflineplus">+            // we can recover from gappy syncs.</span>
<a href="#l11.1785"></a><span id="l11.1785" class="difflineplus">+            if (backwards &amp;&amp; !res.next_token) {</span>
<a href="#l11.1786"></a><span id="l11.1786" class="difflineplus">+                eventTimeline.setPaginationToken(null, dir);</span>
<a href="#l11.1787"></a><span id="l11.1787" class="difflineplus">+            }</span>
<a href="#l11.1788"></a><span id="l11.1788" class="difflineplus">+            return res.next_token ? true : false;</span>
<a href="#l11.1789"></a><span id="l11.1789" class="difflineplus">+        }).finally(function() {</span>
<a href="#l11.1790"></a><span id="l11.1790" class="difflineplus">+            eventTimeline._paginationRequests[dir] = null;</span>
<a href="#l11.1791"></a><span id="l11.1791" class="difflineplus">+        });</span>
<a href="#l11.1792"></a><span id="l11.1792" class="difflineplus">+        eventTimeline._paginationRequests[dir] = promise;</span>
<a href="#l11.1793"></a><span id="l11.1793" class="difflineplus">+    }</span>
<a href="#l11.1794"></a><span id="l11.1794" class="difflineplus">+    else {</span>
<a href="#l11.1795"></a><span id="l11.1795" class="difflineplus">+        var room = this.getRoom(eventTimeline.getRoomId());</span>
<a href="#l11.1796"></a><span id="l11.1796" class="difflineplus">+        if (!room) {</span>
<a href="#l11.1797"></a><span id="l11.1797" class="difflineplus">+            throw new Error(&quot;Unknown room &quot; + eventTimeline.getRoomId());</span>
<a href="#l11.1798"></a><span id="l11.1798" class="difflineplus">+        }</span>
<a href="#l11.1799"></a><span id="l11.1799" class="difflineplus">+</span>
<a href="#l11.1800"></a><span id="l11.1800" class="difflineplus">+        path = utils.encodeUri(</span>
<a href="#l11.1801"></a><span id="l11.1801" class="difflineplus">+            &quot;/rooms/$roomId/messages&quot;, {$roomId: eventTimeline.getRoomId()}</span>
<a href="#l11.1802"></a><span id="l11.1802" class="difflineplus">+        );</span>
<a href="#l11.1803"></a><span id="l11.1803" class="difflineplus">+        params = {</span>
<a href="#l11.1804"></a><span id="l11.1804" class="difflineplus">+            from: token,</span>
<a href="#l11.1805"></a><span id="l11.1805" class="difflineplus">+            limit: ('limit' in opts) ? opts.limit : 30,</span>
<a href="#l11.1806"></a><span id="l11.1806" class="difflineplus">+            dir: dir</span>
<a href="#l11.1807"></a><span id="l11.1807" class="difflineplus">+        };</span>
<a href="#l11.1808"></a><span id="l11.1808" class="difflineplus">+</span>
<a href="#l11.1809"></a><span id="l11.1809" class="difflineplus">+        var filter = eventTimeline.getFilter();</span>
<a href="#l11.1810"></a><span id="l11.1810" class="difflineplus">+        if (filter) {</span>
<a href="#l11.1811"></a><span id="l11.1811" class="difflineplus">+            // XXX: it's horrific that /messages' filter parameter doesn't match</span>
<a href="#l11.1812"></a><span id="l11.1812" class="difflineplus">+            // /sync's one - see https://matrix.org/jira/browse/SPEC-451</span>
<a href="#l11.1813"></a><span id="l11.1813" class="difflineplus">+            params.filter = JSON.stringify(filter.getRoomTimelineFilterComponent());</span>
<a href="#l11.1814"></a><span id="l11.1814" class="difflineplus">+        }</span>
<a href="#l11.1815"></a><span id="l11.1815" class="difflineplus">+</span>
<a href="#l11.1816"></a><span id="l11.1816" class="difflineplus">+        promise =</span>
<a href="#l11.1817"></a><span id="l11.1817" class="difflineplus">+            this._http.authedRequest(undefined, &quot;GET&quot;, path, params</span>
<a href="#l11.1818"></a><span id="l11.1818" class="difflineplus">+        ).then(function(res) {</span>
<a href="#l11.1819"></a><span id="l11.1819" class="difflineplus">+            var token = res.end;</span>
<a href="#l11.1820"></a><span id="l11.1820" class="difflineplus">+            var matrixEvents = utils.map(res.chunk, self.getEventMapper());</span>
<a href="#l11.1821"></a><span id="l11.1821" class="difflineplus">+            eventTimeline.getTimelineSet()</span>
<a href="#l11.1822"></a><span id="l11.1822" class="difflineplus">+                .addEventsToTimeline(matrixEvents, backwards, eventTimeline, token);</span>
<a href="#l11.1823"></a><span id="l11.1823" class="difflineplus">+</span>
<a href="#l11.1824"></a><span id="l11.1824" class="difflineplus">+            // if we've hit the end of the timeline, we need to stop trying to</span>
<a href="#l11.1825"></a><span id="l11.1825" class="difflineplus">+            // paginate. We need to keep the 'forwards' token though, to make sure</span>
<a href="#l11.1826"></a><span id="l11.1826" class="difflineplus">+            // we can recover from gappy syncs.</span>
<a href="#l11.1827"></a><span id="l11.1827" class="difflineplus">+            if (backwards &amp;&amp; res.end == res.start) {</span>
<a href="#l11.1828"></a><span id="l11.1828" class="difflineplus">+                eventTimeline.setPaginationToken(null, dir);</span>
<a href="#l11.1829"></a><span id="l11.1829" class="difflineplus">+            }</span>
<a href="#l11.1830"></a><span id="l11.1830" class="difflineplus">+            return res.end != res.start;</span>
<a href="#l11.1831"></a><span id="l11.1831" class="difflineplus">+        }).finally(function() {</span>
<a href="#l11.1832"></a><span id="l11.1832" class="difflineplus">+            eventTimeline._paginationRequests[dir] = null;</span>
<a href="#l11.1833"></a><span id="l11.1833" class="difflineplus">+        });</span>
<a href="#l11.1834"></a><span id="l11.1834" class="difflineplus">+        eventTimeline._paginationRequests[dir] = promise;</span>
<a href="#l11.1835"></a><span id="l11.1835" class="difflineplus">+    }</span>
<a href="#l11.1836"></a><span id="l11.1836" class="difflineplus">+</span>
<a href="#l11.1837"></a><span id="l11.1837" class="difflineplus">+    return promise;</span>
<a href="#l11.1838"></a><span id="l11.1838" class="difflineplus">+};</span>
<a href="#l11.1839"></a><span id="l11.1839" class="difflineplus">+</span>
<a href="#l11.1840"></a><span id="l11.1840" class="difflineplus">+/**</span>
<a href="#l11.1841"></a><span id="l11.1841" class="difflineplus">+ * Reset the notifTimelineSet entirely, paginating in some historical notifs as</span>
<a href="#l11.1842"></a><span id="l11.1842" class="difflineplus">+ * a starting point for subsequent pagination.</span>
<a href="#l11.1843"></a><span id="l11.1843" class="difflineplus">+ */</span>
<a href="#l11.1844"></a><span id="l11.1844" class="difflineplus">+MatrixClient.prototype.resetNotifTimelineSet = function() {</span>
<a href="#l11.1845"></a><span id="l11.1845" class="difflineplus">+    if (!this._notifTimelineSet) {</span>
<a href="#l11.1846"></a><span id="l11.1846" class="difflineplus">+        return;</span>
<a href="#l11.1847"></a><span id="l11.1847" class="difflineplus">+    }</span>
<a href="#l11.1848"></a><span id="l11.1848" class="difflineplus">+</span>
<a href="#l11.1849"></a><span id="l11.1849" class="difflineplus">+    // FIXME: This thing is a total hack, and results in duplicate events being</span>
<a href="#l11.1850"></a><span id="l11.1850" class="difflineplus">+    // added to the timeline both from /sync and /notifications, and lots of</span>
<a href="#l11.1851"></a><span id="l11.1851" class="difflineplus">+    // slow and wasteful processing and pagination.  The correct solution is to</span>
<a href="#l11.1852"></a><span id="l11.1852" class="difflineplus">+    // extend /messages or /search or something to filter on notifications.</span>
<a href="#l11.1853"></a><span id="l11.1853" class="difflineplus">+</span>
<a href="#l11.1854"></a><span id="l11.1854" class="difflineplus">+    // use the fictitious token 'end'. in practice we would ideally give it</span>
<a href="#l11.1855"></a><span id="l11.1855" class="difflineplus">+    // the oldest backwards pagination token from /sync, but /sync doesn't</span>
<a href="#l11.1856"></a><span id="l11.1856" class="difflineplus">+    // know about /notifications, so we have no choice but to start paginating</span>
<a href="#l11.1857"></a><span id="l11.1857" class="difflineplus">+    // from the current point in time.  This may well overlap with historical</span>
<a href="#l11.1858"></a><span id="l11.1858" class="difflineplus">+    // notifs which are then inserted into the timeline by /sync responses.</span>
<a href="#l11.1859"></a><span id="l11.1859" class="difflineplus">+    this._notifTimelineSet.resetLiveTimeline('end', true);</span>
<a href="#l11.1860"></a><span id="l11.1860" class="difflineplus">+</span>
<a href="#l11.1861"></a><span id="l11.1861" class="difflineplus">+    // we could try to paginate a single event at this point in order to get</span>
<a href="#l11.1862"></a><span id="l11.1862" class="difflineplus">+    // a more valid pagination token, but it just ends up with an out of order</span>
<a href="#l11.1863"></a><span id="l11.1863" class="difflineplus">+    // timeline. given what a mess this is and given we're going to have duplicate</span>
<a href="#l11.1864"></a><span id="l11.1864" class="difflineplus">+    // events anyway, just leave it with the dummy token for now.</span>
<a href="#l11.1865"></a><span id="l11.1865" class="difflineplus">+    /*</span>
<a href="#l11.1866"></a><span id="l11.1866" class="difflineplus">+    this.paginateNotifTimeline(this._notifTimelineSet.getLiveTimeline(), {</span>
<a href="#l11.1867"></a><span id="l11.1867" class="difflineplus">+        backwards: true,</span>
<a href="#l11.1868"></a><span id="l11.1868" class="difflineplus">+        limit: 1</span>
<a href="#l11.1869"></a><span id="l11.1869" class="difflineplus">+    });</span>
<a href="#l11.1870"></a><span id="l11.1870" class="difflineplus">+    */</span>
<a href="#l11.1871"></a><span id="l11.1871" class="difflineplus">+};</span>
<a href="#l11.1872"></a><span id="l11.1872" class="difflineplus">+</span>
<a href="#l11.1873"></a><span id="l11.1873" class="difflineplus">+/**</span>
<a href="#l11.1874"></a><span id="l11.1874" class="difflineplus">+ * Peek into a room and receive updates about the room. This only works if the</span>
<a href="#l11.1875"></a><span id="l11.1875" class="difflineplus">+ * history visibility for the room is world_readable.</span>
<a href="#l11.1876"></a><span id="l11.1876" class="difflineplus">+ * @param {String} roomId The room to attempt to peek into.</span>
<a href="#l11.1877"></a><span id="l11.1877" class="difflineplus">+ * @return {module:client.Promise} Resolves: Room object</span>
<a href="#l11.1878"></a><span id="l11.1878" class="difflineplus">+ * @return {module:http-api.MatrixError} Rejects: with an error response.</span>
<a href="#l11.1879"></a><span id="l11.1879" class="difflineplus">+ */</span>
<a href="#l11.1880"></a><span id="l11.1880" class="difflineplus">+MatrixClient.prototype.peekInRoom = function(roomId) {</span>
<a href="#l11.1881"></a><span id="l11.1881" class="difflineplus">+    if (this._peekSync) {</span>
<a href="#l11.1882"></a><span id="l11.1882" class="difflineplus">+        this._peekSync.stopPeeking();</span>
<a href="#l11.1883"></a><span id="l11.1883" class="difflineplus">+    }</span>
<a href="#l11.1884"></a><span id="l11.1884" class="difflineplus">+    this._peekSync = new SyncApi(this, this._clientOpts);</span>
<a href="#l11.1885"></a><span id="l11.1885" class="difflineplus">+    return this._peekSync.peek(roomId);</span>
<a href="#l11.1886"></a><span id="l11.1886" class="difflineplus">+};</span>
<a href="#l11.1887"></a><span id="l11.1887" class="difflineplus">+</span>
<a href="#l11.1888"></a><span id="l11.1888" class="difflineplus">+/**</span>
<a href="#l11.1889"></a><span id="l11.1889" class="difflineplus">+ * Stop any ongoing room peeking.</span>
<a href="#l11.1890"></a><span id="l11.1890" class="difflineplus">+ */</span>
<a href="#l11.1891"></a><span id="l11.1891" class="difflineplus">+MatrixClient.prototype.stopPeeking = function() {</span>
<a href="#l11.1892"></a><span id="l11.1892" class="difflineplus">+    if (this._peekSync) {</span>
<a href="#l11.1893"></a><span id="l11.1893" class="difflineplus">+        this._peekSync.stopPeeking();</span>
<a href="#l11.1894"></a><span id="l11.1894" class="difflineplus">+        this._peekSync = null;</span>
<a href="#l11.1895"></a><span id="l11.1895" class="difflineplus">+    }</span>
<a href="#l11.1896"></a><span id="l11.1896" class="difflineplus">+};</span>
<a href="#l11.1897"></a><span id="l11.1897" class="difflineplus">+</span>
<a href="#l11.1898"></a><span id="l11.1898" class="difflineplus">+/**</span>
<a href="#l11.1899"></a><span id="l11.1899" class="difflineplus">+ * Set r/w flags for guest access in a room.</span>
<a href="#l11.1900"></a><span id="l11.1900" class="difflineplus">+ * @param {string} roomId The room to configure guest access in.</span>
<a href="#l11.1901"></a><span id="l11.1901" class="difflineplus">+ * @param {Object} opts Options</span>
<a href="#l11.1902"></a><span id="l11.1902" class="difflineplus">+ * @param {boolean} opts.allowJoin True to allow guests to join this room. This</span>
<a href="#l11.1903"></a><span id="l11.1903" class="difflineplus">+ * implicitly gives guests write access. If false or not given, guests are</span>
<a href="#l11.1904"></a><span id="l11.1904" class="difflineplus">+ * explicitly forbidden from joining the room.</span>
<a href="#l11.1905"></a><span id="l11.1905" class="difflineplus">+ * @param {boolean} opts.allowRead True to set history visibility to</span>
<a href="#l11.1906"></a><span id="l11.1906" class="difflineplus">+ * be world_readable. This gives guests read access *from this point forward*.</span>
<a href="#l11.1907"></a><span id="l11.1907" class="difflineplus">+ * If false or not given, history visibility is not modified.</span>
<a href="#l11.1908"></a><span id="l11.1908" class="difflineplus">+ * @return {module:client.Promise} Resolves: TODO</span>
<a href="#l11.1909"></a><span id="l11.1909" class="difflineplus">+ * @return {module:http-api.MatrixError} Rejects: with an error response.</span>
<a href="#l11.1910"></a><span id="l11.1910" class="difflineplus">+ */</span>
<a href="#l11.1911"></a><span id="l11.1911" class="difflineplus">+MatrixClient.prototype.setGuestAccess = function(roomId, opts) {</span>
<a href="#l11.1912"></a><span id="l11.1912" class="difflineplus">+    var writePromise = this.sendStateEvent(roomId, &quot;m.room.guest_access&quot;, {</span>
<a href="#l11.1913"></a><span id="l11.1913" class="difflineplus">+        guest_access: opts.allowJoin ? &quot;can_join&quot; : &quot;forbidden&quot;</span>
<a href="#l11.1914"></a><span id="l11.1914" class="difflineplus">+    });</span>
<a href="#l11.1915"></a><span id="l11.1915" class="difflineplus">+</span>
<a href="#l11.1916"></a><span id="l11.1916" class="difflineplus">+    var readPromise = q();</span>
<a href="#l11.1917"></a><span id="l11.1917" class="difflineplus">+    if (opts.allowRead) {</span>
<a href="#l11.1918"></a><span id="l11.1918" class="difflineplus">+        readPromise = this.sendStateEvent(roomId, &quot;m.room.history_visibility&quot;, {</span>
<a href="#l11.1919"></a><span id="l11.1919" class="difflineplus">+            history_visibility: &quot;world_readable&quot;</span>
<a href="#l11.1920"></a><span id="l11.1920" class="difflineplus">+        });</span>
<a href="#l11.1921"></a><span id="l11.1921" class="difflineplus">+    }</span>
<a href="#l11.1922"></a><span id="l11.1922" class="difflineplus">+</span>
<a href="#l11.1923"></a><span id="l11.1923" class="difflineplus">+    return q.all(readPromise, writePromise);</span>
<a href="#l11.1924"></a><span id="l11.1924" class="difflineplus">+};</span>
<a href="#l11.1925"></a><span id="l11.1925" class="difflineplus">+</span>
<a href="#l11.1926"></a><span id="l11.1926" class="difflineplus">+// Registration/Login operations</span>
<a href="#l11.1927"></a><span id="l11.1927" class="difflineplus">+// =============================</span>
<a href="#l11.1928"></a><span id="l11.1928" class="difflineplus">+</span>
<a href="#l11.1929"></a><span id="l11.1929" class="difflineplus">+/**</span>
<a href="#l11.1930"></a><span id="l11.1930" class="difflineplus">+ * Requests an email verification token for the purposes of registration.</span>
<a href="#l11.1931"></a><span id="l11.1931" class="difflineplus">+ * This API proxies the Identity Server /validate/email/requestToken API,</span>
<a href="#l11.1932"></a><span id="l11.1932" class="difflineplus">+ * adding registration-specific behaviour. Specifically, if an account with</span>
<a href="#l11.1933"></a><span id="l11.1933" class="difflineplus">+ * the given email address already exists, it will either send an email</span>
<a href="#l11.1934"></a><span id="l11.1934" class="difflineplus">+ * to the address informing them of this or return M_THREEPID_IN_USE</span>
<a href="#l11.1935"></a><span id="l11.1935" class="difflineplus">+ * (which one is up to the Home Server).</span>
<a href="#l11.1936"></a><span id="l11.1936" class="difflineplus">+ *</span>
<a href="#l11.1937"></a><span id="l11.1937" class="difflineplus">+ * requestEmailToken calls the equivalent API directly on the ID server,</span>
<a href="#l11.1938"></a><span id="l11.1938" class="difflineplus">+ * therefore bypassing the registration-specific logic.</span>
<a href="#l11.1939"></a><span id="l11.1939" class="difflineplus">+ *</span>
<a href="#l11.1940"></a><span id="l11.1940" class="difflineplus">+ * Parameters and return value are as for requestEmailToken</span>
<a href="#l11.1941"></a><span id="l11.1941" class="difflineplus">+</span>
<a href="#l11.1942"></a><span id="l11.1942" class="difflineplus">+ * @param {string} email As requestEmailToken</span>
<a href="#l11.1943"></a><span id="l11.1943" class="difflineplus">+ * @param {string} clientSecret As requestEmailToken</span>
<a href="#l11.1944"></a><span id="l11.1944" class="difflineplus">+ * @param {number} sendAttempt As requestEmailToken</span>
<a href="#l11.1945"></a><span id="l11.1945" class="difflineplus">+ * @param {string} nextLink As requestEmailToken</span>
<a href="#l11.1946"></a><span id="l11.1946" class="difflineplus">+ * @param {module:client.callback} callback Optional. As requestEmailToken</span>
<a href="#l11.1947"></a><span id="l11.1947" class="difflineplus">+ * @return {module:client.Promise} Resolves: As requestEmailToken</span>
<a href="#l11.1948"></a><span id="l11.1948" class="difflineplus">+ */</span>
<a href="#l11.1949"></a><span id="l11.1949" class="difflineplus">+MatrixClient.prototype.requestRegisterEmailToken = function(email, clientSecret,</span>
<a href="#l11.1950"></a><span id="l11.1950" class="difflineplus">+                                                    sendAttempt, nextLink, callback) {</span>
<a href="#l11.1951"></a><span id="l11.1951" class="difflineplus">+    return this._requestTokenFromEndpoint(</span>
<a href="#l11.1952"></a><span id="l11.1952" class="difflineplus">+        &quot;/register/email/requestToken&quot;,</span>
<a href="#l11.1953"></a><span id="l11.1953" class="difflineplus">+        email, clientSecret, sendAttempt, nextLink, callback</span>
<a href="#l11.1954"></a><span id="l11.1954" class="difflineplus">+    );</span>
<a href="#l11.1955"></a><span id="l11.1955" class="difflineplus">+};</span>
<a href="#l11.1956"></a><span id="l11.1956" class="difflineplus">+</span>
<a href="#l11.1957"></a><span id="l11.1957" class="difflineplus">+/**</span>
<a href="#l11.1958"></a><span id="l11.1958" class="difflineplus">+ * Requests an email verification token for the purposes of adding a</span>
<a href="#l11.1959"></a><span id="l11.1959" class="difflineplus">+ * third party identifier to an account.</span>
<a href="#l11.1960"></a><span id="l11.1960" class="difflineplus">+ * This API proxies the Identity Server /validate/email/requestToken API,</span>
<a href="#l11.1961"></a><span id="l11.1961" class="difflineplus">+ * adding specific behaviour for the addition of email addresses to an</span>
<a href="#l11.1962"></a><span id="l11.1962" class="difflineplus">+ * account. Specifically, if an account with</span>
<a href="#l11.1963"></a><span id="l11.1963" class="difflineplus">+ * the given email address already exists, it will either send an email</span>
<a href="#l11.1964"></a><span id="l11.1964" class="difflineplus">+ * to the address informing them of this or return M_THREEPID_IN_USE</span>
<a href="#l11.1965"></a><span id="l11.1965" class="difflineplus">+ * (which one is up to the Home Server).</span>
<a href="#l11.1966"></a><span id="l11.1966" class="difflineplus">+ *</span>
<a href="#l11.1967"></a><span id="l11.1967" class="difflineplus">+ * requestEmailToken calls the equivalent API directly on the ID server,</span>
<a href="#l11.1968"></a><span id="l11.1968" class="difflineplus">+ * therefore bypassing the email addition specific logic.</span>
<a href="#l11.1969"></a><span id="l11.1969" class="difflineplus">+ *</span>
<a href="#l11.1970"></a><span id="l11.1970" class="difflineplus">+ * @param {string} email As requestEmailToken</span>
<a href="#l11.1971"></a><span id="l11.1971" class="difflineplus">+ * @param {string} clientSecret As requestEmailToken</span>
<a href="#l11.1972"></a><span id="l11.1972" class="difflineplus">+ * @param {number} sendAttempt As requestEmailToken</span>
<a href="#l11.1973"></a><span id="l11.1973" class="difflineplus">+ * @param {string} nextLink As requestEmailToken</span>
<a href="#l11.1974"></a><span id="l11.1974" class="difflineplus">+ * @param {module:client.callback} callback Optional. As requestEmailToken</span>
<a href="#l11.1975"></a><span id="l11.1975" class="difflineplus">+ * @return {module:client.Promise} Resolves: As requestEmailToken</span>
<a href="#l11.1976"></a><span id="l11.1976" class="difflineplus">+ */</span>
<a href="#l11.1977"></a><span id="l11.1977" class="difflineplus">+MatrixClient.prototype.requestAdd3pidEmailToken = function(email, clientSecret,</span>
<a href="#l11.1978"></a><span id="l11.1978" class="difflineplus">+                                                    sendAttempt, nextLink, callback) {</span>
<a href="#l11.1979"></a><span id="l11.1979" class="difflineplus">+    return this._requestTokenFromEndpoint(</span>
<a href="#l11.1980"></a><span id="l11.1980" class="difflineplus">+        &quot;/account/3pid/email/requestToken&quot;,</span>
<a href="#l11.1981"></a><span id="l11.1981" class="difflineplus">+        email, clientSecret, sendAttempt, nextLink, callback</span>
<a href="#l11.1982"></a><span id="l11.1982" class="difflineplus">+    );</span>
<a href="#l11.1983"></a><span id="l11.1983" class="difflineplus">+};</span>
<a href="#l11.1984"></a><span id="l11.1984" class="difflineplus">+</span>
<a href="#l11.1985"></a><span id="l11.1985" class="difflineplus">+/**</span>
<a href="#l11.1986"></a><span id="l11.1986" class="difflineplus">+ * Requests an email verification token for the purposes of resetting</span>
<a href="#l11.1987"></a><span id="l11.1987" class="difflineplus">+ * the password on an account.</span>
<a href="#l11.1988"></a><span id="l11.1988" class="difflineplus">+ * This API proxies the Identity Server /validate/email/requestToken API,</span>
<a href="#l11.1989"></a><span id="l11.1989" class="difflineplus">+ * adding specific behaviour for the password resetting. Specifically,</span>
<a href="#l11.1990"></a><span id="l11.1990" class="difflineplus">+ * if no account with the given email address exists, it may either</span>
<a href="#l11.1991"></a><span id="l11.1991" class="difflineplus">+ * return M_THREEPID_NOT_FOUND or send an email</span>
<a href="#l11.1992"></a><span id="l11.1992" class="difflineplus">+ * to the address informing them of this (which one is up to the Home Server).</span>
<a href="#l11.1993"></a><span id="l11.1993" class="difflineplus">+ *</span>
<a href="#l11.1994"></a><span id="l11.1994" class="difflineplus">+ * requestEmailToken calls the equivalent API directly on the ID server,</span>
<a href="#l11.1995"></a><span id="l11.1995" class="difflineplus">+ * therefore bypassing the password reset specific logic.</span>
<a href="#l11.1996"></a><span id="l11.1996" class="difflineplus">+ *</span>
<a href="#l11.1997"></a><span id="l11.1997" class="difflineplus">+ * @param {string} email As requestEmailToken</span>
<a href="#l11.1998"></a><span id="l11.1998" class="difflineplus">+ * @param {string} clientSecret As requestEmailToken</span>
<a href="#l11.1999"></a><span id="l11.1999" class="difflineplus">+ * @param {number} sendAttempt As requestEmailToken</span>
<a href="#l11.2000"></a><span id="l11.2000" class="difflineplus">+ * @param {string} nextLink As requestEmailToken</span>
<a href="#l11.2001"></a><span id="l11.2001" class="difflineplus">+ * @param {module:client.callback} callback Optional. As requestEmailToken</span>
<a href="#l11.2002"></a><span id="l11.2002" class="difflineplus">+ * @return {module:client.Promise} Resolves: As requestEmailToken</span>
<a href="#l11.2003"></a><span id="l11.2003" class="difflineplus">+ */</span>
<a href="#l11.2004"></a><span id="l11.2004" class="difflineplus">+MatrixClient.prototype.requestPasswordEmailToken = function(email, clientSecret,</span>
<a href="#l11.2005"></a><span id="l11.2005" class="difflineplus">+                                                    sendAttempt, nextLink, callback) {</span>
<a href="#l11.2006"></a><span id="l11.2006" class="difflineplus">+    return this._requestTokenFromEndpoint(</span>
<a href="#l11.2007"></a><span id="l11.2007" class="difflineplus">+        &quot;/account/password/email/requestToken&quot;,</span>
<a href="#l11.2008"></a><span id="l11.2008" class="difflineplus">+        email, clientSecret, sendAttempt, nextLink, callback</span>
<a href="#l11.2009"></a><span id="l11.2009" class="difflineplus">+    );</span>
<a href="#l11.2010"></a><span id="l11.2010" class="difflineplus">+};</span>
<a href="#l11.2011"></a><span id="l11.2011" class="difflineplus">+</span>
<a href="#l11.2012"></a><span id="l11.2012" class="difflineplus">+/**</span>
<a href="#l11.2013"></a><span id="l11.2013" class="difflineplus">+ * Internal utility function for requesting validation tokens from usage-specific</span>
<a href="#l11.2014"></a><span id="l11.2014" class="difflineplus">+ * requestToken endpoints.</span>
<a href="#l11.2015"></a><span id="l11.2015" class="difflineplus">+ *</span>
<a href="#l11.2016"></a><span id="l11.2016" class="difflineplus">+ * @param {string} endpoint The endpoint to send the request to</span>
<a href="#l11.2017"></a><span id="l11.2017" class="difflineplus">+ * @param {string} email As requestEmailToken</span>
<a href="#l11.2018"></a><span id="l11.2018" class="difflineplus">+ * @param {string} clientSecret As requestEmailToken</span>
<a href="#l11.2019"></a><span id="l11.2019" class="difflineplus">+ * @param {number} sendAttempt As requestEmailToken</span>
<a href="#l11.2020"></a><span id="l11.2020" class="difflineplus">+ * @param {string} nextLink As requestEmailToken</span>
<a href="#l11.2021"></a><span id="l11.2021" class="difflineplus">+ * @param {module:client.callback} callback Optional. As requestEmailToken</span>
<a href="#l11.2022"></a><span id="l11.2022" class="difflineplus">+ * @return {module:client.Promise} Resolves: As requestEmailToken</span>
<a href="#l11.2023"></a><span id="l11.2023" class="difflineplus">+ */</span>
<a href="#l11.2024"></a><span id="l11.2024" class="difflineplus">+MatrixClient.prototype._requestTokenFromEndpoint = function(endpoint,</span>
<a href="#l11.2025"></a><span id="l11.2025" class="difflineplus">+                                                    email, clientSecret,</span>
<a href="#l11.2026"></a><span id="l11.2026" class="difflineplus">+                                                    sendAttempt, nextLink, callback) {</span>
<a href="#l11.2027"></a><span id="l11.2027" class="difflineplus">+    var id_server_url = url.parse(this.idBaseUrl);</span>
<a href="#l11.2028"></a><span id="l11.2028" class="difflineplus">+    if (id_server_url.host === null) {</span>
<a href="#l11.2029"></a><span id="l11.2029" class="difflineplus">+        throw new Error(&quot;Invalid ID server URL: &quot; + this.idBaseUrl);</span>
<a href="#l11.2030"></a><span id="l11.2030" class="difflineplus">+    }</span>
<a href="#l11.2031"></a><span id="l11.2031" class="difflineplus">+</span>
<a href="#l11.2032"></a><span id="l11.2032" class="difflineplus">+    var params = {</span>
<a href="#l11.2033"></a><span id="l11.2033" class="difflineplus">+        client_secret: clientSecret,</span>
<a href="#l11.2034"></a><span id="l11.2034" class="difflineplus">+        email: email,</span>
<a href="#l11.2035"></a><span id="l11.2035" class="difflineplus">+        send_attempt: sendAttempt,</span>
<a href="#l11.2036"></a><span id="l11.2036" class="difflineplus">+        next_link: nextLink,</span>
<a href="#l11.2037"></a><span id="l11.2037" class="difflineplus">+        id_server: id_server_url.host,</span>
<a href="#l11.2038"></a><span id="l11.2038" class="difflineplus">+    };</span>
<a href="#l11.2039"></a><span id="l11.2039" class="difflineplus">+    return this._http.request(</span>
<a href="#l11.2040"></a><span id="l11.2040" class="difflineplus">+        callback, &quot;POST&quot;, endpoint, undefined,</span>
<a href="#l11.2041"></a><span id="l11.2041" class="difflineplus">+        params</span>
<a href="#l11.2042"></a><span id="l11.2042" class="difflineplus">+    );</span>
<a href="#l11.2043"></a><span id="l11.2043" class="difflineplus">+};</span>
<a href="#l11.2044"></a><span id="l11.2044" class="difflineplus">+</span>
<a href="#l11.2045"></a><span id="l11.2045" class="difflineplus">+</span>
<a href="#l11.2046"></a><span id="l11.2046" class="difflineplus">+// Push operations</span>
<a href="#l11.2047"></a><span id="l11.2047" class="difflineplus">+// ===============</span>
<a href="#l11.2048"></a><span id="l11.2048" class="difflineplus">+</span>
<a href="#l11.2049"></a><span id="l11.2049" class="difflineplus">+/**</span>
<a href="#l11.2050"></a><span id="l11.2050" class="difflineplus">+ * Get the room-kind push rule associated with a room.</span>
<a href="#l11.2051"></a><span id="l11.2051" class="difflineplus">+ * @param {string} scope &quot;global&quot; or device-specific.</span>
<a href="#l11.2052"></a><span id="l11.2052" class="difflineplus">+ * @param {string} roomId the id of the room.</span>
<a href="#l11.2053"></a><span id="l11.2053" class="difflineplus">+ * @return {object} the rule or undefined.</span>
<a href="#l11.2054"></a><span id="l11.2054" class="difflineplus">+ */</span>
<a href="#l11.2055"></a><span id="l11.2055" class="difflineplus">+MatrixClient.prototype.getRoomPushRule = function(scope, roomId) {</span>
<a href="#l11.2056"></a><span id="l11.2056" class="difflineplus">+    // There can be only room-kind push rule per room</span>
<a href="#l11.2057"></a><span id="l11.2057" class="difflineplus">+    // and its id is the room id.</span>
<a href="#l11.2058"></a><span id="l11.2058" class="difflineplus">+    if (this.pushRules) {</span>
<a href="#l11.2059"></a><span id="l11.2059" class="difflineplus">+        for (var i = 0; i &lt; this.pushRules[scope].room.length; i++) {</span>
<a href="#l11.2060"></a><span id="l11.2060" class="difflineplus">+            var rule = this.pushRules[scope].room[i];</span>
<a href="#l11.2061"></a><span id="l11.2061" class="difflineplus">+            if (rule.rule_id === roomId) {</span>
<a href="#l11.2062"></a><span id="l11.2062" class="difflineplus">+                return rule;</span>
<a href="#l11.2063"></a><span id="l11.2063" class="difflineplus">+            }</span>
<a href="#l11.2064"></a><span id="l11.2064" class="difflineplus">+        }</span>
<a href="#l11.2065"></a><span id="l11.2065" class="difflineplus">+    }</span>
<a href="#l11.2066"></a><span id="l11.2066" class="difflineplus">+    else {</span>
<a href="#l11.2067"></a><span id="l11.2067" class="difflineplus">+        throw new Error(</span>
<a href="#l11.2068"></a><span id="l11.2068" class="difflineplus">+            &quot;SyncApi.sync() must be done before accessing to push rules.&quot;</span>
<a href="#l11.2069"></a><span id="l11.2069" class="difflineplus">+        );</span>
<a href="#l11.2070"></a><span id="l11.2070" class="difflineplus">+    }</span>
<a href="#l11.2071"></a><span id="l11.2071" class="difflineplus">+};</span>
<a href="#l11.2072"></a><span id="l11.2072" class="difflineplus">+</span>
<a href="#l11.2073"></a><span id="l11.2073" class="difflineplus">+/**</span>
<a href="#l11.2074"></a><span id="l11.2074" class="difflineplus">+ * Set a room-kind muting push rule in a room.</span>
<a href="#l11.2075"></a><span id="l11.2075" class="difflineplus">+ * The operation also updates MatrixClient.pushRules at the end.</span>
<a href="#l11.2076"></a><span id="l11.2076" class="difflineplus">+ * @param {string} scope &quot;global&quot; or device-specific.</span>
<a href="#l11.2077"></a><span id="l11.2077" class="difflineplus">+ * @param {string} roomId the id of the room.</span>
<a href="#l11.2078"></a><span id="l11.2078" class="difflineplus">+ * @param {string} mute the mute state.</span>
<a href="#l11.2079"></a><span id="l11.2079" class="difflineplus">+ * @return {module:client.Promise} Resolves: result object</span>
<a href="#l11.2080"></a><span id="l11.2080" class="difflineplus">+ * @return {module:http-api.MatrixError} Rejects: with an error response.</span>
<a href="#l11.2081"></a><span id="l11.2081" class="difflineplus">+ */</span>
<a href="#l11.2082"></a><span id="l11.2082" class="difflineplus">+MatrixClient.prototype.setRoomMutePushRule = function(scope, roomId, mute) {</span>
<a href="#l11.2083"></a><span id="l11.2083" class="difflineplus">+    var self = this;</span>
<a href="#l11.2084"></a><span id="l11.2084" class="difflineplus">+    var deferred, hasDontNotifyRule;</span>
<a href="#l11.2085"></a><span id="l11.2085" class="difflineplus">+</span>
<a href="#l11.2086"></a><span id="l11.2086" class="difflineplus">+    // Get the existing room-kind push rule if any</span>
<a href="#l11.2087"></a><span id="l11.2087" class="difflineplus">+    var roomPushRule = this.getRoomPushRule(scope, roomId);</span>
<a href="#l11.2088"></a><span id="l11.2088" class="difflineplus">+    if (roomPushRule) {</span>
<a href="#l11.2089"></a><span id="l11.2089" class="difflineplus">+        if (0 &lt;= roomPushRule.actions.indexOf(&quot;dont_notify&quot;)) {</span>
<a href="#l11.2090"></a><span id="l11.2090" class="difflineplus">+            hasDontNotifyRule = true;</span>
<a href="#l11.2091"></a><span id="l11.2091" class="difflineplus">+        }</span>
<a href="#l11.2092"></a><span id="l11.2092" class="difflineplus">+    }</span>
<a href="#l11.2093"></a><span id="l11.2093" class="difflineplus">+</span>
<a href="#l11.2094"></a><span id="l11.2094" class="difflineplus">+    if (!mute) {</span>
<a href="#l11.2095"></a><span id="l11.2095" class="difflineplus">+        // Remove the rule only if it is a muting rule</span>
<a href="#l11.2096"></a><span id="l11.2096" class="difflineplus">+        if (hasDontNotifyRule) {</span>
<a href="#l11.2097"></a><span id="l11.2097" class="difflineplus">+            deferred = this.deletePushRule(scope, &quot;room&quot;, roomPushRule.rule_id);</span>
<a href="#l11.2098"></a><span id="l11.2098" class="difflineplus">+        }</span>
<a href="#l11.2099"></a><span id="l11.2099" class="difflineplus">+    }</span>
<a href="#l11.2100"></a><span id="l11.2100" class="difflineplus">+    else {</span>
<a href="#l11.2101"></a><span id="l11.2101" class="difflineplus">+        if (!roomPushRule) {</span>
<a href="#l11.2102"></a><span id="l11.2102" class="difflineplus">+            deferred = this.addPushRule(scope, &quot;room&quot;, roomId, {</span>
<a href="#l11.2103"></a><span id="l11.2103" class="difflineplus">+                actions: [&quot;dont_notify&quot;]</span>
<a href="#l11.2104"></a><span id="l11.2104" class="difflineplus">+            });</span>
<a href="#l11.2105"></a><span id="l11.2105" class="difflineplus">+        }</span>
<a href="#l11.2106"></a><span id="l11.2106" class="difflineplus">+        else if (!hasDontNotifyRule) {</span>
<a href="#l11.2107"></a><span id="l11.2107" class="difflineplus">+            // Remove the existing one before setting the mute push rule</span>
<a href="#l11.2108"></a><span id="l11.2108" class="difflineplus">+            // This is a workaround to SYN-590 (Push rule update fails)</span>
<a href="#l11.2109"></a><span id="l11.2109" class="difflineplus">+            deferred = q.defer();</span>
<a href="#l11.2110"></a><span id="l11.2110" class="difflineplus">+            this.deletePushRule(scope, &quot;room&quot;, roomPushRule.rule_id)</span>
<a href="#l11.2111"></a><span id="l11.2111" class="difflineplus">+            .done(function() {</span>
<a href="#l11.2112"></a><span id="l11.2112" class="difflineplus">+                self.addPushRule(scope, &quot;room&quot;, roomId, {</span>
<a href="#l11.2113"></a><span id="l11.2113" class="difflineplus">+                    actions: [&quot;dont_notify&quot;]</span>
<a href="#l11.2114"></a><span id="l11.2114" class="difflineplus">+                }).done(function() {</span>
<a href="#l11.2115"></a><span id="l11.2115" class="difflineplus">+                    deferred.resolve();</span>
<a href="#l11.2116"></a><span id="l11.2116" class="difflineplus">+                }, function(err) {</span>
<a href="#l11.2117"></a><span id="l11.2117" class="difflineplus">+                    deferred.reject(err);</span>
<a href="#l11.2118"></a><span id="l11.2118" class="difflineplus">+                });</span>
<a href="#l11.2119"></a><span id="l11.2119" class="difflineplus">+            }, function(err) {</span>
<a href="#l11.2120"></a><span id="l11.2120" class="difflineplus">+                deferred.reject(err);</span>
<a href="#l11.2121"></a><span id="l11.2121" class="difflineplus">+            });</span>
<a href="#l11.2122"></a><span id="l11.2122" class="difflineplus">+</span>
<a href="#l11.2123"></a><span id="l11.2123" class="difflineplus">+            deferred = deferred.promise;</span>
<a href="#l11.2124"></a><span id="l11.2124" class="difflineplus">+        }</span>
<a href="#l11.2125"></a><span id="l11.2125" class="difflineplus">+    }</span>
<a href="#l11.2126"></a><span id="l11.2126" class="difflineplus">+</span>
<a href="#l11.2127"></a><span id="l11.2127" class="difflineplus">+    if (deferred) {</span>
<a href="#l11.2128"></a><span id="l11.2128" class="difflineplus">+        // Update this.pushRules when the operation completes</span>
<a href="#l11.2129"></a><span id="l11.2129" class="difflineplus">+        var ruleRefreshDeferred = q.defer();</span>
<a href="#l11.2130"></a><span id="l11.2130" class="difflineplus">+        deferred.done(function() {</span>
<a href="#l11.2131"></a><span id="l11.2131" class="difflineplus">+            self.getPushRules().done(function(result) {</span>
<a href="#l11.2132"></a><span id="l11.2132" class="difflineplus">+                self.pushRules = result;</span>
<a href="#l11.2133"></a><span id="l11.2133" class="difflineplus">+                ruleRefreshDeferred.resolve();</span>
<a href="#l11.2134"></a><span id="l11.2134" class="difflineplus">+            }, function(err) {</span>
<a href="#l11.2135"></a><span id="l11.2135" class="difflineplus">+                ruleRefreshDeferred.reject(err);</span>
<a href="#l11.2136"></a><span id="l11.2136" class="difflineplus">+            });</span>
<a href="#l11.2137"></a><span id="l11.2137" class="difflineplus">+        }, function(err) {</span>
<a href="#l11.2138"></a><span id="l11.2138" class="difflineplus">+            // Update it even if the previous operation fails. This can help the</span>
<a href="#l11.2139"></a><span id="l11.2139" class="difflineplus">+            // app to recover when push settings has been modifed from another client</span>
<a href="#l11.2140"></a><span id="l11.2140" class="difflineplus">+            self.getPushRules().done(function(result) {</span>
<a href="#l11.2141"></a><span id="l11.2141" class="difflineplus">+                self.pushRules = result;</span>
<a href="#l11.2142"></a><span id="l11.2142" class="difflineplus">+                ruleRefreshDeferred.reject(err);</span>
<a href="#l11.2143"></a><span id="l11.2143" class="difflineplus">+            }, function(err2) {</span>
<a href="#l11.2144"></a><span id="l11.2144" class="difflineplus">+                ruleRefreshDeferred.reject(err);</span>
<a href="#l11.2145"></a><span id="l11.2145" class="difflineplus">+            });</span>
<a href="#l11.2146"></a><span id="l11.2146" class="difflineplus">+        });</span>
<a href="#l11.2147"></a><span id="l11.2147" class="difflineplus">+        return ruleRefreshDeferred.promise;</span>
<a href="#l11.2148"></a><span id="l11.2148" class="difflineplus">+    }</span>
<a href="#l11.2149"></a><span id="l11.2149" class="difflineplus">+};</span>
<a href="#l11.2150"></a><span id="l11.2150" class="difflineplus">+</span>
<a href="#l11.2151"></a><span id="l11.2151" class="difflineplus">+// Search</span>
<a href="#l11.2152"></a><span id="l11.2152" class="difflineplus">+// ======</span>
<a href="#l11.2153"></a><span id="l11.2153" class="difflineplus">+</span>
<a href="#l11.2154"></a><span id="l11.2154" class="difflineplus">+/**</span>
<a href="#l11.2155"></a><span id="l11.2155" class="difflineplus">+ * Perform a server-side search for messages containing the given text.</span>
<a href="#l11.2156"></a><span id="l11.2156" class="difflineplus">+ * @param {Object} opts Options for the search.</span>
<a href="#l11.2157"></a><span id="l11.2157" class="difflineplus">+ * @param {string} opts.query The text to query.</span>
<a href="#l11.2158"></a><span id="l11.2158" class="difflineplus">+ * @param {string=} opts.keys The keys to search on. Defaults to all keys. One</span>
<a href="#l11.2159"></a><span id="l11.2159" class="difflineplus">+ * of &quot;content.body&quot;, &quot;content.name&quot;, &quot;content.topic&quot;.</span>
<a href="#l11.2160"></a><span id="l11.2160" class="difflineplus">+ * @param {module:client.callback} callback Optional.</span>
<a href="#l11.2161"></a><span id="l11.2161" class="difflineplus">+ * @return {module:client.Promise} Resolves: TODO</span>
<a href="#l11.2162"></a><span id="l11.2162" class="difflineplus">+ * @return {module:http-api.MatrixError} Rejects: with an error response.</span>
<a href="#l11.2163"></a><span id="l11.2163" class="difflineplus">+ */</span>
<a href="#l11.2164"></a><span id="l11.2164" class="difflineplus">+MatrixClient.prototype.searchMessageText = function(opts, callback) {</span>
<a href="#l11.2165"></a><span id="l11.2165" class="difflineplus">+    return this.search({</span>
<a href="#l11.2166"></a><span id="l11.2166" class="difflineplus">+        body: {</span>
<a href="#l11.2167"></a><span id="l11.2167" class="difflineplus">+            search_categories: {</span>
<a href="#l11.2168"></a><span id="l11.2168" class="difflineplus">+                room_events: {</span>
<a href="#l11.2169"></a><span id="l11.2169" class="difflineplus">+                    keys: opts.keys,</span>
<a href="#l11.2170"></a><span id="l11.2170" class="difflineplus">+                    search_term: opts.query</span>
<a href="#l11.2171"></a><span id="l11.2171" class="difflineplus">+                }</span>
<a href="#l11.2172"></a><span id="l11.2172" class="difflineplus">+            }</span>
<a href="#l11.2173"></a><span id="l11.2173" class="difflineplus">+        }</span>
<a href="#l11.2174"></a><span id="l11.2174" class="difflineplus">+    }, callback);</span>
<a href="#l11.2175"></a><span id="l11.2175" class="difflineplus">+};</span>
<a href="#l11.2176"></a><span id="l11.2176" class="difflineplus">+</span>
<a href="#l11.2177"></a><span id="l11.2177" class="difflineplus">+/**</span>
<a href="#l11.2178"></a><span id="l11.2178" class="difflineplus">+ * Perform a server-side search for room events.</span>
<a href="#l11.2179"></a><span id="l11.2179" class="difflineplus">+ *</span>
<a href="#l11.2180"></a><span id="l11.2180" class="difflineplus">+ * The returned promise resolves to an object containing the fields:</span>
<a href="#l11.2181"></a><span id="l11.2181" class="difflineplus">+ *</span>
<a href="#l11.2182"></a><span id="l11.2182" class="difflineplus">+ *  * {number}  count:       estimate of the number of results</span>
<a href="#l11.2183"></a><span id="l11.2183" class="difflineplus">+ *  * {string}  next_batch:  token for back-pagination; if undefined, there are</span>
<a href="#l11.2184"></a><span id="l11.2184" class="difflineplus">+ *                           no more results</span>
<a href="#l11.2185"></a><span id="l11.2185" class="difflineplus">+ *  * {Array}   highlights:  a list of words to highlight from the stemming</span>
<a href="#l11.2186"></a><span id="l11.2186" class="difflineplus">+ *                           algorithm</span>
<a href="#l11.2187"></a><span id="l11.2187" class="difflineplus">+ *  * {Array}   results:     a list of results</span>
<a href="#l11.2188"></a><span id="l11.2188" class="difflineplus">+ *</span>
<a href="#l11.2189"></a><span id="l11.2189" class="difflineplus">+ * Each entry in the results list is a {module:models/search-result.SearchResult}.</span>
<a href="#l11.2190"></a><span id="l11.2190" class="difflineplus">+ *</span>
<a href="#l11.2191"></a><span id="l11.2191" class="difflineplus">+ * @param {Object} opts</span>
<a href="#l11.2192"></a><span id="l11.2192" class="difflineplus">+ * @param {string} opts.term     the term to search for</span>
<a href="#l11.2193"></a><span id="l11.2193" class="difflineplus">+ * @param {Object} opts.filter   a JSON filter object to pass in the request</span>
<a href="#l11.2194"></a><span id="l11.2194" class="difflineplus">+ * @return {module:client.Promise} Resolves: result object</span>
<a href="#l11.2195"></a><span id="l11.2195" class="difflineplus">+ * @return {module:http-api.MatrixError} Rejects: with an error response.</span>
<a href="#l11.2196"></a><span id="l11.2196" class="difflineplus">+ */</span>
<a href="#l11.2197"></a><span id="l11.2197" class="difflineplus">+MatrixClient.prototype.searchRoomEvents = function(opts) {</span>
<a href="#l11.2198"></a><span id="l11.2198" class="difflineplus">+    // TODO: support groups</span>
<a href="#l11.2199"></a><span id="l11.2199" class="difflineplus">+</span>
<a href="#l11.2200"></a><span id="l11.2200" class="difflineplus">+    var body = {</span>
<a href="#l11.2201"></a><span id="l11.2201" class="difflineplus">+        search_categories: {</span>
<a href="#l11.2202"></a><span id="l11.2202" class="difflineplus">+            room_events: {</span>
<a href="#l11.2203"></a><span id="l11.2203" class="difflineplus">+                search_term: opts.term,</span>
<a href="#l11.2204"></a><span id="l11.2204" class="difflineplus">+                filter: opts.filter,</span>
<a href="#l11.2205"></a><span id="l11.2205" class="difflineplus">+                order_by: &quot;recent&quot;,</span>
<a href="#l11.2206"></a><span id="l11.2206" class="difflineplus">+                event_context: {</span>
<a href="#l11.2207"></a><span id="l11.2207" class="difflineplus">+                    before_limit: 1,</span>
<a href="#l11.2208"></a><span id="l11.2208" class="difflineplus">+                    after_limit: 1,</span>
<a href="#l11.2209"></a><span id="l11.2209" class="difflineplus">+                    include_profile: true,</span>
<a href="#l11.2210"></a><span id="l11.2210" class="difflineplus">+                }</span>
<a href="#l11.2211"></a><span id="l11.2211" class="difflineplus">+            }</span>
<a href="#l11.2212"></a><span id="l11.2212" class="difflineplus">+        }</span>
<a href="#l11.2213"></a><span id="l11.2213" class="difflineplus">+    };</span>
<a href="#l11.2214"></a><span id="l11.2214" class="difflineplus">+</span>
<a href="#l11.2215"></a><span id="l11.2215" class="difflineplus">+    var searchResults = {</span>
<a href="#l11.2216"></a><span id="l11.2216" class="difflineplus">+        _query: body,</span>
<a href="#l11.2217"></a><span id="l11.2217" class="difflineplus">+        results: [],</span>
<a href="#l11.2218"></a><span id="l11.2218" class="difflineplus">+        highlights: [],</span>
<a href="#l11.2219"></a><span id="l11.2219" class="difflineplus">+    };</span>
<a href="#l11.2220"></a><span id="l11.2220" class="difflineplus">+</span>
<a href="#l11.2221"></a><span id="l11.2221" class="difflineplus">+    return this.search({body: body}).then(</span>
<a href="#l11.2222"></a><span id="l11.2222" class="difflineplus">+        this._processRoomEventsSearch.bind(this, searchResults)</span>
<a href="#l11.2223"></a><span id="l11.2223" class="difflineplus">+    );</span>
<a href="#l11.2224"></a><span id="l11.2224" class="difflineplus">+};</span>
<a href="#l11.2225"></a><span id="l11.2225" class="difflineplus">+</span>
<a href="#l11.2226"></a><span id="l11.2226" class="difflineplus">+/**</span>
<a href="#l11.2227"></a><span id="l11.2227" class="difflineplus">+ * Take a result from an earlier searchRoomEvents call, and backfill results.</span>
<a href="#l11.2228"></a><span id="l11.2228" class="difflineplus">+ *</span>
<a href="#l11.2229"></a><span id="l11.2229" class="difflineplus">+ * @param  {object} searchResults  the results object to be updated</span>
<a href="#l11.2230"></a><span id="l11.2230" class="difflineplus">+ * @return {module:client.Promise} Resolves: updated result object</span>
<a href="#l11.2231"></a><span id="l11.2231" class="difflineplus">+ * @return {Error} Rejects: with an error response.</span>
<a href="#l11.2232"></a><span id="l11.2232" class="difflineplus">+ */</span>
<a href="#l11.2233"></a><span id="l11.2233" class="difflineplus">+MatrixClient.prototype.backPaginateRoomEventsSearch = function(searchResults) {</span>
<a href="#l11.2234"></a><span id="l11.2234" class="difflineplus">+    // TODO: we should implement a backoff (as per scrollback()) to deal more</span>
<a href="#l11.2235"></a><span id="l11.2235" class="difflineplus">+    // nicely with HTTP errors.</span>
<a href="#l11.2236"></a><span id="l11.2236" class="difflineplus">+</span>
<a href="#l11.2237"></a><span id="l11.2237" class="difflineplus">+    if (!searchResults.next_batch) {</span>
<a href="#l11.2238"></a><span id="l11.2238" class="difflineplus">+        return q.reject(new Error(&quot;Cannot backpaginate event search any further&quot;));</span>
<a href="#l11.2239"></a><span id="l11.2239" class="difflineplus">+    }</span>
<a href="#l11.2240"></a><span id="l11.2240" class="difflineplus">+</span>
<a href="#l11.2241"></a><span id="l11.2241" class="difflineplus">+    if (searchResults.pendingRequest) {</span>
<a href="#l11.2242"></a><span id="l11.2242" class="difflineplus">+        // already a request in progress - return the existing promise</span>
<a href="#l11.2243"></a><span id="l11.2243" class="difflineplus">+        return searchResults.pendingRequest;</span>
<a href="#l11.2244"></a><span id="l11.2244" class="difflineplus">+    }</span>
<a href="#l11.2245"></a><span id="l11.2245" class="difflineplus">+</span>
<a href="#l11.2246"></a><span id="l11.2246" class="difflineplus">+    var searchOpts = {</span>
<a href="#l11.2247"></a><span id="l11.2247" class="difflineplus">+        body: searchResults._query,</span>
<a href="#l11.2248"></a><span id="l11.2248" class="difflineplus">+        next_batch: searchResults.next_batch,</span>
<a href="#l11.2249"></a><span id="l11.2249" class="difflineplus">+    };</span>
<a href="#l11.2250"></a><span id="l11.2250" class="difflineplus">+</span>
<a href="#l11.2251"></a><span id="l11.2251" class="difflineplus">+    var promise = this.search(searchOpts).then(</span>
<a href="#l11.2252"></a><span id="l11.2252" class="difflineplus">+        this._processRoomEventsSearch.bind(this, searchResults)</span>
<a href="#l11.2253"></a><span id="l11.2253" class="difflineplus">+    ).finally(function() {</span>
<a href="#l11.2254"></a><span id="l11.2254" class="difflineplus">+        searchResults.pendingRequest = null;</span>
<a href="#l11.2255"></a><span id="l11.2255" class="difflineplus">+    });</span>
<a href="#l11.2256"></a><span id="l11.2256" class="difflineplus">+    searchResults.pendingRequest = promise;</span>
<a href="#l11.2257"></a><span id="l11.2257" class="difflineplus">+</span>
<a href="#l11.2258"></a><span id="l11.2258" class="difflineplus">+    return promise;</span>
<a href="#l11.2259"></a><span id="l11.2259" class="difflineplus">+};</span>
<a href="#l11.2260"></a><span id="l11.2260" class="difflineplus">+</span>
<a href="#l11.2261"></a><span id="l11.2261" class="difflineplus">+/**</span>
<a href="#l11.2262"></a><span id="l11.2262" class="difflineplus">+ * helper for searchRoomEvents and backPaginateRoomEventsSearch. Processes the</span>
<a href="#l11.2263"></a><span id="l11.2263" class="difflineplus">+ * response from the API call and updates the searchResults</span>
<a href="#l11.2264"></a><span id="l11.2264" class="difflineplus">+ *</span>
<a href="#l11.2265"></a><span id="l11.2265" class="difflineplus">+ * @param {Object} searchResults</span>
<a href="#l11.2266"></a><span id="l11.2266" class="difflineplus">+ * @param {Object} response</span>
<a href="#l11.2267"></a><span id="l11.2267" class="difflineplus">+ * @return {Object} searchResults</span>
<a href="#l11.2268"></a><span id="l11.2268" class="difflineplus">+ * @private</span>
<a href="#l11.2269"></a><span id="l11.2269" class="difflineplus">+ */</span>
<a href="#l11.2270"></a><span id="l11.2270" class="difflineplus">+MatrixClient.prototype._processRoomEventsSearch = function(searchResults, response) {</span>
<a href="#l11.2271"></a><span id="l11.2271" class="difflineplus">+    var room_events = response.search_categories.room_events;</span>
<a href="#l11.2272"></a><span id="l11.2272" class="difflineplus">+</span>
<a href="#l11.2273"></a><span id="l11.2273" class="difflineplus">+    searchResults.count = room_events.count;</span>
<a href="#l11.2274"></a><span id="l11.2274" class="difflineplus">+    searchResults.next_batch = room_events.next_batch;</span>
<a href="#l11.2275"></a><span id="l11.2275" class="difflineplus">+</span>
<a href="#l11.2276"></a><span id="l11.2276" class="difflineplus">+    // combine the highlight list with our existing list; build an object</span>
<a href="#l11.2277"></a><span id="l11.2277" class="difflineplus">+    // to avoid O(N^2) fail</span>
<a href="#l11.2278"></a><span id="l11.2278" class="difflineplus">+    var highlights = {};</span>
<a href="#l11.2279"></a><span id="l11.2279" class="difflineplus">+    room_events.highlights.forEach(function(hl) { highlights[hl] = 1; });</span>
<a href="#l11.2280"></a><span id="l11.2280" class="difflineplus">+    searchResults.highlights.forEach(function(hl) { highlights[hl] = 1; });</span>
<a href="#l11.2281"></a><span id="l11.2281" class="difflineplus">+</span>
<a href="#l11.2282"></a><span id="l11.2282" class="difflineplus">+    // turn it back into a list.</span>
<a href="#l11.2283"></a><span id="l11.2283" class="difflineplus">+    searchResults.highlights = Object.keys(highlights);</span>
<a href="#l11.2284"></a><span id="l11.2284" class="difflineplus">+</span>
<a href="#l11.2285"></a><span id="l11.2285" class="difflineplus">+    // append the new results to our existing results</span>
<a href="#l11.2286"></a><span id="l11.2286" class="difflineplus">+    for (var i = 0; i &lt; room_events.results.length; i++) {</span>
<a href="#l11.2287"></a><span id="l11.2287" class="difflineplus">+        var sr = SearchResult.fromJson(room_events.results[i], this.getEventMapper());</span>
<a href="#l11.2288"></a><span id="l11.2288" class="difflineplus">+        searchResults.results.push(sr);</span>
<a href="#l11.2289"></a><span id="l11.2289" class="difflineplus">+    }</span>
<a href="#l11.2290"></a><span id="l11.2290" class="difflineplus">+    return searchResults;</span>
<a href="#l11.2291"></a><span id="l11.2291" class="difflineplus">+};</span>
<a href="#l11.2292"></a><span id="l11.2292" class="difflineplus">+</span>
<a href="#l11.2293"></a><span id="l11.2293" class="difflineplus">+</span>
<a href="#l11.2294"></a><span id="l11.2294" class="difflineplus">+/**</span>
<a href="#l11.2295"></a><span id="l11.2295" class="difflineplus">+ * Populate the store with rooms the user has left.</span>
<a href="#l11.2296"></a><span id="l11.2296" class="difflineplus">+ * @return {module:client.Promise} Resolves: TODO - Resolved when the rooms have</span>
<a href="#l11.2297"></a><span id="l11.2297" class="difflineplus">+ * been added to the data store.</span>
<a href="#l11.2298"></a><span id="l11.2298" class="difflineplus">+ * @return {module:http-api.MatrixError} Rejects: with an error response.</span>
<a href="#l11.2299"></a><span id="l11.2299" class="difflineplus">+ */</span>
<a href="#l11.2300"></a><span id="l11.2300" class="difflineplus">+MatrixClient.prototype.syncLeftRooms = function() {</span>
<a href="#l11.2301"></a><span id="l11.2301" class="difflineplus">+    // Guard against multiple calls whilst ongoing and multiple calls post success</span>
<a href="#l11.2302"></a><span id="l11.2302" class="difflineplus">+    if (this._syncedLeftRooms) {</span>
<a href="#l11.2303"></a><span id="l11.2303" class="difflineplus">+        return q([]); // don't call syncRooms again if it succeeded.</span>
<a href="#l11.2304"></a><span id="l11.2304" class="difflineplus">+    }</span>
<a href="#l11.2305"></a><span id="l11.2305" class="difflineplus">+    if (this._syncLeftRoomsPromise) {</span>
<a href="#l11.2306"></a><span id="l11.2306" class="difflineplus">+        return this._syncLeftRoomsPromise; // return the ongoing request</span>
<a href="#l11.2307"></a><span id="l11.2307" class="difflineplus">+    }</span>
<a href="#l11.2308"></a><span id="l11.2308" class="difflineplus">+    var self = this;</span>
<a href="#l11.2309"></a><span id="l11.2309" class="difflineplus">+    var syncApi = new SyncApi(this, this._clientOpts);</span>
<a href="#l11.2310"></a><span id="l11.2310" class="difflineplus">+    this._syncLeftRoomsPromise = syncApi.syncLeftRooms();</span>
<a href="#l11.2311"></a><span id="l11.2311" class="difflineplus">+</span>
<a href="#l11.2312"></a><span id="l11.2312" class="difflineplus">+    // cleanup locks</span>
<a href="#l11.2313"></a><span id="l11.2313" class="difflineplus">+    this._syncLeftRoomsPromise.then(function(res) {</span>
<a href="#l11.2314"></a><span id="l11.2314" class="difflineplus">+        console.log(&quot;Marking success of sync left room request&quot;);</span>
<a href="#l11.2315"></a><span id="l11.2315" class="difflineplus">+        self._syncedLeftRooms = true; // flip the bit on success</span>
<a href="#l11.2316"></a><span id="l11.2316" class="difflineplus">+    }).finally(function() {</span>
<a href="#l11.2317"></a><span id="l11.2317" class="difflineplus">+        self._syncLeftRoomsPromise = null; // cleanup ongoing request state</span>
<a href="#l11.2318"></a><span id="l11.2318" class="difflineplus">+    });</span>
<a href="#l11.2319"></a><span id="l11.2319" class="difflineplus">+</span>
<a href="#l11.2320"></a><span id="l11.2320" class="difflineplus">+    return this._syncLeftRoomsPromise;</span>
<a href="#l11.2321"></a><span id="l11.2321" class="difflineplus">+};</span>
<a href="#l11.2322"></a><span id="l11.2322" class="difflineplus">+</span>
<a href="#l11.2323"></a><span id="l11.2323" class="difflineplus">+// Filters</span>
<a href="#l11.2324"></a><span id="l11.2324" class="difflineplus">+// =======</span>
<a href="#l11.2325"></a><span id="l11.2325" class="difflineplus">+</span>
<a href="#l11.2326"></a><span id="l11.2326" class="difflineplus">+/**</span>
<a href="#l11.2327"></a><span id="l11.2327" class="difflineplus">+ * Create a new filter.</span>
<a href="#l11.2328"></a><span id="l11.2328" class="difflineplus">+ * @param {Object} content The HTTP body for the request</span>
<a href="#l11.2329"></a><span id="l11.2329" class="difflineplus">+ * @return {Filter} Resolves to a Filter object.</span>
<a href="#l11.2330"></a><span id="l11.2330" class="difflineplus">+ * @return {module:http-api.MatrixError} Rejects: with an error response.</span>
<a href="#l11.2331"></a><span id="l11.2331" class="difflineplus">+ */</span>
<a href="#l11.2332"></a><span id="l11.2332" class="difflineplus">+MatrixClient.prototype.createFilter = function(content) {</span>
<a href="#l11.2333"></a><span id="l11.2333" class="difflineplus">+    var self = this;</span>
<a href="#l11.2334"></a><span id="l11.2334" class="difflineplus">+    var path = utils.encodeUri(&quot;/user/$userId/filter&quot;, {</span>
<a href="#l11.2335"></a><span id="l11.2335" class="difflineplus">+        $userId: this.credentials.userId</span>
<a href="#l11.2336"></a><span id="l11.2336" class="difflineplus">+    });</span>
<a href="#l11.2337"></a><span id="l11.2337" class="difflineplus">+    return this._http.authedRequest(</span>
<a href="#l11.2338"></a><span id="l11.2338" class="difflineplus">+        undefined, &quot;POST&quot;, path, undefined, content</span>
<a href="#l11.2339"></a><span id="l11.2339" class="difflineplus">+    ).then(function(response) {</span>
<a href="#l11.2340"></a><span id="l11.2340" class="difflineplus">+        // persist the filter</span>
<a href="#l11.2341"></a><span id="l11.2341" class="difflineplus">+        var filter = Filter.fromJson(</span>
<a href="#l11.2342"></a><span id="l11.2342" class="difflineplus">+            self.credentials.userId, response.filter_id, content</span>
<a href="#l11.2343"></a><span id="l11.2343" class="difflineplus">+        );</span>
<a href="#l11.2344"></a><span id="l11.2344" class="difflineplus">+        self.store.storeFilter(filter);</span>
<a href="#l11.2345"></a><span id="l11.2345" class="difflineplus">+        return filter;</span>
<a href="#l11.2346"></a><span id="l11.2346" class="difflineplus">+    });</span>
<a href="#l11.2347"></a><span id="l11.2347" class="difflineplus">+};</span>
<a href="#l11.2348"></a><span id="l11.2348" class="difflineplus">+</span>
<a href="#l11.2349"></a><span id="l11.2349" class="difflineplus">+/**</span>
<a href="#l11.2350"></a><span id="l11.2350" class="difflineplus">+ * Retrieve a filter.</span>
<a href="#l11.2351"></a><span id="l11.2351" class="difflineplus">+ * @param {string} userId The user ID of the filter owner</span>
<a href="#l11.2352"></a><span id="l11.2352" class="difflineplus">+ * @param {string} filterId The filter ID to retrieve</span>
<a href="#l11.2353"></a><span id="l11.2353" class="difflineplus">+ * @param {boolean} allowCached True to allow cached filters to be returned.</span>
<a href="#l11.2354"></a><span id="l11.2354" class="difflineplus">+ * Default: True.</span>
<a href="#l11.2355"></a><span id="l11.2355" class="difflineplus">+ * @return {module:client.Promise} Resolves: TODO</span>
<a href="#l11.2356"></a><span id="l11.2356" class="difflineplus">+ * @return {module:http-api.MatrixError} Rejects: with an error response.</span>
<a href="#l11.2357"></a><span id="l11.2357" class="difflineplus">+ */</span>
<a href="#l11.2358"></a><span id="l11.2358" class="difflineplus">+MatrixClient.prototype.getFilter = function(userId, filterId, allowCached) {</span>
<a href="#l11.2359"></a><span id="l11.2359" class="difflineplus">+    if (allowCached) {</span>
<a href="#l11.2360"></a><span id="l11.2360" class="difflineplus">+        var filter = this.store.getFilter(userId, filterId);</span>
<a href="#l11.2361"></a><span id="l11.2361" class="difflineplus">+        if (filter) {</span>
<a href="#l11.2362"></a><span id="l11.2362" class="difflineplus">+            return q(filter);</span>
<a href="#l11.2363"></a><span id="l11.2363" class="difflineplus">+        }</span>
<a href="#l11.2364"></a><span id="l11.2364" class="difflineplus">+    }</span>
<a href="#l11.2365"></a><span id="l11.2365" class="difflineplus">+</span>
<a href="#l11.2366"></a><span id="l11.2366" class="difflineplus">+    var self = this;</span>
<a href="#l11.2367"></a><span id="l11.2367" class="difflineplus">+    var path = utils.encodeUri(&quot;/user/$userId/filter/$filterId&quot;, {</span>
<a href="#l11.2368"></a><span id="l11.2368" class="difflineplus">+        $userId: userId,</span>
<a href="#l11.2369"></a><span id="l11.2369" class="difflineplus">+        $filterId: filterId</span>
<a href="#l11.2370"></a><span id="l11.2370" class="difflineplus">+    });</span>
<a href="#l11.2371"></a><span id="l11.2371" class="difflineplus">+</span>
<a href="#l11.2372"></a><span id="l11.2372" class="difflineplus">+    return this._http.authedRequest(</span>
<a href="#l11.2373"></a><span id="l11.2373" class="difflineplus">+        undefined, &quot;GET&quot;, path, undefined, undefined</span>
<a href="#l11.2374"></a><span id="l11.2374" class="difflineplus">+    ).then(function(response) {</span>
<a href="#l11.2375"></a><span id="l11.2375" class="difflineplus">+        // persist the filter</span>
<a href="#l11.2376"></a><span id="l11.2376" class="difflineplus">+        var filter = Filter.fromJson(</span>
<a href="#l11.2377"></a><span id="l11.2377" class="difflineplus">+            userId, filterId, response</span>
<a href="#l11.2378"></a><span id="l11.2378" class="difflineplus">+        );</span>
<a href="#l11.2379"></a><span id="l11.2379" class="difflineplus">+        self.store.storeFilter(filter);</span>
<a href="#l11.2380"></a><span id="l11.2380" class="difflineplus">+        return filter;</span>
<a href="#l11.2381"></a><span id="l11.2381" class="difflineplus">+    });</span>
<a href="#l11.2382"></a><span id="l11.2382" class="difflineplus">+};</span>
<a href="#l11.2383"></a><span id="l11.2383" class="difflineplus">+</span>
<a href="#l11.2384"></a><span id="l11.2384" class="difflineplus">+/**</span>
<a href="#l11.2385"></a><span id="l11.2385" class="difflineplus">+ * @param {string} filterName</span>
<a href="#l11.2386"></a><span id="l11.2386" class="difflineplus">+ * @param {Filter} filter</span>
<a href="#l11.2387"></a><span id="l11.2387" class="difflineplus">+ * @return {Promise&lt;String&gt;} Filter ID</span>
<a href="#l11.2388"></a><span id="l11.2388" class="difflineplus">+ */</span>
<a href="#l11.2389"></a><span id="l11.2389" class="difflineplus">+MatrixClient.prototype.getOrCreateFilter = function(filterName, filter) {</span>
<a href="#l11.2390"></a><span id="l11.2390" class="difflineplus">+</span>
<a href="#l11.2391"></a><span id="l11.2391" class="difflineplus">+    var filterId = this.store.getFilterIdByName(filterName);</span>
<a href="#l11.2392"></a><span id="l11.2392" class="difflineplus">+    var promise = q();</span>
<a href="#l11.2393"></a><span id="l11.2393" class="difflineplus">+    var self = this;</span>
<a href="#l11.2394"></a><span id="l11.2394" class="difflineplus">+</span>
<a href="#l11.2395"></a><span id="l11.2395" class="difflineplus">+    if (filterId) {</span>
<a href="#l11.2396"></a><span id="l11.2396" class="difflineplus">+        // check that the existing filter matches our expectations</span>
<a href="#l11.2397"></a><span id="l11.2397" class="difflineplus">+        promise = self.getFilter(self.credentials.userId,</span>
<a href="#l11.2398"></a><span id="l11.2398" class="difflineplus">+                         filterId, true</span>
<a href="#l11.2399"></a><span id="l11.2399" class="difflineplus">+        ).then(function(existingFilter) {</span>
<a href="#l11.2400"></a><span id="l11.2400" class="difflineplus">+            var oldDef = existingFilter.getDefinition();</span>
<a href="#l11.2401"></a><span id="l11.2401" class="difflineplus">+            var newDef = filter.getDefinition();</span>
<a href="#l11.2402"></a><span id="l11.2402" class="difflineplus">+</span>
<a href="#l11.2403"></a><span id="l11.2403" class="difflineplus">+            if (utils.deepCompare(oldDef, newDef)) {</span>
<a href="#l11.2404"></a><span id="l11.2404" class="difflineplus">+                // super, just use that.</span>
<a href="#l11.2405"></a><span id="l11.2405" class="difflineplus">+                // debuglog(&quot;Using existing filter ID %s: %s&quot;, filterId,</span>
<a href="#l11.2406"></a><span id="l11.2406" class="difflineplus">+                //          JSON.stringify(oldDef));</span>
<a href="#l11.2407"></a><span id="l11.2407" class="difflineplus">+                return q(filterId);</span>
<a href="#l11.2408"></a><span id="l11.2408" class="difflineplus">+            }</span>
<a href="#l11.2409"></a><span id="l11.2409" class="difflineplus">+            // debuglog(&quot;Existing filter ID %s: %s; new filter: %s&quot;,</span>
<a href="#l11.2410"></a><span id="l11.2410" class="difflineplus">+            //          filterId, JSON.stringify(oldDef), JSON.stringify(newDef));</span>
<a href="#l11.2411"></a><span id="l11.2411" class="difflineplus">+            self.store.setFilterIdByName(filterName, undefined);</span>
<a href="#l11.2412"></a><span id="l11.2412" class="difflineplus">+            return undefined;</span>
<a href="#l11.2413"></a><span id="l11.2413" class="difflineplus">+        }, function(error) {</span>
<a href="#l11.2414"></a><span id="l11.2414" class="difflineplus">+            // Synapse currently returns the following when the filter cannot be found:</span>
<a href="#l11.2415"></a><span id="l11.2415" class="difflineplus">+            // {</span>
<a href="#l11.2416"></a><span id="l11.2416" class="difflineplus">+            //     errcode: &quot;M_UNKNOWN&quot;,</span>
<a href="#l11.2417"></a><span id="l11.2417" class="difflineplus">+            //     name: &quot;M_UNKNOWN&quot;,</span>
<a href="#l11.2418"></a><span id="l11.2418" class="difflineplus">+            //     message: &quot;No row found&quot;,</span>
<a href="#l11.2419"></a><span id="l11.2419" class="difflineplus">+            //     data: Object, httpStatus: 404</span>
<a href="#l11.2420"></a><span id="l11.2420" class="difflineplus">+            // }</span>
<a href="#l11.2421"></a><span id="l11.2421" class="difflineplus">+            if (error.httpStatus === 404 &amp;&amp;</span>
<a href="#l11.2422"></a><span id="l11.2422" class="difflineplus">+                (error.errcode === &quot;M_UNKNOWN&quot; || error.errcode === &quot;M_NOT_FOUND&quot;)) {</span>
<a href="#l11.2423"></a><span id="l11.2423" class="difflineplus">+                // Clear existing filterId from localStorage</span>
<a href="#l11.2424"></a><span id="l11.2424" class="difflineplus">+                // if it no longer exists on the server</span>
<a href="#l11.2425"></a><span id="l11.2425" class="difflineplus">+                self.store.setFilterIdByName(filterName, undefined);</span>
<a href="#l11.2426"></a><span id="l11.2426" class="difflineplus">+                // Return a undefined value for existingId further down the promise chain</span>
<a href="#l11.2427"></a><span id="l11.2427" class="difflineplus">+                return undefined;</span>
<a href="#l11.2428"></a><span id="l11.2428" class="difflineplus">+            } else {</span>
<a href="#l11.2429"></a><span id="l11.2429" class="difflineplus">+                throw error;</span>
<a href="#l11.2430"></a><span id="l11.2430" class="difflineplus">+            }</span>
<a href="#l11.2431"></a><span id="l11.2431" class="difflineplus">+        });</span>
<a href="#l11.2432"></a><span id="l11.2432" class="difflineplus">+    }</span>
<a href="#l11.2433"></a><span id="l11.2433" class="difflineplus">+</span>
<a href="#l11.2434"></a><span id="l11.2434" class="difflineplus">+    return promise.then(function(existingId) {</span>
<a href="#l11.2435"></a><span id="l11.2435" class="difflineplus">+        if (existingId) {</span>
<a href="#l11.2436"></a><span id="l11.2436" class="difflineplus">+            return existingId;</span>
<a href="#l11.2437"></a><span id="l11.2437" class="difflineplus">+        }</span>
<a href="#l11.2438"></a><span id="l11.2438" class="difflineplus">+</span>
<a href="#l11.2439"></a><span id="l11.2439" class="difflineplus">+        // create a new filter</span>
<a href="#l11.2440"></a><span id="l11.2440" class="difflineplus">+        return self.createFilter(filter.getDefinition()</span>
<a href="#l11.2441"></a><span id="l11.2441" class="difflineplus">+        ).then(function(createdFilter) {</span>
<a href="#l11.2442"></a><span id="l11.2442" class="difflineplus">+            // debuglog(&quot;Created new filter ID %s: %s&quot;, createdFilter.filterId,</span>
<a href="#l11.2443"></a><span id="l11.2443" class="difflineplus">+            //          JSON.stringify(createdFilter.getDefinition()));</span>
<a href="#l11.2444"></a><span id="l11.2444" class="difflineplus">+            self.store.setFilterIdByName(filterName, createdFilter.filterId);</span>
<a href="#l11.2445"></a><span id="l11.2445" class="difflineplus">+            return createdFilter.filterId;</span>
<a href="#l11.2446"></a><span id="l11.2446" class="difflineplus">+        });</span>
<a href="#l11.2447"></a><span id="l11.2447" class="difflineplus">+    });</span>
<a href="#l11.2448"></a><span id="l11.2448" class="difflineplus">+};</span>
<a href="#l11.2449"></a><span id="l11.2449" class="difflineplus">+</span>
<a href="#l11.2450"></a><span id="l11.2450" class="difflineplus">+</span>
<a href="#l11.2451"></a><span id="l11.2451" class="difflineplus">+/**</span>
<a href="#l11.2452"></a><span id="l11.2452" class="difflineplus">+ * Gets a bearer token from the Home Server that the user can</span>
<a href="#l11.2453"></a><span id="l11.2453" class="difflineplus">+ * present to a third party in order to prove their ownership</span>
<a href="#l11.2454"></a><span id="l11.2454" class="difflineplus">+ * of the Matrix account they are logged into.</span>
<a href="#l11.2455"></a><span id="l11.2455" class="difflineplus">+ * @return {module:client.Promise} Resolves: Token object</span>
<a href="#l11.2456"></a><span id="l11.2456" class="difflineplus">+ * @return {module:http-api.MatrixError} Rejects: with an error response.</span>
<a href="#l11.2457"></a><span id="l11.2457" class="difflineplus">+ */</span>
<a href="#l11.2458"></a><span id="l11.2458" class="difflineplus">+MatrixClient.prototype.getOpenIdToken = function() {</span>
<a href="#l11.2459"></a><span id="l11.2459" class="difflineplus">+    var path = utils.encodeUri(&quot;/user/$userId/openid/request_token&quot;, {</span>
<a href="#l11.2460"></a><span id="l11.2460" class="difflineplus">+        $userId: this.credentials.userId,</span>
<a href="#l11.2461"></a><span id="l11.2461" class="difflineplus">+    });</span>
<a href="#l11.2462"></a><span id="l11.2462" class="difflineplus">+</span>
<a href="#l11.2463"></a><span id="l11.2463" class="difflineplus">+    return this._http.authedRequest(</span>
<a href="#l11.2464"></a><span id="l11.2464" class="difflineplus">+        undefined, &quot;POST&quot;, path, undefined, {}</span>
<a href="#l11.2465"></a><span id="l11.2465" class="difflineplus">+    );</span>
<a href="#l11.2466"></a><span id="l11.2466" class="difflineplus">+};</span>
<a href="#l11.2467"></a><span id="l11.2467" class="difflineplus">+</span>
<a href="#l11.2468"></a><span id="l11.2468" class="difflineplus">+</span>
<a href="#l11.2469"></a><span id="l11.2469" class="difflineplus">+// VoIP operations</span>
<a href="#l11.2470"></a><span id="l11.2470" class="difflineplus">+// ===============</span>
<a href="#l11.2471"></a><span id="l11.2471" class="difflineplus">+</span>
<a href="#l11.2472"></a><span id="l11.2472" class="difflineplus">+/**</span>
<a href="#l11.2473"></a><span id="l11.2473" class="difflineplus">+ * @param {module:client.callback} callback Optional.</span>
<a href="#l11.2474"></a><span id="l11.2474" class="difflineplus">+ * @return {module:client.Promise} Resolves: TODO</span>
<a href="#l11.2475"></a><span id="l11.2475" class="difflineplus">+ * @return {module:http-api.MatrixError} Rejects: with an error response.</span>
<a href="#l11.2476"></a><span id="l11.2476" class="difflineplus">+ */</span>
<a href="#l11.2477"></a><span id="l11.2477" class="difflineplus">+MatrixClient.prototype.turnServer = function(callback) {</span>
<a href="#l11.2478"></a><span id="l11.2478" class="difflineplus">+    return this._http.authedRequest(callback, &quot;GET&quot;, &quot;/voip/turnServer&quot;);</span>
<a href="#l11.2479"></a><span id="l11.2479" class="difflineplus">+};</span>
<a href="#l11.2480"></a><span id="l11.2480" class="difflineplus">+</span>
<a href="#l11.2481"></a><span id="l11.2481" class="difflineplus">+/**</span>
<a href="#l11.2482"></a><span id="l11.2482" class="difflineplus">+ * Get the TURN servers for this home server.</span>
<a href="#l11.2483"></a><span id="l11.2483" class="difflineplus">+ * @return {Array&lt;Object&gt;} The servers or an empty list.</span>
<a href="#l11.2484"></a><span id="l11.2484" class="difflineplus">+ */</span>
<a href="#l11.2485"></a><span id="l11.2485" class="difflineplus">+MatrixClient.prototype.getTurnServers = function() {</span>
<a href="#l11.2486"></a><span id="l11.2486" class="difflineplus">+    return this._turnServers || [];</span>
<a href="#l11.2487"></a><span id="l11.2487" class="difflineplus">+};</span>
<a href="#l11.2488"></a><span id="l11.2488" class="difflineplus">+</span>
<a href="#l11.2489"></a><span id="l11.2489" class="difflineplus">+// Higher level APIs</span>
<a href="#l11.2490"></a><span id="l11.2490" class="difflineplus">+// =================</span>
<a href="#l11.2491"></a><span id="l11.2491" class="difflineplus">+</span>
<a href="#l11.2492"></a><span id="l11.2492" class="difflineplus">+// TODO: stuff to handle:</span>
<a href="#l11.2493"></a><span id="l11.2493" class="difflineplus">+//   local echo</span>
<a href="#l11.2494"></a><span id="l11.2494" class="difflineplus">+//   event dup suppression? - apparently we should still be doing this</span>
<a href="#l11.2495"></a><span id="l11.2495" class="difflineplus">+//   tracking current display name / avatar per-message</span>
<a href="#l11.2496"></a><span id="l11.2496" class="difflineplus">+//   pagination</span>
<a href="#l11.2497"></a><span id="l11.2497" class="difflineplus">+//   re-sending (including persisting pending messages to be sent)</span>
<a href="#l11.2498"></a><span id="l11.2498" class="difflineplus">+//   - Need a nice way to callback the app for arbitrary events like</span>
<a href="#l11.2499"></a><span id="l11.2499" class="difflineplus">+//     displayname changes</span>
<a href="#l11.2500"></a><span id="l11.2500" class="difflineplus">+//   due to ambiguity (or should this be on a chat-specific layer)?</span>
<a href="#l11.2501"></a><span id="l11.2501" class="difflineplus">+//   reconnect after connectivity outages</span>
<a href="#l11.2502"></a><span id="l11.2502" class="difflineplus">+</span>
<a href="#l11.2503"></a><span id="l11.2503" class="difflineplus">+</span>
<a href="#l11.2504"></a><span id="l11.2504" class="difflineplus">+/**</span>
<a href="#l11.2505"></a><span id="l11.2505" class="difflineplus">+ * High level helper method to call initialSync, emit the resulting events,</span>
<a href="#l11.2506"></a><span id="l11.2506" class="difflineplus">+ * and then start polling the eventStream for new events. To listen for these</span>
<a href="#l11.2507"></a><span id="l11.2507" class="difflineplus">+ * events, add a listener for {@link module:client~MatrixClient#event:&quot;event&quot;}</span>
<a href="#l11.2508"></a><span id="l11.2508" class="difflineplus">+ * via {@link module:client~MatrixClient#on}.</span>
<a href="#l11.2509"></a><span id="l11.2509" class="difflineplus">+ * @param {Object=} opts Options to apply when syncing.</span>
<a href="#l11.2510"></a><span id="l11.2510" class="difflineplus">+ * @param {Number=} opts.initialSyncLimit The event &lt;code&gt;limit=&lt;/code&gt; to apply</span>
<a href="#l11.2511"></a><span id="l11.2511" class="difflineplus">+ * to initial sync. Default: 8.</span>
<a href="#l11.2512"></a><span id="l11.2512" class="difflineplus">+ * @param {Boolean=} opts.includeArchivedRooms True to put &lt;code&gt;archived=true&lt;/code&gt;</span>
<a href="#l11.2513"></a><span id="l11.2513" class="difflineplus">+ * on the &lt;code&gt;/initialSync&lt;/code&gt; request. Default: false.</span>
<a href="#l11.2514"></a><span id="l11.2514" class="difflineplus">+ * @param {Boolean=} opts.resolveInvitesToProfiles True to do /profile requests</span>
<a href="#l11.2515"></a><span id="l11.2515" class="difflineplus">+ * on every invite event if the displayname/avatar_url is not known for this user ID.</span>
<a href="#l11.2516"></a><span id="l11.2516" class="difflineplus">+ * Default: false.</span>
<a href="#l11.2517"></a><span id="l11.2517" class="difflineplus">+ *</span>
<a href="#l11.2518"></a><span id="l11.2518" class="difflineplus">+ * @param {String=} opts.pendingEventOrdering Controls where pending messages</span>
<a href="#l11.2519"></a><span id="l11.2519" class="difflineplus">+ * appear in a room's timeline. If &quot;&lt;b&gt;chronological&lt;/b&gt;&quot;, messages will appear</span>
<a href="#l11.2520"></a><span id="l11.2520" class="difflineplus">+ * in the timeline when the call to &lt;code&gt;sendEvent&lt;/code&gt; was made. If</span>
<a href="#l11.2521"></a><span id="l11.2521" class="difflineplus">+ * &quot;&lt;b&gt;detached&lt;/b&gt;&quot;, pending messages will appear in a separate list,</span>
<a href="#l11.2522"></a><span id="l11.2522" class="difflineplus">+ * accessbile via {@link module:models/room#getPendingEvents}. Default:</span>
<a href="#l11.2523"></a><span id="l11.2523" class="difflineplus">+ * &quot;chronological&quot;.</span>
<a href="#l11.2524"></a><span id="l11.2524" class="difflineplus">+ *</span>
<a href="#l11.2525"></a><span id="l11.2525" class="difflineplus">+ * @param {Number=} opts.pollTimeout The number of milliseconds to wait on /events.</span>
<a href="#l11.2526"></a><span id="l11.2526" class="difflineplus">+ * Default: 30000 (30 seconds).</span>
<a href="#l11.2527"></a><span id="l11.2527" class="difflineplus">+ *</span>
<a href="#l11.2528"></a><span id="l11.2528" class="difflineplus">+ * @param {Filter=} opts.filter The filter to apply to /sync calls. This will override</span>
<a href="#l11.2529"></a><span id="l11.2529" class="difflineplus">+ * the opts.initialSyncLimit, which would normally result in a timeline limit filter.</span>
<a href="#l11.2530"></a><span id="l11.2530" class="difflineplus">+ */</span>
<a href="#l11.2531"></a><span id="l11.2531" class="difflineplus">+MatrixClient.prototype.startClient = function(opts) {</span>
<a href="#l11.2532"></a><span id="l11.2532" class="difflineplus">+    if (this.clientRunning) {</span>
<a href="#l11.2533"></a><span id="l11.2533" class="difflineplus">+        // client is already running.</span>
<a href="#l11.2534"></a><span id="l11.2534" class="difflineplus">+        return;</span>
<a href="#l11.2535"></a><span id="l11.2535" class="difflineplus">+    }</span>
<a href="#l11.2536"></a><span id="l11.2536" class="difflineplus">+    this.clientRunning = true;</span>
<a href="#l11.2537"></a><span id="l11.2537" class="difflineplus">+    // backwards compat for when 'opts' was 'historyLen'.</span>
<a href="#l11.2538"></a><span id="l11.2538" class="difflineplus">+    if (typeof opts === &quot;number&quot;) {</span>
<a href="#l11.2539"></a><span id="l11.2539" class="difflineplus">+        opts = {</span>
<a href="#l11.2540"></a><span id="l11.2540" class="difflineplus">+            initialSyncLimit: opts</span>
<a href="#l11.2541"></a><span id="l11.2541" class="difflineplus">+        };</span>
<a href="#l11.2542"></a><span id="l11.2542" class="difflineplus">+    }</span>
<a href="#l11.2543"></a><span id="l11.2543" class="difflineplus">+</span>
<a href="#l11.2544"></a><span id="l11.2544" class="difflineplus">+    this._clientOpts = opts;</span>
<a href="#l11.2545"></a><span id="l11.2545" class="difflineplus">+</span>
<a href="#l11.2546"></a><span id="l11.2546" class="difflineplus">+    if (this._crypto) {</span>
<a href="#l11.2547"></a><span id="l11.2547" class="difflineplus">+        this._crypto.uploadKeys(5).done();</span>
<a href="#l11.2548"></a><span id="l11.2548" class="difflineplus">+        var tenMinutes = 1000 * 60 * 10;</span>
<a href="#l11.2549"></a><span id="l11.2549" class="difflineplus">+        var self = this;</span>
<a href="#l11.2550"></a><span id="l11.2550" class="difflineplus">+        this._uploadIntervalID = global.setInterval(function() {</span>
<a href="#l11.2551"></a><span id="l11.2551" class="difflineplus">+            self._crypto.uploadKeys(5).done();</span>
<a href="#l11.2552"></a><span id="l11.2552" class="difflineplus">+        }, tenMinutes);</span>
<a href="#l11.2553"></a><span id="l11.2553" class="difflineplus">+    }</span>
<a href="#l11.2554"></a><span id="l11.2554" class="difflineplus">+</span>
<a href="#l11.2555"></a><span id="l11.2555" class="difflineplus">+    // periodically poll for turn servers if we support voip</span>
<a href="#l11.2556"></a><span id="l11.2556" class="difflineplus">+    checkTurnServers(this);</span>
<a href="#l11.2557"></a><span id="l11.2557" class="difflineplus">+</span>
<a href="#l11.2558"></a><span id="l11.2558" class="difflineplus">+    if (this._syncApi) {</span>
<a href="#l11.2559"></a><span id="l11.2559" class="difflineplus">+        // This shouldn't happen since we thought the client was not running</span>
<a href="#l11.2560"></a><span id="l11.2560" class="difflineplus">+        console.error(&quot;Still have sync object whilst not running: stopping old one&quot;);</span>
<a href="#l11.2561"></a><span id="l11.2561" class="difflineplus">+        this._syncApi.stop();</span>
<a href="#l11.2562"></a><span id="l11.2562" class="difflineplus">+    }</span>
<a href="#l11.2563"></a><span id="l11.2563" class="difflineplus">+    this._syncApi = new SyncApi(this, opts);</span>
<a href="#l11.2564"></a><span id="l11.2564" class="difflineplus">+    this._syncApi.sync();</span>
<a href="#l11.2565"></a><span id="l11.2565" class="difflineplus">+};</span>
<a href="#l11.2566"></a><span id="l11.2566" class="difflineplus">+</span>
<a href="#l11.2567"></a><span id="l11.2567" class="difflineplus">+/**</span>
<a href="#l11.2568"></a><span id="l11.2568" class="difflineplus">+ * High level helper method to stop the client from polling and allow a</span>
<a href="#l11.2569"></a><span id="l11.2569" class="difflineplus">+ * clean shutdown.</span>
<a href="#l11.2570"></a><span id="l11.2570" class="difflineplus">+ */</span>
<a href="#l11.2571"></a><span id="l11.2571" class="difflineplus">+MatrixClient.prototype.stopClient = function() {</span>
<a href="#l11.2572"></a><span id="l11.2572" class="difflineplus">+    this.clientRunning = false;</span>
<a href="#l11.2573"></a><span id="l11.2573" class="difflineplus">+    // TODO: f.e. Room =&gt; self.store.storeRoom(room) ?</span>
<a href="#l11.2574"></a><span id="l11.2574" class="difflineplus">+    if (this._syncApi) {</span>
<a href="#l11.2575"></a><span id="l11.2575" class="difflineplus">+        this._syncApi.stop();</span>
<a href="#l11.2576"></a><span id="l11.2576" class="difflineplus">+        this._syncApi = null;</span>
<a href="#l11.2577"></a><span id="l11.2577" class="difflineplus">+    }</span>
<a href="#l11.2578"></a><span id="l11.2578" class="difflineplus">+    if (this._crypto) {</span>
<a href="#l11.2579"></a><span id="l11.2579" class="difflineplus">+        global.clearInterval(this._uploadIntervalID);</span>
<a href="#l11.2580"></a><span id="l11.2580" class="difflineplus">+    }</span>
<a href="#l11.2581"></a><span id="l11.2581" class="difflineplus">+    global.clearTimeout(this._checkTurnServersTimeoutID);</span>
<a href="#l11.2582"></a><span id="l11.2582" class="difflineplus">+};</span>
<a href="#l11.2583"></a><span id="l11.2583" class="difflineplus">+</span>
<a href="#l11.2584"></a><span id="l11.2584" class="difflineplus">+function setupCallEventHandler(client) {</span>
<a href="#l11.2585"></a><span id="l11.2585" class="difflineplus">+    var candidatesByCall = {</span>
<a href="#l11.2586"></a><span id="l11.2586" class="difflineplus">+        // callId: [Candidate]</span>
<a href="#l11.2587"></a><span id="l11.2587" class="difflineplus">+    };</span>
<a href="#l11.2588"></a><span id="l11.2588" class="difflineplus">+</span>
<a href="#l11.2589"></a><span id="l11.2589" class="difflineplus">+    // Maintain a buffer of events before the client has synced for the first time.</span>
<a href="#l11.2590"></a><span id="l11.2590" class="difflineplus">+    // This buffer will be inspected to see if we should send incoming call</span>
<a href="#l11.2591"></a><span id="l11.2591" class="difflineplus">+    // notifications. It needs to be buffered to correctly determine if an</span>
<a href="#l11.2592"></a><span id="l11.2592" class="difflineplus">+    // incoming call has had a matching answer/hangup.</span>
<a href="#l11.2593"></a><span id="l11.2593" class="difflineplus">+    var callEventBuffer = [];</span>
<a href="#l11.2594"></a><span id="l11.2594" class="difflineplus">+    var isClientPrepared = false;</span>
<a href="#l11.2595"></a><span id="l11.2595" class="difflineplus">+    client.on(&quot;sync&quot;, function(state) {</span>
<a href="#l11.2596"></a><span id="l11.2596" class="difflineplus">+        if (state === &quot;PREPARED&quot;) {</span>
<a href="#l11.2597"></a><span id="l11.2597" class="difflineplus">+            isClientPrepared = true;</span>
<a href="#l11.2598"></a><span id="l11.2598" class="difflineplus">+            var ignoreCallIds = {}; // Set&lt;String&gt;</span>
<a href="#l11.2599"></a><span id="l11.2599" class="difflineplus">+            // inspect the buffer and mark all calls which have been answered</span>
<a href="#l11.2600"></a><span id="l11.2600" class="difflineplus">+            // or hung up before passing them to the call event handler.</span>
<a href="#l11.2601"></a><span id="l11.2601" class="difflineplus">+            for (var i = callEventBuffer.length - 1; i &gt;= 0; i--) {</span>
<a href="#l11.2602"></a><span id="l11.2602" class="difflineplus">+                var ev = callEventBuffer[i];</span>
<a href="#l11.2603"></a><span id="l11.2603" class="difflineplus">+                if (ev.getType() === &quot;m.call.answer&quot; ||</span>
<a href="#l11.2604"></a><span id="l11.2604" class="difflineplus">+                        ev.getType() === &quot;m.call.hangup&quot;) {</span>
<a href="#l11.2605"></a><span id="l11.2605" class="difflineplus">+                    ignoreCallIds[ev.getContent().call_id] = &quot;yep&quot;;</span>
<a href="#l11.2606"></a><span id="l11.2606" class="difflineplus">+                }</span>
<a href="#l11.2607"></a><span id="l11.2607" class="difflineplus">+            }</span>
<a href="#l11.2608"></a><span id="l11.2608" class="difflineplus">+            // now loop through the buffer chronologically and inject them</span>
<a href="#l11.2609"></a><span id="l11.2609" class="difflineplus">+            callEventBuffer.forEach(function(e) {</span>
<a href="#l11.2610"></a><span id="l11.2610" class="difflineplus">+                if (ignoreCallIds[e.getContent().call_id]) {</span>
<a href="#l11.2611"></a><span id="l11.2611" class="difflineplus">+                    return;</span>
<a href="#l11.2612"></a><span id="l11.2612" class="difflineplus">+                }</span>
<a href="#l11.2613"></a><span id="l11.2613" class="difflineplus">+                callEventHandler(e);</span>
<a href="#l11.2614"></a><span id="l11.2614" class="difflineplus">+            });</span>
<a href="#l11.2615"></a><span id="l11.2615" class="difflineplus">+            callEventBuffer = [];</span>
<a href="#l11.2616"></a><span id="l11.2616" class="difflineplus">+        }</span>
<a href="#l11.2617"></a><span id="l11.2617" class="difflineplus">+    });</span>
<a href="#l11.2618"></a><span id="l11.2618" class="difflineplus">+</span>
<a href="#l11.2619"></a><span id="l11.2619" class="difflineplus">+    client.on(&quot;event&quot;, function(event) {</span>
<a href="#l11.2620"></a><span id="l11.2620" class="difflineplus">+        if (!isClientPrepared) {</span>
<a href="#l11.2621"></a><span id="l11.2621" class="difflineplus">+            if (event.getType().indexOf(&quot;m.call.&quot;) === 0) {</span>
<a href="#l11.2622"></a><span id="l11.2622" class="difflineplus">+                callEventBuffer.push(event);</span>
<a href="#l11.2623"></a><span id="l11.2623" class="difflineplus">+            }</span>
<a href="#l11.2624"></a><span id="l11.2624" class="difflineplus">+            return;</span>
<a href="#l11.2625"></a><span id="l11.2625" class="difflineplus">+        }</span>
<a href="#l11.2626"></a><span id="l11.2626" class="difflineplus">+        callEventHandler(event);</span>
<a href="#l11.2627"></a><span id="l11.2627" class="difflineplus">+    });</span>
<a href="#l11.2628"></a><span id="l11.2628" class="difflineplus">+</span>
<a href="#l11.2629"></a><span id="l11.2629" class="difflineplus">+    function callEventHandler(event) {</span>
<a href="#l11.2630"></a><span id="l11.2630" class="difflineplus">+        if (event.getType().indexOf(&quot;m.call.&quot;) !== 0) {</span>
<a href="#l11.2631"></a><span id="l11.2631" class="difflineplus">+            return; // not a call event</span>
<a href="#l11.2632"></a><span id="l11.2632" class="difflineplus">+        }</span>
<a href="#l11.2633"></a><span id="l11.2633" class="difflineplus">+        var content = event.getContent();</span>
<a href="#l11.2634"></a><span id="l11.2634" class="difflineplus">+        var call = content.call_id ? client.callList[content.call_id] : undefined;</span>
<a href="#l11.2635"></a><span id="l11.2635" class="difflineplus">+        var i;</span>
<a href="#l11.2636"></a><span id="l11.2636" class="difflineplus">+        //console.log(&quot;RECV %s content=%s&quot;, event.getType(), JSON.stringify(content));</span>
<a href="#l11.2637"></a><span id="l11.2637" class="difflineplus">+</span>
<a href="#l11.2638"></a><span id="l11.2638" class="difflineplus">+        if (event.getType() === &quot;m.call.invite&quot;) {</span>
<a href="#l11.2639"></a><span id="l11.2639" class="difflineplus">+            if (event.getSender() === client.credentials.userId) {</span>
<a href="#l11.2640"></a><span id="l11.2640" class="difflineplus">+                return; // ignore invites you send</span>
<a href="#l11.2641"></a><span id="l11.2641" class="difflineplus">+            }</span>
<a href="#l11.2642"></a><span id="l11.2642" class="difflineplus">+</span>
<a href="#l11.2643"></a><span id="l11.2643" class="difflineplus">+            if (event.getAge() &gt; content.lifetime) {</span>
<a href="#l11.2644"></a><span id="l11.2644" class="difflineplus">+                return; // expired call</span>
<a href="#l11.2645"></a><span id="l11.2645" class="difflineplus">+            }</span>
<a href="#l11.2646"></a><span id="l11.2646" class="difflineplus">+</span>
<a href="#l11.2647"></a><span id="l11.2647" class="difflineplus">+            if (call &amp;&amp; call.state === &quot;ended&quot;) {</span>
<a href="#l11.2648"></a><span id="l11.2648" class="difflineplus">+                return; // stale/old invite event</span>
<a href="#l11.2649"></a><span id="l11.2649" class="difflineplus">+            }</span>
<a href="#l11.2650"></a><span id="l11.2650" class="difflineplus">+            if (call) {</span>
<a href="#l11.2651"></a><span id="l11.2651" class="difflineplus">+                console.log(</span>
<a href="#l11.2652"></a><span id="l11.2652" class="difflineplus">+                    &quot;WARN: Already have a MatrixCall with id %s but got an &quot; +</span>
<a href="#l11.2653"></a><span id="l11.2653" class="difflineplus">+                    &quot;invite. Clobbering.&quot;,</span>
<a href="#l11.2654"></a><span id="l11.2654" class="difflineplus">+                    content.call_id</span>
<a href="#l11.2655"></a><span id="l11.2655" class="difflineplus">+                );</span>
<a href="#l11.2656"></a><span id="l11.2656" class="difflineplus">+            }</span>
<a href="#l11.2657"></a><span id="l11.2657" class="difflineplus">+</span>
<a href="#l11.2658"></a><span id="l11.2658" class="difflineplus">+            call = webRtcCall.createNewMatrixCall(client, event.getRoomId());</span>
<a href="#l11.2659"></a><span id="l11.2659" class="difflineplus">+            if (!call) {</span>
<a href="#l11.2660"></a><span id="l11.2660" class="difflineplus">+                console.log(</span>
<a href="#l11.2661"></a><span id="l11.2661" class="difflineplus">+                    &quot;Incoming call ID &quot; + content.call_id + &quot; but this client &quot; +</span>
<a href="#l11.2662"></a><span id="l11.2662" class="difflineplus">+                    &quot;doesn't support WebRTC&quot;</span>
<a href="#l11.2663"></a><span id="l11.2663" class="difflineplus">+                );</span>
<a href="#l11.2664"></a><span id="l11.2664" class="difflineplus">+                // don't hang up the call: there could be other clients</span>
<a href="#l11.2665"></a><span id="l11.2665" class="difflineplus">+                // connected that do support WebRTC and declining the</span>
<a href="#l11.2666"></a><span id="l11.2666" class="difflineplus">+                // the call on their behalf would be really annoying.</span>
<a href="#l11.2667"></a><span id="l11.2667" class="difflineplus">+                return;</span>
<a href="#l11.2668"></a><span id="l11.2668" class="difflineplus">+            }</span>
<a href="#l11.2669"></a><span id="l11.2669" class="difflineplus">+</span>
<a href="#l11.2670"></a><span id="l11.2670" class="difflineplus">+            call.callId = content.call_id;</span>
<a href="#l11.2671"></a><span id="l11.2671" class="difflineplus">+            call._initWithInvite(event);</span>
<a href="#l11.2672"></a><span id="l11.2672" class="difflineplus">+            client.callList[call.callId] = call;</span>
<a href="#l11.2673"></a><span id="l11.2673" class="difflineplus">+</span>
<a href="#l11.2674"></a><span id="l11.2674" class="difflineplus">+            // if we stashed candidate events for that call ID, play them back now</span>
<a href="#l11.2675"></a><span id="l11.2675" class="difflineplus">+            if (candidatesByCall[call.callId]) {</span>
<a href="#l11.2676"></a><span id="l11.2676" class="difflineplus">+                for (i = 0; i &lt; candidatesByCall[call.callId].length; i++) {</span>
<a href="#l11.2677"></a><span id="l11.2677" class="difflineplus">+                    call._gotRemoteIceCandidate(</span>
<a href="#l11.2678"></a><span id="l11.2678" class="difflineplus">+                        candidatesByCall[call.callId][i]</span>
<a href="#l11.2679"></a><span id="l11.2679" class="difflineplus">+                    );</span>
<a href="#l11.2680"></a><span id="l11.2680" class="difflineplus">+                }</span>
<a href="#l11.2681"></a><span id="l11.2681" class="difflineplus">+            }</span>
<a href="#l11.2682"></a><span id="l11.2682" class="difflineplus">+</span>
<a href="#l11.2683"></a><span id="l11.2683" class="difflineplus">+            // Were we trying to call that user (room)?</span>
<a href="#l11.2684"></a><span id="l11.2684" class="difflineplus">+            var existingCall;</span>
<a href="#l11.2685"></a><span id="l11.2685" class="difflineplus">+            var existingCalls = utils.values(client.callList);</span>
<a href="#l11.2686"></a><span id="l11.2686" class="difflineplus">+            for (i = 0; i &lt; existingCalls.length; ++i) {</span>
<a href="#l11.2687"></a><span id="l11.2687" class="difflineplus">+                var thisCall = existingCalls[i];</span>
<a href="#l11.2688"></a><span id="l11.2688" class="difflineplus">+                if (call.room_id === thisCall.room_id &amp;&amp;</span>
<a href="#l11.2689"></a><span id="l11.2689" class="difflineplus">+                        thisCall.direction === 'outbound' &amp;&amp;</span>
<a href="#l11.2690"></a><span id="l11.2690" class="difflineplus">+                        ([&quot;wait_local_media&quot;, &quot;create_offer&quot;, &quot;invite_sent&quot;].indexOf(</span>
<a href="#l11.2691"></a><span id="l11.2691" class="difflineplus">+                            thisCall.state) !== -1)) {</span>
<a href="#l11.2692"></a><span id="l11.2692" class="difflineplus">+                    existingCall = thisCall;</span>
<a href="#l11.2693"></a><span id="l11.2693" class="difflineplus">+                    break;</span>
<a href="#l11.2694"></a><span id="l11.2694" class="difflineplus">+                }</span>
<a href="#l11.2695"></a><span id="l11.2695" class="difflineplus">+            }</span>
<a href="#l11.2696"></a><span id="l11.2696" class="difflineplus">+</span>
<a href="#l11.2697"></a><span id="l11.2697" class="difflineplus">+            if (existingCall) {</span>
<a href="#l11.2698"></a><span id="l11.2698" class="difflineplus">+                // If we've only got to wait_local_media or create_offer and</span>
<a href="#l11.2699"></a><span id="l11.2699" class="difflineplus">+                // we've got an invite, pick the incoming call because we know</span>
<a href="#l11.2700"></a><span id="l11.2700" class="difflineplus">+                // we haven't sent our invite yet otherwise, pick whichever</span>
<a href="#l11.2701"></a><span id="l11.2701" class="difflineplus">+                // call has the lowest call ID (by string comparison)</span>
<a href="#l11.2702"></a><span id="l11.2702" class="difflineplus">+                if (existingCall.state === 'wait_local_media' ||</span>
<a href="#l11.2703"></a><span id="l11.2703" class="difflineplus">+                        existingCall.state === 'create_offer' ||</span>
<a href="#l11.2704"></a><span id="l11.2704" class="difflineplus">+                        existingCall.callId &gt; call.callId) {</span>
<a href="#l11.2705"></a><span id="l11.2705" class="difflineplus">+                    console.log(</span>
<a href="#l11.2706"></a><span id="l11.2706" class="difflineplus">+                        &quot;Glare detected: answering incoming call &quot; + call.callId +</span>
<a href="#l11.2707"></a><span id="l11.2707" class="difflineplus">+                        &quot; and canceling outgoing call &quot; + existingCall.callId</span>
<a href="#l11.2708"></a><span id="l11.2708" class="difflineplus">+                    );</span>
<a href="#l11.2709"></a><span id="l11.2709" class="difflineplus">+                    existingCall._replacedBy(call);</span>
<a href="#l11.2710"></a><span id="l11.2710" class="difflineplus">+                    call.answer();</span>
<a href="#l11.2711"></a><span id="l11.2711" class="difflineplus">+                }</span>
<a href="#l11.2712"></a><span id="l11.2712" class="difflineplus">+                else {</span>
<a href="#l11.2713"></a><span id="l11.2713" class="difflineplus">+                    console.log(</span>
<a href="#l11.2714"></a><span id="l11.2714" class="difflineplus">+                        &quot;Glare detected: rejecting incoming call &quot; + call.callId +</span>
<a href="#l11.2715"></a><span id="l11.2715" class="difflineplus">+                        &quot; and keeping outgoing call &quot; + existingCall.callId</span>
<a href="#l11.2716"></a><span id="l11.2716" class="difflineplus">+                    );</span>
<a href="#l11.2717"></a><span id="l11.2717" class="difflineplus">+                    call.hangup();</span>
<a href="#l11.2718"></a><span id="l11.2718" class="difflineplus">+                }</span>
<a href="#l11.2719"></a><span id="l11.2719" class="difflineplus">+            }</span>
<a href="#l11.2720"></a><span id="l11.2720" class="difflineplus">+            else {</span>
<a href="#l11.2721"></a><span id="l11.2721" class="difflineplus">+                client.emit(&quot;Call.incoming&quot;, call);</span>
<a href="#l11.2722"></a><span id="l11.2722" class="difflineplus">+            }</span>
<a href="#l11.2723"></a><span id="l11.2723" class="difflineplus">+        }</span>
<a href="#l11.2724"></a><span id="l11.2724" class="difflineplus">+        else if (event.getType() === 'm.call.answer') {</span>
<a href="#l11.2725"></a><span id="l11.2725" class="difflineplus">+            if (!call) {</span>
<a href="#l11.2726"></a><span id="l11.2726" class="difflineplus">+                return;</span>
<a href="#l11.2727"></a><span id="l11.2727" class="difflineplus">+            }</span>
<a href="#l11.2728"></a><span id="l11.2728" class="difflineplus">+            if (event.getSender() === client.credentials.userId) {</span>
<a href="#l11.2729"></a><span id="l11.2729" class="difflineplus">+                if (call.state === 'ringing') {</span>
<a href="#l11.2730"></a><span id="l11.2730" class="difflineplus">+                    call._onAnsweredElsewhere(content);</span>
<a href="#l11.2731"></a><span id="l11.2731" class="difflineplus">+                }</span>
<a href="#l11.2732"></a><span id="l11.2732" class="difflineplus">+            }</span>
<a href="#l11.2733"></a><span id="l11.2733" class="difflineplus">+            else {</span>
<a href="#l11.2734"></a><span id="l11.2734" class="difflineplus">+                call._receivedAnswer(content);</span>
<a href="#l11.2735"></a><span id="l11.2735" class="difflineplus">+            }</span>
<a href="#l11.2736"></a><span id="l11.2736" class="difflineplus">+        }</span>
<a href="#l11.2737"></a><span id="l11.2737" class="difflineplus">+        else if (event.getType() === 'm.call.candidates') {</span>
<a href="#l11.2738"></a><span id="l11.2738" class="difflineplus">+            if (event.getSender() === client.credentials.userId) {</span>
<a href="#l11.2739"></a><span id="l11.2739" class="difflineplus">+                return;</span>
<a href="#l11.2740"></a><span id="l11.2740" class="difflineplus">+            }</span>
<a href="#l11.2741"></a><span id="l11.2741" class="difflineplus">+            if (!call) {</span>
<a href="#l11.2742"></a><span id="l11.2742" class="difflineplus">+                // store the candidates; we may get a call eventually.</span>
<a href="#l11.2743"></a><span id="l11.2743" class="difflineplus">+                if (!candidatesByCall[content.call_id]) {</span>
<a href="#l11.2744"></a><span id="l11.2744" class="difflineplus">+                    candidatesByCall[content.call_id] = [];</span>
<a href="#l11.2745"></a><span id="l11.2745" class="difflineplus">+                }</span>
<a href="#l11.2746"></a><span id="l11.2746" class="difflineplus">+                candidatesByCall[content.call_id] = candidatesByCall[</span>
<a href="#l11.2747"></a><span id="l11.2747" class="difflineplus">+                    content.call_id</span>
<a href="#l11.2748"></a><span id="l11.2748" class="difflineplus">+                ].concat(content.candidates);</span>
<a href="#l11.2749"></a><span id="l11.2749" class="difflineplus">+            }</span>
<a href="#l11.2750"></a><span id="l11.2750" class="difflineplus">+            else {</span>
<a href="#l11.2751"></a><span id="l11.2751" class="difflineplus">+                for (i = 0; i &lt; content.candidates.length; i++) {</span>
<a href="#l11.2752"></a><span id="l11.2752" class="difflineplus">+                    call._gotRemoteIceCandidate(content.candidates[i]);</span>
<a href="#l11.2753"></a><span id="l11.2753" class="difflineplus">+                }</span>
<a href="#l11.2754"></a><span id="l11.2754" class="difflineplus">+            }</span>
<a href="#l11.2755"></a><span id="l11.2755" class="difflineplus">+        }</span>
<a href="#l11.2756"></a><span id="l11.2756" class="difflineplus">+        else if (event.getType() === 'm.call.hangup') {</span>
<a href="#l11.2757"></a><span id="l11.2757" class="difflineplus">+            // Note that we also observe our own hangups here so we can see</span>
<a href="#l11.2758"></a><span id="l11.2758" class="difflineplus">+            // if we've already rejected a call that would otherwise be valid</span>
<a href="#l11.2759"></a><span id="l11.2759" class="difflineplus">+            if (!call) {</span>
<a href="#l11.2760"></a><span id="l11.2760" class="difflineplus">+                // if not live, store the fact that the call has ended because</span>
<a href="#l11.2761"></a><span id="l11.2761" class="difflineplus">+                // we're probably getting events backwards so</span>
<a href="#l11.2762"></a><span id="l11.2762" class="difflineplus">+                // the hangup will come before the invite</span>
<a href="#l11.2763"></a><span id="l11.2763" class="difflineplus">+                call = webRtcCall.createNewMatrixCall(client, event.getRoomId());</span>
<a href="#l11.2764"></a><span id="l11.2764" class="difflineplus">+                if (call) {</span>
<a href="#l11.2765"></a><span id="l11.2765" class="difflineplus">+                    call.callId = content.call_id;</span>
<a href="#l11.2766"></a><span id="l11.2766" class="difflineplus">+                    call._initWithHangup(event);</span>
<a href="#l11.2767"></a><span id="l11.2767" class="difflineplus">+                    client.callList[content.call_id] = call;</span>
<a href="#l11.2768"></a><span id="l11.2768" class="difflineplus">+                }</span>
<a href="#l11.2769"></a><span id="l11.2769" class="difflineplus">+            }</span>
<a href="#l11.2770"></a><span id="l11.2770" class="difflineplus">+            else {</span>
<a href="#l11.2771"></a><span id="l11.2771" class="difflineplus">+                if (call.state !== 'ended') {</span>
<a href="#l11.2772"></a><span id="l11.2772" class="difflineplus">+                    call._onHangupReceived(content);</span>
<a href="#l11.2773"></a><span id="l11.2773" class="difflineplus">+                    delete client.callList[content.call_id];</span>
<a href="#l11.2774"></a><span id="l11.2774" class="difflineplus">+                }</span>
<a href="#l11.2775"></a><span id="l11.2775" class="difflineplus">+            }</span>
<a href="#l11.2776"></a><span id="l11.2776" class="difflineplus">+        }</span>
<a href="#l11.2777"></a><span id="l11.2777" class="difflineplus">+    }</span>
<a href="#l11.2778"></a><span id="l11.2778" class="difflineplus">+}</span>
<a href="#l11.2779"></a><span id="l11.2779" class="difflineplus">+</span>
<a href="#l11.2780"></a><span id="l11.2780" class="difflineplus">+function checkTurnServers(client) {</span>
<a href="#l11.2781"></a><span id="l11.2781" class="difflineplus">+    if (!client._supportsVoip) {</span>
<a href="#l11.2782"></a><span id="l11.2782" class="difflineplus">+        return;</span>
<a href="#l11.2783"></a><span id="l11.2783" class="difflineplus">+    }</span>
<a href="#l11.2784"></a><span id="l11.2784" class="difflineplus">+    if (client.isGuest()) {</span>
<a href="#l11.2785"></a><span id="l11.2785" class="difflineplus">+        return; // guests can't access TURN servers</span>
<a href="#l11.2786"></a><span id="l11.2786" class="difflineplus">+    }</span>
<a href="#l11.2787"></a><span id="l11.2787" class="difflineplus">+</span>
<a href="#l11.2788"></a><span id="l11.2788" class="difflineplus">+    client.turnServer().done(function(res) {</span>
<a href="#l11.2789"></a><span id="l11.2789" class="difflineplus">+        if (res.uris) {</span>
<a href="#l11.2790"></a><span id="l11.2790" class="difflineplus">+            console.log(&quot;Got TURN URIs: &quot; + res.uris + &quot; refresh in &quot; +</span>
<a href="#l11.2791"></a><span id="l11.2791" class="difflineplus">+                res.ttl + &quot; secs&quot;);</span>
<a href="#l11.2792"></a><span id="l11.2792" class="difflineplus">+            // map the response to a format that can be fed to</span>
<a href="#l11.2793"></a><span id="l11.2793" class="difflineplus">+            // RTCPeerConnection</span>
<a href="#l11.2794"></a><span id="l11.2794" class="difflineplus">+            var servers = {</span>
<a href="#l11.2795"></a><span id="l11.2795" class="difflineplus">+                urls: res.uris,</span>
<a href="#l11.2796"></a><span id="l11.2796" class="difflineplus">+                username: res.username,</span>
<a href="#l11.2797"></a><span id="l11.2797" class="difflineplus">+                credential: res.password</span>
<a href="#l11.2798"></a><span id="l11.2798" class="difflineplus">+            };</span>
<a href="#l11.2799"></a><span id="l11.2799" class="difflineplus">+            client._turnServers = [servers];</span>
<a href="#l11.2800"></a><span id="l11.2800" class="difflineplus">+            // re-fetch when we're about to reach the TTL</span>
<a href="#l11.2801"></a><span id="l11.2801" class="difflineplus">+            client._checkTurnServersTimeoutID =</span>
<a href="#l11.2802"></a><span id="l11.2802" class="difflineplus">+                setTimeout(function() { checkTurnServers(client); },</span>
<a href="#l11.2803"></a><span id="l11.2803" class="difflineplus">+                           (res.ttl || (60 * 60)) * 1000 * 0.9</span>
<a href="#l11.2804"></a><span id="l11.2804" class="difflineplus">+                          );</span>
<a href="#l11.2805"></a><span id="l11.2805" class="difflineplus">+        }</span>
<a href="#l11.2806"></a><span id="l11.2806" class="difflineplus">+    }, function(err) {</span>
<a href="#l11.2807"></a><span id="l11.2807" class="difflineplus">+        console.error(&quot;Failed to get TURN URIs&quot;);</span>
<a href="#l11.2808"></a><span id="l11.2808" class="difflineplus">+        client._checkTurnServersTimeoutID =</span>
<a href="#l11.2809"></a><span id="l11.2809" class="difflineplus">+            setTimeout(function() { checkTurnServers(client); }, 60000);</span>
<a href="#l11.2810"></a><span id="l11.2810" class="difflineplus">+    });</span>
<a href="#l11.2811"></a><span id="l11.2811" class="difflineplus">+}</span>
<a href="#l11.2812"></a><span id="l11.2812" class="difflineplus">+</span>
<a href="#l11.2813"></a><span id="l11.2813" class="difflineplus">+function _reject(callback, defer, err) {</span>
<a href="#l11.2814"></a><span id="l11.2814" class="difflineplus">+    if (callback) {</span>
<a href="#l11.2815"></a><span id="l11.2815" class="difflineplus">+        callback(err);</span>
<a href="#l11.2816"></a><span id="l11.2816" class="difflineplus">+    }</span>
<a href="#l11.2817"></a><span id="l11.2817" class="difflineplus">+    defer.reject(err);</span>
<a href="#l11.2818"></a><span id="l11.2818" class="difflineplus">+}</span>
<a href="#l11.2819"></a><span id="l11.2819" class="difflineplus">+</span>
<a href="#l11.2820"></a><span id="l11.2820" class="difflineplus">+function _resolve(callback, defer, res) {</span>
<a href="#l11.2821"></a><span id="l11.2821" class="difflineplus">+    if (callback) {</span>
<a href="#l11.2822"></a><span id="l11.2822" class="difflineplus">+        callback(null, res);</span>
<a href="#l11.2823"></a><span id="l11.2823" class="difflineplus">+    }</span>
<a href="#l11.2824"></a><span id="l11.2824" class="difflineplus">+    defer.resolve(res);</span>
<a href="#l11.2825"></a><span id="l11.2825" class="difflineplus">+}</span>
<a href="#l11.2826"></a><span id="l11.2826" class="difflineplus">+</span>
<a href="#l11.2827"></a><span id="l11.2827" class="difflineplus">+function _PojoToMatrixEventMapper(client) {</span>
<a href="#l11.2828"></a><span id="l11.2828" class="difflineplus">+    function mapper(plainOldJsObject) {</span>
<a href="#l11.2829"></a><span id="l11.2829" class="difflineplus">+        var event = new MatrixEvent(plainOldJsObject);</span>
<a href="#l11.2830"></a><span id="l11.2830" class="difflineplus">+        if (event.isEncrypted()) {</span>
<a href="#l11.2831"></a><span id="l11.2831" class="difflineplus">+            _decryptEvent(client, event);</span>
<a href="#l11.2832"></a><span id="l11.2832" class="difflineplus">+        }</span>
<a href="#l11.2833"></a><span id="l11.2833" class="difflineplus">+        return event;</span>
<a href="#l11.2834"></a><span id="l11.2834" class="difflineplus">+    }</span>
<a href="#l11.2835"></a><span id="l11.2835" class="difflineplus">+    return mapper;</span>
<a href="#l11.2836"></a><span id="l11.2836" class="difflineplus">+}</span>
<a href="#l11.2837"></a><span id="l11.2837" class="difflineplus">+</span>
<a href="#l11.2838"></a><span id="l11.2838" class="difflineplus">+/**</span>
<a href="#l11.2839"></a><span id="l11.2839" class="difflineplus">+ * @return {Function}</span>
<a href="#l11.2840"></a><span id="l11.2840" class="difflineplus">+ */</span>
<a href="#l11.2841"></a><span id="l11.2841" class="difflineplus">+MatrixClient.prototype.getEventMapper = function() {</span>
<a href="#l11.2842"></a><span id="l11.2842" class="difflineplus">+    return _PojoToMatrixEventMapper(this);</span>
<a href="#l11.2843"></a><span id="l11.2843" class="difflineplus">+};</span>
<a href="#l11.2844"></a><span id="l11.2844" class="difflineplus">+</span>
<a href="#l11.2845"></a><span id="l11.2845" class="difflineplus">+// Identity Server Operations</span>
<a href="#l11.2846"></a><span id="l11.2846" class="difflineplus">+// ==========================</span>
<a href="#l11.2847"></a><span id="l11.2847" class="difflineplus">+</span>
<a href="#l11.2848"></a><span id="l11.2848" class="difflineplus">+/**</span>
<a href="#l11.2849"></a><span id="l11.2849" class="difflineplus">+ * Generates a random string suitable for use as a client secret. &lt;strong&gt;This</span>
<a href="#l11.2850"></a><span id="l11.2850" class="difflineplus">+ * method is experimental and may change.&lt;/strong&gt;</span>
<a href="#l11.2851"></a><span id="l11.2851" class="difflineplus">+ * @return {string} A new client secret</span>
<a href="#l11.2852"></a><span id="l11.2852" class="difflineplus">+ */</span>
<a href="#l11.2853"></a><span id="l11.2853" class="difflineplus">+MatrixClient.prototype.generateClientSecret = function() {</span>
<a href="#l11.2854"></a><span id="l11.2854" class="difflineplus">+    var ret = &quot;&quot;;</span>
<a href="#l11.2855"></a><span id="l11.2855" class="difflineplus">+    var chars = &quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789&quot;;</span>
<a href="#l11.2856"></a><span id="l11.2856" class="difflineplus">+</span>
<a href="#l11.2857"></a><span id="l11.2857" class="difflineplus">+    for (var i = 0; i &lt; 32; i++) {</span>
<a href="#l11.2858"></a><span id="l11.2858" class="difflineplus">+        ret += chars.charAt(Math.floor(Math.random() * chars.length));</span>
<a href="#l11.2859"></a><span id="l11.2859" class="difflineplus">+    }</span>
<a href="#l11.2860"></a><span id="l11.2860" class="difflineplus">+</span>
<a href="#l11.2861"></a><span id="l11.2861" class="difflineplus">+    return ret;</span>
<a href="#l11.2862"></a><span id="l11.2862" class="difflineplus">+};</span>
<a href="#l11.2863"></a><span id="l11.2863" class="difflineplus">+</span>
<a href="#l11.2864"></a><span id="l11.2864" class="difflineplus">+/** */</span>
<a href="#l11.2865"></a><span id="l11.2865" class="difflineplus">+module.exports.MatrixClient = MatrixClient;</span>
<a href="#l11.2866"></a><span id="l11.2866" class="difflineplus">+/** */</span>
<a href="#l11.2867"></a><span id="l11.2867" class="difflineplus">+module.exports.CRYPTO_ENABLED = CRYPTO_ENABLED;</span>
<a href="#l11.2868"></a><span id="l11.2868" class="difflineplus">+</span>
<a href="#l11.2869"></a><span id="l11.2869" class="difflineplus">+// MatrixClient Event JSDocs</span>
<a href="#l11.2870"></a><span id="l11.2870" class="difflineplus">+</span>
<a href="#l11.2871"></a><span id="l11.2871" class="difflineplus">+/**</span>
<a href="#l11.2872"></a><span id="l11.2872" class="difflineplus">+ * Fires whenever the SDK receives a new event.</span>
<a href="#l11.2873"></a><span id="l11.2873" class="difflineplus">+ * &lt;p&gt;</span>
<a href="#l11.2874"></a><span id="l11.2874" class="difflineplus">+ * This is only fired for live events received via /sync - it is not fired for</span>
<a href="#l11.2875"></a><span id="l11.2875" class="difflineplus">+ * events received over context, search, or pagination APIs.</span>
<a href="#l11.2876"></a><span id="l11.2876" class="difflineplus">+ *</span>
<a href="#l11.2877"></a><span id="l11.2877" class="difflineplus">+ * @event module:client~MatrixClient#&quot;event&quot;</span>
<a href="#l11.2878"></a><span id="l11.2878" class="difflineplus">+ * @param {MatrixEvent} event The matrix event which caused this event to fire.</span>
<a href="#l11.2879"></a><span id="l11.2879" class="difflineplus">+ * @example</span>
<a href="#l11.2880"></a><span id="l11.2880" class="difflineplus">+ * matrixClient.on(&quot;event&quot;, function(event){</span>
<a href="#l11.2881"></a><span id="l11.2881" class="difflineplus">+ *   var sender = event.getSender();</span>
<a href="#l11.2882"></a><span id="l11.2882" class="difflineplus">+ * });</span>
<a href="#l11.2883"></a><span id="l11.2883" class="difflineplus">+ */</span>
<a href="#l11.2884"></a><span id="l11.2884" class="difflineplus">+</span>
<a href="#l11.2885"></a><span id="l11.2885" class="difflineplus">+/**</span>
<a href="#l11.2886"></a><span id="l11.2886" class="difflineplus">+ * Fires whenever the SDK receives a new to-device event.</span>
<a href="#l11.2887"></a><span id="l11.2887" class="difflineplus">+ * @event module:client~MatrixClient#&quot;toDeviceEvent&quot;</span>
<a href="#l11.2888"></a><span id="l11.2888" class="difflineplus">+ * @param {MatrixEvent} event The matrix event which caused this event to fire.</span>
<a href="#l11.2889"></a><span id="l11.2889" class="difflineplus">+ * @example</span>
<a href="#l11.2890"></a><span id="l11.2890" class="difflineplus">+ * matrixClient.on(&quot;toDeviceEvent&quot;, function(event){</span>
<a href="#l11.2891"></a><span id="l11.2891" class="difflineplus">+ *   var sender = event.getSender();</span>
<a href="#l11.2892"></a><span id="l11.2892" class="difflineplus">+ * });</span>
<a href="#l11.2893"></a><span id="l11.2893" class="difflineplus">+ */</span>
<a href="#l11.2894"></a><span id="l11.2894" class="difflineplus">+</span>
<a href="#l11.2895"></a><span id="l11.2895" class="difflineplus">+/**</span>
<a href="#l11.2896"></a><span id="l11.2896" class="difflineplus">+ * Fires whenever the SDK's syncing state is updated. The state can be one of:</span>
<a href="#l11.2897"></a><span id="l11.2897" class="difflineplus">+ * &lt;ul&gt;</span>
<a href="#l11.2898"></a><span id="l11.2898" class="difflineplus">+ * &lt;li&gt;PREPARED : The client has synced with the server at least once and is</span>
<a href="#l11.2899"></a><span id="l11.2899" class="difflineplus">+ * ready for methods to be called on it. This will be immediately followed by</span>
<a href="#l11.2900"></a><span id="l11.2900" class="difflineplus">+ * a state of SYNCING. &lt;i&gt;This is the equivalent of &quot;syncComplete&quot; in the</span>
<a href="#l11.2901"></a><span id="l11.2901" class="difflineplus">+ * previous API.&lt;/i&gt;&lt;/li&gt;</span>
<a href="#l11.2902"></a><span id="l11.2902" class="difflineplus">+ * &lt;li&gt;SYNCING : The client is currently polling for new events from the server.</span>
<a href="#l11.2903"></a><span id="l11.2903" class="difflineplus">+ * This will be called &lt;i&gt;after&lt;/i&gt; processing latest events from a sync.&lt;/li&gt;</span>
<a href="#l11.2904"></a><span id="l11.2904" class="difflineplus">+ * &lt;li&gt;ERROR : The client has had a problem syncing with the server. If this is</span>
<a href="#l11.2905"></a><span id="l11.2905" class="difflineplus">+ * called &lt;i&gt;before&lt;/i&gt; PREPARED then there was a problem performing the initial</span>
<a href="#l11.2906"></a><span id="l11.2906" class="difflineplus">+ * sync. If this is called &lt;i&gt;after&lt;/i&gt; PREPARED then there was a problem polling</span>
<a href="#l11.2907"></a><span id="l11.2907" class="difflineplus">+ * the server for updates. This may be called multiple times even if the state is</span>
<a href="#l11.2908"></a><span id="l11.2908" class="difflineplus">+ * already ERROR. &lt;i&gt;This is the equivalent of &quot;syncError&quot; in the previous</span>
<a href="#l11.2909"></a><span id="l11.2909" class="difflineplus">+ * API.&lt;/i&gt;&lt;/li&gt;</span>
<a href="#l11.2910"></a><span id="l11.2910" class="difflineplus">+ * &lt;li&gt;RECONNECTING: The sync connedtion has dropped, but not in a way that should</span>
<a href="#l11.2911"></a><span id="l11.2911" class="difflineplus">+ * be considered erroneous.</span>
<a href="#l11.2912"></a><span id="l11.2912" class="difflineplus">+ * &lt;/li&gt;</span>
<a href="#l11.2913"></a><span id="l11.2913" class="difflineplus">+ * &lt;li&gt;STOPPED: The client has stopped syncing with server due to stopClient</span>
<a href="#l11.2914"></a><span id="l11.2914" class="difflineplus">+ * being called.</span>
<a href="#l11.2915"></a><span id="l11.2915" class="difflineplus">+ * &lt;/li&gt;</span>
<a href="#l11.2916"></a><span id="l11.2916" class="difflineplus">+ * &lt;/ul&gt;</span>
<a href="#l11.2917"></a><span id="l11.2917" class="difflineplus">+ * State transition diagram:</span>
<a href="#l11.2918"></a><span id="l11.2918" class="difflineplus">+ * &lt;pre&gt;</span>
<a href="#l11.2919"></a><span id="l11.2919" class="difflineplus">+ *                                          +----&gt;STOPPED</span>
<a href="#l11.2920"></a><span id="l11.2920" class="difflineplus">+ *                                          |</span>
<a href="#l11.2921"></a><span id="l11.2921" class="difflineplus">+ *              +-----&gt;PREPARED -------&gt; SYNCING &lt;--+</span>
<a href="#l11.2922"></a><span id="l11.2922" class="difflineplus">+ *              |        ^                  ^       |</span>
<a href="#l11.2923"></a><span id="l11.2923" class="difflineplus">+ *              |        |                  |       |</span>
<a href="#l11.2924"></a><span id="l11.2924" class="difflineplus">+ *              |        |                  V       |</span>
<a href="#l11.2925"></a><span id="l11.2925" class="difflineplus">+ *   null ------+        |  +-RECONNECTING&lt;-+       |</span>
<a href="#l11.2926"></a><span id="l11.2926" class="difflineplus">+ *              |        |  V                       |</span>
<a href="#l11.2927"></a><span id="l11.2927" class="difflineplus">+ *              +-------&gt;ERROR ---------------------+</span>
<a href="#l11.2928"></a><span id="l11.2928" class="difflineplus">+ *</span>
<a href="#l11.2929"></a><span id="l11.2929" class="difflineplus">+ * NB: 'null' will never be emitted by this event.</span>
<a href="#l11.2930"></a><span id="l11.2930" class="difflineplus">+ * &lt;/pre&gt;</span>
<a href="#l11.2931"></a><span id="l11.2931" class="difflineplus">+ * Transitions:</span>
<a href="#l11.2932"></a><span id="l11.2932" class="difflineplus">+ * &lt;ul&gt;</span>
<a href="#l11.2933"></a><span id="l11.2933" class="difflineplus">+ * &lt;li&gt;&lt;code&gt;null -&gt; PREPARED&lt;/code&gt; : Occurs when the initial sync is completed</span>
<a href="#l11.2934"></a><span id="l11.2934" class="difflineplus">+ * first time. This involves setting up filters and obtaining push rules.</span>
<a href="#l11.2935"></a><span id="l11.2935" class="difflineplus">+ * &lt;li&gt;&lt;code&gt;null -&gt; ERROR&lt;/code&gt; : Occurs when the initial sync failed first time.</span>
<a href="#l11.2936"></a><span id="l11.2936" class="difflineplus">+ * &lt;li&gt;&lt;code&gt;ERROR -&gt; PREPARED&lt;/code&gt; : Occurs when the initial sync succeeds</span>
<a href="#l11.2937"></a><span id="l11.2937" class="difflineplus">+ * after previously failing.</span>
<a href="#l11.2938"></a><span id="l11.2938" class="difflineplus">+ * &lt;li&gt;&lt;code&gt;PREPARED -&gt; SYNCING&lt;/code&gt; : Occurs immediately after transitioning</span>
<a href="#l11.2939"></a><span id="l11.2939" class="difflineplus">+ * to PREPARED. Starts listening for live updates rather than catching up.</span>
<a href="#l11.2940"></a><span id="l11.2940" class="difflineplus">+ * &lt;li&gt;&lt;code&gt;SYNCING -&gt; ERROR&lt;/code&gt; : Occurs the first time a client cannot perform a</span>
<a href="#l11.2941"></a><span id="l11.2941" class="difflineplus">+ * live update.</span>
<a href="#l11.2942"></a><span id="l11.2942" class="difflineplus">+ * &lt;li&gt;&lt;code&gt;ERROR -&gt; SYNCING&lt;/code&gt; : Occurs when the client has performed a</span>
<a href="#l11.2943"></a><span id="l11.2943" class="difflineplus">+ * live update after having previously failed.</span>
<a href="#l11.2944"></a><span id="l11.2944" class="difflineplus">+ * &lt;li&gt;&lt;code&gt;ERROR -&gt; ERROR&lt;/code&gt; : Occurs when the client has failed to sync</span>
<a href="#l11.2945"></a><span id="l11.2945" class="difflineplus">+ * for a second time or more.&lt;/li&gt;</span>
<a href="#l11.2946"></a><span id="l11.2946" class="difflineplus">+ * &lt;li&gt;&lt;code&gt;SYNCING -&gt; SYNCING&lt;/code&gt; : Occurs when the client has performed a live</span>
<a href="#l11.2947"></a><span id="l11.2947" class="difflineplus">+ * update. This is called &lt;i&gt;after&lt;/i&gt; processing.&lt;/li&gt;</span>
<a href="#l11.2948"></a><span id="l11.2948" class="difflineplus">+ * &lt;li&gt;&lt;code&gt;* -&gt; STOPPED&lt;/code&gt; : Occurs once the client has stopped syncing or</span>
<a href="#l11.2949"></a><span id="l11.2949" class="difflineplus">+ * trying to sync after stopClient has been called.&lt;/li&gt;</span>
<a href="#l11.2950"></a><span id="l11.2950" class="difflineplus">+ * &lt;/ul&gt;</span>
<a href="#l11.2951"></a><span id="l11.2951" class="difflineplus">+ *</span>
<a href="#l11.2952"></a><span id="l11.2952" class="difflineplus">+ * @event module:client~MatrixClient#&quot;sync&quot;</span>
<a href="#l11.2953"></a><span id="l11.2953" class="difflineplus">+ * @param {string} state An enum representing the syncing state. One of &quot;PREPARED&quot;,</span>
<a href="#l11.2954"></a><span id="l11.2954" class="difflineplus">+ * &quot;SYNCING&quot;, &quot;ERROR&quot;, &quot;STOPPED&quot;.</span>
<a href="#l11.2955"></a><span id="l11.2955" class="difflineplus">+ * @param {?string} prevState An enum representing the previous syncing state.</span>
<a href="#l11.2956"></a><span id="l11.2956" class="difflineplus">+ * One of &quot;PREPARED&quot;, &quot;SYNCING&quot;, &quot;ERROR&quot;, &quot;STOPPED&quot; &lt;b&gt;or null&lt;/b&gt;.</span>
<a href="#l11.2957"></a><span id="l11.2957" class="difflineplus">+ * @param {?Object} data Data about this transition.</span>
<a href="#l11.2958"></a><span id="l11.2958" class="difflineplus">+ * @param {MatrixError} data.err The matrix error if &lt;code&gt;state=ERROR&lt;/code&gt;.</span>
<a href="#l11.2959"></a><span id="l11.2959" class="difflineplus">+ * @example</span>
<a href="#l11.2960"></a><span id="l11.2960" class="difflineplus">+ * matrixClient.on(&quot;sync&quot;, function(state, prevState, data) {</span>
<a href="#l11.2961"></a><span id="l11.2961" class="difflineplus">+ *   switch (state) {</span>
<a href="#l11.2962"></a><span id="l11.2962" class="difflineplus">+ *     case &quot;ERROR&quot;:</span>
<a href="#l11.2963"></a><span id="l11.2963" class="difflineplus">+ *       // update UI to say &quot;Connection Lost&quot;</span>
<a href="#l11.2964"></a><span id="l11.2964" class="difflineplus">+ *       break;</span>
<a href="#l11.2965"></a><span id="l11.2965" class="difflineplus">+ *     case &quot;SYNCING&quot;:</span>
<a href="#l11.2966"></a><span id="l11.2966" class="difflineplus">+ *       // update UI to remove any &quot;Connection Lost&quot; message</span>
<a href="#l11.2967"></a><span id="l11.2967" class="difflineplus">+ *       break;</span>
<a href="#l11.2968"></a><span id="l11.2968" class="difflineplus">+ *     case &quot;PREPARED&quot;:</span>
<a href="#l11.2969"></a><span id="l11.2969" class="difflineplus">+ *       // the client instance is ready to be queried.</span>
<a href="#l11.2970"></a><span id="l11.2970" class="difflineplus">+ *       var rooms = matrixClient.getRooms();</span>
<a href="#l11.2971"></a><span id="l11.2971" class="difflineplus">+ *       break;</span>
<a href="#l11.2972"></a><span id="l11.2972" class="difflineplus">+ *   }</span>
<a href="#l11.2973"></a><span id="l11.2973" class="difflineplus">+ * });</span>
<a href="#l11.2974"></a><span id="l11.2974" class="difflineplus">+ */</span>
<a href="#l11.2975"></a><span id="l11.2975" class="difflineplus">+</span>
<a href="#l11.2976"></a><span id="l11.2976" class="difflineplus">+ /**</span>
<a href="#l11.2977"></a><span id="l11.2977" class="difflineplus">+ * Fires whenever a new Room is added. This will fire when you are invited to a</span>
<a href="#l11.2978"></a><span id="l11.2978" class="difflineplus">+ * room, as well as when you join a room. &lt;strong&gt;This event is experimental and</span>
<a href="#l11.2979"></a><span id="l11.2979" class="difflineplus">+ * may change.&lt;/strong&gt;</span>
<a href="#l11.2980"></a><span id="l11.2980" class="difflineplus">+ * @event module:client~MatrixClient#&quot;Room&quot;</span>
<a href="#l11.2981"></a><span id="l11.2981" class="difflineplus">+ * @param {Room} room The newly created, fully populated room.</span>
<a href="#l11.2982"></a><span id="l11.2982" class="difflineplus">+ * @example</span>
<a href="#l11.2983"></a><span id="l11.2983" class="difflineplus">+ * matrixClient.on(&quot;Room&quot;, function(room){</span>
<a href="#l11.2984"></a><span id="l11.2984" class="difflineplus">+ *   var roomId = room.roomId;</span>
<a href="#l11.2985"></a><span id="l11.2985" class="difflineplus">+ * });</span>
<a href="#l11.2986"></a><span id="l11.2986" class="difflineplus">+ */</span>
<a href="#l11.2987"></a><span id="l11.2987" class="difflineplus">+</span>
<a href="#l11.2988"></a><span id="l11.2988" class="difflineplus">+ /**</span>
<a href="#l11.2989"></a><span id="l11.2989" class="difflineplus">+ * Fires whenever a Room is removed. This will fire when you forget a room.</span>
<a href="#l11.2990"></a><span id="l11.2990" class="difflineplus">+ * &lt;strong&gt;This event is experimental and may change.&lt;/strong&gt;</span>
<a href="#l11.2991"></a><span id="l11.2991" class="difflineplus">+ * @event module:client~MatrixClient#&quot;deleteRoom&quot;</span>
<a href="#l11.2992"></a><span id="l11.2992" class="difflineplus">+ * @param {string} roomId The deleted room ID.</span>
<a href="#l11.2993"></a><span id="l11.2993" class="difflineplus">+ * @example</span>
<a href="#l11.2994"></a><span id="l11.2994" class="difflineplus">+ * matrixClient.on(&quot;deleteRoom&quot;, function(roomId){</span>
<a href="#l11.2995"></a><span id="l11.2995" class="difflineplus">+ *   // update UI from getRooms()</span>
<a href="#l11.2996"></a><span id="l11.2996" class="difflineplus">+ * });</span>
<a href="#l11.2997"></a><span id="l11.2997" class="difflineplus">+ */</span>
<a href="#l11.2998"></a><span id="l11.2998" class="difflineplus">+</span>
<a href="#l11.2999"></a><span id="l11.2999" class="difflineplus">+/**</span>
<a href="#l11.3000"></a><span id="l11.3000" class="difflineplus">+ * Fires whenever an incoming call arrives.</span>
<a href="#l11.3001"></a><span id="l11.3001" class="difflineplus">+ * @event module:client~MatrixClient#&quot;Call.incoming&quot;</span>
<a href="#l11.3002"></a><span id="l11.3002" class="difflineplus">+ * @param {module:webrtc/call~MatrixCall} call The incoming call.</span>
<a href="#l11.3003"></a><span id="l11.3003" class="difflineplus">+ * @example</span>
<a href="#l11.3004"></a><span id="l11.3004" class="difflineplus">+ * matrixClient.on(&quot;Call.incoming&quot;, function(call){</span>
<a href="#l11.3005"></a><span id="l11.3005" class="difflineplus">+ *   call.answer(); // auto-answer</span>
<a href="#l11.3006"></a><span id="l11.3006" class="difflineplus">+ * });</span>
<a href="#l11.3007"></a><span id="l11.3007" class="difflineplus">+ */</span>
<a href="#l11.3008"></a><span id="l11.3008" class="difflineplus">+</span>
<a href="#l11.3009"></a><span id="l11.3009" class="difflineplus">+/**</span>
<a href="#l11.3010"></a><span id="l11.3010" class="difflineplus">+ * Fires whenever the login session the JS SDK is using is no</span>
<a href="#l11.3011"></a><span id="l11.3011" class="difflineplus">+ * longer valid and the user must log in again.</span>
<a href="#l11.3012"></a><span id="l11.3012" class="difflineplus">+ * NB. This only fires when action is required from the user, not</span>
<a href="#l11.3013"></a><span id="l11.3013" class="difflineplus">+ * when then login session can be renewed by using a refresh token.</span>
<a href="#l11.3014"></a><span id="l11.3014" class="difflineplus">+ * @event module:client~MatrixClient#&quot;Session.logged_out&quot;</span>
<a href="#l11.3015"></a><span id="l11.3015" class="difflineplus">+ * @example</span>
<a href="#l11.3016"></a><span id="l11.3016" class="difflineplus">+ * matrixClient.on(&quot;Session.logged_out&quot;, function(call){</span>
<a href="#l11.3017"></a><span id="l11.3017" class="difflineplus">+ *   // show the login screen</span>
<a href="#l11.3018"></a><span id="l11.3018" class="difflineplus">+ * });</span>
<a href="#l11.3019"></a><span id="l11.3019" class="difflineplus">+ */</span>
<a href="#l11.3020"></a><span id="l11.3020" class="difflineplus">+</span>
<a href="#l11.3021"></a><span id="l11.3021" class="difflineplus">+/**</span>
<a href="#l11.3022"></a><span id="l11.3022" class="difflineplus">+ * Fires when a device is marked as verified/unverified/blocked/unblocked by</span>
<a href="#l11.3023"></a><span id="l11.3023" class="difflineplus">+ * {@link module:client~MatrixClient#setDeviceVerified|MatrixClient.setDeviceVerified} or</span>
<a href="#l11.3024"></a><span id="l11.3024" class="difflineplus">+ * {@link module:client~MatrixClient#setDeviceBlocked|MatrixClient.setDeviceBlocked}.</span>
<a href="#l11.3025"></a><span id="l11.3025" class="difflineplus">+ *</span>
<a href="#l11.3026"></a><span id="l11.3026" class="difflineplus">+ * @event module:client~MatrixClient#&quot;deviceVerificationChanged&quot;</span>
<a href="#l11.3027"></a><span id="l11.3027" class="difflineplus">+ * @param {string} userId the owner of the verified device</span>
<a href="#l11.3028"></a><span id="l11.3028" class="difflineplus">+ * @param {string} deviceId the id of the verified device</span>
<a href="#l11.3029"></a><span id="l11.3029" class="difflineplus">+ */</span>
<a href="#l11.3030"></a><span id="l11.3030" class="difflineplus">+</span>
<a href="#l11.3031"></a><span id="l11.3031" class="difflineplus">+/**</span>
<a href="#l11.3032"></a><span id="l11.3032" class="difflineplus">+ * Fires whenever new user-scoped account_data is added.</span>
<a href="#l11.3033"></a><span id="l11.3033" class="difflineplus">+ * @event module:client~MatrixClient#&quot;Room&quot;</span>
<a href="#l11.3034"></a><span id="l11.3034" class="difflineplus">+ * @param {MatrixEvent} event The event describing the account_data just added</span>
<a href="#l11.3035"></a><span id="l11.3035" class="difflineplus">+ * @example</span>
<a href="#l11.3036"></a><span id="l11.3036" class="difflineplus">+ * matrixClient.on(&quot;accountData&quot;, function(event){</span>
<a href="#l11.3037"></a><span id="l11.3037" class="difflineplus">+ *   myAccountData[event.type] = event.content;</span>
<a href="#l11.3038"></a><span id="l11.3038" class="difflineplus">+ * });</span>
<a href="#l11.3039"></a><span id="l11.3039" class="difflineplus">+ */</span>
<a href="#l11.3040"></a><span id="l11.3040" class="difflineplus">+</span>
<a href="#l11.3041"></a><span id="l11.3041" class="difflineplus">+</span>
<a href="#l11.3042"></a><span id="l11.3042" class="difflineplus">+// EventEmitter JSDocs</span>
<a href="#l11.3043"></a><span id="l11.3043" class="difflineplus">+</span>
<a href="#l11.3044"></a><span id="l11.3044" class="difflineplus">+/**</span>
<a href="#l11.3045"></a><span id="l11.3045" class="difflineplus">+ * The {@link https://nodejs.org/api/events.html|EventEmitter} class.</span>
<a href="#l11.3046"></a><span id="l11.3046" class="difflineplus">+ * @external EventEmitter</span>
<a href="#l11.3047"></a><span id="l11.3047" class="difflineplus">+ * @see {@link https://nodejs.org/api/events.html}</span>
<a href="#l11.3048"></a><span id="l11.3048" class="difflineplus">+ */</span>
<a href="#l11.3049"></a><span id="l11.3049" class="difflineplus">+</span>
<a href="#l11.3050"></a><span id="l11.3050" class="difflineplus">+/**</span>
<a href="#l11.3051"></a><span id="l11.3051" class="difflineplus">+ * Adds a listener to the end of the listeners array for the specified event.</span>
<a href="#l11.3052"></a><span id="l11.3052" class="difflineplus">+ * No checks are made to see if the listener has already been added. Multiple</span>
<a href="#l11.3053"></a><span id="l11.3053" class="difflineplus">+ * calls passing the same combination of event and listener will result in the</span>
<a href="#l11.3054"></a><span id="l11.3054" class="difflineplus">+ * listener being added multiple times.</span>
<a href="#l11.3055"></a><span id="l11.3055" class="difflineplus">+ * @function external:EventEmitter#on</span>
<a href="#l11.3056"></a><span id="l11.3056" class="difflineplus">+ * @param {string} event The event to listen for.</span>
<a href="#l11.3057"></a><span id="l11.3057" class="difflineplus">+ * @param {Function} listener The function to invoke.</span>
<a href="#l11.3058"></a><span id="l11.3058" class="difflineplus">+ * @return {EventEmitter} for call chaining.</span>
<a href="#l11.3059"></a><span id="l11.3059" class="difflineplus">+ */</span>
<a href="#l11.3060"></a><span id="l11.3060" class="difflineplus">+</span>
<a href="#l11.3061"></a><span id="l11.3061" class="difflineplus">+/**</span>
<a href="#l11.3062"></a><span id="l11.3062" class="difflineplus">+ * Alias for {@link external:EventEmitter#on}.</span>
<a href="#l11.3063"></a><span id="l11.3063" class="difflineplus">+ * @function external:EventEmitter#addListener</span>
<a href="#l11.3064"></a><span id="l11.3064" class="difflineplus">+ * @param {string} event The event to listen for.</span>
<a href="#l11.3065"></a><span id="l11.3065" class="difflineplus">+ * @param {Function} listener The function to invoke.</span>
<a href="#l11.3066"></a><span id="l11.3066" class="difflineplus">+ * @return {EventEmitter} for call chaining.</span>
<a href="#l11.3067"></a><span id="l11.3067" class="difflineplus">+ */</span>
<a href="#l11.3068"></a><span id="l11.3068" class="difflineplus">+</span>
<a href="#l11.3069"></a><span id="l11.3069" class="difflineplus">+/**</span>
<a href="#l11.3070"></a><span id="l11.3070" class="difflineplus">+ * Adds a &lt;b&gt;one time&lt;/b&gt; listener for the event. This listener is invoked only</span>
<a href="#l11.3071"></a><span id="l11.3071" class="difflineplus">+ * the next time the event is fired, after which it is removed.</span>
<a href="#l11.3072"></a><span id="l11.3072" class="difflineplus">+ * @function external:EventEmitter#once</span>
<a href="#l11.3073"></a><span id="l11.3073" class="difflineplus">+ * @param {string} event The event to listen for.</span>
<a href="#l11.3074"></a><span id="l11.3074" class="difflineplus">+ * @param {Function} listener The function to invoke.</span>
<a href="#l11.3075"></a><span id="l11.3075" class="difflineplus">+ * @return {EventEmitter} for call chaining.</span>
<a href="#l11.3076"></a><span id="l11.3076" class="difflineplus">+ */</span>
<a href="#l11.3077"></a><span id="l11.3077" class="difflineplus">+</span>
<a href="#l11.3078"></a><span id="l11.3078" class="difflineplus">+/**</span>
<a href="#l11.3079"></a><span id="l11.3079" class="difflineplus">+ * Remove a listener from the listener array for the specified event.</span>
<a href="#l11.3080"></a><span id="l11.3080" class="difflineplus">+ * &lt;b&gt;Caution:&lt;/b&gt; changes array indices in the listener array behind the</span>
<a href="#l11.3081"></a><span id="l11.3081" class="difflineplus">+ * listener.</span>
<a href="#l11.3082"></a><span id="l11.3082" class="difflineplus">+ * @function external:EventEmitter#removeListener</span>
<a href="#l11.3083"></a><span id="l11.3083" class="difflineplus">+ * @param {string} event The event to listen for.</span>
<a href="#l11.3084"></a><span id="l11.3084" class="difflineplus">+ * @param {Function} listener The function to invoke.</span>
<a href="#l11.3085"></a><span id="l11.3085" class="difflineplus">+ * @return {EventEmitter} for call chaining.</span>
<a href="#l11.3086"></a><span id="l11.3086" class="difflineplus">+ */</span>
<a href="#l11.3087"></a><span id="l11.3087" class="difflineplus">+</span>
<a href="#l11.3088"></a><span id="l11.3088" class="difflineplus">+/**</span>
<a href="#l11.3089"></a><span id="l11.3089" class="difflineplus">+ * Removes all listeners, or those of the specified event. It's not a good idea</span>
<a href="#l11.3090"></a><span id="l11.3090" class="difflineplus">+ * to remove listeners that were added elsewhere in the code, especially when</span>
<a href="#l11.3091"></a><span id="l11.3091" class="difflineplus">+ * it's on an emitter that you didn't create (e.g. sockets or file streams).</span>
<a href="#l11.3092"></a><span id="l11.3092" class="difflineplus">+ * @function external:EventEmitter#removeAllListeners</span>
<a href="#l11.3093"></a><span id="l11.3093" class="difflineplus">+ * @param {string} event Optional. The event to remove listeners for.</span>
<a href="#l11.3094"></a><span id="l11.3094" class="difflineplus">+ * @return {EventEmitter} for call chaining.</span>
<a href="#l11.3095"></a><span id="l11.3095" class="difflineplus">+ */</span>
<a href="#l11.3096"></a><span id="l11.3096" class="difflineplus">+</span>
<a href="#l11.3097"></a><span id="l11.3097" class="difflineplus">+/**</span>
<a href="#l11.3098"></a><span id="l11.3098" class="difflineplus">+ * Execute each of the listeners in order with the supplied arguments.</span>
<a href="#l11.3099"></a><span id="l11.3099" class="difflineplus">+ * @function external:EventEmitter#emit</span>
<a href="#l11.3100"></a><span id="l11.3100" class="difflineplus">+ * @param {string} event The event to emit.</span>
<a href="#l11.3101"></a><span id="l11.3101" class="difflineplus">+ * @param {Function} listener The function to invoke.</span>
<a href="#l11.3102"></a><span id="l11.3102" class="difflineplus">+ * @return {boolean} true if event had listeners, false otherwise.</span>
<a href="#l11.3103"></a><span id="l11.3103" class="difflineplus">+ */</span>
<a href="#l11.3104"></a><span id="l11.3104" class="difflineplus">+</span>
<a href="#l11.3105"></a><span id="l11.3105" class="difflineplus">+/**</span>
<a href="#l11.3106"></a><span id="l11.3106" class="difflineplus">+ * By default EventEmitters will print a warning if more than 10 listeners are</span>
<a href="#l11.3107"></a><span id="l11.3107" class="difflineplus">+ * added for a particular event. This is a useful default which helps finding</span>
<a href="#l11.3108"></a><span id="l11.3108" class="difflineplus">+ * memory leaks. Obviously not all Emitters should be limited to 10. This</span>
<a href="#l11.3109"></a><span id="l11.3109" class="difflineplus">+ * function allows that to be increased. Set to zero for unlimited.</span>
<a href="#l11.3110"></a><span id="l11.3110" class="difflineplus">+ * @function external:EventEmitter#setMaxListeners</span>
<a href="#l11.3111"></a><span id="l11.3111" class="difflineplus">+ * @param {Number} n The max number of listeners.</span>
<a href="#l11.3112"></a><span id="l11.3112" class="difflineplus">+ * @return {EventEmitter} for call chaining.</span>
<a href="#l11.3113"></a><span id="l11.3113" class="difflineplus">+ */</span>
<a href="#l11.3114"></a><span id="l11.3114" class="difflineplus">+</span>
<a href="#l11.3115"></a><span id="l11.3115" class="difflineplus">+// MatrixClient Callback JSDocs</span>
<a href="#l11.3116"></a><span id="l11.3116" class="difflineplus">+</span>
<a href="#l11.3117"></a><span id="l11.3117" class="difflineplus">+/**</span>
<a href="#l11.3118"></a><span id="l11.3118" class="difflineplus">+ * The standard MatrixClient callback interface. Functions which accept this</span>
<a href="#l11.3119"></a><span id="l11.3119" class="difflineplus">+ * will specify 2 return arguments. These arguments map to the 2 parameters</span>
<a href="#l11.3120"></a><span id="l11.3120" class="difflineplus">+ * specified in this callback.</span>
<a href="#l11.3121"></a><span id="l11.3121" class="difflineplus">+ * @callback module:client.callback</span>
<a href="#l11.3122"></a><span id="l11.3122" class="difflineplus">+ * @param {Object} err The error value, the &quot;rejected&quot; value or null.</span>
<a href="#l11.3123"></a><span id="l11.3123" class="difflineplus">+ * @param {Object} data The data returned, the &quot;resolved&quot; value.</span>
<a href="#l11.3124"></a><span id="l11.3124" class="difflineplus">+ */</span>
<a href="#l11.3125"></a><span id="l11.3125" class="difflineplus">+</span>
<a href="#l11.3126"></a><span id="l11.3126" class="difflineplus">+ /**</span>
<a href="#l11.3127"></a><span id="l11.3127" class="difflineplus">+  * {@link https://github.com/kriskowal/q|A promise implementation (Q)}. Functions</span>
<a href="#l11.3128"></a><span id="l11.3128" class="difflineplus">+  * which return this will specify 2 return arguments. These arguments map to the</span>
<a href="#l11.3129"></a><span id="l11.3129" class="difflineplus">+  * &quot;onFulfilled&quot; and &quot;onRejected&quot; values of the Promise.</span>
<a href="#l11.3130"></a><span id="l11.3130" class="difflineplus">+  * @typedef {Object} Promise</span>
<a href="#l11.3131"></a><span id="l11.3131" class="difflineplus">+  * @static</span>
<a href="#l11.3132"></a><span id="l11.3132" class="difflineplus">+  * @property {Function} then promise.then(onFulfilled, onRejected, onProgress)</span>
<a href="#l11.3133"></a><span id="l11.3133" class="difflineplus">+  * @property {Function} catch promise.catch(onRejected)</span>
<a href="#l11.3134"></a><span id="l11.3134" class="difflineplus">+  * @property {Function} finally promise.finally(callback)</span>
<a href="#l11.3135"></a><span id="l11.3135" class="difflineplus">+  * @property {Function} done promise.done(onFulfilled, onRejected, onProgress)</span>
<a href="#l11.3136"></a><span id="l11.3136" class="difflineplus">+  */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1">new file mode 100644</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineminus">--- /dev/null</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineplus">+++ b/chat/protocols/matrix/matrix-sdk/content-repo.js</span>
<a href="#l12.4"></a><span id="l12.4" class="difflineat">@@ -0,0 +1,105 @@</span>
<a href="#l12.5"></a><span id="l12.5" class="difflineplus">+/*</span>
<a href="#l12.6"></a><span id="l12.6" class="difflineplus">+Copyright 2015, 2016 OpenMarket Ltd</span>
<a href="#l12.7"></a><span id="l12.7" class="difflineplus">+</span>
<a href="#l12.8"></a><span id="l12.8" class="difflineplus">+Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<a href="#l12.9"></a><span id="l12.9" class="difflineplus">+you may not use this file except in compliance with the License.</span>
<a href="#l12.10"></a><span id="l12.10" class="difflineplus">+You may obtain a copy of the License at</span>
<a href="#l12.11"></a><span id="l12.11" class="difflineplus">+</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineplus">+    http://www.apache.org/licenses/LICENSE-2.0</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineplus">+Unless required by applicable law or agreed to in writing, software</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineplus">+distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<a href="#l12.16"></a><span id="l12.16" class="difflineplus">+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<a href="#l12.17"></a><span id="l12.17" class="difflineplus">+See the License for the specific language governing permissions and</span>
<a href="#l12.18"></a><span id="l12.18" class="difflineplus">+limitations under the License.</span>
<a href="#l12.19"></a><span id="l12.19" class="difflineplus">+*/</span>
<a href="#l12.20"></a><span id="l12.20" class="difflineplus">+/**</span>
<a href="#l12.21"></a><span id="l12.21" class="difflineplus">+ * @module content-repo</span>
<a href="#l12.22"></a><span id="l12.22" class="difflineplus">+ */</span>
<a href="#l12.23"></a><span id="l12.23" class="difflineplus">+var utils = require(&quot;./utils&quot;);</span>
<a href="#l12.24"></a><span id="l12.24" class="difflineplus">+</span>
<a href="#l12.25"></a><span id="l12.25" class="difflineplus">+/** Content Repo utility functions */</span>
<a href="#l12.26"></a><span id="l12.26" class="difflineplus">+module.exports = {</span>
<a href="#l12.27"></a><span id="l12.27" class="difflineplus">+    /**</span>
<a href="#l12.28"></a><span id="l12.28" class="difflineplus">+     * Get the HTTP URL for an MXC URI.</span>
<a href="#l12.29"></a><span id="l12.29" class="difflineplus">+     * @param {string} baseUrl The base homeserver url which has a content repo.</span>
<a href="#l12.30"></a><span id="l12.30" class="difflineplus">+     * @param {string} mxc The mxc:// URI.</span>
<a href="#l12.31"></a><span id="l12.31" class="difflineplus">+     * @param {Number} width The desired width of the thumbnail.</span>
<a href="#l12.32"></a><span id="l12.32" class="difflineplus">+     * @param {Number} height The desired height of the thumbnail.</span>
<a href="#l12.33"></a><span id="l12.33" class="difflineplus">+     * @param {string} resizeMethod The thumbnail resize method to use, either</span>
<a href="#l12.34"></a><span id="l12.34" class="difflineplus">+     * &quot;crop&quot; or &quot;scale&quot;.</span>
<a href="#l12.35"></a><span id="l12.35" class="difflineplus">+     * @param {Boolean} allowDirectLinks If true, return any non-mxc URLs</span>
<a href="#l12.36"></a><span id="l12.36" class="difflineplus">+     * directly. Fetching such URLs will leak information about the user to</span>
<a href="#l12.37"></a><span id="l12.37" class="difflineplus">+     * anyone they share a room with. If false, will return the emptry string</span>
<a href="#l12.38"></a><span id="l12.38" class="difflineplus">+     * for such URLs.</span>
<a href="#l12.39"></a><span id="l12.39" class="difflineplus">+     * @return {string} The complete URL to the content.</span>
<a href="#l12.40"></a><span id="l12.40" class="difflineplus">+     */</span>
<a href="#l12.41"></a><span id="l12.41" class="difflineplus">+    getHttpUriForMxc: function(baseUrl, mxc, width, height,</span>
<a href="#l12.42"></a><span id="l12.42" class="difflineplus">+                               resizeMethod, allowDirectLinks) {</span>
<a href="#l12.43"></a><span id="l12.43" class="difflineplus">+        if (typeof mxc !== &quot;string&quot; || !mxc) {</span>
<a href="#l12.44"></a><span id="l12.44" class="difflineplus">+            return '';</span>
<a href="#l12.45"></a><span id="l12.45" class="difflineplus">+        }</span>
<a href="#l12.46"></a><span id="l12.46" class="difflineplus">+        if (mxc.indexOf(&quot;mxc://&quot;) !== 0) {</span>
<a href="#l12.47"></a><span id="l12.47" class="difflineplus">+            if (allowDirectLinks) {</span>
<a href="#l12.48"></a><span id="l12.48" class="difflineplus">+                return mxc;</span>
<a href="#l12.49"></a><span id="l12.49" class="difflineplus">+            } else {</span>
<a href="#l12.50"></a><span id="l12.50" class="difflineplus">+                return '';</span>
<a href="#l12.51"></a><span id="l12.51" class="difflineplus">+            }</span>
<a href="#l12.52"></a><span id="l12.52" class="difflineplus">+        }</span>
<a href="#l12.53"></a><span id="l12.53" class="difflineplus">+        var serverAndMediaId = mxc.slice(6); // strips mxc://</span>
<a href="#l12.54"></a><span id="l12.54" class="difflineplus">+        var prefix = &quot;/_matrix/media/v1/download/&quot;;</span>
<a href="#l12.55"></a><span id="l12.55" class="difflineplus">+        var params = {};</span>
<a href="#l12.56"></a><span id="l12.56" class="difflineplus">+</span>
<a href="#l12.57"></a><span id="l12.57" class="difflineplus">+        if (width) {</span>
<a href="#l12.58"></a><span id="l12.58" class="difflineplus">+            params.width = width;</span>
<a href="#l12.59"></a><span id="l12.59" class="difflineplus">+        }</span>
<a href="#l12.60"></a><span id="l12.60" class="difflineplus">+        if (height) {</span>
<a href="#l12.61"></a><span id="l12.61" class="difflineplus">+            params.height = height;</span>
<a href="#l12.62"></a><span id="l12.62" class="difflineplus">+        }</span>
<a href="#l12.63"></a><span id="l12.63" class="difflineplus">+        if (resizeMethod) {</span>
<a href="#l12.64"></a><span id="l12.64" class="difflineplus">+            params.method = resizeMethod;</span>
<a href="#l12.65"></a><span id="l12.65" class="difflineplus">+        }</span>
<a href="#l12.66"></a><span id="l12.66" class="difflineplus">+        if (utils.keys(params).length &gt; 0) {</span>
<a href="#l12.67"></a><span id="l12.67" class="difflineplus">+            // these are thumbnailing params so they probably want the</span>
<a href="#l12.68"></a><span id="l12.68" class="difflineplus">+            // thumbnailing API...</span>
<a href="#l12.69"></a><span id="l12.69" class="difflineplus">+            prefix = &quot;/_matrix/media/v1/thumbnail/&quot;;</span>
<a href="#l12.70"></a><span id="l12.70" class="difflineplus">+        }</span>
<a href="#l12.71"></a><span id="l12.71" class="difflineplus">+</span>
<a href="#l12.72"></a><span id="l12.72" class="difflineplus">+        var fragmentOffset = serverAndMediaId.indexOf(&quot;#&quot;),</span>
<a href="#l12.73"></a><span id="l12.73" class="difflineplus">+            fragment = &quot;&quot;;</span>
<a href="#l12.74"></a><span id="l12.74" class="difflineplus">+        if (fragmentOffset &gt;= 0) {</span>
<a href="#l12.75"></a><span id="l12.75" class="difflineplus">+            fragment = serverAndMediaId.substr(fragmentOffset);</span>
<a href="#l12.76"></a><span id="l12.76" class="difflineplus">+            serverAndMediaId = serverAndMediaId.substr(0, fragmentOffset);</span>
<a href="#l12.77"></a><span id="l12.77" class="difflineplus">+        }</span>
<a href="#l12.78"></a><span id="l12.78" class="difflineplus">+        return baseUrl + prefix + serverAndMediaId +</span>
<a href="#l12.79"></a><span id="l12.79" class="difflineplus">+            (utils.keys(params).length === 0 ? &quot;&quot; :</span>
<a href="#l12.80"></a><span id="l12.80" class="difflineplus">+            (&quot;?&quot; + utils.encodeParams(params))) + fragment;</span>
<a href="#l12.81"></a><span id="l12.81" class="difflineplus">+    },</span>
<a href="#l12.82"></a><span id="l12.82" class="difflineplus">+</span>
<a href="#l12.83"></a><span id="l12.83" class="difflineplus">+    /**</span>
<a href="#l12.84"></a><span id="l12.84" class="difflineplus">+     * Get an identicon URL from an arbitrary string.</span>
<a href="#l12.85"></a><span id="l12.85" class="difflineplus">+     * @param {string} baseUrl The base homeserver url which has a content repo.</span>
<a href="#l12.86"></a><span id="l12.86" class="difflineplus">+     * @param {string} identiconString The string to create an identicon for.</span>
<a href="#l12.87"></a><span id="l12.87" class="difflineplus">+     * @param {Number} width The desired width of the image in pixels. Default: 96.</span>
<a href="#l12.88"></a><span id="l12.88" class="difflineplus">+     * @param {Number} height The desired height of the image in pixels. Default: 96.</span>
<a href="#l12.89"></a><span id="l12.89" class="difflineplus">+     * @return {string} The complete URL to the identicon.</span>
<a href="#l12.90"></a><span id="l12.90" class="difflineplus">+     */</span>
<a href="#l12.91"></a><span id="l12.91" class="difflineplus">+    getIdenticonUri: function(baseUrl, identiconString, width, height) {</span>
<a href="#l12.92"></a><span id="l12.92" class="difflineplus">+        if (!identiconString) {</span>
<a href="#l12.93"></a><span id="l12.93" class="difflineplus">+            return null;</span>
<a href="#l12.94"></a><span id="l12.94" class="difflineplus">+        }</span>
<a href="#l12.95"></a><span id="l12.95" class="difflineplus">+        if (!width) { width = 96; }</span>
<a href="#l12.96"></a><span id="l12.96" class="difflineplus">+        if (!height) { height = 96; }</span>
<a href="#l12.97"></a><span id="l12.97" class="difflineplus">+        var params = {</span>
<a href="#l12.98"></a><span id="l12.98" class="difflineplus">+            width: width,</span>
<a href="#l12.99"></a><span id="l12.99" class="difflineplus">+            height: height</span>
<a href="#l12.100"></a><span id="l12.100" class="difflineplus">+        };</span>
<a href="#l12.101"></a><span id="l12.101" class="difflineplus">+</span>
<a href="#l12.102"></a><span id="l12.102" class="difflineplus">+        var path = utils.encodeUri(&quot;/_matrix/media/v1/identicon/$ident&quot;, {</span>
<a href="#l12.103"></a><span id="l12.103" class="difflineplus">+            $ident: identiconString</span>
<a href="#l12.104"></a><span id="l12.104" class="difflineplus">+        });</span>
<a href="#l12.105"></a><span id="l12.105" class="difflineplus">+        return baseUrl + path +</span>
<a href="#l12.106"></a><span id="l12.106" class="difflineplus">+            (utils.keys(params).length === 0 ? &quot;&quot; :</span>
<a href="#l12.107"></a><span id="l12.107" class="difflineplus">+                (&quot;?&quot; + utils.encodeParams(params)));</span>
<a href="#l12.108"></a><span id="l12.108" class="difflineplus">+    }</span>
<a href="#l12.109"></a><span id="l12.109" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1">new file mode 100644</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineminus">--- /dev/null</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineplus">+++ b/chat/protocols/matrix/matrix-sdk/crypto/OlmDevice.js</span>
<a href="#l13.4"></a><span id="l13.4" class="difflineat">@@ -0,0 +1,744 @@</span>
<a href="#l13.5"></a><span id="l13.5" class="difflineplus">+/*</span>
<a href="#l13.6"></a><span id="l13.6" class="difflineplus">+Copyright 2016 OpenMarket Ltd</span>
<a href="#l13.7"></a><span id="l13.7" class="difflineplus">+</span>
<a href="#l13.8"></a><span id="l13.8" class="difflineplus">+Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<a href="#l13.9"></a><span id="l13.9" class="difflineplus">+you may not use this file except in compliance with the License.</span>
<a href="#l13.10"></a><span id="l13.10" class="difflineplus">+You may obtain a copy of the License at</span>
<a href="#l13.11"></a><span id="l13.11" class="difflineplus">+</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineplus">+    http://www.apache.org/licenses/LICENSE-2.0</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineplus">+Unless required by applicable law or agreed to in writing, software</span>
<a href="#l13.15"></a><span id="l13.15" class="difflineplus">+distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<a href="#l13.16"></a><span id="l13.16" class="difflineplus">+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<a href="#l13.17"></a><span id="l13.17" class="difflineplus">+See the License for the specific language governing permissions and</span>
<a href="#l13.18"></a><span id="l13.18" class="difflineplus">+limitations under the License.</span>
<a href="#l13.19"></a><span id="l13.19" class="difflineplus">+*/</span>
<a href="#l13.20"></a><span id="l13.20" class="difflineplus">+&quot;use strict&quot;;</span>
<a href="#l13.21"></a><span id="l13.21" class="difflineplus">+</span>
<a href="#l13.22"></a><span id="l13.22" class="difflineplus">+/**</span>
<a href="#l13.23"></a><span id="l13.23" class="difflineplus">+ * olm.js wrapper</span>
<a href="#l13.24"></a><span id="l13.24" class="difflineplus">+ *</span>
<a href="#l13.25"></a><span id="l13.25" class="difflineplus">+ * @module crypto/OlmDevice</span>
<a href="#l13.26"></a><span id="l13.26" class="difflineplus">+ */</span>
<a href="#l13.27"></a><span id="l13.27" class="difflineplus">+</span>
<a href="#l13.28"></a><span id="l13.28" class="difflineplus">+var Olm = require(&quot;olm&quot;);</span>
<a href="#l13.29"></a><span id="l13.29" class="difflineplus">+var utils = require(&quot;../utils&quot;);</span>
<a href="#l13.30"></a><span id="l13.30" class="difflineplus">+</span>
<a href="#l13.31"></a><span id="l13.31" class="difflineplus">+/**</span>
<a href="#l13.32"></a><span id="l13.32" class="difflineplus">+ * Manages the olm cryptography functions. Each OlmDevice has a single</span>
<a href="#l13.33"></a><span id="l13.33" class="difflineplus">+ * OlmAccount and a number of OlmSessions.</span>
<a href="#l13.34"></a><span id="l13.34" class="difflineplus">+ *</span>
<a href="#l13.35"></a><span id="l13.35" class="difflineplus">+ * Accounts and sessions are kept pickled in a sessionStore.</span>
<a href="#l13.36"></a><span id="l13.36" class="difflineplus">+ *</span>
<a href="#l13.37"></a><span id="l13.37" class="difflineplus">+ * @constructor</span>
<a href="#l13.38"></a><span id="l13.38" class="difflineplus">+ * @alias module:crypto/OlmDevice</span>
<a href="#l13.39"></a><span id="l13.39" class="difflineplus">+ *</span>
<a href="#l13.40"></a><span id="l13.40" class="difflineplus">+ * @param {Object} sessionStore A store to be used for data in end-to-end</span>
<a href="#l13.41"></a><span id="l13.41" class="difflineplus">+ *    crypto</span>
<a href="#l13.42"></a><span id="l13.42" class="difflineplus">+ *</span>
<a href="#l13.43"></a><span id="l13.43" class="difflineplus">+ * @property {string} deviceCurve25519Key   Curve25519 key for the account</span>
<a href="#l13.44"></a><span id="l13.44" class="difflineplus">+ * @property {string} deviceEd25519Key      Ed25519 key for the account</span>
<a href="#l13.45"></a><span id="l13.45" class="difflineplus">+ */</span>
<a href="#l13.46"></a><span id="l13.46" class="difflineplus">+function OlmDevice(sessionStore) {</span>
<a href="#l13.47"></a><span id="l13.47" class="difflineplus">+    this._sessionStore = sessionStore;</span>
<a href="#l13.48"></a><span id="l13.48" class="difflineplus">+    this._pickleKey = &quot;DEFAULT_KEY&quot;;</span>
<a href="#l13.49"></a><span id="l13.49" class="difflineplus">+</span>
<a href="#l13.50"></a><span id="l13.50" class="difflineplus">+    var e2eKeys;</span>
<a href="#l13.51"></a><span id="l13.51" class="difflineplus">+    var account = new Olm.Account();</span>
<a href="#l13.52"></a><span id="l13.52" class="difflineplus">+    try {</span>
<a href="#l13.53"></a><span id="l13.53" class="difflineplus">+        _initialise_account(this._sessionStore, this._pickleKey, account);</span>
<a href="#l13.54"></a><span id="l13.54" class="difflineplus">+        e2eKeys = JSON.parse(account.identity_keys());</span>
<a href="#l13.55"></a><span id="l13.55" class="difflineplus">+    } finally {</span>
<a href="#l13.56"></a><span id="l13.56" class="difflineplus">+        account.free();</span>
<a href="#l13.57"></a><span id="l13.57" class="difflineplus">+    }</span>
<a href="#l13.58"></a><span id="l13.58" class="difflineplus">+</span>
<a href="#l13.59"></a><span id="l13.59" class="difflineplus">+    this.deviceCurve25519Key = e2eKeys.curve25519;</span>
<a href="#l13.60"></a><span id="l13.60" class="difflineplus">+    this.deviceEd25519Key = e2eKeys.ed25519;</span>
<a href="#l13.61"></a><span id="l13.61" class="difflineplus">+</span>
<a href="#l13.62"></a><span id="l13.62" class="difflineplus">+    // we don't bother stashing outboundgroupsessions in the sessionstore -</span>
<a href="#l13.63"></a><span id="l13.63" class="difflineplus">+    // instead we keep them here.</span>
<a href="#l13.64"></a><span id="l13.64" class="difflineplus">+    this._outboundGroupSessionStore = {};</span>
<a href="#l13.65"></a><span id="l13.65" class="difflineplus">+</span>
<a href="#l13.66"></a><span id="l13.66" class="difflineplus">+    // Store a set of decrypted message indexes for each group session.</span>
<a href="#l13.67"></a><span id="l13.67" class="difflineplus">+    // This partially mitigates a replay attack where a MITM resends a group</span>
<a href="#l13.68"></a><span id="l13.68" class="difflineplus">+    // message into the room.</span>
<a href="#l13.69"></a><span id="l13.69" class="difflineplus">+    //</span>
<a href="#l13.70"></a><span id="l13.70" class="difflineplus">+    // TODO: If we ever remove an event from memory we will also need to remove</span>
<a href="#l13.71"></a><span id="l13.71" class="difflineplus">+    // it from this map. Otherwise if we download the event from the server we</span>
<a href="#l13.72"></a><span id="l13.72" class="difflineplus">+    // will think that it is a duplicate.</span>
<a href="#l13.73"></a><span id="l13.73" class="difflineplus">+    //</span>
<a href="#l13.74"></a><span id="l13.74" class="difflineplus">+    // Keys are strings of form &quot;&lt;senderKey&gt;|&lt;session_id&gt;|&lt;message_index&gt;&quot;</span>
<a href="#l13.75"></a><span id="l13.75" class="difflineplus">+    // Values are true.</span>
<a href="#l13.76"></a><span id="l13.76" class="difflineplus">+    this._inboundGroupSessionMessageIndexes = {};</span>
<a href="#l13.77"></a><span id="l13.77" class="difflineplus">+}</span>
<a href="#l13.78"></a><span id="l13.78" class="difflineplus">+</span>
<a href="#l13.79"></a><span id="l13.79" class="difflineplus">+function _initialise_account(sessionStore, pickleKey, account) {</span>
<a href="#l13.80"></a><span id="l13.80" class="difflineplus">+    var e2eAccount = sessionStore.getEndToEndAccount();</span>
<a href="#l13.81"></a><span id="l13.81" class="difflineplus">+    if (e2eAccount !== null) {</span>
<a href="#l13.82"></a><span id="l13.82" class="difflineplus">+        account.unpickle(pickleKey, e2eAccount);</span>
<a href="#l13.83"></a><span id="l13.83" class="difflineplus">+        return;</span>
<a href="#l13.84"></a><span id="l13.84" class="difflineplus">+    }</span>
<a href="#l13.85"></a><span id="l13.85" class="difflineplus">+</span>
<a href="#l13.86"></a><span id="l13.86" class="difflineplus">+    account.create();</span>
<a href="#l13.87"></a><span id="l13.87" class="difflineplus">+    var pickled = account.pickle(pickleKey);</span>
<a href="#l13.88"></a><span id="l13.88" class="difflineplus">+    sessionStore.storeEndToEndAccount(pickled);</span>
<a href="#l13.89"></a><span id="l13.89" class="difflineplus">+}</span>
<a href="#l13.90"></a><span id="l13.90" class="difflineplus">+</span>
<a href="#l13.91"></a><span id="l13.91" class="difflineplus">+/**</span>
<a href="#l13.92"></a><span id="l13.92" class="difflineplus">+ * @return {array} The version of Olm.</span>
<a href="#l13.93"></a><span id="l13.93" class="difflineplus">+ */</span>
<a href="#l13.94"></a><span id="l13.94" class="difflineplus">+OlmDevice.getOlmVersion = function() {</span>
<a href="#l13.95"></a><span id="l13.95" class="difflineplus">+    return Olm.get_library_version();</span>
<a href="#l13.96"></a><span id="l13.96" class="difflineplus">+};</span>
<a href="#l13.97"></a><span id="l13.97" class="difflineplus">+</span>
<a href="#l13.98"></a><span id="l13.98" class="difflineplus">+</span>
<a href="#l13.99"></a><span id="l13.99" class="difflineplus">+/**</span>
<a href="#l13.100"></a><span id="l13.100" class="difflineplus">+ * extract our OlmAccount from the session store and call the given function</span>
<a href="#l13.101"></a><span id="l13.101" class="difflineplus">+ *</span>
<a href="#l13.102"></a><span id="l13.102" class="difflineplus">+ * @param {function} func</span>
<a href="#l13.103"></a><span id="l13.103" class="difflineplus">+ * @return {object} result of func</span>
<a href="#l13.104"></a><span id="l13.104" class="difflineplus">+ * @private</span>
<a href="#l13.105"></a><span id="l13.105" class="difflineplus">+ */</span>
<a href="#l13.106"></a><span id="l13.106" class="difflineplus">+OlmDevice.prototype._getAccount = function(func) {</span>
<a href="#l13.107"></a><span id="l13.107" class="difflineplus">+    var account = new Olm.Account();</span>
<a href="#l13.108"></a><span id="l13.108" class="difflineplus">+    try {</span>
<a href="#l13.109"></a><span id="l13.109" class="difflineplus">+        var pickledAccount = this._sessionStore.getEndToEndAccount();</span>
<a href="#l13.110"></a><span id="l13.110" class="difflineplus">+        account.unpickle(this._pickleKey, pickledAccount);</span>
<a href="#l13.111"></a><span id="l13.111" class="difflineplus">+        return func(account);</span>
<a href="#l13.112"></a><span id="l13.112" class="difflineplus">+    } finally {</span>
<a href="#l13.113"></a><span id="l13.113" class="difflineplus">+        account.free();</span>
<a href="#l13.114"></a><span id="l13.114" class="difflineplus">+    }</span>
<a href="#l13.115"></a><span id="l13.115" class="difflineplus">+};</span>
<a href="#l13.116"></a><span id="l13.116" class="difflineplus">+</span>
<a href="#l13.117"></a><span id="l13.117" class="difflineplus">+</span>
<a href="#l13.118"></a><span id="l13.118" class="difflineplus">+/**</span>
<a href="#l13.119"></a><span id="l13.119" class="difflineplus">+ * store our OlmAccount in the session store</span>
<a href="#l13.120"></a><span id="l13.120" class="difflineplus">+ *</span>
<a href="#l13.121"></a><span id="l13.121" class="difflineplus">+ * @param {OlmAccount} account</span>
<a href="#l13.122"></a><span id="l13.122" class="difflineplus">+ * @private</span>
<a href="#l13.123"></a><span id="l13.123" class="difflineplus">+ */</span>
<a href="#l13.124"></a><span id="l13.124" class="difflineplus">+OlmDevice.prototype._saveAccount = function(account) {</span>
<a href="#l13.125"></a><span id="l13.125" class="difflineplus">+    var pickledAccount = account.pickle(this._pickleKey);</span>
<a href="#l13.126"></a><span id="l13.126" class="difflineplus">+    this._sessionStore.storeEndToEndAccount(pickledAccount);</span>
<a href="#l13.127"></a><span id="l13.127" class="difflineplus">+};</span>
<a href="#l13.128"></a><span id="l13.128" class="difflineplus">+</span>
<a href="#l13.129"></a><span id="l13.129" class="difflineplus">+</span>
<a href="#l13.130"></a><span id="l13.130" class="difflineplus">+/**</span>
<a href="#l13.131"></a><span id="l13.131" class="difflineplus">+ * extract an OlmSession from the session store and call the given function</span>
<a href="#l13.132"></a><span id="l13.132" class="difflineplus">+ *</span>
<a href="#l13.133"></a><span id="l13.133" class="difflineplus">+ * @param {string} deviceKey</span>
<a href="#l13.134"></a><span id="l13.134" class="difflineplus">+ * @param {string} sessionId</span>
<a href="#l13.135"></a><span id="l13.135" class="difflineplus">+ * @param {function} func</span>
<a href="#l13.136"></a><span id="l13.136" class="difflineplus">+ * @return {object} result of func</span>
<a href="#l13.137"></a><span id="l13.137" class="difflineplus">+ * @private</span>
<a href="#l13.138"></a><span id="l13.138" class="difflineplus">+ */</span>
<a href="#l13.139"></a><span id="l13.139" class="difflineplus">+OlmDevice.prototype._getSession = function(deviceKey, sessionId, func) {</span>
<a href="#l13.140"></a><span id="l13.140" class="difflineplus">+    var sessions = this._sessionStore.getEndToEndSessions(deviceKey);</span>
<a href="#l13.141"></a><span id="l13.141" class="difflineplus">+    var pickledSession = sessions[sessionId];</span>
<a href="#l13.142"></a><span id="l13.142" class="difflineplus">+</span>
<a href="#l13.143"></a><span id="l13.143" class="difflineplus">+    var session = new Olm.Session();</span>
<a href="#l13.144"></a><span id="l13.144" class="difflineplus">+    try {</span>
<a href="#l13.145"></a><span id="l13.145" class="difflineplus">+        session.unpickle(this._pickleKey, pickledSession);</span>
<a href="#l13.146"></a><span id="l13.146" class="difflineplus">+        return func(session);</span>
<a href="#l13.147"></a><span id="l13.147" class="difflineplus">+    } finally {</span>
<a href="#l13.148"></a><span id="l13.148" class="difflineplus">+        session.free();</span>
<a href="#l13.149"></a><span id="l13.149" class="difflineplus">+    }</span>
<a href="#l13.150"></a><span id="l13.150" class="difflineplus">+};</span>
<a href="#l13.151"></a><span id="l13.151" class="difflineplus">+</span>
<a href="#l13.152"></a><span id="l13.152" class="difflineplus">+</span>
<a href="#l13.153"></a><span id="l13.153" class="difflineplus">+/**</span>
<a href="#l13.154"></a><span id="l13.154" class="difflineplus">+ * store our OlmSession in the session store</span>
<a href="#l13.155"></a><span id="l13.155" class="difflineplus">+ *</span>
<a href="#l13.156"></a><span id="l13.156" class="difflineplus">+ * @param {string} deviceKey</span>
<a href="#l13.157"></a><span id="l13.157" class="difflineplus">+ * @param {OlmSession} session</span>
<a href="#l13.158"></a><span id="l13.158" class="difflineplus">+ * @private</span>
<a href="#l13.159"></a><span id="l13.159" class="difflineplus">+ */</span>
<a href="#l13.160"></a><span id="l13.160" class="difflineplus">+OlmDevice.prototype._saveSession = function(deviceKey, session) {</span>
<a href="#l13.161"></a><span id="l13.161" class="difflineplus">+    var pickledSession = session.pickle(this._pickleKey);</span>
<a href="#l13.162"></a><span id="l13.162" class="difflineplus">+    this._sessionStore.storeEndToEndSession(</span>
<a href="#l13.163"></a><span id="l13.163" class="difflineplus">+        deviceKey, session.session_id(), pickledSession</span>
<a href="#l13.164"></a><span id="l13.164" class="difflineplus">+    );</span>
<a href="#l13.165"></a><span id="l13.165" class="difflineplus">+};</span>
<a href="#l13.166"></a><span id="l13.166" class="difflineplus">+</span>
<a href="#l13.167"></a><span id="l13.167" class="difflineplus">+</span>
<a href="#l13.168"></a><span id="l13.168" class="difflineplus">+/**</span>
<a href="#l13.169"></a><span id="l13.169" class="difflineplus">+ * get an OlmUtility and call the given function</span>
<a href="#l13.170"></a><span id="l13.170" class="difflineplus">+ *</span>
<a href="#l13.171"></a><span id="l13.171" class="difflineplus">+ * @param {function} func</span>
<a href="#l13.172"></a><span id="l13.172" class="difflineplus">+ * @return {object} result of func</span>
<a href="#l13.173"></a><span id="l13.173" class="difflineplus">+ * @private</span>
<a href="#l13.174"></a><span id="l13.174" class="difflineplus">+ */</span>
<a href="#l13.175"></a><span id="l13.175" class="difflineplus">+OlmDevice.prototype._getUtility = function(func) {</span>
<a href="#l13.176"></a><span id="l13.176" class="difflineplus">+    var utility = new Olm.Utility();</span>
<a href="#l13.177"></a><span id="l13.177" class="difflineplus">+    try {</span>
<a href="#l13.178"></a><span id="l13.178" class="difflineplus">+        return func(utility);</span>
<a href="#l13.179"></a><span id="l13.179" class="difflineplus">+    } finally {</span>
<a href="#l13.180"></a><span id="l13.180" class="difflineplus">+        utility.free();</span>
<a href="#l13.181"></a><span id="l13.181" class="difflineplus">+    }</span>
<a href="#l13.182"></a><span id="l13.182" class="difflineplus">+};</span>
<a href="#l13.183"></a><span id="l13.183" class="difflineplus">+</span>
<a href="#l13.184"></a><span id="l13.184" class="difflineplus">+</span>
<a href="#l13.185"></a><span id="l13.185" class="difflineplus">+/**</span>
<a href="#l13.186"></a><span id="l13.186" class="difflineplus">+ * Signs a message with the ed25519 key for this account.</span>
<a href="#l13.187"></a><span id="l13.187" class="difflineplus">+ *</span>
<a href="#l13.188"></a><span id="l13.188" class="difflineplus">+ * @param {string} message  message to be signed</span>
<a href="#l13.189"></a><span id="l13.189" class="difflineplus">+ * @return {string} base64-encoded signature</span>
<a href="#l13.190"></a><span id="l13.190" class="difflineplus">+ */</span>
<a href="#l13.191"></a><span id="l13.191" class="difflineplus">+OlmDevice.prototype.sign = function(message) {</span>
<a href="#l13.192"></a><span id="l13.192" class="difflineplus">+    return this._getAccount(function(account) {</span>
<a href="#l13.193"></a><span id="l13.193" class="difflineplus">+        return account.sign(message);</span>
<a href="#l13.194"></a><span id="l13.194" class="difflineplus">+    });</span>
<a href="#l13.195"></a><span id="l13.195" class="difflineplus">+};</span>
<a href="#l13.196"></a><span id="l13.196" class="difflineplus">+</span>
<a href="#l13.197"></a><span id="l13.197" class="difflineplus">+/**</span>
<a href="#l13.198"></a><span id="l13.198" class="difflineplus">+ * Get the current (unused, unpublished) one-time keys for this account.</span>
<a href="#l13.199"></a><span id="l13.199" class="difflineplus">+ *</span>
<a href="#l13.200"></a><span id="l13.200" class="difflineplus">+ * @return {object} one time keys; an object with the single property</span>
<a href="#l13.201"></a><span id="l13.201" class="difflineplus">+ * &lt;tt&gt;curve25519&lt;/tt&gt;, which is itself an object mapping key id to Curve25519</span>
<a href="#l13.202"></a><span id="l13.202" class="difflineplus">+ * key.</span>
<a href="#l13.203"></a><span id="l13.203" class="difflineplus">+ */</span>
<a href="#l13.204"></a><span id="l13.204" class="difflineplus">+OlmDevice.prototype.getOneTimeKeys = function() {</span>
<a href="#l13.205"></a><span id="l13.205" class="difflineplus">+    return this._getAccount(function(account) {</span>
<a href="#l13.206"></a><span id="l13.206" class="difflineplus">+        return JSON.parse(account.one_time_keys());</span>
<a href="#l13.207"></a><span id="l13.207" class="difflineplus">+    });</span>
<a href="#l13.208"></a><span id="l13.208" class="difflineplus">+};</span>
<a href="#l13.209"></a><span id="l13.209" class="difflineplus">+</span>
<a href="#l13.210"></a><span id="l13.210" class="difflineplus">+</span>
<a href="#l13.211"></a><span id="l13.211" class="difflineplus">+/**</span>
<a href="#l13.212"></a><span id="l13.212" class="difflineplus">+ * Get the maximum number of one-time keys we can store.</span>
<a href="#l13.213"></a><span id="l13.213" class="difflineplus">+ *</span>
<a href="#l13.214"></a><span id="l13.214" class="difflineplus">+ * @return {number} number of keys</span>
<a href="#l13.215"></a><span id="l13.215" class="difflineplus">+ */</span>
<a href="#l13.216"></a><span id="l13.216" class="difflineplus">+OlmDevice.prototype.maxNumberOfOneTimeKeys = function() {</span>
<a href="#l13.217"></a><span id="l13.217" class="difflineplus">+    return this._getAccount(function(account) {</span>
<a href="#l13.218"></a><span id="l13.218" class="difflineplus">+        return account.max_number_of_one_time_keys();</span>
<a href="#l13.219"></a><span id="l13.219" class="difflineplus">+    });</span>
<a href="#l13.220"></a><span id="l13.220" class="difflineplus">+};</span>
<a href="#l13.221"></a><span id="l13.221" class="difflineplus">+</span>
<a href="#l13.222"></a><span id="l13.222" class="difflineplus">+/**</span>
<a href="#l13.223"></a><span id="l13.223" class="difflineplus">+ * Marks all of the one-time keys as published.</span>
<a href="#l13.224"></a><span id="l13.224" class="difflineplus">+ */</span>
<a href="#l13.225"></a><span id="l13.225" class="difflineplus">+OlmDevice.prototype.markKeysAsPublished = function() {</span>
<a href="#l13.226"></a><span id="l13.226" class="difflineplus">+    var self = this;</span>
<a href="#l13.227"></a><span id="l13.227" class="difflineplus">+    this._getAccount(function(account) {</span>
<a href="#l13.228"></a><span id="l13.228" class="difflineplus">+        account.mark_keys_as_published();</span>
<a href="#l13.229"></a><span id="l13.229" class="difflineplus">+        self._saveAccount(account);</span>
<a href="#l13.230"></a><span id="l13.230" class="difflineplus">+    });</span>
<a href="#l13.231"></a><span id="l13.231" class="difflineplus">+};</span>
<a href="#l13.232"></a><span id="l13.232" class="difflineplus">+</span>
<a href="#l13.233"></a><span id="l13.233" class="difflineplus">+/**</span>
<a href="#l13.234"></a><span id="l13.234" class="difflineplus">+ * Generate some new one-time keys</span>
<a href="#l13.235"></a><span id="l13.235" class="difflineplus">+ *</span>
<a href="#l13.236"></a><span id="l13.236" class="difflineplus">+ * @param {number} numKeys number of keys to generate</span>
<a href="#l13.237"></a><span id="l13.237" class="difflineplus">+ */</span>
<a href="#l13.238"></a><span id="l13.238" class="difflineplus">+OlmDevice.prototype.generateOneTimeKeys = function(numKeys) {</span>
<a href="#l13.239"></a><span id="l13.239" class="difflineplus">+    var self = this;</span>
<a href="#l13.240"></a><span id="l13.240" class="difflineplus">+    this._getAccount(function(account) {</span>
<a href="#l13.241"></a><span id="l13.241" class="difflineplus">+        account.generate_one_time_keys(numKeys);</span>
<a href="#l13.242"></a><span id="l13.242" class="difflineplus">+        self._saveAccount(account);</span>
<a href="#l13.243"></a><span id="l13.243" class="difflineplus">+    });</span>
<a href="#l13.244"></a><span id="l13.244" class="difflineplus">+};</span>
<a href="#l13.245"></a><span id="l13.245" class="difflineplus">+</span>
<a href="#l13.246"></a><span id="l13.246" class="difflineplus">+/**</span>
<a href="#l13.247"></a><span id="l13.247" class="difflineplus">+ * Generate a new outbound session</span>
<a href="#l13.248"></a><span id="l13.248" class="difflineplus">+ *</span>
<a href="#l13.249"></a><span id="l13.249" class="difflineplus">+ * The new session will be stored in the sessionStore.</span>
<a href="#l13.250"></a><span id="l13.250" class="difflineplus">+ *</span>
<a href="#l13.251"></a><span id="l13.251" class="difflineplus">+ * @param {string} theirIdentityKey remote user's Curve25519 identity key</span>
<a href="#l13.252"></a><span id="l13.252" class="difflineplus">+ * @param {string} theirOneTimeKey  remote user's one-time Curve25519 key</span>
<a href="#l13.253"></a><span id="l13.253" class="difflineplus">+ * @return {string} sessionId for the outbound session.</span>
<a href="#l13.254"></a><span id="l13.254" class="difflineplus">+ */</span>
<a href="#l13.255"></a><span id="l13.255" class="difflineplus">+OlmDevice.prototype.createOutboundSession = function(</span>
<a href="#l13.256"></a><span id="l13.256" class="difflineplus">+    theirIdentityKey, theirOneTimeKey</span>
<a href="#l13.257"></a><span id="l13.257" class="difflineplus">+) {</span>
<a href="#l13.258"></a><span id="l13.258" class="difflineplus">+    var self = this;</span>
<a href="#l13.259"></a><span id="l13.259" class="difflineplus">+    return this._getAccount(function(account) {</span>
<a href="#l13.260"></a><span id="l13.260" class="difflineplus">+        var session = new Olm.Session();</span>
<a href="#l13.261"></a><span id="l13.261" class="difflineplus">+        try {</span>
<a href="#l13.262"></a><span id="l13.262" class="difflineplus">+            session.create_outbound(account, theirIdentityKey, theirOneTimeKey);</span>
<a href="#l13.263"></a><span id="l13.263" class="difflineplus">+            self._saveSession(theirIdentityKey, session);</span>
<a href="#l13.264"></a><span id="l13.264" class="difflineplus">+            return session.session_id();</span>
<a href="#l13.265"></a><span id="l13.265" class="difflineplus">+        } finally {</span>
<a href="#l13.266"></a><span id="l13.266" class="difflineplus">+            session.free();</span>
<a href="#l13.267"></a><span id="l13.267" class="difflineplus">+        }</span>
<a href="#l13.268"></a><span id="l13.268" class="difflineplus">+    });</span>
<a href="#l13.269"></a><span id="l13.269" class="difflineplus">+};</span>
<a href="#l13.270"></a><span id="l13.270" class="difflineplus">+</span>
<a href="#l13.271"></a><span id="l13.271" class="difflineplus">+</span>
<a href="#l13.272"></a><span id="l13.272" class="difflineplus">+/**</span>
<a href="#l13.273"></a><span id="l13.273" class="difflineplus">+ * Generate a new inbound session, given an incoming message</span>
<a href="#l13.274"></a><span id="l13.274" class="difflineplus">+ *</span>
<a href="#l13.275"></a><span id="l13.275" class="difflineplus">+ * @param {string} theirDeviceIdentityKey remote user's Curve25519 identity key</span>
<a href="#l13.276"></a><span id="l13.276" class="difflineplus">+ * @param {number} message_type  message_type field from the received message (must be 0)</span>
<a href="#l13.277"></a><span id="l13.277" class="difflineplus">+ * @param {string} ciphertext base64-encoded body from the received message</span>
<a href="#l13.278"></a><span id="l13.278" class="difflineplus">+ *</span>
<a href="#l13.279"></a><span id="l13.279" class="difflineplus">+ * @return {{payload: string, session_id: string}} decrypted payload, and</span>
<a href="#l13.280"></a><span id="l13.280" class="difflineplus">+ *     session id of new session</span>
<a href="#l13.281"></a><span id="l13.281" class="difflineplus">+ *</span>
<a href="#l13.282"></a><span id="l13.282" class="difflineplus">+ * @raises {Error} if the received message was not valid (for instance, it</span>
<a href="#l13.283"></a><span id="l13.283" class="difflineplus">+ *     didn't use a valid one-time key).</span>
<a href="#l13.284"></a><span id="l13.284" class="difflineplus">+ */</span>
<a href="#l13.285"></a><span id="l13.285" class="difflineplus">+OlmDevice.prototype.createInboundSession = function(</span>
<a href="#l13.286"></a><span id="l13.286" class="difflineplus">+    theirDeviceIdentityKey, message_type, ciphertext</span>
<a href="#l13.287"></a><span id="l13.287" class="difflineplus">+) {</span>
<a href="#l13.288"></a><span id="l13.288" class="difflineplus">+    if (message_type !== 0) {</span>
<a href="#l13.289"></a><span id="l13.289" class="difflineplus">+        throw new Error(&quot;Need message_type == 0 to create inbound session&quot;);</span>
<a href="#l13.290"></a><span id="l13.290" class="difflineplus">+    }</span>
<a href="#l13.291"></a><span id="l13.291" class="difflineplus">+</span>
<a href="#l13.292"></a><span id="l13.292" class="difflineplus">+    var self = this;</span>
<a href="#l13.293"></a><span id="l13.293" class="difflineplus">+    return this._getAccount(function(account) {</span>
<a href="#l13.294"></a><span id="l13.294" class="difflineplus">+        var session = new Olm.Session();</span>
<a href="#l13.295"></a><span id="l13.295" class="difflineplus">+        try {</span>
<a href="#l13.296"></a><span id="l13.296" class="difflineplus">+            session.create_inbound_from(account, theirDeviceIdentityKey, ciphertext);</span>
<a href="#l13.297"></a><span id="l13.297" class="difflineplus">+            account.remove_one_time_keys(session);</span>
<a href="#l13.298"></a><span id="l13.298" class="difflineplus">+            self._saveAccount(account);</span>
<a href="#l13.299"></a><span id="l13.299" class="difflineplus">+</span>
<a href="#l13.300"></a><span id="l13.300" class="difflineplus">+            var payloadString = session.decrypt(message_type, ciphertext);</span>
<a href="#l13.301"></a><span id="l13.301" class="difflineplus">+</span>
<a href="#l13.302"></a><span id="l13.302" class="difflineplus">+            self._saveSession(theirDeviceIdentityKey, session);</span>
<a href="#l13.303"></a><span id="l13.303" class="difflineplus">+</span>
<a href="#l13.304"></a><span id="l13.304" class="difflineplus">+            return {</span>
<a href="#l13.305"></a><span id="l13.305" class="difflineplus">+                payload: payloadString,</span>
<a href="#l13.306"></a><span id="l13.306" class="difflineplus">+                session_id: session.session_id(),</span>
<a href="#l13.307"></a><span id="l13.307" class="difflineplus">+            };</span>
<a href="#l13.308"></a><span id="l13.308" class="difflineplus">+        } finally {</span>
<a href="#l13.309"></a><span id="l13.309" class="difflineplus">+            session.free();</span>
<a href="#l13.310"></a><span id="l13.310" class="difflineplus">+        }</span>
<a href="#l13.311"></a><span id="l13.311" class="difflineplus">+    });</span>
<a href="#l13.312"></a><span id="l13.312" class="difflineplus">+};</span>
<a href="#l13.313"></a><span id="l13.313" class="difflineplus">+</span>
<a href="#l13.314"></a><span id="l13.314" class="difflineplus">+</span>
<a href="#l13.315"></a><span id="l13.315" class="difflineplus">+/**</span>
<a href="#l13.316"></a><span id="l13.316" class="difflineplus">+ * Get a list of known session IDs for the given device</span>
<a href="#l13.317"></a><span id="l13.317" class="difflineplus">+ *</span>
<a href="#l13.318"></a><span id="l13.318" class="difflineplus">+ * @param {string} theirDeviceIdentityKey Curve25519 identity key for the</span>
<a href="#l13.319"></a><span id="l13.319" class="difflineplus">+ *     remote device</span>
<a href="#l13.320"></a><span id="l13.320" class="difflineplus">+ * @return {string[]}  a list of known session ids for the device</span>
<a href="#l13.321"></a><span id="l13.321" class="difflineplus">+ */</span>
<a href="#l13.322"></a><span id="l13.322" class="difflineplus">+OlmDevice.prototype.getSessionIdsForDevice = function(theirDeviceIdentityKey) {</span>
<a href="#l13.323"></a><span id="l13.323" class="difflineplus">+    var sessions = this._sessionStore.getEndToEndSessions(</span>
<a href="#l13.324"></a><span id="l13.324" class="difflineplus">+        theirDeviceIdentityKey</span>
<a href="#l13.325"></a><span id="l13.325" class="difflineplus">+    );</span>
<a href="#l13.326"></a><span id="l13.326" class="difflineplus">+    return utils.keys(sessions);</span>
<a href="#l13.327"></a><span id="l13.327" class="difflineplus">+};</span>
<a href="#l13.328"></a><span id="l13.328" class="difflineplus">+</span>
<a href="#l13.329"></a><span id="l13.329" class="difflineplus">+/**</span>
<a href="#l13.330"></a><span id="l13.330" class="difflineplus">+ * Get the right olm session id for encrypting messages to the given identity key</span>
<a href="#l13.331"></a><span id="l13.331" class="difflineplus">+ *</span>
<a href="#l13.332"></a><span id="l13.332" class="difflineplus">+ * @param {string} theirDeviceIdentityKey Curve25519 identity key for the</span>
<a href="#l13.333"></a><span id="l13.333" class="difflineplus">+ *     remote device</span>
<a href="#l13.334"></a><span id="l13.334" class="difflineplus">+ * @return {string?}  session id, or null if no established session</span>
<a href="#l13.335"></a><span id="l13.335" class="difflineplus">+ */</span>
<a href="#l13.336"></a><span id="l13.336" class="difflineplus">+OlmDevice.prototype.getSessionIdForDevice = function(theirDeviceIdentityKey) {</span>
<a href="#l13.337"></a><span id="l13.337" class="difflineplus">+    var sessionIds = this.getSessionIdsForDevice(theirDeviceIdentityKey);</span>
<a href="#l13.338"></a><span id="l13.338" class="difflineplus">+    if (sessionIds.length === 0) {</span>
<a href="#l13.339"></a><span id="l13.339" class="difflineplus">+        return null;</span>
<a href="#l13.340"></a><span id="l13.340" class="difflineplus">+    }</span>
<a href="#l13.341"></a><span id="l13.341" class="difflineplus">+    // Use the session with the lowest ID.</span>
<a href="#l13.342"></a><span id="l13.342" class="difflineplus">+    sessionIds.sort();</span>
<a href="#l13.343"></a><span id="l13.343" class="difflineplus">+    return sessionIds[0];</span>
<a href="#l13.344"></a><span id="l13.344" class="difflineplus">+};</span>
<a href="#l13.345"></a><span id="l13.345" class="difflineplus">+</span>
<a href="#l13.346"></a><span id="l13.346" class="difflineplus">+/**</span>
<a href="#l13.347"></a><span id="l13.347" class="difflineplus">+ * Get information on the active Olm sessions for a device.</span>
<a href="#l13.348"></a><span id="l13.348" class="difflineplus">+ * &lt;p&gt;</span>
<a href="#l13.349"></a><span id="l13.349" class="difflineplus">+ * Returns an array, with an entry for each active session. The first entry in</span>
<a href="#l13.350"></a><span id="l13.350" class="difflineplus">+ * the result will be the one used for outgoing messages. Each entry contains</span>
<a href="#l13.351"></a><span id="l13.351" class="difflineplus">+ * the keys 'hasReceivedMessage' (true if the session has received an incoming</span>
<a href="#l13.352"></a><span id="l13.352" class="difflineplus">+ * message and is therefore past the pre-key stage), and 'sessionId'.</span>
<a href="#l13.353"></a><span id="l13.353" class="difflineplus">+ *</span>
<a href="#l13.354"></a><span id="l13.354" class="difflineplus">+ * @param {string} deviceIdentityKey Curve25519 identity key for the device</span>
<a href="#l13.355"></a><span id="l13.355" class="difflineplus">+ * @return {Array.&lt;{sessionId: string, hasReceivedMessage: Boolean}&gt;}</span>
<a href="#l13.356"></a><span id="l13.356" class="difflineplus">+ */</span>
<a href="#l13.357"></a><span id="l13.357" class="difflineplus">+OlmDevice.prototype.getSessionInfoForDevice = function(deviceIdentityKey) {</span>
<a href="#l13.358"></a><span id="l13.358" class="difflineplus">+    var sessionIds = this.getSessionIdsForDevice(deviceIdentityKey);</span>
<a href="#l13.359"></a><span id="l13.359" class="difflineplus">+    sessionIds.sort();</span>
<a href="#l13.360"></a><span id="l13.360" class="difflineplus">+</span>
<a href="#l13.361"></a><span id="l13.361" class="difflineplus">+    var info = [];</span>
<a href="#l13.362"></a><span id="l13.362" class="difflineplus">+</span>
<a href="#l13.363"></a><span id="l13.363" class="difflineplus">+    function getSessionInfo(session) {</span>
<a href="#l13.364"></a><span id="l13.364" class="difflineplus">+        return {</span>
<a href="#l13.365"></a><span id="l13.365" class="difflineplus">+            hasReceivedMessage: session.has_received_message()</span>
<a href="#l13.366"></a><span id="l13.366" class="difflineplus">+        };</span>
<a href="#l13.367"></a><span id="l13.367" class="difflineplus">+    }</span>
<a href="#l13.368"></a><span id="l13.368" class="difflineplus">+</span>
<a href="#l13.369"></a><span id="l13.369" class="difflineplus">+    for (var i = 0; i &lt; sessionIds.length; i++) {</span>
<a href="#l13.370"></a><span id="l13.370" class="difflineplus">+        var sessionId = sessionIds[i];</span>
<a href="#l13.371"></a><span id="l13.371" class="difflineplus">+        var res = this._getSession(deviceIdentityKey, sessionId, getSessionInfo);</span>
<a href="#l13.372"></a><span id="l13.372" class="difflineplus">+        res.sessionId = sessionId;</span>
<a href="#l13.373"></a><span id="l13.373" class="difflineplus">+        info.push(res);</span>
<a href="#l13.374"></a><span id="l13.374" class="difflineplus">+    }</span>
<a href="#l13.375"></a><span id="l13.375" class="difflineplus">+    return info;</span>
<a href="#l13.376"></a><span id="l13.376" class="difflineplus">+};</span>
<a href="#l13.377"></a><span id="l13.377" class="difflineplus">+</span>
<a href="#l13.378"></a><span id="l13.378" class="difflineplus">+/**</span>
<a href="#l13.379"></a><span id="l13.379" class="difflineplus">+ * Encrypt an outgoing message using an existing session</span>
<a href="#l13.380"></a><span id="l13.380" class="difflineplus">+ *</span>
<a href="#l13.381"></a><span id="l13.381" class="difflineplus">+ * @param {string} theirDeviceIdentityKey Curve25519 identity key for the</span>
<a href="#l13.382"></a><span id="l13.382" class="difflineplus">+ *     remote device</span>
<a href="#l13.383"></a><span id="l13.383" class="difflineplus">+ * @param {string} sessionId  the id of the active session</span>
<a href="#l13.384"></a><span id="l13.384" class="difflineplus">+ * @param {string} payloadString  payload to be encrypted and sent</span>
<a href="#l13.385"></a><span id="l13.385" class="difflineplus">+ *</span>
<a href="#l13.386"></a><span id="l13.386" class="difflineplus">+ * @return {string} ciphertext</span>
<a href="#l13.387"></a><span id="l13.387" class="difflineplus">+ */</span>
<a href="#l13.388"></a><span id="l13.388" class="difflineplus">+OlmDevice.prototype.encryptMessage = function(</span>
<a href="#l13.389"></a><span id="l13.389" class="difflineplus">+    theirDeviceIdentityKey, sessionId, payloadString</span>
<a href="#l13.390"></a><span id="l13.390" class="difflineplus">+) {</span>
<a href="#l13.391"></a><span id="l13.391" class="difflineplus">+    var self = this;</span>
<a href="#l13.392"></a><span id="l13.392" class="difflineplus">+</span>
<a href="#l13.393"></a><span id="l13.393" class="difflineplus">+    if (payloadString === undefined) {</span>
<a href="#l13.394"></a><span id="l13.394" class="difflineplus">+        throw new Error(&quot;payloadString undefined&quot;);</span>
<a href="#l13.395"></a><span id="l13.395" class="difflineplus">+    }</span>
<a href="#l13.396"></a><span id="l13.396" class="difflineplus">+</span>
<a href="#l13.397"></a><span id="l13.397" class="difflineplus">+    return this._getSession(theirDeviceIdentityKey, sessionId, function(session) {</span>
<a href="#l13.398"></a><span id="l13.398" class="difflineplus">+        var res = session.encrypt(payloadString);</span>
<a href="#l13.399"></a><span id="l13.399" class="difflineplus">+        self._saveSession(theirDeviceIdentityKey, session);</span>
<a href="#l13.400"></a><span id="l13.400" class="difflineplus">+        return res;</span>
<a href="#l13.401"></a><span id="l13.401" class="difflineplus">+    });</span>
<a href="#l13.402"></a><span id="l13.402" class="difflineplus">+};</span>
<a href="#l13.403"></a><span id="l13.403" class="difflineplus">+</span>
<a href="#l13.404"></a><span id="l13.404" class="difflineplus">+/**</span>
<a href="#l13.405"></a><span id="l13.405" class="difflineplus">+ * Decrypt an incoming message using an existing session</span>
<a href="#l13.406"></a><span id="l13.406" class="difflineplus">+ *</span>
<a href="#l13.407"></a><span id="l13.407" class="difflineplus">+ * @param {string} theirDeviceIdentityKey Curve25519 identity key for the</span>
<a href="#l13.408"></a><span id="l13.408" class="difflineplus">+ *     remote device</span>
<a href="#l13.409"></a><span id="l13.409" class="difflineplus">+ * @param {string} sessionId  the id of the active session</span>
<a href="#l13.410"></a><span id="l13.410" class="difflineplus">+ * @param {number} message_type  message_type field from the received message</span>
<a href="#l13.411"></a><span id="l13.411" class="difflineplus">+ * @param {string} ciphertext base64-encoded body from the received message</span>
<a href="#l13.412"></a><span id="l13.412" class="difflineplus">+ *</span>
<a href="#l13.413"></a><span id="l13.413" class="difflineplus">+ * @return {string} decrypted payload.</span>
<a href="#l13.414"></a><span id="l13.414" class="difflineplus">+ */</span>
<a href="#l13.415"></a><span id="l13.415" class="difflineplus">+OlmDevice.prototype.decryptMessage = function(</span>
<a href="#l13.416"></a><span id="l13.416" class="difflineplus">+    theirDeviceIdentityKey, sessionId, message_type, ciphertext</span>
<a href="#l13.417"></a><span id="l13.417" class="difflineplus">+) {</span>
<a href="#l13.418"></a><span id="l13.418" class="difflineplus">+    var self = this;</span>
<a href="#l13.419"></a><span id="l13.419" class="difflineplus">+</span>
<a href="#l13.420"></a><span id="l13.420" class="difflineplus">+    return this._getSession(theirDeviceIdentityKey, sessionId, function(session) {</span>
<a href="#l13.421"></a><span id="l13.421" class="difflineplus">+        var payloadString = session.decrypt(message_type, ciphertext);</span>
<a href="#l13.422"></a><span id="l13.422" class="difflineplus">+        self._saveSession(theirDeviceIdentityKey, session);</span>
<a href="#l13.423"></a><span id="l13.423" class="difflineplus">+</span>
<a href="#l13.424"></a><span id="l13.424" class="difflineplus">+        return payloadString;</span>
<a href="#l13.425"></a><span id="l13.425" class="difflineplus">+    });</span>
<a href="#l13.426"></a><span id="l13.426" class="difflineplus">+};</span>
<a href="#l13.427"></a><span id="l13.427" class="difflineplus">+</span>
<a href="#l13.428"></a><span id="l13.428" class="difflineplus">+/**</span>
<a href="#l13.429"></a><span id="l13.429" class="difflineplus">+ * Determine if an incoming messages is a prekey message matching an existing session</span>
<a href="#l13.430"></a><span id="l13.430" class="difflineplus">+ *</span>
<a href="#l13.431"></a><span id="l13.431" class="difflineplus">+ * @param {string} theirDeviceIdentityKey Curve25519 identity key for the</span>
<a href="#l13.432"></a><span id="l13.432" class="difflineplus">+ *     remote device</span>
<a href="#l13.433"></a><span id="l13.433" class="difflineplus">+ * @param {string} sessionId  the id of the active session</span>
<a href="#l13.434"></a><span id="l13.434" class="difflineplus">+ * @param {number} message_type  message_type field from the received message</span>
<a href="#l13.435"></a><span id="l13.435" class="difflineplus">+ * @param {string} ciphertext base64-encoded body from the received message</span>
<a href="#l13.436"></a><span id="l13.436" class="difflineplus">+ *</span>
<a href="#l13.437"></a><span id="l13.437" class="difflineplus">+ * @return {boolean} true if the received message is a prekey message which matches</span>
<a href="#l13.438"></a><span id="l13.438" class="difflineplus">+ *    the given session.</span>
<a href="#l13.439"></a><span id="l13.439" class="difflineplus">+ */</span>
<a href="#l13.440"></a><span id="l13.440" class="difflineplus">+OlmDevice.prototype.matchesSession = function(</span>
<a href="#l13.441"></a><span id="l13.441" class="difflineplus">+    theirDeviceIdentityKey, sessionId, message_type, ciphertext</span>
<a href="#l13.442"></a><span id="l13.442" class="difflineplus">+) {</span>
<a href="#l13.443"></a><span id="l13.443" class="difflineplus">+    if (message_type !== 0) {</span>
<a href="#l13.444"></a><span id="l13.444" class="difflineplus">+        return false;</span>
<a href="#l13.445"></a><span id="l13.445" class="difflineplus">+    }</span>
<a href="#l13.446"></a><span id="l13.446" class="difflineplus">+</span>
<a href="#l13.447"></a><span id="l13.447" class="difflineplus">+    return this._getSession(theirDeviceIdentityKey, sessionId, function(session) {</span>
<a href="#l13.448"></a><span id="l13.448" class="difflineplus">+        return session.matches_inbound(ciphertext);</span>
<a href="#l13.449"></a><span id="l13.449" class="difflineplus">+    });</span>
<a href="#l13.450"></a><span id="l13.450" class="difflineplus">+};</span>
<a href="#l13.451"></a><span id="l13.451" class="difflineplus">+</span>
<a href="#l13.452"></a><span id="l13.452" class="difflineplus">+</span>
<a href="#l13.453"></a><span id="l13.453" class="difflineplus">+</span>
<a href="#l13.454"></a><span id="l13.454" class="difflineplus">+// Outbound group session</span>
<a href="#l13.455"></a><span id="l13.455" class="difflineplus">+// ======================</span>
<a href="#l13.456"></a><span id="l13.456" class="difflineplus">+</span>
<a href="#l13.457"></a><span id="l13.457" class="difflineplus">+/**</span>
<a href="#l13.458"></a><span id="l13.458" class="difflineplus">+ * store an OutboundGroupSession in _outboundGroupSessionStore</span>
<a href="#l13.459"></a><span id="l13.459" class="difflineplus">+ *</span>
<a href="#l13.460"></a><span id="l13.460" class="difflineplus">+ * @param {Olm.OutboundGroupSession} session</span>
<a href="#l13.461"></a><span id="l13.461" class="difflineplus">+ * @private</span>
<a href="#l13.462"></a><span id="l13.462" class="difflineplus">+ */</span>
<a href="#l13.463"></a><span id="l13.463" class="difflineplus">+OlmDevice.prototype._saveOutboundGroupSession = function(session) {</span>
<a href="#l13.464"></a><span id="l13.464" class="difflineplus">+    var pickledSession = session.pickle(this._pickleKey);</span>
<a href="#l13.465"></a><span id="l13.465" class="difflineplus">+    this._outboundGroupSessionStore[session.session_id()] = pickledSession;</span>
<a href="#l13.466"></a><span id="l13.466" class="difflineplus">+};</span>
<a href="#l13.467"></a><span id="l13.467" class="difflineplus">+</span>
<a href="#l13.468"></a><span id="l13.468" class="difflineplus">+</span>
<a href="#l13.469"></a><span id="l13.469" class="difflineplus">+/**</span>
<a href="#l13.470"></a><span id="l13.470" class="difflineplus">+ * extract an OutboundGroupSession from _outboundGroupSessionStore and call the</span>
<a href="#l13.471"></a><span id="l13.471" class="difflineplus">+ * given function</span>
<a href="#l13.472"></a><span id="l13.472" class="difflineplus">+ *</span>
<a href="#l13.473"></a><span id="l13.473" class="difflineplus">+ * @param {string} sessionId</span>
<a href="#l13.474"></a><span id="l13.474" class="difflineplus">+ * @param {function} func</span>
<a href="#l13.475"></a><span id="l13.475" class="difflineplus">+ * @return {object} result of func</span>
<a href="#l13.476"></a><span id="l13.476" class="difflineplus">+ * @private</span>
<a href="#l13.477"></a><span id="l13.477" class="difflineplus">+ */</span>
<a href="#l13.478"></a><span id="l13.478" class="difflineplus">+OlmDevice.prototype._getOutboundGroupSession = function(sessionId, func) {</span>
<a href="#l13.479"></a><span id="l13.479" class="difflineplus">+    var pickled = this._outboundGroupSessionStore[sessionId];</span>
<a href="#l13.480"></a><span id="l13.480" class="difflineplus">+    if (pickled === null) {</span>
<a href="#l13.481"></a><span id="l13.481" class="difflineplus">+        throw new Error(&quot;Unknown outbound group session &quot; + sessionId);</span>
<a href="#l13.482"></a><span id="l13.482" class="difflineplus">+    }</span>
<a href="#l13.483"></a><span id="l13.483" class="difflineplus">+</span>
<a href="#l13.484"></a><span id="l13.484" class="difflineplus">+    var session = new Olm.OutboundGroupSession();</span>
<a href="#l13.485"></a><span id="l13.485" class="difflineplus">+    try {</span>
<a href="#l13.486"></a><span id="l13.486" class="difflineplus">+        session.unpickle(this._pickleKey, pickled);</span>
<a href="#l13.487"></a><span id="l13.487" class="difflineplus">+        return func(session);</span>
<a href="#l13.488"></a><span id="l13.488" class="difflineplus">+    } finally {</span>
<a href="#l13.489"></a><span id="l13.489" class="difflineplus">+        session.free();</span>
<a href="#l13.490"></a><span id="l13.490" class="difflineplus">+    }</span>
<a href="#l13.491"></a><span id="l13.491" class="difflineplus">+};</span>
<a href="#l13.492"></a><span id="l13.492" class="difflineplus">+</span>
<a href="#l13.493"></a><span id="l13.493" class="difflineplus">+</span>
<a href="#l13.494"></a><span id="l13.494" class="difflineplus">+/**</span>
<a href="#l13.495"></a><span id="l13.495" class="difflineplus">+ * Generate a new outbound group session</span>
<a href="#l13.496"></a><span id="l13.496" class="difflineplus">+ *</span>
<a href="#l13.497"></a><span id="l13.497" class="difflineplus">+ * @return {string} sessionId for the outbound session.</span>
<a href="#l13.498"></a><span id="l13.498" class="difflineplus">+ */</span>
<a href="#l13.499"></a><span id="l13.499" class="difflineplus">+OlmDevice.prototype.createOutboundGroupSession = function() {</span>
<a href="#l13.500"></a><span id="l13.500" class="difflineplus">+    var session = new Olm.OutboundGroupSession();</span>
<a href="#l13.501"></a><span id="l13.501" class="difflineplus">+    try {</span>
<a href="#l13.502"></a><span id="l13.502" class="difflineplus">+        session.create();</span>
<a href="#l13.503"></a><span id="l13.503" class="difflineplus">+        this._saveOutboundGroupSession(session);</span>
<a href="#l13.504"></a><span id="l13.504" class="difflineplus">+        return session.session_id();</span>
<a href="#l13.505"></a><span id="l13.505" class="difflineplus">+    } finally {</span>
<a href="#l13.506"></a><span id="l13.506" class="difflineplus">+        session.free();</span>
<a href="#l13.507"></a><span id="l13.507" class="difflineplus">+    }</span>
<a href="#l13.508"></a><span id="l13.508" class="difflineplus">+};</span>
<a href="#l13.509"></a><span id="l13.509" class="difflineplus">+</span>
<a href="#l13.510"></a><span id="l13.510" class="difflineplus">+</span>
<a href="#l13.511"></a><span id="l13.511" class="difflineplus">+/**</span>
<a href="#l13.512"></a><span id="l13.512" class="difflineplus">+ * Encrypt an outgoing message with an outbound group session</span>
<a href="#l13.513"></a><span id="l13.513" class="difflineplus">+ *</span>
<a href="#l13.514"></a><span id="l13.514" class="difflineplus">+ * @param {string} sessionId  the id of the outboundgroupsession</span>
<a href="#l13.515"></a><span id="l13.515" class="difflineplus">+ * @param {string} payloadString  payload to be encrypted and sent</span>
<a href="#l13.516"></a><span id="l13.516" class="difflineplus">+ *</span>
<a href="#l13.517"></a><span id="l13.517" class="difflineplus">+ * @return {string} ciphertext</span>
<a href="#l13.518"></a><span id="l13.518" class="difflineplus">+ */</span>
<a href="#l13.519"></a><span id="l13.519" class="difflineplus">+OlmDevice.prototype.encryptGroupMessage = function(sessionId, payloadString) {</span>
<a href="#l13.520"></a><span id="l13.520" class="difflineplus">+    var self = this;</span>
<a href="#l13.521"></a><span id="l13.521" class="difflineplus">+</span>
<a href="#l13.522"></a><span id="l13.522" class="difflineplus">+    return this._getOutboundGroupSession(sessionId, function(session) {</span>
<a href="#l13.523"></a><span id="l13.523" class="difflineplus">+        var res = session.encrypt(payloadString);</span>
<a href="#l13.524"></a><span id="l13.524" class="difflineplus">+        self._saveOutboundGroupSession(session);</span>
<a href="#l13.525"></a><span id="l13.525" class="difflineplus">+        return res;</span>
<a href="#l13.526"></a><span id="l13.526" class="difflineplus">+    });</span>
<a href="#l13.527"></a><span id="l13.527" class="difflineplus">+};</span>
<a href="#l13.528"></a><span id="l13.528" class="difflineplus">+</span>
<a href="#l13.529"></a><span id="l13.529" class="difflineplus">+/**</span>
<a href="#l13.530"></a><span id="l13.530" class="difflineplus">+ * Get the session keys for an outbound group session</span>
<a href="#l13.531"></a><span id="l13.531" class="difflineplus">+ *</span>
<a href="#l13.532"></a><span id="l13.532" class="difflineplus">+ * @param {string} sessionId  the id of the outbound group session</span>
<a href="#l13.533"></a><span id="l13.533" class="difflineplus">+ *</span>
<a href="#l13.534"></a><span id="l13.534" class="difflineplus">+ * @return {{chain_index: number, key: string}} current chain index, and</span>
<a href="#l13.535"></a><span id="l13.535" class="difflineplus">+ *     base64-encoded secret key.</span>
<a href="#l13.536"></a><span id="l13.536" class="difflineplus">+ */</span>
<a href="#l13.537"></a><span id="l13.537" class="difflineplus">+OlmDevice.prototype.getOutboundGroupSessionKey = function(sessionId) {</span>
<a href="#l13.538"></a><span id="l13.538" class="difflineplus">+    return this._getOutboundGroupSession(sessionId, function(session) {</span>
<a href="#l13.539"></a><span id="l13.539" class="difflineplus">+        return {</span>
<a href="#l13.540"></a><span id="l13.540" class="difflineplus">+            chain_index: session.message_index(),</span>
<a href="#l13.541"></a><span id="l13.541" class="difflineplus">+            key: session.session_key(),</span>
<a href="#l13.542"></a><span id="l13.542" class="difflineplus">+        };</span>
<a href="#l13.543"></a><span id="l13.543" class="difflineplus">+    });</span>
<a href="#l13.544"></a><span id="l13.544" class="difflineplus">+};</span>
<a href="#l13.545"></a><span id="l13.545" class="difflineplus">+</span>
<a href="#l13.546"></a><span id="l13.546" class="difflineplus">+</span>
<a href="#l13.547"></a><span id="l13.547" class="difflineplus">+// Inbound group session</span>
<a href="#l13.548"></a><span id="l13.548" class="difflineplus">+// =====================</span>
<a href="#l13.549"></a><span id="l13.549" class="difflineplus">+</span>
<a href="#l13.550"></a><span id="l13.550" class="difflineplus">+/**</span>
<a href="#l13.551"></a><span id="l13.551" class="difflineplus">+ * store an InboundGroupSession in the session store</span>
<a href="#l13.552"></a><span id="l13.552" class="difflineplus">+ *</span>
<a href="#l13.553"></a><span id="l13.553" class="difflineplus">+ * @param {string} roomId</span>
<a href="#l13.554"></a><span id="l13.554" class="difflineplus">+ * @param {string} senderCurve25519Key</span>
<a href="#l13.555"></a><span id="l13.555" class="difflineplus">+ * @param {string} sessionId</span>
<a href="#l13.556"></a><span id="l13.556" class="difflineplus">+ * @param {Olm.InboundGroupSession} session</span>
<a href="#l13.557"></a><span id="l13.557" class="difflineplus">+ * @param {object} keysClaimed Other keys the sender claims.</span>
<a href="#l13.558"></a><span id="l13.558" class="difflineplus">+ * @private</span>
<a href="#l13.559"></a><span id="l13.559" class="difflineplus">+ */</span>
<a href="#l13.560"></a><span id="l13.560" class="difflineplus">+OlmDevice.prototype._saveInboundGroupSession = function(</span>
<a href="#l13.561"></a><span id="l13.561" class="difflineplus">+    roomId, senderCurve25519Key, sessionId, session, keysClaimed</span>
<a href="#l13.562"></a><span id="l13.562" class="difflineplus">+) {</span>
<a href="#l13.563"></a><span id="l13.563" class="difflineplus">+    var r = {</span>
<a href="#l13.564"></a><span id="l13.564" class="difflineplus">+        room_id: roomId,</span>
<a href="#l13.565"></a><span id="l13.565" class="difflineplus">+        session: session.pickle(this._pickleKey),</span>
<a href="#l13.566"></a><span id="l13.566" class="difflineplus">+        keysClaimed: keysClaimed,</span>
<a href="#l13.567"></a><span id="l13.567" class="difflineplus">+    };</span>
<a href="#l13.568"></a><span id="l13.568" class="difflineplus">+</span>
<a href="#l13.569"></a><span id="l13.569" class="difflineplus">+    this._sessionStore.storeEndToEndInboundGroupSession(</span>
<a href="#l13.570"></a><span id="l13.570" class="difflineplus">+        senderCurve25519Key, sessionId, JSON.stringify(r)</span>
<a href="#l13.571"></a><span id="l13.571" class="difflineplus">+    );</span>
<a href="#l13.572"></a><span id="l13.572" class="difflineplus">+};</span>
<a href="#l13.573"></a><span id="l13.573" class="difflineplus">+</span>
<a href="#l13.574"></a><span id="l13.574" class="difflineplus">+/**</span>
<a href="#l13.575"></a><span id="l13.575" class="difflineplus">+ * extract an InboundGroupSession from the session store and call the given function</span>
<a href="#l13.576"></a><span id="l13.576" class="difflineplus">+ *</span>
<a href="#l13.577"></a><span id="l13.577" class="difflineplus">+ * @param {string} roomId</span>
<a href="#l13.578"></a><span id="l13.578" class="difflineplus">+ * @param {string} senderKey</span>
<a href="#l13.579"></a><span id="l13.579" class="difflineplus">+ * @param {string} sessionId</span>
<a href="#l13.580"></a><span id="l13.580" class="difflineplus">+ * @param {function(Olm.InboundGroupSession, Object&lt;string, string&gt;): T} func</span>
<a href="#l13.581"></a><span id="l13.581" class="difflineplus">+ *   function to call. Second argument is the map of keys claimed by the session.</span>
<a href="#l13.582"></a><span id="l13.582" class="difflineplus">+ *</span>
<a href="#l13.583"></a><span id="l13.583" class="difflineplus">+ * @return {null} the sessionId is unknown</span>
<a href="#l13.584"></a><span id="l13.584" class="difflineplus">+ *</span>
<a href="#l13.585"></a><span id="l13.585" class="difflineplus">+ * @return {T} result of func</span>
<a href="#l13.586"></a><span id="l13.586" class="difflineplus">+ *</span>
<a href="#l13.587"></a><span id="l13.587" class="difflineplus">+ * @private</span>
<a href="#l13.588"></a><span id="l13.588" class="difflineplus">+ * @template {T}</span>
<a href="#l13.589"></a><span id="l13.589" class="difflineplus">+ */</span>
<a href="#l13.590"></a><span id="l13.590" class="difflineplus">+OlmDevice.prototype._getInboundGroupSession = function(</span>
<a href="#l13.591"></a><span id="l13.591" class="difflineplus">+    roomId, senderKey, sessionId, func</span>
<a href="#l13.592"></a><span id="l13.592" class="difflineplus">+) {</span>
<a href="#l13.593"></a><span id="l13.593" class="difflineplus">+    var r = this._sessionStore.getEndToEndInboundGroupSession(</span>
<a href="#l13.594"></a><span id="l13.594" class="difflineplus">+        senderKey, sessionId</span>
<a href="#l13.595"></a><span id="l13.595" class="difflineplus">+    );</span>
<a href="#l13.596"></a><span id="l13.596" class="difflineplus">+</span>
<a href="#l13.597"></a><span id="l13.597" class="difflineplus">+    if (r === null) {</span>
<a href="#l13.598"></a><span id="l13.598" class="difflineplus">+        return null;</span>
<a href="#l13.599"></a><span id="l13.599" class="difflineplus">+    }</span>
<a href="#l13.600"></a><span id="l13.600" class="difflineplus">+</span>
<a href="#l13.601"></a><span id="l13.601" class="difflineplus">+    r = JSON.parse(r);</span>
<a href="#l13.602"></a><span id="l13.602" class="difflineplus">+</span>
<a href="#l13.603"></a><span id="l13.603" class="difflineplus">+    // check that the room id matches the original one for the session. This stops</span>
<a href="#l13.604"></a><span id="l13.604" class="difflineplus">+    // the HS pretending a message was targeting a different room.</span>
<a href="#l13.605"></a><span id="l13.605" class="difflineplus">+    if (roomId !== r.room_id) {</span>
<a href="#l13.606"></a><span id="l13.606" class="difflineplus">+        throw new Error(</span>
<a href="#l13.607"></a><span id="l13.607" class="difflineplus">+            &quot;Mismatched room_id for inbound group session (expected &quot; + r.room_id +</span>
<a href="#l13.608"></a><span id="l13.608" class="difflineplus">+                &quot;, was &quot; + roomId + &quot;)&quot;</span>
<a href="#l13.609"></a><span id="l13.609" class="difflineplus">+        );</span>
<a href="#l13.610"></a><span id="l13.610" class="difflineplus">+    }</span>
<a href="#l13.611"></a><span id="l13.611" class="difflineplus">+</span>
<a href="#l13.612"></a><span id="l13.612" class="difflineplus">+    var session = new Olm.InboundGroupSession();</span>
<a href="#l13.613"></a><span id="l13.613" class="difflineplus">+    try {</span>
<a href="#l13.614"></a><span id="l13.614" class="difflineplus">+        session.unpickle(this._pickleKey, r.session);</span>
<a href="#l13.615"></a><span id="l13.615" class="difflineplus">+        return func(session, r.keysClaimed || {});</span>
<a href="#l13.616"></a><span id="l13.616" class="difflineplus">+    } finally {</span>
<a href="#l13.617"></a><span id="l13.617" class="difflineplus">+        session.free();</span>
<a href="#l13.618"></a><span id="l13.618" class="difflineplus">+    }</span>
<a href="#l13.619"></a><span id="l13.619" class="difflineplus">+};</span>
<a href="#l13.620"></a><span id="l13.620" class="difflineplus">+</span>
<a href="#l13.621"></a><span id="l13.621" class="difflineplus">+/**</span>
<a href="#l13.622"></a><span id="l13.622" class="difflineplus">+ * Add an inbound group session to the session store</span>
<a href="#l13.623"></a><span id="l13.623" class="difflineplus">+ *</span>
<a href="#l13.624"></a><span id="l13.624" class="difflineplus">+ * @param {string} roomId     room in which this session will be used</span>
<a href="#l13.625"></a><span id="l13.625" class="difflineplus">+ * @param {string} senderKey  base64-encoded curve25519 key of the sender</span>
<a href="#l13.626"></a><span id="l13.626" class="difflineplus">+ * @param {string} sessionId  session identifier</span>
<a href="#l13.627"></a><span id="l13.627" class="difflineplus">+ * @param {string} sessionKey base64-encoded secret key</span>
<a href="#l13.628"></a><span id="l13.628" class="difflineplus">+ * @param {Object&lt;string, string&gt;} keysClaimed Other keys the sender claims.</span>
<a href="#l13.629"></a><span id="l13.629" class="difflineplus">+ */</span>
<a href="#l13.630"></a><span id="l13.630" class="difflineplus">+OlmDevice.prototype.addInboundGroupSession = function(</span>
<a href="#l13.631"></a><span id="l13.631" class="difflineplus">+    roomId, senderKey, sessionId, sessionKey, keysClaimed</span>
<a href="#l13.632"></a><span id="l13.632" class="difflineplus">+) {</span>
<a href="#l13.633"></a><span id="l13.633" class="difflineplus">+    var self = this;</span>
<a href="#l13.634"></a><span id="l13.634" class="difflineplus">+</span>
<a href="#l13.635"></a><span id="l13.635" class="difflineplus">+    /* if we already have this session, consider updating it */</span>
<a href="#l13.636"></a><span id="l13.636" class="difflineplus">+    function updateSession(session) {</span>
<a href="#l13.637"></a><span id="l13.637" class="difflineplus">+        console.log(&quot;Update for megolm session &quot; + senderKey + &quot;/&quot; + sessionId);</span>
<a href="#l13.638"></a><span id="l13.638" class="difflineplus">+        // for now we just ignore updates. TODO: implement something here</span>
<a href="#l13.639"></a><span id="l13.639" class="difflineplus">+</span>
<a href="#l13.640"></a><span id="l13.640" class="difflineplus">+        return true;</span>
<a href="#l13.641"></a><span id="l13.641" class="difflineplus">+    }</span>
<a href="#l13.642"></a><span id="l13.642" class="difflineplus">+</span>
<a href="#l13.643"></a><span id="l13.643" class="difflineplus">+    var r = this._getInboundGroupSession(</span>
<a href="#l13.644"></a><span id="l13.644" class="difflineplus">+        roomId, senderKey, sessionId, updateSession</span>
<a href="#l13.645"></a><span id="l13.645" class="difflineplus">+    );</span>
<a href="#l13.646"></a><span id="l13.646" class="difflineplus">+</span>
<a href="#l13.647"></a><span id="l13.647" class="difflineplus">+    if (r !== null) {</span>
<a href="#l13.648"></a><span id="l13.648" class="difflineplus">+        return;</span>
<a href="#l13.649"></a><span id="l13.649" class="difflineplus">+    }</span>
<a href="#l13.650"></a><span id="l13.650" class="difflineplus">+</span>
<a href="#l13.651"></a><span id="l13.651" class="difflineplus">+    // new session.</span>
<a href="#l13.652"></a><span id="l13.652" class="difflineplus">+    var session = new Olm.InboundGroupSession();</span>
<a href="#l13.653"></a><span id="l13.653" class="difflineplus">+    try {</span>
<a href="#l13.654"></a><span id="l13.654" class="difflineplus">+        session.create(sessionKey);</span>
<a href="#l13.655"></a><span id="l13.655" class="difflineplus">+        if (sessionId != session.session_id()) {</span>
<a href="#l13.656"></a><span id="l13.656" class="difflineplus">+            throw new Error(</span>
<a href="#l13.657"></a><span id="l13.657" class="difflineplus">+                &quot;Mismatched group session ID from senderKey: &quot; + senderKey</span>
<a href="#l13.658"></a><span id="l13.658" class="difflineplus">+            );</span>
<a href="#l13.659"></a><span id="l13.659" class="difflineplus">+        }</span>
<a href="#l13.660"></a><span id="l13.660" class="difflineplus">+        self._saveInboundGroupSession(</span>
<a href="#l13.661"></a><span id="l13.661" class="difflineplus">+            roomId, senderKey, sessionId, session, keysClaimed</span>
<a href="#l13.662"></a><span id="l13.662" class="difflineplus">+        );</span>
<a href="#l13.663"></a><span id="l13.663" class="difflineplus">+    } finally {</span>
<a href="#l13.664"></a><span id="l13.664" class="difflineplus">+        session.free();</span>
<a href="#l13.665"></a><span id="l13.665" class="difflineplus">+    }</span>
<a href="#l13.666"></a><span id="l13.666" class="difflineplus">+};</span>
<a href="#l13.667"></a><span id="l13.667" class="difflineplus">+</span>
<a href="#l13.668"></a><span id="l13.668" class="difflineplus">+/**</span>
<a href="#l13.669"></a><span id="l13.669" class="difflineplus">+ * Decrypt a received message with an inbound group session</span>
<a href="#l13.670"></a><span id="l13.670" class="difflineplus">+ *</span>
<a href="#l13.671"></a><span id="l13.671" class="difflineplus">+ * @param {string} roomId    room in which the message was received</span>
<a href="#l13.672"></a><span id="l13.672" class="difflineplus">+ * @param {string} senderKey base64-encoded curve25519 key of the sender</span>
<a href="#l13.673"></a><span id="l13.673" class="difflineplus">+ * @param {string} sessionId session identifier</span>
<a href="#l13.674"></a><span id="l13.674" class="difflineplus">+ * @param {string} body      base64-encoded body of the encrypted message</span>
<a href="#l13.675"></a><span id="l13.675" class="difflineplus">+ *</span>
<a href="#l13.676"></a><span id="l13.676" class="difflineplus">+ * @return {null} the sessionId is unknown</span>
<a href="#l13.677"></a><span id="l13.677" class="difflineplus">+ *</span>
<a href="#l13.678"></a><span id="l13.678" class="difflineplus">+ * @return {{result: string, keysProved: Object&lt;string, string&gt;, keysClaimed:</span>
<a href="#l13.679"></a><span id="l13.679" class="difflineplus">+ *    Object&lt;string, string&gt;}} result</span>
<a href="#l13.680"></a><span id="l13.680" class="difflineplus">+ */</span>
<a href="#l13.681"></a><span id="l13.681" class="difflineplus">+OlmDevice.prototype.decryptGroupMessage = function(</span>
<a href="#l13.682"></a><span id="l13.682" class="difflineplus">+    roomId, senderKey, sessionId, body</span>
<a href="#l13.683"></a><span id="l13.683" class="difflineplus">+) {</span>
<a href="#l13.684"></a><span id="l13.684" class="difflineplus">+    var self = this;</span>
<a href="#l13.685"></a><span id="l13.685" class="difflineplus">+</span>
<a href="#l13.686"></a><span id="l13.686" class="difflineplus">+    function decrypt(session, keysClaimed) {</span>
<a href="#l13.687"></a><span id="l13.687" class="difflineplus">+        var res = session.decrypt(body);</span>
<a href="#l13.688"></a><span id="l13.688" class="difflineplus">+</span>
<a href="#l13.689"></a><span id="l13.689" class="difflineplus">+        var plaintext = res.plaintext;</span>
<a href="#l13.690"></a><span id="l13.690" class="difflineplus">+        if (plaintext === undefined) {</span>
<a href="#l13.691"></a><span id="l13.691" class="difflineplus">+            // Compatibility for older olm versions.</span>
<a href="#l13.692"></a><span id="l13.692" class="difflineplus">+            plaintext = res;</span>
<a href="#l13.693"></a><span id="l13.693" class="difflineplus">+        } else {</span>
<a href="#l13.694"></a><span id="l13.694" class="difflineplus">+            // Check if we have seen this message index before to detect replay attacks.</span>
<a href="#l13.695"></a><span id="l13.695" class="difflineplus">+            var messageIndexKey = senderKey + &quot;|&quot; + sessionId + &quot;|&quot; + res.message_index;</span>
<a href="#l13.696"></a><span id="l13.696" class="difflineplus">+            if (messageIndexKey in self._inboundGroupSessionMessageIndexes) {</span>
<a href="#l13.697"></a><span id="l13.697" class="difflineplus">+                throw new Error(</span>
<a href="#l13.698"></a><span id="l13.698" class="difflineplus">+                    &quot;Duplicate message index, possible replay attack: &quot; +</span>
<a href="#l13.699"></a><span id="l13.699" class="difflineplus">+                    messageIndexKey</span>
<a href="#l13.700"></a><span id="l13.700" class="difflineplus">+                );</span>
<a href="#l13.701"></a><span id="l13.701" class="difflineplus">+            }</span>
<a href="#l13.702"></a><span id="l13.702" class="difflineplus">+            self._inboundGroupSessionMessageIndexes[messageIndexKey] = true;</span>
<a href="#l13.703"></a><span id="l13.703" class="difflineplus">+        }</span>
<a href="#l13.704"></a><span id="l13.704" class="difflineplus">+</span>
<a href="#l13.705"></a><span id="l13.705" class="difflineplus">+        // the sender must have had the senderKey to persuade us to save the</span>
<a href="#l13.706"></a><span id="l13.706" class="difflineplus">+        // session.</span>
<a href="#l13.707"></a><span id="l13.707" class="difflineplus">+        var keysProved = {curve25519: senderKey};</span>
<a href="#l13.708"></a><span id="l13.708" class="difflineplus">+</span>
<a href="#l13.709"></a><span id="l13.709" class="difflineplus">+        self._saveInboundGroupSession(</span>
<a href="#l13.710"></a><span id="l13.710" class="difflineplus">+            roomId, senderKey, sessionId, session, keysClaimed</span>
<a href="#l13.711"></a><span id="l13.711" class="difflineplus">+        );</span>
<a href="#l13.712"></a><span id="l13.712" class="difflineplus">+        return {</span>
<a href="#l13.713"></a><span id="l13.713" class="difflineplus">+            result: plaintext,</span>
<a href="#l13.714"></a><span id="l13.714" class="difflineplus">+            keysClaimed: keysClaimed,</span>
<a href="#l13.715"></a><span id="l13.715" class="difflineplus">+            keysProved: keysProved,</span>
<a href="#l13.716"></a><span id="l13.716" class="difflineplus">+        };</span>
<a href="#l13.717"></a><span id="l13.717" class="difflineplus">+    }</span>
<a href="#l13.718"></a><span id="l13.718" class="difflineplus">+</span>
<a href="#l13.719"></a><span id="l13.719" class="difflineplus">+    return this._getInboundGroupSession(</span>
<a href="#l13.720"></a><span id="l13.720" class="difflineplus">+        roomId, senderKey, sessionId, decrypt</span>
<a href="#l13.721"></a><span id="l13.721" class="difflineplus">+    );</span>
<a href="#l13.722"></a><span id="l13.722" class="difflineplus">+};</span>
<a href="#l13.723"></a><span id="l13.723" class="difflineplus">+</span>
<a href="#l13.724"></a><span id="l13.724" class="difflineplus">+</span>
<a href="#l13.725"></a><span id="l13.725" class="difflineplus">+// Utilities</span>
<a href="#l13.726"></a><span id="l13.726" class="difflineplus">+// =========</span>
<a href="#l13.727"></a><span id="l13.727" class="difflineplus">+</span>
<a href="#l13.728"></a><span id="l13.728" class="difflineplus">+/**</span>
<a href="#l13.729"></a><span id="l13.729" class="difflineplus">+ * Verify an ed25519 signature.</span>
<a href="#l13.730"></a><span id="l13.730" class="difflineplus">+ *</span>
<a href="#l13.731"></a><span id="l13.731" class="difflineplus">+ * @param {string} key ed25519 key</span>
<a href="#l13.732"></a><span id="l13.732" class="difflineplus">+ * @param {string} message message which was signed</span>
<a href="#l13.733"></a><span id="l13.733" class="difflineplus">+ * @param {string} signature base64-encoded signature to be checked</span>
<a href="#l13.734"></a><span id="l13.734" class="difflineplus">+ *</span>
<a href="#l13.735"></a><span id="l13.735" class="difflineplus">+ * @raises {Error} if there is a problem with the verification. If the key was</span>
<a href="#l13.736"></a><span id="l13.736" class="difflineplus">+ * too small then the message will be &quot;OLM.INVALID_BASE64&quot;. If the signature</span>
<a href="#l13.737"></a><span id="l13.737" class="difflineplus">+ * was invalid then the message will be &quot;OLM.BAD_MESSAGE_MAC&quot;.</span>
<a href="#l13.738"></a><span id="l13.738" class="difflineplus">+ */</span>
<a href="#l13.739"></a><span id="l13.739" class="difflineplus">+OlmDevice.prototype.verifySignature = function(</span>
<a href="#l13.740"></a><span id="l13.740" class="difflineplus">+    key, message, signature</span>
<a href="#l13.741"></a><span id="l13.741" class="difflineplus">+) {</span>
<a href="#l13.742"></a><span id="l13.742" class="difflineplus">+    this._getUtility(function(util) {</span>
<a href="#l13.743"></a><span id="l13.743" class="difflineplus">+        util.ed25519_verify(key, message, signature);</span>
<a href="#l13.744"></a><span id="l13.744" class="difflineplus">+    });</span>
<a href="#l13.745"></a><span id="l13.745" class="difflineplus">+};</span>
<a href="#l13.746"></a><span id="l13.746" class="difflineplus">+</span>
<a href="#l13.747"></a><span id="l13.747" class="difflineplus">+/** */</span>
<a href="#l13.748"></a><span id="l13.748" class="difflineplus">+module.exports = OlmDevice;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1">new file mode 100644</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineminus">--- /dev/null</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineplus">+++ b/chat/protocols/matrix/matrix-sdk/crypto/algorithms/base.js</span>
<a href="#l14.4"></a><span id="l14.4" class="difflineat">@@ -0,0 +1,167 @@</span>
<a href="#l14.5"></a><span id="l14.5" class="difflineplus">+/*</span>
<a href="#l14.6"></a><span id="l14.6" class="difflineplus">+Copyright 2016 OpenMarket Ltd</span>
<a href="#l14.7"></a><span id="l14.7" class="difflineplus">+</span>
<a href="#l14.8"></a><span id="l14.8" class="difflineplus">+Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<a href="#l14.9"></a><span id="l14.9" class="difflineplus">+you may not use this file except in compliance with the License.</span>
<a href="#l14.10"></a><span id="l14.10" class="difflineplus">+You may obtain a copy of the License at</span>
<a href="#l14.11"></a><span id="l14.11" class="difflineplus">+</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineplus">+    http://www.apache.org/licenses/LICENSE-2.0</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineplus">+Unless required by applicable law or agreed to in writing, software</span>
<a href="#l14.15"></a><span id="l14.15" class="difflineplus">+distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<a href="#l14.16"></a><span id="l14.16" class="difflineplus">+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<a href="#l14.17"></a><span id="l14.17" class="difflineplus">+See the License for the specific language governing permissions and</span>
<a href="#l14.18"></a><span id="l14.18" class="difflineplus">+limitations under the License.</span>
<a href="#l14.19"></a><span id="l14.19" class="difflineplus">+*/</span>
<a href="#l14.20"></a><span id="l14.20" class="difflineplus">+&quot;use strict&quot;;</span>
<a href="#l14.21"></a><span id="l14.21" class="difflineplus">+</span>
<a href="#l14.22"></a><span id="l14.22" class="difflineplus">+/**</span>
<a href="#l14.23"></a><span id="l14.23" class="difflineplus">+ * Internal module. Defines the base classes of the encryption implementations</span>
<a href="#l14.24"></a><span id="l14.24" class="difflineplus">+ *</span>
<a href="#l14.25"></a><span id="l14.25" class="difflineplus">+ * @module crypto/algorithms/base</span>
<a href="#l14.26"></a><span id="l14.26" class="difflineplus">+ */</span>
<a href="#l14.27"></a><span id="l14.27" class="difflineplus">+var utils = require(&quot;../../utils&quot;);</span>
<a href="#l14.28"></a><span id="l14.28" class="difflineplus">+</span>
<a href="#l14.29"></a><span id="l14.29" class="difflineplus">+/**</span>
<a href="#l14.30"></a><span id="l14.30" class="difflineplus">+ * map of registered encryption algorithm classes. A map from string to {@link</span>
<a href="#l14.31"></a><span id="l14.31" class="difflineplus">+ * module:crypto/algorithms/base.EncryptionAlgorithm|EncryptionAlgorithm} class</span>
<a href="#l14.32"></a><span id="l14.32" class="difflineplus">+ *</span>
<a href="#l14.33"></a><span id="l14.33" class="difflineplus">+ * @type {Object.&lt;string, function(new: module:crypto/algorithms/base.EncryptionAlgorithm)&gt;}</span>
<a href="#l14.34"></a><span id="l14.34" class="difflineplus">+ */</span>
<a href="#l14.35"></a><span id="l14.35" class="difflineplus">+module.exports.ENCRYPTION_CLASSES = {};</span>
<a href="#l14.36"></a><span id="l14.36" class="difflineplus">+</span>
<a href="#l14.37"></a><span id="l14.37" class="difflineplus">+/**</span>
<a href="#l14.38"></a><span id="l14.38" class="difflineplus">+ * map of registered encryption algorithm classes. Map from string to {@link</span>
<a href="#l14.39"></a><span id="l14.39" class="difflineplus">+ * module:crypto/algorithms/base.DecryptionAlgorithm|DecryptionAlgorithm} class</span>
<a href="#l14.40"></a><span id="l14.40" class="difflineplus">+ *</span>
<a href="#l14.41"></a><span id="l14.41" class="difflineplus">+ * @type {Object.&lt;string, function(new: module:crypto/algorithms/base.DecryptionAlgorithm)&gt;}</span>
<a href="#l14.42"></a><span id="l14.42" class="difflineplus">+ */</span>
<a href="#l14.43"></a><span id="l14.43" class="difflineplus">+module.exports.DECRYPTION_CLASSES = {};</span>
<a href="#l14.44"></a><span id="l14.44" class="difflineplus">+</span>
<a href="#l14.45"></a><span id="l14.45" class="difflineplus">+/**</span>
<a href="#l14.46"></a><span id="l14.46" class="difflineplus">+ * base type for encryption implementations</span>
<a href="#l14.47"></a><span id="l14.47" class="difflineplus">+ *</span>
<a href="#l14.48"></a><span id="l14.48" class="difflineplus">+ * @constructor</span>
<a href="#l14.49"></a><span id="l14.49" class="difflineplus">+ * @alias module:crypto/algorithms/base.EncryptionAlgorithm</span>
<a href="#l14.50"></a><span id="l14.50" class="difflineplus">+ *</span>
<a href="#l14.51"></a><span id="l14.51" class="difflineplus">+ * @param {object} params parameters</span>
<a href="#l14.52"></a><span id="l14.52" class="difflineplus">+ * @param {string} params.userId  The UserID for the local user</span>
<a href="#l14.53"></a><span id="l14.53" class="difflineplus">+ * @param {string} params.deviceId The identifier for this device.</span>
<a href="#l14.54"></a><span id="l14.54" class="difflineplus">+ * @param {module:crypto} params.crypto crypto core</span>
<a href="#l14.55"></a><span id="l14.55" class="difflineplus">+ * @param {module:crypto/OlmDevice} params.olmDevice olm.js wrapper</span>
<a href="#l14.56"></a><span id="l14.56" class="difflineplus">+ * @param {module:base-apis~MatrixBaseApis} baseApis base matrix api interface</span>
<a href="#l14.57"></a><span id="l14.57" class="difflineplus">+ * @param {string} params.roomId  The ID of the room we will be sending to</span>
<a href="#l14.58"></a><span id="l14.58" class="difflineplus">+ * @param {object} params.config  The body of the m.room.encryption event</span>
<a href="#l14.59"></a><span id="l14.59" class="difflineplus">+ */</span>
<a href="#l14.60"></a><span id="l14.60" class="difflineplus">+var EncryptionAlgorithm = function(params) {</span>
<a href="#l14.61"></a><span id="l14.61" class="difflineplus">+    this._userId = params.userId;</span>
<a href="#l14.62"></a><span id="l14.62" class="difflineplus">+    this._deviceId = params.deviceId;</span>
<a href="#l14.63"></a><span id="l14.63" class="difflineplus">+    this._crypto = params.crypto;</span>
<a href="#l14.64"></a><span id="l14.64" class="difflineplus">+    this._olmDevice = params.olmDevice;</span>
<a href="#l14.65"></a><span id="l14.65" class="difflineplus">+    this._baseApis = params.baseApis;</span>
<a href="#l14.66"></a><span id="l14.66" class="difflineplus">+    this._roomId = params.roomId;</span>
<a href="#l14.67"></a><span id="l14.67" class="difflineplus">+};</span>
<a href="#l14.68"></a><span id="l14.68" class="difflineplus">+/** */</span>
<a href="#l14.69"></a><span id="l14.69" class="difflineplus">+module.exports.EncryptionAlgorithm = EncryptionAlgorithm;</span>
<a href="#l14.70"></a><span id="l14.70" class="difflineplus">+</span>
<a href="#l14.71"></a><span id="l14.71" class="difflineplus">+/**</span>
<a href="#l14.72"></a><span id="l14.72" class="difflineplus">+ * Encrypt a message event</span>
<a href="#l14.73"></a><span id="l14.73" class="difflineplus">+ *</span>
<a href="#l14.74"></a><span id="l14.74" class="difflineplus">+ * @method module:crypto/algorithms/base.EncryptionAlgorithm#encryptMessage</span>
<a href="#l14.75"></a><span id="l14.75" class="difflineplus">+ * @abstract</span>
<a href="#l14.76"></a><span id="l14.76" class="difflineplus">+ *</span>
<a href="#l14.77"></a><span id="l14.77" class="difflineplus">+ * @param {module:models/room} room</span>
<a href="#l14.78"></a><span id="l14.78" class="difflineplus">+ * @param {string} eventType</span>
<a href="#l14.79"></a><span id="l14.79" class="difflineplus">+ * @param {object} plaintext event content</span>
<a href="#l14.80"></a><span id="l14.80" class="difflineplus">+ *</span>
<a href="#l14.81"></a><span id="l14.81" class="difflineplus">+ * @return {module:client.Promise} Promise which resolves to the new event body</span>
<a href="#l14.82"></a><span id="l14.82" class="difflineplus">+ */</span>
<a href="#l14.83"></a><span id="l14.83" class="difflineplus">+</span>
<a href="#l14.84"></a><span id="l14.84" class="difflineplus">+/**</span>
<a href="#l14.85"></a><span id="l14.85" class="difflineplus">+ * Called when the membership of a member of the room changes.</span>
<a href="#l14.86"></a><span id="l14.86" class="difflineplus">+ *</span>
<a href="#l14.87"></a><span id="l14.87" class="difflineplus">+ * @param {module:models/event.MatrixEvent} event  event causing the change</span>
<a href="#l14.88"></a><span id="l14.88" class="difflineplus">+ * @param {module:models/room-member} member  user whose membership changed</span>
<a href="#l14.89"></a><span id="l14.89" class="difflineplus">+ * @param {string=} oldMembership  previous membership</span>
<a href="#l14.90"></a><span id="l14.90" class="difflineplus">+ */</span>
<a href="#l14.91"></a><span id="l14.91" class="difflineplus">+EncryptionAlgorithm.prototype.onRoomMembership = function(</span>
<a href="#l14.92"></a><span id="l14.92" class="difflineplus">+    event, member, oldMembership</span>
<a href="#l14.93"></a><span id="l14.93" class="difflineplus">+) {};</span>
<a href="#l14.94"></a><span id="l14.94" class="difflineplus">+</span>
<a href="#l14.95"></a><span id="l14.95" class="difflineplus">+/**</span>
<a href="#l14.96"></a><span id="l14.96" class="difflineplus">+ * base type for decryption implementations</span>
<a href="#l14.97"></a><span id="l14.97" class="difflineplus">+ *</span>
<a href="#l14.98"></a><span id="l14.98" class="difflineplus">+ * @constructor</span>
<a href="#l14.99"></a><span id="l14.99" class="difflineplus">+ * @alias module:crypto/algorithms/base.DecryptionAlgorithm</span>
<a href="#l14.100"></a><span id="l14.100" class="difflineplus">+ *</span>
<a href="#l14.101"></a><span id="l14.101" class="difflineplus">+ * @param {object} params parameters</span>
<a href="#l14.102"></a><span id="l14.102" class="difflineplus">+ * @param {string} params.userId  The UserID for the local user</span>
<a href="#l14.103"></a><span id="l14.103" class="difflineplus">+ * @param {module:crypto} params.crypto crypto core</span>
<a href="#l14.104"></a><span id="l14.104" class="difflineplus">+ * @param {module:crypto/OlmDevice} params.olmDevice olm.js wrapper</span>
<a href="#l14.105"></a><span id="l14.105" class="difflineplus">+ * @param {string=} params.roomId The ID of the room we will be receiving</span>
<a href="#l14.106"></a><span id="l14.106" class="difflineplus">+ *     from. Null for to-device events.</span>
<a href="#l14.107"></a><span id="l14.107" class="difflineplus">+ */</span>
<a href="#l14.108"></a><span id="l14.108" class="difflineplus">+var DecryptionAlgorithm = function(params) {</span>
<a href="#l14.109"></a><span id="l14.109" class="difflineplus">+    this._userId = params.userId;</span>
<a href="#l14.110"></a><span id="l14.110" class="difflineplus">+    this._crypto = params.crypto;</span>
<a href="#l14.111"></a><span id="l14.111" class="difflineplus">+    this._olmDevice = params.olmDevice;</span>
<a href="#l14.112"></a><span id="l14.112" class="difflineplus">+    this._roomId = params.roomId;</span>
<a href="#l14.113"></a><span id="l14.113" class="difflineplus">+};</span>
<a href="#l14.114"></a><span id="l14.114" class="difflineplus">+/** */</span>
<a href="#l14.115"></a><span id="l14.115" class="difflineplus">+module.exports.DecryptionAlgorithm = DecryptionAlgorithm;</span>
<a href="#l14.116"></a><span id="l14.116" class="difflineplus">+</span>
<a href="#l14.117"></a><span id="l14.117" class="difflineplus">+/**</span>
<a href="#l14.118"></a><span id="l14.118" class="difflineplus">+ * Decrypt an event</span>
<a href="#l14.119"></a><span id="l14.119" class="difflineplus">+ *</span>
<a href="#l14.120"></a><span id="l14.120" class="difflineplus">+ * @method module:crypto/algorithms/base.DecryptionAlgorithm#decryptEvent</span>
<a href="#l14.121"></a><span id="l14.121" class="difflineplus">+ * @abstract</span>
<a href="#l14.122"></a><span id="l14.122" class="difflineplus">+ *</span>
<a href="#l14.123"></a><span id="l14.123" class="difflineplus">+ * @param {object} event raw event</span>
<a href="#l14.124"></a><span id="l14.124" class="difflineplus">+ *</span>
<a href="#l14.125"></a><span id="l14.125" class="difflineplus">+ * @return {null} if the event referred to an unknown megolm session</span>
<a href="#l14.126"></a><span id="l14.126" class="difflineplus">+ * @return {module:crypto.DecryptionResult} decryption result</span>
<a href="#l14.127"></a><span id="l14.127" class="difflineplus">+ *</span>
<a href="#l14.128"></a><span id="l14.128" class="difflineplus">+ * @throws {module:crypto/algorithms/base.DecryptionError} if there is a</span>
<a href="#l14.129"></a><span id="l14.129" class="difflineplus">+ *   problem decrypting the event</span>
<a href="#l14.130"></a><span id="l14.130" class="difflineplus">+ */</span>
<a href="#l14.131"></a><span id="l14.131" class="difflineplus">+</span>
<a href="#l14.132"></a><span id="l14.132" class="difflineplus">+/**</span>
<a href="#l14.133"></a><span id="l14.133" class="difflineplus">+ * Handle a key event</span>
<a href="#l14.134"></a><span id="l14.134" class="difflineplus">+ *</span>
<a href="#l14.135"></a><span id="l14.135" class="difflineplus">+ * @method module:crypto/algorithms/base.DecryptionAlgorithm#onRoomKeyEvent</span>
<a href="#l14.136"></a><span id="l14.136" class="difflineplus">+ *</span>
<a href="#l14.137"></a><span id="l14.137" class="difflineplus">+ * @param {module:models/event.MatrixEvent} event key event</span>
<a href="#l14.138"></a><span id="l14.138" class="difflineplus">+ */</span>
<a href="#l14.139"></a><span id="l14.139" class="difflineplus">+DecryptionAlgorithm.prototype.onRoomKeyEvent = function(params) {</span>
<a href="#l14.140"></a><span id="l14.140" class="difflineplus">+    // ignore by default</span>
<a href="#l14.141"></a><span id="l14.141" class="difflineplus">+};</span>
<a href="#l14.142"></a><span id="l14.142" class="difflineplus">+</span>
<a href="#l14.143"></a><span id="l14.143" class="difflineplus">+/**</span>
<a href="#l14.144"></a><span id="l14.144" class="difflineplus">+ * Exception thrown when decryption fails</span>
<a href="#l14.145"></a><span id="l14.145" class="difflineplus">+ *</span>
<a href="#l14.146"></a><span id="l14.146" class="difflineplus">+ * @constructor</span>
<a href="#l14.147"></a><span id="l14.147" class="difflineplus">+ * @param {string} msg message describing the problem</span>
<a href="#l14.148"></a><span id="l14.148" class="difflineplus">+ * @extends Error</span>
<a href="#l14.149"></a><span id="l14.149" class="difflineplus">+ */</span>
<a href="#l14.150"></a><span id="l14.150" class="difflineplus">+module.exports.DecryptionError = function(msg) {</span>
<a href="#l14.151"></a><span id="l14.151" class="difflineplus">+    this.message = msg;</span>
<a href="#l14.152"></a><span id="l14.152" class="difflineplus">+};</span>
<a href="#l14.153"></a><span id="l14.153" class="difflineplus">+utils.inherits(module.exports.DecryptionError, Error);</span>
<a href="#l14.154"></a><span id="l14.154" class="difflineplus">+</span>
<a href="#l14.155"></a><span id="l14.155" class="difflineplus">+/**</span>
<a href="#l14.156"></a><span id="l14.156" class="difflineplus">+ * Registers an encryption/decryption class for a particular algorithm</span>
<a href="#l14.157"></a><span id="l14.157" class="difflineplus">+ *</span>
<a href="#l14.158"></a><span id="l14.158" class="difflineplus">+ * @param {string} algorithm algorithm tag to register for</span>
<a href="#l14.159"></a><span id="l14.159" class="difflineplus">+ *</span>
<a href="#l14.160"></a><span id="l14.160" class="difflineplus">+ * @param {class} encryptor {@link</span>
<a href="#l14.161"></a><span id="l14.161" class="difflineplus">+ *     module:crypto/algorithms/base.EncryptionAlgorithm|EncryptionAlgorithm}</span>
<a href="#l14.162"></a><span id="l14.162" class="difflineplus">+ *     implementation</span>
<a href="#l14.163"></a><span id="l14.163" class="difflineplus">+ *</span>
<a href="#l14.164"></a><span id="l14.164" class="difflineplus">+ * @param {class} decryptor {@link</span>
<a href="#l14.165"></a><span id="l14.165" class="difflineplus">+ *     module:crypto/algorithms/base.DecryptionAlgorithm|DecryptionAlgorithm}</span>
<a href="#l14.166"></a><span id="l14.166" class="difflineplus">+ *     implementation</span>
<a href="#l14.167"></a><span id="l14.167" class="difflineplus">+ */</span>
<a href="#l14.168"></a><span id="l14.168" class="difflineplus">+module.exports.registerAlgorithm = function(algorithm, encryptor, decryptor) {</span>
<a href="#l14.169"></a><span id="l14.169" class="difflineplus">+    module.exports.ENCRYPTION_CLASSES[algorithm] = encryptor;</span>
<a href="#l14.170"></a><span id="l14.170" class="difflineplus">+    module.exports.DECRYPTION_CLASSES[algorithm] = decryptor;</span>
<a href="#l14.171"></a><span id="l14.171" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1">new file mode 100644</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineminus">--- /dev/null</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineplus">+++ b/chat/protocols/matrix/matrix-sdk/crypto/algorithms/index.js</span>
<a href="#l15.4"></a><span id="l15.4" class="difflineat">@@ -0,0 +1,40 @@</span>
<a href="#l15.5"></a><span id="l15.5" class="difflineplus">+/*</span>
<a href="#l15.6"></a><span id="l15.6" class="difflineplus">+Copyright 2016 OpenMarket Ltd</span>
<a href="#l15.7"></a><span id="l15.7" class="difflineplus">+</span>
<a href="#l15.8"></a><span id="l15.8" class="difflineplus">+Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<a href="#l15.9"></a><span id="l15.9" class="difflineplus">+you may not use this file except in compliance with the License.</span>
<a href="#l15.10"></a><span id="l15.10" class="difflineplus">+You may obtain a copy of the License at</span>
<a href="#l15.11"></a><span id="l15.11" class="difflineplus">+</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineplus">+    http://www.apache.org/licenses/LICENSE-2.0</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineplus">+</span>
<a href="#l15.14"></a><span id="l15.14" class="difflineplus">+Unless required by applicable law or agreed to in writing, software</span>
<a href="#l15.15"></a><span id="l15.15" class="difflineplus">+distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<a href="#l15.16"></a><span id="l15.16" class="difflineplus">+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<a href="#l15.17"></a><span id="l15.17" class="difflineplus">+See the License for the specific language governing permissions and</span>
<a href="#l15.18"></a><span id="l15.18" class="difflineplus">+limitations under the License.</span>
<a href="#l15.19"></a><span id="l15.19" class="difflineplus">+*/</span>
<a href="#l15.20"></a><span id="l15.20" class="difflineplus">+&quot;use strict&quot;;</span>
<a href="#l15.21"></a><span id="l15.21" class="difflineplus">+</span>
<a href="#l15.22"></a><span id="l15.22" class="difflineplus">+/**</span>
<a href="#l15.23"></a><span id="l15.23" class="difflineplus">+ * @module crypto/algorithms</span>
<a href="#l15.24"></a><span id="l15.24" class="difflineplus">+ */</span>
<a href="#l15.25"></a><span id="l15.25" class="difflineplus">+</span>
<a href="#l15.26"></a><span id="l15.26" class="difflineplus">+var base = require(&quot;./base&quot;);</span>
<a href="#l15.27"></a><span id="l15.27" class="difflineplus">+</span>
<a href="#l15.28"></a><span id="l15.28" class="difflineplus">+require(&quot;./olm&quot;);</span>
<a href="#l15.29"></a><span id="l15.29" class="difflineplus">+require(&quot;./megolm&quot;);</span>
<a href="#l15.30"></a><span id="l15.30" class="difflineplus">+</span>
<a href="#l15.31"></a><span id="l15.31" class="difflineplus">+/**</span>
<a href="#l15.32"></a><span id="l15.32" class="difflineplus">+ * @see module:crypto/algorithms/base.ENCRYPTION_CLASSES</span>
<a href="#l15.33"></a><span id="l15.33" class="difflineplus">+ */</span>
<a href="#l15.34"></a><span id="l15.34" class="difflineplus">+module.exports.ENCRYPTION_CLASSES = base.ENCRYPTION_CLASSES;</span>
<a href="#l15.35"></a><span id="l15.35" class="difflineplus">+</span>
<a href="#l15.36"></a><span id="l15.36" class="difflineplus">+/**</span>
<a href="#l15.37"></a><span id="l15.37" class="difflineplus">+ * @see module:crypto/algorithms/base.DECRYPTION_CLASSES</span>
<a href="#l15.38"></a><span id="l15.38" class="difflineplus">+ */</span>
<a href="#l15.39"></a><span id="l15.39" class="difflineplus">+module.exports.DECRYPTION_CLASSES = base.DECRYPTION_CLASSES;</span>
<a href="#l15.40"></a><span id="l15.40" class="difflineplus">+</span>
<a href="#l15.41"></a><span id="l15.41" class="difflineplus">+/**</span>
<a href="#l15.42"></a><span id="l15.42" class="difflineplus">+ * @see module:crypto/algorithms/base.DecryptionError</span>
<a href="#l15.43"></a><span id="l15.43" class="difflineplus">+ */</span>
<a href="#l15.44"></a><span id="l15.44" class="difflineplus">+module.exports.DecryptionError = base.DecryptionError;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1">new file mode 100644</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineminus">--- /dev/null</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineplus">+++ b/chat/protocols/matrix/matrix-sdk/crypto/algorithms/megolm.js</span>
<a href="#l16.4"></a><span id="l16.4" class="difflineat">@@ -0,0 +1,537 @@</span>
<a href="#l16.5"></a><span id="l16.5" class="difflineplus">+/*</span>
<a href="#l16.6"></a><span id="l16.6" class="difflineplus">+Copyright 2015, 2016 OpenMarket Ltd</span>
<a href="#l16.7"></a><span id="l16.7" class="difflineplus">+</span>
<a href="#l16.8"></a><span id="l16.8" class="difflineplus">+Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<a href="#l16.9"></a><span id="l16.9" class="difflineplus">+you may not use this file except in compliance with the License.</span>
<a href="#l16.10"></a><span id="l16.10" class="difflineplus">+You may obtain a copy of the License at</span>
<a href="#l16.11"></a><span id="l16.11" class="difflineplus">+</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineplus">+    http://www.apache.org/licenses/LICENSE-2.0</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineplus">+</span>
<a href="#l16.14"></a><span id="l16.14" class="difflineplus">+Unless required by applicable law or agreed to in writing, software</span>
<a href="#l16.15"></a><span id="l16.15" class="difflineplus">+distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<a href="#l16.16"></a><span id="l16.16" class="difflineplus">+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<a href="#l16.17"></a><span id="l16.17" class="difflineplus">+See the License for the specific language governing permissions and</span>
<a href="#l16.18"></a><span id="l16.18" class="difflineplus">+limitations under the License.</span>
<a href="#l16.19"></a><span id="l16.19" class="difflineplus">+*/</span>
<a href="#l16.20"></a><span id="l16.20" class="difflineplus">+&quot;use strict&quot;;</span>
<a href="#l16.21"></a><span id="l16.21" class="difflineplus">+</span>
<a href="#l16.22"></a><span id="l16.22" class="difflineplus">+/**</span>
<a href="#l16.23"></a><span id="l16.23" class="difflineplus">+ * Defines m.olm encryption/decryption</span>
<a href="#l16.24"></a><span id="l16.24" class="difflineplus">+ *</span>
<a href="#l16.25"></a><span id="l16.25" class="difflineplus">+ * @module crypto/algorithms/megolm</span>
<a href="#l16.26"></a><span id="l16.26" class="difflineplus">+ */</span>
<a href="#l16.27"></a><span id="l16.27" class="difflineplus">+</span>
<a href="#l16.28"></a><span id="l16.28" class="difflineplus">+var q = require(&quot;q&quot;);</span>
<a href="#l16.29"></a><span id="l16.29" class="difflineplus">+</span>
<a href="#l16.30"></a><span id="l16.30" class="difflineplus">+var utils = require(&quot;../../utils&quot;);</span>
<a href="#l16.31"></a><span id="l16.31" class="difflineplus">+var olmlib = require(&quot;../olmlib&quot;);</span>
<a href="#l16.32"></a><span id="l16.32" class="difflineplus">+var base = require(&quot;./base&quot;);</span>
<a href="#l16.33"></a><span id="l16.33" class="difflineplus">+</span>
<a href="#l16.34"></a><span id="l16.34" class="difflineplus">+/**</span>
<a href="#l16.35"></a><span id="l16.35" class="difflineplus">+ * @private</span>
<a href="#l16.36"></a><span id="l16.36" class="difflineplus">+ * @constructor</span>
<a href="#l16.37"></a><span id="l16.37" class="difflineplus">+ *</span>
<a href="#l16.38"></a><span id="l16.38" class="difflineplus">+ * @param {string} sessionId</span>
<a href="#l16.39"></a><span id="l16.39" class="difflineplus">+ *</span>
<a href="#l16.40"></a><span id="l16.40" class="difflineplus">+ * @property {string} sessionId</span>
<a href="#l16.41"></a><span id="l16.41" class="difflineplus">+ * @property {Number} useCount     number of times this session has been used</span>
<a href="#l16.42"></a><span id="l16.42" class="difflineplus">+ * @property {Number} creationTime when the session was created (ms since the epoch)</span>
<a href="#l16.43"></a><span id="l16.43" class="difflineplus">+ * @property {module:client.Promise?} sharePromise  If a share operation is in progress,</span>
<a href="#l16.44"></a><span id="l16.44" class="difflineplus">+ *    a promise which resolves when it is complete.</span>
<a href="#l16.45"></a><span id="l16.45" class="difflineplus">+ *</span>
<a href="#l16.46"></a><span id="l16.46" class="difflineplus">+ * @property {object} sharedWithDevices</span>
<a href="#l16.47"></a><span id="l16.47" class="difflineplus">+ *    devices with which we have shared the session key</span>
<a href="#l16.48"></a><span id="l16.48" class="difflineplus">+ *        userId -&gt; {deviceId -&gt; msgindex}</span>
<a href="#l16.49"></a><span id="l16.49" class="difflineplus">+ */</span>
<a href="#l16.50"></a><span id="l16.50" class="difflineplus">+function OutboundSessionInfo(sessionId) {</span>
<a href="#l16.51"></a><span id="l16.51" class="difflineplus">+    this.sessionId = sessionId;</span>
<a href="#l16.52"></a><span id="l16.52" class="difflineplus">+    this.useCount = 0;</span>
<a href="#l16.53"></a><span id="l16.53" class="difflineplus">+    this.creationTime = new Date().getTime();</span>
<a href="#l16.54"></a><span id="l16.54" class="difflineplus">+    this.sharePromise = null;</span>
<a href="#l16.55"></a><span id="l16.55" class="difflineplus">+    this.sharedWithDevices = {};</span>
<a href="#l16.56"></a><span id="l16.56" class="difflineplus">+}</span>
<a href="#l16.57"></a><span id="l16.57" class="difflineplus">+</span>
<a href="#l16.58"></a><span id="l16.58" class="difflineplus">+</span>
<a href="#l16.59"></a><span id="l16.59" class="difflineplus">+/**</span>
<a href="#l16.60"></a><span id="l16.60" class="difflineplus">+ * Check if it's time to rotate the session</span>
<a href="#l16.61"></a><span id="l16.61" class="difflineplus">+ *</span>
<a href="#l16.62"></a><span id="l16.62" class="difflineplus">+ * @param {Number} rotationPeriodMsgs</span>
<a href="#l16.63"></a><span id="l16.63" class="difflineplus">+ * @param {Number} rotationPeriodMs</span>
<a href="#l16.64"></a><span id="l16.64" class="difflineplus">+ * @return {Boolean}</span>
<a href="#l16.65"></a><span id="l16.65" class="difflineplus">+ */</span>
<a href="#l16.66"></a><span id="l16.66" class="difflineplus">+OutboundSessionInfo.prototype.needsRotation = function(</span>
<a href="#l16.67"></a><span id="l16.67" class="difflineplus">+    rotationPeriodMsgs, rotationPeriodMs</span>
<a href="#l16.68"></a><span id="l16.68" class="difflineplus">+) {</span>
<a href="#l16.69"></a><span id="l16.69" class="difflineplus">+    var sessionLifetime = new Date().getTime() - this.creationTime;</span>
<a href="#l16.70"></a><span id="l16.70" class="difflineplus">+</span>
<a href="#l16.71"></a><span id="l16.71" class="difflineplus">+    if (this.useCount &gt;= rotationPeriodMsgs ||</span>
<a href="#l16.72"></a><span id="l16.72" class="difflineplus">+        sessionLifetime &gt;= rotationPeriodMs</span>
<a href="#l16.73"></a><span id="l16.73" class="difflineplus">+       ) {</span>
<a href="#l16.74"></a><span id="l16.74" class="difflineplus">+        console.log(</span>
<a href="#l16.75"></a><span id="l16.75" class="difflineplus">+            &quot;Rotating megolm session after &quot; + this.useCount +</span>
<a href="#l16.76"></a><span id="l16.76" class="difflineplus">+                &quot; messages, &quot; + sessionLifetime + &quot;ms&quot;</span>
<a href="#l16.77"></a><span id="l16.77" class="difflineplus">+        );</span>
<a href="#l16.78"></a><span id="l16.78" class="difflineplus">+        return true;</span>
<a href="#l16.79"></a><span id="l16.79" class="difflineplus">+    }</span>
<a href="#l16.80"></a><span id="l16.80" class="difflineplus">+</span>
<a href="#l16.81"></a><span id="l16.81" class="difflineplus">+    return false;</span>
<a href="#l16.82"></a><span id="l16.82" class="difflineplus">+};</span>
<a href="#l16.83"></a><span id="l16.83" class="difflineplus">+</span>
<a href="#l16.84"></a><span id="l16.84" class="difflineplus">+</span>
<a href="#l16.85"></a><span id="l16.85" class="difflineplus">+/**</span>
<a href="#l16.86"></a><span id="l16.86" class="difflineplus">+ * Megolm encryption implementation</span>
<a href="#l16.87"></a><span id="l16.87" class="difflineplus">+ *</span>
<a href="#l16.88"></a><span id="l16.88" class="difflineplus">+ * @constructor</span>
<a href="#l16.89"></a><span id="l16.89" class="difflineplus">+ * @extends {module:crypto/algorithms/base.EncryptionAlgorithm}</span>
<a href="#l16.90"></a><span id="l16.90" class="difflineplus">+ *</span>
<a href="#l16.91"></a><span id="l16.91" class="difflineplus">+ * @param {object} params parameters, as per</span>
<a href="#l16.92"></a><span id="l16.92" class="difflineplus">+ *     {@link module:crypto/algorithms/base.EncryptionAlgorithm}</span>
<a href="#l16.93"></a><span id="l16.93" class="difflineplus">+ */</span>
<a href="#l16.94"></a><span id="l16.94" class="difflineplus">+function MegolmEncryption(params) {</span>
<a href="#l16.95"></a><span id="l16.95" class="difflineplus">+    base.EncryptionAlgorithm.call(this, params);</span>
<a href="#l16.96"></a><span id="l16.96" class="difflineplus">+</span>
<a href="#l16.97"></a><span id="l16.97" class="difflineplus">+    // OutboundSessionInfo. Null if we haven't yet started setting one up. Note</span>
<a href="#l16.98"></a><span id="l16.98" class="difflineplus">+    // that even if this is non-null, it may not be ready for use (in which</span>
<a href="#l16.99"></a><span id="l16.99" class="difflineplus">+    // case _outboundSession.sharePromise will be non-null.)</span>
<a href="#l16.100"></a><span id="l16.100" class="difflineplus">+    this._outboundSession = null;</span>
<a href="#l16.101"></a><span id="l16.101" class="difflineplus">+</span>
<a href="#l16.102"></a><span id="l16.102" class="difflineplus">+    // default rotation periods</span>
<a href="#l16.103"></a><span id="l16.103" class="difflineplus">+    this._sessionRotationPeriodMsgs = 100;</span>
<a href="#l16.104"></a><span id="l16.104" class="difflineplus">+    this._sessionRotationPeriodMs = 7 * 24 * 3600 * 1000;</span>
<a href="#l16.105"></a><span id="l16.105" class="difflineplus">+</span>
<a href="#l16.106"></a><span id="l16.106" class="difflineplus">+    if (params.config.rotation_period_ms !== undefined) {</span>
<a href="#l16.107"></a><span id="l16.107" class="difflineplus">+        this._sessionRotationPeriodMs = params.config.rotation_period_ms;</span>
<a href="#l16.108"></a><span id="l16.108" class="difflineplus">+    }</span>
<a href="#l16.109"></a><span id="l16.109" class="difflineplus">+</span>
<a href="#l16.110"></a><span id="l16.110" class="difflineplus">+    if (params.config.rotation_period_msgs !== undefined) {</span>
<a href="#l16.111"></a><span id="l16.111" class="difflineplus">+        this._sessionRotationPeriodMsgs = params.config.rotation_period_msgs;</span>
<a href="#l16.112"></a><span id="l16.112" class="difflineplus">+    }</span>
<a href="#l16.113"></a><span id="l16.113" class="difflineplus">+}</span>
<a href="#l16.114"></a><span id="l16.114" class="difflineplus">+utils.inherits(MegolmEncryption, base.EncryptionAlgorithm);</span>
<a href="#l16.115"></a><span id="l16.115" class="difflineplus">+</span>
<a href="#l16.116"></a><span id="l16.116" class="difflineplus">+/**</span>
<a href="#l16.117"></a><span id="l16.117" class="difflineplus">+ * @private</span>
<a href="#l16.118"></a><span id="l16.118" class="difflineplus">+ *</span>
<a href="#l16.119"></a><span id="l16.119" class="difflineplus">+ * @param {module:models/room} room</span>
<a href="#l16.120"></a><span id="l16.120" class="difflineplus">+ *</span>
<a href="#l16.121"></a><span id="l16.121" class="difflineplus">+ * @return {module:client.Promise} Promise which resolves to the</span>
<a href="#l16.122"></a><span id="l16.122" class="difflineplus">+ *    OutboundSessionInfo when setup is complete.</span>
<a href="#l16.123"></a><span id="l16.123" class="difflineplus">+ */</span>
<a href="#l16.124"></a><span id="l16.124" class="difflineplus">+MegolmEncryption.prototype._ensureOutboundSession = function(room) {</span>
<a href="#l16.125"></a><span id="l16.125" class="difflineplus">+    var self = this;</span>
<a href="#l16.126"></a><span id="l16.126" class="difflineplus">+</span>
<a href="#l16.127"></a><span id="l16.127" class="difflineplus">+    var session = this._outboundSession;</span>
<a href="#l16.128"></a><span id="l16.128" class="difflineplus">+</span>
<a href="#l16.129"></a><span id="l16.129" class="difflineplus">+    // need to make a brand new session?</span>
<a href="#l16.130"></a><span id="l16.130" class="difflineplus">+    if (!session || session.needsRotation(self._sessionRotationPeriodMsgs,</span>
<a href="#l16.131"></a><span id="l16.131" class="difflineplus">+                                          self._sessionRotationPeriodMs)</span>
<a href="#l16.132"></a><span id="l16.132" class="difflineplus">+       ) {</span>
<a href="#l16.133"></a><span id="l16.133" class="difflineplus">+        this._outboundSession = session = this._prepareNewSession(room);</span>
<a href="#l16.134"></a><span id="l16.134" class="difflineplus">+    }</span>
<a href="#l16.135"></a><span id="l16.135" class="difflineplus">+</span>
<a href="#l16.136"></a><span id="l16.136" class="difflineplus">+    if (session.sharePromise) {</span>
<a href="#l16.137"></a><span id="l16.137" class="difflineplus">+        // key share already in progress</span>
<a href="#l16.138"></a><span id="l16.138" class="difflineplus">+        return session.sharePromise;</span>
<a href="#l16.139"></a><span id="l16.139" class="difflineplus">+    }</span>
<a href="#l16.140"></a><span id="l16.140" class="difflineplus">+</span>
<a href="#l16.141"></a><span id="l16.141" class="difflineplus">+    // no share in progress: check if we need to share with any devices</span>
<a href="#l16.142"></a><span id="l16.142" class="difflineplus">+    var prom = this._getDevicesInRoom(room).then(function(devicesInRoom) {</span>
<a href="#l16.143"></a><span id="l16.143" class="difflineplus">+        var shareMap = {};</span>
<a href="#l16.144"></a><span id="l16.144" class="difflineplus">+</span>
<a href="#l16.145"></a><span id="l16.145" class="difflineplus">+        for (var userId in devicesInRoom) {</span>
<a href="#l16.146"></a><span id="l16.146" class="difflineplus">+            if (!devicesInRoom.hasOwnProperty(userId)) {</span>
<a href="#l16.147"></a><span id="l16.147" class="difflineplus">+                continue;</span>
<a href="#l16.148"></a><span id="l16.148" class="difflineplus">+            }</span>
<a href="#l16.149"></a><span id="l16.149" class="difflineplus">+</span>
<a href="#l16.150"></a><span id="l16.150" class="difflineplus">+            var userDevices = devicesInRoom[userId];</span>
<a href="#l16.151"></a><span id="l16.151" class="difflineplus">+</span>
<a href="#l16.152"></a><span id="l16.152" class="difflineplus">+            for (var deviceId in userDevices) {</span>
<a href="#l16.153"></a><span id="l16.153" class="difflineplus">+                if (!userDevices.hasOwnProperty(deviceId)) {</span>
<a href="#l16.154"></a><span id="l16.154" class="difflineplus">+                    continue;</span>
<a href="#l16.155"></a><span id="l16.155" class="difflineplus">+                }</span>
<a href="#l16.156"></a><span id="l16.156" class="difflineplus">+</span>
<a href="#l16.157"></a><span id="l16.157" class="difflineplus">+                var deviceInfo = userDevices[deviceId];</span>
<a href="#l16.158"></a><span id="l16.158" class="difflineplus">+</span>
<a href="#l16.159"></a><span id="l16.159" class="difflineplus">+                if (deviceInfo.isBlocked()) {</span>
<a href="#l16.160"></a><span id="l16.160" class="difflineplus">+                    continue;</span>
<a href="#l16.161"></a><span id="l16.161" class="difflineplus">+                }</span>
<a href="#l16.162"></a><span id="l16.162" class="difflineplus">+</span>
<a href="#l16.163"></a><span id="l16.163" class="difflineplus">+                var key = deviceInfo.getIdentityKey();</span>
<a href="#l16.164"></a><span id="l16.164" class="difflineplus">+                if (key == self._olmDevice.deviceCurve25519Key) {</span>
<a href="#l16.165"></a><span id="l16.165" class="difflineplus">+                    // don't bother sending to ourself</span>
<a href="#l16.166"></a><span id="l16.166" class="difflineplus">+                    continue;</span>
<a href="#l16.167"></a><span id="l16.167" class="difflineplus">+                }</span>
<a href="#l16.168"></a><span id="l16.168" class="difflineplus">+</span>
<a href="#l16.169"></a><span id="l16.169" class="difflineplus">+                if (</span>
<a href="#l16.170"></a><span id="l16.170" class="difflineplus">+                    !session.sharedWithDevices[userId] ||</span>
<a href="#l16.171"></a><span id="l16.171" class="difflineplus">+                        session.sharedWithDevices[userId][deviceId] === undefined</span>
<a href="#l16.172"></a><span id="l16.172" class="difflineplus">+                ) {</span>
<a href="#l16.173"></a><span id="l16.173" class="difflineplus">+                    shareMap[userId] = shareMap[userId] || [];</span>
<a href="#l16.174"></a><span id="l16.174" class="difflineplus">+                    shareMap[userId].push(deviceInfo);</span>
<a href="#l16.175"></a><span id="l16.175" class="difflineplus">+                }</span>
<a href="#l16.176"></a><span id="l16.176" class="difflineplus">+            }</span>
<a href="#l16.177"></a><span id="l16.177" class="difflineplus">+        }</span>
<a href="#l16.178"></a><span id="l16.178" class="difflineplus">+</span>
<a href="#l16.179"></a><span id="l16.179" class="difflineplus">+        return self._shareKeyWithDevices(</span>
<a href="#l16.180"></a><span id="l16.180" class="difflineplus">+            session, shareMap</span>
<a href="#l16.181"></a><span id="l16.181" class="difflineplus">+        );</span>
<a href="#l16.182"></a><span id="l16.182" class="difflineplus">+    }).finally(function() {</span>
<a href="#l16.183"></a><span id="l16.183" class="difflineplus">+        session.sharePromise = null;</span>
<a href="#l16.184"></a><span id="l16.184" class="difflineplus">+    }).then(function() {</span>
<a href="#l16.185"></a><span id="l16.185" class="difflineplus">+        return session;</span>
<a href="#l16.186"></a><span id="l16.186" class="difflineplus">+    });</span>
<a href="#l16.187"></a><span id="l16.187" class="difflineplus">+</span>
<a href="#l16.188"></a><span id="l16.188" class="difflineplus">+    session.sharePromise = prom;</span>
<a href="#l16.189"></a><span id="l16.189" class="difflineplus">+    return prom;</span>
<a href="#l16.190"></a><span id="l16.190" class="difflineplus">+};</span>
<a href="#l16.191"></a><span id="l16.191" class="difflineplus">+</span>
<a href="#l16.192"></a><span id="l16.192" class="difflineplus">+/**</span>
<a href="#l16.193"></a><span id="l16.193" class="difflineplus">+ * @private</span>
<a href="#l16.194"></a><span id="l16.194" class="difflineplus">+ *</span>
<a href="#l16.195"></a><span id="l16.195" class="difflineplus">+ * @param {module:models/room} room</span>
<a href="#l16.196"></a><span id="l16.196" class="difflineplus">+ *</span>
<a href="#l16.197"></a><span id="l16.197" class="difflineplus">+ * @return {module:crypto/algorithms/megolm.OutboundSessionInfo} session</span>
<a href="#l16.198"></a><span id="l16.198" class="difflineplus">+ */</span>
<a href="#l16.199"></a><span id="l16.199" class="difflineplus">+MegolmEncryption.prototype._prepareNewSession = function(room) {</span>
<a href="#l16.200"></a><span id="l16.200" class="difflineplus">+    var session_id = this._olmDevice.createOutboundGroupSession();</span>
<a href="#l16.201"></a><span id="l16.201" class="difflineplus">+    var key = this._olmDevice.getOutboundGroupSessionKey(session_id);</span>
<a href="#l16.202"></a><span id="l16.202" class="difflineplus">+</span>
<a href="#l16.203"></a><span id="l16.203" class="difflineplus">+    this._olmDevice.addInboundGroupSession(</span>
<a href="#l16.204"></a><span id="l16.204" class="difflineplus">+        this._roomId, this._olmDevice.deviceCurve25519Key, session_id,</span>
<a href="#l16.205"></a><span id="l16.205" class="difflineplus">+        key.key, {ed25519: this._olmDevice.deviceEd25519Key}</span>
<a href="#l16.206"></a><span id="l16.206" class="difflineplus">+    );</span>
<a href="#l16.207"></a><span id="l16.207" class="difflineplus">+</span>
<a href="#l16.208"></a><span id="l16.208" class="difflineplus">+    return new OutboundSessionInfo(session_id);</span>
<a href="#l16.209"></a><span id="l16.209" class="difflineplus">+};</span>
<a href="#l16.210"></a><span id="l16.210" class="difflineplus">+</span>
<a href="#l16.211"></a><span id="l16.211" class="difflineplus">+/**</span>
<a href="#l16.212"></a><span id="l16.212" class="difflineplus">+ * @private</span>
<a href="#l16.213"></a><span id="l16.213" class="difflineplus">+ *</span>
<a href="#l16.214"></a><span id="l16.214" class="difflineplus">+ * @param {module:crypto/algorithms/megolm.OutboundSessionInfo} session</span>
<a href="#l16.215"></a><span id="l16.215" class="difflineplus">+ *</span>
<a href="#l16.216"></a><span id="l16.216" class="difflineplus">+ * @param {object&lt;string, module:crypto/deviceinfo[]&gt;} devicesByUser</span>
<a href="#l16.217"></a><span id="l16.217" class="difflineplus">+ *    map from userid to list of devices</span>
<a href="#l16.218"></a><span id="l16.218" class="difflineplus">+ *</span>
<a href="#l16.219"></a><span id="l16.219" class="difflineplus">+ * @return {module:client.Promise} Promise which resolves once the key sharing</span>
<a href="#l16.220"></a><span id="l16.220" class="difflineplus">+ *     message has been sent.</span>
<a href="#l16.221"></a><span id="l16.221" class="difflineplus">+ */</span>
<a href="#l16.222"></a><span id="l16.222" class="difflineplus">+MegolmEncryption.prototype._shareKeyWithDevices = function(session, devicesByUser) {</span>
<a href="#l16.223"></a><span id="l16.223" class="difflineplus">+    var self = this;</span>
<a href="#l16.224"></a><span id="l16.224" class="difflineplus">+</span>
<a href="#l16.225"></a><span id="l16.225" class="difflineplus">+    var key = this._olmDevice.getOutboundGroupSessionKey(session.sessionId);</span>
<a href="#l16.226"></a><span id="l16.226" class="difflineplus">+    var payload = {</span>
<a href="#l16.227"></a><span id="l16.227" class="difflineplus">+        type: &quot;m.room_key&quot;,</span>
<a href="#l16.228"></a><span id="l16.228" class="difflineplus">+        content: {</span>
<a href="#l16.229"></a><span id="l16.229" class="difflineplus">+            algorithm: olmlib.MEGOLM_ALGORITHM,</span>
<a href="#l16.230"></a><span id="l16.230" class="difflineplus">+            room_id: this._roomId,</span>
<a href="#l16.231"></a><span id="l16.231" class="difflineplus">+            session_id: session.sessionId,</span>
<a href="#l16.232"></a><span id="l16.232" class="difflineplus">+            session_key: key.key,</span>
<a href="#l16.233"></a><span id="l16.233" class="difflineplus">+            chain_index: key.chain_index,</span>
<a href="#l16.234"></a><span id="l16.234" class="difflineplus">+        }</span>
<a href="#l16.235"></a><span id="l16.235" class="difflineplus">+    };</span>
<a href="#l16.236"></a><span id="l16.236" class="difflineplus">+</span>
<a href="#l16.237"></a><span id="l16.237" class="difflineplus">+    var contentMap = {};</span>
<a href="#l16.238"></a><span id="l16.238" class="difflineplus">+</span>
<a href="#l16.239"></a><span id="l16.239" class="difflineplus">+    return olmlib.ensureOlmSessionsForDevices(</span>
<a href="#l16.240"></a><span id="l16.240" class="difflineplus">+        this._olmDevice, this._baseApis, devicesByUser</span>
<a href="#l16.241"></a><span id="l16.241" class="difflineplus">+    ).then(function(devicemap) {</span>
<a href="#l16.242"></a><span id="l16.242" class="difflineplus">+        var haveTargets = false;</span>
<a href="#l16.243"></a><span id="l16.243" class="difflineplus">+</span>
<a href="#l16.244"></a><span id="l16.244" class="difflineplus">+        for (var userId in devicesByUser) {</span>
<a href="#l16.245"></a><span id="l16.245" class="difflineplus">+            if (!devicesByUser.hasOwnProperty(userId)) {</span>
<a href="#l16.246"></a><span id="l16.246" class="difflineplus">+                continue;</span>
<a href="#l16.247"></a><span id="l16.247" class="difflineplus">+            }</span>
<a href="#l16.248"></a><span id="l16.248" class="difflineplus">+</span>
<a href="#l16.249"></a><span id="l16.249" class="difflineplus">+            var devicesToShareWith = devicesByUser[userId];</span>
<a href="#l16.250"></a><span id="l16.250" class="difflineplus">+            var sessionResults = devicemap[userId];</span>
<a href="#l16.251"></a><span id="l16.251" class="difflineplus">+</span>
<a href="#l16.252"></a><span id="l16.252" class="difflineplus">+            for (var i = 0; i &lt; devicesToShareWith.length; i++) {</span>
<a href="#l16.253"></a><span id="l16.253" class="difflineplus">+                var deviceInfo = devicesToShareWith[i];</span>
<a href="#l16.254"></a><span id="l16.254" class="difflineplus">+                var deviceId = deviceInfo.deviceId;</span>
<a href="#l16.255"></a><span id="l16.255" class="difflineplus">+</span>
<a href="#l16.256"></a><span id="l16.256" class="difflineplus">+                var sessionResult = sessionResults[deviceId];</span>
<a href="#l16.257"></a><span id="l16.257" class="difflineplus">+                if (!sessionResult.sessionId) {</span>
<a href="#l16.258"></a><span id="l16.258" class="difflineplus">+                    // no session with this device, probably because there</span>
<a href="#l16.259"></a><span id="l16.259" class="difflineplus">+                    // were no one-time keys.</span>
<a href="#l16.260"></a><span id="l16.260" class="difflineplus">+                    //</span>
<a href="#l16.261"></a><span id="l16.261" class="difflineplus">+                    // we could send them a to_device message anyway, as a</span>
<a href="#l16.262"></a><span id="l16.262" class="difflineplus">+                    // signal that they have missed out on the key sharing</span>
<a href="#l16.263"></a><span id="l16.263" class="difflineplus">+                    // message because of the lack of keys, but there's not</span>
<a href="#l16.264"></a><span id="l16.264" class="difflineplus">+                    // much point in that really; it will mostly serve to clog</span>
<a href="#l16.265"></a><span id="l16.265" class="difflineplus">+                    // up to_device inboxes.</span>
<a href="#l16.266"></a><span id="l16.266" class="difflineplus">+                    //</span>
<a href="#l16.267"></a><span id="l16.267" class="difflineplus">+                    // ensureOlmSessionsForUsers has already done the logging,</span>
<a href="#l16.268"></a><span id="l16.268" class="difflineplus">+                    // so just skip it.</span>
<a href="#l16.269"></a><span id="l16.269" class="difflineplus">+                    continue;</span>
<a href="#l16.270"></a><span id="l16.270" class="difflineplus">+                }</span>
<a href="#l16.271"></a><span id="l16.271" class="difflineplus">+</span>
<a href="#l16.272"></a><span id="l16.272" class="difflineplus">+                console.log(</span>
<a href="#l16.273"></a><span id="l16.273" class="difflineplus">+                    &quot;sharing keys with device &quot; + userId + &quot;:&quot; + deviceId</span>
<a href="#l16.274"></a><span id="l16.274" class="difflineplus">+                );</span>
<a href="#l16.275"></a><span id="l16.275" class="difflineplus">+</span>
<a href="#l16.276"></a><span id="l16.276" class="difflineplus">+                var encryptedContent = {</span>
<a href="#l16.277"></a><span id="l16.277" class="difflineplus">+                    algorithm: olmlib.OLM_ALGORITHM,</span>
<a href="#l16.278"></a><span id="l16.278" class="difflineplus">+                    sender_key: self._olmDevice.deviceCurve25519Key,</span>
<a href="#l16.279"></a><span id="l16.279" class="difflineplus">+                    ciphertext: {},</span>
<a href="#l16.280"></a><span id="l16.280" class="difflineplus">+                };</span>
<a href="#l16.281"></a><span id="l16.281" class="difflineplus">+</span>
<a href="#l16.282"></a><span id="l16.282" class="difflineplus">+                olmlib.encryptMessageForDevice(</span>
<a href="#l16.283"></a><span id="l16.283" class="difflineplus">+                    encryptedContent.ciphertext,</span>
<a href="#l16.284"></a><span id="l16.284" class="difflineplus">+                    self._userId,</span>
<a href="#l16.285"></a><span id="l16.285" class="difflineplus">+                    self._deviceId,</span>
<a href="#l16.286"></a><span id="l16.286" class="difflineplus">+                    self._olmDevice,</span>
<a href="#l16.287"></a><span id="l16.287" class="difflineplus">+                    userId,</span>
<a href="#l16.288"></a><span id="l16.288" class="difflineplus">+                    deviceInfo,</span>
<a href="#l16.289"></a><span id="l16.289" class="difflineplus">+                    payload</span>
<a href="#l16.290"></a><span id="l16.290" class="difflineplus">+                );</span>
<a href="#l16.291"></a><span id="l16.291" class="difflineplus">+</span>
<a href="#l16.292"></a><span id="l16.292" class="difflineplus">+                if (!contentMap[userId]) {</span>
<a href="#l16.293"></a><span id="l16.293" class="difflineplus">+                    contentMap[userId] = {};</span>
<a href="#l16.294"></a><span id="l16.294" class="difflineplus">+                }</span>
<a href="#l16.295"></a><span id="l16.295" class="difflineplus">+</span>
<a href="#l16.296"></a><span id="l16.296" class="difflineplus">+                contentMap[userId][deviceId] = encryptedContent;</span>
<a href="#l16.297"></a><span id="l16.297" class="difflineplus">+                haveTargets = true;</span>
<a href="#l16.298"></a><span id="l16.298" class="difflineplus">+            }</span>
<a href="#l16.299"></a><span id="l16.299" class="difflineplus">+        }</span>
<a href="#l16.300"></a><span id="l16.300" class="difflineplus">+</span>
<a href="#l16.301"></a><span id="l16.301" class="difflineplus">+        if (!haveTargets) {</span>
<a href="#l16.302"></a><span id="l16.302" class="difflineplus">+            return q();</span>
<a href="#l16.303"></a><span id="l16.303" class="difflineplus">+        }</span>
<a href="#l16.304"></a><span id="l16.304" class="difflineplus">+</span>
<a href="#l16.305"></a><span id="l16.305" class="difflineplus">+        // TODO: retries</span>
<a href="#l16.306"></a><span id="l16.306" class="difflineplus">+        return self._baseApis.sendToDevice(&quot;m.room.encrypted&quot;, contentMap);</span>
<a href="#l16.307"></a><span id="l16.307" class="difflineplus">+    }).then(function() {</span>
<a href="#l16.308"></a><span id="l16.308" class="difflineplus">+        // Add the devices we have shared with to session.sharedWithDevices.</span>
<a href="#l16.309"></a><span id="l16.309" class="difflineplus">+        //</span>
<a href="#l16.310"></a><span id="l16.310" class="difflineplus">+        // we deliberately iterate over devicesByUser (ie, the devices we</span>
<a href="#l16.311"></a><span id="l16.311" class="difflineplus">+        // attempted to share with) rather than the contentMap (those we did</span>
<a href="#l16.312"></a><span id="l16.312" class="difflineplus">+        // share with), because we don't want to try to claim a one-time-key</span>
<a href="#l16.313"></a><span id="l16.313" class="difflineplus">+        // for dead devices on every message.</span>
<a href="#l16.314"></a><span id="l16.314" class="difflineplus">+        for (var userId in devicesByUser) {</span>
<a href="#l16.315"></a><span id="l16.315" class="difflineplus">+            if (!devicesByUser.hasOwnProperty(userId)) {</span>
<a href="#l16.316"></a><span id="l16.316" class="difflineplus">+                continue;</span>
<a href="#l16.317"></a><span id="l16.317" class="difflineplus">+            }</span>
<a href="#l16.318"></a><span id="l16.318" class="difflineplus">+            if (!session.sharedWithDevices[userId]) {</span>
<a href="#l16.319"></a><span id="l16.319" class="difflineplus">+                session.sharedWithDevices[userId] = {};</span>
<a href="#l16.320"></a><span id="l16.320" class="difflineplus">+            }</span>
<a href="#l16.321"></a><span id="l16.321" class="difflineplus">+            var devicesToShareWith = devicesByUser[userId];</span>
<a href="#l16.322"></a><span id="l16.322" class="difflineplus">+            for (var i = 0; i &lt; devicesToShareWith.length; i++) {</span>
<a href="#l16.323"></a><span id="l16.323" class="difflineplus">+                var deviceInfo = devicesToShareWith[i];</span>
<a href="#l16.324"></a><span id="l16.324" class="difflineplus">+                session.sharedWithDevices[userId][deviceInfo.deviceId] =</span>
<a href="#l16.325"></a><span id="l16.325" class="difflineplus">+                    key.chain_index;</span>
<a href="#l16.326"></a><span id="l16.326" class="difflineplus">+            }</span>
<a href="#l16.327"></a><span id="l16.327" class="difflineplus">+        }</span>
<a href="#l16.328"></a><span id="l16.328" class="difflineplus">+    });</span>
<a href="#l16.329"></a><span id="l16.329" class="difflineplus">+};</span>
<a href="#l16.330"></a><span id="l16.330" class="difflineplus">+</span>
<a href="#l16.331"></a><span id="l16.331" class="difflineplus">+/**</span>
<a href="#l16.332"></a><span id="l16.332" class="difflineplus">+ * @inheritdoc</span>
<a href="#l16.333"></a><span id="l16.333" class="difflineplus">+ *</span>
<a href="#l16.334"></a><span id="l16.334" class="difflineplus">+ * @param {module:models/room} room</span>
<a href="#l16.335"></a><span id="l16.335" class="difflineplus">+ * @param {string} eventType</span>
<a href="#l16.336"></a><span id="l16.336" class="difflineplus">+ * @param {object} plaintext event content</span>
<a href="#l16.337"></a><span id="l16.337" class="difflineplus">+ *</span>
<a href="#l16.338"></a><span id="l16.338" class="difflineplus">+ * @return {module:client.Promise} Promise which resolves to the new event body</span>
<a href="#l16.339"></a><span id="l16.339" class="difflineplus">+ */</span>
<a href="#l16.340"></a><span id="l16.340" class="difflineplus">+MegolmEncryption.prototype.encryptMessage = function(room, eventType, content) {</span>
<a href="#l16.341"></a><span id="l16.341" class="difflineplus">+    var self = this;</span>
<a href="#l16.342"></a><span id="l16.342" class="difflineplus">+    return this._ensureOutboundSession(room).then(function(session) {</span>
<a href="#l16.343"></a><span id="l16.343" class="difflineplus">+        var payloadJson = {</span>
<a href="#l16.344"></a><span id="l16.344" class="difflineplus">+            room_id: self._roomId,</span>
<a href="#l16.345"></a><span id="l16.345" class="difflineplus">+            type: eventType,</span>
<a href="#l16.346"></a><span id="l16.346" class="difflineplus">+            content: content</span>
<a href="#l16.347"></a><span id="l16.347" class="difflineplus">+        };</span>
<a href="#l16.348"></a><span id="l16.348" class="difflineplus">+</span>
<a href="#l16.349"></a><span id="l16.349" class="difflineplus">+        var ciphertext = self._olmDevice.encryptGroupMessage(</span>
<a href="#l16.350"></a><span id="l16.350" class="difflineplus">+            session.sessionId, JSON.stringify(payloadJson)</span>
<a href="#l16.351"></a><span id="l16.351" class="difflineplus">+        );</span>
<a href="#l16.352"></a><span id="l16.352" class="difflineplus">+</span>
<a href="#l16.353"></a><span id="l16.353" class="difflineplus">+        var encryptedContent = {</span>
<a href="#l16.354"></a><span id="l16.354" class="difflineplus">+            algorithm: olmlib.MEGOLM_ALGORITHM,</span>
<a href="#l16.355"></a><span id="l16.355" class="difflineplus">+            sender_key: self._olmDevice.deviceCurve25519Key,</span>
<a href="#l16.356"></a><span id="l16.356" class="difflineplus">+            ciphertext: ciphertext,</span>
<a href="#l16.357"></a><span id="l16.357" class="difflineplus">+            session_id: session.sessionId,</span>
<a href="#l16.358"></a><span id="l16.358" class="difflineplus">+             // Include our device ID so that recipients can send us a</span>
<a href="#l16.359"></a><span id="l16.359" class="difflineplus">+             // m.new_device message if they don't have our session key.</span>
<a href="#l16.360"></a><span id="l16.360" class="difflineplus">+            device_id: self._deviceId,</span>
<a href="#l16.361"></a><span id="l16.361" class="difflineplus">+        };</span>
<a href="#l16.362"></a><span id="l16.362" class="difflineplus">+</span>
<a href="#l16.363"></a><span id="l16.363" class="difflineplus">+        session.useCount++;</span>
<a href="#l16.364"></a><span id="l16.364" class="difflineplus">+        return encryptedContent;</span>
<a href="#l16.365"></a><span id="l16.365" class="difflineplus">+    });</span>
<a href="#l16.366"></a><span id="l16.366" class="difflineplus">+};</span>
<a href="#l16.367"></a><span id="l16.367" class="difflineplus">+</span>
<a href="#l16.368"></a><span id="l16.368" class="difflineplus">+/**</span>
<a href="#l16.369"></a><span id="l16.369" class="difflineplus">+ * @inheritdoc</span>
<a href="#l16.370"></a><span id="l16.370" class="difflineplus">+ *</span>
<a href="#l16.371"></a><span id="l16.371" class="difflineplus">+ * @param {module:models/event.MatrixEvent} event  event causing the change</span>
<a href="#l16.372"></a><span id="l16.372" class="difflineplus">+ * @param {module:models/room-member} member  user whose membership changed</span>
<a href="#l16.373"></a><span id="l16.373" class="difflineplus">+ * @param {string=} oldMembership  previous membership</span>
<a href="#l16.374"></a><span id="l16.374" class="difflineplus">+ */</span>
<a href="#l16.375"></a><span id="l16.375" class="difflineplus">+MegolmEncryption.prototype.onRoomMembership = function(event, member, oldMembership) {</span>
<a href="#l16.376"></a><span id="l16.376" class="difflineplus">+    var newMembership = member.membership;</span>
<a href="#l16.377"></a><span id="l16.377" class="difflineplus">+</span>
<a href="#l16.378"></a><span id="l16.378" class="difflineplus">+    if (newMembership === 'join' || newMembership === 'invite') {</span>
<a href="#l16.379"></a><span id="l16.379" class="difflineplus">+        return;</span>
<a href="#l16.380"></a><span id="l16.380" class="difflineplus">+    }</span>
<a href="#l16.381"></a><span id="l16.381" class="difflineplus">+</span>
<a href="#l16.382"></a><span id="l16.382" class="difflineplus">+    // otherwise we assume the user is leaving, and start a new outbound session.</span>
<a href="#l16.383"></a><span id="l16.383" class="difflineplus">+    console.log(&quot;Discarding outbound megolm session due to change in &quot; +</span>
<a href="#l16.384"></a><span id="l16.384" class="difflineplus">+                &quot;membership of &quot; + member.userId + &quot; (&quot; + oldMembership +</span>
<a href="#l16.385"></a><span id="l16.385" class="difflineplus">+                &quot;-&gt;&quot; + newMembership + &quot;)&quot;);</span>
<a href="#l16.386"></a><span id="l16.386" class="difflineplus">+</span>
<a href="#l16.387"></a><span id="l16.387" class="difflineplus">+    // this ensures that we will start a new session on the next message.</span>
<a href="#l16.388"></a><span id="l16.388" class="difflineplus">+    this._outboundSession = null;</span>
<a href="#l16.389"></a><span id="l16.389" class="difflineplus">+};</span>
<a href="#l16.390"></a><span id="l16.390" class="difflineplus">+</span>
<a href="#l16.391"></a><span id="l16.391" class="difflineplus">+/**</span>
<a href="#l16.392"></a><span id="l16.392" class="difflineplus">+ * Get the list of devices for all users in the room</span>
<a href="#l16.393"></a><span id="l16.393" class="difflineplus">+ *</span>
<a href="#l16.394"></a><span id="l16.394" class="difflineplus">+ * @param {module:models/room} room</span>
<a href="#l16.395"></a><span id="l16.395" class="difflineplus">+ *</span>
<a href="#l16.396"></a><span id="l16.396" class="difflineplus">+ * @return {module:client.Promise} Promise which resolves to a map</span>
<a href="#l16.397"></a><span id="l16.397" class="difflineplus">+ *     from userId to deviceId to deviceInfo</span>
<a href="#l16.398"></a><span id="l16.398" class="difflineplus">+ */</span>
<a href="#l16.399"></a><span id="l16.399" class="difflineplus">+MegolmEncryption.prototype._getDevicesInRoom = function(room) {</span>
<a href="#l16.400"></a><span id="l16.400" class="difflineplus">+    // XXX what about rooms where invitees can see the content?</span>
<a href="#l16.401"></a><span id="l16.401" class="difflineplus">+    var roomMembers = utils.map(room.getJoinedMembers(), function(u) {</span>
<a href="#l16.402"></a><span id="l16.402" class="difflineplus">+        return u.userId;</span>
<a href="#l16.403"></a><span id="l16.403" class="difflineplus">+    });</span>
<a href="#l16.404"></a><span id="l16.404" class="difflineplus">+</span>
<a href="#l16.405"></a><span id="l16.405" class="difflineplus">+    // We are happy to use a cached version here: we assume that if we already</span>
<a href="#l16.406"></a><span id="l16.406" class="difflineplus">+    // have a list of the user's devices, then we already share an e2e room</span>
<a href="#l16.407"></a><span id="l16.407" class="difflineplus">+    // with them, which means that they will have announced any new devices via</span>
<a href="#l16.408"></a><span id="l16.408" class="difflineplus">+    // an m.new_device.</span>
<a href="#l16.409"></a><span id="l16.409" class="difflineplus">+    return this._crypto.downloadKeys(roomMembers, false);</span>
<a href="#l16.410"></a><span id="l16.410" class="difflineplus">+};</span>
<a href="#l16.411"></a><span id="l16.411" class="difflineplus">+</span>
<a href="#l16.412"></a><span id="l16.412" class="difflineplus">+/**</span>
<a href="#l16.413"></a><span id="l16.413" class="difflineplus">+ * Megolm decryption implementation</span>
<a href="#l16.414"></a><span id="l16.414" class="difflineplus">+ *</span>
<a href="#l16.415"></a><span id="l16.415" class="difflineplus">+ * @constructor</span>
<a href="#l16.416"></a><span id="l16.416" class="difflineplus">+ * @extends {module:crypto/algorithms/base.DecryptionAlgorithm}</span>
<a href="#l16.417"></a><span id="l16.417" class="difflineplus">+ *</span>
<a href="#l16.418"></a><span id="l16.418" class="difflineplus">+ * @param {object} params parameters, as per</span>
<a href="#l16.419"></a><span id="l16.419" class="difflineplus">+ *     {@link module:crypto/algorithms/base.DecryptionAlgorithm}</span>
<a href="#l16.420"></a><span id="l16.420" class="difflineplus">+ */</span>
<a href="#l16.421"></a><span id="l16.421" class="difflineplus">+function MegolmDecryption(params) {</span>
<a href="#l16.422"></a><span id="l16.422" class="difflineplus">+    base.DecryptionAlgorithm.call(this, params);</span>
<a href="#l16.423"></a><span id="l16.423" class="difflineplus">+</span>
<a href="#l16.424"></a><span id="l16.424" class="difflineplus">+    // events which we couldn't decrypt due to unknown sessions / indexes: map from</span>
<a href="#l16.425"></a><span id="l16.425" class="difflineplus">+    // senderKey|sessionId to list of MatrixEvents</span>
<a href="#l16.426"></a><span id="l16.426" class="difflineplus">+    this._pendingEvents = {};</span>
<a href="#l16.427"></a><span id="l16.427" class="difflineplus">+}</span>
<a href="#l16.428"></a><span id="l16.428" class="difflineplus">+utils.inherits(MegolmDecryption, base.DecryptionAlgorithm);</span>
<a href="#l16.429"></a><span id="l16.429" class="difflineplus">+</span>
<a href="#l16.430"></a><span id="l16.430" class="difflineplus">+/**</span>
<a href="#l16.431"></a><span id="l16.431" class="difflineplus">+ * @inheritdoc</span>
<a href="#l16.432"></a><span id="l16.432" class="difflineplus">+ *</span>
<a href="#l16.433"></a><span id="l16.433" class="difflineplus">+ * @param {MatrixEvent} event</span>
<a href="#l16.434"></a><span id="l16.434" class="difflineplus">+ *</span>
<a href="#l16.435"></a><span id="l16.435" class="difflineplus">+ * @return {null} The event referred to an unknown megolm session</span>
<a href="#l16.436"></a><span id="l16.436" class="difflineplus">+ * @return {module:crypto.DecryptionResult} decryption result</span>
<a href="#l16.437"></a><span id="l16.437" class="difflineplus">+ *</span>
<a href="#l16.438"></a><span id="l16.438" class="difflineplus">+ * @throws {module:crypto/algorithms/base.DecryptionError} if there is a</span>
<a href="#l16.439"></a><span id="l16.439" class="difflineplus">+ *   problem decrypting the event</span>
<a href="#l16.440"></a><span id="l16.440" class="difflineplus">+ */</span>
<a href="#l16.441"></a><span id="l16.441" class="difflineplus">+MegolmDecryption.prototype.decryptEvent = function(event) {</span>
<a href="#l16.442"></a><span id="l16.442" class="difflineplus">+    var content = event.getWireContent();</span>
<a href="#l16.443"></a><span id="l16.443" class="difflineplus">+</span>
<a href="#l16.444"></a><span id="l16.444" class="difflineplus">+    if (!content.sender_key || !content.session_id ||</span>
<a href="#l16.445"></a><span id="l16.445" class="difflineplus">+        !content.ciphertext</span>
<a href="#l16.446"></a><span id="l16.446" class="difflineplus">+       ) {</span>
<a href="#l16.447"></a><span id="l16.447" class="difflineplus">+        throw new base.DecryptionError(&quot;Missing fields in input&quot;);</span>
<a href="#l16.448"></a><span id="l16.448" class="difflineplus">+    }</span>
<a href="#l16.449"></a><span id="l16.449" class="difflineplus">+</span>
<a href="#l16.450"></a><span id="l16.450" class="difflineplus">+    var res;</span>
<a href="#l16.451"></a><span id="l16.451" class="difflineplus">+    try {</span>
<a href="#l16.452"></a><span id="l16.452" class="difflineplus">+        res = this._olmDevice.decryptGroupMessage(</span>
<a href="#l16.453"></a><span id="l16.453" class="difflineplus">+            event.getRoomId(), content.sender_key, content.session_id, content.ciphertext</span>
<a href="#l16.454"></a><span id="l16.454" class="difflineplus">+        );</span>
<a href="#l16.455"></a><span id="l16.455" class="difflineplus">+    } catch (e) {</span>
<a href="#l16.456"></a><span id="l16.456" class="difflineplus">+        if (e.message === 'OLM.UNKNOWN_MESSAGE_INDEX') {</span>
<a href="#l16.457"></a><span id="l16.457" class="difflineplus">+            this._addEventToPendingList(event);</span>
<a href="#l16.458"></a><span id="l16.458" class="difflineplus">+        }</span>
<a href="#l16.459"></a><span id="l16.459" class="difflineplus">+        throw new base.DecryptionError(e);</span>
<a href="#l16.460"></a><span id="l16.460" class="difflineplus">+    }</span>
<a href="#l16.461"></a><span id="l16.461" class="difflineplus">+</span>
<a href="#l16.462"></a><span id="l16.462" class="difflineplus">+    if (res === null) {</span>
<a href="#l16.463"></a><span id="l16.463" class="difflineplus">+        // We've got a message for a session we don't have.</span>
<a href="#l16.464"></a><span id="l16.464" class="difflineplus">+        this._addEventToPendingList(event);</span>
<a href="#l16.465"></a><span id="l16.465" class="difflineplus">+        throw new base.DecryptionError(&quot;Unknown inbound session id&quot;);</span>
<a href="#l16.466"></a><span id="l16.466" class="difflineplus">+    }</span>
<a href="#l16.467"></a><span id="l16.467" class="difflineplus">+</span>
<a href="#l16.468"></a><span id="l16.468" class="difflineplus">+    var payload = JSON.parse(res.result);</span>
<a href="#l16.469"></a><span id="l16.469" class="difflineplus">+</span>
<a href="#l16.470"></a><span id="l16.470" class="difflineplus">+    // belt-and-braces check that the room id matches that indicated by the HS</span>
<a href="#l16.471"></a><span id="l16.471" class="difflineplus">+    // (this is somewhat redundant, since the megolm session is scoped to the</span>
<a href="#l16.472"></a><span id="l16.472" class="difflineplus">+    // room, so neither the sender nor a MITM can lie about the room_id).</span>
<a href="#l16.473"></a><span id="l16.473" class="difflineplus">+    if (payload.room_id !== event.getRoomId()) {</span>
<a href="#l16.474"></a><span id="l16.474" class="difflineplus">+        throw new base.DecryptionError(</span>
<a href="#l16.475"></a><span id="l16.475" class="difflineplus">+            &quot;Message intended for room &quot; + payload.room_id</span>
<a href="#l16.476"></a><span id="l16.476" class="difflineplus">+        );</span>
<a href="#l16.477"></a><span id="l16.477" class="difflineplus">+    }</span>
<a href="#l16.478"></a><span id="l16.478" class="difflineplus">+</span>
<a href="#l16.479"></a><span id="l16.479" class="difflineplus">+    event.setClearData(payload, res.keysProved, res.keysClaimed);</span>
<a href="#l16.480"></a><span id="l16.480" class="difflineplus">+};</span>
<a href="#l16.481"></a><span id="l16.481" class="difflineplus">+</span>
<a href="#l16.482"></a><span id="l16.482" class="difflineplus">+</span>
<a href="#l16.483"></a><span id="l16.483" class="difflineplus">+/**</span>
<a href="#l16.484"></a><span id="l16.484" class="difflineplus">+ * Add an event to the list of those we couldn't decrypt the first time we</span>
<a href="#l16.485"></a><span id="l16.485" class="difflineplus">+ * saw them.</span>
<a href="#l16.486"></a><span id="l16.486" class="difflineplus">+ *</span>
<a href="#l16.487"></a><span id="l16.487" class="difflineplus">+ * @private</span>
<a href="#l16.488"></a><span id="l16.488" class="difflineplus">+ *</span>
<a href="#l16.489"></a><span id="l16.489" class="difflineplus">+ * @param {module:models/event.MatrixEvent} event</span>
<a href="#l16.490"></a><span id="l16.490" class="difflineplus">+ */</span>
<a href="#l16.491"></a><span id="l16.491" class="difflineplus">+MegolmDecryption.prototype._addEventToPendingList = function(event) {</span>
<a href="#l16.492"></a><span id="l16.492" class="difflineplus">+    var content = event.getWireContent();</span>
<a href="#l16.493"></a><span id="l16.493" class="difflineplus">+    var k = content.sender_key + &quot;|&quot; + content.session_id;</span>
<a href="#l16.494"></a><span id="l16.494" class="difflineplus">+    if (!this._pendingEvents[k]) {</span>
<a href="#l16.495"></a><span id="l16.495" class="difflineplus">+        this._pendingEvents[k] = [];</span>
<a href="#l16.496"></a><span id="l16.496" class="difflineplus">+    }</span>
<a href="#l16.497"></a><span id="l16.497" class="difflineplus">+    this._pendingEvents[k].push(event);</span>
<a href="#l16.498"></a><span id="l16.498" class="difflineplus">+};</span>
<a href="#l16.499"></a><span id="l16.499" class="difflineplus">+</span>
<a href="#l16.500"></a><span id="l16.500" class="difflineplus">+/**</span>
<a href="#l16.501"></a><span id="l16.501" class="difflineplus">+ * @inheritdoc</span>
<a href="#l16.502"></a><span id="l16.502" class="difflineplus">+ *</span>
<a href="#l16.503"></a><span id="l16.503" class="difflineplus">+ * @param {module:models/event.MatrixEvent} event key event</span>
<a href="#l16.504"></a><span id="l16.504" class="difflineplus">+ */</span>
<a href="#l16.505"></a><span id="l16.505" class="difflineplus">+MegolmDecryption.prototype.onRoomKeyEvent = function(event) {</span>
<a href="#l16.506"></a><span id="l16.506" class="difflineplus">+    console.log(&quot;Adding key from &quot;, event);</span>
<a href="#l16.507"></a><span id="l16.507" class="difflineplus">+    var content = event.getContent();</span>
<a href="#l16.508"></a><span id="l16.508" class="difflineplus">+</span>
<a href="#l16.509"></a><span id="l16.509" class="difflineplus">+    if (!content.room_id ||</span>
<a href="#l16.510"></a><span id="l16.510" class="difflineplus">+        !content.session_id ||</span>
<a href="#l16.511"></a><span id="l16.511" class="difflineplus">+        !content.session_key</span>
<a href="#l16.512"></a><span id="l16.512" class="difflineplus">+       ) {</span>
<a href="#l16.513"></a><span id="l16.513" class="difflineplus">+        console.error(&quot;key event is missing fields&quot;);</span>
<a href="#l16.514"></a><span id="l16.514" class="difflineplus">+        return;</span>
<a href="#l16.515"></a><span id="l16.515" class="difflineplus">+    }</span>
<a href="#l16.516"></a><span id="l16.516" class="difflineplus">+</span>
<a href="#l16.517"></a><span id="l16.517" class="difflineplus">+    this._olmDevice.addInboundGroupSession(</span>
<a href="#l16.518"></a><span id="l16.518" class="difflineplus">+        content.room_id, event.getSenderKey(), content.session_id,</span>
<a href="#l16.519"></a><span id="l16.519" class="difflineplus">+        content.session_key, event.getKeysClaimed()</span>
<a href="#l16.520"></a><span id="l16.520" class="difflineplus">+    );</span>
<a href="#l16.521"></a><span id="l16.521" class="difflineplus">+</span>
<a href="#l16.522"></a><span id="l16.522" class="difflineplus">+    var k = event.getSenderKey() + &quot;|&quot; + content.session_id;</span>
<a href="#l16.523"></a><span id="l16.523" class="difflineplus">+    var pending = this._pendingEvents[k];</span>
<a href="#l16.524"></a><span id="l16.524" class="difflineplus">+    if (pending) {</span>
<a href="#l16.525"></a><span id="l16.525" class="difflineplus">+        // have another go at decrypting events sent with this session.</span>
<a href="#l16.526"></a><span id="l16.526" class="difflineplus">+        delete this._pendingEvents[k];</span>
<a href="#l16.527"></a><span id="l16.527" class="difflineplus">+</span>
<a href="#l16.528"></a><span id="l16.528" class="difflineplus">+        for (var i = 0; i &lt; pending.length; i++) {</span>
<a href="#l16.529"></a><span id="l16.529" class="difflineplus">+            try {</span>
<a href="#l16.530"></a><span id="l16.530" class="difflineplus">+                this.decryptEvent(pending[i]);</span>
<a href="#l16.531"></a><span id="l16.531" class="difflineplus">+                console.log(&quot;successful re-decryption of&quot;, pending[i]);</span>
<a href="#l16.532"></a><span id="l16.532" class="difflineplus">+            } catch (e) {</span>
<a href="#l16.533"></a><span id="l16.533" class="difflineplus">+                console.log(&quot;Still can't decrypt&quot;, pending[i], e.stack || e);</span>
<a href="#l16.534"></a><span id="l16.534" class="difflineplus">+            }</span>
<a href="#l16.535"></a><span id="l16.535" class="difflineplus">+        }</span>
<a href="#l16.536"></a><span id="l16.536" class="difflineplus">+    }</span>
<a href="#l16.537"></a><span id="l16.537" class="difflineplus">+};</span>
<a href="#l16.538"></a><span id="l16.538" class="difflineplus">+</span>
<a href="#l16.539"></a><span id="l16.539" class="difflineplus">+base.registerAlgorithm(</span>
<a href="#l16.540"></a><span id="l16.540" class="difflineplus">+    olmlib.MEGOLM_ALGORITHM, MegolmEncryption, MegolmDecryption</span>
<a href="#l16.541"></a><span id="l16.541" class="difflineplus">+);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1">new file mode 100644</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineminus">--- /dev/null</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineplus">+++ b/chat/protocols/matrix/matrix-sdk/crypto/algorithms/olm.js</span>
<a href="#l17.4"></a><span id="l17.4" class="difflineat">@@ -0,0 +1,319 @@</span>
<a href="#l17.5"></a><span id="l17.5" class="difflineplus">+/*</span>
<a href="#l17.6"></a><span id="l17.6" class="difflineplus">+Copyright 2016 OpenMarket Ltd</span>
<a href="#l17.7"></a><span id="l17.7" class="difflineplus">+</span>
<a href="#l17.8"></a><span id="l17.8" class="difflineplus">+Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<a href="#l17.9"></a><span id="l17.9" class="difflineplus">+you may not use this file except in compliance with the License.</span>
<a href="#l17.10"></a><span id="l17.10" class="difflineplus">+You may obtain a copy of the License at</span>
<a href="#l17.11"></a><span id="l17.11" class="difflineplus">+</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineplus">+    http://www.apache.org/licenses/LICENSE-2.0</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineplus">+</span>
<a href="#l17.14"></a><span id="l17.14" class="difflineplus">+Unless required by applicable law or agreed to in writing, software</span>
<a href="#l17.15"></a><span id="l17.15" class="difflineplus">+distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<a href="#l17.16"></a><span id="l17.16" class="difflineplus">+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<a href="#l17.17"></a><span id="l17.17" class="difflineplus">+See the License for the specific language governing permissions and</span>
<a href="#l17.18"></a><span id="l17.18" class="difflineplus">+limitations under the License.</span>
<a href="#l17.19"></a><span id="l17.19" class="difflineplus">+*/</span>
<a href="#l17.20"></a><span id="l17.20" class="difflineplus">+&quot;use strict&quot;;</span>
<a href="#l17.21"></a><span id="l17.21" class="difflineplus">+</span>
<a href="#l17.22"></a><span id="l17.22" class="difflineplus">+/**</span>
<a href="#l17.23"></a><span id="l17.23" class="difflineplus">+ * Defines m.olm encryption/decryption</span>
<a href="#l17.24"></a><span id="l17.24" class="difflineplus">+ *</span>
<a href="#l17.25"></a><span id="l17.25" class="difflineplus">+ * @module crypto/algorithms/olm</span>
<a href="#l17.26"></a><span id="l17.26" class="difflineplus">+ */</span>
<a href="#l17.27"></a><span id="l17.27" class="difflineplus">+var q = require('q');</span>
<a href="#l17.28"></a><span id="l17.28" class="difflineplus">+</span>
<a href="#l17.29"></a><span id="l17.29" class="difflineplus">+var utils = require(&quot;../../utils&quot;);</span>
<a href="#l17.30"></a><span id="l17.30" class="difflineplus">+var olmlib = require(&quot;../olmlib&quot;);</span>
<a href="#l17.31"></a><span id="l17.31" class="difflineplus">+var DeviceInfo = require(&quot;../deviceinfo&quot;);</span>
<a href="#l17.32"></a><span id="l17.32" class="difflineplus">+var DeviceVerification = DeviceInfo.DeviceVerification;</span>
<a href="#l17.33"></a><span id="l17.33" class="difflineplus">+</span>
<a href="#l17.34"></a><span id="l17.34" class="difflineplus">+</span>
<a href="#l17.35"></a><span id="l17.35" class="difflineplus">+var base = require(&quot;./base&quot;);</span>
<a href="#l17.36"></a><span id="l17.36" class="difflineplus">+</span>
<a href="#l17.37"></a><span id="l17.37" class="difflineplus">+/**</span>
<a href="#l17.38"></a><span id="l17.38" class="difflineplus">+ * Olm encryption implementation</span>
<a href="#l17.39"></a><span id="l17.39" class="difflineplus">+ *</span>
<a href="#l17.40"></a><span id="l17.40" class="difflineplus">+ * @constructor</span>
<a href="#l17.41"></a><span id="l17.41" class="difflineplus">+ * @extends {module:crypto/algorithms/base.EncryptionAlgorithm}</span>
<a href="#l17.42"></a><span id="l17.42" class="difflineplus">+ *</span>
<a href="#l17.43"></a><span id="l17.43" class="difflineplus">+ * @param {object} params parameters, as per</span>
<a href="#l17.44"></a><span id="l17.44" class="difflineplus">+ *     {@link module:crypto/algorithms/base.EncryptionAlgorithm}</span>
<a href="#l17.45"></a><span id="l17.45" class="difflineplus">+ */</span>
<a href="#l17.46"></a><span id="l17.46" class="difflineplus">+function OlmEncryption(params) {</span>
<a href="#l17.47"></a><span id="l17.47" class="difflineplus">+    base.EncryptionAlgorithm.call(this, params);</span>
<a href="#l17.48"></a><span id="l17.48" class="difflineplus">+    this._sessionPrepared = false;</span>
<a href="#l17.49"></a><span id="l17.49" class="difflineplus">+    this._prepPromise = null;</span>
<a href="#l17.50"></a><span id="l17.50" class="difflineplus">+}</span>
<a href="#l17.51"></a><span id="l17.51" class="difflineplus">+utils.inherits(OlmEncryption, base.EncryptionAlgorithm);</span>
<a href="#l17.52"></a><span id="l17.52" class="difflineplus">+</span>
<a href="#l17.53"></a><span id="l17.53" class="difflineplus">+/**</span>
<a href="#l17.54"></a><span id="l17.54" class="difflineplus">+ * @private</span>
<a href="#l17.55"></a><span id="l17.55" class="difflineplus">+</span>
<a href="#l17.56"></a><span id="l17.56" class="difflineplus">+ * @param {string[]} roomMembers list of currently-joined users in the room</span>
<a href="#l17.57"></a><span id="l17.57" class="difflineplus">+ * @return {module:client.Promise} Promise which resolves when setup is complete</span>
<a href="#l17.58"></a><span id="l17.58" class="difflineplus">+ */</span>
<a href="#l17.59"></a><span id="l17.59" class="difflineplus">+OlmEncryption.prototype._ensureSession = function(roomMembers) {</span>
<a href="#l17.60"></a><span id="l17.60" class="difflineplus">+    if (this._prepPromise) {</span>
<a href="#l17.61"></a><span id="l17.61" class="difflineplus">+        // prep already in progress</span>
<a href="#l17.62"></a><span id="l17.62" class="difflineplus">+        return this._prepPromise;</span>
<a href="#l17.63"></a><span id="l17.63" class="difflineplus">+    }</span>
<a href="#l17.64"></a><span id="l17.64" class="difflineplus">+</span>
<a href="#l17.65"></a><span id="l17.65" class="difflineplus">+    if (this._sessionPrepared) {</span>
<a href="#l17.66"></a><span id="l17.66" class="difflineplus">+        // prep already done</span>
<a href="#l17.67"></a><span id="l17.67" class="difflineplus">+        return q();</span>
<a href="#l17.68"></a><span id="l17.68" class="difflineplus">+    }</span>
<a href="#l17.69"></a><span id="l17.69" class="difflineplus">+</span>
<a href="#l17.70"></a><span id="l17.70" class="difflineplus">+    var self = this;</span>
<a href="#l17.71"></a><span id="l17.71" class="difflineplus">+    this._prepPromise = self._crypto.downloadKeys(roomMembers, true).then(function(res) {</span>
<a href="#l17.72"></a><span id="l17.72" class="difflineplus">+        return self._crypto.ensureOlmSessionsForUsers(roomMembers);</span>
<a href="#l17.73"></a><span id="l17.73" class="difflineplus">+    }).then(function() {</span>
<a href="#l17.74"></a><span id="l17.74" class="difflineplus">+        self._sessionPrepared = true;</span>
<a href="#l17.75"></a><span id="l17.75" class="difflineplus">+    }).finally(function() {</span>
<a href="#l17.76"></a><span id="l17.76" class="difflineplus">+        self._prepPromise = null;</span>
<a href="#l17.77"></a><span id="l17.77" class="difflineplus">+    });</span>
<a href="#l17.78"></a><span id="l17.78" class="difflineplus">+    return this._prepPromise;</span>
<a href="#l17.79"></a><span id="l17.79" class="difflineplus">+};</span>
<a href="#l17.80"></a><span id="l17.80" class="difflineplus">+</span>
<a href="#l17.81"></a><span id="l17.81" class="difflineplus">+/**</span>
<a href="#l17.82"></a><span id="l17.82" class="difflineplus">+ * @inheritdoc</span>
<a href="#l17.83"></a><span id="l17.83" class="difflineplus">+ *</span>
<a href="#l17.84"></a><span id="l17.84" class="difflineplus">+ * @param {module:models/room} room</span>
<a href="#l17.85"></a><span id="l17.85" class="difflineplus">+ * @param {string} eventType</span>
<a href="#l17.86"></a><span id="l17.86" class="difflineplus">+ * @param {object} plaintext event content</span>
<a href="#l17.87"></a><span id="l17.87" class="difflineplus">+ *</span>
<a href="#l17.88"></a><span id="l17.88" class="difflineplus">+ * @return {module:client.Promise} Promise which resolves to the new event body</span>
<a href="#l17.89"></a><span id="l17.89" class="difflineplus">+ */</span>
<a href="#l17.90"></a><span id="l17.90" class="difflineplus">+OlmEncryption.prototype.encryptMessage = function(room, eventType, content) {</span>
<a href="#l17.91"></a><span id="l17.91" class="difflineplus">+    // pick the list of recipients based on the membership list.</span>
<a href="#l17.92"></a><span id="l17.92" class="difflineplus">+    //</span>
<a href="#l17.93"></a><span id="l17.93" class="difflineplus">+    // TODO: there is a race condition here! What if a new user turns up</span>
<a href="#l17.94"></a><span id="l17.94" class="difflineplus">+    // just as you are sending a secret message?</span>
<a href="#l17.95"></a><span id="l17.95" class="difflineplus">+</span>
<a href="#l17.96"></a><span id="l17.96" class="difflineplus">+    var users = utils.map(room.getJoinedMembers(), function(u) {</span>
<a href="#l17.97"></a><span id="l17.97" class="difflineplus">+        return u.userId;</span>
<a href="#l17.98"></a><span id="l17.98" class="difflineplus">+    });</span>
<a href="#l17.99"></a><span id="l17.99" class="difflineplus">+</span>
<a href="#l17.100"></a><span id="l17.100" class="difflineplus">+    var self = this;</span>
<a href="#l17.101"></a><span id="l17.101" class="difflineplus">+    return this._ensureSession(users).then(function() {</span>
<a href="#l17.102"></a><span id="l17.102" class="difflineplus">+        var payloadFields = {</span>
<a href="#l17.103"></a><span id="l17.103" class="difflineplus">+            room_id: room.roomId,</span>
<a href="#l17.104"></a><span id="l17.104" class="difflineplus">+            type: eventType,</span>
<a href="#l17.105"></a><span id="l17.105" class="difflineplus">+            content: content,</span>
<a href="#l17.106"></a><span id="l17.106" class="difflineplus">+        };</span>
<a href="#l17.107"></a><span id="l17.107" class="difflineplus">+</span>
<a href="#l17.108"></a><span id="l17.108" class="difflineplus">+        var encryptedContent = {</span>
<a href="#l17.109"></a><span id="l17.109" class="difflineplus">+            algorithm: olmlib.OLM_ALGORITHM,</span>
<a href="#l17.110"></a><span id="l17.110" class="difflineplus">+            sender_key: self._olmDevice.deviceCurve25519Key,</span>
<a href="#l17.111"></a><span id="l17.111" class="difflineplus">+            ciphertext: {},</span>
<a href="#l17.112"></a><span id="l17.112" class="difflineplus">+        };</span>
<a href="#l17.113"></a><span id="l17.113" class="difflineplus">+</span>
<a href="#l17.114"></a><span id="l17.114" class="difflineplus">+        for (var i = 0; i &lt; users.length; ++i) {</span>
<a href="#l17.115"></a><span id="l17.115" class="difflineplus">+            var userId = users[i];</span>
<a href="#l17.116"></a><span id="l17.116" class="difflineplus">+            var devices = self._crypto.getStoredDevicesForUser(userId);</span>
<a href="#l17.117"></a><span id="l17.117" class="difflineplus">+</span>
<a href="#l17.118"></a><span id="l17.118" class="difflineplus">+            for (var j = 0; j &lt; devices.length; ++j) {</span>
<a href="#l17.119"></a><span id="l17.119" class="difflineplus">+                var deviceInfo = devices[j];</span>
<a href="#l17.120"></a><span id="l17.120" class="difflineplus">+                var key = deviceInfo.getIdentityKey();</span>
<a href="#l17.121"></a><span id="l17.121" class="difflineplus">+                if (key == self._olmDevice.deviceCurve25519Key) {</span>
<a href="#l17.122"></a><span id="l17.122" class="difflineplus">+                    // don't bother sending to ourself</span>
<a href="#l17.123"></a><span id="l17.123" class="difflineplus">+                    continue;</span>
<a href="#l17.124"></a><span id="l17.124" class="difflineplus">+                }</span>
<a href="#l17.125"></a><span id="l17.125" class="difflineplus">+                if (deviceInfo.verified == DeviceVerification.BLOCKED) {</span>
<a href="#l17.126"></a><span id="l17.126" class="difflineplus">+                    // don't bother setting up sessions with blocked users</span>
<a href="#l17.127"></a><span id="l17.127" class="difflineplus">+                    continue;</span>
<a href="#l17.128"></a><span id="l17.128" class="difflineplus">+                }</span>
<a href="#l17.129"></a><span id="l17.129" class="difflineplus">+</span>
<a href="#l17.130"></a><span id="l17.130" class="difflineplus">+                olmlib.encryptMessageForDevice(</span>
<a href="#l17.131"></a><span id="l17.131" class="difflineplus">+                    encryptedContent.ciphertext,</span>
<a href="#l17.132"></a><span id="l17.132" class="difflineplus">+                    self._userId, self._deviceId, self._olmDevice,</span>
<a href="#l17.133"></a><span id="l17.133" class="difflineplus">+                    userId, deviceInfo, payloadFields</span>
<a href="#l17.134"></a><span id="l17.134" class="difflineplus">+                );</span>
<a href="#l17.135"></a><span id="l17.135" class="difflineplus">+            }</span>
<a href="#l17.136"></a><span id="l17.136" class="difflineplus">+        }</span>
<a href="#l17.137"></a><span id="l17.137" class="difflineplus">+</span>
<a href="#l17.138"></a><span id="l17.138" class="difflineplus">+        return encryptedContent;</span>
<a href="#l17.139"></a><span id="l17.139" class="difflineplus">+    });</span>
<a href="#l17.140"></a><span id="l17.140" class="difflineplus">+};</span>
<a href="#l17.141"></a><span id="l17.141" class="difflineplus">+</span>
<a href="#l17.142"></a><span id="l17.142" class="difflineplus">+/**</span>
<a href="#l17.143"></a><span id="l17.143" class="difflineplus">+ * Olm decryption implementation</span>
<a href="#l17.144"></a><span id="l17.144" class="difflineplus">+ *</span>
<a href="#l17.145"></a><span id="l17.145" class="difflineplus">+ * @constructor</span>
<a href="#l17.146"></a><span id="l17.146" class="difflineplus">+ * @extends {module:crypto/algorithms/base.DecryptionAlgorithm}</span>
<a href="#l17.147"></a><span id="l17.147" class="difflineplus">+ * @param {object} params parameters, as per</span>
<a href="#l17.148"></a><span id="l17.148" class="difflineplus">+ *     {@link module:crypto/algorithms/base.DecryptionAlgorithm}</span>
<a href="#l17.149"></a><span id="l17.149" class="difflineplus">+ */</span>
<a href="#l17.150"></a><span id="l17.150" class="difflineplus">+function OlmDecryption(params) {</span>
<a href="#l17.151"></a><span id="l17.151" class="difflineplus">+    base.DecryptionAlgorithm.call(this, params);</span>
<a href="#l17.152"></a><span id="l17.152" class="difflineplus">+}</span>
<a href="#l17.153"></a><span id="l17.153" class="difflineplus">+utils.inherits(OlmDecryption, base.DecryptionAlgorithm);</span>
<a href="#l17.154"></a><span id="l17.154" class="difflineplus">+</span>
<a href="#l17.155"></a><span id="l17.155" class="difflineplus">+/**</span>
<a href="#l17.156"></a><span id="l17.156" class="difflineplus">+ * @inheritdoc</span>
<a href="#l17.157"></a><span id="l17.157" class="difflineplus">+ *</span>
<a href="#l17.158"></a><span id="l17.158" class="difflineplus">+ * @param {MatrixEvent} event</span>
<a href="#l17.159"></a><span id="l17.159" class="difflineplus">+ *</span>
<a href="#l17.160"></a><span id="l17.160" class="difflineplus">+ * @throws {module:crypto/algorithms/base.DecryptionError} if there is a</span>
<a href="#l17.161"></a><span id="l17.161" class="difflineplus">+ *   problem decrypting the event</span>
<a href="#l17.162"></a><span id="l17.162" class="difflineplus">+ */</span>
<a href="#l17.163"></a><span id="l17.163" class="difflineplus">+OlmDecryption.prototype.decryptEvent = function(event) {</span>
<a href="#l17.164"></a><span id="l17.164" class="difflineplus">+    var content = event.getWireContent();</span>
<a href="#l17.165"></a><span id="l17.165" class="difflineplus">+    var deviceKey = content.sender_key;</span>
<a href="#l17.166"></a><span id="l17.166" class="difflineplus">+    var ciphertext = content.ciphertext;</span>
<a href="#l17.167"></a><span id="l17.167" class="difflineplus">+</span>
<a href="#l17.168"></a><span id="l17.168" class="difflineplus">+    if (!ciphertext) {</span>
<a href="#l17.169"></a><span id="l17.169" class="difflineplus">+        throw new base.DecryptionError(&quot;Missing ciphertext&quot;);</span>
<a href="#l17.170"></a><span id="l17.170" class="difflineplus">+    }</span>
<a href="#l17.171"></a><span id="l17.171" class="difflineplus">+</span>
<a href="#l17.172"></a><span id="l17.172" class="difflineplus">+    if (!(this._olmDevice.deviceCurve25519Key in ciphertext)) {</span>
<a href="#l17.173"></a><span id="l17.173" class="difflineplus">+        throw new base.DecryptionError(&quot;Not included in recipients&quot;);</span>
<a href="#l17.174"></a><span id="l17.174" class="difflineplus">+    }</span>
<a href="#l17.175"></a><span id="l17.175" class="difflineplus">+    var message = ciphertext[this._olmDevice.deviceCurve25519Key];</span>
<a href="#l17.176"></a><span id="l17.176" class="difflineplus">+    var payloadString;</span>
<a href="#l17.177"></a><span id="l17.177" class="difflineplus">+</span>
<a href="#l17.178"></a><span id="l17.178" class="difflineplus">+    try {</span>
<a href="#l17.179"></a><span id="l17.179" class="difflineplus">+        payloadString = this._decryptMessage(deviceKey, message);</span>
<a href="#l17.180"></a><span id="l17.180" class="difflineplus">+    } catch (e) {</span>
<a href="#l17.181"></a><span id="l17.181" class="difflineplus">+        console.warn(</span>
<a href="#l17.182"></a><span id="l17.182" class="difflineplus">+            &quot;Failed to decrypt Olm event (id=&quot; +</span>
<a href="#l17.183"></a><span id="l17.183" class="difflineplus">+                event.getId() + &quot;) from &quot; + deviceKey +</span>
<a href="#l17.184"></a><span id="l17.184" class="difflineplus">+                &quot;: &quot; + e.message</span>
<a href="#l17.185"></a><span id="l17.185" class="difflineplus">+        );</span>
<a href="#l17.186"></a><span id="l17.186" class="difflineplus">+        throw new base.DecryptionError(&quot;Bad Encrypted Message&quot;);</span>
<a href="#l17.187"></a><span id="l17.187" class="difflineplus">+    }</span>
<a href="#l17.188"></a><span id="l17.188" class="difflineplus">+</span>
<a href="#l17.189"></a><span id="l17.189" class="difflineplus">+    var payload = JSON.parse(payloadString);</span>
<a href="#l17.190"></a><span id="l17.190" class="difflineplus">+</span>
<a href="#l17.191"></a><span id="l17.191" class="difflineplus">+    // check that we were the intended recipient, to avoid unknown-key attack</span>
<a href="#l17.192"></a><span id="l17.192" class="difflineplus">+    // https://github.com/vector-im/vector-web/issues/2483</span>
<a href="#l17.193"></a><span id="l17.193" class="difflineplus">+    if (payload.recipient != this._userId) {</span>
<a href="#l17.194"></a><span id="l17.194" class="difflineplus">+        console.warn(</span>
<a href="#l17.195"></a><span id="l17.195" class="difflineplus">+            &quot;Event &quot; + event.getId() + &quot;: Intended recipient &quot; +</span>
<a href="#l17.196"></a><span id="l17.196" class="difflineplus">+            payload.recipient + &quot; does not match our id &quot; + this._userId</span>
<a href="#l17.197"></a><span id="l17.197" class="difflineplus">+        );</span>
<a href="#l17.198"></a><span id="l17.198" class="difflineplus">+        throw new base.DecryptionError(</span>
<a href="#l17.199"></a><span id="l17.199" class="difflineplus">+            &quot;Message was intented for &quot; + payload.recipient</span>
<a href="#l17.200"></a><span id="l17.200" class="difflineplus">+        );</span>
<a href="#l17.201"></a><span id="l17.201" class="difflineplus">+    }</span>
<a href="#l17.202"></a><span id="l17.202" class="difflineplus">+</span>
<a href="#l17.203"></a><span id="l17.203" class="difflineplus">+    if (payload.recipient_keys.ed25519 !=</span>
<a href="#l17.204"></a><span id="l17.204" class="difflineplus">+               this._olmDevice.deviceEd25519Key) {</span>
<a href="#l17.205"></a><span id="l17.205" class="difflineplus">+        console.warn(</span>
<a href="#l17.206"></a><span id="l17.206" class="difflineplus">+            &quot;Event &quot; + event.getId() + &quot;: Intended recipient ed25519 key &quot; +</span>
<a href="#l17.207"></a><span id="l17.207" class="difflineplus">+            payload.recipient_keys.ed25519 + &quot; did not match ours&quot;</span>
<a href="#l17.208"></a><span id="l17.208" class="difflineplus">+        );</span>
<a href="#l17.209"></a><span id="l17.209" class="difflineplus">+        throw new base.DecryptionError(&quot;Message not intended for this device&quot;);</span>
<a href="#l17.210"></a><span id="l17.210" class="difflineplus">+    }</span>
<a href="#l17.211"></a><span id="l17.211" class="difflineplus">+</span>
<a href="#l17.212"></a><span id="l17.212" class="difflineplus">+    // check that the original sender matches what the homeserver told us, to</span>
<a href="#l17.213"></a><span id="l17.213" class="difflineplus">+    // avoid people masquerading as others.</span>
<a href="#l17.214"></a><span id="l17.214" class="difflineplus">+    // (this check is also provided via the sender's embedded ed25519 key,</span>
<a href="#l17.215"></a><span id="l17.215" class="difflineplus">+    // which is checked elsewhere).</span>
<a href="#l17.216"></a><span id="l17.216" class="difflineplus">+    if (payload.sender != event.getSender()) {</span>
<a href="#l17.217"></a><span id="l17.217" class="difflineplus">+        console.warn(</span>
<a href="#l17.218"></a><span id="l17.218" class="difflineplus">+            &quot;Event &quot; + event.getId() + &quot;: original sender &quot; + payload.sender +</span>
<a href="#l17.219"></a><span id="l17.219" class="difflineplus">+            &quot; does not match reported sender &quot; + event.getSender()</span>
<a href="#l17.220"></a><span id="l17.220" class="difflineplus">+        );</span>
<a href="#l17.221"></a><span id="l17.221" class="difflineplus">+        throw new base.DecryptionError(</span>
<a href="#l17.222"></a><span id="l17.222" class="difflineplus">+            &quot;Message forwarded from &quot; + payload.sender</span>
<a href="#l17.223"></a><span id="l17.223" class="difflineplus">+        );</span>
<a href="#l17.224"></a><span id="l17.224" class="difflineplus">+    }</span>
<a href="#l17.225"></a><span id="l17.225" class="difflineplus">+</span>
<a href="#l17.226"></a><span id="l17.226" class="difflineplus">+    // Olm events intended for a room have a room_id.</span>
<a href="#l17.227"></a><span id="l17.227" class="difflineplus">+    if (payload.room_id !== event.getRoomId()) {</span>
<a href="#l17.228"></a><span id="l17.228" class="difflineplus">+        console.warn(</span>
<a href="#l17.229"></a><span id="l17.229" class="difflineplus">+            &quot;Event &quot; + event.getId() + &quot;: original room &quot; + payload.room_id +</span>
<a href="#l17.230"></a><span id="l17.230" class="difflineplus">+            &quot; does not match reported room &quot; + event.room_id</span>
<a href="#l17.231"></a><span id="l17.231" class="difflineplus">+        );</span>
<a href="#l17.232"></a><span id="l17.232" class="difflineplus">+        throw new base.DecryptionError(</span>
<a href="#l17.233"></a><span id="l17.233" class="difflineplus">+            &quot;Message intended for room &quot; + payload.room_id</span>
<a href="#l17.234"></a><span id="l17.234" class="difflineplus">+        );</span>
<a href="#l17.235"></a><span id="l17.235" class="difflineplus">+    }</span>
<a href="#l17.236"></a><span id="l17.236" class="difflineplus">+</span>
<a href="#l17.237"></a><span id="l17.237" class="difflineplus">+    event.setClearData(payload, {curve25519: deviceKey}, payload.keys || {});</span>
<a href="#l17.238"></a><span id="l17.238" class="difflineplus">+};</span>
<a href="#l17.239"></a><span id="l17.239" class="difflineplus">+</span>
<a href="#l17.240"></a><span id="l17.240" class="difflineplus">+</span>
<a href="#l17.241"></a><span id="l17.241" class="difflineplus">+/**</span>
<a href="#l17.242"></a><span id="l17.242" class="difflineplus">+ * Attempt to decrypt an Olm message</span>
<a href="#l17.243"></a><span id="l17.243" class="difflineplus">+ *</span>
<a href="#l17.244"></a><span id="l17.244" class="difflineplus">+ * @param {string} theirDeviceIdentityKey  Curve25519 identity key of the sender</span>
<a href="#l17.245"></a><span id="l17.245" class="difflineplus">+ * @param {object} message  message object, with 'type' and 'body' fields</span>
<a href="#l17.246"></a><span id="l17.246" class="difflineplus">+ *</span>
<a href="#l17.247"></a><span id="l17.247" class="difflineplus">+ * @return {string} payload, if decrypted successfully.</span>
<a href="#l17.248"></a><span id="l17.248" class="difflineplus">+ */</span>
<a href="#l17.249"></a><span id="l17.249" class="difflineplus">+OlmDecryption.prototype._decryptMessage = function(theirDeviceIdentityKey, message) {</span>
<a href="#l17.250"></a><span id="l17.250" class="difflineplus">+    var sessionIds = this._olmDevice.getSessionIdsForDevice(theirDeviceIdentityKey);</span>
<a href="#l17.251"></a><span id="l17.251" class="difflineplus">+</span>
<a href="#l17.252"></a><span id="l17.252" class="difflineplus">+    // try each session in turn.</span>
<a href="#l17.253"></a><span id="l17.253" class="difflineplus">+    var decryptionErrors = {};</span>
<a href="#l17.254"></a><span id="l17.254" class="difflineplus">+    for (var i = 0; i &lt; sessionIds.length; i++) {</span>
<a href="#l17.255"></a><span id="l17.255" class="difflineplus">+        var sessionId = sessionIds[i];</span>
<a href="#l17.256"></a><span id="l17.256" class="difflineplus">+        try {</span>
<a href="#l17.257"></a><span id="l17.257" class="difflineplus">+            var payload = this._olmDevice.decryptMessage(</span>
<a href="#l17.258"></a><span id="l17.258" class="difflineplus">+                theirDeviceIdentityKey, sessionId, message.type, message.body</span>
<a href="#l17.259"></a><span id="l17.259" class="difflineplus">+            );</span>
<a href="#l17.260"></a><span id="l17.260" class="difflineplus">+            console.log(</span>
<a href="#l17.261"></a><span id="l17.261" class="difflineplus">+                &quot;Decrypted Olm message from &quot; + theirDeviceIdentityKey +</span>
<a href="#l17.262"></a><span id="l17.262" class="difflineplus">+                    &quot; with session &quot; + sessionId</span>
<a href="#l17.263"></a><span id="l17.263" class="difflineplus">+            );</span>
<a href="#l17.264"></a><span id="l17.264" class="difflineplus">+            return payload;</span>
<a href="#l17.265"></a><span id="l17.265" class="difflineplus">+        } catch (e) {</span>
<a href="#l17.266"></a><span id="l17.266" class="difflineplus">+            var foundSession = this._olmDevice.matchesSession(</span>
<a href="#l17.267"></a><span id="l17.267" class="difflineplus">+                theirDeviceIdentityKey, sessionId, message.type, message.body</span>
<a href="#l17.268"></a><span id="l17.268" class="difflineplus">+            );</span>
<a href="#l17.269"></a><span id="l17.269" class="difflineplus">+</span>
<a href="#l17.270"></a><span id="l17.270" class="difflineplus">+            if (foundSession) {</span>
<a href="#l17.271"></a><span id="l17.271" class="difflineplus">+                // decryption failed, but it was a prekey message matching this</span>
<a href="#l17.272"></a><span id="l17.272" class="difflineplus">+                // session, so it should have worked.</span>
<a href="#l17.273"></a><span id="l17.273" class="difflineplus">+                throw new Error(</span>
<a href="#l17.274"></a><span id="l17.274" class="difflineplus">+                    &quot;Error decrypting prekey message with existing session id &quot; +</span>
<a href="#l17.275"></a><span id="l17.275" class="difflineplus">+                        sessionId + &quot;: &quot; + e.message</span>
<a href="#l17.276"></a><span id="l17.276" class="difflineplus">+                );</span>
<a href="#l17.277"></a><span id="l17.277" class="difflineplus">+            }</span>
<a href="#l17.278"></a><span id="l17.278" class="difflineplus">+</span>
<a href="#l17.279"></a><span id="l17.279" class="difflineplus">+            // otherwise it's probably a message for another session; carry on, but</span>
<a href="#l17.280"></a><span id="l17.280" class="difflineplus">+            // keep a record of the error</span>
<a href="#l17.281"></a><span id="l17.281" class="difflineplus">+            decryptionErrors[sessionId] = e.message;</span>
<a href="#l17.282"></a><span id="l17.282" class="difflineplus">+        }</span>
<a href="#l17.283"></a><span id="l17.283" class="difflineplus">+    }</span>
<a href="#l17.284"></a><span id="l17.284" class="difflineplus">+</span>
<a href="#l17.285"></a><span id="l17.285" class="difflineplus">+    if (message.type !== 0) {</span>
<a href="#l17.286"></a><span id="l17.286" class="difflineplus">+        // not a prekey message, so it should have matched an existing session, but it</span>
<a href="#l17.287"></a><span id="l17.287" class="difflineplus">+        // didn't work.</span>
<a href="#l17.288"></a><span id="l17.288" class="difflineplus">+</span>
<a href="#l17.289"></a><span id="l17.289" class="difflineplus">+        if (sessionIds.length === 0) {</span>
<a href="#l17.290"></a><span id="l17.290" class="difflineplus">+            throw new Error(&quot;No existing sessions&quot;);</span>
<a href="#l17.291"></a><span id="l17.291" class="difflineplus">+        }</span>
<a href="#l17.292"></a><span id="l17.292" class="difflineplus">+</span>
<a href="#l17.293"></a><span id="l17.293" class="difflineplus">+        throw new Error(</span>
<a href="#l17.294"></a><span id="l17.294" class="difflineplus">+            &quot;Error decrypting non-prekey message with existing sessions: &quot; +</span>
<a href="#l17.295"></a><span id="l17.295" class="difflineplus">+                JSON.stringify(decryptionErrors)</span>
<a href="#l17.296"></a><span id="l17.296" class="difflineplus">+        );</span>
<a href="#l17.297"></a><span id="l17.297" class="difflineplus">+    }</span>
<a href="#l17.298"></a><span id="l17.298" class="difflineplus">+</span>
<a href="#l17.299"></a><span id="l17.299" class="difflineplus">+    // prekey message which doesn't match any existing sessions: make a new</span>
<a href="#l17.300"></a><span id="l17.300" class="difflineplus">+    // session.</span>
<a href="#l17.301"></a><span id="l17.301" class="difflineplus">+</span>
<a href="#l17.302"></a><span id="l17.302" class="difflineplus">+    var res;</span>
<a href="#l17.303"></a><span id="l17.303" class="difflineplus">+    try {</span>
<a href="#l17.304"></a><span id="l17.304" class="difflineplus">+        res = this._olmDevice.createInboundSession(</span>
<a href="#l17.305"></a><span id="l17.305" class="difflineplus">+            theirDeviceIdentityKey, message.type, message.body</span>
<a href="#l17.306"></a><span id="l17.306" class="difflineplus">+        );</span>
<a href="#l17.307"></a><span id="l17.307" class="difflineplus">+    } catch (e) {</span>
<a href="#l17.308"></a><span id="l17.308" class="difflineplus">+        decryptionErrors[&quot;(new)&quot;] = e.message;</span>
<a href="#l17.309"></a><span id="l17.309" class="difflineplus">+        throw new Error(</span>
<a href="#l17.310"></a><span id="l17.310" class="difflineplus">+            &quot;Error decrypting prekey message: &quot; +</span>
<a href="#l17.311"></a><span id="l17.311" class="difflineplus">+                JSON.stringify(decryptionErrors)</span>
<a href="#l17.312"></a><span id="l17.312" class="difflineplus">+        );</span>
<a href="#l17.313"></a><span id="l17.313" class="difflineplus">+    }</span>
<a href="#l17.314"></a><span id="l17.314" class="difflineplus">+</span>
<a href="#l17.315"></a><span id="l17.315" class="difflineplus">+    console.log(</span>
<a href="#l17.316"></a><span id="l17.316" class="difflineplus">+        &quot;created new inbound Olm session ID &quot; +</span>
<a href="#l17.317"></a><span id="l17.317" class="difflineplus">+            res.session_id + &quot; with &quot; + theirDeviceIdentityKey</span>
<a href="#l17.318"></a><span id="l17.318" class="difflineplus">+    );</span>
<a href="#l17.319"></a><span id="l17.319" class="difflineplus">+    return res.payload;</span>
<a href="#l17.320"></a><span id="l17.320" class="difflineplus">+};</span>
<a href="#l17.321"></a><span id="l17.321" class="difflineplus">+</span>
<a href="#l17.322"></a><span id="l17.322" class="difflineplus">+</span>
<a href="#l17.323"></a><span id="l17.323" class="difflineplus">+base.registerAlgorithm(olmlib.OLM_ALGORITHM, OlmEncryption, OlmDecryption);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1">new file mode 100644</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineminus">--- /dev/null</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineplus">+++ b/chat/protocols/matrix/matrix-sdk/crypto/deviceinfo.js</span>
<a href="#l18.4"></a><span id="l18.4" class="difflineat">@@ -0,0 +1,145 @@</span>
<a href="#l18.5"></a><span id="l18.5" class="difflineplus">+/*</span>
<a href="#l18.6"></a><span id="l18.6" class="difflineplus">+Copyright 2016 OpenMarket Ltd</span>
<a href="#l18.7"></a><span id="l18.7" class="difflineplus">+</span>
<a href="#l18.8"></a><span id="l18.8" class="difflineplus">+Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<a href="#l18.9"></a><span id="l18.9" class="difflineplus">+you may not use this file except in compliance with the License.</span>
<a href="#l18.10"></a><span id="l18.10" class="difflineplus">+You may obtain a copy of the License at</span>
<a href="#l18.11"></a><span id="l18.11" class="difflineplus">+</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineplus">+    http://www.apache.org/licenses/LICENSE-2.0</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineplus">+</span>
<a href="#l18.14"></a><span id="l18.14" class="difflineplus">+Unless required by applicable law or agreed to in writing, software</span>
<a href="#l18.15"></a><span id="l18.15" class="difflineplus">+distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<a href="#l18.16"></a><span id="l18.16" class="difflineplus">+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<a href="#l18.17"></a><span id="l18.17" class="difflineplus">+See the License for the specific language governing permissions and</span>
<a href="#l18.18"></a><span id="l18.18" class="difflineplus">+limitations under the License.</span>
<a href="#l18.19"></a><span id="l18.19" class="difflineplus">+*/</span>
<a href="#l18.20"></a><span id="l18.20" class="difflineplus">+&quot;use strict&quot;;</span>
<a href="#l18.21"></a><span id="l18.21" class="difflineplus">+</span>
<a href="#l18.22"></a><span id="l18.22" class="difflineplus">+</span>
<a href="#l18.23"></a><span id="l18.23" class="difflineplus">+/**</span>
<a href="#l18.24"></a><span id="l18.24" class="difflineplus">+ * @module crypto/deviceinfo</span>
<a href="#l18.25"></a><span id="l18.25" class="difflineplus">+ */</span>
<a href="#l18.26"></a><span id="l18.26" class="difflineplus">+</span>
<a href="#l18.27"></a><span id="l18.27" class="difflineplus">+/**</span>
<a href="#l18.28"></a><span id="l18.28" class="difflineplus">+  * Information about a user's device</span>
<a href="#l18.29"></a><span id="l18.29" class="difflineplus">+  *</span>
<a href="#l18.30"></a><span id="l18.30" class="difflineplus">+  * @constructor</span>
<a href="#l18.31"></a><span id="l18.31" class="difflineplus">+  * @alias module:crypto/deviceinfo</span>
<a href="#l18.32"></a><span id="l18.32" class="difflineplus">+  *</span>
<a href="#l18.33"></a><span id="l18.33" class="difflineplus">+  * @property {string} deviceId the ID of this device</span>
<a href="#l18.34"></a><span id="l18.34" class="difflineplus">+  *</span>
<a href="#l18.35"></a><span id="l18.35" class="difflineplus">+  * @property {string[]} algorithms list of algorithms supported by this device</span>
<a href="#l18.36"></a><span id="l18.36" class="difflineplus">+  *</span>
<a href="#l18.37"></a><span id="l18.37" class="difflineplus">+  * @property {Object.&lt;string,string&gt;} keys a map from</span>
<a href="#l18.38"></a><span id="l18.38" class="difflineplus">+  *      &amp;lt;key type&amp;gt;:&amp;lt;id&amp;gt; -&gt; &amp;lt;base64-encoded key&amp;gt;&gt;</span>
<a href="#l18.39"></a><span id="l18.39" class="difflineplus">+  *</span>
<a href="#l18.40"></a><span id="l18.40" class="difflineplus">+  * @property {module:crypto/deviceinfo.DeviceVerification} verified</span>
<a href="#l18.41"></a><span id="l18.41" class="difflineplus">+  *     whether the device has been verified by the user</span>
<a href="#l18.42"></a><span id="l18.42" class="difflineplus">+  *</span>
<a href="#l18.43"></a><span id="l18.43" class="difflineplus">+  * @property {Object} unsigned  additional data from the homeserver</span>
<a href="#l18.44"></a><span id="l18.44" class="difflineplus">+  *</span>
<a href="#l18.45"></a><span id="l18.45" class="difflineplus">+  * @param {string} deviceId id of the device</span>
<a href="#l18.46"></a><span id="l18.46" class="difflineplus">+  */</span>
<a href="#l18.47"></a><span id="l18.47" class="difflineplus">+function DeviceInfo(deviceId) {</span>
<a href="#l18.48"></a><span id="l18.48" class="difflineplus">+    // you can't change the deviceId</span>
<a href="#l18.49"></a><span id="l18.49" class="difflineplus">+    Object.defineProperty(this, 'deviceId', {</span>
<a href="#l18.50"></a><span id="l18.50" class="difflineplus">+        enumerable: true,</span>
<a href="#l18.51"></a><span id="l18.51" class="difflineplus">+        value: deviceId,</span>
<a href="#l18.52"></a><span id="l18.52" class="difflineplus">+    });</span>
<a href="#l18.53"></a><span id="l18.53" class="difflineplus">+</span>
<a href="#l18.54"></a><span id="l18.54" class="difflineplus">+    this.algorithms = [];</span>
<a href="#l18.55"></a><span id="l18.55" class="difflineplus">+    this.keys = {};</span>
<a href="#l18.56"></a><span id="l18.56" class="difflineplus">+    this.verified = DeviceVerification.UNVERIFIED;</span>
<a href="#l18.57"></a><span id="l18.57" class="difflineplus">+    this.unsigned = {};</span>
<a href="#l18.58"></a><span id="l18.58" class="difflineplus">+}</span>
<a href="#l18.59"></a><span id="l18.59" class="difflineplus">+</span>
<a href="#l18.60"></a><span id="l18.60" class="difflineplus">+/**</span>
<a href="#l18.61"></a><span id="l18.61" class="difflineplus">+ * rehydrate a DeviceInfo from the session store</span>
<a href="#l18.62"></a><span id="l18.62" class="difflineplus">+ *</span>
<a href="#l18.63"></a><span id="l18.63" class="difflineplus">+ * @param {object} obj  raw object from session store</span>
<a href="#l18.64"></a><span id="l18.64" class="difflineplus">+ * @param {string} deviceId id of the device</span>
<a href="#l18.65"></a><span id="l18.65" class="difflineplus">+ *</span>
<a href="#l18.66"></a><span id="l18.66" class="difflineplus">+ * @return {module:crypto~DeviceInfo} new DeviceInfo</span>
<a href="#l18.67"></a><span id="l18.67" class="difflineplus">+ */</span>
<a href="#l18.68"></a><span id="l18.68" class="difflineplus">+DeviceInfo.fromStorage = function(obj, deviceId) {</span>
<a href="#l18.69"></a><span id="l18.69" class="difflineplus">+    var res = new DeviceInfo(deviceId);</span>
<a href="#l18.70"></a><span id="l18.70" class="difflineplus">+    for (var prop in obj) {</span>
<a href="#l18.71"></a><span id="l18.71" class="difflineplus">+        if (obj.hasOwnProperty(prop)) {</span>
<a href="#l18.72"></a><span id="l18.72" class="difflineplus">+            res[prop] = obj[prop];</span>
<a href="#l18.73"></a><span id="l18.73" class="difflineplus">+        }</span>
<a href="#l18.74"></a><span id="l18.74" class="difflineplus">+    }</span>
<a href="#l18.75"></a><span id="l18.75" class="difflineplus">+    return res;</span>
<a href="#l18.76"></a><span id="l18.76" class="difflineplus">+};</span>
<a href="#l18.77"></a><span id="l18.77" class="difflineplus">+</span>
<a href="#l18.78"></a><span id="l18.78" class="difflineplus">+/**</span>
<a href="#l18.79"></a><span id="l18.79" class="difflineplus">+ * Prepare a DeviceInfo for JSON serialisation in the session store</span>
<a href="#l18.80"></a><span id="l18.80" class="difflineplus">+ *</span>
<a href="#l18.81"></a><span id="l18.81" class="difflineplus">+ * @return {object} deviceinfo with non-serialised members removed</span>
<a href="#l18.82"></a><span id="l18.82" class="difflineplus">+ */</span>
<a href="#l18.83"></a><span id="l18.83" class="difflineplus">+DeviceInfo.prototype.toStorage = function() {</span>
<a href="#l18.84"></a><span id="l18.84" class="difflineplus">+    return {</span>
<a href="#l18.85"></a><span id="l18.85" class="difflineplus">+        algorithms: this.algorithms,</span>
<a href="#l18.86"></a><span id="l18.86" class="difflineplus">+        keys: this.keys,</span>
<a href="#l18.87"></a><span id="l18.87" class="difflineplus">+        verified: this.verified,</span>
<a href="#l18.88"></a><span id="l18.88" class="difflineplus">+        unsigned: this.unsigned,</span>
<a href="#l18.89"></a><span id="l18.89" class="difflineplus">+    };</span>
<a href="#l18.90"></a><span id="l18.90" class="difflineplus">+};</span>
<a href="#l18.91"></a><span id="l18.91" class="difflineplus">+</span>
<a href="#l18.92"></a><span id="l18.92" class="difflineplus">+/**</span>
<a href="#l18.93"></a><span id="l18.93" class="difflineplus">+ * Get the fingerprint for this device (ie, the Ed25519 key)</span>
<a href="#l18.94"></a><span id="l18.94" class="difflineplus">+ *</span>
<a href="#l18.95"></a><span id="l18.95" class="difflineplus">+ * @return {string} base64-encoded fingerprint of this device</span>
<a href="#l18.96"></a><span id="l18.96" class="difflineplus">+ */</span>
<a href="#l18.97"></a><span id="l18.97" class="difflineplus">+DeviceInfo.prototype.getFingerprint = function() {</span>
<a href="#l18.98"></a><span id="l18.98" class="difflineplus">+    return this.keys[&quot;ed25519:&quot; + this.deviceId];</span>
<a href="#l18.99"></a><span id="l18.99" class="difflineplus">+};</span>
<a href="#l18.100"></a><span id="l18.100" class="difflineplus">+</span>
<a href="#l18.101"></a><span id="l18.101" class="difflineplus">+/**</span>
<a href="#l18.102"></a><span id="l18.102" class="difflineplus">+ * Get the identity key for this device (ie, the Curve25519 key)</span>
<a href="#l18.103"></a><span id="l18.103" class="difflineplus">+ *</span>
<a href="#l18.104"></a><span id="l18.104" class="difflineplus">+ * @return {string} base64-encoded identity key of this device</span>
<a href="#l18.105"></a><span id="l18.105" class="difflineplus">+ */</span>
<a href="#l18.106"></a><span id="l18.106" class="difflineplus">+DeviceInfo.prototype.getIdentityKey = function() {</span>
<a href="#l18.107"></a><span id="l18.107" class="difflineplus">+    return this.keys[&quot;curve25519:&quot; + this.deviceId];</span>
<a href="#l18.108"></a><span id="l18.108" class="difflineplus">+};</span>
<a href="#l18.109"></a><span id="l18.109" class="difflineplus">+</span>
<a href="#l18.110"></a><span id="l18.110" class="difflineplus">+/**</span>
<a href="#l18.111"></a><span id="l18.111" class="difflineplus">+ * Get the configured display name for this device, if any</span>
<a href="#l18.112"></a><span id="l18.112" class="difflineplus">+ *</span>
<a href="#l18.113"></a><span id="l18.113" class="difflineplus">+ * @return {string?} displayname</span>
<a href="#l18.114"></a><span id="l18.114" class="difflineplus">+ */</span>
<a href="#l18.115"></a><span id="l18.115" class="difflineplus">+DeviceInfo.prototype.getDisplayName = function() {</span>
<a href="#l18.116"></a><span id="l18.116" class="difflineplus">+    return this.unsigned.device_display_name || null;</span>
<a href="#l18.117"></a><span id="l18.117" class="difflineplus">+};</span>
<a href="#l18.118"></a><span id="l18.118" class="difflineplus">+</span>
<a href="#l18.119"></a><span id="l18.119" class="difflineplus">+/**</span>
<a href="#l18.120"></a><span id="l18.120" class="difflineplus">+ * Returns true if this device is blocked</span>
<a href="#l18.121"></a><span id="l18.121" class="difflineplus">+ *</span>
<a href="#l18.122"></a><span id="l18.122" class="difflineplus">+ * @return {Boolean} true if blocked</span>
<a href="#l18.123"></a><span id="l18.123" class="difflineplus">+ */</span>
<a href="#l18.124"></a><span id="l18.124" class="difflineplus">+DeviceInfo.prototype.isBlocked = function() {</span>
<a href="#l18.125"></a><span id="l18.125" class="difflineplus">+    return this.verified == DeviceVerification.BLOCKED;</span>
<a href="#l18.126"></a><span id="l18.126" class="difflineplus">+};</span>
<a href="#l18.127"></a><span id="l18.127" class="difflineplus">+</span>
<a href="#l18.128"></a><span id="l18.128" class="difflineplus">+/**</span>
<a href="#l18.129"></a><span id="l18.129" class="difflineplus">+ * Returns true if this device is verified</span>
<a href="#l18.130"></a><span id="l18.130" class="difflineplus">+ *</span>
<a href="#l18.131"></a><span id="l18.131" class="difflineplus">+ * @return {Boolean} true if verified</span>
<a href="#l18.132"></a><span id="l18.132" class="difflineplus">+ */</span>
<a href="#l18.133"></a><span id="l18.133" class="difflineplus">+DeviceInfo.prototype.isVerified = function() {</span>
<a href="#l18.134"></a><span id="l18.134" class="difflineplus">+    return this.verified == DeviceVerification.VERIFIED;</span>
<a href="#l18.135"></a><span id="l18.135" class="difflineplus">+};</span>
<a href="#l18.136"></a><span id="l18.136" class="difflineplus">+</span>
<a href="#l18.137"></a><span id="l18.137" class="difflineplus">+/**</span>
<a href="#l18.138"></a><span id="l18.138" class="difflineplus">+ * @enum</span>
<a href="#l18.139"></a><span id="l18.139" class="difflineplus">+ */</span>
<a href="#l18.140"></a><span id="l18.140" class="difflineplus">+DeviceInfo.DeviceVerification = {</span>
<a href="#l18.141"></a><span id="l18.141" class="difflineplus">+    VERIFIED: 1,</span>
<a href="#l18.142"></a><span id="l18.142" class="difflineplus">+    UNVERIFIED: 0,</span>
<a href="#l18.143"></a><span id="l18.143" class="difflineplus">+    BLOCKED: -1,</span>
<a href="#l18.144"></a><span id="l18.144" class="difflineplus">+};</span>
<a href="#l18.145"></a><span id="l18.145" class="difflineplus">+</span>
<a href="#l18.146"></a><span id="l18.146" class="difflineplus">+var DeviceVerification = DeviceInfo.DeviceVerification;</span>
<a href="#l18.147"></a><span id="l18.147" class="difflineplus">+</span>
<a href="#l18.148"></a><span id="l18.148" class="difflineplus">+/** */</span>
<a href="#l18.149"></a><span id="l18.149" class="difflineplus">+module.exports = DeviceInfo;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1">new file mode 100644</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineminus">--- /dev/null</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineplus">+++ b/chat/protocols/matrix/matrix-sdk/crypto/index.js</span>
<a href="#l19.4"></a><span id="l19.4" class="difflineat">@@ -0,0 +1,1259 @@</span>
<a href="#l19.5"></a><span id="l19.5" class="difflineplus">+/*</span>
<a href="#l19.6"></a><span id="l19.6" class="difflineplus">+Copyright 2016 OpenMarket Ltd</span>
<a href="#l19.7"></a><span id="l19.7" class="difflineplus">+</span>
<a href="#l19.8"></a><span id="l19.8" class="difflineplus">+Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<a href="#l19.9"></a><span id="l19.9" class="difflineplus">+you may not use this file except in compliance with the License.</span>
<a href="#l19.10"></a><span id="l19.10" class="difflineplus">+You may obtain a copy of the License at</span>
<a href="#l19.11"></a><span id="l19.11" class="difflineplus">+</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineplus">+    http://www.apache.org/licenses/LICENSE-2.0</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineplus">+</span>
<a href="#l19.14"></a><span id="l19.14" class="difflineplus">+Unless required by applicable law or agreed to in writing, software</span>
<a href="#l19.15"></a><span id="l19.15" class="difflineplus">+distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<a href="#l19.16"></a><span id="l19.16" class="difflineplus">+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<a href="#l19.17"></a><span id="l19.17" class="difflineplus">+See the License for the specific language governing permissions and</span>
<a href="#l19.18"></a><span id="l19.18" class="difflineplus">+limitations under the License.</span>
<a href="#l19.19"></a><span id="l19.19" class="difflineplus">+*/</span>
<a href="#l19.20"></a><span id="l19.20" class="difflineplus">+&quot;use strict&quot;;</span>
<a href="#l19.21"></a><span id="l19.21" class="difflineplus">+</span>
<a href="#l19.22"></a><span id="l19.22" class="difflineplus">+</span>
<a href="#l19.23"></a><span id="l19.23" class="difflineplus">+/**</span>
<a href="#l19.24"></a><span id="l19.24" class="difflineplus">+ * @module crypto</span>
<a href="#l19.25"></a><span id="l19.25" class="difflineplus">+ */</span>
<a href="#l19.26"></a><span id="l19.26" class="difflineplus">+</span>
<a href="#l19.27"></a><span id="l19.27" class="difflineplus">+var anotherjson = require('another-json');</span>
<a href="#l19.28"></a><span id="l19.28" class="difflineplus">+var q = require(&quot;q&quot;);</span>
<a href="#l19.29"></a><span id="l19.29" class="difflineplus">+</span>
<a href="#l19.30"></a><span id="l19.30" class="difflineplus">+var utils = require(&quot;../utils&quot;);</span>
<a href="#l19.31"></a><span id="l19.31" class="difflineplus">+var OlmDevice = require(&quot;./OlmDevice&quot;);</span>
<a href="#l19.32"></a><span id="l19.32" class="difflineplus">+var olmlib = require(&quot;./olmlib&quot;);</span>
<a href="#l19.33"></a><span id="l19.33" class="difflineplus">+var algorithms = require(&quot;./algorithms&quot;);</span>
<a href="#l19.34"></a><span id="l19.34" class="difflineplus">+var DeviceInfo = require(&quot;./deviceinfo&quot;);</span>
<a href="#l19.35"></a><span id="l19.35" class="difflineplus">+var DeviceVerification = DeviceInfo.DeviceVerification;</span>
<a href="#l19.36"></a><span id="l19.36" class="difflineplus">+</span>
<a href="#l19.37"></a><span id="l19.37" class="difflineplus">+/**</span>
<a href="#l19.38"></a><span id="l19.38" class="difflineplus">+ * Cryptography bits</span>
<a href="#l19.39"></a><span id="l19.39" class="difflineplus">+ *</span>
<a href="#l19.40"></a><span id="l19.40" class="difflineplus">+ * @constructor</span>
<a href="#l19.41"></a><span id="l19.41" class="difflineplus">+ * @alias module:crypto</span>
<a href="#l19.42"></a><span id="l19.42" class="difflineplus">+ *</span>
<a href="#l19.43"></a><span id="l19.43" class="difflineplus">+ * @param {module:base-apis~MatrixBaseApis} baseApis base matrix api interface</span>
<a href="#l19.44"></a><span id="l19.44" class="difflineplus">+ *</span>
<a href="#l19.45"></a><span id="l19.45" class="difflineplus">+ * @param {external:EventEmitter} eventEmitter event source where we can register</span>
<a href="#l19.46"></a><span id="l19.46" class="difflineplus">+ *    for event notifications</span>
<a href="#l19.47"></a><span id="l19.47" class="difflineplus">+ *</span>
<a href="#l19.48"></a><span id="l19.48" class="difflineplus">+ * @param {module:store/session/webstorage~WebStorageSessionStore} sessionStore</span>
<a href="#l19.49"></a><span id="l19.49" class="difflineplus">+ *    Store to be used for end-to-end crypto session data</span>
<a href="#l19.50"></a><span id="l19.50" class="difflineplus">+ *</span>
<a href="#l19.51"></a><span id="l19.51" class="difflineplus">+ * @param {string} userId The user ID for the local user</span>
<a href="#l19.52"></a><span id="l19.52" class="difflineplus">+ *</span>
<a href="#l19.53"></a><span id="l19.53" class="difflineplus">+ * @param {string} deviceId The identifier for this device.</span>
<a href="#l19.54"></a><span id="l19.54" class="difflineplus">+ */</span>
<a href="#l19.55"></a><span id="l19.55" class="difflineplus">+function Crypto(baseApis, eventEmitter, sessionStore, userId, deviceId) {</span>
<a href="#l19.56"></a><span id="l19.56" class="difflineplus">+    this._baseApis = baseApis;</span>
<a href="#l19.57"></a><span id="l19.57" class="difflineplus">+    this._sessionStore = sessionStore;</span>
<a href="#l19.58"></a><span id="l19.58" class="difflineplus">+    this._userId = userId;</span>
<a href="#l19.59"></a><span id="l19.59" class="difflineplus">+    this._deviceId = deviceId;</span>
<a href="#l19.60"></a><span id="l19.60" class="difflineplus">+</span>
<a href="#l19.61"></a><span id="l19.61" class="difflineplus">+    this._initialSyncCompleted = false;</span>
<a href="#l19.62"></a><span id="l19.62" class="difflineplus">+    // userId -&gt; deviceId -&gt; true</span>
<a href="#l19.63"></a><span id="l19.63" class="difflineplus">+    this._pendingNewDevices = {};</span>
<a href="#l19.64"></a><span id="l19.64" class="difflineplus">+</span>
<a href="#l19.65"></a><span id="l19.65" class="difflineplus">+    this._olmDevice = new OlmDevice(sessionStore);</span>
<a href="#l19.66"></a><span id="l19.66" class="difflineplus">+</span>
<a href="#l19.67"></a><span id="l19.67" class="difflineplus">+    // EncryptionAlgorithm instance for each room</span>
<a href="#l19.68"></a><span id="l19.68" class="difflineplus">+    this._roomEncryptors = {};</span>
<a href="#l19.69"></a><span id="l19.69" class="difflineplus">+</span>
<a href="#l19.70"></a><span id="l19.70" class="difflineplus">+    // map from algorithm to DecryptionAlgorithm instance, for each room</span>
<a href="#l19.71"></a><span id="l19.71" class="difflineplus">+    this._roomDecryptors = {};</span>
<a href="#l19.72"></a><span id="l19.72" class="difflineplus">+</span>
<a href="#l19.73"></a><span id="l19.73" class="difflineplus">+    this._supportedAlgorithms = utils.keys(</span>
<a href="#l19.74"></a><span id="l19.74" class="difflineplus">+        algorithms.DECRYPTION_CLASSES</span>
<a href="#l19.75"></a><span id="l19.75" class="difflineplus">+    );</span>
<a href="#l19.76"></a><span id="l19.76" class="difflineplus">+</span>
<a href="#l19.77"></a><span id="l19.77" class="difflineplus">+    // build our device keys: these will later be uploaded</span>
<a href="#l19.78"></a><span id="l19.78" class="difflineplus">+    this._deviceKeys = {};</span>
<a href="#l19.79"></a><span id="l19.79" class="difflineplus">+    this._deviceKeys[&quot;ed25519:&quot; + this._deviceId] =</span>
<a href="#l19.80"></a><span id="l19.80" class="difflineplus">+        this._olmDevice.deviceEd25519Key;</span>
<a href="#l19.81"></a><span id="l19.81" class="difflineplus">+    this._deviceKeys[&quot;curve25519:&quot; + this._deviceId] =</span>
<a href="#l19.82"></a><span id="l19.82" class="difflineplus">+        this._olmDevice.deviceCurve25519Key;</span>
<a href="#l19.83"></a><span id="l19.83" class="difflineplus">+</span>
<a href="#l19.84"></a><span id="l19.84" class="difflineplus">+    // add our own deviceinfo to the sessionstore</span>
<a href="#l19.85"></a><span id="l19.85" class="difflineplus">+    var deviceInfo = {</span>
<a href="#l19.86"></a><span id="l19.86" class="difflineplus">+        keys: this._deviceKeys,</span>
<a href="#l19.87"></a><span id="l19.87" class="difflineplus">+        algorithms: this._supportedAlgorithms,</span>
<a href="#l19.88"></a><span id="l19.88" class="difflineplus">+        verified: DeviceVerification.VERIFIED,</span>
<a href="#l19.89"></a><span id="l19.89" class="difflineplus">+    };</span>
<a href="#l19.90"></a><span id="l19.90" class="difflineplus">+    var myDevices = this._sessionStore.getEndToEndDevicesForUser(</span>
<a href="#l19.91"></a><span id="l19.91" class="difflineplus">+        this._userId</span>
<a href="#l19.92"></a><span id="l19.92" class="difflineplus">+    ) || {};</span>
<a href="#l19.93"></a><span id="l19.93" class="difflineplus">+    myDevices[this._deviceId] = deviceInfo;</span>
<a href="#l19.94"></a><span id="l19.94" class="difflineplus">+    this._sessionStore.storeEndToEndDevicesForUser(</span>
<a href="#l19.95"></a><span id="l19.95" class="difflineplus">+        this._userId, myDevices</span>
<a href="#l19.96"></a><span id="l19.96" class="difflineplus">+    );</span>
<a href="#l19.97"></a><span id="l19.97" class="difflineplus">+</span>
<a href="#l19.98"></a><span id="l19.98" class="difflineplus">+    _registerEventHandlers(this, eventEmitter);</span>
<a href="#l19.99"></a><span id="l19.99" class="difflineplus">+</span>
<a href="#l19.100"></a><span id="l19.100" class="difflineplus">+    // map from userId -&gt; deviceId -&gt; roomId -&gt; timestamp</span>
<a href="#l19.101"></a><span id="l19.101" class="difflineplus">+    this._lastNewDeviceMessageTsByUserDeviceRoom = {};</span>
<a href="#l19.102"></a><span id="l19.102" class="difflineplus">+}</span>
<a href="#l19.103"></a><span id="l19.103" class="difflineplus">+</span>
<a href="#l19.104"></a><span id="l19.104" class="difflineplus">+function _registerEventHandlers(crypto, eventEmitter) {</span>
<a href="#l19.105"></a><span id="l19.105" class="difflineplus">+    eventEmitter.on(&quot;sync&quot;, function(syncState, oldState, data) {</span>
<a href="#l19.106"></a><span id="l19.106" class="difflineplus">+        try {</span>
<a href="#l19.107"></a><span id="l19.107" class="difflineplus">+            if (syncState == &quot;PREPARED&quot;) {</span>
<a href="#l19.108"></a><span id="l19.108" class="difflineplus">+                // XXX ugh. we're assuming the eventEmitter is a MatrixClient.</span>
<a href="#l19.109"></a><span id="l19.109" class="difflineplus">+                // how can we avoid doing so?</span>
<a href="#l19.110"></a><span id="l19.110" class="difflineplus">+                var rooms = eventEmitter.getRooms();</span>
<a href="#l19.111"></a><span id="l19.111" class="difflineplus">+                crypto._onInitialSyncCompleted(rooms);</span>
<a href="#l19.112"></a><span id="l19.112" class="difflineplus">+            }</span>
<a href="#l19.113"></a><span id="l19.113" class="difflineplus">+        } catch (e) {</span>
<a href="#l19.114"></a><span id="l19.114" class="difflineplus">+            console.error(&quot;Error handling sync&quot;, e);</span>
<a href="#l19.115"></a><span id="l19.115" class="difflineplus">+        }</span>
<a href="#l19.116"></a><span id="l19.116" class="difflineplus">+    });</span>
<a href="#l19.117"></a><span id="l19.117" class="difflineplus">+</span>
<a href="#l19.118"></a><span id="l19.118" class="difflineplus">+    eventEmitter.on(&quot;RoomMember.membership&quot;, function(event, member, oldMembership) {</span>
<a href="#l19.119"></a><span id="l19.119" class="difflineplus">+        try {</span>
<a href="#l19.120"></a><span id="l19.120" class="difflineplus">+            crypto._onRoomMembership(event, member, oldMembership);</span>
<a href="#l19.121"></a><span id="l19.121" class="difflineplus">+        } catch (e) {</span>
<a href="#l19.122"></a><span id="l19.122" class="difflineplus">+             console.error(&quot;Error handling membership change:&quot;, e);</span>
<a href="#l19.123"></a><span id="l19.123" class="difflineplus">+        }</span>
<a href="#l19.124"></a><span id="l19.124" class="difflineplus">+    });</span>
<a href="#l19.125"></a><span id="l19.125" class="difflineplus">+</span>
<a href="#l19.126"></a><span id="l19.126" class="difflineplus">+    eventEmitter.on(&quot;toDeviceEvent&quot;, function(event) {</span>
<a href="#l19.127"></a><span id="l19.127" class="difflineplus">+        try {</span>
<a href="#l19.128"></a><span id="l19.128" class="difflineplus">+            if (event.getType() == &quot;m.room_key&quot;) {</span>
<a href="#l19.129"></a><span id="l19.129" class="difflineplus">+                crypto._onRoomKeyEvent(event);</span>
<a href="#l19.130"></a><span id="l19.130" class="difflineplus">+            } else if (event.getType() == &quot;m.new_device&quot;) {</span>
<a href="#l19.131"></a><span id="l19.131" class="difflineplus">+                crypto._onNewDeviceEvent(event);</span>
<a href="#l19.132"></a><span id="l19.132" class="difflineplus">+            }</span>
<a href="#l19.133"></a><span id="l19.133" class="difflineplus">+        } catch (e) {</span>
<a href="#l19.134"></a><span id="l19.134" class="difflineplus">+            console.error(&quot;Error handling toDeviceEvent:&quot;, e);</span>
<a href="#l19.135"></a><span id="l19.135" class="difflineplus">+        }</span>
<a href="#l19.136"></a><span id="l19.136" class="difflineplus">+    });</span>
<a href="#l19.137"></a><span id="l19.137" class="difflineplus">+</span>
<a href="#l19.138"></a><span id="l19.138" class="difflineplus">+    eventEmitter.on(&quot;event&quot;, function(event) {</span>
<a href="#l19.139"></a><span id="l19.139" class="difflineplus">+        try {</span>
<a href="#l19.140"></a><span id="l19.140" class="difflineplus">+            if (!event.isState() || event.getType() != &quot;m.room.encryption&quot;) {</span>
<a href="#l19.141"></a><span id="l19.141" class="difflineplus">+                return;</span>
<a href="#l19.142"></a><span id="l19.142" class="difflineplus">+            }</span>
<a href="#l19.143"></a><span id="l19.143" class="difflineplus">+            crypto._onCryptoEvent(event);</span>
<a href="#l19.144"></a><span id="l19.144" class="difflineplus">+        } catch (e) {</span>
<a href="#l19.145"></a><span id="l19.145" class="difflineplus">+            console.error(&quot;Error handling crypto event:&quot;, e);</span>
<a href="#l19.146"></a><span id="l19.146" class="difflineplus">+        }</span>
<a href="#l19.147"></a><span id="l19.147" class="difflineplus">+    });</span>
<a href="#l19.148"></a><span id="l19.148" class="difflineplus">+}</span>
<a href="#l19.149"></a><span id="l19.149" class="difflineplus">+</span>
<a href="#l19.150"></a><span id="l19.150" class="difflineplus">+/**</span>
<a href="#l19.151"></a><span id="l19.151" class="difflineplus">+ * @return {string} The version of Olm.</span>
<a href="#l19.152"></a><span id="l19.152" class="difflineplus">+ */</span>
<a href="#l19.153"></a><span id="l19.153" class="difflineplus">+Crypto.getOlmVersion = function() {</span>
<a href="#l19.154"></a><span id="l19.154" class="difflineplus">+    return OlmDevice.getOlmVersion();</span>
<a href="#l19.155"></a><span id="l19.155" class="difflineplus">+};</span>
<a href="#l19.156"></a><span id="l19.156" class="difflineplus">+</span>
<a href="#l19.157"></a><span id="l19.157" class="difflineplus">+/**</span>
<a href="#l19.158"></a><span id="l19.158" class="difflineplus">+ * Get the Ed25519 key for this device</span>
<a href="#l19.159"></a><span id="l19.159" class="difflineplus">+ *</span>
<a href="#l19.160"></a><span id="l19.160" class="difflineplus">+ * @return {string} base64-encoded ed25519 key.</span>
<a href="#l19.161"></a><span id="l19.161" class="difflineplus">+ */</span>
<a href="#l19.162"></a><span id="l19.162" class="difflineplus">+Crypto.prototype.getDeviceEd25519Key = function() {</span>
<a href="#l19.163"></a><span id="l19.163" class="difflineplus">+    return this._olmDevice.deviceEd25519Key;</span>
<a href="#l19.164"></a><span id="l19.164" class="difflineplus">+};</span>
<a href="#l19.165"></a><span id="l19.165" class="difflineplus">+</span>
<a href="#l19.166"></a><span id="l19.166" class="difflineplus">+/**</span>
<a href="#l19.167"></a><span id="l19.167" class="difflineplus">+ * Upload the device keys to the homeserver and ensure that the</span>
<a href="#l19.168"></a><span id="l19.168" class="difflineplus">+ * homeserver has enough one-time keys.</span>
<a href="#l19.169"></a><span id="l19.169" class="difflineplus">+ * @param {number} maxKeys The maximum number of keys to generate</span>
<a href="#l19.170"></a><span id="l19.170" class="difflineplus">+ * @return {object} A promise that will resolve when the keys are uploaded.</span>
<a href="#l19.171"></a><span id="l19.171" class="difflineplus">+ */</span>
<a href="#l19.172"></a><span id="l19.172" class="difflineplus">+Crypto.prototype.uploadKeys = function(maxKeys) {</span>
<a href="#l19.173"></a><span id="l19.173" class="difflineplus">+    var self = this;</span>
<a href="#l19.174"></a><span id="l19.174" class="difflineplus">+    return _uploadDeviceKeys(this).then(function(res) {</span>
<a href="#l19.175"></a><span id="l19.175" class="difflineplus">+        // We need to keep a pool of one time public keys on the server so that</span>
<a href="#l19.176"></a><span id="l19.176" class="difflineplus">+        // other devices can start conversations with us. But we can only store</span>
<a href="#l19.177"></a><span id="l19.177" class="difflineplus">+        // a finite number of private keys in the olm Account object.</span>
<a href="#l19.178"></a><span id="l19.178" class="difflineplus">+        // To complicate things further then can be a delay between a device</span>
<a href="#l19.179"></a><span id="l19.179" class="difflineplus">+        // claiming a public one time key from the server and it sending us a</span>
<a href="#l19.180"></a><span id="l19.180" class="difflineplus">+        // message. We need to keep the corresponding private key locally until</span>
<a href="#l19.181"></a><span id="l19.181" class="difflineplus">+        // we receive the message.</span>
<a href="#l19.182"></a><span id="l19.182" class="difflineplus">+        // But that message might never arrive leaving us stuck with duff</span>
<a href="#l19.183"></a><span id="l19.183" class="difflineplus">+        // private keys clogging up our local storage.</span>
<a href="#l19.184"></a><span id="l19.184" class="difflineplus">+        // So we need some kind of enginering compromise to balance all of</span>
<a href="#l19.185"></a><span id="l19.185" class="difflineplus">+        // these factors.</span>
<a href="#l19.186"></a><span id="l19.186" class="difflineplus">+</span>
<a href="#l19.187"></a><span id="l19.187" class="difflineplus">+        // We first find how many keys the server has for us.</span>
<a href="#l19.188"></a><span id="l19.188" class="difflineplus">+        var keyCount = res.one_time_key_counts.signed_curve25519 || 0;</span>
<a href="#l19.189"></a><span id="l19.189" class="difflineplus">+        // We then check how many keys we can store in the Account object.</span>
<a href="#l19.190"></a><span id="l19.190" class="difflineplus">+        var maxOneTimeKeys = self._olmDevice.maxNumberOfOneTimeKeys();</span>
<a href="#l19.191"></a><span id="l19.191" class="difflineplus">+        // Try to keep at most half that number on the server. This leaves the</span>
<a href="#l19.192"></a><span id="l19.192" class="difflineplus">+        // rest of the slots free to hold keys that have been claimed from the</span>
<a href="#l19.193"></a><span id="l19.193" class="difflineplus">+        // server but we haven't recevied a message for.</span>
<a href="#l19.194"></a><span id="l19.194" class="difflineplus">+        // If we run out of slots when generating new keys then olm will</span>
<a href="#l19.195"></a><span id="l19.195" class="difflineplus">+        // discard the oldest private keys first. This will eventually clean</span>
<a href="#l19.196"></a><span id="l19.196" class="difflineplus">+        // out stale private keys that won't receive a message.</span>
<a href="#l19.197"></a><span id="l19.197" class="difflineplus">+        var keyLimit = Math.floor(maxOneTimeKeys / 2);</span>
<a href="#l19.198"></a><span id="l19.198" class="difflineplus">+        // We work out how many new keys we need to create to top up the server</span>
<a href="#l19.199"></a><span id="l19.199" class="difflineplus">+        // If there are too many keys on the server then we don't need to</span>
<a href="#l19.200"></a><span id="l19.200" class="difflineplus">+        // create any more keys.</span>
<a href="#l19.201"></a><span id="l19.201" class="difflineplus">+        var numberToGenerate = Math.max(keyLimit - keyCount, 0);</span>
<a href="#l19.202"></a><span id="l19.202" class="difflineplus">+        if (maxKeys !== undefined) {</span>
<a href="#l19.203"></a><span id="l19.203" class="difflineplus">+            // Creating keys can be an expensive operation so we limit the</span>
<a href="#l19.204"></a><span id="l19.204" class="difflineplus">+            // number we generate in one go to avoid blocking the application</span>
<a href="#l19.205"></a><span id="l19.205" class="difflineplus">+            // for too long.</span>
<a href="#l19.206"></a><span id="l19.206" class="difflineplus">+            numberToGenerate = Math.min(numberToGenerate, maxKeys);</span>
<a href="#l19.207"></a><span id="l19.207" class="difflineplus">+        }</span>
<a href="#l19.208"></a><span id="l19.208" class="difflineplus">+</span>
<a href="#l19.209"></a><span id="l19.209" class="difflineplus">+        if (numberToGenerate &lt;= 0) {</span>
<a href="#l19.210"></a><span id="l19.210" class="difflineplus">+            // If we don't need to generate any keys then we are done.</span>
<a href="#l19.211"></a><span id="l19.211" class="difflineplus">+            return;</span>
<a href="#l19.212"></a><span id="l19.212" class="difflineplus">+        }</span>
<a href="#l19.213"></a><span id="l19.213" class="difflineplus">+</span>
<a href="#l19.214"></a><span id="l19.214" class="difflineplus">+        // Ask olm to generate new one time keys, then upload them to synapse.</span>
<a href="#l19.215"></a><span id="l19.215" class="difflineplus">+        self._olmDevice.generateOneTimeKeys(numberToGenerate);</span>
<a href="#l19.216"></a><span id="l19.216" class="difflineplus">+        return _uploadOneTimeKeys(self);</span>
<a href="#l19.217"></a><span id="l19.217" class="difflineplus">+    });</span>
<a href="#l19.218"></a><span id="l19.218" class="difflineplus">+};</span>
<a href="#l19.219"></a><span id="l19.219" class="difflineplus">+</span>
<a href="#l19.220"></a><span id="l19.220" class="difflineplus">+// returns a promise which resolves to the response</span>
<a href="#l19.221"></a><span id="l19.221" class="difflineplus">+function _uploadDeviceKeys(crypto) {</span>
<a href="#l19.222"></a><span id="l19.222" class="difflineplus">+    var userId = crypto._userId;</span>
<a href="#l19.223"></a><span id="l19.223" class="difflineplus">+    var deviceId = crypto._deviceId;</span>
<a href="#l19.224"></a><span id="l19.224" class="difflineplus">+</span>
<a href="#l19.225"></a><span id="l19.225" class="difflineplus">+    var deviceKeys = {</span>
<a href="#l19.226"></a><span id="l19.226" class="difflineplus">+        algorithms: crypto._supportedAlgorithms,</span>
<a href="#l19.227"></a><span id="l19.227" class="difflineplus">+        device_id: deviceId,</span>
<a href="#l19.228"></a><span id="l19.228" class="difflineplus">+        keys: crypto._deviceKeys,</span>
<a href="#l19.229"></a><span id="l19.229" class="difflineplus">+        user_id: userId,</span>
<a href="#l19.230"></a><span id="l19.230" class="difflineplus">+    };</span>
<a href="#l19.231"></a><span id="l19.231" class="difflineplus">+    crypto._signObject(deviceKeys);</span>
<a href="#l19.232"></a><span id="l19.232" class="difflineplus">+</span>
<a href="#l19.233"></a><span id="l19.233" class="difflineplus">+    return crypto._baseApis.uploadKeysRequest({</span>
<a href="#l19.234"></a><span id="l19.234" class="difflineplus">+        device_keys: deviceKeys,</span>
<a href="#l19.235"></a><span id="l19.235" class="difflineplus">+    }, {</span>
<a href="#l19.236"></a><span id="l19.236" class="difflineplus">+        // for now, we set the device id explicitly, as we may not be using the</span>
<a href="#l19.237"></a><span id="l19.237" class="difflineplus">+        // same one as used in login.</span>
<a href="#l19.238"></a><span id="l19.238" class="difflineplus">+        device_id: deviceId,</span>
<a href="#l19.239"></a><span id="l19.239" class="difflineplus">+    });</span>
<a href="#l19.240"></a><span id="l19.240" class="difflineplus">+}</span>
<a href="#l19.241"></a><span id="l19.241" class="difflineplus">+</span>
<a href="#l19.242"></a><span id="l19.242" class="difflineplus">+// returns a promise which resolves to the response</span>
<a href="#l19.243"></a><span id="l19.243" class="difflineplus">+function _uploadOneTimeKeys(crypto) {</span>
<a href="#l19.244"></a><span id="l19.244" class="difflineplus">+    var oneTimeKeys = crypto._olmDevice.getOneTimeKeys();</span>
<a href="#l19.245"></a><span id="l19.245" class="difflineplus">+    var oneTimeJson = {};</span>
<a href="#l19.246"></a><span id="l19.246" class="difflineplus">+</span>
<a href="#l19.247"></a><span id="l19.247" class="difflineplus">+    for (var keyId in oneTimeKeys.curve25519) {</span>
<a href="#l19.248"></a><span id="l19.248" class="difflineplus">+        if (oneTimeKeys.curve25519.hasOwnProperty(keyId)) {</span>
<a href="#l19.249"></a><span id="l19.249" class="difflineplus">+            var k = {</span>
<a href="#l19.250"></a><span id="l19.250" class="difflineplus">+                key: oneTimeKeys.curve25519[keyId],</span>
<a href="#l19.251"></a><span id="l19.251" class="difflineplus">+            };</span>
<a href="#l19.252"></a><span id="l19.252" class="difflineplus">+            crypto._signObject(k);</span>
<a href="#l19.253"></a><span id="l19.253" class="difflineplus">+            oneTimeJson[&quot;signed_curve25519:&quot; + keyId] = k;</span>
<a href="#l19.254"></a><span id="l19.254" class="difflineplus">+        }</span>
<a href="#l19.255"></a><span id="l19.255" class="difflineplus">+    }</span>
<a href="#l19.256"></a><span id="l19.256" class="difflineplus">+</span>
<a href="#l19.257"></a><span id="l19.257" class="difflineplus">+    return crypto._baseApis.uploadKeysRequest({</span>
<a href="#l19.258"></a><span id="l19.258" class="difflineplus">+        one_time_keys: oneTimeJson</span>
<a href="#l19.259"></a><span id="l19.259" class="difflineplus">+    }, {</span>
<a href="#l19.260"></a><span id="l19.260" class="difflineplus">+        // for now, we set the device id explicitly, as we may not be using the</span>
<a href="#l19.261"></a><span id="l19.261" class="difflineplus">+        // same one as used in login.</span>
<a href="#l19.262"></a><span id="l19.262" class="difflineplus">+        device_id: crypto._deviceId,</span>
<a href="#l19.263"></a><span id="l19.263" class="difflineplus">+    }).then(function(res) {</span>
<a href="#l19.264"></a><span id="l19.264" class="difflineplus">+        crypto._olmDevice.markKeysAsPublished();</span>
<a href="#l19.265"></a><span id="l19.265" class="difflineplus">+        return res;</span>
<a href="#l19.266"></a><span id="l19.266" class="difflineplus">+    });</span>
<a href="#l19.267"></a><span id="l19.267" class="difflineplus">+}</span>
<a href="#l19.268"></a><span id="l19.268" class="difflineplus">+</span>
<a href="#l19.269"></a><span id="l19.269" class="difflineplus">+/**</span>
<a href="#l19.270"></a><span id="l19.270" class="difflineplus">+ * Download the keys for a list of users and stores the keys in the session</span>
<a href="#l19.271"></a><span id="l19.271" class="difflineplus">+ * store.</span>
<a href="#l19.272"></a><span id="l19.272" class="difflineplus">+ * @param {Array} userIds The users to fetch.</span>
<a href="#l19.273"></a><span id="l19.273" class="difflineplus">+ * @param {bool} forceDownload Always download the keys even if cached.</span>
<a href="#l19.274"></a><span id="l19.274" class="difflineplus">+ *</span>
<a href="#l19.275"></a><span id="l19.275" class="difflineplus">+ * @return {Promise} A promise which resolves to a map userId-&gt;deviceId-&gt;{@link</span>
<a href="#l19.276"></a><span id="l19.276" class="difflineplus">+ * module:crypto/deviceinfo|DeviceInfo}.</span>
<a href="#l19.277"></a><span id="l19.277" class="difflineplus">+ */</span>
<a href="#l19.278"></a><span id="l19.278" class="difflineplus">+Crypto.prototype.downloadKeys = function(userIds, forceDownload) {</span>
<a href="#l19.279"></a><span id="l19.279" class="difflineplus">+    var self = this;</span>
<a href="#l19.280"></a><span id="l19.280" class="difflineplus">+</span>
<a href="#l19.281"></a><span id="l19.281" class="difflineplus">+    // map from userid -&gt; deviceid -&gt; DeviceInfo</span>
<a href="#l19.282"></a><span id="l19.282" class="difflineplus">+    var stored = {};</span>
<a href="#l19.283"></a><span id="l19.283" class="difflineplus">+    function storeDev(userId, dev) {</span>
<a href="#l19.284"></a><span id="l19.284" class="difflineplus">+        stored[userId][dev.deviceId] = dev;</span>
<a href="#l19.285"></a><span id="l19.285" class="difflineplus">+    }</span>
<a href="#l19.286"></a><span id="l19.286" class="difflineplus">+</span>
<a href="#l19.287"></a><span id="l19.287" class="difflineplus">+    // list of userids we need to download keys for</span>
<a href="#l19.288"></a><span id="l19.288" class="difflineplus">+    var downloadUsers = [];</span>
<a href="#l19.289"></a><span id="l19.289" class="difflineplus">+</span>
<a href="#l19.290"></a><span id="l19.290" class="difflineplus">+    if (forceDownload) {</span>
<a href="#l19.291"></a><span id="l19.291" class="difflineplus">+        downloadUsers = userIds;</span>
<a href="#l19.292"></a><span id="l19.292" class="difflineplus">+    } else {</span>
<a href="#l19.293"></a><span id="l19.293" class="difflineplus">+        for (var i = 0; i &lt; userIds.length; ++i) {</span>
<a href="#l19.294"></a><span id="l19.294" class="difflineplus">+            var userId = userIds[i];</span>
<a href="#l19.295"></a><span id="l19.295" class="difflineplus">+            var devices = this.getStoredDevicesForUser(userId);</span>
<a href="#l19.296"></a><span id="l19.296" class="difflineplus">+</span>
<a href="#l19.297"></a><span id="l19.297" class="difflineplus">+            if (!devices) {</span>
<a href="#l19.298"></a><span id="l19.298" class="difflineplus">+                downloadUsers.push(userId);</span>
<a href="#l19.299"></a><span id="l19.299" class="difflineplus">+            } else {</span>
<a href="#l19.300"></a><span id="l19.300" class="difflineplus">+                stored[userId] = {};</span>
<a href="#l19.301"></a><span id="l19.301" class="difflineplus">+                devices.map(storeDev.bind(null, userId));</span>
<a href="#l19.302"></a><span id="l19.302" class="difflineplus">+            }</span>
<a href="#l19.303"></a><span id="l19.303" class="difflineplus">+        }</span>
<a href="#l19.304"></a><span id="l19.304" class="difflineplus">+    }</span>
<a href="#l19.305"></a><span id="l19.305" class="difflineplus">+</span>
<a href="#l19.306"></a><span id="l19.306" class="difflineplus">+    if (downloadUsers.length === 0) {</span>
<a href="#l19.307"></a><span id="l19.307" class="difflineplus">+        return q(stored);</span>
<a href="#l19.308"></a><span id="l19.308" class="difflineplus">+    }</span>
<a href="#l19.309"></a><span id="l19.309" class="difflineplus">+</span>
<a href="#l19.310"></a><span id="l19.310" class="difflineplus">+    var r = this._doKeyDownloadForUsers(downloadUsers);</span>
<a href="#l19.311"></a><span id="l19.311" class="difflineplus">+    var promises = [];</span>
<a href="#l19.312"></a><span id="l19.312" class="difflineplus">+    downloadUsers.map(function(u) {</span>
<a href="#l19.313"></a><span id="l19.313" class="difflineplus">+        promises.push(r[u].catch(function(e) {</span>
<a href="#l19.314"></a><span id="l19.314" class="difflineplus">+            console.warn('Error downloading keys for user ' + u + ':', e);</span>
<a href="#l19.315"></a><span id="l19.315" class="difflineplus">+        }).then(function() {</span>
<a href="#l19.316"></a><span id="l19.316" class="difflineplus">+            stored[u] = {};</span>
<a href="#l19.317"></a><span id="l19.317" class="difflineplus">+            var devices = self.getStoredDevicesForUser(u) || [];</span>
<a href="#l19.318"></a><span id="l19.318" class="difflineplus">+            devices.map(storeDev.bind(null, u));</span>
<a href="#l19.319"></a><span id="l19.319" class="difflineplus">+        }));</span>
<a href="#l19.320"></a><span id="l19.320" class="difflineplus">+    });</span>
<a href="#l19.321"></a><span id="l19.321" class="difflineplus">+</span>
<a href="#l19.322"></a><span id="l19.322" class="difflineplus">+    return q.all(promises).then(function() {</span>
<a href="#l19.323"></a><span id="l19.323" class="difflineplus">+        return stored;</span>
<a href="#l19.324"></a><span id="l19.324" class="difflineplus">+    });</span>
<a href="#l19.325"></a><span id="l19.325" class="difflineplus">+};</span>
<a href="#l19.326"></a><span id="l19.326" class="difflineplus">+</span>
<a href="#l19.327"></a><span id="l19.327" class="difflineplus">+/**</span>
<a href="#l19.328"></a><span id="l19.328" class="difflineplus">+ * @param {string[]} downloadUsers list of userIds</span>
<a href="#l19.329"></a><span id="l19.329" class="difflineplus">+ *</span>
<a href="#l19.330"></a><span id="l19.330" class="difflineplus">+ * @return {Object a map from userId to a promise for a result for that user</span>
<a href="#l19.331"></a><span id="l19.331" class="difflineplus">+ */</span>
<a href="#l19.332"></a><span id="l19.332" class="difflineplus">+Crypto.prototype._doKeyDownloadForUsers = function(downloadUsers) {</span>
<a href="#l19.333"></a><span id="l19.333" class="difflineplus">+    var self = this;</span>
<a href="#l19.334"></a><span id="l19.334" class="difflineplus">+</span>
<a href="#l19.335"></a><span id="l19.335" class="difflineplus">+    console.log('Starting key download for ' + downloadUsers);</span>
<a href="#l19.336"></a><span id="l19.336" class="difflineplus">+</span>
<a href="#l19.337"></a><span id="l19.337" class="difflineplus">+    var deferMap = {};</span>
<a href="#l19.338"></a><span id="l19.338" class="difflineplus">+    var promiseMap = {};</span>
<a href="#l19.339"></a><span id="l19.339" class="difflineplus">+</span>
<a href="#l19.340"></a><span id="l19.340" class="difflineplus">+    downloadUsers.map(function(u) {</span>
<a href="#l19.341"></a><span id="l19.341" class="difflineplus">+        deferMap[u] = q.defer();</span>
<a href="#l19.342"></a><span id="l19.342" class="difflineplus">+        promiseMap[u] = deferMap[u].promise;</span>
<a href="#l19.343"></a><span id="l19.343" class="difflineplus">+    });</span>
<a href="#l19.344"></a><span id="l19.344" class="difflineplus">+</span>
<a href="#l19.345"></a><span id="l19.345" class="difflineplus">+    this._baseApis.downloadKeysForUsers(</span>
<a href="#l19.346"></a><span id="l19.346" class="difflineplus">+        downloadUsers</span>
<a href="#l19.347"></a><span id="l19.347" class="difflineplus">+    ).done(function(res) {</span>
<a href="#l19.348"></a><span id="l19.348" class="difflineplus">+        var dk = res.device_keys || {};</span>
<a href="#l19.349"></a><span id="l19.349" class="difflineplus">+</span>
<a href="#l19.350"></a><span id="l19.350" class="difflineplus">+        for (var i = 0; i &lt; downloadUsers.length; ++i) {</span>
<a href="#l19.351"></a><span id="l19.351" class="difflineplus">+            var userId = downloadUsers[i];</span>
<a href="#l19.352"></a><span id="l19.352" class="difflineplus">+            var deviceId;</span>
<a href="#l19.353"></a><span id="l19.353" class="difflineplus">+</span>
<a href="#l19.354"></a><span id="l19.354" class="difflineplus">+            console.log('got keys for ' + userId + ':', dk[userId]);</span>
<a href="#l19.355"></a><span id="l19.355" class="difflineplus">+</span>
<a href="#l19.356"></a><span id="l19.356" class="difflineplus">+            if (!dk[userId]) {</span>
<a href="#l19.357"></a><span id="l19.357" class="difflineplus">+                // no result for this user</span>
<a href="#l19.358"></a><span id="l19.358" class="difflineplus">+                var err = 'Unknown';</span>
<a href="#l19.359"></a><span id="l19.359" class="difflineplus">+                // TODO: do something with res.failures</span>
<a href="#l19.360"></a><span id="l19.360" class="difflineplus">+                deferMap[userId].reject(err);</span>
<a href="#l19.361"></a><span id="l19.361" class="difflineplus">+                continue;</span>
<a href="#l19.362"></a><span id="l19.362" class="difflineplus">+            }</span>
<a href="#l19.363"></a><span id="l19.363" class="difflineplus">+</span>
<a href="#l19.364"></a><span id="l19.364" class="difflineplus">+            // map from deviceid -&gt; deviceinfo for this user</span>
<a href="#l19.365"></a><span id="l19.365" class="difflineplus">+            var userStore = {};</span>
<a href="#l19.366"></a><span id="l19.366" class="difflineplus">+            var devs = self._sessionStore.getEndToEndDevicesForUser(userId);</span>
<a href="#l19.367"></a><span id="l19.367" class="difflineplus">+            if (devs) {</span>
<a href="#l19.368"></a><span id="l19.368" class="difflineplus">+                for (deviceId in devs) {</span>
<a href="#l19.369"></a><span id="l19.369" class="difflineplus">+                    if (devs.hasOwnProperty(deviceId)) {</span>
<a href="#l19.370"></a><span id="l19.370" class="difflineplus">+                        var d = DeviceInfo.fromStorage(devs[deviceId], deviceId);</span>
<a href="#l19.371"></a><span id="l19.371" class="difflineplus">+                        userStore[deviceId] = d;</span>
<a href="#l19.372"></a><span id="l19.372" class="difflineplus">+                    }</span>
<a href="#l19.373"></a><span id="l19.373" class="difflineplus">+                }</span>
<a href="#l19.374"></a><span id="l19.374" class="difflineplus">+            }</span>
<a href="#l19.375"></a><span id="l19.375" class="difflineplus">+</span>
<a href="#l19.376"></a><span id="l19.376" class="difflineplus">+            _updateStoredDeviceKeysForUser(</span>
<a href="#l19.377"></a><span id="l19.377" class="difflineplus">+                self._olmDevice, userId, userStore, dk[userId]</span>
<a href="#l19.378"></a><span id="l19.378" class="difflineplus">+            );</span>
<a href="#l19.379"></a><span id="l19.379" class="difflineplus">+</span>
<a href="#l19.380"></a><span id="l19.380" class="difflineplus">+            // update the session store</span>
<a href="#l19.381"></a><span id="l19.381" class="difflineplus">+            var storage = {};</span>
<a href="#l19.382"></a><span id="l19.382" class="difflineplus">+            for (deviceId in userStore) {</span>
<a href="#l19.383"></a><span id="l19.383" class="difflineplus">+                if (!userStore.hasOwnProperty(deviceId)) {</span>
<a href="#l19.384"></a><span id="l19.384" class="difflineplus">+                    continue;</span>
<a href="#l19.385"></a><span id="l19.385" class="difflineplus">+                }</span>
<a href="#l19.386"></a><span id="l19.386" class="difflineplus">+</span>
<a href="#l19.387"></a><span id="l19.387" class="difflineplus">+                storage[deviceId] = userStore[deviceId].toStorage();</span>
<a href="#l19.388"></a><span id="l19.388" class="difflineplus">+            }</span>
<a href="#l19.389"></a><span id="l19.389" class="difflineplus">+            self._sessionStore.storeEndToEndDevicesForUser(</span>
<a href="#l19.390"></a><span id="l19.390" class="difflineplus">+                userId, storage</span>
<a href="#l19.391"></a><span id="l19.391" class="difflineplus">+            );</span>
<a href="#l19.392"></a><span id="l19.392" class="difflineplus">+</span>
<a href="#l19.393"></a><span id="l19.393" class="difflineplus">+            deferMap[userId].resolve();</span>
<a href="#l19.394"></a><span id="l19.394" class="difflineplus">+        }</span>
<a href="#l19.395"></a><span id="l19.395" class="difflineplus">+    }, function(err) {</span>
<a href="#l19.396"></a><span id="l19.396" class="difflineplus">+        downloadUsers.map(function(u) {</span>
<a href="#l19.397"></a><span id="l19.397" class="difflineplus">+            deferMap[u].reject(err);</span>
<a href="#l19.398"></a><span id="l19.398" class="difflineplus">+        });</span>
<a href="#l19.399"></a><span id="l19.399" class="difflineplus">+    });</span>
<a href="#l19.400"></a><span id="l19.400" class="difflineplus">+</span>
<a href="#l19.401"></a><span id="l19.401" class="difflineplus">+    return promiseMap;</span>
<a href="#l19.402"></a><span id="l19.402" class="difflineplus">+};</span>
<a href="#l19.403"></a><span id="l19.403" class="difflineplus">+</span>
<a href="#l19.404"></a><span id="l19.404" class="difflineplus">+function _updateStoredDeviceKeysForUser(_olmDevice, userId, userStore,</span>
<a href="#l19.405"></a><span id="l19.405" class="difflineplus">+                                        userResult) {</span>
<a href="#l19.406"></a><span id="l19.406" class="difflineplus">+    var updated = false;</span>
<a href="#l19.407"></a><span id="l19.407" class="difflineplus">+</span>
<a href="#l19.408"></a><span id="l19.408" class="difflineplus">+    // remove any devices in the store which aren't in the response</span>
<a href="#l19.409"></a><span id="l19.409" class="difflineplus">+    for (var deviceId in userStore) {</span>
<a href="#l19.410"></a><span id="l19.410" class="difflineplus">+        if (!userStore.hasOwnProperty(deviceId)) {</span>
<a href="#l19.411"></a><span id="l19.411" class="difflineplus">+            continue;</span>
<a href="#l19.412"></a><span id="l19.412" class="difflineplus">+        }</span>
<a href="#l19.413"></a><span id="l19.413" class="difflineplus">+</span>
<a href="#l19.414"></a><span id="l19.414" class="difflineplus">+        if (!(deviceId in userResult)) {</span>
<a href="#l19.415"></a><span id="l19.415" class="difflineplus">+            console.log(&quot;Device &quot; + userId + &quot;:&quot; + deviceId +</span>
<a href="#l19.416"></a><span id="l19.416" class="difflineplus">+                        &quot; has been removed&quot;);</span>
<a href="#l19.417"></a><span id="l19.417" class="difflineplus">+            delete userStore[deviceId];</span>
<a href="#l19.418"></a><span id="l19.418" class="difflineplus">+            updated = true;</span>
<a href="#l19.419"></a><span id="l19.419" class="difflineplus">+        }</span>
<a href="#l19.420"></a><span id="l19.420" class="difflineplus">+    }</span>
<a href="#l19.421"></a><span id="l19.421" class="difflineplus">+</span>
<a href="#l19.422"></a><span id="l19.422" class="difflineplus">+    for (deviceId in userResult) {</span>
<a href="#l19.423"></a><span id="l19.423" class="difflineplus">+        if (!userResult.hasOwnProperty(deviceId)) {</span>
<a href="#l19.424"></a><span id="l19.424" class="difflineplus">+            continue;</span>
<a href="#l19.425"></a><span id="l19.425" class="difflineplus">+        }</span>
<a href="#l19.426"></a><span id="l19.426" class="difflineplus">+</span>
<a href="#l19.427"></a><span id="l19.427" class="difflineplus">+        var deviceResult = userResult[deviceId];</span>
<a href="#l19.428"></a><span id="l19.428" class="difflineplus">+</span>
<a href="#l19.429"></a><span id="l19.429" class="difflineplus">+        // check that the user_id and device_id in the response object are</span>
<a href="#l19.430"></a><span id="l19.430" class="difflineplus">+        // correct</span>
<a href="#l19.431"></a><span id="l19.431" class="difflineplus">+        if (deviceResult.user_id !== userId) {</span>
<a href="#l19.432"></a><span id="l19.432" class="difflineplus">+            console.warn(&quot;Mismatched user_id &quot; + deviceResult.user_id +</span>
<a href="#l19.433"></a><span id="l19.433" class="difflineplus">+                         &quot; in keys from &quot; + userId + &quot;:&quot; + deviceId);</span>
<a href="#l19.434"></a><span id="l19.434" class="difflineplus">+            continue;</span>
<a href="#l19.435"></a><span id="l19.435" class="difflineplus">+        }</span>
<a href="#l19.436"></a><span id="l19.436" class="difflineplus">+        if (deviceResult.device_id !== deviceId) {</span>
<a href="#l19.437"></a><span id="l19.437" class="difflineplus">+            console.warn(&quot;Mismatched device_id &quot; + deviceResult.device_id +</span>
<a href="#l19.438"></a><span id="l19.438" class="difflineplus">+                         &quot; in keys from &quot; + userId + &quot;:&quot; + deviceId);</span>
<a href="#l19.439"></a><span id="l19.439" class="difflineplus">+            continue;</span>
<a href="#l19.440"></a><span id="l19.440" class="difflineplus">+        }</span>
<a href="#l19.441"></a><span id="l19.441" class="difflineplus">+</span>
<a href="#l19.442"></a><span id="l19.442" class="difflineplus">+        if (_storeDeviceKeys(_olmDevice, userStore, deviceResult)) {</span>
<a href="#l19.443"></a><span id="l19.443" class="difflineplus">+            updated = true;</span>
<a href="#l19.444"></a><span id="l19.444" class="difflineplus">+        }</span>
<a href="#l19.445"></a><span id="l19.445" class="difflineplus">+    }</span>
<a href="#l19.446"></a><span id="l19.446" class="difflineplus">+</span>
<a href="#l19.447"></a><span id="l19.447" class="difflineplus">+    return updated;</span>
<a href="#l19.448"></a><span id="l19.448" class="difflineplus">+}</span>
<a href="#l19.449"></a><span id="l19.449" class="difflineplus">+</span>
<a href="#l19.450"></a><span id="l19.450" class="difflineplus">+/*</span>
<a href="#l19.451"></a><span id="l19.451" class="difflineplus">+ * Process a device in a /query response, and add it to the userStore</span>
<a href="#l19.452"></a><span id="l19.452" class="difflineplus">+ *</span>
<a href="#l19.453"></a><span id="l19.453" class="difflineplus">+ * returns true if a change was made, else false</span>
<a href="#l19.454"></a><span id="l19.454" class="difflineplus">+ */</span>
<a href="#l19.455"></a><span id="l19.455" class="difflineplus">+function _storeDeviceKeys(_olmDevice, userStore, deviceResult) {</span>
<a href="#l19.456"></a><span id="l19.456" class="difflineplus">+    if (!deviceResult.keys) {</span>
<a href="#l19.457"></a><span id="l19.457" class="difflineplus">+        // no keys?</span>
<a href="#l19.458"></a><span id="l19.458" class="difflineplus">+        return false;</span>
<a href="#l19.459"></a><span id="l19.459" class="difflineplus">+    }</span>
<a href="#l19.460"></a><span id="l19.460" class="difflineplus">+</span>
<a href="#l19.461"></a><span id="l19.461" class="difflineplus">+    var deviceId = deviceResult.device_id;</span>
<a href="#l19.462"></a><span id="l19.462" class="difflineplus">+    var userId = deviceResult.user_id;</span>
<a href="#l19.463"></a><span id="l19.463" class="difflineplus">+</span>
<a href="#l19.464"></a><span id="l19.464" class="difflineplus">+    var signKeyId = &quot;ed25519:&quot; + deviceId;</span>
<a href="#l19.465"></a><span id="l19.465" class="difflineplus">+    var signKey = deviceResult.keys[signKeyId];</span>
<a href="#l19.466"></a><span id="l19.466" class="difflineplus">+    if (!signKey) {</span>
<a href="#l19.467"></a><span id="l19.467" class="difflineplus">+        console.log(&quot;Device &quot; + userId + &quot;:&quot; + deviceId +</span>
<a href="#l19.468"></a><span id="l19.468" class="difflineplus">+                    &quot; has no ed25519 key&quot;);</span>
<a href="#l19.469"></a><span id="l19.469" class="difflineplus">+        return false;</span>
<a href="#l19.470"></a><span id="l19.470" class="difflineplus">+    }</span>
<a href="#l19.471"></a><span id="l19.471" class="difflineplus">+</span>
<a href="#l19.472"></a><span id="l19.472" class="difflineplus">+    var unsigned = deviceResult.unsigned || {};</span>
<a href="#l19.473"></a><span id="l19.473" class="difflineplus">+</span>
<a href="#l19.474"></a><span id="l19.474" class="difflineplus">+    try {</span>
<a href="#l19.475"></a><span id="l19.475" class="difflineplus">+        olmlib.verifySignature(_olmDevice, deviceResult, userId, deviceId, signKey);</span>
<a href="#l19.476"></a><span id="l19.476" class="difflineplus">+    } catch (e) {</span>
<a href="#l19.477"></a><span id="l19.477" class="difflineplus">+        console.log(&quot;Unable to verify signature on device &quot; +</span>
<a href="#l19.478"></a><span id="l19.478" class="difflineplus">+                    userId + &quot;:&quot; + deviceId + &quot;:&quot;, e);</span>
<a href="#l19.479"></a><span id="l19.479" class="difflineplus">+        return false;</span>
<a href="#l19.480"></a><span id="l19.480" class="difflineplus">+    }</span>
<a href="#l19.481"></a><span id="l19.481" class="difflineplus">+</span>
<a href="#l19.482"></a><span id="l19.482" class="difflineplus">+    // DeviceInfo</span>
<a href="#l19.483"></a><span id="l19.483" class="difflineplus">+    var deviceStore;</span>
<a href="#l19.484"></a><span id="l19.484" class="difflineplus">+</span>
<a href="#l19.485"></a><span id="l19.485" class="difflineplus">+    if (deviceId in userStore) {</span>
<a href="#l19.486"></a><span id="l19.486" class="difflineplus">+        // already have this device.</span>
<a href="#l19.487"></a><span id="l19.487" class="difflineplus">+        deviceStore = userStore[deviceId];</span>
<a href="#l19.488"></a><span id="l19.488" class="difflineplus">+</span>
<a href="#l19.489"></a><span id="l19.489" class="difflineplus">+        if (deviceStore.getFingerprint() != signKey) {</span>
<a href="#l19.490"></a><span id="l19.490" class="difflineplus">+            // this should only happen if the list has been MITMed; we are</span>
<a href="#l19.491"></a><span id="l19.491" class="difflineplus">+            // best off sticking with the original keys.</span>
<a href="#l19.492"></a><span id="l19.492" class="difflineplus">+            //</span>
<a href="#l19.493"></a><span id="l19.493" class="difflineplus">+            // Should we warn the user about it somehow?</span>
<a href="#l19.494"></a><span id="l19.494" class="difflineplus">+            console.warn(&quot;Ed25519 key for device&quot; + userId + &quot;: &quot; +</span>
<a href="#l19.495"></a><span id="l19.495" class="difflineplus">+                         deviceId + &quot; has changed&quot;);</span>
<a href="#l19.496"></a><span id="l19.496" class="difflineplus">+            return false;</span>
<a href="#l19.497"></a><span id="l19.497" class="difflineplus">+        }</span>
<a href="#l19.498"></a><span id="l19.498" class="difflineplus">+    } else {</span>
<a href="#l19.499"></a><span id="l19.499" class="difflineplus">+        userStore[deviceId] = deviceStore = new DeviceInfo(deviceId);</span>
<a href="#l19.500"></a><span id="l19.500" class="difflineplus">+    }</span>
<a href="#l19.501"></a><span id="l19.501" class="difflineplus">+</span>
<a href="#l19.502"></a><span id="l19.502" class="difflineplus">+    deviceStore.keys = deviceResult.keys || {};</span>
<a href="#l19.503"></a><span id="l19.503" class="difflineplus">+    deviceStore.algorithms = deviceResult.algorithms || [];</span>
<a href="#l19.504"></a><span id="l19.504" class="difflineplus">+    deviceStore.unsigned = unsigned;</span>
<a href="#l19.505"></a><span id="l19.505" class="difflineplus">+    return true;</span>
<a href="#l19.506"></a><span id="l19.506" class="difflineplus">+}</span>
<a href="#l19.507"></a><span id="l19.507" class="difflineplus">+</span>
<a href="#l19.508"></a><span id="l19.508" class="difflineplus">+/**</span>
<a href="#l19.509"></a><span id="l19.509" class="difflineplus">+ * Get the stored device keys for a user id</span>
<a href="#l19.510"></a><span id="l19.510" class="difflineplus">+ *</span>
<a href="#l19.511"></a><span id="l19.511" class="difflineplus">+ * @param {string} userId the user to list keys for.</span>
<a href="#l19.512"></a><span id="l19.512" class="difflineplus">+ *</span>
<a href="#l19.513"></a><span id="l19.513" class="difflineplus">+ * @return {module:crypto/deviceinfo[]?} list of devices, or null if we haven't</span>
<a href="#l19.514"></a><span id="l19.514" class="difflineplus">+ * managed to get a list of devices for this user yet.</span>
<a href="#l19.515"></a><span id="l19.515" class="difflineplus">+ */</span>
<a href="#l19.516"></a><span id="l19.516" class="difflineplus">+Crypto.prototype.getStoredDevicesForUser = function(userId) {</span>
<a href="#l19.517"></a><span id="l19.517" class="difflineplus">+    var devs = this._sessionStore.getEndToEndDevicesForUser(userId);</span>
<a href="#l19.518"></a><span id="l19.518" class="difflineplus">+    if (!devs) {</span>
<a href="#l19.519"></a><span id="l19.519" class="difflineplus">+        return null;</span>
<a href="#l19.520"></a><span id="l19.520" class="difflineplus">+    }</span>
<a href="#l19.521"></a><span id="l19.521" class="difflineplus">+    var res = [];</span>
<a href="#l19.522"></a><span id="l19.522" class="difflineplus">+    for (var deviceId in devs) {</span>
<a href="#l19.523"></a><span id="l19.523" class="difflineplus">+        if (devs.hasOwnProperty(deviceId)) {</span>
<a href="#l19.524"></a><span id="l19.524" class="difflineplus">+            res.push(DeviceInfo.fromStorage(devs[deviceId], deviceId));</span>
<a href="#l19.525"></a><span id="l19.525" class="difflineplus">+        }</span>
<a href="#l19.526"></a><span id="l19.526" class="difflineplus">+    }</span>
<a href="#l19.527"></a><span id="l19.527" class="difflineplus">+    return res;</span>
<a href="#l19.528"></a><span id="l19.528" class="difflineplus">+};</span>
<a href="#l19.529"></a><span id="l19.529" class="difflineplus">+</span>
<a href="#l19.530"></a><span id="l19.530" class="difflineplus">+/**</span>
<a href="#l19.531"></a><span id="l19.531" class="difflineplus">+ * Get the stored keys for a single device</span>
<a href="#l19.532"></a><span id="l19.532" class="difflineplus">+ *</span>
<a href="#l19.533"></a><span id="l19.533" class="difflineplus">+ * @param {string} userId</span>
<a href="#l19.534"></a><span id="l19.534" class="difflineplus">+ * @param {string} deviceId</span>
<a href="#l19.535"></a><span id="l19.535" class="difflineplus">+ *</span>
<a href="#l19.536"></a><span id="l19.536" class="difflineplus">+ * @return {module:crypto/deviceinfo?} list of devices, or undefined</span>
<a href="#l19.537"></a><span id="l19.537" class="difflineplus">+ * if we don't know about this device</span>
<a href="#l19.538"></a><span id="l19.538" class="difflineplus">+ */</span>
<a href="#l19.539"></a><span id="l19.539" class="difflineplus">+Crypto.prototype.getStoredDevice = function(userId, deviceId) {</span>
<a href="#l19.540"></a><span id="l19.540" class="difflineplus">+    var devs = this._sessionStore.getEndToEndDevicesForUser(userId);</span>
<a href="#l19.541"></a><span id="l19.541" class="difflineplus">+    if (!devs || !devs[deviceId]) {</span>
<a href="#l19.542"></a><span id="l19.542" class="difflineplus">+        return undefined;</span>
<a href="#l19.543"></a><span id="l19.543" class="difflineplus">+    }</span>
<a href="#l19.544"></a><span id="l19.544" class="difflineplus">+    return DeviceInfo.fromStorage(devs[deviceId], deviceId);</span>
<a href="#l19.545"></a><span id="l19.545" class="difflineplus">+};</span>
<a href="#l19.546"></a><span id="l19.546" class="difflineplus">+</span>
<a href="#l19.547"></a><span id="l19.547" class="difflineplus">+/**</span>
<a href="#l19.548"></a><span id="l19.548" class="difflineplus">+ * List the stored device keys for a user id</span>
<a href="#l19.549"></a><span id="l19.549" class="difflineplus">+ *</span>
<a href="#l19.550"></a><span id="l19.550" class="difflineplus">+ * @deprecated prefer {@link module:crypto#getStoredDevicesForUser}</span>
<a href="#l19.551"></a><span id="l19.551" class="difflineplus">+ *</span>
<a href="#l19.552"></a><span id="l19.552" class="difflineplus">+ * @param {string} userId the user to list keys for.</span>
<a href="#l19.553"></a><span id="l19.553" class="difflineplus">+ *</span>
<a href="#l19.554"></a><span id="l19.554" class="difflineplus">+ * @return {object[]} list of devices with &quot;id&quot;, &quot;verified&quot;, &quot;blocked&quot;,</span>
<a href="#l19.555"></a><span id="l19.555" class="difflineplus">+ *    &quot;key&quot;, and &quot;display_name&quot; parameters.</span>
<a href="#l19.556"></a><span id="l19.556" class="difflineplus">+ */</span>
<a href="#l19.557"></a><span id="l19.557" class="difflineplus">+Crypto.prototype.listDeviceKeys = function(userId) {</span>
<a href="#l19.558"></a><span id="l19.558" class="difflineplus">+    var devices = this.getStoredDevicesForUser(userId) || [];</span>
<a href="#l19.559"></a><span id="l19.559" class="difflineplus">+</span>
<a href="#l19.560"></a><span id="l19.560" class="difflineplus">+    var result = [];</span>
<a href="#l19.561"></a><span id="l19.561" class="difflineplus">+</span>
<a href="#l19.562"></a><span id="l19.562" class="difflineplus">+    for (var i = 0; i &lt; devices.length; ++i) {</span>
<a href="#l19.563"></a><span id="l19.563" class="difflineplus">+        var device = devices[i];</span>
<a href="#l19.564"></a><span id="l19.564" class="difflineplus">+        var ed25519Key = device.getFingerprint();</span>
<a href="#l19.565"></a><span id="l19.565" class="difflineplus">+        if (ed25519Key) {</span>
<a href="#l19.566"></a><span id="l19.566" class="difflineplus">+            result.push({</span>
<a href="#l19.567"></a><span id="l19.567" class="difflineplus">+                id: device.deviceId,</span>
<a href="#l19.568"></a><span id="l19.568" class="difflineplus">+                key: ed25519Key,</span>
<a href="#l19.569"></a><span id="l19.569" class="difflineplus">+                verified: Boolean(device.isVerified()),</span>
<a href="#l19.570"></a><span id="l19.570" class="difflineplus">+                blocked: Boolean(device.isBlocked()),</span>
<a href="#l19.571"></a><span id="l19.571" class="difflineplus">+                display_name: device.getDisplayName(),</span>
<a href="#l19.572"></a><span id="l19.572" class="difflineplus">+            });</span>
<a href="#l19.573"></a><span id="l19.573" class="difflineplus">+        }</span>
<a href="#l19.574"></a><span id="l19.574" class="difflineplus">+    }</span>
<a href="#l19.575"></a><span id="l19.575" class="difflineplus">+</span>
<a href="#l19.576"></a><span id="l19.576" class="difflineplus">+    // sort by deviceid</span>
<a href="#l19.577"></a><span id="l19.577" class="difflineplus">+    result.sort(function(a, b) {</span>
<a href="#l19.578"></a><span id="l19.578" class="difflineplus">+        if (a.deviceId &lt; b.deviceId) { return -1; }</span>
<a href="#l19.579"></a><span id="l19.579" class="difflineplus">+        if (a.deviceId &gt; b.deviceId) { return 1; }</span>
<a href="#l19.580"></a><span id="l19.580" class="difflineplus">+        return 0;</span>
<a href="#l19.581"></a><span id="l19.581" class="difflineplus">+    });</span>
<a href="#l19.582"></a><span id="l19.582" class="difflineplus">+</span>
<a href="#l19.583"></a><span id="l19.583" class="difflineplus">+    return result;</span>
<a href="#l19.584"></a><span id="l19.584" class="difflineplus">+};</span>
<a href="#l19.585"></a><span id="l19.585" class="difflineplus">+</span>
<a href="#l19.586"></a><span id="l19.586" class="difflineplus">+/**</span>
<a href="#l19.587"></a><span id="l19.587" class="difflineplus">+ * Find a device by curve25519 identity key</span>
<a href="#l19.588"></a><span id="l19.588" class="difflineplus">+ *</span>
<a href="#l19.589"></a><span id="l19.589" class="difflineplus">+ * @param {string} userId     owner of the device</span>
<a href="#l19.590"></a><span id="l19.590" class="difflineplus">+ * @param {string} algorithm  encryption algorithm</span>
<a href="#l19.591"></a><span id="l19.591" class="difflineplus">+ * @param {string} sender_key curve25519 key to match</span>
<a href="#l19.592"></a><span id="l19.592" class="difflineplus">+ *</span>
<a href="#l19.593"></a><span id="l19.593" class="difflineplus">+ * @return {module:crypto/deviceinfo?}</span>
<a href="#l19.594"></a><span id="l19.594" class="difflineplus">+ */</span>
<a href="#l19.595"></a><span id="l19.595" class="difflineplus">+Crypto.prototype.getDeviceByIdentityKey = function(userId, algorithm, sender_key) {</span>
<a href="#l19.596"></a><span id="l19.596" class="difflineplus">+    if (</span>
<a href="#l19.597"></a><span id="l19.597" class="difflineplus">+        algorithm !== olmlib.OLM_ALGORITHM &amp;&amp;</span>
<a href="#l19.598"></a><span id="l19.598" class="difflineplus">+        algorithm !== olmlib.MEGOLM_ALGORITHM</span>
<a href="#l19.599"></a><span id="l19.599" class="difflineplus">+    ) {</span>
<a href="#l19.600"></a><span id="l19.600" class="difflineplus">+        // we only deal in olm keys</span>
<a href="#l19.601"></a><span id="l19.601" class="difflineplus">+        return null;</span>
<a href="#l19.602"></a><span id="l19.602" class="difflineplus">+    }</span>
<a href="#l19.603"></a><span id="l19.603" class="difflineplus">+</span>
<a href="#l19.604"></a><span id="l19.604" class="difflineplus">+    var devices = this._sessionStore.getEndToEndDevicesForUser(userId);</span>
<a href="#l19.605"></a><span id="l19.605" class="difflineplus">+    if (!devices) {</span>
<a href="#l19.606"></a><span id="l19.606" class="difflineplus">+        return null;</span>
<a href="#l19.607"></a><span id="l19.607" class="difflineplus">+    }</span>
<a href="#l19.608"></a><span id="l19.608" class="difflineplus">+</span>
<a href="#l19.609"></a><span id="l19.609" class="difflineplus">+    for (var deviceId in devices) {</span>
<a href="#l19.610"></a><span id="l19.610" class="difflineplus">+        if (!devices.hasOwnProperty(deviceId)) {</span>
<a href="#l19.611"></a><span id="l19.611" class="difflineplus">+            continue;</span>
<a href="#l19.612"></a><span id="l19.612" class="difflineplus">+        }</span>
<a href="#l19.613"></a><span id="l19.613" class="difflineplus">+</span>
<a href="#l19.614"></a><span id="l19.614" class="difflineplus">+        var device = devices[deviceId];</span>
<a href="#l19.615"></a><span id="l19.615" class="difflineplus">+        for (var keyId in device.keys) {</span>
<a href="#l19.616"></a><span id="l19.616" class="difflineplus">+            if (!device.keys.hasOwnProperty(keyId)) {</span>
<a href="#l19.617"></a><span id="l19.617" class="difflineplus">+                continue;</span>
<a href="#l19.618"></a><span id="l19.618" class="difflineplus">+            }</span>
<a href="#l19.619"></a><span id="l19.619" class="difflineplus">+            if (keyId.indexOf(&quot;curve25519:&quot;) !== 0) {</span>
<a href="#l19.620"></a><span id="l19.620" class="difflineplus">+                continue;</span>
<a href="#l19.621"></a><span id="l19.621" class="difflineplus">+            }</span>
<a href="#l19.622"></a><span id="l19.622" class="difflineplus">+            var deviceKey = device.keys[keyId];</span>
<a href="#l19.623"></a><span id="l19.623" class="difflineplus">+            if (deviceKey == sender_key) {</span>
<a href="#l19.624"></a><span id="l19.624" class="difflineplus">+                return DeviceInfo.fromStorage(device, deviceId);</span>
<a href="#l19.625"></a><span id="l19.625" class="difflineplus">+            }</span>
<a href="#l19.626"></a><span id="l19.626" class="difflineplus">+        }</span>
<a href="#l19.627"></a><span id="l19.627" class="difflineplus">+    }</span>
<a href="#l19.628"></a><span id="l19.628" class="difflineplus">+</span>
<a href="#l19.629"></a><span id="l19.629" class="difflineplus">+    // doesn't match a known device</span>
<a href="#l19.630"></a><span id="l19.630" class="difflineplus">+    return null;</span>
<a href="#l19.631"></a><span id="l19.631" class="difflineplus">+};</span>
<a href="#l19.632"></a><span id="l19.632" class="difflineplus">+</span>
<a href="#l19.633"></a><span id="l19.633" class="difflineplus">+</span>
<a href="#l19.634"></a><span id="l19.634" class="difflineplus">+/**</span>
<a href="#l19.635"></a><span id="l19.635" class="difflineplus">+ * Update the blocked/verified state of the given device</span>
<a href="#l19.636"></a><span id="l19.636" class="difflineplus">+ *</span>
<a href="#l19.637"></a><span id="l19.637" class="difflineplus">+ * @param {string} userId owner of the device</span>
<a href="#l19.638"></a><span id="l19.638" class="difflineplus">+ * @param {string} deviceId unique identifier for the device</span>
<a href="#l19.639"></a><span id="l19.639" class="difflineplus">+ *</span>
<a href="#l19.640"></a><span id="l19.640" class="difflineplus">+ * @param {?boolean} verified whether to mark the device as verified. Null to</span>
<a href="#l19.641"></a><span id="l19.641" class="difflineplus">+ *     leave unchanged.</span>
<a href="#l19.642"></a><span id="l19.642" class="difflineplus">+ *</span>
<a href="#l19.643"></a><span id="l19.643" class="difflineplus">+ * @param {?boolean} blocked whether to mark the device as blocked. Null to</span>
<a href="#l19.644"></a><span id="l19.644" class="difflineplus">+ *      leave unchanged.</span>
<a href="#l19.645"></a><span id="l19.645" class="difflineplus">+ */</span>
<a href="#l19.646"></a><span id="l19.646" class="difflineplus">+Crypto.prototype.setDeviceVerification = function(userId, deviceId, verified, blocked) {</span>
<a href="#l19.647"></a><span id="l19.647" class="difflineplus">+    var devices = this._sessionStore.getEndToEndDevicesForUser(userId);</span>
<a href="#l19.648"></a><span id="l19.648" class="difflineplus">+    if (!devices || !devices[deviceId]) {</span>
<a href="#l19.649"></a><span id="l19.649" class="difflineplus">+        throw new Error(&quot;Unknown device &quot; + userId + &quot;:&quot; + deviceId);</span>
<a href="#l19.650"></a><span id="l19.650" class="difflineplus">+    }</span>
<a href="#l19.651"></a><span id="l19.651" class="difflineplus">+</span>
<a href="#l19.652"></a><span id="l19.652" class="difflineplus">+    var dev = devices[deviceId];</span>
<a href="#l19.653"></a><span id="l19.653" class="difflineplus">+    var verificationStatus = dev.verified;</span>
<a href="#l19.654"></a><span id="l19.654" class="difflineplus">+</span>
<a href="#l19.655"></a><span id="l19.655" class="difflineplus">+    if (verified) {</span>
<a href="#l19.656"></a><span id="l19.656" class="difflineplus">+        verificationStatus = DeviceVerification.VERIFIED;</span>
<a href="#l19.657"></a><span id="l19.657" class="difflineplus">+    } else if (verified !== null &amp;&amp; verificationStatus == DeviceVerification.VERIFIED) {</span>
<a href="#l19.658"></a><span id="l19.658" class="difflineplus">+        verificationStatus = DeviceVerification.UNVERIFIED;</span>
<a href="#l19.659"></a><span id="l19.659" class="difflineplus">+    }</span>
<a href="#l19.660"></a><span id="l19.660" class="difflineplus">+</span>
<a href="#l19.661"></a><span id="l19.661" class="difflineplus">+    if (blocked) {</span>
<a href="#l19.662"></a><span id="l19.662" class="difflineplus">+        verificationStatus = DeviceVerification.BLOCKED;</span>
<a href="#l19.663"></a><span id="l19.663" class="difflineplus">+    } else if (blocked !== null &amp;&amp; verificationStatus == DeviceVerification.BLOCKED) {</span>
<a href="#l19.664"></a><span id="l19.664" class="difflineplus">+        verificationStatus = DeviceVerification.UNVERIFIED;</span>
<a href="#l19.665"></a><span id="l19.665" class="difflineplus">+    }</span>
<a href="#l19.666"></a><span id="l19.666" class="difflineplus">+</span>
<a href="#l19.667"></a><span id="l19.667" class="difflineplus">+    if (dev.verified === verificationStatus) {</span>
<a href="#l19.668"></a><span id="l19.668" class="difflineplus">+        return;</span>
<a href="#l19.669"></a><span id="l19.669" class="difflineplus">+    }</span>
<a href="#l19.670"></a><span id="l19.670" class="difflineplus">+    dev.verified = verificationStatus;</span>
<a href="#l19.671"></a><span id="l19.671" class="difflineplus">+    this._sessionStore.storeEndToEndDevicesForUser(userId, devices);</span>
<a href="#l19.672"></a><span id="l19.672" class="difflineplus">+};</span>
<a href="#l19.673"></a><span id="l19.673" class="difflineplus">+</span>
<a href="#l19.674"></a><span id="l19.674" class="difflineplus">+</span>
<a href="#l19.675"></a><span id="l19.675" class="difflineplus">+/**</span>
<a href="#l19.676"></a><span id="l19.676" class="difflineplus">+ * Get information on the active olm sessions with a user</span>
<a href="#l19.677"></a><span id="l19.677" class="difflineplus">+ * &lt;p&gt;</span>
<a href="#l19.678"></a><span id="l19.678" class="difflineplus">+ * Returns a map from device id to an object with keys 'deviceIdKey' (the</span>
<a href="#l19.679"></a><span id="l19.679" class="difflineplus">+ * device's curve25519 identity key) and 'sessions' (an array of objects in the</span>
<a href="#l19.680"></a><span id="l19.680" class="difflineplus">+ * same format as that returned by</span>
<a href="#l19.681"></a><span id="l19.681" class="difflineplus">+ * {@link module:crypto/OlmDevice#getSessionInfoForDevice}).</span>
<a href="#l19.682"></a><span id="l19.682" class="difflineplus">+ * &lt;p&gt;</span>
<a href="#l19.683"></a><span id="l19.683" class="difflineplus">+ * This method is provided for debugging purposes.</span>
<a href="#l19.684"></a><span id="l19.684" class="difflineplus">+ *</span>
<a href="#l19.685"></a><span id="l19.685" class="difflineplus">+ * @param {string} userId id of user to inspect</span>
<a href="#l19.686"></a><span id="l19.686" class="difflineplus">+ *</span>
<a href="#l19.687"></a><span id="l19.687" class="difflineplus">+ * @return {Object.&lt;string, {deviceIdKey: string, sessions: object[]}&gt;}</span>
<a href="#l19.688"></a><span id="l19.688" class="difflineplus">+ */</span>
<a href="#l19.689"></a><span id="l19.689" class="difflineplus">+Crypto.prototype.getOlmSessionsForUser = function(userId) {</span>
<a href="#l19.690"></a><span id="l19.690" class="difflineplus">+    var devices = this.getStoredDevicesForUser(userId) || [];</span>
<a href="#l19.691"></a><span id="l19.691" class="difflineplus">+    var result = {};</span>
<a href="#l19.692"></a><span id="l19.692" class="difflineplus">+    for (var j = 0; j &lt; devices.length; ++j) {</span>
<a href="#l19.693"></a><span id="l19.693" class="difflineplus">+        var device = devices[j];</span>
<a href="#l19.694"></a><span id="l19.694" class="difflineplus">+        var deviceKey = device.getIdentityKey();</span>
<a href="#l19.695"></a><span id="l19.695" class="difflineplus">+        var sessions = this._olmDevice.getSessionInfoForDevice(deviceKey);</span>
<a href="#l19.696"></a><span id="l19.696" class="difflineplus">+</span>
<a href="#l19.697"></a><span id="l19.697" class="difflineplus">+        result[device.deviceId] = {</span>
<a href="#l19.698"></a><span id="l19.698" class="difflineplus">+            deviceIdKey: deviceKey,</span>
<a href="#l19.699"></a><span id="l19.699" class="difflineplus">+            sessions: sessions,</span>
<a href="#l19.700"></a><span id="l19.700" class="difflineplus">+        };</span>
<a href="#l19.701"></a><span id="l19.701" class="difflineplus">+    }</span>
<a href="#l19.702"></a><span id="l19.702" class="difflineplus">+    return result;</span>
<a href="#l19.703"></a><span id="l19.703" class="difflineplus">+};</span>
<a href="#l19.704"></a><span id="l19.704" class="difflineplus">+</span>
<a href="#l19.705"></a><span id="l19.705" class="difflineplus">+</span>
<a href="#l19.706"></a><span id="l19.706" class="difflineplus">+/**</span>
<a href="#l19.707"></a><span id="l19.707" class="difflineplus">+ * Get the device which sent an event</span>
<a href="#l19.708"></a><span id="l19.708" class="difflineplus">+ *</span>
<a href="#l19.709"></a><span id="l19.709" class="difflineplus">+ * @param {module:models/event.MatrixEvent} event event to be checked</span>
<a href="#l19.710"></a><span id="l19.710" class="difflineplus">+ *</span>
<a href="#l19.711"></a><span id="l19.711" class="difflineplus">+ * @return {module:crypto/deviceinfo?}</span>
<a href="#l19.712"></a><span id="l19.712" class="difflineplus">+ */</span>
<a href="#l19.713"></a><span id="l19.713" class="difflineplus">+Crypto.prototype.getEventSenderDeviceInfo = function(event) {</span>
<a href="#l19.714"></a><span id="l19.714" class="difflineplus">+    var sender_key = event.getSenderKey();</span>
<a href="#l19.715"></a><span id="l19.715" class="difflineplus">+    var algorithm = event.getWireContent().algorithm;</span>
<a href="#l19.716"></a><span id="l19.716" class="difflineplus">+</span>
<a href="#l19.717"></a><span id="l19.717" class="difflineplus">+    if (!sender_key || !algorithm) {</span>
<a href="#l19.718"></a><span id="l19.718" class="difflineplus">+        return null;</span>
<a href="#l19.719"></a><span id="l19.719" class="difflineplus">+    }</span>
<a href="#l19.720"></a><span id="l19.720" class="difflineplus">+</span>
<a href="#l19.721"></a><span id="l19.721" class="difflineplus">+    // sender_key is the Curve25519 identity key of the device which the event</span>
<a href="#l19.722"></a><span id="l19.722" class="difflineplus">+    // was sent from. In the case of Megolm, it's actually the Curve25519</span>
<a href="#l19.723"></a><span id="l19.723" class="difflineplus">+    // identity key of the device which set up the Megolm session.</span>
<a href="#l19.724"></a><span id="l19.724" class="difflineplus">+</span>
<a href="#l19.725"></a><span id="l19.725" class="difflineplus">+    var device = this.getDeviceByIdentityKey(</span>
<a href="#l19.726"></a><span id="l19.726" class="difflineplus">+        event.getSender(), algorithm, sender_key</span>
<a href="#l19.727"></a><span id="l19.727" class="difflineplus">+    );</span>
<a href="#l19.728"></a><span id="l19.728" class="difflineplus">+</span>
<a href="#l19.729"></a><span id="l19.729" class="difflineplus">+    if (device === null) {</span>
<a href="#l19.730"></a><span id="l19.730" class="difflineplus">+        // we haven't downloaded the details of this device yet.</span>
<a href="#l19.731"></a><span id="l19.731" class="difflineplus">+        return null;</span>
<a href="#l19.732"></a><span id="l19.732" class="difflineplus">+    }</span>
<a href="#l19.733"></a><span id="l19.733" class="difflineplus">+</span>
<a href="#l19.734"></a><span id="l19.734" class="difflineplus">+    // so far so good, but now we need to check that the sender of this event</span>
<a href="#l19.735"></a><span id="l19.735" class="difflineplus">+    // hadn't advertised someone else's Curve25519 key as their own. We do that</span>
<a href="#l19.736"></a><span id="l19.736" class="difflineplus">+    // by checking the Ed25519 claimed by the event (or, in the case of megolm,</span>
<a href="#l19.737"></a><span id="l19.737" class="difflineplus">+    // the event which set up the megolm session), to check that it matches the</span>
<a href="#l19.738"></a><span id="l19.738" class="difflineplus">+    // fingerprint of the purported sending device.</span>
<a href="#l19.739"></a><span id="l19.739" class="difflineplus">+    //</span>
<a href="#l19.740"></a><span id="l19.740" class="difflineplus">+    // (see https://github.com/vector-im/vector-web/issues/2215)</span>
<a href="#l19.741"></a><span id="l19.741" class="difflineplus">+</span>
<a href="#l19.742"></a><span id="l19.742" class="difflineplus">+    var claimedKey = event.getKeysClaimed().ed25519;</span>
<a href="#l19.743"></a><span id="l19.743" class="difflineplus">+    if (!claimedKey) {</span>
<a href="#l19.744"></a><span id="l19.744" class="difflineplus">+        console.warn(&quot;Event &quot; + event.getId() + &quot; claims no ed25519 key: &quot; +</span>
<a href="#l19.745"></a><span id="l19.745" class="difflineplus">+                     &quot;cannot verify sending device&quot;);</span>
<a href="#l19.746"></a><span id="l19.746" class="difflineplus">+        return null;</span>
<a href="#l19.747"></a><span id="l19.747" class="difflineplus">+    }</span>
<a href="#l19.748"></a><span id="l19.748" class="difflineplus">+</span>
<a href="#l19.749"></a><span id="l19.749" class="difflineplus">+    if (claimedKey !== device.getFingerprint()) {</span>
<a href="#l19.750"></a><span id="l19.750" class="difflineplus">+        console.warn(</span>
<a href="#l19.751"></a><span id="l19.751" class="difflineplus">+            &quot;Event &quot; + event.getId() + &quot; claims ed25519 key &quot; + claimedKey +</span>
<a href="#l19.752"></a><span id="l19.752" class="difflineplus">+                &quot;but sender device has key &quot; + device.getFingerprint());</span>
<a href="#l19.753"></a><span id="l19.753" class="difflineplus">+        return null;</span>
<a href="#l19.754"></a><span id="l19.754" class="difflineplus">+    }</span>
<a href="#l19.755"></a><span id="l19.755" class="difflineplus">+</span>
<a href="#l19.756"></a><span id="l19.756" class="difflineplus">+    return device;</span>
<a href="#l19.757"></a><span id="l19.757" class="difflineplus">+};</span>
<a href="#l19.758"></a><span id="l19.758" class="difflineplus">+</span>
<a href="#l19.759"></a><span id="l19.759" class="difflineplus">+</span>
<a href="#l19.760"></a><span id="l19.760" class="difflineplus">+/**</span>
<a href="#l19.761"></a><span id="l19.761" class="difflineplus">+ * Configure a room to use encryption (ie, save a flag in the sessionstore).</span>
<a href="#l19.762"></a><span id="l19.762" class="difflineplus">+ *</span>
<a href="#l19.763"></a><span id="l19.763" class="difflineplus">+ * @param {string} roomId The room ID to enable encryption in.</span>
<a href="#l19.764"></a><span id="l19.764" class="difflineplus">+ * @param {object} config The encryption config for the room.</span>
<a href="#l19.765"></a><span id="l19.765" class="difflineplus">+ */</span>
<a href="#l19.766"></a><span id="l19.766" class="difflineplus">+Crypto.prototype.setRoomEncryption = function(roomId, config) {</span>
<a href="#l19.767"></a><span id="l19.767" class="difflineplus">+    // if we already have encryption in this room, we should ignore this event</span>
<a href="#l19.768"></a><span id="l19.768" class="difflineplus">+    // (for now at least. maybe we should alert the user somehow?)</span>
<a href="#l19.769"></a><span id="l19.769" class="difflineplus">+    var existingConfig = this._sessionStore.getEndToEndRoom(roomId);</span>
<a href="#l19.770"></a><span id="l19.770" class="difflineplus">+    if (existingConfig) {</span>
<a href="#l19.771"></a><span id="l19.771" class="difflineplus">+        if (JSON.stringify(existingConfig) != JSON.stringify(config)) {</span>
<a href="#l19.772"></a><span id="l19.772" class="difflineplus">+            console.error(&quot;Ignoring m.room.encryption event which requests &quot; +</span>
<a href="#l19.773"></a><span id="l19.773" class="difflineplus">+                          &quot;a change of config in &quot; + roomId);</span>
<a href="#l19.774"></a><span id="l19.774" class="difflineplus">+            return;</span>
<a href="#l19.775"></a><span id="l19.775" class="difflineplus">+        }</span>
<a href="#l19.776"></a><span id="l19.776" class="difflineplus">+    }</span>
<a href="#l19.777"></a><span id="l19.777" class="difflineplus">+</span>
<a href="#l19.778"></a><span id="l19.778" class="difflineplus">+    var AlgClass = algorithms.ENCRYPTION_CLASSES[config.algorithm];</span>
<a href="#l19.779"></a><span id="l19.779" class="difflineplus">+    if (!AlgClass) {</span>
<a href="#l19.780"></a><span id="l19.780" class="difflineplus">+        throw new Error(&quot;Unable to encrypt with &quot; + config.algorithm);</span>
<a href="#l19.781"></a><span id="l19.781" class="difflineplus">+    }</span>
<a href="#l19.782"></a><span id="l19.782" class="difflineplus">+</span>
<a href="#l19.783"></a><span id="l19.783" class="difflineplus">+    // remove spurious keys</span>
<a href="#l19.784"></a><span id="l19.784" class="difflineplus">+    config = {</span>
<a href="#l19.785"></a><span id="l19.785" class="difflineplus">+        algorithm: config.algorithm,</span>
<a href="#l19.786"></a><span id="l19.786" class="difflineplus">+    };</span>
<a href="#l19.787"></a><span id="l19.787" class="difflineplus">+    this._sessionStore.storeEndToEndRoom(roomId, config);</span>
<a href="#l19.788"></a><span id="l19.788" class="difflineplus">+</span>
<a href="#l19.789"></a><span id="l19.789" class="difflineplus">+    var alg = new AlgClass({</span>
<a href="#l19.790"></a><span id="l19.790" class="difflineplus">+        userId: this._userId,</span>
<a href="#l19.791"></a><span id="l19.791" class="difflineplus">+        deviceId: this._deviceId,</span>
<a href="#l19.792"></a><span id="l19.792" class="difflineplus">+        crypto: this,</span>
<a href="#l19.793"></a><span id="l19.793" class="difflineplus">+        olmDevice: this._olmDevice,</span>
<a href="#l19.794"></a><span id="l19.794" class="difflineplus">+        baseApis: this._baseApis,</span>
<a href="#l19.795"></a><span id="l19.795" class="difflineplus">+        roomId: roomId,</span>
<a href="#l19.796"></a><span id="l19.796" class="difflineplus">+        config: config,</span>
<a href="#l19.797"></a><span id="l19.797" class="difflineplus">+    });</span>
<a href="#l19.798"></a><span id="l19.798" class="difflineplus">+    this._roomEncryptors[roomId] = alg;</span>
<a href="#l19.799"></a><span id="l19.799" class="difflineplus">+};</span>
<a href="#l19.800"></a><span id="l19.800" class="difflineplus">+</span>
<a href="#l19.801"></a><span id="l19.801" class="difflineplus">+</span>
<a href="#l19.802"></a><span id="l19.802" class="difflineplus">+/**</span>
<a href="#l19.803"></a><span id="l19.803" class="difflineplus">+ * @typedef {Object} module:crypto~OlmSessionResult</span>
<a href="#l19.804"></a><span id="l19.804" class="difflineplus">+ * @property {module:crypto/deviceinfo} device  device info</span>
<a href="#l19.805"></a><span id="l19.805" class="difflineplus">+ * @property {string?} sessionId base64 olm session id; null if no session</span>
<a href="#l19.806"></a><span id="l19.806" class="difflineplus">+ *    could be established</span>
<a href="#l19.807"></a><span id="l19.807" class="difflineplus">+ */</span>
<a href="#l19.808"></a><span id="l19.808" class="difflineplus">+</span>
<a href="#l19.809"></a><span id="l19.809" class="difflineplus">+/**</span>
<a href="#l19.810"></a><span id="l19.810" class="difflineplus">+ * Try to make sure we have established olm sessions for all known devices for</span>
<a href="#l19.811"></a><span id="l19.811" class="difflineplus">+ * the given users.</span>
<a href="#l19.812"></a><span id="l19.812" class="difflineplus">+ *</span>
<a href="#l19.813"></a><span id="l19.813" class="difflineplus">+ * @param {string[]} users list of user ids</span>
<a href="#l19.814"></a><span id="l19.814" class="difflineplus">+ *</span>
<a href="#l19.815"></a><span id="l19.815" class="difflineplus">+ * @return {module:client.Promise} resolves once the sessions are complete, to</span>
<a href="#l19.816"></a><span id="l19.816" class="difflineplus">+ *    an Object mapping from userId to deviceId to</span>
<a href="#l19.817"></a><span id="l19.817" class="difflineplus">+ *    {@link module:crypto~OlmSessionResult}</span>
<a href="#l19.818"></a><span id="l19.818" class="difflineplus">+ */</span>
<a href="#l19.819"></a><span id="l19.819" class="difflineplus">+Crypto.prototype.ensureOlmSessionsForUsers = function(users) {</span>
<a href="#l19.820"></a><span id="l19.820" class="difflineplus">+    var devicesByUser = {};</span>
<a href="#l19.821"></a><span id="l19.821" class="difflineplus">+</span>
<a href="#l19.822"></a><span id="l19.822" class="difflineplus">+    for (var i = 0; i &lt; users.length; ++i) {</span>
<a href="#l19.823"></a><span id="l19.823" class="difflineplus">+        var userId = users[i];</span>
<a href="#l19.824"></a><span id="l19.824" class="difflineplus">+        devicesByUser[userId] = [];</span>
<a href="#l19.825"></a><span id="l19.825" class="difflineplus">+</span>
<a href="#l19.826"></a><span id="l19.826" class="difflineplus">+        var devices = this.getStoredDevicesForUser(userId) || [];</span>
<a href="#l19.827"></a><span id="l19.827" class="difflineplus">+        for (var j = 0; j &lt; devices.length; ++j) {</span>
<a href="#l19.828"></a><span id="l19.828" class="difflineplus">+            var deviceInfo = devices[j];</span>
<a href="#l19.829"></a><span id="l19.829" class="difflineplus">+</span>
<a href="#l19.830"></a><span id="l19.830" class="difflineplus">+            var key = deviceInfo.getIdentityKey();</span>
<a href="#l19.831"></a><span id="l19.831" class="difflineplus">+            if (key == this._olmDevice.deviceCurve25519Key) {</span>
<a href="#l19.832"></a><span id="l19.832" class="difflineplus">+                // don't bother setting up session to ourself</span>
<a href="#l19.833"></a><span id="l19.833" class="difflineplus">+                continue;</span>
<a href="#l19.834"></a><span id="l19.834" class="difflineplus">+            }</span>
<a href="#l19.835"></a><span id="l19.835" class="difflineplus">+            if (deviceInfo.verified == DeviceVerification.BLOCKED) {</span>
<a href="#l19.836"></a><span id="l19.836" class="difflineplus">+                // don't bother setting up sessions with blocked users</span>
<a href="#l19.837"></a><span id="l19.837" class="difflineplus">+                continue;</span>
<a href="#l19.838"></a><span id="l19.838" class="difflineplus">+            }</span>
<a href="#l19.839"></a><span id="l19.839" class="difflineplus">+</span>
<a href="#l19.840"></a><span id="l19.840" class="difflineplus">+            devicesByUser[userId].push(deviceInfo);</span>
<a href="#l19.841"></a><span id="l19.841" class="difflineplus">+        }</span>
<a href="#l19.842"></a><span id="l19.842" class="difflineplus">+    }</span>
<a href="#l19.843"></a><span id="l19.843" class="difflineplus">+</span>
<a href="#l19.844"></a><span id="l19.844" class="difflineplus">+    return olmlib.ensureOlmSessionsForDevices(</span>
<a href="#l19.845"></a><span id="l19.845" class="difflineplus">+        this._olmDevice, this._baseApis, devicesByUser</span>
<a href="#l19.846"></a><span id="l19.846" class="difflineplus">+    );</span>
<a href="#l19.847"></a><span id="l19.847" class="difflineplus">+};</span>
<a href="#l19.848"></a><span id="l19.848" class="difflineplus">+</span>
<a href="#l19.849"></a><span id="l19.849" class="difflineplus">+/**</span>
<a href="#l19.850"></a><span id="l19.850" class="difflineplus">+ * Whether encryption is enabled for a room.</span>
<a href="#l19.851"></a><span id="l19.851" class="difflineplus">+ * @param {string} roomId the room id to query.</span>
<a href="#l19.852"></a><span id="l19.852" class="difflineplus">+ * @return {bool} whether encryption is enabled.</span>
<a href="#l19.853"></a><span id="l19.853" class="difflineplus">+ */</span>
<a href="#l19.854"></a><span id="l19.854" class="difflineplus">+Crypto.prototype.isRoomEncrypted = function(roomId) {</span>
<a href="#l19.855"></a><span id="l19.855" class="difflineplus">+    return Boolean(this._roomEncryptors[roomId]);</span>
<a href="#l19.856"></a><span id="l19.856" class="difflineplus">+};</span>
<a href="#l19.857"></a><span id="l19.857" class="difflineplus">+</span>
<a href="#l19.858"></a><span id="l19.858" class="difflineplus">+/**</span>
<a href="#l19.859"></a><span id="l19.859" class="difflineplus">+ * Encrypt an event according to the configuration of the room, if necessary.</span>
<a href="#l19.860"></a><span id="l19.860" class="difflineplus">+ *</span>
<a href="#l19.861"></a><span id="l19.861" class="difflineplus">+ * @param {module:models/event.MatrixEvent} event  event to be sent</span>
<a href="#l19.862"></a><span id="l19.862" class="difflineplus">+ *</span>
<a href="#l19.863"></a><span id="l19.863" class="difflineplus">+ * @param {module:models/room?} room destination room. Null if the destination</span>
<a href="#l19.864"></a><span id="l19.864" class="difflineplus">+ *     is not a room we have seen over the sync pipe.</span>
<a href="#l19.865"></a><span id="l19.865" class="difflineplus">+ *</span>
<a href="#l19.866"></a><span id="l19.866" class="difflineplus">+ * @return {module:client.Promise?} Promise which resolves when the event has been</span>
<a href="#l19.867"></a><span id="l19.867" class="difflineplus">+ *     encrypted, or null if nothing was needed</span>
<a href="#l19.868"></a><span id="l19.868" class="difflineplus">+ */</span>
<a href="#l19.869"></a><span id="l19.869" class="difflineplus">+Crypto.prototype.encryptEventIfNeeded = function(event, room) {</span>
<a href="#l19.870"></a><span id="l19.870" class="difflineplus">+    if (event.isEncrypted()) {</span>
<a href="#l19.871"></a><span id="l19.871" class="difflineplus">+        // this event has already been encrypted; this happens if the</span>
<a href="#l19.872"></a><span id="l19.872" class="difflineplus">+        // encryption step succeeded, but the send step failed on the first</span>
<a href="#l19.873"></a><span id="l19.873" class="difflineplus">+        // attempt.</span>
<a href="#l19.874"></a><span id="l19.874" class="difflineplus">+        return null;</span>
<a href="#l19.875"></a><span id="l19.875" class="difflineplus">+    }</span>
<a href="#l19.876"></a><span id="l19.876" class="difflineplus">+</span>
<a href="#l19.877"></a><span id="l19.877" class="difflineplus">+    if (!room) {</span>
<a href="#l19.878"></a><span id="l19.878" class="difflineplus">+        throw new Error(&quot;Cannot send encrypted messages in unknown rooms&quot;);</span>
<a href="#l19.879"></a><span id="l19.879" class="difflineplus">+    }</span>
<a href="#l19.880"></a><span id="l19.880" class="difflineplus">+</span>
<a href="#l19.881"></a><span id="l19.881" class="difflineplus">+    var roomId = event.getRoomId();</span>
<a href="#l19.882"></a><span id="l19.882" class="difflineplus">+</span>
<a href="#l19.883"></a><span id="l19.883" class="difflineplus">+    var alg = this._roomEncryptors[roomId];</span>
<a href="#l19.884"></a><span id="l19.884" class="difflineplus">+    if (!alg) {</span>
<a href="#l19.885"></a><span id="l19.885" class="difflineplus">+        // not encrypting messages in this room</span>
<a href="#l19.886"></a><span id="l19.886" class="difflineplus">+</span>
<a href="#l19.887"></a><span id="l19.887" class="difflineplus">+        // check that the HS hasn't hidden the crypto event</span>
<a href="#l19.888"></a><span id="l19.888" class="difflineplus">+        if (this._sessionStore.getEndToEndRoom(roomId)) {</span>
<a href="#l19.889"></a><span id="l19.889" class="difflineplus">+            throw new Error(</span>
<a href="#l19.890"></a><span id="l19.890" class="difflineplus">+                &quot;Room was previously configured to use encryption, but is &quot; +</span>
<a href="#l19.891"></a><span id="l19.891" class="difflineplus">+                &quot;no longer. Perhaps the homeserver is hiding the &quot; +</span>
<a href="#l19.892"></a><span id="l19.892" class="difflineplus">+                &quot;configuration event.&quot;</span>
<a href="#l19.893"></a><span id="l19.893" class="difflineplus">+            );</span>
<a href="#l19.894"></a><span id="l19.894" class="difflineplus">+        }</span>
<a href="#l19.895"></a><span id="l19.895" class="difflineplus">+        return null;</span>
<a href="#l19.896"></a><span id="l19.896" class="difflineplus">+    }</span>
<a href="#l19.897"></a><span id="l19.897" class="difflineplus">+</span>
<a href="#l19.898"></a><span id="l19.898" class="difflineplus">+    // We can claim and prove ownership of all our device keys in the local</span>
<a href="#l19.899"></a><span id="l19.899" class="difflineplus">+    // echo of the event since we know that all the local echos come from</span>
<a href="#l19.900"></a><span id="l19.900" class="difflineplus">+    // this device.</span>
<a href="#l19.901"></a><span id="l19.901" class="difflineplus">+    var myKeys = {</span>
<a href="#l19.902"></a><span id="l19.902" class="difflineplus">+        curve25519: this._olmDevice.deviceCurve25519Key,</span>
<a href="#l19.903"></a><span id="l19.903" class="difflineplus">+        ed25519: this._olmDevice.deviceEd25519Key,</span>
<a href="#l19.904"></a><span id="l19.904" class="difflineplus">+    };</span>
<a href="#l19.905"></a><span id="l19.905" class="difflineplus">+</span>
<a href="#l19.906"></a><span id="l19.906" class="difflineplus">+    return alg.encryptMessage(</span>
<a href="#l19.907"></a><span id="l19.907" class="difflineplus">+        room, event.getType(), event.getContent()</span>
<a href="#l19.908"></a><span id="l19.908" class="difflineplus">+    ).then(function(encryptedContent) {</span>
<a href="#l19.909"></a><span id="l19.909" class="difflineplus">+        event.makeEncrypted(&quot;m.room.encrypted&quot;, encryptedContent, myKeys);</span>
<a href="#l19.910"></a><span id="l19.910" class="difflineplus">+    });</span>
<a href="#l19.911"></a><span id="l19.911" class="difflineplus">+};</span>
<a href="#l19.912"></a><span id="l19.912" class="difflineplus">+</span>
<a href="#l19.913"></a><span id="l19.913" class="difflineplus">+/**</span>
<a href="#l19.914"></a><span id="l19.914" class="difflineplus">+ * Decrypt a received event</span>
<a href="#l19.915"></a><span id="l19.915" class="difflineplus">+ *</span>
<a href="#l19.916"></a><span id="l19.916" class="difflineplus">+ * @param {MatrixEvent} event</span>
<a href="#l19.917"></a><span id="l19.917" class="difflineplus">+ *</span>
<a href="#l19.918"></a><span id="l19.918" class="difflineplus">+ * @raises {algorithms.DecryptionError} if there is a problem decrypting the event</span>
<a href="#l19.919"></a><span id="l19.919" class="difflineplus">+ */</span>
<a href="#l19.920"></a><span id="l19.920" class="difflineplus">+Crypto.prototype.decryptEvent = function(event) {</span>
<a href="#l19.921"></a><span id="l19.921" class="difflineplus">+    var content = event.getWireContent();</span>
<a href="#l19.922"></a><span id="l19.922" class="difflineplus">+    var alg = this._getRoomDecryptor(event.getRoomId(), content.algorithm);</span>
<a href="#l19.923"></a><span id="l19.923" class="difflineplus">+    alg.decryptEvent(event);</span>
<a href="#l19.924"></a><span id="l19.924" class="difflineplus">+};</span>
<a href="#l19.925"></a><span id="l19.925" class="difflineplus">+</span>
<a href="#l19.926"></a><span id="l19.926" class="difflineplus">+/**</span>
<a href="#l19.927"></a><span id="l19.927" class="difflineplus">+ * Send a &quot;m.new_device&quot; message to remind it that we exist and are a member</span>
<a href="#l19.928"></a><span id="l19.928" class="difflineplus">+ * of a room.</span>
<a href="#l19.929"></a><span id="l19.929" class="difflineplus">+ *</span>
<a href="#l19.930"></a><span id="l19.930" class="difflineplus">+ * This is rate limited to send a message at most once an hour per desination.</span>
<a href="#l19.931"></a><span id="l19.931" class="difflineplus">+ *</span>
<a href="#l19.932"></a><span id="l19.932" class="difflineplus">+ * @param {string}  userId   The ID of the user to ping.</span>
<a href="#l19.933"></a><span id="l19.933" class="difflineplus">+ * @param {string?} deviceId The ID of the device to ping. If null, all</span>
<a href="#l19.934"></a><span id="l19.934" class="difflineplus">+ *     devices.</span>
<a href="#l19.935"></a><span id="l19.935" class="difflineplus">+ * @param {string}  roomId   The ID of the room we want to remind them about.</span>
<a href="#l19.936"></a><span id="l19.936" class="difflineplus">+ */</span>
<a href="#l19.937"></a><span id="l19.937" class="difflineplus">+Crypto.prototype._sendPingToDevice = function(userId, deviceId, roomId) {</span>
<a href="#l19.938"></a><span id="l19.938" class="difflineplus">+    if (deviceId === null) {</span>
<a href="#l19.939"></a><span id="l19.939" class="difflineplus">+        deviceId = &quot;*&quot;;</span>
<a href="#l19.940"></a><span id="l19.940" class="difflineplus">+    }</span>
<a href="#l19.941"></a><span id="l19.941" class="difflineplus">+</span>
<a href="#l19.942"></a><span id="l19.942" class="difflineplus">+    var lastMessageTsMap = this._lastNewDeviceMessageTsByUserDeviceRoom;</span>
<a href="#l19.943"></a><span id="l19.943" class="difflineplus">+</span>
<a href="#l19.944"></a><span id="l19.944" class="difflineplus">+    var lastTsByDevice = lastMessageTsMap[userId];</span>
<a href="#l19.945"></a><span id="l19.945" class="difflineplus">+    if (!lastTsByDevice) {</span>
<a href="#l19.946"></a><span id="l19.946" class="difflineplus">+        lastTsByDevice = lastMessageTsMap[userId] = {};</span>
<a href="#l19.947"></a><span id="l19.947" class="difflineplus">+    }</span>
<a href="#l19.948"></a><span id="l19.948" class="difflineplus">+</span>
<a href="#l19.949"></a><span id="l19.949" class="difflineplus">+    var lastTsByRoom = lastTsByDevice[deviceId];</span>
<a href="#l19.950"></a><span id="l19.950" class="difflineplus">+    if (!lastTsByRoom) {</span>
<a href="#l19.951"></a><span id="l19.951" class="difflineplus">+        lastTsByRoom = lastTsByDevice[deviceId] = {};</span>
<a href="#l19.952"></a><span id="l19.952" class="difflineplus">+    }</span>
<a href="#l19.953"></a><span id="l19.953" class="difflineplus">+</span>
<a href="#l19.954"></a><span id="l19.954" class="difflineplus">+    var lastTs = lastTsByRoom[roomId];</span>
<a href="#l19.955"></a><span id="l19.955" class="difflineplus">+    var timeNowMs = Date.now();</span>
<a href="#l19.956"></a><span id="l19.956" class="difflineplus">+    var oneHourMs = 1000 * 60 * 60;</span>
<a href="#l19.957"></a><span id="l19.957" class="difflineplus">+</span>
<a href="#l19.958"></a><span id="l19.958" class="difflineplus">+    if (lastTs !== undefined &amp;&amp; lastTs + oneHourMs &gt; timeNowMs) {</span>
<a href="#l19.959"></a><span id="l19.959" class="difflineplus">+        // rate-limiting</span>
<a href="#l19.960"></a><span id="l19.960" class="difflineplus">+        return;</span>
<a href="#l19.961"></a><span id="l19.961" class="difflineplus">+    }</span>
<a href="#l19.962"></a><span id="l19.962" class="difflineplus">+</span>
<a href="#l19.963"></a><span id="l19.963" class="difflineplus">+    var content = {};</span>
<a href="#l19.964"></a><span id="l19.964" class="difflineplus">+    content[userId] = {};</span>
<a href="#l19.965"></a><span id="l19.965" class="difflineplus">+    content[userId][deviceId] = {</span>
<a href="#l19.966"></a><span id="l19.966" class="difflineplus">+        device_id: this._deviceId,</span>
<a href="#l19.967"></a><span id="l19.967" class="difflineplus">+        rooms: [roomId],</span>
<a href="#l19.968"></a><span id="l19.968" class="difflineplus">+    };</span>
<a href="#l19.969"></a><span id="l19.969" class="difflineplus">+</span>
<a href="#l19.970"></a><span id="l19.970" class="difflineplus">+    this._baseApis.sendToDevice(</span>
<a href="#l19.971"></a><span id="l19.971" class="difflineplus">+        &quot;m.new_device&quot;, // OH HAI!</span>
<a href="#l19.972"></a><span id="l19.972" class="difflineplus">+        content</span>
<a href="#l19.973"></a><span id="l19.973" class="difflineplus">+    ).done();</span>
<a href="#l19.974"></a><span id="l19.974" class="difflineplus">+</span>
<a href="#l19.975"></a><span id="l19.975" class="difflineplus">+    lastTsByRoom[roomId] = timeNowMs;</span>
<a href="#l19.976"></a><span id="l19.976" class="difflineplus">+};</span>
<a href="#l19.977"></a><span id="l19.977" class="difflineplus">+</span>
<a href="#l19.978"></a><span id="l19.978" class="difflineplus">+/**</span>
<a href="#l19.979"></a><span id="l19.979" class="difflineplus">+ * handle an m.room.encryption event</span>
<a href="#l19.980"></a><span id="l19.980" class="difflineplus">+ *</span>
<a href="#l19.981"></a><span id="l19.981" class="difflineplus">+ * @private</span>
<a href="#l19.982"></a><span id="l19.982" class="difflineplus">+ * @param {module:models/event.MatrixEvent} event encryption event</span>
<a href="#l19.983"></a><span id="l19.983" class="difflineplus">+ */</span>
<a href="#l19.984"></a><span id="l19.984" class="difflineplus">+Crypto.prototype._onCryptoEvent = function(event) {</span>
<a href="#l19.985"></a><span id="l19.985" class="difflineplus">+    var roomId = event.getRoomId();</span>
<a href="#l19.986"></a><span id="l19.986" class="difflineplus">+    var content = event.getContent();</span>
<a href="#l19.987"></a><span id="l19.987" class="difflineplus">+</span>
<a href="#l19.988"></a><span id="l19.988" class="difflineplus">+    try {</span>
<a href="#l19.989"></a><span id="l19.989" class="difflineplus">+        this.setRoomEncryption(roomId, content);</span>
<a href="#l19.990"></a><span id="l19.990" class="difflineplus">+    } catch (e) {</span>
<a href="#l19.991"></a><span id="l19.991" class="difflineplus">+        console.error(&quot;Error configuring encryption in room &quot; + roomId +</span>
<a href="#l19.992"></a><span id="l19.992" class="difflineplus">+                      &quot;:&quot;, e);</span>
<a href="#l19.993"></a><span id="l19.993" class="difflineplus">+    }</span>
<a href="#l19.994"></a><span id="l19.994" class="difflineplus">+};</span>
<a href="#l19.995"></a><span id="l19.995" class="difflineplus">+</span>
<a href="#l19.996"></a><span id="l19.996" class="difflineplus">+/**</span>
<a href="#l19.997"></a><span id="l19.997" class="difflineplus">+ * handle the completion of the initial sync.</span>
<a href="#l19.998"></a><span id="l19.998" class="difflineplus">+ *</span>
<a href="#l19.999"></a><span id="l19.999" class="difflineplus">+ * Announces the new device.</span>
<a href="#l19.1000"></a><span id="l19.1000" class="difflineplus">+ *</span>
<a href="#l19.1001"></a><span id="l19.1001" class="difflineplus">+ * @private</span>
<a href="#l19.1002"></a><span id="l19.1002" class="difflineplus">+ * @param {module:models/room[]} rooms list of rooms the client knows about</span>
<a href="#l19.1003"></a><span id="l19.1003" class="difflineplus">+ */</span>
<a href="#l19.1004"></a><span id="l19.1004" class="difflineplus">+Crypto.prototype._onInitialSyncCompleted = function(rooms) {</span>
<a href="#l19.1005"></a><span id="l19.1005" class="difflineplus">+    this._initialSyncCompleted = true;</span>
<a href="#l19.1006"></a><span id="l19.1006" class="difflineplus">+</span>
<a href="#l19.1007"></a><span id="l19.1007" class="difflineplus">+    // catch up on any m.new_device events which arrived during the initial sync.</span>
<a href="#l19.1008"></a><span id="l19.1008" class="difflineplus">+    this._flushNewDeviceRequests();</span>
<a href="#l19.1009"></a><span id="l19.1009" class="difflineplus">+</span>
<a href="#l19.1010"></a><span id="l19.1010" class="difflineplus">+    if (this._sessionStore.getDeviceAnnounced()) {</span>
<a href="#l19.1011"></a><span id="l19.1011" class="difflineplus">+        return;</span>
<a href="#l19.1012"></a><span id="l19.1012" class="difflineplus">+    }</span>
<a href="#l19.1013"></a><span id="l19.1013" class="difflineplus">+</span>
<a href="#l19.1014"></a><span id="l19.1014" class="difflineplus">+    // we need to tell all the devices in all the rooms we are members of that</span>
<a href="#l19.1015"></a><span id="l19.1015" class="difflineplus">+    // we have arrived.</span>
<a href="#l19.1016"></a><span id="l19.1016" class="difflineplus">+    // build a list of rooms for each user.</span>
<a href="#l19.1017"></a><span id="l19.1017" class="difflineplus">+    var roomsByUser = {};</span>
<a href="#l19.1018"></a><span id="l19.1018" class="difflineplus">+    for (var i = 0; i &lt; rooms.length; i++) {</span>
<a href="#l19.1019"></a><span id="l19.1019" class="difflineplus">+        var room = rooms[i];</span>
<a href="#l19.1020"></a><span id="l19.1020" class="difflineplus">+</span>
<a href="#l19.1021"></a><span id="l19.1021" class="difflineplus">+        // check for rooms with encryption enabled</span>
<a href="#l19.1022"></a><span id="l19.1022" class="difflineplus">+        var alg = this._roomEncryptors[room.roomId];</span>
<a href="#l19.1023"></a><span id="l19.1023" class="difflineplus">+        if (!alg) {</span>
<a href="#l19.1024"></a><span id="l19.1024" class="difflineplus">+            continue;</span>
<a href="#l19.1025"></a><span id="l19.1025" class="difflineplus">+        }</span>
<a href="#l19.1026"></a><span id="l19.1026" class="difflineplus">+</span>
<a href="#l19.1027"></a><span id="l19.1027" class="difflineplus">+        // ignore any rooms which we have left</span>
<a href="#l19.1028"></a><span id="l19.1028" class="difflineplus">+        var me = room.getMember(this._userId);</span>
<a href="#l19.1029"></a><span id="l19.1029" class="difflineplus">+        if (!me || (</span>
<a href="#l19.1030"></a><span id="l19.1030" class="difflineplus">+            me.membership !== &quot;join&quot; &amp;&amp; me.membership !== &quot;invite&quot;</span>
<a href="#l19.1031"></a><span id="l19.1031" class="difflineplus">+        )) {</span>
<a href="#l19.1032"></a><span id="l19.1032" class="difflineplus">+            continue;</span>
<a href="#l19.1033"></a><span id="l19.1033" class="difflineplus">+        }</span>
<a href="#l19.1034"></a><span id="l19.1034" class="difflineplus">+</span>
<a href="#l19.1035"></a><span id="l19.1035" class="difflineplus">+        var members = room.getJoinedMembers();</span>
<a href="#l19.1036"></a><span id="l19.1036" class="difflineplus">+        for (var j = 0; j &lt; members.length; j++) {</span>
<a href="#l19.1037"></a><span id="l19.1037" class="difflineplus">+            var m = members[j];</span>
<a href="#l19.1038"></a><span id="l19.1038" class="difflineplus">+            if (!roomsByUser[m.userId]) {</span>
<a href="#l19.1039"></a><span id="l19.1039" class="difflineplus">+                roomsByUser[m.userId] = [];</span>
<a href="#l19.1040"></a><span id="l19.1040" class="difflineplus">+            }</span>
<a href="#l19.1041"></a><span id="l19.1041" class="difflineplus">+            roomsByUser[m.userId].push(room.roomId);</span>
<a href="#l19.1042"></a><span id="l19.1042" class="difflineplus">+        }</span>
<a href="#l19.1043"></a><span id="l19.1043" class="difflineplus">+    }</span>
<a href="#l19.1044"></a><span id="l19.1044" class="difflineplus">+</span>
<a href="#l19.1045"></a><span id="l19.1045" class="difflineplus">+    // build a per-device message for each user</span>
<a href="#l19.1046"></a><span id="l19.1046" class="difflineplus">+    var content = {};</span>
<a href="#l19.1047"></a><span id="l19.1047" class="difflineplus">+    for (var userId in roomsByUser) {</span>
<a href="#l19.1048"></a><span id="l19.1048" class="difflineplus">+        if (!roomsByUser.hasOwnProperty(userId)) {</span>
<a href="#l19.1049"></a><span id="l19.1049" class="difflineplus">+            continue;</span>
<a href="#l19.1050"></a><span id="l19.1050" class="difflineplus">+        }</span>
<a href="#l19.1051"></a><span id="l19.1051" class="difflineplus">+        content[userId] = {</span>
<a href="#l19.1052"></a><span id="l19.1052" class="difflineplus">+            &quot;*&quot;: {</span>
<a href="#l19.1053"></a><span id="l19.1053" class="difflineplus">+                device_id: this._deviceId,</span>
<a href="#l19.1054"></a><span id="l19.1054" class="difflineplus">+                rooms: roomsByUser[userId],</span>
<a href="#l19.1055"></a><span id="l19.1055" class="difflineplus">+            },</span>
<a href="#l19.1056"></a><span id="l19.1056" class="difflineplus">+        };</span>
<a href="#l19.1057"></a><span id="l19.1057" class="difflineplus">+    }</span>
<a href="#l19.1058"></a><span id="l19.1058" class="difflineplus">+</span>
<a href="#l19.1059"></a><span id="l19.1059" class="difflineplus">+    var self = this;</span>
<a href="#l19.1060"></a><span id="l19.1060" class="difflineplus">+    this._baseApis.sendToDevice(</span>
<a href="#l19.1061"></a><span id="l19.1061" class="difflineplus">+        &quot;m.new_device&quot;, // OH HAI!</span>
<a href="#l19.1062"></a><span id="l19.1062" class="difflineplus">+        content</span>
<a href="#l19.1063"></a><span id="l19.1063" class="difflineplus">+    ).done(function() {</span>
<a href="#l19.1064"></a><span id="l19.1064" class="difflineplus">+        self._sessionStore.setDeviceAnnounced();</span>
<a href="#l19.1065"></a><span id="l19.1065" class="difflineplus">+    });</span>
<a href="#l19.1066"></a><span id="l19.1066" class="difflineplus">+};</span>
<a href="#l19.1067"></a><span id="l19.1067" class="difflineplus">+</span>
<a href="#l19.1068"></a><span id="l19.1068" class="difflineplus">+/**</span>
<a href="#l19.1069"></a><span id="l19.1069" class="difflineplus">+ * Handle a key event</span>
<a href="#l19.1070"></a><span id="l19.1070" class="difflineplus">+ *</span>
<a href="#l19.1071"></a><span id="l19.1071" class="difflineplus">+ * @private</span>
<a href="#l19.1072"></a><span id="l19.1072" class="difflineplus">+ * @param {module:models/event.MatrixEvent} event key event</span>
<a href="#l19.1073"></a><span id="l19.1073" class="difflineplus">+ */</span>
<a href="#l19.1074"></a><span id="l19.1074" class="difflineplus">+Crypto.prototype._onRoomKeyEvent = function(event) {</span>
<a href="#l19.1075"></a><span id="l19.1075" class="difflineplus">+    var content = event.getContent();</span>
<a href="#l19.1076"></a><span id="l19.1076" class="difflineplus">+</span>
<a href="#l19.1077"></a><span id="l19.1077" class="difflineplus">+    if (!content.room_id || !content.algorithm) {</span>
<a href="#l19.1078"></a><span id="l19.1078" class="difflineplus">+        console.error(&quot;key event is missing fields&quot;);</span>
<a href="#l19.1079"></a><span id="l19.1079" class="difflineplus">+        return;</span>
<a href="#l19.1080"></a><span id="l19.1080" class="difflineplus">+    }</span>
<a href="#l19.1081"></a><span id="l19.1081" class="difflineplus">+</span>
<a href="#l19.1082"></a><span id="l19.1082" class="difflineplus">+    var alg = this._getRoomDecryptor(content.room_id, content.algorithm);</span>
<a href="#l19.1083"></a><span id="l19.1083" class="difflineplus">+    alg.onRoomKeyEvent(event);</span>
<a href="#l19.1084"></a><span id="l19.1084" class="difflineplus">+};</span>
<a href="#l19.1085"></a><span id="l19.1085" class="difflineplus">+</span>
<a href="#l19.1086"></a><span id="l19.1086" class="difflineplus">+/**</span>
<a href="#l19.1087"></a><span id="l19.1087" class="difflineplus">+ * Handle a change in the membership state of a member of a room</span>
<a href="#l19.1088"></a><span id="l19.1088" class="difflineplus">+ *</span>
<a href="#l19.1089"></a><span id="l19.1089" class="difflineplus">+ * @private</span>
<a href="#l19.1090"></a><span id="l19.1090" class="difflineplus">+ * @param {module:models/event.MatrixEvent} event  event causing the change</span>
<a href="#l19.1091"></a><span id="l19.1091" class="difflineplus">+ * @param {module:models/room-member} member  user whose membership changed</span>
<a href="#l19.1092"></a><span id="l19.1092" class="difflineplus">+ * @param {string=} oldMembership  previous membership</span>
<a href="#l19.1093"></a><span id="l19.1093" class="difflineplus">+ */</span>
<a href="#l19.1094"></a><span id="l19.1094" class="difflineplus">+Crypto.prototype._onRoomMembership = function(event, member, oldMembership) {</span>
<a href="#l19.1095"></a><span id="l19.1095" class="difflineplus">+</span>
<a href="#l19.1096"></a><span id="l19.1096" class="difflineplus">+    // this event handler is registered on the *client* (as opposed to the room</span>
<a href="#l19.1097"></a><span id="l19.1097" class="difflineplus">+    // member itself), which means it is only called on changes to the *live*</span>
<a href="#l19.1098"></a><span id="l19.1098" class="difflineplus">+    // membership state (ie, it is not called when we back-paginate, nor when</span>
<a href="#l19.1099"></a><span id="l19.1099" class="difflineplus">+    // we load the state in the initialsync).</span>
<a href="#l19.1100"></a><span id="l19.1100" class="difflineplus">+    //</span>
<a href="#l19.1101"></a><span id="l19.1101" class="difflineplus">+    // Further, it is automatically registered and called when new members</span>
<a href="#l19.1102"></a><span id="l19.1102" class="difflineplus">+    // arrive in the room.</span>
<a href="#l19.1103"></a><span id="l19.1103" class="difflineplus">+</span>
<a href="#l19.1104"></a><span id="l19.1104" class="difflineplus">+    var roomId = member.roomId;</span>
<a href="#l19.1105"></a><span id="l19.1105" class="difflineplus">+</span>
<a href="#l19.1106"></a><span id="l19.1106" class="difflineplus">+    var alg = this._roomEncryptors[roomId];</span>
<a href="#l19.1107"></a><span id="l19.1107" class="difflineplus">+    if (!alg) {</span>
<a href="#l19.1108"></a><span id="l19.1108" class="difflineplus">+        // not encrypting in this room</span>
<a href="#l19.1109"></a><span id="l19.1109" class="difflineplus">+        return;</span>
<a href="#l19.1110"></a><span id="l19.1110" class="difflineplus">+    }</span>
<a href="#l19.1111"></a><span id="l19.1111" class="difflineplus">+</span>
<a href="#l19.1112"></a><span id="l19.1112" class="difflineplus">+    alg.onRoomMembership(event, member, oldMembership);</span>
<a href="#l19.1113"></a><span id="l19.1113" class="difflineplus">+};</span>
<a href="#l19.1114"></a><span id="l19.1114" class="difflineplus">+</span>
<a href="#l19.1115"></a><span id="l19.1115" class="difflineplus">+</span>
<a href="#l19.1116"></a><span id="l19.1116" class="difflineplus">+/**</span>
<a href="#l19.1117"></a><span id="l19.1117" class="difflineplus">+ * Called when a new device announces itself</span>
<a href="#l19.1118"></a><span id="l19.1118" class="difflineplus">+ *</span>
<a href="#l19.1119"></a><span id="l19.1119" class="difflineplus">+ * @private</span>
<a href="#l19.1120"></a><span id="l19.1120" class="difflineplus">+ * @param {module:models/event.MatrixEvent} event announcement event</span>
<a href="#l19.1121"></a><span id="l19.1121" class="difflineplus">+ */</span>
<a href="#l19.1122"></a><span id="l19.1122" class="difflineplus">+Crypto.prototype._onNewDeviceEvent = function(event) {</span>
<a href="#l19.1123"></a><span id="l19.1123" class="difflineplus">+    var content = event.getContent();</span>
<a href="#l19.1124"></a><span id="l19.1124" class="difflineplus">+    var userId = event.getSender();</span>
<a href="#l19.1125"></a><span id="l19.1125" class="difflineplus">+    var deviceId = content.device_id;</span>
<a href="#l19.1126"></a><span id="l19.1126" class="difflineplus">+    var rooms = content.rooms;</span>
<a href="#l19.1127"></a><span id="l19.1127" class="difflineplus">+</span>
<a href="#l19.1128"></a><span id="l19.1128" class="difflineplus">+    if (!rooms || !deviceId) {</span>
<a href="#l19.1129"></a><span id="l19.1129" class="difflineplus">+        console.warn(&quot;new_device event missing keys&quot;);</span>
<a href="#l19.1130"></a><span id="l19.1130" class="difflineplus">+        return;</span>
<a href="#l19.1131"></a><span id="l19.1131" class="difflineplus">+    }</span>
<a href="#l19.1132"></a><span id="l19.1132" class="difflineplus">+</span>
<a href="#l19.1133"></a><span id="l19.1133" class="difflineplus">+    console.log(&quot;m.new_device event from &quot; + userId + &quot;:&quot; + deviceId +</span>
<a href="#l19.1134"></a><span id="l19.1134" class="difflineplus">+                &quot; for rooms &quot; + rooms);</span>
<a href="#l19.1135"></a><span id="l19.1135" class="difflineplus">+</span>
<a href="#l19.1136"></a><span id="l19.1136" class="difflineplus">+    if (this.getStoredDevice(userId, deviceId)) {</span>
<a href="#l19.1137"></a><span id="l19.1137" class="difflineplus">+        console.log(&quot;Known device; ignoring&quot;);</span>
<a href="#l19.1138"></a><span id="l19.1138" class="difflineplus">+        return;</span>
<a href="#l19.1139"></a><span id="l19.1139" class="difflineplus">+    }</span>
<a href="#l19.1140"></a><span id="l19.1140" class="difflineplus">+</span>
<a href="#l19.1141"></a><span id="l19.1141" class="difflineplus">+    this._pendingNewDevices[userId] = this._pendingNewDevices[userId] || {};</span>
<a href="#l19.1142"></a><span id="l19.1142" class="difflineplus">+    this._pendingNewDevices[userId][deviceId] = true;</span>
<a href="#l19.1143"></a><span id="l19.1143" class="difflineplus">+</span>
<a href="#l19.1144"></a><span id="l19.1144" class="difflineplus">+    // we delay handling these until the intialsync has completed, so that we</span>
<a href="#l19.1145"></a><span id="l19.1145" class="difflineplus">+    // can do all of them together.</span>
<a href="#l19.1146"></a><span id="l19.1146" class="difflineplus">+    if (this._initialSyncCompleted) {</span>
<a href="#l19.1147"></a><span id="l19.1147" class="difflineplus">+        this._flushNewDeviceRequests();</span>
<a href="#l19.1148"></a><span id="l19.1148" class="difflineplus">+    }</span>
<a href="#l19.1149"></a><span id="l19.1149" class="difflineplus">+};</span>
<a href="#l19.1150"></a><span id="l19.1150" class="difflineplus">+</span>
<a href="#l19.1151"></a><span id="l19.1151" class="difflineplus">+/**</span>
<a href="#l19.1152"></a><span id="l19.1152" class="difflineplus">+ * Start device queries for any users who sent us an m.new_device recently</span>
<a href="#l19.1153"></a><span id="l19.1153" class="difflineplus">+ */</span>
<a href="#l19.1154"></a><span id="l19.1154" class="difflineplus">+Crypto.prototype._flushNewDeviceRequests = function() {</span>
<a href="#l19.1155"></a><span id="l19.1155" class="difflineplus">+    var self = this;</span>
<a href="#l19.1156"></a><span id="l19.1156" class="difflineplus">+</span>
<a href="#l19.1157"></a><span id="l19.1157" class="difflineplus">+    var pending = this._pendingNewDevices;</span>
<a href="#l19.1158"></a><span id="l19.1158" class="difflineplus">+    var users = utils.keys(pending).filter(function(u) {</span>
<a href="#l19.1159"></a><span id="l19.1159" class="difflineplus">+        return utils.keys(pending[u]).length &gt; 0;</span>
<a href="#l19.1160"></a><span id="l19.1160" class="difflineplus">+    });</span>
<a href="#l19.1161"></a><span id="l19.1161" class="difflineplus">+</span>
<a href="#l19.1162"></a><span id="l19.1162" class="difflineplus">+    if (users.length === 0) {</span>
<a href="#l19.1163"></a><span id="l19.1163" class="difflineplus">+        return;</span>
<a href="#l19.1164"></a><span id="l19.1164" class="difflineplus">+    }</span>
<a href="#l19.1165"></a><span id="l19.1165" class="difflineplus">+</span>
<a href="#l19.1166"></a><span id="l19.1166" class="difflineplus">+    var r = this._doKeyDownloadForUsers(users);</span>
<a href="#l19.1167"></a><span id="l19.1167" class="difflineplus">+</span>
<a href="#l19.1168"></a><span id="l19.1168" class="difflineplus">+    // we've kicked off requests to these users: remove their</span>
<a href="#l19.1169"></a><span id="l19.1169" class="difflineplus">+    // pending flag for now.</span>
<a href="#l19.1170"></a><span id="l19.1170" class="difflineplus">+    this._pendingNewDevices = {};</span>
<a href="#l19.1171"></a><span id="l19.1171" class="difflineplus">+</span>
<a href="#l19.1172"></a><span id="l19.1172" class="difflineplus">+    users.map(function(u) {</span>
<a href="#l19.1173"></a><span id="l19.1173" class="difflineplus">+        r[u] = r[u].catch(function(e) {</span>
<a href="#l19.1174"></a><span id="l19.1174" class="difflineplus">+            console.error(</span>
<a href="#l19.1175"></a><span id="l19.1175" class="difflineplus">+                'Error updating device keys for user ' + u + ':', e</span>
<a href="#l19.1176"></a><span id="l19.1176" class="difflineplus">+            );</span>
<a href="#l19.1177"></a><span id="l19.1177" class="difflineplus">+</span>
<a href="#l19.1178"></a><span id="l19.1178" class="difflineplus">+            // reinstate the pending flags on any users which failed; this will</span>
<a href="#l19.1179"></a><span id="l19.1179" class="difflineplus">+            // mean that we will do another download in the future, but won't</span>
<a href="#l19.1180"></a><span id="l19.1180" class="difflineplus">+            // tight-loop.</span>
<a href="#l19.1181"></a><span id="l19.1181" class="difflineplus">+            //</span>
<a href="#l19.1182"></a><span id="l19.1182" class="difflineplus">+            self._pendingNewDevices[u] = self._pendingNewDevices[u] || {};</span>
<a href="#l19.1183"></a><span id="l19.1183" class="difflineplus">+            utils.update(self._pendingNewDevices[u], pending[u]);</span>
<a href="#l19.1184"></a><span id="l19.1184" class="difflineplus">+        });</span>
<a href="#l19.1185"></a><span id="l19.1185" class="difflineplus">+    });</span>
<a href="#l19.1186"></a><span id="l19.1186" class="difflineplus">+</span>
<a href="#l19.1187"></a><span id="l19.1187" class="difflineplus">+    q.all(utils.values(r)).done();</span>
<a href="#l19.1188"></a><span id="l19.1188" class="difflineplus">+};</span>
<a href="#l19.1189"></a><span id="l19.1189" class="difflineplus">+</span>
<a href="#l19.1190"></a><span id="l19.1190" class="difflineplus">+/**</span>
<a href="#l19.1191"></a><span id="l19.1191" class="difflineplus">+ * Get a decryptor for a given room and algorithm.</span>
<a href="#l19.1192"></a><span id="l19.1192" class="difflineplus">+ *</span>
<a href="#l19.1193"></a><span id="l19.1193" class="difflineplus">+ * If we already have a decryptor for the given room and algorithm, return</span>
<a href="#l19.1194"></a><span id="l19.1194" class="difflineplus">+ * it. Otherwise try to instantiate it.</span>
<a href="#l19.1195"></a><span id="l19.1195" class="difflineplus">+ *</span>
<a href="#l19.1196"></a><span id="l19.1196" class="difflineplus">+ * @private</span>
<a href="#l19.1197"></a><span id="l19.1197" class="difflineplus">+ *</span>
<a href="#l19.1198"></a><span id="l19.1198" class="difflineplus">+ * @param {string?} roomId   room id for decryptor. If undefined, a temporary</span>
<a href="#l19.1199"></a><span id="l19.1199" class="difflineplus">+ * decryptor is instantiated.</span>
<a href="#l19.1200"></a><span id="l19.1200" class="difflineplus">+ *</span>
<a href="#l19.1201"></a><span id="l19.1201" class="difflineplus">+ * @param {string} algorithm  crypto algorithm</span>
<a href="#l19.1202"></a><span id="l19.1202" class="difflineplus">+ *</span>
<a href="#l19.1203"></a><span id="l19.1203" class="difflineplus">+ * @return {module:crypto.algorithms.base.DecryptionAlgorithm}</span>
<a href="#l19.1204"></a><span id="l19.1204" class="difflineplus">+ *</span>
<a href="#l19.1205"></a><span id="l19.1205" class="difflineplus">+ * @raises {module:crypto.algorithms.DecryptionError} if the algorithm is</span>
<a href="#l19.1206"></a><span id="l19.1206" class="difflineplus">+ * unknown</span>
<a href="#l19.1207"></a><span id="l19.1207" class="difflineplus">+ */</span>
<a href="#l19.1208"></a><span id="l19.1208" class="difflineplus">+Crypto.prototype._getRoomDecryptor = function(roomId, algorithm) {</span>
<a href="#l19.1209"></a><span id="l19.1209" class="difflineplus">+    var decryptors;</span>
<a href="#l19.1210"></a><span id="l19.1210" class="difflineplus">+    var alg;</span>
<a href="#l19.1211"></a><span id="l19.1211" class="difflineplus">+</span>
<a href="#l19.1212"></a><span id="l19.1212" class="difflineplus">+    roomId = roomId || null;</span>
<a href="#l19.1213"></a><span id="l19.1213" class="difflineplus">+    if (roomId) {</span>
<a href="#l19.1214"></a><span id="l19.1214" class="difflineplus">+        decryptors = this._roomDecryptors[roomId];</span>
<a href="#l19.1215"></a><span id="l19.1215" class="difflineplus">+        if (!decryptors) {</span>
<a href="#l19.1216"></a><span id="l19.1216" class="difflineplus">+            this._roomDecryptors[roomId] = decryptors = {};</span>
<a href="#l19.1217"></a><span id="l19.1217" class="difflineplus">+        }</span>
<a href="#l19.1218"></a><span id="l19.1218" class="difflineplus">+</span>
<a href="#l19.1219"></a><span id="l19.1219" class="difflineplus">+        alg = decryptors[algorithm];</span>
<a href="#l19.1220"></a><span id="l19.1220" class="difflineplus">+        if (alg) {</span>
<a href="#l19.1221"></a><span id="l19.1221" class="difflineplus">+            return alg;</span>
<a href="#l19.1222"></a><span id="l19.1222" class="difflineplus">+        }</span>
<a href="#l19.1223"></a><span id="l19.1223" class="difflineplus">+    }</span>
<a href="#l19.1224"></a><span id="l19.1224" class="difflineplus">+</span>
<a href="#l19.1225"></a><span id="l19.1225" class="difflineplus">+    var AlgClass = algorithms.DECRYPTION_CLASSES[algorithm];</span>
<a href="#l19.1226"></a><span id="l19.1226" class="difflineplus">+    if (!AlgClass) {</span>
<a href="#l19.1227"></a><span id="l19.1227" class="difflineplus">+        throw new algorithms.DecryptionError(&quot;Unable to decrypt &quot; + algorithm);</span>
<a href="#l19.1228"></a><span id="l19.1228" class="difflineplus">+    }</span>
<a href="#l19.1229"></a><span id="l19.1229" class="difflineplus">+    alg = new AlgClass({</span>
<a href="#l19.1230"></a><span id="l19.1230" class="difflineplus">+        userId: this._userId,</span>
<a href="#l19.1231"></a><span id="l19.1231" class="difflineplus">+        crypto: this,</span>
<a href="#l19.1232"></a><span id="l19.1232" class="difflineplus">+        olmDevice: this._olmDevice,</span>
<a href="#l19.1233"></a><span id="l19.1233" class="difflineplus">+        roomId: roomId,</span>
<a href="#l19.1234"></a><span id="l19.1234" class="difflineplus">+    });</span>
<a href="#l19.1235"></a><span id="l19.1235" class="difflineplus">+</span>
<a href="#l19.1236"></a><span id="l19.1236" class="difflineplus">+    if (decryptors) {</span>
<a href="#l19.1237"></a><span id="l19.1237" class="difflineplus">+        decryptors[algorithm] = alg;</span>
<a href="#l19.1238"></a><span id="l19.1238" class="difflineplus">+    }</span>
<a href="#l19.1239"></a><span id="l19.1239" class="difflineplus">+    return alg;</span>
<a href="#l19.1240"></a><span id="l19.1240" class="difflineplus">+};</span>
<a href="#l19.1241"></a><span id="l19.1241" class="difflineplus">+</span>
<a href="#l19.1242"></a><span id="l19.1242" class="difflineplus">+</span>
<a href="#l19.1243"></a><span id="l19.1243" class="difflineplus">+/**</span>
<a href="#l19.1244"></a><span id="l19.1244" class="difflineplus">+ * sign the given object with our ed25519 key</span>
<a href="#l19.1245"></a><span id="l19.1245" class="difflineplus">+ *</span>
<a href="#l19.1246"></a><span id="l19.1246" class="difflineplus">+ * @param {Object} obj  Object to which we will add a 'signatures' property</span>
<a href="#l19.1247"></a><span id="l19.1247" class="difflineplus">+ */</span>
<a href="#l19.1248"></a><span id="l19.1248" class="difflineplus">+Crypto.prototype._signObject = function(obj) {</span>
<a href="#l19.1249"></a><span id="l19.1249" class="difflineplus">+    var sigs = {};</span>
<a href="#l19.1250"></a><span id="l19.1250" class="difflineplus">+    sigs[this._userId] = {};</span>
<a href="#l19.1251"></a><span id="l19.1251" class="difflineplus">+    sigs[this._userId][&quot;ed25519:&quot; + this._deviceId] =</span>
<a href="#l19.1252"></a><span id="l19.1252" class="difflineplus">+        this._olmDevice.sign(anotherjson.stringify(obj));</span>
<a href="#l19.1253"></a><span id="l19.1253" class="difflineplus">+    obj.signatures = sigs;</span>
<a href="#l19.1254"></a><span id="l19.1254" class="difflineplus">+};</span>
<a href="#l19.1255"></a><span id="l19.1255" class="difflineplus">+</span>
<a href="#l19.1256"></a><span id="l19.1256" class="difflineplus">+/**</span>
<a href="#l19.1257"></a><span id="l19.1257" class="difflineplus">+ * @see module:crypto/algorithms/base.DecryptionError</span>
<a href="#l19.1258"></a><span id="l19.1258" class="difflineplus">+ */</span>
<a href="#l19.1259"></a><span id="l19.1259" class="difflineplus">+Crypto.DecryptionError = algorithms.DecryptionError;</span>
<a href="#l19.1260"></a><span id="l19.1260" class="difflineplus">+</span>
<a href="#l19.1261"></a><span id="l19.1261" class="difflineplus">+</span>
<a href="#l19.1262"></a><span id="l19.1262" class="difflineplus">+/** */</span>
<a href="#l19.1263"></a><span id="l19.1263" class="difflineplus">+module.exports = Crypto;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1">new file mode 100644</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineminus">--- /dev/null</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineplus">+++ b/chat/protocols/matrix/matrix-sdk/crypto/olmlib.js</span>
<a href="#l20.4"></a><span id="l20.4" class="difflineat">@@ -0,0 +1,268 @@</span>
<a href="#l20.5"></a><span id="l20.5" class="difflineplus">+/*</span>
<a href="#l20.6"></a><span id="l20.6" class="difflineplus">+Copyright 2016 OpenMarket Ltd</span>
<a href="#l20.7"></a><span id="l20.7" class="difflineplus">+</span>
<a href="#l20.8"></a><span id="l20.8" class="difflineplus">+Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<a href="#l20.9"></a><span id="l20.9" class="difflineplus">+you may not use this file except in compliance with the License.</span>
<a href="#l20.10"></a><span id="l20.10" class="difflineplus">+You may obtain a copy of the License at</span>
<a href="#l20.11"></a><span id="l20.11" class="difflineplus">+</span>
<a href="#l20.12"></a><span id="l20.12" class="difflineplus">+    http://www.apache.org/licenses/LICENSE-2.0</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineplus">+</span>
<a href="#l20.14"></a><span id="l20.14" class="difflineplus">+Unless required by applicable law or agreed to in writing, software</span>
<a href="#l20.15"></a><span id="l20.15" class="difflineplus">+distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<a href="#l20.16"></a><span id="l20.16" class="difflineplus">+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<a href="#l20.17"></a><span id="l20.17" class="difflineplus">+See the License for the specific language governing permissions and</span>
<a href="#l20.18"></a><span id="l20.18" class="difflineplus">+limitations under the License.</span>
<a href="#l20.19"></a><span id="l20.19" class="difflineplus">+*/</span>
<a href="#l20.20"></a><span id="l20.20" class="difflineplus">+</span>
<a href="#l20.21"></a><span id="l20.21" class="difflineplus">+/**</span>
<a href="#l20.22"></a><span id="l20.22" class="difflineplus">+ * @module olmlib</span>
<a href="#l20.23"></a><span id="l20.23" class="difflineplus">+ *</span>
<a href="#l20.24"></a><span id="l20.24" class="difflineplus">+ * Utilities common to olm encryption algorithms</span>
<a href="#l20.25"></a><span id="l20.25" class="difflineplus">+ */</span>
<a href="#l20.26"></a><span id="l20.26" class="difflineplus">+</span>
<a href="#l20.27"></a><span id="l20.27" class="difflineplus">+var q = require('q');</span>
<a href="#l20.28"></a><span id="l20.28" class="difflineplus">+var anotherjson = require('another-json');</span>
<a href="#l20.29"></a><span id="l20.29" class="difflineplus">+</span>
<a href="#l20.30"></a><span id="l20.30" class="difflineplus">+var utils = require(&quot;../utils&quot;);</span>
<a href="#l20.31"></a><span id="l20.31" class="difflineplus">+</span>
<a href="#l20.32"></a><span id="l20.32" class="difflineplus">+/**</span>
<a href="#l20.33"></a><span id="l20.33" class="difflineplus">+ * matrix algorithm tag for olm</span>
<a href="#l20.34"></a><span id="l20.34" class="difflineplus">+ */</span>
<a href="#l20.35"></a><span id="l20.35" class="difflineplus">+module.exports.OLM_ALGORITHM = &quot;m.olm.v1.curve25519-aes-sha2&quot;;</span>
<a href="#l20.36"></a><span id="l20.36" class="difflineplus">+</span>
<a href="#l20.37"></a><span id="l20.37" class="difflineplus">+/**</span>
<a href="#l20.38"></a><span id="l20.38" class="difflineplus">+ * matrix algorithm tag for megolm</span>
<a href="#l20.39"></a><span id="l20.39" class="difflineplus">+ */</span>
<a href="#l20.40"></a><span id="l20.40" class="difflineplus">+module.exports.MEGOLM_ALGORITHM = &quot;m.megolm.v1.aes-sha2&quot;;</span>
<a href="#l20.41"></a><span id="l20.41" class="difflineplus">+</span>
<a href="#l20.42"></a><span id="l20.42" class="difflineplus">+</span>
<a href="#l20.43"></a><span id="l20.43" class="difflineplus">+/**</span>
<a href="#l20.44"></a><span id="l20.44" class="difflineplus">+ * Encrypt an event payload for an Olm device</span>
<a href="#l20.45"></a><span id="l20.45" class="difflineplus">+ *</span>
<a href="#l20.46"></a><span id="l20.46" class="difflineplus">+ * @param {Object&lt;string, string&gt;} resultsObject  The `ciphertext` property</span>
<a href="#l20.47"></a><span id="l20.47" class="difflineplus">+ *   of the m.room.encrypted event to which to add our result</span>
<a href="#l20.48"></a><span id="l20.48" class="difflineplus">+ *</span>
<a href="#l20.49"></a><span id="l20.49" class="difflineplus">+ * @param {string} ourUserId</span>
<a href="#l20.50"></a><span id="l20.50" class="difflineplus">+ * @param {string} ourDeviceId</span>
<a href="#l20.51"></a><span id="l20.51" class="difflineplus">+ * @param {module:crypto/OlmDevice} olmDevice olm.js wrapper</span>
<a href="#l20.52"></a><span id="l20.52" class="difflineplus">+ * @param {string} recipientUserId</span>
<a href="#l20.53"></a><span id="l20.53" class="difflineplus">+ * @param {module:crypto/deviceinfo} recipientDevice</span>
<a href="#l20.54"></a><span id="l20.54" class="difflineplus">+ * @param {object} payloadFields fields to include in the encrypted payload</span>
<a href="#l20.55"></a><span id="l20.55" class="difflineplus">+ */</span>
<a href="#l20.56"></a><span id="l20.56" class="difflineplus">+module.exports.encryptMessageForDevice = function(</span>
<a href="#l20.57"></a><span id="l20.57" class="difflineplus">+    resultsObject,</span>
<a href="#l20.58"></a><span id="l20.58" class="difflineplus">+    ourUserId, ourDeviceId, olmDevice, recipientUserId, recipientDevice,</span>
<a href="#l20.59"></a><span id="l20.59" class="difflineplus">+    payloadFields</span>
<a href="#l20.60"></a><span id="l20.60" class="difflineplus">+) {</span>
<a href="#l20.61"></a><span id="l20.61" class="difflineplus">+    var deviceKey = recipientDevice.getIdentityKey();</span>
<a href="#l20.62"></a><span id="l20.62" class="difflineplus">+    var sessionId = olmDevice.getSessionIdForDevice(deviceKey);</span>
<a href="#l20.63"></a><span id="l20.63" class="difflineplus">+    if (sessionId === null) {</span>
<a href="#l20.64"></a><span id="l20.64" class="difflineplus">+        // If we don't have a session for a device then</span>
<a href="#l20.65"></a><span id="l20.65" class="difflineplus">+        // we can't encrypt a message for it.</span>
<a href="#l20.66"></a><span id="l20.66" class="difflineplus">+        return;</span>
<a href="#l20.67"></a><span id="l20.67" class="difflineplus">+    }</span>
<a href="#l20.68"></a><span id="l20.68" class="difflineplus">+</span>
<a href="#l20.69"></a><span id="l20.69" class="difflineplus">+    console.log(</span>
<a href="#l20.70"></a><span id="l20.70" class="difflineplus">+        &quot;Using sessionid &quot; + sessionId + &quot; for device &quot; +</span>
<a href="#l20.71"></a><span id="l20.71" class="difflineplus">+            recipientUserId + &quot;:&quot; + recipientDevice.deviceId</span>
<a href="#l20.72"></a><span id="l20.72" class="difflineplus">+    );</span>
<a href="#l20.73"></a><span id="l20.73" class="difflineplus">+</span>
<a href="#l20.74"></a><span id="l20.74" class="difflineplus">+    var payload = {</span>
<a href="#l20.75"></a><span id="l20.75" class="difflineplus">+        sender: ourUserId,</span>
<a href="#l20.76"></a><span id="l20.76" class="difflineplus">+        sender_device: ourDeviceId,</span>
<a href="#l20.77"></a><span id="l20.77" class="difflineplus">+</span>
<a href="#l20.78"></a><span id="l20.78" class="difflineplus">+        // Include the Ed25519 key so that the recipient knows what</span>
<a href="#l20.79"></a><span id="l20.79" class="difflineplus">+        // device this message came from.</span>
<a href="#l20.80"></a><span id="l20.80" class="difflineplus">+        // We don't need to include the curve25519 key since the</span>
<a href="#l20.81"></a><span id="l20.81" class="difflineplus">+        // recipient will already know this from the olm headers.</span>
<a href="#l20.82"></a><span id="l20.82" class="difflineplus">+        // When combined with the device keys retrieved from the</span>
<a href="#l20.83"></a><span id="l20.83" class="difflineplus">+        // homeserver signed by the ed25519 key this proves that</span>
<a href="#l20.84"></a><span id="l20.84" class="difflineplus">+        // the curve25519 key and the ed25519 key are owned by</span>
<a href="#l20.85"></a><span id="l20.85" class="difflineplus">+        // the same device.</span>
<a href="#l20.86"></a><span id="l20.86" class="difflineplus">+        keys: {</span>
<a href="#l20.87"></a><span id="l20.87" class="difflineplus">+            &quot;ed25519&quot;: olmDevice.deviceEd25519Key,</span>
<a href="#l20.88"></a><span id="l20.88" class="difflineplus">+        },</span>
<a href="#l20.89"></a><span id="l20.89" class="difflineplus">+</span>
<a href="#l20.90"></a><span id="l20.90" class="difflineplus">+        // include the recipient device details in the payload,</span>
<a href="#l20.91"></a><span id="l20.91" class="difflineplus">+        // to avoid unknown key attacks, per</span>
<a href="#l20.92"></a><span id="l20.92" class="difflineplus">+        // https://github.com/vector-im/vector-web/issues/2483</span>
<a href="#l20.93"></a><span id="l20.93" class="difflineplus">+        recipient: recipientUserId,</span>
<a href="#l20.94"></a><span id="l20.94" class="difflineplus">+        recipient_keys: {</span>
<a href="#l20.95"></a><span id="l20.95" class="difflineplus">+            &quot;ed25519&quot;: recipientDevice.getFingerprint(),</span>
<a href="#l20.96"></a><span id="l20.96" class="difflineplus">+        },</span>
<a href="#l20.97"></a><span id="l20.97" class="difflineplus">+    };</span>
<a href="#l20.98"></a><span id="l20.98" class="difflineplus">+</span>
<a href="#l20.99"></a><span id="l20.99" class="difflineplus">+    // TODO: technically, a bunch of that stuff only needs to be included for</span>
<a href="#l20.100"></a><span id="l20.100" class="difflineplus">+    // pre-key messages: after that, both sides know exactly which devices are</span>
<a href="#l20.101"></a><span id="l20.101" class="difflineplus">+    // involved in the session. If we're looking to reduce data transfer in the</span>
<a href="#l20.102"></a><span id="l20.102" class="difflineplus">+    // future, we could elide them for subsequent messages.</span>
<a href="#l20.103"></a><span id="l20.103" class="difflineplus">+</span>
<a href="#l20.104"></a><span id="l20.104" class="difflineplus">+    utils.extend(payload, payloadFields);</span>
<a href="#l20.105"></a><span id="l20.105" class="difflineplus">+</span>
<a href="#l20.106"></a><span id="l20.106" class="difflineplus">+    resultsObject[deviceKey] = olmDevice.encryptMessage(</span>
<a href="#l20.107"></a><span id="l20.107" class="difflineplus">+        deviceKey, sessionId, JSON.stringify(payload)</span>
<a href="#l20.108"></a><span id="l20.108" class="difflineplus">+    );</span>
<a href="#l20.109"></a><span id="l20.109" class="difflineplus">+};</span>
<a href="#l20.110"></a><span id="l20.110" class="difflineplus">+</span>
<a href="#l20.111"></a><span id="l20.111" class="difflineplus">+/**</span>
<a href="#l20.112"></a><span id="l20.112" class="difflineplus">+ * Try to make sure we have established olm sessions for the given devices.</span>
<a href="#l20.113"></a><span id="l20.113" class="difflineplus">+ *</span>
<a href="#l20.114"></a><span id="l20.114" class="difflineplus">+ * @param {module:crypto/OlmDevice} olmDevice</span>
<a href="#l20.115"></a><span id="l20.115" class="difflineplus">+ *</span>
<a href="#l20.116"></a><span id="l20.116" class="difflineplus">+ * @param {module:base-apis~MatrixBaseApis} baseApis</span>
<a href="#l20.117"></a><span id="l20.117" class="difflineplus">+ *</span>
<a href="#l20.118"></a><span id="l20.118" class="difflineplus">+ * @param {object&lt;string, module:crypto/deviceinfo[]&gt;} devicesByUser</span>
<a href="#l20.119"></a><span id="l20.119" class="difflineplus">+ *    map from userid to list of devices</span>
<a href="#l20.120"></a><span id="l20.120" class="difflineplus">+ *</span>
<a href="#l20.121"></a><span id="l20.121" class="difflineplus">+ * @return {module:client.Promise} resolves once the sessions are complete, to</span>
<a href="#l20.122"></a><span id="l20.122" class="difflineplus">+ *    an Object mapping from userId to deviceId to</span>
<a href="#l20.123"></a><span id="l20.123" class="difflineplus">+ *    {@link module:crypto~OlmSessionResult}</span>
<a href="#l20.124"></a><span id="l20.124" class="difflineplus">+ */</span>
<a href="#l20.125"></a><span id="l20.125" class="difflineplus">+module.exports.ensureOlmSessionsForDevices = function(</span>
<a href="#l20.126"></a><span id="l20.126" class="difflineplus">+    olmDevice, baseApis, devicesByUser</span>
<a href="#l20.127"></a><span id="l20.127" class="difflineplus">+) {</span>
<a href="#l20.128"></a><span id="l20.128" class="difflineplus">+    var devicesWithoutSession = [</span>
<a href="#l20.129"></a><span id="l20.129" class="difflineplus">+        // [userId, deviceId], ...</span>
<a href="#l20.130"></a><span id="l20.130" class="difflineplus">+    ];</span>
<a href="#l20.131"></a><span id="l20.131" class="difflineplus">+    var result = {};</span>
<a href="#l20.132"></a><span id="l20.132" class="difflineplus">+</span>
<a href="#l20.133"></a><span id="l20.133" class="difflineplus">+    for (var userId in devicesByUser) {</span>
<a href="#l20.134"></a><span id="l20.134" class="difflineplus">+        if (!devicesByUser.hasOwnProperty(userId)) { continue; }</span>
<a href="#l20.135"></a><span id="l20.135" class="difflineplus">+        result[userId] = {};</span>
<a href="#l20.136"></a><span id="l20.136" class="difflineplus">+        var devices = devicesByUser[userId];</span>
<a href="#l20.137"></a><span id="l20.137" class="difflineplus">+        for (var j = 0; j &lt; devices.length; j++) {</span>
<a href="#l20.138"></a><span id="l20.138" class="difflineplus">+            var deviceInfo = devices[j];</span>
<a href="#l20.139"></a><span id="l20.139" class="difflineplus">+            var deviceId = deviceInfo.deviceId;</span>
<a href="#l20.140"></a><span id="l20.140" class="difflineplus">+            var key = deviceInfo.getIdentityKey();</span>
<a href="#l20.141"></a><span id="l20.141" class="difflineplus">+            var sessionId = olmDevice.getSessionIdForDevice(key);</span>
<a href="#l20.142"></a><span id="l20.142" class="difflineplus">+            if (sessionId === null) {</span>
<a href="#l20.143"></a><span id="l20.143" class="difflineplus">+                devicesWithoutSession.push([userId, deviceId]);</span>
<a href="#l20.144"></a><span id="l20.144" class="difflineplus">+            }</span>
<a href="#l20.145"></a><span id="l20.145" class="difflineplus">+            result[userId][deviceId] = {</span>
<a href="#l20.146"></a><span id="l20.146" class="difflineplus">+                device: deviceInfo,</span>
<a href="#l20.147"></a><span id="l20.147" class="difflineplus">+                sessionId: sessionId,</span>
<a href="#l20.148"></a><span id="l20.148" class="difflineplus">+            };</span>
<a href="#l20.149"></a><span id="l20.149" class="difflineplus">+        }</span>
<a href="#l20.150"></a><span id="l20.150" class="difflineplus">+    }</span>
<a href="#l20.151"></a><span id="l20.151" class="difflineplus">+</span>
<a href="#l20.152"></a><span id="l20.152" class="difflineplus">+    if (devicesWithoutSession.length === 0) {</span>
<a href="#l20.153"></a><span id="l20.153" class="difflineplus">+        return q(result);</span>
<a href="#l20.154"></a><span id="l20.154" class="difflineplus">+    }</span>
<a href="#l20.155"></a><span id="l20.155" class="difflineplus">+</span>
<a href="#l20.156"></a><span id="l20.156" class="difflineplus">+    // TODO: this has a race condition - if we try to send another message</span>
<a href="#l20.157"></a><span id="l20.157" class="difflineplus">+    // while we are claiming a key, we will end up claiming two and setting up</span>
<a href="#l20.158"></a><span id="l20.158" class="difflineplus">+    // two sessions.</span>
<a href="#l20.159"></a><span id="l20.159" class="difflineplus">+    //</span>
<a href="#l20.160"></a><span id="l20.160" class="difflineplus">+    // That should eventually resolve itself, but it's poor form.</span>
<a href="#l20.161"></a><span id="l20.161" class="difflineplus">+</span>
<a href="#l20.162"></a><span id="l20.162" class="difflineplus">+    var oneTimeKeyAlgorithm = &quot;signed_curve25519&quot;;</span>
<a href="#l20.163"></a><span id="l20.163" class="difflineplus">+    return baseApis.claimOneTimeKeys(</span>
<a href="#l20.164"></a><span id="l20.164" class="difflineplus">+        devicesWithoutSession, oneTimeKeyAlgorithm</span>
<a href="#l20.165"></a><span id="l20.165" class="difflineplus">+    ).then(function(res) {</span>
<a href="#l20.166"></a><span id="l20.166" class="difflineplus">+        for (var userId in devicesByUser) {</span>
<a href="#l20.167"></a><span id="l20.167" class="difflineplus">+            if (!devicesByUser.hasOwnProperty(userId)) { continue; }</span>
<a href="#l20.168"></a><span id="l20.168" class="difflineplus">+            var userRes = res.one_time_keys[userId] || {};</span>
<a href="#l20.169"></a><span id="l20.169" class="difflineplus">+            var devices = devicesByUser[userId];</span>
<a href="#l20.170"></a><span id="l20.170" class="difflineplus">+            for (var j = 0; j &lt; devices.length; j++) {</span>
<a href="#l20.171"></a><span id="l20.171" class="difflineplus">+                var deviceInfo = devices[j];</span>
<a href="#l20.172"></a><span id="l20.172" class="difflineplus">+                var deviceId = deviceInfo.deviceId;</span>
<a href="#l20.173"></a><span id="l20.173" class="difflineplus">+                if (result[userId][deviceId].sessionId) {</span>
<a href="#l20.174"></a><span id="l20.174" class="difflineplus">+                    // we already have a result for this device</span>
<a href="#l20.175"></a><span id="l20.175" class="difflineplus">+                    continue;</span>
<a href="#l20.176"></a><span id="l20.176" class="difflineplus">+                }</span>
<a href="#l20.177"></a><span id="l20.177" class="difflineplus">+</span>
<a href="#l20.178"></a><span id="l20.178" class="difflineplus">+                var deviceRes = userRes[deviceId] || {};</span>
<a href="#l20.179"></a><span id="l20.179" class="difflineplus">+                var oneTimeKey = null;</span>
<a href="#l20.180"></a><span id="l20.180" class="difflineplus">+                for (var keyId in deviceRes) {</span>
<a href="#l20.181"></a><span id="l20.181" class="difflineplus">+                    if (keyId.indexOf(oneTimeKeyAlgorithm + &quot;:&quot;) === 0) {</span>
<a href="#l20.182"></a><span id="l20.182" class="difflineplus">+                        oneTimeKey = deviceRes[keyId];</span>
<a href="#l20.183"></a><span id="l20.183" class="difflineplus">+                    }</span>
<a href="#l20.184"></a><span id="l20.184" class="difflineplus">+                }</span>
<a href="#l20.185"></a><span id="l20.185" class="difflineplus">+</span>
<a href="#l20.186"></a><span id="l20.186" class="difflineplus">+                if (!oneTimeKey) {</span>
<a href="#l20.187"></a><span id="l20.187" class="difflineplus">+                    console.warn(</span>
<a href="#l20.188"></a><span id="l20.188" class="difflineplus">+                        &quot;No one-time keys (alg=&quot; + oneTimeKeyAlgorithm +</span>
<a href="#l20.189"></a><span id="l20.189" class="difflineplus">+                            &quot;) for device &quot; + userId + &quot;:&quot; + deviceId</span>
<a href="#l20.190"></a><span id="l20.190" class="difflineplus">+                    );</span>
<a href="#l20.191"></a><span id="l20.191" class="difflineplus">+                    continue;</span>
<a href="#l20.192"></a><span id="l20.192" class="difflineplus">+                }</span>
<a href="#l20.193"></a><span id="l20.193" class="difflineplus">+</span>
<a href="#l20.194"></a><span id="l20.194" class="difflineplus">+                var sid = _verifyKeyAndStartSession(</span>
<a href="#l20.195"></a><span id="l20.195" class="difflineplus">+                    olmDevice, oneTimeKey, userId, deviceInfo</span>
<a href="#l20.196"></a><span id="l20.196" class="difflineplus">+                );</span>
<a href="#l20.197"></a><span id="l20.197" class="difflineplus">+                result[userId][deviceId].sessionId = sid;</span>
<a href="#l20.198"></a><span id="l20.198" class="difflineplus">+            }</span>
<a href="#l20.199"></a><span id="l20.199" class="difflineplus">+        }</span>
<a href="#l20.200"></a><span id="l20.200" class="difflineplus">+        return result;</span>
<a href="#l20.201"></a><span id="l20.201" class="difflineplus">+    });</span>
<a href="#l20.202"></a><span id="l20.202" class="difflineplus">+};</span>
<a href="#l20.203"></a><span id="l20.203" class="difflineplus">+</span>
<a href="#l20.204"></a><span id="l20.204" class="difflineplus">+</span>
<a href="#l20.205"></a><span id="l20.205" class="difflineplus">+function _verifyKeyAndStartSession(olmDevice, oneTimeKey, userId, deviceInfo) {</span>
<a href="#l20.206"></a><span id="l20.206" class="difflineplus">+    var deviceId = deviceInfo.deviceId;</span>
<a href="#l20.207"></a><span id="l20.207" class="difflineplus">+    try {</span>
<a href="#l20.208"></a><span id="l20.208" class="difflineplus">+        _verifySignature(</span>
<a href="#l20.209"></a><span id="l20.209" class="difflineplus">+            olmDevice, oneTimeKey, userId, deviceId,</span>
<a href="#l20.210"></a><span id="l20.210" class="difflineplus">+            deviceInfo.getFingerprint()</span>
<a href="#l20.211"></a><span id="l20.211" class="difflineplus">+        );</span>
<a href="#l20.212"></a><span id="l20.212" class="difflineplus">+    } catch (e) {</span>
<a href="#l20.213"></a><span id="l20.213" class="difflineplus">+        console.error(</span>
<a href="#l20.214"></a><span id="l20.214" class="difflineplus">+            &quot;Unable to verify signature on one-time key for device &quot; +</span>
<a href="#l20.215"></a><span id="l20.215" class="difflineplus">+                userId + &quot;:&quot; + deviceId + &quot;:&quot;, e</span>
<a href="#l20.216"></a><span id="l20.216" class="difflineplus">+        );</span>
<a href="#l20.217"></a><span id="l20.217" class="difflineplus">+        return null;</span>
<a href="#l20.218"></a><span id="l20.218" class="difflineplus">+    }</span>
<a href="#l20.219"></a><span id="l20.219" class="difflineplus">+</span>
<a href="#l20.220"></a><span id="l20.220" class="difflineplus">+    var sid;</span>
<a href="#l20.221"></a><span id="l20.221" class="difflineplus">+    try {</span>
<a href="#l20.222"></a><span id="l20.222" class="difflineplus">+        sid = olmDevice.createOutboundSession(</span>
<a href="#l20.223"></a><span id="l20.223" class="difflineplus">+            deviceInfo.getIdentityKey(), oneTimeKey.key</span>
<a href="#l20.224"></a><span id="l20.224" class="difflineplus">+        );</span>
<a href="#l20.225"></a><span id="l20.225" class="difflineplus">+    } catch (e) {</span>
<a href="#l20.226"></a><span id="l20.226" class="difflineplus">+        // possibly a bad key</span>
<a href="#l20.227"></a><span id="l20.227" class="difflineplus">+        console.error(&quot;Error starting session with device &quot; +</span>
<a href="#l20.228"></a><span id="l20.228" class="difflineplus">+                      userId + &quot;:&quot; + deviceId + &quot;: &quot; + e);</span>
<a href="#l20.229"></a><span id="l20.229" class="difflineplus">+        return null;</span>
<a href="#l20.230"></a><span id="l20.230" class="difflineplus">+    }</span>
<a href="#l20.231"></a><span id="l20.231" class="difflineplus">+</span>
<a href="#l20.232"></a><span id="l20.232" class="difflineplus">+    console.log(&quot;Started new sessionid &quot; + sid +</span>
<a href="#l20.233"></a><span id="l20.233" class="difflineplus">+                &quot; for device &quot; + userId + &quot;:&quot; + deviceId);</span>
<a href="#l20.234"></a><span id="l20.234" class="difflineplus">+    return sid;</span>
<a href="#l20.235"></a><span id="l20.235" class="difflineplus">+}</span>
<a href="#l20.236"></a><span id="l20.236" class="difflineplus">+</span>
<a href="#l20.237"></a><span id="l20.237" class="difflineplus">+</span>
<a href="#l20.238"></a><span id="l20.238" class="difflineplus">+/**</span>
<a href="#l20.239"></a><span id="l20.239" class="difflineplus">+ * Verify the signature on an object</span>
<a href="#l20.240"></a><span id="l20.240" class="difflineplus">+ *</span>
<a href="#l20.241"></a><span id="l20.241" class="difflineplus">+ * @param {module:crypto/OlmDevice} olmDevice olm wrapper to use for verify op</span>
<a href="#l20.242"></a><span id="l20.242" class="difflineplus">+ *</span>
<a href="#l20.243"></a><span id="l20.243" class="difflineplus">+ * @param {Object} obj object to check signature on. Note that this will be</span>
<a href="#l20.244"></a><span id="l20.244" class="difflineplus">+ * stripped of its 'signatures' and 'unsigned' properties.</span>
<a href="#l20.245"></a><span id="l20.245" class="difflineplus">+ *</span>
<a href="#l20.246"></a><span id="l20.246" class="difflineplus">+ * @param {string} signingUserId  ID of the user whose signature should be checked</span>
<a href="#l20.247"></a><span id="l20.247" class="difflineplus">+ *</span>
<a href="#l20.248"></a><span id="l20.248" class="difflineplus">+ * @param {string} signingDeviceId  ID of the device whose signature should be checked</span>
<a href="#l20.249"></a><span id="l20.249" class="difflineplus">+ *</span>
<a href="#l20.250"></a><span id="l20.250" class="difflineplus">+ * @param {string} signingKey   base64-ed ed25519 public key</span>
<a href="#l20.251"></a><span id="l20.251" class="difflineplus">+ */</span>
<a href="#l20.252"></a><span id="l20.252" class="difflineplus">+var _verifySignature = module.exports.verifySignature = function(</span>
<a href="#l20.253"></a><span id="l20.253" class="difflineplus">+    olmDevice, obj, signingUserId, signingDeviceId, signingKey</span>
<a href="#l20.254"></a><span id="l20.254" class="difflineplus">+) {</span>
<a href="#l20.255"></a><span id="l20.255" class="difflineplus">+    var signKeyId = &quot;ed25519:&quot; + signingDeviceId;</span>
<a href="#l20.256"></a><span id="l20.256" class="difflineplus">+    var signatures = obj.signatures || {};</span>
<a href="#l20.257"></a><span id="l20.257" class="difflineplus">+    var userSigs = signatures[signingUserId] || {};</span>
<a href="#l20.258"></a><span id="l20.258" class="difflineplus">+    var signature = userSigs[signKeyId];</span>
<a href="#l20.259"></a><span id="l20.259" class="difflineplus">+    if (!signature) {</span>
<a href="#l20.260"></a><span id="l20.260" class="difflineplus">+        throw Error(&quot;No signature&quot;);</span>
<a href="#l20.261"></a><span id="l20.261" class="difflineplus">+    }</span>
<a href="#l20.262"></a><span id="l20.262" class="difflineplus">+</span>
<a href="#l20.263"></a><span id="l20.263" class="difflineplus">+    // prepare the canonical json: remove unsigned and signatures, and stringify with</span>
<a href="#l20.264"></a><span id="l20.264" class="difflineplus">+    // anotherjson</span>
<a href="#l20.265"></a><span id="l20.265" class="difflineplus">+    delete obj.unsigned;</span>
<a href="#l20.266"></a><span id="l20.266" class="difflineplus">+    delete obj.signatures;</span>
<a href="#l20.267"></a><span id="l20.267" class="difflineplus">+    var json = anotherjson.stringify(obj);</span>
<a href="#l20.268"></a><span id="l20.268" class="difflineplus">+</span>
<a href="#l20.269"></a><span id="l20.269" class="difflineplus">+    olmDevice.verifySignature(</span>
<a href="#l20.270"></a><span id="l20.270" class="difflineplus">+        signingKey, json, signature</span>
<a href="#l20.271"></a><span id="l20.271" class="difflineplus">+    );</span>
<a href="#l20.272"></a><span id="l20.272" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1">new file mode 100644</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineminus">--- /dev/null</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineplus">+++ b/chat/protocols/matrix/matrix-sdk/filter-component.js</span>
<a href="#l21.4"></a><span id="l21.4" class="difflineat">@@ -0,0 +1,141 @@</span>
<a href="#l21.5"></a><span id="l21.5" class="difflineplus">+/*</span>
<a href="#l21.6"></a><span id="l21.6" class="difflineplus">+Copyright 2016 OpenMarket Ltd</span>
<a href="#l21.7"></a><span id="l21.7" class="difflineplus">+</span>
<a href="#l21.8"></a><span id="l21.8" class="difflineplus">+Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<a href="#l21.9"></a><span id="l21.9" class="difflineplus">+you may not use this file except in compliance with the License.</span>
<a href="#l21.10"></a><span id="l21.10" class="difflineplus">+You may obtain a copy of the License at</span>
<a href="#l21.11"></a><span id="l21.11" class="difflineplus">+</span>
<a href="#l21.12"></a><span id="l21.12" class="difflineplus">+    http://www.apache.org/licenses/LICENSE-2.0</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineplus">+</span>
<a href="#l21.14"></a><span id="l21.14" class="difflineplus">+Unless required by applicable law or agreed to in writing, software</span>
<a href="#l21.15"></a><span id="l21.15" class="difflineplus">+distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<a href="#l21.16"></a><span id="l21.16" class="difflineplus">+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<a href="#l21.17"></a><span id="l21.17" class="difflineplus">+See the License for the specific language governing permissions and</span>
<a href="#l21.18"></a><span id="l21.18" class="difflineplus">+limitations under the License.</span>
<a href="#l21.19"></a><span id="l21.19" class="difflineplus">+*/</span>
<a href="#l21.20"></a><span id="l21.20" class="difflineplus">+&quot;use strict&quot;;</span>
<a href="#l21.21"></a><span id="l21.21" class="difflineplus">+/**</span>
<a href="#l21.22"></a><span id="l21.22" class="difflineplus">+ * @module filter-component</span>
<a href="#l21.23"></a><span id="l21.23" class="difflineplus">+ */</span>
<a href="#l21.24"></a><span id="l21.24" class="difflineplus">+</span>
<a href="#l21.25"></a><span id="l21.25" class="difflineplus">+/**</span>
<a href="#l21.26"></a><span id="l21.26" class="difflineplus">+ * Checks if a value matches a given field value, which may be a * terminated</span>
<a href="#l21.27"></a><span id="l21.27" class="difflineplus">+ * wildcard pattern.</span>
<a href="#l21.28"></a><span id="l21.28" class="difflineplus">+ * @param {String} actual_value  The value to be compared</span>
<a href="#l21.29"></a><span id="l21.29" class="difflineplus">+ * @param {String} filter_value  The filter pattern to be compared</span>
<a href="#l21.30"></a><span id="l21.30" class="difflineplus">+ * @return {bool} true if the actual_value matches the filter_value</span>
<a href="#l21.31"></a><span id="l21.31" class="difflineplus">+ */</span>
<a href="#l21.32"></a><span id="l21.32" class="difflineplus">+function _matches_wildcard(actual_value, filter_value) {</span>
<a href="#l21.33"></a><span id="l21.33" class="difflineplus">+    if (filter_value.endsWith(&quot;*&quot;)) {</span>
<a href="#l21.34"></a><span id="l21.34" class="difflineplus">+        var type_prefix = filter_value.slice(0, -1);</span>
<a href="#l21.35"></a><span id="l21.35" class="difflineplus">+        return actual_value.substr(0, type_prefix.length) === type_prefix;</span>
<a href="#l21.36"></a><span id="l21.36" class="difflineplus">+    }</span>
<a href="#l21.37"></a><span id="l21.37" class="difflineplus">+    else {</span>
<a href="#l21.38"></a><span id="l21.38" class="difflineplus">+        return actual_value === filter_value;</span>
<a href="#l21.39"></a><span id="l21.39" class="difflineplus">+    }</span>
<a href="#l21.40"></a><span id="l21.40" class="difflineplus">+}</span>
<a href="#l21.41"></a><span id="l21.41" class="difflineplus">+</span>
<a href="#l21.42"></a><span id="l21.42" class="difflineplus">+/**</span>
<a href="#l21.43"></a><span id="l21.43" class="difflineplus">+ * FilterComponent is a section of a Filter definition which defines the</span>
<a href="#l21.44"></a><span id="l21.44" class="difflineplus">+ * types, rooms, senders filters etc to be applied to a particular type of resource.</span>
<a href="#l21.45"></a><span id="l21.45" class="difflineplus">+ * This is all ported over from synapse's Filter object.</span>
<a href="#l21.46"></a><span id="l21.46" class="difflineplus">+ *</span>
<a href="#l21.47"></a><span id="l21.47" class="difflineplus">+ * N.B. that synapse refers to these as 'Filters', and what js-sdk refers to as</span>
<a href="#l21.48"></a><span id="l21.48" class="difflineplus">+ * 'Filters' are referred to as 'FilterCollections'.</span>
<a href="#l21.49"></a><span id="l21.49" class="difflineplus">+ *</span>
<a href="#l21.50"></a><span id="l21.50" class="difflineplus">+ * @constructor</span>
<a href="#l21.51"></a><span id="l21.51" class="difflineplus">+ * @param {Object} the definition of this filter JSON, e.g. { 'contains_url': true }</span>
<a href="#l21.52"></a><span id="l21.52" class="difflineplus">+ */</span>
<a href="#l21.53"></a><span id="l21.53" class="difflineplus">+function FilterComponent(filter_json) {</span>
<a href="#l21.54"></a><span id="l21.54" class="difflineplus">+    this.filter_json = filter_json;</span>
<a href="#l21.55"></a><span id="l21.55" class="difflineplus">+</span>
<a href="#l21.56"></a><span id="l21.56" class="difflineplus">+    this.types = filter_json.types || null;</span>
<a href="#l21.57"></a><span id="l21.57" class="difflineplus">+    this.not_types = filter_json.not_types || [];</span>
<a href="#l21.58"></a><span id="l21.58" class="difflineplus">+</span>
<a href="#l21.59"></a><span id="l21.59" class="difflineplus">+    this.rooms = filter_json.rooms || null;</span>
<a href="#l21.60"></a><span id="l21.60" class="difflineplus">+    this.not_rooms = filter_json.not_rooms || [];</span>
<a href="#l21.61"></a><span id="l21.61" class="difflineplus">+</span>
<a href="#l21.62"></a><span id="l21.62" class="difflineplus">+    this.senders = filter_json.senders || null;</span>
<a href="#l21.63"></a><span id="l21.63" class="difflineplus">+    this.not_senders = filter_json.not_senders || [];</span>
<a href="#l21.64"></a><span id="l21.64" class="difflineplus">+</span>
<a href="#l21.65"></a><span id="l21.65" class="difflineplus">+    this.contains_url = filter_json.contains_url || null;</span>
<a href="#l21.66"></a><span id="l21.66" class="difflineplus">+}</span>
<a href="#l21.67"></a><span id="l21.67" class="difflineplus">+</span>
<a href="#l21.68"></a><span id="l21.68" class="difflineplus">+/**</span>
<a href="#l21.69"></a><span id="l21.69" class="difflineplus">+ * Checks with the filter component matches the given event</span>
<a href="#l21.70"></a><span id="l21.70" class="difflineplus">+ * @param {MatrixEvent} event event to be checked against the filter</span>
<a href="#l21.71"></a><span id="l21.71" class="difflineplus">+ * @return {bool} true if the event matches the filter</span>
<a href="#l21.72"></a><span id="l21.72" class="difflineplus">+ */</span>
<a href="#l21.73"></a><span id="l21.73" class="difflineplus">+FilterComponent.prototype.check = function(event) {</span>
<a href="#l21.74"></a><span id="l21.74" class="difflineplus">+    return this._checkFields(</span>
<a href="#l21.75"></a><span id="l21.75" class="difflineplus">+        event.getRoomId(),</span>
<a href="#l21.76"></a><span id="l21.76" class="difflineplus">+        event.getSender(),</span>
<a href="#l21.77"></a><span id="l21.77" class="difflineplus">+        event.getType(),</span>
<a href="#l21.78"></a><span id="l21.78" class="difflineplus">+        event.getContent() ? event.getContent().url !== undefined : false</span>
<a href="#l21.79"></a><span id="l21.79" class="difflineplus">+    );</span>
<a href="#l21.80"></a><span id="l21.80" class="difflineplus">+};</span>
<a href="#l21.81"></a><span id="l21.81" class="difflineplus">+</span>
<a href="#l21.82"></a><span id="l21.82" class="difflineplus">+/**</span>
<a href="#l21.83"></a><span id="l21.83" class="difflineplus">+ * Checks whether the filter component matches the given event fields.</span>
<a href="#l21.84"></a><span id="l21.84" class="difflineplus">+ * @param {String} room_id       the room_id for the event being checked</span>
<a href="#l21.85"></a><span id="l21.85" class="difflineplus">+ * @param {String} sender        the sender of the event being checked</span>
<a href="#l21.86"></a><span id="l21.86" class="difflineplus">+ * @param {String} event_type    the type of the event being checked</span>
<a href="#l21.87"></a><span id="l21.87" class="difflineplus">+ * @param {String} contains_url  whether the event contains a content.url field</span>
<a href="#l21.88"></a><span id="l21.88" class="difflineplus">+ * @return {bool} true if the event fields match the filter</span>
<a href="#l21.89"></a><span id="l21.89" class="difflineplus">+ */</span>
<a href="#l21.90"></a><span id="l21.90" class="difflineplus">+FilterComponent.prototype._checkFields =</span>
<a href="#l21.91"></a><span id="l21.91" class="difflineplus">+    function(room_id, sender, event_type, contains_url)</span>
<a href="#l21.92"></a><span id="l21.92" class="difflineplus">+{</span>
<a href="#l21.93"></a><span id="l21.93" class="difflineplus">+    var literal_keys = {</span>
<a href="#l21.94"></a><span id="l21.94" class="difflineplus">+        &quot;rooms&quot;: function(v) { return room_id === v; },</span>
<a href="#l21.95"></a><span id="l21.95" class="difflineplus">+        &quot;senders&quot;: function(v) { return sender === v; },</span>
<a href="#l21.96"></a><span id="l21.96" class="difflineplus">+        &quot;types&quot;: function(v) { return _matches_wildcard(event_type, v); },</span>
<a href="#l21.97"></a><span id="l21.97" class="difflineplus">+    };</span>
<a href="#l21.98"></a><span id="l21.98" class="difflineplus">+</span>
<a href="#l21.99"></a><span id="l21.99" class="difflineplus">+    var self = this;</span>
<a href="#l21.100"></a><span id="l21.100" class="difflineplus">+    Object.keys(literal_keys).forEach(function(name) {</span>
<a href="#l21.101"></a><span id="l21.101" class="difflineplus">+        var match_func = literal_keys[name];</span>
<a href="#l21.102"></a><span id="l21.102" class="difflineplus">+        var not_name = &quot;not_&quot; + name;</span>
<a href="#l21.103"></a><span id="l21.103" class="difflineplus">+        var disallowed_values = self[not_name];</span>
<a href="#l21.104"></a><span id="l21.104" class="difflineplus">+        if (disallowed_values.map(match_func)) {</span>
<a href="#l21.105"></a><span id="l21.105" class="difflineplus">+            return false;</span>
<a href="#l21.106"></a><span id="l21.106" class="difflineplus">+        }</span>
<a href="#l21.107"></a><span id="l21.107" class="difflineplus">+</span>
<a href="#l21.108"></a><span id="l21.108" class="difflineplus">+        var allowed_values = self[name];</span>
<a href="#l21.109"></a><span id="l21.109" class="difflineplus">+        if (allowed_values) {</span>
<a href="#l21.110"></a><span id="l21.110" class="difflineplus">+            if (!allowed_values.map(match_func)) {</span>
<a href="#l21.111"></a><span id="l21.111" class="difflineplus">+                return false;</span>
<a href="#l21.112"></a><span id="l21.112" class="difflineplus">+            }</span>
<a href="#l21.113"></a><span id="l21.113" class="difflineplus">+        }</span>
<a href="#l21.114"></a><span id="l21.114" class="difflineplus">+    });</span>
<a href="#l21.115"></a><span id="l21.115" class="difflineplus">+</span>
<a href="#l21.116"></a><span id="l21.116" class="difflineplus">+    var contains_url_filter = this.filter_json.contains_url;</span>
<a href="#l21.117"></a><span id="l21.117" class="difflineplus">+    if (contains_url_filter !== undefined) {</span>
<a href="#l21.118"></a><span id="l21.118" class="difflineplus">+        if (contains_url_filter !== contains_url) {</span>
<a href="#l21.119"></a><span id="l21.119" class="difflineplus">+            return false;</span>
<a href="#l21.120"></a><span id="l21.120" class="difflineplus">+        }</span>
<a href="#l21.121"></a><span id="l21.121" class="difflineplus">+    }</span>
<a href="#l21.122"></a><span id="l21.122" class="difflineplus">+</span>
<a href="#l21.123"></a><span id="l21.123" class="difflineplus">+    return true;</span>
<a href="#l21.124"></a><span id="l21.124" class="difflineplus">+};</span>
<a href="#l21.125"></a><span id="l21.125" class="difflineplus">+</span>
<a href="#l21.126"></a><span id="l21.126" class="difflineplus">+/**</span>
<a href="#l21.127"></a><span id="l21.127" class="difflineplus">+ * Filters a list of events down to those which match this filter component</span>
<a href="#l21.128"></a><span id="l21.128" class="difflineplus">+ * @param {MatrixEvent[]} events  Events to be checked againt the filter component</span>
<a href="#l21.129"></a><span id="l21.129" class="difflineplus">+ * @return {MatrixEvent[]} events which matched the filter component</span>
<a href="#l21.130"></a><span id="l21.130" class="difflineplus">+ */</span>
<a href="#l21.131"></a><span id="l21.131" class="difflineplus">+FilterComponent.prototype.filter = function(events) {</span>
<a href="#l21.132"></a><span id="l21.132" class="difflineplus">+    return events.filter(this.check, this);</span>
<a href="#l21.133"></a><span id="l21.133" class="difflineplus">+};</span>
<a href="#l21.134"></a><span id="l21.134" class="difflineplus">+</span>
<a href="#l21.135"></a><span id="l21.135" class="difflineplus">+/**</span>
<a href="#l21.136"></a><span id="l21.136" class="difflineplus">+ * Returns the limit field for a given filter component, providing a default of</span>
<a href="#l21.137"></a><span id="l21.137" class="difflineplus">+ * 10 if none is otherwise specified.  Cargo-culted from Synapse.</span>
<a href="#l21.138"></a><span id="l21.138" class="difflineplus">+ * @return {Number} the limit for this filter component.</span>
<a href="#l21.139"></a><span id="l21.139" class="difflineplus">+ */</span>
<a href="#l21.140"></a><span id="l21.140" class="difflineplus">+FilterComponent.prototype.limit = function() {</span>
<a href="#l21.141"></a><span id="l21.141" class="difflineplus">+    return this.filter_json.limit !== undefined ? this.filter_json.limit : 10;</span>
<a href="#l21.142"></a><span id="l21.142" class="difflineplus">+};</span>
<a href="#l21.143"></a><span id="l21.143" class="difflineplus">+</span>
<a href="#l21.144"></a><span id="l21.144" class="difflineplus">+/** The FilterComponent class */</span>
<a href="#l21.145"></a><span id="l21.145" class="difflineplus">+module.exports = FilterComponent;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1">new file mode 100644</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineminus">--- /dev/null</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineplus">+++ b/chat/protocols/matrix/matrix-sdk/filter.js</span>
<a href="#l22.4"></a><span id="l22.4" class="difflineat">@@ -0,0 +1,192 @@</span>
<a href="#l22.5"></a><span id="l22.5" class="difflineplus">+/*</span>
<a href="#l22.6"></a><span id="l22.6" class="difflineplus">+Copyright 2015, 2016 OpenMarket Ltd</span>
<a href="#l22.7"></a><span id="l22.7" class="difflineplus">+</span>
<a href="#l22.8"></a><span id="l22.8" class="difflineplus">+Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<a href="#l22.9"></a><span id="l22.9" class="difflineplus">+you may not use this file except in compliance with the License.</span>
<a href="#l22.10"></a><span id="l22.10" class="difflineplus">+You may obtain a copy of the License at</span>
<a href="#l22.11"></a><span id="l22.11" class="difflineplus">+</span>
<a href="#l22.12"></a><span id="l22.12" class="difflineplus">+    http://www.apache.org/licenses/LICENSE-2.0</span>
<a href="#l22.13"></a><span id="l22.13" class="difflineplus">+</span>
<a href="#l22.14"></a><span id="l22.14" class="difflineplus">+Unless required by applicable law or agreed to in writing, software</span>
<a href="#l22.15"></a><span id="l22.15" class="difflineplus">+distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<a href="#l22.16"></a><span id="l22.16" class="difflineplus">+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<a href="#l22.17"></a><span id="l22.17" class="difflineplus">+See the License for the specific language governing permissions and</span>
<a href="#l22.18"></a><span id="l22.18" class="difflineplus">+limitations under the License.</span>
<a href="#l22.19"></a><span id="l22.19" class="difflineplus">+*/</span>
<a href="#l22.20"></a><span id="l22.20" class="difflineplus">+&quot;use strict&quot;;</span>
<a href="#l22.21"></a><span id="l22.21" class="difflineplus">+/**</span>
<a href="#l22.22"></a><span id="l22.22" class="difflineplus">+ * @module filter</span>
<a href="#l22.23"></a><span id="l22.23" class="difflineplus">+ */</span>
<a href="#l22.24"></a><span id="l22.24" class="difflineplus">+</span>
<a href="#l22.25"></a><span id="l22.25" class="difflineplus">+var FilterComponent = require(&quot;./filter-component&quot;);</span>
<a href="#l22.26"></a><span id="l22.26" class="difflineplus">+</span>
<a href="#l22.27"></a><span id="l22.27" class="difflineplus">+/**</span>
<a href="#l22.28"></a><span id="l22.28" class="difflineplus">+ * @param {Object} obj</span>
<a href="#l22.29"></a><span id="l22.29" class="difflineplus">+ * @param {string} keyNesting</span>
<a href="#l22.30"></a><span id="l22.30" class="difflineplus">+ * @param {*} val</span>
<a href="#l22.31"></a><span id="l22.31" class="difflineplus">+ */</span>
<a href="#l22.32"></a><span id="l22.32" class="difflineplus">+function setProp(obj, keyNesting, val) {</span>
<a href="#l22.33"></a><span id="l22.33" class="difflineplus">+    var nestedKeys = keyNesting.split(&quot;.&quot;);</span>
<a href="#l22.34"></a><span id="l22.34" class="difflineplus">+    var currentObj = obj;</span>
<a href="#l22.35"></a><span id="l22.35" class="difflineplus">+    for (var i = 0; i &lt; (nestedKeys.length - 1); i++) {</span>
<a href="#l22.36"></a><span id="l22.36" class="difflineplus">+        if (!currentObj[nestedKeys[i]]) {</span>
<a href="#l22.37"></a><span id="l22.37" class="difflineplus">+            currentObj[nestedKeys[i]] = {};</span>
<a href="#l22.38"></a><span id="l22.38" class="difflineplus">+        }</span>
<a href="#l22.39"></a><span id="l22.39" class="difflineplus">+        currentObj = currentObj[nestedKeys[i]];</span>
<a href="#l22.40"></a><span id="l22.40" class="difflineplus">+    }</span>
<a href="#l22.41"></a><span id="l22.41" class="difflineplus">+    currentObj[nestedKeys[nestedKeys.length - 1]] = val;</span>
<a href="#l22.42"></a><span id="l22.42" class="difflineplus">+}</span>
<a href="#l22.43"></a><span id="l22.43" class="difflineplus">+</span>
<a href="#l22.44"></a><span id="l22.44" class="difflineplus">+/**</span>
<a href="#l22.45"></a><span id="l22.45" class="difflineplus">+ * Construct a new Filter.</span>
<a href="#l22.46"></a><span id="l22.46" class="difflineplus">+ * @constructor</span>
<a href="#l22.47"></a><span id="l22.47" class="difflineplus">+ * @param {string} userId The user ID for this filter.</span>
<a href="#l22.48"></a><span id="l22.48" class="difflineplus">+ * @param {string=} filterId The filter ID if known.</span>
<a href="#l22.49"></a><span id="l22.49" class="difflineplus">+ * @prop {string} userId The user ID of the filter</span>
<a href="#l22.50"></a><span id="l22.50" class="difflineplus">+ * @prop {?string} filterId The filter ID</span>
<a href="#l22.51"></a><span id="l22.51" class="difflineplus">+ */</span>
<a href="#l22.52"></a><span id="l22.52" class="difflineplus">+function Filter(userId, filterId) {</span>
<a href="#l22.53"></a><span id="l22.53" class="difflineplus">+    this.userId = userId;</span>
<a href="#l22.54"></a><span id="l22.54" class="difflineplus">+    this.filterId = filterId;</span>
<a href="#l22.55"></a><span id="l22.55" class="difflineplus">+    this.definition = {};</span>
<a href="#l22.56"></a><span id="l22.56" class="difflineplus">+}</span>
<a href="#l22.57"></a><span id="l22.57" class="difflineplus">+</span>
<a href="#l22.58"></a><span id="l22.58" class="difflineplus">+/**</span>
<a href="#l22.59"></a><span id="l22.59" class="difflineplus">+ * Get the ID of this filter on your homeserver (if known)</span>
<a href="#l22.60"></a><span id="l22.60" class="difflineplus">+ * @return {?Number} The filter ID</span>
<a href="#l22.61"></a><span id="l22.61" class="difflineplus">+ */</span>
<a href="#l22.62"></a><span id="l22.62" class="difflineplus">+Filter.prototype.getFilterId = function() {</span>
<a href="#l22.63"></a><span id="l22.63" class="difflineplus">+    return this.filterId;</span>
<a href="#l22.64"></a><span id="l22.64" class="difflineplus">+};</span>
<a href="#l22.65"></a><span id="l22.65" class="difflineplus">+</span>
<a href="#l22.66"></a><span id="l22.66" class="difflineplus">+/**</span>
<a href="#l22.67"></a><span id="l22.67" class="difflineplus">+ * Get the JSON body of the filter.</span>
<a href="#l22.68"></a><span id="l22.68" class="difflineplus">+ * @return {Object} The filter definition</span>
<a href="#l22.69"></a><span id="l22.69" class="difflineplus">+ */</span>
<a href="#l22.70"></a><span id="l22.70" class="difflineplus">+Filter.prototype.getDefinition = function() {</span>
<a href="#l22.71"></a><span id="l22.71" class="difflineplus">+    return this.definition;</span>
<a href="#l22.72"></a><span id="l22.72" class="difflineplus">+};</span>
<a href="#l22.73"></a><span id="l22.73" class="difflineplus">+</span>
<a href="#l22.74"></a><span id="l22.74" class="difflineplus">+/**</span>
<a href="#l22.75"></a><span id="l22.75" class="difflineplus">+ * Set the JSON body of the filter</span>
<a href="#l22.76"></a><span id="l22.76" class="difflineplus">+ * @param {Object} definition The filter definition</span>
<a href="#l22.77"></a><span id="l22.77" class="difflineplus">+ */</span>
<a href="#l22.78"></a><span id="l22.78" class="difflineplus">+Filter.prototype.setDefinition = function(definition) {</span>
<a href="#l22.79"></a><span id="l22.79" class="difflineplus">+    this.definition = definition;</span>
<a href="#l22.80"></a><span id="l22.80" class="difflineplus">+</span>
<a href="#l22.81"></a><span id="l22.81" class="difflineplus">+    // This is all ported from synapse's FilterCollection()</span>
<a href="#l22.82"></a><span id="l22.82" class="difflineplus">+</span>
<a href="#l22.83"></a><span id="l22.83" class="difflineplus">+    // definitions look something like:</span>
<a href="#l22.84"></a><span id="l22.84" class="difflineplus">+    // {</span>
<a href="#l22.85"></a><span id="l22.85" class="difflineplus">+    //   &quot;room&quot;: {</span>
<a href="#l22.86"></a><span id="l22.86" class="difflineplus">+    //     &quot;rooms&quot;: [&quot;!abcde:example.com&quot;],</span>
<a href="#l22.87"></a><span id="l22.87" class="difflineplus">+    //     &quot;not_rooms&quot;: [&quot;!123456:example.com&quot;],</span>
<a href="#l22.88"></a><span id="l22.88" class="difflineplus">+    //     &quot;state&quot;: {</span>
<a href="#l22.89"></a><span id="l22.89" class="difflineplus">+    //       &quot;types&quot;: [&quot;m.room.*&quot;],</span>
<a href="#l22.90"></a><span id="l22.90" class="difflineplus">+    //       &quot;not_rooms&quot;: [&quot;!726s6s6q:example.com&quot;],</span>
<a href="#l22.91"></a><span id="l22.91" class="difflineplus">+    //     },</span>
<a href="#l22.92"></a><span id="l22.92" class="difflineplus">+    //     &quot;timeline&quot;: {</span>
<a href="#l22.93"></a><span id="l22.93" class="difflineplus">+    //       &quot;limit&quot;: 10,</span>
<a href="#l22.94"></a><span id="l22.94" class="difflineplus">+    //       &quot;types&quot;: [&quot;m.room.message&quot;],</span>
<a href="#l22.95"></a><span id="l22.95" class="difflineplus">+    //       &quot;not_rooms&quot;: [&quot;!726s6s6q:example.com&quot;],</span>
<a href="#l22.96"></a><span id="l22.96" class="difflineplus">+    //       &quot;not_senders&quot;: [&quot;@spam:example.com&quot;]</span>
<a href="#l22.97"></a><span id="l22.97" class="difflineplus">+    //       &quot;contains_url&quot;: true</span>
<a href="#l22.98"></a><span id="l22.98" class="difflineplus">+    //     },</span>
<a href="#l22.99"></a><span id="l22.99" class="difflineplus">+    //     &quot;ephemeral&quot;: {</span>
<a href="#l22.100"></a><span id="l22.100" class="difflineplus">+    //       &quot;types&quot;: [&quot;m.receipt&quot;, &quot;m.typing&quot;],</span>
<a href="#l22.101"></a><span id="l22.101" class="difflineplus">+    //       &quot;not_rooms&quot;: [&quot;!726s6s6q:example.com&quot;],</span>
<a href="#l22.102"></a><span id="l22.102" class="difflineplus">+    //       &quot;not_senders&quot;: [&quot;@spam:example.com&quot;]</span>
<a href="#l22.103"></a><span id="l22.103" class="difflineplus">+    //     }</span>
<a href="#l22.104"></a><span id="l22.104" class="difflineplus">+    //   },</span>
<a href="#l22.105"></a><span id="l22.105" class="difflineplus">+    //   &quot;presence&quot;: {</span>
<a href="#l22.106"></a><span id="l22.106" class="difflineplus">+    //     &quot;types&quot;: [&quot;m.presence&quot;],</span>
<a href="#l22.107"></a><span id="l22.107" class="difflineplus">+    //     &quot;not_senders&quot;: [&quot;@alice:example.com&quot;]</span>
<a href="#l22.108"></a><span id="l22.108" class="difflineplus">+    //   },</span>
<a href="#l22.109"></a><span id="l22.109" class="difflineplus">+    //   &quot;event_format&quot;: &quot;client&quot;,</span>
<a href="#l22.110"></a><span id="l22.110" class="difflineplus">+    //   &quot;event_fields&quot;: [&quot;type&quot;, &quot;content&quot;, &quot;sender&quot;]</span>
<a href="#l22.111"></a><span id="l22.111" class="difflineplus">+    // }</span>
<a href="#l22.112"></a><span id="l22.112" class="difflineplus">+</span>
<a href="#l22.113"></a><span id="l22.113" class="difflineplus">+    var room_filter_json = definition.room;</span>
<a href="#l22.114"></a><span id="l22.114" class="difflineplus">+</span>
<a href="#l22.115"></a><span id="l22.115" class="difflineplus">+    // consider the top level rooms/not_rooms filter</span>
<a href="#l22.116"></a><span id="l22.116" class="difflineplus">+    var room_filter_fields = {};</span>
<a href="#l22.117"></a><span id="l22.117" class="difflineplus">+    if (room_filter_json) {</span>
<a href="#l22.118"></a><span id="l22.118" class="difflineplus">+        if (room_filter_json.rooms) {</span>
<a href="#l22.119"></a><span id="l22.119" class="difflineplus">+            room_filter_fields.rooms = room_filter_json.rooms;</span>
<a href="#l22.120"></a><span id="l22.120" class="difflineplus">+        }</span>
<a href="#l22.121"></a><span id="l22.121" class="difflineplus">+        if (room_filter_json.rooms) {</span>
<a href="#l22.122"></a><span id="l22.122" class="difflineplus">+            room_filter_fields.not_rooms = room_filter_json.not_rooms;</span>
<a href="#l22.123"></a><span id="l22.123" class="difflineplus">+        }</span>
<a href="#l22.124"></a><span id="l22.124" class="difflineplus">+</span>
<a href="#l22.125"></a><span id="l22.125" class="difflineplus">+        this._include_leave = room_filter_json.include_leave || false;</span>
<a href="#l22.126"></a><span id="l22.126" class="difflineplus">+    }</span>
<a href="#l22.127"></a><span id="l22.127" class="difflineplus">+</span>
<a href="#l22.128"></a><span id="l22.128" class="difflineplus">+    this._room_filter = new FilterComponent(room_filter_fields);</span>
<a href="#l22.129"></a><span id="l22.129" class="difflineplus">+    this._room_timeline_filter = new FilterComponent(</span>
<a href="#l22.130"></a><span id="l22.130" class="difflineplus">+        room_filter_json ? (room_filter_json.timeline || {}) : {}</span>
<a href="#l22.131"></a><span id="l22.131" class="difflineplus">+    );</span>
<a href="#l22.132"></a><span id="l22.132" class="difflineplus">+</span>
<a href="#l22.133"></a><span id="l22.133" class="difflineplus">+    // don't bother porting this from synapse yet:</span>
<a href="#l22.134"></a><span id="l22.134" class="difflineplus">+    // this._room_state_filter =</span>
<a href="#l22.135"></a><span id="l22.135" class="difflineplus">+    //     new FilterComponent(room_filter_json.state || {});</span>
<a href="#l22.136"></a><span id="l22.136" class="difflineplus">+    // this._room_ephemeral_filter =</span>
<a href="#l22.137"></a><span id="l22.137" class="difflineplus">+    //     new FilterComponent(room_filter_json.ephemeral || {});</span>
<a href="#l22.138"></a><span id="l22.138" class="difflineplus">+    // this._room_account_data_filter =</span>
<a href="#l22.139"></a><span id="l22.139" class="difflineplus">+    //     new FilterComponent(room_filter_json.account_data || {});</span>
<a href="#l22.140"></a><span id="l22.140" class="difflineplus">+    // this._presence_filter =</span>
<a href="#l22.141"></a><span id="l22.141" class="difflineplus">+    //     new FilterComponent(definition.presence || {});</span>
<a href="#l22.142"></a><span id="l22.142" class="difflineplus">+    // this._account_data_filter =</span>
<a href="#l22.143"></a><span id="l22.143" class="difflineplus">+    //     new FilterComponent(definition.account_data || {});</span>
<a href="#l22.144"></a><span id="l22.144" class="difflineplus">+};</span>
<a href="#l22.145"></a><span id="l22.145" class="difflineplus">+</span>
<a href="#l22.146"></a><span id="l22.146" class="difflineplus">+/**</span>
<a href="#l22.147"></a><span id="l22.147" class="difflineplus">+ * Get the room.timeline filter component of the filter</span>
<a href="#l22.148"></a><span id="l22.148" class="difflineplus">+ * @return {FilterComponent} room timeline filter component</span>
<a href="#l22.149"></a><span id="l22.149" class="difflineplus">+ */</span>
<a href="#l22.150"></a><span id="l22.150" class="difflineplus">+Filter.prototype.getRoomTimelineFilterComponent = function() {</span>
<a href="#l22.151"></a><span id="l22.151" class="difflineplus">+    return this._room_timeline_filter;</span>
<a href="#l22.152"></a><span id="l22.152" class="difflineplus">+};</span>
<a href="#l22.153"></a><span id="l22.153" class="difflineplus">+</span>
<a href="#l22.154"></a><span id="l22.154" class="difflineplus">+/**</span>
<a href="#l22.155"></a><span id="l22.155" class="difflineplus">+ * Filter the list of events based on whether they are allowed in a timeline</span>
<a href="#l22.156"></a><span id="l22.156" class="difflineplus">+ * based on this filter</span>
<a href="#l22.157"></a><span id="l22.157" class="difflineplus">+ * @param {MatrixEvent[]} events  the list of events being filtered</span>
<a href="#l22.158"></a><span id="l22.158" class="difflineplus">+ * @return {MatrixEvent[]} the list of events which match the filter</span>
<a href="#l22.159"></a><span id="l22.159" class="difflineplus">+ */</span>
<a href="#l22.160"></a><span id="l22.160" class="difflineplus">+Filter.prototype.filterRoomTimeline = function(events) {</span>
<a href="#l22.161"></a><span id="l22.161" class="difflineplus">+    return this._room_timeline_filter.filter(this._room_filter.filter(events));</span>
<a href="#l22.162"></a><span id="l22.162" class="difflineplus">+};</span>
<a href="#l22.163"></a><span id="l22.163" class="difflineplus">+</span>
<a href="#l22.164"></a><span id="l22.164" class="difflineplus">+/**</span>
<a href="#l22.165"></a><span id="l22.165" class="difflineplus">+ * Set the max number of events to return for each room's timeline.</span>
<a href="#l22.166"></a><span id="l22.166" class="difflineplus">+ * @param {Number} limit The max number of events to return for each room.</span>
<a href="#l22.167"></a><span id="l22.167" class="difflineplus">+ */</span>
<a href="#l22.168"></a><span id="l22.168" class="difflineplus">+Filter.prototype.setTimelineLimit = function(limit) {</span>
<a href="#l22.169"></a><span id="l22.169" class="difflineplus">+    setProp(this.definition, &quot;room.timeline.limit&quot;, limit);</span>
<a href="#l22.170"></a><span id="l22.170" class="difflineplus">+};</span>
<a href="#l22.171"></a><span id="l22.171" class="difflineplus">+</span>
<a href="#l22.172"></a><span id="l22.172" class="difflineplus">+/**</span>
<a href="#l22.173"></a><span id="l22.173" class="difflineplus">+ * Control whether left rooms should be included in responses.</span>
<a href="#l22.174"></a><span id="l22.174" class="difflineplus">+ * @param {boolean} includeLeave True to make rooms the user has left appear</span>
<a href="#l22.175"></a><span id="l22.175" class="difflineplus">+ * in responses.</span>
<a href="#l22.176"></a><span id="l22.176" class="difflineplus">+ */</span>
<a href="#l22.177"></a><span id="l22.177" class="difflineplus">+Filter.prototype.setIncludeLeaveRooms = function(includeLeave) {</span>
<a href="#l22.178"></a><span id="l22.178" class="difflineplus">+    setProp(this.definition, &quot;room.include_leave&quot;, includeLeave);</span>
<a href="#l22.179"></a><span id="l22.179" class="difflineplus">+};</span>
<a href="#l22.180"></a><span id="l22.180" class="difflineplus">+</span>
<a href="#l22.181"></a><span id="l22.181" class="difflineplus">+/**</span>
<a href="#l22.182"></a><span id="l22.182" class="difflineplus">+ * Create a filter from existing data.</span>
<a href="#l22.183"></a><span id="l22.183" class="difflineplus">+ * @static</span>
<a href="#l22.184"></a><span id="l22.184" class="difflineplus">+ * @param {string} userId</span>
<a href="#l22.185"></a><span id="l22.185" class="difflineplus">+ * @param {string} filterId</span>
<a href="#l22.186"></a><span id="l22.186" class="difflineplus">+ * @param {Object} jsonObj</span>
<a href="#l22.187"></a><span id="l22.187" class="difflineplus">+ * @return {Filter}</span>
<a href="#l22.188"></a><span id="l22.188" class="difflineplus">+ */</span>
<a href="#l22.189"></a><span id="l22.189" class="difflineplus">+Filter.fromJson = function(userId, filterId, jsonObj) {</span>
<a href="#l22.190"></a><span id="l22.190" class="difflineplus">+    var filter = new Filter(userId, filterId);</span>
<a href="#l22.191"></a><span id="l22.191" class="difflineplus">+    filter.setDefinition(jsonObj);</span>
<a href="#l22.192"></a><span id="l22.192" class="difflineplus">+    return filter;</span>
<a href="#l22.193"></a><span id="l22.193" class="difflineplus">+};</span>
<a href="#l22.194"></a><span id="l22.194" class="difflineplus">+</span>
<a href="#l22.195"></a><span id="l22.195" class="difflineplus">+/** The Filter class */</span>
<a href="#l22.196"></a><span id="l22.196" class="difflineplus">+module.exports = Filter;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1">new file mode 100644</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineminus">--- /dev/null</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineplus">+++ b/chat/protocols/matrix/matrix-sdk/http-api.js</span>
<a href="#l23.4"></a><span id="l23.4" class="difflineat">@@ -0,0 +1,767 @@</span>
<a href="#l23.5"></a><span id="l23.5" class="difflineplus">+/*</span>
<a href="#l23.6"></a><span id="l23.6" class="difflineplus">+Copyright 2015, 2016 OpenMarket Ltd</span>
<a href="#l23.7"></a><span id="l23.7" class="difflineplus">+</span>
<a href="#l23.8"></a><span id="l23.8" class="difflineplus">+Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<a href="#l23.9"></a><span id="l23.9" class="difflineplus">+you may not use this file except in compliance with the License.</span>
<a href="#l23.10"></a><span id="l23.10" class="difflineplus">+You may obtain a copy of the License at</span>
<a href="#l23.11"></a><span id="l23.11" class="difflineplus">+</span>
<a href="#l23.12"></a><span id="l23.12" class="difflineplus">+    http://www.apache.org/licenses/LICENSE-2.0</span>
<a href="#l23.13"></a><span id="l23.13" class="difflineplus">+</span>
<a href="#l23.14"></a><span id="l23.14" class="difflineplus">+Unless required by applicable law or agreed to in writing, software</span>
<a href="#l23.15"></a><span id="l23.15" class="difflineplus">+distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<a href="#l23.16"></a><span id="l23.16" class="difflineplus">+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<a href="#l23.17"></a><span id="l23.17" class="difflineplus">+See the License for the specific language governing permissions and</span>
<a href="#l23.18"></a><span id="l23.18" class="difflineplus">+limitations under the License.</span>
<a href="#l23.19"></a><span id="l23.19" class="difflineplus">+*/</span>
<a href="#l23.20"></a><span id="l23.20" class="difflineplus">+&quot;use strict&quot;;</span>
<a href="#l23.21"></a><span id="l23.21" class="difflineplus">+/**</span>
<a href="#l23.22"></a><span id="l23.22" class="difflineplus">+ * This is an internal module. See {@link MatrixHttpApi} for the public class.</span>
<a href="#l23.23"></a><span id="l23.23" class="difflineplus">+ * @module http-api</span>
<a href="#l23.24"></a><span id="l23.24" class="difflineplus">+ */</span>
<a href="#l23.25"></a><span id="l23.25" class="difflineplus">+var q = require(&quot;q&quot;);</span>
<a href="#l23.26"></a><span id="l23.26" class="difflineplus">+var utils = require(&quot;./utils&quot;);</span>
<a href="#l23.27"></a><span id="l23.27" class="difflineplus">+</span>
<a href="#l23.28"></a><span id="l23.28" class="difflineplus">+// we use our own implementation of setTimeout, so that if we get suspended in</span>
<a href="#l23.29"></a><span id="l23.29" class="difflineplus">+// the middle of a /sync, we cancel the sync as soon as we awake, rather than</span>
<a href="#l23.30"></a><span id="l23.30" class="difflineplus">+// waiting for the delay to elapse.</span>
<a href="#l23.31"></a><span id="l23.31" class="difflineplus">+var callbacks = require(&quot;./realtime-callbacks&quot;);</span>
<a href="#l23.32"></a><span id="l23.32" class="difflineplus">+</span>
<a href="#l23.33"></a><span id="l23.33" class="difflineplus">+/*</span>
<a href="#l23.34"></a><span id="l23.34" class="difflineplus">+TODO:</span>
<a href="#l23.35"></a><span id="l23.35" class="difflineplus">+- CS: complete register function (doing stages)</span>
<a href="#l23.36"></a><span id="l23.36" class="difflineplus">+- Identity server: linkEmail, authEmail, bindEmail, lookup3pid</span>
<a href="#l23.37"></a><span id="l23.37" class="difflineplus">+*/</span>
<a href="#l23.38"></a><span id="l23.38" class="difflineplus">+</span>
<a href="#l23.39"></a><span id="l23.39" class="difflineplus">+/**</span>
<a href="#l23.40"></a><span id="l23.40" class="difflineplus">+ * A constant representing the URI path for release 0 of the Client-Server HTTP API.</span>
<a href="#l23.41"></a><span id="l23.41" class="difflineplus">+ */</span>
<a href="#l23.42"></a><span id="l23.42" class="difflineplus">+module.exports.PREFIX_R0 = &quot;/_matrix/client/r0&quot;;</span>
<a href="#l23.43"></a><span id="l23.43" class="difflineplus">+</span>
<a href="#l23.44"></a><span id="l23.44" class="difflineplus">+/**</span>
<a href="#l23.45"></a><span id="l23.45" class="difflineplus">+ * A constant representing the URI path for as-yet unspecified Client-Server HTTP APIs.</span>
<a href="#l23.46"></a><span id="l23.46" class="difflineplus">+ */</span>
<a href="#l23.47"></a><span id="l23.47" class="difflineplus">+module.exports.PREFIX_UNSTABLE = &quot;/_matrix/client/unstable&quot;;</span>
<a href="#l23.48"></a><span id="l23.48" class="difflineplus">+</span>
<a href="#l23.49"></a><span id="l23.49" class="difflineplus">+/**</span>
<a href="#l23.50"></a><span id="l23.50" class="difflineplus">+ * URI path for the identity API</span>
<a href="#l23.51"></a><span id="l23.51" class="difflineplus">+ */</span>
<a href="#l23.52"></a><span id="l23.52" class="difflineplus">+module.exports.PREFIX_IDENTITY_V1 = &quot;/_matrix/identity/api/v1&quot;;</span>
<a href="#l23.53"></a><span id="l23.53" class="difflineplus">+</span>
<a href="#l23.54"></a><span id="l23.54" class="difflineplus">+/**</span>
<a href="#l23.55"></a><span id="l23.55" class="difflineplus">+ * URI path for the media repo API</span>
<a href="#l23.56"></a><span id="l23.56" class="difflineplus">+ */</span>
<a href="#l23.57"></a><span id="l23.57" class="difflineplus">+module.exports.PREFIX_MEDIA_R0 = &quot;/_matrix/media/r0&quot;;</span>
<a href="#l23.58"></a><span id="l23.58" class="difflineplus">+</span>
<a href="#l23.59"></a><span id="l23.59" class="difflineplus">+/**</span>
<a href="#l23.60"></a><span id="l23.60" class="difflineplus">+ * Construct a MatrixHttpApi.</span>
<a href="#l23.61"></a><span id="l23.61" class="difflineplus">+ * @constructor</span>
<a href="#l23.62"></a><span id="l23.62" class="difflineplus">+ * @param {EventEmitter} event_emitter The event emitter to use for emitting events</span>
<a href="#l23.63"></a><span id="l23.63" class="difflineplus">+ * @param {Object} opts The options to use for this HTTP API.</span>
<a href="#l23.64"></a><span id="l23.64" class="difflineplus">+ * @param {string} opts.baseUrl Required. The base client-server URL e.g.</span>
<a href="#l23.65"></a><span id="l23.65" class="difflineplus">+ * 'http://localhost:8008'.</span>
<a href="#l23.66"></a><span id="l23.66" class="difflineplus">+ * @param {Function} opts.request Required. The function to call for HTTP</span>
<a href="#l23.67"></a><span id="l23.67" class="difflineplus">+ * requests. This function must look like function(opts, callback){ ... }.</span>
<a href="#l23.68"></a><span id="l23.68" class="difflineplus">+ * @param {string} opts.prefix Required. The matrix client prefix to use, e.g.</span>
<a href="#l23.69"></a><span id="l23.69" class="difflineplus">+ * '/_matrix/client/r0'. See PREFIX_R0 and PREFIX_UNSTABLE for constants.</span>
<a href="#l23.70"></a><span id="l23.70" class="difflineplus">+ *</span>
<a href="#l23.71"></a><span id="l23.71" class="difflineplus">+ * @param {bool=} opts.onlyData True to return only the 'data' component of the</span>
<a href="#l23.72"></a><span id="l23.72" class="difflineplus">+ * response (e.g. the parsed HTTP body). If false, requests will return an</span>
<a href="#l23.73"></a><span id="l23.73" class="difflineplus">+ * object with the properties &lt;tt&gt;code&lt;/tt&gt;, &lt;tt&gt;headers&lt;/tt&gt; and &lt;tt&gt;data&lt;/tt&gt;.</span>
<a href="#l23.74"></a><span id="l23.74" class="difflineplus">+ *</span>
<a href="#l23.75"></a><span id="l23.75" class="difflineplus">+ * @param {string} opts.accessToken The access_token to send with requests. Can be</span>
<a href="#l23.76"></a><span id="l23.76" class="difflineplus">+ * null to not send an access token.</span>
<a href="#l23.77"></a><span id="l23.77" class="difflineplus">+ * @param {Object} opts.extraParams Optional. Extra query parameters to send on</span>
<a href="#l23.78"></a><span id="l23.78" class="difflineplus">+ * requests.</span>
<a href="#l23.79"></a><span id="l23.79" class="difflineplus">+ */</span>
<a href="#l23.80"></a><span id="l23.80" class="difflineplus">+module.exports.MatrixHttpApi = function MatrixHttpApi(event_emitter, opts) {</span>
<a href="#l23.81"></a><span id="l23.81" class="difflineplus">+    utils.checkObjectHasKeys(opts, [&quot;baseUrl&quot;, &quot;request&quot;, &quot;prefix&quot;]);</span>
<a href="#l23.82"></a><span id="l23.82" class="difflineplus">+    opts.onlyData = opts.onlyData || false;</span>
<a href="#l23.83"></a><span id="l23.83" class="difflineplus">+    this.event_emitter = event_emitter;</span>
<a href="#l23.84"></a><span id="l23.84" class="difflineplus">+    this.opts = opts;</span>
<a href="#l23.85"></a><span id="l23.85" class="difflineplus">+    this.uploads = [];</span>
<a href="#l23.86"></a><span id="l23.86" class="difflineplus">+};</span>
<a href="#l23.87"></a><span id="l23.87" class="difflineplus">+</span>
<a href="#l23.88"></a><span id="l23.88" class="difflineplus">+module.exports.MatrixHttpApi.prototype = {</span>
<a href="#l23.89"></a><span id="l23.89" class="difflineplus">+</span>
<a href="#l23.90"></a><span id="l23.90" class="difflineplus">+    /**</span>
<a href="#l23.91"></a><span id="l23.91" class="difflineplus">+     * Get the content repository url with query parameters.</span>
<a href="#l23.92"></a><span id="l23.92" class="difflineplus">+     * @return {Object} An object with a 'base', 'path' and 'params' for base URL,</span>
<a href="#l23.93"></a><span id="l23.93" class="difflineplus">+     *          path and query parameters respectively.</span>
<a href="#l23.94"></a><span id="l23.94" class="difflineplus">+     */</span>
<a href="#l23.95"></a><span id="l23.95" class="difflineplus">+    getContentUri: function() {</span>
<a href="#l23.96"></a><span id="l23.96" class="difflineplus">+        var params = {</span>
<a href="#l23.97"></a><span id="l23.97" class="difflineplus">+            access_token: this.opts.accessToken</span>
<a href="#l23.98"></a><span id="l23.98" class="difflineplus">+        };</span>
<a href="#l23.99"></a><span id="l23.99" class="difflineplus">+        return {</span>
<a href="#l23.100"></a><span id="l23.100" class="difflineplus">+            base: this.opts.baseUrl,</span>
<a href="#l23.101"></a><span id="l23.101" class="difflineplus">+            path: &quot;/_matrix/media/v1/upload&quot;,</span>
<a href="#l23.102"></a><span id="l23.102" class="difflineplus">+            params: params</span>
<a href="#l23.103"></a><span id="l23.103" class="difflineplus">+        };</span>
<a href="#l23.104"></a><span id="l23.104" class="difflineplus">+    },</span>
<a href="#l23.105"></a><span id="l23.105" class="difflineplus">+</span>
<a href="#l23.106"></a><span id="l23.106" class="difflineplus">+    /**</span>
<a href="#l23.107"></a><span id="l23.107" class="difflineplus">+     * Upload content to the Home Server</span>
<a href="#l23.108"></a><span id="l23.108" class="difflineplus">+     *</span>
<a href="#l23.109"></a><span id="l23.109" class="difflineplus">+     * @param {object} file The object to upload. On a browser, something that</span>
<a href="#l23.110"></a><span id="l23.110" class="difflineplus">+     *   can be sent to XMLHttpRequest.send (typically a File).  Under node.js,</span>
<a href="#l23.111"></a><span id="l23.111" class="difflineplus">+     *   a Buffer, String or ReadStream.</span>
<a href="#l23.112"></a><span id="l23.112" class="difflineplus">+     *</span>
<a href="#l23.113"></a><span id="l23.113" class="difflineplus">+     * @param {object} opts  options object</span>
<a href="#l23.114"></a><span id="l23.114" class="difflineplus">+     *</span>
<a href="#l23.115"></a><span id="l23.115" class="difflineplus">+     * @param {string=} opts.name   Name to give the file on the server. Defaults</span>
<a href="#l23.116"></a><span id="l23.116" class="difflineplus">+     *   to &lt;tt&gt;file.name&lt;/tt&gt;.</span>
<a href="#l23.117"></a><span id="l23.117" class="difflineplus">+     *</span>
<a href="#l23.118"></a><span id="l23.118" class="difflineplus">+     * @param {string=} opts.type   Content-type for the upload. Defaults to</span>
<a href="#l23.119"></a><span id="l23.119" class="difflineplus">+     *   &lt;tt&gt;file.type&lt;/tt&gt;, or &lt;tt&gt;applicaton/octet-stream&lt;/tt&gt;.</span>
<a href="#l23.120"></a><span id="l23.120" class="difflineplus">+     *</span>
<a href="#l23.121"></a><span id="l23.121" class="difflineplus">+     * @param {boolean=} opts.rawResponse Return the raw body, rather than</span>
<a href="#l23.122"></a><span id="l23.122" class="difflineplus">+     *   parsing the JSON. Defaults to false (except on node.js, where it</span>
<a href="#l23.123"></a><span id="l23.123" class="difflineplus">+     *   defaults to true for backwards compatibility).</span>
<a href="#l23.124"></a><span id="l23.124" class="difflineplus">+     *</span>
<a href="#l23.125"></a><span id="l23.125" class="difflineplus">+     * @param {boolean=} opts.onlyContentUri Just return the content URI,</span>
<a href="#l23.126"></a><span id="l23.126" class="difflineplus">+     *   rather than the whole body. Defaults to false (except on browsers,</span>
<a href="#l23.127"></a><span id="l23.127" class="difflineplus">+     *   where it defaults to true for backwards compatibility). Ignored if</span>
<a href="#l23.128"></a><span id="l23.128" class="difflineplus">+     *   opts.rawResponse is true.</span>
<a href="#l23.129"></a><span id="l23.129" class="difflineplus">+     *</span>
<a href="#l23.130"></a><span id="l23.130" class="difflineplus">+     * @param {Function=} opts.callback Deprecated. Optional. The callback to</span>
<a href="#l23.131"></a><span id="l23.131" class="difflineplus">+     *    invoke on success/failure. See the promise return values for more</span>
<a href="#l23.132"></a><span id="l23.132" class="difflineplus">+     *    information.</span>
<a href="#l23.133"></a><span id="l23.133" class="difflineplus">+     *</span>
<a href="#l23.134"></a><span id="l23.134" class="difflineplus">+     * @return {module:client.Promise} Resolves to response object, as</span>
<a href="#l23.135"></a><span id="l23.135" class="difflineplus">+     *    determined by this.opts.onlyData, opts.rawResponse, and</span>
<a href="#l23.136"></a><span id="l23.136" class="difflineplus">+     *    opts.onlyContentUri.  Rejects with an error (usually a MatrixError).</span>
<a href="#l23.137"></a><span id="l23.137" class="difflineplus">+     */</span>
<a href="#l23.138"></a><span id="l23.138" class="difflineplus">+    uploadContent: function(file, opts) {</span>
<a href="#l23.139"></a><span id="l23.139" class="difflineplus">+        if (utils.isFunction(opts)) {</span>
<a href="#l23.140"></a><span id="l23.140" class="difflineplus">+            // opts used to be callback</span>
<a href="#l23.141"></a><span id="l23.141" class="difflineplus">+            opts = {</span>
<a href="#l23.142"></a><span id="l23.142" class="difflineplus">+                callback: opts,</span>
<a href="#l23.143"></a><span id="l23.143" class="difflineplus">+            };</span>
<a href="#l23.144"></a><span id="l23.144" class="difflineplus">+        } else if (opts === undefined) {</span>
<a href="#l23.145"></a><span id="l23.145" class="difflineplus">+            opts = {};</span>
<a href="#l23.146"></a><span id="l23.146" class="difflineplus">+        }</span>
<a href="#l23.147"></a><span id="l23.147" class="difflineplus">+</span>
<a href="#l23.148"></a><span id="l23.148" class="difflineplus">+        // if the file doesn't have a mime type, use a default since</span>
<a href="#l23.149"></a><span id="l23.149" class="difflineplus">+        // the HS errors if we don't supply one.</span>
<a href="#l23.150"></a><span id="l23.150" class="difflineplus">+        var contentType = opts.type || file.type || 'application/octet-stream';</span>
<a href="#l23.151"></a><span id="l23.151" class="difflineplus">+        var fileName = opts.name || file.name;</span>
<a href="#l23.152"></a><span id="l23.152" class="difflineplus">+</span>
<a href="#l23.153"></a><span id="l23.153" class="difflineplus">+        // we used to recommend setting file.stream to the thing to upload on</span>
<a href="#l23.154"></a><span id="l23.154" class="difflineplus">+        // nodejs.</span>
<a href="#l23.155"></a><span id="l23.155" class="difflineplus">+        var body = file.stream ? file.stream : file;</span>
<a href="#l23.156"></a><span id="l23.156" class="difflineplus">+</span>
<a href="#l23.157"></a><span id="l23.157" class="difflineplus">+        // backwards-compatibility hacks where we used to do different things</span>
<a href="#l23.158"></a><span id="l23.158" class="difflineplus">+        // between browser and node.</span>
<a href="#l23.159"></a><span id="l23.159" class="difflineplus">+        var rawResponse = opts.rawResponse;</span>
<a href="#l23.160"></a><span id="l23.160" class="difflineplus">+        if (rawResponse === undefined) {</span>
<a href="#l23.161"></a><span id="l23.161" class="difflineplus">+            if (global.XMLHttpRequest) {</span>
<a href="#l23.162"></a><span id="l23.162" class="difflineplus">+                rawResponse = false;</span>
<a href="#l23.163"></a><span id="l23.163" class="difflineplus">+            } else {</span>
<a href="#l23.164"></a><span id="l23.164" class="difflineplus">+                console.warn(</span>
<a href="#l23.165"></a><span id="l23.165" class="difflineplus">+                    &quot;Returning the raw JSON from uploadContent(). Future &quot; +</span>
<a href="#l23.166"></a><span id="l23.166" class="difflineplus">+                    &quot;versions of the js-sdk will change this default, to &quot; +</span>
<a href="#l23.167"></a><span id="l23.167" class="difflineplus">+                    &quot;return the parsed object. Set opts.rawResponse=false &quot; +</span>
<a href="#l23.168"></a><span id="l23.168" class="difflineplus">+                    &quot;to change this behaviour now.&quot;</span>
<a href="#l23.169"></a><span id="l23.169" class="difflineplus">+                );</span>
<a href="#l23.170"></a><span id="l23.170" class="difflineplus">+                rawResponse = true;</span>
<a href="#l23.171"></a><span id="l23.171" class="difflineplus">+            }</span>
<a href="#l23.172"></a><span id="l23.172" class="difflineplus">+        }</span>
<a href="#l23.173"></a><span id="l23.173" class="difflineplus">+</span>
<a href="#l23.174"></a><span id="l23.174" class="difflineplus">+        var onlyContentUri = opts.onlyContentUri;</span>
<a href="#l23.175"></a><span id="l23.175" class="difflineplus">+        if (!rawResponse &amp;&amp; onlyContentUri === undefined) {</span>
<a href="#l23.176"></a><span id="l23.176" class="difflineplus">+            if (global.XMLHttpRequest) {</span>
<a href="#l23.177"></a><span id="l23.177" class="difflineplus">+                console.warn(</span>
<a href="#l23.178"></a><span id="l23.178" class="difflineplus">+                    &quot;Returning only the content-uri from uploadContent(). &quot; +</span>
<a href="#l23.179"></a><span id="l23.179" class="difflineplus">+                    &quot;Future versions of the js-sdk will change this &quot; +</span>
<a href="#l23.180"></a><span id="l23.180" class="difflineplus">+                    &quot;default, to return the whole response object. Set &quot; +</span>
<a href="#l23.181"></a><span id="l23.181" class="difflineplus">+                    &quot;opts.onlyContentUri=false to change this behaviour now.&quot;</span>
<a href="#l23.182"></a><span id="l23.182" class="difflineplus">+                );</span>
<a href="#l23.183"></a><span id="l23.183" class="difflineplus">+                onlyContentUri = true;</span>
<a href="#l23.184"></a><span id="l23.184" class="difflineplus">+            } else {</span>
<a href="#l23.185"></a><span id="l23.185" class="difflineplus">+                onlyContentUri = false;</span>
<a href="#l23.186"></a><span id="l23.186" class="difflineplus">+            }</span>
<a href="#l23.187"></a><span id="l23.187" class="difflineplus">+        }</span>
<a href="#l23.188"></a><span id="l23.188" class="difflineplus">+</span>
<a href="#l23.189"></a><span id="l23.189" class="difflineplus">+        // browser-request doesn't support File objects because it deep-copies</span>
<a href="#l23.190"></a><span id="l23.190" class="difflineplus">+        // the options using JSON.parse(JSON.stringify(options)). Instead of</span>
<a href="#l23.191"></a><span id="l23.191" class="difflineplus">+        // loading the whole file into memory as a string and letting</span>
<a href="#l23.192"></a><span id="l23.192" class="difflineplus">+        // browser-request base64 encode and then decode it again, we just</span>
<a href="#l23.193"></a><span id="l23.193" class="difflineplus">+        // use XMLHttpRequest directly.</span>
<a href="#l23.194"></a><span id="l23.194" class="difflineplus">+        // (browser-request doesn't support progress either, which is also kind</span>
<a href="#l23.195"></a><span id="l23.195" class="difflineplus">+        // of important here)</span>
<a href="#l23.196"></a><span id="l23.196" class="difflineplus">+</span>
<a href="#l23.197"></a><span id="l23.197" class="difflineplus">+        var upload = { loaded: 0, total: 0 };</span>
<a href="#l23.198"></a><span id="l23.198" class="difflineplus">+        var promise;</span>
<a href="#l23.199"></a><span id="l23.199" class="difflineplus">+</span>
<a href="#l23.200"></a><span id="l23.200" class="difflineplus">+        // XMLHttpRequest doesn't parse JSON for us. request normally does, but</span>
<a href="#l23.201"></a><span id="l23.201" class="difflineplus">+        // we're setting opts.json=false so that it doesn't JSON-encode the</span>
<a href="#l23.202"></a><span id="l23.202" class="difflineplus">+        // request, which also means it doesn't JSON-decode the response. Either</span>
<a href="#l23.203"></a><span id="l23.203" class="difflineplus">+        // way, we have to JSON-parse the response ourselves.</span>
<a href="#l23.204"></a><span id="l23.204" class="difflineplus">+        var bodyParser = null;</span>
<a href="#l23.205"></a><span id="l23.205" class="difflineplus">+        if (!rawResponse) {</span>
<a href="#l23.206"></a><span id="l23.206" class="difflineplus">+            bodyParser = function(rawBody) {</span>
<a href="#l23.207"></a><span id="l23.207" class="difflineplus">+                var body = JSON.parse(rawBody);</span>
<a href="#l23.208"></a><span id="l23.208" class="difflineplus">+                if (onlyContentUri) {</span>
<a href="#l23.209"></a><span id="l23.209" class="difflineplus">+                    body = body.content_uri;</span>
<a href="#l23.210"></a><span id="l23.210" class="difflineplus">+                    if (body === undefined) {</span>
<a href="#l23.211"></a><span id="l23.211" class="difflineplus">+                        throw Error('Bad response');</span>
<a href="#l23.212"></a><span id="l23.212" class="difflineplus">+                    }</span>
<a href="#l23.213"></a><span id="l23.213" class="difflineplus">+                }</span>
<a href="#l23.214"></a><span id="l23.214" class="difflineplus">+                return body;</span>
<a href="#l23.215"></a><span id="l23.215" class="difflineplus">+            };</span>
<a href="#l23.216"></a><span id="l23.216" class="difflineplus">+        }</span>
<a href="#l23.217"></a><span id="l23.217" class="difflineplus">+</span>
<a href="#l23.218"></a><span id="l23.218" class="difflineplus">+        if (global.XMLHttpRequest) {</span>
<a href="#l23.219"></a><span id="l23.219" class="difflineplus">+            var defer = q.defer();</span>
<a href="#l23.220"></a><span id="l23.220" class="difflineplus">+            var xhr = new global.XMLHttpRequest();</span>
<a href="#l23.221"></a><span id="l23.221" class="difflineplus">+            upload.xhr = xhr;</span>
<a href="#l23.222"></a><span id="l23.222" class="difflineplus">+            var cb = requestCallback(defer, opts.callback, this.opts.onlyData);</span>
<a href="#l23.223"></a><span id="l23.223" class="difflineplus">+</span>
<a href="#l23.224"></a><span id="l23.224" class="difflineplus">+            var timeout_fn = function() {</span>
<a href="#l23.225"></a><span id="l23.225" class="difflineplus">+                xhr.abort();</span>
<a href="#l23.226"></a><span id="l23.226" class="difflineplus">+                cb(new Error('Timeout'));</span>
<a href="#l23.227"></a><span id="l23.227" class="difflineplus">+            };</span>
<a href="#l23.228"></a><span id="l23.228" class="difflineplus">+</span>
<a href="#l23.229"></a><span id="l23.229" class="difflineplus">+            // set an initial timeout of 30s; we'll advance it each time we get</span>
<a href="#l23.230"></a><span id="l23.230" class="difflineplus">+            // a progress notification</span>
<a href="#l23.231"></a><span id="l23.231" class="difflineplus">+            xhr.timeout_timer = callbacks.setTimeout(timeout_fn, 30000);</span>
<a href="#l23.232"></a><span id="l23.232" class="difflineplus">+</span>
<a href="#l23.233"></a><span id="l23.233" class="difflineplus">+            xhr.onreadystatechange = function() {</span>
<a href="#l23.234"></a><span id="l23.234" class="difflineplus">+                switch (xhr.readyState) {</span>
<a href="#l23.235"></a><span id="l23.235" class="difflineplus">+                    case global.XMLHttpRequest.DONE:</span>
<a href="#l23.236"></a><span id="l23.236" class="difflineplus">+                        callbacks.clearTimeout(xhr.timeout_timer);</span>
<a href="#l23.237"></a><span id="l23.237" class="difflineplus">+                        var resp;</span>
<a href="#l23.238"></a><span id="l23.238" class="difflineplus">+                        try {</span>
<a href="#l23.239"></a><span id="l23.239" class="difflineplus">+                            if (!xhr.responseText) {</span>
<a href="#l23.240"></a><span id="l23.240" class="difflineplus">+                                throw new Error('No response body.');</span>
<a href="#l23.241"></a><span id="l23.241" class="difflineplus">+                            }</span>
<a href="#l23.242"></a><span id="l23.242" class="difflineplus">+                            resp = xhr.responseText;</span>
<a href="#l23.243"></a><span id="l23.243" class="difflineplus">+                            if (bodyParser) {</span>
<a href="#l23.244"></a><span id="l23.244" class="difflineplus">+                                resp = bodyParser(resp);</span>
<a href="#l23.245"></a><span id="l23.245" class="difflineplus">+                            }</span>
<a href="#l23.246"></a><span id="l23.246" class="difflineplus">+                        } catch (err) {</span>
<a href="#l23.247"></a><span id="l23.247" class="difflineplus">+                            err.http_status = xhr.status;</span>
<a href="#l23.248"></a><span id="l23.248" class="difflineplus">+                            cb(err);</span>
<a href="#l23.249"></a><span id="l23.249" class="difflineplus">+                            return;</span>
<a href="#l23.250"></a><span id="l23.250" class="difflineplus">+                        }</span>
<a href="#l23.251"></a><span id="l23.251" class="difflineplus">+                        cb(undefined, xhr, resp);</span>
<a href="#l23.252"></a><span id="l23.252" class="difflineplus">+                        break;</span>
<a href="#l23.253"></a><span id="l23.253" class="difflineplus">+                }</span>
<a href="#l23.254"></a><span id="l23.254" class="difflineplus">+            };</span>
<a href="#l23.255"></a><span id="l23.255" class="difflineplus">+            xhr.upload.addEventListener(&quot;progress&quot;, function(ev) {</span>
<a href="#l23.256"></a><span id="l23.256" class="difflineplus">+                callbacks.clearTimeout(xhr.timeout_timer);</span>
<a href="#l23.257"></a><span id="l23.257" class="difflineplus">+                upload.loaded = ev.loaded;</span>
<a href="#l23.258"></a><span id="l23.258" class="difflineplus">+                upload.total = ev.total;</span>
<a href="#l23.259"></a><span id="l23.259" class="difflineplus">+                xhr.timeout_timer = callbacks.setTimeout(timeout_fn, 30000);</span>
<a href="#l23.260"></a><span id="l23.260" class="difflineplus">+                defer.notify(ev);</span>
<a href="#l23.261"></a><span id="l23.261" class="difflineplus">+            });</span>
<a href="#l23.262"></a><span id="l23.262" class="difflineplus">+            var url = this.opts.baseUrl + &quot;/_matrix/media/v1/upload&quot;;</span>
<a href="#l23.263"></a><span id="l23.263" class="difflineplus">+            url += &quot;?access_token=&quot; + encodeURIComponent(this.opts.accessToken);</span>
<a href="#l23.264"></a><span id="l23.264" class="difflineplus">+            url += &quot;&amp;filename=&quot; + encodeURIComponent(fileName);</span>
<a href="#l23.265"></a><span id="l23.265" class="difflineplus">+</span>
<a href="#l23.266"></a><span id="l23.266" class="difflineplus">+            xhr.open(&quot;POST&quot;, url);</span>
<a href="#l23.267"></a><span id="l23.267" class="difflineplus">+            xhr.setRequestHeader(&quot;Content-Type&quot;, contentType);</span>
<a href="#l23.268"></a><span id="l23.268" class="difflineplus">+            xhr.send(body);</span>
<a href="#l23.269"></a><span id="l23.269" class="difflineplus">+            promise = defer.promise;</span>
<a href="#l23.270"></a><span id="l23.270" class="difflineplus">+</span>
<a href="#l23.271"></a><span id="l23.271" class="difflineplus">+            // dirty hack (as per _request) to allow the upload to be cancelled.</span>
<a href="#l23.272"></a><span id="l23.272" class="difflineplus">+            promise.abort = xhr.abort.bind(xhr);</span>
<a href="#l23.273"></a><span id="l23.273" class="difflineplus">+        } else {</span>
<a href="#l23.274"></a><span id="l23.274" class="difflineplus">+            var queryParams = {</span>
<a href="#l23.275"></a><span id="l23.275" class="difflineplus">+                filename: fileName,</span>
<a href="#l23.276"></a><span id="l23.276" class="difflineplus">+            };</span>
<a href="#l23.277"></a><span id="l23.277" class="difflineplus">+</span>
<a href="#l23.278"></a><span id="l23.278" class="difflineplus">+            promise = this.authedRequest(</span>
<a href="#l23.279"></a><span id="l23.279" class="difflineplus">+                opts.callback, &quot;POST&quot;, &quot;/upload&quot;, queryParams, body, {</span>
<a href="#l23.280"></a><span id="l23.280" class="difflineplus">+                    prefix: &quot;/_matrix/media/v1&quot;,</span>
<a href="#l23.281"></a><span id="l23.281" class="difflineplus">+                    headers: {&quot;Content-Type&quot;: contentType},</span>
<a href="#l23.282"></a><span id="l23.282" class="difflineplus">+                    json: false,</span>
<a href="#l23.283"></a><span id="l23.283" class="difflineplus">+                    bodyParser: bodyParser,</span>
<a href="#l23.284"></a><span id="l23.284" class="difflineplus">+                }</span>
<a href="#l23.285"></a><span id="l23.285" class="difflineplus">+            );</span>
<a href="#l23.286"></a><span id="l23.286" class="difflineplus">+        }</span>
<a href="#l23.287"></a><span id="l23.287" class="difflineplus">+</span>
<a href="#l23.288"></a><span id="l23.288" class="difflineplus">+        var self = this;</span>
<a href="#l23.289"></a><span id="l23.289" class="difflineplus">+</span>
<a href="#l23.290"></a><span id="l23.290" class="difflineplus">+        // remove the upload from the list on completion</span>
<a href="#l23.291"></a><span id="l23.291" class="difflineplus">+        var promise0 = promise.finally(function() {</span>
<a href="#l23.292"></a><span id="l23.292" class="difflineplus">+            for (var i = 0; i &lt; self.uploads.length; ++i) {</span>
<a href="#l23.293"></a><span id="l23.293" class="difflineplus">+                if (self.uploads[i] === upload) {</span>
<a href="#l23.294"></a><span id="l23.294" class="difflineplus">+                    self.uploads.splice(i, 1);</span>
<a href="#l23.295"></a><span id="l23.295" class="difflineplus">+                    return;</span>
<a href="#l23.296"></a><span id="l23.296" class="difflineplus">+                }</span>
<a href="#l23.297"></a><span id="l23.297" class="difflineplus">+            }</span>
<a href="#l23.298"></a><span id="l23.298" class="difflineplus">+        });</span>
<a href="#l23.299"></a><span id="l23.299" class="difflineplus">+</span>
<a href="#l23.300"></a><span id="l23.300" class="difflineplus">+        // copy our dirty abort() method to the new promise</span>
<a href="#l23.301"></a><span id="l23.301" class="difflineplus">+        promise0.abort = promise.abort;</span>
<a href="#l23.302"></a><span id="l23.302" class="difflineplus">+</span>
<a href="#l23.303"></a><span id="l23.303" class="difflineplus">+        upload.promise = promise0;</span>
<a href="#l23.304"></a><span id="l23.304" class="difflineplus">+        this.uploads.push(upload);</span>
<a href="#l23.305"></a><span id="l23.305" class="difflineplus">+</span>
<a href="#l23.306"></a><span id="l23.306" class="difflineplus">+        return promise0;</span>
<a href="#l23.307"></a><span id="l23.307" class="difflineplus">+    },</span>
<a href="#l23.308"></a><span id="l23.308" class="difflineplus">+</span>
<a href="#l23.309"></a><span id="l23.309" class="difflineplus">+    cancelUpload: function(promise) {</span>
<a href="#l23.310"></a><span id="l23.310" class="difflineplus">+        if (promise.abort) {</span>
<a href="#l23.311"></a><span id="l23.311" class="difflineplus">+            promise.abort();</span>
<a href="#l23.312"></a><span id="l23.312" class="difflineplus">+            return true;</span>
<a href="#l23.313"></a><span id="l23.313" class="difflineplus">+        }</span>
<a href="#l23.314"></a><span id="l23.314" class="difflineplus">+        return false;</span>
<a href="#l23.315"></a><span id="l23.315" class="difflineplus">+    },</span>
<a href="#l23.316"></a><span id="l23.316" class="difflineplus">+</span>
<a href="#l23.317"></a><span id="l23.317" class="difflineplus">+    getCurrentUploads: function() {</span>
<a href="#l23.318"></a><span id="l23.318" class="difflineplus">+        return this.uploads;</span>
<a href="#l23.319"></a><span id="l23.319" class="difflineplus">+    },</span>
<a href="#l23.320"></a><span id="l23.320" class="difflineplus">+</span>
<a href="#l23.321"></a><span id="l23.321" class="difflineplus">+    idServerRequest: function(callback, method, path, params, prefix) {</span>
<a href="#l23.322"></a><span id="l23.322" class="difflineplus">+        var fullUri = this.opts.idBaseUrl + prefix + path;</span>
<a href="#l23.323"></a><span id="l23.323" class="difflineplus">+</span>
<a href="#l23.324"></a><span id="l23.324" class="difflineplus">+        if (callback !== undefined &amp;&amp; !utils.isFunction(callback)) {</span>
<a href="#l23.325"></a><span id="l23.325" class="difflineplus">+            throw Error(</span>
<a href="#l23.326"></a><span id="l23.326" class="difflineplus">+                &quot;Expected callback to be a function but got &quot; + typeof callback</span>
<a href="#l23.327"></a><span id="l23.327" class="difflineplus">+            );</span>
<a href="#l23.328"></a><span id="l23.328" class="difflineplus">+        }</span>
<a href="#l23.329"></a><span id="l23.329" class="difflineplus">+</span>
<a href="#l23.330"></a><span id="l23.330" class="difflineplus">+        var opts = {</span>
<a href="#l23.331"></a><span id="l23.331" class="difflineplus">+            uri: fullUri,</span>
<a href="#l23.332"></a><span id="l23.332" class="difflineplus">+            method: method,</span>
<a href="#l23.333"></a><span id="l23.333" class="difflineplus">+            withCredentials: false,</span>
<a href="#l23.334"></a><span id="l23.334" class="difflineplus">+            json: false,</span>
<a href="#l23.335"></a><span id="l23.335" class="difflineplus">+            _matrix_opts: this.opts</span>
<a href="#l23.336"></a><span id="l23.336" class="difflineplus">+        };</span>
<a href="#l23.337"></a><span id="l23.337" class="difflineplus">+        if (method == 'GET') {</span>
<a href="#l23.338"></a><span id="l23.338" class="difflineplus">+            opts.qs = params;</span>
<a href="#l23.339"></a><span id="l23.339" class="difflineplus">+        } else {</span>
<a href="#l23.340"></a><span id="l23.340" class="difflineplus">+            opts.form = params;</span>
<a href="#l23.341"></a><span id="l23.341" class="difflineplus">+        }</span>
<a href="#l23.342"></a><span id="l23.342" class="difflineplus">+</span>
<a href="#l23.343"></a><span id="l23.343" class="difflineplus">+        var defer = q.defer();</span>
<a href="#l23.344"></a><span id="l23.344" class="difflineplus">+        this.opts.request(</span>
<a href="#l23.345"></a><span id="l23.345" class="difflineplus">+            opts,</span>
<a href="#l23.346"></a><span id="l23.346" class="difflineplus">+            requestCallback(defer, callback, this.opts.onlyData)</span>
<a href="#l23.347"></a><span id="l23.347" class="difflineplus">+        );</span>
<a href="#l23.348"></a><span id="l23.348" class="difflineplus">+        // ID server does not always take JSON, so we can't use requests' 'json'</span>
<a href="#l23.349"></a><span id="l23.349" class="difflineplus">+        // option as we do with the home server, but it does return JSON, so</span>
<a href="#l23.350"></a><span id="l23.350" class="difflineplus">+        // parse it manually</span>
<a href="#l23.351"></a><span id="l23.351" class="difflineplus">+        return defer.promise.then(function(response) {</span>
<a href="#l23.352"></a><span id="l23.352" class="difflineplus">+            return JSON.parse(response);</span>
<a href="#l23.353"></a><span id="l23.353" class="difflineplus">+        });</span>
<a href="#l23.354"></a><span id="l23.354" class="difflineplus">+    },</span>
<a href="#l23.355"></a><span id="l23.355" class="difflineplus">+</span>
<a href="#l23.356"></a><span id="l23.356" class="difflineplus">+    /**</span>
<a href="#l23.357"></a><span id="l23.357" class="difflineplus">+     * Perform an authorised request to the homeserver.</span>
<a href="#l23.358"></a><span id="l23.358" class="difflineplus">+     * @param {Function} callback Optional. The callback to invoke on</span>
<a href="#l23.359"></a><span id="l23.359" class="difflineplus">+     * success/failure. See the promise return values for more information.</span>
<a href="#l23.360"></a><span id="l23.360" class="difflineplus">+     * @param {string} method The HTTP method e.g. &quot;GET&quot;.</span>
<a href="#l23.361"></a><span id="l23.361" class="difflineplus">+     * @param {string} path The HTTP path &lt;b&gt;after&lt;/b&gt; the supplied prefix e.g.</span>
<a href="#l23.362"></a><span id="l23.362" class="difflineplus">+     * &quot;/createRoom&quot;.</span>
<a href="#l23.363"></a><span id="l23.363" class="difflineplus">+     *</span>
<a href="#l23.364"></a><span id="l23.364" class="difflineplus">+     * @param {Object=} queryParams A dict of query params (these will NOT be</span>
<a href="#l23.365"></a><span id="l23.365" class="difflineplus">+     * urlencoded). If unspecified, there will be no query params.</span>
<a href="#l23.366"></a><span id="l23.366" class="difflineplus">+     *</span>
<a href="#l23.367"></a><span id="l23.367" class="difflineplus">+     * @param {Object} data The HTTP JSON body.</span>
<a href="#l23.368"></a><span id="l23.368" class="difflineplus">+     *</span>
<a href="#l23.369"></a><span id="l23.369" class="difflineplus">+     * @param {Object=} opts additional options</span>
<a href="#l23.370"></a><span id="l23.370" class="difflineplus">+     *</span>
<a href="#l23.371"></a><span id="l23.371" class="difflineplus">+     * @param {Number=} opts.localTimeoutMs The maximum amount of time to wait before</span>
<a href="#l23.372"></a><span id="l23.372" class="difflineplus">+     * timing out the request. If not specified, there is no timeout.</span>
<a href="#l23.373"></a><span id="l23.373" class="difflineplus">+     *</span>
<a href="#l23.374"></a><span id="l23.374" class="difflineplus">+     * @param {sting=} opts.prefix The full prefix to use e.g.</span>
<a href="#l23.375"></a><span id="l23.375" class="difflineplus">+     * &quot;/_matrix/client/v2_alpha&quot;. If not specified, uses this.opts.prefix.</span>
<a href="#l23.376"></a><span id="l23.376" class="difflineplus">+     *</span>
<a href="#l23.377"></a><span id="l23.377" class="difflineplus">+     * @param {Object=} opts.headers map of additional request headers</span>
<a href="#l23.378"></a><span id="l23.378" class="difflineplus">+     *</span>
<a href="#l23.379"></a><span id="l23.379" class="difflineplus">+     * @return {module:client.Promise} Resolves to &lt;code&gt;{data: {Object},</span>
<a href="#l23.380"></a><span id="l23.380" class="difflineplus">+     * headers: {Object}, code: {Number}}&lt;/code&gt;.</span>
<a href="#l23.381"></a><span id="l23.381" class="difflineplus">+     * If &lt;code&gt;onlyData&lt;/code&gt; is set, this will resolve to the &lt;code&gt;data&lt;/code&gt;</span>
<a href="#l23.382"></a><span id="l23.382" class="difflineplus">+     * object only.</span>
<a href="#l23.383"></a><span id="l23.383" class="difflineplus">+     * @return {module:http-api.MatrixError} Rejects with an error if a problem</span>
<a href="#l23.384"></a><span id="l23.384" class="difflineplus">+     * occurred. This includes network problems and Matrix-specific error JSON.</span>
<a href="#l23.385"></a><span id="l23.385" class="difflineplus">+     */</span>
<a href="#l23.386"></a><span id="l23.386" class="difflineplus">+    authedRequest: function(callback, method, path, queryParams, data, opts) {</span>
<a href="#l23.387"></a><span id="l23.387" class="difflineplus">+        if (!queryParams) {</span>
<a href="#l23.388"></a><span id="l23.388" class="difflineplus">+            queryParams = {};</span>
<a href="#l23.389"></a><span id="l23.389" class="difflineplus">+        }</span>
<a href="#l23.390"></a><span id="l23.390" class="difflineplus">+        if (!queryParams.access_token) {</span>
<a href="#l23.391"></a><span id="l23.391" class="difflineplus">+            queryParams.access_token = this.opts.accessToken;</span>
<a href="#l23.392"></a><span id="l23.392" class="difflineplus">+        }</span>
<a href="#l23.393"></a><span id="l23.393" class="difflineplus">+</span>
<a href="#l23.394"></a><span id="l23.394" class="difflineplus">+        var request_promise = this.request(</span>
<a href="#l23.395"></a><span id="l23.395" class="difflineplus">+            callback, method, path, queryParams, data, opts</span>
<a href="#l23.396"></a><span id="l23.396" class="difflineplus">+        );</span>
<a href="#l23.397"></a><span id="l23.397" class="difflineplus">+</span>
<a href="#l23.398"></a><span id="l23.398" class="difflineplus">+        var self = this;</span>
<a href="#l23.399"></a><span id="l23.399" class="difflineplus">+        request_promise.catch(function(err) {</span>
<a href="#l23.400"></a><span id="l23.400" class="difflineplus">+            if (err.errcode == 'M_UNKNOWN_TOKEN') {</span>
<a href="#l23.401"></a><span id="l23.401" class="difflineplus">+                self.event_emitter.emit(&quot;Session.logged_out&quot;);</span>
<a href="#l23.402"></a><span id="l23.402" class="difflineplus">+            }</span>
<a href="#l23.403"></a><span id="l23.403" class="difflineplus">+        });</span>
<a href="#l23.404"></a><span id="l23.404" class="difflineplus">+</span>
<a href="#l23.405"></a><span id="l23.405" class="difflineplus">+        // return the original promise, otherwise tests break due to it having to</span>
<a href="#l23.406"></a><span id="l23.406" class="difflineplus">+        // go around the event loop one more time to process the result of the request</span>
<a href="#l23.407"></a><span id="l23.407" class="difflineplus">+        return request_promise;</span>
<a href="#l23.408"></a><span id="l23.408" class="difflineplus">+    },</span>
<a href="#l23.409"></a><span id="l23.409" class="difflineplus">+</span>
<a href="#l23.410"></a><span id="l23.410" class="difflineplus">+    /**</span>
<a href="#l23.411"></a><span id="l23.411" class="difflineplus">+     * Perform a request to the homeserver without any credentials.</span>
<a href="#l23.412"></a><span id="l23.412" class="difflineplus">+     * @param {Function} callback Optional. The callback to invoke on</span>
<a href="#l23.413"></a><span id="l23.413" class="difflineplus">+     * success/failure. See the promise return values for more information.</span>
<a href="#l23.414"></a><span id="l23.414" class="difflineplus">+     * @param {string} method The HTTP method e.g. &quot;GET&quot;.</span>
<a href="#l23.415"></a><span id="l23.415" class="difflineplus">+     * @param {string} path The HTTP path &lt;b&gt;after&lt;/b&gt; the supplied prefix e.g.</span>
<a href="#l23.416"></a><span id="l23.416" class="difflineplus">+     * &quot;/createRoom&quot;.</span>
<a href="#l23.417"></a><span id="l23.417" class="difflineplus">+     *</span>
<a href="#l23.418"></a><span id="l23.418" class="difflineplus">+     * @param {Object=} queryParams A dict of query params (these will NOT be</span>
<a href="#l23.419"></a><span id="l23.419" class="difflineplus">+     * urlencoded). If unspecified, there will be no query params.</span>
<a href="#l23.420"></a><span id="l23.420" class="difflineplus">+     *</span>
<a href="#l23.421"></a><span id="l23.421" class="difflineplus">+     * @param {Object} data The HTTP JSON body.</span>
<a href="#l23.422"></a><span id="l23.422" class="difflineplus">+     *</span>
<a href="#l23.423"></a><span id="l23.423" class="difflineplus">+     * @param {Object=} opts additional options</span>
<a href="#l23.424"></a><span id="l23.424" class="difflineplus">+     *</span>
<a href="#l23.425"></a><span id="l23.425" class="difflineplus">+     * @param {Number=} opts.localTimeoutMs The maximum amount of time to wait before</span>
<a href="#l23.426"></a><span id="l23.426" class="difflineplus">+     * timing out the request. If not specified, there is no timeout.</span>
<a href="#l23.427"></a><span id="l23.427" class="difflineplus">+     *</span>
<a href="#l23.428"></a><span id="l23.428" class="difflineplus">+     * @param {sting=} opts.prefix The full prefix to use e.g.</span>
<a href="#l23.429"></a><span id="l23.429" class="difflineplus">+     * &quot;/_matrix/client/v2_alpha&quot;. If not specified, uses this.opts.prefix.</span>
<a href="#l23.430"></a><span id="l23.430" class="difflineplus">+     *</span>
<a href="#l23.431"></a><span id="l23.431" class="difflineplus">+     * @param {Object=} opts.headers map of additional request headers</span>
<a href="#l23.432"></a><span id="l23.432" class="difflineplus">+     *</span>
<a href="#l23.433"></a><span id="l23.433" class="difflineplus">+     * @return {module:client.Promise} Resolves to &lt;code&gt;{data: {Object},</span>
<a href="#l23.434"></a><span id="l23.434" class="difflineplus">+     * headers: {Object}, code: {Number}}&lt;/code&gt;.</span>
<a href="#l23.435"></a><span id="l23.435" class="difflineplus">+     * If &lt;code&gt;onlyData&lt;/code&gt; is set, this will resolve to the &lt;code&gt;data&lt;/code&gt;</span>
<a href="#l23.436"></a><span id="l23.436" class="difflineplus">+     * object only.</span>
<a href="#l23.437"></a><span id="l23.437" class="difflineplus">+     * @return {module:http-api.MatrixError} Rejects with an error if a problem</span>
<a href="#l23.438"></a><span id="l23.438" class="difflineplus">+     * occurred. This includes network problems and Matrix-specific error JSON.</span>
<a href="#l23.439"></a><span id="l23.439" class="difflineplus">+     */</span>
<a href="#l23.440"></a><span id="l23.440" class="difflineplus">+    request: function(callback, method, path, queryParams, data, opts) {</span>
<a href="#l23.441"></a><span id="l23.441" class="difflineplus">+        opts = opts || {};</span>
<a href="#l23.442"></a><span id="l23.442" class="difflineplus">+        var prefix = opts.prefix !== undefined ? opts.prefix : this.opts.prefix;</span>
<a href="#l23.443"></a><span id="l23.443" class="difflineplus">+        var fullUri = this.opts.baseUrl + prefix + path;</span>
<a href="#l23.444"></a><span id="l23.444" class="difflineplus">+</span>
<a href="#l23.445"></a><span id="l23.445" class="difflineplus">+        return this.requestOtherUrl(</span>
<a href="#l23.446"></a><span id="l23.446" class="difflineplus">+            callback, method, fullUri, queryParams, data, opts</span>
<a href="#l23.447"></a><span id="l23.447" class="difflineplus">+        );</span>
<a href="#l23.448"></a><span id="l23.448" class="difflineplus">+    },</span>
<a href="#l23.449"></a><span id="l23.449" class="difflineplus">+</span>
<a href="#l23.450"></a><span id="l23.450" class="difflineplus">+    /**</span>
<a href="#l23.451"></a><span id="l23.451" class="difflineplus">+     * Perform an authorised request to the homeserver with a specific path</span>
<a href="#l23.452"></a><span id="l23.452" class="difflineplus">+     * prefix which overrides the default for this call only. Useful for hitting</span>
<a href="#l23.453"></a><span id="l23.453" class="difflineplus">+     * different Matrix Client-Server versions.</span>
<a href="#l23.454"></a><span id="l23.454" class="difflineplus">+     * @param {Function} callback Optional. The callback to invoke on</span>
<a href="#l23.455"></a><span id="l23.455" class="difflineplus">+     * success/failure. See the promise return values for more information.</span>
<a href="#l23.456"></a><span id="l23.456" class="difflineplus">+     * @param {string} method The HTTP method e.g. &quot;GET&quot;.</span>
<a href="#l23.457"></a><span id="l23.457" class="difflineplus">+     * @param {string} path The HTTP path &lt;b&gt;after&lt;/b&gt; the supplied prefix e.g.</span>
<a href="#l23.458"></a><span id="l23.458" class="difflineplus">+     * &quot;/createRoom&quot;.</span>
<a href="#l23.459"></a><span id="l23.459" class="difflineplus">+     * @param {Object} queryParams A dict of query params (these will NOT be</span>
<a href="#l23.460"></a><span id="l23.460" class="difflineplus">+     * urlencoded).</span>
<a href="#l23.461"></a><span id="l23.461" class="difflineplus">+     * @param {Object} data The HTTP JSON body.</span>
<a href="#l23.462"></a><span id="l23.462" class="difflineplus">+     * @param {string} prefix The full prefix to use e.g.</span>
<a href="#l23.463"></a><span id="l23.463" class="difflineplus">+     * &quot;/_matrix/client/v2_alpha&quot;.</span>
<a href="#l23.464"></a><span id="l23.464" class="difflineplus">+     * @param {Number=} localTimeoutMs The maximum amount of time to wait before</span>
<a href="#l23.465"></a><span id="l23.465" class="difflineplus">+     * timing out the request. If not specified, there is no timeout.</span>
<a href="#l23.466"></a><span id="l23.466" class="difflineplus">+     * @return {module:client.Promise} Resolves to &lt;code&gt;{data: {Object},</span>
<a href="#l23.467"></a><span id="l23.467" class="difflineplus">+     * headers: {Object}, code: {Number}}&lt;/code&gt;.</span>
<a href="#l23.468"></a><span id="l23.468" class="difflineplus">+     * If &lt;code&gt;onlyData&lt;/code&gt; is set, this will resolve to the &lt;code&gt;data&lt;/code&gt;</span>
<a href="#l23.469"></a><span id="l23.469" class="difflineplus">+     * object only.</span>
<a href="#l23.470"></a><span id="l23.470" class="difflineplus">+     * @return {module:http-api.MatrixError} Rejects with an error if a problem</span>
<a href="#l23.471"></a><span id="l23.471" class="difflineplus">+     * occurred. This includes network problems and Matrix-specific error JSON.</span>
<a href="#l23.472"></a><span id="l23.472" class="difflineplus">+     *</span>
<a href="#l23.473"></a><span id="l23.473" class="difflineplus">+     * @deprecated prefer authedRequest with opts.prefix</span>
<a href="#l23.474"></a><span id="l23.474" class="difflineplus">+     */</span>
<a href="#l23.475"></a><span id="l23.475" class="difflineplus">+    authedRequestWithPrefix: function(callback, method, path, queryParams, data,</span>
<a href="#l23.476"></a><span id="l23.476" class="difflineplus">+                                      prefix, localTimeoutMs) {</span>
<a href="#l23.477"></a><span id="l23.477" class="difflineplus">+        return this.authedRequest(</span>
<a href="#l23.478"></a><span id="l23.478" class="difflineplus">+            callback, method, path, queryParams, data, {</span>
<a href="#l23.479"></a><span id="l23.479" class="difflineplus">+                localTimeoutMs: localTimeoutMs,</span>
<a href="#l23.480"></a><span id="l23.480" class="difflineplus">+                prefix: prefix,</span>
<a href="#l23.481"></a><span id="l23.481" class="difflineplus">+            }</span>
<a href="#l23.482"></a><span id="l23.482" class="difflineplus">+        );</span>
<a href="#l23.483"></a><span id="l23.483" class="difflineplus">+    },</span>
<a href="#l23.484"></a><span id="l23.484" class="difflineplus">+</span>
<a href="#l23.485"></a><span id="l23.485" class="difflineplus">+    /**</span>
<a href="#l23.486"></a><span id="l23.486" class="difflineplus">+     * Perform a request to the homeserver without any credentials but with a</span>
<a href="#l23.487"></a><span id="l23.487" class="difflineplus">+     * specific path prefix which overrides the default for this call only.</span>
<a href="#l23.488"></a><span id="l23.488" class="difflineplus">+     * Useful for hitting different Matrix Client-Server versions.</span>
<a href="#l23.489"></a><span id="l23.489" class="difflineplus">+     * @param {Function} callback Optional. The callback to invoke on</span>
<a href="#l23.490"></a><span id="l23.490" class="difflineplus">+     * success/failure. See the promise return values for more information.</span>
<a href="#l23.491"></a><span id="l23.491" class="difflineplus">+     * @param {string} method The HTTP method e.g. &quot;GET&quot;.</span>
<a href="#l23.492"></a><span id="l23.492" class="difflineplus">+     * @param {string} path The HTTP path &lt;b&gt;after&lt;/b&gt; the supplied prefix e.g.</span>
<a href="#l23.493"></a><span id="l23.493" class="difflineplus">+     * &quot;/createRoom&quot;.</span>
<a href="#l23.494"></a><span id="l23.494" class="difflineplus">+     * @param {Object} queryParams A dict of query params (these will NOT be</span>
<a href="#l23.495"></a><span id="l23.495" class="difflineplus">+     * urlencoded).</span>
<a href="#l23.496"></a><span id="l23.496" class="difflineplus">+     * @param {Object} data The HTTP JSON body.</span>
<a href="#l23.497"></a><span id="l23.497" class="difflineplus">+     * @param {string} prefix The full prefix to use e.g.</span>
<a href="#l23.498"></a><span id="l23.498" class="difflineplus">+     * &quot;/_matrix/client/v2_alpha&quot;.</span>
<a href="#l23.499"></a><span id="l23.499" class="difflineplus">+     * @param {Number=} localTimeoutMs The maximum amount of time to wait before</span>
<a href="#l23.500"></a><span id="l23.500" class="difflineplus">+     * timing out the request. If not specified, there is no timeout.</span>
<a href="#l23.501"></a><span id="l23.501" class="difflineplus">+     * @return {module:client.Promise} Resolves to &lt;code&gt;{data: {Object},</span>
<a href="#l23.502"></a><span id="l23.502" class="difflineplus">+     * headers: {Object}, code: {Number}}&lt;/code&gt;.</span>
<a href="#l23.503"></a><span id="l23.503" class="difflineplus">+     * If &lt;code&gt;onlyData&lt;/code&gt; is set, this will resolve to the &lt;code&gt;data&lt;/code&gt;</span>
<a href="#l23.504"></a><span id="l23.504" class="difflineplus">+     * object only.</span>
<a href="#l23.505"></a><span id="l23.505" class="difflineplus">+     * @return {module:http-api.MatrixError} Rejects with an error if a problem</span>
<a href="#l23.506"></a><span id="l23.506" class="difflineplus">+     * occurred. This includes network problems and Matrix-specific error JSON.</span>
<a href="#l23.507"></a><span id="l23.507" class="difflineplus">+     *</span>
<a href="#l23.508"></a><span id="l23.508" class="difflineplus">+     * @deprecated prefer request with opts.prefix</span>
<a href="#l23.509"></a><span id="l23.509" class="difflineplus">+     */</span>
<a href="#l23.510"></a><span id="l23.510" class="difflineplus">+    requestWithPrefix: function(callback, method, path, queryParams, data, prefix,</span>
<a href="#l23.511"></a><span id="l23.511" class="difflineplus">+                                localTimeoutMs) {</span>
<a href="#l23.512"></a><span id="l23.512" class="difflineplus">+        return this.request(</span>
<a href="#l23.513"></a><span id="l23.513" class="difflineplus">+            callback, method, path, queryParams, data, {</span>
<a href="#l23.514"></a><span id="l23.514" class="difflineplus">+                localTimeoutMs: localTimeoutMs,</span>
<a href="#l23.515"></a><span id="l23.515" class="difflineplus">+                prefix: prefix,</span>
<a href="#l23.516"></a><span id="l23.516" class="difflineplus">+            }</span>
<a href="#l23.517"></a><span id="l23.517" class="difflineplus">+        );</span>
<a href="#l23.518"></a><span id="l23.518" class="difflineplus">+    },</span>
<a href="#l23.519"></a><span id="l23.519" class="difflineplus">+</span>
<a href="#l23.520"></a><span id="l23.520" class="difflineplus">+    /**</span>
<a href="#l23.521"></a><span id="l23.521" class="difflineplus">+     * Perform a request to an arbitrary URL.</span>
<a href="#l23.522"></a><span id="l23.522" class="difflineplus">+     * @param {Function} callback Optional. The callback to invoke on</span>
<a href="#l23.523"></a><span id="l23.523" class="difflineplus">+     * success/failure. See the promise return values for more information.</span>
<a href="#l23.524"></a><span id="l23.524" class="difflineplus">+     * @param {string} method The HTTP method e.g. &quot;GET&quot;.</span>
<a href="#l23.525"></a><span id="l23.525" class="difflineplus">+     * @param {string} uri The HTTP URI</span>
<a href="#l23.526"></a><span id="l23.526" class="difflineplus">+     *</span>
<a href="#l23.527"></a><span id="l23.527" class="difflineplus">+     * @param {Object=} queryParams A dict of query params (these will NOT be</span>
<a href="#l23.528"></a><span id="l23.528" class="difflineplus">+     * urlencoded). If unspecified, there will be no query params.</span>
<a href="#l23.529"></a><span id="l23.529" class="difflineplus">+     *</span>
<a href="#l23.530"></a><span id="l23.530" class="difflineplus">+     * @param {Object} data The HTTP JSON body.</span>
<a href="#l23.531"></a><span id="l23.531" class="difflineplus">+     *</span>
<a href="#l23.532"></a><span id="l23.532" class="difflineplus">+     * @param {Object=} opts additional options</span>
<a href="#l23.533"></a><span id="l23.533" class="difflineplus">+     *</span>
<a href="#l23.534"></a><span id="l23.534" class="difflineplus">+     * @param {Number=} opts.localTimeoutMs The maximum amount of time to wait before</span>
<a href="#l23.535"></a><span id="l23.535" class="difflineplus">+     * timing out the request. If not specified, there is no timeout.</span>
<a href="#l23.536"></a><span id="l23.536" class="difflineplus">+     *</span>
<a href="#l23.537"></a><span id="l23.537" class="difflineplus">+     * @param {sting=} opts.prefix The full prefix to use e.g.</span>
<a href="#l23.538"></a><span id="l23.538" class="difflineplus">+     * &quot;/_matrix/client/v2_alpha&quot;. If not specified, uses this.opts.prefix.</span>
<a href="#l23.539"></a><span id="l23.539" class="difflineplus">+     *</span>
<a href="#l23.540"></a><span id="l23.540" class="difflineplus">+     * @param {Object=} opts.headers map of additional request headers</span>
<a href="#l23.541"></a><span id="l23.541" class="difflineplus">+     *</span>
<a href="#l23.542"></a><span id="l23.542" class="difflineplus">+     * @return {module:client.Promise} Resolves to &lt;code&gt;{data: {Object},</span>
<a href="#l23.543"></a><span id="l23.543" class="difflineplus">+     * headers: {Object}, code: {Number}}&lt;/code&gt;.</span>
<a href="#l23.544"></a><span id="l23.544" class="difflineplus">+     * If &lt;code&gt;onlyData&lt;/code&gt; is set, this will resolve to the &lt;code&gt;data&lt;/code&gt;</span>
<a href="#l23.545"></a><span id="l23.545" class="difflineplus">+     * object only.</span>
<a href="#l23.546"></a><span id="l23.546" class="difflineplus">+     * @return {module:http-api.MatrixError} Rejects with an error if a problem</span>
<a href="#l23.547"></a><span id="l23.547" class="difflineplus">+     * occurred. This includes network problems and Matrix-specific error JSON.</span>
<a href="#l23.548"></a><span id="l23.548" class="difflineplus">+     */</span>
<a href="#l23.549"></a><span id="l23.549" class="difflineplus">+    requestOtherUrl: function(callback, method, uri, queryParams, data,</span>
<a href="#l23.550"></a><span id="l23.550" class="difflineplus">+                              opts) {</span>
<a href="#l23.551"></a><span id="l23.551" class="difflineplus">+        if (opts === undefined || opts === null) {</span>
<a href="#l23.552"></a><span id="l23.552" class="difflineplus">+            opts = {};</span>
<a href="#l23.553"></a><span id="l23.553" class="difflineplus">+        } else if (isFinite(opts)) {</span>
<a href="#l23.554"></a><span id="l23.554" class="difflineplus">+            // opts used to be localTimeoutMs</span>
<a href="#l23.555"></a><span id="l23.555" class="difflineplus">+            opts = {</span>
<a href="#l23.556"></a><span id="l23.556" class="difflineplus">+                localTimeoutMs: opts</span>
<a href="#l23.557"></a><span id="l23.557" class="difflineplus">+            };</span>
<a href="#l23.558"></a><span id="l23.558" class="difflineplus">+        }</span>
<a href="#l23.559"></a><span id="l23.559" class="difflineplus">+</span>
<a href="#l23.560"></a><span id="l23.560" class="difflineplus">+        return this._request(</span>
<a href="#l23.561"></a><span id="l23.561" class="difflineplus">+            callback, method, uri, queryParams, data, opts</span>
<a href="#l23.562"></a><span id="l23.562" class="difflineplus">+        );</span>
<a href="#l23.563"></a><span id="l23.563" class="difflineplus">+    },</span>
<a href="#l23.564"></a><span id="l23.564" class="difflineplus">+</span>
<a href="#l23.565"></a><span id="l23.565" class="difflineplus">+    /**</span>
<a href="#l23.566"></a><span id="l23.566" class="difflineplus">+     * Form and return a homeserver request URL based on the given path</span>
<a href="#l23.567"></a><span id="l23.567" class="difflineplus">+     * params and prefix.</span>
<a href="#l23.568"></a><span id="l23.568" class="difflineplus">+     * @param {string} path The HTTP path &lt;b&gt;after&lt;/b&gt; the supplied prefix e.g.</span>
<a href="#l23.569"></a><span id="l23.569" class="difflineplus">+     * &quot;/createRoom&quot;.</span>
<a href="#l23.570"></a><span id="l23.570" class="difflineplus">+     * @param {Object} queryParams A dict of query params (these will NOT be</span>
<a href="#l23.571"></a><span id="l23.571" class="difflineplus">+     * urlencoded).</span>
<a href="#l23.572"></a><span id="l23.572" class="difflineplus">+     * @param {string} prefix The full prefix to use e.g.</span>
<a href="#l23.573"></a><span id="l23.573" class="difflineplus">+     * &quot;/_matrix/client/v2_alpha&quot;.</span>
<a href="#l23.574"></a><span id="l23.574" class="difflineplus">+     * @return {string} URL</span>
<a href="#l23.575"></a><span id="l23.575" class="difflineplus">+     */</span>
<a href="#l23.576"></a><span id="l23.576" class="difflineplus">+    getUrl: function(path, queryParams, prefix) {</span>
<a href="#l23.577"></a><span id="l23.577" class="difflineplus">+        var queryString = &quot;&quot;;</span>
<a href="#l23.578"></a><span id="l23.578" class="difflineplus">+        if (queryParams) {</span>
<a href="#l23.579"></a><span id="l23.579" class="difflineplus">+            queryString = &quot;?&quot; + utils.encodeParams(queryParams);</span>
<a href="#l23.580"></a><span id="l23.580" class="difflineplus">+        }</span>
<a href="#l23.581"></a><span id="l23.581" class="difflineplus">+        return this.opts.baseUrl + prefix + path + queryString;</span>
<a href="#l23.582"></a><span id="l23.582" class="difflineplus">+    },</span>
<a href="#l23.583"></a><span id="l23.583" class="difflineplus">+</span>
<a href="#l23.584"></a><span id="l23.584" class="difflineplus">+    /**</span>
<a href="#l23.585"></a><span id="l23.585" class="difflineplus">+     * @private</span>
<a href="#l23.586"></a><span id="l23.586" class="difflineplus">+     *</span>
<a href="#l23.587"></a><span id="l23.587" class="difflineplus">+     * @param {function} callback</span>
<a href="#l23.588"></a><span id="l23.588" class="difflineplus">+     * @param {string} method</span>
<a href="#l23.589"></a><span id="l23.589" class="difflineplus">+     * @param {string} uri</span>
<a href="#l23.590"></a><span id="l23.590" class="difflineplus">+     * @param {object} queryParams</span>
<a href="#l23.591"></a><span id="l23.591" class="difflineplus">+     * @param {object|string} data</span>
<a href="#l23.592"></a><span id="l23.592" class="difflineplus">+     * @param {object=} opts</span>
<a href="#l23.593"></a><span id="l23.593" class="difflineplus">+     *</span>
<a href="#l23.594"></a><span id="l23.594" class="difflineplus">+     * @param {boolean} [opts.json =true] Json-encode data before sending, and</span>
<a href="#l23.595"></a><span id="l23.595" class="difflineplus">+     *   decode response on receipt. (We will still json-decode error</span>
<a href="#l23.596"></a><span id="l23.596" class="difflineplus">+     *   responses, even if this is false.)</span>
<a href="#l23.597"></a><span id="l23.597" class="difflineplus">+     *</span>
<a href="#l23.598"></a><span id="l23.598" class="difflineplus">+     * @param {object=} opts.headers  extra request headers</span>
<a href="#l23.599"></a><span id="l23.599" class="difflineplus">+     *</span>
<a href="#l23.600"></a><span id="l23.600" class="difflineplus">+     * @param {number=} opts.localTimeoutMs client-side timeout for the</span>
<a href="#l23.601"></a><span id="l23.601" class="difflineplus">+     *    request. No timeout if undefined.</span>
<a href="#l23.602"></a><span id="l23.602" class="difflineplus">+     *</span>
<a href="#l23.603"></a><span id="l23.603" class="difflineplus">+     * @param {function=} opts.bodyParser function to parse the body of the</span>
<a href="#l23.604"></a><span id="l23.604" class="difflineplus">+     *    response before passing it to the promise and callback.</span>
<a href="#l23.605"></a><span id="l23.605" class="difflineplus">+     *</span>
<a href="#l23.606"></a><span id="l23.606" class="difflineplus">+     * @return {module:client.Promise} a promise which resolves to either the</span>
<a href="#l23.607"></a><span id="l23.607" class="difflineplus">+     * response object (if this.opts.onlyData is truthy), or the parsed</span>
<a href="#l23.608"></a><span id="l23.608" class="difflineplus">+     * body. Rejects</span>
<a href="#l23.609"></a><span id="l23.609" class="difflineplus">+     */</span>
<a href="#l23.610"></a><span id="l23.610" class="difflineplus">+    _request: function(callback, method, uri, queryParams, data, opts) {</span>
<a href="#l23.611"></a><span id="l23.611" class="difflineplus">+        if (callback !== undefined &amp;&amp; !utils.isFunction(callback)) {</span>
<a href="#l23.612"></a><span id="l23.612" class="difflineplus">+            throw Error(</span>
<a href="#l23.613"></a><span id="l23.613" class="difflineplus">+                &quot;Expected callback to be a function but got &quot; + typeof callback</span>
<a href="#l23.614"></a><span id="l23.614" class="difflineplus">+            );</span>
<a href="#l23.615"></a><span id="l23.615" class="difflineplus">+        }</span>
<a href="#l23.616"></a><span id="l23.616" class="difflineplus">+        opts = opts || {};</span>
<a href="#l23.617"></a><span id="l23.617" class="difflineplus">+</span>
<a href="#l23.618"></a><span id="l23.618" class="difflineplus">+        var self = this;</span>
<a href="#l23.619"></a><span id="l23.619" class="difflineplus">+        if (this.opts.extraParams) {</span>
<a href="#l23.620"></a><span id="l23.620" class="difflineplus">+            for (var key in this.opts.extraParams) {</span>
<a href="#l23.621"></a><span id="l23.621" class="difflineplus">+                if (!this.opts.extraParams.hasOwnProperty(key)) { continue; }</span>
<a href="#l23.622"></a><span id="l23.622" class="difflineplus">+                queryParams[key] = this.opts.extraParams[key];</span>
<a href="#l23.623"></a><span id="l23.623" class="difflineplus">+            }</span>
<a href="#l23.624"></a><span id="l23.624" class="difflineplus">+        }</span>
<a href="#l23.625"></a><span id="l23.625" class="difflineplus">+</span>
<a href="#l23.626"></a><span id="l23.626" class="difflineplus">+        var json = opts.json === undefined ? true : opts.json;</span>
<a href="#l23.627"></a><span id="l23.627" class="difflineplus">+</span>
<a href="#l23.628"></a><span id="l23.628" class="difflineplus">+        var defer = q.defer();</span>
<a href="#l23.629"></a><span id="l23.629" class="difflineplus">+</span>
<a href="#l23.630"></a><span id="l23.630" class="difflineplus">+        var timeoutId;</span>
<a href="#l23.631"></a><span id="l23.631" class="difflineplus">+        var timedOut = false;</span>
<a href="#l23.632"></a><span id="l23.632" class="difflineplus">+        var req;</span>
<a href="#l23.633"></a><span id="l23.633" class="difflineplus">+        var localTimeoutMs = opts.localTimeoutMs;</span>
<a href="#l23.634"></a><span id="l23.634" class="difflineplus">+        if (localTimeoutMs) {</span>
<a href="#l23.635"></a><span id="l23.635" class="difflineplus">+            timeoutId = callbacks.setTimeout(function() {</span>
<a href="#l23.636"></a><span id="l23.636" class="difflineplus">+                timedOut = true;</span>
<a href="#l23.637"></a><span id="l23.637" class="difflineplus">+                if (req &amp;&amp; req.abort) {</span>
<a href="#l23.638"></a><span id="l23.638" class="difflineplus">+                    req.abort();</span>
<a href="#l23.639"></a><span id="l23.639" class="difflineplus">+                }</span>
<a href="#l23.640"></a><span id="l23.640" class="difflineplus">+                defer.reject(new module.exports.MatrixError({</span>
<a href="#l23.641"></a><span id="l23.641" class="difflineplus">+                    error: &quot;Locally timed out waiting for a response&quot;,</span>
<a href="#l23.642"></a><span id="l23.642" class="difflineplus">+                    errcode: &quot;ORG.MATRIX.JSSDK_TIMEOUT&quot;,</span>
<a href="#l23.643"></a><span id="l23.643" class="difflineplus">+                    timeout: localTimeoutMs</span>
<a href="#l23.644"></a><span id="l23.644" class="difflineplus">+                }));</span>
<a href="#l23.645"></a><span id="l23.645" class="difflineplus">+            }, localTimeoutMs);</span>
<a href="#l23.646"></a><span id="l23.646" class="difflineplus">+        }</span>
<a href="#l23.647"></a><span id="l23.647" class="difflineplus">+</span>
<a href="#l23.648"></a><span id="l23.648" class="difflineplus">+        var reqPromise = defer.promise;</span>
<a href="#l23.649"></a><span id="l23.649" class="difflineplus">+</span>
<a href="#l23.650"></a><span id="l23.650" class="difflineplus">+        try {</span>
<a href="#l23.651"></a><span id="l23.651" class="difflineplus">+            req = this.opts.request(</span>
<a href="#l23.652"></a><span id="l23.652" class="difflineplus">+                {</span>
<a href="#l23.653"></a><span id="l23.653" class="difflineplus">+                    uri: uri,</span>
<a href="#l23.654"></a><span id="l23.654" class="difflineplus">+                    method: method,</span>
<a href="#l23.655"></a><span id="l23.655" class="difflineplus">+                    withCredentials: false,</span>
<a href="#l23.656"></a><span id="l23.656" class="difflineplus">+                    qs: queryParams,</span>
<a href="#l23.657"></a><span id="l23.657" class="difflineplus">+                    body: data,</span>
<a href="#l23.658"></a><span id="l23.658" class="difflineplus">+                    json: json,</span>
<a href="#l23.659"></a><span id="l23.659" class="difflineplus">+                    timeout: localTimeoutMs,</span>
<a href="#l23.660"></a><span id="l23.660" class="difflineplus">+                    headers: opts.headers || {},</span>
<a href="#l23.661"></a><span id="l23.661" class="difflineplus">+                    _matrix_opts: this.opts</span>
<a href="#l23.662"></a><span id="l23.662" class="difflineplus">+                },</span>
<a href="#l23.663"></a><span id="l23.663" class="difflineplus">+                function(err, response, body) {</span>
<a href="#l23.664"></a><span id="l23.664" class="difflineplus">+                    if (localTimeoutMs) {</span>
<a href="#l23.665"></a><span id="l23.665" class="difflineplus">+                        callbacks.clearTimeout(timeoutId);</span>
<a href="#l23.666"></a><span id="l23.666" class="difflineplus">+                        if (timedOut) {</span>
<a href="#l23.667"></a><span id="l23.667" class="difflineplus">+                            return; // already rejected promise</span>
<a href="#l23.668"></a><span id="l23.668" class="difflineplus">+                        }</span>
<a href="#l23.669"></a><span id="l23.669" class="difflineplus">+                    }</span>
<a href="#l23.670"></a><span id="l23.670" class="difflineplus">+</span>
<a href="#l23.671"></a><span id="l23.671" class="difflineplus">+                    // if json is falsy, we won't parse any error response, so need</span>
<a href="#l23.672"></a><span id="l23.672" class="difflineplus">+                    // to do so before turning it into a MatrixError</span>
<a href="#l23.673"></a><span id="l23.673" class="difflineplus">+                    var parseErrorJson = !json;</span>
<a href="#l23.674"></a><span id="l23.674" class="difflineplus">+                    var handlerFn = requestCallback(</span>
<a href="#l23.675"></a><span id="l23.675" class="difflineplus">+                        defer, callback, self.opts.onlyData,</span>
<a href="#l23.676"></a><span id="l23.676" class="difflineplus">+                        parseErrorJson,</span>
<a href="#l23.677"></a><span id="l23.677" class="difflineplus">+                        opts.bodyParser</span>
<a href="#l23.678"></a><span id="l23.678" class="difflineplus">+                    );</span>
<a href="#l23.679"></a><span id="l23.679" class="difflineplus">+                    handlerFn(err, response, body);</span>
<a href="#l23.680"></a><span id="l23.680" class="difflineplus">+                }</span>
<a href="#l23.681"></a><span id="l23.681" class="difflineplus">+            );</span>
<a href="#l23.682"></a><span id="l23.682" class="difflineplus">+            if (req &amp;&amp; req.abort) {</span>
<a href="#l23.683"></a><span id="l23.683" class="difflineplus">+                // FIXME: This is EVIL, but I can't think of a better way to expose</span>
<a href="#l23.684"></a><span id="l23.684" class="difflineplus">+                // abort() operations on underlying HTTP requests :(</span>
<a href="#l23.685"></a><span id="l23.685" class="difflineplus">+                reqPromise.abort = req.abort.bind(req);</span>
<a href="#l23.686"></a><span id="l23.686" class="difflineplus">+            }</span>
<a href="#l23.687"></a><span id="l23.687" class="difflineplus">+        }</span>
<a href="#l23.688"></a><span id="l23.688" class="difflineplus">+        catch (ex) {</span>
<a href="#l23.689"></a><span id="l23.689" class="difflineplus">+            defer.reject(ex);</span>
<a href="#l23.690"></a><span id="l23.690" class="difflineplus">+            if (callback) {</span>
<a href="#l23.691"></a><span id="l23.691" class="difflineplus">+                callback(ex);</span>
<a href="#l23.692"></a><span id="l23.692" class="difflineplus">+            }</span>
<a href="#l23.693"></a><span id="l23.693" class="difflineplus">+        }</span>
<a href="#l23.694"></a><span id="l23.694" class="difflineplus">+        return reqPromise;</span>
<a href="#l23.695"></a><span id="l23.695" class="difflineplus">+    }</span>
<a href="#l23.696"></a><span id="l23.696" class="difflineplus">+};</span>
<a href="#l23.697"></a><span id="l23.697" class="difflineplus">+</span>
<a href="#l23.698"></a><span id="l23.698" class="difflineplus">+/*</span>
<a href="#l23.699"></a><span id="l23.699" class="difflineplus">+ * Returns a callback that can be invoked by an HTTP request on completion,</span>
<a href="#l23.700"></a><span id="l23.700" class="difflineplus">+ * that will either resolve or reject the given defer as well as invoke the</span>
<a href="#l23.701"></a><span id="l23.701" class="difflineplus">+ * given userDefinedCallback (if any).</span>
<a href="#l23.702"></a><span id="l23.702" class="difflineplus">+ *</span>
<a href="#l23.703"></a><span id="l23.703" class="difflineplus">+ * If onlyData is true, the defer/callback is invoked with the body of the</span>
<a href="#l23.704"></a><span id="l23.704" class="difflineplus">+ * response, otherwise the result code.</span>
<a href="#l23.705"></a><span id="l23.705" class="difflineplus">+ *</span>
<a href="#l23.706"></a><span id="l23.706" class="difflineplus">+ * If parseErrorJson is true, we will JSON.parse the body if we get a 4xx error.</span>
<a href="#l23.707"></a><span id="l23.707" class="difflineplus">+ *</span>
<a href="#l23.708"></a><span id="l23.708" class="difflineplus">+ */</span>
<a href="#l23.709"></a><span id="l23.709" class="difflineplus">+var requestCallback = function(</span>
<a href="#l23.710"></a><span id="l23.710" class="difflineplus">+    defer, userDefinedCallback, onlyData,</span>
<a href="#l23.711"></a><span id="l23.711" class="difflineplus">+    parseErrorJson, bodyParser</span>
<a href="#l23.712"></a><span id="l23.712" class="difflineplus">+) {</span>
<a href="#l23.713"></a><span id="l23.713" class="difflineplus">+    userDefinedCallback = userDefinedCallback || function() {};</span>
<a href="#l23.714"></a><span id="l23.714" class="difflineplus">+</span>
<a href="#l23.715"></a><span id="l23.715" class="difflineplus">+    return function(err, response, body) {</span>
<a href="#l23.716"></a><span id="l23.716" class="difflineplus">+        if (!err) {</span>
<a href="#l23.717"></a><span id="l23.717" class="difflineplus">+            try {</span>
<a href="#l23.718"></a><span id="l23.718" class="difflineplus">+                if (response.statusCode &gt;= 400) {</span>
<a href="#l23.719"></a><span id="l23.719" class="difflineplus">+                    if (parseErrorJson) {</span>
<a href="#l23.720"></a><span id="l23.720" class="difflineplus">+                        // we won't have json-decoded the response.</span>
<a href="#l23.721"></a><span id="l23.721" class="difflineplus">+                        body = JSON.parse(body);</span>
<a href="#l23.722"></a><span id="l23.722" class="difflineplus">+                    }</span>
<a href="#l23.723"></a><span id="l23.723" class="difflineplus">+                    err = new module.exports.MatrixError(body);</span>
<a href="#l23.724"></a><span id="l23.724" class="difflineplus">+                } else if (bodyParser) {</span>
<a href="#l23.725"></a><span id="l23.725" class="difflineplus">+                    body = bodyParser(body);</span>
<a href="#l23.726"></a><span id="l23.726" class="difflineplus">+                }</span>
<a href="#l23.727"></a><span id="l23.727" class="difflineplus">+            } catch (e) {</span>
<a href="#l23.728"></a><span id="l23.728" class="difflineplus">+                err = e;</span>
<a href="#l23.729"></a><span id="l23.729" class="difflineplus">+            }</span>
<a href="#l23.730"></a><span id="l23.730" class="difflineplus">+            if (err) {</span>
<a href="#l23.731"></a><span id="l23.731" class="difflineplus">+                err.httpStatus = response.statusCode;</span>
<a href="#l23.732"></a><span id="l23.732" class="difflineplus">+            }</span>
<a href="#l23.733"></a><span id="l23.733" class="difflineplus">+        }</span>
<a href="#l23.734"></a><span id="l23.734" class="difflineplus">+</span>
<a href="#l23.735"></a><span id="l23.735" class="difflineplus">+        if (err) {</span>
<a href="#l23.736"></a><span id="l23.736" class="difflineplus">+            defer.reject(err);</span>
<a href="#l23.737"></a><span id="l23.737" class="difflineplus">+            userDefinedCallback(err);</span>
<a href="#l23.738"></a><span id="l23.738" class="difflineplus">+        }</span>
<a href="#l23.739"></a><span id="l23.739" class="difflineplus">+        else {</span>
<a href="#l23.740"></a><span id="l23.740" class="difflineplus">+            var res = {</span>
<a href="#l23.741"></a><span id="l23.741" class="difflineplus">+                code: response.statusCode,</span>
<a href="#l23.742"></a><span id="l23.742" class="difflineplus">+                headers: response.headers,</span>
<a href="#l23.743"></a><span id="l23.743" class="difflineplus">+                data: body</span>
<a href="#l23.744"></a><span id="l23.744" class="difflineplus">+            };</span>
<a href="#l23.745"></a><span id="l23.745" class="difflineplus">+            defer.resolve(onlyData ? body : res);</span>
<a href="#l23.746"></a><span id="l23.746" class="difflineplus">+            userDefinedCallback(null, onlyData ? body : res);</span>
<a href="#l23.747"></a><span id="l23.747" class="difflineplus">+        }</span>
<a href="#l23.748"></a><span id="l23.748" class="difflineplus">+    };</span>
<a href="#l23.749"></a><span id="l23.749" class="difflineplus">+};</span>
<a href="#l23.750"></a><span id="l23.750" class="difflineplus">+</span>
<a href="#l23.751"></a><span id="l23.751" class="difflineplus">+/**</span>
<a href="#l23.752"></a><span id="l23.752" class="difflineplus">+ * Construct a Matrix error. This is a JavaScript Error with additional</span>
<a href="#l23.753"></a><span id="l23.753" class="difflineplus">+ * information specific to the standard Matrix error response.</span>
<a href="#l23.754"></a><span id="l23.754" class="difflineplus">+ * @constructor</span>
<a href="#l23.755"></a><span id="l23.755" class="difflineplus">+ * @param {Object} errorJson The Matrix error JSON returned from the homeserver.</span>
<a href="#l23.756"></a><span id="l23.756" class="difflineplus">+ * @prop {string} errcode The Matrix 'errcode' value, e.g. &quot;M_FORBIDDEN&quot;.</span>
<a href="#l23.757"></a><span id="l23.757" class="difflineplus">+ * @prop {string} name Same as MatrixError.errcode but with a default unknown string.</span>
<a href="#l23.758"></a><span id="l23.758" class="difflineplus">+ * @prop {string} message The Matrix 'error' value, e.g. &quot;Missing token.&quot;</span>
<a href="#l23.759"></a><span id="l23.759" class="difflineplus">+ * @prop {Object} data The raw Matrix error JSON used to construct this object.</span>
<a href="#l23.760"></a><span id="l23.760" class="difflineplus">+ * @prop {integer} httpStatus The numeric HTTP status code given</span>
<a href="#l23.761"></a><span id="l23.761" class="difflineplus">+ */</span>
<a href="#l23.762"></a><span id="l23.762" class="difflineplus">+module.exports.MatrixError = function MatrixError(errorJson) {</span>
<a href="#l23.763"></a><span id="l23.763" class="difflineplus">+    errorJson = errorJson || {};</span>
<a href="#l23.764"></a><span id="l23.764" class="difflineplus">+    this.errcode = errorJson.errcode;</span>
<a href="#l23.765"></a><span id="l23.765" class="difflineplus">+    this.name = errorJson.errcode || &quot;Unknown error code&quot;;</span>
<a href="#l23.766"></a><span id="l23.766" class="difflineplus">+    this.message = errorJson.error || &quot;Unknown message&quot;;</span>
<a href="#l23.767"></a><span id="l23.767" class="difflineplus">+    this.data = errorJson;</span>
<a href="#l23.768"></a><span id="l23.768" class="difflineplus">+};</span>
<a href="#l23.769"></a><span id="l23.769" class="difflineplus">+module.exports.MatrixError.prototype = Object.create(Error.prototype);</span>
<a href="#l23.770"></a><span id="l23.770" class="difflineplus">+/** */</span>
<a href="#l23.771"></a><span id="l23.771" class="difflineplus">+module.exports.MatrixError.prototype.constructor = module.exports.MatrixError;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1">new file mode 100644</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineminus">--- /dev/null</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineplus">+++ b/chat/protocols/matrix/matrix-sdk/interactive-auth.js</span>
<a href="#l24.4"></a><span id="l24.4" class="difflineat">@@ -0,0 +1,228 @@</span>
<a href="#l24.5"></a><span id="l24.5" class="difflineplus">+/*</span>
<a href="#l24.6"></a><span id="l24.6" class="difflineplus">+Copyright 2016 OpenMarket Ltd</span>
<a href="#l24.7"></a><span id="l24.7" class="difflineplus">+</span>
<a href="#l24.8"></a><span id="l24.8" class="difflineplus">+Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<a href="#l24.9"></a><span id="l24.9" class="difflineplus">+you may not use this file except in compliance with the License.</span>
<a href="#l24.10"></a><span id="l24.10" class="difflineplus">+You may obtain a copy of the License at</span>
<a href="#l24.11"></a><span id="l24.11" class="difflineplus">+</span>
<a href="#l24.12"></a><span id="l24.12" class="difflineplus">+    http://www.apache.org/licenses/LICENSE-2.0</span>
<a href="#l24.13"></a><span id="l24.13" class="difflineplus">+</span>
<a href="#l24.14"></a><span id="l24.14" class="difflineplus">+Unless required by applicable law or agreed to in writing, software</span>
<a href="#l24.15"></a><span id="l24.15" class="difflineplus">+distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<a href="#l24.16"></a><span id="l24.16" class="difflineplus">+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<a href="#l24.17"></a><span id="l24.17" class="difflineplus">+See the License for the specific language governing permissions and</span>
<a href="#l24.18"></a><span id="l24.18" class="difflineplus">+limitations under the License.</span>
<a href="#l24.19"></a><span id="l24.19" class="difflineplus">+*/</span>
<a href="#l24.20"></a><span id="l24.20" class="difflineplus">+&quot;use strict&quot;;</span>
<a href="#l24.21"></a><span id="l24.21" class="difflineplus">+</span>
<a href="#l24.22"></a><span id="l24.22" class="difflineplus">+/** @module interactive-auth */</span>
<a href="#l24.23"></a><span id="l24.23" class="difflineplus">+var q = require(&quot;q&quot;);</span>
<a href="#l24.24"></a><span id="l24.24" class="difflineplus">+</span>
<a href="#l24.25"></a><span id="l24.25" class="difflineplus">+var utils = require(&quot;./utils&quot;);</span>
<a href="#l24.26"></a><span id="l24.26" class="difflineplus">+</span>
<a href="#l24.27"></a><span id="l24.27" class="difflineplus">+/**</span>
<a href="#l24.28"></a><span id="l24.28" class="difflineplus">+ * Abstracts the logic used to drive the interactive auth process.</span>
<a href="#l24.29"></a><span id="l24.29" class="difflineplus">+ *</span>
<a href="#l24.30"></a><span id="l24.30" class="difflineplus">+ * &lt;p&gt;Components implementing an interactive auth flow should instantiate one of</span>
<a href="#l24.31"></a><span id="l24.31" class="difflineplus">+ * these, passing in the necessary callbacks to the constructor. They should</span>
<a href="#l24.32"></a><span id="l24.32" class="difflineplus">+ * then call attemptAuth, which will return a promise which will resolve or</span>
<a href="#l24.33"></a><span id="l24.33" class="difflineplus">+ * reject when the interactive-auth process completes.</span>
<a href="#l24.34"></a><span id="l24.34" class="difflineplus">+ *</span>
<a href="#l24.35"></a><span id="l24.35" class="difflineplus">+ * &lt;p&gt;Meanwhile, calls will be made to the startAuthStage and doRequest</span>
<a href="#l24.36"></a><span id="l24.36" class="difflineplus">+ * callbacks, and information gathered from the user can be submitted with</span>
<a href="#l24.37"></a><span id="l24.37" class="difflineplus">+ * submitAuthDict.</span>
<a href="#l24.38"></a><span id="l24.38" class="difflineplus">+ *</span>
<a href="#l24.39"></a><span id="l24.39" class="difflineplus">+ * @constructor</span>
<a href="#l24.40"></a><span id="l24.40" class="difflineplus">+ * @alias module:interactive-auth</span>
<a href="#l24.41"></a><span id="l24.41" class="difflineplus">+ *</span>
<a href="#l24.42"></a><span id="l24.42" class="difflineplus">+ * @param {object} opts  options object</span>
<a href="#l24.43"></a><span id="l24.43" class="difflineplus">+ *</span>
<a href="#l24.44"></a><span id="l24.44" class="difflineplus">+ * @param {object?} opts.authData error response from the last request. If</span>
<a href="#l24.45"></a><span id="l24.45" class="difflineplus">+ *    null, a request will be made with no auth before starting.</span>
<a href="#l24.46"></a><span id="l24.46" class="difflineplus">+ *</span>
<a href="#l24.47"></a><span id="l24.47" class="difflineplus">+ * @param {function(object?): module:client.Promise} opts.doRequest</span>
<a href="#l24.48"></a><span id="l24.48" class="difflineplus">+ *     called with the new auth dict to submit the request. Should return a</span>
<a href="#l24.49"></a><span id="l24.49" class="difflineplus">+ *     promise which resolves to the successful response or rejects with a</span>
<a href="#l24.50"></a><span id="l24.50" class="difflineplus">+ *     MatrixError.</span>
<a href="#l24.51"></a><span id="l24.51" class="difflineplus">+ *</span>
<a href="#l24.52"></a><span id="l24.52" class="difflineplus">+ * @param {function(string, object?)} opts.startAuthStage</span>
<a href="#l24.53"></a><span id="l24.53" class="difflineplus">+ *     called to ask the UI to start a particular auth stage. The arguments</span>
<a href="#l24.54"></a><span id="l24.54" class="difflineplus">+ *     are: the login type (eg m.login.password); and (if the last request</span>
<a href="#l24.55"></a><span id="l24.55" class="difflineplus">+ *     returned an error), an error object, with fields 'errcode' and 'error'.</span>
<a href="#l24.56"></a><span id="l24.56" class="difflineplus">+ *</span>
<a href="#l24.57"></a><span id="l24.57" class="difflineplus">+ */</span>
<a href="#l24.58"></a><span id="l24.58" class="difflineplus">+function InteractiveAuth(opts) {</span>
<a href="#l24.59"></a><span id="l24.59" class="difflineplus">+    this._data = opts.authData;</span>
<a href="#l24.60"></a><span id="l24.60" class="difflineplus">+    this._requestCallback = opts.doRequest;</span>
<a href="#l24.61"></a><span id="l24.61" class="difflineplus">+    this._startAuthStageCallback = opts.startAuthStage;</span>
<a href="#l24.62"></a><span id="l24.62" class="difflineplus">+    this._completionDeferred = null;</span>
<a href="#l24.63"></a><span id="l24.63" class="difflineplus">+}</span>
<a href="#l24.64"></a><span id="l24.64" class="difflineplus">+</span>
<a href="#l24.65"></a><span id="l24.65" class="difflineplus">+InteractiveAuth.prototype = {</span>
<a href="#l24.66"></a><span id="l24.66" class="difflineplus">+    /**</span>
<a href="#l24.67"></a><span id="l24.67" class="difflineplus">+     * begin the authentication process.</span>
<a href="#l24.68"></a><span id="l24.68" class="difflineplus">+     *</span>
<a href="#l24.69"></a><span id="l24.69" class="difflineplus">+     * @return {module:client.Promise}  which resolves to the response on success,</span>
<a href="#l24.70"></a><span id="l24.70" class="difflineplus">+     * or rejects with the error on failure.</span>
<a href="#l24.71"></a><span id="l24.71" class="difflineplus">+     */</span>
<a href="#l24.72"></a><span id="l24.72" class="difflineplus">+    attemptAuth: function() {</span>
<a href="#l24.73"></a><span id="l24.73" class="difflineplus">+        this._completionDeferred = q.defer();</span>
<a href="#l24.74"></a><span id="l24.74" class="difflineplus">+</span>
<a href="#l24.75"></a><span id="l24.75" class="difflineplus">+        if (!this._data) {</span>
<a href="#l24.76"></a><span id="l24.76" class="difflineplus">+            this._doRequest(null);</span>
<a href="#l24.77"></a><span id="l24.77" class="difflineplus">+        } else {</span>
<a href="#l24.78"></a><span id="l24.78" class="difflineplus">+            this._startNextAuthStage();</span>
<a href="#l24.79"></a><span id="l24.79" class="difflineplus">+        }</span>
<a href="#l24.80"></a><span id="l24.80" class="difflineplus">+</span>
<a href="#l24.81"></a><span id="l24.81" class="difflineplus">+        return this._completionDeferred.promise;</span>
<a href="#l24.82"></a><span id="l24.82" class="difflineplus">+    },</span>
<a href="#l24.83"></a><span id="l24.83" class="difflineplus">+</span>
<a href="#l24.84"></a><span id="l24.84" class="difflineplus">+    /**</span>
<a href="#l24.85"></a><span id="l24.85" class="difflineplus">+     * get the auth session ID</span>
<a href="#l24.86"></a><span id="l24.86" class="difflineplus">+     *</span>
<a href="#l24.87"></a><span id="l24.87" class="difflineplus">+     * @return {string} session id</span>
<a href="#l24.88"></a><span id="l24.88" class="difflineplus">+     */</span>
<a href="#l24.89"></a><span id="l24.89" class="difflineplus">+    getSessionId: function() {</span>
<a href="#l24.90"></a><span id="l24.90" class="difflineplus">+        return this._data ? this._data.session : undefined;</span>
<a href="#l24.91"></a><span id="l24.91" class="difflineplus">+    },</span>
<a href="#l24.92"></a><span id="l24.92" class="difflineplus">+</span>
<a href="#l24.93"></a><span id="l24.93" class="difflineplus">+    /**</span>
<a href="#l24.94"></a><span id="l24.94" class="difflineplus">+     * get the server params for a given stage</span>
<a href="#l24.95"></a><span id="l24.95" class="difflineplus">+     *</span>
<a href="#l24.96"></a><span id="l24.96" class="difflineplus">+     * @param {string}  login type for the stage</span>
<a href="#l24.97"></a><span id="l24.97" class="difflineplus">+     * @return {object?}  any parameters from the server for this stage</span>
<a href="#l24.98"></a><span id="l24.98" class="difflineplus">+     */</span>
<a href="#l24.99"></a><span id="l24.99" class="difflineplus">+    getStageParams: function(loginType) {</span>
<a href="#l24.100"></a><span id="l24.100" class="difflineplus">+        var params = {};</span>
<a href="#l24.101"></a><span id="l24.101" class="difflineplus">+        if (this._data &amp;&amp; this._data.params) {</span>
<a href="#l24.102"></a><span id="l24.102" class="difflineplus">+            params = this._data.params;</span>
<a href="#l24.103"></a><span id="l24.103" class="difflineplus">+        }</span>
<a href="#l24.104"></a><span id="l24.104" class="difflineplus">+        return params[loginType];</span>
<a href="#l24.105"></a><span id="l24.105" class="difflineplus">+    },</span>
<a href="#l24.106"></a><span id="l24.106" class="difflineplus">+</span>
<a href="#l24.107"></a><span id="l24.107" class="difflineplus">+    /**</span>
<a href="#l24.108"></a><span id="l24.108" class="difflineplus">+     * submit a new auth dict and fire off the request. This will either</span>
<a href="#l24.109"></a><span id="l24.109" class="difflineplus">+     * make attemptAuth resolve/reject, or cause the startAuthStage callback</span>
<a href="#l24.110"></a><span id="l24.110" class="difflineplus">+     * to be called for a new stage.</span>
<a href="#l24.111"></a><span id="l24.111" class="difflineplus">+     *</span>
<a href="#l24.112"></a><span id="l24.112" class="difflineplus">+     * @param {object} authData new auth dict to send to the server. Should</span>
<a href="#l24.113"></a><span id="l24.113" class="difflineplus">+     *    include a `type` propterty denoting the login type, as well as any</span>
<a href="#l24.114"></a><span id="l24.114" class="difflineplus">+     *    other params for that stage.</span>
<a href="#l24.115"></a><span id="l24.115" class="difflineplus">+     */</span>
<a href="#l24.116"></a><span id="l24.116" class="difflineplus">+    submitAuthDict: function(authData) {</span>
<a href="#l24.117"></a><span id="l24.117" class="difflineplus">+        if (!this._completionDeferred) {</span>
<a href="#l24.118"></a><span id="l24.118" class="difflineplus">+            throw new Error(&quot;submitAuthDict() called before attemptAuth()&quot;);</span>
<a href="#l24.119"></a><span id="l24.119" class="difflineplus">+        }</span>
<a href="#l24.120"></a><span id="l24.120" class="difflineplus">+</span>
<a href="#l24.121"></a><span id="l24.121" class="difflineplus">+        // use the sessionid from the last request.</span>
<a href="#l24.122"></a><span id="l24.122" class="difflineplus">+        var auth = {</span>
<a href="#l24.123"></a><span id="l24.123" class="difflineplus">+            session: this._data.session,</span>
<a href="#l24.124"></a><span id="l24.124" class="difflineplus">+        };</span>
<a href="#l24.125"></a><span id="l24.125" class="difflineplus">+        utils.extend(auth, authData);</span>
<a href="#l24.126"></a><span id="l24.126" class="difflineplus">+</span>
<a href="#l24.127"></a><span id="l24.127" class="difflineplus">+        this._doRequest(auth);</span>
<a href="#l24.128"></a><span id="l24.128" class="difflineplus">+    },</span>
<a href="#l24.129"></a><span id="l24.129" class="difflineplus">+</span>
<a href="#l24.130"></a><span id="l24.130" class="difflineplus">+    /**</span>
<a href="#l24.131"></a><span id="l24.131" class="difflineplus">+     * Fire off a request, and either resolve the promise, or call</span>
<a href="#l24.132"></a><span id="l24.132" class="difflineplus">+     * startAuthStage.</span>
<a href="#l24.133"></a><span id="l24.133" class="difflineplus">+     *</span>
<a href="#l24.134"></a><span id="l24.134" class="difflineplus">+     * @private</span>
<a href="#l24.135"></a><span id="l24.135" class="difflineplus">+     * @param {object?} auth new auth dict, including session id</span>
<a href="#l24.136"></a><span id="l24.136" class="difflineplus">+     */</span>
<a href="#l24.137"></a><span id="l24.137" class="difflineplus">+    _doRequest: function(auth) {</span>
<a href="#l24.138"></a><span id="l24.138" class="difflineplus">+        var self = this;</span>
<a href="#l24.139"></a><span id="l24.139" class="difflineplus">+</span>
<a href="#l24.140"></a><span id="l24.140" class="difflineplus">+        // hackery to make sure that synchronous exceptions end up in the catch</span>
<a href="#l24.141"></a><span id="l24.141" class="difflineplus">+        // handler (without the additional event loop entailed by q.fcall or an</span>
<a href="#l24.142"></a><span id="l24.142" class="difflineplus">+        // extra q().then)</span>
<a href="#l24.143"></a><span id="l24.143" class="difflineplus">+        var prom;</span>
<a href="#l24.144"></a><span id="l24.144" class="difflineplus">+        try {</span>
<a href="#l24.145"></a><span id="l24.145" class="difflineplus">+            prom = this._requestCallback(auth);</span>
<a href="#l24.146"></a><span id="l24.146" class="difflineplus">+        } catch (e) {</span>
<a href="#l24.147"></a><span id="l24.147" class="difflineplus">+            prom = q.reject(e);</span>
<a href="#l24.148"></a><span id="l24.148" class="difflineplus">+        }</span>
<a href="#l24.149"></a><span id="l24.149" class="difflineplus">+</span>
<a href="#l24.150"></a><span id="l24.150" class="difflineplus">+        prom.then(</span>
<a href="#l24.151"></a><span id="l24.151" class="difflineplus">+            function(result) {</span>
<a href="#l24.152"></a><span id="l24.152" class="difflineplus">+                console.log(&quot;result from request: &quot;, result);</span>
<a href="#l24.153"></a><span id="l24.153" class="difflineplus">+                self._completionDeferred.resolve(result);</span>
<a href="#l24.154"></a><span id="l24.154" class="difflineplus">+            }, function(error) {</span>
<a href="#l24.155"></a><span id="l24.155" class="difflineplus">+                if (error.httpStatus !== 401 || !error.data || !error.data.flows) {</span>
<a href="#l24.156"></a><span id="l24.156" class="difflineplus">+                    // doesn't look like an interactive-auth failure. fail the whole lot.</span>
<a href="#l24.157"></a><span id="l24.157" class="difflineplus">+                    throw error;</span>
<a href="#l24.158"></a><span id="l24.158" class="difflineplus">+                }</span>
<a href="#l24.159"></a><span id="l24.159" class="difflineplus">+                self._data = error.data;</span>
<a href="#l24.160"></a><span id="l24.160" class="difflineplus">+                self._startNextAuthStage();</span>
<a href="#l24.161"></a><span id="l24.161" class="difflineplus">+            }</span>
<a href="#l24.162"></a><span id="l24.162" class="difflineplus">+        ).catch(this._completionDeferred.reject).done();</span>
<a href="#l24.163"></a><span id="l24.163" class="difflineplus">+    },</span>
<a href="#l24.164"></a><span id="l24.164" class="difflineplus">+</span>
<a href="#l24.165"></a><span id="l24.165" class="difflineplus">+    /**</span>
<a href="#l24.166"></a><span id="l24.166" class="difflineplus">+     * Pick the next stage and call the callback</span>
<a href="#l24.167"></a><span id="l24.167" class="difflineplus">+     *</span>
<a href="#l24.168"></a><span id="l24.168" class="difflineplus">+     * @private</span>
<a href="#l24.169"></a><span id="l24.169" class="difflineplus">+     */</span>
<a href="#l24.170"></a><span id="l24.170" class="difflineplus">+    _startNextAuthStage: function() {</span>
<a href="#l24.171"></a><span id="l24.171" class="difflineplus">+        var nextStage = this._chooseStage();</span>
<a href="#l24.172"></a><span id="l24.172" class="difflineplus">+        if (!nextStage) {</span>
<a href="#l24.173"></a><span id="l24.173" class="difflineplus">+            throw new Error(&quot;No incomplete flows from the server&quot;);</span>
<a href="#l24.174"></a><span id="l24.174" class="difflineplus">+        }</span>
<a href="#l24.175"></a><span id="l24.175" class="difflineplus">+</span>
<a href="#l24.176"></a><span id="l24.176" class="difflineplus">+        var stageError = null;</span>
<a href="#l24.177"></a><span id="l24.177" class="difflineplus">+        if (this._data.errcode || this._data.error) {</span>
<a href="#l24.178"></a><span id="l24.178" class="difflineplus">+            stageError = {</span>
<a href="#l24.179"></a><span id="l24.179" class="difflineplus">+                errcode: this._data.errcode || &quot;&quot;,</span>
<a href="#l24.180"></a><span id="l24.180" class="difflineplus">+                error: this._data.error || &quot;&quot;,</span>
<a href="#l24.181"></a><span id="l24.181" class="difflineplus">+            };</span>
<a href="#l24.182"></a><span id="l24.182" class="difflineplus">+        }</span>
<a href="#l24.183"></a><span id="l24.183" class="difflineplus">+        this._startAuthStageCallback(nextStage, stageError);</span>
<a href="#l24.184"></a><span id="l24.184" class="difflineplus">+    },</span>
<a href="#l24.185"></a><span id="l24.185" class="difflineplus">+</span>
<a href="#l24.186"></a><span id="l24.186" class="difflineplus">+    /**</span>
<a href="#l24.187"></a><span id="l24.187" class="difflineplus">+     * Pick the next auth stage</span>
<a href="#l24.188"></a><span id="l24.188" class="difflineplus">+     *</span>
<a href="#l24.189"></a><span id="l24.189" class="difflineplus">+     * @private</span>
<a href="#l24.190"></a><span id="l24.190" class="difflineplus">+     * @return {string?} login type</span>
<a href="#l24.191"></a><span id="l24.191" class="difflineplus">+     */</span>
<a href="#l24.192"></a><span id="l24.192" class="difflineplus">+    _chooseStage: function() {</span>
<a href="#l24.193"></a><span id="l24.193" class="difflineplus">+        var flow = this._chooseFlow();</span>
<a href="#l24.194"></a><span id="l24.194" class="difflineplus">+        console.log(&quot;Active flow =&gt; %s&quot;, JSON.stringify(flow));</span>
<a href="#l24.195"></a><span id="l24.195" class="difflineplus">+        var nextStage = this._firstUncompletedStage(flow);</span>
<a href="#l24.196"></a><span id="l24.196" class="difflineplus">+        console.log(&quot;Next stage: %s&quot;, nextStage);</span>
<a href="#l24.197"></a><span id="l24.197" class="difflineplus">+        return nextStage;</span>
<a href="#l24.198"></a><span id="l24.198" class="difflineplus">+    },</span>
<a href="#l24.199"></a><span id="l24.199" class="difflineplus">+</span>
<a href="#l24.200"></a><span id="l24.200" class="difflineplus">+    /**</span>
<a href="#l24.201"></a><span id="l24.201" class="difflineplus">+     * Pick one of the flows from the returned list</span>
<a href="#l24.202"></a><span id="l24.202" class="difflineplus">+     *</span>
<a href="#l24.203"></a><span id="l24.203" class="difflineplus">+     * @private</span>
<a href="#l24.204"></a><span id="l24.204" class="difflineplus">+     * @return {object} flow</span>
<a href="#l24.205"></a><span id="l24.205" class="difflineplus">+     */</span>
<a href="#l24.206"></a><span id="l24.206" class="difflineplus">+    _chooseFlow: function() {</span>
<a href="#l24.207"></a><span id="l24.207" class="difflineplus">+        var flows = this._data.flows || [];</span>
<a href="#l24.208"></a><span id="l24.208" class="difflineplus">+        // always use the first flow for now</span>
<a href="#l24.209"></a><span id="l24.209" class="difflineplus">+        return flows[0];</span>
<a href="#l24.210"></a><span id="l24.210" class="difflineplus">+    },</span>
<a href="#l24.211"></a><span id="l24.211" class="difflineplus">+</span>
<a href="#l24.212"></a><span id="l24.212" class="difflineplus">+    /**</span>
<a href="#l24.213"></a><span id="l24.213" class="difflineplus">+     * Get the first uncompleted stage in the given flow</span>
<a href="#l24.214"></a><span id="l24.214" class="difflineplus">+     *</span>
<a href="#l24.215"></a><span id="l24.215" class="difflineplus">+     * @private</span>
<a href="#l24.216"></a><span id="l24.216" class="difflineplus">+     * @param {object} flow</span>
<a href="#l24.217"></a><span id="l24.217" class="difflineplus">+     * @return {string} login type</span>
<a href="#l24.218"></a><span id="l24.218" class="difflineplus">+     */</span>
<a href="#l24.219"></a><span id="l24.219" class="difflineplus">+    _firstUncompletedStage: function(flow) {</span>
<a href="#l24.220"></a><span id="l24.220" class="difflineplus">+        var completed = (this._data || {}).completed || [];</span>
<a href="#l24.221"></a><span id="l24.221" class="difflineplus">+        for (var i = 0; i &lt; flow.stages.length; ++i) {</span>
<a href="#l24.222"></a><span id="l24.222" class="difflineplus">+            var stageType = flow.stages[i];</span>
<a href="#l24.223"></a><span id="l24.223" class="difflineplus">+            if (completed.indexOf(stageType) === -1) {</span>
<a href="#l24.224"></a><span id="l24.224" class="difflineplus">+                return stageType;</span>
<a href="#l24.225"></a><span id="l24.225" class="difflineplus">+            }</span>
<a href="#l24.226"></a><span id="l24.226" class="difflineplus">+        }</span>
<a href="#l24.227"></a><span id="l24.227" class="difflineplus">+    },</span>
<a href="#l24.228"></a><span id="l24.228" class="difflineplus">+};</span>
<a href="#l24.229"></a><span id="l24.229" class="difflineplus">+</span>
<a href="#l24.230"></a><span id="l24.230" class="difflineplus">+</span>
<a href="#l24.231"></a><span id="l24.231" class="difflineplus">+/** */</span>
<a href="#l24.232"></a><span id="l24.232" class="difflineplus">+module.exports = InteractiveAuth;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1">new file mode 100644</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineminus">--- /dev/null</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineplus">+++ b/chat/protocols/matrix/matrix-sdk/matrix.js</span>
<a href="#l25.4"></a><span id="l25.4" class="difflineat">@@ -0,0 +1,173 @@</span>
<a href="#l25.5"></a><span id="l25.5" class="difflineplus">+/*</span>
<a href="#l25.6"></a><span id="l25.6" class="difflineplus">+Copyright 2015, 2016 OpenMarket Ltd</span>
<a href="#l25.7"></a><span id="l25.7" class="difflineplus">+</span>
<a href="#l25.8"></a><span id="l25.8" class="difflineplus">+Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<a href="#l25.9"></a><span id="l25.9" class="difflineplus">+you may not use this file except in compliance with the License.</span>
<a href="#l25.10"></a><span id="l25.10" class="difflineplus">+You may obtain a copy of the License at</span>
<a href="#l25.11"></a><span id="l25.11" class="difflineplus">+</span>
<a href="#l25.12"></a><span id="l25.12" class="difflineplus">+    http://www.apache.org/licenses/LICENSE-2.0</span>
<a href="#l25.13"></a><span id="l25.13" class="difflineplus">+</span>
<a href="#l25.14"></a><span id="l25.14" class="difflineplus">+Unless required by applicable law or agreed to in writing, software</span>
<a href="#l25.15"></a><span id="l25.15" class="difflineplus">+distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<a href="#l25.16"></a><span id="l25.16" class="difflineplus">+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<a href="#l25.17"></a><span id="l25.17" class="difflineplus">+See the License for the specific language governing permissions and</span>
<a href="#l25.18"></a><span id="l25.18" class="difflineplus">+limitations under the License.</span>
<a href="#l25.19"></a><span id="l25.19" class="difflineplus">+*/</span>
<a href="#l25.20"></a><span id="l25.20" class="difflineplus">+&quot;use strict&quot;;</span>
<a href="#l25.21"></a><span id="l25.21" class="difflineplus">+</span>
<a href="#l25.22"></a><span id="l25.22" class="difflineplus">+/** The {@link module:models/event.MatrixEvent|MatrixEvent} class. */</span>
<a href="#l25.23"></a><span id="l25.23" class="difflineplus">+module.exports.MatrixEvent = require(&quot;./models/event&quot;).MatrixEvent;</span>
<a href="#l25.24"></a><span id="l25.24" class="difflineplus">+/** The {@link module:models/event.EventStatus|EventStatus} enum. */</span>
<a href="#l25.25"></a><span id="l25.25" class="difflineplus">+module.exports.EventStatus = require(&quot;./models/event&quot;).EventStatus;</span>
<a href="#l25.26"></a><span id="l25.26" class="difflineplus">+/** The {@link module:store/memory.MatrixInMemoryStore|MatrixInMemoryStore} class. */</span>
<a href="#l25.27"></a><span id="l25.27" class="difflineplus">+module.exports.MatrixInMemoryStore = require(&quot;./store/memory&quot;).MatrixInMemoryStore;</span>
<a href="#l25.28"></a><span id="l25.28" class="difflineplus">+/** The {@link module:store/webstorage~WebStorageStore|WebStorageStore} class.</span>
<a href="#l25.29"></a><span id="l25.29" class="difflineplus">+ * &lt;strong&gt;Work in progress; unstable.&lt;/strong&gt; */</span>
<a href="#l25.30"></a><span id="l25.30" class="difflineplus">+module.exports.WebStorageStore = require(&quot;./store/webstorage&quot;);</span>
<a href="#l25.31"></a><span id="l25.31" class="difflineplus">+/** The {@link module:http-api.MatrixHttpApi|MatrixHttpApi} class. */</span>
<a href="#l25.32"></a><span id="l25.32" class="difflineplus">+module.exports.MatrixHttpApi = require(&quot;./http-api&quot;).MatrixHttpApi;</span>
<a href="#l25.33"></a><span id="l25.33" class="difflineplus">+/** The {@link module:http-api.MatrixError|MatrixError} class. */</span>
<a href="#l25.34"></a><span id="l25.34" class="difflineplus">+module.exports.MatrixError = require(&quot;./http-api&quot;).MatrixError;</span>
<a href="#l25.35"></a><span id="l25.35" class="difflineplus">+/** The {@link module:client.MatrixClient|MatrixClient} class. */</span>
<a href="#l25.36"></a><span id="l25.36" class="difflineplus">+module.exports.MatrixClient = require(&quot;./client&quot;).MatrixClient;</span>
<a href="#l25.37"></a><span id="l25.37" class="difflineplus">+/** The {@link module:models/room|Room} class. */</span>
<a href="#l25.38"></a><span id="l25.38" class="difflineplus">+module.exports.Room = require(&quot;./models/room&quot;);</span>
<a href="#l25.39"></a><span id="l25.39" class="difflineplus">+/** The {@link module:models/event-timeline~EventTimeline} class. */</span>
<a href="#l25.40"></a><span id="l25.40" class="difflineplus">+module.exports.EventTimeline = require(&quot;./models/event-timeline&quot;);</span>
<a href="#l25.41"></a><span id="l25.41" class="difflineplus">+/** The {@link module:models/event-timeline-set~EventTimelineSet} class. */</span>
<a href="#l25.42"></a><span id="l25.42" class="difflineplus">+module.exports.EventTimelineSet = require(&quot;./models/event-timeline-set&quot;);</span>
<a href="#l25.43"></a><span id="l25.43" class="difflineplus">+/** The {@link module:models/room-member|RoomMember} class. */</span>
<a href="#l25.44"></a><span id="l25.44" class="difflineplus">+module.exports.RoomMember = require(&quot;./models/room-member&quot;);</span>
<a href="#l25.45"></a><span id="l25.45" class="difflineplus">+/** The {@link module:models/room-state~RoomState|RoomState} class. */</span>
<a href="#l25.46"></a><span id="l25.46" class="difflineplus">+module.exports.RoomState = require(&quot;./models/room-state&quot;);</span>
<a href="#l25.47"></a><span id="l25.47" class="difflineplus">+/** The {@link module:models/user~User|User} class. */</span>
<a href="#l25.48"></a><span id="l25.48" class="difflineplus">+module.exports.User = require(&quot;./models/user&quot;);</span>
<a href="#l25.49"></a><span id="l25.49" class="difflineplus">+/** The {@link module:scheduler~MatrixScheduler|MatrixScheduler} class. */</span>
<a href="#l25.50"></a><span id="l25.50" class="difflineplus">+module.exports.MatrixScheduler = require(&quot;./scheduler&quot;);</span>
<a href="#l25.51"></a><span id="l25.51" class="difflineplus">+/** The {@link module:store/session/webstorage~WebStorageSessionStore|</span>
<a href="#l25.52"></a><span id="l25.52" class="difflineplus">+ * WebStorageSessionStore} class. &lt;strong&gt;Work in progress; unstable.&lt;/strong&gt; */</span>
<a href="#l25.53"></a><span id="l25.53" class="difflineplus">+module.exports.WebStorageSessionStore = require(&quot;./store/session/webstorage&quot;);</span>
<a href="#l25.54"></a><span id="l25.54" class="difflineplus">+/** True if crypto libraries are being used on this client. */</span>
<a href="#l25.55"></a><span id="l25.55" class="difflineplus">+module.exports.CRYPTO_ENABLED = require(&quot;./client&quot;).CRYPTO_ENABLED;</span>
<a href="#l25.56"></a><span id="l25.56" class="difflineplus">+/** {@link module:content-repo|ContentRepo} utility functions. */</span>
<a href="#l25.57"></a><span id="l25.57" class="difflineplus">+module.exports.ContentRepo = require(&quot;./content-repo&quot;);</span>
<a href="#l25.58"></a><span id="l25.58" class="difflineplus">+/** The {@link module:filter~Filter|Filter} class. */</span>
<a href="#l25.59"></a><span id="l25.59" class="difflineplus">+module.exports.Filter = require(&quot;./filter&quot;);</span>
<a href="#l25.60"></a><span id="l25.60" class="difflineplus">+/** The {@link module:timeline-window~TimelineWindow} class. */</span>
<a href="#l25.61"></a><span id="l25.61" class="difflineplus">+module.exports.TimelineWindow = require(&quot;./timeline-window&quot;).TimelineWindow;</span>
<a href="#l25.62"></a><span id="l25.62" class="difflineplus">+/** The {@link module:interactive-auth} class. */</span>
<a href="#l25.63"></a><span id="l25.63" class="difflineplus">+module.exports.InteractiveAuth = require(&quot;./interactive-auth&quot;);</span>
<a href="#l25.64"></a><span id="l25.64" class="difflineplus">+</span>
<a href="#l25.65"></a><span id="l25.65" class="difflineplus">+</span>
<a href="#l25.66"></a><span id="l25.66" class="difflineplus">+/**</span>
<a href="#l25.67"></a><span id="l25.67" class="difflineplus">+ * Create a new Matrix Call.</span>
<a href="#l25.68"></a><span id="l25.68" class="difflineplus">+ * @function</span>
<a href="#l25.69"></a><span id="l25.69" class="difflineplus">+ * @param {module:client.MatrixClient} client The MatrixClient instance to use.</span>
<a href="#l25.70"></a><span id="l25.70" class="difflineplus">+ * @param {string} roomId The room the call is in.</span>
<a href="#l25.71"></a><span id="l25.71" class="difflineplus">+ * @return {module:webrtc/call~MatrixCall} The Matrix call or null if the browser</span>
<a href="#l25.72"></a><span id="l25.72" class="difflineplus">+ * does not support WebRTC.</span>
<a href="#l25.73"></a><span id="l25.73" class="difflineplus">+ */</span>
<a href="#l25.74"></a><span id="l25.74" class="difflineplus">+module.exports.createNewMatrixCall = require(&quot;./webrtc/call&quot;).createNewMatrixCall;</span>
<a href="#l25.75"></a><span id="l25.75" class="difflineplus">+</span>
<a href="#l25.76"></a><span id="l25.76" class="difflineplus">+// expose the underlying request object so different environments can use</span>
<a href="#l25.77"></a><span id="l25.77" class="difflineplus">+// different request libs (e.g. request or browser-request)</span>
<a href="#l25.78"></a><span id="l25.78" class="difflineplus">+var request;</span>
<a href="#l25.79"></a><span id="l25.79" class="difflineplus">+/**</span>
<a href="#l25.80"></a><span id="l25.80" class="difflineplus">+ * The function used to perform HTTP requests. Only use this if you want to</span>
<a href="#l25.81"></a><span id="l25.81" class="difflineplus">+ * use a different HTTP library, e.g. Angular's &lt;code&gt;$http&lt;/code&gt;. This should</span>
<a href="#l25.82"></a><span id="l25.82" class="difflineplus">+ * be set prior to calling {@link createClient}.</span>
<a href="#l25.83"></a><span id="l25.83" class="difflineplus">+ * @param {requestFunction} r The request function to use.</span>
<a href="#l25.84"></a><span id="l25.84" class="difflineplus">+ */</span>
<a href="#l25.85"></a><span id="l25.85" class="difflineplus">+module.exports.request = function(r) {</span>
<a href="#l25.86"></a><span id="l25.86" class="difflineplus">+    request = r;</span>
<a href="#l25.87"></a><span id="l25.87" class="difflineplus">+};</span>
<a href="#l25.88"></a><span id="l25.88" class="difflineplus">+</span>
<a href="#l25.89"></a><span id="l25.89" class="difflineplus">+/**</span>
<a href="#l25.90"></a><span id="l25.90" class="difflineplus">+ * Return the currently-set request function.</span>
<a href="#l25.91"></a><span id="l25.91" class="difflineplus">+ * @return {requestFunction} The current request function.</span>
<a href="#l25.92"></a><span id="l25.92" class="difflineplus">+ */</span>
<a href="#l25.93"></a><span id="l25.93" class="difflineplus">+module.exports.getRequest = function() {</span>
<a href="#l25.94"></a><span id="l25.94" class="difflineplus">+    return request;</span>
<a href="#l25.95"></a><span id="l25.95" class="difflineplus">+};</span>
<a href="#l25.96"></a><span id="l25.96" class="difflineplus">+</span>
<a href="#l25.97"></a><span id="l25.97" class="difflineplus">+/**</span>
<a href="#l25.98"></a><span id="l25.98" class="difflineplus">+ * Apply wrapping code around the request function. The wrapper function is</span>
<a href="#l25.99"></a><span id="l25.99" class="difflineplus">+ * installed as the new request handler, and when invoked it is passed the</span>
<a href="#l25.100"></a><span id="l25.100" class="difflineplus">+ * previous value, along with the options and callback arguments.</span>
<a href="#l25.101"></a><span id="l25.101" class="difflineplus">+ * @param {requestWrapperFunction} wrapper The wrapping function.</span>
<a href="#l25.102"></a><span id="l25.102" class="difflineplus">+ */</span>
<a href="#l25.103"></a><span id="l25.103" class="difflineplus">+module.exports.wrapRequest = function(wrapper) {</span>
<a href="#l25.104"></a><span id="l25.104" class="difflineplus">+    var origRequest = request;</span>
<a href="#l25.105"></a><span id="l25.105" class="difflineplus">+    request = function(options, callback) {</span>
<a href="#l25.106"></a><span id="l25.106" class="difflineplus">+        return wrapper(origRequest, options, callback);</span>
<a href="#l25.107"></a><span id="l25.107" class="difflineplus">+    };</span>
<a href="#l25.108"></a><span id="l25.108" class="difflineplus">+};</span>
<a href="#l25.109"></a><span id="l25.109" class="difflineplus">+</span>
<a href="#l25.110"></a><span id="l25.110" class="difflineplus">+/**</span>
<a href="#l25.111"></a><span id="l25.111" class="difflineplus">+ * Construct a Matrix Client. Similar to {@link module:client~MatrixClient}</span>
<a href="#l25.112"></a><span id="l25.112" class="difflineplus">+ * except that the 'request', 'store' and 'scheduler' dependencies are satisfied.</span>
<a href="#l25.113"></a><span id="l25.113" class="difflineplus">+ * @param {(Object|string)} opts The configuration options for this client. If</span>
<a href="#l25.114"></a><span id="l25.114" class="difflineplus">+ * this is a string, it is assumed to be the base URL. These configuration</span>
<a href="#l25.115"></a><span id="l25.115" class="difflineplus">+ * options will be passed directly to {@link module:client~MatrixClient}.</span>
<a href="#l25.116"></a><span id="l25.116" class="difflineplus">+ * @param {Object} opts.store If not set, defaults to</span>
<a href="#l25.117"></a><span id="l25.117" class="difflineplus">+ * {@link module:store/memory.MatrixInMemoryStore}.</span>
<a href="#l25.118"></a><span id="l25.118" class="difflineplus">+ * @param {Object} opts.scheduler If not set, defaults to</span>
<a href="#l25.119"></a><span id="l25.119" class="difflineplus">+ * {@link module:scheduler~MatrixScheduler}.</span>
<a href="#l25.120"></a><span id="l25.120" class="difflineplus">+ * @param {requestFunction} opts.request If not set, defaults to the function</span>
<a href="#l25.121"></a><span id="l25.121" class="difflineplus">+ * supplied to {@link request} which defaults to the request module from NPM.</span>
<a href="#l25.122"></a><span id="l25.122" class="difflineplus">+ * @return {MatrixClient} A new matrix client.</span>
<a href="#l25.123"></a><span id="l25.123" class="difflineplus">+ * @see {@link module:client~MatrixClient} for the full list of options for</span>
<a href="#l25.124"></a><span id="l25.124" class="difflineplus">+ * &lt;code&gt;opts&lt;/code&gt;.</span>
<a href="#l25.125"></a><span id="l25.125" class="difflineplus">+ */</span>
<a href="#l25.126"></a><span id="l25.126" class="difflineplus">+module.exports.createClient = function(opts) {</span>
<a href="#l25.127"></a><span id="l25.127" class="difflineplus">+    if (typeof opts === &quot;string&quot;) {</span>
<a href="#l25.128"></a><span id="l25.128" class="difflineplus">+        opts = {</span>
<a href="#l25.129"></a><span id="l25.129" class="difflineplus">+            &quot;baseUrl&quot;: opts</span>
<a href="#l25.130"></a><span id="l25.130" class="difflineplus">+        };</span>
<a href="#l25.131"></a><span id="l25.131" class="difflineplus">+    }</span>
<a href="#l25.132"></a><span id="l25.132" class="difflineplus">+    opts.request = opts.request || request;</span>
<a href="#l25.133"></a><span id="l25.133" class="difflineplus">+    opts.store = opts.store || new module.exports.MatrixInMemoryStore({</span>
<a href="#l25.134"></a><span id="l25.134" class="difflineplus">+      localStorage: global.localStorage</span>
<a href="#l25.135"></a><span id="l25.135" class="difflineplus">+    });</span>
<a href="#l25.136"></a><span id="l25.136" class="difflineplus">+    opts.scheduler = opts.scheduler || new module.exports.MatrixScheduler();</span>
<a href="#l25.137"></a><span id="l25.137" class="difflineplus">+    return new module.exports.MatrixClient(opts);</span>
<a href="#l25.138"></a><span id="l25.138" class="difflineplus">+};</span>
<a href="#l25.139"></a><span id="l25.139" class="difflineplus">+</span>
<a href="#l25.140"></a><span id="l25.140" class="difflineplus">+/**</span>
<a href="#l25.141"></a><span id="l25.141" class="difflineplus">+ * The request function interface for performing HTTP requests. This matches the</span>
<a href="#l25.142"></a><span id="l25.142" class="difflineplus">+ * API for the {@link https://github.com/request/request#requestoptions-callback|</span>
<a href="#l25.143"></a><span id="l25.143" class="difflineplus">+ * request NPM module}. The SDK will attempt to call this function in order to</span>
<a href="#l25.144"></a><span id="l25.144" class="difflineplus">+ * perform an HTTP request.</span>
<a href="#l25.145"></a><span id="l25.145" class="difflineplus">+ * @callback requestFunction</span>
<a href="#l25.146"></a><span id="l25.146" class="difflineplus">+ * @param {Object} opts The options for this HTTP request.</span>
<a href="#l25.147"></a><span id="l25.147" class="difflineplus">+ * @param {string} opts.uri The complete URI.</span>
<a href="#l25.148"></a><span id="l25.148" class="difflineplus">+ * @param {string} opts.method The HTTP method.</span>
<a href="#l25.149"></a><span id="l25.149" class="difflineplus">+ * @param {Object} opts.qs The query parameters to append to the URI.</span>
<a href="#l25.150"></a><span id="l25.150" class="difflineplus">+ * @param {Object} opts.body The JSON-serializable object.</span>
<a href="#l25.151"></a><span id="l25.151" class="difflineplus">+ * @param {boolean} opts.json True if this is a JSON request.</span>
<a href="#l25.152"></a><span id="l25.152" class="difflineplus">+ * @param {Object} opts._matrix_opts The underlying options set for</span>
<a href="#l25.153"></a><span id="l25.153" class="difflineplus">+ * {@link MatrixHttpApi}.</span>
<a href="#l25.154"></a><span id="l25.154" class="difflineplus">+ * @param {requestCallback} callback The request callback.</span>
<a href="#l25.155"></a><span id="l25.155" class="difflineplus">+ */</span>
<a href="#l25.156"></a><span id="l25.156" class="difflineplus">+</span>
<a href="#l25.157"></a><span id="l25.157" class="difflineplus">+/**</span>
<a href="#l25.158"></a><span id="l25.158" class="difflineplus">+ * A wrapper for the request function interface.</span>
<a href="#l25.159"></a><span id="l25.159" class="difflineplus">+ * @callback requestWrapperFunction</span>
<a href="#l25.160"></a><span id="l25.160" class="difflineplus">+ * @param {requestFunction} origRequest The underlying request function being</span>
<a href="#l25.161"></a><span id="l25.161" class="difflineplus">+ * wrapped</span>
<a href="#l25.162"></a><span id="l25.162" class="difflineplus">+ * @param {Object} opts The options for this HTTP request, given in the same</span>
<a href="#l25.163"></a><span id="l25.163" class="difflineplus">+ * form as {@link requestFunction}.</span>
<a href="#l25.164"></a><span id="l25.164" class="difflineplus">+ * @param {requestCallback} callback The request callback.</span>
<a href="#l25.165"></a><span id="l25.165" class="difflineplus">+ */</span>
<a href="#l25.166"></a><span id="l25.166" class="difflineplus">+</span>
<a href="#l25.167"></a><span id="l25.167" class="difflineplus">+ /**</span>
<a href="#l25.168"></a><span id="l25.168" class="difflineplus">+  * The request callback interface for performing HTTP requests. This matches the</span>
<a href="#l25.169"></a><span id="l25.169" class="difflineplus">+  * API for the {@link https://github.com/request/request#requestoptions-callback|</span>
<a href="#l25.170"></a><span id="l25.170" class="difflineplus">+  * request NPM module}. The SDK will implement a callback which meets this</span>
<a href="#l25.171"></a><span id="l25.171" class="difflineplus">+  * interface in order to handle the HTTP response.</span>
<a href="#l25.172"></a><span id="l25.172" class="difflineplus">+  * @callback requestCallback</span>
<a href="#l25.173"></a><span id="l25.173" class="difflineplus">+  * @param {Error} err The error if one occurred, else falsey.</span>
<a href="#l25.174"></a><span id="l25.174" class="difflineplus">+  * @param {Object} response The HTTP response which consists of</span>
<a href="#l25.175"></a><span id="l25.175" class="difflineplus">+  * &lt;code&gt;{statusCode: {Number}, headers: {Object}}&lt;/code&gt;</span>
<a href="#l25.176"></a><span id="l25.176" class="difflineplus">+  * @param {Object} body The parsed HTTP response body.</span>
<a href="#l25.177"></a><span id="l25.177" class="difflineplus">+  */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1">new file mode 100644</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineminus">--- /dev/null</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineplus">+++ b/chat/protocols/matrix/matrix-sdk/models/event-context.js</span>
<a href="#l26.4"></a><span id="l26.4" class="difflineat">@@ -0,0 +1,119 @@</span>
<a href="#l26.5"></a><span id="l26.5" class="difflineplus">+/*</span>
<a href="#l26.6"></a><span id="l26.6" class="difflineplus">+Copyright 2015, 2016 OpenMarket Ltd</span>
<a href="#l26.7"></a><span id="l26.7" class="difflineplus">+</span>
<a href="#l26.8"></a><span id="l26.8" class="difflineplus">+Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<a href="#l26.9"></a><span id="l26.9" class="difflineplus">+you may not use this file except in compliance with the License.</span>
<a href="#l26.10"></a><span id="l26.10" class="difflineplus">+You may obtain a copy of the License at</span>
<a href="#l26.11"></a><span id="l26.11" class="difflineplus">+</span>
<a href="#l26.12"></a><span id="l26.12" class="difflineplus">+    http://www.apache.org/licenses/LICENSE-2.0</span>
<a href="#l26.13"></a><span id="l26.13" class="difflineplus">+</span>
<a href="#l26.14"></a><span id="l26.14" class="difflineplus">+Unless required by applicable law or agreed to in writing, software</span>
<a href="#l26.15"></a><span id="l26.15" class="difflineplus">+distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<a href="#l26.16"></a><span id="l26.16" class="difflineplus">+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<a href="#l26.17"></a><span id="l26.17" class="difflineplus">+See the License for the specific language governing permissions and</span>
<a href="#l26.18"></a><span id="l26.18" class="difflineplus">+limitations under the License.</span>
<a href="#l26.19"></a><span id="l26.19" class="difflineplus">+*/</span>
<a href="#l26.20"></a><span id="l26.20" class="difflineplus">+&quot;use strict&quot;;</span>
<a href="#l26.21"></a><span id="l26.21" class="difflineplus">+</span>
<a href="#l26.22"></a><span id="l26.22" class="difflineplus">+/**</span>
<a href="#l26.23"></a><span id="l26.23" class="difflineplus">+ * @module models/event-context</span>
<a href="#l26.24"></a><span id="l26.24" class="difflineplus">+ */</span>
<a href="#l26.25"></a><span id="l26.25" class="difflineplus">+</span>
<a href="#l26.26"></a><span id="l26.26" class="difflineplus">+/**</span>
<a href="#l26.27"></a><span id="l26.27" class="difflineplus">+ * Construct a new EventContext</span>
<a href="#l26.28"></a><span id="l26.28" class="difflineplus">+ *</span>
<a href="#l26.29"></a><span id="l26.29" class="difflineplus">+ * An eventcontext is used for circumstances such as search results, when we</span>
<a href="#l26.30"></a><span id="l26.30" class="difflineplus">+ * have a particular event of interest, and a bunch of events before and after</span>
<a href="#l26.31"></a><span id="l26.31" class="difflineplus">+ * it.</span>
<a href="#l26.32"></a><span id="l26.32" class="difflineplus">+ *</span>
<a href="#l26.33"></a><span id="l26.33" class="difflineplus">+ * It also stores pagination tokens for going backwards and forwards in the</span>
<a href="#l26.34"></a><span id="l26.34" class="difflineplus">+ * timeline.</span>
<a href="#l26.35"></a><span id="l26.35" class="difflineplus">+ *</span>
<a href="#l26.36"></a><span id="l26.36" class="difflineplus">+ * @param {MatrixEvent} ourEvent  the event at the centre of this context</span>
<a href="#l26.37"></a><span id="l26.37" class="difflineplus">+ *</span>
<a href="#l26.38"></a><span id="l26.38" class="difflineplus">+ * @constructor</span>
<a href="#l26.39"></a><span id="l26.39" class="difflineplus">+ */</span>
<a href="#l26.40"></a><span id="l26.40" class="difflineplus">+function EventContext(ourEvent) {</span>
<a href="#l26.41"></a><span id="l26.41" class="difflineplus">+    this._timeline = [ourEvent];</span>
<a href="#l26.42"></a><span id="l26.42" class="difflineplus">+    this._ourEventIndex = 0;</span>
<a href="#l26.43"></a><span id="l26.43" class="difflineplus">+    this._paginateTokens = {b: null, f: null};</span>
<a href="#l26.44"></a><span id="l26.44" class="difflineplus">+</span>
<a href="#l26.45"></a><span id="l26.45" class="difflineplus">+    // this is used by MatrixClient to keep track of active requests</span>
<a href="#l26.46"></a><span id="l26.46" class="difflineplus">+    this._paginateRequests = {b: null, f: null};</span>
<a href="#l26.47"></a><span id="l26.47" class="difflineplus">+}</span>
<a href="#l26.48"></a><span id="l26.48" class="difflineplus">+</span>
<a href="#l26.49"></a><span id="l26.49" class="difflineplus">+/**</span>
<a href="#l26.50"></a><span id="l26.50" class="difflineplus">+ * Get the main event of interest</span>
<a href="#l26.51"></a><span id="l26.51" class="difflineplus">+ *</span>
<a href="#l26.52"></a><span id="l26.52" class="difflineplus">+ * This is a convenience function for getTimeline()[getOurEventIndex()].</span>
<a href="#l26.53"></a><span id="l26.53" class="difflineplus">+ *</span>
<a href="#l26.54"></a><span id="l26.54" class="difflineplus">+ * @return {MatrixEvent} The event at the centre of this context.</span>
<a href="#l26.55"></a><span id="l26.55" class="difflineplus">+ */</span>
<a href="#l26.56"></a><span id="l26.56" class="difflineplus">+EventContext.prototype.getEvent = function() {</span>
<a href="#l26.57"></a><span id="l26.57" class="difflineplus">+    return this._timeline[this._ourEventIndex];</span>
<a href="#l26.58"></a><span id="l26.58" class="difflineplus">+};</span>
<a href="#l26.59"></a><span id="l26.59" class="difflineplus">+</span>
<a href="#l26.60"></a><span id="l26.60" class="difflineplus">+/**</span>
<a href="#l26.61"></a><span id="l26.61" class="difflineplus">+ * Get the list of events in this context</span>
<a href="#l26.62"></a><span id="l26.62" class="difflineplus">+ *</span>
<a href="#l26.63"></a><span id="l26.63" class="difflineplus">+ * @return {Array} An array of MatrixEvents</span>
<a href="#l26.64"></a><span id="l26.64" class="difflineplus">+ */</span>
<a href="#l26.65"></a><span id="l26.65" class="difflineplus">+EventContext.prototype.getTimeline = function() {</span>
<a href="#l26.66"></a><span id="l26.66" class="difflineplus">+    return this._timeline;</span>
<a href="#l26.67"></a><span id="l26.67" class="difflineplus">+};</span>
<a href="#l26.68"></a><span id="l26.68" class="difflineplus">+</span>
<a href="#l26.69"></a><span id="l26.69" class="difflineplus">+/**</span>
<a href="#l26.70"></a><span id="l26.70" class="difflineplus">+ * Get the index in the timeline of our event</span>
<a href="#l26.71"></a><span id="l26.71" class="difflineplus">+ *</span>
<a href="#l26.72"></a><span id="l26.72" class="difflineplus">+ * @return {Number}</span>
<a href="#l26.73"></a><span id="l26.73" class="difflineplus">+ */</span>
<a href="#l26.74"></a><span id="l26.74" class="difflineplus">+EventContext.prototype.getOurEventIndex = function() {</span>
<a href="#l26.75"></a><span id="l26.75" class="difflineplus">+    return this._ourEventIndex;</span>
<a href="#l26.76"></a><span id="l26.76" class="difflineplus">+};</span>
<a href="#l26.77"></a><span id="l26.77" class="difflineplus">+</span>
<a href="#l26.78"></a><span id="l26.78" class="difflineplus">+/**</span>
<a href="#l26.79"></a><span id="l26.79" class="difflineplus">+ * Get a pagination token.</span>
<a href="#l26.80"></a><span id="l26.80" class="difflineplus">+ *</span>
<a href="#l26.81"></a><span id="l26.81" class="difflineplus">+ * @param {boolean} backwards   true to get the pagination token for going</span>
<a href="#l26.82"></a><span id="l26.82" class="difflineplus">+ *                                  backwards in time</span>
<a href="#l26.83"></a><span id="l26.83" class="difflineplus">+ * @return {string}</span>
<a href="#l26.84"></a><span id="l26.84" class="difflineplus">+ */</span>
<a href="#l26.85"></a><span id="l26.85" class="difflineplus">+EventContext.prototype.getPaginateToken = function(backwards) {</span>
<a href="#l26.86"></a><span id="l26.86" class="difflineplus">+    return this._paginateTokens[backwards ? 'b' : 'f'];</span>
<a href="#l26.87"></a><span id="l26.87" class="difflineplus">+};</span>
<a href="#l26.88"></a><span id="l26.88" class="difflineplus">+</span>
<a href="#l26.89"></a><span id="l26.89" class="difflineplus">+/**</span>
<a href="#l26.90"></a><span id="l26.90" class="difflineplus">+ * Set a pagination token.</span>
<a href="#l26.91"></a><span id="l26.91" class="difflineplus">+ *</span>
<a href="#l26.92"></a><span id="l26.92" class="difflineplus">+ * Generally this will be used only by the matrix js sdk.</span>
<a href="#l26.93"></a><span id="l26.93" class="difflineplus">+ *</span>
<a href="#l26.94"></a><span id="l26.94" class="difflineplus">+ * @param {string} token        pagination token</span>
<a href="#l26.95"></a><span id="l26.95" class="difflineplus">+ * @param {boolean} backwards   true to set the pagination token for going</span>
<a href="#l26.96"></a><span id="l26.96" class="difflineplus">+ *                                   backwards in time</span>
<a href="#l26.97"></a><span id="l26.97" class="difflineplus">+ */</span>
<a href="#l26.98"></a><span id="l26.98" class="difflineplus">+EventContext.prototype.setPaginateToken = function(token, backwards) {</span>
<a href="#l26.99"></a><span id="l26.99" class="difflineplus">+    this._paginateTokens[backwards ? 'b' : 'f'] = token;</span>
<a href="#l26.100"></a><span id="l26.100" class="difflineplus">+};</span>
<a href="#l26.101"></a><span id="l26.101" class="difflineplus">+</span>
<a href="#l26.102"></a><span id="l26.102" class="difflineplus">+/**</span>
<a href="#l26.103"></a><span id="l26.103" class="difflineplus">+ * Add more events to the timeline</span>
<a href="#l26.104"></a><span id="l26.104" class="difflineplus">+ *</span>
<a href="#l26.105"></a><span id="l26.105" class="difflineplus">+ * @param {Array} events      new events, in timeline order</span>
<a href="#l26.106"></a><span id="l26.106" class="difflineplus">+ * @param {boolean} atStart   true to insert new events at the start</span>
<a href="#l26.107"></a><span id="l26.107" class="difflineplus">+ */</span>
<a href="#l26.108"></a><span id="l26.108" class="difflineplus">+EventContext.prototype.addEvents = function(events, atStart) {</span>
<a href="#l26.109"></a><span id="l26.109" class="difflineplus">+    // TODO: should we share logic with Room.addEventsToTimeline?</span>
<a href="#l26.110"></a><span id="l26.110" class="difflineplus">+    // Should Room even use EventContext?</span>
<a href="#l26.111"></a><span id="l26.111" class="difflineplus">+</span>
<a href="#l26.112"></a><span id="l26.112" class="difflineplus">+    if (atStart) {</span>
<a href="#l26.113"></a><span id="l26.113" class="difflineplus">+        this._timeline = events.concat(this._timeline);</span>
<a href="#l26.114"></a><span id="l26.114" class="difflineplus">+        this._ourEventIndex += events.length;</span>
<a href="#l26.115"></a><span id="l26.115" class="difflineplus">+    } else {</span>
<a href="#l26.116"></a><span id="l26.116" class="difflineplus">+        this._timeline = this._timeline.concat(events);</span>
<a href="#l26.117"></a><span id="l26.117" class="difflineplus">+    }</span>
<a href="#l26.118"></a><span id="l26.118" class="difflineplus">+};</span>
<a href="#l26.119"></a><span id="l26.119" class="difflineplus">+</span>
<a href="#l26.120"></a><span id="l26.120" class="difflineplus">+/**</span>
<a href="#l26.121"></a><span id="l26.121" class="difflineplus">+ * The EventContext class</span>
<a href="#l26.122"></a><span id="l26.122" class="difflineplus">+ */</span>
<a href="#l26.123"></a><span id="l26.123" class="difflineplus">+module.exports = EventContext;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l27.1"></a><span id="l27.1">new file mode 100644</span>
<a href="#l27.2"></a><span id="l27.2" class="difflineminus">--- /dev/null</span>
<a href="#l27.3"></a><span id="l27.3" class="difflineplus">+++ b/chat/protocols/matrix/matrix-sdk/models/event-timeline-set.js</span>
<a href="#l27.4"></a><span id="l27.4" class="difflineat">@@ -0,0 +1,654 @@</span>
<a href="#l27.5"></a><span id="l27.5" class="difflineplus">+/*</span>
<a href="#l27.6"></a><span id="l27.6" class="difflineplus">+Copyright 2016 OpenMarket Ltd</span>
<a href="#l27.7"></a><span id="l27.7" class="difflineplus">+</span>
<a href="#l27.8"></a><span id="l27.8" class="difflineplus">+Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<a href="#l27.9"></a><span id="l27.9" class="difflineplus">+you may not use this file except in compliance with the License.</span>
<a href="#l27.10"></a><span id="l27.10" class="difflineplus">+You may obtain a copy of the License at</span>
<a href="#l27.11"></a><span id="l27.11" class="difflineplus">+</span>
<a href="#l27.12"></a><span id="l27.12" class="difflineplus">+    http://www.apache.org/licenses/LICENSE-2.0</span>
<a href="#l27.13"></a><span id="l27.13" class="difflineplus">+</span>
<a href="#l27.14"></a><span id="l27.14" class="difflineplus">+Unless required by applicable law or agreed to in writing, software</span>
<a href="#l27.15"></a><span id="l27.15" class="difflineplus">+distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<a href="#l27.16"></a><span id="l27.16" class="difflineplus">+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<a href="#l27.17"></a><span id="l27.17" class="difflineplus">+See the License for the specific language governing permissions and</span>
<a href="#l27.18"></a><span id="l27.18" class="difflineplus">+limitations under the License.</span>
<a href="#l27.19"></a><span id="l27.19" class="difflineplus">+*/</span>
<a href="#l27.20"></a><span id="l27.20" class="difflineplus">+&quot;use strict&quot;;</span>
<a href="#l27.21"></a><span id="l27.21" class="difflineplus">+/**</span>
<a href="#l27.22"></a><span id="l27.22" class="difflineplus">+ * @module models/event-timeline-set</span>
<a href="#l27.23"></a><span id="l27.23" class="difflineplus">+ */</span>
<a href="#l27.24"></a><span id="l27.24" class="difflineplus">+var EventEmitter = require(&quot;events&quot;).EventEmitter;</span>
<a href="#l27.25"></a><span id="l27.25" class="difflineplus">+var utils = require(&quot;../utils&quot;);</span>
<a href="#l27.26"></a><span id="l27.26" class="difflineplus">+var EventTimeline = require(&quot;./event-timeline&quot;);</span>
<a href="#l27.27"></a><span id="l27.27" class="difflineplus">+</span>
<a href="#l27.28"></a><span id="l27.28" class="difflineplus">+// var DEBUG = false;</span>
<a href="#l27.29"></a><span id="l27.29" class="difflineplus">+var DEBUG = true;</span>
<a href="#l27.30"></a><span id="l27.30" class="difflineplus">+</span>
<a href="#l27.31"></a><span id="l27.31" class="difflineplus">+if (DEBUG) {</span>
<a href="#l27.32"></a><span id="l27.32" class="difflineplus">+    // using bind means that we get to keep useful line numbers in the console</span>
<a href="#l27.33"></a><span id="l27.33" class="difflineplus">+    var debuglog = console.log.bind(console);</span>
<a href="#l27.34"></a><span id="l27.34" class="difflineplus">+} else {</span>
<a href="#l27.35"></a><span id="l27.35" class="difflineplus">+    var debuglog = function() {};</span>
<a href="#l27.36"></a><span id="l27.36" class="difflineplus">+}</span>
<a href="#l27.37"></a><span id="l27.37" class="difflineplus">+</span>
<a href="#l27.38"></a><span id="l27.38" class="difflineplus">+/**</span>
<a href="#l27.39"></a><span id="l27.39" class="difflineplus">+ * Construct a set of EventTimeline objects, typically on behalf of a given</span>
<a href="#l27.40"></a><span id="l27.40" class="difflineplus">+ * room.  A room may have multiple EventTimelineSets for different levels</span>
<a href="#l27.41"></a><span id="l27.41" class="difflineplus">+ * of filtering.  The global notification list is also an EventTimelineSet, but</span>
<a href="#l27.42"></a><span id="l27.42" class="difflineplus">+ * lacks a room.</span>
<a href="#l27.43"></a><span id="l27.43" class="difflineplus">+ *</span>
<a href="#l27.44"></a><span id="l27.44" class="difflineplus">+ * &lt;p&gt;This is an ordered sequence of timelines, which may or may not</span>
<a href="#l27.45"></a><span id="l27.45" class="difflineplus">+ * be continuous. Each timeline lists a series of events, as well as tracking</span>
<a href="#l27.46"></a><span id="l27.46" class="difflineplus">+ * the room state at the start and the end of the timeline (if appropriate).</span>
<a href="#l27.47"></a><span id="l27.47" class="difflineplus">+ * It also tracks forward and backward pagination tokens, as well as containing</span>
<a href="#l27.48"></a><span id="l27.48" class="difflineplus">+ * links to the next timeline in the sequence.</span>
<a href="#l27.49"></a><span id="l27.49" class="difflineplus">+ *</span>
<a href="#l27.50"></a><span id="l27.50" class="difflineplus">+ * &lt;p&gt;There is one special timeline - the 'live' timeline, which represents the</span>
<a href="#l27.51"></a><span id="l27.51" class="difflineplus">+ * timeline to which events are being added in real-time as they are received</span>
<a href="#l27.52"></a><span id="l27.52" class="difflineplus">+ * from the /sync API. Note that you should not retain references to this</span>
<a href="#l27.53"></a><span id="l27.53" class="difflineplus">+ * timeline - even if it is the current timeline right now, it may not remain</span>
<a href="#l27.54"></a><span id="l27.54" class="difflineplus">+ * so if the server gives us a timeline gap in /sync.</span>
<a href="#l27.55"></a><span id="l27.55" class="difflineplus">+ *</span>
<a href="#l27.56"></a><span id="l27.56" class="difflineplus">+ * &lt;p&gt;In order that we can find events from their ids later, we also maintain a</span>
<a href="#l27.57"></a><span id="l27.57" class="difflineplus">+ * map from event_id to timeline and index.</span>
<a href="#l27.58"></a><span id="l27.58" class="difflineplus">+ *</span>
<a href="#l27.59"></a><span id="l27.59" class="difflineplus">+ * @constructor</span>
<a href="#l27.60"></a><span id="l27.60" class="difflineplus">+ * @param {?Room} room      the optional room for this timelineSet</span>
<a href="#l27.61"></a><span id="l27.61" class="difflineplus">+ * @param {Object} opts     hash of options inherited from Room.</span>
<a href="#l27.62"></a><span id="l27.62" class="difflineplus">+ *      opts.timelineSupport gives whether timeline support is enabled</span>
<a href="#l27.63"></a><span id="l27.63" class="difflineplus">+ *      opts.filter is the filter object, if any, for this timelineSet.</span>
<a href="#l27.64"></a><span id="l27.64" class="difflineplus">+ */</span>
<a href="#l27.65"></a><span id="l27.65" class="difflineplus">+function EventTimelineSet(room, opts) {</span>
<a href="#l27.66"></a><span id="l27.66" class="difflineplus">+    this.room = room;</span>
<a href="#l27.67"></a><span id="l27.67" class="difflineplus">+</span>
<a href="#l27.68"></a><span id="l27.68" class="difflineplus">+    this._timelineSupport = Boolean(opts.timelineSupport);</span>
<a href="#l27.69"></a><span id="l27.69" class="difflineplus">+    this._liveTimeline = new EventTimeline(this);</span>
<a href="#l27.70"></a><span id="l27.70" class="difflineplus">+</span>
<a href="#l27.71"></a><span id="l27.71" class="difflineplus">+    // just a list - *not* ordered.</span>
<a href="#l27.72"></a><span id="l27.72" class="difflineplus">+    this._timelines = [this._liveTimeline];</span>
<a href="#l27.73"></a><span id="l27.73" class="difflineplus">+    this._eventIdToTimeline = {};</span>
<a href="#l27.74"></a><span id="l27.74" class="difflineplus">+</span>
<a href="#l27.75"></a><span id="l27.75" class="difflineplus">+    this._filter = opts.filter || null;</span>
<a href="#l27.76"></a><span id="l27.76" class="difflineplus">+}</span>
<a href="#l27.77"></a><span id="l27.77" class="difflineplus">+utils.inherits(EventTimelineSet, EventEmitter);</span>
<a href="#l27.78"></a><span id="l27.78" class="difflineplus">+</span>
<a href="#l27.79"></a><span id="l27.79" class="difflineplus">+/**</span>
<a href="#l27.80"></a><span id="l27.80" class="difflineplus">+ * Get the filter object this timeline set is filtered on, if any</span>
<a href="#l27.81"></a><span id="l27.81" class="difflineplus">+ * @return {?Filter} the optional filter for this timelineSet</span>
<a href="#l27.82"></a><span id="l27.82" class="difflineplus">+ */</span>
<a href="#l27.83"></a><span id="l27.83" class="difflineplus">+EventTimelineSet.prototype.getFilter = function() {</span>
<a href="#l27.84"></a><span id="l27.84" class="difflineplus">+    return this._filter;</span>
<a href="#l27.85"></a><span id="l27.85" class="difflineplus">+};</span>
<a href="#l27.86"></a><span id="l27.86" class="difflineplus">+</span>
<a href="#l27.87"></a><span id="l27.87" class="difflineplus">+/**</span>
<a href="#l27.88"></a><span id="l27.88" class="difflineplus">+ * Set the filter object this timeline set is filtered on</span>
<a href="#l27.89"></a><span id="l27.89" class="difflineplus">+ * (passed to the server when paginating via /messages).</span>
<a href="#l27.90"></a><span id="l27.90" class="difflineplus">+ * @param {Filter} filter the filter for this timelineSet</span>
<a href="#l27.91"></a><span id="l27.91" class="difflineplus">+ */</span>
<a href="#l27.92"></a><span id="l27.92" class="difflineplus">+EventTimelineSet.prototype.setFilter = function(filter) {</span>
<a href="#l27.93"></a><span id="l27.93" class="difflineplus">+    this._filter = filter;</span>
<a href="#l27.94"></a><span id="l27.94" class="difflineplus">+};</span>
<a href="#l27.95"></a><span id="l27.95" class="difflineplus">+</span>
<a href="#l27.96"></a><span id="l27.96" class="difflineplus">+/**</span>
<a href="#l27.97"></a><span id="l27.97" class="difflineplus">+ * Get the list of pending sent events for this timelineSet's room, filtered</span>
<a href="#l27.98"></a><span id="l27.98" class="difflineplus">+ * by the timelineSet's filter if appropriate.</span>
<a href="#l27.99"></a><span id="l27.99" class="difflineplus">+ *</span>
<a href="#l27.100"></a><span id="l27.100" class="difflineplus">+ * @return {module:models/event.MatrixEvent[]} A list of the sent events</span>
<a href="#l27.101"></a><span id="l27.101" class="difflineplus">+ * waiting for remote echo.</span>
<a href="#l27.102"></a><span id="l27.102" class="difflineplus">+ *</span>
<a href="#l27.103"></a><span id="l27.103" class="difflineplus">+ * @throws If &lt;code&gt;opts.pendingEventOrdering&lt;/code&gt; was not 'detached'</span>
<a href="#l27.104"></a><span id="l27.104" class="difflineplus">+ */</span>
<a href="#l27.105"></a><span id="l27.105" class="difflineplus">+EventTimelineSet.prototype.getPendingEvents = function() {</span>
<a href="#l27.106"></a><span id="l27.106" class="difflineplus">+    if (!this.room) {</span>
<a href="#l27.107"></a><span id="l27.107" class="difflineplus">+        return [];</span>
<a href="#l27.108"></a><span id="l27.108" class="difflineplus">+    }</span>
<a href="#l27.109"></a><span id="l27.109" class="difflineplus">+</span>
<a href="#l27.110"></a><span id="l27.110" class="difflineplus">+    if (this._filter) {</span>
<a href="#l27.111"></a><span id="l27.111" class="difflineplus">+        return this._filter.filterRoomTimeline(this.room.getPendingEvents());</span>
<a href="#l27.112"></a><span id="l27.112" class="difflineplus">+    }</span>
<a href="#l27.113"></a><span id="l27.113" class="difflineplus">+    else {</span>
<a href="#l27.114"></a><span id="l27.114" class="difflineplus">+        return this.room.getPendingEvents();</span>
<a href="#l27.115"></a><span id="l27.115" class="difflineplus">+    }</span>
<a href="#l27.116"></a><span id="l27.116" class="difflineplus">+};</span>
<a href="#l27.117"></a><span id="l27.117" class="difflineplus">+</span>
<a href="#l27.118"></a><span id="l27.118" class="difflineplus">+/**</span>
<a href="#l27.119"></a><span id="l27.119" class="difflineplus">+ * Get the live timeline for this room.</span>
<a href="#l27.120"></a><span id="l27.120" class="difflineplus">+ *</span>
<a href="#l27.121"></a><span id="l27.121" class="difflineplus">+ * @return {module:models/event-timeline~EventTimeline} live timeline</span>
<a href="#l27.122"></a><span id="l27.122" class="difflineplus">+ */</span>
<a href="#l27.123"></a><span id="l27.123" class="difflineplus">+EventTimelineSet.prototype.getLiveTimeline = function() {</span>
<a href="#l27.124"></a><span id="l27.124" class="difflineplus">+    return this._liveTimeline;</span>
<a href="#l27.125"></a><span id="l27.125" class="difflineplus">+};</span>
<a href="#l27.126"></a><span id="l27.126" class="difflineplus">+</span>
<a href="#l27.127"></a><span id="l27.127" class="difflineplus">+/**</span>
<a href="#l27.128"></a><span id="l27.128" class="difflineplus">+ * Return the timeline (if any) this event is in.</span>
<a href="#l27.129"></a><span id="l27.129" class="difflineplus">+ * @param {String} eventId the eventId being sought</span>
<a href="#l27.130"></a><span id="l27.130" class="difflineplus">+ * @return {module:models/event-timeline~EventTimeline} timeline</span>
<a href="#l27.131"></a><span id="l27.131" class="difflineplus">+ */</span>
<a href="#l27.132"></a><span id="l27.132" class="difflineplus">+EventTimelineSet.prototype.eventIdToTimeline = function(eventId) {</span>
<a href="#l27.133"></a><span id="l27.133" class="difflineplus">+    return this._eventIdToTimeline[eventId];</span>
<a href="#l27.134"></a><span id="l27.134" class="difflineplus">+};</span>
<a href="#l27.135"></a><span id="l27.135" class="difflineplus">+</span>
<a href="#l27.136"></a><span id="l27.136" class="difflineplus">+/**</span>
<a href="#l27.137"></a><span id="l27.137" class="difflineplus">+ * Track a new event as if it were in the same timeline as an old event,</span>
<a href="#l27.138"></a><span id="l27.138" class="difflineplus">+ * replacing it.</span>
<a href="#l27.139"></a><span id="l27.139" class="difflineplus">+ * @param {String} oldEventId  event ID of the original event</span>
<a href="#l27.140"></a><span id="l27.140" class="difflineplus">+ * @param {String} newEventId  event ID of the replacement event</span>
<a href="#l27.141"></a><span id="l27.141" class="difflineplus">+ */</span>
<a href="#l27.142"></a><span id="l27.142" class="difflineplus">+EventTimelineSet.prototype.replaceEventId = function(oldEventId, newEventId) {</span>
<a href="#l27.143"></a><span id="l27.143" class="difflineplus">+    var existingTimeline = this._eventIdToTimeline[oldEventId];</span>
<a href="#l27.144"></a><span id="l27.144" class="difflineplus">+    if (existingTimeline) {</span>
<a href="#l27.145"></a><span id="l27.145" class="difflineplus">+        delete this._eventIdToTimeline[oldEventId];</span>
<a href="#l27.146"></a><span id="l27.146" class="difflineplus">+        this._eventIdToTimeline[newEventId] = existingTimeline;</span>
<a href="#l27.147"></a><span id="l27.147" class="difflineplus">+    }</span>
<a href="#l27.148"></a><span id="l27.148" class="difflineplus">+};</span>
<a href="#l27.149"></a><span id="l27.149" class="difflineplus">+</span>
<a href="#l27.150"></a><span id="l27.150" class="difflineplus">+/**</span>
<a href="#l27.151"></a><span id="l27.151" class="difflineplus">+ * Reset the live timeline, and start a new one.</span>
<a href="#l27.152"></a><span id="l27.152" class="difflineplus">+ *</span>
<a href="#l27.153"></a><span id="l27.153" class="difflineplus">+ * &lt;p&gt;This is used when /sync returns a 'limited' timeline.</span>
<a href="#l27.154"></a><span id="l27.154" class="difflineplus">+ *</span>
<a href="#l27.155"></a><span id="l27.155" class="difflineplus">+ * @param {string=} backPaginationToken   token for back-paginating the new timeline</span>
<a href="#l27.156"></a><span id="l27.156" class="difflineplus">+ * @param {?bool} flush  Whether to flush the non-live timelines too.</span>
<a href="#l27.157"></a><span id="l27.157" class="difflineplus">+ *</span>
<a href="#l27.158"></a><span id="l27.158" class="difflineplus">+ * @fires module:client~MatrixClient#event:&quot;Room.timelineReset&quot;</span>
<a href="#l27.159"></a><span id="l27.159" class="difflineplus">+ */</span>
<a href="#l27.160"></a><span id="l27.160" class="difflineplus">+EventTimelineSet.prototype.resetLiveTimeline = function(backPaginationToken, flush) {</span>
<a href="#l27.161"></a><span id="l27.161" class="difflineplus">+    var newTimeline;</span>
<a href="#l27.162"></a><span id="l27.162" class="difflineplus">+</span>
<a href="#l27.163"></a><span id="l27.163" class="difflineplus">+    if (!this._timelineSupport || flush) {</span>
<a href="#l27.164"></a><span id="l27.164" class="difflineplus">+        // if timeline support is disabled, forget about the old timelines</span>
<a href="#l27.165"></a><span id="l27.165" class="difflineplus">+        newTimeline = new EventTimeline(this);</span>
<a href="#l27.166"></a><span id="l27.166" class="difflineplus">+        this._timelines = [newTimeline];</span>
<a href="#l27.167"></a><span id="l27.167" class="difflineplus">+        this._eventIdToTimeline = {};</span>
<a href="#l27.168"></a><span id="l27.168" class="difflineplus">+    } else {</span>
<a href="#l27.169"></a><span id="l27.169" class="difflineplus">+        newTimeline = this.addTimeline();</span>
<a href="#l27.170"></a><span id="l27.170" class="difflineplus">+    }</span>
<a href="#l27.171"></a><span id="l27.171" class="difflineplus">+</span>
<a href="#l27.172"></a><span id="l27.172" class="difflineplus">+    // initialise the state in the new timeline from our last known state</span>
<a href="#l27.173"></a><span id="l27.173" class="difflineplus">+    var evMap = this._liveTimeline.getState(EventTimeline.FORWARDS).events;</span>
<a href="#l27.174"></a><span id="l27.174" class="difflineplus">+    var events = [];</span>
<a href="#l27.175"></a><span id="l27.175" class="difflineplus">+    for (var evtype in evMap) {</span>
<a href="#l27.176"></a><span id="l27.176" class="difflineplus">+        if (!evMap.hasOwnProperty(evtype)) { continue; }</span>
<a href="#l27.177"></a><span id="l27.177" class="difflineplus">+        for (var stateKey in evMap[evtype]) {</span>
<a href="#l27.178"></a><span id="l27.178" class="difflineplus">+            if (!evMap[evtype].hasOwnProperty(stateKey)) { continue; }</span>
<a href="#l27.179"></a><span id="l27.179" class="difflineplus">+            events.push(evMap[evtype][stateKey]);</span>
<a href="#l27.180"></a><span id="l27.180" class="difflineplus">+        }</span>
<a href="#l27.181"></a><span id="l27.181" class="difflineplus">+    }</span>
<a href="#l27.182"></a><span id="l27.182" class="difflineplus">+    newTimeline.initialiseState(events);</span>
<a href="#l27.183"></a><span id="l27.183" class="difflineplus">+</span>
<a href="#l27.184"></a><span id="l27.184" class="difflineplus">+    // make sure we set the pagination token before firing timelineReset,</span>
<a href="#l27.185"></a><span id="l27.185" class="difflineplus">+    // otherwise clients which start back-paginating will fail, and then get</span>
<a href="#l27.186"></a><span id="l27.186" class="difflineplus">+    // stuck without realising that they *can* back-paginate.</span>
<a href="#l27.187"></a><span id="l27.187" class="difflineplus">+    newTimeline.setPaginationToken(backPaginationToken, EventTimeline.BACKWARDS);</span>
<a href="#l27.188"></a><span id="l27.188" class="difflineplus">+</span>
<a href="#l27.189"></a><span id="l27.189" class="difflineplus">+    this._liveTimeline = newTimeline;</span>
<a href="#l27.190"></a><span id="l27.190" class="difflineplus">+    this.emit(&quot;Room.timelineReset&quot;, this.room, this);</span>
<a href="#l27.191"></a><span id="l27.191" class="difflineplus">+};</span>
<a href="#l27.192"></a><span id="l27.192" class="difflineplus">+</span>
<a href="#l27.193"></a><span id="l27.193" class="difflineplus">+/**</span>
<a href="#l27.194"></a><span id="l27.194" class="difflineplus">+ * Get the timeline which contains the given event, if any</span>
<a href="#l27.195"></a><span id="l27.195" class="difflineplus">+ *</span>
<a href="#l27.196"></a><span id="l27.196" class="difflineplus">+ * @param {string} eventId  event ID to look for</span>
<a href="#l27.197"></a><span id="l27.197" class="difflineplus">+ * @return {?module:models/event-timeline~EventTimeline} timeline containing</span>
<a href="#l27.198"></a><span id="l27.198" class="difflineplus">+ * the given event, or null if unknown</span>
<a href="#l27.199"></a><span id="l27.199" class="difflineplus">+ */</span>
<a href="#l27.200"></a><span id="l27.200" class="difflineplus">+EventTimelineSet.prototype.getTimelineForEvent = function(eventId) {</span>
<a href="#l27.201"></a><span id="l27.201" class="difflineplus">+    var res = this._eventIdToTimeline[eventId];</span>
<a href="#l27.202"></a><span id="l27.202" class="difflineplus">+    return (res === undefined) ? null : res;</span>
<a href="#l27.203"></a><span id="l27.203" class="difflineplus">+};</span>
<a href="#l27.204"></a><span id="l27.204" class="difflineplus">+</span>
<a href="#l27.205"></a><span id="l27.205" class="difflineplus">+/**</span>
<a href="#l27.206"></a><span id="l27.206" class="difflineplus">+ * Get an event which is stored in our timelines</span>
<a href="#l27.207"></a><span id="l27.207" class="difflineplus">+ *</span>
<a href="#l27.208"></a><span id="l27.208" class="difflineplus">+ * @param {string} eventId  event ID to look for</span>
<a href="#l27.209"></a><span id="l27.209" class="difflineplus">+ * @return {?module:models/event~MatrixEvent} the given event, or undefined if unknown</span>
<a href="#l27.210"></a><span id="l27.210" class="difflineplus">+ */</span>
<a href="#l27.211"></a><span id="l27.211" class="difflineplus">+EventTimelineSet.prototype.findEventById = function(eventId) {</span>
<a href="#l27.212"></a><span id="l27.212" class="difflineplus">+    var tl = this.getTimelineForEvent(eventId);</span>
<a href="#l27.213"></a><span id="l27.213" class="difflineplus">+    if (!tl) {</span>
<a href="#l27.214"></a><span id="l27.214" class="difflineplus">+        return undefined;</span>
<a href="#l27.215"></a><span id="l27.215" class="difflineplus">+    }</span>
<a href="#l27.216"></a><span id="l27.216" class="difflineplus">+    return utils.findElement(tl.getEvents(),</span>
<a href="#l27.217"></a><span id="l27.217" class="difflineplus">+                             function(ev) { return ev.getId() == eventId; });</span>
<a href="#l27.218"></a><span id="l27.218" class="difflineplus">+};</span>
<a href="#l27.219"></a><span id="l27.219" class="difflineplus">+</span>
<a href="#l27.220"></a><span id="l27.220" class="difflineplus">+/**</span>
<a href="#l27.221"></a><span id="l27.221" class="difflineplus">+ * Add a new timeline to this timeline list</span>
<a href="#l27.222"></a><span id="l27.222" class="difflineplus">+ *</span>
<a href="#l27.223"></a><span id="l27.223" class="difflineplus">+ * @return {module:models/event-timeline~EventTimeline} newly-created timeline</span>
<a href="#l27.224"></a><span id="l27.224" class="difflineplus">+ */</span>
<a href="#l27.225"></a><span id="l27.225" class="difflineplus">+EventTimelineSet.prototype.addTimeline = function() {</span>
<a href="#l27.226"></a><span id="l27.226" class="difflineplus">+    if (!this._timelineSupport) {</span>
<a href="#l27.227"></a><span id="l27.227" class="difflineplus">+        throw new Error(&quot;timeline support is disabled. Set the 'timelineSupport'&quot; +</span>
<a href="#l27.228"></a><span id="l27.228" class="difflineplus">+                        &quot; parameter to true when creating MatrixClient to enable&quot; +</span>
<a href="#l27.229"></a><span id="l27.229" class="difflineplus">+                        &quot; it.&quot;);</span>
<a href="#l27.230"></a><span id="l27.230" class="difflineplus">+    }</span>
<a href="#l27.231"></a><span id="l27.231" class="difflineplus">+</span>
<a href="#l27.232"></a><span id="l27.232" class="difflineplus">+    var timeline = new EventTimeline(this);</span>
<a href="#l27.233"></a><span id="l27.233" class="difflineplus">+    this._timelines.push(timeline);</span>
<a href="#l27.234"></a><span id="l27.234" class="difflineplus">+    return timeline;</span>
<a href="#l27.235"></a><span id="l27.235" class="difflineplus">+};</span>
<a href="#l27.236"></a><span id="l27.236" class="difflineplus">+</span>
<a href="#l27.237"></a><span id="l27.237" class="difflineplus">+</span>
<a href="#l27.238"></a><span id="l27.238" class="difflineplus">+/**</span>
<a href="#l27.239"></a><span id="l27.239" class="difflineplus">+ * Add events to a timeline</span>
<a href="#l27.240"></a><span id="l27.240" class="difflineplus">+ *</span>
<a href="#l27.241"></a><span id="l27.241" class="difflineplus">+ * &lt;p&gt;Will fire &quot;Room.timeline&quot; for each event added.</span>
<a href="#l27.242"></a><span id="l27.242" class="difflineplus">+ *</span>
<a href="#l27.243"></a><span id="l27.243" class="difflineplus">+ * @param {MatrixEvent[]} events A list of events to add.</span>
<a href="#l27.244"></a><span id="l27.244" class="difflineplus">+ *</span>
<a href="#l27.245"></a><span id="l27.245" class="difflineplus">+ * @param {boolean} toStartOfTimeline   True to add these events to the start</span>
<a href="#l27.246"></a><span id="l27.246" class="difflineplus">+ * (oldest) instead of the end (newest) of the timeline. If true, the oldest</span>
<a href="#l27.247"></a><span id="l27.247" class="difflineplus">+ * event will be the &lt;b&gt;last&lt;/b&gt; element of 'events'.</span>
<a href="#l27.248"></a><span id="l27.248" class="difflineplus">+ *</span>
<a href="#l27.249"></a><span id="l27.249" class="difflineplus">+ * @param {module:models/event-timeline~EventTimeline} timeline   timeline to</span>
<a href="#l27.250"></a><span id="l27.250" class="difflineplus">+ *    add events to.</span>
<a href="#l27.251"></a><span id="l27.251" class="difflineplus">+ *</span>
<a href="#l27.252"></a><span id="l27.252" class="difflineplus">+ * @param {string=} paginationToken   token for the next batch of events</span>
<a href="#l27.253"></a><span id="l27.253" class="difflineplus">+ *</span>
<a href="#l27.254"></a><span id="l27.254" class="difflineplus">+ * @fires module:client~MatrixClient#event:&quot;Room.timeline&quot;</span>
<a href="#l27.255"></a><span id="l27.255" class="difflineplus">+ *</span>
<a href="#l27.256"></a><span id="l27.256" class="difflineplus">+ */</span>
<a href="#l27.257"></a><span id="l27.257" class="difflineplus">+EventTimelineSet.prototype.addEventsToTimeline = function(events, toStartOfTimeline,</span>
<a href="#l27.258"></a><span id="l27.258" class="difflineplus">+                                              timeline, paginationToken) {</span>
<a href="#l27.259"></a><span id="l27.259" class="difflineplus">+    if (!timeline) {</span>
<a href="#l27.260"></a><span id="l27.260" class="difflineplus">+        throw new Error(</span>
<a href="#l27.261"></a><span id="l27.261" class="difflineplus">+            &quot;'timeline' not specified for EventTimelineSet.addEventsToTimeline&quot;</span>
<a href="#l27.262"></a><span id="l27.262" class="difflineplus">+        );</span>
<a href="#l27.263"></a><span id="l27.263" class="difflineplus">+    }</span>
<a href="#l27.264"></a><span id="l27.264" class="difflineplus">+</span>
<a href="#l27.265"></a><span id="l27.265" class="difflineplus">+    if (!toStartOfTimeline &amp;&amp; timeline == this._liveTimeline) {</span>
<a href="#l27.266"></a><span id="l27.266" class="difflineplus">+        throw new Error(</span>
<a href="#l27.267"></a><span id="l27.267" class="difflineplus">+            &quot;EventTimelineSet.addEventsToTimeline cannot be used for adding events to &quot; +</span>
<a href="#l27.268"></a><span id="l27.268" class="difflineplus">+            &quot;the live timeline - use Room.addLiveEvents instead&quot;</span>
<a href="#l27.269"></a><span id="l27.269" class="difflineplus">+        );</span>
<a href="#l27.270"></a><span id="l27.270" class="difflineplus">+    }</span>
<a href="#l27.271"></a><span id="l27.271" class="difflineplus">+</span>
<a href="#l27.272"></a><span id="l27.272" class="difflineplus">+    if (this._filter) {</span>
<a href="#l27.273"></a><span id="l27.273" class="difflineplus">+        events = this._filter.filterRoomTimeline(events);</span>
<a href="#l27.274"></a><span id="l27.274" class="difflineplus">+        if (!events.length) {</span>
<a href="#l27.275"></a><span id="l27.275" class="difflineplus">+            return;</span>
<a href="#l27.276"></a><span id="l27.276" class="difflineplus">+        }</span>
<a href="#l27.277"></a><span id="l27.277" class="difflineplus">+    }</span>
<a href="#l27.278"></a><span id="l27.278" class="difflineplus">+</span>
<a href="#l27.279"></a><span id="l27.279" class="difflineplus">+    var direction = toStartOfTimeline ? EventTimeline.BACKWARDS :</span>
<a href="#l27.280"></a><span id="l27.280" class="difflineplus">+        EventTimeline.FORWARDS;</span>
<a href="#l27.281"></a><span id="l27.281" class="difflineplus">+    var inverseDirection = toStartOfTimeline ? EventTimeline.FORWARDS :</span>
<a href="#l27.282"></a><span id="l27.282" class="difflineplus">+        EventTimeline.BACKWARDS;</span>
<a href="#l27.283"></a><span id="l27.283" class="difflineplus">+</span>
<a href="#l27.284"></a><span id="l27.284" class="difflineplus">+    // Adding events to timelines can be quite complicated. The following</span>
<a href="#l27.285"></a><span id="l27.285" class="difflineplus">+    // illustrates some of the corner-cases.</span>
<a href="#l27.286"></a><span id="l27.286" class="difflineplus">+    //</span>
<a href="#l27.287"></a><span id="l27.287" class="difflineplus">+    // Let's say we start by knowing about four timelines. timeline3 and</span>
<a href="#l27.288"></a><span id="l27.288" class="difflineplus">+    // timeline4 are neighbours:</span>
<a href="#l27.289"></a><span id="l27.289" class="difflineplus">+    //</span>
<a href="#l27.290"></a><span id="l27.290" class="difflineplus">+    //    timeline1    timeline2    timeline3    timeline4</span>
<a href="#l27.291"></a><span id="l27.291" class="difflineplus">+    //      [M]          [P]          [S] &lt;------&gt; [T]</span>
<a href="#l27.292"></a><span id="l27.292" class="difflineplus">+    //</span>
<a href="#l27.293"></a><span id="l27.293" class="difflineplus">+    // Now we paginate timeline1, and get the following events from the server:</span>
<a href="#l27.294"></a><span id="l27.294" class="difflineplus">+    // [M, N, P, R, S, T, U].</span>
<a href="#l27.295"></a><span id="l27.295" class="difflineplus">+    //</span>
<a href="#l27.296"></a><span id="l27.296" class="difflineplus">+    // 1. First, we ignore event M, since we already know about it.</span>
<a href="#l27.297"></a><span id="l27.297" class="difflineplus">+    //</span>
<a href="#l27.298"></a><span id="l27.298" class="difflineplus">+    // 2. Next, we append N to timeline 1.</span>
<a href="#l27.299"></a><span id="l27.299" class="difflineplus">+    //</span>
<a href="#l27.300"></a><span id="l27.300" class="difflineplus">+    // 3. Next, we don't add event P, since we already know about it,</span>
<a href="#l27.301"></a><span id="l27.301" class="difflineplus">+    //    but we do link together the timelines. We now have:</span>
<a href="#l27.302"></a><span id="l27.302" class="difflineplus">+    //</span>
<a href="#l27.303"></a><span id="l27.303" class="difflineplus">+    //    timeline1    timeline2    timeline3    timeline4</span>
<a href="#l27.304"></a><span id="l27.304" class="difflineplus">+    //      [M, N] &lt;---&gt; [P]          [S] &lt;------&gt; [T]</span>
<a href="#l27.305"></a><span id="l27.305" class="difflineplus">+    //</span>
<a href="#l27.306"></a><span id="l27.306" class="difflineplus">+    // 4. Now we add event R to timeline2:</span>
<a href="#l27.307"></a><span id="l27.307" class="difflineplus">+    //</span>
<a href="#l27.308"></a><span id="l27.308" class="difflineplus">+    //    timeline1    timeline2    timeline3    timeline4</span>
<a href="#l27.309"></a><span id="l27.309" class="difflineplus">+    //      [M, N] &lt;---&gt; [P, R]       [S] &lt;------&gt; [T]</span>
<a href="#l27.310"></a><span id="l27.310" class="difflineplus">+    //</span>
<a href="#l27.311"></a><span id="l27.311" class="difflineplus">+    //    Note that we have switched the timeline we are working on from</span>
<a href="#l27.312"></a><span id="l27.312" class="difflineplus">+    //    timeline1 to timeline2.</span>
<a href="#l27.313"></a><span id="l27.313" class="difflineplus">+    //</span>
<a href="#l27.314"></a><span id="l27.314" class="difflineplus">+    // 5. We ignore event S, but again join the timelines:</span>
<a href="#l27.315"></a><span id="l27.315" class="difflineplus">+    //</span>
<a href="#l27.316"></a><span id="l27.316" class="difflineplus">+    //    timeline1    timeline2    timeline3    timeline4</span>
<a href="#l27.317"></a><span id="l27.317" class="difflineplus">+    //      [M, N] &lt;---&gt; [P, R] &lt;---&gt; [S] &lt;------&gt; [T]</span>
<a href="#l27.318"></a><span id="l27.318" class="difflineplus">+    //</span>
<a href="#l27.319"></a><span id="l27.319" class="difflineplus">+    // 6. We ignore event T, and the timelines are already joined, so there</span>
<a href="#l27.320"></a><span id="l27.320" class="difflineplus">+    //    is nothing to do.</span>
<a href="#l27.321"></a><span id="l27.321" class="difflineplus">+    //</span>
<a href="#l27.322"></a><span id="l27.322" class="difflineplus">+    // 7. Finally, we add event U to timeline4:</span>
<a href="#l27.323"></a><span id="l27.323" class="difflineplus">+    //</span>
<a href="#l27.324"></a><span id="l27.324" class="difflineplus">+    //    timeline1    timeline2    timeline3    timeline4</span>
<a href="#l27.325"></a><span id="l27.325" class="difflineplus">+    //      [M, N] &lt;---&gt; [P, R] &lt;---&gt; [S] &lt;------&gt; [T, U]</span>
<a href="#l27.326"></a><span id="l27.326" class="difflineplus">+    //</span>
<a href="#l27.327"></a><span id="l27.327" class="difflineplus">+    // The important thing to note in the above is what happened when we</span>
<a href="#l27.328"></a><span id="l27.328" class="difflineplus">+    // already knew about a given event:</span>
<a href="#l27.329"></a><span id="l27.329" class="difflineplus">+    //</span>
<a href="#l27.330"></a><span id="l27.330" class="difflineplus">+    //   - if it was appropriate, we joined up the timelines (steps 3, 5).</span>
<a href="#l27.331"></a><span id="l27.331" class="difflineplus">+    //   - in any case, we started adding further events to the timeline which</span>
<a href="#l27.332"></a><span id="l27.332" class="difflineplus">+    //       contained the event we knew about (steps 3, 5, 6).</span>
<a href="#l27.333"></a><span id="l27.333" class="difflineplus">+    //</span>
<a href="#l27.334"></a><span id="l27.334" class="difflineplus">+    //</span>
<a href="#l27.335"></a><span id="l27.335" class="difflineplus">+    // So much for adding events to the timeline. But what do we want to do</span>
<a href="#l27.336"></a><span id="l27.336" class="difflineplus">+    // with the pagination token?</span>
<a href="#l27.337"></a><span id="l27.337" class="difflineplus">+    //</span>
<a href="#l27.338"></a><span id="l27.338" class="difflineplus">+    // In the case above, we will be given a pagination token which tells us how to</span>
<a href="#l27.339"></a><span id="l27.339" class="difflineplus">+    // get events beyond 'U' - in this case, it makes sense to store this</span>
<a href="#l27.340"></a><span id="l27.340" class="difflineplus">+    // against timeline4. But what if timeline4 already had 'U' and beyond? in</span>
<a href="#l27.341"></a><span id="l27.341" class="difflineplus">+    // that case, our best bet is to throw away the pagination token we were</span>
<a href="#l27.342"></a><span id="l27.342" class="difflineplus">+    // given and stick with whatever token timeline4 had previously. In short,</span>
<a href="#l27.343"></a><span id="l27.343" class="difflineplus">+    // we want to only store the pagination token if the last event we receive</span>
<a href="#l27.344"></a><span id="l27.344" class="difflineplus">+    // is one we didn't previously know about.</span>
<a href="#l27.345"></a><span id="l27.345" class="difflineplus">+    //</span>
<a href="#l27.346"></a><span id="l27.346" class="difflineplus">+    // We make an exception for this if it turns out that we already knew about</span>
<a href="#l27.347"></a><span id="l27.347" class="difflineplus">+    // *all* of the events, and we weren't able to join up any timelines. When</span>
<a href="#l27.348"></a><span id="l27.348" class="difflineplus">+    // that happens, it means our existing pagination token is faulty, since it</span>
<a href="#l27.349"></a><span id="l27.349" class="difflineplus">+    // is only telling us what we already know. Rather than repeatedly</span>
<a href="#l27.350"></a><span id="l27.350" class="difflineplus">+    // paginating with the same token, we might as well use the new pagination</span>
<a href="#l27.351"></a><span id="l27.351" class="difflineplus">+    // token in the hope that we eventually work our way out of the mess.</span>
<a href="#l27.352"></a><span id="l27.352" class="difflineplus">+</span>
<a href="#l27.353"></a><span id="l27.353" class="difflineplus">+    var didUpdate = false;</span>
<a href="#l27.354"></a><span id="l27.354" class="difflineplus">+    var lastEventWasNew = false;</span>
<a href="#l27.355"></a><span id="l27.355" class="difflineplus">+    for (var i = 0; i &lt; events.length; i++) {</span>
<a href="#l27.356"></a><span id="l27.356" class="difflineplus">+        var event = events[i];</span>
<a href="#l27.357"></a><span id="l27.357" class="difflineplus">+        var eventId = event.getId();</span>
<a href="#l27.358"></a><span id="l27.358" class="difflineplus">+</span>
<a href="#l27.359"></a><span id="l27.359" class="difflineplus">+        var existingTimeline = this._eventIdToTimeline[eventId];</span>
<a href="#l27.360"></a><span id="l27.360" class="difflineplus">+</span>
<a href="#l27.361"></a><span id="l27.361" class="difflineplus">+        if (!existingTimeline) {</span>
<a href="#l27.362"></a><span id="l27.362" class="difflineplus">+            // we don't know about this event yet. Just add it to the timeline.</span>
<a href="#l27.363"></a><span id="l27.363" class="difflineplus">+            this.addEventToTimeline(event, timeline, toStartOfTimeline);</span>
<a href="#l27.364"></a><span id="l27.364" class="difflineplus">+            lastEventWasNew = true;</span>
<a href="#l27.365"></a><span id="l27.365" class="difflineplus">+            didUpdate = true;</span>
<a href="#l27.366"></a><span id="l27.366" class="difflineplus">+            continue;</span>
<a href="#l27.367"></a><span id="l27.367" class="difflineplus">+        }</span>
<a href="#l27.368"></a><span id="l27.368" class="difflineplus">+</span>
<a href="#l27.369"></a><span id="l27.369" class="difflineplus">+        lastEventWasNew = false;</span>
<a href="#l27.370"></a><span id="l27.370" class="difflineplus">+</span>
<a href="#l27.371"></a><span id="l27.371" class="difflineplus">+        if (existingTimeline == timeline) {</span>
<a href="#l27.372"></a><span id="l27.372" class="difflineplus">+            debuglog(&quot;Event &quot; + eventId + &quot; already in timeline &quot; + timeline);</span>
<a href="#l27.373"></a><span id="l27.373" class="difflineplus">+            continue;</span>
<a href="#l27.374"></a><span id="l27.374" class="difflineplus">+        }</span>
<a href="#l27.375"></a><span id="l27.375" class="difflineplus">+</span>
<a href="#l27.376"></a><span id="l27.376" class="difflineplus">+        var neighbour = timeline.getNeighbouringTimeline(direction);</span>
<a href="#l27.377"></a><span id="l27.377" class="difflineplus">+        if (neighbour) {</span>
<a href="#l27.378"></a><span id="l27.378" class="difflineplus">+            // this timeline already has a neighbour in the relevant direction;</span>
<a href="#l27.379"></a><span id="l27.379" class="difflineplus">+            // let's assume the timelines are already correctly linked up, and</span>
<a href="#l27.380"></a><span id="l27.380" class="difflineplus">+            // skip over to it.</span>
<a href="#l27.381"></a><span id="l27.381" class="difflineplus">+            //</span>
<a href="#l27.382"></a><span id="l27.382" class="difflineplus">+            // there's probably some edge-case here where we end up with an</span>
<a href="#l27.383"></a><span id="l27.383" class="difflineplus">+            // event which is in a timeline a way down the chain, and there is</span>
<a href="#l27.384"></a><span id="l27.384" class="difflineplus">+            // a break in the chain somewhere. But I can't really imagine how</span>
<a href="#l27.385"></a><span id="l27.385" class="difflineplus">+            // that would happen, so I'm going to ignore it for now.</span>
<a href="#l27.386"></a><span id="l27.386" class="difflineplus">+            //</span>
<a href="#l27.387"></a><span id="l27.387" class="difflineplus">+            if (existingTimeline == neighbour) {</span>
<a href="#l27.388"></a><span id="l27.388" class="difflineplus">+                debuglog(&quot;Event &quot; + eventId + &quot; in neighbouring timeline - &quot; +</span>
<a href="#l27.389"></a><span id="l27.389" class="difflineplus">+                            &quot;switching to &quot; + existingTimeline);</span>
<a href="#l27.390"></a><span id="l27.390" class="difflineplus">+            } else {</span>
<a href="#l27.391"></a><span id="l27.391" class="difflineplus">+                debuglog(&quot;Event &quot; + eventId + &quot; already in a different &quot; +</span>
<a href="#l27.392"></a><span id="l27.392" class="difflineplus">+                            &quot;timeline &quot; + existingTimeline);</span>
<a href="#l27.393"></a><span id="l27.393" class="difflineplus">+            }</span>
<a href="#l27.394"></a><span id="l27.394" class="difflineplus">+            timeline = existingTimeline;</span>
<a href="#l27.395"></a><span id="l27.395" class="difflineplus">+            continue;</span>
<a href="#l27.396"></a><span id="l27.396" class="difflineplus">+        }</span>
<a href="#l27.397"></a><span id="l27.397" class="difflineplus">+</span>
<a href="#l27.398"></a><span id="l27.398" class="difflineplus">+        // time to join the timelines.</span>
<a href="#l27.399"></a><span id="l27.399" class="difflineplus">+        console.info(&quot;Already have timeline for &quot; + eventId +</span>
<a href="#l27.400"></a><span id="l27.400" class="difflineplus">+                     &quot; - joining timeline &quot; + timeline + &quot; to &quot; +</span>
<a href="#l27.401"></a><span id="l27.401" class="difflineplus">+                     existingTimeline);</span>
<a href="#l27.402"></a><span id="l27.402" class="difflineplus">+        timeline.setNeighbouringTimeline(existingTimeline, direction);</span>
<a href="#l27.403"></a><span id="l27.403" class="difflineplus">+        existingTimeline.setNeighbouringTimeline(timeline, inverseDirection);</span>
<a href="#l27.404"></a><span id="l27.404" class="difflineplus">+        timeline = existingTimeline;</span>
<a href="#l27.405"></a><span id="l27.405" class="difflineplus">+        didUpdate = true;</span>
<a href="#l27.406"></a><span id="l27.406" class="difflineplus">+    }</span>
<a href="#l27.407"></a><span id="l27.407" class="difflineplus">+</span>
<a href="#l27.408"></a><span id="l27.408" class="difflineplus">+    // see above - if the last event was new to us, or if we didn't find any</span>
<a href="#l27.409"></a><span id="l27.409" class="difflineplus">+    // new information, we update the pagination token for whatever</span>
<a href="#l27.410"></a><span id="l27.410" class="difflineplus">+    // timeline we ended up on.</span>
<a href="#l27.411"></a><span id="l27.411" class="difflineplus">+    if (lastEventWasNew || !didUpdate) {</span>
<a href="#l27.412"></a><span id="l27.412" class="difflineplus">+        timeline.setPaginationToken(paginationToken, direction);</span>
<a href="#l27.413"></a><span id="l27.413" class="difflineplus">+    }</span>
<a href="#l27.414"></a><span id="l27.414" class="difflineplus">+};</span>
<a href="#l27.415"></a><span id="l27.415" class="difflineplus">+</span>
<a href="#l27.416"></a><span id="l27.416" class="difflineplus">+/**</span>
<a href="#l27.417"></a><span id="l27.417" class="difflineplus">+ * Add an event to the end of this live timeline.</span>
<a href="#l27.418"></a><span id="l27.418" class="difflineplus">+ *</span>
<a href="#l27.419"></a><span id="l27.419" class="difflineplus">+ * @param {MatrixEvent} event Event to be added</span>
<a href="#l27.420"></a><span id="l27.420" class="difflineplus">+ * @param {string?} duplicateStrategy 'ignore' or 'replace'</span>
<a href="#l27.421"></a><span id="l27.421" class="difflineplus">+ */</span>
<a href="#l27.422"></a><span id="l27.422" class="difflineplus">+EventTimelineSet.prototype.addLiveEvent = function(event, duplicateStrategy) {</span>
<a href="#l27.423"></a><span id="l27.423" class="difflineplus">+    if (this._filter) {</span>
<a href="#l27.424"></a><span id="l27.424" class="difflineplus">+        var events = this._filter.filterRoomTimeline([event]);</span>
<a href="#l27.425"></a><span id="l27.425" class="difflineplus">+        if (!events.length) {</span>
<a href="#l27.426"></a><span id="l27.426" class="difflineplus">+            return;</span>
<a href="#l27.427"></a><span id="l27.427" class="difflineplus">+        }</span>
<a href="#l27.428"></a><span id="l27.428" class="difflineplus">+    }</span>
<a href="#l27.429"></a><span id="l27.429" class="difflineplus">+</span>
<a href="#l27.430"></a><span id="l27.430" class="difflineplus">+    var timeline = this._eventIdToTimeline[event.getId()];</span>
<a href="#l27.431"></a><span id="l27.431" class="difflineplus">+    if (timeline) {</span>
<a href="#l27.432"></a><span id="l27.432" class="difflineplus">+        if (duplicateStrategy === &quot;replace&quot;) {</span>
<a href="#l27.433"></a><span id="l27.433" class="difflineplus">+            debuglog(&quot;EventTimelineSet.addLiveEvent: replacing duplicate event &quot; +</span>
<a href="#l27.434"></a><span id="l27.434" class="difflineplus">+                     event.getId());</span>
<a href="#l27.435"></a><span id="l27.435" class="difflineplus">+            var tlEvents = timeline.getEvents();</span>
<a href="#l27.436"></a><span id="l27.436" class="difflineplus">+            for (var j = 0; j &lt; tlEvents.length; j++) {</span>
<a href="#l27.437"></a><span id="l27.437" class="difflineplus">+                if (tlEvents[j].getId() === event.getId()) {</span>
<a href="#l27.438"></a><span id="l27.438" class="difflineplus">+                    // still need to set the right metadata on this event</span>
<a href="#l27.439"></a><span id="l27.439" class="difflineplus">+                    EventTimeline.setEventMetadata(</span>
<a href="#l27.440"></a><span id="l27.440" class="difflineplus">+                        event,</span>
<a href="#l27.441"></a><span id="l27.441" class="difflineplus">+                        timeline.getState(EventTimeline.FORWARDS),</span>
<a href="#l27.442"></a><span id="l27.442" class="difflineplus">+                        false</span>
<a href="#l27.443"></a><span id="l27.443" class="difflineplus">+                    );</span>
<a href="#l27.444"></a><span id="l27.444" class="difflineplus">+</span>
<a href="#l27.445"></a><span id="l27.445" class="difflineplus">+                    if (!tlEvents[j].encryptedType) {</span>
<a href="#l27.446"></a><span id="l27.446" class="difflineplus">+                        tlEvents[j] = event;</span>
<a href="#l27.447"></a><span id="l27.447" class="difflineplus">+                    }</span>
<a href="#l27.448"></a><span id="l27.448" class="difflineplus">+</span>
<a href="#l27.449"></a><span id="l27.449" class="difflineplus">+                    // XXX: we need to fire an event when this happens.</span>
<a href="#l27.450"></a><span id="l27.450" class="difflineplus">+                    break;</span>
<a href="#l27.451"></a><span id="l27.451" class="difflineplus">+                }</span>
<a href="#l27.452"></a><span id="l27.452" class="difflineplus">+            }</span>
<a href="#l27.453"></a><span id="l27.453" class="difflineplus">+        } else {</span>
<a href="#l27.454"></a><span id="l27.454" class="difflineplus">+            debuglog(&quot;EventTimelineSet.addLiveEvent: ignoring duplicate event &quot; +</span>
<a href="#l27.455"></a><span id="l27.455" class="difflineplus">+                     event.getId());</span>
<a href="#l27.456"></a><span id="l27.456" class="difflineplus">+        }</span>
<a href="#l27.457"></a><span id="l27.457" class="difflineplus">+        return;</span>
<a href="#l27.458"></a><span id="l27.458" class="difflineplus">+    }</span>
<a href="#l27.459"></a><span id="l27.459" class="difflineplus">+</span>
<a href="#l27.460"></a><span id="l27.460" class="difflineplus">+    this.addEventToTimeline(event, this._liveTimeline, false);</span>
<a href="#l27.461"></a><span id="l27.461" class="difflineplus">+};</span>
<a href="#l27.462"></a><span id="l27.462" class="difflineplus">+</span>
<a href="#l27.463"></a><span id="l27.463" class="difflineplus">+/**</span>
<a href="#l27.464"></a><span id="l27.464" class="difflineplus">+ * Add event to the given timeline, and emit Room.timeline. Assumes</span>
<a href="#l27.465"></a><span id="l27.465" class="difflineplus">+ * we have already checked we don't know about this event.</span>
<a href="#l27.466"></a><span id="l27.466" class="difflineplus">+ *</span>
<a href="#l27.467"></a><span id="l27.467" class="difflineplus">+ * Will fire &quot;Room.timeline&quot; for each event added.</span>
<a href="#l27.468"></a><span id="l27.468" class="difflineplus">+ *</span>
<a href="#l27.469"></a><span id="l27.469" class="difflineplus">+ * @param {MatrixEvent} event</span>
<a href="#l27.470"></a><span id="l27.470" class="difflineplus">+ * @param {EventTimeline} timeline</span>
<a href="#l27.471"></a><span id="l27.471" class="difflineplus">+ * @param {boolean} toStartOfTimeline</span>
<a href="#l27.472"></a><span id="l27.472" class="difflineplus">+ *</span>
<a href="#l27.473"></a><span id="l27.473" class="difflineplus">+ * @fires module:client~MatrixClient#event:&quot;Room.timeline&quot;</span>
<a href="#l27.474"></a><span id="l27.474" class="difflineplus">+ */</span>
<a href="#l27.475"></a><span id="l27.475" class="difflineplus">+EventTimelineSet.prototype.addEventToTimeline = function(event, timeline,</span>
<a href="#l27.476"></a><span id="l27.476" class="difflineplus">+                                                         toStartOfTimeline) {</span>
<a href="#l27.477"></a><span id="l27.477" class="difflineplus">+    var eventId = event.getId();</span>
<a href="#l27.478"></a><span id="l27.478" class="difflineplus">+    timeline.addEvent(event, toStartOfTimeline);</span>
<a href="#l27.479"></a><span id="l27.479" class="difflineplus">+    this._eventIdToTimeline[eventId] = timeline;</span>
<a href="#l27.480"></a><span id="l27.480" class="difflineplus">+</span>
<a href="#l27.481"></a><span id="l27.481" class="difflineplus">+    var data = {</span>
<a href="#l27.482"></a><span id="l27.482" class="difflineplus">+        timeline: timeline,</span>
<a href="#l27.483"></a><span id="l27.483" class="difflineplus">+        liveEvent: !toStartOfTimeline &amp;&amp; timeline == this._liveTimeline,</span>
<a href="#l27.484"></a><span id="l27.484" class="difflineplus">+    };</span>
<a href="#l27.485"></a><span id="l27.485" class="difflineplus">+    this.emit(&quot;Room.timeline&quot;, event, this.room,</span>
<a href="#l27.486"></a><span id="l27.486" class="difflineplus">+              Boolean(toStartOfTimeline), false, data);</span>
<a href="#l27.487"></a><span id="l27.487" class="difflineplus">+};</span>
<a href="#l27.488"></a><span id="l27.488" class="difflineplus">+</span>
<a href="#l27.489"></a><span id="l27.489" class="difflineplus">+/**</span>
<a href="#l27.490"></a><span id="l27.490" class="difflineplus">+ * Replaces event with ID oldEventId with one with newEventId, if oldEventId is</span>
<a href="#l27.491"></a><span id="l27.491" class="difflineplus">+ * recognised.  Otherwise, add to the live timeline.  Used to handle remote echos.</span>
<a href="#l27.492"></a><span id="l27.492" class="difflineplus">+ *</span>
<a href="#l27.493"></a><span id="l27.493" class="difflineplus">+ * @param {MatrixEvent} localEvent     the new event to be added to the timeline</span>
<a href="#l27.494"></a><span id="l27.494" class="difflineplus">+ * @param {String} oldEventId          the ID of the original event</span>
<a href="#l27.495"></a><span id="l27.495" class="difflineplus">+ * @param {boolean} newEventId         the ID of the replacement event</span>
<a href="#l27.496"></a><span id="l27.496" class="difflineplus">+ *</span>
<a href="#l27.497"></a><span id="l27.497" class="difflineplus">+ * @fires module:client~MatrixClient#event:&quot;Room.timeline&quot;</span>
<a href="#l27.498"></a><span id="l27.498" class="difflineplus">+ */</span>
<a href="#l27.499"></a><span id="l27.499" class="difflineplus">+EventTimelineSet.prototype.handleRemoteEcho = function(localEvent, oldEventId,</span>
<a href="#l27.500"></a><span id="l27.500" class="difflineplus">+                                                        newEventId) {</span>
<a href="#l27.501"></a><span id="l27.501" class="difflineplus">+    // XXX: why don't we infer newEventId from localEvent?</span>
<a href="#l27.502"></a><span id="l27.502" class="difflineplus">+    var existingTimeline = this._eventIdToTimeline[oldEventId];</span>
<a href="#l27.503"></a><span id="l27.503" class="difflineplus">+    if (existingTimeline) {</span>
<a href="#l27.504"></a><span id="l27.504" class="difflineplus">+        delete this._eventIdToTimeline[oldEventId];</span>
<a href="#l27.505"></a><span id="l27.505" class="difflineplus">+        this._eventIdToTimeline[newEventId] = existingTimeline;</span>
<a href="#l27.506"></a><span id="l27.506" class="difflineplus">+    } else {</span>
<a href="#l27.507"></a><span id="l27.507" class="difflineplus">+        if (this._filter) {</span>
<a href="#l27.508"></a><span id="l27.508" class="difflineplus">+            if (this._filter.filterRoomTimeline([localEvent]).length) {</span>
<a href="#l27.509"></a><span id="l27.509" class="difflineplus">+                this.addEventToTimeline(localEvent, this._liveTimeline, false);</span>
<a href="#l27.510"></a><span id="l27.510" class="difflineplus">+            }</span>
<a href="#l27.511"></a><span id="l27.511" class="difflineplus">+        }</span>
<a href="#l27.512"></a><span id="l27.512" class="difflineplus">+        else {</span>
<a href="#l27.513"></a><span id="l27.513" class="difflineplus">+            this.addEventToTimeline(localEvent, this._liveTimeline, false);</span>
<a href="#l27.514"></a><span id="l27.514" class="difflineplus">+        }</span>
<a href="#l27.515"></a><span id="l27.515" class="difflineplus">+    }</span>
<a href="#l27.516"></a><span id="l27.516" class="difflineplus">+};</span>
<a href="#l27.517"></a><span id="l27.517" class="difflineplus">+</span>
<a href="#l27.518"></a><span id="l27.518" class="difflineplus">+/**</span>
<a href="#l27.519"></a><span id="l27.519" class="difflineplus">+ * Removes a single event from this room.</span>
<a href="#l27.520"></a><span id="l27.520" class="difflineplus">+ *</span>
<a href="#l27.521"></a><span id="l27.521" class="difflineplus">+ * @param {String} eventId  The id of the event to remove</span>
<a href="#l27.522"></a><span id="l27.522" class="difflineplus">+ *</span>
<a href="#l27.523"></a><span id="l27.523" class="difflineplus">+ * @return {?MatrixEvent} the removed event, or null if the event was not found</span>
<a href="#l27.524"></a><span id="l27.524" class="difflineplus">+ * in this room.</span>
<a href="#l27.525"></a><span id="l27.525" class="difflineplus">+ */</span>
<a href="#l27.526"></a><span id="l27.526" class="difflineplus">+EventTimelineSet.prototype.removeEvent = function(eventId) {</span>
<a href="#l27.527"></a><span id="l27.527" class="difflineplus">+    var timeline = this._eventIdToTimeline[eventId];</span>
<a href="#l27.528"></a><span id="l27.528" class="difflineplus">+    if (!timeline) {</span>
<a href="#l27.529"></a><span id="l27.529" class="difflineplus">+        return null;</span>
<a href="#l27.530"></a><span id="l27.530" class="difflineplus">+    }</span>
<a href="#l27.531"></a><span id="l27.531" class="difflineplus">+</span>
<a href="#l27.532"></a><span id="l27.532" class="difflineplus">+    var removed = timeline.removeEvent(eventId);</span>
<a href="#l27.533"></a><span id="l27.533" class="difflineplus">+    if (removed) {</span>
<a href="#l27.534"></a><span id="l27.534" class="difflineplus">+        delete this._eventIdToTimeline[eventId];</span>
<a href="#l27.535"></a><span id="l27.535" class="difflineplus">+        var data = {</span>
<a href="#l27.536"></a><span id="l27.536" class="difflineplus">+            timeline: timeline,</span>
<a href="#l27.537"></a><span id="l27.537" class="difflineplus">+        };</span>
<a href="#l27.538"></a><span id="l27.538" class="difflineplus">+        this.emit(&quot;Room.timeline&quot;, removed, this.room, undefined, true, data);</span>
<a href="#l27.539"></a><span id="l27.539" class="difflineplus">+    }</span>
<a href="#l27.540"></a><span id="l27.540" class="difflineplus">+    return removed;</span>
<a href="#l27.541"></a><span id="l27.541" class="difflineplus">+};</span>
<a href="#l27.542"></a><span id="l27.542" class="difflineplus">+</span>
<a href="#l27.543"></a><span id="l27.543" class="difflineplus">+/**</span>
<a href="#l27.544"></a><span id="l27.544" class="difflineplus">+ * Determine where two events appear in the timeline relative to one another</span>
<a href="#l27.545"></a><span id="l27.545" class="difflineplus">+ *</span>
<a href="#l27.546"></a><span id="l27.546" class="difflineplus">+ * @param {string} eventId1   The id of the first event</span>
<a href="#l27.547"></a><span id="l27.547" class="difflineplus">+ * @param {string} eventId2   The id of the second event</span>
<a href="#l27.548"></a><span id="l27.548" class="difflineplus">+</span>
<a href="#l27.549"></a><span id="l27.549" class="difflineplus">+ * @return {?number} a number less than zero if eventId1 precedes eventId2, and</span>
<a href="#l27.550"></a><span id="l27.550" class="difflineplus">+ *    greater than zero if eventId1 succeeds eventId2. zero if they are the</span>
<a href="#l27.551"></a><span id="l27.551" class="difflineplus">+ *    same event; null if we can't tell (either because we don't know about one</span>
<a href="#l27.552"></a><span id="l27.552" class="difflineplus">+ *    of the events, or because they are in separate timelines which don't join</span>
<a href="#l27.553"></a><span id="l27.553" class="difflineplus">+ *    up).</span>
<a href="#l27.554"></a><span id="l27.554" class="difflineplus">+ */</span>
<a href="#l27.555"></a><span id="l27.555" class="difflineplus">+EventTimelineSet.prototype.compareEventOrdering = function(eventId1, eventId2) {</span>
<a href="#l27.556"></a><span id="l27.556" class="difflineplus">+    if (eventId1 == eventId2) {</span>
<a href="#l27.557"></a><span id="l27.557" class="difflineplus">+        // optimise this case</span>
<a href="#l27.558"></a><span id="l27.558" class="difflineplus">+        return 0;</span>
<a href="#l27.559"></a><span id="l27.559" class="difflineplus">+    }</span>
<a href="#l27.560"></a><span id="l27.560" class="difflineplus">+</span>
<a href="#l27.561"></a><span id="l27.561" class="difflineplus">+    var timeline1 = this._eventIdToTimeline[eventId1];</span>
<a href="#l27.562"></a><span id="l27.562" class="difflineplus">+    var timeline2 = this._eventIdToTimeline[eventId2];</span>
<a href="#l27.563"></a><span id="l27.563" class="difflineplus">+</span>
<a href="#l27.564"></a><span id="l27.564" class="difflineplus">+    if (timeline1 === undefined) {</span>
<a href="#l27.565"></a><span id="l27.565" class="difflineplus">+        return null;</span>
<a href="#l27.566"></a><span id="l27.566" class="difflineplus">+    }</span>
<a href="#l27.567"></a><span id="l27.567" class="difflineplus">+    if (timeline2 === undefined) {</span>
<a href="#l27.568"></a><span id="l27.568" class="difflineplus">+        return null;</span>
<a href="#l27.569"></a><span id="l27.569" class="difflineplus">+    }</span>
<a href="#l27.570"></a><span id="l27.570" class="difflineplus">+</span>
<a href="#l27.571"></a><span id="l27.571" class="difflineplus">+    if (timeline1 === timeline2) {</span>
<a href="#l27.572"></a><span id="l27.572" class="difflineplus">+        // both events are in the same timeline - figure out their</span>
<a href="#l27.573"></a><span id="l27.573" class="difflineplus">+        // relative indices</span>
<a href="#l27.574"></a><span id="l27.574" class="difflineplus">+        var idx1, idx2;</span>
<a href="#l27.575"></a><span id="l27.575" class="difflineplus">+        var events = timeline1.getEvents();</span>
<a href="#l27.576"></a><span id="l27.576" class="difflineplus">+        for (var idx = 0; idx &lt; events.length &amp;&amp;</span>
<a href="#l27.577"></a><span id="l27.577" class="difflineplus">+             (idx1 === undefined || idx2 === undefined); idx++) {</span>
<a href="#l27.578"></a><span id="l27.578" class="difflineplus">+            var evId = events[idx].getId();</span>
<a href="#l27.579"></a><span id="l27.579" class="difflineplus">+            if (evId == eventId1) {</span>
<a href="#l27.580"></a><span id="l27.580" class="difflineplus">+                idx1 = idx;</span>
<a href="#l27.581"></a><span id="l27.581" class="difflineplus">+            }</span>
<a href="#l27.582"></a><span id="l27.582" class="difflineplus">+            if (evId == eventId2) {</span>
<a href="#l27.583"></a><span id="l27.583" class="difflineplus">+                idx2 = idx;</span>
<a href="#l27.584"></a><span id="l27.584" class="difflineplus">+            }</span>
<a href="#l27.585"></a><span id="l27.585" class="difflineplus">+        }</span>
<a href="#l27.586"></a><span id="l27.586" class="difflineplus">+        return idx1 - idx2;</span>
<a href="#l27.587"></a><span id="l27.587" class="difflineplus">+    }</span>
<a href="#l27.588"></a><span id="l27.588" class="difflineplus">+</span>
<a href="#l27.589"></a><span id="l27.589" class="difflineplus">+    // the events are in different timelines. Iterate through the</span>
<a href="#l27.590"></a><span id="l27.590" class="difflineplus">+    // linkedlist to see which comes first.</span>
<a href="#l27.591"></a><span id="l27.591" class="difflineplus">+</span>
<a href="#l27.592"></a><span id="l27.592" class="difflineplus">+    // first work forwards from timeline1</span>
<a href="#l27.593"></a><span id="l27.593" class="difflineplus">+    var tl = timeline1;</span>
<a href="#l27.594"></a><span id="l27.594" class="difflineplus">+    while (tl) {</span>
<a href="#l27.595"></a><span id="l27.595" class="difflineplus">+        if (tl === timeline2) {</span>
<a href="#l27.596"></a><span id="l27.596" class="difflineplus">+            // timeline1 is before timeline2</span>
<a href="#l27.597"></a><span id="l27.597" class="difflineplus">+            return -1;</span>
<a href="#l27.598"></a><span id="l27.598" class="difflineplus">+        }</span>
<a href="#l27.599"></a><span id="l27.599" class="difflineplus">+        tl = tl.getNeighbouringTimeline(EventTimeline.FORWARDS);</span>
<a href="#l27.600"></a><span id="l27.600" class="difflineplus">+    }</span>
<a href="#l27.601"></a><span id="l27.601" class="difflineplus">+</span>
<a href="#l27.602"></a><span id="l27.602" class="difflineplus">+    // now try backwards from timeline1</span>
<a href="#l27.603"></a><span id="l27.603" class="difflineplus">+    tl = timeline1;</span>
<a href="#l27.604"></a><span id="l27.604" class="difflineplus">+    while (tl) {</span>
<a href="#l27.605"></a><span id="l27.605" class="difflineplus">+        if (tl === timeline2) {</span>
<a href="#l27.606"></a><span id="l27.606" class="difflineplus">+            // timeline2 is before timeline1</span>
<a href="#l27.607"></a><span id="l27.607" class="difflineplus">+            return 1;</span>
<a href="#l27.608"></a><span id="l27.608" class="difflineplus">+        }</span>
<a href="#l27.609"></a><span id="l27.609" class="difflineplus">+        tl = tl.getNeighbouringTimeline(EventTimeline.BACKWARDS);</span>
<a href="#l27.610"></a><span id="l27.610" class="difflineplus">+    }</span>
<a href="#l27.611"></a><span id="l27.611" class="difflineplus">+</span>
<a href="#l27.612"></a><span id="l27.612" class="difflineplus">+    // the timelines are not contiguous.</span>
<a href="#l27.613"></a><span id="l27.613" class="difflineplus">+    return null;</span>
<a href="#l27.614"></a><span id="l27.614" class="difflineplus">+};</span>
<a href="#l27.615"></a><span id="l27.615" class="difflineplus">+</span>
<a href="#l27.616"></a><span id="l27.616" class="difflineplus">+/**</span>
<a href="#l27.617"></a><span id="l27.617" class="difflineplus">+ * The EventTimelineSet class.</span>
<a href="#l27.618"></a><span id="l27.618" class="difflineplus">+ */</span>
<a href="#l27.619"></a><span id="l27.619" class="difflineplus">+module.exports = EventTimelineSet;</span>
<a href="#l27.620"></a><span id="l27.620" class="difflineplus">+</span>
<a href="#l27.621"></a><span id="l27.621" class="difflineplus">+/**</span>
<a href="#l27.622"></a><span id="l27.622" class="difflineplus">+ * Fires whenever the timeline in a room is updated.</span>
<a href="#l27.623"></a><span id="l27.623" class="difflineplus">+ * @event module:client~MatrixClient#&quot;Room.timeline&quot;</span>
<a href="#l27.624"></a><span id="l27.624" class="difflineplus">+ * @param {MatrixEvent} event The matrix event which caused this event to fire.</span>
<a href="#l27.625"></a><span id="l27.625" class="difflineplus">+ * @param {?Room} room The room, if any, whose timeline was updated.</span>
<a href="#l27.626"></a><span id="l27.626" class="difflineplus">+ * @param {boolean} toStartOfTimeline True if this event was added to the start</span>
<a href="#l27.627"></a><span id="l27.627" class="difflineplus">+ * @param {boolean} removed True if this event has just been removed from the timeline</span>
<a href="#l27.628"></a><span id="l27.628" class="difflineplus">+ * (beginning; oldest) of the timeline e.g. due to pagination.</span>
<a href="#l27.629"></a><span id="l27.629" class="difflineplus">+ *</span>
<a href="#l27.630"></a><span id="l27.630" class="difflineplus">+ * @param {object} data  more data about the event</span>
<a href="#l27.631"></a><span id="l27.631" class="difflineplus">+ *</span>
<a href="#l27.632"></a><span id="l27.632" class="difflineplus">+ * @param {module:event-timeline.EventTimeline} data.timeline the timeline the</span>
<a href="#l27.633"></a><span id="l27.633" class="difflineplus">+ * event was added to/removed from</span>
<a href="#l27.634"></a><span id="l27.634" class="difflineplus">+ *</span>
<a href="#l27.635"></a><span id="l27.635" class="difflineplus">+ * @param {boolean} data.liveEvent true if the event was a real-time event</span>
<a href="#l27.636"></a><span id="l27.636" class="difflineplus">+ * added to the end of the live timeline</span>
<a href="#l27.637"></a><span id="l27.637" class="difflineplus">+ *</span>
<a href="#l27.638"></a><span id="l27.638" class="difflineplus">+ * @example</span>
<a href="#l27.639"></a><span id="l27.639" class="difflineplus">+ * matrixClient.on(&quot;Room.timeline&quot;,</span>
<a href="#l27.640"></a><span id="l27.640" class="difflineplus">+ *                 function(event, room, toStartOfTimeline, removed, data) {</span>
<a href="#l27.641"></a><span id="l27.641" class="difflineplus">+ *   if (!toStartOfTimeline &amp;&amp; data.liveEvent) {</span>
<a href="#l27.642"></a><span id="l27.642" class="difflineplus">+ *     var messageToAppend = room.timeline.[room.timeline.length - 1];</span>
<a href="#l27.643"></a><span id="l27.643" class="difflineplus">+ *   }</span>
<a href="#l27.644"></a><span id="l27.644" class="difflineplus">+ * });</span>
<a href="#l27.645"></a><span id="l27.645" class="difflineplus">+ */</span>
<a href="#l27.646"></a><span id="l27.646" class="difflineplus">+</span>
<a href="#l27.647"></a><span id="l27.647" class="difflineplus">+/**</span>
<a href="#l27.648"></a><span id="l27.648" class="difflineplus">+ * Fires whenever the live timeline in a room is reset.</span>
<a href="#l27.649"></a><span id="l27.649" class="difflineplus">+ *</span>
<a href="#l27.650"></a><span id="l27.650" class="difflineplus">+ * When we get a 'limited' sync (for example, after a network outage), we reset</span>
<a href="#l27.651"></a><span id="l27.651" class="difflineplus">+ * the live timeline to be empty before adding the recent events to the new</span>
<a href="#l27.652"></a><span id="l27.652" class="difflineplus">+ * timeline. This event is fired after the timeline is reset, and before the</span>
<a href="#l27.653"></a><span id="l27.653" class="difflineplus">+ * new events are added.</span>
<a href="#l27.654"></a><span id="l27.654" class="difflineplus">+ *</span>
<a href="#l27.655"></a><span id="l27.655" class="difflineplus">+ * @event module:client~MatrixClient#&quot;Room.timelineReset&quot;</span>
<a href="#l27.656"></a><span id="l27.656" class="difflineplus">+ * @param {Room} room The room whose live timeline was reset, if any</span>
<a href="#l27.657"></a><span id="l27.657" class="difflineplus">+ * @param {EventTimelineSet} timelineSet timelineSet room whose live timeline was reset</span>
<a href="#l27.658"></a><span id="l27.658" class="difflineplus">+ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l28.1"></a><span id="l28.1">new file mode 100644</span>
<a href="#l28.2"></a><span id="l28.2" class="difflineminus">--- /dev/null</span>
<a href="#l28.3"></a><span id="l28.3" class="difflineplus">+++ b/chat/protocols/matrix/matrix-sdk/models/event-timeline.js</span>
<a href="#l28.4"></a><span id="l28.4" class="difflineat">@@ -0,0 +1,353 @@</span>
<a href="#l28.5"></a><span id="l28.5" class="difflineplus">+/*</span>
<a href="#l28.6"></a><span id="l28.6" class="difflineplus">+Copyright 2016, 2017 OpenMarket Ltd</span>
<a href="#l28.7"></a><span id="l28.7" class="difflineplus">+</span>
<a href="#l28.8"></a><span id="l28.8" class="difflineplus">+Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<a href="#l28.9"></a><span id="l28.9" class="difflineplus">+you may not use this file except in compliance with the License.</span>
<a href="#l28.10"></a><span id="l28.10" class="difflineplus">+You may obtain a copy of the License at</span>
<a href="#l28.11"></a><span id="l28.11" class="difflineplus">+</span>
<a href="#l28.12"></a><span id="l28.12" class="difflineplus">+    http://www.apache.org/licenses/LICENSE-2.0</span>
<a href="#l28.13"></a><span id="l28.13" class="difflineplus">+</span>
<a href="#l28.14"></a><span id="l28.14" class="difflineplus">+Unless required by applicable law or agreed to in writing, software</span>
<a href="#l28.15"></a><span id="l28.15" class="difflineplus">+distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<a href="#l28.16"></a><span id="l28.16" class="difflineplus">+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<a href="#l28.17"></a><span id="l28.17" class="difflineplus">+See the License for the specific language governing permissions and</span>
<a href="#l28.18"></a><span id="l28.18" class="difflineplus">+limitations under the License.</span>
<a href="#l28.19"></a><span id="l28.19" class="difflineplus">+*/</span>
<a href="#l28.20"></a><span id="l28.20" class="difflineplus">+&quot;use strict&quot;;</span>
<a href="#l28.21"></a><span id="l28.21" class="difflineplus">+</span>
<a href="#l28.22"></a><span id="l28.22" class="difflineplus">+/**</span>
<a href="#l28.23"></a><span id="l28.23" class="difflineplus">+ * @module models/event-timeline</span>
<a href="#l28.24"></a><span id="l28.24" class="difflineplus">+ */</span>
<a href="#l28.25"></a><span id="l28.25" class="difflineplus">+</span>
<a href="#l28.26"></a><span id="l28.26" class="difflineplus">+var RoomState = require(&quot;./room-state&quot;);</span>
<a href="#l28.27"></a><span id="l28.27" class="difflineplus">+var utils = require(&quot;../utils&quot;);</span>
<a href="#l28.28"></a><span id="l28.28" class="difflineplus">+var MatrixEvent = require(&quot;./event&quot;).MatrixEvent;</span>
<a href="#l28.29"></a><span id="l28.29" class="difflineplus">+</span>
<a href="#l28.30"></a><span id="l28.30" class="difflineplus">+/**</span>
<a href="#l28.31"></a><span id="l28.31" class="difflineplus">+ * Construct a new EventTimeline</span>
<a href="#l28.32"></a><span id="l28.32" class="difflineplus">+ *</span>
<a href="#l28.33"></a><span id="l28.33" class="difflineplus">+ * &lt;p&gt;An EventTimeline represents a contiguous sequence of events in a room.</span>
<a href="#l28.34"></a><span id="l28.34" class="difflineplus">+ *</span>
<a href="#l28.35"></a><span id="l28.35" class="difflineplus">+ * &lt;p&gt;As well as keeping track of the events themselves, it stores the state of</span>
<a href="#l28.36"></a><span id="l28.36" class="difflineplus">+ * the room at the beginning and end of the timeline, and pagination tokens for</span>
<a href="#l28.37"></a><span id="l28.37" class="difflineplus">+ * going backwards and forwards in the timeline.</span>
<a href="#l28.38"></a><span id="l28.38" class="difflineplus">+ *</span>
<a href="#l28.39"></a><span id="l28.39" class="difflineplus">+ * &lt;p&gt;In order that clients can meaningfully maintain an index into a timeline,</span>
<a href="#l28.40"></a><span id="l28.40" class="difflineplus">+ * the EventTimeline object tracks a 'baseIndex'. This starts at zero, but is</span>
<a href="#l28.41"></a><span id="l28.41" class="difflineplus">+ * incremented when events are prepended to the timeline. The index of an event</span>
<a href="#l28.42"></a><span id="l28.42" class="difflineplus">+ * relative to baseIndex therefore remains constant.</span>
<a href="#l28.43"></a><span id="l28.43" class="difflineplus">+ *</span>
<a href="#l28.44"></a><span id="l28.44" class="difflineplus">+ * &lt;p&gt;Once a timeline joins up with its neighbour, they are linked together into a</span>
<a href="#l28.45"></a><span id="l28.45" class="difflineplus">+ * doubly-linked list.</span>
<a href="#l28.46"></a><span id="l28.46" class="difflineplus">+ *</span>
<a href="#l28.47"></a><span id="l28.47" class="difflineplus">+ * @param {EventTimelineSet} eventTimelineSet the set of timelines this is part of</span>
<a href="#l28.48"></a><span id="l28.48" class="difflineplus">+ * @constructor</span>
<a href="#l28.49"></a><span id="l28.49" class="difflineplus">+ */</span>
<a href="#l28.50"></a><span id="l28.50" class="difflineplus">+function EventTimeline(eventTimelineSet) {</span>
<a href="#l28.51"></a><span id="l28.51" class="difflineplus">+    this._eventTimelineSet = eventTimelineSet;</span>
<a href="#l28.52"></a><span id="l28.52" class="difflineplus">+    this._roomId = eventTimelineSet.room ? eventTimelineSet.room.roomId : null;</span>
<a href="#l28.53"></a><span id="l28.53" class="difflineplus">+    this._events = [];</span>
<a href="#l28.54"></a><span id="l28.54" class="difflineplus">+    this._baseIndex = 0;</span>
<a href="#l28.55"></a><span id="l28.55" class="difflineplus">+    this._startState = new RoomState(this._roomId);</span>
<a href="#l28.56"></a><span id="l28.56" class="difflineplus">+    this._startState.paginationToken = null;</span>
<a href="#l28.57"></a><span id="l28.57" class="difflineplus">+    this._endState = new RoomState(this._roomId);</span>
<a href="#l28.58"></a><span id="l28.58" class="difflineplus">+    this._endState.paginationToken = null;</span>
<a href="#l28.59"></a><span id="l28.59" class="difflineplus">+</span>
<a href="#l28.60"></a><span id="l28.60" class="difflineplus">+    this._prevTimeline = null;</span>
<a href="#l28.61"></a><span id="l28.61" class="difflineplus">+    this._nextTimeline = null;</span>
<a href="#l28.62"></a><span id="l28.62" class="difflineplus">+</span>
<a href="#l28.63"></a><span id="l28.63" class="difflineplus">+    // this is used by client.js</span>
<a href="#l28.64"></a><span id="l28.64" class="difflineplus">+    this._paginationRequests = {'b': null, 'f': null};</span>
<a href="#l28.65"></a><span id="l28.65" class="difflineplus">+</span>
<a href="#l28.66"></a><span id="l28.66" class="difflineplus">+    this._name = this._roomId + &quot;:&quot; + new Date().toISOString();</span>
<a href="#l28.67"></a><span id="l28.67" class="difflineplus">+}</span>
<a href="#l28.68"></a><span id="l28.68" class="difflineplus">+</span>
<a href="#l28.69"></a><span id="l28.69" class="difflineplus">+/**</span>
<a href="#l28.70"></a><span id="l28.70" class="difflineplus">+ * Symbolic constant for methods which take a 'direction' argument:</span>
<a href="#l28.71"></a><span id="l28.71" class="difflineplus">+ * refers to the start of the timeline, or backwards in time.</span>
<a href="#l28.72"></a><span id="l28.72" class="difflineplus">+ */</span>
<a href="#l28.73"></a><span id="l28.73" class="difflineplus">+EventTimeline.BACKWARDS = &quot;b&quot;;</span>
<a href="#l28.74"></a><span id="l28.74" class="difflineplus">+</span>
<a href="#l28.75"></a><span id="l28.75" class="difflineplus">+/**</span>
<a href="#l28.76"></a><span id="l28.76" class="difflineplus">+ * Symbolic constant for methods which take a 'direction' argument:</span>
<a href="#l28.77"></a><span id="l28.77" class="difflineplus">+ * refers to the end of the timeline, or forwards in time.</span>
<a href="#l28.78"></a><span id="l28.78" class="difflineplus">+ */</span>
<a href="#l28.79"></a><span id="l28.79" class="difflineplus">+EventTimeline.FORWARDS = &quot;f&quot;;</span>
<a href="#l28.80"></a><span id="l28.80" class="difflineplus">+</span>
<a href="#l28.81"></a><span id="l28.81" class="difflineplus">+/**</span>
<a href="#l28.82"></a><span id="l28.82" class="difflineplus">+ * Initialise the start and end state with the given events</span>
<a href="#l28.83"></a><span id="l28.83" class="difflineplus">+ *</span>
<a href="#l28.84"></a><span id="l28.84" class="difflineplus">+ * &lt;p&gt;This can only be called before any events are added.</span>
<a href="#l28.85"></a><span id="l28.85" class="difflineplus">+ *</span>
<a href="#l28.86"></a><span id="l28.86" class="difflineplus">+ * @param {MatrixEvent[]} stateEvents list of state events to initialise the</span>
<a href="#l28.87"></a><span id="l28.87" class="difflineplus">+ * state with.</span>
<a href="#l28.88"></a><span id="l28.88" class="difflineplus">+ * @throws {Error} if an attempt is made to call this after addEvent is called.</span>
<a href="#l28.89"></a><span id="l28.89" class="difflineplus">+ */</span>
<a href="#l28.90"></a><span id="l28.90" class="difflineplus">+EventTimeline.prototype.initialiseState = function(stateEvents) {</span>
<a href="#l28.91"></a><span id="l28.91" class="difflineplus">+    if (this._events.length &gt; 0) {</span>
<a href="#l28.92"></a><span id="l28.92" class="difflineplus">+        throw new Error(&quot;Cannot initialise state after events are added&quot;);</span>
<a href="#l28.93"></a><span id="l28.93" class="difflineplus">+    }</span>
<a href="#l28.94"></a><span id="l28.94" class="difflineplus">+</span>
<a href="#l28.95"></a><span id="l28.95" class="difflineplus">+    // we deep-copy the events here, in case they get changed later - we don't</span>
<a href="#l28.96"></a><span id="l28.96" class="difflineplus">+    // want changes to the start state leaking through to the end state.</span>
<a href="#l28.97"></a><span id="l28.97" class="difflineplus">+    var oldStateEvents = utils.map(</span>
<a href="#l28.98"></a><span id="l28.98" class="difflineplus">+        utils.deepCopy(</span>
<a href="#l28.99"></a><span id="l28.99" class="difflineplus">+            stateEvents.map(function(mxEvent) { return mxEvent.event; })</span>
<a href="#l28.100"></a><span id="l28.100" class="difflineplus">+        ), function(ev) { return new MatrixEvent(ev); });</span>
<a href="#l28.101"></a><span id="l28.101" class="difflineplus">+</span>
<a href="#l28.102"></a><span id="l28.102" class="difflineplus">+    this._startState.setStateEvents(oldStateEvents);</span>
<a href="#l28.103"></a><span id="l28.103" class="difflineplus">+    this._endState.setStateEvents(stateEvents);</span>
<a href="#l28.104"></a><span id="l28.104" class="difflineplus">+};</span>
<a href="#l28.105"></a><span id="l28.105" class="difflineplus">+</span>
<a href="#l28.106"></a><span id="l28.106" class="difflineplus">+/**</span>
<a href="#l28.107"></a><span id="l28.107" class="difflineplus">+ * Get the ID of the room for this timeline</span>
<a href="#l28.108"></a><span id="l28.108" class="difflineplus">+ * @return {string} room ID</span>
<a href="#l28.109"></a><span id="l28.109" class="difflineplus">+ */</span>
<a href="#l28.110"></a><span id="l28.110" class="difflineplus">+EventTimeline.prototype.getRoomId = function() {</span>
<a href="#l28.111"></a><span id="l28.111" class="difflineplus">+    return this._roomId;</span>
<a href="#l28.112"></a><span id="l28.112" class="difflineplus">+};</span>
<a href="#l28.113"></a><span id="l28.113" class="difflineplus">+</span>
<a href="#l28.114"></a><span id="l28.114" class="difflineplus">+/**</span>
<a href="#l28.115"></a><span id="l28.115" class="difflineplus">+ * Get the filter for this timeline's timelineSet (if any)</span>
<a href="#l28.116"></a><span id="l28.116" class="difflineplus">+ * @return {Filter} filter</span>
<a href="#l28.117"></a><span id="l28.117" class="difflineplus">+ */</span>
<a href="#l28.118"></a><span id="l28.118" class="difflineplus">+EventTimeline.prototype.getFilter = function() {</span>
<a href="#l28.119"></a><span id="l28.119" class="difflineplus">+    return this._eventTimelineSet.getFilter();</span>
<a href="#l28.120"></a><span id="l28.120" class="difflineplus">+};</span>
<a href="#l28.121"></a><span id="l28.121" class="difflineplus">+</span>
<a href="#l28.122"></a><span id="l28.122" class="difflineplus">+/**</span>
<a href="#l28.123"></a><span id="l28.123" class="difflineplus">+ * Get the timelineSet for this timeline</span>
<a href="#l28.124"></a><span id="l28.124" class="difflineplus">+ * @return {EventTimelineSet} timelineSet</span>
<a href="#l28.125"></a><span id="l28.125" class="difflineplus">+ */</span>
<a href="#l28.126"></a><span id="l28.126" class="difflineplus">+EventTimeline.prototype.getTimelineSet = function() {</span>
<a href="#l28.127"></a><span id="l28.127" class="difflineplus">+    return this._eventTimelineSet;</span>
<a href="#l28.128"></a><span id="l28.128" class="difflineplus">+};</span>
<a href="#l28.129"></a><span id="l28.129" class="difflineplus">+</span>
<a href="#l28.130"></a><span id="l28.130" class="difflineplus">+/**</span>
<a href="#l28.131"></a><span id="l28.131" class="difflineplus">+ * Get the base index.</span>
<a href="#l28.132"></a><span id="l28.132" class="difflineplus">+ *</span>
<a href="#l28.133"></a><span id="l28.133" class="difflineplus">+ * &lt;p&gt;This is an index which is incremented when events are prepended to the</span>
<a href="#l28.134"></a><span id="l28.134" class="difflineplus">+ * timeline. An individual event therefore stays at the same index in the array</span>
<a href="#l28.135"></a><span id="l28.135" class="difflineplus">+ * relative to the base index (although note that a given event's index may</span>
<a href="#l28.136"></a><span id="l28.136" class="difflineplus">+ * well be less than the base index, thus giving that event a negative relative</span>
<a href="#l28.137"></a><span id="l28.137" class="difflineplus">+ * index).</span>
<a href="#l28.138"></a><span id="l28.138" class="difflineplus">+ *</span>
<a href="#l28.139"></a><span id="l28.139" class="difflineplus">+ * @return {number}</span>
<a href="#l28.140"></a><span id="l28.140" class="difflineplus">+ */</span>
<a href="#l28.141"></a><span id="l28.141" class="difflineplus">+EventTimeline.prototype.getBaseIndex = function() {</span>
<a href="#l28.142"></a><span id="l28.142" class="difflineplus">+    return this._baseIndex;</span>
<a href="#l28.143"></a><span id="l28.143" class="difflineplus">+};</span>
<a href="#l28.144"></a><span id="l28.144" class="difflineplus">+</span>
<a href="#l28.145"></a><span id="l28.145" class="difflineplus">+/**</span>
<a href="#l28.146"></a><span id="l28.146" class="difflineplus">+ * Get the list of events in this context</span>
<a href="#l28.147"></a><span id="l28.147" class="difflineplus">+ *</span>
<a href="#l28.148"></a><span id="l28.148" class="difflineplus">+ * @return {MatrixEvent[]} An array of MatrixEvents</span>
<a href="#l28.149"></a><span id="l28.149" class="difflineplus">+ */</span>
<a href="#l28.150"></a><span id="l28.150" class="difflineplus">+EventTimeline.prototype.getEvents = function() {</span>
<a href="#l28.151"></a><span id="l28.151" class="difflineplus">+    return this._events;</span>
<a href="#l28.152"></a><span id="l28.152" class="difflineplus">+};</span>
<a href="#l28.153"></a><span id="l28.153" class="difflineplus">+</span>
<a href="#l28.154"></a><span id="l28.154" class="difflineplus">+/**</span>
<a href="#l28.155"></a><span id="l28.155" class="difflineplus">+ * Get the room state at the start/end of the timeline</span>
<a href="#l28.156"></a><span id="l28.156" class="difflineplus">+ *</span>
<a href="#l28.157"></a><span id="l28.157" class="difflineplus">+ * @param {string} direction   EventTimeline.BACKWARDS to get the state at the</span>
<a href="#l28.158"></a><span id="l28.158" class="difflineplus">+ *   start of the timeline; EventTimeline.FORWARDS to get the state at the end</span>
<a href="#l28.159"></a><span id="l28.159" class="difflineplus">+ *   of the timeline.</span>
<a href="#l28.160"></a><span id="l28.160" class="difflineplus">+ *</span>
<a href="#l28.161"></a><span id="l28.161" class="difflineplus">+ * @return {RoomState} state at the start/end of the timeline</span>
<a href="#l28.162"></a><span id="l28.162" class="difflineplus">+ */</span>
<a href="#l28.163"></a><span id="l28.163" class="difflineplus">+EventTimeline.prototype.getState = function(direction) {</span>
<a href="#l28.164"></a><span id="l28.164" class="difflineplus">+    if (direction == EventTimeline.BACKWARDS) {</span>
<a href="#l28.165"></a><span id="l28.165" class="difflineplus">+        return this._startState;</span>
<a href="#l28.166"></a><span id="l28.166" class="difflineplus">+    } else if (direction == EventTimeline.FORWARDS) {</span>
<a href="#l28.167"></a><span id="l28.167" class="difflineplus">+        return this._endState;</span>
<a href="#l28.168"></a><span id="l28.168" class="difflineplus">+    } else {</span>
<a href="#l28.169"></a><span id="l28.169" class="difflineplus">+        throw new Error(&quot;Invalid direction '&quot; + direction + &quot;'&quot;);</span>
<a href="#l28.170"></a><span id="l28.170" class="difflineplus">+    }</span>
<a href="#l28.171"></a><span id="l28.171" class="difflineplus">+};</span>
<a href="#l28.172"></a><span id="l28.172" class="difflineplus">+</span>
<a href="#l28.173"></a><span id="l28.173" class="difflineplus">+/**</span>
<a href="#l28.174"></a><span id="l28.174" class="difflineplus">+ * Get a pagination token</span>
<a href="#l28.175"></a><span id="l28.175" class="difflineplus">+ *</span>
<a href="#l28.176"></a><span id="l28.176" class="difflineplus">+ * @param {string} direction   EventTimeline.BACKWARDS to get the pagination</span>
<a href="#l28.177"></a><span id="l28.177" class="difflineplus">+ *   token for going backwards in time; EventTimeline.FORWARDS to get the</span>
<a href="#l28.178"></a><span id="l28.178" class="difflineplus">+ *   pagination token for going forwards in time.</span>
<a href="#l28.179"></a><span id="l28.179" class="difflineplus">+ *</span>
<a href="#l28.180"></a><span id="l28.180" class="difflineplus">+ * @return {?string} pagination token</span>
<a href="#l28.181"></a><span id="l28.181" class="difflineplus">+ */</span>
<a href="#l28.182"></a><span id="l28.182" class="difflineplus">+EventTimeline.prototype.getPaginationToken = function(direction) {</span>
<a href="#l28.183"></a><span id="l28.183" class="difflineplus">+    return this.getState(direction).paginationToken;</span>
<a href="#l28.184"></a><span id="l28.184" class="difflineplus">+};</span>
<a href="#l28.185"></a><span id="l28.185" class="difflineplus">+</span>
<a href="#l28.186"></a><span id="l28.186" class="difflineplus">+/**</span>
<a href="#l28.187"></a><span id="l28.187" class="difflineplus">+ * Set a pagination token</span>
<a href="#l28.188"></a><span id="l28.188" class="difflineplus">+ *</span>
<a href="#l28.189"></a><span id="l28.189" class="difflineplus">+ * @param {?string} token       pagination token</span>
<a href="#l28.190"></a><span id="l28.190" class="difflineplus">+ *</span>
<a href="#l28.191"></a><span id="l28.191" class="difflineplus">+ * @param {string} direction    EventTimeline.BACKWARDS to set the pagination</span>
<a href="#l28.192"></a><span id="l28.192" class="difflineplus">+ *   token for going backwards in time; EventTimeline.FORWARDS to set the</span>
<a href="#l28.193"></a><span id="l28.193" class="difflineplus">+ *   pagination token for going forwards in time.</span>
<a href="#l28.194"></a><span id="l28.194" class="difflineplus">+ */</span>
<a href="#l28.195"></a><span id="l28.195" class="difflineplus">+EventTimeline.prototype.setPaginationToken = function(token, direction) {</span>
<a href="#l28.196"></a><span id="l28.196" class="difflineplus">+    this.getState(direction).paginationToken = token;</span>
<a href="#l28.197"></a><span id="l28.197" class="difflineplus">+};</span>
<a href="#l28.198"></a><span id="l28.198" class="difflineplus">+</span>
<a href="#l28.199"></a><span id="l28.199" class="difflineplus">+/**</span>
<a href="#l28.200"></a><span id="l28.200" class="difflineplus">+ * Get the next timeline in the series</span>
<a href="#l28.201"></a><span id="l28.201" class="difflineplus">+ *</span>
<a href="#l28.202"></a><span id="l28.202" class="difflineplus">+ * @param {string} direction EventTimeline.BACKWARDS to get the previous</span>
<a href="#l28.203"></a><span id="l28.203" class="difflineplus">+ *   timeline; EventTimeline.FORWARDS to get the next timeline.</span>
<a href="#l28.204"></a><span id="l28.204" class="difflineplus">+ *</span>
<a href="#l28.205"></a><span id="l28.205" class="difflineplus">+ * @return {?EventTimeline} previous or following timeline, if they have been</span>
<a href="#l28.206"></a><span id="l28.206" class="difflineplus">+ * joined up.</span>
<a href="#l28.207"></a><span id="l28.207" class="difflineplus">+ */</span>
<a href="#l28.208"></a><span id="l28.208" class="difflineplus">+EventTimeline.prototype.getNeighbouringTimeline = function(direction) {</span>
<a href="#l28.209"></a><span id="l28.209" class="difflineplus">+    if (direction == EventTimeline.BACKWARDS) {</span>
<a href="#l28.210"></a><span id="l28.210" class="difflineplus">+        return this._prevTimeline;</span>
<a href="#l28.211"></a><span id="l28.211" class="difflineplus">+    } else if (direction == EventTimeline.FORWARDS) {</span>
<a href="#l28.212"></a><span id="l28.212" class="difflineplus">+        return this._nextTimeline;</span>
<a href="#l28.213"></a><span id="l28.213" class="difflineplus">+    } else {</span>
<a href="#l28.214"></a><span id="l28.214" class="difflineplus">+        throw new Error(&quot;Invalid direction '&quot; + direction + &quot;'&quot;);</span>
<a href="#l28.215"></a><span id="l28.215" class="difflineplus">+    }</span>
<a href="#l28.216"></a><span id="l28.216" class="difflineplus">+};</span>
<a href="#l28.217"></a><span id="l28.217" class="difflineplus">+</span>
<a href="#l28.218"></a><span id="l28.218" class="difflineplus">+/**</span>
<a href="#l28.219"></a><span id="l28.219" class="difflineplus">+ * Set the next timeline in the series</span>
<a href="#l28.220"></a><span id="l28.220" class="difflineplus">+ *</span>
<a href="#l28.221"></a><span id="l28.221" class="difflineplus">+ * @param {EventTimeline} neighbour previous/following timeline</span>
<a href="#l28.222"></a><span id="l28.222" class="difflineplus">+ *</span>
<a href="#l28.223"></a><span id="l28.223" class="difflineplus">+ * @param {string} direction EventTimeline.BACKWARDS to set the previous</span>
<a href="#l28.224"></a><span id="l28.224" class="difflineplus">+ *   timeline; EventTimeline.FORWARDS to set the next timeline.</span>
<a href="#l28.225"></a><span id="l28.225" class="difflineplus">+ *</span>
<a href="#l28.226"></a><span id="l28.226" class="difflineplus">+ * @throws {Error} if an attempt is made to set the neighbouring timeline when</span>
<a href="#l28.227"></a><span id="l28.227" class="difflineplus">+ * it is already set.</span>
<a href="#l28.228"></a><span id="l28.228" class="difflineplus">+ */</span>
<a href="#l28.229"></a><span id="l28.229" class="difflineplus">+EventTimeline.prototype.setNeighbouringTimeline = function(neighbour, direction) {</span>
<a href="#l28.230"></a><span id="l28.230" class="difflineplus">+    if (this.getNeighbouringTimeline(direction)) {</span>
<a href="#l28.231"></a><span id="l28.231" class="difflineplus">+        throw new Error(&quot;timeline already has a neighbouring timeline - &quot; +</span>
<a href="#l28.232"></a><span id="l28.232" class="difflineplus">+                        &quot;cannot reset neighbour&quot;);</span>
<a href="#l28.233"></a><span id="l28.233" class="difflineplus">+    }</span>
<a href="#l28.234"></a><span id="l28.234" class="difflineplus">+</span>
<a href="#l28.235"></a><span id="l28.235" class="difflineplus">+    if (direction == EventTimeline.BACKWARDS) {</span>
<a href="#l28.236"></a><span id="l28.236" class="difflineplus">+        this._prevTimeline = neighbour;</span>
<a href="#l28.237"></a><span id="l28.237" class="difflineplus">+    } else if (direction == EventTimeline.FORWARDS) {</span>
<a href="#l28.238"></a><span id="l28.238" class="difflineplus">+        this._nextTimeline = neighbour;</span>
<a href="#l28.239"></a><span id="l28.239" class="difflineplus">+    } else {</span>
<a href="#l28.240"></a><span id="l28.240" class="difflineplus">+        throw new Error(&quot;Invalid direction '&quot; + direction + &quot;'&quot;);</span>
<a href="#l28.241"></a><span id="l28.241" class="difflineplus">+    }</span>
<a href="#l28.242"></a><span id="l28.242" class="difflineplus">+</span>
<a href="#l28.243"></a><span id="l28.243" class="difflineplus">+    // make sure we don't try to paginate this timeline</span>
<a href="#l28.244"></a><span id="l28.244" class="difflineplus">+    this.setPaginationToken(null, direction);</span>
<a href="#l28.245"></a><span id="l28.245" class="difflineplus">+};</span>
<a href="#l28.246"></a><span id="l28.246" class="difflineplus">+</span>
<a href="#l28.247"></a><span id="l28.247" class="difflineplus">+/**</span>
<a href="#l28.248"></a><span id="l28.248" class="difflineplus">+ * Add a new event to the timeline, and update the state</span>
<a href="#l28.249"></a><span id="l28.249" class="difflineplus">+ *</span>
<a href="#l28.250"></a><span id="l28.250" class="difflineplus">+ * @param {MatrixEvent} event   new event</span>
<a href="#l28.251"></a><span id="l28.251" class="difflineplus">+ * @param {boolean}  atStart     true to insert new event at the start</span>
<a href="#l28.252"></a><span id="l28.252" class="difflineplus">+ */</span>
<a href="#l28.253"></a><span id="l28.253" class="difflineplus">+EventTimeline.prototype.addEvent = function(event, atStart) {</span>
<a href="#l28.254"></a><span id="l28.254" class="difflineplus">+    var stateContext = atStart ? this._startState : this._endState;</span>
<a href="#l28.255"></a><span id="l28.255" class="difflineplus">+</span>
<a href="#l28.256"></a><span id="l28.256" class="difflineplus">+    // only call setEventMetadata on the unfiltered timelineSets</span>
<a href="#l28.257"></a><span id="l28.257" class="difflineplus">+    var timelineSet = this.getTimelineSet();</span>
<a href="#l28.258"></a><span id="l28.258" class="difflineplus">+    if (timelineSet.room &amp;&amp;</span>
<a href="#l28.259"></a><span id="l28.259" class="difflineplus">+        timelineSet.room.getUnfilteredTimelineSet() === timelineSet)</span>
<a href="#l28.260"></a><span id="l28.260" class="difflineplus">+    {</span>
<a href="#l28.261"></a><span id="l28.261" class="difflineplus">+        EventTimeline.setEventMetadata(event, stateContext, atStart);</span>
<a href="#l28.262"></a><span id="l28.262" class="difflineplus">+</span>
<a href="#l28.263"></a><span id="l28.263" class="difflineplus">+        // modify state</span>
<a href="#l28.264"></a><span id="l28.264" class="difflineplus">+        if (event.isState()) {</span>
<a href="#l28.265"></a><span id="l28.265" class="difflineplus">+            stateContext.setStateEvents([event]);</span>
<a href="#l28.266"></a><span id="l28.266" class="difflineplus">+            // it is possible that the act of setting the state event means we</span>
<a href="#l28.267"></a><span id="l28.267" class="difflineplus">+            // can set more metadata (specifically sender/target props), so try</span>
<a href="#l28.268"></a><span id="l28.268" class="difflineplus">+            // it again if the prop wasn't previously set. It may also mean that</span>
<a href="#l28.269"></a><span id="l28.269" class="difflineplus">+            // the sender/target is updated (if the event set was a room member event)</span>
<a href="#l28.270"></a><span id="l28.270" class="difflineplus">+            // so we want to use the *updated* member (new avatar/name) instead.</span>
<a href="#l28.271"></a><span id="l28.271" class="difflineplus">+            //</span>
<a href="#l28.272"></a><span id="l28.272" class="difflineplus">+            // However, we do NOT want to do this on member events if we're going</span>
<a href="#l28.273"></a><span id="l28.273" class="difflineplus">+            // back in time, else we'll set the .sender value for BEFORE the given</span>
<a href="#l28.274"></a><span id="l28.274" class="difflineplus">+            // member event, whereas we want to set the .sender value for the ACTUAL</span>
<a href="#l28.275"></a><span id="l28.275" class="difflineplus">+            // member event itself.</span>
<a href="#l28.276"></a><span id="l28.276" class="difflineplus">+            if (!event.sender || (event.getType() === &quot;m.room.member&quot; &amp;&amp; !atStart)) {</span>
<a href="#l28.277"></a><span id="l28.277" class="difflineplus">+                EventTimeline.setEventMetadata(event, stateContext, atStart);</span>
<a href="#l28.278"></a><span id="l28.278" class="difflineplus">+            }</span>
<a href="#l28.279"></a><span id="l28.279" class="difflineplus">+        }</span>
<a href="#l28.280"></a><span id="l28.280" class="difflineplus">+    }</span>
<a href="#l28.281"></a><span id="l28.281" class="difflineplus">+</span>
<a href="#l28.282"></a><span id="l28.282" class="difflineplus">+    var insertIndex;</span>
<a href="#l28.283"></a><span id="l28.283" class="difflineplus">+</span>
<a href="#l28.284"></a><span id="l28.284" class="difflineplus">+    if (atStart) {</span>
<a href="#l28.285"></a><span id="l28.285" class="difflineplus">+        insertIndex = 0;</span>
<a href="#l28.286"></a><span id="l28.286" class="difflineplus">+    } else {</span>
<a href="#l28.287"></a><span id="l28.287" class="difflineplus">+        insertIndex = this._events.length;</span>
<a href="#l28.288"></a><span id="l28.288" class="difflineplus">+    }</span>
<a href="#l28.289"></a><span id="l28.289" class="difflineplus">+</span>
<a href="#l28.290"></a><span id="l28.290" class="difflineplus">+    this._events.splice(insertIndex, 0, event); // insert element</span>
<a href="#l28.291"></a><span id="l28.291" class="difflineplus">+    if (atStart) {</span>
<a href="#l28.292"></a><span id="l28.292" class="difflineplus">+        this._baseIndex++;</span>
<a href="#l28.293"></a><span id="l28.293" class="difflineplus">+    }</span>
<a href="#l28.294"></a><span id="l28.294" class="difflineplus">+};</span>
<a href="#l28.295"></a><span id="l28.295" class="difflineplus">+</span>
<a href="#l28.296"></a><span id="l28.296" class="difflineplus">+/**</span>
<a href="#l28.297"></a><span id="l28.297" class="difflineplus">+ * Static helper method to set sender and target properties</span>
<a href="#l28.298"></a><span id="l28.298" class="difflineplus">+ *</span>
<a href="#l28.299"></a><span id="l28.299" class="difflineplus">+ * @param {MatrixEvent} event   the event whose metadata is to be set</span>
<a href="#l28.300"></a><span id="l28.300" class="difflineplus">+ * @param {RoomState} stateContext  the room state to be queried</span>
<a href="#l28.301"></a><span id="l28.301" class="difflineplus">+ * @param {bool} toStartOfTimeline  if true the event's forwardLooking flag is set false</span>
<a href="#l28.302"></a><span id="l28.302" class="difflineplus">+ */</span>
<a href="#l28.303"></a><span id="l28.303" class="difflineplus">+EventTimeline.setEventMetadata = function(event, stateContext, toStartOfTimeline) {</span>
<a href="#l28.304"></a><span id="l28.304" class="difflineplus">+    // set sender and target properties</span>
<a href="#l28.305"></a><span id="l28.305" class="difflineplus">+    event.sender = stateContext.getSentinelMember(</span>
<a href="#l28.306"></a><span id="l28.306" class="difflineplus">+        event.getSender()</span>
<a href="#l28.307"></a><span id="l28.307" class="difflineplus">+    );</span>
<a href="#l28.308"></a><span id="l28.308" class="difflineplus">+    if (event.getType() === &quot;m.room.member&quot;) {</span>
<a href="#l28.309"></a><span id="l28.309" class="difflineplus">+        event.target = stateContext.getSentinelMember(</span>
<a href="#l28.310"></a><span id="l28.310" class="difflineplus">+            event.getStateKey()</span>
<a href="#l28.311"></a><span id="l28.311" class="difflineplus">+        );</span>
<a href="#l28.312"></a><span id="l28.312" class="difflineplus">+    }</span>
<a href="#l28.313"></a><span id="l28.313" class="difflineplus">+    if (event.isState()) {</span>
<a href="#l28.314"></a><span id="l28.314" class="difflineplus">+        // room state has no concept of 'old' or 'current', but we want the</span>
<a href="#l28.315"></a><span id="l28.315" class="difflineplus">+        // room state to regress back to previous values if toStartOfTimeline</span>
<a href="#l28.316"></a><span id="l28.316" class="difflineplus">+        // is set, which means inspecting prev_content if it exists. This</span>
<a href="#l28.317"></a><span id="l28.317" class="difflineplus">+        // is done by toggling the forwardLooking flag.</span>
<a href="#l28.318"></a><span id="l28.318" class="difflineplus">+        if (toStartOfTimeline) {</span>
<a href="#l28.319"></a><span id="l28.319" class="difflineplus">+            event.forwardLooking = false;</span>
<a href="#l28.320"></a><span id="l28.320" class="difflineplus">+        }</span>
<a href="#l28.321"></a><span id="l28.321" class="difflineplus">+    }</span>
<a href="#l28.322"></a><span id="l28.322" class="difflineplus">+};</span>
<a href="#l28.323"></a><span id="l28.323" class="difflineplus">+</span>
<a href="#l28.324"></a><span id="l28.324" class="difflineplus">+/**</span>
<a href="#l28.325"></a><span id="l28.325" class="difflineplus">+ * Remove an event from the timeline</span>
<a href="#l28.326"></a><span id="l28.326" class="difflineplus">+ *</span>
<a href="#l28.327"></a><span id="l28.327" class="difflineplus">+ * @param {string} eventId  ID of event to be removed</span>
<a href="#l28.328"></a><span id="l28.328" class="difflineplus">+ * @return {?MatrixEvent} removed event, or null if not found</span>
<a href="#l28.329"></a><span id="l28.329" class="difflineplus">+ */</span>
<a href="#l28.330"></a><span id="l28.330" class="difflineplus">+EventTimeline.prototype.removeEvent = function(eventId) {</span>
<a href="#l28.331"></a><span id="l28.331" class="difflineplus">+    for (var i = this._events.length - 1; i &gt;= 0; i--) {</span>
<a href="#l28.332"></a><span id="l28.332" class="difflineplus">+        var ev = this._events[i];</span>
<a href="#l28.333"></a><span id="l28.333" class="difflineplus">+        if (ev.getId() == eventId) {</span>
<a href="#l28.334"></a><span id="l28.334" class="difflineplus">+            this._events.splice(i, 1);</span>
<a href="#l28.335"></a><span id="l28.335" class="difflineplus">+            if (i &lt; this._baseIndex) {</span>
<a href="#l28.336"></a><span id="l28.336" class="difflineplus">+                this._baseIndex--;</span>
<a href="#l28.337"></a><span id="l28.337" class="difflineplus">+            }</span>
<a href="#l28.338"></a><span id="l28.338" class="difflineplus">+            return ev;</span>
<a href="#l28.339"></a><span id="l28.339" class="difflineplus">+        }</span>
<a href="#l28.340"></a><span id="l28.340" class="difflineplus">+    }</span>
<a href="#l28.341"></a><span id="l28.341" class="difflineplus">+    return null;</span>
<a href="#l28.342"></a><span id="l28.342" class="difflineplus">+};</span>
<a href="#l28.343"></a><span id="l28.343" class="difflineplus">+</span>
<a href="#l28.344"></a><span id="l28.344" class="difflineplus">+/**</span>
<a href="#l28.345"></a><span id="l28.345" class="difflineplus">+ * Return a string to identify this timeline, for debugging</span>
<a href="#l28.346"></a><span id="l28.346" class="difflineplus">+ *</span>
<a href="#l28.347"></a><span id="l28.347" class="difflineplus">+ * @return {string} name for this timeline</span>
<a href="#l28.348"></a><span id="l28.348" class="difflineplus">+ */</span>
<a href="#l28.349"></a><span id="l28.349" class="difflineplus">+EventTimeline.prototype.toString = function() {</span>
<a href="#l28.350"></a><span id="l28.350" class="difflineplus">+    return this._name;</span>
<a href="#l28.351"></a><span id="l28.351" class="difflineplus">+};</span>
<a href="#l28.352"></a><span id="l28.352" class="difflineplus">+</span>
<a href="#l28.353"></a><span id="l28.353" class="difflineplus">+</span>
<a href="#l28.354"></a><span id="l28.354" class="difflineplus">+/**</span>
<a href="#l28.355"></a><span id="l28.355" class="difflineplus">+ * The EventTimeline class</span>
<a href="#l28.356"></a><span id="l28.356" class="difflineplus">+ */</span>
<a href="#l28.357"></a><span id="l28.357" class="difflineplus">+module.exports = EventTimeline;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l29.1"></a><span id="l29.1">new file mode 100644</span>
<a href="#l29.2"></a><span id="l29.2" class="difflineminus">--- /dev/null</span>
<a href="#l29.3"></a><span id="l29.3" class="difflineplus">+++ b/chat/protocols/matrix/matrix-sdk/models/event.js</span>
<a href="#l29.4"></a><span id="l29.4" class="difflineat">@@ -0,0 +1,429 @@</span>
<a href="#l29.5"></a><span id="l29.5" class="difflineplus">+/*</span>
<a href="#l29.6"></a><span id="l29.6" class="difflineplus">+Copyright 2015, 2016 OpenMarket Ltd</span>
<a href="#l29.7"></a><span id="l29.7" class="difflineplus">+</span>
<a href="#l29.8"></a><span id="l29.8" class="difflineplus">+Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<a href="#l29.9"></a><span id="l29.9" class="difflineplus">+you may not use this file except in compliance with the License.</span>
<a href="#l29.10"></a><span id="l29.10" class="difflineplus">+You may obtain a copy of the License at</span>
<a href="#l29.11"></a><span id="l29.11" class="difflineplus">+</span>
<a href="#l29.12"></a><span id="l29.12" class="difflineplus">+    http://www.apache.org/licenses/LICENSE-2.0</span>
<a href="#l29.13"></a><span id="l29.13" class="difflineplus">+</span>
<a href="#l29.14"></a><span id="l29.14" class="difflineplus">+Unless required by applicable law or agreed to in writing, software</span>
<a href="#l29.15"></a><span id="l29.15" class="difflineplus">+distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<a href="#l29.16"></a><span id="l29.16" class="difflineplus">+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<a href="#l29.17"></a><span id="l29.17" class="difflineplus">+See the License for the specific language governing permissions and</span>
<a href="#l29.18"></a><span id="l29.18" class="difflineplus">+limitations under the License.</span>
<a href="#l29.19"></a><span id="l29.19" class="difflineplus">+*/</span>
<a href="#l29.20"></a><span id="l29.20" class="difflineplus">+&quot;use strict&quot;;</span>
<a href="#l29.21"></a><span id="l29.21" class="difflineplus">+</span>
<a href="#l29.22"></a><span id="l29.22" class="difflineplus">+/**</span>
<a href="#l29.23"></a><span id="l29.23" class="difflineplus">+ * This is an internal module. See {@link MatrixEvent} and {@link RoomEvent} for</span>
<a href="#l29.24"></a><span id="l29.24" class="difflineplus">+ * the public classes.</span>
<a href="#l29.25"></a><span id="l29.25" class="difflineplus">+ * @module models/event</span>
<a href="#l29.26"></a><span id="l29.26" class="difflineplus">+ */</span>
<a href="#l29.27"></a><span id="l29.27" class="difflineplus">+</span>
<a href="#l29.28"></a><span id="l29.28" class="difflineplus">+var EventEmitter = require(&quot;events&quot;).EventEmitter;</span>
<a href="#l29.29"></a><span id="l29.29" class="difflineplus">+</span>
<a href="#l29.30"></a><span id="l29.30" class="difflineplus">+var utils = require('../utils.js');</span>
<a href="#l29.31"></a><span id="l29.31" class="difflineplus">+</span>
<a href="#l29.32"></a><span id="l29.32" class="difflineplus">+/**</span>
<a href="#l29.33"></a><span id="l29.33" class="difflineplus">+ * Enum for event statuses.</span>
<a href="#l29.34"></a><span id="l29.34" class="difflineplus">+ * @readonly</span>
<a href="#l29.35"></a><span id="l29.35" class="difflineplus">+ * @enum {string}</span>
<a href="#l29.36"></a><span id="l29.36" class="difflineplus">+ */</span>
<a href="#l29.37"></a><span id="l29.37" class="difflineplus">+module.exports.EventStatus = {</span>
<a href="#l29.38"></a><span id="l29.38" class="difflineplus">+    /** The event was not sent and will no longer be retried. */</span>
<a href="#l29.39"></a><span id="l29.39" class="difflineplus">+    NOT_SENT: &quot;not_sent&quot;,</span>
<a href="#l29.40"></a><span id="l29.40" class="difflineplus">+</span>
<a href="#l29.41"></a><span id="l29.41" class="difflineplus">+    /** The message is being encrypted */</span>
<a href="#l29.42"></a><span id="l29.42" class="difflineplus">+    ENCRYPTING: &quot;encrypting&quot;,</span>
<a href="#l29.43"></a><span id="l29.43" class="difflineplus">+</span>
<a href="#l29.44"></a><span id="l29.44" class="difflineplus">+    /** The event is in the process of being sent. */</span>
<a href="#l29.45"></a><span id="l29.45" class="difflineplus">+    SENDING: &quot;sending&quot;,</span>
<a href="#l29.46"></a><span id="l29.46" class="difflineplus">+    /** The event is in a queue waiting to be sent. */</span>
<a href="#l29.47"></a><span id="l29.47" class="difflineplus">+    QUEUED: &quot;queued&quot;,</span>
<a href="#l29.48"></a><span id="l29.48" class="difflineplus">+    /** The event has been sent to the server, but we have not yet received the</span>
<a href="#l29.49"></a><span id="l29.49" class="difflineplus">+     * echo. */</span>
<a href="#l29.50"></a><span id="l29.50" class="difflineplus">+    SENT: &quot;sent&quot;,</span>
<a href="#l29.51"></a><span id="l29.51" class="difflineplus">+</span>
<a href="#l29.52"></a><span id="l29.52" class="difflineplus">+    /** The event was cancelled before it was successfully sent. */</span>
<a href="#l29.53"></a><span id="l29.53" class="difflineplus">+    CANCELLED: &quot;cancelled&quot;,</span>
<a href="#l29.54"></a><span id="l29.54" class="difflineplus">+};</span>
<a href="#l29.55"></a><span id="l29.55" class="difflineplus">+</span>
<a href="#l29.56"></a><span id="l29.56" class="difflineplus">+/**</span>
<a href="#l29.57"></a><span id="l29.57" class="difflineplus">+ * Construct a Matrix Event object</span>
<a href="#l29.58"></a><span id="l29.58" class="difflineplus">+ * @constructor</span>
<a href="#l29.59"></a><span id="l29.59" class="difflineplus">+ *</span>
<a href="#l29.60"></a><span id="l29.60" class="difflineplus">+ * @param {Object} event The raw event to be wrapped in this DAO</span>
<a href="#l29.61"></a><span id="l29.61" class="difflineplus">+ *</span>
<a href="#l29.62"></a><span id="l29.62" class="difflineplus">+ * @prop {Object} event The raw (possibly encrypted) event. &lt;b&gt;Do not access</span>
<a href="#l29.63"></a><span id="l29.63" class="difflineplus">+ * this property&lt;/b&gt; directly unless you absolutely have to. Prefer the getter</span>
<a href="#l29.64"></a><span id="l29.64" class="difflineplus">+ * methods defined on this class. Using the getter methods shields your app</span>
<a href="#l29.65"></a><span id="l29.65" class="difflineplus">+ * from changes to event JSON between Matrix versions.</span>
<a href="#l29.66"></a><span id="l29.66" class="difflineplus">+ *</span>
<a href="#l29.67"></a><span id="l29.67" class="difflineplus">+ * @prop {RoomMember} sender The room member who sent this event, or null e.g.</span>
<a href="#l29.68"></a><span id="l29.68" class="difflineplus">+ * this is a presence event.</span>
<a href="#l29.69"></a><span id="l29.69" class="difflineplus">+ * @prop {RoomMember} target The room member who is the target of this event, e.g.</span>
<a href="#l29.70"></a><span id="l29.70" class="difflineplus">+ * the invitee, the person being banned, etc.</span>
<a href="#l29.71"></a><span id="l29.71" class="difflineplus">+ * @prop {EventStatus} status The sending status of the event.</span>
<a href="#l29.72"></a><span id="l29.72" class="difflineplus">+ * @prop {boolean} forwardLooking True if this event is 'forward looking', meaning</span>
<a href="#l29.73"></a><span id="l29.73" class="difflineplus">+ * that getDirectionalContent() will return event.content and not event.prev_content.</span>
<a href="#l29.74"></a><span id="l29.74" class="difflineplus">+ * Default: true. &lt;strong&gt;This property is experimental and may change.&lt;/strong&gt;</span>
<a href="#l29.75"></a><span id="l29.75" class="difflineplus">+ */</span>
<a href="#l29.76"></a><span id="l29.76" class="difflineplus">+module.exports.MatrixEvent = function MatrixEvent(</span>
<a href="#l29.77"></a><span id="l29.77" class="difflineplus">+    event</span>
<a href="#l29.78"></a><span id="l29.78" class="difflineplus">+) {</span>
<a href="#l29.79"></a><span id="l29.79" class="difflineplus">+    this.event = event || {};</span>
<a href="#l29.80"></a><span id="l29.80" class="difflineplus">+    this.sender = null;</span>
<a href="#l29.81"></a><span id="l29.81" class="difflineplus">+    this.target = null;</span>
<a href="#l29.82"></a><span id="l29.82" class="difflineplus">+    this.status = null;</span>
<a href="#l29.83"></a><span id="l29.83" class="difflineplus">+    this.forwardLooking = true;</span>
<a href="#l29.84"></a><span id="l29.84" class="difflineplus">+    this._pushActions = null;</span>
<a href="#l29.85"></a><span id="l29.85" class="difflineplus">+</span>
<a href="#l29.86"></a><span id="l29.86" class="difflineplus">+    this._clearEvent = {};</span>
<a href="#l29.87"></a><span id="l29.87" class="difflineplus">+    this._keysProved = {};</span>
<a href="#l29.88"></a><span id="l29.88" class="difflineplus">+    this._keysClaimed = {};</span>
<a href="#l29.89"></a><span id="l29.89" class="difflineplus">+};</span>
<a href="#l29.90"></a><span id="l29.90" class="difflineplus">+utils.inherits(module.exports.MatrixEvent, EventEmitter);</span>
<a href="#l29.91"></a><span id="l29.91" class="difflineplus">+</span>
<a href="#l29.92"></a><span id="l29.92" class="difflineplus">+</span>
<a href="#l29.93"></a><span id="l29.93" class="difflineplus">+utils.extend(module.exports.MatrixEvent.prototype, {</span>
<a href="#l29.94"></a><span id="l29.94" class="difflineplus">+</span>
<a href="#l29.95"></a><span id="l29.95" class="difflineplus">+    /**</span>
<a href="#l29.96"></a><span id="l29.96" class="difflineplus">+     * Get the event_id for this event.</span>
<a href="#l29.97"></a><span id="l29.97" class="difflineplus">+     * @return {string} The event ID, e.g. &lt;code&gt;$143350589368169JsLZx:localhost</span>
<a href="#l29.98"></a><span id="l29.98" class="difflineplus">+     * &lt;/code&gt;</span>
<a href="#l29.99"></a><span id="l29.99" class="difflineplus">+     */</span>
<a href="#l29.100"></a><span id="l29.100" class="difflineplus">+    getId: function() {</span>
<a href="#l29.101"></a><span id="l29.101" class="difflineplus">+        return this.event.event_id;</span>
<a href="#l29.102"></a><span id="l29.102" class="difflineplus">+    },</span>
<a href="#l29.103"></a><span id="l29.103" class="difflineplus">+</span>
<a href="#l29.104"></a><span id="l29.104" class="difflineplus">+    /**</span>
<a href="#l29.105"></a><span id="l29.105" class="difflineplus">+     * Get the user_id for this event.</span>
<a href="#l29.106"></a><span id="l29.106" class="difflineplus">+     * @return {string} The user ID, e.g. &lt;code&gt;@alice:matrix.org&lt;/code&gt;</span>
<a href="#l29.107"></a><span id="l29.107" class="difflineplus">+     */</span>
<a href="#l29.108"></a><span id="l29.108" class="difflineplus">+    getSender: function() {</span>
<a href="#l29.109"></a><span id="l29.109" class="difflineplus">+        return this.event.sender || this.event.user_id; // v2 / v1</span>
<a href="#l29.110"></a><span id="l29.110" class="difflineplus">+    },</span>
<a href="#l29.111"></a><span id="l29.111" class="difflineplus">+</span>
<a href="#l29.112"></a><span id="l29.112" class="difflineplus">+    /**</span>
<a href="#l29.113"></a><span id="l29.113" class="difflineplus">+     * Get the (decrypted, if necessary) type of event.</span>
<a href="#l29.114"></a><span id="l29.114" class="difflineplus">+     *</span>
<a href="#l29.115"></a><span id="l29.115" class="difflineplus">+     * @return {string} The event type, e.g. &lt;code&gt;m.room.message&lt;/code&gt;</span>
<a href="#l29.116"></a><span id="l29.116" class="difflineplus">+     */</span>
<a href="#l29.117"></a><span id="l29.117" class="difflineplus">+    getType: function() {</span>
<a href="#l29.118"></a><span id="l29.118" class="difflineplus">+        return this._clearEvent.type || this.event.type;</span>
<a href="#l29.119"></a><span id="l29.119" class="difflineplus">+    },</span>
<a href="#l29.120"></a><span id="l29.120" class="difflineplus">+</span>
<a href="#l29.121"></a><span id="l29.121" class="difflineplus">+    /**</span>
<a href="#l29.122"></a><span id="l29.122" class="difflineplus">+     * Get the (possibly encrypted) type of the event that will be sent to the</span>
<a href="#l29.123"></a><span id="l29.123" class="difflineplus">+     * homeserver.</span>
<a href="#l29.124"></a><span id="l29.124" class="difflineplus">+     *</span>
<a href="#l29.125"></a><span id="l29.125" class="difflineplus">+     * @return {string} The event type.</span>
<a href="#l29.126"></a><span id="l29.126" class="difflineplus">+     */</span>
<a href="#l29.127"></a><span id="l29.127" class="difflineplus">+    getWireType: function() {</span>
<a href="#l29.128"></a><span id="l29.128" class="difflineplus">+        return this.event.type;</span>
<a href="#l29.129"></a><span id="l29.129" class="difflineplus">+    },</span>
<a href="#l29.130"></a><span id="l29.130" class="difflineplus">+</span>
<a href="#l29.131"></a><span id="l29.131" class="difflineplus">+    /**</span>
<a href="#l29.132"></a><span id="l29.132" class="difflineplus">+     * Get the room_id for this event. This will return &lt;code&gt;undefined&lt;/code&gt;</span>
<a href="#l29.133"></a><span id="l29.133" class="difflineplus">+     * for &lt;code&gt;m.presence&lt;/code&gt; events.</span>
<a href="#l29.134"></a><span id="l29.134" class="difflineplus">+     * @return {string} The room ID, e.g. &lt;code&gt;!cURbafjkfsMDVwdRDQ:matrix.org</span>
<a href="#l29.135"></a><span id="l29.135" class="difflineplus">+     * &lt;/code&gt;</span>
<a href="#l29.136"></a><span id="l29.136" class="difflineplus">+     */</span>
<a href="#l29.137"></a><span id="l29.137" class="difflineplus">+    getRoomId: function() {</span>
<a href="#l29.138"></a><span id="l29.138" class="difflineplus">+        return this.event.room_id;</span>
<a href="#l29.139"></a><span id="l29.139" class="difflineplus">+    },</span>
<a href="#l29.140"></a><span id="l29.140" class="difflineplus">+</span>
<a href="#l29.141"></a><span id="l29.141" class="difflineplus">+    /**</span>
<a href="#l29.142"></a><span id="l29.142" class="difflineplus">+     * Get the timestamp of this event.</span>
<a href="#l29.143"></a><span id="l29.143" class="difflineplus">+     * @return {Number} The event timestamp, e.g. &lt;code&gt;1433502692297&lt;/code&gt;</span>
<a href="#l29.144"></a><span id="l29.144" class="difflineplus">+     */</span>
<a href="#l29.145"></a><span id="l29.145" class="difflineplus">+    getTs: function() {</span>
<a href="#l29.146"></a><span id="l29.146" class="difflineplus">+        return this.event.origin_server_ts;</span>
<a href="#l29.147"></a><span id="l29.147" class="difflineplus">+    },</span>
<a href="#l29.148"></a><span id="l29.148" class="difflineplus">+</span>
<a href="#l29.149"></a><span id="l29.149" class="difflineplus">+    /**</span>
<a href="#l29.150"></a><span id="l29.150" class="difflineplus">+     * Get the (decrypted, if necessary) event content JSON.</span>
<a href="#l29.151"></a><span id="l29.151" class="difflineplus">+     *</span>
<a href="#l29.152"></a><span id="l29.152" class="difflineplus">+     * @return {Object} The event content JSON, or an empty object.</span>
<a href="#l29.153"></a><span id="l29.153" class="difflineplus">+     */</span>
<a href="#l29.154"></a><span id="l29.154" class="difflineplus">+    getContent: function() {</span>
<a href="#l29.155"></a><span id="l29.155" class="difflineplus">+        return this._clearEvent.content || this.event.content || {};</span>
<a href="#l29.156"></a><span id="l29.156" class="difflineplus">+    },</span>
<a href="#l29.157"></a><span id="l29.157" class="difflineplus">+</span>
<a href="#l29.158"></a><span id="l29.158" class="difflineplus">+    /**</span>
<a href="#l29.159"></a><span id="l29.159" class="difflineplus">+     * Get the (possibly encrypted) event content JSON that will be sent to the</span>
<a href="#l29.160"></a><span id="l29.160" class="difflineplus">+     * homeserver.</span>
<a href="#l29.161"></a><span id="l29.161" class="difflineplus">+     *</span>
<a href="#l29.162"></a><span id="l29.162" class="difflineplus">+     * @return {Object} The event content JSON, or an empty object.</span>
<a href="#l29.163"></a><span id="l29.163" class="difflineplus">+     */</span>
<a href="#l29.164"></a><span id="l29.164" class="difflineplus">+    getWireContent: function() {</span>
<a href="#l29.165"></a><span id="l29.165" class="difflineplus">+        return this.event.content || {};</span>
<a href="#l29.166"></a><span id="l29.166" class="difflineplus">+    },</span>
<a href="#l29.167"></a><span id="l29.167" class="difflineplus">+</span>
<a href="#l29.168"></a><span id="l29.168" class="difflineplus">+    /**</span>
<a href="#l29.169"></a><span id="l29.169" class="difflineplus">+     * Get the previous event content JSON. This will only return something for</span>
<a href="#l29.170"></a><span id="l29.170" class="difflineplus">+     * state events which exist in the timeline.</span>
<a href="#l29.171"></a><span id="l29.171" class="difflineplus">+     * @return {Object} The previous event content JSON, or an empty object.</span>
<a href="#l29.172"></a><span id="l29.172" class="difflineplus">+     */</span>
<a href="#l29.173"></a><span id="l29.173" class="difflineplus">+    getPrevContent: function() {</span>
<a href="#l29.174"></a><span id="l29.174" class="difflineplus">+        // v2 then v1 then default</span>
<a href="#l29.175"></a><span id="l29.175" class="difflineplus">+        return this.getUnsigned().prev_content || this.event.prev_content || {};</span>
<a href="#l29.176"></a><span id="l29.176" class="difflineplus">+    },</span>
<a href="#l29.177"></a><span id="l29.177" class="difflineplus">+</span>
<a href="#l29.178"></a><span id="l29.178" class="difflineplus">+    /**</span>
<a href="#l29.179"></a><span id="l29.179" class="difflineplus">+     * Get either 'content' or 'prev_content' depending on if this event is</span>
<a href="#l29.180"></a><span id="l29.180" class="difflineplus">+     * 'forward-looking' or not. This can be modified via event.forwardLooking.</span>
<a href="#l29.181"></a><span id="l29.181" class="difflineplus">+     * In practice, this means we get the chronologically earlier content value</span>
<a href="#l29.182"></a><span id="l29.182" class="difflineplus">+     * for this event (this method should surely be called getEarlierContent)</span>
<a href="#l29.183"></a><span id="l29.183" class="difflineplus">+     * &lt;strong&gt;This method is experimental and may change.&lt;/strong&gt;</span>
<a href="#l29.184"></a><span id="l29.184" class="difflineplus">+     * @return {Object} event.content if this event is forward-looking, else</span>
<a href="#l29.185"></a><span id="l29.185" class="difflineplus">+     * event.prev_content.</span>
<a href="#l29.186"></a><span id="l29.186" class="difflineplus">+     */</span>
<a href="#l29.187"></a><span id="l29.187" class="difflineplus">+    getDirectionalContent: function() {</span>
<a href="#l29.188"></a><span id="l29.188" class="difflineplus">+        return this.forwardLooking ? this.getContent() : this.getPrevContent();</span>
<a href="#l29.189"></a><span id="l29.189" class="difflineplus">+    },</span>
<a href="#l29.190"></a><span id="l29.190" class="difflineplus">+</span>
<a href="#l29.191"></a><span id="l29.191" class="difflineplus">+    /**</span>
<a href="#l29.192"></a><span id="l29.192" class="difflineplus">+     * Get the age of this event. This represents the age of the event when the</span>
<a href="#l29.193"></a><span id="l29.193" class="difflineplus">+     * event arrived at the device, and not the age of the event when this</span>
<a href="#l29.194"></a><span id="l29.194" class="difflineplus">+     * function was called.</span>
<a href="#l29.195"></a><span id="l29.195" class="difflineplus">+     * @return {Number} The age of this event in milliseconds.</span>
<a href="#l29.196"></a><span id="l29.196" class="difflineplus">+     */</span>
<a href="#l29.197"></a><span id="l29.197" class="difflineplus">+    getAge: function() {</span>
<a href="#l29.198"></a><span id="l29.198" class="difflineplus">+        return this.getUnsigned().age || this.event.age; // v2 / v1</span>
<a href="#l29.199"></a><span id="l29.199" class="difflineplus">+    },</span>
<a href="#l29.200"></a><span id="l29.200" class="difflineplus">+</span>
<a href="#l29.201"></a><span id="l29.201" class="difflineplus">+    /**</span>
<a href="#l29.202"></a><span id="l29.202" class="difflineplus">+     * Get the event state_key if it has one. This will return &lt;code&gt;undefined</span>
<a href="#l29.203"></a><span id="l29.203" class="difflineplus">+     * &lt;/code&gt; for message events.</span>
<a href="#l29.204"></a><span id="l29.204" class="difflineplus">+     * @return {string} The event's &lt;code&gt;state_key&lt;/code&gt;.</span>
<a href="#l29.205"></a><span id="l29.205" class="difflineplus">+     */</span>
<a href="#l29.206"></a><span id="l29.206" class="difflineplus">+    getStateKey: function() {</span>
<a href="#l29.207"></a><span id="l29.207" class="difflineplus">+        return this.event.state_key;</span>
<a href="#l29.208"></a><span id="l29.208" class="difflineplus">+    },</span>
<a href="#l29.209"></a><span id="l29.209" class="difflineplus">+</span>
<a href="#l29.210"></a><span id="l29.210" class="difflineplus">+    /**</span>
<a href="#l29.211"></a><span id="l29.211" class="difflineplus">+     * Check if this event is a state event.</span>
<a href="#l29.212"></a><span id="l29.212" class="difflineplus">+     * @return {boolean} True if this is a state event.</span>
<a href="#l29.213"></a><span id="l29.213" class="difflineplus">+     */</span>
<a href="#l29.214"></a><span id="l29.214" class="difflineplus">+    isState: function() {</span>
<a href="#l29.215"></a><span id="l29.215" class="difflineplus">+        return this.event.state_key !== undefined;</span>
<a href="#l29.216"></a><span id="l29.216" class="difflineplus">+    },</span>
<a href="#l29.217"></a><span id="l29.217" class="difflineplus">+</span>
<a href="#l29.218"></a><span id="l29.218" class="difflineplus">+    /**</span>
<a href="#l29.219"></a><span id="l29.219" class="difflineplus">+     * Replace the content of this event with encrypted versions.</span>
<a href="#l29.220"></a><span id="l29.220" class="difflineplus">+     * (This is used when sending an event; it should not be used by applications).</span>
<a href="#l29.221"></a><span id="l29.221" class="difflineplus">+     *</span>
<a href="#l29.222"></a><span id="l29.222" class="difflineplus">+     * @internal</span>
<a href="#l29.223"></a><span id="l29.223" class="difflineplus">+     *</span>
<a href="#l29.224"></a><span id="l29.224" class="difflineplus">+     * @param {string} crypto_type type of the encrypted event - typically</span>
<a href="#l29.225"></a><span id="l29.225" class="difflineplus">+     * &lt;tt&gt;&quot;m.room.encrypted&quot;&lt;/tt&gt;</span>
<a href="#l29.226"></a><span id="l29.226" class="difflineplus">+     *</span>
<a href="#l29.227"></a><span id="l29.227" class="difflineplus">+     * @param {object} crypto_content raw 'content' for the encrypted event.</span>
<a href="#l29.228"></a><span id="l29.228" class="difflineplus">+     * @param {object} keys The local keys claimed and proved by this event.</span>
<a href="#l29.229"></a><span id="l29.229" class="difflineplus">+     */</span>
<a href="#l29.230"></a><span id="l29.230" class="difflineplus">+    makeEncrypted: function(crypto_type, crypto_content, keys) {</span>
<a href="#l29.231"></a><span id="l29.231" class="difflineplus">+        // keep the plain-text data for 'view source'</span>
<a href="#l29.232"></a><span id="l29.232" class="difflineplus">+        this._clearEvent = {</span>
<a href="#l29.233"></a><span id="l29.233" class="difflineplus">+            type: this.event.type,</span>
<a href="#l29.234"></a><span id="l29.234" class="difflineplus">+            content: this.event.content,</span>
<a href="#l29.235"></a><span id="l29.235" class="difflineplus">+        };</span>
<a href="#l29.236"></a><span id="l29.236" class="difflineplus">+        this.event.type = crypto_type;</span>
<a href="#l29.237"></a><span id="l29.237" class="difflineplus">+        this.event.content = crypto_content;</span>
<a href="#l29.238"></a><span id="l29.238" class="difflineplus">+        this._keysProved = keys;</span>
<a href="#l29.239"></a><span id="l29.239" class="difflineplus">+        this._keysClaimed = keys;</span>
<a href="#l29.240"></a><span id="l29.240" class="difflineplus">+    },</span>
<a href="#l29.241"></a><span id="l29.241" class="difflineplus">+</span>
<a href="#l29.242"></a><span id="l29.242" class="difflineplus">+    /**</span>
<a href="#l29.243"></a><span id="l29.243" class="difflineplus">+     * Update the cleartext data on this event.</span>
<a href="#l29.244"></a><span id="l29.244" class="difflineplus">+     *</span>
<a href="#l29.245"></a><span id="l29.245" class="difflineplus">+     * (This is used after decrypting an event; it should not be used by applications).</span>
<a href="#l29.246"></a><span id="l29.246" class="difflineplus">+     *</span>
<a href="#l29.247"></a><span id="l29.247" class="difflineplus">+     * @internal</span>
<a href="#l29.248"></a><span id="l29.248" class="difflineplus">+     *</span>
<a href="#l29.249"></a><span id="l29.249" class="difflineplus">+     * @fires module:models/event.MatrixEvent#&quot;Event.decrypted&quot;</span>
<a href="#l29.250"></a><span id="l29.250" class="difflineplus">+     *</span>
<a href="#l29.251"></a><span id="l29.251" class="difflineplus">+     * @param {Object} clearEvent The plaintext payload for the event</span>
<a href="#l29.252"></a><span id="l29.252" class="difflineplus">+     *     (typically containing &lt;tt&gt;type&lt;/tt&gt; and &lt;tt&gt;content&lt;/tt&gt; fields).</span>
<a href="#l29.253"></a><span id="l29.253" class="difflineplus">+     *</span>
<a href="#l29.254"></a><span id="l29.254" class="difflineplus">+     * @param {Object=} keysProved Keys owned by the sender of this event.</span>
<a href="#l29.255"></a><span id="l29.255" class="difflineplus">+     *    See {@link module:models/event.MatrixEvent#getKeysProved}.</span>
<a href="#l29.256"></a><span id="l29.256" class="difflineplus">+     *</span>
<a href="#l29.257"></a><span id="l29.257" class="difflineplus">+     * @param {Object=} keysClaimed Keys the sender of this event claims.</span>
<a href="#l29.258"></a><span id="l29.258" class="difflineplus">+     *    See {@link module:models/event.MatrixEvent#getKeysClaimed}.</span>
<a href="#l29.259"></a><span id="l29.259" class="difflineplus">+     */</span>
<a href="#l29.260"></a><span id="l29.260" class="difflineplus">+    setClearData: function(clearEvent, keysProved, keysClaimed) {</span>
<a href="#l29.261"></a><span id="l29.261" class="difflineplus">+        this._clearEvent = clearEvent;</span>
<a href="#l29.262"></a><span id="l29.262" class="difflineplus">+        this._keysProved = keysProved || {};</span>
<a href="#l29.263"></a><span id="l29.263" class="difflineplus">+        this._keysClaimed = keysClaimed || {};</span>
<a href="#l29.264"></a><span id="l29.264" class="difflineplus">+        this.emit(&quot;Event.decrypted&quot;, this);</span>
<a href="#l29.265"></a><span id="l29.265" class="difflineplus">+    },</span>
<a href="#l29.266"></a><span id="l29.266" class="difflineplus">+</span>
<a href="#l29.267"></a><span id="l29.267" class="difflineplus">+    /**</span>
<a href="#l29.268"></a><span id="l29.268" class="difflineplus">+     * Check if the event is encrypted.</span>
<a href="#l29.269"></a><span id="l29.269" class="difflineplus">+     * @return {boolean} True if this event is encrypted.</span>
<a href="#l29.270"></a><span id="l29.270" class="difflineplus">+     */</span>
<a href="#l29.271"></a><span id="l29.271" class="difflineplus">+    isEncrypted: function() {</span>
<a href="#l29.272"></a><span id="l29.272" class="difflineplus">+        return this.event.type === &quot;m.room.encrypted&quot;;</span>
<a href="#l29.273"></a><span id="l29.273" class="difflineplus">+    },</span>
<a href="#l29.274"></a><span id="l29.274" class="difflineplus">+</span>
<a href="#l29.275"></a><span id="l29.275" class="difflineplus">+    /**</span>
<a href="#l29.276"></a><span id="l29.276" class="difflineplus">+     * The curve25519 key that sent this event</span>
<a href="#l29.277"></a><span id="l29.277" class="difflineplus">+     * @return {string}</span>
<a href="#l29.278"></a><span id="l29.278" class="difflineplus">+     */</span>
<a href="#l29.279"></a><span id="l29.279" class="difflineplus">+    getSenderKey: function() {</span>
<a href="#l29.280"></a><span id="l29.280" class="difflineplus">+        return this.getKeysProved().curve25519 || null;</span>
<a href="#l29.281"></a><span id="l29.281" class="difflineplus">+    },</span>
<a href="#l29.282"></a><span id="l29.282" class="difflineplus">+</span>
<a href="#l29.283"></a><span id="l29.283" class="difflineplus">+    /**</span>
<a href="#l29.284"></a><span id="l29.284" class="difflineplus">+     * The keys that must have been owned by the sender of this encrypted event.</span>
<a href="#l29.285"></a><span id="l29.285" class="difflineplus">+     * &lt;p&gt;</span>
<a href="#l29.286"></a><span id="l29.286" class="difflineplus">+     * These don't necessarily have to come from this event itself, but may be</span>
<a href="#l29.287"></a><span id="l29.287" class="difflineplus">+     * implied by the cryptographic session.</span>
<a href="#l29.288"></a><span id="l29.288" class="difflineplus">+     *</span>
<a href="#l29.289"></a><span id="l29.289" class="difflineplus">+     * @return {Object&lt;string, string&gt;}</span>
<a href="#l29.290"></a><span id="l29.290" class="difflineplus">+     */</span>
<a href="#l29.291"></a><span id="l29.291" class="difflineplus">+    getKeysProved: function() {</span>
<a href="#l29.292"></a><span id="l29.292" class="difflineplus">+        return this._keysProved;</span>
<a href="#l29.293"></a><span id="l29.293" class="difflineplus">+    },</span>
<a href="#l29.294"></a><span id="l29.294" class="difflineplus">+</span>
<a href="#l29.295"></a><span id="l29.295" class="difflineplus">+    /**</span>
<a href="#l29.296"></a><span id="l29.296" class="difflineplus">+     * The additional keys the sender of this encrypted event claims to possess.</span>
<a href="#l29.297"></a><span id="l29.297" class="difflineplus">+     * &lt;p&gt;</span>
<a href="#l29.298"></a><span id="l29.298" class="difflineplus">+     * These don't necessarily have to come from this event itself, but may be</span>
<a href="#l29.299"></a><span id="l29.299" class="difflineplus">+     * implied by the cryptographic session.</span>
<a href="#l29.300"></a><span id="l29.300" class="difflineplus">+     * For example megolm messages don't claim keys directly, but instead</span>
<a href="#l29.301"></a><span id="l29.301" class="difflineplus">+     * inherit a claim from the olm message that established the session.</span>
<a href="#l29.302"></a><span id="l29.302" class="difflineplus">+     *</span>
<a href="#l29.303"></a><span id="l29.303" class="difflineplus">+     * @return {Object&lt;string, string&gt;}</span>
<a href="#l29.304"></a><span id="l29.304" class="difflineplus">+     */</span>
<a href="#l29.305"></a><span id="l29.305" class="difflineplus">+    getKeysClaimed: function() {</span>
<a href="#l29.306"></a><span id="l29.306" class="difflineplus">+        return this._keysClaimed;</span>
<a href="#l29.307"></a><span id="l29.307" class="difflineplus">+    },</span>
<a href="#l29.308"></a><span id="l29.308" class="difflineplus">+</span>
<a href="#l29.309"></a><span id="l29.309" class="difflineplus">+    getUnsigned: function() {</span>
<a href="#l29.310"></a><span id="l29.310" class="difflineplus">+        return this.event.unsigned || {};</span>
<a href="#l29.311"></a><span id="l29.311" class="difflineplus">+    },</span>
<a href="#l29.312"></a><span id="l29.312" class="difflineplus">+</span>
<a href="#l29.313"></a><span id="l29.313" class="difflineplus">+    /**</span>
<a href="#l29.314"></a><span id="l29.314" class="difflineplus">+     * Update the content of an event in the same way it would be by the server</span>
<a href="#l29.315"></a><span id="l29.315" class="difflineplus">+     * if it were redacted before it was sent to us</span>
<a href="#l29.316"></a><span id="l29.316" class="difflineplus">+     *</span>
<a href="#l29.317"></a><span id="l29.317" class="difflineplus">+     * @param {module:models/event.MatrixEvent} redaction_event</span>
<a href="#l29.318"></a><span id="l29.318" class="difflineplus">+     *     event causing the redaction</span>
<a href="#l29.319"></a><span id="l29.319" class="difflineplus">+     */</span>
<a href="#l29.320"></a><span id="l29.320" class="difflineplus">+    makeRedacted: function(redaction_event) {</span>
<a href="#l29.321"></a><span id="l29.321" class="difflineplus">+        // quick sanity-check</span>
<a href="#l29.322"></a><span id="l29.322" class="difflineplus">+        if (!redaction_event.event) {</span>
<a href="#l29.323"></a><span id="l29.323" class="difflineplus">+            throw new Error(&quot;invalid redaction_event in makeRedacted&quot;);</span>
<a href="#l29.324"></a><span id="l29.324" class="difflineplus">+        }</span>
<a href="#l29.325"></a><span id="l29.325" class="difflineplus">+</span>
<a href="#l29.326"></a><span id="l29.326" class="difflineplus">+        // we attempt to replicate what we would see from the server if</span>
<a href="#l29.327"></a><span id="l29.327" class="difflineplus">+        // the event had been redacted before we saw it.</span>
<a href="#l29.328"></a><span id="l29.328" class="difflineplus">+        //</span>
<a href="#l29.329"></a><span id="l29.329" class="difflineplus">+        // The server removes (most of) the content of the event, and adds a</span>
<a href="#l29.330"></a><span id="l29.330" class="difflineplus">+        // &quot;redacted_because&quot; key to the unsigned section containing the</span>
<a href="#l29.331"></a><span id="l29.331" class="difflineplus">+        // redacted event.</span>
<a href="#l29.332"></a><span id="l29.332" class="difflineplus">+        if (!this.event.unsigned) {</span>
<a href="#l29.333"></a><span id="l29.333" class="difflineplus">+            this.event.unsigned = {};</span>
<a href="#l29.334"></a><span id="l29.334" class="difflineplus">+        }</span>
<a href="#l29.335"></a><span id="l29.335" class="difflineplus">+        this.event.unsigned.redacted_because = redaction_event.event;</span>
<a href="#l29.336"></a><span id="l29.336" class="difflineplus">+</span>
<a href="#l29.337"></a><span id="l29.337" class="difflineplus">+        var key;</span>
<a href="#l29.338"></a><span id="l29.338" class="difflineplus">+        for (key in this.event) {</span>
<a href="#l29.339"></a><span id="l29.339" class="difflineplus">+            if (!this.event.hasOwnProperty(key)) { continue; }</span>
<a href="#l29.340"></a><span id="l29.340" class="difflineplus">+            if (!_REDACT_KEEP_KEY_MAP[key]) {</span>
<a href="#l29.341"></a><span id="l29.341" class="difflineplus">+                delete this.event[key];</span>
<a href="#l29.342"></a><span id="l29.342" class="difflineplus">+            }</span>
<a href="#l29.343"></a><span id="l29.343" class="difflineplus">+        }</span>
<a href="#l29.344"></a><span id="l29.344" class="difflineplus">+</span>
<a href="#l29.345"></a><span id="l29.345" class="difflineplus">+        var keeps = _REDACT_KEEP_CONTENT_MAP[this.getType()] || {};</span>
<a href="#l29.346"></a><span id="l29.346" class="difflineplus">+        var content = this.getContent();</span>
<a href="#l29.347"></a><span id="l29.347" class="difflineplus">+        for (key in content) {</span>
<a href="#l29.348"></a><span id="l29.348" class="difflineplus">+            if (!content.hasOwnProperty(key)) { continue; }</span>
<a href="#l29.349"></a><span id="l29.349" class="difflineplus">+            if (!keeps[key]) {</span>
<a href="#l29.350"></a><span id="l29.350" class="difflineplus">+                delete content[key];</span>
<a href="#l29.351"></a><span id="l29.351" class="difflineplus">+            }</span>
<a href="#l29.352"></a><span id="l29.352" class="difflineplus">+        }</span>
<a href="#l29.353"></a><span id="l29.353" class="difflineplus">+    },</span>
<a href="#l29.354"></a><span id="l29.354" class="difflineplus">+</span>
<a href="#l29.355"></a><span id="l29.355" class="difflineplus">+    /**</span>
<a href="#l29.356"></a><span id="l29.356" class="difflineplus">+     * Check if this event has been redacted</span>
<a href="#l29.357"></a><span id="l29.357" class="difflineplus">+     *</span>
<a href="#l29.358"></a><span id="l29.358" class="difflineplus">+     * @return {boolean} True if this event has been redacted</span>
<a href="#l29.359"></a><span id="l29.359" class="difflineplus">+     */</span>
<a href="#l29.360"></a><span id="l29.360" class="difflineplus">+    isRedacted: function() {</span>
<a href="#l29.361"></a><span id="l29.361" class="difflineplus">+        return Boolean(this.getUnsigned().redacted_because);</span>
<a href="#l29.362"></a><span id="l29.362" class="difflineplus">+    },</span>
<a href="#l29.363"></a><span id="l29.363" class="difflineplus">+</span>
<a href="#l29.364"></a><span id="l29.364" class="difflineplus">+    /**</span>
<a href="#l29.365"></a><span id="l29.365" class="difflineplus">+     * Get the push actions, if known, for this event</span>
<a href="#l29.366"></a><span id="l29.366" class="difflineplus">+     *</span>
<a href="#l29.367"></a><span id="l29.367" class="difflineplus">+     * @return {?Object} push actions</span>
<a href="#l29.368"></a><span id="l29.368" class="difflineplus">+     */</span>
<a href="#l29.369"></a><span id="l29.369" class="difflineplus">+     getPushActions: function() {</span>
<a href="#l29.370"></a><span id="l29.370" class="difflineplus">+        return this._pushActions;</span>
<a href="#l29.371"></a><span id="l29.371" class="difflineplus">+     },</span>
<a href="#l29.372"></a><span id="l29.372" class="difflineplus">+</span>
<a href="#l29.373"></a><span id="l29.373" class="difflineplus">+    /**</span>
<a href="#l29.374"></a><span id="l29.374" class="difflineplus">+     * Set the push actions for this event.</span>
<a href="#l29.375"></a><span id="l29.375" class="difflineplus">+     *</span>
<a href="#l29.376"></a><span id="l29.376" class="difflineplus">+     * @param {Object} pushActions push actions</span>
<a href="#l29.377"></a><span id="l29.377" class="difflineplus">+     */</span>
<a href="#l29.378"></a><span id="l29.378" class="difflineplus">+     setPushActions: function(pushActions) {</span>
<a href="#l29.379"></a><span id="l29.379" class="difflineplus">+        this._pushActions = pushActions;</span>
<a href="#l29.380"></a><span id="l29.380" class="difflineplus">+     },</span>
<a href="#l29.381"></a><span id="l29.381" class="difflineplus">+});</span>
<a href="#l29.382"></a><span id="l29.382" class="difflineplus">+</span>
<a href="#l29.383"></a><span id="l29.383" class="difflineplus">+</span>
<a href="#l29.384"></a><span id="l29.384" class="difflineplus">+/* http://matrix.org/docs/spec/r0.0.1/client_server.html#redactions says:</span>
<a href="#l29.385"></a><span id="l29.385" class="difflineplus">+ *</span>
<a href="#l29.386"></a><span id="l29.386" class="difflineplus">+ * the server should strip off any keys not in the following list:</span>
<a href="#l29.387"></a><span id="l29.387" class="difflineplus">+ *    event_id</span>
<a href="#l29.388"></a><span id="l29.388" class="difflineplus">+ *    type</span>
<a href="#l29.389"></a><span id="l29.389" class="difflineplus">+ *    room_id</span>
<a href="#l29.390"></a><span id="l29.390" class="difflineplus">+ *    user_id</span>
<a href="#l29.391"></a><span id="l29.391" class="difflineplus">+ *    state_key</span>
<a href="#l29.392"></a><span id="l29.392" class="difflineplus">+ *    prev_state</span>
<a href="#l29.393"></a><span id="l29.393" class="difflineplus">+ *    content</span>
<a href="#l29.394"></a><span id="l29.394" class="difflineplus">+ *    [we keep 'unsigned' as well, since that is created by the local server]</span>
<a href="#l29.395"></a><span id="l29.395" class="difflineplus">+ *</span>
<a href="#l29.396"></a><span id="l29.396" class="difflineplus">+ * The content object should also be stripped of all keys, unless it is one of</span>
<a href="#l29.397"></a><span id="l29.397" class="difflineplus">+ * one of the following event types:</span>
<a href="#l29.398"></a><span id="l29.398" class="difflineplus">+ *    m.room.member allows key membership</span>
<a href="#l29.399"></a><span id="l29.399" class="difflineplus">+ *    m.room.create allows key creator</span>
<a href="#l29.400"></a><span id="l29.400" class="difflineplus">+ *    m.room.join_rules allows key join_rule</span>
<a href="#l29.401"></a><span id="l29.401" class="difflineplus">+ *    m.room.power_levels allows keys ban, events, events_default, kick,</span>
<a href="#l29.402"></a><span id="l29.402" class="difflineplus">+ *        redact, state_default, users, users_default.</span>
<a href="#l29.403"></a><span id="l29.403" class="difflineplus">+ *    m.room.aliases allows key aliases</span>
<a href="#l29.404"></a><span id="l29.404" class="difflineplus">+ */</span>
<a href="#l29.405"></a><span id="l29.405" class="difflineplus">+// a map giving the keys we keep when an event is redacted</span>
<a href="#l29.406"></a><span id="l29.406" class="difflineplus">+var _REDACT_KEEP_KEY_MAP = [</span>
<a href="#l29.407"></a><span id="l29.407" class="difflineplus">+    'event_id', 'type', 'room_id', 'user_id', 'state_key', 'prev_state',</span>
<a href="#l29.408"></a><span id="l29.408" class="difflineplus">+    'content', 'unsigned',</span>
<a href="#l29.409"></a><span id="l29.409" class="difflineplus">+].reduce(function(ret, val) { ret[val] = 1; return ret; }, {});</span>
<a href="#l29.410"></a><span id="l29.410" class="difflineplus">+</span>
<a href="#l29.411"></a><span id="l29.411" class="difflineplus">+// a map from event type to the .content keys we keep when an event is redacted</span>
<a href="#l29.412"></a><span id="l29.412" class="difflineplus">+var _REDACT_KEEP_CONTENT_MAP = {</span>
<a href="#l29.413"></a><span id="l29.413" class="difflineplus">+    'm.room.member': {'membership': 1},</span>
<a href="#l29.414"></a><span id="l29.414" class="difflineplus">+    'm.room.create': {'creator': 1},</span>
<a href="#l29.415"></a><span id="l29.415" class="difflineplus">+    'm.room.join_rules': {'join_rule': 1},</span>
<a href="#l29.416"></a><span id="l29.416" class="difflineplus">+    'm.room.power_levels': {'ban': 1, 'events': 1, 'events_default': 1,</span>
<a href="#l29.417"></a><span id="l29.417" class="difflineplus">+                            'kick': 1, 'redact': 1, 'state_default': 1,</span>
<a href="#l29.418"></a><span id="l29.418" class="difflineplus">+                            'users': 1, 'users_default': 1,</span>
<a href="#l29.419"></a><span id="l29.419" class="difflineplus">+                           },</span>
<a href="#l29.420"></a><span id="l29.420" class="difflineplus">+    'm.room.aliases': {'aliases': 1},</span>
<a href="#l29.421"></a><span id="l29.421" class="difflineplus">+};</span>
<a href="#l29.422"></a><span id="l29.422" class="difflineplus">+</span>
<a href="#l29.423"></a><span id="l29.423" class="difflineplus">+</span>
<a href="#l29.424"></a><span id="l29.424" class="difflineplus">+</span>
<a href="#l29.425"></a><span id="l29.425" class="difflineplus">+</span>
<a href="#l29.426"></a><span id="l29.426" class="difflineplus">+/**</span>
<a href="#l29.427"></a><span id="l29.427" class="difflineplus">+ * Fires when an event is decrypted</span>
<a href="#l29.428"></a><span id="l29.428" class="difflineplus">+ *</span>
<a href="#l29.429"></a><span id="l29.429" class="difflineplus">+ * @event module:models/event.MatrixEvent#&quot;Event.decrypted&quot;</span>
<a href="#l29.430"></a><span id="l29.430" class="difflineplus">+ *</span>
<a href="#l29.431"></a><span id="l29.431" class="difflineplus">+ * @param {module:models/event.MatrixEvent} event</span>
<a href="#l29.432"></a><span id="l29.432" class="difflineplus">+ *    The matrix event which has been decrypted</span>
<a href="#l29.433"></a><span id="l29.433" class="difflineplus">+ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l30.1"></a><span id="l30.1">new file mode 100644</span>
<a href="#l30.2"></a><span id="l30.2" class="difflineminus">--- /dev/null</span>
<a href="#l30.3"></a><span id="l30.3" class="difflineplus">+++ b/chat/protocols/matrix/matrix-sdk/models/room-member.js</span>
<a href="#l30.4"></a><span id="l30.4" class="difflineat">@@ -0,0 +1,285 @@</span>
<a href="#l30.5"></a><span id="l30.5" class="difflineplus">+/*</span>
<a href="#l30.6"></a><span id="l30.6" class="difflineplus">+Copyright 2015, 2016 OpenMarket Ltd</span>
<a href="#l30.7"></a><span id="l30.7" class="difflineplus">+</span>
<a href="#l30.8"></a><span id="l30.8" class="difflineplus">+Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<a href="#l30.9"></a><span id="l30.9" class="difflineplus">+you may not use this file except in compliance with the License.</span>
<a href="#l30.10"></a><span id="l30.10" class="difflineplus">+You may obtain a copy of the License at</span>
<a href="#l30.11"></a><span id="l30.11" class="difflineplus">+</span>
<a href="#l30.12"></a><span id="l30.12" class="difflineplus">+    http://www.apache.org/licenses/LICENSE-2.0</span>
<a href="#l30.13"></a><span id="l30.13" class="difflineplus">+</span>
<a href="#l30.14"></a><span id="l30.14" class="difflineplus">+Unless required by applicable law or agreed to in writing, software</span>
<a href="#l30.15"></a><span id="l30.15" class="difflineplus">+distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<a href="#l30.16"></a><span id="l30.16" class="difflineplus">+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<a href="#l30.17"></a><span id="l30.17" class="difflineplus">+See the License for the specific language governing permissions and</span>
<a href="#l30.18"></a><span id="l30.18" class="difflineplus">+limitations under the License.</span>
<a href="#l30.19"></a><span id="l30.19" class="difflineplus">+*/</span>
<a href="#l30.20"></a><span id="l30.20" class="difflineplus">+&quot;use strict&quot;;</span>
<a href="#l30.21"></a><span id="l30.21" class="difflineplus">+/**</span>
<a href="#l30.22"></a><span id="l30.22" class="difflineplus">+ * @module models/room-member</span>
<a href="#l30.23"></a><span id="l30.23" class="difflineplus">+ */</span>
<a href="#l30.24"></a><span id="l30.24" class="difflineplus">+var EventEmitter = require(&quot;events&quot;).EventEmitter;</span>
<a href="#l30.25"></a><span id="l30.25" class="difflineplus">+var ContentRepo = require(&quot;../content-repo&quot;);</span>
<a href="#l30.26"></a><span id="l30.26" class="difflineplus">+</span>
<a href="#l30.27"></a><span id="l30.27" class="difflineplus">+var utils = require(&quot;../utils&quot;);</span>
<a href="#l30.28"></a><span id="l30.28" class="difflineplus">+</span>
<a href="#l30.29"></a><span id="l30.29" class="difflineplus">+/**</span>
<a href="#l30.30"></a><span id="l30.30" class="difflineplus">+ * Construct a new room member.</span>
<a href="#l30.31"></a><span id="l30.31" class="difflineplus">+ *</span>
<a href="#l30.32"></a><span id="l30.32" class="difflineplus">+ * @constructor</span>
<a href="#l30.33"></a><span id="l30.33" class="difflineplus">+ * @alias module:models/room-member</span>
<a href="#l30.34"></a><span id="l30.34" class="difflineplus">+ *</span>
<a href="#l30.35"></a><span id="l30.35" class="difflineplus">+ * @param {string} roomId The room ID of the member.</span>
<a href="#l30.36"></a><span id="l30.36" class="difflineplus">+ * @param {string} userId The user ID of the member.</span>
<a href="#l30.37"></a><span id="l30.37" class="difflineplus">+ * @prop {string} roomId The room ID for this member.</span>
<a href="#l30.38"></a><span id="l30.38" class="difflineplus">+ * @prop {string} userId The user ID of this member.</span>
<a href="#l30.39"></a><span id="l30.39" class="difflineplus">+ * @prop {boolean} typing True if the room member is currently typing.</span>
<a href="#l30.40"></a><span id="l30.40" class="difflineplus">+ * @prop {string} name The human-readable name for this room member.</span>
<a href="#l30.41"></a><span id="l30.41" class="difflineplus">+ * @prop {Number} powerLevel The power level for this room member.</span>
<a href="#l30.42"></a><span id="l30.42" class="difflineplus">+ * @prop {Number} powerLevelNorm The normalised power level (0-100) for this</span>
<a href="#l30.43"></a><span id="l30.43" class="difflineplus">+ * room member.</span>
<a href="#l30.44"></a><span id="l30.44" class="difflineplus">+ * @prop {User} user The User object for this room member, if one exists.</span>
<a href="#l30.45"></a><span id="l30.45" class="difflineplus">+ * @prop {string} membership The membership state for this room member e.g. 'join'.</span>
<a href="#l30.46"></a><span id="l30.46" class="difflineplus">+ * @prop {Object} events The events describing this RoomMember.</span>
<a href="#l30.47"></a><span id="l30.47" class="difflineplus">+ * @prop {MatrixEvent} events.member The m.room.member event for this RoomMember.</span>
<a href="#l30.48"></a><span id="l30.48" class="difflineplus">+ */</span>
<a href="#l30.49"></a><span id="l30.49" class="difflineplus">+function RoomMember(roomId, userId) {</span>
<a href="#l30.50"></a><span id="l30.50" class="difflineplus">+    this.roomId = roomId;</span>
<a href="#l30.51"></a><span id="l30.51" class="difflineplus">+    this.userId = userId;</span>
<a href="#l30.52"></a><span id="l30.52" class="difflineplus">+    this.typing = false;</span>
<a href="#l30.53"></a><span id="l30.53" class="difflineplus">+    this.name = userId;</span>
<a href="#l30.54"></a><span id="l30.54" class="difflineplus">+    this.powerLevel = 0;</span>
<a href="#l30.55"></a><span id="l30.55" class="difflineplus">+    this.powerLevelNorm = 0;</span>
<a href="#l30.56"></a><span id="l30.56" class="difflineplus">+    this.user = null;</span>
<a href="#l30.57"></a><span id="l30.57" class="difflineplus">+    this.membership = null;</span>
<a href="#l30.58"></a><span id="l30.58" class="difflineplus">+    this.events = {</span>
<a href="#l30.59"></a><span id="l30.59" class="difflineplus">+        member: null</span>
<a href="#l30.60"></a><span id="l30.60" class="difflineplus">+    };</span>
<a href="#l30.61"></a><span id="l30.61" class="difflineplus">+    this._updateModifiedTime();</span>
<a href="#l30.62"></a><span id="l30.62" class="difflineplus">+}</span>
<a href="#l30.63"></a><span id="l30.63" class="difflineplus">+utils.inherits(RoomMember, EventEmitter);</span>
<a href="#l30.64"></a><span id="l30.64" class="difflineplus">+</span>
<a href="#l30.65"></a><span id="l30.65" class="difflineplus">+/**</span>
<a href="#l30.66"></a><span id="l30.66" class="difflineplus">+ * Update this room member's membership event. May fire &quot;RoomMember.name&quot; if</span>
<a href="#l30.67"></a><span id="l30.67" class="difflineplus">+ * this event updates this member's name.</span>
<a href="#l30.68"></a><span id="l30.68" class="difflineplus">+ * @param {MatrixEvent} event The &lt;code&gt;m.room.member&lt;/code&gt; event</span>
<a href="#l30.69"></a><span id="l30.69" class="difflineplus">+ * @param {RoomState} roomState Optional. The room state to take into account</span>
<a href="#l30.70"></a><span id="l30.70" class="difflineplus">+ * when calculating (e.g. for disambiguating users with the same name).</span>
<a href="#l30.71"></a><span id="l30.71" class="difflineplus">+ * @fires module:client~MatrixClient#event:&quot;RoomMember.name&quot;</span>
<a href="#l30.72"></a><span id="l30.72" class="difflineplus">+ * @fires module:client~MatrixClient#event:&quot;RoomMember.membership&quot;</span>
<a href="#l30.73"></a><span id="l30.73" class="difflineplus">+ */</span>
<a href="#l30.74"></a><span id="l30.74" class="difflineplus">+RoomMember.prototype.setMembershipEvent = function(event, roomState) {</span>
<a href="#l30.75"></a><span id="l30.75" class="difflineplus">+    if (event.getType() !== &quot;m.room.member&quot;) {</span>
<a href="#l30.76"></a><span id="l30.76" class="difflineplus">+        return;</span>
<a href="#l30.77"></a><span id="l30.77" class="difflineplus">+    }</span>
<a href="#l30.78"></a><span id="l30.78" class="difflineplus">+    this.events.member = event;</span>
<a href="#l30.79"></a><span id="l30.79" class="difflineplus">+</span>
<a href="#l30.80"></a><span id="l30.80" class="difflineplus">+    var oldMembership = this.membership;</span>
<a href="#l30.81"></a><span id="l30.81" class="difflineplus">+    this.membership = event.getDirectionalContent().membership;</span>
<a href="#l30.82"></a><span id="l30.82" class="difflineplus">+</span>
<a href="#l30.83"></a><span id="l30.83" class="difflineplus">+    var oldName = this.name;</span>
<a href="#l30.84"></a><span id="l30.84" class="difflineplus">+    this.name = calculateDisplayName(this, event, roomState);</span>
<a href="#l30.85"></a><span id="l30.85" class="difflineplus">+    if (oldMembership !== this.membership) {</span>
<a href="#l30.86"></a><span id="l30.86" class="difflineplus">+        this._updateModifiedTime();</span>
<a href="#l30.87"></a><span id="l30.87" class="difflineplus">+        this.emit(&quot;RoomMember.membership&quot;, event, this, oldMembership);</span>
<a href="#l30.88"></a><span id="l30.88" class="difflineplus">+    }</span>
<a href="#l30.89"></a><span id="l30.89" class="difflineplus">+    if (oldName !== this.name) {</span>
<a href="#l30.90"></a><span id="l30.90" class="difflineplus">+        this._updateModifiedTime();</span>
<a href="#l30.91"></a><span id="l30.91" class="difflineplus">+        this.emit(&quot;RoomMember.name&quot;, event, this, oldName);</span>
<a href="#l30.92"></a><span id="l30.92" class="difflineplus">+    }</span>
<a href="#l30.93"></a><span id="l30.93" class="difflineplus">+};</span>
<a href="#l30.94"></a><span id="l30.94" class="difflineplus">+</span>
<a href="#l30.95"></a><span id="l30.95" class="difflineplus">+/**</span>
<a href="#l30.96"></a><span id="l30.96" class="difflineplus">+ * Update this room member's power level event. May fire</span>
<a href="#l30.97"></a><span id="l30.97" class="difflineplus">+ * &quot;RoomMember.powerLevel&quot; if this event updates this member's power levels.</span>
<a href="#l30.98"></a><span id="l30.98" class="difflineplus">+ * @param {MatrixEvent} powerLevelEvent The &lt;code&gt;m.room.power_levels&lt;/code&gt;</span>
<a href="#l30.99"></a><span id="l30.99" class="difflineplus">+ * event</span>
<a href="#l30.100"></a><span id="l30.100" class="difflineplus">+ * @fires module:client~MatrixClient#event:&quot;RoomMember.powerLevel&quot;</span>
<a href="#l30.101"></a><span id="l30.101" class="difflineplus">+ */</span>
<a href="#l30.102"></a><span id="l30.102" class="difflineplus">+RoomMember.prototype.setPowerLevelEvent = function(powerLevelEvent) {</span>
<a href="#l30.103"></a><span id="l30.103" class="difflineplus">+    if (powerLevelEvent.getType() !== &quot;m.room.power_levels&quot;) {</span>
<a href="#l30.104"></a><span id="l30.104" class="difflineplus">+        return;</span>
<a href="#l30.105"></a><span id="l30.105" class="difflineplus">+    }</span>
<a href="#l30.106"></a><span id="l30.106" class="difflineplus">+    var maxLevel = powerLevelEvent.getContent().users_default || 0;</span>
<a href="#l30.107"></a><span id="l30.107" class="difflineplus">+    utils.forEach(utils.values(powerLevelEvent.getContent().users), function(lvl) {</span>
<a href="#l30.108"></a><span id="l30.108" class="difflineplus">+        maxLevel = Math.max(maxLevel, lvl);</span>
<a href="#l30.109"></a><span id="l30.109" class="difflineplus">+    });</span>
<a href="#l30.110"></a><span id="l30.110" class="difflineplus">+    var oldPowerLevel = this.powerLevel;</span>
<a href="#l30.111"></a><span id="l30.111" class="difflineplus">+    var oldPowerLevelNorm = this.powerLevelNorm;</span>
<a href="#l30.112"></a><span id="l30.112" class="difflineplus">+</span>
<a href="#l30.113"></a><span id="l30.113" class="difflineplus">+    if (powerLevelEvent.getContent().users[this.userId] !== undefined) {</span>
<a href="#l30.114"></a><span id="l30.114" class="difflineplus">+        this.powerLevel = powerLevelEvent.getContent().users[this.userId];</span>
<a href="#l30.115"></a><span id="l30.115" class="difflineplus">+    } else if (powerLevelEvent.getContent().users_default !== undefined) {</span>
<a href="#l30.116"></a><span id="l30.116" class="difflineplus">+        this.powerLevel = powerLevelEvent.getContent().users_default;</span>
<a href="#l30.117"></a><span id="l30.117" class="difflineplus">+    } else {</span>
<a href="#l30.118"></a><span id="l30.118" class="difflineplus">+        this.powerLevel = 0;</span>
<a href="#l30.119"></a><span id="l30.119" class="difflineplus">+    }</span>
<a href="#l30.120"></a><span id="l30.120" class="difflineplus">+    this.powerLevelNorm = 0;</span>
<a href="#l30.121"></a><span id="l30.121" class="difflineplus">+    if (maxLevel &gt; 0) {</span>
<a href="#l30.122"></a><span id="l30.122" class="difflineplus">+        this.powerLevelNorm = (this.powerLevel * 100) / maxLevel;</span>
<a href="#l30.123"></a><span id="l30.123" class="difflineplus">+    }</span>
<a href="#l30.124"></a><span id="l30.124" class="difflineplus">+</span>
<a href="#l30.125"></a><span id="l30.125" class="difflineplus">+    // emit for changes in powerLevelNorm as well (since the app will need to</span>
<a href="#l30.126"></a><span id="l30.126" class="difflineplus">+    // redraw everyone's level if the max has changed)</span>
<a href="#l30.127"></a><span id="l30.127" class="difflineplus">+    if (oldPowerLevel !== this.powerLevel || oldPowerLevelNorm !== this.powerLevelNorm) {</span>
<a href="#l30.128"></a><span id="l30.128" class="difflineplus">+        this._updateModifiedTime();</span>
<a href="#l30.129"></a><span id="l30.129" class="difflineplus">+        this.emit(&quot;RoomMember.powerLevel&quot;, powerLevelEvent, this);</span>
<a href="#l30.130"></a><span id="l30.130" class="difflineplus">+    }</span>
<a href="#l30.131"></a><span id="l30.131" class="difflineplus">+};</span>
<a href="#l30.132"></a><span id="l30.132" class="difflineplus">+</span>
<a href="#l30.133"></a><span id="l30.133" class="difflineplus">+/**</span>
<a href="#l30.134"></a><span id="l30.134" class="difflineplus">+ * Update this room member's typing event. May fire &quot;RoomMember.typing&quot; if</span>
<a href="#l30.135"></a><span id="l30.135" class="difflineplus">+ * this event changes this member's typing state.</span>
<a href="#l30.136"></a><span id="l30.136" class="difflineplus">+ * @param {MatrixEvent} event The typing event</span>
<a href="#l30.137"></a><span id="l30.137" class="difflineplus">+ * @fires module:client~MatrixClient#event:&quot;RoomMember.typing&quot;</span>
<a href="#l30.138"></a><span id="l30.138" class="difflineplus">+ */</span>
<a href="#l30.139"></a><span id="l30.139" class="difflineplus">+RoomMember.prototype.setTypingEvent = function(event) {</span>
<a href="#l30.140"></a><span id="l30.140" class="difflineplus">+    if (event.getType() !== &quot;m.typing&quot;) {</span>
<a href="#l30.141"></a><span id="l30.141" class="difflineplus">+        return;</span>
<a href="#l30.142"></a><span id="l30.142" class="difflineplus">+    }</span>
<a href="#l30.143"></a><span id="l30.143" class="difflineplus">+    var oldTyping = this.typing;</span>
<a href="#l30.144"></a><span id="l30.144" class="difflineplus">+    this.typing = false;</span>
<a href="#l30.145"></a><span id="l30.145" class="difflineplus">+    var typingList = event.getContent().user_ids;</span>
<a href="#l30.146"></a><span id="l30.146" class="difflineplus">+    if (!utils.isArray(typingList)) {</span>
<a href="#l30.147"></a><span id="l30.147" class="difflineplus">+        // malformed event :/ bail early. TODO: whine?</span>
<a href="#l30.148"></a><span id="l30.148" class="difflineplus">+        return;</span>
<a href="#l30.149"></a><span id="l30.149" class="difflineplus">+    }</span>
<a href="#l30.150"></a><span id="l30.150" class="difflineplus">+    if (typingList.indexOf(this.userId) !== -1) {</span>
<a href="#l30.151"></a><span id="l30.151" class="difflineplus">+        this.typing = true;</span>
<a href="#l30.152"></a><span id="l30.152" class="difflineplus">+    }</span>
<a href="#l30.153"></a><span id="l30.153" class="difflineplus">+    if (oldTyping !== this.typing) {</span>
<a href="#l30.154"></a><span id="l30.154" class="difflineplus">+        this._updateModifiedTime();</span>
<a href="#l30.155"></a><span id="l30.155" class="difflineplus">+        this.emit(&quot;RoomMember.typing&quot;, event, this);</span>
<a href="#l30.156"></a><span id="l30.156" class="difflineplus">+    }</span>
<a href="#l30.157"></a><span id="l30.157" class="difflineplus">+};</span>
<a href="#l30.158"></a><span id="l30.158" class="difflineplus">+</span>
<a href="#l30.159"></a><span id="l30.159" class="difflineplus">+/**</span>
<a href="#l30.160"></a><span id="l30.160" class="difflineplus">+ * Update the last modified time to the current time.</span>
<a href="#l30.161"></a><span id="l30.161" class="difflineplus">+ */</span>
<a href="#l30.162"></a><span id="l30.162" class="difflineplus">+RoomMember.prototype._updateModifiedTime = function() {</span>
<a href="#l30.163"></a><span id="l30.163" class="difflineplus">+    this._modified = Date.now();</span>
<a href="#l30.164"></a><span id="l30.164" class="difflineplus">+};</span>
<a href="#l30.165"></a><span id="l30.165" class="difflineplus">+</span>
<a href="#l30.166"></a><span id="l30.166" class="difflineplus">+/**</span>
<a href="#l30.167"></a><span id="l30.167" class="difflineplus">+ * Get the timestamp when this RoomMember was last updated. This timestamp is</span>
<a href="#l30.168"></a><span id="l30.168" class="difflineplus">+ * updated when properties on this RoomMember are updated.</span>
<a href="#l30.169"></a><span id="l30.169" class="difflineplus">+ * It is updated &lt;i&gt;before&lt;/i&gt; firing events.</span>
<a href="#l30.170"></a><span id="l30.170" class="difflineplus">+ * @return {number} The timestamp</span>
<a href="#l30.171"></a><span id="l30.171" class="difflineplus">+ */</span>
<a href="#l30.172"></a><span id="l30.172" class="difflineplus">+RoomMember.prototype.getLastModifiedTime = function() {</span>
<a href="#l30.173"></a><span id="l30.173" class="difflineplus">+    return this._modified;</span>
<a href="#l30.174"></a><span id="l30.174" class="difflineplus">+};</span>
<a href="#l30.175"></a><span id="l30.175" class="difflineplus">+</span>
<a href="#l30.176"></a><span id="l30.176" class="difflineplus">+/**</span>
<a href="#l30.177"></a><span id="l30.177" class="difflineplus">+ * Get the avatar URL for a room member.</span>
<a href="#l30.178"></a><span id="l30.178" class="difflineplus">+ * @param {string} baseUrl The base homeserver URL See</span>
<a href="#l30.179"></a><span id="l30.179" class="difflineplus">+ * {@link module:client~MatrixClient#getHomeserverUrl}.</span>
<a href="#l30.180"></a><span id="l30.180" class="difflineplus">+ * @param {Number} width The desired width of the thumbnail.</span>
<a href="#l30.181"></a><span id="l30.181" class="difflineplus">+ * @param {Number} height The desired height of the thumbnail.</span>
<a href="#l30.182"></a><span id="l30.182" class="difflineplus">+ * @param {string} resizeMethod The thumbnail resize method to use, either</span>
<a href="#l30.183"></a><span id="l30.183" class="difflineplus">+ * &quot;crop&quot; or &quot;scale&quot;.</span>
<a href="#l30.184"></a><span id="l30.184" class="difflineplus">+ * @param {Boolean} allowDefault (optional) Passing false causes this method to</span>
<a href="#l30.185"></a><span id="l30.185" class="difflineplus">+ * return null if the user has no avatar image. Otherwise, a default image URL</span>
<a href="#l30.186"></a><span id="l30.186" class="difflineplus">+ * will be returned. Default: true.</span>
<a href="#l30.187"></a><span id="l30.187" class="difflineplus">+ * @param {Boolean} allowDirectLinks (optional) If true, the avatar URL will be</span>
<a href="#l30.188"></a><span id="l30.188" class="difflineplus">+ * returned even if it is a direct hyperlink rather than a matrix content URL.</span>
<a href="#l30.189"></a><span id="l30.189" class="difflineplus">+ * If false, any non-matrix content URLs will be ignored. Setting this option to</span>
<a href="#l30.190"></a><span id="l30.190" class="difflineplus">+ * true will expose URLs that, if fetched, will leak information about the user</span>
<a href="#l30.191"></a><span id="l30.191" class="difflineplus">+ * to anyone who they share a room with.</span>
<a href="#l30.192"></a><span id="l30.192" class="difflineplus">+ * @return {?string} the avatar URL or null.</span>
<a href="#l30.193"></a><span id="l30.193" class="difflineplus">+ */</span>
<a href="#l30.194"></a><span id="l30.194" class="difflineplus">+RoomMember.prototype.getAvatarUrl =</span>
<a href="#l30.195"></a><span id="l30.195" class="difflineplus">+        function(baseUrl, width, height, resizeMethod, allowDefault, allowDirectLinks) {</span>
<a href="#l30.196"></a><span id="l30.196" class="difflineplus">+    if (allowDefault === undefined) { allowDefault = true; }</span>
<a href="#l30.197"></a><span id="l30.197" class="difflineplus">+    if (!this.events.member &amp;&amp; !allowDefault) {</span>
<a href="#l30.198"></a><span id="l30.198" class="difflineplus">+        return null;</span>
<a href="#l30.199"></a><span id="l30.199" class="difflineplus">+    }</span>
<a href="#l30.200"></a><span id="l30.200" class="difflineplus">+    var rawUrl = this.events.member ? this.events.member.getContent().avatar_url : null;</span>
<a href="#l30.201"></a><span id="l30.201" class="difflineplus">+    var httpUrl = ContentRepo.getHttpUriForMxc(</span>
<a href="#l30.202"></a><span id="l30.202" class="difflineplus">+        baseUrl, rawUrl, width, height, resizeMethod, allowDirectLinks</span>
<a href="#l30.203"></a><span id="l30.203" class="difflineplus">+    );</span>
<a href="#l30.204"></a><span id="l30.204" class="difflineplus">+    if (httpUrl) {</span>
<a href="#l30.205"></a><span id="l30.205" class="difflineplus">+        return httpUrl;</span>
<a href="#l30.206"></a><span id="l30.206" class="difflineplus">+    }</span>
<a href="#l30.207"></a><span id="l30.207" class="difflineplus">+    else if (allowDefault) {</span>
<a href="#l30.208"></a><span id="l30.208" class="difflineplus">+        return ContentRepo.getIdenticonUri(</span>
<a href="#l30.209"></a><span id="l30.209" class="difflineplus">+            baseUrl, this.userId, width, height</span>
<a href="#l30.210"></a><span id="l30.210" class="difflineplus">+        );</span>
<a href="#l30.211"></a><span id="l30.211" class="difflineplus">+    }</span>
<a href="#l30.212"></a><span id="l30.212" class="difflineplus">+    return null;</span>
<a href="#l30.213"></a><span id="l30.213" class="difflineplus">+};</span>
<a href="#l30.214"></a><span id="l30.214" class="difflineplus">+</span>
<a href="#l30.215"></a><span id="l30.215" class="difflineplus">+function calculateDisplayName(member, event, roomState) {</span>
<a href="#l30.216"></a><span id="l30.216" class="difflineplus">+    var displayName = event.getDirectionalContent().displayname;</span>
<a href="#l30.217"></a><span id="l30.217" class="difflineplus">+    var selfUserId = member.userId;</span>
<a href="#l30.218"></a><span id="l30.218" class="difflineplus">+</span>
<a href="#l30.219"></a><span id="l30.219" class="difflineplus">+    if (!displayName) {</span>
<a href="#l30.220"></a><span id="l30.220" class="difflineplus">+        return selfUserId;</span>
<a href="#l30.221"></a><span id="l30.221" class="difflineplus">+    }</span>
<a href="#l30.222"></a><span id="l30.222" class="difflineplus">+</span>
<a href="#l30.223"></a><span id="l30.223" class="difflineplus">+    if (!roomState) {</span>
<a href="#l30.224"></a><span id="l30.224" class="difflineplus">+        return displayName;</span>
<a href="#l30.225"></a><span id="l30.225" class="difflineplus">+    }</span>
<a href="#l30.226"></a><span id="l30.226" class="difflineplus">+</span>
<a href="#l30.227"></a><span id="l30.227" class="difflineplus">+    var userIds = roomState.getUserIdsWithDisplayName(displayName);</span>
<a href="#l30.228"></a><span id="l30.228" class="difflineplus">+    var otherUsers = userIds.filter(function(u) {</span>
<a href="#l30.229"></a><span id="l30.229" class="difflineplus">+        return u !== selfUserId;</span>
<a href="#l30.230"></a><span id="l30.230" class="difflineplus">+    });</span>
<a href="#l30.231"></a><span id="l30.231" class="difflineplus">+    if (otherUsers.length &gt; 0) {</span>
<a href="#l30.232"></a><span id="l30.232" class="difflineplus">+        return displayName + &quot; (&quot; + selfUserId + &quot;)&quot;;</span>
<a href="#l30.233"></a><span id="l30.233" class="difflineplus">+    }</span>
<a href="#l30.234"></a><span id="l30.234" class="difflineplus">+    return displayName;</span>
<a href="#l30.235"></a><span id="l30.235" class="difflineplus">+}</span>
<a href="#l30.236"></a><span id="l30.236" class="difflineplus">+</span>
<a href="#l30.237"></a><span id="l30.237" class="difflineplus">+/**</span>
<a href="#l30.238"></a><span id="l30.238" class="difflineplus">+ * The RoomMember class.</span>
<a href="#l30.239"></a><span id="l30.239" class="difflineplus">+ */</span>
<a href="#l30.240"></a><span id="l30.240" class="difflineplus">+module.exports = RoomMember;</span>
<a href="#l30.241"></a><span id="l30.241" class="difflineplus">+</span>
<a href="#l30.242"></a><span id="l30.242" class="difflineplus">+/**</span>
<a href="#l30.243"></a><span id="l30.243" class="difflineplus">+ * Fires whenever any room member's name changes.</span>
<a href="#l30.244"></a><span id="l30.244" class="difflineplus">+ * @event module:client~MatrixClient#&quot;RoomMember.name&quot;</span>
<a href="#l30.245"></a><span id="l30.245" class="difflineplus">+ * @param {MatrixEvent} event The matrix event which caused this event to fire.</span>
<a href="#l30.246"></a><span id="l30.246" class="difflineplus">+ * @param {RoomMember} member The member whose RoomMember.name changed.</span>
<a href="#l30.247"></a><span id="l30.247" class="difflineplus">+ * @param {string?} oldName The previous name. Null if the member didn't have a</span>
<a href="#l30.248"></a><span id="l30.248" class="difflineplus">+ *    name previously.</span>
<a href="#l30.249"></a><span id="l30.249" class="difflineplus">+ * @example</span>
<a href="#l30.250"></a><span id="l30.250" class="difflineplus">+ * matrixClient.on(&quot;RoomMember.name&quot;, function(event, member){</span>
<a href="#l30.251"></a><span id="l30.251" class="difflineplus">+ *   var newName = member.name;</span>
<a href="#l30.252"></a><span id="l30.252" class="difflineplus">+ * });</span>
<a href="#l30.253"></a><span id="l30.253" class="difflineplus">+ */</span>
<a href="#l30.254"></a><span id="l30.254" class="difflineplus">+</span>
<a href="#l30.255"></a><span id="l30.255" class="difflineplus">+/**</span>
<a href="#l30.256"></a><span id="l30.256" class="difflineplus">+ * Fires whenever any room member's membership state changes.</span>
<a href="#l30.257"></a><span id="l30.257" class="difflineplus">+ * @event module:client~MatrixClient#&quot;RoomMember.membership&quot;</span>
<a href="#l30.258"></a><span id="l30.258" class="difflineplus">+ * @param {MatrixEvent} event The matrix event which caused this event to fire.</span>
<a href="#l30.259"></a><span id="l30.259" class="difflineplus">+ * @param {RoomMember} member The member whose RoomMember.membership changed.</span>
<a href="#l30.260"></a><span id="l30.260" class="difflineplus">+ * @param {string?} oldMembership The previous membership state. Null if it's a</span>
<a href="#l30.261"></a><span id="l30.261" class="difflineplus">+ *    new member.</span>
<a href="#l30.262"></a><span id="l30.262" class="difflineplus">+ * @example</span>
<a href="#l30.263"></a><span id="l30.263" class="difflineplus">+ * matrixClient.on(&quot;RoomMember.membership&quot;, function(event, member, oldMembership){</span>
<a href="#l30.264"></a><span id="l30.264" class="difflineplus">+ *   var newState = member.membership;</span>
<a href="#l30.265"></a><span id="l30.265" class="difflineplus">+ * });</span>
<a href="#l30.266"></a><span id="l30.266" class="difflineplus">+ */</span>
<a href="#l30.267"></a><span id="l30.267" class="difflineplus">+</span>
<a href="#l30.268"></a><span id="l30.268" class="difflineplus">+/**</span>
<a href="#l30.269"></a><span id="l30.269" class="difflineplus">+ * Fires whenever any room member's typing state changes.</span>
<a href="#l30.270"></a><span id="l30.270" class="difflineplus">+ * @event module:client~MatrixClient#&quot;RoomMember.typing&quot;</span>
<a href="#l30.271"></a><span id="l30.271" class="difflineplus">+ * @param {MatrixEvent} event The matrix event which caused this event to fire.</span>
<a href="#l30.272"></a><span id="l30.272" class="difflineplus">+ * @param {RoomMember} member The member whose RoomMember.typing changed.</span>
<a href="#l30.273"></a><span id="l30.273" class="difflineplus">+ * @example</span>
<a href="#l30.274"></a><span id="l30.274" class="difflineplus">+ * matrixClient.on(&quot;RoomMember.typing&quot;, function(event, member){</span>
<a href="#l30.275"></a><span id="l30.275" class="difflineplus">+ *   var isTyping = member.typing;</span>
<a href="#l30.276"></a><span id="l30.276" class="difflineplus">+ * });</span>
<a href="#l30.277"></a><span id="l30.277" class="difflineplus">+ */</span>
<a href="#l30.278"></a><span id="l30.278" class="difflineplus">+</span>
<a href="#l30.279"></a><span id="l30.279" class="difflineplus">+/**</span>
<a href="#l30.280"></a><span id="l30.280" class="difflineplus">+ * Fires whenever any room member's power level changes.</span>
<a href="#l30.281"></a><span id="l30.281" class="difflineplus">+ * @event module:client~MatrixClient#&quot;RoomMember.powerLevel&quot;</span>
<a href="#l30.282"></a><span id="l30.282" class="difflineplus">+ * @param {MatrixEvent} event The matrix event which caused this event to fire.</span>
<a href="#l30.283"></a><span id="l30.283" class="difflineplus">+ * @param {RoomMember} member The member whose RoomMember.powerLevel changed.</span>
<a href="#l30.284"></a><span id="l30.284" class="difflineplus">+ * @example</span>
<a href="#l30.285"></a><span id="l30.285" class="difflineplus">+ * matrixClient.on(&quot;RoomMember.powerLevel&quot;, function(event, member){</span>
<a href="#l30.286"></a><span id="l30.286" class="difflineplus">+ *   var newPowerLevel = member.powerLevel;</span>
<a href="#l30.287"></a><span id="l30.287" class="difflineplus">+ *   var newNormPowerLevel = member.powerLevelNorm;</span>
<a href="#l30.288"></a><span id="l30.288" class="difflineplus">+ * });</span>
<a href="#l30.289"></a><span id="l30.289" class="difflineplus">+ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l31.1"></a><span id="l31.1">new file mode 100644</span>
<a href="#l31.2"></a><span id="l31.2" class="difflineminus">--- /dev/null</span>
<a href="#l31.3"></a><span id="l31.3" class="difflineplus">+++ b/chat/protocols/matrix/matrix-sdk/models/room-state.js</span>
<a href="#l31.4"></a><span id="l31.4" class="difflineat">@@ -0,0 +1,432 @@</span>
<a href="#l31.5"></a><span id="l31.5" class="difflineplus">+/*</span>
<a href="#l31.6"></a><span id="l31.6" class="difflineplus">+Copyright 2015, 2016 OpenMarket Ltd</span>
<a href="#l31.7"></a><span id="l31.7" class="difflineplus">+</span>
<a href="#l31.8"></a><span id="l31.8" class="difflineplus">+Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<a href="#l31.9"></a><span id="l31.9" class="difflineplus">+you may not use this file except in compliance with the License.</span>
<a href="#l31.10"></a><span id="l31.10" class="difflineplus">+You may obtain a copy of the License at</span>
<a href="#l31.11"></a><span id="l31.11" class="difflineplus">+</span>
<a href="#l31.12"></a><span id="l31.12" class="difflineplus">+    http://www.apache.org/licenses/LICENSE-2.0</span>
<a href="#l31.13"></a><span id="l31.13" class="difflineplus">+</span>
<a href="#l31.14"></a><span id="l31.14" class="difflineplus">+Unless required by applicable law or agreed to in writing, software</span>
<a href="#l31.15"></a><span id="l31.15" class="difflineplus">+distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<a href="#l31.16"></a><span id="l31.16" class="difflineplus">+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<a href="#l31.17"></a><span id="l31.17" class="difflineplus">+See the License for the specific language governing permissions and</span>
<a href="#l31.18"></a><span id="l31.18" class="difflineplus">+limitations under the License.</span>
<a href="#l31.19"></a><span id="l31.19" class="difflineplus">+*/</span>
<a href="#l31.20"></a><span id="l31.20" class="difflineplus">+&quot;use strict&quot;;</span>
<a href="#l31.21"></a><span id="l31.21" class="difflineplus">+/**</span>
<a href="#l31.22"></a><span id="l31.22" class="difflineplus">+ * @module models/room-state</span>
<a href="#l31.23"></a><span id="l31.23" class="difflineplus">+ */</span>
<a href="#l31.24"></a><span id="l31.24" class="difflineplus">+var EventEmitter = require(&quot;events&quot;).EventEmitter;</span>
<a href="#l31.25"></a><span id="l31.25" class="difflineplus">+</span>
<a href="#l31.26"></a><span id="l31.26" class="difflineplus">+var utils = require(&quot;../utils&quot;);</span>
<a href="#l31.27"></a><span id="l31.27" class="difflineplus">+var RoomMember = require(&quot;./room-member&quot;);</span>
<a href="#l31.28"></a><span id="l31.28" class="difflineplus">+</span>
<a href="#l31.29"></a><span id="l31.29" class="difflineplus">+/**</span>
<a href="#l31.30"></a><span id="l31.30" class="difflineplus">+ * Construct room state.</span>
<a href="#l31.31"></a><span id="l31.31" class="difflineplus">+ * @constructor</span>
<a href="#l31.32"></a><span id="l31.32" class="difflineplus">+ * @param {?string} roomId Optional. The ID of the room which has this state.</span>
<a href="#l31.33"></a><span id="l31.33" class="difflineplus">+ * If none is specified it just tracks paginationTokens, useful for notifTimelineSet</span>
<a href="#l31.34"></a><span id="l31.34" class="difflineplus">+ * @prop {Object.&lt;string, RoomMember&gt;} members The room member dictionary, keyed</span>
<a href="#l31.35"></a><span id="l31.35" class="difflineplus">+ * on the user's ID.</span>
<a href="#l31.36"></a><span id="l31.36" class="difflineplus">+ * @prop {Object.&lt;string, Object.&lt;string, MatrixEvent&gt;&gt;} events The state</span>
<a href="#l31.37"></a><span id="l31.37" class="difflineplus">+ * events dictionary, keyed on the event type and then the state_key value.</span>
<a href="#l31.38"></a><span id="l31.38" class="difflineplus">+ * @prop {string} paginationToken The pagination token for this state.</span>
<a href="#l31.39"></a><span id="l31.39" class="difflineplus">+ */</span>
<a href="#l31.40"></a><span id="l31.40" class="difflineplus">+function RoomState(roomId) {</span>
<a href="#l31.41"></a><span id="l31.41" class="difflineplus">+    this.roomId = roomId;</span>
<a href="#l31.42"></a><span id="l31.42" class="difflineplus">+    this.members = {</span>
<a href="#l31.43"></a><span id="l31.43" class="difflineplus">+        // userId: RoomMember</span>
<a href="#l31.44"></a><span id="l31.44" class="difflineplus">+    };</span>
<a href="#l31.45"></a><span id="l31.45" class="difflineplus">+    this.events = {</span>
<a href="#l31.46"></a><span id="l31.46" class="difflineplus">+        // eventType: { stateKey: MatrixEvent }</span>
<a href="#l31.47"></a><span id="l31.47" class="difflineplus">+    };</span>
<a href="#l31.48"></a><span id="l31.48" class="difflineplus">+    this.paginationToken = null;</span>
<a href="#l31.49"></a><span id="l31.49" class="difflineplus">+</span>
<a href="#l31.50"></a><span id="l31.50" class="difflineplus">+    this._sentinels = {</span>
<a href="#l31.51"></a><span id="l31.51" class="difflineplus">+        // userId: RoomMember</span>
<a href="#l31.52"></a><span id="l31.52" class="difflineplus">+    };</span>
<a href="#l31.53"></a><span id="l31.53" class="difflineplus">+    this._updateModifiedTime();</span>
<a href="#l31.54"></a><span id="l31.54" class="difflineplus">+    this._displayNameToUserIds = {};</span>
<a href="#l31.55"></a><span id="l31.55" class="difflineplus">+    this._userIdsToDisplayNames = {};</span>
<a href="#l31.56"></a><span id="l31.56" class="difflineplus">+    this._tokenToInvite = {}; // 3pid invite state_key to m.room.member invite</span>
<a href="#l31.57"></a><span id="l31.57" class="difflineplus">+}</span>
<a href="#l31.58"></a><span id="l31.58" class="difflineplus">+utils.inherits(RoomState, EventEmitter);</span>
<a href="#l31.59"></a><span id="l31.59" class="difflineplus">+</span>
<a href="#l31.60"></a><span id="l31.60" class="difflineplus">+/**</span>
<a href="#l31.61"></a><span id="l31.61" class="difflineplus">+ * Get all RoomMembers in this room.</span>
<a href="#l31.62"></a><span id="l31.62" class="difflineplus">+ * @return {Array&lt;RoomMember&gt;} A list of RoomMembers.</span>
<a href="#l31.63"></a><span id="l31.63" class="difflineplus">+ */</span>
<a href="#l31.64"></a><span id="l31.64" class="difflineplus">+RoomState.prototype.getMembers = function() {</span>
<a href="#l31.65"></a><span id="l31.65" class="difflineplus">+    return utils.values(this.members);</span>
<a href="#l31.66"></a><span id="l31.66" class="difflineplus">+};</span>
<a href="#l31.67"></a><span id="l31.67" class="difflineplus">+</span>
<a href="#l31.68"></a><span id="l31.68" class="difflineplus">+/**</span>
<a href="#l31.69"></a><span id="l31.69" class="difflineplus">+ * Get a room member by their user ID.</span>
<a href="#l31.70"></a><span id="l31.70" class="difflineplus">+ * @param {string} userId The room member's user ID.</span>
<a href="#l31.71"></a><span id="l31.71" class="difflineplus">+ * @return {RoomMember} The member or null if they do not exist.</span>
<a href="#l31.72"></a><span id="l31.72" class="difflineplus">+ */</span>
<a href="#l31.73"></a><span id="l31.73" class="difflineplus">+RoomState.prototype.getMember = function(userId) {</span>
<a href="#l31.74"></a><span id="l31.74" class="difflineplus">+    return this.members[userId] || null;</span>
<a href="#l31.75"></a><span id="l31.75" class="difflineplus">+};</span>
<a href="#l31.76"></a><span id="l31.76" class="difflineplus">+</span>
<a href="#l31.77"></a><span id="l31.77" class="difflineplus">+/**</span>
<a href="#l31.78"></a><span id="l31.78" class="difflineplus">+ * Get a room member whose properties will not change with this room state. You</span>
<a href="#l31.79"></a><span id="l31.79" class="difflineplus">+ * typically want this if you want to attach a RoomMember to a MatrixEvent which</span>
<a href="#l31.80"></a><span id="l31.80" class="difflineplus">+ * may no longer be represented correctly by Room.currentState or Room.oldState.</span>
<a href="#l31.81"></a><span id="l31.81" class="difflineplus">+ * The term 'sentinel' refers to the fact that this RoomMember is an unchanging</span>
<a href="#l31.82"></a><span id="l31.82" class="difflineplus">+ * guardian for state at this particular point in time.</span>
<a href="#l31.83"></a><span id="l31.83" class="difflineplus">+ * @param {string} userId The room member's user ID.</span>
<a href="#l31.84"></a><span id="l31.84" class="difflineplus">+ * @return {RoomMember} The member or null if they do not exist.</span>
<a href="#l31.85"></a><span id="l31.85" class="difflineplus">+ */</span>
<a href="#l31.86"></a><span id="l31.86" class="difflineplus">+RoomState.prototype.getSentinelMember = function(userId) {</span>
<a href="#l31.87"></a><span id="l31.87" class="difflineplus">+    return this._sentinels[userId] || null;</span>
<a href="#l31.88"></a><span id="l31.88" class="difflineplus">+};</span>
<a href="#l31.89"></a><span id="l31.89" class="difflineplus">+</span>
<a href="#l31.90"></a><span id="l31.90" class="difflineplus">+/**</span>
<a href="#l31.91"></a><span id="l31.91" class="difflineplus">+ * Get state events from the state of the room.</span>
<a href="#l31.92"></a><span id="l31.92" class="difflineplus">+ * @param {string} eventType The event type of the state event.</span>
<a href="#l31.93"></a><span id="l31.93" class="difflineplus">+ * @param {string} stateKey Optional. The state_key of the state event. If</span>
<a href="#l31.94"></a><span id="l31.94" class="difflineplus">+ * this is &lt;code&gt;undefined&lt;/code&gt; then all matching state events will be</span>
<a href="#l31.95"></a><span id="l31.95" class="difflineplus">+ * returned.</span>
<a href="#l31.96"></a><span id="l31.96" class="difflineplus">+ * @return {MatrixEvent[]|MatrixEvent} A list of events if state_key was</span>
<a href="#l31.97"></a><span id="l31.97" class="difflineplus">+ * &lt;code&gt;undefined&lt;/code&gt;, else a single event (or null if no match found).</span>
<a href="#l31.98"></a><span id="l31.98" class="difflineplus">+ */</span>
<a href="#l31.99"></a><span id="l31.99" class="difflineplus">+RoomState.prototype.getStateEvents = function(eventType, stateKey) {</span>
<a href="#l31.100"></a><span id="l31.100" class="difflineplus">+    if (!this.events[eventType]) {</span>
<a href="#l31.101"></a><span id="l31.101" class="difflineplus">+        // no match</span>
<a href="#l31.102"></a><span id="l31.102" class="difflineplus">+        return stateKey === undefined ? [] : null;</span>
<a href="#l31.103"></a><span id="l31.103" class="difflineplus">+    }</span>
<a href="#l31.104"></a><span id="l31.104" class="difflineplus">+    if (stateKey === undefined) { // return all values</span>
<a href="#l31.105"></a><span id="l31.105" class="difflineplus">+        return utils.values(this.events[eventType]);</span>
<a href="#l31.106"></a><span id="l31.106" class="difflineplus">+    }</span>
<a href="#l31.107"></a><span id="l31.107" class="difflineplus">+    var event = this.events[eventType][stateKey];</span>
<a href="#l31.108"></a><span id="l31.108" class="difflineplus">+    return event ? event : null;</span>
<a href="#l31.109"></a><span id="l31.109" class="difflineplus">+};</span>
<a href="#l31.110"></a><span id="l31.110" class="difflineplus">+</span>
<a href="#l31.111"></a><span id="l31.111" class="difflineplus">+/**</span>
<a href="#l31.112"></a><span id="l31.112" class="difflineplus">+ * Add an array of one or more state MatrixEvents, overwriting</span>
<a href="#l31.113"></a><span id="l31.113" class="difflineplus">+ * any existing state with the same {type, stateKey} tuple. Will fire</span>
<a href="#l31.114"></a><span id="l31.114" class="difflineplus">+ * &quot;RoomState.events&quot; for every event added. May fire &quot;RoomState.members&quot;</span>
<a href="#l31.115"></a><span id="l31.115" class="difflineplus">+ * if there are &lt;code&gt;m.room.member&lt;/code&gt; events.</span>
<a href="#l31.116"></a><span id="l31.116" class="difflineplus">+ * @param {MatrixEvent[]} stateEvents a list of state events for this room.</span>
<a href="#l31.117"></a><span id="l31.117" class="difflineplus">+ * @fires module:client~MatrixClient#event:&quot;RoomState.members&quot;</span>
<a href="#l31.118"></a><span id="l31.118" class="difflineplus">+ * @fires module:client~MatrixClient#event:&quot;RoomState.newMember&quot;</span>
<a href="#l31.119"></a><span id="l31.119" class="difflineplus">+ * @fires module:client~MatrixClient#event:&quot;RoomState.events&quot;</span>
<a href="#l31.120"></a><span id="l31.120" class="difflineplus">+ */</span>
<a href="#l31.121"></a><span id="l31.121" class="difflineplus">+RoomState.prototype.setStateEvents = function(stateEvents) {</span>
<a href="#l31.122"></a><span id="l31.122" class="difflineplus">+    var self = this;</span>
<a href="#l31.123"></a><span id="l31.123" class="difflineplus">+    this._updateModifiedTime();</span>
<a href="#l31.124"></a><span id="l31.124" class="difflineplus">+</span>
<a href="#l31.125"></a><span id="l31.125" class="difflineplus">+    // update the core event dict</span>
<a href="#l31.126"></a><span id="l31.126" class="difflineplus">+    utils.forEach(stateEvents, function(event) {</span>
<a href="#l31.127"></a><span id="l31.127" class="difflineplus">+        if (event.getRoomId() !== self.roomId) { return; }</span>
<a href="#l31.128"></a><span id="l31.128" class="difflineplus">+        if (!event.isState()) { return; }</span>
<a href="#l31.129"></a><span id="l31.129" class="difflineplus">+</span>
<a href="#l31.130"></a><span id="l31.130" class="difflineplus">+        if (self.events[event.getType()] === undefined) {</span>
<a href="#l31.131"></a><span id="l31.131" class="difflineplus">+            self.events[event.getType()] = {};</span>
<a href="#l31.132"></a><span id="l31.132" class="difflineplus">+        }</span>
<a href="#l31.133"></a><span id="l31.133" class="difflineplus">+        self.events[event.getType()][event.getStateKey()] = event;</span>
<a href="#l31.134"></a><span id="l31.134" class="difflineplus">+        if (event.getType() === &quot;m.room.member&quot;) {</span>
<a href="#l31.135"></a><span id="l31.135" class="difflineplus">+            _updateDisplayNameCache(</span>
<a href="#l31.136"></a><span id="l31.136" class="difflineplus">+                self, event.getStateKey(), event.getContent().displayname</span>
<a href="#l31.137"></a><span id="l31.137" class="difflineplus">+            );</span>
<a href="#l31.138"></a><span id="l31.138" class="difflineplus">+            _updateThirdPartyTokenCache(self, event);</span>
<a href="#l31.139"></a><span id="l31.139" class="difflineplus">+        }</span>
<a href="#l31.140"></a><span id="l31.140" class="difflineplus">+        self.emit(&quot;RoomState.events&quot;, event, self);</span>
<a href="#l31.141"></a><span id="l31.141" class="difflineplus">+    });</span>
<a href="#l31.142"></a><span id="l31.142" class="difflineplus">+</span>
<a href="#l31.143"></a><span id="l31.143" class="difflineplus">+    // update higher level data structures. This needs to be done AFTER the</span>
<a href="#l31.144"></a><span id="l31.144" class="difflineplus">+    // core event dict as these structures may depend on other state events in</span>
<a href="#l31.145"></a><span id="l31.145" class="difflineplus">+    // the given array (e.g. disambiguating display names in one go to do both</span>
<a href="#l31.146"></a><span id="l31.146" class="difflineplus">+    // clashing names rather than progressively which only catches 1 of them).</span>
<a href="#l31.147"></a><span id="l31.147" class="difflineplus">+    utils.forEach(stateEvents, function(event) {</span>
<a href="#l31.148"></a><span id="l31.148" class="difflineplus">+        if (event.getRoomId() !== self.roomId) { return; }</span>
<a href="#l31.149"></a><span id="l31.149" class="difflineplus">+        if (!event.isState()) { return; }</span>
<a href="#l31.150"></a><span id="l31.150" class="difflineplus">+</span>
<a href="#l31.151"></a><span id="l31.151" class="difflineplus">+        if (event.getType() === &quot;m.room.member&quot;) {</span>
<a href="#l31.152"></a><span id="l31.152" class="difflineplus">+            var userId = event.getStateKey();</span>
<a href="#l31.153"></a><span id="l31.153" class="difflineplus">+</span>
<a href="#l31.154"></a><span id="l31.154" class="difflineplus">+            // leave events apparently elide the displayname or avatar_url,</span>
<a href="#l31.155"></a><span id="l31.155" class="difflineplus">+            // so let's fake one up so that we don't leak user ids</span>
<a href="#l31.156"></a><span id="l31.156" class="difflineplus">+            // into the timeline</span>
<a href="#l31.157"></a><span id="l31.157" class="difflineplus">+            if (event.getContent().membership === &quot;leave&quot; ||</span>
<a href="#l31.158"></a><span id="l31.158" class="difflineplus">+                event.getContent().membership === &quot;ban&quot;)</span>
<a href="#l31.159"></a><span id="l31.159" class="difflineplus">+            {</span>
<a href="#l31.160"></a><span id="l31.160" class="difflineplus">+                event.getContent().avatar_url =</span>
<a href="#l31.161"></a><span id="l31.161" class="difflineplus">+                    event.getContent().avatar_url ||</span>
<a href="#l31.162"></a><span id="l31.162" class="difflineplus">+                    event.getPrevContent().avatar_url;</span>
<a href="#l31.163"></a><span id="l31.163" class="difflineplus">+                event.getContent().displayname =</span>
<a href="#l31.164"></a><span id="l31.164" class="difflineplus">+                    event.getContent().displayname ||</span>
<a href="#l31.165"></a><span id="l31.165" class="difflineplus">+                    event.getPrevContent().displayname;</span>
<a href="#l31.166"></a><span id="l31.166" class="difflineplus">+            }</span>
<a href="#l31.167"></a><span id="l31.167" class="difflineplus">+</span>
<a href="#l31.168"></a><span id="l31.168" class="difflineplus">+            var member = self.members[userId];</span>
<a href="#l31.169"></a><span id="l31.169" class="difflineplus">+            if (!member) {</span>
<a href="#l31.170"></a><span id="l31.170" class="difflineplus">+                member = new RoomMember(event.getRoomId(), userId);</span>
<a href="#l31.171"></a><span id="l31.171" class="difflineplus">+                self.emit(&quot;RoomState.newMember&quot;, event, self, member);</span>
<a href="#l31.172"></a><span id="l31.172" class="difflineplus">+            }</span>
<a href="#l31.173"></a><span id="l31.173" class="difflineplus">+            // Add a new sentinel for this change. We apply the same</span>
<a href="#l31.174"></a><span id="l31.174" class="difflineplus">+            // operations to both sentinel and member rather than deep copying</span>
<a href="#l31.175"></a><span id="l31.175" class="difflineplus">+            // so we don't make assumptions about the properties of RoomMember</span>
<a href="#l31.176"></a><span id="l31.176" class="difflineplus">+            // (e.g. and manage to break it because deep copying doesn't do</span>
<a href="#l31.177"></a><span id="l31.177" class="difflineplus">+            // everything).</span>
<a href="#l31.178"></a><span id="l31.178" class="difflineplus">+            var sentinel = new RoomMember(event.getRoomId(), userId);</span>
<a href="#l31.179"></a><span id="l31.179" class="difflineplus">+            utils.forEach([member, sentinel], function(roomMember) {</span>
<a href="#l31.180"></a><span id="l31.180" class="difflineplus">+                roomMember.setMembershipEvent(event, self);</span>
<a href="#l31.181"></a><span id="l31.181" class="difflineplus">+                // this member may have a power level already, so set it.</span>
<a href="#l31.182"></a><span id="l31.182" class="difflineplus">+                var pwrLvlEvent = self.getStateEvents(&quot;m.room.power_levels&quot;, &quot;&quot;);</span>
<a href="#l31.183"></a><span id="l31.183" class="difflineplus">+                if (pwrLvlEvent) {</span>
<a href="#l31.184"></a><span id="l31.184" class="difflineplus">+                    roomMember.setPowerLevelEvent(pwrLvlEvent);</span>
<a href="#l31.185"></a><span id="l31.185" class="difflineplus">+                }</span>
<a href="#l31.186"></a><span id="l31.186" class="difflineplus">+            });</span>
<a href="#l31.187"></a><span id="l31.187" class="difflineplus">+</span>
<a href="#l31.188"></a><span id="l31.188" class="difflineplus">+            self._sentinels[userId] = sentinel;</span>
<a href="#l31.189"></a><span id="l31.189" class="difflineplus">+            self.members[userId] = member;</span>
<a href="#l31.190"></a><span id="l31.190" class="difflineplus">+            self.emit(&quot;RoomState.members&quot;, event, self, member);</span>
<a href="#l31.191"></a><span id="l31.191" class="difflineplus">+        }</span>
<a href="#l31.192"></a><span id="l31.192" class="difflineplus">+        else if (event.getType() === &quot;m.room.power_levels&quot;) {</span>
<a href="#l31.193"></a><span id="l31.193" class="difflineplus">+            var members = utils.values(self.members);</span>
<a href="#l31.194"></a><span id="l31.194" class="difflineplus">+            utils.forEach(members, function(member) {</span>
<a href="#l31.195"></a><span id="l31.195" class="difflineplus">+                member.setPowerLevelEvent(event);</span>
<a href="#l31.196"></a><span id="l31.196" class="difflineplus">+                self.emit(&quot;RoomState.members&quot;, event, self, member);</span>
<a href="#l31.197"></a><span id="l31.197" class="difflineplus">+            });</span>
<a href="#l31.198"></a><span id="l31.198" class="difflineplus">+        }</span>
<a href="#l31.199"></a><span id="l31.199" class="difflineplus">+    });</span>
<a href="#l31.200"></a><span id="l31.200" class="difflineplus">+};</span>
<a href="#l31.201"></a><span id="l31.201" class="difflineplus">+</span>
<a href="#l31.202"></a><span id="l31.202" class="difflineplus">+/**</span>
<a href="#l31.203"></a><span id="l31.203" class="difflineplus">+ * Set the current typing event for this room.</span>
<a href="#l31.204"></a><span id="l31.204" class="difflineplus">+ * @param {MatrixEvent} event The typing event</span>
<a href="#l31.205"></a><span id="l31.205" class="difflineplus">+ */</span>
<a href="#l31.206"></a><span id="l31.206" class="difflineplus">+RoomState.prototype.setTypingEvent = function(event) {</span>
<a href="#l31.207"></a><span id="l31.207" class="difflineplus">+    utils.forEach(utils.values(this.members), function(member) {</span>
<a href="#l31.208"></a><span id="l31.208" class="difflineplus">+        member.setTypingEvent(event);</span>
<a href="#l31.209"></a><span id="l31.209" class="difflineplus">+    });</span>
<a href="#l31.210"></a><span id="l31.210" class="difflineplus">+};</span>
<a href="#l31.211"></a><span id="l31.211" class="difflineplus">+</span>
<a href="#l31.212"></a><span id="l31.212" class="difflineplus">+/**</span>
<a href="#l31.213"></a><span id="l31.213" class="difflineplus">+ * Get the m.room.member event which has the given third party invite token.</span>
<a href="#l31.214"></a><span id="l31.214" class="difflineplus">+ *</span>
<a href="#l31.215"></a><span id="l31.215" class="difflineplus">+ * @param {string} token The token</span>
<a href="#l31.216"></a><span id="l31.216" class="difflineplus">+ * @return {?MatrixEvent} The m.room.member event or null</span>
<a href="#l31.217"></a><span id="l31.217" class="difflineplus">+ */</span>
<a href="#l31.218"></a><span id="l31.218" class="difflineplus">+RoomState.prototype.getInviteForThreePidToken = function(token) {</span>
<a href="#l31.219"></a><span id="l31.219" class="difflineplus">+    return this._tokenToInvite[token] || null;</span>
<a href="#l31.220"></a><span id="l31.220" class="difflineplus">+};</span>
<a href="#l31.221"></a><span id="l31.221" class="difflineplus">+</span>
<a href="#l31.222"></a><span id="l31.222" class="difflineplus">+/**</span>
<a href="#l31.223"></a><span id="l31.223" class="difflineplus">+ * Update the last modified time to the current time.</span>
<a href="#l31.224"></a><span id="l31.224" class="difflineplus">+ */</span>
<a href="#l31.225"></a><span id="l31.225" class="difflineplus">+RoomState.prototype._updateModifiedTime = function() {</span>
<a href="#l31.226"></a><span id="l31.226" class="difflineplus">+    this._modified = Date.now();</span>
<a href="#l31.227"></a><span id="l31.227" class="difflineplus">+};</span>
<a href="#l31.228"></a><span id="l31.228" class="difflineplus">+</span>
<a href="#l31.229"></a><span id="l31.229" class="difflineplus">+/**</span>
<a href="#l31.230"></a><span id="l31.230" class="difflineplus">+ * Get the timestamp when this room state was last updated. This timestamp is</span>
<a href="#l31.231"></a><span id="l31.231" class="difflineplus">+ * updated when this object has received new state events.</span>
<a href="#l31.232"></a><span id="l31.232" class="difflineplus">+ * @return {number} The timestamp</span>
<a href="#l31.233"></a><span id="l31.233" class="difflineplus">+ */</span>
<a href="#l31.234"></a><span id="l31.234" class="difflineplus">+RoomState.prototype.getLastModifiedTime = function() {</span>
<a href="#l31.235"></a><span id="l31.235" class="difflineplus">+    return this._modified;</span>
<a href="#l31.236"></a><span id="l31.236" class="difflineplus">+};</span>
<a href="#l31.237"></a><span id="l31.237" class="difflineplus">+</span>
<a href="#l31.238"></a><span id="l31.238" class="difflineplus">+/**</span>
<a href="#l31.239"></a><span id="l31.239" class="difflineplus">+ * Get user IDs with the specified display name.</span>
<a href="#l31.240"></a><span id="l31.240" class="difflineplus">+ * @param {string} displayName The display name to get user IDs from.</span>
<a href="#l31.241"></a><span id="l31.241" class="difflineplus">+ * @return {string[]} An array of user IDs or an empty array.</span>
<a href="#l31.242"></a><span id="l31.242" class="difflineplus">+ */</span>
<a href="#l31.243"></a><span id="l31.243" class="difflineplus">+RoomState.prototype.getUserIdsWithDisplayName = function(displayName) {</span>
<a href="#l31.244"></a><span id="l31.244" class="difflineplus">+    return this._displayNameToUserIds[displayName] || [];</span>
<a href="#l31.245"></a><span id="l31.245" class="difflineplus">+};</span>
<a href="#l31.246"></a><span id="l31.246" class="difflineplus">+</span>
<a href="#l31.247"></a><span id="l31.247" class="difflineplus">+/**</span>
<a href="#l31.248"></a><span id="l31.248" class="difflineplus">+ * Short-form for maySendEvent('m.room.message', userId)</span>
<a href="#l31.249"></a><span id="l31.249" class="difflineplus">+ * @param {string} userId The user ID of the user to test permission for</span>
<a href="#l31.250"></a><span id="l31.250" class="difflineplus">+ * @return {boolean} true if the given user ID should be permitted to send</span>
<a href="#l31.251"></a><span id="l31.251" class="difflineplus">+ *                   message events into the given room.</span>
<a href="#l31.252"></a><span id="l31.252" class="difflineplus">+ */</span>
<a href="#l31.253"></a><span id="l31.253" class="difflineplus">+RoomState.prototype.maySendMessage = function(userId) {</span>
<a href="#l31.254"></a><span id="l31.254" class="difflineplus">+    return this._maySendEventOfType('m.room.message', userId, false);</span>
<a href="#l31.255"></a><span id="l31.255" class="difflineplus">+};</span>
<a href="#l31.256"></a><span id="l31.256" class="difflineplus">+</span>
<a href="#l31.257"></a><span id="l31.257" class="difflineplus">+/**</span>
<a href="#l31.258"></a><span id="l31.258" class="difflineplus">+ * Returns true if the given user ID has permission to send a normal</span>
<a href="#l31.259"></a><span id="l31.259" class="difflineplus">+ * event of type `eventType` into this room.</span>
<a href="#l31.260"></a><span id="l31.260" class="difflineplus">+ * @param {string} type The type of event to test</span>
<a href="#l31.261"></a><span id="l31.261" class="difflineplus">+ * @param {string} userId The user ID of the user to test permission for</span>
<a href="#l31.262"></a><span id="l31.262" class="difflineplus">+ * @return {boolean} true if the given user ID should be permitted to send</span>
<a href="#l31.263"></a><span id="l31.263" class="difflineplus">+ *                        the given type of event into this room,</span>
<a href="#l31.264"></a><span id="l31.264" class="difflineplus">+ *                        according to the room's state.</span>
<a href="#l31.265"></a><span id="l31.265" class="difflineplus">+ */</span>
<a href="#l31.266"></a><span id="l31.266" class="difflineplus">+RoomState.prototype.maySendEvent = function(eventType, userId) {</span>
<a href="#l31.267"></a><span id="l31.267" class="difflineplus">+    return this._maySendEventOfType(eventType, userId, false);</span>
<a href="#l31.268"></a><span id="l31.268" class="difflineplus">+};</span>
<a href="#l31.269"></a><span id="l31.269" class="difflineplus">+</span>
<a href="#l31.270"></a><span id="l31.270" class="difflineplus">+</span>
<a href="#l31.271"></a><span id="l31.271" class="difflineplus">+/**</span>
<a href="#l31.272"></a><span id="l31.272" class="difflineplus">+ * Returns true if the given MatrixClient has permission to send a state</span>
<a href="#l31.273"></a><span id="l31.273" class="difflineplus">+ * event of type `stateEventType` into this room.</span>
<a href="#l31.274"></a><span id="l31.274" class="difflineplus">+ * @param {string} type The type of state events to test</span>
<a href="#l31.275"></a><span id="l31.275" class="difflineplus">+ * @param {MatrixClient}  The client to test permission for</span>
<a href="#l31.276"></a><span id="l31.276" class="difflineplus">+ * @return {boolean} true if the given client should be permitted to send</span>
<a href="#l31.277"></a><span id="l31.277" class="difflineplus">+ *                        the given type of state event into this room,</span>
<a href="#l31.278"></a><span id="l31.278" class="difflineplus">+ *                        according to the room's state.</span>
<a href="#l31.279"></a><span id="l31.279" class="difflineplus">+ */</span>
<a href="#l31.280"></a><span id="l31.280" class="difflineplus">+RoomState.prototype.mayClientSendStateEvent = function(stateEventType, cli) {</span>
<a href="#l31.281"></a><span id="l31.281" class="difflineplus">+    if (cli.isGuest()) {</span>
<a href="#l31.282"></a><span id="l31.282" class="difflineplus">+        return false;</span>
<a href="#l31.283"></a><span id="l31.283" class="difflineplus">+    }</span>
<a href="#l31.284"></a><span id="l31.284" class="difflineplus">+    return this.maySendStateEvent(stateEventType, cli.credentials.userId);</span>
<a href="#l31.285"></a><span id="l31.285" class="difflineplus">+};</span>
<a href="#l31.286"></a><span id="l31.286" class="difflineplus">+</span>
<a href="#l31.287"></a><span id="l31.287" class="difflineplus">+/**</span>
<a href="#l31.288"></a><span id="l31.288" class="difflineplus">+ * Returns true if the given user ID has permission to send a state</span>
<a href="#l31.289"></a><span id="l31.289" class="difflineplus">+ * event of type `stateEventType` into this room.</span>
<a href="#l31.290"></a><span id="l31.290" class="difflineplus">+ * @param {string} type The type of state events to test</span>
<a href="#l31.291"></a><span id="l31.291" class="difflineplus">+ * @param {string} userId The user ID of the user to test permission for</span>
<a href="#l31.292"></a><span id="l31.292" class="difflineplus">+ * @return {boolean} true if the given user ID should be permitted to send</span>
<a href="#l31.293"></a><span id="l31.293" class="difflineplus">+ *                        the given type of state event into this room,</span>
<a href="#l31.294"></a><span id="l31.294" class="difflineplus">+ *                        according to the room's state.</span>
<a href="#l31.295"></a><span id="l31.295" class="difflineplus">+ */</span>
<a href="#l31.296"></a><span id="l31.296" class="difflineplus">+RoomState.prototype.maySendStateEvent = function(stateEventType, userId) {</span>
<a href="#l31.297"></a><span id="l31.297" class="difflineplus">+    return this._maySendEventOfType(stateEventType, userId, true);</span>
<a href="#l31.298"></a><span id="l31.298" class="difflineplus">+};</span>
<a href="#l31.299"></a><span id="l31.299" class="difflineplus">+</span>
<a href="#l31.300"></a><span id="l31.300" class="difflineplus">+/**</span>
<a href="#l31.301"></a><span id="l31.301" class="difflineplus">+ * Returns true if the given user ID has permission to send a normal or state</span>
<a href="#l31.302"></a><span id="l31.302" class="difflineplus">+ * event of type `eventType` into this room.</span>
<a href="#l31.303"></a><span id="l31.303" class="difflineplus">+ * @param {string} type The type of event to test</span>
<a href="#l31.304"></a><span id="l31.304" class="difflineplus">+ * @param {string} userId The user ID of the user to test permission for</span>
<a href="#l31.305"></a><span id="l31.305" class="difflineplus">+ * @param {boolean} state If true, tests if the user may send a state</span>
<a href="#l31.306"></a><span id="l31.306" class="difflineplus">+                          event of this type. Otherwise tests whether</span>
<a href="#l31.307"></a><span id="l31.307" class="difflineplus">+                          they may send a regular event.</span>
<a href="#l31.308"></a><span id="l31.308" class="difflineplus">+ * @return {boolean} true if the given user ID should be permitted to send</span>
<a href="#l31.309"></a><span id="l31.309" class="difflineplus">+ *                        the given type of event into this room,</span>
<a href="#l31.310"></a><span id="l31.310" class="difflineplus">+ *                        according to the room's state.</span>
<a href="#l31.311"></a><span id="l31.311" class="difflineplus">+ */</span>
<a href="#l31.312"></a><span id="l31.312" class="difflineplus">+RoomState.prototype._maySendEventOfType = function(eventType, userId, state) {</span>
<a href="#l31.313"></a><span id="l31.313" class="difflineplus">+    var member = this.getMember(userId);</span>
<a href="#l31.314"></a><span id="l31.314" class="difflineplus">+    if (!member || member.membership == 'leave') { return false; }</span>
<a href="#l31.315"></a><span id="l31.315" class="difflineplus">+</span>
<a href="#l31.316"></a><span id="l31.316" class="difflineplus">+    var power_levels_event = this.getStateEvents('m.room.power_levels', '');</span>
<a href="#l31.317"></a><span id="l31.317" class="difflineplus">+</span>
<a href="#l31.318"></a><span id="l31.318" class="difflineplus">+    var power_levels;</span>
<a href="#l31.319"></a><span id="l31.319" class="difflineplus">+    var events_levels = {};</span>
<a href="#l31.320"></a><span id="l31.320" class="difflineplus">+</span>
<a href="#l31.321"></a><span id="l31.321" class="difflineplus">+    var default_user_level = 0;</span>
<a href="#l31.322"></a><span id="l31.322" class="difflineplus">+    var user_levels = [];</span>
<a href="#l31.323"></a><span id="l31.323" class="difflineplus">+</span>
<a href="#l31.324"></a><span id="l31.324" class="difflineplus">+    var state_default = 0;</span>
<a href="#l31.325"></a><span id="l31.325" class="difflineplus">+    var events_default = 0;</span>
<a href="#l31.326"></a><span id="l31.326" class="difflineplus">+    if (power_levels_event) {</span>
<a href="#l31.327"></a><span id="l31.327" class="difflineplus">+        power_levels = power_levels_event.getContent();</span>
<a href="#l31.328"></a><span id="l31.328" class="difflineplus">+        events_levels = power_levels.events || {};</span>
<a href="#l31.329"></a><span id="l31.329" class="difflineplus">+</span>
<a href="#l31.330"></a><span id="l31.330" class="difflineplus">+        default_user_level = parseInt(power_levels.users_default || 0);</span>
<a href="#l31.331"></a><span id="l31.331" class="difflineplus">+        user_levels = power_levels.users || {};</span>
<a href="#l31.332"></a><span id="l31.332" class="difflineplus">+</span>
<a href="#l31.333"></a><span id="l31.333" class="difflineplus">+        if (power_levels.state_default !== undefined) {</span>
<a href="#l31.334"></a><span id="l31.334" class="difflineplus">+            state_default = power_levels.state_default;</span>
<a href="#l31.335"></a><span id="l31.335" class="difflineplus">+        } else {</span>
<a href="#l31.336"></a><span id="l31.336" class="difflineplus">+            state_default = 50;</span>
<a href="#l31.337"></a><span id="l31.337" class="difflineplus">+        }</span>
<a href="#l31.338"></a><span id="l31.338" class="difflineplus">+        if (power_levels.events_default !== undefined) {</span>
<a href="#l31.339"></a><span id="l31.339" class="difflineplus">+            events_default = power_levels.events_default;</span>
<a href="#l31.340"></a><span id="l31.340" class="difflineplus">+        }</span>
<a href="#l31.341"></a><span id="l31.341" class="difflineplus">+    }</span>
<a href="#l31.342"></a><span id="l31.342" class="difflineplus">+</span>
<a href="#l31.343"></a><span id="l31.343" class="difflineplus">+    var required_level = state ? state_default : events_default;</span>
<a href="#l31.344"></a><span id="l31.344" class="difflineplus">+    if (events_levels[eventType] !== undefined) {</span>
<a href="#l31.345"></a><span id="l31.345" class="difflineplus">+        required_level = events_levels[eventType];</span>
<a href="#l31.346"></a><span id="l31.346" class="difflineplus">+    }</span>
<a href="#l31.347"></a><span id="l31.347" class="difflineplus">+    return member.powerLevel &gt;= required_level;</span>
<a href="#l31.348"></a><span id="l31.348" class="difflineplus">+};</span>
<a href="#l31.349"></a><span id="l31.349" class="difflineplus">+</span>
<a href="#l31.350"></a><span id="l31.350" class="difflineplus">+/**</span>
<a href="#l31.351"></a><span id="l31.351" class="difflineplus">+ * The RoomState class.</span>
<a href="#l31.352"></a><span id="l31.352" class="difflineplus">+ */</span>
<a href="#l31.353"></a><span id="l31.353" class="difflineplus">+module.exports = RoomState;</span>
<a href="#l31.354"></a><span id="l31.354" class="difflineplus">+</span>
<a href="#l31.355"></a><span id="l31.355" class="difflineplus">+</span>
<a href="#l31.356"></a><span id="l31.356" class="difflineplus">+function _updateThirdPartyTokenCache(roomState, memberEvent) {</span>
<a href="#l31.357"></a><span id="l31.357" class="difflineplus">+    if (!memberEvent.getContent().third_party_invite) {</span>
<a href="#l31.358"></a><span id="l31.358" class="difflineplus">+        return;</span>
<a href="#l31.359"></a><span id="l31.359" class="difflineplus">+    }</span>
<a href="#l31.360"></a><span id="l31.360" class="difflineplus">+    var token = (memberEvent.getContent().third_party_invite.signed || {}).token;</span>
<a href="#l31.361"></a><span id="l31.361" class="difflineplus">+    if (!token) {</span>
<a href="#l31.362"></a><span id="l31.362" class="difflineplus">+        return;</span>
<a href="#l31.363"></a><span id="l31.363" class="difflineplus">+    }</span>
<a href="#l31.364"></a><span id="l31.364" class="difflineplus">+    var threePidInvite = roomState.getStateEvents(</span>
<a href="#l31.365"></a><span id="l31.365" class="difflineplus">+        &quot;m.room.third_party_invite&quot;, token</span>
<a href="#l31.366"></a><span id="l31.366" class="difflineplus">+    );</span>
<a href="#l31.367"></a><span id="l31.367" class="difflineplus">+    if (!threePidInvite) {</span>
<a href="#l31.368"></a><span id="l31.368" class="difflineplus">+        return;</span>
<a href="#l31.369"></a><span id="l31.369" class="difflineplus">+    }</span>
<a href="#l31.370"></a><span id="l31.370" class="difflineplus">+    roomState._tokenToInvite[token] = memberEvent;</span>
<a href="#l31.371"></a><span id="l31.371" class="difflineplus">+}</span>
<a href="#l31.372"></a><span id="l31.372" class="difflineplus">+</span>
<a href="#l31.373"></a><span id="l31.373" class="difflineplus">+function _updateDisplayNameCache(roomState, userId, displayName) {</span>
<a href="#l31.374"></a><span id="l31.374" class="difflineplus">+    var oldName = roomState._userIdsToDisplayNames[userId];</span>
<a href="#l31.375"></a><span id="l31.375" class="difflineplus">+    delete roomState._userIdsToDisplayNames[userId];</span>
<a href="#l31.376"></a><span id="l31.376" class="difflineplus">+    if (oldName) {</span>
<a href="#l31.377"></a><span id="l31.377" class="difflineplus">+        // Remove the old name from the cache.</span>
<a href="#l31.378"></a><span id="l31.378" class="difflineplus">+        // We clobber the user_id &gt; name lookup but the name -&gt; [user_id] lookup</span>
<a href="#l31.379"></a><span id="l31.379" class="difflineplus">+        // means we need to remove that user ID from that array rather than nuking</span>
<a href="#l31.380"></a><span id="l31.380" class="difflineplus">+        // the lot.</span>
<a href="#l31.381"></a><span id="l31.381" class="difflineplus">+        var existingUserIds = roomState._displayNameToUserIds[oldName] || [];</span>
<a href="#l31.382"></a><span id="l31.382" class="difflineplus">+        for (var i = 0; i &lt; existingUserIds.length; i++) {</span>
<a href="#l31.383"></a><span id="l31.383" class="difflineplus">+            if (existingUserIds[i] === userId) {</span>
<a href="#l31.384"></a><span id="l31.384" class="difflineplus">+                // remove this user ID from this array</span>
<a href="#l31.385"></a><span id="l31.385" class="difflineplus">+                existingUserIds.splice(i, 1);</span>
<a href="#l31.386"></a><span id="l31.386" class="difflineplus">+                i--;</span>
<a href="#l31.387"></a><span id="l31.387" class="difflineplus">+            }</span>
<a href="#l31.388"></a><span id="l31.388" class="difflineplus">+        }</span>
<a href="#l31.389"></a><span id="l31.389" class="difflineplus">+        roomState._displayNameToUserIds[oldName] = existingUserIds;</span>
<a href="#l31.390"></a><span id="l31.390" class="difflineplus">+    }</span>
<a href="#l31.391"></a><span id="l31.391" class="difflineplus">+</span>
<a href="#l31.392"></a><span id="l31.392" class="difflineplus">+    roomState._userIdsToDisplayNames[userId] = displayName;</span>
<a href="#l31.393"></a><span id="l31.393" class="difflineplus">+    if (!roomState._displayNameToUserIds[displayName]) {</span>
<a href="#l31.394"></a><span id="l31.394" class="difflineplus">+        roomState._displayNameToUserIds[displayName] = [];</span>
<a href="#l31.395"></a><span id="l31.395" class="difflineplus">+    }</span>
<a href="#l31.396"></a><span id="l31.396" class="difflineplus">+    roomState._displayNameToUserIds[displayName].push(userId);</span>
<a href="#l31.397"></a><span id="l31.397" class="difflineplus">+}</span>
<a href="#l31.398"></a><span id="l31.398" class="difflineplus">+</span>
<a href="#l31.399"></a><span id="l31.399" class="difflineplus">+/**</span>
<a href="#l31.400"></a><span id="l31.400" class="difflineplus">+ * Fires whenever the event dictionary in room state is updated.</span>
<a href="#l31.401"></a><span id="l31.401" class="difflineplus">+ * @event module:client~MatrixClient#&quot;RoomState.events&quot;</span>
<a href="#l31.402"></a><span id="l31.402" class="difflineplus">+ * @param {MatrixEvent} event The matrix event which caused this event to fire.</span>
<a href="#l31.403"></a><span id="l31.403" class="difflineplus">+ * @param {RoomState} state The room state whose RoomState.events dictionary</span>
<a href="#l31.404"></a><span id="l31.404" class="difflineplus">+ * was updated.</span>
<a href="#l31.405"></a><span id="l31.405" class="difflineplus">+ * @example</span>
<a href="#l31.406"></a><span id="l31.406" class="difflineplus">+ * matrixClient.on(&quot;RoomState.events&quot;, function(event, state){</span>
<a href="#l31.407"></a><span id="l31.407" class="difflineplus">+ *   var newStateEvent = event;</span>
<a href="#l31.408"></a><span id="l31.408" class="difflineplus">+ * });</span>
<a href="#l31.409"></a><span id="l31.409" class="difflineplus">+ */</span>
<a href="#l31.410"></a><span id="l31.410" class="difflineplus">+</span>
<a href="#l31.411"></a><span id="l31.411" class="difflineplus">+/**</span>
<a href="#l31.412"></a><span id="l31.412" class="difflineplus">+ * Fires whenever a member in the members dictionary is updated in any way.</span>
<a href="#l31.413"></a><span id="l31.413" class="difflineplus">+ * @event module:client~MatrixClient#&quot;RoomState.members&quot;</span>
<a href="#l31.414"></a><span id="l31.414" class="difflineplus">+ * @param {MatrixEvent} event The matrix event which caused this event to fire.</span>
<a href="#l31.415"></a><span id="l31.415" class="difflineplus">+ * @param {RoomState} state The room state whose RoomState.members dictionary</span>
<a href="#l31.416"></a><span id="l31.416" class="difflineplus">+ * was updated.</span>
<a href="#l31.417"></a><span id="l31.417" class="difflineplus">+ * @param {RoomMember} member The room member that was updated.</span>
<a href="#l31.418"></a><span id="l31.418" class="difflineplus">+ * @example</span>
<a href="#l31.419"></a><span id="l31.419" class="difflineplus">+ * matrixClient.on(&quot;RoomState.members&quot;, function(event, state, member){</span>
<a href="#l31.420"></a><span id="l31.420" class="difflineplus">+ *   var newMembershipState = member.membership;</span>
<a href="#l31.421"></a><span id="l31.421" class="difflineplus">+ * });</span>
<a href="#l31.422"></a><span id="l31.422" class="difflineplus">+ */</span>
<a href="#l31.423"></a><span id="l31.423" class="difflineplus">+</span>
<a href="#l31.424"></a><span id="l31.424" class="difflineplus">+ /**</span>
<a href="#l31.425"></a><span id="l31.425" class="difflineplus">+ * Fires whenever a member is added to the members dictionary. The RoomMember</span>
<a href="#l31.426"></a><span id="l31.426" class="difflineplus">+ * will not be fully populated yet (e.g. no membership state).</span>
<a href="#l31.427"></a><span id="l31.427" class="difflineplus">+ * @event module:client~MatrixClient#&quot;RoomState.newMember&quot;</span>
<a href="#l31.428"></a><span id="l31.428" class="difflineplus">+ * @param {MatrixEvent} event The matrix event which caused this event to fire.</span>
<a href="#l31.429"></a><span id="l31.429" class="difflineplus">+ * @param {RoomState} state The room state whose RoomState.members dictionary</span>
<a href="#l31.430"></a><span id="l31.430" class="difflineplus">+ * was updated with a new entry.</span>
<a href="#l31.431"></a><span id="l31.431" class="difflineplus">+ * @param {RoomMember} member The room member that was added.</span>
<a href="#l31.432"></a><span id="l31.432" class="difflineplus">+ * @example</span>
<a href="#l31.433"></a><span id="l31.433" class="difflineplus">+ * matrixClient.on(&quot;RoomState.newMember&quot;, function(event, state, member){</span>
<a href="#l31.434"></a><span id="l31.434" class="difflineplus">+ *   // add event listeners on 'member'</span>
<a href="#l31.435"></a><span id="l31.435" class="difflineplus">+ * });</span>
<a href="#l31.436"></a><span id="l31.436" class="difflineplus">+ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l32.1"></a><span id="l32.1">new file mode 100644</span>
<a href="#l32.2"></a><span id="l32.2" class="difflineminus">--- /dev/null</span>
<a href="#l32.3"></a><span id="l32.3" class="difflineplus">+++ b/chat/protocols/matrix/matrix-sdk/models/room-summary.js</span>
<a href="#l32.4"></a><span id="l32.4" class="difflineat">@@ -0,0 +1,42 @@</span>
<a href="#l32.5"></a><span id="l32.5" class="difflineplus">+/*</span>
<a href="#l32.6"></a><span id="l32.6" class="difflineplus">+Copyright 2015, 2016 OpenMarket Ltd</span>
<a href="#l32.7"></a><span id="l32.7" class="difflineplus">+</span>
<a href="#l32.8"></a><span id="l32.8" class="difflineplus">+Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<a href="#l32.9"></a><span id="l32.9" class="difflineplus">+you may not use this file except in compliance with the License.</span>
<a href="#l32.10"></a><span id="l32.10" class="difflineplus">+You may obtain a copy of the License at</span>
<a href="#l32.11"></a><span id="l32.11" class="difflineplus">+</span>
<a href="#l32.12"></a><span id="l32.12" class="difflineplus">+    http://www.apache.org/licenses/LICENSE-2.0</span>
<a href="#l32.13"></a><span id="l32.13" class="difflineplus">+</span>
<a href="#l32.14"></a><span id="l32.14" class="difflineplus">+Unless required by applicable law or agreed to in writing, software</span>
<a href="#l32.15"></a><span id="l32.15" class="difflineplus">+distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<a href="#l32.16"></a><span id="l32.16" class="difflineplus">+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<a href="#l32.17"></a><span id="l32.17" class="difflineplus">+See the License for the specific language governing permissions and</span>
<a href="#l32.18"></a><span id="l32.18" class="difflineplus">+limitations under the License.</span>
<a href="#l32.19"></a><span id="l32.19" class="difflineplus">+*/</span>
<a href="#l32.20"></a><span id="l32.20" class="difflineplus">+&quot;use strict&quot;;</span>
<a href="#l32.21"></a><span id="l32.21" class="difflineplus">+/**</span>
<a href="#l32.22"></a><span id="l32.22" class="difflineplus">+ * @module models/room-summary</span>
<a href="#l32.23"></a><span id="l32.23" class="difflineplus">+ */</span>
<a href="#l32.24"></a><span id="l32.24" class="difflineplus">+</span>
<a href="#l32.25"></a><span id="l32.25" class="difflineplus">+/**</span>
<a href="#l32.26"></a><span id="l32.26" class="difflineplus">+ * Construct a new Room Summary. A summary can be used for display on a recent</span>
<a href="#l32.27"></a><span id="l32.27" class="difflineplus">+ * list, without having to load the entire room list into memory.</span>
<a href="#l32.28"></a><span id="l32.28" class="difflineplus">+ * @constructor</span>
<a href="#l32.29"></a><span id="l32.29" class="difflineplus">+ * @param {string} roomId Required. The ID of this room.</span>
<a href="#l32.30"></a><span id="l32.30" class="difflineplus">+ * @param {Object} info Optional. The summary info. Additional keys are supported.</span>
<a href="#l32.31"></a><span id="l32.31" class="difflineplus">+ * @param {string} info.title The title of the room (e.g. &lt;code&gt;m.room.name&lt;/code&gt;)</span>
<a href="#l32.32"></a><span id="l32.32" class="difflineplus">+ * @param {string} info.desc The description of the room (e.g.</span>
<a href="#l32.33"></a><span id="l32.33" class="difflineplus">+ * &lt;code&gt;m.room.topic&lt;/code&gt;)</span>
<a href="#l32.34"></a><span id="l32.34" class="difflineplus">+ * @param {Number} info.numMembers The number of joined users.</span>
<a href="#l32.35"></a><span id="l32.35" class="difflineplus">+ * @param {string[]} info.aliases The list of aliases for this room.</span>
<a href="#l32.36"></a><span id="l32.36" class="difflineplus">+ * @param {Number} info.timestamp The timestamp for this room.</span>
<a href="#l32.37"></a><span id="l32.37" class="difflineplus">+ */</span>
<a href="#l32.38"></a><span id="l32.38" class="difflineplus">+function RoomSummary(roomId, info) {</span>
<a href="#l32.39"></a><span id="l32.39" class="difflineplus">+    this.roomId = roomId;</span>
<a href="#l32.40"></a><span id="l32.40" class="difflineplus">+    this.info = info;</span>
<a href="#l32.41"></a><span id="l32.41" class="difflineplus">+}</span>
<a href="#l32.42"></a><span id="l32.42" class="difflineplus">+</span>
<a href="#l32.43"></a><span id="l32.43" class="difflineplus">+/**</span>
<a href="#l32.44"></a><span id="l32.44" class="difflineplus">+ * The RoomSummary class.</span>
<a href="#l32.45"></a><span id="l32.45" class="difflineplus">+ */</span>
<a href="#l32.46"></a><span id="l32.46" class="difflineplus">+module.exports = RoomSummary;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l33.1"></a><span id="l33.1">new file mode 100644</span>
<a href="#l33.2"></a><span id="l33.2" class="difflineminus">--- /dev/null</span>
<a href="#l33.3"></a><span id="l33.3" class="difflineplus">+++ b/chat/protocols/matrix/matrix-sdk/models/room.js</span>
<a href="#l33.4"></a><span id="l33.4" class="difflineat">@@ -0,0 +1,1355 @@</span>
<a href="#l33.5"></a><span id="l33.5" class="difflineplus">+/*</span>
<a href="#l33.6"></a><span id="l33.6" class="difflineplus">+Copyright 2015, 2016 OpenMarket Ltd</span>
<a href="#l33.7"></a><span id="l33.7" class="difflineplus">+</span>
<a href="#l33.8"></a><span id="l33.8" class="difflineplus">+Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<a href="#l33.9"></a><span id="l33.9" class="difflineplus">+you may not use this file except in compliance with the License.</span>
<a href="#l33.10"></a><span id="l33.10" class="difflineplus">+You may obtain a copy of the License at</span>
<a href="#l33.11"></a><span id="l33.11" class="difflineplus">+</span>
<a href="#l33.12"></a><span id="l33.12" class="difflineplus">+    http://www.apache.org/licenses/LICENSE-2.0</span>
<a href="#l33.13"></a><span id="l33.13" class="difflineplus">+</span>
<a href="#l33.14"></a><span id="l33.14" class="difflineplus">+Unless required by applicable law or agreed to in writing, software</span>
<a href="#l33.15"></a><span id="l33.15" class="difflineplus">+distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<a href="#l33.16"></a><span id="l33.16" class="difflineplus">+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<a href="#l33.17"></a><span id="l33.17" class="difflineplus">+See the License for the specific language governing permissions and</span>
<a href="#l33.18"></a><span id="l33.18" class="difflineplus">+limitations under the License.</span>
<a href="#l33.19"></a><span id="l33.19" class="difflineplus">+*/</span>
<a href="#l33.20"></a><span id="l33.20" class="difflineplus">+&quot;use strict&quot;;</span>
<a href="#l33.21"></a><span id="l33.21" class="difflineplus">+/**</span>
<a href="#l33.22"></a><span id="l33.22" class="difflineplus">+ * @module models/room</span>
<a href="#l33.23"></a><span id="l33.23" class="difflineplus">+ */</span>
<a href="#l33.24"></a><span id="l33.24" class="difflineplus">+var EventEmitter = require(&quot;events&quot;).EventEmitter;</span>
<a href="#l33.25"></a><span id="l33.25" class="difflineplus">+</span>
<a href="#l33.26"></a><span id="l33.26" class="difflineplus">+var EventStatus = require(&quot;./event&quot;).EventStatus;</span>
<a href="#l33.27"></a><span id="l33.27" class="difflineplus">+var RoomSummary = require(&quot;./room-summary&quot;);</span>
<a href="#l33.28"></a><span id="l33.28" class="difflineplus">+var MatrixEvent = require(&quot;./event&quot;).MatrixEvent;</span>
<a href="#l33.29"></a><span id="l33.29" class="difflineplus">+var utils = require(&quot;../utils&quot;);</span>
<a href="#l33.30"></a><span id="l33.30" class="difflineplus">+var ContentRepo = require(&quot;../content-repo&quot;);</span>
<a href="#l33.31"></a><span id="l33.31" class="difflineplus">+var EventTimeline = require(&quot;./event-timeline&quot;);</span>
<a href="#l33.32"></a><span id="l33.32" class="difflineplus">+var EventTimelineSet = require(&quot;./event-timeline-set&quot;);</span>
<a href="#l33.33"></a><span id="l33.33" class="difflineplus">+</span>
<a href="#l33.34"></a><span id="l33.34" class="difflineplus">+</span>
<a href="#l33.35"></a><span id="l33.35" class="difflineplus">+function synthesizeReceipt(userId, event, receiptType) {</span>
<a href="#l33.36"></a><span id="l33.36" class="difflineplus">+    // console.log(&quot;synthesizing receipt for &quot;+event.getId());</span>
<a href="#l33.37"></a><span id="l33.37" class="difflineplus">+    // This is really ugly because JS has no way to express an object literal</span>
<a href="#l33.38"></a><span id="l33.38" class="difflineplus">+    // where the name of a key comes from an expression</span>
<a href="#l33.39"></a><span id="l33.39" class="difflineplus">+    var fakeReceipt = {</span>
<a href="#l33.40"></a><span id="l33.40" class="difflineplus">+        content: {},</span>
<a href="#l33.41"></a><span id="l33.41" class="difflineplus">+        type: &quot;m.receipt&quot;,</span>
<a href="#l33.42"></a><span id="l33.42" class="difflineplus">+        room_id: event.getRoomId()</span>
<a href="#l33.43"></a><span id="l33.43" class="difflineplus">+    };</span>
<a href="#l33.44"></a><span id="l33.44" class="difflineplus">+    fakeReceipt.content[event.getId()] = {};</span>
<a href="#l33.45"></a><span id="l33.45" class="difflineplus">+    fakeReceipt.content[event.getId()][receiptType] = {};</span>
<a href="#l33.46"></a><span id="l33.46" class="difflineplus">+    fakeReceipt.content[event.getId()][receiptType][userId] = {</span>
<a href="#l33.47"></a><span id="l33.47" class="difflineplus">+        ts: event.getTs()</span>
<a href="#l33.48"></a><span id="l33.48" class="difflineplus">+    };</span>
<a href="#l33.49"></a><span id="l33.49" class="difflineplus">+    return new MatrixEvent(fakeReceipt);</span>
<a href="#l33.50"></a><span id="l33.50" class="difflineplus">+}</span>
<a href="#l33.51"></a><span id="l33.51" class="difflineplus">+</span>
<a href="#l33.52"></a><span id="l33.52" class="difflineplus">+</span>
<a href="#l33.53"></a><span id="l33.53" class="difflineplus">+/**</span>
<a href="#l33.54"></a><span id="l33.54" class="difflineplus">+ * Construct a new Room.</span>
<a href="#l33.55"></a><span id="l33.55" class="difflineplus">+ *</span>
<a href="#l33.56"></a><span id="l33.56" class="difflineplus">+ * &lt;p&gt;For a room, we store an ordered sequence of timelines, which may or may not</span>
<a href="#l33.57"></a><span id="l33.57" class="difflineplus">+ * be continuous. Each timeline lists a series of events, as well as tracking</span>
<a href="#l33.58"></a><span id="l33.58" class="difflineplus">+ * the room state at the start and the end of the timeline. It also tracks</span>
<a href="#l33.59"></a><span id="l33.59" class="difflineplus">+ * forward and backward pagination tokens, as well as containing links to the</span>
<a href="#l33.60"></a><span id="l33.60" class="difflineplus">+ * next timeline in the sequence.</span>
<a href="#l33.61"></a><span id="l33.61" class="difflineplus">+ *</span>
<a href="#l33.62"></a><span id="l33.62" class="difflineplus">+ * &lt;p&gt;There is one special timeline - the 'live' timeline, which represents the</span>
<a href="#l33.63"></a><span id="l33.63" class="difflineplus">+ * timeline to which events are being added in real-time as they are received</span>
<a href="#l33.64"></a><span id="l33.64" class="difflineplus">+ * from the /sync API. Note that you should not retain references to this</span>
<a href="#l33.65"></a><span id="l33.65" class="difflineplus">+ * timeline - even if it is the current timeline right now, it may not remain</span>
<a href="#l33.66"></a><span id="l33.66" class="difflineplus">+ * so if the server gives us a timeline gap in /sync.</span>
<a href="#l33.67"></a><span id="l33.67" class="difflineplus">+ *</span>
<a href="#l33.68"></a><span id="l33.68" class="difflineplus">+ * &lt;p&gt;In order that we can find events from their ids later, we also maintain a</span>
<a href="#l33.69"></a><span id="l33.69" class="difflineplus">+ * map from event_id to timeline and index.</span>
<a href="#l33.70"></a><span id="l33.70" class="difflineplus">+ *</span>
<a href="#l33.71"></a><span id="l33.71" class="difflineplus">+ * @constructor</span>
<a href="#l33.72"></a><span id="l33.72" class="difflineplus">+ * @alias module:models/room</span>
<a href="#l33.73"></a><span id="l33.73" class="difflineplus">+ * @param {string} roomId Required. The ID of this room.</span>
<a href="#l33.74"></a><span id="l33.74" class="difflineplus">+ * @param {Object=} opts Configuration options</span>
<a href="#l33.75"></a><span id="l33.75" class="difflineplus">+ * @param {*} opts.storageToken Optional. The token which a data store can use</span>
<a href="#l33.76"></a><span id="l33.76" class="difflineplus">+ * to remember the state of the room. What this means is dependent on the store</span>
<a href="#l33.77"></a><span id="l33.77" class="difflineplus">+ * implementation.</span>
<a href="#l33.78"></a><span id="l33.78" class="difflineplus">+ *</span>
<a href="#l33.79"></a><span id="l33.79" class="difflineplus">+ * @param {String=} opts.pendingEventOrdering Controls where pending messages</span>
<a href="#l33.80"></a><span id="l33.80" class="difflineplus">+ * appear in a room's timeline. If &quot;&lt;b&gt;chronological&lt;/b&gt;&quot;, messages will appear</span>
<a href="#l33.81"></a><span id="l33.81" class="difflineplus">+ * in the timeline when the call to &lt;code&gt;sendEvent&lt;/code&gt; was made. If</span>
<a href="#l33.82"></a><span id="l33.82" class="difflineplus">+ * &quot;&lt;b&gt;detached&lt;/b&gt;&quot;, pending messages will appear in a separate list,</span>
<a href="#l33.83"></a><span id="l33.83" class="difflineplus">+ * accessbile via {@link module:models/room#getPendingEvents}. Default:</span>
<a href="#l33.84"></a><span id="l33.84" class="difflineplus">+ * &quot;chronological&quot;.</span>
<a href="#l33.85"></a><span id="l33.85" class="difflineplus">+ *</span>
<a href="#l33.86"></a><span id="l33.86" class="difflineplus">+ * @param {boolean} [opts.timelineSupport = false] Set to true to enable improved</span>
<a href="#l33.87"></a><span id="l33.87" class="difflineplus">+ * timeline support.</span>
<a href="#l33.88"></a><span id="l33.88" class="difflineplus">+ *</span>
<a href="#l33.89"></a><span id="l33.89" class="difflineplus">+ * @prop {string} roomId The ID of this room.</span>
<a href="#l33.90"></a><span id="l33.90" class="difflineplus">+ * @prop {string} name The human-readable display name for this room.</span>
<a href="#l33.91"></a><span id="l33.91" class="difflineplus">+ * @prop {Array&lt;MatrixEvent&gt;} timeline The live event timeline for this room,</span>
<a href="#l33.92"></a><span id="l33.92" class="difflineplus">+ * with the oldest event at index 0. Present for backwards compatibility -</span>
<a href="#l33.93"></a><span id="l33.93" class="difflineplus">+ * prefer getLiveTimeline().getEvents().</span>
<a href="#l33.94"></a><span id="l33.94" class="difflineplus">+ * @prop {object} tags Dict of room tags; the keys are the tag name and the values</span>
<a href="#l33.95"></a><span id="l33.95" class="difflineplus">+ * are any metadata associated with the tag - e.g. { &quot;fav&quot; : { order: 1 } }</span>
<a href="#l33.96"></a><span id="l33.96" class="difflineplus">+ * @prop {object} accountData Dict of per-room account_data events; the keys are the</span>
<a href="#l33.97"></a><span id="l33.97" class="difflineplus">+ * event type and the values are the events.</span>
<a href="#l33.98"></a><span id="l33.98" class="difflineplus">+ * @prop {RoomState} oldState The state of the room at the time of the oldest</span>
<a href="#l33.99"></a><span id="l33.99" class="difflineplus">+ * event in the live timeline. Present for backwards compatibility -</span>
<a href="#l33.100"></a><span id="l33.100" class="difflineplus">+ * prefer getLiveTimeline().getState(true).</span>
<a href="#l33.101"></a><span id="l33.101" class="difflineplus">+ * @prop {RoomState} currentState The state of the room at the time of the</span>
<a href="#l33.102"></a><span id="l33.102" class="difflineplus">+ * newest event in the timeline. Present for backwards compatibility -</span>
<a href="#l33.103"></a><span id="l33.103" class="difflineplus">+ * prefer getLiveTimeline().getState(false).</span>
<a href="#l33.104"></a><span id="l33.104" class="difflineplus">+ * @prop {RoomSummary} summary The room summary.</span>
<a href="#l33.105"></a><span id="l33.105" class="difflineplus">+ * @prop {*} storageToken A token which a data store can use to remember</span>
<a href="#l33.106"></a><span id="l33.106" class="difflineplus">+ * the state of the room.</span>
<a href="#l33.107"></a><span id="l33.107" class="difflineplus">+ */</span>
<a href="#l33.108"></a><span id="l33.108" class="difflineplus">+function Room(roomId, opts) {</span>
<a href="#l33.109"></a><span id="l33.109" class="difflineplus">+    opts = opts || {};</span>
<a href="#l33.110"></a><span id="l33.110" class="difflineplus">+    opts.pendingEventOrdering = opts.pendingEventOrdering || &quot;chronological&quot;;</span>
<a href="#l33.111"></a><span id="l33.111" class="difflineplus">+</span>
<a href="#l33.112"></a><span id="l33.112" class="difflineplus">+    if ([&quot;chronological&quot;, &quot;detached&quot;].indexOf(opts.pendingEventOrdering) === -1) {</span>
<a href="#l33.113"></a><span id="l33.113" class="difflineplus">+        throw new Error(</span>
<a href="#l33.114"></a><span id="l33.114" class="difflineplus">+            &quot;opts.pendingEventOrdering MUST be either 'chronological' or &quot; +</span>
<a href="#l33.115"></a><span id="l33.115" class="difflineplus">+            &quot;'detached'. Got: '&quot; + opts.pendingEventOrdering + &quot;'&quot;</span>
<a href="#l33.116"></a><span id="l33.116" class="difflineplus">+        );</span>
<a href="#l33.117"></a><span id="l33.117" class="difflineplus">+    }</span>
<a href="#l33.118"></a><span id="l33.118" class="difflineplus">+</span>
<a href="#l33.119"></a><span id="l33.119" class="difflineplus">+    this.roomId = roomId;</span>
<a href="#l33.120"></a><span id="l33.120" class="difflineplus">+    this.name = roomId;</span>
<a href="#l33.121"></a><span id="l33.121" class="difflineplus">+    this.tags = {</span>
<a href="#l33.122"></a><span id="l33.122" class="difflineplus">+        // $tagName: { $metadata: $value },</span>
<a href="#l33.123"></a><span id="l33.123" class="difflineplus">+        // $tagName: { $metadata: $value },</span>
<a href="#l33.124"></a><span id="l33.124" class="difflineplus">+    };</span>
<a href="#l33.125"></a><span id="l33.125" class="difflineplus">+    this.accountData = {</span>
<a href="#l33.126"></a><span id="l33.126" class="difflineplus">+        // $eventType: $event</span>
<a href="#l33.127"></a><span id="l33.127" class="difflineplus">+    };</span>
<a href="#l33.128"></a><span id="l33.128" class="difflineplus">+    this.summary = null;</span>
<a href="#l33.129"></a><span id="l33.129" class="difflineplus">+    this.storageToken = opts.storageToken;</span>
<a href="#l33.130"></a><span id="l33.130" class="difflineplus">+    this._opts = opts;</span>
<a href="#l33.131"></a><span id="l33.131" class="difflineplus">+    this._txnToEvent = {}; // Pending in-flight requests { string: MatrixEvent }</span>
<a href="#l33.132"></a><span id="l33.132" class="difflineplus">+    // receipts should clobber based on receipt_type and user_id pairs hence</span>
<a href="#l33.133"></a><span id="l33.133" class="difflineplus">+    // the form of this structure. This is sub-optimal for the exposed APIs</span>
<a href="#l33.134"></a><span id="l33.134" class="difflineplus">+    // which pass in an event ID and get back some receipts, so we also store</span>
<a href="#l33.135"></a><span id="l33.135" class="difflineplus">+    // a pre-cached list for this purpose.</span>
<a href="#l33.136"></a><span id="l33.136" class="difflineplus">+    this._receipts = {</span>
<a href="#l33.137"></a><span id="l33.137" class="difflineplus">+        // receipt_type: {</span>
<a href="#l33.138"></a><span id="l33.138" class="difflineplus">+        //   user_id: {</span>
<a href="#l33.139"></a><span id="l33.139" class="difflineplus">+        //     eventId: &lt;event_id&gt;,</span>
<a href="#l33.140"></a><span id="l33.140" class="difflineplus">+        //     data: &lt;receipt_data&gt;</span>
<a href="#l33.141"></a><span id="l33.141" class="difflineplus">+        //   }</span>
<a href="#l33.142"></a><span id="l33.142" class="difflineplus">+        // }</span>
<a href="#l33.143"></a><span id="l33.143" class="difflineplus">+    };</span>
<a href="#l33.144"></a><span id="l33.144" class="difflineplus">+    this._receiptCacheByEventId = {</span>
<a href="#l33.145"></a><span id="l33.145" class="difflineplus">+        // $event_id: [{</span>
<a href="#l33.146"></a><span id="l33.146" class="difflineplus">+        //   type: $type,</span>
<a href="#l33.147"></a><span id="l33.147" class="difflineplus">+        //   userId: $user_id,</span>
<a href="#l33.148"></a><span id="l33.148" class="difflineplus">+        //   data: &lt;receipt data&gt;</span>
<a href="#l33.149"></a><span id="l33.149" class="difflineplus">+        // }]</span>
<a href="#l33.150"></a><span id="l33.150" class="difflineplus">+    };</span>
<a href="#l33.151"></a><span id="l33.151" class="difflineplus">+    // only receipts that came from the server, not synthesized ones</span>
<a href="#l33.152"></a><span id="l33.152" class="difflineplus">+    this._realReceipts = {};</span>
<a href="#l33.153"></a><span id="l33.153" class="difflineplus">+</span>
<a href="#l33.154"></a><span id="l33.154" class="difflineplus">+    this._notificationCounts = {};</span>
<a href="#l33.155"></a><span id="l33.155" class="difflineplus">+</span>
<a href="#l33.156"></a><span id="l33.156" class="difflineplus">+    // all our per-room timeline sets. the first one is the unfiltered ones;</span>
<a href="#l33.157"></a><span id="l33.157" class="difflineplus">+    // the subsequent ones are the filtered ones in no particular order.</span>
<a href="#l33.158"></a><span id="l33.158" class="difflineplus">+    this._timelineSets = [new EventTimelineSet(this, opts)];</span>
<a href="#l33.159"></a><span id="l33.159" class="difflineplus">+    reEmit(this, this.getUnfilteredTimelineSet(),</span>
<a href="#l33.160"></a><span id="l33.160" class="difflineplus">+           [&quot;Room.timeline&quot;, &quot;Room.timelineReset&quot;]);</span>
<a href="#l33.161"></a><span id="l33.161" class="difflineplus">+</span>
<a href="#l33.162"></a><span id="l33.162" class="difflineplus">+    this._fixUpLegacyTimelineFields();</span>
<a href="#l33.163"></a><span id="l33.163" class="difflineplus">+</span>
<a href="#l33.164"></a><span id="l33.164" class="difflineplus">+    // any filtered timeline sets we're maintaining for this room</span>
<a href="#l33.165"></a><span id="l33.165" class="difflineplus">+    this._filteredTimelineSets = {</span>
<a href="#l33.166"></a><span id="l33.166" class="difflineplus">+        // filter_id: timelineSet</span>
<a href="#l33.167"></a><span id="l33.167" class="difflineplus">+    };</span>
<a href="#l33.168"></a><span id="l33.168" class="difflineplus">+</span>
<a href="#l33.169"></a><span id="l33.169" class="difflineplus">+    if (this._opts.pendingEventOrdering == &quot;detached&quot;) {</span>
<a href="#l33.170"></a><span id="l33.170" class="difflineplus">+        this._pendingEventList = [];</span>
<a href="#l33.171"></a><span id="l33.171" class="difflineplus">+    }</span>
<a href="#l33.172"></a><span id="l33.172" class="difflineplus">+}</span>
<a href="#l33.173"></a><span id="l33.173" class="difflineplus">+utils.inherits(Room, EventEmitter);</span>
<a href="#l33.174"></a><span id="l33.174" class="difflineplus">+</span>
<a href="#l33.175"></a><span id="l33.175" class="difflineplus">+/**</span>
<a href="#l33.176"></a><span id="l33.176" class="difflineplus">+ * Get the list of pending sent events for this room</span>
<a href="#l33.177"></a><span id="l33.177" class="difflineplus">+ *</span>
<a href="#l33.178"></a><span id="l33.178" class="difflineplus">+ * @return {module:models/event.MatrixEvent[]} A list of the sent events</span>
<a href="#l33.179"></a><span id="l33.179" class="difflineplus">+ * waiting for remote echo.</span>
<a href="#l33.180"></a><span id="l33.180" class="difflineplus">+ *</span>
<a href="#l33.181"></a><span id="l33.181" class="difflineplus">+ * @throws If &lt;code&gt;opts.pendingEventOrdering&lt;/code&gt; was not 'detached'</span>
<a href="#l33.182"></a><span id="l33.182" class="difflineplus">+ */</span>
<a href="#l33.183"></a><span id="l33.183" class="difflineplus">+Room.prototype.getPendingEvents = function() {</span>
<a href="#l33.184"></a><span id="l33.184" class="difflineplus">+    if (this._opts.pendingEventOrdering !== &quot;detached&quot;) {</span>
<a href="#l33.185"></a><span id="l33.185" class="difflineplus">+        throw new Error(</span>
<a href="#l33.186"></a><span id="l33.186" class="difflineplus">+            &quot;Cannot call getPendingEventList with pendingEventOrdering == &quot; +</span>
<a href="#l33.187"></a><span id="l33.187" class="difflineplus">+                this._opts.pendingEventOrdering);</span>
<a href="#l33.188"></a><span id="l33.188" class="difflineplus">+    }</span>
<a href="#l33.189"></a><span id="l33.189" class="difflineplus">+</span>
<a href="#l33.190"></a><span id="l33.190" class="difflineplus">+    return this._pendingEventList;</span>
<a href="#l33.191"></a><span id="l33.191" class="difflineplus">+};</span>
<a href="#l33.192"></a><span id="l33.192" class="difflineplus">+</span>
<a href="#l33.193"></a><span id="l33.193" class="difflineplus">+/**</span>
<a href="#l33.194"></a><span id="l33.194" class="difflineplus">+ * Get the live unfiltered timeline for this room.</span>
<a href="#l33.195"></a><span id="l33.195" class="difflineplus">+ *</span>
<a href="#l33.196"></a><span id="l33.196" class="difflineplus">+ * @return {module:models/event-timeline~EventTimeline} live timeline</span>
<a href="#l33.197"></a><span id="l33.197" class="difflineplus">+ */</span>
<a href="#l33.198"></a><span id="l33.198" class="difflineplus">+Room.prototype.getLiveTimeline = function() {</span>
<a href="#l33.199"></a><span id="l33.199" class="difflineplus">+    return this.getUnfilteredTimelineSet().getLiveTimeline();</span>
<a href="#l33.200"></a><span id="l33.200" class="difflineplus">+};</span>
<a href="#l33.201"></a><span id="l33.201" class="difflineplus">+</span>
<a href="#l33.202"></a><span id="l33.202" class="difflineplus">+</span>
<a href="#l33.203"></a><span id="l33.203" class="difflineplus">+/**</span>
<a href="#l33.204"></a><span id="l33.204" class="difflineplus">+ * Reset the live timeline of all timelineSets, and start new ones.</span>
<a href="#l33.205"></a><span id="l33.205" class="difflineplus">+ *</span>
<a href="#l33.206"></a><span id="l33.206" class="difflineplus">+ * &lt;p&gt;This is used when /sync returns a 'limited' timeline.</span>
<a href="#l33.207"></a><span id="l33.207" class="difflineplus">+ *</span>
<a href="#l33.208"></a><span id="l33.208" class="difflineplus">+ * @param {string=} backPaginationToken   token for back-paginating the new timeline</span>
<a href="#l33.209"></a><span id="l33.209" class="difflineplus">+ */</span>
<a href="#l33.210"></a><span id="l33.210" class="difflineplus">+Room.prototype.resetLiveTimeline = function(backPaginationToken) {</span>
<a href="#l33.211"></a><span id="l33.211" class="difflineplus">+    for (var i = 0; i &lt; this._timelineSets.length; i++) {</span>
<a href="#l33.212"></a><span id="l33.212" class="difflineplus">+        this._timelineSets[i].resetLiveTimeline(backPaginationToken);</span>
<a href="#l33.213"></a><span id="l33.213" class="difflineplus">+    }</span>
<a href="#l33.214"></a><span id="l33.214" class="difflineplus">+</span>
<a href="#l33.215"></a><span id="l33.215" class="difflineplus">+    this._fixUpLegacyTimelineFields();</span>
<a href="#l33.216"></a><span id="l33.216" class="difflineplus">+};</span>
<a href="#l33.217"></a><span id="l33.217" class="difflineplus">+</span>
<a href="#l33.218"></a><span id="l33.218" class="difflineplus">+/**</span>
<a href="#l33.219"></a><span id="l33.219" class="difflineplus">+ * Fix up this.timeline, this.oldState and this.currentState</span>
<a href="#l33.220"></a><span id="l33.220" class="difflineplus">+ *</span>
<a href="#l33.221"></a><span id="l33.221" class="difflineplus">+ * @private</span>
<a href="#l33.222"></a><span id="l33.222" class="difflineplus">+ */</span>
<a href="#l33.223"></a><span id="l33.223" class="difflineplus">+Room.prototype._fixUpLegacyTimelineFields = function() {</span>
<a href="#l33.224"></a><span id="l33.224" class="difflineplus">+    // maintain this.timeline as a reference to the live timeline,</span>
<a href="#l33.225"></a><span id="l33.225" class="difflineplus">+    // and this.oldState and this.currentState as references to the</span>
<a href="#l33.226"></a><span id="l33.226" class="difflineplus">+    // state at the start and end of that timeline. These are more</span>
<a href="#l33.227"></a><span id="l33.227" class="difflineplus">+    // for backwards-compatibility than anything else.</span>
<a href="#l33.228"></a><span id="l33.228" class="difflineplus">+    this.timeline = this.getLiveTimeline().getEvents();</span>
<a href="#l33.229"></a><span id="l33.229" class="difflineplus">+    this.oldState = this.getLiveTimeline()</span>
<a href="#l33.230"></a><span id="l33.230" class="difflineplus">+                        .getState(EventTimeline.BACKWARDS);</span>
<a href="#l33.231"></a><span id="l33.231" class="difflineplus">+    this.currentState = this.getLiveTimeline()</span>
<a href="#l33.232"></a><span id="l33.232" class="difflineplus">+                            .getState(EventTimeline.FORWARDS);</span>
<a href="#l33.233"></a><span id="l33.233" class="difflineplus">+};</span>
<a href="#l33.234"></a><span id="l33.234" class="difflineplus">+</span>
<a href="#l33.235"></a><span id="l33.235" class="difflineplus">+/**</span>
<a href="#l33.236"></a><span id="l33.236" class="difflineplus">+ * Return the timeline sets for this room.</span>
<a href="#l33.237"></a><span id="l33.237" class="difflineplus">+ * @return {EventTimelineSet[]} array of timeline sets for this room</span>
<a href="#l33.238"></a><span id="l33.238" class="difflineplus">+ */</span>
<a href="#l33.239"></a><span id="l33.239" class="difflineplus">+Room.prototype.getTimelineSets = function() {</span>
<a href="#l33.240"></a><span id="l33.240" class="difflineplus">+    return this._timelineSets;</span>
<a href="#l33.241"></a><span id="l33.241" class="difflineplus">+};</span>
<a href="#l33.242"></a><span id="l33.242" class="difflineplus">+</span>
<a href="#l33.243"></a><span id="l33.243" class="difflineplus">+/**</span>
<a href="#l33.244"></a><span id="l33.244" class="difflineplus">+ * Helper to return the main unfiltered timeline set for this room</span>
<a href="#l33.245"></a><span id="l33.245" class="difflineplus">+ * @return {EventTimelineSet} room's unfiltered timeline set</span>
<a href="#l33.246"></a><span id="l33.246" class="difflineplus">+ */</span>
<a href="#l33.247"></a><span id="l33.247" class="difflineplus">+Room.prototype.getUnfilteredTimelineSet = function() {</span>
<a href="#l33.248"></a><span id="l33.248" class="difflineplus">+    return this._timelineSets[0];</span>
<a href="#l33.249"></a><span id="l33.249" class="difflineplus">+};</span>
<a href="#l33.250"></a><span id="l33.250" class="difflineplus">+</span>
<a href="#l33.251"></a><span id="l33.251" class="difflineplus">+/**</span>
<a href="#l33.252"></a><span id="l33.252" class="difflineplus">+ * Get the timeline which contains the given event from the unfiltered set, if any</span>
<a href="#l33.253"></a><span id="l33.253" class="difflineplus">+ *</span>
<a href="#l33.254"></a><span id="l33.254" class="difflineplus">+ * @param {string} eventId  event ID to look for</span>
<a href="#l33.255"></a><span id="l33.255" class="difflineplus">+ * @return {?module:models/event-timeline~EventTimeline} timeline containing</span>
<a href="#l33.256"></a><span id="l33.256" class="difflineplus">+ * the given event, or null if unknown</span>
<a href="#l33.257"></a><span id="l33.257" class="difflineplus">+ */</span>
<a href="#l33.258"></a><span id="l33.258" class="difflineplus">+Room.prototype.getTimelineForEvent = function(eventId) {</span>
<a href="#l33.259"></a><span id="l33.259" class="difflineplus">+    return this.getUnfilteredTimelineSet().getTimelineForEvent(eventId);</span>
<a href="#l33.260"></a><span id="l33.260" class="difflineplus">+};</span>
<a href="#l33.261"></a><span id="l33.261" class="difflineplus">+</span>
<a href="#l33.262"></a><span id="l33.262" class="difflineplus">+/**</span>
<a href="#l33.263"></a><span id="l33.263" class="difflineplus">+ * Add a new timeline to this room's unfiltered timeline set</span>
<a href="#l33.264"></a><span id="l33.264" class="difflineplus">+ *</span>
<a href="#l33.265"></a><span id="l33.265" class="difflineplus">+ * @return {module:models/event-timeline~EventTimeline} newly-created timeline</span>
<a href="#l33.266"></a><span id="l33.266" class="difflineplus">+ */</span>
<a href="#l33.267"></a><span id="l33.267" class="difflineplus">+Room.prototype.addTimeline = function() {</span>
<a href="#l33.268"></a><span id="l33.268" class="difflineplus">+    return this.getUnfilteredTimelineSet().addTimeline();</span>
<a href="#l33.269"></a><span id="l33.269" class="difflineplus">+};</span>
<a href="#l33.270"></a><span id="l33.270" class="difflineplus">+</span>
<a href="#l33.271"></a><span id="l33.271" class="difflineplus">+/**</span>
<a href="#l33.272"></a><span id="l33.272" class="difflineplus">+ * Get an event which is stored in our unfiltered timeline set</span>
<a href="#l33.273"></a><span id="l33.273" class="difflineplus">+ *</span>
<a href="#l33.274"></a><span id="l33.274" class="difflineplus">+ * @param {string} eventId  event ID to look for</span>
<a href="#l33.275"></a><span id="l33.275" class="difflineplus">+ * @return {?module:models/event.MatrixEvent} the given event, or undefined if unknown</span>
<a href="#l33.276"></a><span id="l33.276" class="difflineplus">+ */</span>
<a href="#l33.277"></a><span id="l33.277" class="difflineplus">+Room.prototype.findEventById = function(eventId) {</span>
<a href="#l33.278"></a><span id="l33.278" class="difflineplus">+    return this.getUnfilteredTimelineSet().findEventById(eventId);</span>
<a href="#l33.279"></a><span id="l33.279" class="difflineplus">+};</span>
<a href="#l33.280"></a><span id="l33.280" class="difflineplus">+</span>
<a href="#l33.281"></a><span id="l33.281" class="difflineplus">+/**</span>
<a href="#l33.282"></a><span id="l33.282" class="difflineplus">+ * Get one of the notification counts for this room</span>
<a href="#l33.283"></a><span id="l33.283" class="difflineplus">+ * @param {String} type The type of notification count to get. default: 'total'</span>
<a href="#l33.284"></a><span id="l33.284" class="difflineplus">+ * @return {Number} The notification count, or undefined if there is no count</span>
<a href="#l33.285"></a><span id="l33.285" class="difflineplus">+ *                  for this type.</span>
<a href="#l33.286"></a><span id="l33.286" class="difflineplus">+ */</span>
<a href="#l33.287"></a><span id="l33.287" class="difflineplus">+Room.prototype.getUnreadNotificationCount = function(type) {</span>
<a href="#l33.288"></a><span id="l33.288" class="difflineplus">+    type = type || 'total';</span>
<a href="#l33.289"></a><span id="l33.289" class="difflineplus">+    return this._notificationCounts[type];</span>
<a href="#l33.290"></a><span id="l33.290" class="difflineplus">+};</span>
<a href="#l33.291"></a><span id="l33.291" class="difflineplus">+</span>
<a href="#l33.292"></a><span id="l33.292" class="difflineplus">+/**</span>
<a href="#l33.293"></a><span id="l33.293" class="difflineplus">+ * Set one of the notification counts for this room</span>
<a href="#l33.294"></a><span id="l33.294" class="difflineplus">+ * @param {String} type The type of notification count to set.</span>
<a href="#l33.295"></a><span id="l33.295" class="difflineplus">+ * @param {Number} count The new count</span>
<a href="#l33.296"></a><span id="l33.296" class="difflineplus">+ */</span>
<a href="#l33.297"></a><span id="l33.297" class="difflineplus">+Room.prototype.setUnreadNotificationCount = function(type, count) {</span>
<a href="#l33.298"></a><span id="l33.298" class="difflineplus">+    this._notificationCounts[type] = count;</span>
<a href="#l33.299"></a><span id="l33.299" class="difflineplus">+};</span>
<a href="#l33.300"></a><span id="l33.300" class="difflineplus">+</span>
<a href="#l33.301"></a><span id="l33.301" class="difflineplus">+/**</span>
<a href="#l33.302"></a><span id="l33.302" class="difflineplus">+ * Get the avatar URL for a room if one was set.</span>
<a href="#l33.303"></a><span id="l33.303" class="difflineplus">+ * @param {String} baseUrl The homeserver base URL. See</span>
<a href="#l33.304"></a><span id="l33.304" class="difflineplus">+ * {@link module:client~MatrixClient#getHomeserverUrl}.</span>
<a href="#l33.305"></a><span id="l33.305" class="difflineplus">+ * @param {Number} width The desired width of the thumbnail.</span>
<a href="#l33.306"></a><span id="l33.306" class="difflineplus">+ * @param {Number} height The desired height of the thumbnail.</span>
<a href="#l33.307"></a><span id="l33.307" class="difflineplus">+ * @param {string} resizeMethod The thumbnail resize method to use, either</span>
<a href="#l33.308"></a><span id="l33.308" class="difflineplus">+ * &quot;crop&quot; or &quot;scale&quot;.</span>
<a href="#l33.309"></a><span id="l33.309" class="difflineplus">+ * @param {boolean} allowDefault True to allow an identicon for this room if an</span>
<a href="#l33.310"></a><span id="l33.310" class="difflineplus">+ * avatar URL wasn't explicitly set. Default: true.</span>
<a href="#l33.311"></a><span id="l33.311" class="difflineplus">+ * @return {?string} the avatar URL or null.</span>
<a href="#l33.312"></a><span id="l33.312" class="difflineplus">+ */</span>
<a href="#l33.313"></a><span id="l33.313" class="difflineplus">+Room.prototype.getAvatarUrl = function(baseUrl, width, height, resizeMethod,</span>
<a href="#l33.314"></a><span id="l33.314" class="difflineplus">+                                       allowDefault) {</span>
<a href="#l33.315"></a><span id="l33.315" class="difflineplus">+    var roomAvatarEvent = this.currentState.getStateEvents(&quot;m.room.avatar&quot;, &quot;&quot;);</span>
<a href="#l33.316"></a><span id="l33.316" class="difflineplus">+    if (allowDefault === undefined) { allowDefault = true; }</span>
<a href="#l33.317"></a><span id="l33.317" class="difflineplus">+    if (!roomAvatarEvent &amp;&amp; !allowDefault) {</span>
<a href="#l33.318"></a><span id="l33.318" class="difflineplus">+        return null;</span>
<a href="#l33.319"></a><span id="l33.319" class="difflineplus">+    }</span>
<a href="#l33.320"></a><span id="l33.320" class="difflineplus">+</span>
<a href="#l33.321"></a><span id="l33.321" class="difflineplus">+    var mainUrl = roomAvatarEvent ? roomAvatarEvent.getContent().url : null;</span>
<a href="#l33.322"></a><span id="l33.322" class="difflineplus">+    if (mainUrl) {</span>
<a href="#l33.323"></a><span id="l33.323" class="difflineplus">+        return ContentRepo.getHttpUriForMxc(</span>
<a href="#l33.324"></a><span id="l33.324" class="difflineplus">+            baseUrl, mainUrl, width, height, resizeMethod</span>
<a href="#l33.325"></a><span id="l33.325" class="difflineplus">+        );</span>
<a href="#l33.326"></a><span id="l33.326" class="difflineplus">+    }</span>
<a href="#l33.327"></a><span id="l33.327" class="difflineplus">+    else if (allowDefault) {</span>
<a href="#l33.328"></a><span id="l33.328" class="difflineplus">+        return ContentRepo.getIdenticonUri(</span>
<a href="#l33.329"></a><span id="l33.329" class="difflineplus">+            baseUrl, this.roomId, width, height</span>
<a href="#l33.330"></a><span id="l33.330" class="difflineplus">+        );</span>
<a href="#l33.331"></a><span id="l33.331" class="difflineplus">+    }</span>
<a href="#l33.332"></a><span id="l33.332" class="difflineplus">+</span>
<a href="#l33.333"></a><span id="l33.333" class="difflineplus">+    return null;</span>
<a href="#l33.334"></a><span id="l33.334" class="difflineplus">+};</span>
<a href="#l33.335"></a><span id="l33.335" class="difflineplus">+</span>
<a href="#l33.336"></a><span id="l33.336" class="difflineplus">+/**</span>
<a href="#l33.337"></a><span id="l33.337" class="difflineplus">+ * Get the aliases this room has according to the room's state</span>
<a href="#l33.338"></a><span id="l33.338" class="difflineplus">+ * The aliases returned by this function may not necessarily</span>
<a href="#l33.339"></a><span id="l33.339" class="difflineplus">+ * still point to this room.</span>
<a href="#l33.340"></a><span id="l33.340" class="difflineplus">+ * @return {array} The room's alias as an array of strings</span>
<a href="#l33.341"></a><span id="l33.341" class="difflineplus">+ */</span>
<a href="#l33.342"></a><span id="l33.342" class="difflineplus">+Room.prototype.getAliases = function() {</span>
<a href="#l33.343"></a><span id="l33.343" class="difflineplus">+    var alias_strings = [];</span>
<a href="#l33.344"></a><span id="l33.344" class="difflineplus">+</span>
<a href="#l33.345"></a><span id="l33.345" class="difflineplus">+    var alias_events = this.currentState.getStateEvents(&quot;m.room.aliases&quot;);</span>
<a href="#l33.346"></a><span id="l33.346" class="difflineplus">+    if (alias_events) {</span>
<a href="#l33.347"></a><span id="l33.347" class="difflineplus">+        for (var i = 0; i &lt; alias_events.length; ++i) {</span>
<a href="#l33.348"></a><span id="l33.348" class="difflineplus">+            var alias_event = alias_events[i];</span>
<a href="#l33.349"></a><span id="l33.349" class="difflineplus">+            if (utils.isArray(alias_event.getContent().aliases)) {</span>
<a href="#l33.350"></a><span id="l33.350" class="difflineplus">+                Array.prototype.push.apply(</span>
<a href="#l33.351"></a><span id="l33.351" class="difflineplus">+                    alias_strings, alias_event.getContent().aliases</span>
<a href="#l33.352"></a><span id="l33.352" class="difflineplus">+                );</span>
<a href="#l33.353"></a><span id="l33.353" class="difflineplus">+            }</span>
<a href="#l33.354"></a><span id="l33.354" class="difflineplus">+        }</span>
<a href="#l33.355"></a><span id="l33.355" class="difflineplus">+    }</span>
<a href="#l33.356"></a><span id="l33.356" class="difflineplus">+    return alias_strings;</span>
<a href="#l33.357"></a><span id="l33.357" class="difflineplus">+};</span>
<a href="#l33.358"></a><span id="l33.358" class="difflineplus">+</span>
<a href="#l33.359"></a><span id="l33.359" class="difflineplus">+/**</span>
<a href="#l33.360"></a><span id="l33.360" class="difflineplus">+ * Get this room's canonical alias</span>
<a href="#l33.361"></a><span id="l33.361" class="difflineplus">+ * The alias returned by this function may not necessarily</span>
<a href="#l33.362"></a><span id="l33.362" class="difflineplus">+ * still point to this room.</span>
<a href="#l33.363"></a><span id="l33.363" class="difflineplus">+ * @return {?string} The room's canonical alias, or null if there is none</span>
<a href="#l33.364"></a><span id="l33.364" class="difflineplus">+ */</span>
<a href="#l33.365"></a><span id="l33.365" class="difflineplus">+Room.prototype.getCanonicalAlias = function() {</span>
<a href="#l33.366"></a><span id="l33.366" class="difflineplus">+    var canonicalAlias = this.currentState.getStateEvents(&quot;m.room.canonical_alias&quot;, &quot;&quot;);</span>
<a href="#l33.367"></a><span id="l33.367" class="difflineplus">+    if (canonicalAlias) {</span>
<a href="#l33.368"></a><span id="l33.368" class="difflineplus">+        return canonicalAlias.getContent().alias;</span>
<a href="#l33.369"></a><span id="l33.369" class="difflineplus">+    }</span>
<a href="#l33.370"></a><span id="l33.370" class="difflineplus">+    return null;</span>
<a href="#l33.371"></a><span id="l33.371" class="difflineplus">+};</span>
<a href="#l33.372"></a><span id="l33.372" class="difflineplus">+</span>
<a href="#l33.373"></a><span id="l33.373" class="difflineplus">+/**</span>
<a href="#l33.374"></a><span id="l33.374" class="difflineplus">+ * Add events to a timeline</span>
<a href="#l33.375"></a><span id="l33.375" class="difflineplus">+ *</span>
<a href="#l33.376"></a><span id="l33.376" class="difflineplus">+ * &lt;p&gt;Will fire &quot;Room.timeline&quot; for each event added.</span>
<a href="#l33.377"></a><span id="l33.377" class="difflineplus">+ *</span>
<a href="#l33.378"></a><span id="l33.378" class="difflineplus">+ * @param {MatrixEvent[]} events A list of events to add.</span>
<a href="#l33.379"></a><span id="l33.379" class="difflineplus">+ *</span>
<a href="#l33.380"></a><span id="l33.380" class="difflineplus">+ * @param {boolean} toStartOfTimeline   True to add these events to the start</span>
<a href="#l33.381"></a><span id="l33.381" class="difflineplus">+ * (oldest) instead of the end (newest) of the timeline. If true, the oldest</span>
<a href="#l33.382"></a><span id="l33.382" class="difflineplus">+ * event will be the &lt;b&gt;last&lt;/b&gt; element of 'events'.</span>
<a href="#l33.383"></a><span id="l33.383" class="difflineplus">+ *</span>
<a href="#l33.384"></a><span id="l33.384" class="difflineplus">+ * @param {module:models/event-timeline~EventTimeline} timeline   timeline to</span>
<a href="#l33.385"></a><span id="l33.385" class="difflineplus">+ *    add events to.</span>
<a href="#l33.386"></a><span id="l33.386" class="difflineplus">+ *</span>
<a href="#l33.387"></a><span id="l33.387" class="difflineplus">+ * @param {string=} paginationToken   token for the next batch of events</span>
<a href="#l33.388"></a><span id="l33.388" class="difflineplus">+ *</span>
<a href="#l33.389"></a><span id="l33.389" class="difflineplus">+ * @fires module:client~MatrixClient#event:&quot;Room.timeline&quot;</span>
<a href="#l33.390"></a><span id="l33.390" class="difflineplus">+ *</span>
<a href="#l33.391"></a><span id="l33.391" class="difflineplus">+ */</span>
<a href="#l33.392"></a><span id="l33.392" class="difflineplus">+Room.prototype.addEventsToTimeline = function(events, toStartOfTimeline,</span>
<a href="#l33.393"></a><span id="l33.393" class="difflineplus">+                                              timeline, paginationToken) {</span>
<a href="#l33.394"></a><span id="l33.394" class="difflineplus">+    timeline.getTimelineSet().addEventsToTimeline(</span>
<a href="#l33.395"></a><span id="l33.395" class="difflineplus">+        events, toStartOfTimeline,</span>
<a href="#l33.396"></a><span id="l33.396" class="difflineplus">+        timeline, paginationToken</span>
<a href="#l33.397"></a><span id="l33.397" class="difflineplus">+    );</span>
<a href="#l33.398"></a><span id="l33.398" class="difflineplus">+};</span>
<a href="#l33.399"></a><span id="l33.399" class="difflineplus">+</span>
<a href="#l33.400"></a><span id="l33.400" class="difflineplus">+/**</span>
<a href="#l33.401"></a><span id="l33.401" class="difflineplus">+ * Get a member from the current room state.</span>
<a href="#l33.402"></a><span id="l33.402" class="difflineplus">+ * @param {string} userId The user ID of the member.</span>
<a href="#l33.403"></a><span id="l33.403" class="difflineplus">+ * @return {RoomMember} The member or &lt;code&gt;null&lt;/code&gt;.</span>
<a href="#l33.404"></a><span id="l33.404" class="difflineplus">+ */</span>
<a href="#l33.405"></a><span id="l33.405" class="difflineplus">+ Room.prototype.getMember = function(userId) {</span>
<a href="#l33.406"></a><span id="l33.406" class="difflineplus">+    var member = this.currentState.members[userId];</span>
<a href="#l33.407"></a><span id="l33.407" class="difflineplus">+    if (!member) {</span>
<a href="#l33.408"></a><span id="l33.408" class="difflineplus">+        return null;</span>
<a href="#l33.409"></a><span id="l33.409" class="difflineplus">+    }</span>
<a href="#l33.410"></a><span id="l33.410" class="difflineplus">+    return member;</span>
<a href="#l33.411"></a><span id="l33.411" class="difflineplus">+ };</span>
<a href="#l33.412"></a><span id="l33.412" class="difflineplus">+</span>
<a href="#l33.413"></a><span id="l33.413" class="difflineplus">+/**</span>
<a href="#l33.414"></a><span id="l33.414" class="difflineplus">+ * Get a list of members whose membership state is &quot;join&quot;.</span>
<a href="#l33.415"></a><span id="l33.415" class="difflineplus">+ * @return {RoomMember[]} A list of currently joined members.</span>
<a href="#l33.416"></a><span id="l33.416" class="difflineplus">+ */</span>
<a href="#l33.417"></a><span id="l33.417" class="difflineplus">+ Room.prototype.getJoinedMembers = function() {</span>
<a href="#l33.418"></a><span id="l33.418" class="difflineplus">+    return this.getMembersWithMembership(&quot;join&quot;);</span>
<a href="#l33.419"></a><span id="l33.419" class="difflineplus">+ };</span>
<a href="#l33.420"></a><span id="l33.420" class="difflineplus">+</span>
<a href="#l33.421"></a><span id="l33.421" class="difflineplus">+/**</span>
<a href="#l33.422"></a><span id="l33.422" class="difflineplus">+ * Get a list of members with given membership state.</span>
<a href="#l33.423"></a><span id="l33.423" class="difflineplus">+ * @param {string} membership The membership state.</span>
<a href="#l33.424"></a><span id="l33.424" class="difflineplus">+ * @return {RoomMember[]} A list of members with the given membership state.</span>
<a href="#l33.425"></a><span id="l33.425" class="difflineplus">+ */</span>
<a href="#l33.426"></a><span id="l33.426" class="difflineplus">+ Room.prototype.getMembersWithMembership = function(membership) {</span>
<a href="#l33.427"></a><span id="l33.427" class="difflineplus">+    return utils.filter(this.currentState.getMembers(), function(m) {</span>
<a href="#l33.428"></a><span id="l33.428" class="difflineplus">+        return m.membership === membership;</span>
<a href="#l33.429"></a><span id="l33.429" class="difflineplus">+    });</span>
<a href="#l33.430"></a><span id="l33.430" class="difflineplus">+ };</span>
<a href="#l33.431"></a><span id="l33.431" class="difflineplus">+</span>
<a href="#l33.432"></a><span id="l33.432" class="difflineplus">+ /**</span>
<a href="#l33.433"></a><span id="l33.433" class="difflineplus">+  * Get the default room name (i.e. what a given user would see if the</span>
<a href="#l33.434"></a><span id="l33.434" class="difflineplus">+  * room had no m.room.name)</span>
<a href="#l33.435"></a><span id="l33.435" class="difflineplus">+  * @param {string} userId The userId from whose perspective we want</span>
<a href="#l33.436"></a><span id="l33.436" class="difflineplus">+  * to calculate the default name</span>
<a href="#l33.437"></a><span id="l33.437" class="difflineplus">+  * @return {string} The default room name</span>
<a href="#l33.438"></a><span id="l33.438" class="difflineplus">+  */</span>
<a href="#l33.439"></a><span id="l33.439" class="difflineplus">+ Room.prototype.getDefaultRoomName = function(userId) {</span>
<a href="#l33.440"></a><span id="l33.440" class="difflineplus">+    return calculateRoomName(this, userId, true);</span>
<a href="#l33.441"></a><span id="l33.441" class="difflineplus">+ };</span>
<a href="#l33.442"></a><span id="l33.442" class="difflineplus">+</span>
<a href="#l33.443"></a><span id="l33.443" class="difflineplus">+</span>
<a href="#l33.444"></a><span id="l33.444" class="difflineplus">+ /**</span>
<a href="#l33.445"></a><span id="l33.445" class="difflineplus">+ * Check if the given user_id has the given membership state.</span>
<a href="#l33.446"></a><span id="l33.446" class="difflineplus">+ * @param {string} userId The user ID to check.</span>
<a href="#l33.447"></a><span id="l33.447" class="difflineplus">+ * @param {string} membership The membership e.g. &lt;code&gt;'join'&lt;/code&gt;</span>
<a href="#l33.448"></a><span id="l33.448" class="difflineplus">+ * @return {boolean} True if this user_id has the given membership state.</span>
<a href="#l33.449"></a><span id="l33.449" class="difflineplus">+ */</span>
<a href="#l33.450"></a><span id="l33.450" class="difflineplus">+ Room.prototype.hasMembershipState = function(userId, membership) {</span>
<a href="#l33.451"></a><span id="l33.451" class="difflineplus">+    var member = this.getMember(userId);</span>
<a href="#l33.452"></a><span id="l33.452" class="difflineplus">+    if (!member) {</span>
<a href="#l33.453"></a><span id="l33.453" class="difflineplus">+        return false;</span>
<a href="#l33.454"></a><span id="l33.454" class="difflineplus">+    }</span>
<a href="#l33.455"></a><span id="l33.455" class="difflineplus">+    return member.membership === membership;</span>
<a href="#l33.456"></a><span id="l33.456" class="difflineplus">+ };</span>
<a href="#l33.457"></a><span id="l33.457" class="difflineplus">+</span>
<a href="#l33.458"></a><span id="l33.458" class="difflineplus">+/**</span>
<a href="#l33.459"></a><span id="l33.459" class="difflineplus">+ * Add a timelineSet for this room with the given filter</span>
<a href="#l33.460"></a><span id="l33.460" class="difflineplus">+ * @param {Filter} filter  The filter to be applied to this timelineSet</span>
<a href="#l33.461"></a><span id="l33.461" class="difflineplus">+ * @return {EventTimelineSet}  The timelineSet</span>
<a href="#l33.462"></a><span id="l33.462" class="difflineplus">+ */</span>
<a href="#l33.463"></a><span id="l33.463" class="difflineplus">+Room.prototype.getOrCreateFilteredTimelineSet = function(filter) {</span>
<a href="#l33.464"></a><span id="l33.464" class="difflineplus">+    if (this._filteredTimelineSets[filter.filterId]) {</span>
<a href="#l33.465"></a><span id="l33.465" class="difflineplus">+        return this._filteredTimelineSets[filter.filterId];</span>
<a href="#l33.466"></a><span id="l33.466" class="difflineplus">+    }</span>
<a href="#l33.467"></a><span id="l33.467" class="difflineplus">+    var opts = Object.assign({ filter: filter }, this._opts);</span>
<a href="#l33.468"></a><span id="l33.468" class="difflineplus">+    var timelineSet = new EventTimelineSet(this, opts);</span>
<a href="#l33.469"></a><span id="l33.469" class="difflineplus">+    reEmit(this, timelineSet, [&quot;Room.timeline&quot;, &quot;Room.timelineReset&quot;]);</span>
<a href="#l33.470"></a><span id="l33.470" class="difflineplus">+    this._filteredTimelineSets[filter.filterId] = timelineSet;</span>
<a href="#l33.471"></a><span id="l33.471" class="difflineplus">+    this._timelineSets.push(timelineSet);</span>
<a href="#l33.472"></a><span id="l33.472" class="difflineplus">+</span>
<a href="#l33.473"></a><span id="l33.473" class="difflineplus">+    // populate up the new timelineSet with filtered events from our live</span>
<a href="#l33.474"></a><span id="l33.474" class="difflineplus">+    // unfiltered timeline.</span>
<a href="#l33.475"></a><span id="l33.475" class="difflineplus">+    //</span>
<a href="#l33.476"></a><span id="l33.476" class="difflineplus">+    // XXX: This is risky as our timeline</span>
<a href="#l33.477"></a><span id="l33.477" class="difflineplus">+    // may have grown huge and so take a long time to filter.</span>
<a href="#l33.478"></a><span id="l33.478" class="difflineplus">+    // see https://github.com/vector-im/vector-web/issues/2109</span>
<a href="#l33.479"></a><span id="l33.479" class="difflineplus">+</span>
<a href="#l33.480"></a><span id="l33.480" class="difflineplus">+    var unfilteredLiveTimeline = this.getLiveTimeline();</span>
<a href="#l33.481"></a><span id="l33.481" class="difflineplus">+</span>
<a href="#l33.482"></a><span id="l33.482" class="difflineplus">+    unfilteredLiveTimeline.getEvents().forEach(function(event) {</span>
<a href="#l33.483"></a><span id="l33.483" class="difflineplus">+        timelineSet.addLiveEvent(event);</span>
<a href="#l33.484"></a><span id="l33.484" class="difflineplus">+    });</span>
<a href="#l33.485"></a><span id="l33.485" class="difflineplus">+</span>
<a href="#l33.486"></a><span id="l33.486" class="difflineplus">+    // find the earliest unfiltered timeline</span>
<a href="#l33.487"></a><span id="l33.487" class="difflineplus">+    var timeline = unfilteredLiveTimeline;</span>
<a href="#l33.488"></a><span id="l33.488" class="difflineplus">+    while (timeline.getNeighbouringTimeline(EventTimeline.BACKWARDS)) {</span>
<a href="#l33.489"></a><span id="l33.489" class="difflineplus">+        timeline = timeline.getNeighbouringTimeline(EventTimeline.BACKWARDS);</span>
<a href="#l33.490"></a><span id="l33.490" class="difflineplus">+    }</span>
<a href="#l33.491"></a><span id="l33.491" class="difflineplus">+</span>
<a href="#l33.492"></a><span id="l33.492" class="difflineplus">+    timelineSet.getLiveTimeline().setPaginationToken(</span>
<a href="#l33.493"></a><span id="l33.493" class="difflineplus">+        timeline.getPaginationToken(EventTimeline.BACKWARDS),</span>
<a href="#l33.494"></a><span id="l33.494" class="difflineplus">+        EventTimeline.BACKWARDS</span>
<a href="#l33.495"></a><span id="l33.495" class="difflineplus">+    );</span>
<a href="#l33.496"></a><span id="l33.496" class="difflineplus">+</span>
<a href="#l33.497"></a><span id="l33.497" class="difflineplus">+    // alternatively, we could try to do something like this to try and re-paginate</span>
<a href="#l33.498"></a><span id="l33.498" class="difflineplus">+    // in the filtered events from nothing, but Mark says it's an abuse of the API</span>
<a href="#l33.499"></a><span id="l33.499" class="difflineplus">+    // to do so:</span>
<a href="#l33.500"></a><span id="l33.500" class="difflineplus">+    //</span>
<a href="#l33.501"></a><span id="l33.501" class="difflineplus">+    // timelineSet.resetLiveTimeline(</span>
<a href="#l33.502"></a><span id="l33.502" class="difflineplus">+    //      unfilteredLiveTimeline.getPaginationToken(EventTimeline.FORWARDS)</span>
<a href="#l33.503"></a><span id="l33.503" class="difflineplus">+    // );</span>
<a href="#l33.504"></a><span id="l33.504" class="difflineplus">+</span>
<a href="#l33.505"></a><span id="l33.505" class="difflineplus">+    return timelineSet;</span>
<a href="#l33.506"></a><span id="l33.506" class="difflineplus">+};</span>
<a href="#l33.507"></a><span id="l33.507" class="difflineplus">+</span>
<a href="#l33.508"></a><span id="l33.508" class="difflineplus">+/**</span>
<a href="#l33.509"></a><span id="l33.509" class="difflineplus">+ * Forget the timelineSet for this room with the given filter</span>
<a href="#l33.510"></a><span id="l33.510" class="difflineplus">+ *</span>
<a href="#l33.511"></a><span id="l33.511" class="difflineplus">+ * @param {Filter} filter  the filter whose timelineSet is to be forgotten</span>
<a href="#l33.512"></a><span id="l33.512" class="difflineplus">+ */</span>
<a href="#l33.513"></a><span id="l33.513" class="difflineplus">+Room.prototype.removeFilteredTimelineSet = function(filter) {</span>
<a href="#l33.514"></a><span id="l33.514" class="difflineplus">+    var timelineSet = this._filteredTimelineSets[filter.filterId];</span>
<a href="#l33.515"></a><span id="l33.515" class="difflineplus">+    delete this._filteredTimelineSets[filter.filterId];</span>
<a href="#l33.516"></a><span id="l33.516" class="difflineplus">+    var i = this._timelineSets.indexOf(timelineSet);</span>
<a href="#l33.517"></a><span id="l33.517" class="difflineplus">+    if (i &gt; -1) {</span>
<a href="#l33.518"></a><span id="l33.518" class="difflineplus">+        this._timelineSets.splice(i, 1);</span>
<a href="#l33.519"></a><span id="l33.519" class="difflineplus">+    }</span>
<a href="#l33.520"></a><span id="l33.520" class="difflineplus">+};</span>
<a href="#l33.521"></a><span id="l33.521" class="difflineplus">+</span>
<a href="#l33.522"></a><span id="l33.522" class="difflineplus">+/**</span>
<a href="#l33.523"></a><span id="l33.523" class="difflineplus">+ * Add an event to the end of this room's live timelines. Will fire</span>
<a href="#l33.524"></a><span id="l33.524" class="difflineplus">+ * &quot;Room.timeline&quot;.</span>
<a href="#l33.525"></a><span id="l33.525" class="difflineplus">+ *</span>
<a href="#l33.526"></a><span id="l33.526" class="difflineplus">+ * @param {MatrixEvent} event Event to be added</span>
<a href="#l33.527"></a><span id="l33.527" class="difflineplus">+ * @param {string?} duplicateStrategy 'ignore' or 'replace'</span>
<a href="#l33.528"></a><span id="l33.528" class="difflineplus">+ * @fires module:client~MatrixClient#event:&quot;Room.timeline&quot;</span>
<a href="#l33.529"></a><span id="l33.529" class="difflineplus">+ * @private</span>
<a href="#l33.530"></a><span id="l33.530" class="difflineplus">+ */</span>
<a href="#l33.531"></a><span id="l33.531" class="difflineplus">+Room.prototype._addLiveEvent = function(event, duplicateStrategy) {</span>
<a href="#l33.532"></a><span id="l33.532" class="difflineplus">+    var i;</span>
<a href="#l33.533"></a><span id="l33.533" class="difflineplus">+    if (event.getType() === &quot;m.room.redaction&quot;) {</span>
<a href="#l33.534"></a><span id="l33.534" class="difflineplus">+        var redactId = event.event.redacts;</span>
<a href="#l33.535"></a><span id="l33.535" class="difflineplus">+</span>
<a href="#l33.536"></a><span id="l33.536" class="difflineplus">+        // if we know about this event, redact its contents now.</span>
<a href="#l33.537"></a><span id="l33.537" class="difflineplus">+        var redactedEvent = this.getUnfilteredTimelineSet().findEventById(redactId);</span>
<a href="#l33.538"></a><span id="l33.538" class="difflineplus">+        if (redactedEvent) {</span>
<a href="#l33.539"></a><span id="l33.539" class="difflineplus">+            redactedEvent.makeRedacted(event);</span>
<a href="#l33.540"></a><span id="l33.540" class="difflineplus">+            this.emit(&quot;Room.redaction&quot;, event, this);</span>
<a href="#l33.541"></a><span id="l33.541" class="difflineplus">+</span>
<a href="#l33.542"></a><span id="l33.542" class="difflineplus">+            // TODO: we stash user displaynames (among other things) in</span>
<a href="#l33.543"></a><span id="l33.543" class="difflineplus">+            // RoomMember objects which are then attached to other events</span>
<a href="#l33.544"></a><span id="l33.544" class="difflineplus">+            // (in the sender and target fields). We should get those</span>
<a href="#l33.545"></a><span id="l33.545" class="difflineplus">+            // RoomMember objects to update themselves when the events that</span>
<a href="#l33.546"></a><span id="l33.546" class="difflineplus">+            // they are based on are changed.</span>
<a href="#l33.547"></a><span id="l33.547" class="difflineplus">+        }</span>
<a href="#l33.548"></a><span id="l33.548" class="difflineplus">+</span>
<a href="#l33.549"></a><span id="l33.549" class="difflineplus">+        // FIXME: apply redactions to notification list</span>
<a href="#l33.550"></a><span id="l33.550" class="difflineplus">+</span>
<a href="#l33.551"></a><span id="l33.551" class="difflineplus">+        // NB: We continue to add the redaction event to the timeline so</span>
<a href="#l33.552"></a><span id="l33.552" class="difflineplus">+        // clients can say &quot;so and so redacted an event&quot; if they wish to. Also</span>
<a href="#l33.553"></a><span id="l33.553" class="difflineplus">+        // this may be needed to trigger an update.</span>
<a href="#l33.554"></a><span id="l33.554" class="difflineplus">+    }</span>
<a href="#l33.555"></a><span id="l33.555" class="difflineplus">+</span>
<a href="#l33.556"></a><span id="l33.556" class="difflineplus">+    if (event.getUnsigned().transaction_id) {</span>
<a href="#l33.557"></a><span id="l33.557" class="difflineplus">+        var existingEvent = this._txnToEvent[event.getUnsigned().transaction_id];</span>
<a href="#l33.558"></a><span id="l33.558" class="difflineplus">+        if (existingEvent) {</span>
<a href="#l33.559"></a><span id="l33.559" class="difflineplus">+            // remote echo of an event we sent earlier</span>
<a href="#l33.560"></a><span id="l33.560" class="difflineplus">+            this._handleRemoteEcho(event, existingEvent);</span>
<a href="#l33.561"></a><span id="l33.561" class="difflineplus">+            return;</span>
<a href="#l33.562"></a><span id="l33.562" class="difflineplus">+        }</span>
<a href="#l33.563"></a><span id="l33.563" class="difflineplus">+    }</span>
<a href="#l33.564"></a><span id="l33.564" class="difflineplus">+</span>
<a href="#l33.565"></a><span id="l33.565" class="difflineplus">+    // add to our timeline sets</span>
<a href="#l33.566"></a><span id="l33.566" class="difflineplus">+    for (i = 0; i &lt; this._timelineSets.length; i++) {</span>
<a href="#l33.567"></a><span id="l33.567" class="difflineplus">+        this._timelineSets[i].addLiveEvent(event, duplicateStrategy);</span>
<a href="#l33.568"></a><span id="l33.568" class="difflineplus">+    }</span>
<a href="#l33.569"></a><span id="l33.569" class="difflineplus">+</span>
<a href="#l33.570"></a><span id="l33.570" class="difflineplus">+    // synthesize and inject implicit read receipts</span>
<a href="#l33.571"></a><span id="l33.571" class="difflineplus">+    // Done after adding the event because otherwise the app would get a read receipt</span>
<a href="#l33.572"></a><span id="l33.572" class="difflineplus">+    // pointing to an event that wasn't yet in the timeline</span>
<a href="#l33.573"></a><span id="l33.573" class="difflineplus">+    if (event.sender) {</span>
<a href="#l33.574"></a><span id="l33.574" class="difflineplus">+        this.addReceipt(synthesizeReceipt(</span>
<a href="#l33.575"></a><span id="l33.575" class="difflineplus">+            event.sender.userId, event, &quot;m.read&quot;</span>
<a href="#l33.576"></a><span id="l33.576" class="difflineplus">+        ), true);</span>
<a href="#l33.577"></a><span id="l33.577" class="difflineplus">+</span>
<a href="#l33.578"></a><span id="l33.578" class="difflineplus">+        // Any live events from a user could be taken as implicit</span>
<a href="#l33.579"></a><span id="l33.579" class="difflineplus">+        // presence information: evidence that they are currently active.</span>
<a href="#l33.580"></a><span id="l33.580" class="difflineplus">+        // ...except in a world where we use 'user.currentlyActive' to reduce</span>
<a href="#l33.581"></a><span id="l33.581" class="difflineplus">+        // presence spam, this isn't very useful - we'll get a transition when</span>
<a href="#l33.582"></a><span id="l33.582" class="difflineplus">+        // they are no longer currently active anyway. So don't bother to</span>
<a href="#l33.583"></a><span id="l33.583" class="difflineplus">+        // reset the lastActiveAgo and lastPresenceTs from the RoomState's user.</span>
<a href="#l33.584"></a><span id="l33.584" class="difflineplus">+    }</span>
<a href="#l33.585"></a><span id="l33.585" class="difflineplus">+};</span>
<a href="#l33.586"></a><span id="l33.586" class="difflineplus">+</span>
<a href="#l33.587"></a><span id="l33.587" class="difflineplus">+</span>
<a href="#l33.588"></a><span id="l33.588" class="difflineplus">+/**</span>
<a href="#l33.589"></a><span id="l33.589" class="difflineplus">+ * Add a pending outgoing event to this room.</span>
<a href="#l33.590"></a><span id="l33.590" class="difflineplus">+ *</span>
<a href="#l33.591"></a><span id="l33.591" class="difflineplus">+ * &lt;p&gt;The event is added to either the pendingEventList, or the live timeline,</span>
<a href="#l33.592"></a><span id="l33.592" class="difflineplus">+ * depending on the setting of opts.pendingEventOrdering.</span>
<a href="#l33.593"></a><span id="l33.593" class="difflineplus">+ *</span>
<a href="#l33.594"></a><span id="l33.594" class="difflineplus">+ * &lt;p&gt;This is an internal method, intended for use by MatrixClient.</span>
<a href="#l33.595"></a><span id="l33.595" class="difflineplus">+ *</span>
<a href="#l33.596"></a><span id="l33.596" class="difflineplus">+ * @param {module:models/event.MatrixEvent} event The event to add.</span>
<a href="#l33.597"></a><span id="l33.597" class="difflineplus">+ *</span>
<a href="#l33.598"></a><span id="l33.598" class="difflineplus">+ * @param {string} txnId   Transaction id for this outgoing event</span>
<a href="#l33.599"></a><span id="l33.599" class="difflineplus">+ *</span>
<a href="#l33.600"></a><span id="l33.600" class="difflineplus">+ * @fires module:client~MatrixClient#event:&quot;Room.localEchoUpdated&quot;</span>
<a href="#l33.601"></a><span id="l33.601" class="difflineplus">+ *</span>
<a href="#l33.602"></a><span id="l33.602" class="difflineplus">+ * @throws if the event doesn't have status SENDING, or we aren't given a</span>
<a href="#l33.603"></a><span id="l33.603" class="difflineplus">+ * unique transaction id.</span>
<a href="#l33.604"></a><span id="l33.604" class="difflineplus">+ */</span>
<a href="#l33.605"></a><span id="l33.605" class="difflineplus">+Room.prototype.addPendingEvent = function(event, txnId) {</span>
<a href="#l33.606"></a><span id="l33.606" class="difflineplus">+    if (event.status !== EventStatus.SENDING) {</span>
<a href="#l33.607"></a><span id="l33.607" class="difflineplus">+        throw new Error(&quot;addPendingEvent called on an event with status &quot; +</span>
<a href="#l33.608"></a><span id="l33.608" class="difflineplus">+                        event.status);</span>
<a href="#l33.609"></a><span id="l33.609" class="difflineplus">+    }</span>
<a href="#l33.610"></a><span id="l33.610" class="difflineplus">+</span>
<a href="#l33.611"></a><span id="l33.611" class="difflineplus">+    if (this._txnToEvent[txnId]) {</span>
<a href="#l33.612"></a><span id="l33.612" class="difflineplus">+        throw new Error(&quot;addPendingEvent called on an event with known txnId &quot; +</span>
<a href="#l33.613"></a><span id="l33.613" class="difflineplus">+                        txnId);</span>
<a href="#l33.614"></a><span id="l33.614" class="difflineplus">+    }</span>
<a href="#l33.615"></a><span id="l33.615" class="difflineplus">+</span>
<a href="#l33.616"></a><span id="l33.616" class="difflineplus">+    // call setEventMetadata to set up event.sender etc</span>
<a href="#l33.617"></a><span id="l33.617" class="difflineplus">+    // as event is shared over all timelineSets, we set up its metadata based</span>
<a href="#l33.618"></a><span id="l33.618" class="difflineplus">+    // on the unfiltered timelineSet.</span>
<a href="#l33.619"></a><span id="l33.619" class="difflineplus">+    EventTimeline.setEventMetadata(</span>
<a href="#l33.620"></a><span id="l33.620" class="difflineplus">+        event,</span>
<a href="#l33.621"></a><span id="l33.621" class="difflineplus">+        this.getLiveTimeline().getState(EventTimeline.FORWARDS),</span>
<a href="#l33.622"></a><span id="l33.622" class="difflineplus">+        false</span>
<a href="#l33.623"></a><span id="l33.623" class="difflineplus">+    );</span>
<a href="#l33.624"></a><span id="l33.624" class="difflineplus">+</span>
<a href="#l33.625"></a><span id="l33.625" class="difflineplus">+    this._txnToEvent[txnId] = event;</span>
<a href="#l33.626"></a><span id="l33.626" class="difflineplus">+</span>
<a href="#l33.627"></a><span id="l33.627" class="difflineplus">+    if (this._opts.pendingEventOrdering == &quot;detached&quot;) {</span>
<a href="#l33.628"></a><span id="l33.628" class="difflineplus">+        this._pendingEventList.push(event);</span>
<a href="#l33.629"></a><span id="l33.629" class="difflineplus">+    } else {</span>
<a href="#l33.630"></a><span id="l33.630" class="difflineplus">+        for (var i = 0; i &lt; this._timelineSets.length; i++) {</span>
<a href="#l33.631"></a><span id="l33.631" class="difflineplus">+            var timelineSet = this._timelineSets[i];</span>
<a href="#l33.632"></a><span id="l33.632" class="difflineplus">+            if (timelineSet.getFilter()) {</span>
<a href="#l33.633"></a><span id="l33.633" class="difflineplus">+                if (this._filter.filterRoomTimeline([event]).length) {</span>
<a href="#l33.634"></a><span id="l33.634" class="difflineplus">+                    timelineSet.addEventToTimeline(event,</span>
<a href="#l33.635"></a><span id="l33.635" class="difflineplus">+                        timelineSet.getLiveTimeline(), false);</span>
<a href="#l33.636"></a><span id="l33.636" class="difflineplus">+                }</span>
<a href="#l33.637"></a><span id="l33.637" class="difflineplus">+            }</span>
<a href="#l33.638"></a><span id="l33.638" class="difflineplus">+            else {</span>
<a href="#l33.639"></a><span id="l33.639" class="difflineplus">+                timelineSet.addEventToTimeline(event,</span>
<a href="#l33.640"></a><span id="l33.640" class="difflineplus">+                    timelineSet.getLiveTimeline(), false);</span>
<a href="#l33.641"></a><span id="l33.641" class="difflineplus">+            }</span>
<a href="#l33.642"></a><span id="l33.642" class="difflineplus">+        }</span>
<a href="#l33.643"></a><span id="l33.643" class="difflineplus">+    }</span>
<a href="#l33.644"></a><span id="l33.644" class="difflineplus">+</span>
<a href="#l33.645"></a><span id="l33.645" class="difflineplus">+    this.emit(&quot;Room.localEchoUpdated&quot;, event, this, null, null);</span>
<a href="#l33.646"></a><span id="l33.646" class="difflineplus">+};</span>
<a href="#l33.647"></a><span id="l33.647" class="difflineplus">+</span>
<a href="#l33.648"></a><span id="l33.648" class="difflineplus">+/**</span>
<a href="#l33.649"></a><span id="l33.649" class="difflineplus">+ * Deal with the echo of a message we sent.</span>
<a href="#l33.650"></a><span id="l33.650" class="difflineplus">+ *</span>
<a href="#l33.651"></a><span id="l33.651" class="difflineplus">+ * &lt;p&gt;We move the event to the live timeline if it isn't there already, and</span>
<a href="#l33.652"></a><span id="l33.652" class="difflineplus">+ * update it.</span>
<a href="#l33.653"></a><span id="l33.653" class="difflineplus">+ *</span>
<a href="#l33.654"></a><span id="l33.654" class="difflineplus">+ * @param {module:models/event.MatrixEvent} remoteEvent   The event received from</span>
<a href="#l33.655"></a><span id="l33.655" class="difflineplus">+ *    /sync</span>
<a href="#l33.656"></a><span id="l33.656" class="difflineplus">+ * @param {module:models/event.MatrixEvent} localEvent    The local echo, which</span>
<a href="#l33.657"></a><span id="l33.657" class="difflineplus">+ *    should be either in the _pendingEventList or the timeline.</span>
<a href="#l33.658"></a><span id="l33.658" class="difflineplus">+ *</span>
<a href="#l33.659"></a><span id="l33.659" class="difflineplus">+ * @fires module:client~MatrixClient#event:&quot;Room.localEchoUpdated&quot;</span>
<a href="#l33.660"></a><span id="l33.660" class="difflineplus">+ * @private</span>
<a href="#l33.661"></a><span id="l33.661" class="difflineplus">+ */</span>
<a href="#l33.662"></a><span id="l33.662" class="difflineplus">+Room.prototype._handleRemoteEcho = function(remoteEvent, localEvent) {</span>
<a href="#l33.663"></a><span id="l33.663" class="difflineplus">+    var oldEventId = localEvent.getId();</span>
<a href="#l33.664"></a><span id="l33.664" class="difflineplus">+    var newEventId = remoteEvent.getId();</span>
<a href="#l33.665"></a><span id="l33.665" class="difflineplus">+    var oldStatus = localEvent.status;</span>
<a href="#l33.666"></a><span id="l33.666" class="difflineplus">+</span>
<a href="#l33.667"></a><span id="l33.667" class="difflineplus">+    // no longer pending</span>
<a href="#l33.668"></a><span id="l33.668" class="difflineplus">+    delete this._txnToEvent[remoteEvent.transaction_id];</span>
<a href="#l33.669"></a><span id="l33.669" class="difflineplus">+</span>
<a href="#l33.670"></a><span id="l33.670" class="difflineplus">+    // if it's in the pending list, remove it</span>
<a href="#l33.671"></a><span id="l33.671" class="difflineplus">+    if (this._pendingEventList) {</span>
<a href="#l33.672"></a><span id="l33.672" class="difflineplus">+        utils.removeElement(</span>
<a href="#l33.673"></a><span id="l33.673" class="difflineplus">+            this._pendingEventList,</span>
<a href="#l33.674"></a><span id="l33.674" class="difflineplus">+            function(ev) { return ev.getId() == oldEventId; },</span>
<a href="#l33.675"></a><span id="l33.675" class="difflineplus">+            false</span>
<a href="#l33.676"></a><span id="l33.676" class="difflineplus">+        );</span>
<a href="#l33.677"></a><span id="l33.677" class="difflineplus">+    }</span>
<a href="#l33.678"></a><span id="l33.678" class="difflineplus">+</span>
<a href="#l33.679"></a><span id="l33.679" class="difflineplus">+    // replace the event source (this will preserve the plaintext payload if</span>
<a href="#l33.680"></a><span id="l33.680" class="difflineplus">+    // any, which is good, because we don't want to try decoding it again).</span>
<a href="#l33.681"></a><span id="l33.681" class="difflineplus">+    localEvent.event = remoteEvent.event;</span>
<a href="#l33.682"></a><span id="l33.682" class="difflineplus">+</span>
<a href="#l33.683"></a><span id="l33.683" class="difflineplus">+    // successfully sent.</span>
<a href="#l33.684"></a><span id="l33.684" class="difflineplus">+    localEvent.status = null;</span>
<a href="#l33.685"></a><span id="l33.685" class="difflineplus">+</span>
<a href="#l33.686"></a><span id="l33.686" class="difflineplus">+    for (var i = 0; i &lt; this._timelineSets.length; i++) {</span>
<a href="#l33.687"></a><span id="l33.687" class="difflineplus">+        var timelineSet = this._timelineSets[i];</span>
<a href="#l33.688"></a><span id="l33.688" class="difflineplus">+</span>
<a href="#l33.689"></a><span id="l33.689" class="difflineplus">+        // if it's already in the timeline, update the timeline map. If it's not, add it.</span>
<a href="#l33.690"></a><span id="l33.690" class="difflineplus">+        timelineSet.handleRemoteEcho(localEvent, oldEventId, newEventId);</span>
<a href="#l33.691"></a><span id="l33.691" class="difflineplus">+    }</span>
<a href="#l33.692"></a><span id="l33.692" class="difflineplus">+</span>
<a href="#l33.693"></a><span id="l33.693" class="difflineplus">+    this.emit(&quot;Room.localEchoUpdated&quot;, localEvent, this,</span>
<a href="#l33.694"></a><span id="l33.694" class="difflineplus">+              oldEventId, oldStatus);</span>
<a href="#l33.695"></a><span id="l33.695" class="difflineplus">+};</span>
<a href="#l33.696"></a><span id="l33.696" class="difflineplus">+</span>
<a href="#l33.697"></a><span id="l33.697" class="difflineplus">+/* a map from current event status to a list of allowed next statuses</span>
<a href="#l33.698"></a><span id="l33.698" class="difflineplus">+ */</span>
<a href="#l33.699"></a><span id="l33.699" class="difflineplus">+var ALLOWED_TRANSITIONS = {};</span>
<a href="#l33.700"></a><span id="l33.700" class="difflineplus">+</span>
<a href="#l33.701"></a><span id="l33.701" class="difflineplus">+ALLOWED_TRANSITIONS[EventStatus.ENCRYPTING] = [</span>
<a href="#l33.702"></a><span id="l33.702" class="difflineplus">+    EventStatus.SENDING,</span>
<a href="#l33.703"></a><span id="l33.703" class="difflineplus">+    EventStatus.NOT_SENT,</span>
<a href="#l33.704"></a><span id="l33.704" class="difflineplus">+];</span>
<a href="#l33.705"></a><span id="l33.705" class="difflineplus">+</span>
<a href="#l33.706"></a><span id="l33.706" class="difflineplus">+ALLOWED_TRANSITIONS[EventStatus.SENDING] = [</span>
<a href="#l33.707"></a><span id="l33.707" class="difflineplus">+    EventStatus.ENCRYPTING,</span>
<a href="#l33.708"></a><span id="l33.708" class="difflineplus">+    EventStatus.QUEUED,</span>
<a href="#l33.709"></a><span id="l33.709" class="difflineplus">+    EventStatus.NOT_SENT,</span>
<a href="#l33.710"></a><span id="l33.710" class="difflineplus">+    EventStatus.SENT,</span>
<a href="#l33.711"></a><span id="l33.711" class="difflineplus">+];</span>
<a href="#l33.712"></a><span id="l33.712" class="difflineplus">+</span>
<a href="#l33.713"></a><span id="l33.713" class="difflineplus">+ALLOWED_TRANSITIONS[EventStatus.QUEUED] =</span>
<a href="#l33.714"></a><span id="l33.714" class="difflineplus">+    [EventStatus.SENDING, EventStatus.CANCELLED];</span>
<a href="#l33.715"></a><span id="l33.715" class="difflineplus">+</span>
<a href="#l33.716"></a><span id="l33.716" class="difflineplus">+ALLOWED_TRANSITIONS[EventStatus.SENT] =</span>
<a href="#l33.717"></a><span id="l33.717" class="difflineplus">+    [];</span>
<a href="#l33.718"></a><span id="l33.718" class="difflineplus">+</span>
<a href="#l33.719"></a><span id="l33.719" class="difflineplus">+ALLOWED_TRANSITIONS[EventStatus.NOT_SENT] =</span>
<a href="#l33.720"></a><span id="l33.720" class="difflineplus">+    [EventStatus.SENDING, EventStatus.QUEUED, EventStatus.CANCELLED];</span>
<a href="#l33.721"></a><span id="l33.721" class="difflineplus">+</span>
<a href="#l33.722"></a><span id="l33.722" class="difflineplus">+ALLOWED_TRANSITIONS[EventStatus.CANCELLED] =</span>
<a href="#l33.723"></a><span id="l33.723" class="difflineplus">+    [];</span>
<a href="#l33.724"></a><span id="l33.724" class="difflineplus">+</span>
<a href="#l33.725"></a><span id="l33.725" class="difflineplus">+/**</span>
<a href="#l33.726"></a><span id="l33.726" class="difflineplus">+ * Update the status / event id on a pending event, to reflect its transmission</span>
<a href="#l33.727"></a><span id="l33.727" class="difflineplus">+ * progress.</span>
<a href="#l33.728"></a><span id="l33.728" class="difflineplus">+ *</span>
<a href="#l33.729"></a><span id="l33.729" class="difflineplus">+ * &lt;p&gt;This is an internal method.</span>
<a href="#l33.730"></a><span id="l33.730" class="difflineplus">+ *</span>
<a href="#l33.731"></a><span id="l33.731" class="difflineplus">+ * @param {MatrixEvent} event      local echo event</span>
<a href="#l33.732"></a><span id="l33.732" class="difflineplus">+ * @param {EventStatus} newStatus  status to assign</span>
<a href="#l33.733"></a><span id="l33.733" class="difflineplus">+ * @param {string} newEventId      new event id to assign. Ignored unless</span>
<a href="#l33.734"></a><span id="l33.734" class="difflineplus">+ *    newStatus == EventStatus.SENT.</span>
<a href="#l33.735"></a><span id="l33.735" class="difflineplus">+ * @fires module:client~MatrixClient#event:&quot;Room.localEchoUpdated&quot;</span>
<a href="#l33.736"></a><span id="l33.736" class="difflineplus">+ */</span>
<a href="#l33.737"></a><span id="l33.737" class="difflineplus">+Room.prototype.updatePendingEvent = function(event, newStatus, newEventId) {</span>
<a href="#l33.738"></a><span id="l33.738" class="difflineplus">+    // if the message was sent, we expect an event id</span>
<a href="#l33.739"></a><span id="l33.739" class="difflineplus">+    if (newStatus == EventStatus.SENT &amp;&amp; !newEventId) {</span>
<a href="#l33.740"></a><span id="l33.740" class="difflineplus">+        throw new Error(&quot;updatePendingEvent called with status=SENT, &quot; +</span>
<a href="#l33.741"></a><span id="l33.741" class="difflineplus">+                        &quot;but no new event id&quot;);</span>
<a href="#l33.742"></a><span id="l33.742" class="difflineplus">+    }</span>
<a href="#l33.743"></a><span id="l33.743" class="difflineplus">+</span>
<a href="#l33.744"></a><span id="l33.744" class="difflineplus">+    // SENT races against /sync, so we have to special-case it.</span>
<a href="#l33.745"></a><span id="l33.745" class="difflineplus">+    if (newStatus == EventStatus.SENT) {</span>
<a href="#l33.746"></a><span id="l33.746" class="difflineplus">+        var timeline = this.getUnfilteredTimelineSet().eventIdToTimeline(newEventId);</span>
<a href="#l33.747"></a><span id="l33.747" class="difflineplus">+        if (timeline) {</span>
<a href="#l33.748"></a><span id="l33.748" class="difflineplus">+            // we've already received the event via the event stream.</span>
<a href="#l33.749"></a><span id="l33.749" class="difflineplus">+            // nothing more to do here.</span>
<a href="#l33.750"></a><span id="l33.750" class="difflineplus">+            return;</span>
<a href="#l33.751"></a><span id="l33.751" class="difflineplus">+        }</span>
<a href="#l33.752"></a><span id="l33.752" class="difflineplus">+    }</span>
<a href="#l33.753"></a><span id="l33.753" class="difflineplus">+</span>
<a href="#l33.754"></a><span id="l33.754" class="difflineplus">+    var oldStatus = event.status;</span>
<a href="#l33.755"></a><span id="l33.755" class="difflineplus">+    var oldEventId = event.getId();</span>
<a href="#l33.756"></a><span id="l33.756" class="difflineplus">+</span>
<a href="#l33.757"></a><span id="l33.757" class="difflineplus">+    if (!oldStatus) {</span>
<a href="#l33.758"></a><span id="l33.758" class="difflineplus">+        throw new Error(&quot;updatePendingEventStatus called on an event which is &quot; +</span>
<a href="#l33.759"></a><span id="l33.759" class="difflineplus">+                        &quot;not a local echo.&quot;);</span>
<a href="#l33.760"></a><span id="l33.760" class="difflineplus">+    }</span>
<a href="#l33.761"></a><span id="l33.761" class="difflineplus">+</span>
<a href="#l33.762"></a><span id="l33.762" class="difflineplus">+    var allowed = ALLOWED_TRANSITIONS[oldStatus];</span>
<a href="#l33.763"></a><span id="l33.763" class="difflineplus">+    if (!allowed || allowed.indexOf(newStatus) &lt; 0) {</span>
<a href="#l33.764"></a><span id="l33.764" class="difflineplus">+        throw new Error(&quot;Invalid EventStatus transition &quot; + oldStatus + &quot;-&gt;&quot; +</span>
<a href="#l33.765"></a><span id="l33.765" class="difflineplus">+                        newStatus);</span>
<a href="#l33.766"></a><span id="l33.766" class="difflineplus">+    }</span>
<a href="#l33.767"></a><span id="l33.767" class="difflineplus">+</span>
<a href="#l33.768"></a><span id="l33.768" class="difflineplus">+    event.status = newStatus;</span>
<a href="#l33.769"></a><span id="l33.769" class="difflineplus">+</span>
<a href="#l33.770"></a><span id="l33.770" class="difflineplus">+    if (newStatus == EventStatus.SENT) {</span>
<a href="#l33.771"></a><span id="l33.771" class="difflineplus">+        // update the event id</span>
<a href="#l33.772"></a><span id="l33.772" class="difflineplus">+        event.event.event_id = newEventId;</span>
<a href="#l33.773"></a><span id="l33.773" class="difflineplus">+</span>
<a href="#l33.774"></a><span id="l33.774" class="difflineplus">+        // if the event was already in the timeline (which will be the case if</span>
<a href="#l33.775"></a><span id="l33.775" class="difflineplus">+        // opts.pendingEventOrdering==chronological), we need to update the</span>
<a href="#l33.776"></a><span id="l33.776" class="difflineplus">+        // timeline map.</span>
<a href="#l33.777"></a><span id="l33.777" class="difflineplus">+        for (var i = 0; i &lt; this._timelineSets.length; i++) {</span>
<a href="#l33.778"></a><span id="l33.778" class="difflineplus">+            this._timelineSets[i].replaceEventId(oldEventId, newEventId);</span>
<a href="#l33.779"></a><span id="l33.779" class="difflineplus">+        }</span>
<a href="#l33.780"></a><span id="l33.780" class="difflineplus">+    }</span>
<a href="#l33.781"></a><span id="l33.781" class="difflineplus">+    else if (newStatus == EventStatus.CANCELLED) {</span>
<a href="#l33.782"></a><span id="l33.782" class="difflineplus">+        // remove it from the pending event list, or the timeline.</span>
<a href="#l33.783"></a><span id="l33.783" class="difflineplus">+        if (this._pendingEventList) {</span>
<a href="#l33.784"></a><span id="l33.784" class="difflineplus">+            utils.removeElement(</span>
<a href="#l33.785"></a><span id="l33.785" class="difflineplus">+                this._pendingEventList,</span>
<a href="#l33.786"></a><span id="l33.786" class="difflineplus">+                function(ev) { return ev.getId() == oldEventId; },</span>
<a href="#l33.787"></a><span id="l33.787" class="difflineplus">+                false</span>
<a href="#l33.788"></a><span id="l33.788" class="difflineplus">+            );</span>
<a href="#l33.789"></a><span id="l33.789" class="difflineplus">+        }</span>
<a href="#l33.790"></a><span id="l33.790" class="difflineplus">+        this.removeEvent(oldEventId);</span>
<a href="#l33.791"></a><span id="l33.791" class="difflineplus">+    }</span>
<a href="#l33.792"></a><span id="l33.792" class="difflineplus">+</span>
<a href="#l33.793"></a><span id="l33.793" class="difflineplus">+    this.emit(&quot;Room.localEchoUpdated&quot;, event, this, event.getId(), oldStatus);</span>
<a href="#l33.794"></a><span id="l33.794" class="difflineplus">+};</span>
<a href="#l33.795"></a><span id="l33.795" class="difflineplus">+</span>
<a href="#l33.796"></a><span id="l33.796" class="difflineplus">+</span>
<a href="#l33.797"></a><span id="l33.797" class="difflineplus">+/**</span>
<a href="#l33.798"></a><span id="l33.798" class="difflineplus">+ * Add some events to this room. This can include state events, message</span>
<a href="#l33.799"></a><span id="l33.799" class="difflineplus">+ * events and typing notifications. These events are treated as &quot;live&quot; so</span>
<a href="#l33.800"></a><span id="l33.800" class="difflineplus">+ * they will go to the end of the timeline.</span>
<a href="#l33.801"></a><span id="l33.801" class="difflineplus">+ *</span>
<a href="#l33.802"></a><span id="l33.802" class="difflineplus">+ * @param {MatrixEvent[]} events A list of events to add.</span>
<a href="#l33.803"></a><span id="l33.803" class="difflineplus">+ *</span>
<a href="#l33.804"></a><span id="l33.804" class="difflineplus">+ * @param {string} duplicateStrategy Optional. Applies to events in the</span>
<a href="#l33.805"></a><span id="l33.805" class="difflineplus">+ * timeline only. If this is 'replace' then if a duplicate is encountered, the</span>
<a href="#l33.806"></a><span id="l33.806" class="difflineplus">+ * event passed to this function will replace the existing event in the</span>
<a href="#l33.807"></a><span id="l33.807" class="difflineplus">+ * timeline. If this is not specified, or is 'ignore', then the event passed to</span>
<a href="#l33.808"></a><span id="l33.808" class="difflineplus">+ * this function will be ignored entirely, preserving the existing event in the</span>
<a href="#l33.809"></a><span id="l33.809" class="difflineplus">+ * timeline. Events are identical based on their event ID &lt;b&gt;only&lt;/b&gt;.</span>
<a href="#l33.810"></a><span id="l33.810" class="difflineplus">+ *</span>
<a href="#l33.811"></a><span id="l33.811" class="difflineplus">+ * @throws If &lt;code&gt;duplicateStrategy&lt;/code&gt; is not falsey, 'replace' or 'ignore'.</span>
<a href="#l33.812"></a><span id="l33.812" class="difflineplus">+ */</span>
<a href="#l33.813"></a><span id="l33.813" class="difflineplus">+Room.prototype.addLiveEvents = function(events, duplicateStrategy) {</span>
<a href="#l33.814"></a><span id="l33.814" class="difflineplus">+    var i;</span>
<a href="#l33.815"></a><span id="l33.815" class="difflineplus">+    if (duplicateStrategy &amp;&amp; [&quot;replace&quot;, &quot;ignore&quot;].indexOf(duplicateStrategy) === -1) {</span>
<a href="#l33.816"></a><span id="l33.816" class="difflineplus">+        throw new Error(&quot;duplicateStrategy MUST be either 'replace' or 'ignore'&quot;);</span>
<a href="#l33.817"></a><span id="l33.817" class="difflineplus">+    }</span>
<a href="#l33.818"></a><span id="l33.818" class="difflineplus">+</span>
<a href="#l33.819"></a><span id="l33.819" class="difflineplus">+    // sanity check that the live timeline is still live</span>
<a href="#l33.820"></a><span id="l33.820" class="difflineplus">+    for (i = 0; i &lt; this._timelineSets.length; i++) {</span>
<a href="#l33.821"></a><span id="l33.821" class="difflineplus">+        var liveTimeline = this._timelineSets[i].getLiveTimeline();</span>
<a href="#l33.822"></a><span id="l33.822" class="difflineplus">+        if (liveTimeline.getPaginationToken(EventTimeline.FORWARDS)) {</span>
<a href="#l33.823"></a><span id="l33.823" class="difflineplus">+            throw new Error(</span>
<a href="#l33.824"></a><span id="l33.824" class="difflineplus">+                &quot;live timeline &quot; + i + &quot; is no longer live - it has a pagination token &quot; +</span>
<a href="#l33.825"></a><span id="l33.825" class="difflineplus">+                &quot;(&quot; + liveTimeline.getPaginationToken(EventTimeline.FORWARDS) + &quot;)&quot;</span>
<a href="#l33.826"></a><span id="l33.826" class="difflineplus">+            );</span>
<a href="#l33.827"></a><span id="l33.827" class="difflineplus">+        }</span>
<a href="#l33.828"></a><span id="l33.828" class="difflineplus">+        if (liveTimeline.getNeighbouringTimeline(EventTimeline.FORWARDS)) {</span>
<a href="#l33.829"></a><span id="l33.829" class="difflineplus">+            throw new Error(</span>
<a href="#l33.830"></a><span id="l33.830" class="difflineplus">+                &quot;live timeline &quot; + i + &quot; is no longer live - &quot; +</span>
<a href="#l33.831"></a><span id="l33.831" class="difflineplus">+                &quot;it has a neighbouring timeline&quot;</span>
<a href="#l33.832"></a><span id="l33.832" class="difflineplus">+            );</span>
<a href="#l33.833"></a><span id="l33.833" class="difflineplus">+        }</span>
<a href="#l33.834"></a><span id="l33.834" class="difflineplus">+    }</span>
<a href="#l33.835"></a><span id="l33.835" class="difflineplus">+</span>
<a href="#l33.836"></a><span id="l33.836" class="difflineplus">+    for (i = 0; i &lt; events.length; i++) {</span>
<a href="#l33.837"></a><span id="l33.837" class="difflineplus">+        if (events[i].getType() === &quot;m.typing&quot;) {</span>
<a href="#l33.838"></a><span id="l33.838" class="difflineplus">+            this.currentState.setTypingEvent(events[i]);</span>
<a href="#l33.839"></a><span id="l33.839" class="difflineplus">+        }</span>
<a href="#l33.840"></a><span id="l33.840" class="difflineplus">+        else if (events[i].getType() === &quot;m.receipt&quot;) {</span>
<a href="#l33.841"></a><span id="l33.841" class="difflineplus">+            this.addReceipt(events[i]);</span>
<a href="#l33.842"></a><span id="l33.842" class="difflineplus">+        }</span>
<a href="#l33.843"></a><span id="l33.843" class="difflineplus">+        // N.B. account_data is added directly by /sync to avoid</span>
<a href="#l33.844"></a><span id="l33.844" class="difflineplus">+        // having to maintain an event.isAccountData() here</span>
<a href="#l33.845"></a><span id="l33.845" class="difflineplus">+        else {</span>
<a href="#l33.846"></a><span id="l33.846" class="difflineplus">+            // TODO: We should have a filter to say &quot;only add state event</span>
<a href="#l33.847"></a><span id="l33.847" class="difflineplus">+            // types X Y Z to the timeline&quot;.</span>
<a href="#l33.848"></a><span id="l33.848" class="difflineplus">+            this._addLiveEvent(events[i], duplicateStrategy);</span>
<a href="#l33.849"></a><span id="l33.849" class="difflineplus">+        }</span>
<a href="#l33.850"></a><span id="l33.850" class="difflineplus">+    }</span>
<a href="#l33.851"></a><span id="l33.851" class="difflineplus">+};</span>
<a href="#l33.852"></a><span id="l33.852" class="difflineplus">+</span>
<a href="#l33.853"></a><span id="l33.853" class="difflineplus">+/**</span>
<a href="#l33.854"></a><span id="l33.854" class="difflineplus">+ * Removes events from this room.</span>
<a href="#l33.855"></a><span id="l33.855" class="difflineplus">+ * @param {String[]} event_ids A list of event_ids to remove.</span>
<a href="#l33.856"></a><span id="l33.856" class="difflineplus">+ */</span>
<a href="#l33.857"></a><span id="l33.857" class="difflineplus">+Room.prototype.removeEvents = function(event_ids) {</span>
<a href="#l33.858"></a><span id="l33.858" class="difflineplus">+    for (var i = 0; i &lt; event_ids.length; ++i) {</span>
<a href="#l33.859"></a><span id="l33.859" class="difflineplus">+        this.removeEvent(event_ids[i]);</span>
<a href="#l33.860"></a><span id="l33.860" class="difflineplus">+    }</span>
<a href="#l33.861"></a><span id="l33.861" class="difflineplus">+};</span>
<a href="#l33.862"></a><span id="l33.862" class="difflineplus">+</span>
<a href="#l33.863"></a><span id="l33.863" class="difflineplus">+/**</span>
<a href="#l33.864"></a><span id="l33.864" class="difflineplus">+ * Removes a single event from this room.</span>
<a href="#l33.865"></a><span id="l33.865" class="difflineplus">+ *</span>
<a href="#l33.866"></a><span id="l33.866" class="difflineplus">+ * @param {String} eventId  The id of the event to remove</span>
<a href="#l33.867"></a><span id="l33.867" class="difflineplus">+ *</span>
<a href="#l33.868"></a><span id="l33.868" class="difflineplus">+ * @return {bool} true if the event was removed from any of the room's timeline sets</span>
<a href="#l33.869"></a><span id="l33.869" class="difflineplus">+ */</span>
<a href="#l33.870"></a><span id="l33.870" class="difflineplus">+Room.prototype.removeEvent = function(eventId) {</span>
<a href="#l33.871"></a><span id="l33.871" class="difflineplus">+    var removedAny = false;</span>
<a href="#l33.872"></a><span id="l33.872" class="difflineplus">+    for (var i = 0; i &lt; this._timelineSets.length; i++) {</span>
<a href="#l33.873"></a><span id="l33.873" class="difflineplus">+        var removed = this._timelineSets[i].removeEvent(eventId);</span>
<a href="#l33.874"></a><span id="l33.874" class="difflineplus">+        if (removed) {</span>
<a href="#l33.875"></a><span id="l33.875" class="difflineplus">+            removedAny = true;</span>
<a href="#l33.876"></a><span id="l33.876" class="difflineplus">+        }</span>
<a href="#l33.877"></a><span id="l33.877" class="difflineplus">+    }</span>
<a href="#l33.878"></a><span id="l33.878" class="difflineplus">+    return removedAny;</span>
<a href="#l33.879"></a><span id="l33.879" class="difflineplus">+};</span>
<a href="#l33.880"></a><span id="l33.880" class="difflineplus">+</span>
<a href="#l33.881"></a><span id="l33.881" class="difflineplus">+</span>
<a href="#l33.882"></a><span id="l33.882" class="difflineplus">+/**</span>
<a href="#l33.883"></a><span id="l33.883" class="difflineplus">+ * Recalculate various aspects of the room, including the room name and</span>
<a href="#l33.884"></a><span id="l33.884" class="difflineplus">+ * room summary. Call this any time the room's current state is modified.</span>
<a href="#l33.885"></a><span id="l33.885" class="difflineplus">+ * May fire &quot;Room.name&quot; if the room name is updated.</span>
<a href="#l33.886"></a><span id="l33.886" class="difflineplus">+ * @param {string} userId The client's user ID.</span>
<a href="#l33.887"></a><span id="l33.887" class="difflineplus">+ * @fires module:client~MatrixClient#event:&quot;Room.name&quot;</span>
<a href="#l33.888"></a><span id="l33.888" class="difflineplus">+ */</span>
<a href="#l33.889"></a><span id="l33.889" class="difflineplus">+Room.prototype.recalculate = function(userId) {</span>
<a href="#l33.890"></a><span id="l33.890" class="difflineplus">+    // set fake stripped state events if this is an invite room so logic remains</span>
<a href="#l33.891"></a><span id="l33.891" class="difflineplus">+    // consistent elsewhere.</span>
<a href="#l33.892"></a><span id="l33.892" class="difflineplus">+    var self = this;</span>
<a href="#l33.893"></a><span id="l33.893" class="difflineplus">+    var membershipEvent = this.currentState.getStateEvents(</span>
<a href="#l33.894"></a><span id="l33.894" class="difflineplus">+        &quot;m.room.member&quot;, userId</span>
<a href="#l33.895"></a><span id="l33.895" class="difflineplus">+    );</span>
<a href="#l33.896"></a><span id="l33.896" class="difflineplus">+    if (membershipEvent &amp;&amp; membershipEvent.getContent().membership === &quot;invite&quot;) {</span>
<a href="#l33.897"></a><span id="l33.897" class="difflineplus">+        var strippedStateEvents = membershipEvent.event.invite_room_state || [];</span>
<a href="#l33.898"></a><span id="l33.898" class="difflineplus">+        utils.forEach(strippedStateEvents, function(strippedEvent) {</span>
<a href="#l33.899"></a><span id="l33.899" class="difflineplus">+            var existingEvent = self.currentState.getStateEvents(</span>
<a href="#l33.900"></a><span id="l33.900" class="difflineplus">+                strippedEvent.type, strippedEvent.state_key</span>
<a href="#l33.901"></a><span id="l33.901" class="difflineplus">+            );</span>
<a href="#l33.902"></a><span id="l33.902" class="difflineplus">+            if (!existingEvent) {</span>
<a href="#l33.903"></a><span id="l33.903" class="difflineplus">+                // set the fake stripped event instead</span>
<a href="#l33.904"></a><span id="l33.904" class="difflineplus">+                self.currentState.setStateEvents([new MatrixEvent({</span>
<a href="#l33.905"></a><span id="l33.905" class="difflineplus">+                    type: strippedEvent.type,</span>
<a href="#l33.906"></a><span id="l33.906" class="difflineplus">+                    state_key: strippedEvent.state_key,</span>
<a href="#l33.907"></a><span id="l33.907" class="difflineplus">+                    content: strippedEvent.content,</span>
<a href="#l33.908"></a><span id="l33.908" class="difflineplus">+                    event_id: &quot;$fake&quot; + Date.now(),</span>
<a href="#l33.909"></a><span id="l33.909" class="difflineplus">+                    room_id: self.roomId,</span>
<a href="#l33.910"></a><span id="l33.910" class="difflineplus">+                    user_id: userId // technically a lie</span>
<a href="#l33.911"></a><span id="l33.911" class="difflineplus">+                })]);</span>
<a href="#l33.912"></a><span id="l33.912" class="difflineplus">+            }</span>
<a href="#l33.913"></a><span id="l33.913" class="difflineplus">+        });</span>
<a href="#l33.914"></a><span id="l33.914" class="difflineplus">+    }</span>
<a href="#l33.915"></a><span id="l33.915" class="difflineplus">+</span>
<a href="#l33.916"></a><span id="l33.916" class="difflineplus">+</span>
<a href="#l33.917"></a><span id="l33.917" class="difflineplus">+</span>
<a href="#l33.918"></a><span id="l33.918" class="difflineplus">+    var oldName = this.name;</span>
<a href="#l33.919"></a><span id="l33.919" class="difflineplus">+    this.name = calculateRoomName(this, userId);</span>
<a href="#l33.920"></a><span id="l33.920" class="difflineplus">+    this.summary = new RoomSummary(this.roomId, {</span>
<a href="#l33.921"></a><span id="l33.921" class="difflineplus">+        title: this.name</span>
<a href="#l33.922"></a><span id="l33.922" class="difflineplus">+    });</span>
<a href="#l33.923"></a><span id="l33.923" class="difflineplus">+</span>
<a href="#l33.924"></a><span id="l33.924" class="difflineplus">+    if (oldName !== this.name) {</span>
<a href="#l33.925"></a><span id="l33.925" class="difflineplus">+        this.emit(&quot;Room.name&quot;, this);</span>
<a href="#l33.926"></a><span id="l33.926" class="difflineplus">+    }</span>
<a href="#l33.927"></a><span id="l33.927" class="difflineplus">+};</span>
<a href="#l33.928"></a><span id="l33.928" class="difflineplus">+</span>
<a href="#l33.929"></a><span id="l33.929" class="difflineplus">+</span>
<a href="#l33.930"></a><span id="l33.930" class="difflineplus">+/**</span>
<a href="#l33.931"></a><span id="l33.931" class="difflineplus">+ * Get a list of user IDs who have &lt;b&gt;read up to&lt;/b&gt; the given event.</span>
<a href="#l33.932"></a><span id="l33.932" class="difflineplus">+ * @param {MatrixEvent} event the event to get read receipts for.</span>
<a href="#l33.933"></a><span id="l33.933" class="difflineplus">+ * @return {String[]} A list of user IDs.</span>
<a href="#l33.934"></a><span id="l33.934" class="difflineplus">+ */</span>
<a href="#l33.935"></a><span id="l33.935" class="difflineplus">+Room.prototype.getUsersReadUpTo = function(event) {</span>
<a href="#l33.936"></a><span id="l33.936" class="difflineplus">+    return this.getReceiptsForEvent(event).filter(function(receipt) {</span>
<a href="#l33.937"></a><span id="l33.937" class="difflineplus">+        return receipt.type === &quot;m.read&quot;;</span>
<a href="#l33.938"></a><span id="l33.938" class="difflineplus">+    }).map(function(receipt) {</span>
<a href="#l33.939"></a><span id="l33.939" class="difflineplus">+        return receipt.userId;</span>
<a href="#l33.940"></a><span id="l33.940" class="difflineplus">+    });</span>
<a href="#l33.941"></a><span id="l33.941" class="difflineplus">+};</span>
<a href="#l33.942"></a><span id="l33.942" class="difflineplus">+</span>
<a href="#l33.943"></a><span id="l33.943" class="difflineplus">+/**</span>
<a href="#l33.944"></a><span id="l33.944" class="difflineplus">+ * Get the ID of the event that a given user has read up to, or null if we</span>
<a href="#l33.945"></a><span id="l33.945" class="difflineplus">+ * have received no read receipts from them.</span>
<a href="#l33.946"></a><span id="l33.946" class="difflineplus">+ * @param {String} userId The user ID to get read receipt event ID for</span>
<a href="#l33.947"></a><span id="l33.947" class="difflineplus">+ * @param {Boolean} ignoreSynthesized If true, return only receipts that have been</span>
<a href="#l33.948"></a><span id="l33.948" class="difflineplus">+ *                                    sent by the server, not implicit ones generated</span>
<a href="#l33.949"></a><span id="l33.949" class="difflineplus">+ *                                    by the JS SDK.</span>
<a href="#l33.950"></a><span id="l33.950" class="difflineplus">+ * @return {String} ID of the latest event that the given user has read, or null.</span>
<a href="#l33.951"></a><span id="l33.951" class="difflineplus">+ */</span>
<a href="#l33.952"></a><span id="l33.952" class="difflineplus">+Room.prototype.getEventReadUpTo = function(userId, ignoreSynthesized) {</span>
<a href="#l33.953"></a><span id="l33.953" class="difflineplus">+    var receipts = this._receipts;</span>
<a href="#l33.954"></a><span id="l33.954" class="difflineplus">+    if (ignoreSynthesized) {</span>
<a href="#l33.955"></a><span id="l33.955" class="difflineplus">+        receipts = this._realReceipts;</span>
<a href="#l33.956"></a><span id="l33.956" class="difflineplus">+    }</span>
<a href="#l33.957"></a><span id="l33.957" class="difflineplus">+</span>
<a href="#l33.958"></a><span id="l33.958" class="difflineplus">+    if (</span>
<a href="#l33.959"></a><span id="l33.959" class="difflineplus">+        receipts[&quot;m.read&quot;] === undefined ||</span>
<a href="#l33.960"></a><span id="l33.960" class="difflineplus">+        receipts[&quot;m.read&quot;][userId] === undefined</span>
<a href="#l33.961"></a><span id="l33.961" class="difflineplus">+    ) {</span>
<a href="#l33.962"></a><span id="l33.962" class="difflineplus">+        return null;</span>
<a href="#l33.963"></a><span id="l33.963" class="difflineplus">+    }</span>
<a href="#l33.964"></a><span id="l33.964" class="difflineplus">+</span>
<a href="#l33.965"></a><span id="l33.965" class="difflineplus">+    return receipts[&quot;m.read&quot;][userId].eventId;</span>
<a href="#l33.966"></a><span id="l33.966" class="difflineplus">+};</span>
<a href="#l33.967"></a><span id="l33.967" class="difflineplus">+</span>
<a href="#l33.968"></a><span id="l33.968" class="difflineplus">+/**</span>
<a href="#l33.969"></a><span id="l33.969" class="difflineplus">+ * Get a list of receipts for the given event.</span>
<a href="#l33.970"></a><span id="l33.970" class="difflineplus">+ * @param {MatrixEvent} event the event to get receipts for</span>
<a href="#l33.971"></a><span id="l33.971" class="difflineplus">+ * @return {Object[]} A list of receipts with a userId, type and data keys or</span>
<a href="#l33.972"></a><span id="l33.972" class="difflineplus">+ * an empty list.</span>
<a href="#l33.973"></a><span id="l33.973" class="difflineplus">+ */</span>
<a href="#l33.974"></a><span id="l33.974" class="difflineplus">+Room.prototype.getReceiptsForEvent = function(event) {</span>
<a href="#l33.975"></a><span id="l33.975" class="difflineplus">+    return this._receiptCacheByEventId[event.getId()] || [];</span>
<a href="#l33.976"></a><span id="l33.976" class="difflineplus">+};</span>
<a href="#l33.977"></a><span id="l33.977" class="difflineplus">+</span>
<a href="#l33.978"></a><span id="l33.978" class="difflineplus">+/**</span>
<a href="#l33.979"></a><span id="l33.979" class="difflineplus">+ * Add a receipt event to the room.</span>
<a href="#l33.980"></a><span id="l33.980" class="difflineplus">+ * @param {MatrixEvent} event The m.receipt event.</span>
<a href="#l33.981"></a><span id="l33.981" class="difflineplus">+ * @param {Boolean} fake True if this event is implicit</span>
<a href="#l33.982"></a><span id="l33.982" class="difflineplus">+ */</span>
<a href="#l33.983"></a><span id="l33.983" class="difflineplus">+Room.prototype.addReceipt = function(event, fake) {</span>
<a href="#l33.984"></a><span id="l33.984" class="difflineplus">+    // event content looks like:</span>
<a href="#l33.985"></a><span id="l33.985" class="difflineplus">+    // content: {</span>
<a href="#l33.986"></a><span id="l33.986" class="difflineplus">+    //   $event_id: {</span>
<a href="#l33.987"></a><span id="l33.987" class="difflineplus">+    //     $receipt_type: {</span>
<a href="#l33.988"></a><span id="l33.988" class="difflineplus">+    //       $user_id: {</span>
<a href="#l33.989"></a><span id="l33.989" class="difflineplus">+    //         ts: $timestamp</span>
<a href="#l33.990"></a><span id="l33.990" class="difflineplus">+    //       }</span>
<a href="#l33.991"></a><span id="l33.991" class="difflineplus">+    //     }</span>
<a href="#l33.992"></a><span id="l33.992" class="difflineplus">+    //   }</span>
<a href="#l33.993"></a><span id="l33.993" class="difflineplus">+    // }</span>
<a href="#l33.994"></a><span id="l33.994" class="difflineplus">+    if (fake === undefined) { fake = false; }</span>
<a href="#l33.995"></a><span id="l33.995" class="difflineplus">+    if (!fake) {</span>
<a href="#l33.996"></a><span id="l33.996" class="difflineplus">+        this._addReceiptsToStructure(event, this._realReceipts);</span>
<a href="#l33.997"></a><span id="l33.997" class="difflineplus">+        // we don't bother caching real receipts by event ID</span>
<a href="#l33.998"></a><span id="l33.998" class="difflineplus">+        // as there's nothing that would read it.</span>
<a href="#l33.999"></a><span id="l33.999" class="difflineplus">+    }</span>
<a href="#l33.1000"></a><span id="l33.1000" class="difflineplus">+    this._addReceiptsToStructure(event, this._receipts);</span>
<a href="#l33.1001"></a><span id="l33.1001" class="difflineplus">+    this._receiptCacheByEventId = this._buildReceiptCache(this._receipts);</span>
<a href="#l33.1002"></a><span id="l33.1002" class="difflineplus">+</span>
<a href="#l33.1003"></a><span id="l33.1003" class="difflineplus">+    // send events after we've regenerated the cache, otherwise things that</span>
<a href="#l33.1004"></a><span id="l33.1004" class="difflineplus">+    // listened for the event would read from a stale cache</span>
<a href="#l33.1005"></a><span id="l33.1005" class="difflineplus">+    this.emit(&quot;Room.receipt&quot;, event, this);</span>
<a href="#l33.1006"></a><span id="l33.1006" class="difflineplus">+};</span>
<a href="#l33.1007"></a><span id="l33.1007" class="difflineplus">+</span>
<a href="#l33.1008"></a><span id="l33.1008" class="difflineplus">+/**</span>
<a href="#l33.1009"></a><span id="l33.1009" class="difflineplus">+ * Add a receipt event to the room.</span>
<a href="#l33.1010"></a><span id="l33.1010" class="difflineplus">+ * @param {MatrixEvent} event The m.receipt event.</span>
<a href="#l33.1011"></a><span id="l33.1011" class="difflineplus">+ * @param {Object} receipts The object to add receipts to</span>
<a href="#l33.1012"></a><span id="l33.1012" class="difflineplus">+ */</span>
<a href="#l33.1013"></a><span id="l33.1013" class="difflineplus">+Room.prototype._addReceiptsToStructure = function(event, receipts) {</span>
<a href="#l33.1014"></a><span id="l33.1014" class="difflineplus">+    var self = this;</span>
<a href="#l33.1015"></a><span id="l33.1015" class="difflineplus">+    utils.keys(event.getContent()).forEach(function(eventId) {</span>
<a href="#l33.1016"></a><span id="l33.1016" class="difflineplus">+        utils.keys(event.getContent()[eventId]).forEach(function(receiptType) {</span>
<a href="#l33.1017"></a><span id="l33.1017" class="difflineplus">+            utils.keys(event.getContent()[eventId][receiptType]).forEach(</span>
<a href="#l33.1018"></a><span id="l33.1018" class="difflineplus">+            function(userId) {</span>
<a href="#l33.1019"></a><span id="l33.1019" class="difflineplus">+                var receipt = event.getContent()[eventId][receiptType][userId];</span>
<a href="#l33.1020"></a><span id="l33.1020" class="difflineplus">+</span>
<a href="#l33.1021"></a><span id="l33.1021" class="difflineplus">+                if (!receipts[receiptType]) {</span>
<a href="#l33.1022"></a><span id="l33.1022" class="difflineplus">+                    receipts[receiptType] = {};</span>
<a href="#l33.1023"></a><span id="l33.1023" class="difflineplus">+                }</span>
<a href="#l33.1024"></a><span id="l33.1024" class="difflineplus">+</span>
<a href="#l33.1025"></a><span id="l33.1025" class="difflineplus">+                var existingReceipt = receipts[receiptType][userId];</span>
<a href="#l33.1026"></a><span id="l33.1026" class="difflineplus">+</span>
<a href="#l33.1027"></a><span id="l33.1027" class="difflineplus">+                if (!existingReceipt) {</span>
<a href="#l33.1028"></a><span id="l33.1028" class="difflineplus">+                    receipts[receiptType][userId] = {};</span>
<a href="#l33.1029"></a><span id="l33.1029" class="difflineplus">+                } else {</span>
<a href="#l33.1030"></a><span id="l33.1030" class="difflineplus">+                    // we only want to add this receipt if we think it is later</span>
<a href="#l33.1031"></a><span id="l33.1031" class="difflineplus">+                    // than the one we already have. (This is managed</span>
<a href="#l33.1032"></a><span id="l33.1032" class="difflineplus">+                    // server-side, but because we synthesize RRs locally we</span>
<a href="#l33.1033"></a><span id="l33.1033" class="difflineplus">+                    // have to do it here too.)</span>
<a href="#l33.1034"></a><span id="l33.1034" class="difflineplus">+                    var ordering = self.getUnfilteredTimelineSet().compareEventOrdering(</span>
<a href="#l33.1035"></a><span id="l33.1035" class="difflineplus">+                        existingReceipt.eventId, eventId);</span>
<a href="#l33.1036"></a><span id="l33.1036" class="difflineplus">+                    if (ordering !== null &amp;&amp; ordering &gt;= 0) {</span>
<a href="#l33.1037"></a><span id="l33.1037" class="difflineplus">+                        return;</span>
<a href="#l33.1038"></a><span id="l33.1038" class="difflineplus">+                    }</span>
<a href="#l33.1039"></a><span id="l33.1039" class="difflineplus">+                }</span>
<a href="#l33.1040"></a><span id="l33.1040" class="difflineplus">+</span>
<a href="#l33.1041"></a><span id="l33.1041" class="difflineplus">+                receipts[receiptType][userId] = {</span>
<a href="#l33.1042"></a><span id="l33.1042" class="difflineplus">+                    eventId: eventId,</span>
<a href="#l33.1043"></a><span id="l33.1043" class="difflineplus">+                    data: receipt</span>
<a href="#l33.1044"></a><span id="l33.1044" class="difflineplus">+                };</span>
<a href="#l33.1045"></a><span id="l33.1045" class="difflineplus">+            });</span>
<a href="#l33.1046"></a><span id="l33.1046" class="difflineplus">+        });</span>
<a href="#l33.1047"></a><span id="l33.1047" class="difflineplus">+    });</span>
<a href="#l33.1048"></a><span id="l33.1048" class="difflineplus">+};</span>
<a href="#l33.1049"></a><span id="l33.1049" class="difflineplus">+</span>
<a href="#l33.1050"></a><span id="l33.1050" class="difflineplus">+/**</span>
<a href="#l33.1051"></a><span id="l33.1051" class="difflineplus">+ * Build and return a map of receipts by event ID</span>
<a href="#l33.1052"></a><span id="l33.1052" class="difflineplus">+ * @param {Object} receipts A map of receipts</span>
<a href="#l33.1053"></a><span id="l33.1053" class="difflineplus">+ * @return {Object} Map of receipts by event ID</span>
<a href="#l33.1054"></a><span id="l33.1054" class="difflineplus">+ */</span>
<a href="#l33.1055"></a><span id="l33.1055" class="difflineplus">+Room.prototype._buildReceiptCache = function(receipts) {</span>
<a href="#l33.1056"></a><span id="l33.1056" class="difflineplus">+    var receiptCacheByEventId = {};</span>
<a href="#l33.1057"></a><span id="l33.1057" class="difflineplus">+    utils.keys(receipts).forEach(function(receiptType) {</span>
<a href="#l33.1058"></a><span id="l33.1058" class="difflineplus">+        utils.keys(receipts[receiptType]).forEach(function(userId) {</span>
<a href="#l33.1059"></a><span id="l33.1059" class="difflineplus">+            var receipt = receipts[receiptType][userId];</span>
<a href="#l33.1060"></a><span id="l33.1060" class="difflineplus">+            if (!receiptCacheByEventId[receipt.eventId]) {</span>
<a href="#l33.1061"></a><span id="l33.1061" class="difflineplus">+                receiptCacheByEventId[receipt.eventId] = [];</span>
<a href="#l33.1062"></a><span id="l33.1062" class="difflineplus">+            }</span>
<a href="#l33.1063"></a><span id="l33.1063" class="difflineplus">+            receiptCacheByEventId[receipt.eventId].push({</span>
<a href="#l33.1064"></a><span id="l33.1064" class="difflineplus">+                userId: userId,</span>
<a href="#l33.1065"></a><span id="l33.1065" class="difflineplus">+                type: receiptType,</span>
<a href="#l33.1066"></a><span id="l33.1066" class="difflineplus">+                data: receipt.data</span>
<a href="#l33.1067"></a><span id="l33.1067" class="difflineplus">+            });</span>
<a href="#l33.1068"></a><span id="l33.1068" class="difflineplus">+        });</span>
<a href="#l33.1069"></a><span id="l33.1069" class="difflineplus">+    });</span>
<a href="#l33.1070"></a><span id="l33.1070" class="difflineplus">+    return receiptCacheByEventId;</span>
<a href="#l33.1071"></a><span id="l33.1071" class="difflineplus">+};</span>
<a href="#l33.1072"></a><span id="l33.1072" class="difflineplus">+</span>
<a href="#l33.1073"></a><span id="l33.1073" class="difflineplus">+</span>
<a href="#l33.1074"></a><span id="l33.1074" class="difflineplus">+/**</span>
<a href="#l33.1075"></a><span id="l33.1075" class="difflineplus">+ * Add a temporary local-echo receipt to the room to reflect in the</span>
<a href="#l33.1076"></a><span id="l33.1076" class="difflineplus">+ * client the fact that we've sent one.</span>
<a href="#l33.1077"></a><span id="l33.1077" class="difflineplus">+ * @param {string} userId The user ID if the receipt sender</span>
<a href="#l33.1078"></a><span id="l33.1078" class="difflineplus">+ * @param {MatrixEvent} e The event that is to be acknowledged</span>
<a href="#l33.1079"></a><span id="l33.1079" class="difflineplus">+ * @param {string} receiptType The type of receipt</span>
<a href="#l33.1080"></a><span id="l33.1080" class="difflineplus">+ */</span>
<a href="#l33.1081"></a><span id="l33.1081" class="difflineplus">+Room.prototype._addLocalEchoReceipt = function(userId, e, receiptType) {</span>
<a href="#l33.1082"></a><span id="l33.1082" class="difflineplus">+    this.addReceipt(synthesizeReceipt(userId, e, receiptType), true);</span>
<a href="#l33.1083"></a><span id="l33.1083" class="difflineplus">+};</span>
<a href="#l33.1084"></a><span id="l33.1084" class="difflineplus">+</span>
<a href="#l33.1085"></a><span id="l33.1085" class="difflineplus">+/**</span>
<a href="#l33.1086"></a><span id="l33.1086" class="difflineplus">+ * Update the room-tag event for the room.  The previous one is overwritten.</span>
<a href="#l33.1087"></a><span id="l33.1087" class="difflineplus">+ * @param {MatrixEvent} event the m.tag event</span>
<a href="#l33.1088"></a><span id="l33.1088" class="difflineplus">+ */</span>
<a href="#l33.1089"></a><span id="l33.1089" class="difflineplus">+Room.prototype.addTags = function(event) {</span>
<a href="#l33.1090"></a><span id="l33.1090" class="difflineplus">+    // event content looks like:</span>
<a href="#l33.1091"></a><span id="l33.1091" class="difflineplus">+    // content: {</span>
<a href="#l33.1092"></a><span id="l33.1092" class="difflineplus">+    //    tags: {</span>
<a href="#l33.1093"></a><span id="l33.1093" class="difflineplus">+    //       $tagName: { $metadata: $value },</span>
<a href="#l33.1094"></a><span id="l33.1094" class="difflineplus">+    //       $tagName: { $metadata: $value },</span>
<a href="#l33.1095"></a><span id="l33.1095" class="difflineplus">+    //    }</span>
<a href="#l33.1096"></a><span id="l33.1096" class="difflineplus">+    // }</span>
<a href="#l33.1097"></a><span id="l33.1097" class="difflineplus">+</span>
<a href="#l33.1098"></a><span id="l33.1098" class="difflineplus">+    // XXX: do we need to deep copy here?</span>
<a href="#l33.1099"></a><span id="l33.1099" class="difflineplus">+    this.tags = event.getContent().tags;</span>
<a href="#l33.1100"></a><span id="l33.1100" class="difflineplus">+</span>
<a href="#l33.1101"></a><span id="l33.1101" class="difflineplus">+    // XXX: we could do a deep-comparison to see if the tags have really</span>
<a href="#l33.1102"></a><span id="l33.1102" class="difflineplus">+    // changed - but do we want to bother?</span>
<a href="#l33.1103"></a><span id="l33.1103" class="difflineplus">+    this.emit(&quot;Room.tags&quot;, event, this);</span>
<a href="#l33.1104"></a><span id="l33.1104" class="difflineplus">+};</span>
<a href="#l33.1105"></a><span id="l33.1105" class="difflineplus">+</span>
<a href="#l33.1106"></a><span id="l33.1106" class="difflineplus">+/**</span>
<a href="#l33.1107"></a><span id="l33.1107" class="difflineplus">+ * Update the account_data events for this room, overwriting events of the same type.</span>
<a href="#l33.1108"></a><span id="l33.1108" class="difflineplus">+ * @param {Array&lt;MatrixEvent&gt;} events an array of account_data events to add</span>
<a href="#l33.1109"></a><span id="l33.1109" class="difflineplus">+ */</span>
<a href="#l33.1110"></a><span id="l33.1110" class="difflineplus">+Room.prototype.addAccountData = function(events) {</span>
<a href="#l33.1111"></a><span id="l33.1111" class="difflineplus">+    for (var i = 0; i &lt; events.length; i++) {</span>
<a href="#l33.1112"></a><span id="l33.1112" class="difflineplus">+        var event = events[i];</span>
<a href="#l33.1113"></a><span id="l33.1113" class="difflineplus">+        if (event.getType() === &quot;m.tag&quot;) {</span>
<a href="#l33.1114"></a><span id="l33.1114" class="difflineplus">+            this.addTags(event);</span>
<a href="#l33.1115"></a><span id="l33.1115" class="difflineplus">+        }</span>
<a href="#l33.1116"></a><span id="l33.1116" class="difflineplus">+        this.accountData[event.getType()] = event;</span>
<a href="#l33.1117"></a><span id="l33.1117" class="difflineplus">+        this.emit(&quot;Room.accountData&quot;, event, this);</span>
<a href="#l33.1118"></a><span id="l33.1118" class="difflineplus">+    }</span>
<a href="#l33.1119"></a><span id="l33.1119" class="difflineplus">+};</span>
<a href="#l33.1120"></a><span id="l33.1120" class="difflineplus">+</span>
<a href="#l33.1121"></a><span id="l33.1121" class="difflineplus">+/**</span>
<a href="#l33.1122"></a><span id="l33.1122" class="difflineplus">+ * Access account_data event of given event type for this room</span>
<a href="#l33.1123"></a><span id="l33.1123" class="difflineplus">+ * @param {string} type the type of account_data event to be accessed</span>
<a href="#l33.1124"></a><span id="l33.1124" class="difflineplus">+ * @return {?MatrixEvent} the account_data event in question</span>
<a href="#l33.1125"></a><span id="l33.1125" class="difflineplus">+ */</span>
<a href="#l33.1126"></a><span id="l33.1126" class="difflineplus">+Room.prototype.getAccountData = function(type) {</span>
<a href="#l33.1127"></a><span id="l33.1127" class="difflineplus">+    return this.accountData[type];</span>
<a href="#l33.1128"></a><span id="l33.1128" class="difflineplus">+};</span>
<a href="#l33.1129"></a><span id="l33.1129" class="difflineplus">+</span>
<a href="#l33.1130"></a><span id="l33.1130" class="difflineplus">+/**</span>
<a href="#l33.1131"></a><span id="l33.1131" class="difflineplus">+ * This is an internal method. Calculates the name of the room from the current</span>
<a href="#l33.1132"></a><span id="l33.1132" class="difflineplus">+ * room state.</span>
<a href="#l33.1133"></a><span id="l33.1133" class="difflineplus">+ * @param {Room} room The matrix room.</span>
<a href="#l33.1134"></a><span id="l33.1134" class="difflineplus">+ * @param {string} userId The client's user ID. Used to filter room members</span>
<a href="#l33.1135"></a><span id="l33.1135" class="difflineplus">+ * correctly.</span>
<a href="#l33.1136"></a><span id="l33.1136" class="difflineplus">+ * @param {bool} ignoreRoomNameEvent Return the implicit room name that we'd see if there</span>
<a href="#l33.1137"></a><span id="l33.1137" class="difflineplus">+ * was no m.room.name event.</span>
<a href="#l33.1138"></a><span id="l33.1138" class="difflineplus">+ * @return {string} The calculated room name.</span>
<a href="#l33.1139"></a><span id="l33.1139" class="difflineplus">+ */</span>
<a href="#l33.1140"></a><span id="l33.1140" class="difflineplus">+function calculateRoomName(room, userId, ignoreRoomNameEvent) {</span>
<a href="#l33.1141"></a><span id="l33.1141" class="difflineplus">+    if (!ignoreRoomNameEvent) {</span>
<a href="#l33.1142"></a><span id="l33.1142" class="difflineplus">+        // check for an alias, if any. for now, assume first alias is the</span>
<a href="#l33.1143"></a><span id="l33.1143" class="difflineplus">+        // official one.</span>
<a href="#l33.1144"></a><span id="l33.1144" class="difflineplus">+        var mRoomName = room.currentState.getStateEvents(&quot;m.room.name&quot;, &quot;&quot;);</span>
<a href="#l33.1145"></a><span id="l33.1145" class="difflineplus">+        if (mRoomName &amp;&amp; mRoomName.getContent() &amp;&amp; mRoomName.getContent().name) {</span>
<a href="#l33.1146"></a><span id="l33.1146" class="difflineplus">+            return mRoomName.getContent().name;</span>
<a href="#l33.1147"></a><span id="l33.1147" class="difflineplus">+        }</span>
<a href="#l33.1148"></a><span id="l33.1148" class="difflineplus">+    }</span>
<a href="#l33.1149"></a><span id="l33.1149" class="difflineplus">+</span>
<a href="#l33.1150"></a><span id="l33.1150" class="difflineplus">+    var alias = room.getCanonicalAlias();</span>
<a href="#l33.1151"></a><span id="l33.1151" class="difflineplus">+</span>
<a href="#l33.1152"></a><span id="l33.1152" class="difflineplus">+    if (!alias) {</span>
<a href="#l33.1153"></a><span id="l33.1153" class="difflineplus">+        var aliases = room.getAliases();</span>
<a href="#l33.1154"></a><span id="l33.1154" class="difflineplus">+</span>
<a href="#l33.1155"></a><span id="l33.1155" class="difflineplus">+        if (aliases.length) {</span>
<a href="#l33.1156"></a><span id="l33.1156" class="difflineplus">+            alias = aliases[0];</span>
<a href="#l33.1157"></a><span id="l33.1157" class="difflineplus">+        }</span>
<a href="#l33.1158"></a><span id="l33.1158" class="difflineplus">+    }</span>
<a href="#l33.1159"></a><span id="l33.1159" class="difflineplus">+    if (alias) {</span>
<a href="#l33.1160"></a><span id="l33.1160" class="difflineplus">+        return alias;</span>
<a href="#l33.1161"></a><span id="l33.1161" class="difflineplus">+    }</span>
<a href="#l33.1162"></a><span id="l33.1162" class="difflineplus">+</span>
<a href="#l33.1163"></a><span id="l33.1163" class="difflineplus">+    // get members that are NOT ourselves and are actually in the room.</span>
<a href="#l33.1164"></a><span id="l33.1164" class="difflineplus">+    var otherMembers = utils.filter(room.currentState.getMembers(), function(m) {</span>
<a href="#l33.1165"></a><span id="l33.1165" class="difflineplus">+        return (m.userId !== userId &amp;&amp; m.membership !== &quot;leave&quot;);</span>
<a href="#l33.1166"></a><span id="l33.1166" class="difflineplus">+    });</span>
<a href="#l33.1167"></a><span id="l33.1167" class="difflineplus">+    var allMembers = utils.filter(room.currentState.getMembers(), function(m) {</span>
<a href="#l33.1168"></a><span id="l33.1168" class="difflineplus">+        return (m.membership !== &quot;leave&quot;);</span>
<a href="#l33.1169"></a><span id="l33.1169" class="difflineplus">+    });</span>
<a href="#l33.1170"></a><span id="l33.1170" class="difflineplus">+    var myMemberEventArray = utils.filter(room.currentState.getMembers(), function(m) {</span>
<a href="#l33.1171"></a><span id="l33.1171" class="difflineplus">+        return (m.userId == userId);</span>
<a href="#l33.1172"></a><span id="l33.1172" class="difflineplus">+    });</span>
<a href="#l33.1173"></a><span id="l33.1173" class="difflineplus">+    var myMemberEvent = (</span>
<a href="#l33.1174"></a><span id="l33.1174" class="difflineplus">+        (myMemberEventArray.length &amp;&amp; myMemberEventArray[0].events) ?</span>
<a href="#l33.1175"></a><span id="l33.1175" class="difflineplus">+            myMemberEventArray[0].events.member.event : undefined</span>
<a href="#l33.1176"></a><span id="l33.1176" class="difflineplus">+    );</span>
<a href="#l33.1177"></a><span id="l33.1177" class="difflineplus">+</span>
<a href="#l33.1178"></a><span id="l33.1178" class="difflineplus">+    // TODO: Localisation</span>
<a href="#l33.1179"></a><span id="l33.1179" class="difflineplus">+    if (myMemberEvent &amp;&amp; myMemberEvent.content.membership == &quot;invite&quot;) {</span>
<a href="#l33.1180"></a><span id="l33.1180" class="difflineplus">+        if (room.currentState.getMember(myMemberEvent.sender)) {</span>
<a href="#l33.1181"></a><span id="l33.1181" class="difflineplus">+            // extract who invited us to the room</span>
<a href="#l33.1182"></a><span id="l33.1182" class="difflineplus">+            return &quot;Invite from &quot; + room.currentState.getMember(</span>
<a href="#l33.1183"></a><span id="l33.1183" class="difflineplus">+                myMemberEvent.sender</span>
<a href="#l33.1184"></a><span id="l33.1184" class="difflineplus">+            ).name;</span>
<a href="#l33.1185"></a><span id="l33.1185" class="difflineplus">+        } else if (allMembers[0].events.member) {</span>
<a href="#l33.1186"></a><span id="l33.1186" class="difflineplus">+            // use the sender field from the invite event, although this only</span>
<a href="#l33.1187"></a><span id="l33.1187" class="difflineplus">+            // gets us the mxid</span>
<a href="#l33.1188"></a><span id="l33.1188" class="difflineplus">+            return &quot;Invite from &quot; + myMemberEvent.sender;</span>
<a href="#l33.1189"></a><span id="l33.1189" class="difflineplus">+        } else {</span>
<a href="#l33.1190"></a><span id="l33.1190" class="difflineplus">+            return &quot;Room Invite&quot;;</span>
<a href="#l33.1191"></a><span id="l33.1191" class="difflineplus">+        }</span>
<a href="#l33.1192"></a><span id="l33.1192" class="difflineplus">+    }</span>
<a href="#l33.1193"></a><span id="l33.1193" class="difflineplus">+</span>
<a href="#l33.1194"></a><span id="l33.1194" class="difflineplus">+</span>
<a href="#l33.1195"></a><span id="l33.1195" class="difflineplus">+    if (otherMembers.length === 0) {</span>
<a href="#l33.1196"></a><span id="l33.1196" class="difflineplus">+        if (allMembers.length === 1) {</span>
<a href="#l33.1197"></a><span id="l33.1197" class="difflineplus">+            // self-chat, peeked room with 1 participant,</span>
<a href="#l33.1198"></a><span id="l33.1198" class="difflineplus">+            // or inbound invite, or outbound 3PID invite.</span>
<a href="#l33.1199"></a><span id="l33.1199" class="difflineplus">+            if (allMembers[0].userId === userId) {</span>
<a href="#l33.1200"></a><span id="l33.1200" class="difflineplus">+                var thirdPartyInvites =</span>
<a href="#l33.1201"></a><span id="l33.1201" class="difflineplus">+                    room.currentState.getStateEvents(&quot;m.room.third_party_invite&quot;);</span>
<a href="#l33.1202"></a><span id="l33.1202" class="difflineplus">+                if (thirdPartyInvites &amp;&amp; thirdPartyInvites.length &gt; 0) {</span>
<a href="#l33.1203"></a><span id="l33.1203" class="difflineplus">+                    var name = &quot;Inviting &quot; +</span>
<a href="#l33.1204"></a><span id="l33.1204" class="difflineplus">+                               thirdPartyInvites[0].getContent().display_name;</span>
<a href="#l33.1205"></a><span id="l33.1205" class="difflineplus">+                    if (thirdPartyInvites.length &gt; 1) {</span>
<a href="#l33.1206"></a><span id="l33.1206" class="difflineplus">+                        if (thirdPartyInvites.length == 2) {</span>
<a href="#l33.1207"></a><span id="l33.1207" class="difflineplus">+                            name += &quot; and &quot; +</span>
<a href="#l33.1208"></a><span id="l33.1208" class="difflineplus">+                                    thirdPartyInvites[1].getContent().display_name;</span>
<a href="#l33.1209"></a><span id="l33.1209" class="difflineplus">+                        }</span>
<a href="#l33.1210"></a><span id="l33.1210" class="difflineplus">+                        else {</span>
<a href="#l33.1211"></a><span id="l33.1211" class="difflineplus">+                            name += &quot; and &quot; +</span>
<a href="#l33.1212"></a><span id="l33.1212" class="difflineplus">+                                    thirdPartyInvites.length + &quot; others&quot;;</span>
<a href="#l33.1213"></a><span id="l33.1213" class="difflineplus">+                        }</span>
<a href="#l33.1214"></a><span id="l33.1214" class="difflineplus">+                    }</span>
<a href="#l33.1215"></a><span id="l33.1215" class="difflineplus">+                    return name;</span>
<a href="#l33.1216"></a><span id="l33.1216" class="difflineplus">+                }</span>
<a href="#l33.1217"></a><span id="l33.1217" class="difflineplus">+                else {</span>
<a href="#l33.1218"></a><span id="l33.1218" class="difflineplus">+                    return &quot;Empty room&quot;;</span>
<a href="#l33.1219"></a><span id="l33.1219" class="difflineplus">+                }</span>
<a href="#l33.1220"></a><span id="l33.1220" class="difflineplus">+            }</span>
<a href="#l33.1221"></a><span id="l33.1221" class="difflineplus">+            else {</span>
<a href="#l33.1222"></a><span id="l33.1222" class="difflineplus">+                return allMembers[0].name;</span>
<a href="#l33.1223"></a><span id="l33.1223" class="difflineplus">+            }</span>
<a href="#l33.1224"></a><span id="l33.1224" class="difflineplus">+        }</span>
<a href="#l33.1225"></a><span id="l33.1225" class="difflineplus">+        else {</span>
<a href="#l33.1226"></a><span id="l33.1226" class="difflineplus">+            // there really isn't anyone in this room...</span>
<a href="#l33.1227"></a><span id="l33.1227" class="difflineplus">+            return &quot;Empty room&quot;;</span>
<a href="#l33.1228"></a><span id="l33.1228" class="difflineplus">+        }</span>
<a href="#l33.1229"></a><span id="l33.1229" class="difflineplus">+    }</span>
<a href="#l33.1230"></a><span id="l33.1230" class="difflineplus">+    else if (otherMembers.length === 1) {</span>
<a href="#l33.1231"></a><span id="l33.1231" class="difflineplus">+        return otherMembers[0].name;</span>
<a href="#l33.1232"></a><span id="l33.1232" class="difflineplus">+    }</span>
<a href="#l33.1233"></a><span id="l33.1233" class="difflineplus">+    else if (otherMembers.length === 2) {</span>
<a href="#l33.1234"></a><span id="l33.1234" class="difflineplus">+        return (</span>
<a href="#l33.1235"></a><span id="l33.1235" class="difflineplus">+            otherMembers[0].name + &quot; and &quot; + otherMembers[1].name</span>
<a href="#l33.1236"></a><span id="l33.1236" class="difflineplus">+        );</span>
<a href="#l33.1237"></a><span id="l33.1237" class="difflineplus">+    }</span>
<a href="#l33.1238"></a><span id="l33.1238" class="difflineplus">+    else {</span>
<a href="#l33.1239"></a><span id="l33.1239" class="difflineplus">+        return (</span>
<a href="#l33.1240"></a><span id="l33.1240" class="difflineplus">+            otherMembers[0].name + &quot; and &quot; + (otherMembers.length - 1) + &quot; others&quot;</span>
<a href="#l33.1241"></a><span id="l33.1241" class="difflineplus">+        );</span>
<a href="#l33.1242"></a><span id="l33.1242" class="difflineplus">+    }</span>
<a href="#l33.1243"></a><span id="l33.1243" class="difflineplus">+}</span>
<a href="#l33.1244"></a><span id="l33.1244" class="difflineplus">+</span>
<a href="#l33.1245"></a><span id="l33.1245" class="difflineplus">+// FIXME: copypasted from sync.js</span>
<a href="#l33.1246"></a><span id="l33.1246" class="difflineplus">+function reEmit(reEmitEntity, emittableEntity, eventNames) {</span>
<a href="#l33.1247"></a><span id="l33.1247" class="difflineplus">+    utils.forEach(eventNames, function(eventName) {</span>
<a href="#l33.1248"></a><span id="l33.1248" class="difflineplus">+        // setup a listener on the entity (the Room, User, etc) for this event</span>
<a href="#l33.1249"></a><span id="l33.1249" class="difflineplus">+        emittableEntity.on(eventName, function() {</span>
<a href="#l33.1250"></a><span id="l33.1250" class="difflineplus">+            // take the args from the listener and reuse them, adding the</span>
<a href="#l33.1251"></a><span id="l33.1251" class="difflineplus">+            // event name to the arg list so it works with .emit()</span>
<a href="#l33.1252"></a><span id="l33.1252" class="difflineplus">+            // Transformation Example:</span>
<a href="#l33.1253"></a><span id="l33.1253" class="difflineplus">+            // listener on &quot;foo&quot; =&gt; function(a,b) { ... }</span>
<a href="#l33.1254"></a><span id="l33.1254" class="difflineplus">+            // Re-emit on &quot;thing&quot; =&gt; thing.emit(&quot;foo&quot;, a, b)</span>
<a href="#l33.1255"></a><span id="l33.1255" class="difflineplus">+            var newArgs = [eventName];</span>
<a href="#l33.1256"></a><span id="l33.1256" class="difflineplus">+            for (var i = 0; i &lt; arguments.length; i++) {</span>
<a href="#l33.1257"></a><span id="l33.1257" class="difflineplus">+                newArgs.push(arguments[i]);</span>
<a href="#l33.1258"></a><span id="l33.1258" class="difflineplus">+            }</span>
<a href="#l33.1259"></a><span id="l33.1259" class="difflineplus">+            reEmitEntity.emit.apply(reEmitEntity, newArgs);</span>
<a href="#l33.1260"></a><span id="l33.1260" class="difflineplus">+        });</span>
<a href="#l33.1261"></a><span id="l33.1261" class="difflineplus">+    });</span>
<a href="#l33.1262"></a><span id="l33.1262" class="difflineplus">+}</span>
<a href="#l33.1263"></a><span id="l33.1263" class="difflineplus">+</span>
<a href="#l33.1264"></a><span id="l33.1264" class="difflineplus">+/**</span>
<a href="#l33.1265"></a><span id="l33.1265" class="difflineplus">+ * The Room class.</span>
<a href="#l33.1266"></a><span id="l33.1266" class="difflineplus">+ */</span>
<a href="#l33.1267"></a><span id="l33.1267" class="difflineplus">+module.exports = Room;</span>
<a href="#l33.1268"></a><span id="l33.1268" class="difflineplus">+</span>
<a href="#l33.1269"></a><span id="l33.1269" class="difflineplus">+/**</span>
<a href="#l33.1270"></a><span id="l33.1270" class="difflineplus">+ * Fires when an event we had previously received is redacted.</span>
<a href="#l33.1271"></a><span id="l33.1271" class="difflineplus">+ *</span>
<a href="#l33.1272"></a><span id="l33.1272" class="difflineplus">+ * (Note this is *not* fired when the redaction happens before we receive the</span>
<a href="#l33.1273"></a><span id="l33.1273" class="difflineplus">+ * event).</span>
<a href="#l33.1274"></a><span id="l33.1274" class="difflineplus">+ *</span>
<a href="#l33.1275"></a><span id="l33.1275" class="difflineplus">+ * @event module:client~MatrixClient#&quot;Room.redaction&quot;</span>
<a href="#l33.1276"></a><span id="l33.1276" class="difflineplus">+ * @param {MatrixEvent} event The matrix event which was redacted</span>
<a href="#l33.1277"></a><span id="l33.1277" class="difflineplus">+ * @param {Room} room The room containing the redacted event</span>
<a href="#l33.1278"></a><span id="l33.1278" class="difflineplus">+ */</span>
<a href="#l33.1279"></a><span id="l33.1279" class="difflineplus">+</span>
<a href="#l33.1280"></a><span id="l33.1280" class="difflineplus">+/**</span>
<a href="#l33.1281"></a><span id="l33.1281" class="difflineplus">+ * Fires whenever the name of a room is updated.</span>
<a href="#l33.1282"></a><span id="l33.1282" class="difflineplus">+ * @event module:client~MatrixClient#&quot;Room.name&quot;</span>
<a href="#l33.1283"></a><span id="l33.1283" class="difflineplus">+ * @param {Room} room The room whose Room.name was updated.</span>
<a href="#l33.1284"></a><span id="l33.1284" class="difflineplus">+ * @example</span>
<a href="#l33.1285"></a><span id="l33.1285" class="difflineplus">+ * matrixClient.on(&quot;Room.name&quot;, function(room){</span>
<a href="#l33.1286"></a><span id="l33.1286" class="difflineplus">+ *   var newName = room.name;</span>
<a href="#l33.1287"></a><span id="l33.1287" class="difflineplus">+ * });</span>
<a href="#l33.1288"></a><span id="l33.1288" class="difflineplus">+ */</span>
<a href="#l33.1289"></a><span id="l33.1289" class="difflineplus">+</span>
<a href="#l33.1290"></a><span id="l33.1290" class="difflineplus">+/**</span>
<a href="#l33.1291"></a><span id="l33.1291" class="difflineplus">+ * Fires whenever a receipt is received for a room</span>
<a href="#l33.1292"></a><span id="l33.1292" class="difflineplus">+ * @event module:client~MatrixClient#&quot;Room.receipt&quot;</span>
<a href="#l33.1293"></a><span id="l33.1293" class="difflineplus">+ * @param {event} event The receipt event</span>
<a href="#l33.1294"></a><span id="l33.1294" class="difflineplus">+ * @param {Room} room The room whose receipts was updated.</span>
<a href="#l33.1295"></a><span id="l33.1295" class="difflineplus">+ * @example</span>
<a href="#l33.1296"></a><span id="l33.1296" class="difflineplus">+ * matrixClient.on(&quot;Room.receipt&quot;, function(event, room){</span>
<a href="#l33.1297"></a><span id="l33.1297" class="difflineplus">+ *   var receiptContent = event.getContent();</span>
<a href="#l33.1298"></a><span id="l33.1298" class="difflineplus">+ * });</span>
<a href="#l33.1299"></a><span id="l33.1299" class="difflineplus">+ */</span>
<a href="#l33.1300"></a><span id="l33.1300" class="difflineplus">+</span>
<a href="#l33.1301"></a><span id="l33.1301" class="difflineplus">+/**</span>
<a href="#l33.1302"></a><span id="l33.1302" class="difflineplus">+ * Fires whenever a room's tags are updated.</span>
<a href="#l33.1303"></a><span id="l33.1303" class="difflineplus">+ * @event module:client~MatrixClient#&quot;Room.tags&quot;</span>
<a href="#l33.1304"></a><span id="l33.1304" class="difflineplus">+ * @param {event} event The tags event</span>
<a href="#l33.1305"></a><span id="l33.1305" class="difflineplus">+ * @param {Room} room The room whose Room.tags was updated.</span>
<a href="#l33.1306"></a><span id="l33.1306" class="difflineplus">+ * @example</span>
<a href="#l33.1307"></a><span id="l33.1307" class="difflineplus">+ * matrixClient.on(&quot;Room.tags&quot;, function(event, room){</span>
<a href="#l33.1308"></a><span id="l33.1308" class="difflineplus">+ *   var newTags = event.getContent().tags;</span>
<a href="#l33.1309"></a><span id="l33.1309" class="difflineplus">+ *   if (newTags[&quot;favourite&quot;]) showStar(room);</span>
<a href="#l33.1310"></a><span id="l33.1310" class="difflineplus">+ * });</span>
<a href="#l33.1311"></a><span id="l33.1311" class="difflineplus">+ */</span>
<a href="#l33.1312"></a><span id="l33.1312" class="difflineplus">+</span>
<a href="#l33.1313"></a><span id="l33.1313" class="difflineplus">+/**</span>
<a href="#l33.1314"></a><span id="l33.1314" class="difflineplus">+ * Fires whenever a room's account_data is updated.</span>
<a href="#l33.1315"></a><span id="l33.1315" class="difflineplus">+ * @event module:client~MatrixClient#&quot;Room.accountData&quot;</span>
<a href="#l33.1316"></a><span id="l33.1316" class="difflineplus">+ * @param {event} event The account_data event</span>
<a href="#l33.1317"></a><span id="l33.1317" class="difflineplus">+ * @param {Room} room The room whose account_data was updated.</span>
<a href="#l33.1318"></a><span id="l33.1318" class="difflineplus">+ * @example</span>
<a href="#l33.1319"></a><span id="l33.1319" class="difflineplus">+ * matrixClient.on(&quot;Room.accountData&quot;, function(event, room){</span>
<a href="#l33.1320"></a><span id="l33.1320" class="difflineplus">+ *   if (event.getType() === &quot;m.room.colorscheme&quot;) {</span>
<a href="#l33.1321"></a><span id="l33.1321" class="difflineplus">+ *       applyColorScheme(event.getContents());</span>
<a href="#l33.1322"></a><span id="l33.1322" class="difflineplus">+ *   }</span>
<a href="#l33.1323"></a><span id="l33.1323" class="difflineplus">+ * });</span>
<a href="#l33.1324"></a><span id="l33.1324" class="difflineplus">+ */</span>
<a href="#l33.1325"></a><span id="l33.1325" class="difflineplus">+</span>
<a href="#l33.1326"></a><span id="l33.1326" class="difflineplus">+/**</span>
<a href="#l33.1327"></a><span id="l33.1327" class="difflineplus">+ * Fires when the status of a transmitted event is updated.</span>
<a href="#l33.1328"></a><span id="l33.1328" class="difflineplus">+ *</span>
<a href="#l33.1329"></a><span id="l33.1329" class="difflineplus">+ * &lt;p&gt;When an event is first transmitted, a temporary copy of the event is</span>
<a href="#l33.1330"></a><span id="l33.1330" class="difflineplus">+ * inserted into the timeline, with a temporary event id, and a status of</span>
<a href="#l33.1331"></a><span id="l33.1331" class="difflineplus">+ * 'SENDING'.</span>
<a href="#l33.1332"></a><span id="l33.1332" class="difflineplus">+ *</span>
<a href="#l33.1333"></a><span id="l33.1333" class="difflineplus">+ * &lt;p&gt;Once the echo comes back from the server, the content of the event</span>
<a href="#l33.1334"></a><span id="l33.1334" class="difflineplus">+ * (MatrixEvent.event) is replaced by the complete event from the homeserver,</span>
<a href="#l33.1335"></a><span id="l33.1335" class="difflineplus">+ * thus updating its event id, as well as server-generated fields such as the</span>
<a href="#l33.1336"></a><span id="l33.1336" class="difflineplus">+ * timestamp. Its status is set to null.</span>
<a href="#l33.1337"></a><span id="l33.1337" class="difflineplus">+ *</span>
<a href="#l33.1338"></a><span id="l33.1338" class="difflineplus">+ * &lt;p&gt;Once the /send request completes, if the remote echo has not already</span>
<a href="#l33.1339"></a><span id="l33.1339" class="difflineplus">+ * arrived, the event is updated with a new event id and the status is set to</span>
<a href="#l33.1340"></a><span id="l33.1340" class="difflineplus">+ * 'SENT'. The server-generated fields are of course not updated yet.</span>
<a href="#l33.1341"></a><span id="l33.1341" class="difflineplus">+ *</span>
<a href="#l33.1342"></a><span id="l33.1342" class="difflineplus">+ * &lt;p&gt;If the /send fails, In this case, the event's status is set to</span>
<a href="#l33.1343"></a><span id="l33.1343" class="difflineplus">+ * 'NOT_SENT'. If it is later resent, the process starts again, setting the</span>
<a href="#l33.1344"></a><span id="l33.1344" class="difflineplus">+ * status to 'SENDING'. Alternatively, the message may be cancelled, which</span>
<a href="#l33.1345"></a><span id="l33.1345" class="difflineplus">+ * removes the event from the room, and sets the status to 'CANCELLED'.</span>
<a href="#l33.1346"></a><span id="l33.1346" class="difflineplus">+ *</span>
<a href="#l33.1347"></a><span id="l33.1347" class="difflineplus">+ * &lt;p&gt;This event is raised to reflect each of the transitions above.</span>
<a href="#l33.1348"></a><span id="l33.1348" class="difflineplus">+ *</span>
<a href="#l33.1349"></a><span id="l33.1349" class="difflineplus">+ * @event module:client~MatrixClient#&quot;Room.localEchoUpdated&quot;</span>
<a href="#l33.1350"></a><span id="l33.1350" class="difflineplus">+ *</span>
<a href="#l33.1351"></a><span id="l33.1351" class="difflineplus">+ * @param {MatrixEvent} event The matrix event which has been updated</span>
<a href="#l33.1352"></a><span id="l33.1352" class="difflineplus">+ *</span>
<a href="#l33.1353"></a><span id="l33.1353" class="difflineplus">+ * @param {Room} room The room containing the redacted event</span>
<a href="#l33.1354"></a><span id="l33.1354" class="difflineplus">+ *</span>
<a href="#l33.1355"></a><span id="l33.1355" class="difflineplus">+ * @param {string} oldEventId The previous event id (the temporary event id,</span>
<a href="#l33.1356"></a><span id="l33.1356" class="difflineplus">+ *    except when updating a successfully-sent event when its echo arrives)</span>
<a href="#l33.1357"></a><span id="l33.1357" class="difflineplus">+ *</span>
<a href="#l33.1358"></a><span id="l33.1358" class="difflineplus">+ * @param {EventStatus} oldStatus The previous event status.</span>
<a href="#l33.1359"></a><span id="l33.1359" class="difflineplus">+ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l34.1"></a><span id="l34.1">new file mode 100644</span>
<a href="#l34.2"></a><span id="l34.2" class="difflineminus">--- /dev/null</span>
<a href="#l34.3"></a><span id="l34.3" class="difflineplus">+++ b/chat/protocols/matrix/matrix-sdk/models/search-result.js</span>
<a href="#l34.4"></a><span id="l34.4" class="difflineat">@@ -0,0 +1,66 @@</span>
<a href="#l34.5"></a><span id="l34.5" class="difflineplus">+/*</span>
<a href="#l34.6"></a><span id="l34.6" class="difflineplus">+Copyright 2015, 2016 OpenMarket Ltd</span>
<a href="#l34.7"></a><span id="l34.7" class="difflineplus">+</span>
<a href="#l34.8"></a><span id="l34.8" class="difflineplus">+Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<a href="#l34.9"></a><span id="l34.9" class="difflineplus">+you may not use this file except in compliance with the License.</span>
<a href="#l34.10"></a><span id="l34.10" class="difflineplus">+You may obtain a copy of the License at</span>
<a href="#l34.11"></a><span id="l34.11" class="difflineplus">+</span>
<a href="#l34.12"></a><span id="l34.12" class="difflineplus">+    http://www.apache.org/licenses/LICENSE-2.0</span>
<a href="#l34.13"></a><span id="l34.13" class="difflineplus">+</span>
<a href="#l34.14"></a><span id="l34.14" class="difflineplus">+Unless required by applicable law or agreed to in writing, software</span>
<a href="#l34.15"></a><span id="l34.15" class="difflineplus">+distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<a href="#l34.16"></a><span id="l34.16" class="difflineplus">+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<a href="#l34.17"></a><span id="l34.17" class="difflineplus">+See the License for the specific language governing permissions and</span>
<a href="#l34.18"></a><span id="l34.18" class="difflineplus">+limitations under the License.</span>
<a href="#l34.19"></a><span id="l34.19" class="difflineplus">+*/</span>
<a href="#l34.20"></a><span id="l34.20" class="difflineplus">+&quot;use strict&quot;;</span>
<a href="#l34.21"></a><span id="l34.21" class="difflineplus">+</span>
<a href="#l34.22"></a><span id="l34.22" class="difflineplus">+/**</span>
<a href="#l34.23"></a><span id="l34.23" class="difflineplus">+ * @module models/search-result</span>
<a href="#l34.24"></a><span id="l34.24" class="difflineplus">+ */</span>
<a href="#l34.25"></a><span id="l34.25" class="difflineplus">+</span>
<a href="#l34.26"></a><span id="l34.26" class="difflineplus">+var EventContext = require(&quot;./event-context&quot;);</span>
<a href="#l34.27"></a><span id="l34.27" class="difflineplus">+var utils = require(&quot;../utils&quot;);</span>
<a href="#l34.28"></a><span id="l34.28" class="difflineplus">+</span>
<a href="#l34.29"></a><span id="l34.29" class="difflineplus">+/**</span>
<a href="#l34.30"></a><span id="l34.30" class="difflineplus">+ * Construct a new SearchResult</span>
<a href="#l34.31"></a><span id="l34.31" class="difflineplus">+ *</span>
<a href="#l34.32"></a><span id="l34.32" class="difflineplus">+ * @param {number} rank   where this SearchResult ranks in the results</span>
<a href="#l34.33"></a><span id="l34.33" class="difflineplus">+ * @param {event-context.EventContext} eventContext  the matching event and its</span>
<a href="#l34.34"></a><span id="l34.34" class="difflineplus">+ *    context</span>
<a href="#l34.35"></a><span id="l34.35" class="difflineplus">+ *</span>
<a href="#l34.36"></a><span id="l34.36" class="difflineplus">+ * @constructor</span>
<a href="#l34.37"></a><span id="l34.37" class="difflineplus">+ */</span>
<a href="#l34.38"></a><span id="l34.38" class="difflineplus">+function SearchResult(rank, eventContext) {</span>
<a href="#l34.39"></a><span id="l34.39" class="difflineplus">+    this.rank = rank;</span>
<a href="#l34.40"></a><span id="l34.40" class="difflineplus">+    this.context = eventContext;</span>
<a href="#l34.41"></a><span id="l34.41" class="difflineplus">+}</span>
<a href="#l34.42"></a><span id="l34.42" class="difflineplus">+</span>
<a href="#l34.43"></a><span id="l34.43" class="difflineplus">+/**</span>
<a href="#l34.44"></a><span id="l34.44" class="difflineplus">+ * Create a SearchResponse from the response to /search</span>
<a href="#l34.45"></a><span id="l34.45" class="difflineplus">+ * @static</span>
<a href="#l34.46"></a><span id="l34.46" class="difflineplus">+ * @param {Object} jsonObj</span>
<a href="#l34.47"></a><span id="l34.47" class="difflineplus">+ * @param {function} eventMapper</span>
<a href="#l34.48"></a><span id="l34.48" class="difflineplus">+ * @return {SearchResult}</span>
<a href="#l34.49"></a><span id="l34.49" class="difflineplus">+ */</span>
<a href="#l34.50"></a><span id="l34.50" class="difflineplus">+</span>
<a href="#l34.51"></a><span id="l34.51" class="difflineplus">+SearchResult.fromJson = function(jsonObj, eventMapper) {</span>
<a href="#l34.52"></a><span id="l34.52" class="difflineplus">+    var jsonContext = jsonObj.context || {};</span>
<a href="#l34.53"></a><span id="l34.53" class="difflineplus">+    var events_before = jsonContext.events_before || [];</span>
<a href="#l34.54"></a><span id="l34.54" class="difflineplus">+    var events_after = jsonContext.events_after || [];</span>
<a href="#l34.55"></a><span id="l34.55" class="difflineplus">+</span>
<a href="#l34.56"></a><span id="l34.56" class="difflineplus">+    var context = new EventContext(eventMapper(jsonObj.result));</span>
<a href="#l34.57"></a><span id="l34.57" class="difflineplus">+</span>
<a href="#l34.58"></a><span id="l34.58" class="difflineplus">+    context.setPaginateToken(jsonContext.start, true);</span>
<a href="#l34.59"></a><span id="l34.59" class="difflineplus">+    context.addEvents(utils.map(events_before, eventMapper), true);</span>
<a href="#l34.60"></a><span id="l34.60" class="difflineplus">+    context.addEvents(utils.map(events_after, eventMapper), false);</span>
<a href="#l34.61"></a><span id="l34.61" class="difflineplus">+    context.setPaginateToken(jsonContext.end, false);</span>
<a href="#l34.62"></a><span id="l34.62" class="difflineplus">+</span>
<a href="#l34.63"></a><span id="l34.63" class="difflineplus">+    return new SearchResult(jsonObj.rank, context);</span>
<a href="#l34.64"></a><span id="l34.64" class="difflineplus">+};</span>
<a href="#l34.65"></a><span id="l34.65" class="difflineplus">+</span>
<a href="#l34.66"></a><span id="l34.66" class="difflineplus">+</span>
<a href="#l34.67"></a><span id="l34.67" class="difflineplus">+/**</span>
<a href="#l34.68"></a><span id="l34.68" class="difflineplus">+ * The SearchResult class</span>
<a href="#l34.69"></a><span id="l34.69" class="difflineplus">+ */</span>
<a href="#l34.70"></a><span id="l34.70" class="difflineplus">+module.exports = SearchResult;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l35.1"></a><span id="l35.1">new file mode 100644</span>
<a href="#l35.2"></a><span id="l35.2" class="difflineminus">--- /dev/null</span>
<a href="#l35.3"></a><span id="l35.3" class="difflineplus">+++ b/chat/protocols/matrix/matrix-sdk/models/user.js</span>
<a href="#l35.4"></a><span id="l35.4" class="difflineat">@@ -0,0 +1,244 @@</span>
<a href="#l35.5"></a><span id="l35.5" class="difflineplus">+/*</span>
<a href="#l35.6"></a><span id="l35.6" class="difflineplus">+Copyright 2015, 2016 OpenMarket Ltd</span>
<a href="#l35.7"></a><span id="l35.7" class="difflineplus">+</span>
<a href="#l35.8"></a><span id="l35.8" class="difflineplus">+Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<a href="#l35.9"></a><span id="l35.9" class="difflineplus">+you may not use this file except in compliance with the License.</span>
<a href="#l35.10"></a><span id="l35.10" class="difflineplus">+You may obtain a copy of the License at</span>
<a href="#l35.11"></a><span id="l35.11" class="difflineplus">+</span>
<a href="#l35.12"></a><span id="l35.12" class="difflineplus">+    http://www.apache.org/licenses/LICENSE-2.0</span>
<a href="#l35.13"></a><span id="l35.13" class="difflineplus">+</span>
<a href="#l35.14"></a><span id="l35.14" class="difflineplus">+Unless required by applicable law or agreed to in writing, software</span>
<a href="#l35.15"></a><span id="l35.15" class="difflineplus">+distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<a href="#l35.16"></a><span id="l35.16" class="difflineplus">+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<a href="#l35.17"></a><span id="l35.17" class="difflineplus">+See the License for the specific language governing permissions and</span>
<a href="#l35.18"></a><span id="l35.18" class="difflineplus">+limitations under the License.</span>
<a href="#l35.19"></a><span id="l35.19" class="difflineplus">+*/</span>
<a href="#l35.20"></a><span id="l35.20" class="difflineplus">+&quot;use strict&quot;;</span>
<a href="#l35.21"></a><span id="l35.21" class="difflineplus">+/**</span>
<a href="#l35.22"></a><span id="l35.22" class="difflineplus">+ * @module models/user</span>
<a href="#l35.23"></a><span id="l35.23" class="difflineplus">+ */</span>
<a href="#l35.24"></a><span id="l35.24" class="difflineplus">+ var EventEmitter = require(&quot;events&quot;).EventEmitter;</span>
<a href="#l35.25"></a><span id="l35.25" class="difflineplus">+ var utils = require(&quot;../utils&quot;);</span>
<a href="#l35.26"></a><span id="l35.26" class="difflineplus">+</span>
<a href="#l35.27"></a><span id="l35.27" class="difflineplus">+/**</span>
<a href="#l35.28"></a><span id="l35.28" class="difflineplus">+ * Construct a new User. A User must have an ID and can optionally have extra</span>
<a href="#l35.29"></a><span id="l35.29" class="difflineplus">+ * information associated with it.</span>
<a href="#l35.30"></a><span id="l35.30" class="difflineplus">+ * @constructor</span>
<a href="#l35.31"></a><span id="l35.31" class="difflineplus">+ * @param {string} userId Required. The ID of this user.</span>
<a href="#l35.32"></a><span id="l35.32" class="difflineplus">+ * @prop {string} userId The ID of the user.</span>
<a href="#l35.33"></a><span id="l35.33" class="difflineplus">+ * @prop {Object} info The info object supplied in the constructor.</span>
<a href="#l35.34"></a><span id="l35.34" class="difflineplus">+ * @prop {string} displayName The 'displayname' of the user if known.</span>
<a href="#l35.35"></a><span id="l35.35" class="difflineplus">+ * @prop {string} avatarUrl The 'avatar_url' of the user if known.</span>
<a href="#l35.36"></a><span id="l35.36" class="difflineplus">+ * @prop {string} presence The presence enum if known.</span>
<a href="#l35.37"></a><span id="l35.37" class="difflineplus">+ * @prop {string} presenceStatusMsg The presence status message if known.</span>
<a href="#l35.38"></a><span id="l35.38" class="difflineplus">+ * @prop {Number} lastActiveAgo The time elapsed in ms since the user interacted</span>
<a href="#l35.39"></a><span id="l35.39" class="difflineplus">+ *                proactively with the server, or we saw a message from the user</span>
<a href="#l35.40"></a><span id="l35.40" class="difflineplus">+ * @prop {Number} lastPresenceTs Timestamp (ms since the epoch) for when we last</span>
<a href="#l35.41"></a><span id="l35.41" class="difflineplus">+ *                received presence data for this user.  We can subtract</span>
<a href="#l35.42"></a><span id="l35.42" class="difflineplus">+ *                lastActiveAgo from this to approximate an absolute value for</span>
<a href="#l35.43"></a><span id="l35.43" class="difflineplus">+ *                when a user was last active.</span>
<a href="#l35.44"></a><span id="l35.44" class="difflineplus">+ * @prop {Boolean} currentlyActive Whether we should consider lastActiveAgo to be</span>
<a href="#l35.45"></a><span id="l35.45" class="difflineplus">+ *               an approximation and that the user should be seen as active 'now'</span>
<a href="#l35.46"></a><span id="l35.46" class="difflineplus">+ * @prop {Object} events The events describing this user.</span>
<a href="#l35.47"></a><span id="l35.47" class="difflineplus">+ * @prop {MatrixEvent} events.presence The m.presence event for this user.</span>
<a href="#l35.48"></a><span id="l35.48" class="difflineplus">+ */</span>
<a href="#l35.49"></a><span id="l35.49" class="difflineplus">+function User(userId) {</span>
<a href="#l35.50"></a><span id="l35.50" class="difflineplus">+    this.userId = userId;</span>
<a href="#l35.51"></a><span id="l35.51" class="difflineplus">+    this.presence = &quot;offline&quot;;</span>
<a href="#l35.52"></a><span id="l35.52" class="difflineplus">+    this.presenceStatusMsg = null;</span>
<a href="#l35.53"></a><span id="l35.53" class="difflineplus">+    this.displayName = userId;</span>
<a href="#l35.54"></a><span id="l35.54" class="difflineplus">+    this.rawDisplayName = userId;</span>
<a href="#l35.55"></a><span id="l35.55" class="difflineplus">+    this.avatarUrl = null;</span>
<a href="#l35.56"></a><span id="l35.56" class="difflineplus">+    this.lastActiveAgo = 0;</span>
<a href="#l35.57"></a><span id="l35.57" class="difflineplus">+    this.lastPresenceTs = 0;</span>
<a href="#l35.58"></a><span id="l35.58" class="difflineplus">+    this.currentlyActive = false;</span>
<a href="#l35.59"></a><span id="l35.59" class="difflineplus">+    this.events = {</span>
<a href="#l35.60"></a><span id="l35.60" class="difflineplus">+        presence: null,</span>
<a href="#l35.61"></a><span id="l35.61" class="difflineplus">+        profile: null</span>
<a href="#l35.62"></a><span id="l35.62" class="difflineplus">+    };</span>
<a href="#l35.63"></a><span id="l35.63" class="difflineplus">+    this._updateModifiedTime();</span>
<a href="#l35.64"></a><span id="l35.64" class="difflineplus">+}</span>
<a href="#l35.65"></a><span id="l35.65" class="difflineplus">+utils.inherits(User, EventEmitter);</span>
<a href="#l35.66"></a><span id="l35.66" class="difflineplus">+</span>
<a href="#l35.67"></a><span id="l35.67" class="difflineplus">+/**</span>
<a href="#l35.68"></a><span id="l35.68" class="difflineplus">+ * Update this User with the given presence event. May fire &quot;User.presence&quot;,</span>
<a href="#l35.69"></a><span id="l35.69" class="difflineplus">+ * &quot;User.avatarUrl&quot; and/or &quot;User.displayName&quot; if this event updates this user's</span>
<a href="#l35.70"></a><span id="l35.70" class="difflineplus">+ * properties.</span>
<a href="#l35.71"></a><span id="l35.71" class="difflineplus">+ * @param {MatrixEvent} event The &lt;code&gt;m.presence&lt;/code&gt; event.</span>
<a href="#l35.72"></a><span id="l35.72" class="difflineplus">+ * @fires module:client~MatrixClient#event:&quot;User.presence&quot;</span>
<a href="#l35.73"></a><span id="l35.73" class="difflineplus">+ * @fires module:client~MatrixClient#event:&quot;User.displayName&quot;</span>
<a href="#l35.74"></a><span id="l35.74" class="difflineplus">+ * @fires module:client~MatrixClient#event:&quot;User.avatarUrl&quot;</span>
<a href="#l35.75"></a><span id="l35.75" class="difflineplus">+ */</span>
<a href="#l35.76"></a><span id="l35.76" class="difflineplus">+User.prototype.setPresenceEvent = function(event) {</span>
<a href="#l35.77"></a><span id="l35.77" class="difflineplus">+    if (event.getType() !== &quot;m.presence&quot;) {</span>
<a href="#l35.78"></a><span id="l35.78" class="difflineplus">+        return;</span>
<a href="#l35.79"></a><span id="l35.79" class="difflineplus">+    }</span>
<a href="#l35.80"></a><span id="l35.80" class="difflineplus">+    var firstFire = this.events.presence === null;</span>
<a href="#l35.81"></a><span id="l35.81" class="difflineplus">+    this.events.presence = event;</span>
<a href="#l35.82"></a><span id="l35.82" class="difflineplus">+</span>
<a href="#l35.83"></a><span id="l35.83" class="difflineplus">+    var eventsToFire = [];</span>
<a href="#l35.84"></a><span id="l35.84" class="difflineplus">+    if (event.getContent().presence !== this.presence || firstFire) {</span>
<a href="#l35.85"></a><span id="l35.85" class="difflineplus">+        eventsToFire.push(&quot;User.presence&quot;);</span>
<a href="#l35.86"></a><span id="l35.86" class="difflineplus">+    }</span>
<a href="#l35.87"></a><span id="l35.87" class="difflineplus">+    if (event.getContent().avatar_url &amp;&amp;</span>
<a href="#l35.88"></a><span id="l35.88" class="difflineplus">+        event.getContent().avatar_url !== this.avatarUrl)</span>
<a href="#l35.89"></a><span id="l35.89" class="difflineplus">+    {</span>
<a href="#l35.90"></a><span id="l35.90" class="difflineplus">+        eventsToFire.push(&quot;User.avatarUrl&quot;);</span>
<a href="#l35.91"></a><span id="l35.91" class="difflineplus">+    }</span>
<a href="#l35.92"></a><span id="l35.92" class="difflineplus">+    if (event.getContent().displayname &amp;&amp;</span>
<a href="#l35.93"></a><span id="l35.93" class="difflineplus">+        event.getContent().displayname !== this.displayName)</span>
<a href="#l35.94"></a><span id="l35.94" class="difflineplus">+    {</span>
<a href="#l35.95"></a><span id="l35.95" class="difflineplus">+        eventsToFire.push(&quot;User.displayName&quot;);</span>
<a href="#l35.96"></a><span id="l35.96" class="difflineplus">+    }</span>
<a href="#l35.97"></a><span id="l35.97" class="difflineplus">+    if (event.getContent().currently_active !== undefined &amp;&amp;</span>
<a href="#l35.98"></a><span id="l35.98" class="difflineplus">+        event.getContent().currently_active !== this.currentlyActive)</span>
<a href="#l35.99"></a><span id="l35.99" class="difflineplus">+    {</span>
<a href="#l35.100"></a><span id="l35.100" class="difflineplus">+        eventsToFire.push(&quot;User.currentlyActive&quot;);</span>
<a href="#l35.101"></a><span id="l35.101" class="difflineplus">+    }</span>
<a href="#l35.102"></a><span id="l35.102" class="difflineplus">+</span>
<a href="#l35.103"></a><span id="l35.103" class="difflineplus">+    this.presence = event.getContent().presence;</span>
<a href="#l35.104"></a><span id="l35.104" class="difflineplus">+    eventsToFire.push(&quot;User.lastPresenceTs&quot;);</span>
<a href="#l35.105"></a><span id="l35.105" class="difflineplus">+</span>
<a href="#l35.106"></a><span id="l35.106" class="difflineplus">+    if (event.getContent().status_msg) {</span>
<a href="#l35.107"></a><span id="l35.107" class="difflineplus">+      this.presenceStatusMsg = event.getContent().status_msg;</span>
<a href="#l35.108"></a><span id="l35.108" class="difflineplus">+    }</span>
<a href="#l35.109"></a><span id="l35.109" class="difflineplus">+    if (event.getContent().displayname) {</span>
<a href="#l35.110"></a><span id="l35.110" class="difflineplus">+        this.displayName = event.getContent().displayname;</span>
<a href="#l35.111"></a><span id="l35.111" class="difflineplus">+    }</span>
<a href="#l35.112"></a><span id="l35.112" class="difflineplus">+    if (event.getContent().avatar_url) {</span>
<a href="#l35.113"></a><span id="l35.113" class="difflineplus">+        this.avatarUrl = event.getContent().avatar_url;</span>
<a href="#l35.114"></a><span id="l35.114" class="difflineplus">+    }</span>
<a href="#l35.115"></a><span id="l35.115" class="difflineplus">+    this.lastActiveAgo = event.getContent().last_active_ago;</span>
<a href="#l35.116"></a><span id="l35.116" class="difflineplus">+    this.lastPresenceTs = Date.now();</span>
<a href="#l35.117"></a><span id="l35.117" class="difflineplus">+    this.currentlyActive = event.getContent().currently_active;</span>
<a href="#l35.118"></a><span id="l35.118" class="difflineplus">+</span>
<a href="#l35.119"></a><span id="l35.119" class="difflineplus">+    this._updateModifiedTime();</span>
<a href="#l35.120"></a><span id="l35.120" class="difflineplus">+</span>
<a href="#l35.121"></a><span id="l35.121" class="difflineplus">+    for (var i = 0; i &lt; eventsToFire.length; i++) {</span>
<a href="#l35.122"></a><span id="l35.122" class="difflineplus">+        this.emit(eventsToFire[i], event, this);</span>
<a href="#l35.123"></a><span id="l35.123" class="difflineplus">+    }</span>
<a href="#l35.124"></a><span id="l35.124" class="difflineplus">+};</span>
<a href="#l35.125"></a><span id="l35.125" class="difflineplus">+</span>
<a href="#l35.126"></a><span id="l35.126" class="difflineplus">+/**</span>
<a href="#l35.127"></a><span id="l35.127" class="difflineplus">+ * Manually set this user's display name. No event is emitted in response to this</span>
<a href="#l35.128"></a><span id="l35.128" class="difflineplus">+ * as there is no underlying MatrixEvent to emit with.</span>
<a href="#l35.129"></a><span id="l35.129" class="difflineplus">+ * @param {string} name The new display name.</span>
<a href="#l35.130"></a><span id="l35.130" class="difflineplus">+ */</span>
<a href="#l35.131"></a><span id="l35.131" class="difflineplus">+User.prototype.setDisplayName = function(name) {</span>
<a href="#l35.132"></a><span id="l35.132" class="difflineplus">+    var oldName = this.displayName;</span>
<a href="#l35.133"></a><span id="l35.133" class="difflineplus">+    this.displayName = name;</span>
<a href="#l35.134"></a><span id="l35.134" class="difflineplus">+    if (name !== oldName) {</span>
<a href="#l35.135"></a><span id="l35.135" class="difflineplus">+        this._updateModifiedTime();</span>
<a href="#l35.136"></a><span id="l35.136" class="difflineplus">+    }</span>
<a href="#l35.137"></a><span id="l35.137" class="difflineplus">+};</span>
<a href="#l35.138"></a><span id="l35.138" class="difflineplus">+</span>
<a href="#l35.139"></a><span id="l35.139" class="difflineplus">+</span>
<a href="#l35.140"></a><span id="l35.140" class="difflineplus">+/**</span>
<a href="#l35.141"></a><span id="l35.141" class="difflineplus">+ * Manually set this user's non-disambiguated display name. No event is emitted</span>
<a href="#l35.142"></a><span id="l35.142" class="difflineplus">+ * in response to this as there is no underlying MatrixEvent to emit with.</span>
<a href="#l35.143"></a><span id="l35.143" class="difflineplus">+ * @param {string} name The new display name.</span>
<a href="#l35.144"></a><span id="l35.144" class="difflineplus">+ */</span>
<a href="#l35.145"></a><span id="l35.145" class="difflineplus">+User.prototype.setRawDisplayName = function(name) {</span>
<a href="#l35.146"></a><span id="l35.146" class="difflineplus">+    this.rawDisplayName = name;</span>
<a href="#l35.147"></a><span id="l35.147" class="difflineplus">+};</span>
<a href="#l35.148"></a><span id="l35.148" class="difflineplus">+</span>
<a href="#l35.149"></a><span id="l35.149" class="difflineplus">+</span>
<a href="#l35.150"></a><span id="l35.150" class="difflineplus">+/**</span>
<a href="#l35.151"></a><span id="l35.151" class="difflineplus">+ * Manually set this user's avatar URL. No event is emitted in response to this</span>
<a href="#l35.152"></a><span id="l35.152" class="difflineplus">+ * as there is no underlying MatrixEvent to emit with.</span>
<a href="#l35.153"></a><span id="l35.153" class="difflineplus">+ * @param {string} url The new avatar URL.</span>
<a href="#l35.154"></a><span id="l35.154" class="difflineplus">+ */</span>
<a href="#l35.155"></a><span id="l35.155" class="difflineplus">+User.prototype.setAvatarUrl = function(url) {</span>
<a href="#l35.156"></a><span id="l35.156" class="difflineplus">+    var oldUrl = this.avatarUrl;</span>
<a href="#l35.157"></a><span id="l35.157" class="difflineplus">+    this.avatarUrl = url;</span>
<a href="#l35.158"></a><span id="l35.158" class="difflineplus">+    if (url !== oldUrl) {</span>
<a href="#l35.159"></a><span id="l35.159" class="difflineplus">+        this._updateModifiedTime();</span>
<a href="#l35.160"></a><span id="l35.160" class="difflineplus">+    }</span>
<a href="#l35.161"></a><span id="l35.161" class="difflineplus">+};</span>
<a href="#l35.162"></a><span id="l35.162" class="difflineplus">+</span>
<a href="#l35.163"></a><span id="l35.163" class="difflineplus">+/**</span>
<a href="#l35.164"></a><span id="l35.164" class="difflineplus">+ * Update the last modified time to the current time.</span>
<a href="#l35.165"></a><span id="l35.165" class="difflineplus">+ */</span>
<a href="#l35.166"></a><span id="l35.166" class="difflineplus">+User.prototype._updateModifiedTime = function() {</span>
<a href="#l35.167"></a><span id="l35.167" class="difflineplus">+    this._modified = Date.now();</span>
<a href="#l35.168"></a><span id="l35.168" class="difflineplus">+};</span>
<a href="#l35.169"></a><span id="l35.169" class="difflineplus">+</span>
<a href="#l35.170"></a><span id="l35.170" class="difflineplus">+/**</span>
<a href="#l35.171"></a><span id="l35.171" class="difflineplus">+ * Get the timestamp when this User was last updated. This timestamp is</span>
<a href="#l35.172"></a><span id="l35.172" class="difflineplus">+ * updated when this User receives a new Presence event which has updated a</span>
<a href="#l35.173"></a><span id="l35.173" class="difflineplus">+ * property on this object. It is updated &lt;i&gt;before&lt;/i&gt; firing events.</span>
<a href="#l35.174"></a><span id="l35.174" class="difflineplus">+ * @return {number} The timestamp</span>
<a href="#l35.175"></a><span id="l35.175" class="difflineplus">+ */</span>
<a href="#l35.176"></a><span id="l35.176" class="difflineplus">+User.prototype.getLastModifiedTime = function() {</span>
<a href="#l35.177"></a><span id="l35.177" class="difflineplus">+    return this._modified;</span>
<a href="#l35.178"></a><span id="l35.178" class="difflineplus">+};</span>
<a href="#l35.179"></a><span id="l35.179" class="difflineplus">+</span>
<a href="#l35.180"></a><span id="l35.180" class="difflineplus">+/**</span>
<a href="#l35.181"></a><span id="l35.181" class="difflineplus">+ * Get the absolute timestamp when this User was last known active on the server.</span>
<a href="#l35.182"></a><span id="l35.182" class="difflineplus">+ * It is *NOT* accurate if this.currentlyActive is true.</span>
<a href="#l35.183"></a><span id="l35.183" class="difflineplus">+ * @return {number} The timestamp</span>
<a href="#l35.184"></a><span id="l35.184" class="difflineplus">+ */</span>
<a href="#l35.185"></a><span id="l35.185" class="difflineplus">+User.prototype.getLastActiveTs = function() {</span>
<a href="#l35.186"></a><span id="l35.186" class="difflineplus">+    return this.lastPresenceTs - this.lastActiveAgo;</span>
<a href="#l35.187"></a><span id="l35.187" class="difflineplus">+};</span>
<a href="#l35.188"></a><span id="l35.188" class="difflineplus">+</span>
<a href="#l35.189"></a><span id="l35.189" class="difflineplus">+/**</span>
<a href="#l35.190"></a><span id="l35.190" class="difflineplus">+ * The User class.</span>
<a href="#l35.191"></a><span id="l35.191" class="difflineplus">+ */</span>
<a href="#l35.192"></a><span id="l35.192" class="difflineplus">+module.exports = User;</span>
<a href="#l35.193"></a><span id="l35.193" class="difflineplus">+</span>
<a href="#l35.194"></a><span id="l35.194" class="difflineplus">+/**</span>
<a href="#l35.195"></a><span id="l35.195" class="difflineplus">+ * Fires whenever any user's lastPresenceTs changes,</span>
<a href="#l35.196"></a><span id="l35.196" class="difflineplus">+ * ie. whenever any presence event is received for a user.</span>
<a href="#l35.197"></a><span id="l35.197" class="difflineplus">+ * @event module:client~MatrixClient#&quot;User.lastPresenceTs&quot;</span>
<a href="#l35.198"></a><span id="l35.198" class="difflineplus">+ * @param {MatrixEvent} event The matrix event which caused this event to fire.</span>
<a href="#l35.199"></a><span id="l35.199" class="difflineplus">+ * @param {User} user The user whose User.lastPresenceTs changed.</span>
<a href="#l35.200"></a><span id="l35.200" class="difflineplus">+ * @example</span>
<a href="#l35.201"></a><span id="l35.201" class="difflineplus">+ * matrixClient.on(&quot;User.lastPresenceTs&quot;, function(event, user){</span>
<a href="#l35.202"></a><span id="l35.202" class="difflineplus">+ *   var newlastPresenceTs = user.lastPresenceTs;</span>
<a href="#l35.203"></a><span id="l35.203" class="difflineplus">+ * });</span>
<a href="#l35.204"></a><span id="l35.204" class="difflineplus">+ */</span>
<a href="#l35.205"></a><span id="l35.205" class="difflineplus">+</span>
<a href="#l35.206"></a><span id="l35.206" class="difflineplus">+/**</span>
<a href="#l35.207"></a><span id="l35.207" class="difflineplus">+ * Fires whenever any user's presence changes.</span>
<a href="#l35.208"></a><span id="l35.208" class="difflineplus">+ * @event module:client~MatrixClient#&quot;User.presence&quot;</span>
<a href="#l35.209"></a><span id="l35.209" class="difflineplus">+ * @param {MatrixEvent} event The matrix event which caused this event to fire.</span>
<a href="#l35.210"></a><span id="l35.210" class="difflineplus">+ * @param {User} user The user whose User.presence changed.</span>
<a href="#l35.211"></a><span id="l35.211" class="difflineplus">+ * @example</span>
<a href="#l35.212"></a><span id="l35.212" class="difflineplus">+ * matrixClient.on(&quot;User.presence&quot;, function(event, user){</span>
<a href="#l35.213"></a><span id="l35.213" class="difflineplus">+ *   var newPresence = user.presence;</span>
<a href="#l35.214"></a><span id="l35.214" class="difflineplus">+ * });</span>
<a href="#l35.215"></a><span id="l35.215" class="difflineplus">+ */</span>
<a href="#l35.216"></a><span id="l35.216" class="difflineplus">+</span>
<a href="#l35.217"></a><span id="l35.217" class="difflineplus">+/**</span>
<a href="#l35.218"></a><span id="l35.218" class="difflineplus">+ * Fires whenever any user's currentlyActive changes.</span>
<a href="#l35.219"></a><span id="l35.219" class="difflineplus">+ * @event module:client~MatrixClient#&quot;User.currentlyActive&quot;</span>
<a href="#l35.220"></a><span id="l35.220" class="difflineplus">+ * @param {MatrixEvent} event The matrix event which caused this event to fire.</span>
<a href="#l35.221"></a><span id="l35.221" class="difflineplus">+ * @param {User} user The user whose User.currentlyActive changed.</span>
<a href="#l35.222"></a><span id="l35.222" class="difflineplus">+ * @example</span>
<a href="#l35.223"></a><span id="l35.223" class="difflineplus">+ * matrixClient.on(&quot;User.currentlyActive&quot;, function(event, user){</span>
<a href="#l35.224"></a><span id="l35.224" class="difflineplus">+ *   var newCurrentlyActive = user.currentlyActive;</span>
<a href="#l35.225"></a><span id="l35.225" class="difflineplus">+ * });</span>
<a href="#l35.226"></a><span id="l35.226" class="difflineplus">+ */</span>
<a href="#l35.227"></a><span id="l35.227" class="difflineplus">+</span>
<a href="#l35.228"></a><span id="l35.228" class="difflineplus">+/**</span>
<a href="#l35.229"></a><span id="l35.229" class="difflineplus">+ * Fires whenever any user's display name changes.</span>
<a href="#l35.230"></a><span id="l35.230" class="difflineplus">+ * @event module:client~MatrixClient#&quot;User.displayName&quot;</span>
<a href="#l35.231"></a><span id="l35.231" class="difflineplus">+ * @param {MatrixEvent} event The matrix event which caused this event to fire.</span>
<a href="#l35.232"></a><span id="l35.232" class="difflineplus">+ * @param {User} user The user whose User.displayName changed.</span>
<a href="#l35.233"></a><span id="l35.233" class="difflineplus">+ * @example</span>
<a href="#l35.234"></a><span id="l35.234" class="difflineplus">+ * matrixClient.on(&quot;User.displayName&quot;, function(event, user){</span>
<a href="#l35.235"></a><span id="l35.235" class="difflineplus">+ *   var newName = user.displayName;</span>
<a href="#l35.236"></a><span id="l35.236" class="difflineplus">+ * });</span>
<a href="#l35.237"></a><span id="l35.237" class="difflineplus">+ */</span>
<a href="#l35.238"></a><span id="l35.238" class="difflineplus">+</span>
<a href="#l35.239"></a><span id="l35.239" class="difflineplus">+/**</span>
<a href="#l35.240"></a><span id="l35.240" class="difflineplus">+ * Fires whenever any user's avatar URL changes.</span>
<a href="#l35.241"></a><span id="l35.241" class="difflineplus">+ * @event module:client~MatrixClient#&quot;User.avatarUrl&quot;</span>
<a href="#l35.242"></a><span id="l35.242" class="difflineplus">+ * @param {MatrixEvent} event The matrix event which caused this event to fire.</span>
<a href="#l35.243"></a><span id="l35.243" class="difflineplus">+ * @param {User} user The user whose User.avatarUrl changed.</span>
<a href="#l35.244"></a><span id="l35.244" class="difflineplus">+ * @example</span>
<a href="#l35.245"></a><span id="l35.245" class="difflineplus">+ * matrixClient.on(&quot;User.avatarUrl&quot;, function(event, user){</span>
<a href="#l35.246"></a><span id="l35.246" class="difflineplus">+ *   var newUrl = user.avatarUrl;</span>
<a href="#l35.247"></a><span id="l35.247" class="difflineplus">+ * });</span>
<a href="#l35.248"></a><span id="l35.248" class="difflineplus">+ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l36.1"></a><span id="l36.1">new file mode 100644</span>
<a href="#l36.2"></a><span id="l36.2" class="difflineminus">--- /dev/null</span>
<a href="#l36.3"></a><span id="l36.3" class="difflineplus">+++ b/chat/protocols/matrix/matrix-sdk/pushprocessor.js</span>
<a href="#l36.4"></a><span id="l36.4" class="difflineat">@@ -0,0 +1,309 @@</span>
<a href="#l36.5"></a><span id="l36.5" class="difflineplus">+/*</span>
<a href="#l36.6"></a><span id="l36.6" class="difflineplus">+Copyright 2015, 2016 OpenMarket Ltd</span>
<a href="#l36.7"></a><span id="l36.7" class="difflineplus">+</span>
<a href="#l36.8"></a><span id="l36.8" class="difflineplus">+Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<a href="#l36.9"></a><span id="l36.9" class="difflineplus">+you may not use this file except in compliance with the License.</span>
<a href="#l36.10"></a><span id="l36.10" class="difflineplus">+You may obtain a copy of the License at</span>
<a href="#l36.11"></a><span id="l36.11" class="difflineplus">+</span>
<a href="#l36.12"></a><span id="l36.12" class="difflineplus">+    http://www.apache.org/licenses/LICENSE-2.0</span>
<a href="#l36.13"></a><span id="l36.13" class="difflineplus">+</span>
<a href="#l36.14"></a><span id="l36.14" class="difflineplus">+Unless required by applicable law or agreed to in writing, software</span>
<a href="#l36.15"></a><span id="l36.15" class="difflineplus">+distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<a href="#l36.16"></a><span id="l36.16" class="difflineplus">+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<a href="#l36.17"></a><span id="l36.17" class="difflineplus">+See the License for the specific language governing permissions and</span>
<a href="#l36.18"></a><span id="l36.18" class="difflineplus">+limitations under the License.</span>
<a href="#l36.19"></a><span id="l36.19" class="difflineplus">+*/</span>
<a href="#l36.20"></a><span id="l36.20" class="difflineplus">+/**</span>
<a href="#l36.21"></a><span id="l36.21" class="difflineplus">+ * @module pushprocessor</span>
<a href="#l36.22"></a><span id="l36.22" class="difflineplus">+ */</span>
<a href="#l36.23"></a><span id="l36.23" class="difflineplus">+</span>
<a href="#l36.24"></a><span id="l36.24" class="difflineplus">+/**</span>
<a href="#l36.25"></a><span id="l36.25" class="difflineplus">+ * Construct a Push Processor.</span>
<a href="#l36.26"></a><span id="l36.26" class="difflineplus">+ * @constructor</span>
<a href="#l36.27"></a><span id="l36.27" class="difflineplus">+ * @param {Object} client The Matrix client object to use</span>
<a href="#l36.28"></a><span id="l36.28" class="difflineplus">+ */</span>
<a href="#l36.29"></a><span id="l36.29" class="difflineplus">+function PushProcessor(client) {</span>
<a href="#l36.30"></a><span id="l36.30" class="difflineplus">+    var escapeRegExp = function(string) {</span>
<a href="#l36.31"></a><span id="l36.31" class="difflineplus">+        return string.replace(/[.*+?^${}()|[\]\\]/g, &quot;\\$&amp;&quot;);</span>
<a href="#l36.32"></a><span id="l36.32" class="difflineplus">+    };</span>
<a href="#l36.33"></a><span id="l36.33" class="difflineplus">+</span>
<a href="#l36.34"></a><span id="l36.34" class="difflineplus">+    var matchingRuleFromKindSet = function(ev, kindset, device) {</span>
<a href="#l36.35"></a><span id="l36.35" class="difflineplus">+        var rulekinds_in_order = ['override', 'content', 'room', 'sender', 'underride'];</span>
<a href="#l36.36"></a><span id="l36.36" class="difflineplus">+        for (var ruleKindIndex = 0;</span>
<a href="#l36.37"></a><span id="l36.37" class="difflineplus">+                ruleKindIndex &lt; rulekinds_in_order.length;</span>
<a href="#l36.38"></a><span id="l36.38" class="difflineplus">+                ++ruleKindIndex) {</span>
<a href="#l36.39"></a><span id="l36.39" class="difflineplus">+            var kind = rulekinds_in_order[ruleKindIndex];</span>
<a href="#l36.40"></a><span id="l36.40" class="difflineplus">+            var ruleset = kindset[kind];</span>
<a href="#l36.41"></a><span id="l36.41" class="difflineplus">+</span>
<a href="#l36.42"></a><span id="l36.42" class="difflineplus">+            for (var ruleIndex = 0; ruleIndex &lt; ruleset.length; ++ruleIndex) {</span>
<a href="#l36.43"></a><span id="l36.43" class="difflineplus">+                var rule = ruleset[ruleIndex];</span>
<a href="#l36.44"></a><span id="l36.44" class="difflineplus">+                if (!rule.enabled) { continue; }</span>
<a href="#l36.45"></a><span id="l36.45" class="difflineplus">+</span>
<a href="#l36.46"></a><span id="l36.46" class="difflineplus">+                var rawrule = templateRuleToRaw(kind, rule, device);</span>
<a href="#l36.47"></a><span id="l36.47" class="difflineplus">+                if (!rawrule) { continue; }</span>
<a href="#l36.48"></a><span id="l36.48" class="difflineplus">+</span>
<a href="#l36.49"></a><span id="l36.49" class="difflineplus">+                if (ruleMatchesEvent(rawrule, ev)) {</span>
<a href="#l36.50"></a><span id="l36.50" class="difflineplus">+                    rule.kind = kind;</span>
<a href="#l36.51"></a><span id="l36.51" class="difflineplus">+                    return rule;</span>
<a href="#l36.52"></a><span id="l36.52" class="difflineplus">+                }</span>
<a href="#l36.53"></a><span id="l36.53" class="difflineplus">+            }</span>
<a href="#l36.54"></a><span id="l36.54" class="difflineplus">+        }</span>
<a href="#l36.55"></a><span id="l36.55" class="difflineplus">+        return null;</span>
<a href="#l36.56"></a><span id="l36.56" class="difflineplus">+    };</span>
<a href="#l36.57"></a><span id="l36.57" class="difflineplus">+</span>
<a href="#l36.58"></a><span id="l36.58" class="difflineplus">+    var templateRuleToRaw = function(kind, tprule, device) {</span>
<a href="#l36.59"></a><span id="l36.59" class="difflineplus">+        var rawrule = {</span>
<a href="#l36.60"></a><span id="l36.60" class="difflineplus">+            'rule_id': tprule.rule_id,</span>
<a href="#l36.61"></a><span id="l36.61" class="difflineplus">+            'actions': tprule.actions,</span>
<a href="#l36.62"></a><span id="l36.62" class="difflineplus">+            'conditions': []</span>
<a href="#l36.63"></a><span id="l36.63" class="difflineplus">+        };</span>
<a href="#l36.64"></a><span id="l36.64" class="difflineplus">+        switch (kind) {</span>
<a href="#l36.65"></a><span id="l36.65" class="difflineplus">+            case 'underride':</span>
<a href="#l36.66"></a><span id="l36.66" class="difflineplus">+            case 'override':</span>
<a href="#l36.67"></a><span id="l36.67" class="difflineplus">+                rawrule.conditions = tprule.conditions;</span>
<a href="#l36.68"></a><span id="l36.68" class="difflineplus">+                break;</span>
<a href="#l36.69"></a><span id="l36.69" class="difflineplus">+            case 'room':</span>
<a href="#l36.70"></a><span id="l36.70" class="difflineplus">+                if (!tprule.rule_id) { return null; }</span>
<a href="#l36.71"></a><span id="l36.71" class="difflineplus">+                rawrule.conditions.push({</span>
<a href="#l36.72"></a><span id="l36.72" class="difflineplus">+                    'kind': 'event_match',</span>
<a href="#l36.73"></a><span id="l36.73" class="difflineplus">+                    'key': 'room_id',</span>
<a href="#l36.74"></a><span id="l36.74" class="difflineplus">+                    'pattern': tprule.rule_id</span>
<a href="#l36.75"></a><span id="l36.75" class="difflineplus">+                });</span>
<a href="#l36.76"></a><span id="l36.76" class="difflineplus">+                break;</span>
<a href="#l36.77"></a><span id="l36.77" class="difflineplus">+            case 'sender':</span>
<a href="#l36.78"></a><span id="l36.78" class="difflineplus">+                if (!tprule.rule_id) { return null; }</span>
<a href="#l36.79"></a><span id="l36.79" class="difflineplus">+                rawrule.conditions.push({</span>
<a href="#l36.80"></a><span id="l36.80" class="difflineplus">+                    'kind': 'event_match',</span>
<a href="#l36.81"></a><span id="l36.81" class="difflineplus">+                    'key': 'user_id',</span>
<a href="#l36.82"></a><span id="l36.82" class="difflineplus">+                    'pattern': tprule.rule_id</span>
<a href="#l36.83"></a><span id="l36.83" class="difflineplus">+                });</span>
<a href="#l36.84"></a><span id="l36.84" class="difflineplus">+                break;</span>
<a href="#l36.85"></a><span id="l36.85" class="difflineplus">+            case 'content':</span>
<a href="#l36.86"></a><span id="l36.86" class="difflineplus">+                if (!tprule.pattern) { return null; }</span>
<a href="#l36.87"></a><span id="l36.87" class="difflineplus">+                rawrule.conditions.push({</span>
<a href="#l36.88"></a><span id="l36.88" class="difflineplus">+                    'kind': 'event_match',</span>
<a href="#l36.89"></a><span id="l36.89" class="difflineplus">+                    'key': 'content.body',</span>
<a href="#l36.90"></a><span id="l36.90" class="difflineplus">+                    'pattern': tprule.pattern</span>
<a href="#l36.91"></a><span id="l36.91" class="difflineplus">+                });</span>
<a href="#l36.92"></a><span id="l36.92" class="difflineplus">+                break;</span>
<a href="#l36.93"></a><span id="l36.93" class="difflineplus">+        }</span>
<a href="#l36.94"></a><span id="l36.94" class="difflineplus">+        if (device) {</span>
<a href="#l36.95"></a><span id="l36.95" class="difflineplus">+            rawrule.conditions.push({</span>
<a href="#l36.96"></a><span id="l36.96" class="difflineplus">+                'kind': 'device',</span>
<a href="#l36.97"></a><span id="l36.97" class="difflineplus">+                'profile_tag': device</span>
<a href="#l36.98"></a><span id="l36.98" class="difflineplus">+            });</span>
<a href="#l36.99"></a><span id="l36.99" class="difflineplus">+        }</span>
<a href="#l36.100"></a><span id="l36.100" class="difflineplus">+        return rawrule;</span>
<a href="#l36.101"></a><span id="l36.101" class="difflineplus">+    };</span>
<a href="#l36.102"></a><span id="l36.102" class="difflineplus">+</span>
<a href="#l36.103"></a><span id="l36.103" class="difflineplus">+    var ruleMatchesEvent = function(rule, ev) {</span>
<a href="#l36.104"></a><span id="l36.104" class="difflineplus">+        var ret = true;</span>
<a href="#l36.105"></a><span id="l36.105" class="difflineplus">+        for (var i = 0; i &lt; rule.conditions.length; ++i) {</span>
<a href="#l36.106"></a><span id="l36.106" class="difflineplus">+            var cond = rule.conditions[i];</span>
<a href="#l36.107"></a><span id="l36.107" class="difflineplus">+            ret &amp;= eventFulfillsCondition(cond, ev);</span>
<a href="#l36.108"></a><span id="l36.108" class="difflineplus">+        }</span>
<a href="#l36.109"></a><span id="l36.109" class="difflineplus">+        //console.log(&quot;Rule &quot;+rule.rule_id+(ret ? &quot; matches&quot; : &quot; doesn't match&quot;));</span>
<a href="#l36.110"></a><span id="l36.110" class="difflineplus">+        return ret;</span>
<a href="#l36.111"></a><span id="l36.111" class="difflineplus">+    };</span>
<a href="#l36.112"></a><span id="l36.112" class="difflineplus">+</span>
<a href="#l36.113"></a><span id="l36.113" class="difflineplus">+    var eventFulfillsCondition = function(cond, ev) {</span>
<a href="#l36.114"></a><span id="l36.114" class="difflineplus">+        var condition_functions = {</span>
<a href="#l36.115"></a><span id="l36.115" class="difflineplus">+            &quot;event_match&quot;: eventFulfillsEventMatchCondition,</span>
<a href="#l36.116"></a><span id="l36.116" class="difflineplus">+            &quot;device&quot;: eventFulfillsDeviceCondition,</span>
<a href="#l36.117"></a><span id="l36.117" class="difflineplus">+            &quot;contains_display_name&quot;: eventFulfillsDisplayNameCondition,</span>
<a href="#l36.118"></a><span id="l36.118" class="difflineplus">+            &quot;room_member_count&quot;: eventFulfillsRoomMemberCountCondition</span>
<a href="#l36.119"></a><span id="l36.119" class="difflineplus">+        };</span>
<a href="#l36.120"></a><span id="l36.120" class="difflineplus">+        if (condition_functions[cond.kind]) {</span>
<a href="#l36.121"></a><span id="l36.121" class="difflineplus">+            return condition_functions[cond.kind](cond, ev);</span>
<a href="#l36.122"></a><span id="l36.122" class="difflineplus">+        }</span>
<a href="#l36.123"></a><span id="l36.123" class="difflineplus">+        return true;</span>
<a href="#l36.124"></a><span id="l36.124" class="difflineplus">+    };</span>
<a href="#l36.125"></a><span id="l36.125" class="difflineplus">+</span>
<a href="#l36.126"></a><span id="l36.126" class="difflineplus">+    var eventFulfillsRoomMemberCountCondition = function(cond, ev) {</span>
<a href="#l36.127"></a><span id="l36.127" class="difflineplus">+        if (!cond.is) { return false; }</span>
<a href="#l36.128"></a><span id="l36.128" class="difflineplus">+</span>
<a href="#l36.129"></a><span id="l36.129" class="difflineplus">+        var room = client.getRoom(ev.getRoomId());</span>
<a href="#l36.130"></a><span id="l36.130" class="difflineplus">+        if (!room || !room.currentState || !room.currentState.members) { return false; }</span>
<a href="#l36.131"></a><span id="l36.131" class="difflineplus">+</span>
<a href="#l36.132"></a><span id="l36.132" class="difflineplus">+        var memberCount = Object.keys(room.currentState.members).filter(function(m) {</span>
<a href="#l36.133"></a><span id="l36.133" class="difflineplus">+            return room.currentState.members[m].membership == 'join';</span>
<a href="#l36.134"></a><span id="l36.134" class="difflineplus">+        }).length;</span>
<a href="#l36.135"></a><span id="l36.135" class="difflineplus">+</span>
<a href="#l36.136"></a><span id="l36.136" class="difflineplus">+        var m = cond.is.match(/^([=&lt;&gt;]*)([0-9]*)$/);</span>
<a href="#l36.137"></a><span id="l36.137" class="difflineplus">+        if (!m) { return false; }</span>
<a href="#l36.138"></a><span id="l36.138" class="difflineplus">+        var ineq = m[1];</span>
<a href="#l36.139"></a><span id="l36.139" class="difflineplus">+        var rhs = parseInt(m[2]);</span>
<a href="#l36.140"></a><span id="l36.140" class="difflineplus">+        if (isNaN(rhs)) { return false; }</span>
<a href="#l36.141"></a><span id="l36.141" class="difflineplus">+        switch (ineq) {</span>
<a href="#l36.142"></a><span id="l36.142" class="difflineplus">+            case '':</span>
<a href="#l36.143"></a><span id="l36.143" class="difflineplus">+            case '==':</span>
<a href="#l36.144"></a><span id="l36.144" class="difflineplus">+                return memberCount == rhs;</span>
<a href="#l36.145"></a><span id="l36.145" class="difflineplus">+            case '&lt;':</span>
<a href="#l36.146"></a><span id="l36.146" class="difflineplus">+                return memberCount &lt; rhs;</span>
<a href="#l36.147"></a><span id="l36.147" class="difflineplus">+            case '&gt;':</span>
<a href="#l36.148"></a><span id="l36.148" class="difflineplus">+                return memberCount &gt; rhs;</span>
<a href="#l36.149"></a><span id="l36.149" class="difflineplus">+            case '&lt;=':</span>
<a href="#l36.150"></a><span id="l36.150" class="difflineplus">+                return memberCount &lt;= rhs;</span>
<a href="#l36.151"></a><span id="l36.151" class="difflineplus">+            case '&gt;=':</span>
<a href="#l36.152"></a><span id="l36.152" class="difflineplus">+                return memberCount &gt;= rhs;</span>
<a href="#l36.153"></a><span id="l36.153" class="difflineplus">+            default:</span>
<a href="#l36.154"></a><span id="l36.154" class="difflineplus">+                return false;</span>
<a href="#l36.155"></a><span id="l36.155" class="difflineplus">+        }</span>
<a href="#l36.156"></a><span id="l36.156" class="difflineplus">+    };</span>
<a href="#l36.157"></a><span id="l36.157" class="difflineplus">+</span>
<a href="#l36.158"></a><span id="l36.158" class="difflineplus">+    var eventFulfillsDisplayNameCondition = function(cond, ev) {</span>
<a href="#l36.159"></a><span id="l36.159" class="difflineplus">+        var content = ev.getContent();</span>
<a href="#l36.160"></a><span id="l36.160" class="difflineplus">+        if (!content || !content.body || typeof content.body != 'string') {</span>
<a href="#l36.161"></a><span id="l36.161" class="difflineplus">+            return false;</span>
<a href="#l36.162"></a><span id="l36.162" class="difflineplus">+        }</span>
<a href="#l36.163"></a><span id="l36.163" class="difflineplus">+</span>
<a href="#l36.164"></a><span id="l36.164" class="difflineplus">+        var room = client.getRoom(ev.getRoomId());</span>
<a href="#l36.165"></a><span id="l36.165" class="difflineplus">+        if (!room || !room.currentState || !room.currentState.members ||</span>
<a href="#l36.166"></a><span id="l36.166" class="difflineplus">+            !room.currentState.getMember(client.credentials.userId)) { return false; }</span>
<a href="#l36.167"></a><span id="l36.167" class="difflineplus">+</span>
<a href="#l36.168"></a><span id="l36.168" class="difflineplus">+        var displayName = room.currentState.getMember(client.credentials.userId).name;</span>
<a href="#l36.169"></a><span id="l36.169" class="difflineplus">+</span>
<a href="#l36.170"></a><span id="l36.170" class="difflineplus">+        // N.B. we can't use \b as it chokes on unicode. however \W seems to be okay</span>
<a href="#l36.171"></a><span id="l36.171" class="difflineplus">+        // as shorthand for [^0-9A-Za-z_].</span>
<a href="#l36.172"></a><span id="l36.172" class="difflineplus">+        var pat = new RegExp(&quot;(^|\\W)&quot; + escapeRegExp(displayName) + &quot;(\\W|$)&quot;, 'i');</span>
<a href="#l36.173"></a><span id="l36.173" class="difflineplus">+        return content.body.search(pat) &gt; -1;</span>
<a href="#l36.174"></a><span id="l36.174" class="difflineplus">+    };</span>
<a href="#l36.175"></a><span id="l36.175" class="difflineplus">+</span>
<a href="#l36.176"></a><span id="l36.176" class="difflineplus">+    var eventFulfillsDeviceCondition = function(cond, ev) {</span>
<a href="#l36.177"></a><span id="l36.177" class="difflineplus">+        return false; // XXX: Allow a profile tag to be set for the web client instance</span>
<a href="#l36.178"></a><span id="l36.178" class="difflineplus">+    };</span>
<a href="#l36.179"></a><span id="l36.179" class="difflineplus">+</span>
<a href="#l36.180"></a><span id="l36.180" class="difflineplus">+    var eventFulfillsEventMatchCondition = function(cond, ev) {</span>
<a href="#l36.181"></a><span id="l36.181" class="difflineplus">+        var val = valueForDottedKey(cond.key, ev);</span>
<a href="#l36.182"></a><span id="l36.182" class="difflineplus">+        if (!val || typeof val != 'string') { return false; }</span>
<a href="#l36.183"></a><span id="l36.183" class="difflineplus">+</span>
<a href="#l36.184"></a><span id="l36.184" class="difflineplus">+        var pat;</span>
<a href="#l36.185"></a><span id="l36.185" class="difflineplus">+        if (cond.key == 'content.body') {</span>
<a href="#l36.186"></a><span id="l36.186" class="difflineplus">+            pat = '(^|\\W)' + globToRegexp(cond.pattern) + '(\\W|$)';</span>
<a href="#l36.187"></a><span id="l36.187" class="difflineplus">+        } else {</span>
<a href="#l36.188"></a><span id="l36.188" class="difflineplus">+            pat = '^' + globToRegexp(cond.pattern) + '$';</span>
<a href="#l36.189"></a><span id="l36.189" class="difflineplus">+        }</span>
<a href="#l36.190"></a><span id="l36.190" class="difflineplus">+        var regex = new RegExp(pat, 'i');</span>
<a href="#l36.191"></a><span id="l36.191" class="difflineplus">+        return !!val.match(regex);</span>
<a href="#l36.192"></a><span id="l36.192" class="difflineplus">+    };</span>
<a href="#l36.193"></a><span id="l36.193" class="difflineplus">+</span>
<a href="#l36.194"></a><span id="l36.194" class="difflineplus">+    var globToRegexp = function(glob) {</span>
<a href="#l36.195"></a><span id="l36.195" class="difflineplus">+        // From</span>
<a href="#l36.196"></a><span id="l36.196" class="difflineplus">+        // https://github.com/matrix-org/synapse/blob/abbee6b29be80a77e05730707602f3bbfc3f38cb/synapse/push/__init__.py#L132</span>
<a href="#l36.197"></a><span id="l36.197" class="difflineplus">+        // Because micromatch is about 130KB with dependencies,</span>
<a href="#l36.198"></a><span id="l36.198" class="difflineplus">+        // and minimatch is not much better.</span>
<a href="#l36.199"></a><span id="l36.199" class="difflineplus">+        var pat = escapeRegExp(glob);</span>
<a href="#l36.200"></a><span id="l36.200" class="difflineplus">+        pat = pat.replace(/\\\*/, '.*');</span>
<a href="#l36.201"></a><span id="l36.201" class="difflineplus">+        pat = pat.replace(/\?/, '.');</span>
<a href="#l36.202"></a><span id="l36.202" class="difflineplus">+        pat = pat.replace(/\\\[(!|)(.*)\\]/, function(match, p1, p2, offset, string) {</span>
<a href="#l36.203"></a><span id="l36.203" class="difflineplus">+            var first = p1 &amp;&amp; '^' || '';</span>
<a href="#l36.204"></a><span id="l36.204" class="difflineplus">+            var second = p2.replace(/\\\-/, '-');</span>
<a href="#l36.205"></a><span id="l36.205" class="difflineplus">+            return '[' + first + second + ']';</span>
<a href="#l36.206"></a><span id="l36.206" class="difflineplus">+        });</span>
<a href="#l36.207"></a><span id="l36.207" class="difflineplus">+        return pat;</span>
<a href="#l36.208"></a><span id="l36.208" class="difflineplus">+    };</span>
<a href="#l36.209"></a><span id="l36.209" class="difflineplus">+</span>
<a href="#l36.210"></a><span id="l36.210" class="difflineplus">+    var valueForDottedKey = function(key, ev) {</span>
<a href="#l36.211"></a><span id="l36.211" class="difflineplus">+        var parts = key.split('.');</span>
<a href="#l36.212"></a><span id="l36.212" class="difflineplus">+        var val;</span>
<a href="#l36.213"></a><span id="l36.213" class="difflineplus">+</span>
<a href="#l36.214"></a><span id="l36.214" class="difflineplus">+        // special-case the first component to deal with encrypted messages</span>
<a href="#l36.215"></a><span id="l36.215" class="difflineplus">+        var firstPart = parts[0];</span>
<a href="#l36.216"></a><span id="l36.216" class="difflineplus">+        if (firstPart == 'content') {</span>
<a href="#l36.217"></a><span id="l36.217" class="difflineplus">+            val = ev.getContent();</span>
<a href="#l36.218"></a><span id="l36.218" class="difflineplus">+            parts.shift();</span>
<a href="#l36.219"></a><span id="l36.219" class="difflineplus">+        } else if (firstPart == 'type') {</span>
<a href="#l36.220"></a><span id="l36.220" class="difflineplus">+            val = ev.getType();</span>
<a href="#l36.221"></a><span id="l36.221" class="difflineplus">+            parts.shift();</span>
<a href="#l36.222"></a><span id="l36.222" class="difflineplus">+        } else {</span>
<a href="#l36.223"></a><span id="l36.223" class="difflineplus">+            // use the raw event for any other fields</span>
<a href="#l36.224"></a><span id="l36.224" class="difflineplus">+            val = ev.event;</span>
<a href="#l36.225"></a><span id="l36.225" class="difflineplus">+        }</span>
<a href="#l36.226"></a><span id="l36.226" class="difflineplus">+</span>
<a href="#l36.227"></a><span id="l36.227" class="difflineplus">+        while (parts.length &gt; 0) {</span>
<a href="#l36.228"></a><span id="l36.228" class="difflineplus">+            var thispart = parts.shift();</span>
<a href="#l36.229"></a><span id="l36.229" class="difflineplus">+            if (!val[thispart]) { return null; }</span>
<a href="#l36.230"></a><span id="l36.230" class="difflineplus">+            val = val[thispart];</span>
<a href="#l36.231"></a><span id="l36.231" class="difflineplus">+        }</span>
<a href="#l36.232"></a><span id="l36.232" class="difflineplus">+        return val;</span>
<a href="#l36.233"></a><span id="l36.233" class="difflineplus">+    };</span>
<a href="#l36.234"></a><span id="l36.234" class="difflineplus">+</span>
<a href="#l36.235"></a><span id="l36.235" class="difflineplus">+    var matchingRuleForEventWithRulesets = function(ev, rulesets) {</span>
<a href="#l36.236"></a><span id="l36.236" class="difflineplus">+        if (!rulesets || !rulesets.device) { return null; }</span>
<a href="#l36.237"></a><span id="l36.237" class="difflineplus">+        if (ev.getSender() == client.credentials.userId) { return null; }</span>
<a href="#l36.238"></a><span id="l36.238" class="difflineplus">+</span>
<a href="#l36.239"></a><span id="l36.239" class="difflineplus">+        var allDevNames = Object.keys(rulesets.device);</span>
<a href="#l36.240"></a><span id="l36.240" class="difflineplus">+        for (var i = 0; i &lt; allDevNames.length; ++i) {</span>
<a href="#l36.241"></a><span id="l36.241" class="difflineplus">+            var devname = allDevNames[i];</span>
<a href="#l36.242"></a><span id="l36.242" class="difflineplus">+            var devrules = rulesets.device[devname];</span>
<a href="#l36.243"></a><span id="l36.243" class="difflineplus">+</span>
<a href="#l36.244"></a><span id="l36.244" class="difflineplus">+            var matchingRule = matchingRuleFromKindSet(devrules, devname);</span>
<a href="#l36.245"></a><span id="l36.245" class="difflineplus">+            if (matchingRule) { return matchingRule; }</span>
<a href="#l36.246"></a><span id="l36.246" class="difflineplus">+        }</span>
<a href="#l36.247"></a><span id="l36.247" class="difflineplus">+        return matchingRuleFromKindSet(ev, rulesets.global);</span>
<a href="#l36.248"></a><span id="l36.248" class="difflineplus">+    };</span>
<a href="#l36.249"></a><span id="l36.249" class="difflineplus">+</span>
<a href="#l36.250"></a><span id="l36.250" class="difflineplus">+    var pushActionsForEventAndRulesets = function(ev, rulesets) {</span>
<a href="#l36.251"></a><span id="l36.251" class="difflineplus">+        var rule = matchingRuleForEventWithRulesets(ev, rulesets);</span>
<a href="#l36.252"></a><span id="l36.252" class="difflineplus">+        if (!rule) { return {}; }</span>
<a href="#l36.253"></a><span id="l36.253" class="difflineplus">+</span>
<a href="#l36.254"></a><span id="l36.254" class="difflineplus">+        var actionObj = PushProcessor.actionListToActionsObject(rule.actions);</span>
<a href="#l36.255"></a><span id="l36.255" class="difflineplus">+</span>
<a href="#l36.256"></a><span id="l36.256" class="difflineplus">+        // Some actions are implicit in some situations: we add those here</span>
<a href="#l36.257"></a><span id="l36.257" class="difflineplus">+        if (actionObj.tweaks.highlight === undefined) {</span>
<a href="#l36.258"></a><span id="l36.258" class="difflineplus">+            // if it isn't specified, highlight if it's a content</span>
<a href="#l36.259"></a><span id="l36.259" class="difflineplus">+            // rule but otherwise not</span>
<a href="#l36.260"></a><span id="l36.260" class="difflineplus">+            actionObj.tweaks.highlight = (rule.kind == 'content');</span>
<a href="#l36.261"></a><span id="l36.261" class="difflineplus">+        }</span>
<a href="#l36.262"></a><span id="l36.262" class="difflineplus">+</span>
<a href="#l36.263"></a><span id="l36.263" class="difflineplus">+        return actionObj;</span>
<a href="#l36.264"></a><span id="l36.264" class="difflineplus">+    };</span>
<a href="#l36.265"></a><span id="l36.265" class="difflineplus">+</span>
<a href="#l36.266"></a><span id="l36.266" class="difflineplus">+    /**</span>
<a href="#l36.267"></a><span id="l36.267" class="difflineplus">+     * Get the user's push actions for the given event</span>
<a href="#l36.268"></a><span id="l36.268" class="difflineplus">+     *</span>
<a href="#l36.269"></a><span id="l36.269" class="difflineplus">+     * @param {module:models/event.MatrixEvent} ev</span>
<a href="#l36.270"></a><span id="l36.270" class="difflineplus">+     *</span>
<a href="#l36.271"></a><span id="l36.271" class="difflineplus">+     * @return {PushAction}</span>
<a href="#l36.272"></a><span id="l36.272" class="difflineplus">+     */</span>
<a href="#l36.273"></a><span id="l36.273" class="difflineplus">+    this.actionsForEvent = function(ev) {</span>
<a href="#l36.274"></a><span id="l36.274" class="difflineplus">+        return pushActionsForEventAndRulesets(ev, client.pushRules);</span>
<a href="#l36.275"></a><span id="l36.275" class="difflineplus">+    };</span>
<a href="#l36.276"></a><span id="l36.276" class="difflineplus">+}</span>
<a href="#l36.277"></a><span id="l36.277" class="difflineplus">+</span>
<a href="#l36.278"></a><span id="l36.278" class="difflineplus">+/**</span>
<a href="#l36.279"></a><span id="l36.279" class="difflineplus">+ * Convert a list of actions into a object with the actions as keys and their values</span>
<a href="#l36.280"></a><span id="l36.280" class="difflineplus">+ * eg. [ 'notify', { set_tweak: 'sound', value: 'default' } ]</span>
<a href="#l36.281"></a><span id="l36.281" class="difflineplus">+ *     becomes { notify: true, tweaks: { sound: 'default' } }</span>
<a href="#l36.282"></a><span id="l36.282" class="difflineplus">+ * @param {array} actionlist The actions list</span>
<a href="#l36.283"></a><span id="l36.283" class="difflineplus">+ *</span>
<a href="#l36.284"></a><span id="l36.284" class="difflineplus">+ * @return {object} A object with key 'notify' (true or false) and an object of actions</span>
<a href="#l36.285"></a><span id="l36.285" class="difflineplus">+ */</span>
<a href="#l36.286"></a><span id="l36.286" class="difflineplus">+PushProcessor.actionListToActionsObject = function(actionlist) {</span>
<a href="#l36.287"></a><span id="l36.287" class="difflineplus">+    var actionobj = { 'notify': false, 'tweaks': {} };</span>
<a href="#l36.288"></a><span id="l36.288" class="difflineplus">+    for (var i = 0; i &lt; actionlist.length; ++i) {</span>
<a href="#l36.289"></a><span id="l36.289" class="difflineplus">+        var action = actionlist[i];</span>
<a href="#l36.290"></a><span id="l36.290" class="difflineplus">+        if (action === 'notify') {</span>
<a href="#l36.291"></a><span id="l36.291" class="difflineplus">+            actionobj.notify = true;</span>
<a href="#l36.292"></a><span id="l36.292" class="difflineplus">+        } else if (typeof action === 'object') {</span>
<a href="#l36.293"></a><span id="l36.293" class="difflineplus">+            if (action.value === undefined) { action.value = true; }</span>
<a href="#l36.294"></a><span id="l36.294" class="difflineplus">+            actionobj.tweaks[action.set_tweak] = action.value;</span>
<a href="#l36.295"></a><span id="l36.295" class="difflineplus">+        }</span>
<a href="#l36.296"></a><span id="l36.296" class="difflineplus">+    }</span>
<a href="#l36.297"></a><span id="l36.297" class="difflineplus">+    return actionobj;</span>
<a href="#l36.298"></a><span id="l36.298" class="difflineplus">+};</span>
<a href="#l36.299"></a><span id="l36.299" class="difflineplus">+</span>
<a href="#l36.300"></a><span id="l36.300" class="difflineplus">+/**</span>
<a href="#l36.301"></a><span id="l36.301" class="difflineplus">+ * @typedef {Object} PushAction</span>
<a href="#l36.302"></a><span id="l36.302" class="difflineplus">+ * @type {Object}</span>
<a href="#l36.303"></a><span id="l36.303" class="difflineplus">+ * @property {boolean} notify Whether this event should notify the user or not.</span>
<a href="#l36.304"></a><span id="l36.304" class="difflineplus">+ * @property {Object} tweaks How this event should be notified.</span>
<a href="#l36.305"></a><span id="l36.305" class="difflineplus">+ * @property {boolean} tweaks.highlight Whether this event should be highlighted</span>
<a href="#l36.306"></a><span id="l36.306" class="difflineplus">+ * on the UI.</span>
<a href="#l36.307"></a><span id="l36.307" class="difflineplus">+ * @property {boolean} tweaks.sound Whether this notification should produce a</span>
<a href="#l36.308"></a><span id="l36.308" class="difflineplus">+ * noise.</span>
<a href="#l36.309"></a><span id="l36.309" class="difflineplus">+ */</span>
<a href="#l36.310"></a><span id="l36.310" class="difflineplus">+</span>
<a href="#l36.311"></a><span id="l36.311" class="difflineplus">+/** The PushProcessor class. */</span>
<a href="#l36.312"></a><span id="l36.312" class="difflineplus">+module.exports = PushProcessor;</span>
<a href="#l36.313"></a><span id="l36.313" class="difflineplus">+</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l37.1"></a><span id="l37.1">new file mode 100644</span>
<a href="#l37.2"></a><span id="l37.2" class="difflineminus">--- /dev/null</span>
<a href="#l37.3"></a><span id="l37.3" class="difflineplus">+++ b/chat/protocols/matrix/matrix-sdk/q/q.js</span>
<a href="#l37.4"></a><span id="l37.4" class="difflineat">@@ -0,0 +1,2048 @@</span>
<a href="#l37.5"></a><span id="l37.5" class="difflineplus">+// vim:ts=4:sts=4:sw=4:</span>
<a href="#l37.6"></a><span id="l37.6" class="difflineplus">+/*!</span>
<a href="#l37.7"></a><span id="l37.7" class="difflineplus">+ *</span>
<a href="#l37.8"></a><span id="l37.8" class="difflineplus">+ * Copyright 2009-2012 Kris Kowal under the terms of the MIT</span>
<a href="#l37.9"></a><span id="l37.9" class="difflineplus">+ * license found at http://github.com/kriskowal/q/raw/master/LICENSE</span>
<a href="#l37.10"></a><span id="l37.10" class="difflineplus">+ *</span>
<a href="#l37.11"></a><span id="l37.11" class="difflineplus">+ * With parts by Tyler Close</span>
<a href="#l37.12"></a><span id="l37.12" class="difflineplus">+ * Copyright 2007-2009 Tyler Close under the terms of the MIT X license found</span>
<a href="#l37.13"></a><span id="l37.13" class="difflineplus">+ * at http://www.opensource.org/licenses/mit-license.html</span>
<a href="#l37.14"></a><span id="l37.14" class="difflineplus">+ * Forked at ref_send.js version: 2009-05-11</span>
<a href="#l37.15"></a><span id="l37.15" class="difflineplus">+ *</span>
<a href="#l37.16"></a><span id="l37.16" class="difflineplus">+ * With parts by Mark Miller</span>
<a href="#l37.17"></a><span id="l37.17" class="difflineplus">+ * Copyright (C) 2011 Google Inc.</span>
<a href="#l37.18"></a><span id="l37.18" class="difflineplus">+ *</span>
<a href="#l37.19"></a><span id="l37.19" class="difflineplus">+ * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<a href="#l37.20"></a><span id="l37.20" class="difflineplus">+ * you may not use this file except in compliance with the License.</span>
<a href="#l37.21"></a><span id="l37.21" class="difflineplus">+ * You may obtain a copy of the License at</span>
<a href="#l37.22"></a><span id="l37.22" class="difflineplus">+ *</span>
<a href="#l37.23"></a><span id="l37.23" class="difflineplus">+ * http://www.apache.org/licenses/LICENSE-2.0</span>
<a href="#l37.24"></a><span id="l37.24" class="difflineplus">+ *</span>
<a href="#l37.25"></a><span id="l37.25" class="difflineplus">+ * Unless required by applicable law or agreed to in writing, software</span>
<a href="#l37.26"></a><span id="l37.26" class="difflineplus">+ * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<a href="#l37.27"></a><span id="l37.27" class="difflineplus">+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<a href="#l37.28"></a><span id="l37.28" class="difflineplus">+ * See the License for the specific language governing permissions and</span>
<a href="#l37.29"></a><span id="l37.29" class="difflineplus">+ * limitations under the License.</span>
<a href="#l37.30"></a><span id="l37.30" class="difflineplus">+ *</span>
<a href="#l37.31"></a><span id="l37.31" class="difflineplus">+ */</span>
<a href="#l37.32"></a><span id="l37.32" class="difflineplus">+</span>
<a href="#l37.33"></a><span id="l37.33" class="difflineplus">+(function (definition) {</span>
<a href="#l37.34"></a><span id="l37.34" class="difflineplus">+    &quot;use strict&quot;;</span>
<a href="#l37.35"></a><span id="l37.35" class="difflineplus">+</span>
<a href="#l37.36"></a><span id="l37.36" class="difflineplus">+    // This file will function properly as a &lt;script&gt; tag, or a module</span>
<a href="#l37.37"></a><span id="l37.37" class="difflineplus">+    // using CommonJS and NodeJS or RequireJS module formats.  In</span>
<a href="#l37.38"></a><span id="l37.38" class="difflineplus">+    // Common/Node/RequireJS, the module exports the Q API and when</span>
<a href="#l37.39"></a><span id="l37.39" class="difflineplus">+    // executed as a simple &lt;script&gt;, it creates a Q global instead.</span>
<a href="#l37.40"></a><span id="l37.40" class="difflineplus">+</span>
<a href="#l37.41"></a><span id="l37.41" class="difflineplus">+    // Montage Require</span>
<a href="#l37.42"></a><span id="l37.42" class="difflineplus">+    if (typeof bootstrap === &quot;function&quot;) {</span>
<a href="#l37.43"></a><span id="l37.43" class="difflineplus">+        bootstrap(&quot;promise&quot;, definition);</span>
<a href="#l37.44"></a><span id="l37.44" class="difflineplus">+</span>
<a href="#l37.45"></a><span id="l37.45" class="difflineplus">+    // CommonJS</span>
<a href="#l37.46"></a><span id="l37.46" class="difflineplus">+    } else if (typeof exports === &quot;object&quot; &amp;&amp; typeof module === &quot;object&quot;) {</span>
<a href="#l37.47"></a><span id="l37.47" class="difflineplus">+        module.exports = definition();</span>
<a href="#l37.48"></a><span id="l37.48" class="difflineplus">+</span>
<a href="#l37.49"></a><span id="l37.49" class="difflineplus">+    // RequireJS</span>
<a href="#l37.50"></a><span id="l37.50" class="difflineplus">+    } else if (typeof define === &quot;function&quot; &amp;&amp; define.amd) {</span>
<a href="#l37.51"></a><span id="l37.51" class="difflineplus">+        define(definition);</span>
<a href="#l37.52"></a><span id="l37.52" class="difflineplus">+</span>
<a href="#l37.53"></a><span id="l37.53" class="difflineplus">+    // SES (Secure EcmaScript)</span>
<a href="#l37.54"></a><span id="l37.54" class="difflineplus">+    } else if (typeof ses !== &quot;undefined&quot;) {</span>
<a href="#l37.55"></a><span id="l37.55" class="difflineplus">+        if (!ses.ok()) {</span>
<a href="#l37.56"></a><span id="l37.56" class="difflineplus">+            return;</span>
<a href="#l37.57"></a><span id="l37.57" class="difflineplus">+        } else {</span>
<a href="#l37.58"></a><span id="l37.58" class="difflineplus">+            ses.makeQ = definition;</span>
<a href="#l37.59"></a><span id="l37.59" class="difflineplus">+        }</span>
<a href="#l37.60"></a><span id="l37.60" class="difflineplus">+</span>
<a href="#l37.61"></a><span id="l37.61" class="difflineplus">+    // &lt;script&gt;</span>
<a href="#l37.62"></a><span id="l37.62" class="difflineplus">+    } else if (typeof window !== &quot;undefined&quot; || typeof self !== &quot;undefined&quot;) {</span>
<a href="#l37.63"></a><span id="l37.63" class="difflineplus">+        // Prefer window over self for add-on scripts. Use self for</span>
<a href="#l37.64"></a><span id="l37.64" class="difflineplus">+        // non-windowed contexts.</span>
<a href="#l37.65"></a><span id="l37.65" class="difflineplus">+        var global = typeof window !== &quot;undefined&quot; ? window : self;</span>
<a href="#l37.66"></a><span id="l37.66" class="difflineplus">+</span>
<a href="#l37.67"></a><span id="l37.67" class="difflineplus">+        // Get the `window` object, save the previous Q global</span>
<a href="#l37.68"></a><span id="l37.68" class="difflineplus">+        // and initialize Q as a global.</span>
<a href="#l37.69"></a><span id="l37.69" class="difflineplus">+        var previousQ = global.Q;</span>
<a href="#l37.70"></a><span id="l37.70" class="difflineplus">+        global.Q = definition();</span>
<a href="#l37.71"></a><span id="l37.71" class="difflineplus">+</span>
<a href="#l37.72"></a><span id="l37.72" class="difflineplus">+        // Add a noConflict function so Q can be removed from the</span>
<a href="#l37.73"></a><span id="l37.73" class="difflineplus">+        // global namespace.</span>
<a href="#l37.74"></a><span id="l37.74" class="difflineplus">+        global.Q.noConflict = function () {</span>
<a href="#l37.75"></a><span id="l37.75" class="difflineplus">+            global.Q = previousQ;</span>
<a href="#l37.76"></a><span id="l37.76" class="difflineplus">+            return this;</span>
<a href="#l37.77"></a><span id="l37.77" class="difflineplus">+        };</span>
<a href="#l37.78"></a><span id="l37.78" class="difflineplus">+</span>
<a href="#l37.79"></a><span id="l37.79" class="difflineplus">+    } else {</span>
<a href="#l37.80"></a><span id="l37.80" class="difflineplus">+        throw new Error(&quot;This environment was not anticipated by Q. Please file a bug.&quot;);</span>
<a href="#l37.81"></a><span id="l37.81" class="difflineplus">+    }</span>
<a href="#l37.82"></a><span id="l37.82" class="difflineplus">+</span>
<a href="#l37.83"></a><span id="l37.83" class="difflineplus">+})(function () {</span>
<a href="#l37.84"></a><span id="l37.84" class="difflineplus">+&quot;use strict&quot;;</span>
<a href="#l37.85"></a><span id="l37.85" class="difflineplus">+</span>
<a href="#l37.86"></a><span id="l37.86" class="difflineplus">+var hasStacks = false;</span>
<a href="#l37.87"></a><span id="l37.87" class="difflineplus">+try {</span>
<a href="#l37.88"></a><span id="l37.88" class="difflineplus">+    throw new Error();</span>
<a href="#l37.89"></a><span id="l37.89" class="difflineplus">+} catch (e) {</span>
<a href="#l37.90"></a><span id="l37.90" class="difflineplus">+    hasStacks = !!e.stack;</span>
<a href="#l37.91"></a><span id="l37.91" class="difflineplus">+}</span>
<a href="#l37.92"></a><span id="l37.92" class="difflineplus">+</span>
<a href="#l37.93"></a><span id="l37.93" class="difflineplus">+// All code after this point will be filtered from stack traces reported</span>
<a href="#l37.94"></a><span id="l37.94" class="difflineplus">+// by Q.</span>
<a href="#l37.95"></a><span id="l37.95" class="difflineplus">+var qStartingLine = captureLine();</span>
<a href="#l37.96"></a><span id="l37.96" class="difflineplus">+var qFileName;</span>
<a href="#l37.97"></a><span id="l37.97" class="difflineplus">+</span>
<a href="#l37.98"></a><span id="l37.98" class="difflineplus">+// shims</span>
<a href="#l37.99"></a><span id="l37.99" class="difflineplus">+</span>
<a href="#l37.100"></a><span id="l37.100" class="difflineplus">+// used for fallback in &quot;allResolved&quot;</span>
<a href="#l37.101"></a><span id="l37.101" class="difflineplus">+var noop = function () {};</span>
<a href="#l37.102"></a><span id="l37.102" class="difflineplus">+</span>
<a href="#l37.103"></a><span id="l37.103" class="difflineplus">+// Use the fastest possible means to execute a task in a future turn</span>
<a href="#l37.104"></a><span id="l37.104" class="difflineplus">+// of the event loop.</span>
<a href="#l37.105"></a><span id="l37.105" class="difflineplus">+var nextTick =(function () {</span>
<a href="#l37.106"></a><span id="l37.106" class="difflineplus">+    // linked list of tasks (single, with head node)</span>
<a href="#l37.107"></a><span id="l37.107" class="difflineplus">+    var head = {task: void 0, next: null};</span>
<a href="#l37.108"></a><span id="l37.108" class="difflineplus">+    var tail = head;</span>
<a href="#l37.109"></a><span id="l37.109" class="difflineplus">+    var flushing = false;</span>
<a href="#l37.110"></a><span id="l37.110" class="difflineplus">+    var requestTick = void 0;</span>
<a href="#l37.111"></a><span id="l37.111" class="difflineplus">+    var isNodeJS = false;</span>
<a href="#l37.112"></a><span id="l37.112" class="difflineplus">+    // queue for late tasks, used by unhandled rejection tracking</span>
<a href="#l37.113"></a><span id="l37.113" class="difflineplus">+    var laterQueue = [];</span>
<a href="#l37.114"></a><span id="l37.114" class="difflineplus">+</span>
<a href="#l37.115"></a><span id="l37.115" class="difflineplus">+    function flush() {</span>
<a href="#l37.116"></a><span id="l37.116" class="difflineplus">+        /* jshint loopfunc: true */</span>
<a href="#l37.117"></a><span id="l37.117" class="difflineplus">+        var task, domain;</span>
<a href="#l37.118"></a><span id="l37.118" class="difflineplus">+</span>
<a href="#l37.119"></a><span id="l37.119" class="difflineplus">+        while (head.next) {</span>
<a href="#l37.120"></a><span id="l37.120" class="difflineplus">+            head = head.next;</span>
<a href="#l37.121"></a><span id="l37.121" class="difflineplus">+            task = head.task;</span>
<a href="#l37.122"></a><span id="l37.122" class="difflineplus">+            head.task = void 0;</span>
<a href="#l37.123"></a><span id="l37.123" class="difflineplus">+            domain = head.domain;</span>
<a href="#l37.124"></a><span id="l37.124" class="difflineplus">+</span>
<a href="#l37.125"></a><span id="l37.125" class="difflineplus">+            if (domain) {</span>
<a href="#l37.126"></a><span id="l37.126" class="difflineplus">+                head.domain = void 0;</span>
<a href="#l37.127"></a><span id="l37.127" class="difflineplus">+                domain.enter();</span>
<a href="#l37.128"></a><span id="l37.128" class="difflineplus">+            }</span>
<a href="#l37.129"></a><span id="l37.129" class="difflineplus">+            runSingle(task, domain);</span>
<a href="#l37.130"></a><span id="l37.130" class="difflineplus">+</span>
<a href="#l37.131"></a><span id="l37.131" class="difflineplus">+        }</span>
<a href="#l37.132"></a><span id="l37.132" class="difflineplus">+        while (laterQueue.length) {</span>
<a href="#l37.133"></a><span id="l37.133" class="difflineplus">+            task = laterQueue.pop();</span>
<a href="#l37.134"></a><span id="l37.134" class="difflineplus">+            runSingle(task);</span>
<a href="#l37.135"></a><span id="l37.135" class="difflineplus">+        }</span>
<a href="#l37.136"></a><span id="l37.136" class="difflineplus">+        flushing = false;</span>
<a href="#l37.137"></a><span id="l37.137" class="difflineplus">+    }</span>
<a href="#l37.138"></a><span id="l37.138" class="difflineplus">+    // runs a single function in the async queue</span>
<a href="#l37.139"></a><span id="l37.139" class="difflineplus">+    function runSingle(task, domain) {</span>
<a href="#l37.140"></a><span id="l37.140" class="difflineplus">+        try {</span>
<a href="#l37.141"></a><span id="l37.141" class="difflineplus">+            task();</span>
<a href="#l37.142"></a><span id="l37.142" class="difflineplus">+</span>
<a href="#l37.143"></a><span id="l37.143" class="difflineplus">+        } catch (e) {</span>
<a href="#l37.144"></a><span id="l37.144" class="difflineplus">+            if (isNodeJS) {</span>
<a href="#l37.145"></a><span id="l37.145" class="difflineplus">+                // In node, uncaught exceptions are considered fatal errors.</span>
<a href="#l37.146"></a><span id="l37.146" class="difflineplus">+                // Re-throw them synchronously to interrupt flushing!</span>
<a href="#l37.147"></a><span id="l37.147" class="difflineplus">+</span>
<a href="#l37.148"></a><span id="l37.148" class="difflineplus">+                // Ensure continuation if the uncaught exception is suppressed</span>
<a href="#l37.149"></a><span id="l37.149" class="difflineplus">+                // listening &quot;uncaughtException&quot; events (as domains does).</span>
<a href="#l37.150"></a><span id="l37.150" class="difflineplus">+                // Continue in next event to avoid tick recursion.</span>
<a href="#l37.151"></a><span id="l37.151" class="difflineplus">+                if (domain) {</span>
<a href="#l37.152"></a><span id="l37.152" class="difflineplus">+                    domain.exit();</span>
<a href="#l37.153"></a><span id="l37.153" class="difflineplus">+                }</span>
<a href="#l37.154"></a><span id="l37.154" class="difflineplus">+                setTimeout(flush, 0);</span>
<a href="#l37.155"></a><span id="l37.155" class="difflineplus">+                if (domain) {</span>
<a href="#l37.156"></a><span id="l37.156" class="difflineplus">+                    domain.enter();</span>
<a href="#l37.157"></a><span id="l37.157" class="difflineplus">+                }</span>
<a href="#l37.158"></a><span id="l37.158" class="difflineplus">+</span>
<a href="#l37.159"></a><span id="l37.159" class="difflineplus">+                throw e;</span>
<a href="#l37.160"></a><span id="l37.160" class="difflineplus">+</span>
<a href="#l37.161"></a><span id="l37.161" class="difflineplus">+            } else {</span>
<a href="#l37.162"></a><span id="l37.162" class="difflineplus">+                // In browsers, uncaught exceptions are not fatal.</span>
<a href="#l37.163"></a><span id="l37.163" class="difflineplus">+                // Re-throw them asynchronously to avoid slow-downs.</span>
<a href="#l37.164"></a><span id="l37.164" class="difflineplus">+                setTimeout(function () {</span>
<a href="#l37.165"></a><span id="l37.165" class="difflineplus">+                    throw e;</span>
<a href="#l37.166"></a><span id="l37.166" class="difflineplus">+                }, 0);</span>
<a href="#l37.167"></a><span id="l37.167" class="difflineplus">+            }</span>
<a href="#l37.168"></a><span id="l37.168" class="difflineplus">+        }</span>
<a href="#l37.169"></a><span id="l37.169" class="difflineplus">+</span>
<a href="#l37.170"></a><span id="l37.170" class="difflineplus">+        if (domain) {</span>
<a href="#l37.171"></a><span id="l37.171" class="difflineplus">+            domain.exit();</span>
<a href="#l37.172"></a><span id="l37.172" class="difflineplus">+        }</span>
<a href="#l37.173"></a><span id="l37.173" class="difflineplus">+    }</span>
<a href="#l37.174"></a><span id="l37.174" class="difflineplus">+</span>
<a href="#l37.175"></a><span id="l37.175" class="difflineplus">+    nextTick = function (task) {</span>
<a href="#l37.176"></a><span id="l37.176" class="difflineplus">+        tail = tail.next = {</span>
<a href="#l37.177"></a><span id="l37.177" class="difflineplus">+            task: task,</span>
<a href="#l37.178"></a><span id="l37.178" class="difflineplus">+            domain: isNodeJS &amp;&amp; process.domain,</span>
<a href="#l37.179"></a><span id="l37.179" class="difflineplus">+            next: null</span>
<a href="#l37.180"></a><span id="l37.180" class="difflineplus">+        };</span>
<a href="#l37.181"></a><span id="l37.181" class="difflineplus">+</span>
<a href="#l37.182"></a><span id="l37.182" class="difflineplus">+        if (!flushing) {</span>
<a href="#l37.183"></a><span id="l37.183" class="difflineplus">+            flushing = true;</span>
<a href="#l37.184"></a><span id="l37.184" class="difflineplus">+            requestTick();</span>
<a href="#l37.185"></a><span id="l37.185" class="difflineplus">+        }</span>
<a href="#l37.186"></a><span id="l37.186" class="difflineplus">+    };</span>
<a href="#l37.187"></a><span id="l37.187" class="difflineplus">+</span>
<a href="#l37.188"></a><span id="l37.188" class="difflineplus">+    if (typeof process === &quot;object&quot; &amp;&amp;</span>
<a href="#l37.189"></a><span id="l37.189" class="difflineplus">+        process.toString() === &quot;[object process]&quot; &amp;&amp; process.nextTick) {</span>
<a href="#l37.190"></a><span id="l37.190" class="difflineplus">+        // Ensure Q is in a real Node environment, with a `process.nextTick`.</span>
<a href="#l37.191"></a><span id="l37.191" class="difflineplus">+        // To see through fake Node environments:</span>
<a href="#l37.192"></a><span id="l37.192" class="difflineplus">+        // * Mocha test runner - exposes a `process` global without a `nextTick`</span>
<a href="#l37.193"></a><span id="l37.193" class="difflineplus">+        // * Browserify - exposes a `process.nexTick` function that uses</span>
<a href="#l37.194"></a><span id="l37.194" class="difflineplus">+        //   `setTimeout`. In this case `setImmediate` is preferred because</span>
<a href="#l37.195"></a><span id="l37.195" class="difflineplus">+        //    it is faster. Browserify's `process.toString()` yields</span>
<a href="#l37.196"></a><span id="l37.196" class="difflineplus">+        //   &quot;[object Object]&quot;, while in a real Node environment</span>
<a href="#l37.197"></a><span id="l37.197" class="difflineplus">+        //   `process.nextTick()` yields &quot;[object process]&quot;.</span>
<a href="#l37.198"></a><span id="l37.198" class="difflineplus">+        isNodeJS = true;</span>
<a href="#l37.199"></a><span id="l37.199" class="difflineplus">+</span>
<a href="#l37.200"></a><span id="l37.200" class="difflineplus">+        requestTick = function () {</span>
<a href="#l37.201"></a><span id="l37.201" class="difflineplus">+            process.nextTick(flush);</span>
<a href="#l37.202"></a><span id="l37.202" class="difflineplus">+        };</span>
<a href="#l37.203"></a><span id="l37.203" class="difflineplus">+</span>
<a href="#l37.204"></a><span id="l37.204" class="difflineplus">+    } else if (typeof setImmediate === &quot;function&quot;) {</span>
<a href="#l37.205"></a><span id="l37.205" class="difflineplus">+        // In IE10, Node.js 0.9+, or https://github.com/NobleJS/setImmediate</span>
<a href="#l37.206"></a><span id="l37.206" class="difflineplus">+        if (typeof window !== &quot;undefined&quot;) {</span>
<a href="#l37.207"></a><span id="l37.207" class="difflineplus">+            requestTick = setImmediate.bind(window, flush);</span>
<a href="#l37.208"></a><span id="l37.208" class="difflineplus">+        } else {</span>
<a href="#l37.209"></a><span id="l37.209" class="difflineplus">+            requestTick = function () {</span>
<a href="#l37.210"></a><span id="l37.210" class="difflineplus">+                setImmediate(flush);</span>
<a href="#l37.211"></a><span id="l37.211" class="difflineplus">+            };</span>
<a href="#l37.212"></a><span id="l37.212" class="difflineplus">+        }</span>
<a href="#l37.213"></a><span id="l37.213" class="difflineplus">+</span>
<a href="#l37.214"></a><span id="l37.214" class="difflineplus">+    } else if (typeof MessageChannel !== &quot;undefined&quot;) {</span>
<a href="#l37.215"></a><span id="l37.215" class="difflineplus">+        // modern browsers</span>
<a href="#l37.216"></a><span id="l37.216" class="difflineplus">+        // http://www.nonblocking.io/2011/06/windownexttick.html</span>
<a href="#l37.217"></a><span id="l37.217" class="difflineplus">+        var channel = new MessageChannel();</span>
<a href="#l37.218"></a><span id="l37.218" class="difflineplus">+        // At least Safari Version 6.0.5 (8536.30.1) intermittently cannot create</span>
<a href="#l37.219"></a><span id="l37.219" class="difflineplus">+        // working message ports the first time a page loads.</span>
<a href="#l37.220"></a><span id="l37.220" class="difflineplus">+        channel.port1.onmessage = function () {</span>
<a href="#l37.221"></a><span id="l37.221" class="difflineplus">+            requestTick = requestPortTick;</span>
<a href="#l37.222"></a><span id="l37.222" class="difflineplus">+            channel.port1.onmessage = flush;</span>
<a href="#l37.223"></a><span id="l37.223" class="difflineplus">+            flush();</span>
<a href="#l37.224"></a><span id="l37.224" class="difflineplus">+        };</span>
<a href="#l37.225"></a><span id="l37.225" class="difflineplus">+        var requestPortTick = function () {</span>
<a href="#l37.226"></a><span id="l37.226" class="difflineplus">+            // Opera requires us to provide a message payload, regardless of</span>
<a href="#l37.227"></a><span id="l37.227" class="difflineplus">+            // whether we use it.</span>
<a href="#l37.228"></a><span id="l37.228" class="difflineplus">+            channel.port2.postMessage(0);</span>
<a href="#l37.229"></a><span id="l37.229" class="difflineplus">+        };</span>
<a href="#l37.230"></a><span id="l37.230" class="difflineplus">+        requestTick = function () {</span>
<a href="#l37.231"></a><span id="l37.231" class="difflineplus">+            setTimeout(flush, 0);</span>
<a href="#l37.232"></a><span id="l37.232" class="difflineplus">+            requestPortTick();</span>
<a href="#l37.233"></a><span id="l37.233" class="difflineplus">+        };</span>
<a href="#l37.234"></a><span id="l37.234" class="difflineplus">+</span>
<a href="#l37.235"></a><span id="l37.235" class="difflineplus">+    } else {</span>
<a href="#l37.236"></a><span id="l37.236" class="difflineplus">+        // old browsers</span>
<a href="#l37.237"></a><span id="l37.237" class="difflineplus">+        requestTick = function () {</span>
<a href="#l37.238"></a><span id="l37.238" class="difflineplus">+            setTimeout(flush, 0);</span>
<a href="#l37.239"></a><span id="l37.239" class="difflineplus">+        };</span>
<a href="#l37.240"></a><span id="l37.240" class="difflineplus">+    }</span>
<a href="#l37.241"></a><span id="l37.241" class="difflineplus">+    // runs a task after all other tasks have been run</span>
<a href="#l37.242"></a><span id="l37.242" class="difflineplus">+    // this is useful for unhandled rejection tracking that needs to happen</span>
<a href="#l37.243"></a><span id="l37.243" class="difflineplus">+    // after all `then`d tasks have been run.</span>
<a href="#l37.244"></a><span id="l37.244" class="difflineplus">+    nextTick.runAfter = function (task) {</span>
<a href="#l37.245"></a><span id="l37.245" class="difflineplus">+        laterQueue.push(task);</span>
<a href="#l37.246"></a><span id="l37.246" class="difflineplus">+        if (!flushing) {</span>
<a href="#l37.247"></a><span id="l37.247" class="difflineplus">+            flushing = true;</span>
<a href="#l37.248"></a><span id="l37.248" class="difflineplus">+            requestTick();</span>
<a href="#l37.249"></a><span id="l37.249" class="difflineplus">+        }</span>
<a href="#l37.250"></a><span id="l37.250" class="difflineplus">+    };</span>
<a href="#l37.251"></a><span id="l37.251" class="difflineplus">+    return nextTick;</span>
<a href="#l37.252"></a><span id="l37.252" class="difflineplus">+})();</span>
<a href="#l37.253"></a><span id="l37.253" class="difflineplus">+</span>
<a href="#l37.254"></a><span id="l37.254" class="difflineplus">+// Attempt to make generics safe in the face of downstream</span>
<a href="#l37.255"></a><span id="l37.255" class="difflineplus">+// modifications.</span>
<a href="#l37.256"></a><span id="l37.256" class="difflineplus">+// There is no situation where this is necessary.</span>
<a href="#l37.257"></a><span id="l37.257" class="difflineplus">+// If you need a security guarantee, these primordials need to be</span>
<a href="#l37.258"></a><span id="l37.258" class="difflineplus">+// deeply frozen anyway, and if you dont need a security guarantee,</span>
<a href="#l37.259"></a><span id="l37.259" class="difflineplus">+// this is just plain paranoid.</span>
<a href="#l37.260"></a><span id="l37.260" class="difflineplus">+// However, this **might** have the nice side-effect of reducing the size of</span>
<a href="#l37.261"></a><span id="l37.261" class="difflineplus">+// the minified code by reducing x.call() to merely x()</span>
<a href="#l37.262"></a><span id="l37.262" class="difflineplus">+// See Mark Millers explanation of what this does.</span>
<a href="#l37.263"></a><span id="l37.263" class="difflineplus">+// http://wiki.ecmascript.org/doku.php?id=conventions:safe_meta_programming</span>
<a href="#l37.264"></a><span id="l37.264" class="difflineplus">+var call = Function.call;</span>
<a href="#l37.265"></a><span id="l37.265" class="difflineplus">+function uncurryThis(f) {</span>
<a href="#l37.266"></a><span id="l37.266" class="difflineplus">+    return function () {</span>
<a href="#l37.267"></a><span id="l37.267" class="difflineplus">+        return call.apply(f, arguments);</span>
<a href="#l37.268"></a><span id="l37.268" class="difflineplus">+    };</span>
<a href="#l37.269"></a><span id="l37.269" class="difflineplus">+}</span>
<a href="#l37.270"></a><span id="l37.270" class="difflineplus">+// This is equivalent, but slower:</span>
<a href="#l37.271"></a><span id="l37.271" class="difflineplus">+// uncurryThis = Function_bind.bind(Function_bind.call);</span>
<a href="#l37.272"></a><span id="l37.272" class="difflineplus">+// http://jsperf.com/uncurrythis</span>
<a href="#l37.273"></a><span id="l37.273" class="difflineplus">+</span>
<a href="#l37.274"></a><span id="l37.274" class="difflineplus">+var array_slice = uncurryThis(Array.prototype.slice);</span>
<a href="#l37.275"></a><span id="l37.275" class="difflineplus">+</span>
<a href="#l37.276"></a><span id="l37.276" class="difflineplus">+var array_reduce = uncurryThis(</span>
<a href="#l37.277"></a><span id="l37.277" class="difflineplus">+    Array.prototype.reduce || function (callback, basis) {</span>
<a href="#l37.278"></a><span id="l37.278" class="difflineplus">+        var index = 0,</span>
<a href="#l37.279"></a><span id="l37.279" class="difflineplus">+            length = this.length;</span>
<a href="#l37.280"></a><span id="l37.280" class="difflineplus">+        // concerning the initial value, if one is not provided</span>
<a href="#l37.281"></a><span id="l37.281" class="difflineplus">+        if (arguments.length === 1) {</span>
<a href="#l37.282"></a><span id="l37.282" class="difflineplus">+            // seek to the first value in the array, accounting</span>
<a href="#l37.283"></a><span id="l37.283" class="difflineplus">+            // for the possibility that is is a sparse array</span>
<a href="#l37.284"></a><span id="l37.284" class="difflineplus">+            do {</span>
<a href="#l37.285"></a><span id="l37.285" class="difflineplus">+                if (index in this) {</span>
<a href="#l37.286"></a><span id="l37.286" class="difflineplus">+                    basis = this[index++];</span>
<a href="#l37.287"></a><span id="l37.287" class="difflineplus">+                    break;</span>
<a href="#l37.288"></a><span id="l37.288" class="difflineplus">+                }</span>
<a href="#l37.289"></a><span id="l37.289" class="difflineplus">+                if (++index &gt;= length) {</span>
<a href="#l37.290"></a><span id="l37.290" class="difflineplus">+                    throw new TypeError();</span>
<a href="#l37.291"></a><span id="l37.291" class="difflineplus">+                }</span>
<a href="#l37.292"></a><span id="l37.292" class="difflineplus">+            } while (1);</span>
<a href="#l37.293"></a><span id="l37.293" class="difflineplus">+        }</span>
<a href="#l37.294"></a><span id="l37.294" class="difflineplus">+        // reduce</span>
<a href="#l37.295"></a><span id="l37.295" class="difflineplus">+        for (; index &lt; length; index++) {</span>
<a href="#l37.296"></a><span id="l37.296" class="difflineplus">+            // account for the possibility that the array is sparse</span>
<a href="#l37.297"></a><span id="l37.297" class="difflineplus">+            if (index in this) {</span>
<a href="#l37.298"></a><span id="l37.298" class="difflineplus">+                basis = callback(basis, this[index], index);</span>
<a href="#l37.299"></a><span id="l37.299" class="difflineplus">+            }</span>
<a href="#l37.300"></a><span id="l37.300" class="difflineplus">+        }</span>
<a href="#l37.301"></a><span id="l37.301" class="difflineplus">+        return basis;</span>
<a href="#l37.302"></a><span id="l37.302" class="difflineplus">+    }</span>
<a href="#l37.303"></a><span id="l37.303" class="difflineplus">+);</span>
<a href="#l37.304"></a><span id="l37.304" class="difflineplus">+</span>
<a href="#l37.305"></a><span id="l37.305" class="difflineplus">+var array_indexOf = uncurryThis(</span>
<a href="#l37.306"></a><span id="l37.306" class="difflineplus">+    Array.prototype.indexOf || function (value) {</span>
<a href="#l37.307"></a><span id="l37.307" class="difflineplus">+        // not a very good shim, but good enough for our one use of it</span>
<a href="#l37.308"></a><span id="l37.308" class="difflineplus">+        for (var i = 0; i &lt; this.length; i++) {</span>
<a href="#l37.309"></a><span id="l37.309" class="difflineplus">+            if (this[i] === value) {</span>
<a href="#l37.310"></a><span id="l37.310" class="difflineplus">+                return i;</span>
<a href="#l37.311"></a><span id="l37.311" class="difflineplus">+            }</span>
<a href="#l37.312"></a><span id="l37.312" class="difflineplus">+        }</span>
<a href="#l37.313"></a><span id="l37.313" class="difflineplus">+        return -1;</span>
<a href="#l37.314"></a><span id="l37.314" class="difflineplus">+    }</span>
<a href="#l37.315"></a><span id="l37.315" class="difflineplus">+);</span>
<a href="#l37.316"></a><span id="l37.316" class="difflineplus">+</span>
<a href="#l37.317"></a><span id="l37.317" class="difflineplus">+var array_map = uncurryThis(</span>
<a href="#l37.318"></a><span id="l37.318" class="difflineplus">+    Array.prototype.map || function (callback, thisp) {</span>
<a href="#l37.319"></a><span id="l37.319" class="difflineplus">+        var self = this;</span>
<a href="#l37.320"></a><span id="l37.320" class="difflineplus">+        var collect = [];</span>
<a href="#l37.321"></a><span id="l37.321" class="difflineplus">+        array_reduce(self, function (undefined, value, index) {</span>
<a href="#l37.322"></a><span id="l37.322" class="difflineplus">+            collect.push(callback.call(thisp, value, index, self));</span>
<a href="#l37.323"></a><span id="l37.323" class="difflineplus">+        }, void 0);</span>
<a href="#l37.324"></a><span id="l37.324" class="difflineplus">+        return collect;</span>
<a href="#l37.325"></a><span id="l37.325" class="difflineplus">+    }</span>
<a href="#l37.326"></a><span id="l37.326" class="difflineplus">+);</span>
<a href="#l37.327"></a><span id="l37.327" class="difflineplus">+</span>
<a href="#l37.328"></a><span id="l37.328" class="difflineplus">+var object_create = Object.create || function (prototype) {</span>
<a href="#l37.329"></a><span id="l37.329" class="difflineplus">+    function Type() { }</span>
<a href="#l37.330"></a><span id="l37.330" class="difflineplus">+    Type.prototype = prototype;</span>
<a href="#l37.331"></a><span id="l37.331" class="difflineplus">+    return new Type();</span>
<a href="#l37.332"></a><span id="l37.332" class="difflineplus">+};</span>
<a href="#l37.333"></a><span id="l37.333" class="difflineplus">+</span>
<a href="#l37.334"></a><span id="l37.334" class="difflineplus">+var object_hasOwnProperty = uncurryThis(Object.prototype.hasOwnProperty);</span>
<a href="#l37.335"></a><span id="l37.335" class="difflineplus">+</span>
<a href="#l37.336"></a><span id="l37.336" class="difflineplus">+var object_keys = Object.keys || function (object) {</span>
<a href="#l37.337"></a><span id="l37.337" class="difflineplus">+    var keys = [];</span>
<a href="#l37.338"></a><span id="l37.338" class="difflineplus">+    for (var key in object) {</span>
<a href="#l37.339"></a><span id="l37.339" class="difflineplus">+        if (object_hasOwnProperty(object, key)) {</span>
<a href="#l37.340"></a><span id="l37.340" class="difflineplus">+            keys.push(key);</span>
<a href="#l37.341"></a><span id="l37.341" class="difflineplus">+        }</span>
<a href="#l37.342"></a><span id="l37.342" class="difflineplus">+    }</span>
<a href="#l37.343"></a><span id="l37.343" class="difflineplus">+    return keys;</span>
<a href="#l37.344"></a><span id="l37.344" class="difflineplus">+};</span>
<a href="#l37.345"></a><span id="l37.345" class="difflineplus">+</span>
<a href="#l37.346"></a><span id="l37.346" class="difflineplus">+var object_toString = uncurryThis(Object.prototype.toString);</span>
<a href="#l37.347"></a><span id="l37.347" class="difflineplus">+</span>
<a href="#l37.348"></a><span id="l37.348" class="difflineplus">+function isObject(value) {</span>
<a href="#l37.349"></a><span id="l37.349" class="difflineplus">+    return value === Object(value);</span>
<a href="#l37.350"></a><span id="l37.350" class="difflineplus">+}</span>
<a href="#l37.351"></a><span id="l37.351" class="difflineplus">+</span>
<a href="#l37.352"></a><span id="l37.352" class="difflineplus">+// generator related shims</span>
<a href="#l37.353"></a><span id="l37.353" class="difflineplus">+</span>
<a href="#l37.354"></a><span id="l37.354" class="difflineplus">+// FIXME: Remove this function once ES6 generators are in SpiderMonkey.</span>
<a href="#l37.355"></a><span id="l37.355" class="difflineplus">+function isStopIteration(exception) {</span>
<a href="#l37.356"></a><span id="l37.356" class="difflineplus">+    return (</span>
<a href="#l37.357"></a><span id="l37.357" class="difflineplus">+        object_toString(exception) === &quot;[object StopIteration]&quot; ||</span>
<a href="#l37.358"></a><span id="l37.358" class="difflineplus">+        exception instanceof QReturnValue</span>
<a href="#l37.359"></a><span id="l37.359" class="difflineplus">+    );</span>
<a href="#l37.360"></a><span id="l37.360" class="difflineplus">+}</span>
<a href="#l37.361"></a><span id="l37.361" class="difflineplus">+</span>
<a href="#l37.362"></a><span id="l37.362" class="difflineplus">+// FIXME: Remove this helper and Q.return once ES6 generators are in</span>
<a href="#l37.363"></a><span id="l37.363" class="difflineplus">+// SpiderMonkey.</span>
<a href="#l37.364"></a><span id="l37.364" class="difflineplus">+var QReturnValue;</span>
<a href="#l37.365"></a><span id="l37.365" class="difflineplus">+if (typeof ReturnValue !== &quot;undefined&quot;) {</span>
<a href="#l37.366"></a><span id="l37.366" class="difflineplus">+    QReturnValue = ReturnValue;</span>
<a href="#l37.367"></a><span id="l37.367" class="difflineplus">+} else {</span>
<a href="#l37.368"></a><span id="l37.368" class="difflineplus">+    QReturnValue = function (value) {</span>
<a href="#l37.369"></a><span id="l37.369" class="difflineplus">+        this.value = value;</span>
<a href="#l37.370"></a><span id="l37.370" class="difflineplus">+    };</span>
<a href="#l37.371"></a><span id="l37.371" class="difflineplus">+}</span>
<a href="#l37.372"></a><span id="l37.372" class="difflineplus">+</span>
<a href="#l37.373"></a><span id="l37.373" class="difflineplus">+// long stack traces</span>
<a href="#l37.374"></a><span id="l37.374" class="difflineplus">+</span>
<a href="#l37.375"></a><span id="l37.375" class="difflineplus">+var STACK_JUMP_SEPARATOR = &quot;From previous event:&quot;;</span>
<a href="#l37.376"></a><span id="l37.376" class="difflineplus">+</span>
<a href="#l37.377"></a><span id="l37.377" class="difflineplus">+function makeStackTraceLong(error, promise) {</span>
<a href="#l37.378"></a><span id="l37.378" class="difflineplus">+    // If possible, transform the error stack trace by removing Node and Q</span>
<a href="#l37.379"></a><span id="l37.379" class="difflineplus">+    // cruft, then concatenating with the stack trace of `promise`. See #57.</span>
<a href="#l37.380"></a><span id="l37.380" class="difflineplus">+    if (hasStacks &amp;&amp;</span>
<a href="#l37.381"></a><span id="l37.381" class="difflineplus">+        promise.stack &amp;&amp;</span>
<a href="#l37.382"></a><span id="l37.382" class="difflineplus">+        typeof error === &quot;object&quot; &amp;&amp;</span>
<a href="#l37.383"></a><span id="l37.383" class="difflineplus">+        error !== null &amp;&amp;</span>
<a href="#l37.384"></a><span id="l37.384" class="difflineplus">+        error.stack &amp;&amp;</span>
<a href="#l37.385"></a><span id="l37.385" class="difflineplus">+        error.stack.indexOf(STACK_JUMP_SEPARATOR) === -1</span>
<a href="#l37.386"></a><span id="l37.386" class="difflineplus">+    ) {</span>
<a href="#l37.387"></a><span id="l37.387" class="difflineplus">+        var stacks = [];</span>
<a href="#l37.388"></a><span id="l37.388" class="difflineplus">+        for (var p = promise; !!p; p = p.source) {</span>
<a href="#l37.389"></a><span id="l37.389" class="difflineplus">+            if (p.stack) {</span>
<a href="#l37.390"></a><span id="l37.390" class="difflineplus">+                stacks.unshift(p.stack);</span>
<a href="#l37.391"></a><span id="l37.391" class="difflineplus">+            }</span>
<a href="#l37.392"></a><span id="l37.392" class="difflineplus">+        }</span>
<a href="#l37.393"></a><span id="l37.393" class="difflineplus">+        stacks.unshift(error.stack);</span>
<a href="#l37.394"></a><span id="l37.394" class="difflineplus">+</span>
<a href="#l37.395"></a><span id="l37.395" class="difflineplus">+        var concatedStacks = stacks.join(&quot;\n&quot; + STACK_JUMP_SEPARATOR + &quot;\n&quot;);</span>
<a href="#l37.396"></a><span id="l37.396" class="difflineplus">+        error.stack = filterStackString(concatedStacks);</span>
<a href="#l37.397"></a><span id="l37.397" class="difflineplus">+    }</span>
<a href="#l37.398"></a><span id="l37.398" class="difflineplus">+}</span>
<a href="#l37.399"></a><span id="l37.399" class="difflineplus">+</span>
<a href="#l37.400"></a><span id="l37.400" class="difflineplus">+function filterStackString(stackString) {</span>
<a href="#l37.401"></a><span id="l37.401" class="difflineplus">+    var lines = stackString.split(&quot;\n&quot;);</span>
<a href="#l37.402"></a><span id="l37.402" class="difflineplus">+    var desiredLines = [];</span>
<a href="#l37.403"></a><span id="l37.403" class="difflineplus">+    for (var i = 0; i &lt; lines.length; ++i) {</span>
<a href="#l37.404"></a><span id="l37.404" class="difflineplus">+        var line = lines[i];</span>
<a href="#l37.405"></a><span id="l37.405" class="difflineplus">+</span>
<a href="#l37.406"></a><span id="l37.406" class="difflineplus">+        if (!isInternalFrame(line) &amp;&amp; !isNodeFrame(line) &amp;&amp; line) {</span>
<a href="#l37.407"></a><span id="l37.407" class="difflineplus">+            desiredLines.push(line);</span>
<a href="#l37.408"></a><span id="l37.408" class="difflineplus">+        }</span>
<a href="#l37.409"></a><span id="l37.409" class="difflineplus">+    }</span>
<a href="#l37.410"></a><span id="l37.410" class="difflineplus">+    return desiredLines.join(&quot;\n&quot;);</span>
<a href="#l37.411"></a><span id="l37.411" class="difflineplus">+}</span>
<a href="#l37.412"></a><span id="l37.412" class="difflineplus">+</span>
<a href="#l37.413"></a><span id="l37.413" class="difflineplus">+function isNodeFrame(stackLine) {</span>
<a href="#l37.414"></a><span id="l37.414" class="difflineplus">+    return stackLine.indexOf(&quot;(module.js:&quot;) !== -1 ||</span>
<a href="#l37.415"></a><span id="l37.415" class="difflineplus">+           stackLine.indexOf(&quot;(node.js:&quot;) !== -1;</span>
<a href="#l37.416"></a><span id="l37.416" class="difflineplus">+}</span>
<a href="#l37.417"></a><span id="l37.417" class="difflineplus">+</span>
<a href="#l37.418"></a><span id="l37.418" class="difflineplus">+function getFileNameAndLineNumber(stackLine) {</span>
<a href="#l37.419"></a><span id="l37.419" class="difflineplus">+    // Named functions: &quot;at functionName (filename:lineNumber:columnNumber)&quot;</span>
<a href="#l37.420"></a><span id="l37.420" class="difflineplus">+    // In IE10 function name can have spaces (&quot;Anonymous function&quot;) O_o</span>
<a href="#l37.421"></a><span id="l37.421" class="difflineplus">+    var attempt1 = /at .+ \((.+):(\d+):(?:\d+)\)$/.exec(stackLine);</span>
<a href="#l37.422"></a><span id="l37.422" class="difflineplus">+    if (attempt1) {</span>
<a href="#l37.423"></a><span id="l37.423" class="difflineplus">+        return [attempt1[1], Number(attempt1[2])];</span>
<a href="#l37.424"></a><span id="l37.424" class="difflineplus">+    }</span>
<a href="#l37.425"></a><span id="l37.425" class="difflineplus">+</span>
<a href="#l37.426"></a><span id="l37.426" class="difflineplus">+    // Anonymous functions: &quot;at filename:lineNumber:columnNumber&quot;</span>
<a href="#l37.427"></a><span id="l37.427" class="difflineplus">+    var attempt2 = /at ([^ ]+):(\d+):(?:\d+)$/.exec(stackLine);</span>
<a href="#l37.428"></a><span id="l37.428" class="difflineplus">+    if (attempt2) {</span>
<a href="#l37.429"></a><span id="l37.429" class="difflineplus">+        return [attempt2[1], Number(attempt2[2])];</span>
<a href="#l37.430"></a><span id="l37.430" class="difflineplus">+    }</span>
<a href="#l37.431"></a><span id="l37.431" class="difflineplus">+</span>
<a href="#l37.432"></a><span id="l37.432" class="difflineplus">+    // Firefox style: &quot;function@filename:lineNumber or @filename:lineNumber&quot;</span>
<a href="#l37.433"></a><span id="l37.433" class="difflineplus">+    var attempt3 = /.*@(.+):(\d+)$/.exec(stackLine);</span>
<a href="#l37.434"></a><span id="l37.434" class="difflineplus">+    if (attempt3) {</span>
<a href="#l37.435"></a><span id="l37.435" class="difflineplus">+        return [attempt3[1], Number(attempt3[2])];</span>
<a href="#l37.436"></a><span id="l37.436" class="difflineplus">+    }</span>
<a href="#l37.437"></a><span id="l37.437" class="difflineplus">+}</span>
<a href="#l37.438"></a><span id="l37.438" class="difflineplus">+</span>
<a href="#l37.439"></a><span id="l37.439" class="difflineplus">+function isInternalFrame(stackLine) {</span>
<a href="#l37.440"></a><span id="l37.440" class="difflineplus">+    var fileNameAndLineNumber = getFileNameAndLineNumber(stackLine);</span>
<a href="#l37.441"></a><span id="l37.441" class="difflineplus">+</span>
<a href="#l37.442"></a><span id="l37.442" class="difflineplus">+    if (!fileNameAndLineNumber) {</span>
<a href="#l37.443"></a><span id="l37.443" class="difflineplus">+        return false;</span>
<a href="#l37.444"></a><span id="l37.444" class="difflineplus">+    }</span>
<a href="#l37.445"></a><span id="l37.445" class="difflineplus">+</span>
<a href="#l37.446"></a><span id="l37.446" class="difflineplus">+    var fileName = fileNameAndLineNumber[0];</span>
<a href="#l37.447"></a><span id="l37.447" class="difflineplus">+    var lineNumber = fileNameAndLineNumber[1];</span>
<a href="#l37.448"></a><span id="l37.448" class="difflineplus">+</span>
<a href="#l37.449"></a><span id="l37.449" class="difflineplus">+    return fileName === qFileName &amp;&amp;</span>
<a href="#l37.450"></a><span id="l37.450" class="difflineplus">+        lineNumber &gt;= qStartingLine &amp;&amp;</span>
<a href="#l37.451"></a><span id="l37.451" class="difflineplus">+        lineNumber &lt;= qEndingLine;</span>
<a href="#l37.452"></a><span id="l37.452" class="difflineplus">+}</span>
<a href="#l37.453"></a><span id="l37.453" class="difflineplus">+</span>
<a href="#l37.454"></a><span id="l37.454" class="difflineplus">+// discover own file name and line number range for filtering stack</span>
<a href="#l37.455"></a><span id="l37.455" class="difflineplus">+// traces</span>
<a href="#l37.456"></a><span id="l37.456" class="difflineplus">+function captureLine() {</span>
<a href="#l37.457"></a><span id="l37.457" class="difflineplus">+    if (!hasStacks) {</span>
<a href="#l37.458"></a><span id="l37.458" class="difflineplus">+        return;</span>
<a href="#l37.459"></a><span id="l37.459" class="difflineplus">+    }</span>
<a href="#l37.460"></a><span id="l37.460" class="difflineplus">+</span>
<a href="#l37.461"></a><span id="l37.461" class="difflineplus">+    try {</span>
<a href="#l37.462"></a><span id="l37.462" class="difflineplus">+        throw new Error();</span>
<a href="#l37.463"></a><span id="l37.463" class="difflineplus">+    } catch (e) {</span>
<a href="#l37.464"></a><span id="l37.464" class="difflineplus">+        var lines = e.stack.split(&quot;\n&quot;);</span>
<a href="#l37.465"></a><span id="l37.465" class="difflineplus">+        var firstLine = lines[0].indexOf(&quot;@&quot;) &gt; 0 ? lines[1] : lines[2];</span>
<a href="#l37.466"></a><span id="l37.466" class="difflineplus">+        var fileNameAndLineNumber = getFileNameAndLineNumber(firstLine);</span>
<a href="#l37.467"></a><span id="l37.467" class="difflineplus">+        if (!fileNameAndLineNumber) {</span>
<a href="#l37.468"></a><span id="l37.468" class="difflineplus">+            return;</span>
<a href="#l37.469"></a><span id="l37.469" class="difflineplus">+        }</span>
<a href="#l37.470"></a><span id="l37.470" class="difflineplus">+</span>
<a href="#l37.471"></a><span id="l37.471" class="difflineplus">+        qFileName = fileNameAndLineNumber[0];</span>
<a href="#l37.472"></a><span id="l37.472" class="difflineplus">+        return fileNameAndLineNumber[1];</span>
<a href="#l37.473"></a><span id="l37.473" class="difflineplus">+    }</span>
<a href="#l37.474"></a><span id="l37.474" class="difflineplus">+}</span>
<a href="#l37.475"></a><span id="l37.475" class="difflineplus">+</span>
<a href="#l37.476"></a><span id="l37.476" class="difflineplus">+function deprecate(callback, name, alternative) {</span>
<a href="#l37.477"></a><span id="l37.477" class="difflineplus">+    return function () {</span>
<a href="#l37.478"></a><span id="l37.478" class="difflineplus">+        if (typeof console !== &quot;undefined&quot; &amp;&amp;</span>
<a href="#l37.479"></a><span id="l37.479" class="difflineplus">+            typeof console.warn === &quot;function&quot;) {</span>
<a href="#l37.480"></a><span id="l37.480" class="difflineplus">+            console.warn(name + &quot; is deprecated, use &quot; + alternative +</span>
<a href="#l37.481"></a><span id="l37.481" class="difflineplus">+                         &quot; instead.&quot;, new Error(&quot;&quot;).stack);</span>
<a href="#l37.482"></a><span id="l37.482" class="difflineplus">+        }</span>
<a href="#l37.483"></a><span id="l37.483" class="difflineplus">+        return callback.apply(callback, arguments);</span>
<a href="#l37.484"></a><span id="l37.484" class="difflineplus">+    };</span>
<a href="#l37.485"></a><span id="l37.485" class="difflineplus">+}</span>
<a href="#l37.486"></a><span id="l37.486" class="difflineplus">+</span>
<a href="#l37.487"></a><span id="l37.487" class="difflineplus">+// end of shims</span>
<a href="#l37.488"></a><span id="l37.488" class="difflineplus">+// beginning of real work</span>
<a href="#l37.489"></a><span id="l37.489" class="difflineplus">+</span>
<a href="#l37.490"></a><span id="l37.490" class="difflineplus">+/**</span>
<a href="#l37.491"></a><span id="l37.491" class="difflineplus">+ * Constructs a promise for an immediate reference, passes promises through, or</span>
<a href="#l37.492"></a><span id="l37.492" class="difflineplus">+ * coerces promises from different systems.</span>
<a href="#l37.493"></a><span id="l37.493" class="difflineplus">+ * @param value immediate reference or promise</span>
<a href="#l37.494"></a><span id="l37.494" class="difflineplus">+ */</span>
<a href="#l37.495"></a><span id="l37.495" class="difflineplus">+function Q(value) {</span>
<a href="#l37.496"></a><span id="l37.496" class="difflineplus">+    // If the object is already a Promise, return it directly.  This enables</span>
<a href="#l37.497"></a><span id="l37.497" class="difflineplus">+    // the resolve function to both be used to created references from objects,</span>
<a href="#l37.498"></a><span id="l37.498" class="difflineplus">+    // but to tolerably coerce non-promises to promises.</span>
<a href="#l37.499"></a><span id="l37.499" class="difflineplus">+    if (value instanceof Promise) {</span>
<a href="#l37.500"></a><span id="l37.500" class="difflineplus">+        return value;</span>
<a href="#l37.501"></a><span id="l37.501" class="difflineplus">+    }</span>
<a href="#l37.502"></a><span id="l37.502" class="difflineplus">+</span>
<a href="#l37.503"></a><span id="l37.503" class="difflineplus">+    // assimilate thenables</span>
<a href="#l37.504"></a><span id="l37.504" class="difflineplus">+    if (isPromiseAlike(value)) {</span>
<a href="#l37.505"></a><span id="l37.505" class="difflineplus">+        return coerce(value);</span>
<a href="#l37.506"></a><span id="l37.506" class="difflineplus">+    } else {</span>
<a href="#l37.507"></a><span id="l37.507" class="difflineplus">+        return fulfill(value);</span>
<a href="#l37.508"></a><span id="l37.508" class="difflineplus">+    }</span>
<a href="#l37.509"></a><span id="l37.509" class="difflineplus">+}</span>
<a href="#l37.510"></a><span id="l37.510" class="difflineplus">+Q.resolve = Q;</span>
<a href="#l37.511"></a><span id="l37.511" class="difflineplus">+</span>
<a href="#l37.512"></a><span id="l37.512" class="difflineplus">+/**</span>
<a href="#l37.513"></a><span id="l37.513" class="difflineplus">+ * Performs a task in a future turn of the event loop.</span>
<a href="#l37.514"></a><span id="l37.514" class="difflineplus">+ * @param {Function} task</span>
<a href="#l37.515"></a><span id="l37.515" class="difflineplus">+ */</span>
<a href="#l37.516"></a><span id="l37.516" class="difflineplus">+Q.nextTick = nextTick;</span>
<a href="#l37.517"></a><span id="l37.517" class="difflineplus">+</span>
<a href="#l37.518"></a><span id="l37.518" class="difflineplus">+/**</span>
<a href="#l37.519"></a><span id="l37.519" class="difflineplus">+ * Controls whether or not long stack traces will be on</span>
<a href="#l37.520"></a><span id="l37.520" class="difflineplus">+ */</span>
<a href="#l37.521"></a><span id="l37.521" class="difflineplus">+Q.longStackSupport = false;</span>
<a href="#l37.522"></a><span id="l37.522" class="difflineplus">+</span>
<a href="#l37.523"></a><span id="l37.523" class="difflineplus">+// enable long stacks if Q_DEBUG is set</span>
<a href="#l37.524"></a><span id="l37.524" class="difflineplus">+if (typeof process === &quot;object&quot; &amp;&amp; process &amp;&amp; process.env &amp;&amp; process.env.Q_DEBUG) {</span>
<a href="#l37.525"></a><span id="l37.525" class="difflineplus">+    Q.longStackSupport = true;</span>
<a href="#l37.526"></a><span id="l37.526" class="difflineplus">+}</span>
<a href="#l37.527"></a><span id="l37.527" class="difflineplus">+</span>
<a href="#l37.528"></a><span id="l37.528" class="difflineplus">+/**</span>
<a href="#l37.529"></a><span id="l37.529" class="difflineplus">+ * Constructs a {promise, resolve, reject} object.</span>
<a href="#l37.530"></a><span id="l37.530" class="difflineplus">+ *</span>
<a href="#l37.531"></a><span id="l37.531" class="difflineplus">+ * `resolve` is a callback to invoke with a more resolved value for the</span>
<a href="#l37.532"></a><span id="l37.532" class="difflineplus">+ * promise. To fulfill the promise, invoke `resolve` with any value that is</span>
<a href="#l37.533"></a><span id="l37.533" class="difflineplus">+ * not a thenable. To reject the promise, invoke `resolve` with a rejected</span>
<a href="#l37.534"></a><span id="l37.534" class="difflineplus">+ * thenable, or invoke `reject` with the reason directly. To resolve the</span>
<a href="#l37.535"></a><span id="l37.535" class="difflineplus">+ * promise to another thenable, thus putting it in the same state, invoke</span>
<a href="#l37.536"></a><span id="l37.536" class="difflineplus">+ * `resolve` with that other thenable.</span>
<a href="#l37.537"></a><span id="l37.537" class="difflineplus">+ */</span>
<a href="#l37.538"></a><span id="l37.538" class="difflineplus">+Q.defer = defer;</span>
<a href="#l37.539"></a><span id="l37.539" class="difflineplus">+function defer() {</span>
<a href="#l37.540"></a><span id="l37.540" class="difflineplus">+    // if &quot;messages&quot; is an &quot;Array&quot;, that indicates that the promise has not yet</span>
<a href="#l37.541"></a><span id="l37.541" class="difflineplus">+    // been resolved.  If it is &quot;undefined&quot;, it has been resolved.  Each</span>
<a href="#l37.542"></a><span id="l37.542" class="difflineplus">+    // element of the messages array is itself an array of complete arguments to</span>
<a href="#l37.543"></a><span id="l37.543" class="difflineplus">+    // forward to the resolved promise.  We coerce the resolution value to a</span>
<a href="#l37.544"></a><span id="l37.544" class="difflineplus">+    // promise using the `resolve` function because it handles both fully</span>
<a href="#l37.545"></a><span id="l37.545" class="difflineplus">+    // non-thenable values and other thenables gracefully.</span>
<a href="#l37.546"></a><span id="l37.546" class="difflineplus">+    var messages = [], progressListeners = [], resolvedPromise;</span>
<a href="#l37.547"></a><span id="l37.547" class="difflineplus">+</span>
<a href="#l37.548"></a><span id="l37.548" class="difflineplus">+    var deferred = object_create(defer.prototype);</span>
<a href="#l37.549"></a><span id="l37.549" class="difflineplus">+    var promise = object_create(Promise.prototype);</span>
<a href="#l37.550"></a><span id="l37.550" class="difflineplus">+</span>
<a href="#l37.551"></a><span id="l37.551" class="difflineplus">+    promise.promiseDispatch = function (resolve, op, operands) {</span>
<a href="#l37.552"></a><span id="l37.552" class="difflineplus">+        var args = array_slice(arguments);</span>
<a href="#l37.553"></a><span id="l37.553" class="difflineplus">+        if (messages) {</span>
<a href="#l37.554"></a><span id="l37.554" class="difflineplus">+            messages.push(args);</span>
<a href="#l37.555"></a><span id="l37.555" class="difflineplus">+            if (op === &quot;when&quot; &amp;&amp; operands[1]) { // progress operand</span>
<a href="#l37.556"></a><span id="l37.556" class="difflineplus">+                progressListeners.push(operands[1]);</span>
<a href="#l37.557"></a><span id="l37.557" class="difflineplus">+            }</span>
<a href="#l37.558"></a><span id="l37.558" class="difflineplus">+        } else {</span>
<a href="#l37.559"></a><span id="l37.559" class="difflineplus">+            Q.nextTick(function () {</span>
<a href="#l37.560"></a><span id="l37.560" class="difflineplus">+                resolvedPromise.promiseDispatch.apply(resolvedPromise, args);</span>
<a href="#l37.561"></a><span id="l37.561" class="difflineplus">+            });</span>
<a href="#l37.562"></a><span id="l37.562" class="difflineplus">+        }</span>
<a href="#l37.563"></a><span id="l37.563" class="difflineplus">+    };</span>
<a href="#l37.564"></a><span id="l37.564" class="difflineplus">+</span>
<a href="#l37.565"></a><span id="l37.565" class="difflineplus">+    // XXX deprecated</span>
<a href="#l37.566"></a><span id="l37.566" class="difflineplus">+    promise.valueOf = function () {</span>
<a href="#l37.567"></a><span id="l37.567" class="difflineplus">+        if (messages) {</span>
<a href="#l37.568"></a><span id="l37.568" class="difflineplus">+            return promise;</span>
<a href="#l37.569"></a><span id="l37.569" class="difflineplus">+        }</span>
<a href="#l37.570"></a><span id="l37.570" class="difflineplus">+        var nearerValue = nearer(resolvedPromise);</span>
<a href="#l37.571"></a><span id="l37.571" class="difflineplus">+        if (isPromise(nearerValue)) {</span>
<a href="#l37.572"></a><span id="l37.572" class="difflineplus">+            resolvedPromise = nearerValue; // shorten chain</span>
<a href="#l37.573"></a><span id="l37.573" class="difflineplus">+        }</span>
<a href="#l37.574"></a><span id="l37.574" class="difflineplus">+        return nearerValue;</span>
<a href="#l37.575"></a><span id="l37.575" class="difflineplus">+    };</span>
<a href="#l37.576"></a><span id="l37.576" class="difflineplus">+</span>
<a href="#l37.577"></a><span id="l37.577" class="difflineplus">+    promise.inspect = function () {</span>
<a href="#l37.578"></a><span id="l37.578" class="difflineplus">+        if (!resolvedPromise) {</span>
<a href="#l37.579"></a><span id="l37.579" class="difflineplus">+            return { state: &quot;pending&quot; };</span>
<a href="#l37.580"></a><span id="l37.580" class="difflineplus">+        }</span>
<a href="#l37.581"></a><span id="l37.581" class="difflineplus">+        return resolvedPromise.inspect();</span>
<a href="#l37.582"></a><span id="l37.582" class="difflineplus">+    };</span>
<a href="#l37.583"></a><span id="l37.583" class="difflineplus">+</span>
<a href="#l37.584"></a><span id="l37.584" class="difflineplus">+    if (Q.longStackSupport &amp;&amp; hasStacks) {</span>
<a href="#l37.585"></a><span id="l37.585" class="difflineplus">+        try {</span>
<a href="#l37.586"></a><span id="l37.586" class="difflineplus">+            throw new Error();</span>
<a href="#l37.587"></a><span id="l37.587" class="difflineplus">+        } catch (e) {</span>
<a href="#l37.588"></a><span id="l37.588" class="difflineplus">+            // NOTE: don't try to use `Error.captureStackTrace` or transfer the</span>
<a href="#l37.589"></a><span id="l37.589" class="difflineplus">+            // accessor around; that causes memory leaks as per GH-111. Just</span>
<a href="#l37.590"></a><span id="l37.590" class="difflineplus">+            // reify the stack trace as a string ASAP.</span>
<a href="#l37.591"></a><span id="l37.591" class="difflineplus">+            //</span>
<a href="#l37.592"></a><span id="l37.592" class="difflineplus">+            // At the same time, cut off the first line; it's always just</span>
<a href="#l37.593"></a><span id="l37.593" class="difflineplus">+            // &quot;[object Promise]\n&quot;, as per the `toString`.</span>
<a href="#l37.594"></a><span id="l37.594" class="difflineplus">+            promise.stack = e.stack.substring(e.stack.indexOf(&quot;\n&quot;) + 1);</span>
<a href="#l37.595"></a><span id="l37.595" class="difflineplus">+        }</span>
<a href="#l37.596"></a><span id="l37.596" class="difflineplus">+    }</span>
<a href="#l37.597"></a><span id="l37.597" class="difflineplus">+</span>
<a href="#l37.598"></a><span id="l37.598" class="difflineplus">+    // NOTE: we do the checks for `resolvedPromise` in each method, instead of</span>
<a href="#l37.599"></a><span id="l37.599" class="difflineplus">+    // consolidating them into `become`, since otherwise we'd create new</span>
<a href="#l37.600"></a><span id="l37.600" class="difflineplus">+    // promises with the lines `become(whatever(value))`. See e.g. GH-252.</span>
<a href="#l37.601"></a><span id="l37.601" class="difflineplus">+</span>
<a href="#l37.602"></a><span id="l37.602" class="difflineplus">+    function become(newPromise) {</span>
<a href="#l37.603"></a><span id="l37.603" class="difflineplus">+        resolvedPromise = newPromise;</span>
<a href="#l37.604"></a><span id="l37.604" class="difflineplus">+        promise.source = newPromise;</span>
<a href="#l37.605"></a><span id="l37.605" class="difflineplus">+</span>
<a href="#l37.606"></a><span id="l37.606" class="difflineplus">+        array_reduce(messages, function (undefined, message) {</span>
<a href="#l37.607"></a><span id="l37.607" class="difflineplus">+            Q.nextTick(function () {</span>
<a href="#l37.608"></a><span id="l37.608" class="difflineplus">+                newPromise.promiseDispatch.apply(newPromise, message);</span>
<a href="#l37.609"></a><span id="l37.609" class="difflineplus">+            });</span>
<a href="#l37.610"></a><span id="l37.610" class="difflineplus">+        }, void 0);</span>
<a href="#l37.611"></a><span id="l37.611" class="difflineplus">+</span>
<a href="#l37.612"></a><span id="l37.612" class="difflineplus">+        messages = void 0;</span>
<a href="#l37.613"></a><span id="l37.613" class="difflineplus">+        progressListeners = void 0;</span>
<a href="#l37.614"></a><span id="l37.614" class="difflineplus">+    }</span>
<a href="#l37.615"></a><span id="l37.615" class="difflineplus">+</span>
<a href="#l37.616"></a><span id="l37.616" class="difflineplus">+    deferred.promise = promise;</span>
<a href="#l37.617"></a><span id="l37.617" class="difflineplus">+    deferred.resolve = function (value) {</span>
<a href="#l37.618"></a><span id="l37.618" class="difflineplus">+        if (resolvedPromise) {</span>
<a href="#l37.619"></a><span id="l37.619" class="difflineplus">+            return;</span>
<a href="#l37.620"></a><span id="l37.620" class="difflineplus">+        }</span>
<a href="#l37.621"></a><span id="l37.621" class="difflineplus">+</span>
<a href="#l37.622"></a><span id="l37.622" class="difflineplus">+        become(Q(value));</span>
<a href="#l37.623"></a><span id="l37.623" class="difflineplus">+    };</span>
<a href="#l37.624"></a><span id="l37.624" class="difflineplus">+</span>
<a href="#l37.625"></a><span id="l37.625" class="difflineplus">+    deferred.fulfill = function (value) {</span>
<a href="#l37.626"></a><span id="l37.626" class="difflineplus">+        if (resolvedPromise) {</span>
<a href="#l37.627"></a><span id="l37.627" class="difflineplus">+            return;</span>
<a href="#l37.628"></a><span id="l37.628" class="difflineplus">+        }</span>
<a href="#l37.629"></a><span id="l37.629" class="difflineplus">+</span>
<a href="#l37.630"></a><span id="l37.630" class="difflineplus">+        become(fulfill(value));</span>
<a href="#l37.631"></a><span id="l37.631" class="difflineplus">+    };</span>
<a href="#l37.632"></a><span id="l37.632" class="difflineplus">+    deferred.reject = function (reason) {</span>
<a href="#l37.633"></a><span id="l37.633" class="difflineplus">+        if (resolvedPromise) {</span>
<a href="#l37.634"></a><span id="l37.634" class="difflineplus">+            return;</span>
<a href="#l37.635"></a><span id="l37.635" class="difflineplus">+        }</span>
<a href="#l37.636"></a><span id="l37.636" class="difflineplus">+</span>
<a href="#l37.637"></a><span id="l37.637" class="difflineplus">+        become(reject(reason));</span>
<a href="#l37.638"></a><span id="l37.638" class="difflineplus">+    };</span>
<a href="#l37.639"></a><span id="l37.639" class="difflineplus">+    deferred.notify = function (progress) {</span>
<a href="#l37.640"></a><span id="l37.640" class="difflineplus">+        if (resolvedPromise) {</span>
<a href="#l37.641"></a><span id="l37.641" class="difflineplus">+            return;</span>
<a href="#l37.642"></a><span id="l37.642" class="difflineplus">+        }</span>
<a href="#l37.643"></a><span id="l37.643" class="difflineplus">+</span>
<a href="#l37.644"></a><span id="l37.644" class="difflineplus">+        array_reduce(progressListeners, function (undefined, progressListener) {</span>
<a href="#l37.645"></a><span id="l37.645" class="difflineplus">+            Q.nextTick(function () {</span>
<a href="#l37.646"></a><span id="l37.646" class="difflineplus">+                progressListener(progress);</span>
<a href="#l37.647"></a><span id="l37.647" class="difflineplus">+            });</span>
<a href="#l37.648"></a><span id="l37.648" class="difflineplus">+        }, void 0);</span>
<a href="#l37.649"></a><span id="l37.649" class="difflineplus">+    };</span>
<a href="#l37.650"></a><span id="l37.650" class="difflineplus">+</span>
<a href="#l37.651"></a><span id="l37.651" class="difflineplus">+    return deferred;</span>
<a href="#l37.652"></a><span id="l37.652" class="difflineplus">+}</span>
<a href="#l37.653"></a><span id="l37.653" class="difflineplus">+</span>
<a href="#l37.654"></a><span id="l37.654" class="difflineplus">+/**</span>
<a href="#l37.655"></a><span id="l37.655" class="difflineplus">+ * Creates a Node-style callback that will resolve or reject the deferred</span>
<a href="#l37.656"></a><span id="l37.656" class="difflineplus">+ * promise.</span>
<a href="#l37.657"></a><span id="l37.657" class="difflineplus">+ * @returns a nodeback</span>
<a href="#l37.658"></a><span id="l37.658" class="difflineplus">+ */</span>
<a href="#l37.659"></a><span id="l37.659" class="difflineplus">+defer.prototype.makeNodeResolver = function () {</span>
<a href="#l37.660"></a><span id="l37.660" class="difflineplus">+    var self = this;</span>
<a href="#l37.661"></a><span id="l37.661" class="difflineplus">+    return function (error, value) {</span>
<a href="#l37.662"></a><span id="l37.662" class="difflineplus">+        if (error) {</span>
<a href="#l37.663"></a><span id="l37.663" class="difflineplus">+            self.reject(error);</span>
<a href="#l37.664"></a><span id="l37.664" class="difflineplus">+        } else if (arguments.length &gt; 2) {</span>
<a href="#l37.665"></a><span id="l37.665" class="difflineplus">+            self.resolve(array_slice(arguments, 1));</span>
<a href="#l37.666"></a><span id="l37.666" class="difflineplus">+        } else {</span>
<a href="#l37.667"></a><span id="l37.667" class="difflineplus">+            self.resolve(value);</span>
<a href="#l37.668"></a><span id="l37.668" class="difflineplus">+        }</span>
<a href="#l37.669"></a><span id="l37.669" class="difflineplus">+    };</span>
<a href="#l37.670"></a><span id="l37.670" class="difflineplus">+};</span>
<a href="#l37.671"></a><span id="l37.671" class="difflineplus">+</span>
<a href="#l37.672"></a><span id="l37.672" class="difflineplus">+/**</span>
<a href="#l37.673"></a><span id="l37.673" class="difflineplus">+ * @param resolver {Function} a function that returns nothing and accepts</span>
<a href="#l37.674"></a><span id="l37.674" class="difflineplus">+ * the resolve, reject, and notify functions for a deferred.</span>
<a href="#l37.675"></a><span id="l37.675" class="difflineplus">+ * @returns a promise that may be resolved with the given resolve and reject</span>
<a href="#l37.676"></a><span id="l37.676" class="difflineplus">+ * functions, or rejected by a thrown exception in resolver</span>
<a href="#l37.677"></a><span id="l37.677" class="difflineplus">+ */</span>
<a href="#l37.678"></a><span id="l37.678" class="difflineplus">+Q.Promise = promise; // ES6</span>
<a href="#l37.679"></a><span id="l37.679" class="difflineplus">+Q.promise = promise;</span>
<a href="#l37.680"></a><span id="l37.680" class="difflineplus">+function promise(resolver) {</span>
<a href="#l37.681"></a><span id="l37.681" class="difflineplus">+    if (typeof resolver !== &quot;function&quot;) {</span>
<a href="#l37.682"></a><span id="l37.682" class="difflineplus">+        throw new TypeError(&quot;resolver must be a function.&quot;);</span>
<a href="#l37.683"></a><span id="l37.683" class="difflineplus">+    }</span>
<a href="#l37.684"></a><span id="l37.684" class="difflineplus">+    var deferred = defer();</span>
<a href="#l37.685"></a><span id="l37.685" class="difflineplus">+    try {</span>
<a href="#l37.686"></a><span id="l37.686" class="difflineplus">+        resolver(deferred.resolve, deferred.reject, deferred.notify);</span>
<a href="#l37.687"></a><span id="l37.687" class="difflineplus">+    } catch (reason) {</span>
<a href="#l37.688"></a><span id="l37.688" class="difflineplus">+        deferred.reject(reason);</span>
<a href="#l37.689"></a><span id="l37.689" class="difflineplus">+    }</span>
<a href="#l37.690"></a><span id="l37.690" class="difflineplus">+    return deferred.promise;</span>
<a href="#l37.691"></a><span id="l37.691" class="difflineplus">+}</span>
<a href="#l37.692"></a><span id="l37.692" class="difflineplus">+</span>
<a href="#l37.693"></a><span id="l37.693" class="difflineplus">+promise.race = race; // ES6</span>
<a href="#l37.694"></a><span id="l37.694" class="difflineplus">+promise.all = all; // ES6</span>
<a href="#l37.695"></a><span id="l37.695" class="difflineplus">+promise.reject = reject; // ES6</span>
<a href="#l37.696"></a><span id="l37.696" class="difflineplus">+promise.resolve = Q; // ES6</span>
<a href="#l37.697"></a><span id="l37.697" class="difflineplus">+</span>
<a href="#l37.698"></a><span id="l37.698" class="difflineplus">+// XXX experimental.  This method is a way to denote that a local value is</span>
<a href="#l37.699"></a><span id="l37.699" class="difflineplus">+// serializable and should be immediately dispatched to a remote upon request,</span>
<a href="#l37.700"></a><span id="l37.700" class="difflineplus">+// instead of passing a reference.</span>
<a href="#l37.701"></a><span id="l37.701" class="difflineplus">+Q.passByCopy = function (object) {</span>
<a href="#l37.702"></a><span id="l37.702" class="difflineplus">+    //freeze(object);</span>
<a href="#l37.703"></a><span id="l37.703" class="difflineplus">+    //passByCopies.set(object, true);</span>
<a href="#l37.704"></a><span id="l37.704" class="difflineplus">+    return object;</span>
<a href="#l37.705"></a><span id="l37.705" class="difflineplus">+};</span>
<a href="#l37.706"></a><span id="l37.706" class="difflineplus">+</span>
<a href="#l37.707"></a><span id="l37.707" class="difflineplus">+Promise.prototype.passByCopy = function () {</span>
<a href="#l37.708"></a><span id="l37.708" class="difflineplus">+    //freeze(object);</span>
<a href="#l37.709"></a><span id="l37.709" class="difflineplus">+    //passByCopies.set(object, true);</span>
<a href="#l37.710"></a><span id="l37.710" class="difflineplus">+    return this;</span>
<a href="#l37.711"></a><span id="l37.711" class="difflineplus">+};</span>
<a href="#l37.712"></a><span id="l37.712" class="difflineplus">+</span>
<a href="#l37.713"></a><span id="l37.713" class="difflineplus">+/**</span>
<a href="#l37.714"></a><span id="l37.714" class="difflineplus">+ * If two promises eventually fulfill to the same value, promises that value,</span>
<a href="#l37.715"></a><span id="l37.715" class="difflineplus">+ * but otherwise rejects.</span>
<a href="#l37.716"></a><span id="l37.716" class="difflineplus">+ * @param x {Any*}</span>
<a href="#l37.717"></a><span id="l37.717" class="difflineplus">+ * @param y {Any*}</span>
<a href="#l37.718"></a><span id="l37.718" class="difflineplus">+ * @returns {Any*} a promise for x and y if they are the same, but a rejection</span>
<a href="#l37.719"></a><span id="l37.719" class="difflineplus">+ * otherwise.</span>
<a href="#l37.720"></a><span id="l37.720" class="difflineplus">+ *</span>
<a href="#l37.721"></a><span id="l37.721" class="difflineplus">+ */</span>
<a href="#l37.722"></a><span id="l37.722" class="difflineplus">+Q.join = function (x, y) {</span>
<a href="#l37.723"></a><span id="l37.723" class="difflineplus">+    return Q(x).join(y);</span>
<a href="#l37.724"></a><span id="l37.724" class="difflineplus">+};</span>
<a href="#l37.725"></a><span id="l37.725" class="difflineplus">+</span>
<a href="#l37.726"></a><span id="l37.726" class="difflineplus">+Promise.prototype.join = function (that) {</span>
<a href="#l37.727"></a><span id="l37.727" class="difflineplus">+    return Q([this, that]).spread(function (x, y) {</span>
<a href="#l37.728"></a><span id="l37.728" class="difflineplus">+        if (x === y) {</span>
<a href="#l37.729"></a><span id="l37.729" class="difflineplus">+            // TODO: &quot;===&quot; should be Object.is or equiv</span>
<a href="#l37.730"></a><span id="l37.730" class="difflineplus">+            return x;</span>
<a href="#l37.731"></a><span id="l37.731" class="difflineplus">+        } else {</span>
<a href="#l37.732"></a><span id="l37.732" class="difflineplus">+            throw new Error(&quot;Can't join: not the same: &quot; + x + &quot; &quot; + y);</span>
<a href="#l37.733"></a><span id="l37.733" class="difflineplus">+        }</span>
<a href="#l37.734"></a><span id="l37.734" class="difflineplus">+    });</span>
<a href="#l37.735"></a><span id="l37.735" class="difflineplus">+};</span>
<a href="#l37.736"></a><span id="l37.736" class="difflineplus">+</span>
<a href="#l37.737"></a><span id="l37.737" class="difflineplus">+/**</span>
<a href="#l37.738"></a><span id="l37.738" class="difflineplus">+ * Returns a promise for the first of an array of promises to become settled.</span>
<a href="#l37.739"></a><span id="l37.739" class="difflineplus">+ * @param answers {Array[Any*]} promises to race</span>
<a href="#l37.740"></a><span id="l37.740" class="difflineplus">+ * @returns {Any*} the first promise to be settled</span>
<a href="#l37.741"></a><span id="l37.741" class="difflineplus">+ */</span>
<a href="#l37.742"></a><span id="l37.742" class="difflineplus">+Q.race = race;</span>
<a href="#l37.743"></a><span id="l37.743" class="difflineplus">+function race(answerPs) {</span>
<a href="#l37.744"></a><span id="l37.744" class="difflineplus">+    return promise(function (resolve, reject) {</span>
<a href="#l37.745"></a><span id="l37.745" class="difflineplus">+        // Switch to this once we can assume at least ES5</span>
<a href="#l37.746"></a><span id="l37.746" class="difflineplus">+        // answerPs.forEach(function (answerP) {</span>
<a href="#l37.747"></a><span id="l37.747" class="difflineplus">+        //     Q(answerP).then(resolve, reject);</span>
<a href="#l37.748"></a><span id="l37.748" class="difflineplus">+        // });</span>
<a href="#l37.749"></a><span id="l37.749" class="difflineplus">+        // Use this in the meantime</span>
<a href="#l37.750"></a><span id="l37.750" class="difflineplus">+        for (var i = 0, len = answerPs.length; i &lt; len; i++) {</span>
<a href="#l37.751"></a><span id="l37.751" class="difflineplus">+            Q(answerPs[i]).then(resolve, reject);</span>
<a href="#l37.752"></a><span id="l37.752" class="difflineplus">+        }</span>
<a href="#l37.753"></a><span id="l37.753" class="difflineplus">+    });</span>
<a href="#l37.754"></a><span id="l37.754" class="difflineplus">+}</span>
<a href="#l37.755"></a><span id="l37.755" class="difflineplus">+</span>
<a href="#l37.756"></a><span id="l37.756" class="difflineplus">+Promise.prototype.race = function () {</span>
<a href="#l37.757"></a><span id="l37.757" class="difflineplus">+    return this.then(Q.race);</span>
<a href="#l37.758"></a><span id="l37.758" class="difflineplus">+};</span>
<a href="#l37.759"></a><span id="l37.759" class="difflineplus">+</span>
<a href="#l37.760"></a><span id="l37.760" class="difflineplus">+/**</span>
<a href="#l37.761"></a><span id="l37.761" class="difflineplus">+ * Constructs a Promise with a promise descriptor object and optional fallback</span>
<a href="#l37.762"></a><span id="l37.762" class="difflineplus">+ * function.  The descriptor contains methods like when(rejected), get(name),</span>
<a href="#l37.763"></a><span id="l37.763" class="difflineplus">+ * set(name, value), post(name, args), and delete(name), which all</span>
<a href="#l37.764"></a><span id="l37.764" class="difflineplus">+ * return either a value, a promise for a value, or a rejection.  The fallback</span>
<a href="#l37.765"></a><span id="l37.765" class="difflineplus">+ * accepts the operation name, a resolver, and any further arguments that would</span>
<a href="#l37.766"></a><span id="l37.766" class="difflineplus">+ * have been forwarded to the appropriate method above had a method been</span>
<a href="#l37.767"></a><span id="l37.767" class="difflineplus">+ * provided with the proper name.  The API makes no guarantees about the nature</span>
<a href="#l37.768"></a><span id="l37.768" class="difflineplus">+ * of the returned object, apart from that it is usable whereever promises are</span>
<a href="#l37.769"></a><span id="l37.769" class="difflineplus">+ * bought and sold.</span>
<a href="#l37.770"></a><span id="l37.770" class="difflineplus">+ */</span>
<a href="#l37.771"></a><span id="l37.771" class="difflineplus">+Q.makePromise = Promise;</span>
<a href="#l37.772"></a><span id="l37.772" class="difflineplus">+function Promise(descriptor, fallback, inspect) {</span>
<a href="#l37.773"></a><span id="l37.773" class="difflineplus">+    if (fallback === void 0) {</span>
<a href="#l37.774"></a><span id="l37.774" class="difflineplus">+        fallback = function (op) {</span>
<a href="#l37.775"></a><span id="l37.775" class="difflineplus">+            return reject(new Error(</span>
<a href="#l37.776"></a><span id="l37.776" class="difflineplus">+                &quot;Promise does not support operation: &quot; + op</span>
<a href="#l37.777"></a><span id="l37.777" class="difflineplus">+            ));</span>
<a href="#l37.778"></a><span id="l37.778" class="difflineplus">+        };</span>
<a href="#l37.779"></a><span id="l37.779" class="difflineplus">+    }</span>
<a href="#l37.780"></a><span id="l37.780" class="difflineplus">+    if (inspect === void 0) {</span>
<a href="#l37.781"></a><span id="l37.781" class="difflineplus">+        inspect = function () {</span>
<a href="#l37.782"></a><span id="l37.782" class="difflineplus">+            return {state: &quot;unknown&quot;};</span>
<a href="#l37.783"></a><span id="l37.783" class="difflineplus">+        };</span>
<a href="#l37.784"></a><span id="l37.784" class="difflineplus">+    }</span>
<a href="#l37.785"></a><span id="l37.785" class="difflineplus">+</span>
<a href="#l37.786"></a><span id="l37.786" class="difflineplus">+    var promise = object_create(Promise.prototype);</span>
<a href="#l37.787"></a><span id="l37.787" class="difflineplus">+</span>
<a href="#l37.788"></a><span id="l37.788" class="difflineplus">+    promise.promiseDispatch = function (resolve, op, args) {</span>
<a href="#l37.789"></a><span id="l37.789" class="difflineplus">+        var result;</span>
<a href="#l37.790"></a><span id="l37.790" class="difflineplus">+        try {</span>
<a href="#l37.791"></a><span id="l37.791" class="difflineplus">+            if (descriptor[op]) {</span>
<a href="#l37.792"></a><span id="l37.792" class="difflineplus">+                result = descriptor[op].apply(promise, args);</span>
<a href="#l37.793"></a><span id="l37.793" class="difflineplus">+            } else {</span>
<a href="#l37.794"></a><span id="l37.794" class="difflineplus">+                result = fallback.call(promise, op, args);</span>
<a href="#l37.795"></a><span id="l37.795" class="difflineplus">+            }</span>
<a href="#l37.796"></a><span id="l37.796" class="difflineplus">+        } catch (exception) {</span>
<a href="#l37.797"></a><span id="l37.797" class="difflineplus">+            result = reject(exception);</span>
<a href="#l37.798"></a><span id="l37.798" class="difflineplus">+        }</span>
<a href="#l37.799"></a><span id="l37.799" class="difflineplus">+        if (resolve) {</span>
<a href="#l37.800"></a><span id="l37.800" class="difflineplus">+            resolve(result);</span>
<a href="#l37.801"></a><span id="l37.801" class="difflineplus">+        }</span>
<a href="#l37.802"></a><span id="l37.802" class="difflineplus">+    };</span>
<a href="#l37.803"></a><span id="l37.803" class="difflineplus">+</span>
<a href="#l37.804"></a><span id="l37.804" class="difflineplus">+    promise.inspect = inspect;</span>
<a href="#l37.805"></a><span id="l37.805" class="difflineplus">+</span>
<a href="#l37.806"></a><span id="l37.806" class="difflineplus">+    // XXX deprecated `valueOf` and `exception` support</span>
<a href="#l37.807"></a><span id="l37.807" class="difflineplus">+    if (inspect) {</span>
<a href="#l37.808"></a><span id="l37.808" class="difflineplus">+        var inspected = inspect();</span>
<a href="#l37.809"></a><span id="l37.809" class="difflineplus">+        if (inspected.state === &quot;rejected&quot;) {</span>
<a href="#l37.810"></a><span id="l37.810" class="difflineplus">+            promise.exception = inspected.reason;</span>
<a href="#l37.811"></a><span id="l37.811" class="difflineplus">+        }</span>
<a href="#l37.812"></a><span id="l37.812" class="difflineplus">+</span>
<a href="#l37.813"></a><span id="l37.813" class="difflineplus">+        promise.valueOf = function () {</span>
<a href="#l37.814"></a><span id="l37.814" class="difflineplus">+            var inspected = inspect();</span>
<a href="#l37.815"></a><span id="l37.815" class="difflineplus">+            if (inspected.state === &quot;pending&quot; ||</span>
<a href="#l37.816"></a><span id="l37.816" class="difflineplus">+                inspected.state === &quot;rejected&quot;) {</span>
<a href="#l37.817"></a><span id="l37.817" class="difflineplus">+                return promise;</span>
<a href="#l37.818"></a><span id="l37.818" class="difflineplus">+            }</span>
<a href="#l37.819"></a><span id="l37.819" class="difflineplus">+            return inspected.value;</span>
<a href="#l37.820"></a><span id="l37.820" class="difflineplus">+        };</span>
<a href="#l37.821"></a><span id="l37.821" class="difflineplus">+    }</span>
<a href="#l37.822"></a><span id="l37.822" class="difflineplus">+</span>
<a href="#l37.823"></a><span id="l37.823" class="difflineplus">+    return promise;</span>
<a href="#l37.824"></a><span id="l37.824" class="difflineplus">+}</span>
<a href="#l37.825"></a><span id="l37.825" class="difflineplus">+</span>
<a href="#l37.826"></a><span id="l37.826" class="difflineplus">+Promise.prototype.toString = function () {</span>
<a href="#l37.827"></a><span id="l37.827" class="difflineplus">+    return &quot;[object Promise]&quot;;</span>
<a href="#l37.828"></a><span id="l37.828" class="difflineplus">+};</span>
<a href="#l37.829"></a><span id="l37.829" class="difflineplus">+</span>
<a href="#l37.830"></a><span id="l37.830" class="difflineplus">+Promise.prototype.then = function (fulfilled, rejected, progressed) {</span>
<a href="#l37.831"></a><span id="l37.831" class="difflineplus">+    var self = this;</span>
<a href="#l37.832"></a><span id="l37.832" class="difflineplus">+    var deferred = defer();</span>
<a href="#l37.833"></a><span id="l37.833" class="difflineplus">+    var done = false;   // ensure the untrusted promise makes at most a</span>
<a href="#l37.834"></a><span id="l37.834" class="difflineplus">+                        // single call to one of the callbacks</span>
<a href="#l37.835"></a><span id="l37.835" class="difflineplus">+</span>
<a href="#l37.836"></a><span id="l37.836" class="difflineplus">+    function _fulfilled(value) {</span>
<a href="#l37.837"></a><span id="l37.837" class="difflineplus">+        try {</span>
<a href="#l37.838"></a><span id="l37.838" class="difflineplus">+            return typeof fulfilled === &quot;function&quot; ? fulfilled(value) : value;</span>
<a href="#l37.839"></a><span id="l37.839" class="difflineplus">+        } catch (exception) {</span>
<a href="#l37.840"></a><span id="l37.840" class="difflineplus">+            return reject(exception);</span>
<a href="#l37.841"></a><span id="l37.841" class="difflineplus">+        }</span>
<a href="#l37.842"></a><span id="l37.842" class="difflineplus">+    }</span>
<a href="#l37.843"></a><span id="l37.843" class="difflineplus">+</span>
<a href="#l37.844"></a><span id="l37.844" class="difflineplus">+    function _rejected(exception) {</span>
<a href="#l37.845"></a><span id="l37.845" class="difflineplus">+        if (typeof rejected === &quot;function&quot;) {</span>
<a href="#l37.846"></a><span id="l37.846" class="difflineplus">+            makeStackTraceLong(exception, self);</span>
<a href="#l37.847"></a><span id="l37.847" class="difflineplus">+            try {</span>
<a href="#l37.848"></a><span id="l37.848" class="difflineplus">+                return rejected(exception);</span>
<a href="#l37.849"></a><span id="l37.849" class="difflineplus">+            } catch (newException) {</span>
<a href="#l37.850"></a><span id="l37.850" class="difflineplus">+                return reject(newException);</span>
<a href="#l37.851"></a><span id="l37.851" class="difflineplus">+            }</span>
<a href="#l37.852"></a><span id="l37.852" class="difflineplus">+        }</span>
<a href="#l37.853"></a><span id="l37.853" class="difflineplus">+        return reject(exception);</span>
<a href="#l37.854"></a><span id="l37.854" class="difflineplus">+    }</span>
<a href="#l37.855"></a><span id="l37.855" class="difflineplus">+</span>
<a href="#l37.856"></a><span id="l37.856" class="difflineplus">+    function _progressed(value) {</span>
<a href="#l37.857"></a><span id="l37.857" class="difflineplus">+        return typeof progressed === &quot;function&quot; ? progressed(value) : value;</span>
<a href="#l37.858"></a><span id="l37.858" class="difflineplus">+    }</span>
<a href="#l37.859"></a><span id="l37.859" class="difflineplus">+</span>
<a href="#l37.860"></a><span id="l37.860" class="difflineplus">+    Q.nextTick(function () {</span>
<a href="#l37.861"></a><span id="l37.861" class="difflineplus">+        self.promiseDispatch(function (value) {</span>
<a href="#l37.862"></a><span id="l37.862" class="difflineplus">+            if (done) {</span>
<a href="#l37.863"></a><span id="l37.863" class="difflineplus">+                return;</span>
<a href="#l37.864"></a><span id="l37.864" class="difflineplus">+            }</span>
<a href="#l37.865"></a><span id="l37.865" class="difflineplus">+            done = true;</span>
<a href="#l37.866"></a><span id="l37.866" class="difflineplus">+</span>
<a href="#l37.867"></a><span id="l37.867" class="difflineplus">+            deferred.resolve(_fulfilled(value));</span>
<a href="#l37.868"></a><span id="l37.868" class="difflineplus">+        }, &quot;when&quot;, [function (exception) {</span>
<a href="#l37.869"></a><span id="l37.869" class="difflineplus">+            if (done) {</span>
<a href="#l37.870"></a><span id="l37.870" class="difflineplus">+                return;</span>
<a href="#l37.871"></a><span id="l37.871" class="difflineplus">+            }</span>
<a href="#l37.872"></a><span id="l37.872" class="difflineplus">+            done = true;</span>
<a href="#l37.873"></a><span id="l37.873" class="difflineplus">+</span>
<a href="#l37.874"></a><span id="l37.874" class="difflineplus">+            deferred.resolve(_rejected(exception));</span>
<a href="#l37.875"></a><span id="l37.875" class="difflineplus">+        }]);</span>
<a href="#l37.876"></a><span id="l37.876" class="difflineplus">+    });</span>
<a href="#l37.877"></a><span id="l37.877" class="difflineplus">+</span>
<a href="#l37.878"></a><span id="l37.878" class="difflineplus">+    // Progress propagator need to be attached in the current tick.</span>
<a href="#l37.879"></a><span id="l37.879" class="difflineplus">+    self.promiseDispatch(void 0, &quot;when&quot;, [void 0, function (value) {</span>
<a href="#l37.880"></a><span id="l37.880" class="difflineplus">+        var newValue;</span>
<a href="#l37.881"></a><span id="l37.881" class="difflineplus">+        var threw = false;</span>
<a href="#l37.882"></a><span id="l37.882" class="difflineplus">+        try {</span>
<a href="#l37.883"></a><span id="l37.883" class="difflineplus">+            newValue = _progressed(value);</span>
<a href="#l37.884"></a><span id="l37.884" class="difflineplus">+        } catch (e) {</span>
<a href="#l37.885"></a><span id="l37.885" class="difflineplus">+            threw = true;</span>
<a href="#l37.886"></a><span id="l37.886" class="difflineplus">+            if (Q.onerror) {</span>
<a href="#l37.887"></a><span id="l37.887" class="difflineplus">+                Q.onerror(e);</span>
<a href="#l37.888"></a><span id="l37.888" class="difflineplus">+            } else {</span>
<a href="#l37.889"></a><span id="l37.889" class="difflineplus">+                throw e;</span>
<a href="#l37.890"></a><span id="l37.890" class="difflineplus">+            }</span>
<a href="#l37.891"></a><span id="l37.891" class="difflineplus">+        }</span>
<a href="#l37.892"></a><span id="l37.892" class="difflineplus">+</span>
<a href="#l37.893"></a><span id="l37.893" class="difflineplus">+        if (!threw) {</span>
<a href="#l37.894"></a><span id="l37.894" class="difflineplus">+            deferred.notify(newValue);</span>
<a href="#l37.895"></a><span id="l37.895" class="difflineplus">+        }</span>
<a href="#l37.896"></a><span id="l37.896" class="difflineplus">+    }]);</span>
<a href="#l37.897"></a><span id="l37.897" class="difflineplus">+</span>
<a href="#l37.898"></a><span id="l37.898" class="difflineplus">+    return deferred.promise;</span>
<a href="#l37.899"></a><span id="l37.899" class="difflineplus">+};</span>
<a href="#l37.900"></a><span id="l37.900" class="difflineplus">+</span>
<a href="#l37.901"></a><span id="l37.901" class="difflineplus">+Q.tap = function (promise, callback) {</span>
<a href="#l37.902"></a><span id="l37.902" class="difflineplus">+    return Q(promise).tap(callback);</span>
<a href="#l37.903"></a><span id="l37.903" class="difflineplus">+};</span>
<a href="#l37.904"></a><span id="l37.904" class="difflineplus">+</span>
<a href="#l37.905"></a><span id="l37.905" class="difflineplus">+/**</span>
<a href="#l37.906"></a><span id="l37.906" class="difflineplus">+ * Works almost like &quot;finally&quot;, but not called for rejections.</span>
<a href="#l37.907"></a><span id="l37.907" class="difflineplus">+ * Original resolution value is passed through callback unaffected.</span>
<a href="#l37.908"></a><span id="l37.908" class="difflineplus">+ * Callback may return a promise that will be awaited for.</span>
<a href="#l37.909"></a><span id="l37.909" class="difflineplus">+ * @param {Function} callback</span>
<a href="#l37.910"></a><span id="l37.910" class="difflineplus">+ * @returns {Q.Promise}</span>
<a href="#l37.911"></a><span id="l37.911" class="difflineplus">+ * @example</span>
<a href="#l37.912"></a><span id="l37.912" class="difflineplus">+ * doSomething()</span>
<a href="#l37.913"></a><span id="l37.913" class="difflineplus">+ *   .then(...)</span>
<a href="#l37.914"></a><span id="l37.914" class="difflineplus">+ *   .tap(console.log)</span>
<a href="#l37.915"></a><span id="l37.915" class="difflineplus">+ *   .then(...);</span>
<a href="#l37.916"></a><span id="l37.916" class="difflineplus">+ */</span>
<a href="#l37.917"></a><span id="l37.917" class="difflineplus">+Promise.prototype.tap = function (callback) {</span>
<a href="#l37.918"></a><span id="l37.918" class="difflineplus">+    callback = Q(callback);</span>
<a href="#l37.919"></a><span id="l37.919" class="difflineplus">+</span>
<a href="#l37.920"></a><span id="l37.920" class="difflineplus">+    return this.then(function (value) {</span>
<a href="#l37.921"></a><span id="l37.921" class="difflineplus">+        return callback.fcall(value).thenResolve(value);</span>
<a href="#l37.922"></a><span id="l37.922" class="difflineplus">+    });</span>
<a href="#l37.923"></a><span id="l37.923" class="difflineplus">+};</span>
<a href="#l37.924"></a><span id="l37.924" class="difflineplus">+</span>
<a href="#l37.925"></a><span id="l37.925" class="difflineplus">+/**</span>
<a href="#l37.926"></a><span id="l37.926" class="difflineplus">+ * Registers an observer on a promise.</span>
<a href="#l37.927"></a><span id="l37.927" class="difflineplus">+ *</span>
<a href="#l37.928"></a><span id="l37.928" class="difflineplus">+ * Guarantees:</span>
<a href="#l37.929"></a><span id="l37.929" class="difflineplus">+ *</span>
<a href="#l37.930"></a><span id="l37.930" class="difflineplus">+ * 1. that fulfilled and rejected will be called only once.</span>
<a href="#l37.931"></a><span id="l37.931" class="difflineplus">+ * 2. that either the fulfilled callback or the rejected callback will be</span>
<a href="#l37.932"></a><span id="l37.932" class="difflineplus">+ *    called, but not both.</span>
<a href="#l37.933"></a><span id="l37.933" class="difflineplus">+ * 3. that fulfilled and rejected will not be called in this turn.</span>
<a href="#l37.934"></a><span id="l37.934" class="difflineplus">+ *</span>
<a href="#l37.935"></a><span id="l37.935" class="difflineplus">+ * @param value      promise or immediate reference to observe</span>
<a href="#l37.936"></a><span id="l37.936" class="difflineplus">+ * @param fulfilled  function to be called with the fulfilled value</span>
<a href="#l37.937"></a><span id="l37.937" class="difflineplus">+ * @param rejected   function to be called with the rejection exception</span>
<a href="#l37.938"></a><span id="l37.938" class="difflineplus">+ * @param progressed function to be called on any progress notifications</span>
<a href="#l37.939"></a><span id="l37.939" class="difflineplus">+ * @return promise for the return value from the invoked callback</span>
<a href="#l37.940"></a><span id="l37.940" class="difflineplus">+ */</span>
<a href="#l37.941"></a><span id="l37.941" class="difflineplus">+Q.when = when;</span>
<a href="#l37.942"></a><span id="l37.942" class="difflineplus">+function when(value, fulfilled, rejected, progressed) {</span>
<a href="#l37.943"></a><span id="l37.943" class="difflineplus">+    return Q(value).then(fulfilled, rejected, progressed);</span>
<a href="#l37.944"></a><span id="l37.944" class="difflineplus">+}</span>
<a href="#l37.945"></a><span id="l37.945" class="difflineplus">+</span>
<a href="#l37.946"></a><span id="l37.946" class="difflineplus">+Promise.prototype.thenResolve = function (value) {</span>
<a href="#l37.947"></a><span id="l37.947" class="difflineplus">+    return this.then(function () { return value; });</span>
<a href="#l37.948"></a><span id="l37.948" class="difflineplus">+};</span>
<a href="#l37.949"></a><span id="l37.949" class="difflineplus">+</span>
<a href="#l37.950"></a><span id="l37.950" class="difflineplus">+Q.thenResolve = function (promise, value) {</span>
<a href="#l37.951"></a><span id="l37.951" class="difflineplus">+    return Q(promise).thenResolve(value);</span>
<a href="#l37.952"></a><span id="l37.952" class="difflineplus">+};</span>
<a href="#l37.953"></a><span id="l37.953" class="difflineplus">+</span>
<a href="#l37.954"></a><span id="l37.954" class="difflineplus">+Promise.prototype.thenReject = function (reason) {</span>
<a href="#l37.955"></a><span id="l37.955" class="difflineplus">+    return this.then(function () { throw reason; });</span>
<a href="#l37.956"></a><span id="l37.956" class="difflineplus">+};</span>
<a href="#l37.957"></a><span id="l37.957" class="difflineplus">+</span>
<a href="#l37.958"></a><span id="l37.958" class="difflineplus">+Q.thenReject = function (promise, reason) {</span>
<a href="#l37.959"></a><span id="l37.959" class="difflineplus">+    return Q(promise).thenReject(reason);</span>
<a href="#l37.960"></a><span id="l37.960" class="difflineplus">+};</span>
<a href="#l37.961"></a><span id="l37.961" class="difflineplus">+</span>
<a href="#l37.962"></a><span id="l37.962" class="difflineplus">+/**</span>
<a href="#l37.963"></a><span id="l37.963" class="difflineplus">+ * If an object is not a promise, it is as &quot;near&quot; as possible.</span>
<a href="#l37.964"></a><span id="l37.964" class="difflineplus">+ * If a promise is rejected, it is as &quot;near&quot; as possible too.</span>
<a href="#l37.965"></a><span id="l37.965" class="difflineplus">+ * If its a fulfilled promise, the fulfillment value is nearer.</span>
<a href="#l37.966"></a><span id="l37.966" class="difflineplus">+ * If its a deferred promise and the deferred has been resolved, the</span>
<a href="#l37.967"></a><span id="l37.967" class="difflineplus">+ * resolution is &quot;nearer&quot;.</span>
<a href="#l37.968"></a><span id="l37.968" class="difflineplus">+ * @param object</span>
<a href="#l37.969"></a><span id="l37.969" class="difflineplus">+ * @returns most resolved (nearest) form of the object</span>
<a href="#l37.970"></a><span id="l37.970" class="difflineplus">+ */</span>
<a href="#l37.971"></a><span id="l37.971" class="difflineplus">+</span>
<a href="#l37.972"></a><span id="l37.972" class="difflineplus">+// XXX should we re-do this?</span>
<a href="#l37.973"></a><span id="l37.973" class="difflineplus">+Q.nearer = nearer;</span>
<a href="#l37.974"></a><span id="l37.974" class="difflineplus">+function nearer(value) {</span>
<a href="#l37.975"></a><span id="l37.975" class="difflineplus">+    if (isPromise(value)) {</span>
<a href="#l37.976"></a><span id="l37.976" class="difflineplus">+        var inspected = value.inspect();</span>
<a href="#l37.977"></a><span id="l37.977" class="difflineplus">+        if (inspected.state === &quot;fulfilled&quot;) {</span>
<a href="#l37.978"></a><span id="l37.978" class="difflineplus">+            return inspected.value;</span>
<a href="#l37.979"></a><span id="l37.979" class="difflineplus">+        }</span>
<a href="#l37.980"></a><span id="l37.980" class="difflineplus">+    }</span>
<a href="#l37.981"></a><span id="l37.981" class="difflineplus">+    return value;</span>
<a href="#l37.982"></a><span id="l37.982" class="difflineplus">+}</span>
<a href="#l37.983"></a><span id="l37.983" class="difflineplus">+</span>
<a href="#l37.984"></a><span id="l37.984" class="difflineplus">+/**</span>
<a href="#l37.985"></a><span id="l37.985" class="difflineplus">+ * @returns whether the given object is a promise.</span>
<a href="#l37.986"></a><span id="l37.986" class="difflineplus">+ * Otherwise it is a fulfilled value.</span>
<a href="#l37.987"></a><span id="l37.987" class="difflineplus">+ */</span>
<a href="#l37.988"></a><span id="l37.988" class="difflineplus">+Q.isPromise = isPromise;</span>
<a href="#l37.989"></a><span id="l37.989" class="difflineplus">+function isPromise(object) {</span>
<a href="#l37.990"></a><span id="l37.990" class="difflineplus">+    return object instanceof Promise;</span>
<a href="#l37.991"></a><span id="l37.991" class="difflineplus">+}</span>
<a href="#l37.992"></a><span id="l37.992" class="difflineplus">+</span>
<a href="#l37.993"></a><span id="l37.993" class="difflineplus">+Q.isPromiseAlike = isPromiseAlike;</span>
<a href="#l37.994"></a><span id="l37.994" class="difflineplus">+function isPromiseAlike(object) {</span>
<a href="#l37.995"></a><span id="l37.995" class="difflineplus">+    return isObject(object) &amp;&amp; typeof object.then === &quot;function&quot;;</span>
<a href="#l37.996"></a><span id="l37.996" class="difflineplus">+}</span>
<a href="#l37.997"></a><span id="l37.997" class="difflineplus">+</span>
<a href="#l37.998"></a><span id="l37.998" class="difflineplus">+/**</span>
<a href="#l37.999"></a><span id="l37.999" class="difflineplus">+ * @returns whether the given object is a pending promise, meaning not</span>
<a href="#l37.1000"></a><span id="l37.1000" class="difflineplus">+ * fulfilled or rejected.</span>
<a href="#l37.1001"></a><span id="l37.1001" class="difflineplus">+ */</span>
<a href="#l37.1002"></a><span id="l37.1002" class="difflineplus">+Q.isPending = isPending;</span>
<a href="#l37.1003"></a><span id="l37.1003" class="difflineplus">+function isPending(object) {</span>
<a href="#l37.1004"></a><span id="l37.1004" class="difflineplus">+    return isPromise(object) &amp;&amp; object.inspect().state === &quot;pending&quot;;</span>
<a href="#l37.1005"></a><span id="l37.1005" class="difflineplus">+}</span>
<a href="#l37.1006"></a><span id="l37.1006" class="difflineplus">+</span>
<a href="#l37.1007"></a><span id="l37.1007" class="difflineplus">+Promise.prototype.isPending = function () {</span>
<a href="#l37.1008"></a><span id="l37.1008" class="difflineplus">+    return this.inspect().state === &quot;pending&quot;;</span>
<a href="#l37.1009"></a><span id="l37.1009" class="difflineplus">+};</span>
<a href="#l37.1010"></a><span id="l37.1010" class="difflineplus">+</span>
<a href="#l37.1011"></a><span id="l37.1011" class="difflineplus">+/**</span>
<a href="#l37.1012"></a><span id="l37.1012" class="difflineplus">+ * @returns whether the given object is a value or fulfilled</span>
<a href="#l37.1013"></a><span id="l37.1013" class="difflineplus">+ * promise.</span>
<a href="#l37.1014"></a><span id="l37.1014" class="difflineplus">+ */</span>
<a href="#l37.1015"></a><span id="l37.1015" class="difflineplus">+Q.isFulfilled = isFulfilled;</span>
<a href="#l37.1016"></a><span id="l37.1016" class="difflineplus">+function isFulfilled(object) {</span>
<a href="#l37.1017"></a><span id="l37.1017" class="difflineplus">+    return !isPromise(object) || object.inspect().state === &quot;fulfilled&quot;;</span>
<a href="#l37.1018"></a><span id="l37.1018" class="difflineplus">+}</span>
<a href="#l37.1019"></a><span id="l37.1019" class="difflineplus">+</span>
<a href="#l37.1020"></a><span id="l37.1020" class="difflineplus">+Promise.prototype.isFulfilled = function () {</span>
<a href="#l37.1021"></a><span id="l37.1021" class="difflineplus">+    return this.inspect().state === &quot;fulfilled&quot;;</span>
<a href="#l37.1022"></a><span id="l37.1022" class="difflineplus">+};</span>
<a href="#l37.1023"></a><span id="l37.1023" class="difflineplus">+</span>
<a href="#l37.1024"></a><span id="l37.1024" class="difflineplus">+/**</span>
<a href="#l37.1025"></a><span id="l37.1025" class="difflineplus">+ * @returns whether the given object is a rejected promise.</span>
<a href="#l37.1026"></a><span id="l37.1026" class="difflineplus">+ */</span>
<a href="#l37.1027"></a><span id="l37.1027" class="difflineplus">+Q.isRejected = isRejected;</span>
<a href="#l37.1028"></a><span id="l37.1028" class="difflineplus">+function isRejected(object) {</span>
<a href="#l37.1029"></a><span id="l37.1029" class="difflineplus">+    return isPromise(object) &amp;&amp; object.inspect().state === &quot;rejected&quot;;</span>
<a href="#l37.1030"></a><span id="l37.1030" class="difflineplus">+}</span>
<a href="#l37.1031"></a><span id="l37.1031" class="difflineplus">+</span>
<a href="#l37.1032"></a><span id="l37.1032" class="difflineplus">+Promise.prototype.isRejected = function () {</span>
<a href="#l37.1033"></a><span id="l37.1033" class="difflineplus">+    return this.inspect().state === &quot;rejected&quot;;</span>
<a href="#l37.1034"></a><span id="l37.1034" class="difflineplus">+};</span>
<a href="#l37.1035"></a><span id="l37.1035" class="difflineplus">+</span>
<a href="#l37.1036"></a><span id="l37.1036" class="difflineplus">+//// BEGIN UNHANDLED REJECTION TRACKING</span>
<a href="#l37.1037"></a><span id="l37.1037" class="difflineplus">+</span>
<a href="#l37.1038"></a><span id="l37.1038" class="difflineplus">+// This promise library consumes exceptions thrown in handlers so they can be</span>
<a href="#l37.1039"></a><span id="l37.1039" class="difflineplus">+// handled by a subsequent promise.  The exceptions get added to this array when</span>
<a href="#l37.1040"></a><span id="l37.1040" class="difflineplus">+// they are created, and removed when they are handled.  Note that in ES6 or</span>
<a href="#l37.1041"></a><span id="l37.1041" class="difflineplus">+// shimmed environments, this would naturally be a `Set`.</span>
<a href="#l37.1042"></a><span id="l37.1042" class="difflineplus">+var unhandledReasons = [];</span>
<a href="#l37.1043"></a><span id="l37.1043" class="difflineplus">+var unhandledRejections = [];</span>
<a href="#l37.1044"></a><span id="l37.1044" class="difflineplus">+var reportedUnhandledRejections = [];</span>
<a href="#l37.1045"></a><span id="l37.1045" class="difflineplus">+var trackUnhandledRejections = true;</span>
<a href="#l37.1046"></a><span id="l37.1046" class="difflineplus">+</span>
<a href="#l37.1047"></a><span id="l37.1047" class="difflineplus">+function resetUnhandledRejections() {</span>
<a href="#l37.1048"></a><span id="l37.1048" class="difflineplus">+    unhandledReasons.length = 0;</span>
<a href="#l37.1049"></a><span id="l37.1049" class="difflineplus">+    unhandledRejections.length = 0;</span>
<a href="#l37.1050"></a><span id="l37.1050" class="difflineplus">+</span>
<a href="#l37.1051"></a><span id="l37.1051" class="difflineplus">+    if (!trackUnhandledRejections) {</span>
<a href="#l37.1052"></a><span id="l37.1052" class="difflineplus">+        trackUnhandledRejections = true;</span>
<a href="#l37.1053"></a><span id="l37.1053" class="difflineplus">+    }</span>
<a href="#l37.1054"></a><span id="l37.1054" class="difflineplus">+}</span>
<a href="#l37.1055"></a><span id="l37.1055" class="difflineplus">+</span>
<a href="#l37.1056"></a><span id="l37.1056" class="difflineplus">+function trackRejection(promise, reason) {</span>
<a href="#l37.1057"></a><span id="l37.1057" class="difflineplus">+    if (!trackUnhandledRejections) {</span>
<a href="#l37.1058"></a><span id="l37.1058" class="difflineplus">+        return;</span>
<a href="#l37.1059"></a><span id="l37.1059" class="difflineplus">+    }</span>
<a href="#l37.1060"></a><span id="l37.1060" class="difflineplus">+    if (typeof process === &quot;object&quot; &amp;&amp; typeof process.emit === &quot;function&quot;) {</span>
<a href="#l37.1061"></a><span id="l37.1061" class="difflineplus">+        Q.nextTick.runAfter(function () {</span>
<a href="#l37.1062"></a><span id="l37.1062" class="difflineplus">+            if (array_indexOf(unhandledRejections, promise) !== -1) {</span>
<a href="#l37.1063"></a><span id="l37.1063" class="difflineplus">+                process.emit(&quot;unhandledRejection&quot;, reason, promise);</span>
<a href="#l37.1064"></a><span id="l37.1064" class="difflineplus">+                reportedUnhandledRejections.push(promise);</span>
<a href="#l37.1065"></a><span id="l37.1065" class="difflineplus">+            }</span>
<a href="#l37.1066"></a><span id="l37.1066" class="difflineplus">+        });</span>
<a href="#l37.1067"></a><span id="l37.1067" class="difflineplus">+    }</span>
<a href="#l37.1068"></a><span id="l37.1068" class="difflineplus">+</span>
<a href="#l37.1069"></a><span id="l37.1069" class="difflineplus">+    unhandledRejections.push(promise);</span>
<a href="#l37.1070"></a><span id="l37.1070" class="difflineplus">+    if (reason &amp;&amp; typeof reason.stack !== &quot;undefined&quot;) {</span>
<a href="#l37.1071"></a><span id="l37.1071" class="difflineplus">+        unhandledReasons.push(reason.stack);</span>
<a href="#l37.1072"></a><span id="l37.1072" class="difflineplus">+    } else {</span>
<a href="#l37.1073"></a><span id="l37.1073" class="difflineplus">+        unhandledReasons.push(&quot;(no stack) &quot; + reason);</span>
<a href="#l37.1074"></a><span id="l37.1074" class="difflineplus">+    }</span>
<a href="#l37.1075"></a><span id="l37.1075" class="difflineplus">+}</span>
<a href="#l37.1076"></a><span id="l37.1076" class="difflineplus">+</span>
<a href="#l37.1077"></a><span id="l37.1077" class="difflineplus">+function untrackRejection(promise) {</span>
<a href="#l37.1078"></a><span id="l37.1078" class="difflineplus">+    if (!trackUnhandledRejections) {</span>
<a href="#l37.1079"></a><span id="l37.1079" class="difflineplus">+        return;</span>
<a href="#l37.1080"></a><span id="l37.1080" class="difflineplus">+    }</span>
<a href="#l37.1081"></a><span id="l37.1081" class="difflineplus">+</span>
<a href="#l37.1082"></a><span id="l37.1082" class="difflineplus">+    var at = array_indexOf(unhandledRejections, promise);</span>
<a href="#l37.1083"></a><span id="l37.1083" class="difflineplus">+    if (at !== -1) {</span>
<a href="#l37.1084"></a><span id="l37.1084" class="difflineplus">+        if (typeof process === &quot;object&quot; &amp;&amp; typeof process.emit === &quot;function&quot;) {</span>
<a href="#l37.1085"></a><span id="l37.1085" class="difflineplus">+            Q.nextTick.runAfter(function () {</span>
<a href="#l37.1086"></a><span id="l37.1086" class="difflineplus">+                var atReport = array_indexOf(reportedUnhandledRejections, promise);</span>
<a href="#l37.1087"></a><span id="l37.1087" class="difflineplus">+                if (atReport !== -1) {</span>
<a href="#l37.1088"></a><span id="l37.1088" class="difflineplus">+                    process.emit(&quot;rejectionHandled&quot;, unhandledReasons[at], promise);</span>
<a href="#l37.1089"></a><span id="l37.1089" class="difflineplus">+                    reportedUnhandledRejections.splice(atReport, 1);</span>
<a href="#l37.1090"></a><span id="l37.1090" class="difflineplus">+                }</span>
<a href="#l37.1091"></a><span id="l37.1091" class="difflineplus">+            });</span>
<a href="#l37.1092"></a><span id="l37.1092" class="difflineplus">+        }</span>
<a href="#l37.1093"></a><span id="l37.1093" class="difflineplus">+        unhandledRejections.splice(at, 1);</span>
<a href="#l37.1094"></a><span id="l37.1094" class="difflineplus">+        unhandledReasons.splice(at, 1);</span>
<a href="#l37.1095"></a><span id="l37.1095" class="difflineplus">+    }</span>
<a href="#l37.1096"></a><span id="l37.1096" class="difflineplus">+}</span>
<a href="#l37.1097"></a><span id="l37.1097" class="difflineplus">+</span>
<a href="#l37.1098"></a><span id="l37.1098" class="difflineplus">+Q.resetUnhandledRejections = resetUnhandledRejections;</span>
<a href="#l37.1099"></a><span id="l37.1099" class="difflineplus">+</span>
<a href="#l37.1100"></a><span id="l37.1100" class="difflineplus">+Q.getUnhandledReasons = function () {</span>
<a href="#l37.1101"></a><span id="l37.1101" class="difflineplus">+    // Make a copy so that consumers can't interfere with our internal state.</span>
<a href="#l37.1102"></a><span id="l37.1102" class="difflineplus">+    return unhandledReasons.slice();</span>
<a href="#l37.1103"></a><span id="l37.1103" class="difflineplus">+};</span>
<a href="#l37.1104"></a><span id="l37.1104" class="difflineplus">+</span>
<a href="#l37.1105"></a><span id="l37.1105" class="difflineplus">+Q.stopUnhandledRejectionTracking = function () {</span>
<a href="#l37.1106"></a><span id="l37.1106" class="difflineplus">+    resetUnhandledRejections();</span>
<a href="#l37.1107"></a><span id="l37.1107" class="difflineplus">+    trackUnhandledRejections = false;</span>
<a href="#l37.1108"></a><span id="l37.1108" class="difflineplus">+};</span>
<a href="#l37.1109"></a><span id="l37.1109" class="difflineplus">+</span>
<a href="#l37.1110"></a><span id="l37.1110" class="difflineplus">+resetUnhandledRejections();</span>
<a href="#l37.1111"></a><span id="l37.1111" class="difflineplus">+</span>
<a href="#l37.1112"></a><span id="l37.1112" class="difflineplus">+//// END UNHANDLED REJECTION TRACKING</span>
<a href="#l37.1113"></a><span id="l37.1113" class="difflineplus">+</span>
<a href="#l37.1114"></a><span id="l37.1114" class="difflineplus">+/**</span>
<a href="#l37.1115"></a><span id="l37.1115" class="difflineplus">+ * Constructs a rejected promise.</span>
<a href="#l37.1116"></a><span id="l37.1116" class="difflineplus">+ * @param reason value describing the failure</span>
<a href="#l37.1117"></a><span id="l37.1117" class="difflineplus">+ */</span>
<a href="#l37.1118"></a><span id="l37.1118" class="difflineplus">+Q.reject = reject;</span>
<a href="#l37.1119"></a><span id="l37.1119" class="difflineplus">+function reject(reason) {</span>
<a href="#l37.1120"></a><span id="l37.1120" class="difflineplus">+    var rejection = Promise({</span>
<a href="#l37.1121"></a><span id="l37.1121" class="difflineplus">+        &quot;when&quot;: function (rejected) {</span>
<a href="#l37.1122"></a><span id="l37.1122" class="difflineplus">+            // note that the error has been handled</span>
<a href="#l37.1123"></a><span id="l37.1123" class="difflineplus">+            if (rejected) {</span>
<a href="#l37.1124"></a><span id="l37.1124" class="difflineplus">+                untrackRejection(this);</span>
<a href="#l37.1125"></a><span id="l37.1125" class="difflineplus">+            }</span>
<a href="#l37.1126"></a><span id="l37.1126" class="difflineplus">+            return rejected ? rejected(reason) : this;</span>
<a href="#l37.1127"></a><span id="l37.1127" class="difflineplus">+        }</span>
<a href="#l37.1128"></a><span id="l37.1128" class="difflineplus">+    }, function fallback() {</span>
<a href="#l37.1129"></a><span id="l37.1129" class="difflineplus">+        return this;</span>
<a href="#l37.1130"></a><span id="l37.1130" class="difflineplus">+    }, function inspect() {</span>
<a href="#l37.1131"></a><span id="l37.1131" class="difflineplus">+        return { state: &quot;rejected&quot;, reason: reason };</span>
<a href="#l37.1132"></a><span id="l37.1132" class="difflineplus">+    });</span>
<a href="#l37.1133"></a><span id="l37.1133" class="difflineplus">+</span>
<a href="#l37.1134"></a><span id="l37.1134" class="difflineplus">+    // Note that the reason has not been handled.</span>
<a href="#l37.1135"></a><span id="l37.1135" class="difflineplus">+    trackRejection(rejection, reason);</span>
<a href="#l37.1136"></a><span id="l37.1136" class="difflineplus">+</span>
<a href="#l37.1137"></a><span id="l37.1137" class="difflineplus">+    return rejection;</span>
<a href="#l37.1138"></a><span id="l37.1138" class="difflineplus">+}</span>
<a href="#l37.1139"></a><span id="l37.1139" class="difflineplus">+</span>
<a href="#l37.1140"></a><span id="l37.1140" class="difflineplus">+/**</span>
<a href="#l37.1141"></a><span id="l37.1141" class="difflineplus">+ * Constructs a fulfilled promise for an immediate reference.</span>
<a href="#l37.1142"></a><span id="l37.1142" class="difflineplus">+ * @param value immediate reference</span>
<a href="#l37.1143"></a><span id="l37.1143" class="difflineplus">+ */</span>
<a href="#l37.1144"></a><span id="l37.1144" class="difflineplus">+Q.fulfill = fulfill;</span>
<a href="#l37.1145"></a><span id="l37.1145" class="difflineplus">+function fulfill(value) {</span>
<a href="#l37.1146"></a><span id="l37.1146" class="difflineplus">+    return Promise({</span>
<a href="#l37.1147"></a><span id="l37.1147" class="difflineplus">+        &quot;when&quot;: function () {</span>
<a href="#l37.1148"></a><span id="l37.1148" class="difflineplus">+            return value;</span>
<a href="#l37.1149"></a><span id="l37.1149" class="difflineplus">+        },</span>
<a href="#l37.1150"></a><span id="l37.1150" class="difflineplus">+        &quot;get&quot;: function (name) {</span>
<a href="#l37.1151"></a><span id="l37.1151" class="difflineplus">+            return value[name];</span>
<a href="#l37.1152"></a><span id="l37.1152" class="difflineplus">+        },</span>
<a href="#l37.1153"></a><span id="l37.1153" class="difflineplus">+        &quot;set&quot;: function (name, rhs) {</span>
<a href="#l37.1154"></a><span id="l37.1154" class="difflineplus">+            value[name] = rhs;</span>
<a href="#l37.1155"></a><span id="l37.1155" class="difflineplus">+        },</span>
<a href="#l37.1156"></a><span id="l37.1156" class="difflineplus">+        &quot;delete&quot;: function (name) {</span>
<a href="#l37.1157"></a><span id="l37.1157" class="difflineplus">+            delete value[name];</span>
<a href="#l37.1158"></a><span id="l37.1158" class="difflineplus">+        },</span>
<a href="#l37.1159"></a><span id="l37.1159" class="difflineplus">+        &quot;post&quot;: function (name, args) {</span>
<a href="#l37.1160"></a><span id="l37.1160" class="difflineplus">+            // Mark Miller proposes that post with no name should apply a</span>
<a href="#l37.1161"></a><span id="l37.1161" class="difflineplus">+            // promised function.</span>
<a href="#l37.1162"></a><span id="l37.1162" class="difflineplus">+            if (name === null || name === void 0) {</span>
<a href="#l37.1163"></a><span id="l37.1163" class="difflineplus">+                return value.apply(void 0, args);</span>
<a href="#l37.1164"></a><span id="l37.1164" class="difflineplus">+            } else {</span>
<a href="#l37.1165"></a><span id="l37.1165" class="difflineplus">+                return value[name].apply(value, args);</span>
<a href="#l37.1166"></a><span id="l37.1166" class="difflineplus">+            }</span>
<a href="#l37.1167"></a><span id="l37.1167" class="difflineplus">+        },</span>
<a href="#l37.1168"></a><span id="l37.1168" class="difflineplus">+        &quot;apply&quot;: function (thisp, args) {</span>
<a href="#l37.1169"></a><span id="l37.1169" class="difflineplus">+            return value.apply(thisp, args);</span>
<a href="#l37.1170"></a><span id="l37.1170" class="difflineplus">+        },</span>
<a href="#l37.1171"></a><span id="l37.1171" class="difflineplus">+        &quot;keys&quot;: function () {</span>
<a href="#l37.1172"></a><span id="l37.1172" class="difflineplus">+            return object_keys(value);</span>
<a href="#l37.1173"></a><span id="l37.1173" class="difflineplus">+        }</span>
<a href="#l37.1174"></a><span id="l37.1174" class="difflineplus">+    }, void 0, function inspect() {</span>
<a href="#l37.1175"></a><span id="l37.1175" class="difflineplus">+        return { state: &quot;fulfilled&quot;, value: value };</span>
<a href="#l37.1176"></a><span id="l37.1176" class="difflineplus">+    });</span>
<a href="#l37.1177"></a><span id="l37.1177" class="difflineplus">+}</span>
<a href="#l37.1178"></a><span id="l37.1178" class="difflineplus">+</span>
<a href="#l37.1179"></a><span id="l37.1179" class="difflineplus">+/**</span>
<a href="#l37.1180"></a><span id="l37.1180" class="difflineplus">+ * Converts thenables to Q promises.</span>
<a href="#l37.1181"></a><span id="l37.1181" class="difflineplus">+ * @param promise thenable promise</span>
<a href="#l37.1182"></a><span id="l37.1182" class="difflineplus">+ * @returns a Q promise</span>
<a href="#l37.1183"></a><span id="l37.1183" class="difflineplus">+ */</span>
<a href="#l37.1184"></a><span id="l37.1184" class="difflineplus">+function coerce(promise) {</span>
<a href="#l37.1185"></a><span id="l37.1185" class="difflineplus">+    var deferred = defer();</span>
<a href="#l37.1186"></a><span id="l37.1186" class="difflineplus">+    Q.nextTick(function () {</span>
<a href="#l37.1187"></a><span id="l37.1187" class="difflineplus">+        try {</span>
<a href="#l37.1188"></a><span id="l37.1188" class="difflineplus">+            promise.then(deferred.resolve, deferred.reject, deferred.notify);</span>
<a href="#l37.1189"></a><span id="l37.1189" class="difflineplus">+        } catch (exception) {</span>
<a href="#l37.1190"></a><span id="l37.1190" class="difflineplus">+            deferred.reject(exception);</span>
<a href="#l37.1191"></a><span id="l37.1191" class="difflineplus">+        }</span>
<a href="#l37.1192"></a><span id="l37.1192" class="difflineplus">+    });</span>
<a href="#l37.1193"></a><span id="l37.1193" class="difflineplus">+    return deferred.promise;</span>
<a href="#l37.1194"></a><span id="l37.1194" class="difflineplus">+}</span>
<a href="#l37.1195"></a><span id="l37.1195" class="difflineplus">+</span>
<a href="#l37.1196"></a><span id="l37.1196" class="difflineplus">+/**</span>
<a href="#l37.1197"></a><span id="l37.1197" class="difflineplus">+ * Annotates an object such that it will never be</span>
<a href="#l37.1198"></a><span id="l37.1198" class="difflineplus">+ * transferred away from this process over any promise</span>
<a href="#l37.1199"></a><span id="l37.1199" class="difflineplus">+ * communication channel.</span>
<a href="#l37.1200"></a><span id="l37.1200" class="difflineplus">+ * @param object</span>
<a href="#l37.1201"></a><span id="l37.1201" class="difflineplus">+ * @returns promise a wrapping of that object that</span>
<a href="#l37.1202"></a><span id="l37.1202" class="difflineplus">+ * additionally responds to the &quot;isDef&quot; message</span>
<a href="#l37.1203"></a><span id="l37.1203" class="difflineplus">+ * without a rejection.</span>
<a href="#l37.1204"></a><span id="l37.1204" class="difflineplus">+ */</span>
<a href="#l37.1205"></a><span id="l37.1205" class="difflineplus">+Q.master = master;</span>
<a href="#l37.1206"></a><span id="l37.1206" class="difflineplus">+function master(object) {</span>
<a href="#l37.1207"></a><span id="l37.1207" class="difflineplus">+    return Promise({</span>
<a href="#l37.1208"></a><span id="l37.1208" class="difflineplus">+        &quot;isDef&quot;: function () {}</span>
<a href="#l37.1209"></a><span id="l37.1209" class="difflineplus">+    }, function fallback(op, args) {</span>
<a href="#l37.1210"></a><span id="l37.1210" class="difflineplus">+        return dispatch(object, op, args);</span>
<a href="#l37.1211"></a><span id="l37.1211" class="difflineplus">+    }, function () {</span>
<a href="#l37.1212"></a><span id="l37.1212" class="difflineplus">+        return Q(object).inspect();</span>
<a href="#l37.1213"></a><span id="l37.1213" class="difflineplus">+    });</span>
<a href="#l37.1214"></a><span id="l37.1214" class="difflineplus">+}</span>
<a href="#l37.1215"></a><span id="l37.1215" class="difflineplus">+</span>
<a href="#l37.1216"></a><span id="l37.1216" class="difflineplus">+/**</span>
<a href="#l37.1217"></a><span id="l37.1217" class="difflineplus">+ * Spreads the values of a promised array of arguments into the</span>
<a href="#l37.1218"></a><span id="l37.1218" class="difflineplus">+ * fulfillment callback.</span>
<a href="#l37.1219"></a><span id="l37.1219" class="difflineplus">+ * @param fulfilled callback that receives variadic arguments from the</span>
<a href="#l37.1220"></a><span id="l37.1220" class="difflineplus">+ * promised array</span>
<a href="#l37.1221"></a><span id="l37.1221" class="difflineplus">+ * @param rejected callback that receives the exception if the promise</span>
<a href="#l37.1222"></a><span id="l37.1222" class="difflineplus">+ * is rejected.</span>
<a href="#l37.1223"></a><span id="l37.1223" class="difflineplus">+ * @returns a promise for the return value or thrown exception of</span>
<a href="#l37.1224"></a><span id="l37.1224" class="difflineplus">+ * either callback.</span>
<a href="#l37.1225"></a><span id="l37.1225" class="difflineplus">+ */</span>
<a href="#l37.1226"></a><span id="l37.1226" class="difflineplus">+Q.spread = spread;</span>
<a href="#l37.1227"></a><span id="l37.1227" class="difflineplus">+function spread(value, fulfilled, rejected) {</span>
<a href="#l37.1228"></a><span id="l37.1228" class="difflineplus">+    return Q(value).spread(fulfilled, rejected);</span>
<a href="#l37.1229"></a><span id="l37.1229" class="difflineplus">+}</span>
<a href="#l37.1230"></a><span id="l37.1230" class="difflineplus">+</span>
<a href="#l37.1231"></a><span id="l37.1231" class="difflineplus">+Promise.prototype.spread = function (fulfilled, rejected) {</span>
<a href="#l37.1232"></a><span id="l37.1232" class="difflineplus">+    return this.all().then(function (array) {</span>
<a href="#l37.1233"></a><span id="l37.1233" class="difflineplus">+        return fulfilled.apply(void 0, array);</span>
<a href="#l37.1234"></a><span id="l37.1234" class="difflineplus">+    }, rejected);</span>
<a href="#l37.1235"></a><span id="l37.1235" class="difflineplus">+};</span>
<a href="#l37.1236"></a><span id="l37.1236" class="difflineplus">+</span>
<a href="#l37.1237"></a><span id="l37.1237" class="difflineplus">+/**</span>
<a href="#l37.1238"></a><span id="l37.1238" class="difflineplus">+ * The async function is a decorator for generator functions, turning</span>
<a href="#l37.1239"></a><span id="l37.1239" class="difflineplus">+ * them into asynchronous generators.  Although generators are only part</span>
<a href="#l37.1240"></a><span id="l37.1240" class="difflineplus">+ * of the newest ECMAScript 6 drafts, this code does not cause syntax</span>
<a href="#l37.1241"></a><span id="l37.1241" class="difflineplus">+ * errors in older engines.  This code should continue to work and will</span>
<a href="#l37.1242"></a><span id="l37.1242" class="difflineplus">+ * in fact improve over time as the language improves.</span>
<a href="#l37.1243"></a><span id="l37.1243" class="difflineplus">+ *</span>
<a href="#l37.1244"></a><span id="l37.1244" class="difflineplus">+ * ES6 generators are currently part of V8 version 3.19 with the</span>
<a href="#l37.1245"></a><span id="l37.1245" class="difflineplus">+ * --harmony-generators runtime flag enabled.  SpiderMonkey has had them</span>
<a href="#l37.1246"></a><span id="l37.1246" class="difflineplus">+ * for longer, but under an older Python-inspired form.  This function</span>
<a href="#l37.1247"></a><span id="l37.1247" class="difflineplus">+ * works on both kinds of generators.</span>
<a href="#l37.1248"></a><span id="l37.1248" class="difflineplus">+ *</span>
<a href="#l37.1249"></a><span id="l37.1249" class="difflineplus">+ * Decorates a generator function such that:</span>
<a href="#l37.1250"></a><span id="l37.1250" class="difflineplus">+ *  - it may yield promises</span>
<a href="#l37.1251"></a><span id="l37.1251" class="difflineplus">+ *  - execution will continue when that promise is fulfilled</span>
<a href="#l37.1252"></a><span id="l37.1252" class="difflineplus">+ *  - the value of the yield expression will be the fulfilled value</span>
<a href="#l37.1253"></a><span id="l37.1253" class="difflineplus">+ *  - it returns a promise for the return value (when the generator</span>
<a href="#l37.1254"></a><span id="l37.1254" class="difflineplus">+ *    stops iterating)</span>
<a href="#l37.1255"></a><span id="l37.1255" class="difflineplus">+ *  - the decorated function returns a promise for the return value</span>
<a href="#l37.1256"></a><span id="l37.1256" class="difflineplus">+ *    of the generator or the first rejected promise among those</span>
<a href="#l37.1257"></a><span id="l37.1257" class="difflineplus">+ *    yielded.</span>
<a href="#l37.1258"></a><span id="l37.1258" class="difflineplus">+ *  - if an error is thrown in the generator, it propagates through</span>
<a href="#l37.1259"></a><span id="l37.1259" class="difflineplus">+ *    every following yield until it is caught, or until it escapes</span>
<a href="#l37.1260"></a><span id="l37.1260" class="difflineplus">+ *    the generator function altogether, and is translated into a</span>
<a href="#l37.1261"></a><span id="l37.1261" class="difflineplus">+ *    rejection for the promise returned by the decorated generator.</span>
<a href="#l37.1262"></a><span id="l37.1262" class="difflineplus">+ */</span>
<a href="#l37.1263"></a><span id="l37.1263" class="difflineplus">+Q.async = async;</span>
<a href="#l37.1264"></a><span id="l37.1264" class="difflineplus">+function async(makeGenerator) {</span>
<a href="#l37.1265"></a><span id="l37.1265" class="difflineplus">+    return function () {</span>
<a href="#l37.1266"></a><span id="l37.1266" class="difflineplus">+        // when verb is &quot;send&quot;, arg is a value</span>
<a href="#l37.1267"></a><span id="l37.1267" class="difflineplus">+        // when verb is &quot;throw&quot;, arg is an exception</span>
<a href="#l37.1268"></a><span id="l37.1268" class="difflineplus">+        function continuer(verb, arg) {</span>
<a href="#l37.1269"></a><span id="l37.1269" class="difflineplus">+            var result;</span>
<a href="#l37.1270"></a><span id="l37.1270" class="difflineplus">+</span>
<a href="#l37.1271"></a><span id="l37.1271" class="difflineplus">+            // Until V8 3.19 / Chromium 29 is released, SpiderMonkey is the only</span>
<a href="#l37.1272"></a><span id="l37.1272" class="difflineplus">+            // engine that has a deployed base of browsers that support generators.</span>
<a href="#l37.1273"></a><span id="l37.1273" class="difflineplus">+            // However, SM's generators use the Python-inspired semantics of</span>
<a href="#l37.1274"></a><span id="l37.1274" class="difflineplus">+            // outdated ES6 drafts.  We would like to support ES6, but we'd also</span>
<a href="#l37.1275"></a><span id="l37.1275" class="difflineplus">+            // like to make it possible to use generators in deployed browsers, so</span>
<a href="#l37.1276"></a><span id="l37.1276" class="difflineplus">+            // we also support Python-style generators.  At some point we can remove</span>
<a href="#l37.1277"></a><span id="l37.1277" class="difflineplus">+            // this block.</span>
<a href="#l37.1278"></a><span id="l37.1278" class="difflineplus">+</span>
<a href="#l37.1279"></a><span id="l37.1279" class="difflineplus">+            if (typeof StopIteration === &quot;undefined&quot;) {</span>
<a href="#l37.1280"></a><span id="l37.1280" class="difflineplus">+                // ES6 Generators</span>
<a href="#l37.1281"></a><span id="l37.1281" class="difflineplus">+                try {</span>
<a href="#l37.1282"></a><span id="l37.1282" class="difflineplus">+                    result = generator[verb](arg);</span>
<a href="#l37.1283"></a><span id="l37.1283" class="difflineplus">+                } catch (exception) {</span>
<a href="#l37.1284"></a><span id="l37.1284" class="difflineplus">+                    return reject(exception);</span>
<a href="#l37.1285"></a><span id="l37.1285" class="difflineplus">+                }</span>
<a href="#l37.1286"></a><span id="l37.1286" class="difflineplus">+                if (result.done) {</span>
<a href="#l37.1287"></a><span id="l37.1287" class="difflineplus">+                    return Q(result.value);</span>
<a href="#l37.1288"></a><span id="l37.1288" class="difflineplus">+                } else {</span>
<a href="#l37.1289"></a><span id="l37.1289" class="difflineplus">+                    return when(result.value, callback, errback);</span>
<a href="#l37.1290"></a><span id="l37.1290" class="difflineplus">+                }</span>
<a href="#l37.1291"></a><span id="l37.1291" class="difflineplus">+            } else {</span>
<a href="#l37.1292"></a><span id="l37.1292" class="difflineplus">+                // SpiderMonkey Generators</span>
<a href="#l37.1293"></a><span id="l37.1293" class="difflineplus">+                // FIXME: Remove this case when SM does ES6 generators.</span>
<a href="#l37.1294"></a><span id="l37.1294" class="difflineplus">+                try {</span>
<a href="#l37.1295"></a><span id="l37.1295" class="difflineplus">+                    result = generator[verb](arg);</span>
<a href="#l37.1296"></a><span id="l37.1296" class="difflineplus">+                } catch (exception) {</span>
<a href="#l37.1297"></a><span id="l37.1297" class="difflineplus">+                    if (isStopIteration(exception)) {</span>
<a href="#l37.1298"></a><span id="l37.1298" class="difflineplus">+                        return Q(exception.value);</span>
<a href="#l37.1299"></a><span id="l37.1299" class="difflineplus">+                    } else {</span>
<a href="#l37.1300"></a><span id="l37.1300" class="difflineplus">+                        return reject(exception);</span>
<a href="#l37.1301"></a><span id="l37.1301" class="difflineplus">+                    }</span>
<a href="#l37.1302"></a><span id="l37.1302" class="difflineplus">+                }</span>
<a href="#l37.1303"></a><span id="l37.1303" class="difflineplus">+                return when(result, callback, errback);</span>
<a href="#l37.1304"></a><span id="l37.1304" class="difflineplus">+            }</span>
<a href="#l37.1305"></a><span id="l37.1305" class="difflineplus">+        }</span>
<a href="#l37.1306"></a><span id="l37.1306" class="difflineplus">+        var generator = makeGenerator.apply(this, arguments);</span>
<a href="#l37.1307"></a><span id="l37.1307" class="difflineplus">+        var callback = continuer.bind(continuer, &quot;next&quot;);</span>
<a href="#l37.1308"></a><span id="l37.1308" class="difflineplus">+        var errback = continuer.bind(continuer, &quot;throw&quot;);</span>
<a href="#l37.1309"></a><span id="l37.1309" class="difflineplus">+        return callback();</span>
<a href="#l37.1310"></a><span id="l37.1310" class="difflineplus">+    };</span>
<a href="#l37.1311"></a><span id="l37.1311" class="difflineplus">+}</span>
<a href="#l37.1312"></a><span id="l37.1312" class="difflineplus">+</span>
<a href="#l37.1313"></a><span id="l37.1313" class="difflineplus">+/**</span>
<a href="#l37.1314"></a><span id="l37.1314" class="difflineplus">+ * The spawn function is a small wrapper around async that immediately</span>
<a href="#l37.1315"></a><span id="l37.1315" class="difflineplus">+ * calls the generator and also ends the promise chain, so that any</span>
<a href="#l37.1316"></a><span id="l37.1316" class="difflineplus">+ * unhandled errors are thrown instead of forwarded to the error</span>
<a href="#l37.1317"></a><span id="l37.1317" class="difflineplus">+ * handler. This is useful because it's extremely common to run</span>
<a href="#l37.1318"></a><span id="l37.1318" class="difflineplus">+ * generators at the top-level to work with libraries.</span>
<a href="#l37.1319"></a><span id="l37.1319" class="difflineplus">+ */</span>
<a href="#l37.1320"></a><span id="l37.1320" class="difflineplus">+Q.spawn = spawn;</span>
<a href="#l37.1321"></a><span id="l37.1321" class="difflineplus">+function spawn(makeGenerator) {</span>
<a href="#l37.1322"></a><span id="l37.1322" class="difflineplus">+    Q.done(Q.async(makeGenerator)());</span>
<a href="#l37.1323"></a><span id="l37.1323" class="difflineplus">+}</span>
<a href="#l37.1324"></a><span id="l37.1324" class="difflineplus">+</span>
<a href="#l37.1325"></a><span id="l37.1325" class="difflineplus">+// FIXME: Remove this interface once ES6 generators are in SpiderMonkey.</span>
<a href="#l37.1326"></a><span id="l37.1326" class="difflineplus">+/**</span>
<a href="#l37.1327"></a><span id="l37.1327" class="difflineplus">+ * Throws a ReturnValue exception to stop an asynchronous generator.</span>
<a href="#l37.1328"></a><span id="l37.1328" class="difflineplus">+ *</span>
<a href="#l37.1329"></a><span id="l37.1329" class="difflineplus">+ * This interface is a stop-gap measure to support generator return</span>
<a href="#l37.1330"></a><span id="l37.1330" class="difflineplus">+ * values in older Firefox/SpiderMonkey.  In browsers that support ES6</span>
<a href="#l37.1331"></a><span id="l37.1331" class="difflineplus">+ * generators like Chromium 29, just use &quot;return&quot; in your generator</span>
<a href="#l37.1332"></a><span id="l37.1332" class="difflineplus">+ * functions.</span>
<a href="#l37.1333"></a><span id="l37.1333" class="difflineplus">+ *</span>
<a href="#l37.1334"></a><span id="l37.1334" class="difflineplus">+ * @param value the return value for the surrounding generator</span>
<a href="#l37.1335"></a><span id="l37.1335" class="difflineplus">+ * @throws ReturnValue exception with the value.</span>
<a href="#l37.1336"></a><span id="l37.1336" class="difflineplus">+ * @example</span>
<a href="#l37.1337"></a><span id="l37.1337" class="difflineplus">+ * // ES6 style</span>
<a href="#l37.1338"></a><span id="l37.1338" class="difflineplus">+ * Q.async(function* () {</span>
<a href="#l37.1339"></a><span id="l37.1339" class="difflineplus">+ *      var foo = yield getFooPromise();</span>
<a href="#l37.1340"></a><span id="l37.1340" class="difflineplus">+ *      var bar = yield getBarPromise();</span>
<a href="#l37.1341"></a><span id="l37.1341" class="difflineplus">+ *      return foo + bar;</span>
<a href="#l37.1342"></a><span id="l37.1342" class="difflineplus">+ * })</span>
<a href="#l37.1343"></a><span id="l37.1343" class="difflineplus">+ * // Older SpiderMonkey style</span>
<a href="#l37.1344"></a><span id="l37.1344" class="difflineplus">+ * Q.async(function () {</span>
<a href="#l37.1345"></a><span id="l37.1345" class="difflineplus">+ *      var foo = yield getFooPromise();</span>
<a href="#l37.1346"></a><span id="l37.1346" class="difflineplus">+ *      var bar = yield getBarPromise();</span>
<a href="#l37.1347"></a><span id="l37.1347" class="difflineplus">+ *      Q.return(foo + bar);</span>
<a href="#l37.1348"></a><span id="l37.1348" class="difflineplus">+ * })</span>
<a href="#l37.1349"></a><span id="l37.1349" class="difflineplus">+ */</span>
<a href="#l37.1350"></a><span id="l37.1350" class="difflineplus">+Q[&quot;return&quot;] = _return;</span>
<a href="#l37.1351"></a><span id="l37.1351" class="difflineplus">+function _return(value) {</span>
<a href="#l37.1352"></a><span id="l37.1352" class="difflineplus">+    throw new QReturnValue(value);</span>
<a href="#l37.1353"></a><span id="l37.1353" class="difflineplus">+}</span>
<a href="#l37.1354"></a><span id="l37.1354" class="difflineplus">+</span>
<a href="#l37.1355"></a><span id="l37.1355" class="difflineplus">+/**</span>
<a href="#l37.1356"></a><span id="l37.1356" class="difflineplus">+ * The promised function decorator ensures that any promise arguments</span>
<a href="#l37.1357"></a><span id="l37.1357" class="difflineplus">+ * are settled and passed as values (`this` is also settled and passed</span>
<a href="#l37.1358"></a><span id="l37.1358" class="difflineplus">+ * as a value).  It will also ensure that the result of a function is</span>
<a href="#l37.1359"></a><span id="l37.1359" class="difflineplus">+ * always a promise.</span>
<a href="#l37.1360"></a><span id="l37.1360" class="difflineplus">+ *</span>
<a href="#l37.1361"></a><span id="l37.1361" class="difflineplus">+ * @example</span>
<a href="#l37.1362"></a><span id="l37.1362" class="difflineplus">+ * var add = Q.promised(function (a, b) {</span>
<a href="#l37.1363"></a><span id="l37.1363" class="difflineplus">+ *     return a + b;</span>
<a href="#l37.1364"></a><span id="l37.1364" class="difflineplus">+ * });</span>
<a href="#l37.1365"></a><span id="l37.1365" class="difflineplus">+ * add(Q(a), Q(B));</span>
<a href="#l37.1366"></a><span id="l37.1366" class="difflineplus">+ *</span>
<a href="#l37.1367"></a><span id="l37.1367" class="difflineplus">+ * @param {function} callback The function to decorate</span>
<a href="#l37.1368"></a><span id="l37.1368" class="difflineplus">+ * @returns {function} a function that has been decorated.</span>
<a href="#l37.1369"></a><span id="l37.1369" class="difflineplus">+ */</span>
<a href="#l37.1370"></a><span id="l37.1370" class="difflineplus">+Q.promised = promised;</span>
<a href="#l37.1371"></a><span id="l37.1371" class="difflineplus">+function promised(callback) {</span>
<a href="#l37.1372"></a><span id="l37.1372" class="difflineplus">+    return function () {</span>
<a href="#l37.1373"></a><span id="l37.1373" class="difflineplus">+        return spread([this, all(arguments)], function (self, args) {</span>
<a href="#l37.1374"></a><span id="l37.1374" class="difflineplus">+            return callback.apply(self, args);</span>
<a href="#l37.1375"></a><span id="l37.1375" class="difflineplus">+        });</span>
<a href="#l37.1376"></a><span id="l37.1376" class="difflineplus">+    };</span>
<a href="#l37.1377"></a><span id="l37.1377" class="difflineplus">+}</span>
<a href="#l37.1378"></a><span id="l37.1378" class="difflineplus">+</span>
<a href="#l37.1379"></a><span id="l37.1379" class="difflineplus">+/**</span>
<a href="#l37.1380"></a><span id="l37.1380" class="difflineplus">+ * sends a message to a value in a future turn</span>
<a href="#l37.1381"></a><span id="l37.1381" class="difflineplus">+ * @param object* the recipient</span>
<a href="#l37.1382"></a><span id="l37.1382" class="difflineplus">+ * @param op the name of the message operation, e.g., &quot;when&quot;,</span>
<a href="#l37.1383"></a><span id="l37.1383" class="difflineplus">+ * @param args further arguments to be forwarded to the operation</span>
<a href="#l37.1384"></a><span id="l37.1384" class="difflineplus">+ * @returns result {Promise} a promise for the result of the operation</span>
<a href="#l37.1385"></a><span id="l37.1385" class="difflineplus">+ */</span>
<a href="#l37.1386"></a><span id="l37.1386" class="difflineplus">+Q.dispatch = dispatch;</span>
<a href="#l37.1387"></a><span id="l37.1387" class="difflineplus">+function dispatch(object, op, args) {</span>
<a href="#l37.1388"></a><span id="l37.1388" class="difflineplus">+    return Q(object).dispatch(op, args);</span>
<a href="#l37.1389"></a><span id="l37.1389" class="difflineplus">+}</span>
<a href="#l37.1390"></a><span id="l37.1390" class="difflineplus">+</span>
<a href="#l37.1391"></a><span id="l37.1391" class="difflineplus">+Promise.prototype.dispatch = function (op, args) {</span>
<a href="#l37.1392"></a><span id="l37.1392" class="difflineplus">+    var self = this;</span>
<a href="#l37.1393"></a><span id="l37.1393" class="difflineplus">+    var deferred = defer();</span>
<a href="#l37.1394"></a><span id="l37.1394" class="difflineplus">+    Q.nextTick(function () {</span>
<a href="#l37.1395"></a><span id="l37.1395" class="difflineplus">+        self.promiseDispatch(deferred.resolve, op, args);</span>
<a href="#l37.1396"></a><span id="l37.1396" class="difflineplus">+    });</span>
<a href="#l37.1397"></a><span id="l37.1397" class="difflineplus">+    return deferred.promise;</span>
<a href="#l37.1398"></a><span id="l37.1398" class="difflineplus">+};</span>
<a href="#l37.1399"></a><span id="l37.1399" class="difflineplus">+</span>
<a href="#l37.1400"></a><span id="l37.1400" class="difflineplus">+/**</span>
<a href="#l37.1401"></a><span id="l37.1401" class="difflineplus">+ * Gets the value of a property in a future turn.</span>
<a href="#l37.1402"></a><span id="l37.1402" class="difflineplus">+ * @param object    promise or immediate reference for target object</span>
<a href="#l37.1403"></a><span id="l37.1403" class="difflineplus">+ * @param name      name of property to get</span>
<a href="#l37.1404"></a><span id="l37.1404" class="difflineplus">+ * @return promise for the property value</span>
<a href="#l37.1405"></a><span id="l37.1405" class="difflineplus">+ */</span>
<a href="#l37.1406"></a><span id="l37.1406" class="difflineplus">+Q.get = function (object, key) {</span>
<a href="#l37.1407"></a><span id="l37.1407" class="difflineplus">+    return Q(object).dispatch(&quot;get&quot;, [key]);</span>
<a href="#l37.1408"></a><span id="l37.1408" class="difflineplus">+};</span>
<a href="#l37.1409"></a><span id="l37.1409" class="difflineplus">+</span>
<a href="#l37.1410"></a><span id="l37.1410" class="difflineplus">+Promise.prototype.get = function (key) {</span>
<a href="#l37.1411"></a><span id="l37.1411" class="difflineplus">+    return this.dispatch(&quot;get&quot;, [key]);</span>
<a href="#l37.1412"></a><span id="l37.1412" class="difflineplus">+};</span>
<a href="#l37.1413"></a><span id="l37.1413" class="difflineplus">+</span>
<a href="#l37.1414"></a><span id="l37.1414" class="difflineplus">+/**</span>
<a href="#l37.1415"></a><span id="l37.1415" class="difflineplus">+ * Sets the value of a property in a future turn.</span>
<a href="#l37.1416"></a><span id="l37.1416" class="difflineplus">+ * @param object    promise or immediate reference for object object</span>
<a href="#l37.1417"></a><span id="l37.1417" class="difflineplus">+ * @param name      name of property to set</span>
<a href="#l37.1418"></a><span id="l37.1418" class="difflineplus">+ * @param value     new value of property</span>
<a href="#l37.1419"></a><span id="l37.1419" class="difflineplus">+ * @return promise for the return value</span>
<a href="#l37.1420"></a><span id="l37.1420" class="difflineplus">+ */</span>
<a href="#l37.1421"></a><span id="l37.1421" class="difflineplus">+Q.set = function (object, key, value) {</span>
<a href="#l37.1422"></a><span id="l37.1422" class="difflineplus">+    return Q(object).dispatch(&quot;set&quot;, [key, value]);</span>
<a href="#l37.1423"></a><span id="l37.1423" class="difflineplus">+};</span>
<a href="#l37.1424"></a><span id="l37.1424" class="difflineplus">+</span>
<a href="#l37.1425"></a><span id="l37.1425" class="difflineplus">+Promise.prototype.set = function (key, value) {</span>
<a href="#l37.1426"></a><span id="l37.1426" class="difflineplus">+    return this.dispatch(&quot;set&quot;, [key, value]);</span>
<a href="#l37.1427"></a><span id="l37.1427" class="difflineplus">+};</span>
<a href="#l37.1428"></a><span id="l37.1428" class="difflineplus">+</span>
<a href="#l37.1429"></a><span id="l37.1429" class="difflineplus">+/**</span>
<a href="#l37.1430"></a><span id="l37.1430" class="difflineplus">+ * Deletes a property in a future turn.</span>
<a href="#l37.1431"></a><span id="l37.1431" class="difflineplus">+ * @param object    promise or immediate reference for target object</span>
<a href="#l37.1432"></a><span id="l37.1432" class="difflineplus">+ * @param name      name of property to delete</span>
<a href="#l37.1433"></a><span id="l37.1433" class="difflineplus">+ * @return promise for the return value</span>
<a href="#l37.1434"></a><span id="l37.1434" class="difflineplus">+ */</span>
<a href="#l37.1435"></a><span id="l37.1435" class="difflineplus">+Q.del = // XXX legacy</span>
<a href="#l37.1436"></a><span id="l37.1436" class="difflineplus">+Q[&quot;delete&quot;] = function (object, key) {</span>
<a href="#l37.1437"></a><span id="l37.1437" class="difflineplus">+    return Q(object).dispatch(&quot;delete&quot;, [key]);</span>
<a href="#l37.1438"></a><span id="l37.1438" class="difflineplus">+};</span>
<a href="#l37.1439"></a><span id="l37.1439" class="difflineplus">+</span>
<a href="#l37.1440"></a><span id="l37.1440" class="difflineplus">+Promise.prototype.del = // XXX legacy</span>
<a href="#l37.1441"></a><span id="l37.1441" class="difflineplus">+Promise.prototype[&quot;delete&quot;] = function (key) {</span>
<a href="#l37.1442"></a><span id="l37.1442" class="difflineplus">+    return this.dispatch(&quot;delete&quot;, [key]);</span>
<a href="#l37.1443"></a><span id="l37.1443" class="difflineplus">+};</span>
<a href="#l37.1444"></a><span id="l37.1444" class="difflineplus">+</span>
<a href="#l37.1445"></a><span id="l37.1445" class="difflineplus">+/**</span>
<a href="#l37.1446"></a><span id="l37.1446" class="difflineplus">+ * Invokes a method in a future turn.</span>
<a href="#l37.1447"></a><span id="l37.1447" class="difflineplus">+ * @param object    promise or immediate reference for target object</span>
<a href="#l37.1448"></a><span id="l37.1448" class="difflineplus">+ * @param name      name of method to invoke</span>
<a href="#l37.1449"></a><span id="l37.1449" class="difflineplus">+ * @param value     a value to post, typically an array of</span>
<a href="#l37.1450"></a><span id="l37.1450" class="difflineplus">+ *                  invocation arguments for promises that</span>
<a href="#l37.1451"></a><span id="l37.1451" class="difflineplus">+ *                  are ultimately backed with `resolve` values,</span>
<a href="#l37.1452"></a><span id="l37.1452" class="difflineplus">+ *                  as opposed to those backed with URLs</span>
<a href="#l37.1453"></a><span id="l37.1453" class="difflineplus">+ *                  wherein the posted value can be any</span>
<a href="#l37.1454"></a><span id="l37.1454" class="difflineplus">+ *                  JSON serializable object.</span>
<a href="#l37.1455"></a><span id="l37.1455" class="difflineplus">+ * @return promise for the return value</span>
<a href="#l37.1456"></a><span id="l37.1456" class="difflineplus">+ */</span>
<a href="#l37.1457"></a><span id="l37.1457" class="difflineplus">+// bound locally because it is used by other methods</span>
<a href="#l37.1458"></a><span id="l37.1458" class="difflineplus">+Q.mapply = // XXX As proposed by &quot;Redsandro&quot;</span>
<a href="#l37.1459"></a><span id="l37.1459" class="difflineplus">+Q.post = function (object, name, args) {</span>
<a href="#l37.1460"></a><span id="l37.1460" class="difflineplus">+    return Q(object).dispatch(&quot;post&quot;, [name, args]);</span>
<a href="#l37.1461"></a><span id="l37.1461" class="difflineplus">+};</span>
<a href="#l37.1462"></a><span id="l37.1462" class="difflineplus">+</span>
<a href="#l37.1463"></a><span id="l37.1463" class="difflineplus">+Promise.prototype.mapply = // XXX As proposed by &quot;Redsandro&quot;</span>
<a href="#l37.1464"></a><span id="l37.1464" class="difflineplus">+Promise.prototype.post = function (name, args) {</span>
<a href="#l37.1465"></a><span id="l37.1465" class="difflineplus">+    return this.dispatch(&quot;post&quot;, [name, args]);</span>
<a href="#l37.1466"></a><span id="l37.1466" class="difflineplus">+};</span>
<a href="#l37.1467"></a><span id="l37.1467" class="difflineplus">+</span>
<a href="#l37.1468"></a><span id="l37.1468" class="difflineplus">+/**</span>
<a href="#l37.1469"></a><span id="l37.1469" class="difflineplus">+ * Invokes a method in a future turn.</span>
<a href="#l37.1470"></a><span id="l37.1470" class="difflineplus">+ * @param object    promise or immediate reference for target object</span>
<a href="#l37.1471"></a><span id="l37.1471" class="difflineplus">+ * @param name      name of method to invoke</span>
<a href="#l37.1472"></a><span id="l37.1472" class="difflineplus">+ * @param ...args   array of invocation arguments</span>
<a href="#l37.1473"></a><span id="l37.1473" class="difflineplus">+ * @return promise for the return value</span>
<a href="#l37.1474"></a><span id="l37.1474" class="difflineplus">+ */</span>
<a href="#l37.1475"></a><span id="l37.1475" class="difflineplus">+Q.send = // XXX Mark Miller's proposed parlance</span>
<a href="#l37.1476"></a><span id="l37.1476" class="difflineplus">+Q.mcall = // XXX As proposed by &quot;Redsandro&quot;</span>
<a href="#l37.1477"></a><span id="l37.1477" class="difflineplus">+Q.invoke = function (object, name /*...args*/) {</span>
<a href="#l37.1478"></a><span id="l37.1478" class="difflineplus">+    return Q(object).dispatch(&quot;post&quot;, [name, array_slice(arguments, 2)]);</span>
<a href="#l37.1479"></a><span id="l37.1479" class="difflineplus">+};</span>
<a href="#l37.1480"></a><span id="l37.1480" class="difflineplus">+</span>
<a href="#l37.1481"></a><span id="l37.1481" class="difflineplus">+Promise.prototype.send = // XXX Mark Miller's proposed parlance</span>
<a href="#l37.1482"></a><span id="l37.1482" class="difflineplus">+Promise.prototype.mcall = // XXX As proposed by &quot;Redsandro&quot;</span>
<a href="#l37.1483"></a><span id="l37.1483" class="difflineplus">+Promise.prototype.invoke = function (name /*...args*/) {</span>
<a href="#l37.1484"></a><span id="l37.1484" class="difflineplus">+    return this.dispatch(&quot;post&quot;, [name, array_slice(arguments, 1)]);</span>
<a href="#l37.1485"></a><span id="l37.1485" class="difflineplus">+};</span>
<a href="#l37.1486"></a><span id="l37.1486" class="difflineplus">+</span>
<a href="#l37.1487"></a><span id="l37.1487" class="difflineplus">+/**</span>
<a href="#l37.1488"></a><span id="l37.1488" class="difflineplus">+ * Applies the promised function in a future turn.</span>
<a href="#l37.1489"></a><span id="l37.1489" class="difflineplus">+ * @param object    promise or immediate reference for target function</span>
<a href="#l37.1490"></a><span id="l37.1490" class="difflineplus">+ * @param args      array of application arguments</span>
<a href="#l37.1491"></a><span id="l37.1491" class="difflineplus">+ */</span>
<a href="#l37.1492"></a><span id="l37.1492" class="difflineplus">+Q.fapply = function (object, args) {</span>
<a href="#l37.1493"></a><span id="l37.1493" class="difflineplus">+    return Q(object).dispatch(&quot;apply&quot;, [void 0, args]);</span>
<a href="#l37.1494"></a><span id="l37.1494" class="difflineplus">+};</span>
<a href="#l37.1495"></a><span id="l37.1495" class="difflineplus">+</span>
<a href="#l37.1496"></a><span id="l37.1496" class="difflineplus">+Promise.prototype.fapply = function (args) {</span>
<a href="#l37.1497"></a><span id="l37.1497" class="difflineplus">+    return this.dispatch(&quot;apply&quot;, [void 0, args]);</span>
<a href="#l37.1498"></a><span id="l37.1498" class="difflineplus">+};</span>
<a href="#l37.1499"></a><span id="l37.1499" class="difflineplus">+</span>
<a href="#l37.1500"></a><span id="l37.1500" class="difflineplus">+/**</span>
<a href="#l37.1501"></a><span id="l37.1501" class="difflineplus">+ * Calls the promised function in a future turn.</span>
<a href="#l37.1502"></a><span id="l37.1502" class="difflineplus">+ * @param object    promise or immediate reference for target function</span>
<a href="#l37.1503"></a><span id="l37.1503" class="difflineplus">+ * @param ...args   array of application arguments</span>
<a href="#l37.1504"></a><span id="l37.1504" class="difflineplus">+ */</span>
<a href="#l37.1505"></a><span id="l37.1505" class="difflineplus">+Q[&quot;try&quot;] =</span>
<a href="#l37.1506"></a><span id="l37.1506" class="difflineplus">+Q.fcall = function (object /* ...args*/) {</span>
<a href="#l37.1507"></a><span id="l37.1507" class="difflineplus">+    return Q(object).dispatch(&quot;apply&quot;, [void 0, array_slice(arguments, 1)]);</span>
<a href="#l37.1508"></a><span id="l37.1508" class="difflineplus">+};</span>
<a href="#l37.1509"></a><span id="l37.1509" class="difflineplus">+</span>
<a href="#l37.1510"></a><span id="l37.1510" class="difflineplus">+Promise.prototype.fcall = function (/*...args*/) {</span>
<a href="#l37.1511"></a><span id="l37.1511" class="difflineplus">+    return this.dispatch(&quot;apply&quot;, [void 0, array_slice(arguments)]);</span>
<a href="#l37.1512"></a><span id="l37.1512" class="difflineplus">+};</span>
<a href="#l37.1513"></a><span id="l37.1513" class="difflineplus">+</span>
<a href="#l37.1514"></a><span id="l37.1514" class="difflineplus">+/**</span>
<a href="#l37.1515"></a><span id="l37.1515" class="difflineplus">+ * Binds the promised function, transforming return values into a fulfilled</span>
<a href="#l37.1516"></a><span id="l37.1516" class="difflineplus">+ * promise and thrown errors into a rejected one.</span>
<a href="#l37.1517"></a><span id="l37.1517" class="difflineplus">+ * @param object    promise or immediate reference for target function</span>
<a href="#l37.1518"></a><span id="l37.1518" class="difflineplus">+ * @param ...args   array of application arguments</span>
<a href="#l37.1519"></a><span id="l37.1519" class="difflineplus">+ */</span>
<a href="#l37.1520"></a><span id="l37.1520" class="difflineplus">+Q.fbind = function (object /*...args*/) {</span>
<a href="#l37.1521"></a><span id="l37.1521" class="difflineplus">+    var promise = Q(object);</span>
<a href="#l37.1522"></a><span id="l37.1522" class="difflineplus">+    var args = array_slice(arguments, 1);</span>
<a href="#l37.1523"></a><span id="l37.1523" class="difflineplus">+    return function fbound() {</span>
<a href="#l37.1524"></a><span id="l37.1524" class="difflineplus">+        return promise.dispatch(&quot;apply&quot;, [</span>
<a href="#l37.1525"></a><span id="l37.1525" class="difflineplus">+            this,</span>
<a href="#l37.1526"></a><span id="l37.1526" class="difflineplus">+            args.concat(array_slice(arguments))</span>
<a href="#l37.1527"></a><span id="l37.1527" class="difflineplus">+        ]);</span>
<a href="#l37.1528"></a><span id="l37.1528" class="difflineplus">+    };</span>
<a href="#l37.1529"></a><span id="l37.1529" class="difflineplus">+};</span>
<a href="#l37.1530"></a><span id="l37.1530" class="difflineplus">+Promise.prototype.fbind = function (/*...args*/) {</span>
<a href="#l37.1531"></a><span id="l37.1531" class="difflineplus">+    var promise = this;</span>
<a href="#l37.1532"></a><span id="l37.1532" class="difflineplus">+    var args = array_slice(arguments);</span>
<a href="#l37.1533"></a><span id="l37.1533" class="difflineplus">+    return function fbound() {</span>
<a href="#l37.1534"></a><span id="l37.1534" class="difflineplus">+        return promise.dispatch(&quot;apply&quot;, [</span>
<a href="#l37.1535"></a><span id="l37.1535" class="difflineplus">+            this,</span>
<a href="#l37.1536"></a><span id="l37.1536" class="difflineplus">+            args.concat(array_slice(arguments))</span>
<a href="#l37.1537"></a><span id="l37.1537" class="difflineplus">+        ]);</span>
<a href="#l37.1538"></a><span id="l37.1538" class="difflineplus">+    };</span>
<a href="#l37.1539"></a><span id="l37.1539" class="difflineplus">+};</span>
<a href="#l37.1540"></a><span id="l37.1540" class="difflineplus">+</span>
<a href="#l37.1541"></a><span id="l37.1541" class="difflineplus">+/**</span>
<a href="#l37.1542"></a><span id="l37.1542" class="difflineplus">+ * Requests the names of the owned properties of a promised</span>
<a href="#l37.1543"></a><span id="l37.1543" class="difflineplus">+ * object in a future turn.</span>
<a href="#l37.1544"></a><span id="l37.1544" class="difflineplus">+ * @param object    promise or immediate reference for target object</span>
<a href="#l37.1545"></a><span id="l37.1545" class="difflineplus">+ * @return promise for the keys of the eventually settled object</span>
<a href="#l37.1546"></a><span id="l37.1546" class="difflineplus">+ */</span>
<a href="#l37.1547"></a><span id="l37.1547" class="difflineplus">+Q.keys = function (object) {</span>
<a href="#l37.1548"></a><span id="l37.1548" class="difflineplus">+    return Q(object).dispatch(&quot;keys&quot;, []);</span>
<a href="#l37.1549"></a><span id="l37.1549" class="difflineplus">+};</span>
<a href="#l37.1550"></a><span id="l37.1550" class="difflineplus">+</span>
<a href="#l37.1551"></a><span id="l37.1551" class="difflineplus">+Promise.prototype.keys = function () {</span>
<a href="#l37.1552"></a><span id="l37.1552" class="difflineplus">+    return this.dispatch(&quot;keys&quot;, []);</span>
<a href="#l37.1553"></a><span id="l37.1553" class="difflineplus">+};</span>
<a href="#l37.1554"></a><span id="l37.1554" class="difflineplus">+</span>
<a href="#l37.1555"></a><span id="l37.1555" class="difflineplus">+/**</span>
<a href="#l37.1556"></a><span id="l37.1556" class="difflineplus">+ * Turns an array of promises into a promise for an array.  If any of</span>
<a href="#l37.1557"></a><span id="l37.1557" class="difflineplus">+ * the promises gets rejected, the whole array is rejected immediately.</span>
<a href="#l37.1558"></a><span id="l37.1558" class="difflineplus">+ * @param {Array*} an array (or promise for an array) of values (or</span>
<a href="#l37.1559"></a><span id="l37.1559" class="difflineplus">+ * promises for values)</span>
<a href="#l37.1560"></a><span id="l37.1560" class="difflineplus">+ * @returns a promise for an array of the corresponding values</span>
<a href="#l37.1561"></a><span id="l37.1561" class="difflineplus">+ */</span>
<a href="#l37.1562"></a><span id="l37.1562" class="difflineplus">+// By Mark Miller</span>
<a href="#l37.1563"></a><span id="l37.1563" class="difflineplus">+// http://wiki.ecmascript.org/doku.php?id=strawman:concurrency&amp;rev=1308776521#allfulfilled</span>
<a href="#l37.1564"></a><span id="l37.1564" class="difflineplus">+Q.all = all;</span>
<a href="#l37.1565"></a><span id="l37.1565" class="difflineplus">+function all(promises) {</span>
<a href="#l37.1566"></a><span id="l37.1566" class="difflineplus">+    return when(promises, function (promises) {</span>
<a href="#l37.1567"></a><span id="l37.1567" class="difflineplus">+        var pendingCount = 0;</span>
<a href="#l37.1568"></a><span id="l37.1568" class="difflineplus">+        var deferred = defer();</span>
<a href="#l37.1569"></a><span id="l37.1569" class="difflineplus">+        array_reduce(promises, function (undefined, promise, index) {</span>
<a href="#l37.1570"></a><span id="l37.1570" class="difflineplus">+            var snapshot;</span>
<a href="#l37.1571"></a><span id="l37.1571" class="difflineplus">+            if (</span>
<a href="#l37.1572"></a><span id="l37.1572" class="difflineplus">+                isPromise(promise) &amp;&amp;</span>
<a href="#l37.1573"></a><span id="l37.1573" class="difflineplus">+                (snapshot = promise.inspect()).state === &quot;fulfilled&quot;</span>
<a href="#l37.1574"></a><span id="l37.1574" class="difflineplus">+            ) {</span>
<a href="#l37.1575"></a><span id="l37.1575" class="difflineplus">+                promises[index] = snapshot.value;</span>
<a href="#l37.1576"></a><span id="l37.1576" class="difflineplus">+            } else {</span>
<a href="#l37.1577"></a><span id="l37.1577" class="difflineplus">+                ++pendingCount;</span>
<a href="#l37.1578"></a><span id="l37.1578" class="difflineplus">+                when(</span>
<a href="#l37.1579"></a><span id="l37.1579" class="difflineplus">+                    promise,</span>
<a href="#l37.1580"></a><span id="l37.1580" class="difflineplus">+                    function (value) {</span>
<a href="#l37.1581"></a><span id="l37.1581" class="difflineplus">+                        promises[index] = value;</span>
<a href="#l37.1582"></a><span id="l37.1582" class="difflineplus">+                        if (--pendingCount === 0) {</span>
<a href="#l37.1583"></a><span id="l37.1583" class="difflineplus">+                            deferred.resolve(promises);</span>
<a href="#l37.1584"></a><span id="l37.1584" class="difflineplus">+                        }</span>
<a href="#l37.1585"></a><span id="l37.1585" class="difflineplus">+                    },</span>
<a href="#l37.1586"></a><span id="l37.1586" class="difflineplus">+                    deferred.reject,</span>
<a href="#l37.1587"></a><span id="l37.1587" class="difflineplus">+                    function (progress) {</span>
<a href="#l37.1588"></a><span id="l37.1588" class="difflineplus">+                        deferred.notify({ index: index, value: progress });</span>
<a href="#l37.1589"></a><span id="l37.1589" class="difflineplus">+                    }</span>
<a href="#l37.1590"></a><span id="l37.1590" class="difflineplus">+                );</span>
<a href="#l37.1591"></a><span id="l37.1591" class="difflineplus">+            }</span>
<a href="#l37.1592"></a><span id="l37.1592" class="difflineplus">+        }, void 0);</span>
<a href="#l37.1593"></a><span id="l37.1593" class="difflineplus">+        if (pendingCount === 0) {</span>
<a href="#l37.1594"></a><span id="l37.1594" class="difflineplus">+            deferred.resolve(promises);</span>
<a href="#l37.1595"></a><span id="l37.1595" class="difflineplus">+        }</span>
<a href="#l37.1596"></a><span id="l37.1596" class="difflineplus">+        return deferred.promise;</span>
<a href="#l37.1597"></a><span id="l37.1597" class="difflineplus">+    });</span>
<a href="#l37.1598"></a><span id="l37.1598" class="difflineplus">+}</span>
<a href="#l37.1599"></a><span id="l37.1599" class="difflineplus">+</span>
<a href="#l37.1600"></a><span id="l37.1600" class="difflineplus">+Promise.prototype.all = function () {</span>
<a href="#l37.1601"></a><span id="l37.1601" class="difflineplus">+    return all(this);</span>
<a href="#l37.1602"></a><span id="l37.1602" class="difflineplus">+};</span>
<a href="#l37.1603"></a><span id="l37.1603" class="difflineplus">+</span>
<a href="#l37.1604"></a><span id="l37.1604" class="difflineplus">+/**</span>
<a href="#l37.1605"></a><span id="l37.1605" class="difflineplus">+ * Returns the first resolved promise of an array. Prior rejected promises are</span>
<a href="#l37.1606"></a><span id="l37.1606" class="difflineplus">+ * ignored.  Rejects only if all promises are rejected.</span>
<a href="#l37.1607"></a><span id="l37.1607" class="difflineplus">+ * @param {Array*} an array containing values or promises for values</span>
<a href="#l37.1608"></a><span id="l37.1608" class="difflineplus">+ * @returns a promise fulfilled with the value of the first resolved promise,</span>
<a href="#l37.1609"></a><span id="l37.1609" class="difflineplus">+ * or a rejected promise if all promises are rejected.</span>
<a href="#l37.1610"></a><span id="l37.1610" class="difflineplus">+ */</span>
<a href="#l37.1611"></a><span id="l37.1611" class="difflineplus">+Q.any = any;</span>
<a href="#l37.1612"></a><span id="l37.1612" class="difflineplus">+</span>
<a href="#l37.1613"></a><span id="l37.1613" class="difflineplus">+function any(promises) {</span>
<a href="#l37.1614"></a><span id="l37.1614" class="difflineplus">+    if (promises.length === 0) {</span>
<a href="#l37.1615"></a><span id="l37.1615" class="difflineplus">+        return Q.resolve();</span>
<a href="#l37.1616"></a><span id="l37.1616" class="difflineplus">+    }</span>
<a href="#l37.1617"></a><span id="l37.1617" class="difflineplus">+</span>
<a href="#l37.1618"></a><span id="l37.1618" class="difflineplus">+    var deferred = Q.defer();</span>
<a href="#l37.1619"></a><span id="l37.1619" class="difflineplus">+    var pendingCount = 0;</span>
<a href="#l37.1620"></a><span id="l37.1620" class="difflineplus">+    array_reduce(promises, function (prev, current, index) {</span>
<a href="#l37.1621"></a><span id="l37.1621" class="difflineplus">+        var promise = promises[index];</span>
<a href="#l37.1622"></a><span id="l37.1622" class="difflineplus">+</span>
<a href="#l37.1623"></a><span id="l37.1623" class="difflineplus">+        pendingCount++;</span>
<a href="#l37.1624"></a><span id="l37.1624" class="difflineplus">+</span>
<a href="#l37.1625"></a><span id="l37.1625" class="difflineplus">+        when(promise, onFulfilled, onRejected, onProgress);</span>
<a href="#l37.1626"></a><span id="l37.1626" class="difflineplus">+        function onFulfilled(result) {</span>
<a href="#l37.1627"></a><span id="l37.1627" class="difflineplus">+            deferred.resolve(result);</span>
<a href="#l37.1628"></a><span id="l37.1628" class="difflineplus">+        }</span>
<a href="#l37.1629"></a><span id="l37.1629" class="difflineplus">+        function onRejected() {</span>
<a href="#l37.1630"></a><span id="l37.1630" class="difflineplus">+            pendingCount--;</span>
<a href="#l37.1631"></a><span id="l37.1631" class="difflineplus">+            if (pendingCount === 0) {</span>
<a href="#l37.1632"></a><span id="l37.1632" class="difflineplus">+                deferred.reject(new Error(</span>
<a href="#l37.1633"></a><span id="l37.1633" class="difflineplus">+                    &quot;Can't get fulfillment value from any promise, all &quot; +</span>
<a href="#l37.1634"></a><span id="l37.1634" class="difflineplus">+                    &quot;promises were rejected.&quot;</span>
<a href="#l37.1635"></a><span id="l37.1635" class="difflineplus">+                ));</span>
<a href="#l37.1636"></a><span id="l37.1636" class="difflineplus">+            }</span>
<a href="#l37.1637"></a><span id="l37.1637" class="difflineplus">+        }</span>
<a href="#l37.1638"></a><span id="l37.1638" class="difflineplus">+        function onProgress(progress) {</span>
<a href="#l37.1639"></a><span id="l37.1639" class="difflineplus">+            deferred.notify({</span>
<a href="#l37.1640"></a><span id="l37.1640" class="difflineplus">+                index: index,</span>
<a href="#l37.1641"></a><span id="l37.1641" class="difflineplus">+                value: progress</span>
<a href="#l37.1642"></a><span id="l37.1642" class="difflineplus">+            });</span>
<a href="#l37.1643"></a><span id="l37.1643" class="difflineplus">+        }</span>
<a href="#l37.1644"></a><span id="l37.1644" class="difflineplus">+    }, undefined);</span>
<a href="#l37.1645"></a><span id="l37.1645" class="difflineplus">+</span>
<a href="#l37.1646"></a><span id="l37.1646" class="difflineplus">+    return deferred.promise;</span>
<a href="#l37.1647"></a><span id="l37.1647" class="difflineplus">+}</span>
<a href="#l37.1648"></a><span id="l37.1648" class="difflineplus">+</span>
<a href="#l37.1649"></a><span id="l37.1649" class="difflineplus">+Promise.prototype.any = function () {</span>
<a href="#l37.1650"></a><span id="l37.1650" class="difflineplus">+    return any(this);</span>
<a href="#l37.1651"></a><span id="l37.1651" class="difflineplus">+};</span>
<a href="#l37.1652"></a><span id="l37.1652" class="difflineplus">+</span>
<a href="#l37.1653"></a><span id="l37.1653" class="difflineplus">+/**</span>
<a href="#l37.1654"></a><span id="l37.1654" class="difflineplus">+ * Waits for all promises to be settled, either fulfilled or</span>
<a href="#l37.1655"></a><span id="l37.1655" class="difflineplus">+ * rejected.  This is distinct from `all` since that would stop</span>
<a href="#l37.1656"></a><span id="l37.1656" class="difflineplus">+ * waiting at the first rejection.  The promise returned by</span>
<a href="#l37.1657"></a><span id="l37.1657" class="difflineplus">+ * `allResolved` will never be rejected.</span>
<a href="#l37.1658"></a><span id="l37.1658" class="difflineplus">+ * @param promises a promise for an array (or an array) of promises</span>
<a href="#l37.1659"></a><span id="l37.1659" class="difflineplus">+ * (or values)</span>
<a href="#l37.1660"></a><span id="l37.1660" class="difflineplus">+ * @return a promise for an array of promises</span>
<a href="#l37.1661"></a><span id="l37.1661" class="difflineplus">+ */</span>
<a href="#l37.1662"></a><span id="l37.1662" class="difflineplus">+Q.allResolved = deprecate(allResolved, &quot;allResolved&quot;, &quot;allSettled&quot;);</span>
<a href="#l37.1663"></a><span id="l37.1663" class="difflineplus">+function allResolved(promises) {</span>
<a href="#l37.1664"></a><span id="l37.1664" class="difflineplus">+    return when(promises, function (promises) {</span>
<a href="#l37.1665"></a><span id="l37.1665" class="difflineplus">+        promises = array_map(promises, Q);</span>
<a href="#l37.1666"></a><span id="l37.1666" class="difflineplus">+        return when(all(array_map(promises, function (promise) {</span>
<a href="#l37.1667"></a><span id="l37.1667" class="difflineplus">+            return when(promise, noop, noop);</span>
<a href="#l37.1668"></a><span id="l37.1668" class="difflineplus">+        })), function () {</span>
<a href="#l37.1669"></a><span id="l37.1669" class="difflineplus">+            return promises;</span>
<a href="#l37.1670"></a><span id="l37.1670" class="difflineplus">+        });</span>
<a href="#l37.1671"></a><span id="l37.1671" class="difflineplus">+    });</span>
<a href="#l37.1672"></a><span id="l37.1672" class="difflineplus">+}</span>
<a href="#l37.1673"></a><span id="l37.1673" class="difflineplus">+</span>
<a href="#l37.1674"></a><span id="l37.1674" class="difflineplus">+Promise.prototype.allResolved = function () {</span>
<a href="#l37.1675"></a><span id="l37.1675" class="difflineplus">+    return allResolved(this);</span>
<a href="#l37.1676"></a><span id="l37.1676" class="difflineplus">+};</span>
<a href="#l37.1677"></a><span id="l37.1677" class="difflineplus">+</span>
<a href="#l37.1678"></a><span id="l37.1678" class="difflineplus">+/**</span>
<a href="#l37.1679"></a><span id="l37.1679" class="difflineplus">+ * @see Promise#allSettled</span>
<a href="#l37.1680"></a><span id="l37.1680" class="difflineplus">+ */</span>
<a href="#l37.1681"></a><span id="l37.1681" class="difflineplus">+Q.allSettled = allSettled;</span>
<a href="#l37.1682"></a><span id="l37.1682" class="difflineplus">+function allSettled(promises) {</span>
<a href="#l37.1683"></a><span id="l37.1683" class="difflineplus">+    return Q(promises).allSettled();</span>
<a href="#l37.1684"></a><span id="l37.1684" class="difflineplus">+}</span>
<a href="#l37.1685"></a><span id="l37.1685" class="difflineplus">+</span>
<a href="#l37.1686"></a><span id="l37.1686" class="difflineplus">+/**</span>
<a href="#l37.1687"></a><span id="l37.1687" class="difflineplus">+ * Turns an array of promises into a promise for an array of their states (as</span>
<a href="#l37.1688"></a><span id="l37.1688" class="difflineplus">+ * returned by `inspect`) when they have all settled.</span>
<a href="#l37.1689"></a><span id="l37.1689" class="difflineplus">+ * @param {Array[Any*]} values an array (or promise for an array) of values (or</span>
<a href="#l37.1690"></a><span id="l37.1690" class="difflineplus">+ * promises for values)</span>
<a href="#l37.1691"></a><span id="l37.1691" class="difflineplus">+ * @returns {Array[State]} an array of states for the respective values.</span>
<a href="#l37.1692"></a><span id="l37.1692" class="difflineplus">+ */</span>
<a href="#l37.1693"></a><span id="l37.1693" class="difflineplus">+Promise.prototype.allSettled = function () {</span>
<a href="#l37.1694"></a><span id="l37.1694" class="difflineplus">+    return this.then(function (promises) {</span>
<a href="#l37.1695"></a><span id="l37.1695" class="difflineplus">+        return all(array_map(promises, function (promise) {</span>
<a href="#l37.1696"></a><span id="l37.1696" class="difflineplus">+            promise = Q(promise);</span>
<a href="#l37.1697"></a><span id="l37.1697" class="difflineplus">+            function regardless() {</span>
<a href="#l37.1698"></a><span id="l37.1698" class="difflineplus">+                return promise.inspect();</span>
<a href="#l37.1699"></a><span id="l37.1699" class="difflineplus">+            }</span>
<a href="#l37.1700"></a><span id="l37.1700" class="difflineplus">+            return promise.then(regardless, regardless);</span>
<a href="#l37.1701"></a><span id="l37.1701" class="difflineplus">+        }));</span>
<a href="#l37.1702"></a><span id="l37.1702" class="difflineplus">+    });</span>
<a href="#l37.1703"></a><span id="l37.1703" class="difflineplus">+};</span>
<a href="#l37.1704"></a><span id="l37.1704" class="difflineplus">+</span>
<a href="#l37.1705"></a><span id="l37.1705" class="difflineplus">+/**</span>
<a href="#l37.1706"></a><span id="l37.1706" class="difflineplus">+ * Captures the failure of a promise, giving an oportunity to recover</span>
<a href="#l37.1707"></a><span id="l37.1707" class="difflineplus">+ * with a callback.  If the given promise is fulfilled, the returned</span>
<a href="#l37.1708"></a><span id="l37.1708" class="difflineplus">+ * promise is fulfilled.</span>
<a href="#l37.1709"></a><span id="l37.1709" class="difflineplus">+ * @param {Any*} promise for something</span>
<a href="#l37.1710"></a><span id="l37.1710" class="difflineplus">+ * @param {Function} callback to fulfill the returned promise if the</span>
<a href="#l37.1711"></a><span id="l37.1711" class="difflineplus">+ * given promise is rejected</span>
<a href="#l37.1712"></a><span id="l37.1712" class="difflineplus">+ * @returns a promise for the return value of the callback</span>
<a href="#l37.1713"></a><span id="l37.1713" class="difflineplus">+ */</span>
<a href="#l37.1714"></a><span id="l37.1714" class="difflineplus">+Q.fail = // XXX legacy</span>
<a href="#l37.1715"></a><span id="l37.1715" class="difflineplus">+Q[&quot;catch&quot;] = function (object, rejected) {</span>
<a href="#l37.1716"></a><span id="l37.1716" class="difflineplus">+    return Q(object).then(void 0, rejected);</span>
<a href="#l37.1717"></a><span id="l37.1717" class="difflineplus">+};</span>
<a href="#l37.1718"></a><span id="l37.1718" class="difflineplus">+</span>
<a href="#l37.1719"></a><span id="l37.1719" class="difflineplus">+Promise.prototype.fail = // XXX legacy</span>
<a href="#l37.1720"></a><span id="l37.1720" class="difflineplus">+Promise.prototype[&quot;catch&quot;] = function (rejected) {</span>
<a href="#l37.1721"></a><span id="l37.1721" class="difflineplus">+    return this.then(void 0, rejected);</span>
<a href="#l37.1722"></a><span id="l37.1722" class="difflineplus">+};</span>
<a href="#l37.1723"></a><span id="l37.1723" class="difflineplus">+</span>
<a href="#l37.1724"></a><span id="l37.1724" class="difflineplus">+/**</span>
<a href="#l37.1725"></a><span id="l37.1725" class="difflineplus">+ * Attaches a listener that can respond to progress notifications from a</span>
<a href="#l37.1726"></a><span id="l37.1726" class="difflineplus">+ * promise's originating deferred. This listener receives the exact arguments</span>
<a href="#l37.1727"></a><span id="l37.1727" class="difflineplus">+ * passed to ``deferred.notify``.</span>
<a href="#l37.1728"></a><span id="l37.1728" class="difflineplus">+ * @param {Any*} promise for something</span>
<a href="#l37.1729"></a><span id="l37.1729" class="difflineplus">+ * @param {Function} callback to receive any progress notifications</span>
<a href="#l37.1730"></a><span id="l37.1730" class="difflineplus">+ * @returns the given promise, unchanged</span>
<a href="#l37.1731"></a><span id="l37.1731" class="difflineplus">+ */</span>
<a href="#l37.1732"></a><span id="l37.1732" class="difflineplus">+Q.progress = progress;</span>
<a href="#l37.1733"></a><span id="l37.1733" class="difflineplus">+function progress(object, progressed) {</span>
<a href="#l37.1734"></a><span id="l37.1734" class="difflineplus">+    return Q(object).then(void 0, void 0, progressed);</span>
<a href="#l37.1735"></a><span id="l37.1735" class="difflineplus">+}</span>
<a href="#l37.1736"></a><span id="l37.1736" class="difflineplus">+</span>
<a href="#l37.1737"></a><span id="l37.1737" class="difflineplus">+Promise.prototype.progress = function (progressed) {</span>
<a href="#l37.1738"></a><span id="l37.1738" class="difflineplus">+    return this.then(void 0, void 0, progressed);</span>
<a href="#l37.1739"></a><span id="l37.1739" class="difflineplus">+};</span>
<a href="#l37.1740"></a><span id="l37.1740" class="difflineplus">+</span>
<a href="#l37.1741"></a><span id="l37.1741" class="difflineplus">+/**</span>
<a href="#l37.1742"></a><span id="l37.1742" class="difflineplus">+ * Provides an opportunity to observe the settling of a promise,</span>
<a href="#l37.1743"></a><span id="l37.1743" class="difflineplus">+ * regardless of whether the promise is fulfilled or rejected.  Forwards</span>
<a href="#l37.1744"></a><span id="l37.1744" class="difflineplus">+ * the resolution to the returned promise when the callback is done.</span>
<a href="#l37.1745"></a><span id="l37.1745" class="difflineplus">+ * The callback can return a promise to defer completion.</span>
<a href="#l37.1746"></a><span id="l37.1746" class="difflineplus">+ * @param {Any*} promise</span>
<a href="#l37.1747"></a><span id="l37.1747" class="difflineplus">+ * @param {Function} callback to observe the resolution of the given</span>
<a href="#l37.1748"></a><span id="l37.1748" class="difflineplus">+ * promise, takes no arguments.</span>
<a href="#l37.1749"></a><span id="l37.1749" class="difflineplus">+ * @returns a promise for the resolution of the given promise when</span>
<a href="#l37.1750"></a><span id="l37.1750" class="difflineplus">+ * ``fin`` is done.</span>
<a href="#l37.1751"></a><span id="l37.1751" class="difflineplus">+ */</span>
<a href="#l37.1752"></a><span id="l37.1752" class="difflineplus">+Q.fin = // XXX legacy</span>
<a href="#l37.1753"></a><span id="l37.1753" class="difflineplus">+Q[&quot;finally&quot;] = function (object, callback) {</span>
<a href="#l37.1754"></a><span id="l37.1754" class="difflineplus">+    return Q(object)[&quot;finally&quot;](callback);</span>
<a href="#l37.1755"></a><span id="l37.1755" class="difflineplus">+};</span>
<a href="#l37.1756"></a><span id="l37.1756" class="difflineplus">+</span>
<a href="#l37.1757"></a><span id="l37.1757" class="difflineplus">+Promise.prototype.fin = // XXX legacy</span>
<a href="#l37.1758"></a><span id="l37.1758" class="difflineplus">+Promise.prototype[&quot;finally&quot;] = function (callback) {</span>
<a href="#l37.1759"></a><span id="l37.1759" class="difflineplus">+    callback = Q(callback);</span>
<a href="#l37.1760"></a><span id="l37.1760" class="difflineplus">+    return this.then(function (value) {</span>
<a href="#l37.1761"></a><span id="l37.1761" class="difflineplus">+        return callback.fcall().then(function () {</span>
<a href="#l37.1762"></a><span id="l37.1762" class="difflineplus">+            return value;</span>
<a href="#l37.1763"></a><span id="l37.1763" class="difflineplus">+        });</span>
<a href="#l37.1764"></a><span id="l37.1764" class="difflineplus">+    }, function (reason) {</span>
<a href="#l37.1765"></a><span id="l37.1765" class="difflineplus">+        // TODO attempt to recycle the rejection with &quot;this&quot;.</span>
<a href="#l37.1766"></a><span id="l37.1766" class="difflineplus">+        return callback.fcall().then(function () {</span>
<a href="#l37.1767"></a><span id="l37.1767" class="difflineplus">+            throw reason;</span>
<a href="#l37.1768"></a><span id="l37.1768" class="difflineplus">+        });</span>
<a href="#l37.1769"></a><span id="l37.1769" class="difflineplus">+    });</span>
<a href="#l37.1770"></a><span id="l37.1770" class="difflineplus">+};</span>
<a href="#l37.1771"></a><span id="l37.1771" class="difflineplus">+</span>
<a href="#l37.1772"></a><span id="l37.1772" class="difflineplus">+/**</span>
<a href="#l37.1773"></a><span id="l37.1773" class="difflineplus">+ * Terminates a chain of promises, forcing rejections to be</span>
<a href="#l37.1774"></a><span id="l37.1774" class="difflineplus">+ * thrown as exceptions.</span>
<a href="#l37.1775"></a><span id="l37.1775" class="difflineplus">+ * @param {Any*} promise at the end of a chain of promises</span>
<a href="#l37.1776"></a><span id="l37.1776" class="difflineplus">+ * @returns nothing</span>
<a href="#l37.1777"></a><span id="l37.1777" class="difflineplus">+ */</span>
<a href="#l37.1778"></a><span id="l37.1778" class="difflineplus">+Q.done = function (object, fulfilled, rejected, progress) {</span>
<a href="#l37.1779"></a><span id="l37.1779" class="difflineplus">+    return Q(object).done(fulfilled, rejected, progress);</span>
<a href="#l37.1780"></a><span id="l37.1780" class="difflineplus">+};</span>
<a href="#l37.1781"></a><span id="l37.1781" class="difflineplus">+</span>
<a href="#l37.1782"></a><span id="l37.1782" class="difflineplus">+Promise.prototype.done = function (fulfilled, rejected, progress) {</span>
<a href="#l37.1783"></a><span id="l37.1783" class="difflineplus">+    var onUnhandledError = function (error) {</span>
<a href="#l37.1784"></a><span id="l37.1784" class="difflineplus">+        // forward to a future turn so that ``when``</span>
<a href="#l37.1785"></a><span id="l37.1785" class="difflineplus">+        // does not catch it and turn it into a rejection.</span>
<a href="#l37.1786"></a><span id="l37.1786" class="difflineplus">+        Q.nextTick(function () {</span>
<a href="#l37.1787"></a><span id="l37.1787" class="difflineplus">+            makeStackTraceLong(error, promise);</span>
<a href="#l37.1788"></a><span id="l37.1788" class="difflineplus">+            if (Q.onerror) {</span>
<a href="#l37.1789"></a><span id="l37.1789" class="difflineplus">+                Q.onerror(error);</span>
<a href="#l37.1790"></a><span id="l37.1790" class="difflineplus">+            } else {</span>
<a href="#l37.1791"></a><span id="l37.1791" class="difflineplus">+                throw error;</span>
<a href="#l37.1792"></a><span id="l37.1792" class="difflineplus">+            }</span>
<a href="#l37.1793"></a><span id="l37.1793" class="difflineplus">+        });</span>
<a href="#l37.1794"></a><span id="l37.1794" class="difflineplus">+    };</span>
<a href="#l37.1795"></a><span id="l37.1795" class="difflineplus">+</span>
<a href="#l37.1796"></a><span id="l37.1796" class="difflineplus">+    // Avoid unnecessary `nextTick`ing via an unnecessary `when`.</span>
<a href="#l37.1797"></a><span id="l37.1797" class="difflineplus">+    var promise = fulfilled || rejected || progress ?</span>
<a href="#l37.1798"></a><span id="l37.1798" class="difflineplus">+        this.then(fulfilled, rejected, progress) :</span>
<a href="#l37.1799"></a><span id="l37.1799" class="difflineplus">+        this;</span>
<a href="#l37.1800"></a><span id="l37.1800" class="difflineplus">+</span>
<a href="#l37.1801"></a><span id="l37.1801" class="difflineplus">+    if (typeof process === &quot;object&quot; &amp;&amp; process &amp;&amp; process.domain) {</span>
<a href="#l37.1802"></a><span id="l37.1802" class="difflineplus">+        onUnhandledError = process.domain.bind(onUnhandledError);</span>
<a href="#l37.1803"></a><span id="l37.1803" class="difflineplus">+    }</span>
<a href="#l37.1804"></a><span id="l37.1804" class="difflineplus">+</span>
<a href="#l37.1805"></a><span id="l37.1805" class="difflineplus">+    promise.then(void 0, onUnhandledError);</span>
<a href="#l37.1806"></a><span id="l37.1806" class="difflineplus">+};</span>
<a href="#l37.1807"></a><span id="l37.1807" class="difflineplus">+</span>
<a href="#l37.1808"></a><span id="l37.1808" class="difflineplus">+/**</span>
<a href="#l37.1809"></a><span id="l37.1809" class="difflineplus">+ * Causes a promise to be rejected if it does not get fulfilled before</span>
<a href="#l37.1810"></a><span id="l37.1810" class="difflineplus">+ * some milliseconds time out.</span>
<a href="#l37.1811"></a><span id="l37.1811" class="difflineplus">+ * @param {Any*} promise</span>
<a href="#l37.1812"></a><span id="l37.1812" class="difflineplus">+ * @param {Number} milliseconds timeout</span>
<a href="#l37.1813"></a><span id="l37.1813" class="difflineplus">+ * @param {Any*} custom error message or Error object (optional)</span>
<a href="#l37.1814"></a><span id="l37.1814" class="difflineplus">+ * @returns a promise for the resolution of the given promise if it is</span>
<a href="#l37.1815"></a><span id="l37.1815" class="difflineplus">+ * fulfilled before the timeout, otherwise rejected.</span>
<a href="#l37.1816"></a><span id="l37.1816" class="difflineplus">+ */</span>
<a href="#l37.1817"></a><span id="l37.1817" class="difflineplus">+Q.timeout = function (object, ms, error) {</span>
<a href="#l37.1818"></a><span id="l37.1818" class="difflineplus">+    return Q(object).timeout(ms, error);</span>
<a href="#l37.1819"></a><span id="l37.1819" class="difflineplus">+};</span>
<a href="#l37.1820"></a><span id="l37.1820" class="difflineplus">+</span>
<a href="#l37.1821"></a><span id="l37.1821" class="difflineplus">+Promise.prototype.timeout = function (ms, error) {</span>
<a href="#l37.1822"></a><span id="l37.1822" class="difflineplus">+    var deferred = defer();</span>
<a href="#l37.1823"></a><span id="l37.1823" class="difflineplus">+    var timeoutId = setTimeout(function () {</span>
<a href="#l37.1824"></a><span id="l37.1824" class="difflineplus">+        if (!error || &quot;string&quot; === typeof error) {</span>
<a href="#l37.1825"></a><span id="l37.1825" class="difflineplus">+            error = new Error(error || &quot;Timed out after &quot; + ms + &quot; ms&quot;);</span>
<a href="#l37.1826"></a><span id="l37.1826" class="difflineplus">+            error.code = &quot;ETIMEDOUT&quot;;</span>
<a href="#l37.1827"></a><span id="l37.1827" class="difflineplus">+        }</span>
<a href="#l37.1828"></a><span id="l37.1828" class="difflineplus">+        deferred.reject(error);</span>
<a href="#l37.1829"></a><span id="l37.1829" class="difflineplus">+    }, ms);</span>
<a href="#l37.1830"></a><span id="l37.1830" class="difflineplus">+</span>
<a href="#l37.1831"></a><span id="l37.1831" class="difflineplus">+    this.then(function (value) {</span>
<a href="#l37.1832"></a><span id="l37.1832" class="difflineplus">+        clearTimeout(timeoutId);</span>
<a href="#l37.1833"></a><span id="l37.1833" class="difflineplus">+        deferred.resolve(value);</span>
<a href="#l37.1834"></a><span id="l37.1834" class="difflineplus">+    }, function (exception) {</span>
<a href="#l37.1835"></a><span id="l37.1835" class="difflineplus">+        clearTimeout(timeoutId);</span>
<a href="#l37.1836"></a><span id="l37.1836" class="difflineplus">+        deferred.reject(exception);</span>
<a href="#l37.1837"></a><span id="l37.1837" class="difflineplus">+    }, deferred.notify);</span>
<a href="#l37.1838"></a><span id="l37.1838" class="difflineplus">+</span>
<a href="#l37.1839"></a><span id="l37.1839" class="difflineplus">+    return deferred.promise;</span>
<a href="#l37.1840"></a><span id="l37.1840" class="difflineplus">+};</span>
<a href="#l37.1841"></a><span id="l37.1841" class="difflineplus">+</span>
<a href="#l37.1842"></a><span id="l37.1842" class="difflineplus">+/**</span>
<a href="#l37.1843"></a><span id="l37.1843" class="difflineplus">+ * Returns a promise for the given value (or promised value), some</span>
<a href="#l37.1844"></a><span id="l37.1844" class="difflineplus">+ * milliseconds after it resolved. Passes rejections immediately.</span>
<a href="#l37.1845"></a><span id="l37.1845" class="difflineplus">+ * @param {Any*} promise</span>
<a href="#l37.1846"></a><span id="l37.1846" class="difflineplus">+ * @param {Number} milliseconds</span>
<a href="#l37.1847"></a><span id="l37.1847" class="difflineplus">+ * @returns a promise for the resolution of the given promise after milliseconds</span>
<a href="#l37.1848"></a><span id="l37.1848" class="difflineplus">+ * time has elapsed since the resolution of the given promise.</span>
<a href="#l37.1849"></a><span id="l37.1849" class="difflineplus">+ * If the given promise rejects, that is passed immediately.</span>
<a href="#l37.1850"></a><span id="l37.1850" class="difflineplus">+ */</span>
<a href="#l37.1851"></a><span id="l37.1851" class="difflineplus">+Q.delay = function (object, timeout) {</span>
<a href="#l37.1852"></a><span id="l37.1852" class="difflineplus">+    if (timeout === void 0) {</span>
<a href="#l37.1853"></a><span id="l37.1853" class="difflineplus">+        timeout = object;</span>
<a href="#l37.1854"></a><span id="l37.1854" class="difflineplus">+        object = void 0;</span>
<a href="#l37.1855"></a><span id="l37.1855" class="difflineplus">+    }</span>
<a href="#l37.1856"></a><span id="l37.1856" class="difflineplus">+    return Q(object).delay(timeout);</span>
<a href="#l37.1857"></a><span id="l37.1857" class="difflineplus">+};</span>
<a href="#l37.1858"></a><span id="l37.1858" class="difflineplus">+</span>
<a href="#l37.1859"></a><span id="l37.1859" class="difflineplus">+Promise.prototype.delay = function (timeout) {</span>
<a href="#l37.1860"></a><span id="l37.1860" class="difflineplus">+    return this.then(function (value) {</span>
<a href="#l37.1861"></a><span id="l37.1861" class="difflineplus">+        var deferred = defer();</span>
<a href="#l37.1862"></a><span id="l37.1862" class="difflineplus">+        setTimeout(function () {</span>
<a href="#l37.1863"></a><span id="l37.1863" class="difflineplus">+            deferred.resolve(value);</span>
<a href="#l37.1864"></a><span id="l37.1864" class="difflineplus">+        }, timeout);</span>
<a href="#l37.1865"></a><span id="l37.1865" class="difflineplus">+        return deferred.promise;</span>
<a href="#l37.1866"></a><span id="l37.1866" class="difflineplus">+    });</span>
<a href="#l37.1867"></a><span id="l37.1867" class="difflineplus">+};</span>
<a href="#l37.1868"></a><span id="l37.1868" class="difflineplus">+</span>
<a href="#l37.1869"></a><span id="l37.1869" class="difflineplus">+/**</span>
<a href="#l37.1870"></a><span id="l37.1870" class="difflineplus">+ * Passes a continuation to a Node function, which is called with the given</span>
<a href="#l37.1871"></a><span id="l37.1871" class="difflineplus">+ * arguments provided as an array, and returns a promise.</span>
<a href="#l37.1872"></a><span id="l37.1872" class="difflineplus">+ *</span>
<a href="#l37.1873"></a><span id="l37.1873" class="difflineplus">+ *      Q.nfapply(FS.readFile, [__filename])</span>
<a href="#l37.1874"></a><span id="l37.1874" class="difflineplus">+ *      .then(function (content) {</span>
<a href="#l37.1875"></a><span id="l37.1875" class="difflineplus">+ *      })</span>
<a href="#l37.1876"></a><span id="l37.1876" class="difflineplus">+ *</span>
<a href="#l37.1877"></a><span id="l37.1877" class="difflineplus">+ */</span>
<a href="#l37.1878"></a><span id="l37.1878" class="difflineplus">+Q.nfapply = function (callback, args) {</span>
<a href="#l37.1879"></a><span id="l37.1879" class="difflineplus">+    return Q(callback).nfapply(args);</span>
<a href="#l37.1880"></a><span id="l37.1880" class="difflineplus">+};</span>
<a href="#l37.1881"></a><span id="l37.1881" class="difflineplus">+</span>
<a href="#l37.1882"></a><span id="l37.1882" class="difflineplus">+Promise.prototype.nfapply = function (args) {</span>
<a href="#l37.1883"></a><span id="l37.1883" class="difflineplus">+    var deferred = defer();</span>
<a href="#l37.1884"></a><span id="l37.1884" class="difflineplus">+    var nodeArgs = array_slice(args);</span>
<a href="#l37.1885"></a><span id="l37.1885" class="difflineplus">+    nodeArgs.push(deferred.makeNodeResolver());</span>
<a href="#l37.1886"></a><span id="l37.1886" class="difflineplus">+    this.fapply(nodeArgs).fail(deferred.reject);</span>
<a href="#l37.1887"></a><span id="l37.1887" class="difflineplus">+    return deferred.promise;</span>
<a href="#l37.1888"></a><span id="l37.1888" class="difflineplus">+};</span>
<a href="#l37.1889"></a><span id="l37.1889" class="difflineplus">+</span>
<a href="#l37.1890"></a><span id="l37.1890" class="difflineplus">+/**</span>
<a href="#l37.1891"></a><span id="l37.1891" class="difflineplus">+ * Passes a continuation to a Node function, which is called with the given</span>
<a href="#l37.1892"></a><span id="l37.1892" class="difflineplus">+ * arguments provided individually, and returns a promise.</span>
<a href="#l37.1893"></a><span id="l37.1893" class="difflineplus">+ * @example</span>
<a href="#l37.1894"></a><span id="l37.1894" class="difflineplus">+ * Q.nfcall(FS.readFile, __filename)</span>
<a href="#l37.1895"></a><span id="l37.1895" class="difflineplus">+ * .then(function (content) {</span>
<a href="#l37.1896"></a><span id="l37.1896" class="difflineplus">+ * })</span>
<a href="#l37.1897"></a><span id="l37.1897" class="difflineplus">+ *</span>
<a href="#l37.1898"></a><span id="l37.1898" class="difflineplus">+ */</span>
<a href="#l37.1899"></a><span id="l37.1899" class="difflineplus">+Q.nfcall = function (callback /*...args*/) {</span>
<a href="#l37.1900"></a><span id="l37.1900" class="difflineplus">+    var args = array_slice(arguments, 1);</span>
<a href="#l37.1901"></a><span id="l37.1901" class="difflineplus">+    return Q(callback).nfapply(args);</span>
<a href="#l37.1902"></a><span id="l37.1902" class="difflineplus">+};</span>
<a href="#l37.1903"></a><span id="l37.1903" class="difflineplus">+</span>
<a href="#l37.1904"></a><span id="l37.1904" class="difflineplus">+Promise.prototype.nfcall = function (/*...args*/) {</span>
<a href="#l37.1905"></a><span id="l37.1905" class="difflineplus">+    var nodeArgs = array_slice(arguments);</span>
<a href="#l37.1906"></a><span id="l37.1906" class="difflineplus">+    var deferred = defer();</span>
<a href="#l37.1907"></a><span id="l37.1907" class="difflineplus">+    nodeArgs.push(deferred.makeNodeResolver());</span>
<a href="#l37.1908"></a><span id="l37.1908" class="difflineplus">+    this.fapply(nodeArgs).fail(deferred.reject);</span>
<a href="#l37.1909"></a><span id="l37.1909" class="difflineplus">+    return deferred.promise;</span>
<a href="#l37.1910"></a><span id="l37.1910" class="difflineplus">+};</span>
<a href="#l37.1911"></a><span id="l37.1911" class="difflineplus">+</span>
<a href="#l37.1912"></a><span id="l37.1912" class="difflineplus">+/**</span>
<a href="#l37.1913"></a><span id="l37.1913" class="difflineplus">+ * Wraps a NodeJS continuation passing function and returns an equivalent</span>
<a href="#l37.1914"></a><span id="l37.1914" class="difflineplus">+ * version that returns a promise.</span>
<a href="#l37.1915"></a><span id="l37.1915" class="difflineplus">+ * @example</span>
<a href="#l37.1916"></a><span id="l37.1916" class="difflineplus">+ * Q.nfbind(FS.readFile, __filename)(&quot;utf-8&quot;)</span>
<a href="#l37.1917"></a><span id="l37.1917" class="difflineplus">+ * .then(console.log)</span>
<a href="#l37.1918"></a><span id="l37.1918" class="difflineplus">+ * .done()</span>
<a href="#l37.1919"></a><span id="l37.1919" class="difflineplus">+ */</span>
<a href="#l37.1920"></a><span id="l37.1920" class="difflineplus">+Q.nfbind =</span>
<a href="#l37.1921"></a><span id="l37.1921" class="difflineplus">+Q.denodeify = function (callback /*...args*/) {</span>
<a href="#l37.1922"></a><span id="l37.1922" class="difflineplus">+    var baseArgs = array_slice(arguments, 1);</span>
<a href="#l37.1923"></a><span id="l37.1923" class="difflineplus">+    return function () {</span>
<a href="#l37.1924"></a><span id="l37.1924" class="difflineplus">+        var nodeArgs = baseArgs.concat(array_slice(arguments));</span>
<a href="#l37.1925"></a><span id="l37.1925" class="difflineplus">+        var deferred = defer();</span>
<a href="#l37.1926"></a><span id="l37.1926" class="difflineplus">+        nodeArgs.push(deferred.makeNodeResolver());</span>
<a href="#l37.1927"></a><span id="l37.1927" class="difflineplus">+        Q(callback).fapply(nodeArgs).fail(deferred.reject);</span>
<a href="#l37.1928"></a><span id="l37.1928" class="difflineplus">+        return deferred.promise;</span>
<a href="#l37.1929"></a><span id="l37.1929" class="difflineplus">+    };</span>
<a href="#l37.1930"></a><span id="l37.1930" class="difflineplus">+};</span>
<a href="#l37.1931"></a><span id="l37.1931" class="difflineplus">+</span>
<a href="#l37.1932"></a><span id="l37.1932" class="difflineplus">+Promise.prototype.nfbind =</span>
<a href="#l37.1933"></a><span id="l37.1933" class="difflineplus">+Promise.prototype.denodeify = function (/*...args*/) {</span>
<a href="#l37.1934"></a><span id="l37.1934" class="difflineplus">+    var args = array_slice(arguments);</span>
<a href="#l37.1935"></a><span id="l37.1935" class="difflineplus">+    args.unshift(this);</span>
<a href="#l37.1936"></a><span id="l37.1936" class="difflineplus">+    return Q.denodeify.apply(void 0, args);</span>
<a href="#l37.1937"></a><span id="l37.1937" class="difflineplus">+};</span>
<a href="#l37.1938"></a><span id="l37.1938" class="difflineplus">+</span>
<a href="#l37.1939"></a><span id="l37.1939" class="difflineplus">+Q.nbind = function (callback, thisp /*...args*/) {</span>
<a href="#l37.1940"></a><span id="l37.1940" class="difflineplus">+    var baseArgs = array_slice(arguments, 2);</span>
<a href="#l37.1941"></a><span id="l37.1941" class="difflineplus">+    return function () {</span>
<a href="#l37.1942"></a><span id="l37.1942" class="difflineplus">+        var nodeArgs = baseArgs.concat(array_slice(arguments));</span>
<a href="#l37.1943"></a><span id="l37.1943" class="difflineplus">+        var deferred = defer();</span>
<a href="#l37.1944"></a><span id="l37.1944" class="difflineplus">+        nodeArgs.push(deferred.makeNodeResolver());</span>
<a href="#l37.1945"></a><span id="l37.1945" class="difflineplus">+        function bound() {</span>
<a href="#l37.1946"></a><span id="l37.1946" class="difflineplus">+            return callback.apply(thisp, arguments);</span>
<a href="#l37.1947"></a><span id="l37.1947" class="difflineplus">+        }</span>
<a href="#l37.1948"></a><span id="l37.1948" class="difflineplus">+        Q(bound).fapply(nodeArgs).fail(deferred.reject);</span>
<a href="#l37.1949"></a><span id="l37.1949" class="difflineplus">+        return deferred.promise;</span>
<a href="#l37.1950"></a><span id="l37.1950" class="difflineplus">+    };</span>
<a href="#l37.1951"></a><span id="l37.1951" class="difflineplus">+};</span>
<a href="#l37.1952"></a><span id="l37.1952" class="difflineplus">+</span>
<a href="#l37.1953"></a><span id="l37.1953" class="difflineplus">+Promise.prototype.nbind = function (/*thisp, ...args*/) {</span>
<a href="#l37.1954"></a><span id="l37.1954" class="difflineplus">+    var args = array_slice(arguments, 0);</span>
<a href="#l37.1955"></a><span id="l37.1955" class="difflineplus">+    args.unshift(this);</span>
<a href="#l37.1956"></a><span id="l37.1956" class="difflineplus">+    return Q.nbind.apply(void 0, args);</span>
<a href="#l37.1957"></a><span id="l37.1957" class="difflineplus">+};</span>
<a href="#l37.1958"></a><span id="l37.1958" class="difflineplus">+</span>
<a href="#l37.1959"></a><span id="l37.1959" class="difflineplus">+/**</span>
<a href="#l37.1960"></a><span id="l37.1960" class="difflineplus">+ * Calls a method of a Node-style object that accepts a Node-style</span>
<a href="#l37.1961"></a><span id="l37.1961" class="difflineplus">+ * callback with a given array of arguments, plus a provided callback.</span>
<a href="#l37.1962"></a><span id="l37.1962" class="difflineplus">+ * @param object an object that has the named method</span>
<a href="#l37.1963"></a><span id="l37.1963" class="difflineplus">+ * @param {String} name name of the method of object</span>
<a href="#l37.1964"></a><span id="l37.1964" class="difflineplus">+ * @param {Array} args arguments to pass to the method; the callback</span>
<a href="#l37.1965"></a><span id="l37.1965" class="difflineplus">+ * will be provided by Q and appended to these arguments.</span>
<a href="#l37.1966"></a><span id="l37.1966" class="difflineplus">+ * @returns a promise for the value or error</span>
<a href="#l37.1967"></a><span id="l37.1967" class="difflineplus">+ */</span>
<a href="#l37.1968"></a><span id="l37.1968" class="difflineplus">+Q.nmapply = // XXX As proposed by &quot;Redsandro&quot;</span>
<a href="#l37.1969"></a><span id="l37.1969" class="difflineplus">+Q.npost = function (object, name, args) {</span>
<a href="#l37.1970"></a><span id="l37.1970" class="difflineplus">+    return Q(object).npost(name, args);</span>
<a href="#l37.1971"></a><span id="l37.1971" class="difflineplus">+};</span>
<a href="#l37.1972"></a><span id="l37.1972" class="difflineplus">+</span>
<a href="#l37.1973"></a><span id="l37.1973" class="difflineplus">+Promise.prototype.nmapply = // XXX As proposed by &quot;Redsandro&quot;</span>
<a href="#l37.1974"></a><span id="l37.1974" class="difflineplus">+Promise.prototype.npost = function (name, args) {</span>
<a href="#l37.1975"></a><span id="l37.1975" class="difflineplus">+    var nodeArgs = array_slice(args || []);</span>
<a href="#l37.1976"></a><span id="l37.1976" class="difflineplus">+    var deferred = defer();</span>
<a href="#l37.1977"></a><span id="l37.1977" class="difflineplus">+    nodeArgs.push(deferred.makeNodeResolver());</span>
<a href="#l37.1978"></a><span id="l37.1978" class="difflineplus">+    this.dispatch(&quot;post&quot;, [name, nodeArgs]).fail(deferred.reject);</span>
<a href="#l37.1979"></a><span id="l37.1979" class="difflineplus">+    return deferred.promise;</span>
<a href="#l37.1980"></a><span id="l37.1980" class="difflineplus">+};</span>
<a href="#l37.1981"></a><span id="l37.1981" class="difflineplus">+</span>
<a href="#l37.1982"></a><span id="l37.1982" class="difflineplus">+/**</span>
<a href="#l37.1983"></a><span id="l37.1983" class="difflineplus">+ * Calls a method of a Node-style object that accepts a Node-style</span>
<a href="#l37.1984"></a><span id="l37.1984" class="difflineplus">+ * callback, forwarding the given variadic arguments, plus a provided</span>
<a href="#l37.1985"></a><span id="l37.1985" class="difflineplus">+ * callback argument.</span>
<a href="#l37.1986"></a><span id="l37.1986" class="difflineplus">+ * @param object an object that has the named method</span>
<a href="#l37.1987"></a><span id="l37.1987" class="difflineplus">+ * @param {String} name name of the method of object</span>
<a href="#l37.1988"></a><span id="l37.1988" class="difflineplus">+ * @param ...args arguments to pass to the method; the callback will</span>
<a href="#l37.1989"></a><span id="l37.1989" class="difflineplus">+ * be provided by Q and appended to these arguments.</span>
<a href="#l37.1990"></a><span id="l37.1990" class="difflineplus">+ * @returns a promise for the value or error</span>
<a href="#l37.1991"></a><span id="l37.1991" class="difflineplus">+ */</span>
<a href="#l37.1992"></a><span id="l37.1992" class="difflineplus">+Q.nsend = // XXX Based on Mark Miller's proposed &quot;send&quot;</span>
<a href="#l37.1993"></a><span id="l37.1993" class="difflineplus">+Q.nmcall = // XXX Based on &quot;Redsandro's&quot; proposal</span>
<a href="#l37.1994"></a><span id="l37.1994" class="difflineplus">+Q.ninvoke = function (object, name /*...args*/) {</span>
<a href="#l37.1995"></a><span id="l37.1995" class="difflineplus">+    var nodeArgs = array_slice(arguments, 2);</span>
<a href="#l37.1996"></a><span id="l37.1996" class="difflineplus">+    var deferred = defer();</span>
<a href="#l37.1997"></a><span id="l37.1997" class="difflineplus">+    nodeArgs.push(deferred.makeNodeResolver());</span>
<a href="#l37.1998"></a><span id="l37.1998" class="difflineplus">+    Q(object).dispatch(&quot;post&quot;, [name, nodeArgs]).fail(deferred.reject);</span>
<a href="#l37.1999"></a><span id="l37.1999" class="difflineplus">+    return deferred.promise;</span>
<a href="#l37.2000"></a><span id="l37.2000" class="difflineplus">+};</span>
<a href="#l37.2001"></a><span id="l37.2001" class="difflineplus">+</span>
<a href="#l37.2002"></a><span id="l37.2002" class="difflineplus">+Promise.prototype.nsend = // XXX Based on Mark Miller's proposed &quot;send&quot;</span>
<a href="#l37.2003"></a><span id="l37.2003" class="difflineplus">+Promise.prototype.nmcall = // XXX Based on &quot;Redsandro's&quot; proposal</span>
<a href="#l37.2004"></a><span id="l37.2004" class="difflineplus">+Promise.prototype.ninvoke = function (name /*...args*/) {</span>
<a href="#l37.2005"></a><span id="l37.2005" class="difflineplus">+    var nodeArgs = array_slice(arguments, 1);</span>
<a href="#l37.2006"></a><span id="l37.2006" class="difflineplus">+    var deferred = defer();</span>
<a href="#l37.2007"></a><span id="l37.2007" class="difflineplus">+    nodeArgs.push(deferred.makeNodeResolver());</span>
<a href="#l37.2008"></a><span id="l37.2008" class="difflineplus">+    this.dispatch(&quot;post&quot;, [name, nodeArgs]).fail(deferred.reject);</span>
<a href="#l37.2009"></a><span id="l37.2009" class="difflineplus">+    return deferred.promise;</span>
<a href="#l37.2010"></a><span id="l37.2010" class="difflineplus">+};</span>
<a href="#l37.2011"></a><span id="l37.2011" class="difflineplus">+</span>
<a href="#l37.2012"></a><span id="l37.2012" class="difflineplus">+/**</span>
<a href="#l37.2013"></a><span id="l37.2013" class="difflineplus">+ * If a function would like to support both Node continuation-passing-style and</span>
<a href="#l37.2014"></a><span id="l37.2014" class="difflineplus">+ * promise-returning-style, it can end its internal promise chain with</span>
<a href="#l37.2015"></a><span id="l37.2015" class="difflineplus">+ * `nodeify(nodeback)`, forwarding the optional nodeback argument.  If the user</span>
<a href="#l37.2016"></a><span id="l37.2016" class="difflineplus">+ * elects to use a nodeback, the result will be sent there.  If they do not</span>
<a href="#l37.2017"></a><span id="l37.2017" class="difflineplus">+ * pass a nodeback, they will receive the result promise.</span>
<a href="#l37.2018"></a><span id="l37.2018" class="difflineplus">+ * @param object a result (or a promise for a result)</span>
<a href="#l37.2019"></a><span id="l37.2019" class="difflineplus">+ * @param {Function} nodeback a Node.js-style callback</span>
<a href="#l37.2020"></a><span id="l37.2020" class="difflineplus">+ * @returns either the promise or nothing</span>
<a href="#l37.2021"></a><span id="l37.2021" class="difflineplus">+ */</span>
<a href="#l37.2022"></a><span id="l37.2022" class="difflineplus">+Q.nodeify = nodeify;</span>
<a href="#l37.2023"></a><span id="l37.2023" class="difflineplus">+function nodeify(object, nodeback) {</span>
<a href="#l37.2024"></a><span id="l37.2024" class="difflineplus">+    return Q(object).nodeify(nodeback);</span>
<a href="#l37.2025"></a><span id="l37.2025" class="difflineplus">+}</span>
<a href="#l37.2026"></a><span id="l37.2026" class="difflineplus">+</span>
<a href="#l37.2027"></a><span id="l37.2027" class="difflineplus">+Promise.prototype.nodeify = function (nodeback) {</span>
<a href="#l37.2028"></a><span id="l37.2028" class="difflineplus">+    if (nodeback) {</span>
<a href="#l37.2029"></a><span id="l37.2029" class="difflineplus">+        this.then(function (value) {</span>
<a href="#l37.2030"></a><span id="l37.2030" class="difflineplus">+            Q.nextTick(function () {</span>
<a href="#l37.2031"></a><span id="l37.2031" class="difflineplus">+                nodeback(null, value);</span>
<a href="#l37.2032"></a><span id="l37.2032" class="difflineplus">+            });</span>
<a href="#l37.2033"></a><span id="l37.2033" class="difflineplus">+        }, function (error) {</span>
<a href="#l37.2034"></a><span id="l37.2034" class="difflineplus">+            Q.nextTick(function () {</span>
<a href="#l37.2035"></a><span id="l37.2035" class="difflineplus">+                nodeback(error);</span>
<a href="#l37.2036"></a><span id="l37.2036" class="difflineplus">+            });</span>
<a href="#l37.2037"></a><span id="l37.2037" class="difflineplus">+        });</span>
<a href="#l37.2038"></a><span id="l37.2038" class="difflineplus">+    } else {</span>
<a href="#l37.2039"></a><span id="l37.2039" class="difflineplus">+        return this;</span>
<a href="#l37.2040"></a><span id="l37.2040" class="difflineplus">+    }</span>
<a href="#l37.2041"></a><span id="l37.2041" class="difflineplus">+};</span>
<a href="#l37.2042"></a><span id="l37.2042" class="difflineplus">+</span>
<a href="#l37.2043"></a><span id="l37.2043" class="difflineplus">+Q.noConflict = function() {</span>
<a href="#l37.2044"></a><span id="l37.2044" class="difflineplus">+    throw new Error(&quot;Q.noConflict only works when Q is used as a global&quot;);</span>
<a href="#l37.2045"></a><span id="l37.2045" class="difflineplus">+};</span>
<a href="#l37.2046"></a><span id="l37.2046" class="difflineplus">+</span>
<a href="#l37.2047"></a><span id="l37.2047" class="difflineplus">+// All code before this point will be filtered from stack traces.</span>
<a href="#l37.2048"></a><span id="l37.2048" class="difflineplus">+var qEndingLine = captureLine();</span>
<a href="#l37.2049"></a><span id="l37.2049" class="difflineplus">+</span>
<a href="#l37.2050"></a><span id="l37.2050" class="difflineplus">+return Q;</span>
<a href="#l37.2051"></a><span id="l37.2051" class="difflineplus">+</span>
<a href="#l37.2052"></a><span id="l37.2052" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l38.1"></a><span id="l38.1">new file mode 100644</span>
<a href="#l38.2"></a><span id="l38.2" class="difflineminus">--- /dev/null</span>
<a href="#l38.3"></a><span id="l38.3" class="difflineplus">+++ b/chat/protocols/matrix/matrix-sdk/q/queue.js</span>
<a href="#l38.4"></a><span id="l38.4" class="difflineat">@@ -0,0 +1,54 @@</span>
<a href="#l38.5"></a><span id="l38.5" class="difflineplus">+/*</span>
<a href="#l38.6"></a><span id="l38.6" class="difflineplus">+Copyright 20092017 Kristopher Michael Kowal. All rights reserved.</span>
<a href="#l38.7"></a><span id="l38.7" class="difflineplus">+Permission is hereby granted, free of charge, to any person obtaining a copy</span>
<a href="#l38.8"></a><span id="l38.8" class="difflineplus">+of this software and associated documentation files (the &quot;Software&quot;), to</span>
<a href="#l38.9"></a><span id="l38.9" class="difflineplus">+deal in the Software without restriction, including without limitation the</span>
<a href="#l38.10"></a><span id="l38.10" class="difflineplus">+rights to use, copy, modify, merge, publish, distribute, sublicense, and/or</span>
<a href="#l38.11"></a><span id="l38.11" class="difflineplus">+sell copies of the Software, and to permit persons to whom the Software is</span>
<a href="#l38.12"></a><span id="l38.12" class="difflineplus">+furnished to do so, subject to the following conditions:</span>
<a href="#l38.13"></a><span id="l38.13" class="difflineplus">+</span>
<a href="#l38.14"></a><span id="l38.14" class="difflineplus">+The above copyright notice and this permission notice shall be included in</span>
<a href="#l38.15"></a><span id="l38.15" class="difflineplus">+all copies or substantial portions of the Software.</span>
<a href="#l38.16"></a><span id="l38.16" class="difflineplus">+</span>
<a href="#l38.17"></a><span id="l38.17" class="difflineplus">+THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span>
<a href="#l38.18"></a><span id="l38.18" class="difflineplus">+IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span>
<a href="#l38.19"></a><span id="l38.19" class="difflineplus">+FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE</span>
<a href="#l38.20"></a><span id="l38.20" class="difflineplus">+AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER</span>
<a href="#l38.21"></a><span id="l38.21" class="difflineplus">+LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING</span>
<a href="#l38.22"></a><span id="l38.22" class="difflineplus">+FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS</span>
<a href="#l38.23"></a><span id="l38.23" class="difflineplus">+IN THE SOFTWARE.</span>
<a href="#l38.24"></a><span id="l38.24" class="difflineplus">+*/</span>
<a href="#l38.25"></a><span id="l38.25" class="difflineplus">+var Q = require(&quot;./q&quot;);</span>
<a href="#l38.26"></a><span id="l38.26" class="difflineplus">+</span>
<a href="#l38.27"></a><span id="l38.27" class="difflineplus">+module.exports = Queue;</span>
<a href="#l38.28"></a><span id="l38.28" class="difflineplus">+function Queue() {</span>
<a href="#l38.29"></a><span id="l38.29" class="difflineplus">+    var ends = Q.defer();</span>
<a href="#l38.30"></a><span id="l38.30" class="difflineplus">+    var closed = Q.defer();</span>
<a href="#l38.31"></a><span id="l38.31" class="difflineplus">+    return {</span>
<a href="#l38.32"></a><span id="l38.32" class="difflineplus">+        put: function (value) {</span>
<a href="#l38.33"></a><span id="l38.33" class="difflineplus">+            var next = Q.defer();</span>
<a href="#l38.34"></a><span id="l38.34" class="difflineplus">+            ends.resolve({</span>
<a href="#l38.35"></a><span id="l38.35" class="difflineplus">+                head: value,</span>
<a href="#l38.36"></a><span id="l38.36" class="difflineplus">+                tail: next.promise</span>
<a href="#l38.37"></a><span id="l38.37" class="difflineplus">+            });</span>
<a href="#l38.38"></a><span id="l38.38" class="difflineplus">+            ends.resolve = next.resolve;</span>
<a href="#l38.39"></a><span id="l38.39" class="difflineplus">+        },</span>
<a href="#l38.40"></a><span id="l38.40" class="difflineplus">+        get: function () {</span>
<a href="#l38.41"></a><span id="l38.41" class="difflineplus">+            var result = ends.promise.get(&quot;head&quot;);</span>
<a href="#l38.42"></a><span id="l38.42" class="difflineplus">+            ends.promise = ends.promise.get(&quot;tail&quot;);</span>
<a href="#l38.43"></a><span id="l38.43" class="difflineplus">+            return result.fail(function (error) {</span>
<a href="#l38.44"></a><span id="l38.44" class="difflineplus">+                closed.resolve(error);</span>
<a href="#l38.45"></a><span id="l38.45" class="difflineplus">+                throw error;</span>
<a href="#l38.46"></a><span id="l38.46" class="difflineplus">+            });</span>
<a href="#l38.47"></a><span id="l38.47" class="difflineplus">+        },</span>
<a href="#l38.48"></a><span id="l38.48" class="difflineplus">+        closed: closed.promise,</span>
<a href="#l38.49"></a><span id="l38.49" class="difflineplus">+        close: function (error) {</span>
<a href="#l38.50"></a><span id="l38.50" class="difflineplus">+            error = error || new Error(&quot;Can't get value from closed queue&quot;);</span>
<a href="#l38.51"></a><span id="l38.51" class="difflineplus">+            var end = {head: Q.reject(error)};</span>
<a href="#l38.52"></a><span id="l38.52" class="difflineplus">+            end.tail = end;</span>
<a href="#l38.53"></a><span id="l38.53" class="difflineplus">+            ends.resolve(end);</span>
<a href="#l38.54"></a><span id="l38.54" class="difflineplus">+            return closed.promise;</span>
<a href="#l38.55"></a><span id="l38.55" class="difflineplus">+        }</span>
<a href="#l38.56"></a><span id="l38.56" class="difflineplus">+    };</span>
<a href="#l38.57"></a><span id="l38.57" class="difflineplus">+}</span>
<a href="#l38.58"></a><span id="l38.58" class="difflineplus">+</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l39.1"></a><span id="l39.1">new file mode 100644</span>
<a href="#l39.2"></a><span id="l39.2" class="difflineminus">--- /dev/null</span>
<a href="#l39.3"></a><span id="l39.3" class="difflineplus">+++ b/chat/protocols/matrix/matrix-sdk/realtime-callbacks.js</span>
<a href="#l39.4"></a><span id="l39.4" class="difflineat">@@ -0,0 +1,203 @@</span>
<a href="#l39.5"></a><span id="l39.5" class="difflineplus">+/*</span>
<a href="#l39.6"></a><span id="l39.6" class="difflineplus">+Copyright 2016 OpenMarket Ltd</span>
<a href="#l39.7"></a><span id="l39.7" class="difflineplus">+</span>
<a href="#l39.8"></a><span id="l39.8" class="difflineplus">+Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<a href="#l39.9"></a><span id="l39.9" class="difflineplus">+you may not use this file except in compliance with the License.</span>
<a href="#l39.10"></a><span id="l39.10" class="difflineplus">+You may obtain a copy of the License at</span>
<a href="#l39.11"></a><span id="l39.11" class="difflineplus">+</span>
<a href="#l39.12"></a><span id="l39.12" class="difflineplus">+    http://www.apache.org/licenses/LICENSE-2.0</span>
<a href="#l39.13"></a><span id="l39.13" class="difflineplus">+</span>
<a href="#l39.14"></a><span id="l39.14" class="difflineplus">+Unless required by applicable law or agreed to in writing, software</span>
<a href="#l39.15"></a><span id="l39.15" class="difflineplus">+distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<a href="#l39.16"></a><span id="l39.16" class="difflineplus">+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<a href="#l39.17"></a><span id="l39.17" class="difflineplus">+See the License for the specific language governing permissions and</span>
<a href="#l39.18"></a><span id="l39.18" class="difflineplus">+limitations under the License.</span>
<a href="#l39.19"></a><span id="l39.19" class="difflineplus">+*/</span>
<a href="#l39.20"></a><span id="l39.20" class="difflineplus">+</span>
<a href="#l39.21"></a><span id="l39.21" class="difflineplus">+/* A re-implementation of the javascript callback functions (setTimeout,</span>
<a href="#l39.22"></a><span id="l39.22" class="difflineplus">+ * clearTimeout; setInterval and clearInterval are not yet implemented) which</span>
<a href="#l39.23"></a><span id="l39.23" class="difflineplus">+ * try to improve handling of large clock jumps (as seen when</span>
<a href="#l39.24"></a><span id="l39.24" class="difflineplus">+ * suspending/resuming the system).</span>
<a href="#l39.25"></a><span id="l39.25" class="difflineplus">+ *</span>
<a href="#l39.26"></a><span id="l39.26" class="difflineplus">+ * In particular, if a timeout would have fired while the system was suspended,</span>
<a href="#l39.27"></a><span id="l39.27" class="difflineplus">+ * it will instead fire as soon as possible after resume.</span>
<a href="#l39.28"></a><span id="l39.28" class="difflineplus">+ */</span>
<a href="#l39.29"></a><span id="l39.29" class="difflineplus">+</span>
<a href="#l39.30"></a><span id="l39.30" class="difflineplus">+&quot;use strict&quot;;</span>
<a href="#l39.31"></a><span id="l39.31" class="difflineplus">+</span>
<a href="#l39.32"></a><span id="l39.32" class="difflineplus">+// we schedule a callback at least this often, to check if we've missed out on</span>
<a href="#l39.33"></a><span id="l39.33" class="difflineplus">+// some wall-clock time due to being suspended.</span>
<a href="#l39.34"></a><span id="l39.34" class="difflineplus">+var TIMER_CHECK_PERIOD_MS = 1000;</span>
<a href="#l39.35"></a><span id="l39.35" class="difflineplus">+</span>
<a href="#l39.36"></a><span id="l39.36" class="difflineplus">+// counter, for making up ids to return from setTimeout</span>
<a href="#l39.37"></a><span id="l39.37" class="difflineplus">+var _count = 0;</span>
<a href="#l39.38"></a><span id="l39.38" class="difflineplus">+</span>
<a href="#l39.39"></a><span id="l39.39" class="difflineplus">+// the key for our callback with the real global.setTimeout</span>
<a href="#l39.40"></a><span id="l39.40" class="difflineplus">+var _realCallbackKey;</span>
<a href="#l39.41"></a><span id="l39.41" class="difflineplus">+</span>
<a href="#l39.42"></a><span id="l39.42" class="difflineplus">+// a sorted list of the callbacks to be run.</span>
<a href="#l39.43"></a><span id="l39.43" class="difflineplus">+// each is an object with keys [runAt, func, params, key].</span>
<a href="#l39.44"></a><span id="l39.44" class="difflineplus">+var _callbackList = [];</span>
<a href="#l39.45"></a><span id="l39.45" class="difflineplus">+</span>
<a href="#l39.46"></a><span id="l39.46" class="difflineplus">+// var debuglog = console.log.bind(console);</span>
<a href="#l39.47"></a><span id="l39.47" class="difflineplus">+var debuglog = function() {};</span>
<a href="#l39.48"></a><span id="l39.48" class="difflineplus">+</span>
<a href="#l39.49"></a><span id="l39.49" class="difflineplus">+/**</span>
<a href="#l39.50"></a><span id="l39.50" class="difflineplus">+ * Replace the function used by this module to get the current time.</span>
<a href="#l39.51"></a><span id="l39.51" class="difflineplus">+ *</span>
<a href="#l39.52"></a><span id="l39.52" class="difflineplus">+ * Intended for use by the unit tests.</span>
<a href="#l39.53"></a><span id="l39.53" class="difflineplus">+ *</span>
<a href="#l39.54"></a><span id="l39.54" class="difflineplus">+ * @param {function} f function which should return a millisecond counter</span>
<a href="#l39.55"></a><span id="l39.55" class="difflineplus">+ *</span>
<a href="#l39.56"></a><span id="l39.56" class="difflineplus">+ * @internal</span>
<a href="#l39.57"></a><span id="l39.57" class="difflineplus">+ */</span>
<a href="#l39.58"></a><span id="l39.58" class="difflineplus">+module.exports.setNow = function(f) {</span>
<a href="#l39.59"></a><span id="l39.59" class="difflineplus">+    _now = f || Date.now;</span>
<a href="#l39.60"></a><span id="l39.60" class="difflineplus">+};</span>
<a href="#l39.61"></a><span id="l39.61" class="difflineplus">+var _now = Date.now;</span>
<a href="#l39.62"></a><span id="l39.62" class="difflineplus">+</span>
<a href="#l39.63"></a><span id="l39.63" class="difflineplus">+/**</span>
<a href="#l39.64"></a><span id="l39.64" class="difflineplus">+ * reimplementation of window.setTimeout, which will call the callback if</span>
<a href="#l39.65"></a><span id="l39.65" class="difflineplus">+ * the wallclock time goes past the deadline.</span>
<a href="#l39.66"></a><span id="l39.66" class="difflineplus">+ *</span>
<a href="#l39.67"></a><span id="l39.67" class="difflineplus">+ * @param {function} func   callback to be called after a delay</span>
<a href="#l39.68"></a><span id="l39.68" class="difflineplus">+ * @param {Number} delayMs  number of milliseconds to delay by</span>
<a href="#l39.69"></a><span id="l39.69" class="difflineplus">+ *</span>
<a href="#l39.70"></a><span id="l39.70" class="difflineplus">+ * @return {Number} an identifier for this callback, which may be passed into</span>
<a href="#l39.71"></a><span id="l39.71" class="difflineplus">+ *                   clearTimeout later.</span>
<a href="#l39.72"></a><span id="l39.72" class="difflineplus">+ */</span>
<a href="#l39.73"></a><span id="l39.73" class="difflineplus">+module.exports.setTimeout = function(func, delayMs) {</span>
<a href="#l39.74"></a><span id="l39.74" class="difflineplus">+    delayMs = delayMs || 0;</span>
<a href="#l39.75"></a><span id="l39.75" class="difflineplus">+    if (delayMs &lt; 0) {</span>
<a href="#l39.76"></a><span id="l39.76" class="difflineplus">+        delayMs = 0;</span>
<a href="#l39.77"></a><span id="l39.77" class="difflineplus">+    }</span>
<a href="#l39.78"></a><span id="l39.78" class="difflineplus">+</span>
<a href="#l39.79"></a><span id="l39.79" class="difflineplus">+    var params = Array.prototype.slice.call(arguments, 2);</span>
<a href="#l39.80"></a><span id="l39.80" class="difflineplus">+    var runAt = _now() + delayMs;</span>
<a href="#l39.81"></a><span id="l39.81" class="difflineplus">+    var key = _count++;</span>
<a href="#l39.82"></a><span id="l39.82" class="difflineplus">+    debuglog(&quot;setTimeout: scheduling cb&quot;, key, &quot;at&quot;, runAt,</span>
<a href="#l39.83"></a><span id="l39.83" class="difflineplus">+             &quot;(delay&quot;, delayMs, &quot;)&quot;);</span>
<a href="#l39.84"></a><span id="l39.84" class="difflineplus">+    var data = {</span>
<a href="#l39.85"></a><span id="l39.85" class="difflineplus">+        runAt: runAt,</span>
<a href="#l39.86"></a><span id="l39.86" class="difflineplus">+        func: func,</span>
<a href="#l39.87"></a><span id="l39.87" class="difflineplus">+        params: params,</span>
<a href="#l39.88"></a><span id="l39.88" class="difflineplus">+        key: key,</span>
<a href="#l39.89"></a><span id="l39.89" class="difflineplus">+    };</span>
<a href="#l39.90"></a><span id="l39.90" class="difflineplus">+</span>
<a href="#l39.91"></a><span id="l39.91" class="difflineplus">+    // figure out where it goes in the list</span>
<a href="#l39.92"></a><span id="l39.92" class="difflineplus">+    var idx = binarySearch(</span>
<a href="#l39.93"></a><span id="l39.93" class="difflineplus">+        _callbackList, function(el) {</span>
<a href="#l39.94"></a><span id="l39.94" class="difflineplus">+            return el.runAt - runAt;</span>
<a href="#l39.95"></a><span id="l39.95" class="difflineplus">+        }</span>
<a href="#l39.96"></a><span id="l39.96" class="difflineplus">+    );</span>
<a href="#l39.97"></a><span id="l39.97" class="difflineplus">+</span>
<a href="#l39.98"></a><span id="l39.98" class="difflineplus">+    _callbackList.splice(idx, 0, data);</span>
<a href="#l39.99"></a><span id="l39.99" class="difflineplus">+    _scheduleRealCallback();</span>
<a href="#l39.100"></a><span id="l39.100" class="difflineplus">+</span>
<a href="#l39.101"></a><span id="l39.101" class="difflineplus">+    return key;</span>
<a href="#l39.102"></a><span id="l39.102" class="difflineplus">+};</span>
<a href="#l39.103"></a><span id="l39.103" class="difflineplus">+</span>
<a href="#l39.104"></a><span id="l39.104" class="difflineplus">+/**</span>
<a href="#l39.105"></a><span id="l39.105" class="difflineplus">+ * reimplementation of window.clearTimeout, which mirrors setTimeout</span>
<a href="#l39.106"></a><span id="l39.106" class="difflineplus">+ *</span>
<a href="#l39.107"></a><span id="l39.107" class="difflineplus">+ * @param {Number} key   result from an earlier setTimeout call</span>
<a href="#l39.108"></a><span id="l39.108" class="difflineplus">+ */</span>
<a href="#l39.109"></a><span id="l39.109" class="difflineplus">+module.exports.clearTimeout = function(key) {</span>
<a href="#l39.110"></a><span id="l39.110" class="difflineplus">+    if (_callbackList.length === 0) {</span>
<a href="#l39.111"></a><span id="l39.111" class="difflineplus">+        return;</span>
<a href="#l39.112"></a><span id="l39.112" class="difflineplus">+    }</span>
<a href="#l39.113"></a><span id="l39.113" class="difflineplus">+</span>
<a href="#l39.114"></a><span id="l39.114" class="difflineplus">+    // remove the element from the list</span>
<a href="#l39.115"></a><span id="l39.115" class="difflineplus">+    var i;</span>
<a href="#l39.116"></a><span id="l39.116" class="difflineplus">+    for (i = 0; i &lt; _callbackList.length; i++) {</span>
<a href="#l39.117"></a><span id="l39.117" class="difflineplus">+        var cb = _callbackList[i];</span>
<a href="#l39.118"></a><span id="l39.118" class="difflineplus">+        if (cb.key == key) {</span>
<a href="#l39.119"></a><span id="l39.119" class="difflineplus">+            _callbackList.splice(i, 1);</span>
<a href="#l39.120"></a><span id="l39.120" class="difflineplus">+            break;</span>
<a href="#l39.121"></a><span id="l39.121" class="difflineplus">+        }</span>
<a href="#l39.122"></a><span id="l39.122" class="difflineplus">+    }</span>
<a href="#l39.123"></a><span id="l39.123" class="difflineplus">+</span>
<a href="#l39.124"></a><span id="l39.124" class="difflineplus">+    // iff it was the first one in the list, reschedule our callback.</span>
<a href="#l39.125"></a><span id="l39.125" class="difflineplus">+    if (i === 0) {</span>
<a href="#l39.126"></a><span id="l39.126" class="difflineplus">+        _scheduleRealCallback();</span>
<a href="#l39.127"></a><span id="l39.127" class="difflineplus">+    }</span>
<a href="#l39.128"></a><span id="l39.128" class="difflineplus">+};</span>
<a href="#l39.129"></a><span id="l39.129" class="difflineplus">+</span>
<a href="#l39.130"></a><span id="l39.130" class="difflineplus">+// use the real global.setTimeout to schedule a callback to _runCallbacks.</span>
<a href="#l39.131"></a><span id="l39.131" class="difflineplus">+function _scheduleRealCallback() {</span>
<a href="#l39.132"></a><span id="l39.132" class="difflineplus">+    if (_realCallbackKey) {</span>
<a href="#l39.133"></a><span id="l39.133" class="difflineplus">+        global.clearTimeout(_realCallbackKey);</span>
<a href="#l39.134"></a><span id="l39.134" class="difflineplus">+    }</span>
<a href="#l39.135"></a><span id="l39.135" class="difflineplus">+</span>
<a href="#l39.136"></a><span id="l39.136" class="difflineplus">+    var first = _callbackList[0];</span>
<a href="#l39.137"></a><span id="l39.137" class="difflineplus">+</span>
<a href="#l39.138"></a><span id="l39.138" class="difflineplus">+    if (!first) {</span>
<a href="#l39.139"></a><span id="l39.139" class="difflineplus">+        debuglog(&quot;_scheduleRealCallback: no more callbacks, not rescheduling&quot;);</span>
<a href="#l39.140"></a><span id="l39.140" class="difflineplus">+        return;</span>
<a href="#l39.141"></a><span id="l39.141" class="difflineplus">+    }</span>
<a href="#l39.142"></a><span id="l39.142" class="difflineplus">+</span>
<a href="#l39.143"></a><span id="l39.143" class="difflineplus">+    var now = _now();</span>
<a href="#l39.144"></a><span id="l39.144" class="difflineplus">+    var delayMs = Math.min(first.runAt - now, TIMER_CHECK_PERIOD_MS);</span>
<a href="#l39.145"></a><span id="l39.145" class="difflineplus">+</span>
<a href="#l39.146"></a><span id="l39.146" class="difflineplus">+    debuglog(&quot;_scheduleRealCallback: now:&quot;, now, &quot;delay:&quot;, delayMs);</span>
<a href="#l39.147"></a><span id="l39.147" class="difflineplus">+    _realCallbackKey = global.setTimeout(_runCallbacks, delayMs);</span>
<a href="#l39.148"></a><span id="l39.148" class="difflineplus">+}</span>
<a href="#l39.149"></a><span id="l39.149" class="difflineplus">+</span>
<a href="#l39.150"></a><span id="l39.150" class="difflineplus">+function _runCallbacks() {</span>
<a href="#l39.151"></a><span id="l39.151" class="difflineplus">+    var cb;</span>
<a href="#l39.152"></a><span id="l39.152" class="difflineplus">+    var now = _now();</span>
<a href="#l39.153"></a><span id="l39.153" class="difflineplus">+    debuglog(&quot;_runCallbacks: now:&quot;, now);</span>
<a href="#l39.154"></a><span id="l39.154" class="difflineplus">+</span>
<a href="#l39.155"></a><span id="l39.155" class="difflineplus">+    // get the list of things to call</span>
<a href="#l39.156"></a><span id="l39.156" class="difflineplus">+    var callbacksToRun = [];</span>
<a href="#l39.157"></a><span id="l39.157" class="difflineplus">+    while (true) {</span>
<a href="#l39.158"></a><span id="l39.158" class="difflineplus">+        var first = _callbackList[0];</span>
<a href="#l39.159"></a><span id="l39.159" class="difflineplus">+        if (!first || first.runAt &gt; now) {</span>
<a href="#l39.160"></a><span id="l39.160" class="difflineplus">+            break;</span>
<a href="#l39.161"></a><span id="l39.161" class="difflineplus">+        }</span>
<a href="#l39.162"></a><span id="l39.162" class="difflineplus">+        cb = _callbackList.shift();</span>
<a href="#l39.163"></a><span id="l39.163" class="difflineplus">+        debuglog(&quot;_runCallbacks: popping&quot;, cb.key);</span>
<a href="#l39.164"></a><span id="l39.164" class="difflineplus">+        callbacksToRun.push(cb);</span>
<a href="#l39.165"></a><span id="l39.165" class="difflineplus">+    }</span>
<a href="#l39.166"></a><span id="l39.166" class="difflineplus">+</span>
<a href="#l39.167"></a><span id="l39.167" class="difflineplus">+    // reschedule the real callback before running our functions, to</span>
<a href="#l39.168"></a><span id="l39.168" class="difflineplus">+    // keep the codepaths the same whether or not our functions</span>
<a href="#l39.169"></a><span id="l39.169" class="difflineplus">+    // register their own setTimeouts.</span>
<a href="#l39.170"></a><span id="l39.170" class="difflineplus">+    _scheduleRealCallback();</span>
<a href="#l39.171"></a><span id="l39.171" class="difflineplus">+</span>
<a href="#l39.172"></a><span id="l39.172" class="difflineplus">+    for (var i = 0; i &lt; callbacksToRun.length; i++) {</span>
<a href="#l39.173"></a><span id="l39.173" class="difflineplus">+        cb = callbacksToRun[i];</span>
<a href="#l39.174"></a><span id="l39.174" class="difflineplus">+        try {</span>
<a href="#l39.175"></a><span id="l39.175" class="difflineplus">+            cb.func.apply(null, cb.params);</span>
<a href="#l39.176"></a><span id="l39.176" class="difflineplus">+        } catch (e) {</span>
<a href="#l39.177"></a><span id="l39.177" class="difflineplus">+            console.error(&quot;Uncaught exception in callback function&quot;,</span>
<a href="#l39.178"></a><span id="l39.178" class="difflineplus">+                          e.stack || e);</span>
<a href="#l39.179"></a><span id="l39.179" class="difflineplus">+        }</span>
<a href="#l39.180"></a><span id="l39.180" class="difflineplus">+    }</span>
<a href="#l39.181"></a><span id="l39.181" class="difflineplus">+}</span>
<a href="#l39.182"></a><span id="l39.182" class="difflineplus">+</span>
<a href="#l39.183"></a><span id="l39.183" class="difflineplus">+</span>
<a href="#l39.184"></a><span id="l39.184" class="difflineplus">+/* search in a sorted array.</span>
<a href="#l39.185"></a><span id="l39.185" class="difflineplus">+ *</span>
<a href="#l39.186"></a><span id="l39.186" class="difflineplus">+ * returns the index of the last element for which func returns</span>
<a href="#l39.187"></a><span id="l39.187" class="difflineplus">+ * greater than zero, or array.length if no such element exists.</span>
<a href="#l39.188"></a><span id="l39.188" class="difflineplus">+ */</span>
<a href="#l39.189"></a><span id="l39.189" class="difflineplus">+function binarySearch(array, func) {</span>
<a href="#l39.190"></a><span id="l39.190" class="difflineplus">+    // min is inclusive, max exclusive.</span>
<a href="#l39.191"></a><span id="l39.191" class="difflineplus">+    var min = 0,</span>
<a href="#l39.192"></a><span id="l39.192" class="difflineplus">+        max = array.length;</span>
<a href="#l39.193"></a><span id="l39.193" class="difflineplus">+</span>
<a href="#l39.194"></a><span id="l39.194" class="difflineplus">+    while (min &lt; max) {</span>
<a href="#l39.195"></a><span id="l39.195" class="difflineplus">+        var mid = (min + max) &gt;&gt; 1;</span>
<a href="#l39.196"></a><span id="l39.196" class="difflineplus">+        var res = func(array[mid]);</span>
<a href="#l39.197"></a><span id="l39.197" class="difflineplus">+        if (res &gt; 0) {</span>
<a href="#l39.198"></a><span id="l39.198" class="difflineplus">+            // the element at 'mid' is too big; set it as the new max.</span>
<a href="#l39.199"></a><span id="l39.199" class="difflineplus">+            max = mid;</span>
<a href="#l39.200"></a><span id="l39.200" class="difflineplus">+        } else {</span>
<a href="#l39.201"></a><span id="l39.201" class="difflineplus">+            // the element at 'mid' is too small. 'min' is inclusive, so +1.</span>
<a href="#l39.202"></a><span id="l39.202" class="difflineplus">+            min = mid + 1;</span>
<a href="#l39.203"></a><span id="l39.203" class="difflineplus">+        }</span>
<a href="#l39.204"></a><span id="l39.204" class="difflineplus">+    }</span>
<a href="#l39.205"></a><span id="l39.205" class="difflineplus">+    // presumably, min==max now.</span>
<a href="#l39.206"></a><span id="l39.206" class="difflineplus">+    return min;</span>
<a href="#l39.207"></a><span id="l39.207" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l40.1"></a><span id="l40.1">new file mode 100644</span>
<a href="#l40.2"></a><span id="l40.2" class="difflineminus">--- /dev/null</span>
<a href="#l40.3"></a><span id="l40.3" class="difflineplus">+++ b/chat/protocols/matrix/matrix-sdk/scheduler.js</span>
<a href="#l40.4"></a><span id="l40.4" class="difflineat">@@ -0,0 +1,315 @@</span>
<a href="#l40.5"></a><span id="l40.5" class="difflineplus">+/*</span>
<a href="#l40.6"></a><span id="l40.6" class="difflineplus">+Copyright 2015, 2016 OpenMarket Ltd</span>
<a href="#l40.7"></a><span id="l40.7" class="difflineplus">+</span>
<a href="#l40.8"></a><span id="l40.8" class="difflineplus">+Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<a href="#l40.9"></a><span id="l40.9" class="difflineplus">+you may not use this file except in compliance with the License.</span>
<a href="#l40.10"></a><span id="l40.10" class="difflineplus">+You may obtain a copy of the License at</span>
<a href="#l40.11"></a><span id="l40.11" class="difflineplus">+</span>
<a href="#l40.12"></a><span id="l40.12" class="difflineplus">+    http://www.apache.org/licenses/LICENSE-2.0</span>
<a href="#l40.13"></a><span id="l40.13" class="difflineplus">+</span>
<a href="#l40.14"></a><span id="l40.14" class="difflineplus">+Unless required by applicable law or agreed to in writing, software</span>
<a href="#l40.15"></a><span id="l40.15" class="difflineplus">+distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<a href="#l40.16"></a><span id="l40.16" class="difflineplus">+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<a href="#l40.17"></a><span id="l40.17" class="difflineplus">+See the License for the specific language governing permissions and</span>
<a href="#l40.18"></a><span id="l40.18" class="difflineplus">+limitations under the License.</span>
<a href="#l40.19"></a><span id="l40.19" class="difflineplus">+*/</span>
<a href="#l40.20"></a><span id="l40.20" class="difflineplus">+&quot;use strict&quot;;</span>
<a href="#l40.21"></a><span id="l40.21" class="difflineplus">+/**</span>
<a href="#l40.22"></a><span id="l40.22" class="difflineplus">+ * This is an internal module which manages queuing, scheduling and retrying</span>
<a href="#l40.23"></a><span id="l40.23" class="difflineplus">+ * of requests.</span>
<a href="#l40.24"></a><span id="l40.24" class="difflineplus">+ * @module scheduler</span>
<a href="#l40.25"></a><span id="l40.25" class="difflineplus">+ */</span>
<a href="#l40.26"></a><span id="l40.26" class="difflineplus">+var utils = require(&quot;./utils&quot;);</span>
<a href="#l40.27"></a><span id="l40.27" class="difflineplus">+var q = require(&quot;q&quot;);</span>
<a href="#l40.28"></a><span id="l40.28" class="difflineplus">+</span>
<a href="#l40.29"></a><span id="l40.29" class="difflineplus">+var DEBUG = false;  // set true to enable console logging.</span>
<a href="#l40.30"></a><span id="l40.30" class="difflineplus">+</span>
<a href="#l40.31"></a><span id="l40.31" class="difflineplus">+/**</span>
<a href="#l40.32"></a><span id="l40.32" class="difflineplus">+ * Construct a scheduler for Matrix. Requires</span>
<a href="#l40.33"></a><span id="l40.33" class="difflineplus">+ * {@link module:scheduler~MatrixScheduler#setProcessFunction} to be provided</span>
<a href="#l40.34"></a><span id="l40.34" class="difflineplus">+ * with a way of processing events.</span>
<a href="#l40.35"></a><span id="l40.35" class="difflineplus">+ * @constructor</span>
<a href="#l40.36"></a><span id="l40.36" class="difflineplus">+ * @param {module:scheduler~retryAlgorithm} retryAlgorithm Optional. The retry</span>
<a href="#l40.37"></a><span id="l40.37" class="difflineplus">+ * algorithm to apply when determining when to try to send an event again.</span>
<a href="#l40.38"></a><span id="l40.38" class="difflineplus">+ * Defaults to {@link module:scheduler~MatrixScheduler.RETRY_BACKOFF_RATELIMIT}.</span>
<a href="#l40.39"></a><span id="l40.39" class="difflineplus">+ * @param {module:scheduler~queueAlgorithm} queueAlgorithm Optional. The queuing</span>
<a href="#l40.40"></a><span id="l40.40" class="difflineplus">+ * algorithm to apply when determining which events should be sent before the</span>
<a href="#l40.41"></a><span id="l40.41" class="difflineplus">+ * given event. Defaults to {@link module:scheduler~MatrixScheduler.QUEUE_MESSAGES}.</span>
<a href="#l40.42"></a><span id="l40.42" class="difflineplus">+ */</span>
<a href="#l40.43"></a><span id="l40.43" class="difflineplus">+function MatrixScheduler(retryAlgorithm, queueAlgorithm) {</span>
<a href="#l40.44"></a><span id="l40.44" class="difflineplus">+    this.retryAlgorithm = retryAlgorithm || MatrixScheduler.RETRY_BACKOFF_RATELIMIT;</span>
<a href="#l40.45"></a><span id="l40.45" class="difflineplus">+    this.queueAlgorithm = queueAlgorithm || MatrixScheduler.QUEUE_MESSAGES;</span>
<a href="#l40.46"></a><span id="l40.46" class="difflineplus">+    this._queues = {</span>
<a href="#l40.47"></a><span id="l40.47" class="difflineplus">+        // queueName: [{</span>
<a href="#l40.48"></a><span id="l40.48" class="difflineplus">+        //  event: MatrixEvent,  // event to send</span>
<a href="#l40.49"></a><span id="l40.49" class="difflineplus">+        //  defer: Deferred,  // defer to resolve/reject at the END of the retries</span>
<a href="#l40.50"></a><span id="l40.50" class="difflineplus">+        //  attempts: Number  // number of times we've called processFn</span>
<a href="#l40.51"></a><span id="l40.51" class="difflineplus">+        // }, ...]</span>
<a href="#l40.52"></a><span id="l40.52" class="difflineplus">+    };</span>
<a href="#l40.53"></a><span id="l40.53" class="difflineplus">+    this._activeQueues = [];</span>
<a href="#l40.54"></a><span id="l40.54" class="difflineplus">+    this._procFn = null;</span>
<a href="#l40.55"></a><span id="l40.55" class="difflineplus">+}</span>
<a href="#l40.56"></a><span id="l40.56" class="difflineplus">+</span>
<a href="#l40.57"></a><span id="l40.57" class="difflineplus">+/**</span>
<a href="#l40.58"></a><span id="l40.58" class="difflineplus">+ * Retrieve a queue based on an event. The event provided does not need to be in</span>
<a href="#l40.59"></a><span id="l40.59" class="difflineplus">+ * the queue.</span>
<a href="#l40.60"></a><span id="l40.60" class="difflineplus">+ * @param {MatrixEvent} event An event to get the queue for.</span>
<a href="#l40.61"></a><span id="l40.61" class="difflineplus">+ * @return {?Array&lt;MatrixEvent&gt;} A shallow copy of events in the queue or null.</span>
<a href="#l40.62"></a><span id="l40.62" class="difflineplus">+ * Modifying this array will not modify the list itself. Modifying events in</span>
<a href="#l40.63"></a><span id="l40.63" class="difflineplus">+ * this array &lt;i&gt;will&lt;/i&gt; modify the underlying event in the queue.</span>
<a href="#l40.64"></a><span id="l40.64" class="difflineplus">+ * @see MatrixScheduler.removeEventFromQueue To remove an event from the queue.</span>
<a href="#l40.65"></a><span id="l40.65" class="difflineplus">+ */</span>
<a href="#l40.66"></a><span id="l40.66" class="difflineplus">+MatrixScheduler.prototype.getQueueForEvent = function(event) {</span>
<a href="#l40.67"></a><span id="l40.67" class="difflineplus">+    var name = this.queueAlgorithm(event);</span>
<a href="#l40.68"></a><span id="l40.68" class="difflineplus">+    if (!name || !this._queues[name]) {</span>
<a href="#l40.69"></a><span id="l40.69" class="difflineplus">+        return null;</span>
<a href="#l40.70"></a><span id="l40.70" class="difflineplus">+    }</span>
<a href="#l40.71"></a><span id="l40.71" class="difflineplus">+    return utils.map(this._queues[name], function(obj) {</span>
<a href="#l40.72"></a><span id="l40.72" class="difflineplus">+        return obj.event;</span>
<a href="#l40.73"></a><span id="l40.73" class="difflineplus">+    });</span>
<a href="#l40.74"></a><span id="l40.74" class="difflineplus">+};</span>
<a href="#l40.75"></a><span id="l40.75" class="difflineplus">+</span>
<a href="#l40.76"></a><span id="l40.76" class="difflineplus">+/**</span>
<a href="#l40.77"></a><span id="l40.77" class="difflineplus">+ * Remove this event from the queue. The event is equal to another event if they</span>
<a href="#l40.78"></a><span id="l40.78" class="difflineplus">+ * have the same ID returned from event.getId().</span>
<a href="#l40.79"></a><span id="l40.79" class="difflineplus">+ * @param {MatrixEvent} event The event to remove.</span>
<a href="#l40.80"></a><span id="l40.80" class="difflineplus">+ * @return {boolean} True if this event was removed.</span>
<a href="#l40.81"></a><span id="l40.81" class="difflineplus">+ */</span>
<a href="#l40.82"></a><span id="l40.82" class="difflineplus">+MatrixScheduler.prototype.removeEventFromQueue = function(event) {</span>
<a href="#l40.83"></a><span id="l40.83" class="difflineplus">+    var name = this.queueAlgorithm(event);</span>
<a href="#l40.84"></a><span id="l40.84" class="difflineplus">+    if (!name || !this._queues[name]) {</span>
<a href="#l40.85"></a><span id="l40.85" class="difflineplus">+        return false;</span>
<a href="#l40.86"></a><span id="l40.86" class="difflineplus">+    }</span>
<a href="#l40.87"></a><span id="l40.87" class="difflineplus">+    var removed = false;</span>
<a href="#l40.88"></a><span id="l40.88" class="difflineplus">+    utils.removeElement(this._queues[name], function(element) {</span>
<a href="#l40.89"></a><span id="l40.89" class="difflineplus">+        if (element.event.getId() === event.getId()) {</span>
<a href="#l40.90"></a><span id="l40.90" class="difflineplus">+            removed = true;</span>
<a href="#l40.91"></a><span id="l40.91" class="difflineplus">+            return true;</span>
<a href="#l40.92"></a><span id="l40.92" class="difflineplus">+        }</span>
<a href="#l40.93"></a><span id="l40.93" class="difflineplus">+    });</span>
<a href="#l40.94"></a><span id="l40.94" class="difflineplus">+    return removed;</span>
<a href="#l40.95"></a><span id="l40.95" class="difflineplus">+};</span>
<a href="#l40.96"></a><span id="l40.96" class="difflineplus">+</span>
<a href="#l40.97"></a><span id="l40.97" class="difflineplus">+</span>
<a href="#l40.98"></a><span id="l40.98" class="difflineplus">+/**</span>
<a href="#l40.99"></a><span id="l40.99" class="difflineplus">+ * Set the process function. Required for events in the queue to be processed.</span>
<a href="#l40.100"></a><span id="l40.100" class="difflineplus">+ * If set after events have been added to the queue, this will immediately start</span>
<a href="#l40.101"></a><span id="l40.101" class="difflineplus">+ * processing them.</span>
<a href="#l40.102"></a><span id="l40.102" class="difflineplus">+ * @param {module:scheduler~processFn} fn The function that can process events</span>
<a href="#l40.103"></a><span id="l40.103" class="difflineplus">+ * in the queue.</span>
<a href="#l40.104"></a><span id="l40.104" class="difflineplus">+ */</span>
<a href="#l40.105"></a><span id="l40.105" class="difflineplus">+MatrixScheduler.prototype.setProcessFunction = function(fn) {</span>
<a href="#l40.106"></a><span id="l40.106" class="difflineplus">+    this._procFn = fn;</span>
<a href="#l40.107"></a><span id="l40.107" class="difflineplus">+    _startProcessingQueues(this);</span>
<a href="#l40.108"></a><span id="l40.108" class="difflineplus">+};</span>
<a href="#l40.109"></a><span id="l40.109" class="difflineplus">+</span>
<a href="#l40.110"></a><span id="l40.110" class="difflineplus">+/**</span>
<a href="#l40.111"></a><span id="l40.111" class="difflineplus">+ * Queue an event if it is required and start processing queues.</span>
<a href="#l40.112"></a><span id="l40.112" class="difflineplus">+ * @param {MatrixEvent} event The event that may be queued.</span>
<a href="#l40.113"></a><span id="l40.113" class="difflineplus">+ * @return {?Promise} A promise if the event was queued, which will be</span>
<a href="#l40.114"></a><span id="l40.114" class="difflineplus">+ * resolved or rejected in due time, else null.</span>
<a href="#l40.115"></a><span id="l40.115" class="difflineplus">+ */</span>
<a href="#l40.116"></a><span id="l40.116" class="difflineplus">+MatrixScheduler.prototype.queueEvent = function(event) {</span>
<a href="#l40.117"></a><span id="l40.117" class="difflineplus">+    var queueName = this.queueAlgorithm(event);</span>
<a href="#l40.118"></a><span id="l40.118" class="difflineplus">+    if (!queueName) {</span>
<a href="#l40.119"></a><span id="l40.119" class="difflineplus">+        return null;</span>
<a href="#l40.120"></a><span id="l40.120" class="difflineplus">+    }</span>
<a href="#l40.121"></a><span id="l40.121" class="difflineplus">+    // add the event to the queue and make a deferred for it.</span>
<a href="#l40.122"></a><span id="l40.122" class="difflineplus">+    if (!this._queues[queueName]) {</span>
<a href="#l40.123"></a><span id="l40.123" class="difflineplus">+        this._queues[queueName] = [];</span>
<a href="#l40.124"></a><span id="l40.124" class="difflineplus">+    }</span>
<a href="#l40.125"></a><span id="l40.125" class="difflineplus">+    var defer = q.defer();</span>
<a href="#l40.126"></a><span id="l40.126" class="difflineplus">+    this._queues[queueName].push({</span>
<a href="#l40.127"></a><span id="l40.127" class="difflineplus">+        event: event,</span>
<a href="#l40.128"></a><span id="l40.128" class="difflineplus">+        defer: defer,</span>
<a href="#l40.129"></a><span id="l40.129" class="difflineplus">+        attempts: 0</span>
<a href="#l40.130"></a><span id="l40.130" class="difflineplus">+    });</span>
<a href="#l40.131"></a><span id="l40.131" class="difflineplus">+    debuglog(</span>
<a href="#l40.132"></a><span id="l40.132" class="difflineplus">+        &quot;Queue algorithm dumped event %s into queue '%s'&quot;,</span>
<a href="#l40.133"></a><span id="l40.133" class="difflineplus">+        event.getId(), queueName</span>
<a href="#l40.134"></a><span id="l40.134" class="difflineplus">+    );</span>
<a href="#l40.135"></a><span id="l40.135" class="difflineplus">+    _startProcessingQueues(this);</span>
<a href="#l40.136"></a><span id="l40.136" class="difflineplus">+    return defer.promise;</span>
<a href="#l40.137"></a><span id="l40.137" class="difflineplus">+};</span>
<a href="#l40.138"></a><span id="l40.138" class="difflineplus">+</span>
<a href="#l40.139"></a><span id="l40.139" class="difflineplus">+/**</span>
<a href="#l40.140"></a><span id="l40.140" class="difflineplus">+ * Retries events up to 4 times using exponential backoff. This produces wait</span>
<a href="#l40.141"></a><span id="l40.141" class="difflineplus">+ * times of 2, 4, 8, and 16 seconds (30s total) after which we give up. If the</span>
<a href="#l40.142"></a><span id="l40.142" class="difflineplus">+ * failure was due to a rate limited request, the time specified in the error is</span>
<a href="#l40.143"></a><span id="l40.143" class="difflineplus">+ * waited before being retried.</span>
<a href="#l40.144"></a><span id="l40.144" class="difflineplus">+ * @param {MatrixEvent} event</span>
<a href="#l40.145"></a><span id="l40.145" class="difflineplus">+ * @param {Number} attempts</span>
<a href="#l40.146"></a><span id="l40.146" class="difflineplus">+ * @param {MatrixError} err</span>
<a href="#l40.147"></a><span id="l40.147" class="difflineplus">+ * @return {Number}</span>
<a href="#l40.148"></a><span id="l40.148" class="difflineplus">+ * @see module:scheduler~retryAlgorithm</span>
<a href="#l40.149"></a><span id="l40.149" class="difflineplus">+ */</span>
<a href="#l40.150"></a><span id="l40.150" class="difflineplus">+MatrixScheduler.RETRY_BACKOFF_RATELIMIT = function(event, attempts, err) {</span>
<a href="#l40.151"></a><span id="l40.151" class="difflineplus">+    if (err.httpStatus === 400 || err.httpStatus === 403 || err.httpStatus === 401) {</span>
<a href="#l40.152"></a><span id="l40.152" class="difflineplus">+        // client error; no amount of retrying with save you now.</span>
<a href="#l40.153"></a><span id="l40.153" class="difflineplus">+        return -1;</span>
<a href="#l40.154"></a><span id="l40.154" class="difflineplus">+    }</span>
<a href="#l40.155"></a><span id="l40.155" class="difflineplus">+    // we ship with browser-request which returns { cors: rejected } when trying</span>
<a href="#l40.156"></a><span id="l40.156" class="difflineplus">+    // with no connection, so if we match that, give up since they have no conn.</span>
<a href="#l40.157"></a><span id="l40.157" class="difflineplus">+    if (err.cors === &quot;rejected&quot;) {</span>
<a href="#l40.158"></a><span id="l40.158" class="difflineplus">+        return -1;</span>
<a href="#l40.159"></a><span id="l40.159" class="difflineplus">+    }</span>
<a href="#l40.160"></a><span id="l40.160" class="difflineplus">+</span>
<a href="#l40.161"></a><span id="l40.161" class="difflineplus">+    if (err.name === &quot;M_LIMIT_EXCEEDED&quot;) {</span>
<a href="#l40.162"></a><span id="l40.162" class="difflineplus">+        var waitTime = err.data.retry_after_ms;</span>
<a href="#l40.163"></a><span id="l40.163" class="difflineplus">+        if (waitTime) {</span>
<a href="#l40.164"></a><span id="l40.164" class="difflineplus">+            return waitTime;</span>
<a href="#l40.165"></a><span id="l40.165" class="difflineplus">+        }</span>
<a href="#l40.166"></a><span id="l40.166" class="difflineplus">+    }</span>
<a href="#l40.167"></a><span id="l40.167" class="difflineplus">+    if (attempts &gt; 4) {</span>
<a href="#l40.168"></a><span id="l40.168" class="difflineplus">+        return -1; // give up</span>
<a href="#l40.169"></a><span id="l40.169" class="difflineplus">+    }</span>
<a href="#l40.170"></a><span id="l40.170" class="difflineplus">+    return (1000 * Math.pow(2, attempts));</span>
<a href="#l40.171"></a><span id="l40.171" class="difflineplus">+};</span>
<a href="#l40.172"></a><span id="l40.172" class="difflineplus">+</span>
<a href="#l40.173"></a><span id="l40.173" class="difflineplus">+/**</span>
<a href="#l40.174"></a><span id="l40.174" class="difflineplus">+ * Queues &lt;code&gt;m.room.message&lt;/code&gt; events and lets other events continue</span>
<a href="#l40.175"></a><span id="l40.175" class="difflineplus">+ * concurrently.</span>
<a href="#l40.176"></a><span id="l40.176" class="difflineplus">+ * @param {MatrixEvent} event</span>
<a href="#l40.177"></a><span id="l40.177" class="difflineplus">+ * @return {string}</span>
<a href="#l40.178"></a><span id="l40.178" class="difflineplus">+ * @see module:scheduler~queueAlgorithm</span>
<a href="#l40.179"></a><span id="l40.179" class="difflineplus">+ */</span>
<a href="#l40.180"></a><span id="l40.180" class="difflineplus">+MatrixScheduler.QUEUE_MESSAGES = function(event) {</span>
<a href="#l40.181"></a><span id="l40.181" class="difflineplus">+    if (event.getType() === &quot;m.room.message&quot;) {</span>
<a href="#l40.182"></a><span id="l40.182" class="difflineplus">+        // put these events in the 'message' queue.</span>
<a href="#l40.183"></a><span id="l40.183" class="difflineplus">+        return &quot;message&quot;;</span>
<a href="#l40.184"></a><span id="l40.184" class="difflineplus">+    }</span>
<a href="#l40.185"></a><span id="l40.185" class="difflineplus">+    // allow all other events continue concurrently.</span>
<a href="#l40.186"></a><span id="l40.186" class="difflineplus">+    return null;</span>
<a href="#l40.187"></a><span id="l40.187" class="difflineplus">+};</span>
<a href="#l40.188"></a><span id="l40.188" class="difflineplus">+</span>
<a href="#l40.189"></a><span id="l40.189" class="difflineplus">+function _startProcessingQueues(scheduler) {</span>
<a href="#l40.190"></a><span id="l40.190" class="difflineplus">+    if (!scheduler._procFn) {</span>
<a href="#l40.191"></a><span id="l40.191" class="difflineplus">+        return;</span>
<a href="#l40.192"></a><span id="l40.192" class="difflineplus">+    }</span>
<a href="#l40.193"></a><span id="l40.193" class="difflineplus">+    // for each inactive queue with events in them</span>
<a href="#l40.194"></a><span id="l40.194" class="difflineplus">+    utils.forEach(utils.filter(utils.keys(scheduler._queues), function(queueName) {</span>
<a href="#l40.195"></a><span id="l40.195" class="difflineplus">+        return scheduler._activeQueues.indexOf(queueName) === -1 &amp;&amp;</span>
<a href="#l40.196"></a><span id="l40.196" class="difflineplus">+                scheduler._queues[queueName].length &gt; 0;</span>
<a href="#l40.197"></a><span id="l40.197" class="difflineplus">+    }), function(queueName) {</span>
<a href="#l40.198"></a><span id="l40.198" class="difflineplus">+        // mark the queue as active</span>
<a href="#l40.199"></a><span id="l40.199" class="difflineplus">+        scheduler._activeQueues.push(queueName);</span>
<a href="#l40.200"></a><span id="l40.200" class="difflineplus">+        // begin processing the head of the queue</span>
<a href="#l40.201"></a><span id="l40.201" class="difflineplus">+        debuglog(&quot;Spinning up queue: '%s'&quot;, queueName);</span>
<a href="#l40.202"></a><span id="l40.202" class="difflineplus">+        _processQueue(scheduler, queueName);</span>
<a href="#l40.203"></a><span id="l40.203" class="difflineplus">+    });</span>
<a href="#l40.204"></a><span id="l40.204" class="difflineplus">+}</span>
<a href="#l40.205"></a><span id="l40.205" class="difflineplus">+</span>
<a href="#l40.206"></a><span id="l40.206" class="difflineplus">+function _processQueue(scheduler, queueName) {</span>
<a href="#l40.207"></a><span id="l40.207" class="difflineplus">+    // get head of queue</span>
<a href="#l40.208"></a><span id="l40.208" class="difflineplus">+    var obj = _peekNextEvent(scheduler, queueName);</span>
<a href="#l40.209"></a><span id="l40.209" class="difflineplus">+    if (!obj) {</span>
<a href="#l40.210"></a><span id="l40.210" class="difflineplus">+        // queue is empty. Mark as inactive and stop recursing.</span>
<a href="#l40.211"></a><span id="l40.211" class="difflineplus">+        var index = scheduler._activeQueues.indexOf(queueName);</span>
<a href="#l40.212"></a><span id="l40.212" class="difflineplus">+        if (index &gt;= 0) {</span>
<a href="#l40.213"></a><span id="l40.213" class="difflineplus">+            scheduler._activeQueues.splice(index, 1);</span>
<a href="#l40.214"></a><span id="l40.214" class="difflineplus">+        }</span>
<a href="#l40.215"></a><span id="l40.215" class="difflineplus">+        debuglog(&quot;Stopping queue '%s' as it is now empty&quot;, queueName);</span>
<a href="#l40.216"></a><span id="l40.216" class="difflineplus">+        return;</span>
<a href="#l40.217"></a><span id="l40.217" class="difflineplus">+    }</span>
<a href="#l40.218"></a><span id="l40.218" class="difflineplus">+    debuglog(</span>
<a href="#l40.219"></a><span id="l40.219" class="difflineplus">+        &quot;Queue '%s' has %s pending events&quot;,</span>
<a href="#l40.220"></a><span id="l40.220" class="difflineplus">+        queueName, scheduler._queues[queueName].length</span>
<a href="#l40.221"></a><span id="l40.221" class="difflineplus">+    );</span>
<a href="#l40.222"></a><span id="l40.222" class="difflineplus">+    // fire the process function and if it resolves, resolve the deferred. Else</span>
<a href="#l40.223"></a><span id="l40.223" class="difflineplus">+    // invoke the retry algorithm.</span>
<a href="#l40.224"></a><span id="l40.224" class="difflineplus">+    scheduler._procFn(obj.event).done(function(res) {</span>
<a href="#l40.225"></a><span id="l40.225" class="difflineplus">+        // remove this from the queue</span>
<a href="#l40.226"></a><span id="l40.226" class="difflineplus">+        _removeNextEvent(scheduler, queueName);</span>
<a href="#l40.227"></a><span id="l40.227" class="difflineplus">+        debuglog(&quot;Queue '%s' sent event %s&quot;, queueName, obj.event.getId());</span>
<a href="#l40.228"></a><span id="l40.228" class="difflineplus">+        obj.defer.resolve(res);</span>
<a href="#l40.229"></a><span id="l40.229" class="difflineplus">+        // keep processing</span>
<a href="#l40.230"></a><span id="l40.230" class="difflineplus">+        _processQueue(scheduler, queueName);</span>
<a href="#l40.231"></a><span id="l40.231" class="difflineplus">+    }, function(err) {</span>
<a href="#l40.232"></a><span id="l40.232" class="difflineplus">+        obj.attempts += 1;</span>
<a href="#l40.233"></a><span id="l40.233" class="difflineplus">+        // ask the retry algorithm when/if we should try again</span>
<a href="#l40.234"></a><span id="l40.234" class="difflineplus">+        var waitTimeMs = scheduler.retryAlgorithm(obj.event, obj.attempts, err);</span>
<a href="#l40.235"></a><span id="l40.235" class="difflineplus">+        debuglog(</span>
<a href="#l40.236"></a><span id="l40.236" class="difflineplus">+            &quot;retry(%s) err=%s event_id=%s waitTime=%s&quot;,</span>
<a href="#l40.237"></a><span id="l40.237" class="difflineplus">+            obj.attempts, err, obj.event.getId(), waitTimeMs</span>
<a href="#l40.238"></a><span id="l40.238" class="difflineplus">+        );</span>
<a href="#l40.239"></a><span id="l40.239" class="difflineplus">+        if (waitTimeMs === -1) {  // give up (you quitter!)</span>
<a href="#l40.240"></a><span id="l40.240" class="difflineplus">+            debuglog(</span>
<a href="#l40.241"></a><span id="l40.241" class="difflineplus">+                &quot;Queue '%s' giving up on event %s&quot;, queueName, obj.event.getId()</span>
<a href="#l40.242"></a><span id="l40.242" class="difflineplus">+            );</span>
<a href="#l40.243"></a><span id="l40.243" class="difflineplus">+            // remove this from the queue</span>
<a href="#l40.244"></a><span id="l40.244" class="difflineplus">+            _removeNextEvent(scheduler, queueName);</span>
<a href="#l40.245"></a><span id="l40.245" class="difflineplus">+            obj.defer.reject(err);</span>
<a href="#l40.246"></a><span id="l40.246" class="difflineplus">+            // process next event</span>
<a href="#l40.247"></a><span id="l40.247" class="difflineplus">+            _processQueue(scheduler, queueName);</span>
<a href="#l40.248"></a><span id="l40.248" class="difflineplus">+        }</span>
<a href="#l40.249"></a><span id="l40.249" class="difflineplus">+        else {</span>
<a href="#l40.250"></a><span id="l40.250" class="difflineplus">+            setTimeout(function() {</span>
<a href="#l40.251"></a><span id="l40.251" class="difflineplus">+                _processQueue(scheduler, queueName);</span>
<a href="#l40.252"></a><span id="l40.252" class="difflineplus">+            }, waitTimeMs);</span>
<a href="#l40.253"></a><span id="l40.253" class="difflineplus">+        }</span>
<a href="#l40.254"></a><span id="l40.254" class="difflineplus">+    });</span>
<a href="#l40.255"></a><span id="l40.255" class="difflineplus">+}</span>
<a href="#l40.256"></a><span id="l40.256" class="difflineplus">+</span>
<a href="#l40.257"></a><span id="l40.257" class="difflineplus">+function _peekNextEvent(scheduler, queueName) {</span>
<a href="#l40.258"></a><span id="l40.258" class="difflineplus">+    var queue = scheduler._queues[queueName];</span>
<a href="#l40.259"></a><span id="l40.259" class="difflineplus">+    if (!utils.isArray(queue)) {</span>
<a href="#l40.260"></a><span id="l40.260" class="difflineplus">+        return null;</span>
<a href="#l40.261"></a><span id="l40.261" class="difflineplus">+    }</span>
<a href="#l40.262"></a><span id="l40.262" class="difflineplus">+    return queue[0];</span>
<a href="#l40.263"></a><span id="l40.263" class="difflineplus">+}</span>
<a href="#l40.264"></a><span id="l40.264" class="difflineplus">+</span>
<a href="#l40.265"></a><span id="l40.265" class="difflineplus">+function _removeNextEvent(scheduler, queueName) {</span>
<a href="#l40.266"></a><span id="l40.266" class="difflineplus">+    var queue = scheduler._queues[queueName];</span>
<a href="#l40.267"></a><span id="l40.267" class="difflineplus">+    if (!utils.isArray(queue)) {</span>
<a href="#l40.268"></a><span id="l40.268" class="difflineplus">+        return null;</span>
<a href="#l40.269"></a><span id="l40.269" class="difflineplus">+    }</span>
<a href="#l40.270"></a><span id="l40.270" class="difflineplus">+    return queue.shift();</span>
<a href="#l40.271"></a><span id="l40.271" class="difflineplus">+}</span>
<a href="#l40.272"></a><span id="l40.272" class="difflineplus">+</span>
<a href="#l40.273"></a><span id="l40.273" class="difflineplus">+function debuglog() {</span>
<a href="#l40.274"></a><span id="l40.274" class="difflineplus">+    if (DEBUG) {</span>
<a href="#l40.275"></a><span id="l40.275" class="difflineplus">+        console.log.apply(console, arguments);</span>
<a href="#l40.276"></a><span id="l40.276" class="difflineplus">+    }</span>
<a href="#l40.277"></a><span id="l40.277" class="difflineplus">+}</span>
<a href="#l40.278"></a><span id="l40.278" class="difflineplus">+</span>
<a href="#l40.279"></a><span id="l40.279" class="difflineplus">+/**</span>
<a href="#l40.280"></a><span id="l40.280" class="difflineplus">+ * The retry algorithm to apply when retrying events. To stop retrying, return</span>
<a href="#l40.281"></a><span id="l40.281" class="difflineplus">+ * &lt;code&gt;-1&lt;/code&gt;. If this event was part of a queue, it will be removed from</span>
<a href="#l40.282"></a><span id="l40.282" class="difflineplus">+ * the queue.</span>
<a href="#l40.283"></a><span id="l40.283" class="difflineplus">+ * @callback retryAlgorithm</span>
<a href="#l40.284"></a><span id="l40.284" class="difflineplus">+ * @param {MatrixEvent} event The event being retried.</span>
<a href="#l40.285"></a><span id="l40.285" class="difflineplus">+ * @param {Number} attempts The number of failed attempts. This will always be</span>
<a href="#l40.286"></a><span id="l40.286" class="difflineplus">+ * &gt;= 1.</span>
<a href="#l40.287"></a><span id="l40.287" class="difflineplus">+ * @param {MatrixError} err The most recent error message received when trying</span>
<a href="#l40.288"></a><span id="l40.288" class="difflineplus">+ * to send this event.</span>
<a href="#l40.289"></a><span id="l40.289" class="difflineplus">+ * @return {Number} The number of milliseconds to wait before trying again. If</span>
<a href="#l40.290"></a><span id="l40.290" class="difflineplus">+ * this is 0, the request will be immediately retried. If this is</span>
<a href="#l40.291"></a><span id="l40.291" class="difflineplus">+ * &lt;code&gt;-1&lt;/code&gt;, the event will be marked as</span>
<a href="#l40.292"></a><span id="l40.292" class="difflineplus">+ * {@link module:models/event.EventStatus.NOT_SENT} and will not be retried.</span>
<a href="#l40.293"></a><span id="l40.293" class="difflineplus">+ */</span>
<a href="#l40.294"></a><span id="l40.294" class="difflineplus">+</span>
<a href="#l40.295"></a><span id="l40.295" class="difflineplus">+/**</span>
<a href="#l40.296"></a><span id="l40.296" class="difflineplus">+ * The queuing algorithm to apply to events. This function must be idempotent as</span>
<a href="#l40.297"></a><span id="l40.297" class="difflineplus">+ * it may be called multiple times with the same event. All queues created are</span>
<a href="#l40.298"></a><span id="l40.298" class="difflineplus">+ * serviced in a FIFO manner. To send the event ASAP, return &lt;code&gt;null&lt;/code&gt;</span>
<a href="#l40.299"></a><span id="l40.299" class="difflineplus">+ * which will not put this event in a queue. Events that fail to send that form</span>
<a href="#l40.300"></a><span id="l40.300" class="difflineplus">+ * part of a queue will be removed from the queue and the next event in the</span>
<a href="#l40.301"></a><span id="l40.301" class="difflineplus">+ * queue will be sent.</span>
<a href="#l40.302"></a><span id="l40.302" class="difflineplus">+ * @callback queueAlgorithm</span>
<a href="#l40.303"></a><span id="l40.303" class="difflineplus">+ * @param {MatrixEvent} event The event to be sent.</span>
<a href="#l40.304"></a><span id="l40.304" class="difflineplus">+ * @return {string} The name of the queue to put the event into. If a queue with</span>
<a href="#l40.305"></a><span id="l40.305" class="difflineplus">+ * this name does not exist, it will be created. If this is &lt;code&gt;null&lt;/code&gt;,</span>
<a href="#l40.306"></a><span id="l40.306" class="difflineplus">+ * the event is not put into a queue and will be sent concurrently.</span>
<a href="#l40.307"></a><span id="l40.307" class="difflineplus">+ */</span>
<a href="#l40.308"></a><span id="l40.308" class="difflineplus">+</span>
<a href="#l40.309"></a><span id="l40.309" class="difflineplus">+ /**</span>
<a href="#l40.310"></a><span id="l40.310" class="difflineplus">+ * The function to invoke to process (send) events in the queue.</span>
<a href="#l40.311"></a><span id="l40.311" class="difflineplus">+ * @callback processFn</span>
<a href="#l40.312"></a><span id="l40.312" class="difflineplus">+ * @param {MatrixEvent} event The event to send.</span>
<a href="#l40.313"></a><span id="l40.313" class="difflineplus">+ * @return {Promise} Resolved/rejected depending on the outcome of the request.</span>
<a href="#l40.314"></a><span id="l40.314" class="difflineplus">+ */</span>
<a href="#l40.315"></a><span id="l40.315" class="difflineplus">+</span>
<a href="#l40.316"></a><span id="l40.316" class="difflineplus">+/**</span>
<a href="#l40.317"></a><span id="l40.317" class="difflineplus">+ * The MatrixScheduler class.</span>
<a href="#l40.318"></a><span id="l40.318" class="difflineplus">+ */</span>
<a href="#l40.319"></a><span id="l40.319" class="difflineplus">+module.exports = MatrixScheduler;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l41.1"></a><span id="l41.1">new file mode 100644</span>
<a href="#l41.2"></a><span id="l41.2" class="difflineminus">--- /dev/null</span>
<a href="#l41.3"></a><span id="l41.3" class="difflineplus">+++ b/chat/protocols/matrix/matrix-sdk/store/memory.js</span>
<a href="#l41.4"></a><span id="l41.4" class="difflineat">@@ -0,0 +1,284 @@</span>
<a href="#l41.5"></a><span id="l41.5" class="difflineplus">+/*</span>
<a href="#l41.6"></a><span id="l41.6" class="difflineplus">+Copyright 2015, 2016 OpenMarket Ltd</span>
<a href="#l41.7"></a><span id="l41.7" class="difflineplus">+</span>
<a href="#l41.8"></a><span id="l41.8" class="difflineplus">+Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<a href="#l41.9"></a><span id="l41.9" class="difflineplus">+you may not use this file except in compliance with the License.</span>
<a href="#l41.10"></a><span id="l41.10" class="difflineplus">+You may obtain a copy of the License at</span>
<a href="#l41.11"></a><span id="l41.11" class="difflineplus">+</span>
<a href="#l41.12"></a><span id="l41.12" class="difflineplus">+    http://www.apache.org/licenses/LICENSE-2.0</span>
<a href="#l41.13"></a><span id="l41.13" class="difflineplus">+</span>
<a href="#l41.14"></a><span id="l41.14" class="difflineplus">+Unless required by applicable law or agreed to in writing, software</span>
<a href="#l41.15"></a><span id="l41.15" class="difflineplus">+distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<a href="#l41.16"></a><span id="l41.16" class="difflineplus">+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<a href="#l41.17"></a><span id="l41.17" class="difflineplus">+See the License for the specific language governing permissions and</span>
<a href="#l41.18"></a><span id="l41.18" class="difflineplus">+limitations under the License.</span>
<a href="#l41.19"></a><span id="l41.19" class="difflineplus">+*/</span>
<a href="#l41.20"></a><span id="l41.20" class="difflineplus">+&quot;use strict&quot;;</span>
<a href="#l41.21"></a><span id="l41.21" class="difflineplus">+/**</span>
<a href="#l41.22"></a><span id="l41.22" class="difflineplus">+ * This is an internal module. See {@link MatrixInMemoryStore} for the public class.</span>
<a href="#l41.23"></a><span id="l41.23" class="difflineplus">+ * @module store/memory</span>
<a href="#l41.24"></a><span id="l41.24" class="difflineplus">+ */</span>
<a href="#l41.25"></a><span id="l41.25" class="difflineplus">+ var utils = require(&quot;../utils&quot;);</span>
<a href="#l41.26"></a><span id="l41.26" class="difflineplus">+ var User = require(&quot;../models/user&quot;);</span>
<a href="#l41.27"></a><span id="l41.27" class="difflineplus">+</span>
<a href="#l41.28"></a><span id="l41.28" class="difflineplus">+/**</span>
<a href="#l41.29"></a><span id="l41.29" class="difflineplus">+ * Construct a new in-memory data store for the Matrix Client.</span>
<a href="#l41.30"></a><span id="l41.30" class="difflineplus">+ * @constructor</span>
<a href="#l41.31"></a><span id="l41.31" class="difflineplus">+ * @param {Object=} opts Config options</span>
<a href="#l41.32"></a><span id="l41.32" class="difflineplus">+ * @param {LocalStorage} opts.localStorage The local storage instance to persist</span>
<a href="#l41.33"></a><span id="l41.33" class="difflineplus">+ * some forms of data such as tokens. Rooms will NOT be stored. See</span>
<a href="#l41.34"></a><span id="l41.34" class="difflineplus">+ * {@link WebStorageStore} to persist rooms.</span>
<a href="#l41.35"></a><span id="l41.35" class="difflineplus">+ */</span>
<a href="#l41.36"></a><span id="l41.36" class="difflineplus">+module.exports.MatrixInMemoryStore = function MatrixInMemoryStore(opts) {</span>
<a href="#l41.37"></a><span id="l41.37" class="difflineplus">+    opts = opts || {};</span>
<a href="#l41.38"></a><span id="l41.38" class="difflineplus">+    this.rooms = {</span>
<a href="#l41.39"></a><span id="l41.39" class="difflineplus">+        // roomId: Room</span>
<a href="#l41.40"></a><span id="l41.40" class="difflineplus">+    };</span>
<a href="#l41.41"></a><span id="l41.41" class="difflineplus">+    this.users = {</span>
<a href="#l41.42"></a><span id="l41.42" class="difflineplus">+        // userId: User</span>
<a href="#l41.43"></a><span id="l41.43" class="difflineplus">+    };</span>
<a href="#l41.44"></a><span id="l41.44" class="difflineplus">+    this.syncToken = null;</span>
<a href="#l41.45"></a><span id="l41.45" class="difflineplus">+    this.filters = {</span>
<a href="#l41.46"></a><span id="l41.46" class="difflineplus">+        // userId: {</span>
<a href="#l41.47"></a><span id="l41.47" class="difflineplus">+        //    filterId: Filter</span>
<a href="#l41.48"></a><span id="l41.48" class="difflineplus">+        // }</span>
<a href="#l41.49"></a><span id="l41.49" class="difflineplus">+    };</span>
<a href="#l41.50"></a><span id="l41.50" class="difflineplus">+    this.accountData = {</span>
<a href="#l41.51"></a><span id="l41.51" class="difflineplus">+        // type : content</span>
<a href="#l41.52"></a><span id="l41.52" class="difflineplus">+    };</span>
<a href="#l41.53"></a><span id="l41.53" class="difflineplus">+    this.localStorage = opts.localStorage;</span>
<a href="#l41.54"></a><span id="l41.54" class="difflineplus">+};</span>
<a href="#l41.55"></a><span id="l41.55" class="difflineplus">+</span>
<a href="#l41.56"></a><span id="l41.56" class="difflineplus">+module.exports.MatrixInMemoryStore.prototype = {</span>
<a href="#l41.57"></a><span id="l41.57" class="difflineplus">+</span>
<a href="#l41.58"></a><span id="l41.58" class="difflineplus">+    /**</span>
<a href="#l41.59"></a><span id="l41.59" class="difflineplus">+     * Retrieve the token to stream from.</span>
<a href="#l41.60"></a><span id="l41.60" class="difflineplus">+     * @return {string} The token or null.</span>
<a href="#l41.61"></a><span id="l41.61" class="difflineplus">+     */</span>
<a href="#l41.62"></a><span id="l41.62" class="difflineplus">+    getSyncToken: function() {</span>
<a href="#l41.63"></a><span id="l41.63" class="difflineplus">+        return this.syncToken;</span>
<a href="#l41.64"></a><span id="l41.64" class="difflineplus">+    },</span>
<a href="#l41.65"></a><span id="l41.65" class="difflineplus">+</span>
<a href="#l41.66"></a><span id="l41.66" class="difflineplus">+</span>
<a href="#l41.67"></a><span id="l41.67" class="difflineplus">+    /**</span>
<a href="#l41.68"></a><span id="l41.68" class="difflineplus">+     * Set the token to stream from.</span>
<a href="#l41.69"></a><span id="l41.69" class="difflineplus">+     * @param {string} token The token to stream from.</span>
<a href="#l41.70"></a><span id="l41.70" class="difflineplus">+     */</span>
<a href="#l41.71"></a><span id="l41.71" class="difflineplus">+    setSyncToken: function(token) {</span>
<a href="#l41.72"></a><span id="l41.72" class="difflineplus">+        this.syncToken = token;</span>
<a href="#l41.73"></a><span id="l41.73" class="difflineplus">+    },</span>
<a href="#l41.74"></a><span id="l41.74" class="difflineplus">+</span>
<a href="#l41.75"></a><span id="l41.75" class="difflineplus">+    /**</span>
<a href="#l41.76"></a><span id="l41.76" class="difflineplus">+     * Store the given room.</span>
<a href="#l41.77"></a><span id="l41.77" class="difflineplus">+     * @param {Room} room The room to be stored. All properties must be stored.</span>
<a href="#l41.78"></a><span id="l41.78" class="difflineplus">+     */</span>
<a href="#l41.79"></a><span id="l41.79" class="difflineplus">+    storeRoom: function(room) {</span>
<a href="#l41.80"></a><span id="l41.80" class="difflineplus">+        this.rooms[room.roomId] = room;</span>
<a href="#l41.81"></a><span id="l41.81" class="difflineplus">+        // add listeners for room member changes so we can keep the room member</span>
<a href="#l41.82"></a><span id="l41.82" class="difflineplus">+        // map up-to-date.</span>
<a href="#l41.83"></a><span id="l41.83" class="difflineplus">+        room.currentState.on(&quot;RoomState.members&quot;, this._onRoomMember.bind(this));</span>
<a href="#l41.84"></a><span id="l41.84" class="difflineplus">+        // add existing members</span>
<a href="#l41.85"></a><span id="l41.85" class="difflineplus">+        var self = this;</span>
<a href="#l41.86"></a><span id="l41.86" class="difflineplus">+        room.currentState.getMembers().forEach(function(m) {</span>
<a href="#l41.87"></a><span id="l41.87" class="difflineplus">+            self._onRoomMember(null, room.currentState, m);</span>
<a href="#l41.88"></a><span id="l41.88" class="difflineplus">+        });</span>
<a href="#l41.89"></a><span id="l41.89" class="difflineplus">+    },</span>
<a href="#l41.90"></a><span id="l41.90" class="difflineplus">+</span>
<a href="#l41.91"></a><span id="l41.91" class="difflineplus">+    /**</span>
<a href="#l41.92"></a><span id="l41.92" class="difflineplus">+     * Called when a room member in a room being tracked by this store has been</span>
<a href="#l41.93"></a><span id="l41.93" class="difflineplus">+     * updated.</span>
<a href="#l41.94"></a><span id="l41.94" class="difflineplus">+     * @param {MatrixEvent} event</span>
<a href="#l41.95"></a><span id="l41.95" class="difflineplus">+     * @param {RoomState} state</span>
<a href="#l41.96"></a><span id="l41.96" class="difflineplus">+     * @param {RoomMember} member</span>
<a href="#l41.97"></a><span id="l41.97" class="difflineplus">+     */</span>
<a href="#l41.98"></a><span id="l41.98" class="difflineplus">+    _onRoomMember: function(event, state, member) {</span>
<a href="#l41.99"></a><span id="l41.99" class="difflineplus">+        if (member.membership === &quot;invite&quot;) {</span>
<a href="#l41.100"></a><span id="l41.100" class="difflineplus">+            // We do NOT add invited members because people love to typo user IDs</span>
<a href="#l41.101"></a><span id="l41.101" class="difflineplus">+            // which would then show up in these lists (!)</span>
<a href="#l41.102"></a><span id="l41.102" class="difflineplus">+            return;</span>
<a href="#l41.103"></a><span id="l41.103" class="difflineplus">+        }</span>
<a href="#l41.104"></a><span id="l41.104" class="difflineplus">+</span>
<a href="#l41.105"></a><span id="l41.105" class="difflineplus">+        var user = this.users[member.userId] || new User(member.userId);</span>
<a href="#l41.106"></a><span id="l41.106" class="difflineplus">+        if (member.name) {</span>
<a href="#l41.107"></a><span id="l41.107" class="difflineplus">+            user.setDisplayName(member.name);</span>
<a href="#l41.108"></a><span id="l41.108" class="difflineplus">+            if (member.events.member) {</span>
<a href="#l41.109"></a><span id="l41.109" class="difflineplus">+                user.setRawDisplayName(</span>
<a href="#l41.110"></a><span id="l41.110" class="difflineplus">+                    member.events.member.getDirectionalContent().displayname</span>
<a href="#l41.111"></a><span id="l41.111" class="difflineplus">+                );</span>
<a href="#l41.112"></a><span id="l41.112" class="difflineplus">+            }</span>
<a href="#l41.113"></a><span id="l41.113" class="difflineplus">+        }</span>
<a href="#l41.114"></a><span id="l41.114" class="difflineplus">+        if (member.events.member &amp;&amp; member.events.member.getContent().avatar_url) {</span>
<a href="#l41.115"></a><span id="l41.115" class="difflineplus">+            user.setAvatarUrl(member.events.member.getContent().avatar_url);</span>
<a href="#l41.116"></a><span id="l41.116" class="difflineplus">+        }</span>
<a href="#l41.117"></a><span id="l41.117" class="difflineplus">+        this.users[user.userId] = user;</span>
<a href="#l41.118"></a><span id="l41.118" class="difflineplus">+    },</span>
<a href="#l41.119"></a><span id="l41.119" class="difflineplus">+</span>
<a href="#l41.120"></a><span id="l41.120" class="difflineplus">+    /**</span>
<a href="#l41.121"></a><span id="l41.121" class="difflineplus">+     * Retrieve a room by its' room ID.</span>
<a href="#l41.122"></a><span id="l41.122" class="difflineplus">+     * @param {string} roomId The room ID.</span>
<a href="#l41.123"></a><span id="l41.123" class="difflineplus">+     * @return {Room} The room or null.</span>
<a href="#l41.124"></a><span id="l41.124" class="difflineplus">+     */</span>
<a href="#l41.125"></a><span id="l41.125" class="difflineplus">+    getRoom: function(roomId) {</span>
<a href="#l41.126"></a><span id="l41.126" class="difflineplus">+        return this.rooms[roomId] || null;</span>
<a href="#l41.127"></a><span id="l41.127" class="difflineplus">+    },</span>
<a href="#l41.128"></a><span id="l41.128" class="difflineplus">+</span>
<a href="#l41.129"></a><span id="l41.129" class="difflineplus">+    /**</span>
<a href="#l41.130"></a><span id="l41.130" class="difflineplus">+     * Retrieve all known rooms.</span>
<a href="#l41.131"></a><span id="l41.131" class="difflineplus">+     * @return {Room[]} A list of rooms, which may be empty.</span>
<a href="#l41.132"></a><span id="l41.132" class="difflineplus">+     */</span>
<a href="#l41.133"></a><span id="l41.133" class="difflineplus">+    getRooms: function() {</span>
<a href="#l41.134"></a><span id="l41.134" class="difflineplus">+        return utils.values(this.rooms);</span>
<a href="#l41.135"></a><span id="l41.135" class="difflineplus">+    },</span>
<a href="#l41.136"></a><span id="l41.136" class="difflineplus">+</span>
<a href="#l41.137"></a><span id="l41.137" class="difflineplus">+    /**</span>
<a href="#l41.138"></a><span id="l41.138" class="difflineplus">+     * Permanently delete a room.</span>
<a href="#l41.139"></a><span id="l41.139" class="difflineplus">+     * @param {string} roomId</span>
<a href="#l41.140"></a><span id="l41.140" class="difflineplus">+     */</span>
<a href="#l41.141"></a><span id="l41.141" class="difflineplus">+    removeRoom: function(roomId) {</span>
<a href="#l41.142"></a><span id="l41.142" class="difflineplus">+        if (this.rooms[roomId]) {</span>
<a href="#l41.143"></a><span id="l41.143" class="difflineplus">+            this.rooms[roomId].removeListener(&quot;RoomState.members&quot;, this._onRoomMember);</span>
<a href="#l41.144"></a><span id="l41.144" class="difflineplus">+        }</span>
<a href="#l41.145"></a><span id="l41.145" class="difflineplus">+        delete this.rooms[roomId];</span>
<a href="#l41.146"></a><span id="l41.146" class="difflineplus">+    },</span>
<a href="#l41.147"></a><span id="l41.147" class="difflineplus">+</span>
<a href="#l41.148"></a><span id="l41.148" class="difflineplus">+    /**</span>
<a href="#l41.149"></a><span id="l41.149" class="difflineplus">+     * Retrieve a summary of all the rooms.</span>
<a href="#l41.150"></a><span id="l41.150" class="difflineplus">+     * @return {RoomSummary[]} A summary of each room.</span>
<a href="#l41.151"></a><span id="l41.151" class="difflineplus">+     */</span>
<a href="#l41.152"></a><span id="l41.152" class="difflineplus">+    getRoomSummaries: function() {</span>
<a href="#l41.153"></a><span id="l41.153" class="difflineplus">+        return utils.map(utils.values(this.rooms), function(room) {</span>
<a href="#l41.154"></a><span id="l41.154" class="difflineplus">+            return room.summary;</span>
<a href="#l41.155"></a><span id="l41.155" class="difflineplus">+        });</span>
<a href="#l41.156"></a><span id="l41.156" class="difflineplus">+    },</span>
<a href="#l41.157"></a><span id="l41.157" class="difflineplus">+</span>
<a href="#l41.158"></a><span id="l41.158" class="difflineplus">+    /**</span>
<a href="#l41.159"></a><span id="l41.159" class="difflineplus">+     * Store a User.</span>
<a href="#l41.160"></a><span id="l41.160" class="difflineplus">+     * @param {User} user The user to store.</span>
<a href="#l41.161"></a><span id="l41.161" class="difflineplus">+     */</span>
<a href="#l41.162"></a><span id="l41.162" class="difflineplus">+    storeUser: function(user) {</span>
<a href="#l41.163"></a><span id="l41.163" class="difflineplus">+        this.users[user.userId] = user;</span>
<a href="#l41.164"></a><span id="l41.164" class="difflineplus">+    },</span>
<a href="#l41.165"></a><span id="l41.165" class="difflineplus">+</span>
<a href="#l41.166"></a><span id="l41.166" class="difflineplus">+    /**</span>
<a href="#l41.167"></a><span id="l41.167" class="difflineplus">+     * Retrieve a User by its' user ID.</span>
<a href="#l41.168"></a><span id="l41.168" class="difflineplus">+     * @param {string} userId The user ID.</span>
<a href="#l41.169"></a><span id="l41.169" class="difflineplus">+     * @return {User} The user or null.</span>
<a href="#l41.170"></a><span id="l41.170" class="difflineplus">+     */</span>
<a href="#l41.171"></a><span id="l41.171" class="difflineplus">+    getUser: function(userId) {</span>
<a href="#l41.172"></a><span id="l41.172" class="difflineplus">+        return this.users[userId] || null;</span>
<a href="#l41.173"></a><span id="l41.173" class="difflineplus">+    },</span>
<a href="#l41.174"></a><span id="l41.174" class="difflineplus">+</span>
<a href="#l41.175"></a><span id="l41.175" class="difflineplus">+    /**</span>
<a href="#l41.176"></a><span id="l41.176" class="difflineplus">+     * Retrieve all known users.</span>
<a href="#l41.177"></a><span id="l41.177" class="difflineplus">+     * @return {User[]} A list of users, which may be empty.</span>
<a href="#l41.178"></a><span id="l41.178" class="difflineplus">+     */</span>
<a href="#l41.179"></a><span id="l41.179" class="difflineplus">+    getUsers: function() {</span>
<a href="#l41.180"></a><span id="l41.180" class="difflineplus">+        return utils.values(this.users);</span>
<a href="#l41.181"></a><span id="l41.181" class="difflineplus">+    },</span>
<a href="#l41.182"></a><span id="l41.182" class="difflineplus">+</span>
<a href="#l41.183"></a><span id="l41.183" class="difflineplus">+    /**</span>
<a href="#l41.184"></a><span id="l41.184" class="difflineplus">+     * Retrieve scrollback for this room.</span>
<a href="#l41.185"></a><span id="l41.185" class="difflineplus">+     * @param {Room} room The matrix room</span>
<a href="#l41.186"></a><span id="l41.186" class="difflineplus">+     * @param {integer} limit The max number of old events to retrieve.</span>
<a href="#l41.187"></a><span id="l41.187" class="difflineplus">+     * @return {Array&lt;Object&gt;} An array of objects which will be at most 'limit'</span>
<a href="#l41.188"></a><span id="l41.188" class="difflineplus">+     * length and at least 0. The objects are the raw event JSON.</span>
<a href="#l41.189"></a><span id="l41.189" class="difflineplus">+     */</span>
<a href="#l41.190"></a><span id="l41.190" class="difflineplus">+    scrollback: function(room, limit) {</span>
<a href="#l41.191"></a><span id="l41.191" class="difflineplus">+        return [];</span>
<a href="#l41.192"></a><span id="l41.192" class="difflineplus">+    },</span>
<a href="#l41.193"></a><span id="l41.193" class="difflineplus">+</span>
<a href="#l41.194"></a><span id="l41.194" class="difflineplus">+    /**</span>
<a href="#l41.195"></a><span id="l41.195" class="difflineplus">+     * Store events for a room. The events have already been added to the timeline</span>
<a href="#l41.196"></a><span id="l41.196" class="difflineplus">+     * @param {Room} room The room to store events for.</span>
<a href="#l41.197"></a><span id="l41.197" class="difflineplus">+     * @param {Array&lt;MatrixEvent&gt;} events The events to store.</span>
<a href="#l41.198"></a><span id="l41.198" class="difflineplus">+     * @param {string} token The token associated with these events.</span>
<a href="#l41.199"></a><span id="l41.199" class="difflineplus">+     * @param {boolean} toStart True if these are paginated results.</span>
<a href="#l41.200"></a><span id="l41.200" class="difflineplus">+     */</span>
<a href="#l41.201"></a><span id="l41.201" class="difflineplus">+    storeEvents: function(room, events, token, toStart) {</span>
<a href="#l41.202"></a><span id="l41.202" class="difflineplus">+        // no-op because they've already been added to the room instance.</span>
<a href="#l41.203"></a><span id="l41.203" class="difflineplus">+    },</span>
<a href="#l41.204"></a><span id="l41.204" class="difflineplus">+</span>
<a href="#l41.205"></a><span id="l41.205" class="difflineplus">+    /**</span>
<a href="#l41.206"></a><span id="l41.206" class="difflineplus">+     * Store a filter.</span>
<a href="#l41.207"></a><span id="l41.207" class="difflineplus">+     * @param {Filter} filter</span>
<a href="#l41.208"></a><span id="l41.208" class="difflineplus">+     */</span>
<a href="#l41.209"></a><span id="l41.209" class="difflineplus">+    storeFilter: function(filter) {</span>
<a href="#l41.210"></a><span id="l41.210" class="difflineplus">+        if (!filter) { return; }</span>
<a href="#l41.211"></a><span id="l41.211" class="difflineplus">+        if (!this.filters[filter.userId]) {</span>
<a href="#l41.212"></a><span id="l41.212" class="difflineplus">+            this.filters[filter.userId] = {};</span>
<a href="#l41.213"></a><span id="l41.213" class="difflineplus">+        }</span>
<a href="#l41.214"></a><span id="l41.214" class="difflineplus">+        this.filters[filter.userId][filter.filterId] = filter;</span>
<a href="#l41.215"></a><span id="l41.215" class="difflineplus">+    },</span>
<a href="#l41.216"></a><span id="l41.216" class="difflineplus">+</span>
<a href="#l41.217"></a><span id="l41.217" class="difflineplus">+    /**</span>
<a href="#l41.218"></a><span id="l41.218" class="difflineplus">+     * Retrieve a filter.</span>
<a href="#l41.219"></a><span id="l41.219" class="difflineplus">+     * @param {string} userId</span>
<a href="#l41.220"></a><span id="l41.220" class="difflineplus">+     * @param {string} filterId</span>
<a href="#l41.221"></a><span id="l41.221" class="difflineplus">+     * @return {?Filter} A filter or null.</span>
<a href="#l41.222"></a><span id="l41.222" class="difflineplus">+     */</span>
<a href="#l41.223"></a><span id="l41.223" class="difflineplus">+    getFilter: function(userId, filterId) {</span>
<a href="#l41.224"></a><span id="l41.224" class="difflineplus">+        if (!this.filters[userId] || !this.filters[userId][filterId]) {</span>
<a href="#l41.225"></a><span id="l41.225" class="difflineplus">+            return null;</span>
<a href="#l41.226"></a><span id="l41.226" class="difflineplus">+        }</span>
<a href="#l41.227"></a><span id="l41.227" class="difflineplus">+        return this.filters[userId][filterId];</span>
<a href="#l41.228"></a><span id="l41.228" class="difflineplus">+    },</span>
<a href="#l41.229"></a><span id="l41.229" class="difflineplus">+</span>
<a href="#l41.230"></a><span id="l41.230" class="difflineplus">+    /**</span>
<a href="#l41.231"></a><span id="l41.231" class="difflineplus">+     * Retrieve a filter ID with the given name.</span>
<a href="#l41.232"></a><span id="l41.232" class="difflineplus">+     * @param {string} filterName The filter name.</span>
<a href="#l41.233"></a><span id="l41.233" class="difflineplus">+     * @return {?string} The filter ID or null.</span>
<a href="#l41.234"></a><span id="l41.234" class="difflineplus">+     */</span>
<a href="#l41.235"></a><span id="l41.235" class="difflineplus">+    getFilterIdByName: function(filterName) {</span>
<a href="#l41.236"></a><span id="l41.236" class="difflineplus">+        if (!this.localStorage) {</span>
<a href="#l41.237"></a><span id="l41.237" class="difflineplus">+            return null;</span>
<a href="#l41.238"></a><span id="l41.238" class="difflineplus">+        }</span>
<a href="#l41.239"></a><span id="l41.239" class="difflineplus">+        try {</span>
<a href="#l41.240"></a><span id="l41.240" class="difflineplus">+            return this.localStorage.getItem(&quot;mxjssdk_memory_filter_&quot; + filterName);</span>
<a href="#l41.241"></a><span id="l41.241" class="difflineplus">+        }</span>
<a href="#l41.242"></a><span id="l41.242" class="difflineplus">+        catch (e) {}</span>
<a href="#l41.243"></a><span id="l41.243" class="difflineplus">+        return null;</span>
<a href="#l41.244"></a><span id="l41.244" class="difflineplus">+    },</span>
<a href="#l41.245"></a><span id="l41.245" class="difflineplus">+</span>
<a href="#l41.246"></a><span id="l41.246" class="difflineplus">+    /**</span>
<a href="#l41.247"></a><span id="l41.247" class="difflineplus">+     * Set a filter name to ID mapping.</span>
<a href="#l41.248"></a><span id="l41.248" class="difflineplus">+     * @param {string} filterName</span>
<a href="#l41.249"></a><span id="l41.249" class="difflineplus">+     * @param {string} filterId</span>
<a href="#l41.250"></a><span id="l41.250" class="difflineplus">+     */</span>
<a href="#l41.251"></a><span id="l41.251" class="difflineplus">+    setFilterIdByName: function(filterName, filterId) {</span>
<a href="#l41.252"></a><span id="l41.252" class="difflineplus">+        if (!this.localStorage) {</span>
<a href="#l41.253"></a><span id="l41.253" class="difflineplus">+            return;</span>
<a href="#l41.254"></a><span id="l41.254" class="difflineplus">+        }</span>
<a href="#l41.255"></a><span id="l41.255" class="difflineplus">+        try {</span>
<a href="#l41.256"></a><span id="l41.256" class="difflineplus">+            this.localStorage.setItem(&quot;mxjssdk_memory_filter_&quot; + filterName, filterId);</span>
<a href="#l41.257"></a><span id="l41.257" class="difflineplus">+        }</span>
<a href="#l41.258"></a><span id="l41.258" class="difflineplus">+        catch (e) {}</span>
<a href="#l41.259"></a><span id="l41.259" class="difflineplus">+    },</span>
<a href="#l41.260"></a><span id="l41.260" class="difflineplus">+</span>
<a href="#l41.261"></a><span id="l41.261" class="difflineplus">+    /**</span>
<a href="#l41.262"></a><span id="l41.262" class="difflineplus">+     * Store user-scoped account data events.</span>
<a href="#l41.263"></a><span id="l41.263" class="difflineplus">+     * N.B. that account data only allows a single event per type, so multiple</span>
<a href="#l41.264"></a><span id="l41.264" class="difflineplus">+     * events with the same type will replace each other.</span>
<a href="#l41.265"></a><span id="l41.265" class="difflineplus">+     * @param {Array&lt;MatrixEvent&gt;} events The events to store.</span>
<a href="#l41.266"></a><span id="l41.266" class="difflineplus">+     */</span>
<a href="#l41.267"></a><span id="l41.267" class="difflineplus">+    storeAccountDataEvents: function(events) {</span>
<a href="#l41.268"></a><span id="l41.268" class="difflineplus">+        var self = this;</span>
<a href="#l41.269"></a><span id="l41.269" class="difflineplus">+        events.forEach(function(event) {</span>
<a href="#l41.270"></a><span id="l41.270" class="difflineplus">+            self.accountData[event.getType()] = event;</span>
<a href="#l41.271"></a><span id="l41.271" class="difflineplus">+        });</span>
<a href="#l41.272"></a><span id="l41.272" class="difflineplus">+    },</span>
<a href="#l41.273"></a><span id="l41.273" class="difflineplus">+</span>
<a href="#l41.274"></a><span id="l41.274" class="difflineplus">+    /**</span>
<a href="#l41.275"></a><span id="l41.275" class="difflineplus">+     * Get account data event by event type</span>
<a href="#l41.276"></a><span id="l41.276" class="difflineplus">+     * @param {string} eventType The event type being queried</span>
<a href="#l41.277"></a><span id="l41.277" class="difflineplus">+     * @return {?MatrixEvent} the user account_data event of given type, if any</span>
<a href="#l41.278"></a><span id="l41.278" class="difflineplus">+     */</span>
<a href="#l41.279"></a><span id="l41.279" class="difflineplus">+    getAccountData: function(eventType) {</span>
<a href="#l41.280"></a><span id="l41.280" class="difflineplus">+        return this.accountData[eventType];</span>
<a href="#l41.281"></a><span id="l41.281" class="difflineplus">+    },</span>
<a href="#l41.282"></a><span id="l41.282" class="difflineplus">+</span>
<a href="#l41.283"></a><span id="l41.283" class="difflineplus">+    // TODO</span>
<a href="#l41.284"></a><span id="l41.284" class="difflineplus">+    //setMaxHistoryPerRoom: function(maxHistory) {},</span>
<a href="#l41.285"></a><span id="l41.285" class="difflineplus">+</span>
<a href="#l41.286"></a><span id="l41.286" class="difflineplus">+    // TODO</span>
<a href="#l41.287"></a><span id="l41.287" class="difflineplus">+    //reapOldMessages: function() {},</span>
<a href="#l41.288"></a><span id="l41.288" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l42.1"></a><span id="l42.1">new file mode 100644</span>
<a href="#l42.2"></a><span id="l42.2" class="difflineminus">--- /dev/null</span>
<a href="#l42.3"></a><span id="l42.3" class="difflineplus">+++ b/chat/protocols/matrix/matrix-sdk/store/session/webstorage.js</span>
<a href="#l42.4"></a><span id="l42.4" class="difflineat">@@ -0,0 +1,193 @@</span>
<a href="#l42.5"></a><span id="l42.5" class="difflineplus">+/*</span>
<a href="#l42.6"></a><span id="l42.6" class="difflineplus">+Copyright 2015, 2016 OpenMarket Ltd</span>
<a href="#l42.7"></a><span id="l42.7" class="difflineplus">+</span>
<a href="#l42.8"></a><span id="l42.8" class="difflineplus">+Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<a href="#l42.9"></a><span id="l42.9" class="difflineplus">+you may not use this file except in compliance with the License.</span>
<a href="#l42.10"></a><span id="l42.10" class="difflineplus">+You may obtain a copy of the License at</span>
<a href="#l42.11"></a><span id="l42.11" class="difflineplus">+</span>
<a href="#l42.12"></a><span id="l42.12" class="difflineplus">+    http://www.apache.org/licenses/LICENSE-2.0</span>
<a href="#l42.13"></a><span id="l42.13" class="difflineplus">+</span>
<a href="#l42.14"></a><span id="l42.14" class="difflineplus">+Unless required by applicable law or agreed to in writing, software</span>
<a href="#l42.15"></a><span id="l42.15" class="difflineplus">+distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<a href="#l42.16"></a><span id="l42.16" class="difflineplus">+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<a href="#l42.17"></a><span id="l42.17" class="difflineplus">+See the License for the specific language governing permissions and</span>
<a href="#l42.18"></a><span id="l42.18" class="difflineplus">+limitations under the License.</span>
<a href="#l42.19"></a><span id="l42.19" class="difflineplus">+*/</span>
<a href="#l42.20"></a><span id="l42.20" class="difflineplus">+&quot;use strict&quot;;</span>
<a href="#l42.21"></a><span id="l42.21" class="difflineplus">+</span>
<a href="#l42.22"></a><span id="l42.22" class="difflineplus">+/**</span>
<a href="#l42.23"></a><span id="l42.23" class="difflineplus">+ * @module store/session/webstorage</span>
<a href="#l42.24"></a><span id="l42.24" class="difflineplus">+ */</span>
<a href="#l42.25"></a><span id="l42.25" class="difflineplus">+</span>
<a href="#l42.26"></a><span id="l42.26" class="difflineplus">+var utils = require(&quot;../../utils&quot;);</span>
<a href="#l42.27"></a><span id="l42.27" class="difflineplus">+</span>
<a href="#l42.28"></a><span id="l42.28" class="difflineplus">+var DEBUG = false;  // set true to enable console logging.</span>
<a href="#l42.29"></a><span id="l42.29" class="difflineplus">+var E2E_PREFIX = &quot;session.e2e.&quot;;</span>
<a href="#l42.30"></a><span id="l42.30" class="difflineplus">+</span>
<a href="#l42.31"></a><span id="l42.31" class="difflineplus">+/**</span>
<a href="#l42.32"></a><span id="l42.32" class="difflineplus">+ * Construct a web storage session store, capable of storing account keys,</span>
<a href="#l42.33"></a><span id="l42.33" class="difflineplus">+ * session keys and access tokens.</span>
<a href="#l42.34"></a><span id="l42.34" class="difflineplus">+ * @constructor</span>
<a href="#l42.35"></a><span id="l42.35" class="difflineplus">+ * @param {WebStorage} webStore A web storage implementation, e.g.</span>
<a href="#l42.36"></a><span id="l42.36" class="difflineplus">+ * 'window.localStorage' or 'window.sessionStorage' or a custom implementation.</span>
<a href="#l42.37"></a><span id="l42.37" class="difflineplus">+ * @throws if the supplied 'store' does not meet the Storage interface of the</span>
<a href="#l42.38"></a><span id="l42.38" class="difflineplus">+ * WebStorage API.</span>
<a href="#l42.39"></a><span id="l42.39" class="difflineplus">+ */</span>
<a href="#l42.40"></a><span id="l42.40" class="difflineplus">+function WebStorageSessionStore(webStore) {</span>
<a href="#l42.41"></a><span id="l42.41" class="difflineplus">+    this.store = webStore;</span>
<a href="#l42.42"></a><span id="l42.42" class="difflineplus">+    if (!utils.isFunction(webStore.getItem) ||</span>
<a href="#l42.43"></a><span id="l42.43" class="difflineplus">+        !utils.isFunction(webStore.setItem) ||</span>
<a href="#l42.44"></a><span id="l42.44" class="difflineplus">+        !utils.isFunction(webStore.removeItem)) {</span>
<a href="#l42.45"></a><span id="l42.45" class="difflineplus">+        throw new Error(</span>
<a href="#l42.46"></a><span id="l42.46" class="difflineplus">+            &quot;Supplied webStore does not meet the WebStorage API interface&quot;</span>
<a href="#l42.47"></a><span id="l42.47" class="difflineplus">+        );</span>
<a href="#l42.48"></a><span id="l42.48" class="difflineplus">+    }</span>
<a href="#l42.49"></a><span id="l42.49" class="difflineplus">+}</span>
<a href="#l42.50"></a><span id="l42.50" class="difflineplus">+</span>
<a href="#l42.51"></a><span id="l42.51" class="difflineplus">+WebStorageSessionStore.prototype = {</span>
<a href="#l42.52"></a><span id="l42.52" class="difflineplus">+</span>
<a href="#l42.53"></a><span id="l42.53" class="difflineplus">+    /**</span>
<a href="#l42.54"></a><span id="l42.54" class="difflineplus">+     * Store the end to end account for the logged-in user.</span>
<a href="#l42.55"></a><span id="l42.55" class="difflineplus">+     * @param {string} account Base64 encoded account.</span>
<a href="#l42.56"></a><span id="l42.56" class="difflineplus">+     */</span>
<a href="#l42.57"></a><span id="l42.57" class="difflineplus">+    storeEndToEndAccount: function(account) {</span>
<a href="#l42.58"></a><span id="l42.58" class="difflineplus">+        this.store.setItem(KEY_END_TO_END_ACCOUNT, account);</span>
<a href="#l42.59"></a><span id="l42.59" class="difflineplus">+    },</span>
<a href="#l42.60"></a><span id="l42.60" class="difflineplus">+</span>
<a href="#l42.61"></a><span id="l42.61" class="difflineplus">+    /**</span>
<a href="#l42.62"></a><span id="l42.62" class="difflineplus">+     * Load the end to end account for the logged-in user.</span>
<a href="#l42.63"></a><span id="l42.63" class="difflineplus">+     * @return {?string} Base64 encoded account.</span>
<a href="#l42.64"></a><span id="l42.64" class="difflineplus">+     */</span>
<a href="#l42.65"></a><span id="l42.65" class="difflineplus">+    getEndToEndAccount: function() {</span>
<a href="#l42.66"></a><span id="l42.66" class="difflineplus">+        return this.store.getItem(KEY_END_TO_END_ACCOUNT);</span>
<a href="#l42.67"></a><span id="l42.67" class="difflineplus">+    },</span>
<a href="#l42.68"></a><span id="l42.68" class="difflineplus">+</span>
<a href="#l42.69"></a><span id="l42.69" class="difflineplus">+    /**</span>
<a href="#l42.70"></a><span id="l42.70" class="difflineplus">+     * Store a flag indicating that we have announced the new device.</span>
<a href="#l42.71"></a><span id="l42.71" class="difflineplus">+     */</span>
<a href="#l42.72"></a><span id="l42.72" class="difflineplus">+    setDeviceAnnounced: function() {</span>
<a href="#l42.73"></a><span id="l42.73" class="difflineplus">+        this.store.setItem(KEY_END_TO_END_ANNOUNCED, &quot;true&quot;);</span>
<a href="#l42.74"></a><span id="l42.74" class="difflineplus">+    },</span>
<a href="#l42.75"></a><span id="l42.75" class="difflineplus">+</span>
<a href="#l42.76"></a><span id="l42.76" class="difflineplus">+    /**</span>
<a href="#l42.77"></a><span id="l42.77" class="difflineplus">+     * Check if the &quot;device announced&quot; flag is set</span>
<a href="#l42.78"></a><span id="l42.78" class="difflineplus">+     *</span>
<a href="#l42.79"></a><span id="l42.79" class="difflineplus">+     * @return {boolean} true if the &quot;device announced&quot; flag has been set.</span>
<a href="#l42.80"></a><span id="l42.80" class="difflineplus">+     */</span>
<a href="#l42.81"></a><span id="l42.81" class="difflineplus">+    getDeviceAnnounced: function() {</span>
<a href="#l42.82"></a><span id="l42.82" class="difflineplus">+        return this.store.getItem(KEY_END_TO_END_ANNOUNCED) == &quot;true&quot;;</span>
<a href="#l42.83"></a><span id="l42.83" class="difflineplus">+    },</span>
<a href="#l42.84"></a><span id="l42.84" class="difflineplus">+</span>
<a href="#l42.85"></a><span id="l42.85" class="difflineplus">+    /**</span>
<a href="#l42.86"></a><span id="l42.86" class="difflineplus">+     * Stores the known devices for a user.</span>
<a href="#l42.87"></a><span id="l42.87" class="difflineplus">+     * @param {string} userId The user's ID.</span>
<a href="#l42.88"></a><span id="l42.88" class="difflineplus">+     * @param {object} devices A map from device ID to keys for the device.</span>
<a href="#l42.89"></a><span id="l42.89" class="difflineplus">+     */</span>
<a href="#l42.90"></a><span id="l42.90" class="difflineplus">+    storeEndToEndDevicesForUser: function(userId, devices) {</span>
<a href="#l42.91"></a><span id="l42.91" class="difflineplus">+        setJsonItem(this.store, keyEndToEndDevicesForUser(userId), devices);</span>
<a href="#l42.92"></a><span id="l42.92" class="difflineplus">+    },</span>
<a href="#l42.93"></a><span id="l42.93" class="difflineplus">+</span>
<a href="#l42.94"></a><span id="l42.94" class="difflineplus">+    /**</span>
<a href="#l42.95"></a><span id="l42.95" class="difflineplus">+     * Retrieves the known devices for a user.</span>
<a href="#l42.96"></a><span id="l42.96" class="difflineplus">+     * @param {string} userId The user's ID.</span>
<a href="#l42.97"></a><span id="l42.97" class="difflineplus">+     * @return {object} A map from device ID to keys for the device.</span>
<a href="#l42.98"></a><span id="l42.98" class="difflineplus">+     */</span>
<a href="#l42.99"></a><span id="l42.99" class="difflineplus">+    getEndToEndDevicesForUser: function(userId)  {</span>
<a href="#l42.100"></a><span id="l42.100" class="difflineplus">+        return getJsonItem(this.store, keyEndToEndDevicesForUser(userId));</span>
<a href="#l42.101"></a><span id="l42.101" class="difflineplus">+    },</span>
<a href="#l42.102"></a><span id="l42.102" class="difflineplus">+</span>
<a href="#l42.103"></a><span id="l42.103" class="difflineplus">+    /**</span>
<a href="#l42.104"></a><span id="l42.104" class="difflineplus">+     * Store a session between the logged-in user and another device</span>
<a href="#l42.105"></a><span id="l42.105" class="difflineplus">+     * @param {string} deviceKey The public key of the other device.</span>
<a href="#l42.106"></a><span id="l42.106" class="difflineplus">+     * @param {string} sessionId The ID for this end-to-end session.</span>
<a href="#l42.107"></a><span id="l42.107" class="difflineplus">+     * @param {string} session Base64 encoded end-to-end session.</span>
<a href="#l42.108"></a><span id="l42.108" class="difflineplus">+     */</span>
<a href="#l42.109"></a><span id="l42.109" class="difflineplus">+    storeEndToEndSession: function(deviceKey, sessionId, session) {</span>
<a href="#l42.110"></a><span id="l42.110" class="difflineplus">+        var sessions = this.getEndToEndSessions(deviceKey) || {};</span>
<a href="#l42.111"></a><span id="l42.111" class="difflineplus">+        sessions[sessionId] = session;</span>
<a href="#l42.112"></a><span id="l42.112" class="difflineplus">+        setJsonItem(</span>
<a href="#l42.113"></a><span id="l42.113" class="difflineplus">+            this.store, keyEndToEndSessions(deviceKey), sessions</span>
<a href="#l42.114"></a><span id="l42.114" class="difflineplus">+        );</span>
<a href="#l42.115"></a><span id="l42.115" class="difflineplus">+    },</span>
<a href="#l42.116"></a><span id="l42.116" class="difflineplus">+</span>
<a href="#l42.117"></a><span id="l42.117" class="difflineplus">+    /**</span>
<a href="#l42.118"></a><span id="l42.118" class="difflineplus">+     * Retrieve the end-to-end sessions between the logged-in user and another</span>
<a href="#l42.119"></a><span id="l42.119" class="difflineplus">+     * device.</span>
<a href="#l42.120"></a><span id="l42.120" class="difflineplus">+     * @param {string} deviceKey The public key of the other device.</span>
<a href="#l42.121"></a><span id="l42.121" class="difflineplus">+     * @return {object} A map from sessionId to Base64 end-to-end session.</span>
<a href="#l42.122"></a><span id="l42.122" class="difflineplus">+     */</span>
<a href="#l42.123"></a><span id="l42.123" class="difflineplus">+    getEndToEndSessions: function(deviceKey) {</span>
<a href="#l42.124"></a><span id="l42.124" class="difflineplus">+        return getJsonItem(this.store, keyEndToEndSessions(deviceKey));</span>
<a href="#l42.125"></a><span id="l42.125" class="difflineplus">+    },</span>
<a href="#l42.126"></a><span id="l42.126" class="difflineplus">+</span>
<a href="#l42.127"></a><span id="l42.127" class="difflineplus">+    getEndToEndInboundGroupSession: function(senderKey, sessionId) {</span>
<a href="#l42.128"></a><span id="l42.128" class="difflineplus">+        var key = keyEndToEndInboundGroupSession(senderKey, sessionId);</span>
<a href="#l42.129"></a><span id="l42.129" class="difflineplus">+        return this.store.getItem(key);</span>
<a href="#l42.130"></a><span id="l42.130" class="difflineplus">+    },</span>
<a href="#l42.131"></a><span id="l42.131" class="difflineplus">+</span>
<a href="#l42.132"></a><span id="l42.132" class="difflineplus">+    storeEndToEndInboundGroupSession: function(senderKey, sessionId, pickledSession) {</span>
<a href="#l42.133"></a><span id="l42.133" class="difflineplus">+        var key = keyEndToEndInboundGroupSession(senderKey, sessionId);</span>
<a href="#l42.134"></a><span id="l42.134" class="difflineplus">+        return this.store.setItem(key, pickledSession);</span>
<a href="#l42.135"></a><span id="l42.135" class="difflineplus">+    },</span>
<a href="#l42.136"></a><span id="l42.136" class="difflineplus">+</span>
<a href="#l42.137"></a><span id="l42.137" class="difflineplus">+    /**</span>
<a href="#l42.138"></a><span id="l42.138" class="difflineplus">+     * Store the end-to-end state for a room.</span>
<a href="#l42.139"></a><span id="l42.139" class="difflineplus">+     * @param {string} roomId The room's ID.</span>
<a href="#l42.140"></a><span id="l42.140" class="difflineplus">+     * @param {object} roomInfo The end-to-end info for the room.</span>
<a href="#l42.141"></a><span id="l42.141" class="difflineplus">+     */</span>
<a href="#l42.142"></a><span id="l42.142" class="difflineplus">+    storeEndToEndRoom: function(roomId, roomInfo) {</span>
<a href="#l42.143"></a><span id="l42.143" class="difflineplus">+        setJsonItem(this.store, keyEndToEndRoom(roomId), roomInfo);</span>
<a href="#l42.144"></a><span id="l42.144" class="difflineplus">+    },</span>
<a href="#l42.145"></a><span id="l42.145" class="difflineplus">+</span>
<a href="#l42.146"></a><span id="l42.146" class="difflineplus">+    /**</span>
<a href="#l42.147"></a><span id="l42.147" class="difflineplus">+     * Get the end-to-end state for a room</span>
<a href="#l42.148"></a><span id="l42.148" class="difflineplus">+     * @param {string} roomId The room's ID.</span>
<a href="#l42.149"></a><span id="l42.149" class="difflineplus">+     * @return {object} The end-to-end info for the room.</span>
<a href="#l42.150"></a><span id="l42.150" class="difflineplus">+     */</span>
<a href="#l42.151"></a><span id="l42.151" class="difflineplus">+    getEndToEndRoom: function(roomId) {</span>
<a href="#l42.152"></a><span id="l42.152" class="difflineplus">+        return getJsonItem(this.store, keyEndToEndRoom(roomId));</span>
<a href="#l42.153"></a><span id="l42.153" class="difflineplus">+    }</span>
<a href="#l42.154"></a><span id="l42.154" class="difflineplus">+};</span>
<a href="#l42.155"></a><span id="l42.155" class="difflineplus">+</span>
<a href="#l42.156"></a><span id="l42.156" class="difflineplus">+var KEY_END_TO_END_ACCOUNT = E2E_PREFIX + &quot;account&quot;;</span>
<a href="#l42.157"></a><span id="l42.157" class="difflineplus">+var KEY_END_TO_END_ANNOUNCED = E2E_PREFIX + &quot;announced&quot;;</span>
<a href="#l42.158"></a><span id="l42.158" class="difflineplus">+</span>
<a href="#l42.159"></a><span id="l42.159" class="difflineplus">+function keyEndToEndDevicesForUser(userId) {</span>
<a href="#l42.160"></a><span id="l42.160" class="difflineplus">+    return E2E_PREFIX + &quot;devices/&quot; + userId;</span>
<a href="#l42.161"></a><span id="l42.161" class="difflineplus">+}</span>
<a href="#l42.162"></a><span id="l42.162" class="difflineplus">+</span>
<a href="#l42.163"></a><span id="l42.163" class="difflineplus">+function keyEndToEndSessions(deviceKey) {</span>
<a href="#l42.164"></a><span id="l42.164" class="difflineplus">+    return E2E_PREFIX + &quot;sessions/&quot; + deviceKey;</span>
<a href="#l42.165"></a><span id="l42.165" class="difflineplus">+}</span>
<a href="#l42.166"></a><span id="l42.166" class="difflineplus">+</span>
<a href="#l42.167"></a><span id="l42.167" class="difflineplus">+function keyEndToEndInboundGroupSession(senderKey, sessionId) {</span>
<a href="#l42.168"></a><span id="l42.168" class="difflineplus">+    return E2E_PREFIX + &quot;inboundgroupsessions/&quot; + senderKey + &quot;/&quot; + sessionId;</span>
<a href="#l42.169"></a><span id="l42.169" class="difflineplus">+}</span>
<a href="#l42.170"></a><span id="l42.170" class="difflineplus">+</span>
<a href="#l42.171"></a><span id="l42.171" class="difflineplus">+function keyEndToEndRoom(roomId) {</span>
<a href="#l42.172"></a><span id="l42.172" class="difflineplus">+    return E2E_PREFIX + &quot;rooms/&quot; + roomId;</span>
<a href="#l42.173"></a><span id="l42.173" class="difflineplus">+}</span>
<a href="#l42.174"></a><span id="l42.174" class="difflineplus">+</span>
<a href="#l42.175"></a><span id="l42.175" class="difflineplus">+function getJsonItem(store, key) {</span>
<a href="#l42.176"></a><span id="l42.176" class="difflineplus">+    try {</span>
<a href="#l42.177"></a><span id="l42.177" class="difflineplus">+        return JSON.parse(store.getItem(key));</span>
<a href="#l42.178"></a><span id="l42.178" class="difflineplus">+    }</span>
<a href="#l42.179"></a><span id="l42.179" class="difflineplus">+    catch (e) {</span>
<a href="#l42.180"></a><span id="l42.180" class="difflineplus">+        debuglog(&quot;Failed to get key %s: %s&quot;, key, e);</span>
<a href="#l42.181"></a><span id="l42.181" class="difflineplus">+        debuglog(e.stack);</span>
<a href="#l42.182"></a><span id="l42.182" class="difflineplus">+    }</span>
<a href="#l42.183"></a><span id="l42.183" class="difflineplus">+    return null;</span>
<a href="#l42.184"></a><span id="l42.184" class="difflineplus">+}</span>
<a href="#l42.185"></a><span id="l42.185" class="difflineplus">+</span>
<a href="#l42.186"></a><span id="l42.186" class="difflineplus">+function setJsonItem(store, key, val) {</span>
<a href="#l42.187"></a><span id="l42.187" class="difflineplus">+    store.setItem(key, JSON.stringify(val));</span>
<a href="#l42.188"></a><span id="l42.188" class="difflineplus">+}</span>
<a href="#l42.189"></a><span id="l42.189" class="difflineplus">+</span>
<a href="#l42.190"></a><span id="l42.190" class="difflineplus">+function debuglog() {</span>
<a href="#l42.191"></a><span id="l42.191" class="difflineplus">+    if (DEBUG) {</span>
<a href="#l42.192"></a><span id="l42.192" class="difflineplus">+        console.log.apply(console, arguments);</span>
<a href="#l42.193"></a><span id="l42.193" class="difflineplus">+    }</span>
<a href="#l42.194"></a><span id="l42.194" class="difflineplus">+}</span>
<a href="#l42.195"></a><span id="l42.195" class="difflineplus">+</span>
<a href="#l42.196"></a><span id="l42.196" class="difflineplus">+/** */</span>
<a href="#l42.197"></a><span id="l42.197" class="difflineplus">+module.exports = WebStorageSessionStore;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l43.1"></a><span id="l43.1">new file mode 100644</span>
<a href="#l43.2"></a><span id="l43.2" class="difflineminus">--- /dev/null</span>
<a href="#l43.3"></a><span id="l43.3" class="difflineplus">+++ b/chat/protocols/matrix/matrix-sdk/store/stub.js</span>
<a href="#l43.4"></a><span id="l43.4" class="difflineat">@@ -0,0 +1,191 @@</span>
<a href="#l43.5"></a><span id="l43.5" class="difflineplus">+/*</span>
<a href="#l43.6"></a><span id="l43.6" class="difflineplus">+Copyright 2015, 2016 OpenMarket Ltd</span>
<a href="#l43.7"></a><span id="l43.7" class="difflineplus">+</span>
<a href="#l43.8"></a><span id="l43.8" class="difflineplus">+Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<a href="#l43.9"></a><span id="l43.9" class="difflineplus">+you may not use this file except in compliance with the License.</span>
<a href="#l43.10"></a><span id="l43.10" class="difflineplus">+You may obtain a copy of the License at</span>
<a href="#l43.11"></a><span id="l43.11" class="difflineplus">+</span>
<a href="#l43.12"></a><span id="l43.12" class="difflineplus">+    http://www.apache.org/licenses/LICENSE-2.0</span>
<a href="#l43.13"></a><span id="l43.13" class="difflineplus">+</span>
<a href="#l43.14"></a><span id="l43.14" class="difflineplus">+Unless required by applicable law or agreed to in writing, software</span>
<a href="#l43.15"></a><span id="l43.15" class="difflineplus">+distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<a href="#l43.16"></a><span id="l43.16" class="difflineplus">+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<a href="#l43.17"></a><span id="l43.17" class="difflineplus">+See the License for the specific language governing permissions and</span>
<a href="#l43.18"></a><span id="l43.18" class="difflineplus">+limitations under the License.</span>
<a href="#l43.19"></a><span id="l43.19" class="difflineplus">+*/</span>
<a href="#l43.20"></a><span id="l43.20" class="difflineplus">+&quot;use strict&quot;;</span>
<a href="#l43.21"></a><span id="l43.21" class="difflineplus">+/**</span>
<a href="#l43.22"></a><span id="l43.22" class="difflineplus">+ * This is an internal module.</span>
<a href="#l43.23"></a><span id="l43.23" class="difflineplus">+ * @module store/stub</span>
<a href="#l43.24"></a><span id="l43.24" class="difflineplus">+ */</span>
<a href="#l43.25"></a><span id="l43.25" class="difflineplus">+</span>
<a href="#l43.26"></a><span id="l43.26" class="difflineplus">+/**</span>
<a href="#l43.27"></a><span id="l43.27" class="difflineplus">+ * Construct a stub store. This does no-ops on most store methods.</span>
<a href="#l43.28"></a><span id="l43.28" class="difflineplus">+ * @constructor</span>
<a href="#l43.29"></a><span id="l43.29" class="difflineplus">+ */</span>
<a href="#l43.30"></a><span id="l43.30" class="difflineplus">+function StubStore() {</span>
<a href="#l43.31"></a><span id="l43.31" class="difflineplus">+    this.fromToken = null;</span>
<a href="#l43.32"></a><span id="l43.32" class="difflineplus">+}</span>
<a href="#l43.33"></a><span id="l43.33" class="difflineplus">+</span>
<a href="#l43.34"></a><span id="l43.34" class="difflineplus">+StubStore.prototype = {</span>
<a href="#l43.35"></a><span id="l43.35" class="difflineplus">+</span>
<a href="#l43.36"></a><span id="l43.36" class="difflineplus">+    /**</span>
<a href="#l43.37"></a><span id="l43.37" class="difflineplus">+     * Get the sync token.</span>
<a href="#l43.38"></a><span id="l43.38" class="difflineplus">+     * @return {string}</span>
<a href="#l43.39"></a><span id="l43.39" class="difflineplus">+     */</span>
<a href="#l43.40"></a><span id="l43.40" class="difflineplus">+    getSyncToken: function() {</span>
<a href="#l43.41"></a><span id="l43.41" class="difflineplus">+        return this.fromToken;</span>
<a href="#l43.42"></a><span id="l43.42" class="difflineplus">+    },</span>
<a href="#l43.43"></a><span id="l43.43" class="difflineplus">+</span>
<a href="#l43.44"></a><span id="l43.44" class="difflineplus">+    /**</span>
<a href="#l43.45"></a><span id="l43.45" class="difflineplus">+     * Set the sync token.</span>
<a href="#l43.46"></a><span id="l43.46" class="difflineplus">+     * @param {string} token</span>
<a href="#l43.47"></a><span id="l43.47" class="difflineplus">+     */</span>
<a href="#l43.48"></a><span id="l43.48" class="difflineplus">+    setSyncToken: function(token) {</span>
<a href="#l43.49"></a><span id="l43.49" class="difflineplus">+        this.fromToken = token;</span>
<a href="#l43.50"></a><span id="l43.50" class="difflineplus">+    },</span>
<a href="#l43.51"></a><span id="l43.51" class="difflineplus">+</span>
<a href="#l43.52"></a><span id="l43.52" class="difflineplus">+    /**</span>
<a href="#l43.53"></a><span id="l43.53" class="difflineplus">+     * No-op.</span>
<a href="#l43.54"></a><span id="l43.54" class="difflineplus">+     * @param {Room} room</span>
<a href="#l43.55"></a><span id="l43.55" class="difflineplus">+     */</span>
<a href="#l43.56"></a><span id="l43.56" class="difflineplus">+    storeRoom: function(room) {</span>
<a href="#l43.57"></a><span id="l43.57" class="difflineplus">+    },</span>
<a href="#l43.58"></a><span id="l43.58" class="difflineplus">+</span>
<a href="#l43.59"></a><span id="l43.59" class="difflineplus">+    /**</span>
<a href="#l43.60"></a><span id="l43.60" class="difflineplus">+     * No-op.</span>
<a href="#l43.61"></a><span id="l43.61" class="difflineplus">+     * @param {string} roomId</span>
<a href="#l43.62"></a><span id="l43.62" class="difflineplus">+     * @return {null}</span>
<a href="#l43.63"></a><span id="l43.63" class="difflineplus">+     */</span>
<a href="#l43.64"></a><span id="l43.64" class="difflineplus">+    getRoom: function(roomId) {</span>
<a href="#l43.65"></a><span id="l43.65" class="difflineplus">+        return null;</span>
<a href="#l43.66"></a><span id="l43.66" class="difflineplus">+    },</span>
<a href="#l43.67"></a><span id="l43.67" class="difflineplus">+</span>
<a href="#l43.68"></a><span id="l43.68" class="difflineplus">+    /**</span>
<a href="#l43.69"></a><span id="l43.69" class="difflineplus">+     * No-op.</span>
<a href="#l43.70"></a><span id="l43.70" class="difflineplus">+     * @return {Array} An empty array.</span>
<a href="#l43.71"></a><span id="l43.71" class="difflineplus">+     */</span>
<a href="#l43.72"></a><span id="l43.72" class="difflineplus">+    getRooms: function() {</span>
<a href="#l43.73"></a><span id="l43.73" class="difflineplus">+        return [];</span>
<a href="#l43.74"></a><span id="l43.74" class="difflineplus">+    },</span>
<a href="#l43.75"></a><span id="l43.75" class="difflineplus">+</span>
<a href="#l43.76"></a><span id="l43.76" class="difflineplus">+    /**</span>
<a href="#l43.77"></a><span id="l43.77" class="difflineplus">+     * Permanently delete a room.</span>
<a href="#l43.78"></a><span id="l43.78" class="difflineplus">+     * @param {string} roomId</span>
<a href="#l43.79"></a><span id="l43.79" class="difflineplus">+     */</span>
<a href="#l43.80"></a><span id="l43.80" class="difflineplus">+    removeRoom: function(roomId) {</span>
<a href="#l43.81"></a><span id="l43.81" class="difflineplus">+        return;</span>
<a href="#l43.82"></a><span id="l43.82" class="difflineplus">+    },</span>
<a href="#l43.83"></a><span id="l43.83" class="difflineplus">+</span>
<a href="#l43.84"></a><span id="l43.84" class="difflineplus">+    /**</span>
<a href="#l43.85"></a><span id="l43.85" class="difflineplus">+     * No-op.</span>
<a href="#l43.86"></a><span id="l43.86" class="difflineplus">+     * @return {Array} An empty array.</span>
<a href="#l43.87"></a><span id="l43.87" class="difflineplus">+     */</span>
<a href="#l43.88"></a><span id="l43.88" class="difflineplus">+    getRoomSummaries: function() {</span>
<a href="#l43.89"></a><span id="l43.89" class="difflineplus">+        return [];</span>
<a href="#l43.90"></a><span id="l43.90" class="difflineplus">+    },</span>
<a href="#l43.91"></a><span id="l43.91" class="difflineplus">+</span>
<a href="#l43.92"></a><span id="l43.92" class="difflineplus">+    /**</span>
<a href="#l43.93"></a><span id="l43.93" class="difflineplus">+     * No-op.</span>
<a href="#l43.94"></a><span id="l43.94" class="difflineplus">+     * @param {User} user</span>
<a href="#l43.95"></a><span id="l43.95" class="difflineplus">+     */</span>
<a href="#l43.96"></a><span id="l43.96" class="difflineplus">+    storeUser: function(user) {</span>
<a href="#l43.97"></a><span id="l43.97" class="difflineplus">+    },</span>
<a href="#l43.98"></a><span id="l43.98" class="difflineplus">+</span>
<a href="#l43.99"></a><span id="l43.99" class="difflineplus">+    /**</span>
<a href="#l43.100"></a><span id="l43.100" class="difflineplus">+     * No-op.</span>
<a href="#l43.101"></a><span id="l43.101" class="difflineplus">+     * @param {string} userId</span>
<a href="#l43.102"></a><span id="l43.102" class="difflineplus">+     * @return {null}</span>
<a href="#l43.103"></a><span id="l43.103" class="difflineplus">+     */</span>
<a href="#l43.104"></a><span id="l43.104" class="difflineplus">+    getUser: function(userId) {</span>
<a href="#l43.105"></a><span id="l43.105" class="difflineplus">+        return null;</span>
<a href="#l43.106"></a><span id="l43.106" class="difflineplus">+    },</span>
<a href="#l43.107"></a><span id="l43.107" class="difflineplus">+</span>
<a href="#l43.108"></a><span id="l43.108" class="difflineplus">+    /**</span>
<a href="#l43.109"></a><span id="l43.109" class="difflineplus">+     * No-op.</span>
<a href="#l43.110"></a><span id="l43.110" class="difflineplus">+     * @return {User[]}</span>
<a href="#l43.111"></a><span id="l43.111" class="difflineplus">+     */</span>
<a href="#l43.112"></a><span id="l43.112" class="difflineplus">+    getUsers: function() {</span>
<a href="#l43.113"></a><span id="l43.113" class="difflineplus">+        return [];</span>
<a href="#l43.114"></a><span id="l43.114" class="difflineplus">+    },</span>
<a href="#l43.115"></a><span id="l43.115" class="difflineplus">+</span>
<a href="#l43.116"></a><span id="l43.116" class="difflineplus">+    /**</span>
<a href="#l43.117"></a><span id="l43.117" class="difflineplus">+     * No-op.</span>
<a href="#l43.118"></a><span id="l43.118" class="difflineplus">+     * @param {Room} room</span>
<a href="#l43.119"></a><span id="l43.119" class="difflineplus">+     * @param {integer} limit</span>
<a href="#l43.120"></a><span id="l43.120" class="difflineplus">+     * @return {Array}</span>
<a href="#l43.121"></a><span id="l43.121" class="difflineplus">+     */</span>
<a href="#l43.122"></a><span id="l43.122" class="difflineplus">+    scrollback: function(room, limit) {</span>
<a href="#l43.123"></a><span id="l43.123" class="difflineplus">+        return [];</span>
<a href="#l43.124"></a><span id="l43.124" class="difflineplus">+    },</span>
<a href="#l43.125"></a><span id="l43.125" class="difflineplus">+</span>
<a href="#l43.126"></a><span id="l43.126" class="difflineplus">+    /**</span>
<a href="#l43.127"></a><span id="l43.127" class="difflineplus">+     * Store events for a room.</span>
<a href="#l43.128"></a><span id="l43.128" class="difflineplus">+     * @param {Room} room The room to store events for.</span>
<a href="#l43.129"></a><span id="l43.129" class="difflineplus">+     * @param {Array&lt;MatrixEvent&gt;} events The events to store.</span>
<a href="#l43.130"></a><span id="l43.130" class="difflineplus">+     * @param {string} token The token associated with these events.</span>
<a href="#l43.131"></a><span id="l43.131" class="difflineplus">+     * @param {boolean} toStart True if these are paginated results.</span>
<a href="#l43.132"></a><span id="l43.132" class="difflineplus">+     */</span>
<a href="#l43.133"></a><span id="l43.133" class="difflineplus">+    storeEvents: function(room, events, token, toStart) {</span>
<a href="#l43.134"></a><span id="l43.134" class="difflineplus">+    },</span>
<a href="#l43.135"></a><span id="l43.135" class="difflineplus">+</span>
<a href="#l43.136"></a><span id="l43.136" class="difflineplus">+    /**</span>
<a href="#l43.137"></a><span id="l43.137" class="difflineplus">+     * Store a filter.</span>
<a href="#l43.138"></a><span id="l43.138" class="difflineplus">+     * @param {Filter} filter</span>
<a href="#l43.139"></a><span id="l43.139" class="difflineplus">+     */</span>
<a href="#l43.140"></a><span id="l43.140" class="difflineplus">+    storeFilter: function(filter) {</span>
<a href="#l43.141"></a><span id="l43.141" class="difflineplus">+    },</span>
<a href="#l43.142"></a><span id="l43.142" class="difflineplus">+</span>
<a href="#l43.143"></a><span id="l43.143" class="difflineplus">+    /**</span>
<a href="#l43.144"></a><span id="l43.144" class="difflineplus">+     * Retrieve a filter.</span>
<a href="#l43.145"></a><span id="l43.145" class="difflineplus">+     * @param {string} userId</span>
<a href="#l43.146"></a><span id="l43.146" class="difflineplus">+     * @param {string} filterId</span>
<a href="#l43.147"></a><span id="l43.147" class="difflineplus">+     * @return {?Filter} A filter or null.</span>
<a href="#l43.148"></a><span id="l43.148" class="difflineplus">+     */</span>
<a href="#l43.149"></a><span id="l43.149" class="difflineplus">+    getFilter: function(userId, filterId) {</span>
<a href="#l43.150"></a><span id="l43.150" class="difflineplus">+        return null;</span>
<a href="#l43.151"></a><span id="l43.151" class="difflineplus">+    },</span>
<a href="#l43.152"></a><span id="l43.152" class="difflineplus">+</span>
<a href="#l43.153"></a><span id="l43.153" class="difflineplus">+    /**</span>
<a href="#l43.154"></a><span id="l43.154" class="difflineplus">+     * Retrieve a filter ID with the given name.</span>
<a href="#l43.155"></a><span id="l43.155" class="difflineplus">+     * @param {string} filterName The filter name.</span>
<a href="#l43.156"></a><span id="l43.156" class="difflineplus">+     * @return {?string} The filter ID or null.</span>
<a href="#l43.157"></a><span id="l43.157" class="difflineplus">+     */</span>
<a href="#l43.158"></a><span id="l43.158" class="difflineplus">+    getFilterIdByName: function(filterName) {</span>
<a href="#l43.159"></a><span id="l43.159" class="difflineplus">+        return null;</span>
<a href="#l43.160"></a><span id="l43.160" class="difflineplus">+    },</span>
<a href="#l43.161"></a><span id="l43.161" class="difflineplus">+</span>
<a href="#l43.162"></a><span id="l43.162" class="difflineplus">+    /**</span>
<a href="#l43.163"></a><span id="l43.163" class="difflineplus">+     * Set a filter name to ID mapping.</span>
<a href="#l43.164"></a><span id="l43.164" class="difflineplus">+     * @param {string} filterName</span>
<a href="#l43.165"></a><span id="l43.165" class="difflineplus">+     * @param {string} filterId</span>
<a href="#l43.166"></a><span id="l43.166" class="difflineplus">+     */</span>
<a href="#l43.167"></a><span id="l43.167" class="difflineplus">+    setFilterIdByName: function(filterName, filterId) {</span>
<a href="#l43.168"></a><span id="l43.168" class="difflineplus">+</span>
<a href="#l43.169"></a><span id="l43.169" class="difflineplus">+    },</span>
<a href="#l43.170"></a><span id="l43.170" class="difflineplus">+</span>
<a href="#l43.171"></a><span id="l43.171" class="difflineplus">+    /**</span>
<a href="#l43.172"></a><span id="l43.172" class="difflineplus">+     * Store user-scoped account data events</span>
<a href="#l43.173"></a><span id="l43.173" class="difflineplus">+     * @param {Array&lt;MatrixEvent&gt;} events The events to store.</span>
<a href="#l43.174"></a><span id="l43.174" class="difflineplus">+     */</span>
<a href="#l43.175"></a><span id="l43.175" class="difflineplus">+    storeAccountDataEvents: function(events) {</span>
<a href="#l43.176"></a><span id="l43.176" class="difflineplus">+</span>
<a href="#l43.177"></a><span id="l43.177" class="difflineplus">+    },</span>
<a href="#l43.178"></a><span id="l43.178" class="difflineplus">+</span>
<a href="#l43.179"></a><span id="l43.179" class="difflineplus">+    /**</span>
<a href="#l43.180"></a><span id="l43.180" class="difflineplus">+     * Get account data event by event type</span>
<a href="#l43.181"></a><span id="l43.181" class="difflineplus">+     * @param {string} eventType The event type being queried</span>
<a href="#l43.182"></a><span id="l43.182" class="difflineplus">+     */</span>
<a href="#l43.183"></a><span id="l43.183" class="difflineplus">+    getAccountData: function(eventType) {</span>
<a href="#l43.184"></a><span id="l43.184" class="difflineplus">+</span>
<a href="#l43.185"></a><span id="l43.185" class="difflineplus">+    },</span>
<a href="#l43.186"></a><span id="l43.186" class="difflineplus">+</span>
<a href="#l43.187"></a><span id="l43.187" class="difflineplus">+    // TODO</span>
<a href="#l43.188"></a><span id="l43.188" class="difflineplus">+    //setMaxHistoryPerRoom: function(maxHistory) {},</span>
<a href="#l43.189"></a><span id="l43.189" class="difflineplus">+</span>
<a href="#l43.190"></a><span id="l43.190" class="difflineplus">+    // TODO</span>
<a href="#l43.191"></a><span id="l43.191" class="difflineplus">+    //reapOldMessages: function() {},</span>
<a href="#l43.192"></a><span id="l43.192" class="difflineplus">+};</span>
<a href="#l43.193"></a><span id="l43.193" class="difflineplus">+</span>
<a href="#l43.194"></a><span id="l43.194" class="difflineplus">+/** Stub Store class. */</span>
<a href="#l43.195"></a><span id="l43.195" class="difflineplus">+module.exports = StubStore;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l44.1"></a><span id="l44.1">new file mode 100644</span>
<a href="#l44.2"></a><span id="l44.2" class="difflineminus">--- /dev/null</span>
<a href="#l44.3"></a><span id="l44.3" class="difflineplus">+++ b/chat/protocols/matrix/matrix-sdk/store/webstorage.js</span>
<a href="#l44.4"></a><span id="l44.4" class="difflineat">@@ -0,0 +1,686 @@</span>
<a href="#l44.5"></a><span id="l44.5" class="difflineplus">+/*</span>
<a href="#l44.6"></a><span id="l44.6" class="difflineplus">+Copyright 2015, 2016 OpenMarket Ltd</span>
<a href="#l44.7"></a><span id="l44.7" class="difflineplus">+</span>
<a href="#l44.8"></a><span id="l44.8" class="difflineplus">+Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<a href="#l44.9"></a><span id="l44.9" class="difflineplus">+you may not use this file except in compliance with the License.</span>
<a href="#l44.10"></a><span id="l44.10" class="difflineplus">+You may obtain a copy of the License at</span>
<a href="#l44.11"></a><span id="l44.11" class="difflineplus">+</span>
<a href="#l44.12"></a><span id="l44.12" class="difflineplus">+    http://www.apache.org/licenses/LICENSE-2.0</span>
<a href="#l44.13"></a><span id="l44.13" class="difflineplus">+</span>
<a href="#l44.14"></a><span id="l44.14" class="difflineplus">+Unless required by applicable law or agreed to in writing, software</span>
<a href="#l44.15"></a><span id="l44.15" class="difflineplus">+distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<a href="#l44.16"></a><span id="l44.16" class="difflineplus">+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<a href="#l44.17"></a><span id="l44.17" class="difflineplus">+See the License for the specific language governing permissions and</span>
<a href="#l44.18"></a><span id="l44.18" class="difflineplus">+limitations under the License.</span>
<a href="#l44.19"></a><span id="l44.19" class="difflineplus">+*/</span>
<a href="#l44.20"></a><span id="l44.20" class="difflineplus">+&quot;use strict&quot;;</span>
<a href="#l44.21"></a><span id="l44.21" class="difflineplus">+/**</span>
<a href="#l44.22"></a><span id="l44.22" class="difflineplus">+ * This is an internal module. Implementation details:</span>
<a href="#l44.23"></a><span id="l44.23" class="difflineplus">+ * &lt;pre&gt;</span>
<a href="#l44.24"></a><span id="l44.24" class="difflineplus">+ * Room data is stored as follows:</span>
<a href="#l44.25"></a><span id="l44.25" class="difflineplus">+ *   room_$ROOMID_timeline_$INDEX : [ Event, Event, Event ]</span>
<a href="#l44.26"></a><span id="l44.26" class="difflineplus">+ *   room_$ROOMID_state : {</span>
<a href="#l44.27"></a><span id="l44.27" class="difflineplus">+ *                          pagination_token: &lt;oldState.paginationToken&gt;,</span>
<a href="#l44.28"></a><span id="l44.28" class="difflineplus">+ *                          events: {</span>
<a href="#l44.29"></a><span id="l44.29" class="difflineplus">+ *                            &lt;event_type&gt;: { &lt;state_key&gt; : {JSON} }</span>
<a href="#l44.30"></a><span id="l44.30" class="difflineplus">+ *                          }</span>
<a href="#l44.31"></a><span id="l44.31" class="difflineplus">+ *                        }</span>
<a href="#l44.32"></a><span id="l44.32" class="difflineplus">+ * User data is stored as follows:</span>
<a href="#l44.33"></a><span id="l44.33" class="difflineplus">+ *   user_$USERID : User</span>
<a href="#l44.34"></a><span id="l44.34" class="difflineplus">+ * Sync token:</span>
<a href="#l44.35"></a><span id="l44.35" class="difflineplus">+ *   sync_token : $TOKEN</span>
<a href="#l44.36"></a><span id="l44.36" class="difflineplus">+ *</span>
<a href="#l44.37"></a><span id="l44.37" class="difflineplus">+ * Room Retrieval</span>
<a href="#l44.38"></a><span id="l44.38" class="difflineplus">+ * --------------</span>
<a href="#l44.39"></a><span id="l44.39" class="difflineplus">+ * Retrieving a room requires the $ROOMID which then pulls out the current state</span>
<a href="#l44.40"></a><span id="l44.40" class="difflineplus">+ * from room_$ROOMID_state. A defined starting batch of timeline events are then</span>
<a href="#l44.41"></a><span id="l44.41" class="difflineplus">+ * extracted from the highest numbered $INDEX for room_$ROOMID_timeline_$INDEX</span>
<a href="#l44.42"></a><span id="l44.42" class="difflineplus">+ * (more indices as required). The $INDEX may be negative. These are</span>
<a href="#l44.43"></a><span id="l44.43" class="difflineplus">+ * added to the timeline in the same way as /initialSync (old state will diverge).</span>
<a href="#l44.44"></a><span id="l44.44" class="difflineplus">+ * If there exists a room_$ROOMID_timeline_live key, then a timeline sync should</span>
<a href="#l44.45"></a><span id="l44.45" class="difflineplus">+ * be performed before retrieving.</span>
<a href="#l44.46"></a><span id="l44.46" class="difflineplus">+ *</span>
<a href="#l44.47"></a><span id="l44.47" class="difflineplus">+ * Retrieval of earlier messages</span>
<a href="#l44.48"></a><span id="l44.48" class="difflineplus">+ * -----------------------------</span>
<a href="#l44.49"></a><span id="l44.49" class="difflineplus">+ * The earliest event the Room instance knows about is E. Retrieving earlier</span>
<a href="#l44.50"></a><span id="l44.50" class="difflineplus">+ * messages requires a Room which has a storageToken defined.</span>
<a href="#l44.51"></a><span id="l44.51" class="difflineplus">+ * This token maps to the index I where the Room is at. Events are then retrieved from</span>
<a href="#l44.52"></a><span id="l44.52" class="difflineplus">+ * room_$ROOMID_timeline_{I} and elements before E are extracted. If the limit</span>
<a href="#l44.53"></a><span id="l44.53" class="difflineplus">+ * demands more events, I-1 is retrieved, up until I=min $INDEX where it gives</span>
<a href="#l44.54"></a><span id="l44.54" class="difflineplus">+ * less than the limit. Index may go negative if you have paginated in the past.</span>
<a href="#l44.55"></a><span id="l44.55" class="difflineplus">+ *</span>
<a href="#l44.56"></a><span id="l44.56" class="difflineplus">+ * Full Insertion</span>
<a href="#l44.57"></a><span id="l44.57" class="difflineplus">+ * --------------</span>
<a href="#l44.58"></a><span id="l44.58" class="difflineplus">+ * Storing a room requires the timeline and state keys for $ROOMID to</span>
<a href="#l44.59"></a><span id="l44.59" class="difflineplus">+ * be blown away and completely replaced, which is computationally expensive.</span>
<a href="#l44.60"></a><span id="l44.60" class="difflineplus">+ * Room.timeline is batched according to the given batch size B. These batches</span>
<a href="#l44.61"></a><span id="l44.61" class="difflineplus">+ * are then inserted into storage as room_$ROOMID_timeline_$INDEX. Finally,</span>
<a href="#l44.62"></a><span id="l44.62" class="difflineplus">+ * the current room state is persisted to room_$ROOMID_state.</span>
<a href="#l44.63"></a><span id="l44.63" class="difflineplus">+ *</span>
<a href="#l44.64"></a><span id="l44.64" class="difflineplus">+ * Incremental Insertion</span>
<a href="#l44.65"></a><span id="l44.65" class="difflineplus">+ * ---------------------</span>
<a href="#l44.66"></a><span id="l44.66" class="difflineplus">+ * As events arrive, the store can quickly persist these new events. This</span>
<a href="#l44.67"></a><span id="l44.67" class="difflineplus">+ * involves pushing the events to room_$ROOMID_timeline_live. If the</span>
<a href="#l44.68"></a><span id="l44.68" class="difflineplus">+ * current room state has been modified by the new event, then</span>
<a href="#l44.69"></a><span id="l44.69" class="difflineplus">+ * room_$ROOMID_state should be updated in addition to the timeline.</span>
<a href="#l44.70"></a><span id="l44.70" class="difflineplus">+ *</span>
<a href="#l44.71"></a><span id="l44.71" class="difflineplus">+ * Timeline sync</span>
<a href="#l44.72"></a><span id="l44.72" class="difflineplus">+ * -------------</span>
<a href="#l44.73"></a><span id="l44.73" class="difflineplus">+ * Retrieval of events from the timeline depends on the proper batching of</span>
<a href="#l44.74"></a><span id="l44.74" class="difflineplus">+ * events. This is computationally expensive to perform on every new event, so</span>
<a href="#l44.75"></a><span id="l44.75" class="difflineplus">+ * is deferred by inserting live events to room_$ROOMID_timeline_live. A</span>
<a href="#l44.76"></a><span id="l44.76" class="difflineplus">+ * timeline sync reconciles timeline_live and timeline_$INDEX. This involves</span>
<a href="#l44.77"></a><span id="l44.77" class="difflineplus">+ * retrieving _live and the highest numbered $INDEX batch. If the batch is &lt; B,</span>
<a href="#l44.78"></a><span id="l44.78" class="difflineplus">+ * the earliest entries from _live are inserted into the $INDEX until the</span>
<a href="#l44.79"></a><span id="l44.79" class="difflineplus">+ * batch == B. Then, the remaining entries in _live are batched to $INDEX+1,</span>
<a href="#l44.80"></a><span id="l44.80" class="difflineplus">+ * $INDEX+2, and so on. The easiest way to visualise this is that the timeline</span>
<a href="#l44.81"></a><span id="l44.81" class="difflineplus">+ * goes from old to new, left to right:</span>
<a href="#l44.82"></a><span id="l44.82" class="difflineplus">+ *          -2         -1         0         1</span>
<a href="#l44.83"></a><span id="l44.83" class="difflineplus">+ * &lt;--OLD---------------------------------------NEW--&gt;</span>
<a href="#l44.84"></a><span id="l44.84" class="difflineplus">+ *        [a,b,c]    [d,e,f]   [g,h,i]   [j,k,l]</span>
<a href="#l44.85"></a><span id="l44.85" class="difflineplus">+ *</span>
<a href="#l44.86"></a><span id="l44.86" class="difflineplus">+ * Purging</span>
<a href="#l44.87"></a><span id="l44.87" class="difflineplus">+ * -------</span>
<a href="#l44.88"></a><span id="l44.88" class="difflineplus">+ * Events from the timeline can be purged by removing the lowest</span>
<a href="#l44.89"></a><span id="l44.89" class="difflineplus">+ * timeline_$INDEX in the store.</span>
<a href="#l44.90"></a><span id="l44.90" class="difflineplus">+ *</span>
<a href="#l44.91"></a><span id="l44.91" class="difflineplus">+ * Example</span>
<a href="#l44.92"></a><span id="l44.92" class="difflineplus">+ * -------</span>
<a href="#l44.93"></a><span id="l44.93" class="difflineplus">+ * A room with room_id !foo:bar has 9 messages (M1-&gt;9 where 9=newest) with a</span>
<a href="#l44.94"></a><span id="l44.94" class="difflineplus">+ * batch size of 4. The very first time, there is no entry for !foo:bar until</span>
<a href="#l44.95"></a><span id="l44.95" class="difflineplus">+ * storeRoom() is called, which results in the keys: [Full Insert]</span>
<a href="#l44.96"></a><span id="l44.96" class="difflineplus">+ *   room_!foo:bar_timeline_0 : [M1, M2, M3, M4]</span>
<a href="#l44.97"></a><span id="l44.97" class="difflineplus">+ *   room_!foo:bar_timeline_1 : [M5, M6, M7, M8]</span>
<a href="#l44.98"></a><span id="l44.98" class="difflineplus">+ *   room_!foo:bar_timeline_2 : [M9]</span>
<a href="#l44.99"></a><span id="l44.99" class="difflineplus">+ *   room_!foo:bar_state: { ... }</span>
<a href="#l44.100"></a><span id="l44.100" class="difflineplus">+ *</span>
<a href="#l44.101"></a><span id="l44.101" class="difflineplus">+ * 5 new messages (N1-5, 5=newest) arrive and are then added: [Incremental Insert]</span>
<a href="#l44.102"></a><span id="l44.102" class="difflineplus">+ *   room_!foo:bar_timeline_live: [N1]</span>
<a href="#l44.103"></a><span id="l44.103" class="difflineplus">+ *   room_!foo:bar_timeline_live: [N1, N2]</span>
<a href="#l44.104"></a><span id="l44.104" class="difflineplus">+ *   room_!foo:bar_timeline_live: [N1, N2, N3]</span>
<a href="#l44.105"></a><span id="l44.105" class="difflineplus">+ *   room_!foo:bar_timeline_live: [N1, N2, N3, N4]</span>
<a href="#l44.106"></a><span id="l44.106" class="difflineplus">+ *   room_!foo:bar_timeline_live: [N1, N2, N3, N4, N5]</span>
<a href="#l44.107"></a><span id="l44.107" class="difflineplus">+ *</span>
<a href="#l44.108"></a><span id="l44.108" class="difflineplus">+ * App is shutdown. Restarts. The timeline is synced [Timeline Sync]</span>
<a href="#l44.109"></a><span id="l44.109" class="difflineplus">+ *   room_!foo:bar_timeline_2 : [M9, N1, N2, N3]</span>
<a href="#l44.110"></a><span id="l44.110" class="difflineplus">+ *   room_!foo:bar_timeline_3 : [N4, N5]</span>
<a href="#l44.111"></a><span id="l44.111" class="difflineplus">+ *   room_!foo:bar_timeline_live: []</span>
<a href="#l44.112"></a><span id="l44.112" class="difflineplus">+ *</span>
<a href="#l44.113"></a><span id="l44.113" class="difflineplus">+ * And the room is retrieved with 8 messages: [Room Retrieval]</span>
<a href="#l44.114"></a><span id="l44.114" class="difflineplus">+ *   Room.timeline: [M7, M8, M9, N1, N2, N3, N4, N5]</span>
<a href="#l44.115"></a><span id="l44.115" class="difflineplus">+ *   Room.storageToken: =&gt; early_index = 1 because that's where M7 is.</span>
<a href="#l44.116"></a><span id="l44.116" class="difflineplus">+ *</span>
<a href="#l44.117"></a><span id="l44.117" class="difflineplus">+ * 3 earlier messages are requested: [Earlier retrieval]</span>
<a href="#l44.118"></a><span id="l44.118" class="difflineplus">+ *   Use storageToken to find batch index 1. Scan batch for earliest event ID.</span>
<a href="#l44.119"></a><span id="l44.119" class="difflineplus">+ *   earliest event = M7</span>
<a href="#l44.120"></a><span id="l44.120" class="difflineplus">+ *   events = room_!foo:bar_timeline_1 where event &lt; M7 = [M5, M6]</span>
<a href="#l44.121"></a><span id="l44.121" class="difflineplus">+ * Too few events, use next index (0) and get 1 more:</span>
<a href="#l44.122"></a><span id="l44.122" class="difflineplus">+ *   events = room_!foo:bar_timeline_0 = [M1, M2, M3, M4] =&gt; [M4]</span>
<a href="#l44.123"></a><span id="l44.123" class="difflineplus">+ * Return concatentation:</span>
<a href="#l44.124"></a><span id="l44.124" class="difflineplus">+ *   [M4, M5, M6]</span>
<a href="#l44.125"></a><span id="l44.125" class="difflineplus">+ *</span>
<a href="#l44.126"></a><span id="l44.126" class="difflineplus">+ * Purge oldest events: [Purge]</span>
<a href="#l44.127"></a><span id="l44.127" class="difflineplus">+ *   del room_!foo:bar_timeline_0</span>
<a href="#l44.128"></a><span id="l44.128" class="difflineplus">+ * &lt;/pre&gt;</span>
<a href="#l44.129"></a><span id="l44.129" class="difflineplus">+ * @module store/webstorage</span>
<a href="#l44.130"></a><span id="l44.130" class="difflineplus">+ */</span>
<a href="#l44.131"></a><span id="l44.131" class="difflineplus">+var DEBUG = false;  // set true to enable console logging.</span>
<a href="#l44.132"></a><span id="l44.132" class="difflineplus">+var utils = require(&quot;../utils&quot;);</span>
<a href="#l44.133"></a><span id="l44.133" class="difflineplus">+var Room = require(&quot;../models/room&quot;);</span>
<a href="#l44.134"></a><span id="l44.134" class="difflineplus">+var User = require(&quot;../models/user&quot;);</span>
<a href="#l44.135"></a><span id="l44.135" class="difflineplus">+var MatrixEvent = require(&quot;../models/event&quot;).MatrixEvent;</span>
<a href="#l44.136"></a><span id="l44.136" class="difflineplus">+</span>
<a href="#l44.137"></a><span id="l44.137" class="difflineplus">+/**</span>
<a href="#l44.138"></a><span id="l44.138" class="difflineplus">+ * Construct a web storage store, capable of storing rooms and users.</span>
<a href="#l44.139"></a><span id="l44.139" class="difflineplus">+ * @constructor</span>
<a href="#l44.140"></a><span id="l44.140" class="difflineplus">+ * @param {WebStorage} webStore A web storage implementation, e.g.</span>
<a href="#l44.141"></a><span id="l44.141" class="difflineplus">+ * 'window.localStorage' or 'window.sessionStorage' or a custom implementation.</span>
<a href="#l44.142"></a><span id="l44.142" class="difflineplus">+ * @param {integer} batchSize The number of events to store per key/value (room</span>
<a href="#l44.143"></a><span id="l44.143" class="difflineplus">+ * scoped). Use -1 to store all events for a room under one key/value.</span>
<a href="#l44.144"></a><span id="l44.144" class="difflineplus">+ * @throws if the supplied 'store' does not meet the Storage interface of the</span>
<a href="#l44.145"></a><span id="l44.145" class="difflineplus">+ * WebStorage API.</span>
<a href="#l44.146"></a><span id="l44.146" class="difflineplus">+ */</span>
<a href="#l44.147"></a><span id="l44.147" class="difflineplus">+function WebStorageStore(webStore, batchSize) {</span>
<a href="#l44.148"></a><span id="l44.148" class="difflineplus">+    this.store = webStore;</span>
<a href="#l44.149"></a><span id="l44.149" class="difflineplus">+    this.batchSize = batchSize;</span>
<a href="#l44.150"></a><span id="l44.150" class="difflineplus">+    if (!utils.isFunction(webStore.getItem) || !utils.isFunction(webStore.setItem) ||</span>
<a href="#l44.151"></a><span id="l44.151" class="difflineplus">+            !utils.isFunction(webStore.removeItem) || !utils.isFunction(webStore.key)) {</span>
<a href="#l44.152"></a><span id="l44.152" class="difflineplus">+        throw new Error(</span>
<a href="#l44.153"></a><span id="l44.153" class="difflineplus">+            &quot;Supplied webStore does not meet the WebStorage API interface&quot;</span>
<a href="#l44.154"></a><span id="l44.154" class="difflineplus">+        );</span>
<a href="#l44.155"></a><span id="l44.155" class="difflineplus">+    }</span>
<a href="#l44.156"></a><span id="l44.156" class="difflineplus">+    if (!parseInt(webStore.length) &amp;&amp; webStore.length !== 0) {</span>
<a href="#l44.157"></a><span id="l44.157" class="difflineplus">+        throw new Error(</span>
<a href="#l44.158"></a><span id="l44.158" class="difflineplus">+            &quot;Supplied webStore does not meet the WebStorage API interface (length)&quot;</span>
<a href="#l44.159"></a><span id="l44.159" class="difflineplus">+        );</span>
<a href="#l44.160"></a><span id="l44.160" class="difflineplus">+    }</span>
<a href="#l44.161"></a><span id="l44.161" class="difflineplus">+    // cached list of room_ids this is storing.</span>
<a href="#l44.162"></a><span id="l44.162" class="difflineplus">+    this._roomIds = [];</span>
<a href="#l44.163"></a><span id="l44.163" class="difflineplus">+    this._syncedWithStore = false;</span>
<a href="#l44.164"></a><span id="l44.164" class="difflineplus">+    // tokens used to remember which index the room instance is at.</span>
<a href="#l44.165"></a><span id="l44.165" class="difflineplus">+    this._tokens = [</span>
<a href="#l44.166"></a><span id="l44.166" class="difflineplus">+        // { earliestIndex: -4 }</span>
<a href="#l44.167"></a><span id="l44.167" class="difflineplus">+    ];</span>
<a href="#l44.168"></a><span id="l44.168" class="difflineplus">+}</span>
<a href="#l44.169"></a><span id="l44.169" class="difflineplus">+</span>
<a href="#l44.170"></a><span id="l44.170" class="difflineplus">+</span>
<a href="#l44.171"></a><span id="l44.171" class="difflineplus">+/**</span>
<a href="#l44.172"></a><span id="l44.172" class="difflineplus">+ * Retrieve the token to stream from.</span>
<a href="#l44.173"></a><span id="l44.173" class="difflineplus">+ * @return {string} The token or null.</span>
<a href="#l44.174"></a><span id="l44.174" class="difflineplus">+ */</span>
<a href="#l44.175"></a><span id="l44.175" class="difflineplus">+WebStorageStore.prototype.getSyncToken = function() {</span>
<a href="#l44.176"></a><span id="l44.176" class="difflineplus">+    return this.store.getItem(&quot;sync_token&quot;);</span>
<a href="#l44.177"></a><span id="l44.177" class="difflineplus">+};</span>
<a href="#l44.178"></a><span id="l44.178" class="difflineplus">+</span>
<a href="#l44.179"></a><span id="l44.179" class="difflineplus">+/**</span>
<a href="#l44.180"></a><span id="l44.180" class="difflineplus">+ * Set the token to stream from.</span>
<a href="#l44.181"></a><span id="l44.181" class="difflineplus">+ * @param {string} token The token to stream from.</span>
<a href="#l44.182"></a><span id="l44.182" class="difflineplus">+ */</span>
<a href="#l44.183"></a><span id="l44.183" class="difflineplus">+WebStorageStore.prototype.setSyncToken = function(token) {</span>
<a href="#l44.184"></a><span id="l44.184" class="difflineplus">+    this.store.setItem(&quot;sync_token&quot;, token);</span>
<a href="#l44.185"></a><span id="l44.185" class="difflineplus">+};</span>
<a href="#l44.186"></a><span id="l44.186" class="difflineplus">+</span>
<a href="#l44.187"></a><span id="l44.187" class="difflineplus">+/**</span>
<a href="#l44.188"></a><span id="l44.188" class="difflineplus">+ * Store a room in web storage.</span>
<a href="#l44.189"></a><span id="l44.189" class="difflineplus">+ * @param {Room} room</span>
<a href="#l44.190"></a><span id="l44.190" class="difflineplus">+ */</span>
<a href="#l44.191"></a><span id="l44.191" class="difflineplus">+WebStorageStore.prototype.storeRoom = function(room) {</span>
<a href="#l44.192"></a><span id="l44.192" class="difflineplus">+    var serRoom = SerialisedRoom.fromRoom(room, this.batchSize);</span>
<a href="#l44.193"></a><span id="l44.193" class="difflineplus">+    persist(this.store, serRoom);</span>
<a href="#l44.194"></a><span id="l44.194" class="difflineplus">+    if (this._roomIds.indexOf(room.roomId) === -1) {</span>
<a href="#l44.195"></a><span id="l44.195" class="difflineplus">+        this._roomIds.push(room.roomId);</span>
<a href="#l44.196"></a><span id="l44.196" class="difflineplus">+    }</span>
<a href="#l44.197"></a><span id="l44.197" class="difflineplus">+};</span>
<a href="#l44.198"></a><span id="l44.198" class="difflineplus">+</span>
<a href="#l44.199"></a><span id="l44.199" class="difflineplus">+/**</span>
<a href="#l44.200"></a><span id="l44.200" class="difflineplus">+ * Retrieve a room from web storage.</span>
<a href="#l44.201"></a><span id="l44.201" class="difflineplus">+ * @param {string} roomId</span>
<a href="#l44.202"></a><span id="l44.202" class="difflineplus">+ * @return {?Room}</span>
<a href="#l44.203"></a><span id="l44.203" class="difflineplus">+ */</span>
<a href="#l44.204"></a><span id="l44.204" class="difflineplus">+WebStorageStore.prototype.getRoom = function(roomId) {</span>
<a href="#l44.205"></a><span id="l44.205" class="difflineplus">+    // probe if room exists; break early if not. Every room should have state.</span>
<a href="#l44.206"></a><span id="l44.206" class="difflineplus">+    if (!getItem(this.store, keyName(roomId, &quot;state&quot;))) {</span>
<a href="#l44.207"></a><span id="l44.207" class="difflineplus">+        debuglog(&quot;getRoom: No room with id %s found.&quot;, roomId);</span>
<a href="#l44.208"></a><span id="l44.208" class="difflineplus">+        return null;</span>
<a href="#l44.209"></a><span id="l44.209" class="difflineplus">+    }</span>
<a href="#l44.210"></a><span id="l44.210" class="difflineplus">+    var timelineKeys = getTimelineIndices(this.store, roomId);</span>
<a href="#l44.211"></a><span id="l44.211" class="difflineplus">+    if (timelineKeys.indexOf(&quot;live&quot;) !== -1) {</span>
<a href="#l44.212"></a><span id="l44.212" class="difflineplus">+        debuglog(&quot;getRoom: Live events found. Syncing timeline for %s&quot;, roomId);</span>
<a href="#l44.213"></a><span id="l44.213" class="difflineplus">+        this._syncTimeline(roomId, timelineKeys);</span>
<a href="#l44.214"></a><span id="l44.214" class="difflineplus">+    }</span>
<a href="#l44.215"></a><span id="l44.215" class="difflineplus">+    return loadRoom(this.store, roomId, this.batchSize, this._tokens);</span>
<a href="#l44.216"></a><span id="l44.216" class="difflineplus">+};</span>
<a href="#l44.217"></a><span id="l44.217" class="difflineplus">+</span>
<a href="#l44.218"></a><span id="l44.218" class="difflineplus">+/**</span>
<a href="#l44.219"></a><span id="l44.219" class="difflineplus">+ * Get a list of all rooms from web storage.</span>
<a href="#l44.220"></a><span id="l44.220" class="difflineplus">+ * @return {Array} An empty array.</span>
<a href="#l44.221"></a><span id="l44.221" class="difflineplus">+ */</span>
<a href="#l44.222"></a><span id="l44.222" class="difflineplus">+WebStorageStore.prototype.getRooms = function() {</span>
<a href="#l44.223"></a><span id="l44.223" class="difflineplus">+    var rooms = [];</span>
<a href="#l44.224"></a><span id="l44.224" class="difflineplus">+    var i;</span>
<a href="#l44.225"></a><span id="l44.225" class="difflineplus">+    if (!this._syncedWithStore) {</span>
<a href="#l44.226"></a><span id="l44.226" class="difflineplus">+        // sync with the store to set this._roomIds correctly. We know there is</span>
<a href="#l44.227"></a><span id="l44.227" class="difflineplus">+        // exactly one 'state' key for each room, so we grab them.</span>
<a href="#l44.228"></a><span id="l44.228" class="difflineplus">+        this._roomIds = [];</span>
<a href="#l44.229"></a><span id="l44.229" class="difflineplus">+        for (i = 0; i &lt; this.store.length; i++) {</span>
<a href="#l44.230"></a><span id="l44.230" class="difflineplus">+            if (this.store.key(i).indexOf(&quot;room_&quot;) === 0 &amp;&amp;</span>
<a href="#l44.231"></a><span id="l44.231" class="difflineplus">+                    this.store.key(i).indexOf(&quot;_state&quot;) !== -1) {</span>
<a href="#l44.232"></a><span id="l44.232" class="difflineplus">+                // grab the middle bit which is the room ID</span>
<a href="#l44.233"></a><span id="l44.233" class="difflineplus">+                var k = this.store.key(i);</span>
<a href="#l44.234"></a><span id="l44.234" class="difflineplus">+                this._roomIds.push(</span>
<a href="#l44.235"></a><span id="l44.235" class="difflineplus">+                    k.substring(&quot;room_&quot;.length, k.length - &quot;_state&quot;.length)</span>
<a href="#l44.236"></a><span id="l44.236" class="difflineplus">+                );</span>
<a href="#l44.237"></a><span id="l44.237" class="difflineplus">+            }</span>
<a href="#l44.238"></a><span id="l44.238" class="difflineplus">+        }</span>
<a href="#l44.239"></a><span id="l44.239" class="difflineplus">+        this._syncedWithStore = true;</span>
<a href="#l44.240"></a><span id="l44.240" class="difflineplus">+    }</span>
<a href="#l44.241"></a><span id="l44.241" class="difflineplus">+    // call getRoom on each room_id</span>
<a href="#l44.242"></a><span id="l44.242" class="difflineplus">+    for (i = 0; i &lt; this._roomIds.length; i++) {</span>
<a href="#l44.243"></a><span id="l44.243" class="difflineplus">+        var rm = this.getRoom(this._roomIds[i]);</span>
<a href="#l44.244"></a><span id="l44.244" class="difflineplus">+        if (rm) {</span>
<a href="#l44.245"></a><span id="l44.245" class="difflineplus">+            rooms.push(rm);</span>
<a href="#l44.246"></a><span id="l44.246" class="difflineplus">+        }</span>
<a href="#l44.247"></a><span id="l44.247" class="difflineplus">+    }</span>
<a href="#l44.248"></a><span id="l44.248" class="difflineplus">+    return rooms;</span>
<a href="#l44.249"></a><span id="l44.249" class="difflineplus">+};</span>
<a href="#l44.250"></a><span id="l44.250" class="difflineplus">+</span>
<a href="#l44.251"></a><span id="l44.251" class="difflineplus">+/**</span>
<a href="#l44.252"></a><span id="l44.252" class="difflineplus">+ * Get a list of summaries from web storage.</span>
<a href="#l44.253"></a><span id="l44.253" class="difflineplus">+ * @return {Array} An empty array.</span>
<a href="#l44.254"></a><span id="l44.254" class="difflineplus">+ */</span>
<a href="#l44.255"></a><span id="l44.255" class="difflineplus">+WebStorageStore.prototype.getRoomSummaries = function() {</span>
<a href="#l44.256"></a><span id="l44.256" class="difflineplus">+    return [];</span>
<a href="#l44.257"></a><span id="l44.257" class="difflineplus">+};</span>
<a href="#l44.258"></a><span id="l44.258" class="difflineplus">+</span>
<a href="#l44.259"></a><span id="l44.259" class="difflineplus">+/**</span>
<a href="#l44.260"></a><span id="l44.260" class="difflineplus">+ * Store a user in web storage.</span>
<a href="#l44.261"></a><span id="l44.261" class="difflineplus">+ * @param {User} user</span>
<a href="#l44.262"></a><span id="l44.262" class="difflineplus">+ */</span>
<a href="#l44.263"></a><span id="l44.263" class="difflineplus">+WebStorageStore.prototype.storeUser = function(user) {</span>
<a href="#l44.264"></a><span id="l44.264" class="difflineplus">+    // persist the events used to make the user, we can reconstruct on demand.</span>
<a href="#l44.265"></a><span id="l44.265" class="difflineplus">+    setItem(this.store, &quot;user_&quot; + user.userId, {</span>
<a href="#l44.266"></a><span id="l44.266" class="difflineplus">+        presence: user.events.presence ? user.events.presence.event : null</span>
<a href="#l44.267"></a><span id="l44.267" class="difflineplus">+    });</span>
<a href="#l44.268"></a><span id="l44.268" class="difflineplus">+};</span>
<a href="#l44.269"></a><span id="l44.269" class="difflineplus">+</span>
<a href="#l44.270"></a><span id="l44.270" class="difflineplus">+/**</span>
<a href="#l44.271"></a><span id="l44.271" class="difflineplus">+ * Get a user from web storage.</span>
<a href="#l44.272"></a><span id="l44.272" class="difflineplus">+ * @param {string} userId</span>
<a href="#l44.273"></a><span id="l44.273" class="difflineplus">+ * @return {User}</span>
<a href="#l44.274"></a><span id="l44.274" class="difflineplus">+ */</span>
<a href="#l44.275"></a><span id="l44.275" class="difflineplus">+WebStorageStore.prototype.getUser = function(userId) {</span>
<a href="#l44.276"></a><span id="l44.276" class="difflineplus">+    var userData = getItem(this.store, &quot;user_&quot; + userId);</span>
<a href="#l44.277"></a><span id="l44.277" class="difflineplus">+    if (!userData) {</span>
<a href="#l44.278"></a><span id="l44.278" class="difflineplus">+        return null;</span>
<a href="#l44.279"></a><span id="l44.279" class="difflineplus">+    }</span>
<a href="#l44.280"></a><span id="l44.280" class="difflineplus">+    var user = new User(userId);</span>
<a href="#l44.281"></a><span id="l44.281" class="difflineplus">+    if (userData.presence) {</span>
<a href="#l44.282"></a><span id="l44.282" class="difflineplus">+        user.setPresenceEvent(new MatrixEvent(userData.presence));</span>
<a href="#l44.283"></a><span id="l44.283" class="difflineplus">+    }</span>
<a href="#l44.284"></a><span id="l44.284" class="difflineplus">+    return user;</span>
<a href="#l44.285"></a><span id="l44.285" class="difflineplus">+};</span>
<a href="#l44.286"></a><span id="l44.286" class="difflineplus">+</span>
<a href="#l44.287"></a><span id="l44.287" class="difflineplus">+/**</span>
<a href="#l44.288"></a><span id="l44.288" class="difflineplus">+ * Retrieve scrollback for this room. Automatically adds events to the timeline.</span>
<a href="#l44.289"></a><span id="l44.289" class="difflineplus">+ * @param {Room} room The matrix room to add the events to the start of the timeline.</span>
<a href="#l44.290"></a><span id="l44.290" class="difflineplus">+ * @param {integer} limit The max number of old events to retrieve.</span>
<a href="#l44.291"></a><span id="l44.291" class="difflineplus">+ * @return {Array&lt;Object&gt;} An array of objects which will be at most 'limit'</span>
<a href="#l44.292"></a><span id="l44.292" class="difflineplus">+ * length and at least 0. The objects are the raw event JSON. The last element</span>
<a href="#l44.293"></a><span id="l44.293" class="difflineplus">+ * is the 'oldest' (for parity with homeserver scrollback APIs).</span>
<a href="#l44.294"></a><span id="l44.294" class="difflineplus">+ */</span>
<a href="#l44.295"></a><span id="l44.295" class="difflineplus">+WebStorageStore.prototype.scrollback = function(room, limit) {</span>
<a href="#l44.296"></a><span id="l44.296" class="difflineplus">+    if (room.storageToken === undefined || room.storageToken &gt;= this._tokens.length) {</span>
<a href="#l44.297"></a><span id="l44.297" class="difflineplus">+        return [];</span>
<a href="#l44.298"></a><span id="l44.298" class="difflineplus">+    }</span>
<a href="#l44.299"></a><span id="l44.299" class="difflineplus">+    // find the index of the earliest event in this room's timeline</span>
<a href="#l44.300"></a><span id="l44.300" class="difflineplus">+    var storeData = this._tokens[room.storageToken] || {};</span>
<a href="#l44.301"></a><span id="l44.301" class="difflineplus">+    var i;</span>
<a href="#l44.302"></a><span id="l44.302" class="difflineplus">+    var earliestIndex = storeData.earliestIndex;</span>
<a href="#l44.303"></a><span id="l44.303" class="difflineplus">+    var earliestEventId = room.timeline[0] ? room.timeline[0].getId() : null;</span>
<a href="#l44.304"></a><span id="l44.304" class="difflineplus">+    debuglog(</span>
<a href="#l44.305"></a><span id="l44.305" class="difflineplus">+        &quot;scrollback in %s (timeline=%s msgs) i=%s, timeline[0].id=%s - req %s events&quot;,</span>
<a href="#l44.306"></a><span id="l44.306" class="difflineplus">+        room.roomId, room.timeline.length, earliestIndex, earliestEventId, limit</span>
<a href="#l44.307"></a><span id="l44.307" class="difflineplus">+    );</span>
<a href="#l44.308"></a><span id="l44.308" class="difflineplus">+    var batch = getItem(</span>
<a href="#l44.309"></a><span id="l44.309" class="difflineplus">+        this.store, keyName(room.roomId, &quot;timeline&quot;, earliestIndex)</span>
<a href="#l44.310"></a><span id="l44.310" class="difflineplus">+    );</span>
<a href="#l44.311"></a><span id="l44.311" class="difflineplus">+    if (!batch) {</span>
<a href="#l44.312"></a><span id="l44.312" class="difflineplus">+        // bad room or already at start, either way we have nothing to give.</span>
<a href="#l44.313"></a><span id="l44.313" class="difflineplus">+        debuglog(&quot;No batch with index %s found.&quot;, earliestIndex);</span>
<a href="#l44.314"></a><span id="l44.314" class="difflineplus">+        return [];</span>
<a href="#l44.315"></a><span id="l44.315" class="difflineplus">+    }</span>
<a href="#l44.316"></a><span id="l44.316" class="difflineplus">+    // populate from this batch first</span>
<a href="#l44.317"></a><span id="l44.317" class="difflineplus">+    var scrollback = [];</span>
<a href="#l44.318"></a><span id="l44.318" class="difflineplus">+    var foundEventId = false;</span>
<a href="#l44.319"></a><span id="l44.319" class="difflineplus">+    for (i = batch.length - 1; i &gt;= 0; i--) {</span>
<a href="#l44.320"></a><span id="l44.320" class="difflineplus">+        // go back and find the earliest event ID, THEN start adding entries.</span>
<a href="#l44.321"></a><span id="l44.321" class="difflineplus">+        // Make a MatrixEvent so we don't assume .event_id exists</span>
<a href="#l44.322"></a><span id="l44.322" class="difflineplus">+        // (e.g v2/v3 JSON may be different)</span>
<a href="#l44.323"></a><span id="l44.323" class="difflineplus">+        var matrixEvent = new MatrixEvent(batch[i]);</span>
<a href="#l44.324"></a><span id="l44.324" class="difflineplus">+        if (matrixEvent.getId() === earliestEventId) {</span>
<a href="#l44.325"></a><span id="l44.325" class="difflineplus">+            foundEventId = true;</span>
<a href="#l44.326"></a><span id="l44.326" class="difflineplus">+            debuglog(</span>
<a href="#l44.327"></a><span id="l44.327" class="difflineplus">+                &quot;Found timeline[0] event at position %s in batch %s&quot;,</span>
<a href="#l44.328"></a><span id="l44.328" class="difflineplus">+                i, earliestIndex</span>
<a href="#l44.329"></a><span id="l44.329" class="difflineplus">+            );</span>
<a href="#l44.330"></a><span id="l44.330" class="difflineplus">+            continue;</span>
<a href="#l44.331"></a><span id="l44.331" class="difflineplus">+        }</span>
<a href="#l44.332"></a><span id="l44.332" class="difflineplus">+        if (!foundEventId) {</span>
<a href="#l44.333"></a><span id="l44.333" class="difflineplus">+            continue;</span>
<a href="#l44.334"></a><span id="l44.334" class="difflineplus">+        }</span>
<a href="#l44.335"></a><span id="l44.335" class="difflineplus">+        // add entry</span>
<a href="#l44.336"></a><span id="l44.336" class="difflineplus">+        debuglog(&quot;Add event at position %s in batch %s&quot;, i, earliestIndex);</span>
<a href="#l44.337"></a><span id="l44.337" class="difflineplus">+        scrollback.push(batch[i]);</span>
<a href="#l44.338"></a><span id="l44.338" class="difflineplus">+        if (scrollback.length === limit) {</span>
<a href="#l44.339"></a><span id="l44.339" class="difflineplus">+            break;</span>
<a href="#l44.340"></a><span id="l44.340" class="difflineplus">+        }</span>
<a href="#l44.341"></a><span id="l44.341" class="difflineplus">+    }</span>
<a href="#l44.342"></a><span id="l44.342" class="difflineplus">+    if (scrollback.length === limit) {</span>
<a href="#l44.343"></a><span id="l44.343" class="difflineplus">+        debuglog(&quot;Batch has enough events to satisfy request.&quot;);</span>
<a href="#l44.344"></a><span id="l44.344" class="difflineplus">+        return scrollback;</span>
<a href="#l44.345"></a><span id="l44.345" class="difflineplus">+    }</span>
<a href="#l44.346"></a><span id="l44.346" class="difflineplus">+    if (!foundEventId) {</span>
<a href="#l44.347"></a><span id="l44.347" class="difflineplus">+        // the earliest index batch didn't contain the event. In other words,</span>
<a href="#l44.348"></a><span id="l44.348" class="difflineplus">+        // this timeline is at a state we don't know, so bail.</span>
<a href="#l44.349"></a><span id="l44.349" class="difflineplus">+        debuglog(</span>
<a href="#l44.350"></a><span id="l44.350" class="difflineplus">+            &quot;Failed to find event ID %s in batch %s&quot;, earliestEventId, earliestIndex</span>
<a href="#l44.351"></a><span id="l44.351" class="difflineplus">+        );</span>
<a href="#l44.352"></a><span id="l44.352" class="difflineplus">+        return [];</span>
<a href="#l44.353"></a><span id="l44.353" class="difflineplus">+    }</span>
<a href="#l44.354"></a><span id="l44.354" class="difflineplus">+</span>
<a href="#l44.355"></a><span id="l44.355" class="difflineplus">+    // get the requested earlier events from earlier batches</span>
<a href="#l44.356"></a><span id="l44.356" class="difflineplus">+    while (scrollback.length &lt; limit) {</span>
<a href="#l44.357"></a><span id="l44.357" class="difflineplus">+        earliestIndex--;</span>
<a href="#l44.358"></a><span id="l44.358" class="difflineplus">+        batch = getItem(</span>
<a href="#l44.359"></a><span id="l44.359" class="difflineplus">+            this.store, keyName(room.roomId, &quot;timeline&quot;, earliestIndex)</span>
<a href="#l44.360"></a><span id="l44.360" class="difflineplus">+        );</span>
<a href="#l44.361"></a><span id="l44.361" class="difflineplus">+        if (!batch) {</span>
<a href="#l44.362"></a><span id="l44.362" class="difflineplus">+            // no more events</span>
<a href="#l44.363"></a><span id="l44.363" class="difflineplus">+            debuglog(&quot;No batch found at index %s&quot;, earliestIndex);</span>
<a href="#l44.364"></a><span id="l44.364" class="difflineplus">+            break;</span>
<a href="#l44.365"></a><span id="l44.365" class="difflineplus">+        }</span>
<a href="#l44.366"></a><span id="l44.366" class="difflineplus">+        for (i = batch.length - 1; i &gt;= 0; i--) {</span>
<a href="#l44.367"></a><span id="l44.367" class="difflineplus">+            debuglog(&quot;Add event at position %s in batch %s&quot;, i, earliestIndex);</span>
<a href="#l44.368"></a><span id="l44.368" class="difflineplus">+            scrollback.push(batch[i]);</span>
<a href="#l44.369"></a><span id="l44.369" class="difflineplus">+            if (scrollback.length === limit) {</span>
<a href="#l44.370"></a><span id="l44.370" class="difflineplus">+                break;</span>
<a href="#l44.371"></a><span id="l44.371" class="difflineplus">+            }</span>
<a href="#l44.372"></a><span id="l44.372" class="difflineplus">+        }</span>
<a href="#l44.373"></a><span id="l44.373" class="difflineplus">+    }</span>
<a href="#l44.374"></a><span id="l44.374" class="difflineplus">+    debuglog(</span>
<a href="#l44.375"></a><span id="l44.375" class="difflineplus">+        &quot;Out of %s requested events, returning %s. New index=%s&quot;,</span>
<a href="#l44.376"></a><span id="l44.376" class="difflineplus">+        limit, scrollback.length, earliestIndex</span>
<a href="#l44.377"></a><span id="l44.377" class="difflineplus">+    );</span>
<a href="#l44.378"></a><span id="l44.378" class="difflineplus">+    room.addEventsToTimeline(utils.map(scrollback, function(e) {</span>
<a href="#l44.379"></a><span id="l44.379" class="difflineplus">+            return new MatrixEvent(e);</span>
<a href="#l44.380"></a><span id="l44.380" class="difflineplus">+    }), true, room.getLiveTimeline());</span>
<a href="#l44.381"></a><span id="l44.381" class="difflineplus">+</span>
<a href="#l44.382"></a><span id="l44.382" class="difflineplus">+    this._tokens[room.storageToken] = {</span>
<a href="#l44.383"></a><span id="l44.383" class="difflineplus">+        earliestIndex: earliestIndex</span>
<a href="#l44.384"></a><span id="l44.384" class="difflineplus">+    };</span>
<a href="#l44.385"></a><span id="l44.385" class="difflineplus">+    return scrollback;</span>
<a href="#l44.386"></a><span id="l44.386" class="difflineplus">+};</span>
<a href="#l44.387"></a><span id="l44.387" class="difflineplus">+</span>
<a href="#l44.388"></a><span id="l44.388" class="difflineplus">+/**</span>
<a href="#l44.389"></a><span id="l44.389" class="difflineplus">+ * Store events for a room. The events have already been added to the timeline.</span>
<a href="#l44.390"></a><span id="l44.390" class="difflineplus">+ * @param {Room} room The room to store events for.</span>
<a href="#l44.391"></a><span id="l44.391" class="difflineplus">+ * @param {Array&lt;MatrixEvent&gt;} events The events to store.</span>
<a href="#l44.392"></a><span id="l44.392" class="difflineplus">+ * @param {string} token The token associated with these events.</span>
<a href="#l44.393"></a><span id="l44.393" class="difflineplus">+ * @param {boolean} toStart True if these are paginated results. The last element</span>
<a href="#l44.394"></a><span id="l44.394" class="difflineplus">+ * is the 'oldest' (for parity with homeserver scrollback APIs).</span>
<a href="#l44.395"></a><span id="l44.395" class="difflineplus">+ */</span>
<a href="#l44.396"></a><span id="l44.396" class="difflineplus">+WebStorageStore.prototype.storeEvents = function(room, events, token, toStart) {</span>
<a href="#l44.397"></a><span id="l44.397" class="difflineplus">+    if (toStart) {</span>
<a href="#l44.398"></a><span id="l44.398" class="difflineplus">+        // add paginated events to lowest batch indexes (can go -ve)</span>
<a href="#l44.399"></a><span id="l44.399" class="difflineplus">+        var lowIndex = getIndexExtremity(</span>
<a href="#l44.400"></a><span id="l44.400" class="difflineplus">+            getTimelineIndices(this.store, room.roomId), true</span>
<a href="#l44.401"></a><span id="l44.401" class="difflineplus">+        );</span>
<a href="#l44.402"></a><span id="l44.402" class="difflineplus">+        var i, key, batch;</span>
<a href="#l44.403"></a><span id="l44.403" class="difflineplus">+        for (i = 0; i &lt; events.length; i++) { // loop events to be stored</span>
<a href="#l44.404"></a><span id="l44.404" class="difflineplus">+            key = keyName(room.roomId, &quot;timeline&quot;, lowIndex);</span>
<a href="#l44.405"></a><span id="l44.405" class="difflineplus">+            batch = getItem(this.store, key) || [];</span>
<a href="#l44.406"></a><span id="l44.406" class="difflineplus">+            while (batch.length &lt; this.batchSize &amp;&amp; i &lt; events.length) {</span>
<a href="#l44.407"></a><span id="l44.407" class="difflineplus">+                batch.unshift(events[i].event);</span>
<a href="#l44.408"></a><span id="l44.408" class="difflineplus">+                i++; // increment to insert next event into this batch</span>
<a href="#l44.409"></a><span id="l44.409" class="difflineplus">+            }</span>
<a href="#l44.410"></a><span id="l44.410" class="difflineplus">+            i--; // decrement to avoid skipping one (for loop ++s)</span>
<a href="#l44.411"></a><span id="l44.411" class="difflineplus">+            setItem(this.store, key, batch);</span>
<a href="#l44.412"></a><span id="l44.412" class="difflineplus">+            lowIndex--; // decrement index to get a new batch.</span>
<a href="#l44.413"></a><span id="l44.413" class="difflineplus">+        }</span>
<a href="#l44.414"></a><span id="l44.414" class="difflineplus">+    }</span>
<a href="#l44.415"></a><span id="l44.415" class="difflineplus">+    else {</span>
<a href="#l44.416"></a><span id="l44.416" class="difflineplus">+        // dump as live events</span>
<a href="#l44.417"></a><span id="l44.417" class="difflineplus">+        var liveEvents = getItem(</span>
<a href="#l44.418"></a><span id="l44.418" class="difflineplus">+            this.store, keyName(room.roomId, &quot;timeline&quot;, &quot;live&quot;)</span>
<a href="#l44.419"></a><span id="l44.419" class="difflineplus">+        ) || [];</span>
<a href="#l44.420"></a><span id="l44.420" class="difflineplus">+        debuglog(</span>
<a href="#l44.421"></a><span id="l44.421" class="difflineplus">+            &quot;Adding %s events to %s live list (which has %s already)&quot;,</span>
<a href="#l44.422"></a><span id="l44.422" class="difflineplus">+            events.length, room.roomId, liveEvents.length</span>
<a href="#l44.423"></a><span id="l44.423" class="difflineplus">+        );</span>
<a href="#l44.424"></a><span id="l44.424" class="difflineplus">+        var updateState = false;</span>
<a href="#l44.425"></a><span id="l44.425" class="difflineplus">+        liveEvents = liveEvents.concat(utils.map(events, function(me) {</span>
<a href="#l44.426"></a><span id="l44.426" class="difflineplus">+            // cheeky check to avoid looping twice</span>
<a href="#l44.427"></a><span id="l44.427" class="difflineplus">+            if (me.isState()) {</span>
<a href="#l44.428"></a><span id="l44.428" class="difflineplus">+                updateState = true;</span>
<a href="#l44.429"></a><span id="l44.429" class="difflineplus">+            }</span>
<a href="#l44.430"></a><span id="l44.430" class="difflineplus">+            return me.event;</span>
<a href="#l44.431"></a><span id="l44.431" class="difflineplus">+        }));</span>
<a href="#l44.432"></a><span id="l44.432" class="difflineplus">+        setItem(</span>
<a href="#l44.433"></a><span id="l44.433" class="difflineplus">+            this.store, keyName(room.roomId, &quot;timeline&quot;, &quot;live&quot;), liveEvents</span>
<a href="#l44.434"></a><span id="l44.434" class="difflineplus">+        );</span>
<a href="#l44.435"></a><span id="l44.435" class="difflineplus">+        if (updateState) {</span>
<a href="#l44.436"></a><span id="l44.436" class="difflineplus">+            debuglog(&quot;Storing state for %s as new events updated state&quot;, room.roomId);</span>
<a href="#l44.437"></a><span id="l44.437" class="difflineplus">+            // use 0 batch size; we don't care about batching right now.</span>
<a href="#l44.438"></a><span id="l44.438" class="difflineplus">+            var serRoom = SerialisedRoom.fromRoom(room, 0);</span>
<a href="#l44.439"></a><span id="l44.439" class="difflineplus">+            setItem(this.store, keyName(serRoom.roomId, &quot;state&quot;), serRoom.state);</span>
<a href="#l44.440"></a><span id="l44.440" class="difflineplus">+        }</span>
<a href="#l44.441"></a><span id="l44.441" class="difflineplus">+    }</span>
<a href="#l44.442"></a><span id="l44.442" class="difflineplus">+};</span>
<a href="#l44.443"></a><span id="l44.443" class="difflineplus">+</span>
<a href="#l44.444"></a><span id="l44.444" class="difflineplus">+/**</span>
<a href="#l44.445"></a><span id="l44.445" class="difflineplus">+ * Sync the 'live' timeline, batching live events according to 'batchSize'.</span>
<a href="#l44.446"></a><span id="l44.446" class="difflineplus">+ * @param {string} roomId The room to sync the timeline.</span>
<a href="#l44.447"></a><span id="l44.447" class="difflineplus">+ * @param {Array&lt;String&gt;} timelineIndices Optional. The indices in the timeline</span>
<a href="#l44.448"></a><span id="l44.448" class="difflineplus">+ * if known already.</span>
<a href="#l44.449"></a><span id="l44.449" class="difflineplus">+ */</span>
<a href="#l44.450"></a><span id="l44.450" class="difflineplus">+WebStorageStore.prototype._syncTimeline = function(roomId, timelineIndices) {</span>
<a href="#l44.451"></a><span id="l44.451" class="difflineplus">+    timelineIndices = timelineIndices || getTimelineIndices(this.store, roomId);</span>
<a href="#l44.452"></a><span id="l44.452" class="difflineplus">+    var liveEvents = getItem(this.store, keyName(roomId, &quot;timeline&quot;, &quot;live&quot;)) || [];</span>
<a href="#l44.453"></a><span id="l44.453" class="difflineplus">+</span>
<a href="#l44.454"></a><span id="l44.454" class="difflineplus">+    // get the highest numbered $INDEX batch</span>
<a href="#l44.455"></a><span id="l44.455" class="difflineplus">+    var highestIndex = getIndexExtremity(timelineIndices);</span>
<a href="#l44.456"></a><span id="l44.456" class="difflineplus">+    var hiKey = keyName(roomId, &quot;timeline&quot;, highestIndex);</span>
<a href="#l44.457"></a><span id="l44.457" class="difflineplus">+    var hiBatch = getItem(this.store, hiKey) || [];</span>
<a href="#l44.458"></a><span id="l44.458" class="difflineplus">+    // fill up the existing batch first.</span>
<a href="#l44.459"></a><span id="l44.459" class="difflineplus">+    while (hiBatch.length &lt; this.batchSize &amp;&amp; liveEvents.length &gt; 0) {</span>
<a href="#l44.460"></a><span id="l44.460" class="difflineplus">+        hiBatch.push(liveEvents.shift());</span>
<a href="#l44.461"></a><span id="l44.461" class="difflineplus">+    }</span>
<a href="#l44.462"></a><span id="l44.462" class="difflineplus">+    setItem(this.store, hiKey, hiBatch);</span>
<a href="#l44.463"></a><span id="l44.463" class="difflineplus">+</span>
<a href="#l44.464"></a><span id="l44.464" class="difflineplus">+    // start adding new batches as required</span>
<a href="#l44.465"></a><span id="l44.465" class="difflineplus">+    var batch = [];</span>
<a href="#l44.466"></a><span id="l44.466" class="difflineplus">+    while (liveEvents.length &gt; 0) {</span>
<a href="#l44.467"></a><span id="l44.467" class="difflineplus">+        batch.push(liveEvents.shift());</span>
<a href="#l44.468"></a><span id="l44.468" class="difflineplus">+        if (batch.length === this.batchSize || liveEvents.length === 0) {</span>
<a href="#l44.469"></a><span id="l44.469" class="difflineplus">+            // persist the full batch and make another</span>
<a href="#l44.470"></a><span id="l44.470" class="difflineplus">+            highestIndex++;</span>
<a href="#l44.471"></a><span id="l44.471" class="difflineplus">+            hiKey = keyName(roomId, &quot;timeline&quot;, highestIndex);</span>
<a href="#l44.472"></a><span id="l44.472" class="difflineplus">+            setItem(this.store, hiKey, batch);</span>
<a href="#l44.473"></a><span id="l44.473" class="difflineplus">+            batch = [];</span>
<a href="#l44.474"></a><span id="l44.474" class="difflineplus">+        }</span>
<a href="#l44.475"></a><span id="l44.475" class="difflineplus">+    }</span>
<a href="#l44.476"></a><span id="l44.476" class="difflineplus">+    // reset live array</span>
<a href="#l44.477"></a><span id="l44.477" class="difflineplus">+    setItem(this.store, keyName(roomId, &quot;timeline&quot;, &quot;live&quot;), []);</span>
<a href="#l44.478"></a><span id="l44.478" class="difflineplus">+};</span>
<a href="#l44.479"></a><span id="l44.479" class="difflineplus">+</span>
<a href="#l44.480"></a><span id="l44.480" class="difflineplus">+</span>
<a href="#l44.481"></a><span id="l44.481" class="difflineplus">+/**</span>
<a href="#l44.482"></a><span id="l44.482" class="difflineplus">+ * Store a filter.</span>
<a href="#l44.483"></a><span id="l44.483" class="difflineplus">+ * @param {Filter} filter</span>
<a href="#l44.484"></a><span id="l44.484" class="difflineplus">+ */</span>
<a href="#l44.485"></a><span id="l44.485" class="difflineplus">+WebStorageStore.prototype.storeFilter = function(filter) {</span>
<a href="#l44.486"></a><span id="l44.486" class="difflineplus">+};</span>
<a href="#l44.487"></a><span id="l44.487" class="difflineplus">+</span>
<a href="#l44.488"></a><span id="l44.488" class="difflineplus">+/**</span>
<a href="#l44.489"></a><span id="l44.489" class="difflineplus">+ * Retrieve a filter.</span>
<a href="#l44.490"></a><span id="l44.490" class="difflineplus">+ * @param {string} userId</span>
<a href="#l44.491"></a><span id="l44.491" class="difflineplus">+ * @param {string} filterId</span>
<a href="#l44.492"></a><span id="l44.492" class="difflineplus">+ * @return {?Filter} A filter or null.</span>
<a href="#l44.493"></a><span id="l44.493" class="difflineplus">+ */</span>
<a href="#l44.494"></a><span id="l44.494" class="difflineplus">+WebStorageStore.prototype.getFilter = function(userId, filterId) {</span>
<a href="#l44.495"></a><span id="l44.495" class="difflineplus">+    return null;</span>
<a href="#l44.496"></a><span id="l44.496" class="difflineplus">+};</span>
<a href="#l44.497"></a><span id="l44.497" class="difflineplus">+</span>
<a href="#l44.498"></a><span id="l44.498" class="difflineplus">+function SerialisedRoom(roomId) {</span>
<a href="#l44.499"></a><span id="l44.499" class="difflineplus">+    this.state = {</span>
<a href="#l44.500"></a><span id="l44.500" class="difflineplus">+        events: {}</span>
<a href="#l44.501"></a><span id="l44.501" class="difflineplus">+    };</span>
<a href="#l44.502"></a><span id="l44.502" class="difflineplus">+    this.timeline = {</span>
<a href="#l44.503"></a><span id="l44.503" class="difflineplus">+        // $INDEX: []</span>
<a href="#l44.504"></a><span id="l44.504" class="difflineplus">+    };</span>
<a href="#l44.505"></a><span id="l44.505" class="difflineplus">+    this.roomId = roomId;</span>
<a href="#l44.506"></a><span id="l44.506" class="difflineplus">+}</span>
<a href="#l44.507"></a><span id="l44.507" class="difflineplus">+</span>
<a href="#l44.508"></a><span id="l44.508" class="difflineplus">+/**</span>
<a href="#l44.509"></a><span id="l44.509" class="difflineplus">+ * Convert a Room instance into a SerialisedRoom instance which can be stored</span>
<a href="#l44.510"></a><span id="l44.510" class="difflineplus">+ * in the key value store.</span>
<a href="#l44.511"></a><span id="l44.511" class="difflineplus">+ * @param {Room} room The matrix room to convert</span>
<a href="#l44.512"></a><span id="l44.512" class="difflineplus">+ * @param {integer} batchSize The number of events per timeline batch</span>
<a href="#l44.513"></a><span id="l44.513" class="difflineplus">+ * @return {SerialisedRoom} A serialised room representation of 'room'.</span>
<a href="#l44.514"></a><span id="l44.514" class="difflineplus">+ */</span>
<a href="#l44.515"></a><span id="l44.515" class="difflineplus">+SerialisedRoom.fromRoom = function(room, batchSize) {</span>
<a href="#l44.516"></a><span id="l44.516" class="difflineplus">+    var self = new SerialisedRoom(room.roomId);</span>
<a href="#l44.517"></a><span id="l44.517" class="difflineplus">+    var index;</span>
<a href="#l44.518"></a><span id="l44.518" class="difflineplus">+    self.state.pagination_token = room.oldState.paginationToken;</span>
<a href="#l44.519"></a><span id="l44.519" class="difflineplus">+    // [room_$ROOMID_state] downcast to POJO from MatrixEvent</span>
<a href="#l44.520"></a><span id="l44.520" class="difflineplus">+    utils.forEach(utils.keys(room.currentState.events), function(eventType) {</span>
<a href="#l44.521"></a><span id="l44.521" class="difflineplus">+        utils.forEach(utils.keys(room.currentState.events[eventType]), function(skey) {</span>
<a href="#l44.522"></a><span id="l44.522" class="difflineplus">+            if (!self.state.events[eventType]) {</span>
<a href="#l44.523"></a><span id="l44.523" class="difflineplus">+                self.state.events[eventType] = {};</span>
<a href="#l44.524"></a><span id="l44.524" class="difflineplus">+            }</span>
<a href="#l44.525"></a><span id="l44.525" class="difflineplus">+            self.state.events[eventType][skey] = (</span>
<a href="#l44.526"></a><span id="l44.526" class="difflineplus">+                room.currentState.events[eventType][skey].event</span>
<a href="#l44.527"></a><span id="l44.527" class="difflineplus">+            );</span>
<a href="#l44.528"></a><span id="l44.528" class="difflineplus">+        });</span>
<a href="#l44.529"></a><span id="l44.529" class="difflineplus">+    });</span>
<a href="#l44.530"></a><span id="l44.530" class="difflineplus">+</span>
<a href="#l44.531"></a><span id="l44.531" class="difflineplus">+    // [room_$ROOMID_timeline_$INDEX]</span>
<a href="#l44.532"></a><span id="l44.532" class="difflineplus">+    if (batchSize &gt; 0) {</span>
<a href="#l44.533"></a><span id="l44.533" class="difflineplus">+        index = 0;</span>
<a href="#l44.534"></a><span id="l44.534" class="difflineplus">+        while (index * batchSize &lt; room.timeline.length) {</span>
<a href="#l44.535"></a><span id="l44.535" class="difflineplus">+            self.timeline[index] = room.timeline.slice(</span>
<a href="#l44.536"></a><span id="l44.536" class="difflineplus">+                index * batchSize, (index + 1) * batchSize</span>
<a href="#l44.537"></a><span id="l44.537" class="difflineplus">+            );</span>
<a href="#l44.538"></a><span id="l44.538" class="difflineplus">+            self.timeline[index] = utils.map(self.timeline[index], function(me) {</span>
<a href="#l44.539"></a><span id="l44.539" class="difflineplus">+                // use POJO not MatrixEvent</span>
<a href="#l44.540"></a><span id="l44.540" class="difflineplus">+                return me.event;</span>
<a href="#l44.541"></a><span id="l44.541" class="difflineplus">+            });</span>
<a href="#l44.542"></a><span id="l44.542" class="difflineplus">+            index++;</span>
<a href="#l44.543"></a><span id="l44.543" class="difflineplus">+        }</span>
<a href="#l44.544"></a><span id="l44.544" class="difflineplus">+    }</span>
<a href="#l44.545"></a><span id="l44.545" class="difflineplus">+    else { // don't batch</span>
<a href="#l44.546"></a><span id="l44.546" class="difflineplus">+        self.timeline[0] = utils.map(room.timeline, function(matrixEvent) {</span>
<a href="#l44.547"></a><span id="l44.547" class="difflineplus">+            return matrixEvent.event;</span>
<a href="#l44.548"></a><span id="l44.548" class="difflineplus">+        });</span>
<a href="#l44.549"></a><span id="l44.549" class="difflineplus">+    }</span>
<a href="#l44.550"></a><span id="l44.550" class="difflineplus">+    return self;</span>
<a href="#l44.551"></a><span id="l44.551" class="difflineplus">+};</span>
<a href="#l44.552"></a><span id="l44.552" class="difflineplus">+</span>
<a href="#l44.553"></a><span id="l44.553" class="difflineplus">+function loadRoom(store, roomId, numEvents, tokenArray) {</span>
<a href="#l44.554"></a><span id="l44.554" class="difflineplus">+    var room = new Room(roomId, {</span>
<a href="#l44.555"></a><span id="l44.555" class="difflineplus">+        storageToken: tokenArray.length</span>
<a href="#l44.556"></a><span id="l44.556" class="difflineplus">+    });</span>
<a href="#l44.557"></a><span id="l44.557" class="difflineplus">+</span>
<a href="#l44.558"></a><span id="l44.558" class="difflineplus">+    // populate state (flatten nested struct to event array)</span>
<a href="#l44.559"></a><span id="l44.559" class="difflineplus">+    var currentStateMap = getItem(store, keyName(roomId, &quot;state&quot;));</span>
<a href="#l44.560"></a><span id="l44.560" class="difflineplus">+    var stateEvents = [];</span>
<a href="#l44.561"></a><span id="l44.561" class="difflineplus">+    utils.forEach(utils.keys(currentStateMap.events), function(eventType) {</span>
<a href="#l44.562"></a><span id="l44.562" class="difflineplus">+        utils.forEach(utils.keys(currentStateMap.events[eventType]), function(skey) {</span>
<a href="#l44.563"></a><span id="l44.563" class="difflineplus">+            stateEvents.push(currentStateMap.events[eventType][skey]);</span>
<a href="#l44.564"></a><span id="l44.564" class="difflineplus">+        });</span>
<a href="#l44.565"></a><span id="l44.565" class="difflineplus">+    });</span>
<a href="#l44.566"></a><span id="l44.566" class="difflineplus">+    // TODO: Fix logic dupe with MatrixClient._processRoomEvents</span>
<a href="#l44.567"></a><span id="l44.567" class="difflineplus">+    var oldStateEvents = utils.map(</span>
<a href="#l44.568"></a><span id="l44.568" class="difflineplus">+        utils.deepCopy(stateEvents), function(e) {</span>
<a href="#l44.569"></a><span id="l44.569" class="difflineplus">+            return new MatrixEvent(e);</span>
<a href="#l44.570"></a><span id="l44.570" class="difflineplus">+        }</span>
<a href="#l44.571"></a><span id="l44.571" class="difflineplus">+    );</span>
<a href="#l44.572"></a><span id="l44.572" class="difflineplus">+    var currentStateEvents = utils.map(stateEvents, function(e) {</span>
<a href="#l44.573"></a><span id="l44.573" class="difflineplus">+            return new MatrixEvent(e);</span>
<a href="#l44.574"></a><span id="l44.574" class="difflineplus">+        }</span>
<a href="#l44.575"></a><span id="l44.575" class="difflineplus">+    );</span>
<a href="#l44.576"></a><span id="l44.576" class="difflineplus">+    room.oldState.setStateEvents(oldStateEvents);</span>
<a href="#l44.577"></a><span id="l44.577" class="difflineplus">+    room.currentState.setStateEvents(currentStateEvents);</span>
<a href="#l44.578"></a><span id="l44.578" class="difflineplus">+</span>
<a href="#l44.579"></a><span id="l44.579" class="difflineplus">+    // add most recent numEvents</span>
<a href="#l44.580"></a><span id="l44.580" class="difflineplus">+    var recentEvents = [];</span>
<a href="#l44.581"></a><span id="l44.581" class="difflineplus">+    var index = getIndexExtremity(getTimelineIndices(store, roomId));</span>
<a href="#l44.582"></a><span id="l44.582" class="difflineplus">+    var eventIndex = index;</span>
<a href="#l44.583"></a><span id="l44.583" class="difflineplus">+    var i, key, batch;</span>
<a href="#l44.584"></a><span id="l44.584" class="difflineplus">+    while (recentEvents.length &lt; numEvents) {</span>
<a href="#l44.585"></a><span id="l44.585" class="difflineplus">+        key = keyName(roomId, &quot;timeline&quot;, index);</span>
<a href="#l44.586"></a><span id="l44.586" class="difflineplus">+        batch = getItem(store, key) || [];</span>
<a href="#l44.587"></a><span id="l44.587" class="difflineplus">+        if (batch.length === 0) {</span>
<a href="#l44.588"></a><span id="l44.588" class="difflineplus">+            // nothing left in the store.</span>
<a href="#l44.589"></a><span id="l44.589" class="difflineplus">+            break;</span>
<a href="#l44.590"></a><span id="l44.590" class="difflineplus">+        }</span>
<a href="#l44.591"></a><span id="l44.591" class="difflineplus">+        for (i = batch.length - 1; i &gt;= 0; i--) {</span>
<a href="#l44.592"></a><span id="l44.592" class="difflineplus">+            recentEvents.unshift(new MatrixEvent(batch[i]));</span>
<a href="#l44.593"></a><span id="l44.593" class="difflineplus">+            if (recentEvents.length === numEvents) {</span>
<a href="#l44.594"></a><span id="l44.594" class="difflineplus">+                eventIndex = index;</span>
<a href="#l44.595"></a><span id="l44.595" class="difflineplus">+                break;</span>
<a href="#l44.596"></a><span id="l44.596" class="difflineplus">+            }</span>
<a href="#l44.597"></a><span id="l44.597" class="difflineplus">+        }</span>
<a href="#l44.598"></a><span id="l44.598" class="difflineplus">+        index--;</span>
<a href="#l44.599"></a><span id="l44.599" class="difflineplus">+    }</span>
<a href="#l44.600"></a><span id="l44.600" class="difflineplus">+    // add events backwards to diverge old state correctly.</span>
<a href="#l44.601"></a><span id="l44.601" class="difflineplus">+    room.addEventsToTimeline(recentEvents.reverse(), true, room.getLiveTimeline());</span>
<a href="#l44.602"></a><span id="l44.602" class="difflineplus">+    room.oldState.paginationToken = currentStateMap.pagination_token;</span>
<a href="#l44.603"></a><span id="l44.603" class="difflineplus">+    // set the token data to let us know which index this room instance is at</span>
<a href="#l44.604"></a><span id="l44.604" class="difflineplus">+    // for scrollback.</span>
<a href="#l44.605"></a><span id="l44.605" class="difflineplus">+    tokenArray.push({</span>
<a href="#l44.606"></a><span id="l44.606" class="difflineplus">+        earliestIndex: eventIndex</span>
<a href="#l44.607"></a><span id="l44.607" class="difflineplus">+    });</span>
<a href="#l44.608"></a><span id="l44.608" class="difflineplus">+    return room;</span>
<a href="#l44.609"></a><span id="l44.609" class="difflineplus">+}</span>
<a href="#l44.610"></a><span id="l44.610" class="difflineplus">+</span>
<a href="#l44.611"></a><span id="l44.611" class="difflineplus">+function persist(store, serRoom) {</span>
<a href="#l44.612"></a><span id="l44.612" class="difflineplus">+    setItem(store, keyName(serRoom.roomId, &quot;state&quot;), serRoom.state);</span>
<a href="#l44.613"></a><span id="l44.613" class="difflineplus">+    utils.forEach(utils.keys(serRoom.timeline), function(index) {</span>
<a href="#l44.614"></a><span id="l44.614" class="difflineplus">+        setItem(store,</span>
<a href="#l44.615"></a><span id="l44.615" class="difflineplus">+            keyName(serRoom.roomId, &quot;timeline&quot;, index),</span>
<a href="#l44.616"></a><span id="l44.616" class="difflineplus">+            serRoom.timeline[index]</span>
<a href="#l44.617"></a><span id="l44.617" class="difflineplus">+        );</span>
<a href="#l44.618"></a><span id="l44.618" class="difflineplus">+    });</span>
<a href="#l44.619"></a><span id="l44.619" class="difflineplus">+}</span>
<a href="#l44.620"></a><span id="l44.620" class="difflineplus">+</span>
<a href="#l44.621"></a><span id="l44.621" class="difflineplus">+function getTimelineIndices(store, roomId) {</span>
<a href="#l44.622"></a><span id="l44.622" class="difflineplus">+    var keys = [];</span>
<a href="#l44.623"></a><span id="l44.623" class="difflineplus">+    for (var i = 0; i &lt; store.length; i++) {</span>
<a href="#l44.624"></a><span id="l44.624" class="difflineplus">+        if (store.key(i).indexOf(keyName(roomId, &quot;timeline_&quot;)) !== -1) {</span>
<a href="#l44.625"></a><span id="l44.625" class="difflineplus">+            // e.g. room_$ROOMID_timeline_0  =&gt;  0</span>
<a href="#l44.626"></a><span id="l44.626" class="difflineplus">+            keys.push(</span>
<a href="#l44.627"></a><span id="l44.627" class="difflineplus">+                store.key(i).replace(keyName(roomId, &quot;timeline_&quot;), &quot;&quot;)</span>
<a href="#l44.628"></a><span id="l44.628" class="difflineplus">+            );</span>
<a href="#l44.629"></a><span id="l44.629" class="difflineplus">+        }</span>
<a href="#l44.630"></a><span id="l44.630" class="difflineplus">+    }</span>
<a href="#l44.631"></a><span id="l44.631" class="difflineplus">+    return keys;</span>
<a href="#l44.632"></a><span id="l44.632" class="difflineplus">+}</span>
<a href="#l44.633"></a><span id="l44.633" class="difflineplus">+</span>
<a href="#l44.634"></a><span id="l44.634" class="difflineplus">+function getIndexExtremity(timelineIndices, getLowest) {</span>
<a href="#l44.635"></a><span id="l44.635" class="difflineplus">+    var extremity, index;</span>
<a href="#l44.636"></a><span id="l44.636" class="difflineplus">+    for (var i = 0; i &lt; timelineIndices.length; i++) {</span>
<a href="#l44.637"></a><span id="l44.637" class="difflineplus">+        index = parseInt(timelineIndices[i]);</span>
<a href="#l44.638"></a><span id="l44.638" class="difflineplus">+        if (!isNaN(index) &amp;&amp; (</span>
<a href="#l44.639"></a><span id="l44.639" class="difflineplus">+                extremity === undefined ||</span>
<a href="#l44.640"></a><span id="l44.640" class="difflineplus">+                !getLowest &amp;&amp; index &gt; extremity ||</span>
<a href="#l44.641"></a><span id="l44.641" class="difflineplus">+                getLowest &amp;&amp; index &lt; extremity)) {</span>
<a href="#l44.642"></a><span id="l44.642" class="difflineplus">+            extremity = index;</span>
<a href="#l44.643"></a><span id="l44.643" class="difflineplus">+        }</span>
<a href="#l44.644"></a><span id="l44.644" class="difflineplus">+    }</span>
<a href="#l44.645"></a><span id="l44.645" class="difflineplus">+    return extremity;</span>
<a href="#l44.646"></a><span id="l44.646" class="difflineplus">+}</span>
<a href="#l44.647"></a><span id="l44.647" class="difflineplus">+</span>
<a href="#l44.648"></a><span id="l44.648" class="difflineplus">+function keyName(roomId, key, index) {</span>
<a href="#l44.649"></a><span id="l44.649" class="difflineplus">+    return &quot;room_&quot; + roomId + &quot;_&quot; + key + (</span>
<a href="#l44.650"></a><span id="l44.650" class="difflineplus">+        index === undefined ? &quot;&quot; : (&quot;_&quot; + index)</span>
<a href="#l44.651"></a><span id="l44.651" class="difflineplus">+    );</span>
<a href="#l44.652"></a><span id="l44.652" class="difflineplus">+}</span>
<a href="#l44.653"></a><span id="l44.653" class="difflineplus">+</span>
<a href="#l44.654"></a><span id="l44.654" class="difflineplus">+function getItem(store, key) {</span>
<a href="#l44.655"></a><span id="l44.655" class="difflineplus">+    try {</span>
<a href="#l44.656"></a><span id="l44.656" class="difflineplus">+        return JSON.parse(store.getItem(key));</span>
<a href="#l44.657"></a><span id="l44.657" class="difflineplus">+    }</span>
<a href="#l44.658"></a><span id="l44.658" class="difflineplus">+    catch (e) {</span>
<a href="#l44.659"></a><span id="l44.659" class="difflineplus">+        debuglog(&quot;Failed to get key %s: %s&quot;, key, e);</span>
<a href="#l44.660"></a><span id="l44.660" class="difflineplus">+        debuglog(e.stack);</span>
<a href="#l44.661"></a><span id="l44.661" class="difflineplus">+    }</span>
<a href="#l44.662"></a><span id="l44.662" class="difflineplus">+    return null;</span>
<a href="#l44.663"></a><span id="l44.663" class="difflineplus">+}</span>
<a href="#l44.664"></a><span id="l44.664" class="difflineplus">+</span>
<a href="#l44.665"></a><span id="l44.665" class="difflineplus">+function setItem(store, key, val) {</span>
<a href="#l44.666"></a><span id="l44.666" class="difflineplus">+    store.setItem(key, JSON.stringify(val));</span>
<a href="#l44.667"></a><span id="l44.667" class="difflineplus">+}</span>
<a href="#l44.668"></a><span id="l44.668" class="difflineplus">+</span>
<a href="#l44.669"></a><span id="l44.669" class="difflineplus">+function debuglog() {</span>
<a href="#l44.670"></a><span id="l44.670" class="difflineplus">+    if (DEBUG) {</span>
<a href="#l44.671"></a><span id="l44.671" class="difflineplus">+        console.log.apply(console, arguments);</span>
<a href="#l44.672"></a><span id="l44.672" class="difflineplus">+    }</span>
<a href="#l44.673"></a><span id="l44.673" class="difflineplus">+}</span>
<a href="#l44.674"></a><span id="l44.674" class="difflineplus">+</span>
<a href="#l44.675"></a><span id="l44.675" class="difflineplus">+/*</span>
<a href="#l44.676"></a><span id="l44.676" class="difflineplus">+function delRoomStruct(store, roomId) {</span>
<a href="#l44.677"></a><span id="l44.677" class="difflineplus">+    var prefix = &quot;room_&quot; + roomId;</span>
<a href="#l44.678"></a><span id="l44.678" class="difflineplus">+    var keysToRemove = [];</span>
<a href="#l44.679"></a><span id="l44.679" class="difflineplus">+    for (var i = 0; i &lt; store.length; i++) {</span>
<a href="#l44.680"></a><span id="l44.680" class="difflineplus">+        if (store.key(i).indexOf(prefix) !== -1) {</span>
<a href="#l44.681"></a><span id="l44.681" class="difflineplus">+            keysToRemove.push(store.key(i));</span>
<a href="#l44.682"></a><span id="l44.682" class="difflineplus">+        }</span>
<a href="#l44.683"></a><span id="l44.683" class="difflineplus">+    }</span>
<a href="#l44.684"></a><span id="l44.684" class="difflineplus">+    utils.forEach(keysToRemove, function(key) {</span>
<a href="#l44.685"></a><span id="l44.685" class="difflineplus">+        store.removeItem(key);</span>
<a href="#l44.686"></a><span id="l44.686" class="difflineplus">+    });</span>
<a href="#l44.687"></a><span id="l44.687" class="difflineplus">+} */</span>
<a href="#l44.688"></a><span id="l44.688" class="difflineplus">+</span>
<a href="#l44.689"></a><span id="l44.689" class="difflineplus">+/** Web Storage Store class. */</span>
<a href="#l44.690"></a><span id="l44.690" class="difflineplus">+module.exports = WebStorageStore;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l45.1"></a><span id="l45.1">new file mode 100644</span>
<a href="#l45.2"></a><span id="l45.2" class="difflineminus">--- /dev/null</span>
<a href="#l45.3"></a><span id="l45.3" class="difflineplus">+++ b/chat/protocols/matrix/matrix-sdk/sync.js</span>
<a href="#l45.4"></a><span id="l45.4" class="difflineat">@@ -0,0 +1,1138 @@</span>
<a href="#l45.5"></a><span id="l45.5" class="difflineplus">+/*</span>
<a href="#l45.6"></a><span id="l45.6" class="difflineplus">+Copyright 2015, 2016 OpenMarket Ltd</span>
<a href="#l45.7"></a><span id="l45.7" class="difflineplus">+</span>
<a href="#l45.8"></a><span id="l45.8" class="difflineplus">+Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<a href="#l45.9"></a><span id="l45.9" class="difflineplus">+you may not use this file except in compliance with the License.</span>
<a href="#l45.10"></a><span id="l45.10" class="difflineplus">+You may obtain a copy of the License at</span>
<a href="#l45.11"></a><span id="l45.11" class="difflineplus">+</span>
<a href="#l45.12"></a><span id="l45.12" class="difflineplus">+    http://www.apache.org/licenses/LICENSE-2.0</span>
<a href="#l45.13"></a><span id="l45.13" class="difflineplus">+</span>
<a href="#l45.14"></a><span id="l45.14" class="difflineplus">+Unless required by applicable law or agreed to in writing, software</span>
<a href="#l45.15"></a><span id="l45.15" class="difflineplus">+distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<a href="#l45.16"></a><span id="l45.16" class="difflineplus">+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<a href="#l45.17"></a><span id="l45.17" class="difflineplus">+See the License for the specific language governing permissions and</span>
<a href="#l45.18"></a><span id="l45.18" class="difflineplus">+limitations under the License.</span>
<a href="#l45.19"></a><span id="l45.19" class="difflineplus">+*/</span>
<a href="#l45.20"></a><span id="l45.20" class="difflineplus">+&quot;use strict&quot;;</span>
<a href="#l45.21"></a><span id="l45.21" class="difflineplus">+</span>
<a href="#l45.22"></a><span id="l45.22" class="difflineplus">+/*</span>
<a href="#l45.23"></a><span id="l45.23" class="difflineplus">+ * TODO:</span>
<a href="#l45.24"></a><span id="l45.24" class="difflineplus">+ * This class mainly serves to take all the syncing logic out of client.js and</span>
<a href="#l45.25"></a><span id="l45.25" class="difflineplus">+ * into a separate file. It's all very fluid, and this class gut wrenches a lot</span>
<a href="#l45.26"></a><span id="l45.26" class="difflineplus">+ * of MatrixClient props (e.g. _http). Given we want to support WebSockets as</span>
<a href="#l45.27"></a><span id="l45.27" class="difflineplus">+ * an alternative syncing API, we may want to have a proper syncing interface</span>
<a href="#l45.28"></a><span id="l45.28" class="difflineplus">+ * for HTTP and WS at some point.</span>
<a href="#l45.29"></a><span id="l45.29" class="difflineplus">+ */</span>
<a href="#l45.30"></a><span id="l45.30" class="difflineplus">+var q = require(&quot;q&quot;);</span>
<a href="#l45.31"></a><span id="l45.31" class="difflineplus">+var User = require(&quot;./models/user&quot;);</span>
<a href="#l45.32"></a><span id="l45.32" class="difflineplus">+var Room = require(&quot;./models/room&quot;);</span>
<a href="#l45.33"></a><span id="l45.33" class="difflineplus">+var utils = require(&quot;./utils&quot;);</span>
<a href="#l45.34"></a><span id="l45.34" class="difflineplus">+var Filter = require(&quot;./filter&quot;);</span>
<a href="#l45.35"></a><span id="l45.35" class="difflineplus">+var EventTimeline = require(&quot;./models/event-timeline&quot;);</span>
<a href="#l45.36"></a><span id="l45.36" class="difflineplus">+</span>
<a href="#l45.37"></a><span id="l45.37" class="difflineplus">+var DEBUG = true;</span>
<a href="#l45.38"></a><span id="l45.38" class="difflineplus">+</span>
<a href="#l45.39"></a><span id="l45.39" class="difflineplus">+// /sync requests allow you to set a timeout= but the request may continue</span>
<a href="#l45.40"></a><span id="l45.40" class="difflineplus">+// beyond that and wedge forever, so we need to track how long we are willing</span>
<a href="#l45.41"></a><span id="l45.41" class="difflineplus">+// to keep open the connection. This constant is *ADDED* to the timeout= value</span>
<a href="#l45.42"></a><span id="l45.42" class="difflineplus">+// to determine the max time we're willing to wait.</span>
<a href="#l45.43"></a><span id="l45.43" class="difflineplus">+var BUFFER_PERIOD_MS = 80 * 1000;</span>
<a href="#l45.44"></a><span id="l45.44" class="difflineplus">+</span>
<a href="#l45.45"></a><span id="l45.45" class="difflineplus">+function getFilterName(userId, suffix) {</span>
<a href="#l45.46"></a><span id="l45.46" class="difflineplus">+    // scope this on the user ID because people may login on many accounts</span>
<a href="#l45.47"></a><span id="l45.47" class="difflineplus">+    // and they all need to be stored!</span>
<a href="#l45.48"></a><span id="l45.48" class="difflineplus">+    return &quot;FILTER_SYNC_&quot; + userId + (suffix ? &quot;_&quot; + suffix : &quot;&quot;);</span>
<a href="#l45.49"></a><span id="l45.49" class="difflineplus">+}</span>
<a href="#l45.50"></a><span id="l45.50" class="difflineplus">+</span>
<a href="#l45.51"></a><span id="l45.51" class="difflineplus">+function debuglog() {</span>
<a href="#l45.52"></a><span id="l45.52" class="difflineplus">+    if (!DEBUG) { return; }</span>
<a href="#l45.53"></a><span id="l45.53" class="difflineplus">+    console.log.apply(console, arguments);</span>
<a href="#l45.54"></a><span id="l45.54" class="difflineplus">+}</span>
<a href="#l45.55"></a><span id="l45.55" class="difflineplus">+</span>
<a href="#l45.56"></a><span id="l45.56" class="difflineplus">+</span>
<a href="#l45.57"></a><span id="l45.57" class="difflineplus">+/**</span>
<a href="#l45.58"></a><span id="l45.58" class="difflineplus">+ * &lt;b&gt;Internal class - unstable.&lt;/b&gt;</span>
<a href="#l45.59"></a><span id="l45.59" class="difflineplus">+ * Construct an entity which is able to sync with a homeserver.</span>
<a href="#l45.60"></a><span id="l45.60" class="difflineplus">+ * @constructor</span>
<a href="#l45.61"></a><span id="l45.61" class="difflineplus">+ * @param {MatrixClient} client The matrix client instance to use.</span>
<a href="#l45.62"></a><span id="l45.62" class="difflineplus">+ * @param {Object} opts Config options</span>
<a href="#l45.63"></a><span id="l45.63" class="difflineplus">+ */</span>
<a href="#l45.64"></a><span id="l45.64" class="difflineplus">+function SyncApi(client, opts) {</span>
<a href="#l45.65"></a><span id="l45.65" class="difflineplus">+    this.client = client;</span>
<a href="#l45.66"></a><span id="l45.66" class="difflineplus">+    opts = opts || {};</span>
<a href="#l45.67"></a><span id="l45.67" class="difflineplus">+    opts.initialSyncLimit = (</span>
<a href="#l45.68"></a><span id="l45.68" class="difflineplus">+        opts.initialSyncLimit === undefined ? 8 : opts.initialSyncLimit</span>
<a href="#l45.69"></a><span id="l45.69" class="difflineplus">+    );</span>
<a href="#l45.70"></a><span id="l45.70" class="difflineplus">+    opts.resolveInvitesToProfiles = opts.resolveInvitesToProfiles || false;</span>
<a href="#l45.71"></a><span id="l45.71" class="difflineplus">+    opts.pollTimeout = opts.pollTimeout || (30 * 1000);</span>
<a href="#l45.72"></a><span id="l45.72" class="difflineplus">+    opts.pendingEventOrdering = opts.pendingEventOrdering || &quot;chronological&quot;;</span>
<a href="#l45.73"></a><span id="l45.73" class="difflineplus">+    this.opts = opts;</span>
<a href="#l45.74"></a><span id="l45.74" class="difflineplus">+    this._peekRoomId = null;</span>
<a href="#l45.75"></a><span id="l45.75" class="difflineplus">+    this._currentSyncRequest = null;</span>
<a href="#l45.76"></a><span id="l45.76" class="difflineplus">+    this._syncState = null;</span>
<a href="#l45.77"></a><span id="l45.77" class="difflineplus">+    this._running = false;</span>
<a href="#l45.78"></a><span id="l45.78" class="difflineplus">+    this._keepAliveTimer = null;</span>
<a href="#l45.79"></a><span id="l45.79" class="difflineplus">+    this._connectionReturnedDefer = null;</span>
<a href="#l45.80"></a><span id="l45.80" class="difflineplus">+    this._notifEvents = []; // accumulator of sync events in the current sync response</span>
<a href="#l45.81"></a><span id="l45.81" class="difflineplus">+</span>
<a href="#l45.82"></a><span id="l45.82" class="difflineplus">+    if (client.getNotifTimelineSet()) {</span>
<a href="#l45.83"></a><span id="l45.83" class="difflineplus">+        reEmit(client, client.getNotifTimelineSet(),</span>
<a href="#l45.84"></a><span id="l45.84" class="difflineplus">+               [&quot;Room.timeline&quot;, &quot;Room.timelineReset&quot;]);</span>
<a href="#l45.85"></a><span id="l45.85" class="difflineplus">+    }</span>
<a href="#l45.86"></a><span id="l45.86" class="difflineplus">+}</span>
<a href="#l45.87"></a><span id="l45.87" class="difflineplus">+</span>
<a href="#l45.88"></a><span id="l45.88" class="difflineplus">+/**</span>
<a href="#l45.89"></a><span id="l45.89" class="difflineplus">+ * @param {string} roomId</span>
<a href="#l45.90"></a><span id="l45.90" class="difflineplus">+ * @return {Room}</span>
<a href="#l45.91"></a><span id="l45.91" class="difflineplus">+ */</span>
<a href="#l45.92"></a><span id="l45.92" class="difflineplus">+SyncApi.prototype.createRoom = function(roomId) {</span>
<a href="#l45.93"></a><span id="l45.93" class="difflineplus">+    var client = this.client;</span>
<a href="#l45.94"></a><span id="l45.94" class="difflineplus">+    var room = new Room(roomId, {</span>
<a href="#l45.95"></a><span id="l45.95" class="difflineplus">+        pendingEventOrdering: this.opts.pendingEventOrdering,</span>
<a href="#l45.96"></a><span id="l45.96" class="difflineplus">+        timelineSupport: client.timelineSupport,</span>
<a href="#l45.97"></a><span id="l45.97" class="difflineplus">+    });</span>
<a href="#l45.98"></a><span id="l45.98" class="difflineplus">+    reEmit(client, room, [&quot;Room.name&quot;, &quot;Room.timeline&quot;, &quot;Room.redaction&quot;,</span>
<a href="#l45.99"></a><span id="l45.99" class="difflineplus">+                          &quot;Room.receipt&quot;, &quot;Room.tags&quot;,</span>
<a href="#l45.100"></a><span id="l45.100" class="difflineplus">+                          &quot;Room.timelineReset&quot;,</span>
<a href="#l45.101"></a><span id="l45.101" class="difflineplus">+                          &quot;Room.localEchoUpdated&quot;,</span>
<a href="#l45.102"></a><span id="l45.102" class="difflineplus">+                          &quot;Room.accountData&quot;,</span>
<a href="#l45.103"></a><span id="l45.103" class="difflineplus">+                         ]);</span>
<a href="#l45.104"></a><span id="l45.104" class="difflineplus">+    this._registerStateListeners(room);</span>
<a href="#l45.105"></a><span id="l45.105" class="difflineplus">+    return room;</span>
<a href="#l45.106"></a><span id="l45.106" class="difflineplus">+};</span>
<a href="#l45.107"></a><span id="l45.107" class="difflineplus">+</span>
<a href="#l45.108"></a><span id="l45.108" class="difflineplus">+/**</span>
<a href="#l45.109"></a><span id="l45.109" class="difflineplus">+ * @param {Room} room</span>
<a href="#l45.110"></a><span id="l45.110" class="difflineplus">+ * @private</span>
<a href="#l45.111"></a><span id="l45.111" class="difflineplus">+ */</span>
<a href="#l45.112"></a><span id="l45.112" class="difflineplus">+SyncApi.prototype._registerStateListeners = function(room) {</span>
<a href="#l45.113"></a><span id="l45.113" class="difflineplus">+    var client = this.client;</span>
<a href="#l45.114"></a><span id="l45.114" class="difflineplus">+    // we need to also re-emit room state and room member events, so hook it up</span>
<a href="#l45.115"></a><span id="l45.115" class="difflineplus">+    // to the client now. We need to add a listener for RoomState.members in</span>
<a href="#l45.116"></a><span id="l45.116" class="difflineplus">+    // order to hook them correctly. (TODO: find a better way?)</span>
<a href="#l45.117"></a><span id="l45.117" class="difflineplus">+    reEmit(client, room.currentState, [</span>
<a href="#l45.118"></a><span id="l45.118" class="difflineplus">+        &quot;RoomState.events&quot;, &quot;RoomState.members&quot;, &quot;RoomState.newMember&quot;</span>
<a href="#l45.119"></a><span id="l45.119" class="difflineplus">+    ]);</span>
<a href="#l45.120"></a><span id="l45.120" class="difflineplus">+    room.currentState.on(&quot;RoomState.newMember&quot;, function(event, state, member) {</span>
<a href="#l45.121"></a><span id="l45.121" class="difflineplus">+        member.user = client.getUser(member.userId);</span>
<a href="#l45.122"></a><span id="l45.122" class="difflineplus">+        reEmit(</span>
<a href="#l45.123"></a><span id="l45.123" class="difflineplus">+            client, member,</span>
<a href="#l45.124"></a><span id="l45.124" class="difflineplus">+            [</span>
<a href="#l45.125"></a><span id="l45.125" class="difflineplus">+                &quot;RoomMember.name&quot;, &quot;RoomMember.typing&quot;, &quot;RoomMember.powerLevel&quot;,</span>
<a href="#l45.126"></a><span id="l45.126" class="difflineplus">+                &quot;RoomMember.membership&quot;</span>
<a href="#l45.127"></a><span id="l45.127" class="difflineplus">+            ]</span>
<a href="#l45.128"></a><span id="l45.128" class="difflineplus">+        );</span>
<a href="#l45.129"></a><span id="l45.129" class="difflineplus">+    });</span>
<a href="#l45.130"></a><span id="l45.130" class="difflineplus">+};</span>
<a href="#l45.131"></a><span id="l45.131" class="difflineplus">+</span>
<a href="#l45.132"></a><span id="l45.132" class="difflineplus">+/**</span>
<a href="#l45.133"></a><span id="l45.133" class="difflineplus">+ * @param {Room} room</span>
<a href="#l45.134"></a><span id="l45.134" class="difflineplus">+ * @private</span>
<a href="#l45.135"></a><span id="l45.135" class="difflineplus">+ */</span>
<a href="#l45.136"></a><span id="l45.136" class="difflineplus">+SyncApi.prototype._deregisterStateListeners = function(room) {</span>
<a href="#l45.137"></a><span id="l45.137" class="difflineplus">+    // could do with a better way of achieving this.</span>
<a href="#l45.138"></a><span id="l45.138" class="difflineplus">+    room.currentState.removeAllListeners(&quot;RoomState.events&quot;);</span>
<a href="#l45.139"></a><span id="l45.139" class="difflineplus">+    room.currentState.removeAllListeners(&quot;RoomState.members&quot;);</span>
<a href="#l45.140"></a><span id="l45.140" class="difflineplus">+    room.currentState.removeAllListeners(&quot;RoomState.newMember&quot;);</span>
<a href="#l45.141"></a><span id="l45.141" class="difflineplus">+};</span>
<a href="#l45.142"></a><span id="l45.142" class="difflineplus">+</span>
<a href="#l45.143"></a><span id="l45.143" class="difflineplus">+</span>
<a href="#l45.144"></a><span id="l45.144" class="difflineplus">+/**</span>
<a href="#l45.145"></a><span id="l45.145" class="difflineplus">+ * Sync rooms the user has left.</span>
<a href="#l45.146"></a><span id="l45.146" class="difflineplus">+ * @return {Promise} Resolved when they've been added to the store.</span>
<a href="#l45.147"></a><span id="l45.147" class="difflineplus">+ */</span>
<a href="#l45.148"></a><span id="l45.148" class="difflineplus">+SyncApi.prototype.syncLeftRooms = function() {</span>
<a href="#l45.149"></a><span id="l45.149" class="difflineplus">+    var client = this.client;</span>
<a href="#l45.150"></a><span id="l45.150" class="difflineplus">+    var self = this;</span>
<a href="#l45.151"></a><span id="l45.151" class="difflineplus">+</span>
<a href="#l45.152"></a><span id="l45.152" class="difflineplus">+    // grab a filter with limit=1 and include_leave=true</span>
<a href="#l45.153"></a><span id="l45.153" class="difflineplus">+    var filter = new Filter(this.client.credentials.userId);</span>
<a href="#l45.154"></a><span id="l45.154" class="difflineplus">+    filter.setTimelineLimit(1);</span>
<a href="#l45.155"></a><span id="l45.155" class="difflineplus">+    filter.setIncludeLeaveRooms(true);</span>
<a href="#l45.156"></a><span id="l45.156" class="difflineplus">+</span>
<a href="#l45.157"></a><span id="l45.157" class="difflineplus">+    var localTimeoutMs = this.opts.pollTimeout + BUFFER_PERIOD_MS;</span>
<a href="#l45.158"></a><span id="l45.158" class="difflineplus">+    var qps = {</span>
<a href="#l45.159"></a><span id="l45.159" class="difflineplus">+        timeout: 0 // don't want to block since this is a single isolated req</span>
<a href="#l45.160"></a><span id="l45.160" class="difflineplus">+    };</span>
<a href="#l45.161"></a><span id="l45.161" class="difflineplus">+</span>
<a href="#l45.162"></a><span id="l45.162" class="difflineplus">+    return client.getOrCreateFilter(</span>
<a href="#l45.163"></a><span id="l45.163" class="difflineplus">+        getFilterName(client.credentials.userId, &quot;LEFT_ROOMS&quot;), filter</span>
<a href="#l45.164"></a><span id="l45.164" class="difflineplus">+    ).then(function(filterId) {</span>
<a href="#l45.165"></a><span id="l45.165" class="difflineplus">+        qps.filter = filterId;</span>
<a href="#l45.166"></a><span id="l45.166" class="difflineplus">+        return client._http.authedRequest(</span>
<a href="#l45.167"></a><span id="l45.167" class="difflineplus">+            undefined, &quot;GET&quot;, &quot;/sync&quot;, qps, undefined, localTimeoutMs</span>
<a href="#l45.168"></a><span id="l45.168" class="difflineplus">+        );</span>
<a href="#l45.169"></a><span id="l45.169" class="difflineplus">+    }).then(function(data) {</span>
<a href="#l45.170"></a><span id="l45.170" class="difflineplus">+        var leaveRooms = [];</span>
<a href="#l45.171"></a><span id="l45.171" class="difflineplus">+        if (data.rooms &amp;&amp; data.rooms.leave) {</span>
<a href="#l45.172"></a><span id="l45.172" class="difflineplus">+            leaveRooms = self._mapSyncResponseToRoomArray(data.rooms.leave);</span>
<a href="#l45.173"></a><span id="l45.173" class="difflineplus">+        }</span>
<a href="#l45.174"></a><span id="l45.174" class="difflineplus">+        var rooms = [];</span>
<a href="#l45.175"></a><span id="l45.175" class="difflineplus">+        leaveRooms.forEach(function(leaveObj) {</span>
<a href="#l45.176"></a><span id="l45.176" class="difflineplus">+            var room = leaveObj.room;</span>
<a href="#l45.177"></a><span id="l45.177" class="difflineplus">+            rooms.push(room);</span>
<a href="#l45.178"></a><span id="l45.178" class="difflineplus">+            if (!leaveObj.isBrandNewRoom) {</span>
<a href="#l45.179"></a><span id="l45.179" class="difflineplus">+                // the intention behind syncLeftRooms is to add in rooms which were</span>
<a href="#l45.180"></a><span id="l45.180" class="difflineplus">+                // *omitted* from the initial /sync. Rooms the user were joined to</span>
<a href="#l45.181"></a><span id="l45.181" class="difflineplus">+                // but then left whilst the app is running will appear in this list</span>
<a href="#l45.182"></a><span id="l45.182" class="difflineplus">+                // and we do not want to bother with them since they will have the</span>
<a href="#l45.183"></a><span id="l45.183" class="difflineplus">+                // current state already (and may get dupe messages if we add</span>
<a href="#l45.184"></a><span id="l45.184" class="difflineplus">+                // yet more timeline events!), so skip them.</span>
<a href="#l45.185"></a><span id="l45.185" class="difflineplus">+                // NB: When we persist rooms to localStorage this will be more</span>
<a href="#l45.186"></a><span id="l45.186" class="difflineplus">+                //     complicated...</span>
<a href="#l45.187"></a><span id="l45.187" class="difflineplus">+                return;</span>
<a href="#l45.188"></a><span id="l45.188" class="difflineplus">+            }</span>
<a href="#l45.189"></a><span id="l45.189" class="difflineplus">+            leaveObj.timeline = leaveObj.timeline || {};</span>
<a href="#l45.190"></a><span id="l45.190" class="difflineplus">+            var timelineEvents =</span>
<a href="#l45.191"></a><span id="l45.191" class="difflineplus">+                self._mapSyncEventsFormat(leaveObj.timeline, room);</span>
<a href="#l45.192"></a><span id="l45.192" class="difflineplus">+            var stateEvents = self._mapSyncEventsFormat(leaveObj.state, room);</span>
<a href="#l45.193"></a><span id="l45.193" class="difflineplus">+</span>
<a href="#l45.194"></a><span id="l45.194" class="difflineplus">+            // set the back-pagination token. Do this *before* adding any</span>
<a href="#l45.195"></a><span id="l45.195" class="difflineplus">+            // events so that clients can start back-paginating.</span>
<a href="#l45.196"></a><span id="l45.196" class="difflineplus">+            room.getLiveTimeline().setPaginationToken(leaveObj.timeline.prev_batch,</span>
<a href="#l45.197"></a><span id="l45.197" class="difflineplus">+                                                      EventTimeline.BACKWARDS);</span>
<a href="#l45.198"></a><span id="l45.198" class="difflineplus">+</span>
<a href="#l45.199"></a><span id="l45.199" class="difflineplus">+            self._processRoomEvents(room, stateEvents, timelineEvents);</span>
<a href="#l45.200"></a><span id="l45.200" class="difflineplus">+</span>
<a href="#l45.201"></a><span id="l45.201" class="difflineplus">+            room.recalculate(client.credentials.userId);</span>
<a href="#l45.202"></a><span id="l45.202" class="difflineplus">+            client.store.storeRoom(room);</span>
<a href="#l45.203"></a><span id="l45.203" class="difflineplus">+            client.emit(&quot;Room&quot;, room);</span>
<a href="#l45.204"></a><span id="l45.204" class="difflineplus">+        });</span>
<a href="#l45.205"></a><span id="l45.205" class="difflineplus">+        return rooms;</span>
<a href="#l45.206"></a><span id="l45.206" class="difflineplus">+    });</span>
<a href="#l45.207"></a><span id="l45.207" class="difflineplus">+};</span>
<a href="#l45.208"></a><span id="l45.208" class="difflineplus">+</span>
<a href="#l45.209"></a><span id="l45.209" class="difflineplus">+/**</span>
<a href="#l45.210"></a><span id="l45.210" class="difflineplus">+ * Peek into a room. This will result in the room in question being synced so it</span>
<a href="#l45.211"></a><span id="l45.211" class="difflineplus">+ * is accessible via getRooms(). Live updates for the room will be provided.</span>
<a href="#l45.212"></a><span id="l45.212" class="difflineplus">+ * @param {string} roomId The room ID to peek into.</span>
<a href="#l45.213"></a><span id="l45.213" class="difflineplus">+ * @return {Promise} A promise which resolves once the room has been added to the</span>
<a href="#l45.214"></a><span id="l45.214" class="difflineplus">+ * store.</span>
<a href="#l45.215"></a><span id="l45.215" class="difflineplus">+ */</span>
<a href="#l45.216"></a><span id="l45.216" class="difflineplus">+SyncApi.prototype.peek = function(roomId) {</span>
<a href="#l45.217"></a><span id="l45.217" class="difflineplus">+    var self = this;</span>
<a href="#l45.218"></a><span id="l45.218" class="difflineplus">+    var client = this.client;</span>
<a href="#l45.219"></a><span id="l45.219" class="difflineplus">+    this._peekRoomId = roomId;</span>
<a href="#l45.220"></a><span id="l45.220" class="difflineplus">+    return this.client.roomInitialSync(roomId, 20).then(function(response) {</span>
<a href="#l45.221"></a><span id="l45.221" class="difflineplus">+        // make sure things are init'd</span>
<a href="#l45.222"></a><span id="l45.222" class="difflineplus">+        response.messages = response.messages || {};</span>
<a href="#l45.223"></a><span id="l45.223" class="difflineplus">+        response.messages.chunk = response.messages.chunk || [];</span>
<a href="#l45.224"></a><span id="l45.224" class="difflineplus">+        response.state = response.state || [];</span>
<a href="#l45.225"></a><span id="l45.225" class="difflineplus">+</span>
<a href="#l45.226"></a><span id="l45.226" class="difflineplus">+        var peekRoom = self.createRoom(roomId);</span>
<a href="#l45.227"></a><span id="l45.227" class="difflineplus">+</span>
<a href="#l45.228"></a><span id="l45.228" class="difflineplus">+        // FIXME: Mostly duplicated from _processRoomEvents but not entirely</span>
<a href="#l45.229"></a><span id="l45.229" class="difflineplus">+        // because &quot;state&quot; in this API is at the BEGINNING of the chunk</span>
<a href="#l45.230"></a><span id="l45.230" class="difflineplus">+        var oldStateEvents = utils.map(</span>
<a href="#l45.231"></a><span id="l45.231" class="difflineplus">+            utils.deepCopy(response.state), client.getEventMapper()</span>
<a href="#l45.232"></a><span id="l45.232" class="difflineplus">+        );</span>
<a href="#l45.233"></a><span id="l45.233" class="difflineplus">+        var stateEvents = utils.map(</span>
<a href="#l45.234"></a><span id="l45.234" class="difflineplus">+            response.state, client.getEventMapper()</span>
<a href="#l45.235"></a><span id="l45.235" class="difflineplus">+        );</span>
<a href="#l45.236"></a><span id="l45.236" class="difflineplus">+        var messages = utils.map(</span>
<a href="#l45.237"></a><span id="l45.237" class="difflineplus">+            response.messages.chunk, client.getEventMapper()</span>
<a href="#l45.238"></a><span id="l45.238" class="difflineplus">+        );</span>
<a href="#l45.239"></a><span id="l45.239" class="difflineplus">+</span>
<a href="#l45.240"></a><span id="l45.240" class="difflineplus">+        // XXX: copypasted from /sync until we kill off this</span>
<a href="#l45.241"></a><span id="l45.241" class="difflineplus">+        // minging v1 API stuff)</span>
<a href="#l45.242"></a><span id="l45.242" class="difflineplus">+        // handle presence events (User objects)</span>
<a href="#l45.243"></a><span id="l45.243" class="difflineplus">+        if (response.presence &amp;&amp; utils.isArray(response.presence)) {</span>
<a href="#l45.244"></a><span id="l45.244" class="difflineplus">+            response.presence.map(client.getEventMapper()).forEach(</span>
<a href="#l45.245"></a><span id="l45.245" class="difflineplus">+            function(presenceEvent) {</span>
<a href="#l45.246"></a><span id="l45.246" class="difflineplus">+                var user = client.store.getUser(presenceEvent.getContent().user_id);</span>
<a href="#l45.247"></a><span id="l45.247" class="difflineplus">+                if (user) {</span>
<a href="#l45.248"></a><span id="l45.248" class="difflineplus">+                    user.setPresenceEvent(presenceEvent);</span>
<a href="#l45.249"></a><span id="l45.249" class="difflineplus">+                }</span>
<a href="#l45.250"></a><span id="l45.250" class="difflineplus">+                else {</span>
<a href="#l45.251"></a><span id="l45.251" class="difflineplus">+                    user = createNewUser(client, presenceEvent.getContent().user_id);</span>
<a href="#l45.252"></a><span id="l45.252" class="difflineplus">+                    user.setPresenceEvent(presenceEvent);</span>
<a href="#l45.253"></a><span id="l45.253" class="difflineplus">+                    client.store.storeUser(user);</span>
<a href="#l45.254"></a><span id="l45.254" class="difflineplus">+                }</span>
<a href="#l45.255"></a><span id="l45.255" class="difflineplus">+                client.emit(&quot;event&quot;, presenceEvent);</span>
<a href="#l45.256"></a><span id="l45.256" class="difflineplus">+            });</span>
<a href="#l45.257"></a><span id="l45.257" class="difflineplus">+        }</span>
<a href="#l45.258"></a><span id="l45.258" class="difflineplus">+</span>
<a href="#l45.259"></a><span id="l45.259" class="difflineplus">+        // set the pagination token before adding the events in case people</span>
<a href="#l45.260"></a><span id="l45.260" class="difflineplus">+        // fire off pagination requests in response to the Room.timeline</span>
<a href="#l45.261"></a><span id="l45.261" class="difflineplus">+        // events.</span>
<a href="#l45.262"></a><span id="l45.262" class="difflineplus">+        if (response.messages.start) {</span>
<a href="#l45.263"></a><span id="l45.263" class="difflineplus">+            peekRoom.oldState.paginationToken = response.messages.start;</span>
<a href="#l45.264"></a><span id="l45.264" class="difflineplus">+        }</span>
<a href="#l45.265"></a><span id="l45.265" class="difflineplus">+</span>
<a href="#l45.266"></a><span id="l45.266" class="difflineplus">+        // set the state of the room to as it was after the timeline executes</span>
<a href="#l45.267"></a><span id="l45.267" class="difflineplus">+        peekRoom.oldState.setStateEvents(oldStateEvents);</span>
<a href="#l45.268"></a><span id="l45.268" class="difflineplus">+        peekRoom.currentState.setStateEvents(stateEvents);</span>
<a href="#l45.269"></a><span id="l45.269" class="difflineplus">+</span>
<a href="#l45.270"></a><span id="l45.270" class="difflineplus">+        self._resolveInvites(peekRoom);</span>
<a href="#l45.271"></a><span id="l45.271" class="difflineplus">+        peekRoom.recalculate(self.client.credentials.userId);</span>
<a href="#l45.272"></a><span id="l45.272" class="difflineplus">+</span>
<a href="#l45.273"></a><span id="l45.273" class="difflineplus">+        // roll backwards to diverge old state. addEventsToTimeline</span>
<a href="#l45.274"></a><span id="l45.274" class="difflineplus">+        // will overwrite the pagination token, so make sure it overwrites</span>
<a href="#l45.275"></a><span id="l45.275" class="difflineplus">+        // it with the right thing.</span>
<a href="#l45.276"></a><span id="l45.276" class="difflineplus">+        peekRoom.addEventsToTimeline(messages.reverse(), true,</span>
<a href="#l45.277"></a><span id="l45.277" class="difflineplus">+                                     peekRoom.getLiveTimeline(),</span>
<a href="#l45.278"></a><span id="l45.278" class="difflineplus">+                                     response.messages.start);</span>
<a href="#l45.279"></a><span id="l45.279" class="difflineplus">+</span>
<a href="#l45.280"></a><span id="l45.280" class="difflineplus">+        client.store.storeRoom(peekRoom);</span>
<a href="#l45.281"></a><span id="l45.281" class="difflineplus">+        client.emit(&quot;Room&quot;, peekRoom);</span>
<a href="#l45.282"></a><span id="l45.282" class="difflineplus">+</span>
<a href="#l45.283"></a><span id="l45.283" class="difflineplus">+        self._peekPoll(roomId);</span>
<a href="#l45.284"></a><span id="l45.284" class="difflineplus">+        return peekRoom;</span>
<a href="#l45.285"></a><span id="l45.285" class="difflineplus">+    });</span>
<a href="#l45.286"></a><span id="l45.286" class="difflineplus">+};</span>
<a href="#l45.287"></a><span id="l45.287" class="difflineplus">+</span>
<a href="#l45.288"></a><span id="l45.288" class="difflineplus">+/**</span>
<a href="#l45.289"></a><span id="l45.289" class="difflineplus">+ * Stop polling for updates in the peeked room. NOPs if there is no room being</span>
<a href="#l45.290"></a><span id="l45.290" class="difflineplus">+ * peeked.</span>
<a href="#l45.291"></a><span id="l45.291" class="difflineplus">+ */</span>
<a href="#l45.292"></a><span id="l45.292" class="difflineplus">+SyncApi.prototype.stopPeeking = function() {</span>
<a href="#l45.293"></a><span id="l45.293" class="difflineplus">+    this._peekRoomId = null;</span>
<a href="#l45.294"></a><span id="l45.294" class="difflineplus">+};</span>
<a href="#l45.295"></a><span id="l45.295" class="difflineplus">+</span>
<a href="#l45.296"></a><span id="l45.296" class="difflineplus">+/**</span>
<a href="#l45.297"></a><span id="l45.297" class="difflineplus">+ * Do a peek room poll.</span>
<a href="#l45.298"></a><span id="l45.298" class="difflineplus">+ * @param {string} roomId</span>
<a href="#l45.299"></a><span id="l45.299" class="difflineplus">+ * @param {string} token from= token</span>
<a href="#l45.300"></a><span id="l45.300" class="difflineplus">+ */</span>
<a href="#l45.301"></a><span id="l45.301" class="difflineplus">+SyncApi.prototype._peekPoll = function(roomId, token) {</span>
<a href="#l45.302"></a><span id="l45.302" class="difflineplus">+    if (this._peekRoomId !== roomId) {</span>
<a href="#l45.303"></a><span id="l45.303" class="difflineplus">+        debuglog(&quot;Stopped peeking in room %s&quot;, roomId);</span>
<a href="#l45.304"></a><span id="l45.304" class="difflineplus">+        return;</span>
<a href="#l45.305"></a><span id="l45.305" class="difflineplus">+    }</span>
<a href="#l45.306"></a><span id="l45.306" class="difflineplus">+</span>
<a href="#l45.307"></a><span id="l45.307" class="difflineplus">+    var self = this;</span>
<a href="#l45.308"></a><span id="l45.308" class="difflineplus">+    // FIXME: gut wrenching; hard-coded timeout values</span>
<a href="#l45.309"></a><span id="l45.309" class="difflineplus">+    this.client._http.authedRequest(undefined, &quot;GET&quot;, &quot;/events&quot;, {</span>
<a href="#l45.310"></a><span id="l45.310" class="difflineplus">+        room_id: roomId,</span>
<a href="#l45.311"></a><span id="l45.311" class="difflineplus">+        timeout: 30 * 1000,</span>
<a href="#l45.312"></a><span id="l45.312" class="difflineplus">+        from: token</span>
<a href="#l45.313"></a><span id="l45.313" class="difflineplus">+    }, undefined, 50 * 1000).done(function(res) {</span>
<a href="#l45.314"></a><span id="l45.314" class="difflineplus">+</span>
<a href="#l45.315"></a><span id="l45.315" class="difflineplus">+        // We have a problem that we get presence both from /events and /sync</span>
<a href="#l45.316"></a><span id="l45.316" class="difflineplus">+        // however, /sync only returns presence for users in rooms</span>
<a href="#l45.317"></a><span id="l45.317" class="difflineplus">+        // you're actually joined to.</span>
<a href="#l45.318"></a><span id="l45.318" class="difflineplus">+        // in order to be sure to get presence for all of the users in the</span>
<a href="#l45.319"></a><span id="l45.319" class="difflineplus">+        // peeked room, we handle presence explicitly here. This may result</span>
<a href="#l45.320"></a><span id="l45.320" class="difflineplus">+        // in duplicate presence events firing for some users, which is a</span>
<a href="#l45.321"></a><span id="l45.321" class="difflineplus">+        // performance drain, but such is life.</span>
<a href="#l45.322"></a><span id="l45.322" class="difflineplus">+        // XXX: copypasted from /sync until we can kill this minging v1 stuff.</span>
<a href="#l45.323"></a><span id="l45.323" class="difflineplus">+</span>
<a href="#l45.324"></a><span id="l45.324" class="difflineplus">+        res.chunk.filter(function(e) {</span>
<a href="#l45.325"></a><span id="l45.325" class="difflineplus">+            return e.type === &quot;m.presence&quot;;</span>
<a href="#l45.326"></a><span id="l45.326" class="difflineplus">+        }).map(self.client.getEventMapper()).forEach(function(presenceEvent) {</span>
<a href="#l45.327"></a><span id="l45.327" class="difflineplus">+            var user = self.client.store.getUser(presenceEvent.getContent().user_id);</span>
<a href="#l45.328"></a><span id="l45.328" class="difflineplus">+            if (user) {</span>
<a href="#l45.329"></a><span id="l45.329" class="difflineplus">+                user.setPresenceEvent(presenceEvent);</span>
<a href="#l45.330"></a><span id="l45.330" class="difflineplus">+            }</span>
<a href="#l45.331"></a><span id="l45.331" class="difflineplus">+            else {</span>
<a href="#l45.332"></a><span id="l45.332" class="difflineplus">+                user = createNewUser(self.client, presenceEvent.getContent().user_id);</span>
<a href="#l45.333"></a><span id="l45.333" class="difflineplus">+                user.setPresenceEvent(presenceEvent);</span>
<a href="#l45.334"></a><span id="l45.334" class="difflineplus">+                self.client.store.storeUser(user);</span>
<a href="#l45.335"></a><span id="l45.335" class="difflineplus">+            }</span>
<a href="#l45.336"></a><span id="l45.336" class="difflineplus">+            self.client.emit(&quot;event&quot;, presenceEvent);</span>
<a href="#l45.337"></a><span id="l45.337" class="difflineplus">+        });</span>
<a href="#l45.338"></a><span id="l45.338" class="difflineplus">+</span>
<a href="#l45.339"></a><span id="l45.339" class="difflineplus">+        // strip out events which aren't for the given room_id (e.g presence)</span>
<a href="#l45.340"></a><span id="l45.340" class="difflineplus">+        var events = res.chunk.filter(function(e) {</span>
<a href="#l45.341"></a><span id="l45.341" class="difflineplus">+            return e.room_id === roomId;</span>
<a href="#l45.342"></a><span id="l45.342" class="difflineplus">+        }).map(self.client.getEventMapper());</span>
<a href="#l45.343"></a><span id="l45.343" class="difflineplus">+        var room = self.client.getRoom(roomId);</span>
<a href="#l45.344"></a><span id="l45.344" class="difflineplus">+        room.addLiveEvents(events);</span>
<a href="#l45.345"></a><span id="l45.345" class="difflineplus">+        self._peekPoll(roomId, res.end);</span>
<a href="#l45.346"></a><span id="l45.346" class="difflineplus">+    }, function(err) {</span>
<a href="#l45.347"></a><span id="l45.347" class="difflineplus">+        console.error(&quot;[%s] Peek poll failed: %s&quot;, roomId, err);</span>
<a href="#l45.348"></a><span id="l45.348" class="difflineplus">+        setTimeout(function() {</span>
<a href="#l45.349"></a><span id="l45.349" class="difflineplus">+            self._peekPoll(roomId, token);</span>
<a href="#l45.350"></a><span id="l45.350" class="difflineplus">+        }, 30 * 1000);</span>
<a href="#l45.351"></a><span id="l45.351" class="difflineplus">+    });</span>
<a href="#l45.352"></a><span id="l45.352" class="difflineplus">+};</span>
<a href="#l45.353"></a><span id="l45.353" class="difflineplus">+</span>
<a href="#l45.354"></a><span id="l45.354" class="difflineplus">+/**</span>
<a href="#l45.355"></a><span id="l45.355" class="difflineplus">+ * Returns the current state of this sync object</span>
<a href="#l45.356"></a><span id="l45.356" class="difflineplus">+ * @see module:client~MatrixClient#event:&quot;sync&quot;</span>
<a href="#l45.357"></a><span id="l45.357" class="difflineplus">+ * @return {?String}</span>
<a href="#l45.358"></a><span id="l45.358" class="difflineplus">+ */</span>
<a href="#l45.359"></a><span id="l45.359" class="difflineplus">+SyncApi.prototype.getSyncState = function() {</span>
<a href="#l45.360"></a><span id="l45.360" class="difflineplus">+    return this._syncState;</span>
<a href="#l45.361"></a><span id="l45.361" class="difflineplus">+};</span>
<a href="#l45.362"></a><span id="l45.362" class="difflineplus">+</span>
<a href="#l45.363"></a><span id="l45.363" class="difflineplus">+/**</span>
<a href="#l45.364"></a><span id="l45.364" class="difflineplus">+ * Main entry point</span>
<a href="#l45.365"></a><span id="l45.365" class="difflineplus">+ */</span>
<a href="#l45.366"></a><span id="l45.366" class="difflineplus">+SyncApi.prototype.sync = function() {</span>
<a href="#l45.367"></a><span id="l45.367" class="difflineplus">+    debuglog(&quot;SyncApi.sync: starting with sync token &quot; +</span>
<a href="#l45.368"></a><span id="l45.368" class="difflineplus">+             this.client.store.getSyncToken());</span>
<a href="#l45.369"></a><span id="l45.369" class="difflineplus">+</span>
<a href="#l45.370"></a><span id="l45.370" class="difflineplus">+    var client = this.client;</span>
<a href="#l45.371"></a><span id="l45.371" class="difflineplus">+    var self = this;</span>
<a href="#l45.372"></a><span id="l45.372" class="difflineplus">+</span>
<a href="#l45.373"></a><span id="l45.373" class="difflineplus">+    this._running = true;</span>
<a href="#l45.374"></a><span id="l45.374" class="difflineplus">+</span>
<a href="#l45.375"></a><span id="l45.375" class="difflineplus">+    if (global.document) {</span>
<a href="#l45.376"></a><span id="l45.376" class="difflineplus">+        this._onOnlineBound = this._onOnline.bind(this);</span>
<a href="#l45.377"></a><span id="l45.377" class="difflineplus">+        global.document.addEventListener(&quot;online&quot;, this._onOnlineBound, false);</span>
<a href="#l45.378"></a><span id="l45.378" class="difflineplus">+    }</span>
<a href="#l45.379"></a><span id="l45.379" class="difflineplus">+</span>
<a href="#l45.380"></a><span id="l45.380" class="difflineplus">+    // We need to do one-off checks before we can begin the /sync loop.</span>
<a href="#l45.381"></a><span id="l45.381" class="difflineplus">+    // These are:</span>
<a href="#l45.382"></a><span id="l45.382" class="difflineplus">+    //   1) We need to get push rules so we can check if events should bing as we get</span>
<a href="#l45.383"></a><span id="l45.383" class="difflineplus">+    //      them from /sync.</span>
<a href="#l45.384"></a><span id="l45.384" class="difflineplus">+    //   2) We need to get/create a filter which we can use for /sync.</span>
<a href="#l45.385"></a><span id="l45.385" class="difflineplus">+</span>
<a href="#l45.386"></a><span id="l45.386" class="difflineplus">+    function getPushRules() {</span>
<a href="#l45.387"></a><span id="l45.387" class="difflineplus">+        client.getPushRules().done(function(result) {</span>
<a href="#l45.388"></a><span id="l45.388" class="difflineplus">+            debuglog(&quot;Got push rules&quot;);</span>
<a href="#l45.389"></a><span id="l45.389" class="difflineplus">+            client.pushRules = result;</span>
<a href="#l45.390"></a><span id="l45.390" class="difflineplus">+            getFilter(); // Now get the filter</span>
<a href="#l45.391"></a><span id="l45.391" class="difflineplus">+        }, function(err) {</span>
<a href="#l45.392"></a><span id="l45.392" class="difflineplus">+            self._startKeepAlives().done(function() {</span>
<a href="#l45.393"></a><span id="l45.393" class="difflineplus">+                getPushRules();</span>
<a href="#l45.394"></a><span id="l45.394" class="difflineplus">+            });</span>
<a href="#l45.395"></a><span id="l45.395" class="difflineplus">+            self._updateSyncState(&quot;ERROR&quot;, { error: err });</span>
<a href="#l45.396"></a><span id="l45.396" class="difflineplus">+        });</span>
<a href="#l45.397"></a><span id="l45.397" class="difflineplus">+    }</span>
<a href="#l45.398"></a><span id="l45.398" class="difflineplus">+</span>
<a href="#l45.399"></a><span id="l45.399" class="difflineplus">+    function getFilter() {</span>
<a href="#l45.400"></a><span id="l45.400" class="difflineplus">+        var filter;</span>
<a href="#l45.401"></a><span id="l45.401" class="difflineplus">+        if (self.opts.filter) {</span>
<a href="#l45.402"></a><span id="l45.402" class="difflineplus">+            filter = self.opts.filter;</span>
<a href="#l45.403"></a><span id="l45.403" class="difflineplus">+        } else {</span>
<a href="#l45.404"></a><span id="l45.404" class="difflineplus">+            filter = new Filter(client.credentials.userId);</span>
<a href="#l45.405"></a><span id="l45.405" class="difflineplus">+            filter.setTimelineLimit(self.opts.initialSyncLimit);</span>
<a href="#l45.406"></a><span id="l45.406" class="difflineplus">+        }</span>
<a href="#l45.407"></a><span id="l45.407" class="difflineplus">+</span>
<a href="#l45.408"></a><span id="l45.408" class="difflineplus">+        client.getOrCreateFilter(</span>
<a href="#l45.409"></a><span id="l45.409" class="difflineplus">+            getFilterName(client.credentials.userId), filter</span>
<a href="#l45.410"></a><span id="l45.410" class="difflineplus">+        ).done(function(filterId) {</span>
<a href="#l45.411"></a><span id="l45.411" class="difflineplus">+            // reset the notifications timeline to prepare it to paginate from</span>
<a href="#l45.412"></a><span id="l45.412" class="difflineplus">+            // the current point in time.</span>
<a href="#l45.413"></a><span id="l45.413" class="difflineplus">+            // The right solution would be to tie /sync pagination tokens into</span>
<a href="#l45.414"></a><span id="l45.414" class="difflineplus">+            // /notifications API somehow.</span>
<a href="#l45.415"></a><span id="l45.415" class="difflineplus">+            client.resetNotifTimelineSet();</span>
<a href="#l45.416"></a><span id="l45.416" class="difflineplus">+</span>
<a href="#l45.417"></a><span id="l45.417" class="difflineplus">+            self._sync({ filterId: filterId });</span>
<a href="#l45.418"></a><span id="l45.418" class="difflineplus">+        }, function(err) {</span>
<a href="#l45.419"></a><span id="l45.419" class="difflineplus">+            self._startKeepAlives().done(function() {</span>
<a href="#l45.420"></a><span id="l45.420" class="difflineplus">+                getFilter();</span>
<a href="#l45.421"></a><span id="l45.421" class="difflineplus">+            });</span>
<a href="#l45.422"></a><span id="l45.422" class="difflineplus">+            self._updateSyncState(&quot;ERROR&quot;, { error: err });</span>
<a href="#l45.423"></a><span id="l45.423" class="difflineplus">+        });</span>
<a href="#l45.424"></a><span id="l45.424" class="difflineplus">+    }</span>
<a href="#l45.425"></a><span id="l45.425" class="difflineplus">+</span>
<a href="#l45.426"></a><span id="l45.426" class="difflineplus">+    if (client.isGuest()) {</span>
<a href="#l45.427"></a><span id="l45.427" class="difflineplus">+        // no push rules for guests, no access to POST filter for guests.</span>
<a href="#l45.428"></a><span id="l45.428" class="difflineplus">+        self._sync({});</span>
<a href="#l45.429"></a><span id="l45.429" class="difflineplus">+    }</span>
<a href="#l45.430"></a><span id="l45.430" class="difflineplus">+    else {</span>
<a href="#l45.431"></a><span id="l45.431" class="difflineplus">+        getPushRules();</span>
<a href="#l45.432"></a><span id="l45.432" class="difflineplus">+    }</span>
<a href="#l45.433"></a><span id="l45.433" class="difflineplus">+};</span>
<a href="#l45.434"></a><span id="l45.434" class="difflineplus">+</span>
<a href="#l45.435"></a><span id="l45.435" class="difflineplus">+/**</span>
<a href="#l45.436"></a><span id="l45.436" class="difflineplus">+ * Stops the sync object from syncing.</span>
<a href="#l45.437"></a><span id="l45.437" class="difflineplus">+ */</span>
<a href="#l45.438"></a><span id="l45.438" class="difflineplus">+SyncApi.prototype.stop = function() {</span>
<a href="#l45.439"></a><span id="l45.439" class="difflineplus">+    debuglog(&quot;SyncApi.stop&quot;);</span>
<a href="#l45.440"></a><span id="l45.440" class="difflineplus">+    if (global.document) {</span>
<a href="#l45.441"></a><span id="l45.441" class="difflineplus">+        global.document.removeEventListener(&quot;online&quot;, this._onOnlineBound, false);</span>
<a href="#l45.442"></a><span id="l45.442" class="difflineplus">+        this._onOnlineBound = undefined;</span>
<a href="#l45.443"></a><span id="l45.443" class="difflineplus">+    }</span>
<a href="#l45.444"></a><span id="l45.444" class="difflineplus">+    this._running = false;</span>
<a href="#l45.445"></a><span id="l45.445" class="difflineplus">+    if (this._currentSyncRequest) { this._currentSyncRequest.abort(); }</span>
<a href="#l45.446"></a><span id="l45.446" class="difflineplus">+    if (this._keepAliveTimer) {</span>
<a href="#l45.447"></a><span id="l45.447" class="difflineplus">+        clearTimeout(this._keepAliveTimer);</span>
<a href="#l45.448"></a><span id="l45.448" class="difflineplus">+        this._keepAliveTimer = null;</span>
<a href="#l45.449"></a><span id="l45.449" class="difflineplus">+    }</span>
<a href="#l45.450"></a><span id="l45.450" class="difflineplus">+};</span>
<a href="#l45.451"></a><span id="l45.451" class="difflineplus">+</span>
<a href="#l45.452"></a><span id="l45.452" class="difflineplus">+/**</span>
<a href="#l45.453"></a><span id="l45.453" class="difflineplus">+ * Retry a backed off syncing request immediately. This should only be used when</span>
<a href="#l45.454"></a><span id="l45.454" class="difflineplus">+ * the user &lt;b&gt;explicitly&lt;/b&gt; attempts to retry their lost connection.</span>
<a href="#l45.455"></a><span id="l45.455" class="difflineplus">+ * @return {boolean} True if this resulted in a request being retried.</span>
<a href="#l45.456"></a><span id="l45.456" class="difflineplus">+ */</span>
<a href="#l45.457"></a><span id="l45.457" class="difflineplus">+SyncApi.prototype.retryImmediately = function() {</span>
<a href="#l45.458"></a><span id="l45.458" class="difflineplus">+    if (!this._connectionReturnedDefer) { return false; }</span>
<a href="#l45.459"></a><span id="l45.459" class="difflineplus">+    this._startKeepAlives(0);</span>
<a href="#l45.460"></a><span id="l45.460" class="difflineplus">+    return true;</span>
<a href="#l45.461"></a><span id="l45.461" class="difflineplus">+};</span>
<a href="#l45.462"></a><span id="l45.462" class="difflineplus">+</span>
<a href="#l45.463"></a><span id="l45.463" class="difflineplus">+/**</span>
<a href="#l45.464"></a><span id="l45.464" class="difflineplus">+ * Invoke me to do /sync calls</span>
<a href="#l45.465"></a><span id="l45.465" class="difflineplus">+ * @param {Object} syncOptions</span>
<a href="#l45.466"></a><span id="l45.466" class="difflineplus">+ * @param {string} syncOptions.filterId</span>
<a href="#l45.467"></a><span id="l45.467" class="difflineplus">+ * @param {boolean} syncOptions.hasSyncedBefore</span>
<a href="#l45.468"></a><span id="l45.468" class="difflineplus">+ */</span>
<a href="#l45.469"></a><span id="l45.469" class="difflineplus">+SyncApi.prototype._sync = function(syncOptions) {</span>
<a href="#l45.470"></a><span id="l45.470" class="difflineplus">+    var client = this.client;</span>
<a href="#l45.471"></a><span id="l45.471" class="difflineplus">+    var self = this;</span>
<a href="#l45.472"></a><span id="l45.472" class="difflineplus">+</span>
<a href="#l45.473"></a><span id="l45.473" class="difflineplus">+    if (!this._running) {</span>
<a href="#l45.474"></a><span id="l45.474" class="difflineplus">+        debuglog(&quot;Sync no longer running: exiting.&quot;);</span>
<a href="#l45.475"></a><span id="l45.475" class="difflineplus">+        if (self._connectionReturnedDefer) {</span>
<a href="#l45.476"></a><span id="l45.476" class="difflineplus">+            self._connectionReturnedDefer.reject();</span>
<a href="#l45.477"></a><span id="l45.477" class="difflineplus">+            self._connectionReturnedDefer = null;</span>
<a href="#l45.478"></a><span id="l45.478" class="difflineplus">+        }</span>
<a href="#l45.479"></a><span id="l45.479" class="difflineplus">+        this._updateSyncState(&quot;STOPPED&quot;);</span>
<a href="#l45.480"></a><span id="l45.480" class="difflineplus">+        return;</span>
<a href="#l45.481"></a><span id="l45.481" class="difflineplus">+    }</span>
<a href="#l45.482"></a><span id="l45.482" class="difflineplus">+</span>
<a href="#l45.483"></a><span id="l45.483" class="difflineplus">+    var filterId = syncOptions.filterId;</span>
<a href="#l45.484"></a><span id="l45.484" class="difflineplus">+    if (client.isGuest() &amp;&amp; !filterId) {</span>
<a href="#l45.485"></a><span id="l45.485" class="difflineplus">+        filterId = this._getGuestFilter();</span>
<a href="#l45.486"></a><span id="l45.486" class="difflineplus">+    }</span>
<a href="#l45.487"></a><span id="l45.487" class="difflineplus">+</span>
<a href="#l45.488"></a><span id="l45.488" class="difflineplus">+    var syncToken = client.store.getSyncToken();</span>
<a href="#l45.489"></a><span id="l45.489" class="difflineplus">+</span>
<a href="#l45.490"></a><span id="l45.490" class="difflineplus">+    var qps = {</span>
<a href="#l45.491"></a><span id="l45.491" class="difflineplus">+        filter: filterId,</span>
<a href="#l45.492"></a><span id="l45.492" class="difflineplus">+        timeout: this.opts.pollTimeout,</span>
<a href="#l45.493"></a><span id="l45.493" class="difflineplus">+    };</span>
<a href="#l45.494"></a><span id="l45.494" class="difflineplus">+</span>
<a href="#l45.495"></a><span id="l45.495" class="difflineplus">+    if (syncToken) {</span>
<a href="#l45.496"></a><span id="l45.496" class="difflineplus">+        qps.since = syncToken;</span>
<a href="#l45.497"></a><span id="l45.497" class="difflineplus">+    } else {</span>
<a href="#l45.498"></a><span id="l45.498" class="difflineplus">+        // use a cachebuster for initialsyncs, to make sure that</span>
<a href="#l45.499"></a><span id="l45.499" class="difflineplus">+        // we don't get a stale sync</span>
<a href="#l45.500"></a><span id="l45.500" class="difflineplus">+        // (https://github.com/vector-im/vector-web/issues/1354)</span>
<a href="#l45.501"></a><span id="l45.501" class="difflineplus">+        qps._cacheBuster = Date.now();</span>
<a href="#l45.502"></a><span id="l45.502" class="difflineplus">+    }</span>
<a href="#l45.503"></a><span id="l45.503" class="difflineplus">+</span>
<a href="#l45.504"></a><span id="l45.504" class="difflineplus">+    if (this.getSyncState() == 'ERROR' || this.getSyncState() == 'RECONNECTING') {</span>
<a href="#l45.505"></a><span id="l45.505" class="difflineplus">+        // we think the connection is dead. If it comes back up, we won't know</span>
<a href="#l45.506"></a><span id="l45.506" class="difflineplus">+        // about it till /sync returns. If the timeout= is high, this could</span>
<a href="#l45.507"></a><span id="l45.507" class="difflineplus">+        // be a long time. Set it to 0 when doing retries so we don't have to wait</span>
<a href="#l45.508"></a><span id="l45.508" class="difflineplus">+        // for an event or a timeout before emiting the SYNCING event.</span>
<a href="#l45.509"></a><span id="l45.509" class="difflineplus">+        qps.timeout = 0;</span>
<a href="#l45.510"></a><span id="l45.510" class="difflineplus">+    }</span>
<a href="#l45.511"></a><span id="l45.511" class="difflineplus">+</span>
<a href="#l45.512"></a><span id="l45.512" class="difflineplus">+    // normal timeout= plus buffer time</span>
<a href="#l45.513"></a><span id="l45.513" class="difflineplus">+    var clientSideTimeoutMs = this.opts.pollTimeout + BUFFER_PERIOD_MS;</span>
<a href="#l45.514"></a><span id="l45.514" class="difflineplus">+</span>
<a href="#l45.515"></a><span id="l45.515" class="difflineplus">+    this._currentSyncRequest = client._http.authedRequest(</span>
<a href="#l45.516"></a><span id="l45.516" class="difflineplus">+        undefined, &quot;GET&quot;, &quot;/sync&quot;, qps, undefined, clientSideTimeoutMs</span>
<a href="#l45.517"></a><span id="l45.517" class="difflineplus">+    );</span>
<a href="#l45.518"></a><span id="l45.518" class="difflineplus">+</span>
<a href="#l45.519"></a><span id="l45.519" class="difflineplus">+    this._currentSyncRequest.done(function(data) {</span>
<a href="#l45.520"></a><span id="l45.520" class="difflineplus">+        // set the sync token NOW *before* processing the events. We do this so</span>
<a href="#l45.521"></a><span id="l45.521" class="difflineplus">+        // if something barfs on an event we can skip it rather than constantly</span>
<a href="#l45.522"></a><span id="l45.522" class="difflineplus">+        // polling with the same token.</span>
<a href="#l45.523"></a><span id="l45.523" class="difflineplus">+        client.store.setSyncToken(data.next_batch);</span>
<a href="#l45.524"></a><span id="l45.524" class="difflineplus">+</span>
<a href="#l45.525"></a><span id="l45.525" class="difflineplus">+        try {</span>
<a href="#l45.526"></a><span id="l45.526" class="difflineplus">+            self._processSyncResponse(syncToken, data);</span>
<a href="#l45.527"></a><span id="l45.527" class="difflineplus">+        }</span>
<a href="#l45.528"></a><span id="l45.528" class="difflineplus">+        catch (e) {</span>
<a href="#l45.529"></a><span id="l45.529" class="difflineplus">+            // log the exception with stack if we have it, else fall back</span>
<a href="#l45.530"></a><span id="l45.530" class="difflineplus">+            // to the plain description</span>
<a href="#l45.531"></a><span id="l45.531" class="difflineplus">+            console.error(&quot;Caught /sync error&quot;, e.stack || e);</span>
<a href="#l45.532"></a><span id="l45.532" class="difflineplus">+        }</span>
<a href="#l45.533"></a><span id="l45.533" class="difflineplus">+</span>
<a href="#l45.534"></a><span id="l45.534" class="difflineplus">+        // emit synced events</span>
<a href="#l45.535"></a><span id="l45.535" class="difflineplus">+        if (!syncOptions.hasSyncedBefore) {</span>
<a href="#l45.536"></a><span id="l45.536" class="difflineplus">+            self._updateSyncState(&quot;PREPARED&quot;);</span>
<a href="#l45.537"></a><span id="l45.537" class="difflineplus">+            syncOptions.hasSyncedBefore = true;</span>
<a href="#l45.538"></a><span id="l45.538" class="difflineplus">+        }</span>
<a href="#l45.539"></a><span id="l45.539" class="difflineplus">+</span>
<a href="#l45.540"></a><span id="l45.540" class="difflineplus">+        // keep emitting SYNCING -&gt; SYNCING for clients who want to do bulk updates</span>
<a href="#l45.541"></a><span id="l45.541" class="difflineplus">+        self._updateSyncState(&quot;SYNCING&quot;);</span>
<a href="#l45.542"></a><span id="l45.542" class="difflineplus">+</span>
<a href="#l45.543"></a><span id="l45.543" class="difflineplus">+        self._sync(syncOptions);</span>
<a href="#l45.544"></a><span id="l45.544" class="difflineplus">+    }, function(err) {</span>
<a href="#l45.545"></a><span id="l45.545" class="difflineplus">+        if (!self._running) {</span>
<a href="#l45.546"></a><span id="l45.546" class="difflineplus">+            debuglog(&quot;Sync no longer running: exiting&quot;);</span>
<a href="#l45.547"></a><span id="l45.547" class="difflineplus">+            if (self._connectionReturnedDefer) {</span>
<a href="#l45.548"></a><span id="l45.548" class="difflineplus">+                self._connectionReturnedDefer.reject();</span>
<a href="#l45.549"></a><span id="l45.549" class="difflineplus">+                self._connectionReturnedDefer = null;</span>
<a href="#l45.550"></a><span id="l45.550" class="difflineplus">+            }</span>
<a href="#l45.551"></a><span id="l45.551" class="difflineplus">+            self._updateSyncState(&quot;STOPPED&quot;);</span>
<a href="#l45.552"></a><span id="l45.552" class="difflineplus">+            return;</span>
<a href="#l45.553"></a><span id="l45.553" class="difflineplus">+        }</span>
<a href="#l45.554"></a><span id="l45.554" class="difflineplus">+        console.error(&quot;/sync error %s&quot;, err);</span>
<a href="#l45.555"></a><span id="l45.555" class="difflineplus">+        console.error(err);</span>
<a href="#l45.556"></a><span id="l45.556" class="difflineplus">+</span>
<a href="#l45.557"></a><span id="l45.557" class="difflineplus">+        debuglog(&quot;Starting keep-alive&quot;);</span>
<a href="#l45.558"></a><span id="l45.558" class="difflineplus">+        // Note that we do *not* mark the sync connection as</span>
<a href="#l45.559"></a><span id="l45.559" class="difflineplus">+        // lost yet: we only do this if a keepalive poke</span>
<a href="#l45.560"></a><span id="l45.560" class="difflineplus">+        // fails, since long lived HTTP connections will</span>
<a href="#l45.561"></a><span id="l45.561" class="difflineplus">+        // go away sometimes and we shouldn't treat this as</span>
<a href="#l45.562"></a><span id="l45.562" class="difflineplus">+        // erroneous. We set the state to 'reconnecting'</span>
<a href="#l45.563"></a><span id="l45.563" class="difflineplus">+        // instead, so that clients can onserve this state</span>
<a href="#l45.564"></a><span id="l45.564" class="difflineplus">+        // if they wish.</span>
<a href="#l45.565"></a><span id="l45.565" class="difflineplus">+        self._startKeepAlives().done(function() {</span>
<a href="#l45.566"></a><span id="l45.566" class="difflineplus">+            self._sync(syncOptions);</span>
<a href="#l45.567"></a><span id="l45.567" class="difflineplus">+        });</span>
<a href="#l45.568"></a><span id="l45.568" class="difflineplus">+        self._currentSyncRequest = null;</span>
<a href="#l45.569"></a><span id="l45.569" class="difflineplus">+        self._updateSyncState(&quot;RECONNECTING&quot;);</span>
<a href="#l45.570"></a><span id="l45.570" class="difflineplus">+    });</span>
<a href="#l45.571"></a><span id="l45.571" class="difflineplus">+};</span>
<a href="#l45.572"></a><span id="l45.572" class="difflineplus">+</span>
<a href="#l45.573"></a><span id="l45.573" class="difflineplus">+/**</span>
<a href="#l45.574"></a><span id="l45.574" class="difflineplus">+ * Process data returned from a sync response and propagate it</span>
<a href="#l45.575"></a><span id="l45.575" class="difflineplus">+ * into the model objects</span>
<a href="#l45.576"></a><span id="l45.576" class="difflineplus">+ *</span>
<a href="#l45.577"></a><span id="l45.577" class="difflineplus">+ * @param {string} syncToken the old next_batch token sent to this</span>
<a href="#l45.578"></a><span id="l45.578" class="difflineplus">+ *    sync request.</span>
<a href="#l45.579"></a><span id="l45.579" class="difflineplus">+ * @param {Object} data The response from /sync</span>
<a href="#l45.580"></a><span id="l45.580" class="difflineplus">+ */</span>
<a href="#l45.581"></a><span id="l45.581" class="difflineplus">+SyncApi.prototype._processSyncResponse = function(syncToken, data) {</span>
<a href="#l45.582"></a><span id="l45.582" class="difflineplus">+    var client = this.client;</span>
<a href="#l45.583"></a><span id="l45.583" class="difflineplus">+    var self = this;</span>
<a href="#l45.584"></a><span id="l45.584" class="difflineplus">+</span>
<a href="#l45.585"></a><span id="l45.585" class="difflineplus">+    // data looks like:</span>
<a href="#l45.586"></a><span id="l45.586" class="difflineplus">+    // {</span>
<a href="#l45.587"></a><span id="l45.587" class="difflineplus">+    //    next_batch: $token,</span>
<a href="#l45.588"></a><span id="l45.588" class="difflineplus">+    //    presence: { events: [] },</span>
<a href="#l45.589"></a><span id="l45.589" class="difflineplus">+    //    account_data: { events: [] },</span>
<a href="#l45.590"></a><span id="l45.590" class="difflineplus">+    //    to_device: { events: [] },</span>
<a href="#l45.591"></a><span id="l45.591" class="difflineplus">+    //    rooms: {</span>
<a href="#l45.592"></a><span id="l45.592" class="difflineplus">+    //      invite: {</span>
<a href="#l45.593"></a><span id="l45.593" class="difflineplus">+    //        $roomid: {</span>
<a href="#l45.594"></a><span id="l45.594" class="difflineplus">+    //          invite_state: { events: [] }</span>
<a href="#l45.595"></a><span id="l45.595" class="difflineplus">+    //        }</span>
<a href="#l45.596"></a><span id="l45.596" class="difflineplus">+    //      },</span>
<a href="#l45.597"></a><span id="l45.597" class="difflineplus">+    //      join: {</span>
<a href="#l45.598"></a><span id="l45.598" class="difflineplus">+    //        $roomid: {</span>
<a href="#l45.599"></a><span id="l45.599" class="difflineplus">+    //          state: { events: [] },</span>
<a href="#l45.600"></a><span id="l45.600" class="difflineplus">+    //          timeline: { events: [], prev_batch: $token, limited: true },</span>
<a href="#l45.601"></a><span id="l45.601" class="difflineplus">+    //          ephemeral: { events: [] },</span>
<a href="#l45.602"></a><span id="l45.602" class="difflineplus">+    //          account_data: { events: [] },</span>
<a href="#l45.603"></a><span id="l45.603" class="difflineplus">+    //          unread_notifications: {</span>
<a href="#l45.604"></a><span id="l45.604" class="difflineplus">+    //              highlight_count: 0,</span>
<a href="#l45.605"></a><span id="l45.605" class="difflineplus">+    //              notification_count: 0,</span>
<a href="#l45.606"></a><span id="l45.606" class="difflineplus">+    //          }</span>
<a href="#l45.607"></a><span id="l45.607" class="difflineplus">+    //        }</span>
<a href="#l45.608"></a><span id="l45.608" class="difflineplus">+    //      },</span>
<a href="#l45.609"></a><span id="l45.609" class="difflineplus">+    //      leave: {</span>
<a href="#l45.610"></a><span id="l45.610" class="difflineplus">+    //        $roomid: {</span>
<a href="#l45.611"></a><span id="l45.611" class="difflineplus">+    //          state: { events: [] },</span>
<a href="#l45.612"></a><span id="l45.612" class="difflineplus">+    //          timeline: { events: [], prev_batch: $token }</span>
<a href="#l45.613"></a><span id="l45.613" class="difflineplus">+    //        }</span>
<a href="#l45.614"></a><span id="l45.614" class="difflineplus">+    //      }</span>
<a href="#l45.615"></a><span id="l45.615" class="difflineplus">+    //    },</span>
<a href="#l45.616"></a><span id="l45.616" class="difflineplus">+    // }</span>
<a href="#l45.617"></a><span id="l45.617" class="difflineplus">+</span>
<a href="#l45.618"></a><span id="l45.618" class="difflineplus">+    // TODO-arch:</span>
<a href="#l45.619"></a><span id="l45.619" class="difflineplus">+    // - Each event we pass through needs to be emitted via 'event', can we</span>
<a href="#l45.620"></a><span id="l45.620" class="difflineplus">+    //   do this in one place?</span>
<a href="#l45.621"></a><span id="l45.621" class="difflineplus">+    // - The isBrandNewRoom boilerplate is boilerplatey.</span>
<a href="#l45.622"></a><span id="l45.622" class="difflineplus">+</span>
<a href="#l45.623"></a><span id="l45.623" class="difflineplus">+    // handle presence events (User objects)</span>
<a href="#l45.624"></a><span id="l45.624" class="difflineplus">+    if (data.presence &amp;&amp; utils.isArray(data.presence.events)) {</span>
<a href="#l45.625"></a><span id="l45.625" class="difflineplus">+        data.presence.events.map(client.getEventMapper()).forEach(</span>
<a href="#l45.626"></a><span id="l45.626" class="difflineplus">+        function(presenceEvent) {</span>
<a href="#l45.627"></a><span id="l45.627" class="difflineplus">+            var user = client.store.getUser(presenceEvent.getSender());</span>
<a href="#l45.628"></a><span id="l45.628" class="difflineplus">+            if (user) {</span>
<a href="#l45.629"></a><span id="l45.629" class="difflineplus">+                user.setPresenceEvent(presenceEvent);</span>
<a href="#l45.630"></a><span id="l45.630" class="difflineplus">+            }</span>
<a href="#l45.631"></a><span id="l45.631" class="difflineplus">+            else {</span>
<a href="#l45.632"></a><span id="l45.632" class="difflineplus">+                user = createNewUser(client, presenceEvent.getSender());</span>
<a href="#l45.633"></a><span id="l45.633" class="difflineplus">+                user.setPresenceEvent(presenceEvent);</span>
<a href="#l45.634"></a><span id="l45.634" class="difflineplus">+                client.store.storeUser(user);</span>
<a href="#l45.635"></a><span id="l45.635" class="difflineplus">+            }</span>
<a href="#l45.636"></a><span id="l45.636" class="difflineplus">+            client.emit(&quot;event&quot;, presenceEvent);</span>
<a href="#l45.637"></a><span id="l45.637" class="difflineplus">+        });</span>
<a href="#l45.638"></a><span id="l45.638" class="difflineplus">+    }</span>
<a href="#l45.639"></a><span id="l45.639" class="difflineplus">+</span>
<a href="#l45.640"></a><span id="l45.640" class="difflineplus">+    // handle non-room account_data</span>
<a href="#l45.641"></a><span id="l45.641" class="difflineplus">+    if (data.account_data &amp;&amp; utils.isArray(data.account_data.events)) {</span>
<a href="#l45.642"></a><span id="l45.642" class="difflineplus">+        var events = data.account_data.events.map(client.getEventMapper());</span>
<a href="#l45.643"></a><span id="l45.643" class="difflineplus">+        client.store.storeAccountDataEvents(events);</span>
<a href="#l45.644"></a><span id="l45.644" class="difflineplus">+        events.forEach(</span>
<a href="#l45.645"></a><span id="l45.645" class="difflineplus">+            function(accountDataEvent) {</span>
<a href="#l45.646"></a><span id="l45.646" class="difflineplus">+                if (accountDataEvent.getType() == 'm.push_rules') {</span>
<a href="#l45.647"></a><span id="l45.647" class="difflineplus">+                    client.pushRules = accountDataEvent.getContent();</span>
<a href="#l45.648"></a><span id="l45.648" class="difflineplus">+                }</span>
<a href="#l45.649"></a><span id="l45.649" class="difflineplus">+                client.emit(&quot;accountData&quot;, accountDataEvent);</span>
<a href="#l45.650"></a><span id="l45.650" class="difflineplus">+                return accountDataEvent;</span>
<a href="#l45.651"></a><span id="l45.651" class="difflineplus">+            }</span>
<a href="#l45.652"></a><span id="l45.652" class="difflineplus">+        );</span>
<a href="#l45.653"></a><span id="l45.653" class="difflineplus">+    }</span>
<a href="#l45.654"></a><span id="l45.654" class="difflineplus">+</span>
<a href="#l45.655"></a><span id="l45.655" class="difflineplus">+    // handle to-device events</span>
<a href="#l45.656"></a><span id="l45.656" class="difflineplus">+    if (data.to_device &amp;&amp; utils.isArray(data.to_device.events)) {</span>
<a href="#l45.657"></a><span id="l45.657" class="difflineplus">+        data.to_device.events</span>
<a href="#l45.658"></a><span id="l45.658" class="difflineplus">+            .map(client.getEventMapper())</span>
<a href="#l45.659"></a><span id="l45.659" class="difflineplus">+            .forEach(</span>
<a href="#l45.660"></a><span id="l45.660" class="difflineplus">+                function(toDeviceEvent) {</span>
<a href="#l45.661"></a><span id="l45.661" class="difflineplus">+                    var content = toDeviceEvent.getContent();</span>
<a href="#l45.662"></a><span id="l45.662" class="difflineplus">+                    if (</span>
<a href="#l45.663"></a><span id="l45.663" class="difflineplus">+                        toDeviceEvent.getType() == &quot;m.room.message&quot; &amp;&amp;</span>
<a href="#l45.664"></a><span id="l45.664" class="difflineplus">+                            content.msgtype == &quot;m.bad.encrypted&quot;</span>
<a href="#l45.665"></a><span id="l45.665" class="difflineplus">+                    ) {</span>
<a href="#l45.666"></a><span id="l45.666" class="difflineplus">+                        console.warn(</span>
<a href="#l45.667"></a><span id="l45.667" class="difflineplus">+                            &quot;Unable to decrypt to-device event: &quot; + content.body</span>
<a href="#l45.668"></a><span id="l45.668" class="difflineplus">+                        );</span>
<a href="#l45.669"></a><span id="l45.669" class="difflineplus">+                        return;</span>
<a href="#l45.670"></a><span id="l45.670" class="difflineplus">+                    }</span>
<a href="#l45.671"></a><span id="l45.671" class="difflineplus">+</span>
<a href="#l45.672"></a><span id="l45.672" class="difflineplus">+                    client.emit(&quot;toDeviceEvent&quot;, toDeviceEvent);</span>
<a href="#l45.673"></a><span id="l45.673" class="difflineplus">+                }</span>
<a href="#l45.674"></a><span id="l45.674" class="difflineplus">+            );</span>
<a href="#l45.675"></a><span id="l45.675" class="difflineplus">+    }</span>
<a href="#l45.676"></a><span id="l45.676" class="difflineplus">+</span>
<a href="#l45.677"></a><span id="l45.677" class="difflineplus">+    // the returned json structure is a bit crap, so make it into a</span>
<a href="#l45.678"></a><span id="l45.678" class="difflineplus">+    // nicer form (array) after applying sanity to make sure we don't fail</span>
<a href="#l45.679"></a><span id="l45.679" class="difflineplus">+    // on missing keys (on the off chance)</span>
<a href="#l45.680"></a><span id="l45.680" class="difflineplus">+    var inviteRooms = [];</span>
<a href="#l45.681"></a><span id="l45.681" class="difflineplus">+    var joinRooms = [];</span>
<a href="#l45.682"></a><span id="l45.682" class="difflineplus">+    var leaveRooms = [];</span>
<a href="#l45.683"></a><span id="l45.683" class="difflineplus">+</span>
<a href="#l45.684"></a><span id="l45.684" class="difflineplus">+    if (data.rooms) {</span>
<a href="#l45.685"></a><span id="l45.685" class="difflineplus">+        if (data.rooms.invite) {</span>
<a href="#l45.686"></a><span id="l45.686" class="difflineplus">+            inviteRooms = this._mapSyncResponseToRoomArray(data.rooms.invite);</span>
<a href="#l45.687"></a><span id="l45.687" class="difflineplus">+        }</span>
<a href="#l45.688"></a><span id="l45.688" class="difflineplus">+        if (data.rooms.join) {</span>
<a href="#l45.689"></a><span id="l45.689" class="difflineplus">+            joinRooms = this._mapSyncResponseToRoomArray(data.rooms.join);</span>
<a href="#l45.690"></a><span id="l45.690" class="difflineplus">+        }</span>
<a href="#l45.691"></a><span id="l45.691" class="difflineplus">+        if (data.rooms.leave) {</span>
<a href="#l45.692"></a><span id="l45.692" class="difflineplus">+            leaveRooms = this._mapSyncResponseToRoomArray(data.rooms.leave);</span>
<a href="#l45.693"></a><span id="l45.693" class="difflineplus">+        }</span>
<a href="#l45.694"></a><span id="l45.694" class="difflineplus">+    }</span>
<a href="#l45.695"></a><span id="l45.695" class="difflineplus">+</span>
<a href="#l45.696"></a><span id="l45.696" class="difflineplus">+    this._notifEvents = [];</span>
<a href="#l45.697"></a><span id="l45.697" class="difflineplus">+</span>
<a href="#l45.698"></a><span id="l45.698" class="difflineplus">+    // Handle invites</span>
<a href="#l45.699"></a><span id="l45.699" class="difflineplus">+    inviteRooms.forEach(function(inviteObj) {</span>
<a href="#l45.700"></a><span id="l45.700" class="difflineplus">+        var room = inviteObj.room;</span>
<a href="#l45.701"></a><span id="l45.701" class="difflineplus">+        var stateEvents =</span>
<a href="#l45.702"></a><span id="l45.702" class="difflineplus">+            self._mapSyncEventsFormat(inviteObj.invite_state, room);</span>
<a href="#l45.703"></a><span id="l45.703" class="difflineplus">+        self._processRoomEvents(room, stateEvents);</span>
<a href="#l45.704"></a><span id="l45.704" class="difflineplus">+        if (inviteObj.isBrandNewRoom) {</span>
<a href="#l45.705"></a><span id="l45.705" class="difflineplus">+            room.recalculate(client.credentials.userId);</span>
<a href="#l45.706"></a><span id="l45.706" class="difflineplus">+            client.store.storeRoom(room);</span>
<a href="#l45.707"></a><span id="l45.707" class="difflineplus">+            client.emit(&quot;Room&quot;, room);</span>
<a href="#l45.708"></a><span id="l45.708" class="difflineplus">+        }</span>
<a href="#l45.709"></a><span id="l45.709" class="difflineplus">+        stateEvents.forEach(function(e) { client.emit(&quot;event&quot;, e); });</span>
<a href="#l45.710"></a><span id="l45.710" class="difflineplus">+    });</span>
<a href="#l45.711"></a><span id="l45.711" class="difflineplus">+</span>
<a href="#l45.712"></a><span id="l45.712" class="difflineplus">+    // Handle joins</span>
<a href="#l45.713"></a><span id="l45.713" class="difflineplus">+    joinRooms.forEach(function(joinObj) {</span>
<a href="#l45.714"></a><span id="l45.714" class="difflineplus">+        var room = joinObj.room;</span>
<a href="#l45.715"></a><span id="l45.715" class="difflineplus">+        var stateEvents = self._mapSyncEventsFormat(joinObj.state, room);</span>
<a href="#l45.716"></a><span id="l45.716" class="difflineplus">+        var timelineEvents = self._mapSyncEventsFormat(joinObj.timeline, room);</span>
<a href="#l45.717"></a><span id="l45.717" class="difflineplus">+        var ephemeralEvents = self._mapSyncEventsFormat(joinObj.ephemeral);</span>
<a href="#l45.718"></a><span id="l45.718" class="difflineplus">+        var accountDataEvents = self._mapSyncEventsFormat(joinObj.account_data);</span>
<a href="#l45.719"></a><span id="l45.719" class="difflineplus">+</span>
<a href="#l45.720"></a><span id="l45.720" class="difflineplus">+        // we do this first so it's correct when any of the events fire</span>
<a href="#l45.721"></a><span id="l45.721" class="difflineplus">+        if (joinObj.unread_notifications) {</span>
<a href="#l45.722"></a><span id="l45.722" class="difflineplus">+            room.setUnreadNotificationCount(</span>
<a href="#l45.723"></a><span id="l45.723" class="difflineplus">+                'total', joinObj.unread_notifications.notification_count</span>
<a href="#l45.724"></a><span id="l45.724" class="difflineplus">+            );</span>
<a href="#l45.725"></a><span id="l45.725" class="difflineplus">+            room.setUnreadNotificationCount(</span>
<a href="#l45.726"></a><span id="l45.726" class="difflineplus">+                'highlight', joinObj.unread_notifications.highlight_count</span>
<a href="#l45.727"></a><span id="l45.727" class="difflineplus">+            );</span>
<a href="#l45.728"></a><span id="l45.728" class="difflineplus">+        }</span>
<a href="#l45.729"></a><span id="l45.729" class="difflineplus">+</span>
<a href="#l45.730"></a><span id="l45.730" class="difflineplus">+        joinObj.timeline = joinObj.timeline || {};</span>
<a href="#l45.731"></a><span id="l45.731" class="difflineplus">+</span>
<a href="#l45.732"></a><span id="l45.732" class="difflineplus">+        if (joinObj.isBrandNewRoom) {</span>
<a href="#l45.733"></a><span id="l45.733" class="difflineplus">+            // set the back-pagination token. Do this *before* adding any</span>
<a href="#l45.734"></a><span id="l45.734" class="difflineplus">+            // events so that clients can start back-paginating.</span>
<a href="#l45.735"></a><span id="l45.735" class="difflineplus">+            room.getLiveTimeline().setPaginationToken(</span>
<a href="#l45.736"></a><span id="l45.736" class="difflineplus">+                joinObj.timeline.prev_batch, EventTimeline.BACKWARDS);</span>
<a href="#l45.737"></a><span id="l45.737" class="difflineplus">+        }</span>
<a href="#l45.738"></a><span id="l45.738" class="difflineplus">+        else if (joinObj.timeline.limited) {</span>
<a href="#l45.739"></a><span id="l45.739" class="difflineplus">+            var limited = true;</span>
<a href="#l45.740"></a><span id="l45.740" class="difflineplus">+</span>
<a href="#l45.741"></a><span id="l45.741" class="difflineplus">+            // we've got a limited sync, so we *probably* have a gap in the</span>
<a href="#l45.742"></a><span id="l45.742" class="difflineplus">+            // timeline, so should reset. But we might have been peeking or</span>
<a href="#l45.743"></a><span id="l45.743" class="difflineplus">+            // paginating and already have some of the events, in which</span>
<a href="#l45.744"></a><span id="l45.744" class="difflineplus">+            // case we just want to append any subsequent events to the end</span>
<a href="#l45.745"></a><span id="l45.745" class="difflineplus">+            // of the existing timeline.</span>
<a href="#l45.746"></a><span id="l45.746" class="difflineplus">+            //</span>
<a href="#l45.747"></a><span id="l45.747" class="difflineplus">+            // This is particularly important in the case that we already have</span>
<a href="#l45.748"></a><span id="l45.748" class="difflineplus">+            // *all* of the events in the timeline - in that case, if we reset</span>
<a href="#l45.749"></a><span id="l45.749" class="difflineplus">+            // the timeline, we'll end up with an entirely empty timeline,</span>
<a href="#l45.750"></a><span id="l45.750" class="difflineplus">+            // which we'll try to paginate but not get any new events (which</span>
<a href="#l45.751"></a><span id="l45.751" class="difflineplus">+            // will stop us linking the empty timeline into the chain).</span>
<a href="#l45.752"></a><span id="l45.752" class="difflineplus">+            //</span>
<a href="#l45.753"></a><span id="l45.753" class="difflineplus">+            for (var i = timelineEvents.length - 1; i &gt;= 0; i--) {</span>
<a href="#l45.754"></a><span id="l45.754" class="difflineplus">+                var eventId = timelineEvents[i].getId();</span>
<a href="#l45.755"></a><span id="l45.755" class="difflineplus">+                if (room.getTimelineForEvent(eventId)) {</span>
<a href="#l45.756"></a><span id="l45.756" class="difflineplus">+                    debuglog(&quot;Already have event &quot; + eventId + &quot; in limited &quot; +</span>
<a href="#l45.757"></a><span id="l45.757" class="difflineplus">+                             &quot;sync - not resetting&quot;);</span>
<a href="#l45.758"></a><span id="l45.758" class="difflineplus">+                    limited = false;</span>
<a href="#l45.759"></a><span id="l45.759" class="difflineplus">+</span>
<a href="#l45.760"></a><span id="l45.760" class="difflineplus">+                    // we might still be missing some of the events before i;</span>
<a href="#l45.761"></a><span id="l45.761" class="difflineplus">+                    // we don't want to be adding them to the end of the</span>
<a href="#l45.762"></a><span id="l45.762" class="difflineplus">+                    // timeline because that would put them out of order.</span>
<a href="#l45.763"></a><span id="l45.763" class="difflineplus">+                    timelineEvents.splice(0, i);</span>
<a href="#l45.764"></a><span id="l45.764" class="difflineplus">+</span>
<a href="#l45.765"></a><span id="l45.765" class="difflineplus">+                    // XXX: there's a problem here if the skipped part of the</span>
<a href="#l45.766"></a><span id="l45.766" class="difflineplus">+                    // timeline modifies the state set in stateEvents, because</span>
<a href="#l45.767"></a><span id="l45.767" class="difflineplus">+                    // we'll end up using the state from stateEvents rather</span>
<a href="#l45.768"></a><span id="l45.768" class="difflineplus">+                    // than the later state from timelineEvents. We probably</span>
<a href="#l45.769"></a><span id="l45.769" class="difflineplus">+                    // need to wind stateEvents forward over the events we're</span>
<a href="#l45.770"></a><span id="l45.770" class="difflineplus">+                    // skipping.</span>
<a href="#l45.771"></a><span id="l45.771" class="difflineplus">+</span>
<a href="#l45.772"></a><span id="l45.772" class="difflineplus">+                    break;</span>
<a href="#l45.773"></a><span id="l45.773" class="difflineplus">+                }</span>
<a href="#l45.774"></a><span id="l45.774" class="difflineplus">+            }</span>
<a href="#l45.775"></a><span id="l45.775" class="difflineplus">+</span>
<a href="#l45.776"></a><span id="l45.776" class="difflineplus">+            if (limited) {</span>
<a href="#l45.777"></a><span id="l45.777" class="difflineplus">+                // save the old 'next_batch' token as the</span>
<a href="#l45.778"></a><span id="l45.778" class="difflineplus">+                // forward-pagination token for the previously-active</span>
<a href="#l45.779"></a><span id="l45.779" class="difflineplus">+                // timeline.</span>
<a href="#l45.780"></a><span id="l45.780" class="difflineplus">+                room.currentState.paginationToken = syncToken;</span>
<a href="#l45.781"></a><span id="l45.781" class="difflineplus">+                self._deregisterStateListeners(room);</span>
<a href="#l45.782"></a><span id="l45.782" class="difflineplus">+                room.resetLiveTimeline(joinObj.timeline.prev_batch);</span>
<a href="#l45.783"></a><span id="l45.783" class="difflineplus">+</span>
<a href="#l45.784"></a><span id="l45.784" class="difflineplus">+                // We have to assume any gap in any timeline is</span>
<a href="#l45.785"></a><span id="l45.785" class="difflineplus">+                // reason to stop incrementally tracking notifications and</span>
<a href="#l45.786"></a><span id="l45.786" class="difflineplus">+                // reset the timeline.</span>
<a href="#l45.787"></a><span id="l45.787" class="difflineplus">+                client.resetNotifTimelineSet();</span>
<a href="#l45.788"></a><span id="l45.788" class="difflineplus">+</span>
<a href="#l45.789"></a><span id="l45.789" class="difflineplus">+                self._registerStateListeners(room);</span>
<a href="#l45.790"></a><span id="l45.790" class="difflineplus">+            }</span>
<a href="#l45.791"></a><span id="l45.791" class="difflineplus">+        }</span>
<a href="#l45.792"></a><span id="l45.792" class="difflineplus">+</span>
<a href="#l45.793"></a><span id="l45.793" class="difflineplus">+        self._processRoomEvents(room, stateEvents, timelineEvents);</span>
<a href="#l45.794"></a><span id="l45.794" class="difflineplus">+</span>
<a href="#l45.795"></a><span id="l45.795" class="difflineplus">+        // XXX: should we be adding ephemeralEvents to the timeline?</span>
<a href="#l45.796"></a><span id="l45.796" class="difflineplus">+        // It feels like that for symmetry with room.addAccountData()</span>
<a href="#l45.797"></a><span id="l45.797" class="difflineplus">+        // there should be a room.addEphemeralEvents() or similar.</span>
<a href="#l45.798"></a><span id="l45.798" class="difflineplus">+        room.addLiveEvents(ephemeralEvents);</span>
<a href="#l45.799"></a><span id="l45.799" class="difflineplus">+</span>
<a href="#l45.800"></a><span id="l45.800" class="difflineplus">+        // we deliberately don't add accountData to the timeline</span>
<a href="#l45.801"></a><span id="l45.801" class="difflineplus">+        room.addAccountData(accountDataEvents);</span>
<a href="#l45.802"></a><span id="l45.802" class="difflineplus">+</span>
<a href="#l45.803"></a><span id="l45.803" class="difflineplus">+        room.recalculate(client.credentials.userId);</span>
<a href="#l45.804"></a><span id="l45.804" class="difflineplus">+        if (joinObj.isBrandNewRoom) {</span>
<a href="#l45.805"></a><span id="l45.805" class="difflineplus">+            client.store.storeRoom(room);</span>
<a href="#l45.806"></a><span id="l45.806" class="difflineplus">+            client.emit(&quot;Room&quot;, room);</span>
<a href="#l45.807"></a><span id="l45.807" class="difflineplus">+        }</span>
<a href="#l45.808"></a><span id="l45.808" class="difflineplus">+        stateEvents.forEach(function(e) { client.emit(&quot;event&quot;, e); });</span>
<a href="#l45.809"></a><span id="l45.809" class="difflineplus">+        timelineEvents.forEach(function(e) { client.emit(&quot;event&quot;, e); });</span>
<a href="#l45.810"></a><span id="l45.810" class="difflineplus">+        ephemeralEvents.forEach(function(e) { client.emit(&quot;event&quot;, e); });</span>
<a href="#l45.811"></a><span id="l45.811" class="difflineplus">+        accountDataEvents.forEach(function(e) { client.emit(&quot;event&quot;, e); });</span>
<a href="#l45.812"></a><span id="l45.812" class="difflineplus">+    });</span>
<a href="#l45.813"></a><span id="l45.813" class="difflineplus">+</span>
<a href="#l45.814"></a><span id="l45.814" class="difflineplus">+    // Handle leaves (e.g. kicked rooms)</span>
<a href="#l45.815"></a><span id="l45.815" class="difflineplus">+    leaveRooms.forEach(function(leaveObj) {</span>
<a href="#l45.816"></a><span id="l45.816" class="difflineplus">+        var room = leaveObj.room;</span>
<a href="#l45.817"></a><span id="l45.817" class="difflineplus">+        var stateEvents =</span>
<a href="#l45.818"></a><span id="l45.818" class="difflineplus">+            self._mapSyncEventsFormat(leaveObj.state, room);</span>
<a href="#l45.819"></a><span id="l45.819" class="difflineplus">+        var timelineEvents =</span>
<a href="#l45.820"></a><span id="l45.820" class="difflineplus">+            self._mapSyncEventsFormat(leaveObj.timeline, room);</span>
<a href="#l45.821"></a><span id="l45.821" class="difflineplus">+        var accountDataEvents =</span>
<a href="#l45.822"></a><span id="l45.822" class="difflineplus">+            self._mapSyncEventsFormat(leaveObj.account_data);</span>
<a href="#l45.823"></a><span id="l45.823" class="difflineplus">+</span>
<a href="#l45.824"></a><span id="l45.824" class="difflineplus">+        self._processRoomEvents(room, stateEvents, timelineEvents);</span>
<a href="#l45.825"></a><span id="l45.825" class="difflineplus">+        room.addAccountData(accountDataEvents);</span>
<a href="#l45.826"></a><span id="l45.826" class="difflineplus">+</span>
<a href="#l45.827"></a><span id="l45.827" class="difflineplus">+        room.recalculate(client.credentials.userId);</span>
<a href="#l45.828"></a><span id="l45.828" class="difflineplus">+        if (leaveObj.isBrandNewRoom) {</span>
<a href="#l45.829"></a><span id="l45.829" class="difflineplus">+            client.store.storeRoom(room);</span>
<a href="#l45.830"></a><span id="l45.830" class="difflineplus">+            client.emit(&quot;Room&quot;, room);</span>
<a href="#l45.831"></a><span id="l45.831" class="difflineplus">+        }</span>
<a href="#l45.832"></a><span id="l45.832" class="difflineplus">+</span>
<a href="#l45.833"></a><span id="l45.833" class="difflineplus">+        stateEvents.forEach(function(e) { client.emit(&quot;event&quot;, e); });</span>
<a href="#l45.834"></a><span id="l45.834" class="difflineplus">+        timelineEvents.forEach(function(e) { client.emit(&quot;event&quot;, e); });</span>
<a href="#l45.835"></a><span id="l45.835" class="difflineplus">+        accountDataEvents.forEach(function(e) { client.emit(&quot;event&quot;, e); });</span>
<a href="#l45.836"></a><span id="l45.836" class="difflineplus">+    });</span>
<a href="#l45.837"></a><span id="l45.837" class="difflineplus">+</span>
<a href="#l45.838"></a><span id="l45.838" class="difflineplus">+    // update the notification timeline, if appropriate.</span>
<a href="#l45.839"></a><span id="l45.839" class="difflineplus">+    // we only do this for live events, as otherwise we can't order them sanely</span>
<a href="#l45.840"></a><span id="l45.840" class="difflineplus">+    // in the timeline relative to ones paginated in by /notifications.</span>
<a href="#l45.841"></a><span id="l45.841" class="difflineplus">+    // XXX: we could fix this by making EventTimeline support chronological</span>
<a href="#l45.842"></a><span id="l45.842" class="difflineplus">+    // ordering... but it doesn't, right now.</span>
<a href="#l45.843"></a><span id="l45.843" class="difflineplus">+    if (syncToken &amp;&amp; this._notifEvents.length) {</span>
<a href="#l45.844"></a><span id="l45.844" class="difflineplus">+        this._notifEvents.sort(function(a, b) {</span>
<a href="#l45.845"></a><span id="l45.845" class="difflineplus">+            return a.getTs() - b.getTs();</span>
<a href="#l45.846"></a><span id="l45.846" class="difflineplus">+        });</span>
<a href="#l45.847"></a><span id="l45.847" class="difflineplus">+        this._notifEvents.forEach(function(event) {</span>
<a href="#l45.848"></a><span id="l45.848" class="difflineplus">+            client.getNotifTimelineSet().addLiveEvent(event);</span>
<a href="#l45.849"></a><span id="l45.849" class="difflineplus">+        });</span>
<a href="#l45.850"></a><span id="l45.850" class="difflineplus">+    }</span>
<a href="#l45.851"></a><span id="l45.851" class="difflineplus">+};</span>
<a href="#l45.852"></a><span id="l45.852" class="difflineplus">+</span>
<a href="#l45.853"></a><span id="l45.853" class="difflineplus">+/**</span>
<a href="#l45.854"></a><span id="l45.854" class="difflineplus">+ * Starts polling the connectivity check endpoint</span>
<a href="#l45.855"></a><span id="l45.855" class="difflineplus">+ * @param {number} delay How long to delay until the first poll.</span>
<a href="#l45.856"></a><span id="l45.856" class="difflineplus">+ *        defaults to a short, randomised interval (to prevent</span>
<a href="#l45.857"></a><span id="l45.857" class="difflineplus">+ *        tightlooping if /versions succeeds but /sync etc. fail).</span>
<a href="#l45.858"></a><span id="l45.858" class="difflineplus">+ * @return {promise}</span>
<a href="#l45.859"></a><span id="l45.859" class="difflineplus">+ */</span>
<a href="#l45.860"></a><span id="l45.860" class="difflineplus">+SyncApi.prototype._startKeepAlives = function(delay) {</span>
<a href="#l45.861"></a><span id="l45.861" class="difflineplus">+    if (delay === undefined) {</span>
<a href="#l45.862"></a><span id="l45.862" class="difflineplus">+        delay = 2000 + Math.floor(Math.random() * 5000);</span>
<a href="#l45.863"></a><span id="l45.863" class="difflineplus">+    }</span>
<a href="#l45.864"></a><span id="l45.864" class="difflineplus">+</span>
<a href="#l45.865"></a><span id="l45.865" class="difflineplus">+    if (this._keepAliveTimer !== null) {</span>
<a href="#l45.866"></a><span id="l45.866" class="difflineplus">+        clearTimeout(this._keepAliveTimer);</span>
<a href="#l45.867"></a><span id="l45.867" class="difflineplus">+    }</span>
<a href="#l45.868"></a><span id="l45.868" class="difflineplus">+    var self = this;</span>
<a href="#l45.869"></a><span id="l45.869" class="difflineplus">+    if (delay &gt; 0) {</span>
<a href="#l45.870"></a><span id="l45.870" class="difflineplus">+        self._keepAliveTimer = setTimeout(</span>
<a href="#l45.871"></a><span id="l45.871" class="difflineplus">+            self._pokeKeepAlive.bind(self),</span>
<a href="#l45.872"></a><span id="l45.872" class="difflineplus">+            delay</span>
<a href="#l45.873"></a><span id="l45.873" class="difflineplus">+        );</span>
<a href="#l45.874"></a><span id="l45.874" class="difflineplus">+    } else {</span>
<a href="#l45.875"></a><span id="l45.875" class="difflineplus">+        self._pokeKeepAlive();</span>
<a href="#l45.876"></a><span id="l45.876" class="difflineplus">+    }</span>
<a href="#l45.877"></a><span id="l45.877" class="difflineplus">+    if (!this._connectionReturnedDefer) {</span>
<a href="#l45.878"></a><span id="l45.878" class="difflineplus">+        this._connectionReturnedDefer = q.defer();</span>
<a href="#l45.879"></a><span id="l45.879" class="difflineplus">+    }</span>
<a href="#l45.880"></a><span id="l45.880" class="difflineplus">+    return this._connectionReturnedDefer.promise;</span>
<a href="#l45.881"></a><span id="l45.881" class="difflineplus">+};</span>
<a href="#l45.882"></a><span id="l45.882" class="difflineplus">+</span>
<a href="#l45.883"></a><span id="l45.883" class="difflineplus">+/**</span>
<a href="#l45.884"></a><span id="l45.884" class="difflineplus">+ *</span>
<a href="#l45.885"></a><span id="l45.885" class="difflineplus">+ */</span>
<a href="#l45.886"></a><span id="l45.886" class="difflineplus">+SyncApi.prototype._pokeKeepAlive = function() {</span>
<a href="#l45.887"></a><span id="l45.887" class="difflineplus">+    var self = this;</span>
<a href="#l45.888"></a><span id="l45.888" class="difflineplus">+    function success() {</span>
<a href="#l45.889"></a><span id="l45.889" class="difflineplus">+        clearTimeout(self._keepAliveTimer);</span>
<a href="#l45.890"></a><span id="l45.890" class="difflineplus">+        if (self._connectionReturnedDefer) {</span>
<a href="#l45.891"></a><span id="l45.891" class="difflineplus">+            self._connectionReturnedDefer.resolve();</span>
<a href="#l45.892"></a><span id="l45.892" class="difflineplus">+            self._connectionReturnedDefer = null;</span>
<a href="#l45.893"></a><span id="l45.893" class="difflineplus">+        }</span>
<a href="#l45.894"></a><span id="l45.894" class="difflineplus">+    }</span>
<a href="#l45.895"></a><span id="l45.895" class="difflineplus">+</span>
<a href="#l45.896"></a><span id="l45.896" class="difflineplus">+    this.client._http.request(</span>
<a href="#l45.897"></a><span id="l45.897" class="difflineplus">+        undefined, // callback</span>
<a href="#l45.898"></a><span id="l45.898" class="difflineplus">+        &quot;GET&quot;, &quot;/_matrix/client/versions&quot;,</span>
<a href="#l45.899"></a><span id="l45.899" class="difflineplus">+        undefined, // queryParams</span>
<a href="#l45.900"></a><span id="l45.900" class="difflineplus">+        undefined, // data</span>
<a href="#l45.901"></a><span id="l45.901" class="difflineplus">+        {</span>
<a href="#l45.902"></a><span id="l45.902" class="difflineplus">+            prefix: '',</span>
<a href="#l45.903"></a><span id="l45.903" class="difflineplus">+            localTimeoutMs: 15 * 1000,</span>
<a href="#l45.904"></a><span id="l45.904" class="difflineplus">+        }</span>
<a href="#l45.905"></a><span id="l45.905" class="difflineplus">+    ).done(function() {</span>
<a href="#l45.906"></a><span id="l45.906" class="difflineplus">+        success();</span>
<a href="#l45.907"></a><span id="l45.907" class="difflineplus">+    }, function(err) {</span>
<a href="#l45.908"></a><span id="l45.908" class="difflineplus">+        if (err.httpStatus == 400) {</span>
<a href="#l45.909"></a><span id="l45.909" class="difflineplus">+            // treat this as a success because the server probably just doesn't</span>
<a href="#l45.910"></a><span id="l45.910" class="difflineplus">+            // support /versions: point is, we're getting a response.</span>
<a href="#l45.911"></a><span id="l45.911" class="difflineplus">+            // We wait a short time though, just in case somehow the server</span>
<a href="#l45.912"></a><span id="l45.912" class="difflineplus">+            // is in a mode where it 400s /versions responses and sync etc.</span>
<a href="#l45.913"></a><span id="l45.913" class="difflineplus">+            // responses fail, this will mean we don't hammer in a loop.</span>
<a href="#l45.914"></a><span id="l45.914" class="difflineplus">+            self._keepAliveTimer = setTimeout(success, 2000);</span>
<a href="#l45.915"></a><span id="l45.915" class="difflineplus">+        } else {</span>
<a href="#l45.916"></a><span id="l45.916" class="difflineplus">+            self._keepAliveTimer = setTimeout(</span>
<a href="#l45.917"></a><span id="l45.917" class="difflineplus">+                self._pokeKeepAlive.bind(self),</span>
<a href="#l45.918"></a><span id="l45.918" class="difflineplus">+                5000 + Math.floor(Math.random() * 5000)</span>
<a href="#l45.919"></a><span id="l45.919" class="difflineplus">+            );</span>
<a href="#l45.920"></a><span id="l45.920" class="difflineplus">+            // A keepalive has failed, so we emit the</span>
<a href="#l45.921"></a><span id="l45.921" class="difflineplus">+            // error state (whether or not this is the</span>
<a href="#l45.922"></a><span id="l45.922" class="difflineplus">+            // first failure).</span>
<a href="#l45.923"></a><span id="l45.923" class="difflineplus">+            // Note we do this after setting the timer:</span>
<a href="#l45.924"></a><span id="l45.924" class="difflineplus">+            // this lets the unit tests advance the mock</span>
<a href="#l45.925"></a><span id="l45.925" class="difflineplus">+            // clock when the get the error.</span>
<a href="#l45.926"></a><span id="l45.926" class="difflineplus">+            self._updateSyncState(&quot;ERROR&quot;, { error: err });</span>
<a href="#l45.927"></a><span id="l45.927" class="difflineplus">+        }</span>
<a href="#l45.928"></a><span id="l45.928" class="difflineplus">+    });</span>
<a href="#l45.929"></a><span id="l45.929" class="difflineplus">+};</span>
<a href="#l45.930"></a><span id="l45.930" class="difflineplus">+</span>
<a href="#l45.931"></a><span id="l45.931" class="difflineplus">+/**</span>
<a href="#l45.932"></a><span id="l45.932" class="difflineplus">+ * @param {Object} obj</span>
<a href="#l45.933"></a><span id="l45.933" class="difflineplus">+ * @return {Object[]}</span>
<a href="#l45.934"></a><span id="l45.934" class="difflineplus">+ */</span>
<a href="#l45.935"></a><span id="l45.935" class="difflineplus">+SyncApi.prototype._mapSyncResponseToRoomArray = function(obj) {</span>
<a href="#l45.936"></a><span id="l45.936" class="difflineplus">+    // Maps { roomid: {stuff}, roomid: {stuff} }</span>
<a href="#l45.937"></a><span id="l45.937" class="difflineplus">+    // to</span>
<a href="#l45.938"></a><span id="l45.938" class="difflineplus">+    // [{stuff+Room+isBrandNewRoom}, {stuff+Room+isBrandNewRoom}]</span>
<a href="#l45.939"></a><span id="l45.939" class="difflineplus">+    var client = this.client;</span>
<a href="#l45.940"></a><span id="l45.940" class="difflineplus">+    var self = this;</span>
<a href="#l45.941"></a><span id="l45.941" class="difflineplus">+    return utils.keys(obj).map(function(roomId) {</span>
<a href="#l45.942"></a><span id="l45.942" class="difflineplus">+        var arrObj = obj[roomId];</span>
<a href="#l45.943"></a><span id="l45.943" class="difflineplus">+        var room = client.store.getRoom(roomId);</span>
<a href="#l45.944"></a><span id="l45.944" class="difflineplus">+        var isBrandNewRoom = false;</span>
<a href="#l45.945"></a><span id="l45.945" class="difflineplus">+        if (!room) {</span>
<a href="#l45.946"></a><span id="l45.946" class="difflineplus">+            room = self.createRoom(roomId);</span>
<a href="#l45.947"></a><span id="l45.947" class="difflineplus">+            isBrandNewRoom = true;</span>
<a href="#l45.948"></a><span id="l45.948" class="difflineplus">+        }</span>
<a href="#l45.949"></a><span id="l45.949" class="difflineplus">+        arrObj.room = room;</span>
<a href="#l45.950"></a><span id="l45.950" class="difflineplus">+        arrObj.isBrandNewRoom = isBrandNewRoom;</span>
<a href="#l45.951"></a><span id="l45.951" class="difflineplus">+        return arrObj;</span>
<a href="#l45.952"></a><span id="l45.952" class="difflineplus">+    });</span>
<a href="#l45.953"></a><span id="l45.953" class="difflineplus">+};</span>
<a href="#l45.954"></a><span id="l45.954" class="difflineplus">+</span>
<a href="#l45.955"></a><span id="l45.955" class="difflineplus">+/**</span>
<a href="#l45.956"></a><span id="l45.956" class="difflineplus">+ * @param {Object} obj</span>
<a href="#l45.957"></a><span id="l45.957" class="difflineplus">+ * @param {Room} room</span>
<a href="#l45.958"></a><span id="l45.958" class="difflineplus">+ * @return {MatrixEvent[]}</span>
<a href="#l45.959"></a><span id="l45.959" class="difflineplus">+ */</span>
<a href="#l45.960"></a><span id="l45.960" class="difflineplus">+SyncApi.prototype._mapSyncEventsFormat = function(obj, room) {</span>
<a href="#l45.961"></a><span id="l45.961" class="difflineplus">+    if (!obj || !utils.isArray(obj.events)) {</span>
<a href="#l45.962"></a><span id="l45.962" class="difflineplus">+        return [];</span>
<a href="#l45.963"></a><span id="l45.963" class="difflineplus">+    }</span>
<a href="#l45.964"></a><span id="l45.964" class="difflineplus">+    var mapper = this.client.getEventMapper();</span>
<a href="#l45.965"></a><span id="l45.965" class="difflineplus">+    return obj.events.map(function(e) {</span>
<a href="#l45.966"></a><span id="l45.966" class="difflineplus">+        if (room) {</span>
<a href="#l45.967"></a><span id="l45.967" class="difflineplus">+            e.room_id = room.roomId;</span>
<a href="#l45.968"></a><span id="l45.968" class="difflineplus">+        }</span>
<a href="#l45.969"></a><span id="l45.969" class="difflineplus">+        return mapper(e);</span>
<a href="#l45.970"></a><span id="l45.970" class="difflineplus">+    });</span>
<a href="#l45.971"></a><span id="l45.971" class="difflineplus">+};</span>
<a href="#l45.972"></a><span id="l45.972" class="difflineplus">+</span>
<a href="#l45.973"></a><span id="l45.973" class="difflineplus">+/**</span>
<a href="#l45.974"></a><span id="l45.974" class="difflineplus">+ * @param {Room} room</span>
<a href="#l45.975"></a><span id="l45.975" class="difflineplus">+ */</span>
<a href="#l45.976"></a><span id="l45.976" class="difflineplus">+SyncApi.prototype._resolveInvites = function(room) {</span>
<a href="#l45.977"></a><span id="l45.977" class="difflineplus">+    if (!room || !this.opts.resolveInvitesToProfiles) {</span>
<a href="#l45.978"></a><span id="l45.978" class="difflineplus">+        return;</span>
<a href="#l45.979"></a><span id="l45.979" class="difflineplus">+    }</span>
<a href="#l45.980"></a><span id="l45.980" class="difflineplus">+    var client = this.client;</span>
<a href="#l45.981"></a><span id="l45.981" class="difflineplus">+    // For each invited room member we want to give them a displayname/avatar url</span>
<a href="#l45.982"></a><span id="l45.982" class="difflineplus">+    // if they have one (the m.room.member invites don't contain this).</span>
<a href="#l45.983"></a><span id="l45.983" class="difflineplus">+    room.getMembersWithMembership(&quot;invite&quot;).forEach(function(member) {</span>
<a href="#l45.984"></a><span id="l45.984" class="difflineplus">+        if (member._requestedProfileInfo) {</span>
<a href="#l45.985"></a><span id="l45.985" class="difflineplus">+            return;</span>
<a href="#l45.986"></a><span id="l45.986" class="difflineplus">+        }</span>
<a href="#l45.987"></a><span id="l45.987" class="difflineplus">+        member._requestedProfileInfo = true;</span>
<a href="#l45.988"></a><span id="l45.988" class="difflineplus">+        // try to get a cached copy first.</span>
<a href="#l45.989"></a><span id="l45.989" class="difflineplus">+        var user = client.getUser(member.userId);</span>
<a href="#l45.990"></a><span id="l45.990" class="difflineplus">+        var promise;</span>
<a href="#l45.991"></a><span id="l45.991" class="difflineplus">+        if (user) {</span>
<a href="#l45.992"></a><span id="l45.992" class="difflineplus">+            promise = q({</span>
<a href="#l45.993"></a><span id="l45.993" class="difflineplus">+                avatar_url: user.avatarUrl,</span>
<a href="#l45.994"></a><span id="l45.994" class="difflineplus">+                displayname: user.displayName</span>
<a href="#l45.995"></a><span id="l45.995" class="difflineplus">+            });</span>
<a href="#l45.996"></a><span id="l45.996" class="difflineplus">+        }</span>
<a href="#l45.997"></a><span id="l45.997" class="difflineplus">+        else {</span>
<a href="#l45.998"></a><span id="l45.998" class="difflineplus">+            promise = client.getProfileInfo(member.userId);</span>
<a href="#l45.999"></a><span id="l45.999" class="difflineplus">+        }</span>
<a href="#l45.1000"></a><span id="l45.1000" class="difflineplus">+        promise.done(function(info) {</span>
<a href="#l45.1001"></a><span id="l45.1001" class="difflineplus">+            // slightly naughty by doctoring the invite event but this means all</span>
<a href="#l45.1002"></a><span id="l45.1002" class="difflineplus">+            // the code paths remain the same between invite/join display name stuff</span>
<a href="#l45.1003"></a><span id="l45.1003" class="difflineplus">+            // which is a worthy trade-off for some minor pollution.</span>
<a href="#l45.1004"></a><span id="l45.1004" class="difflineplus">+            var inviteEvent = member.events.member;</span>
<a href="#l45.1005"></a><span id="l45.1005" class="difflineplus">+            if (inviteEvent.getContent().membership !== &quot;invite&quot;) {</span>
<a href="#l45.1006"></a><span id="l45.1006" class="difflineplus">+                // between resolving and now they have since joined, so don't clobber</span>
<a href="#l45.1007"></a><span id="l45.1007" class="difflineplus">+                return;</span>
<a href="#l45.1008"></a><span id="l45.1008" class="difflineplus">+            }</span>
<a href="#l45.1009"></a><span id="l45.1009" class="difflineplus">+            inviteEvent.getContent().avatar_url = info.avatar_url;</span>
<a href="#l45.1010"></a><span id="l45.1010" class="difflineplus">+            inviteEvent.getContent().displayname = info.displayname;</span>
<a href="#l45.1011"></a><span id="l45.1011" class="difflineplus">+            // fire listeners</span>
<a href="#l45.1012"></a><span id="l45.1012" class="difflineplus">+            member.setMembershipEvent(inviteEvent, room.currentState);</span>
<a href="#l45.1013"></a><span id="l45.1013" class="difflineplus">+        }, function(err) {</span>
<a href="#l45.1014"></a><span id="l45.1014" class="difflineplus">+            // OH WELL.</span>
<a href="#l45.1015"></a><span id="l45.1015" class="difflineplus">+        });</span>
<a href="#l45.1016"></a><span id="l45.1016" class="difflineplus">+    });</span>
<a href="#l45.1017"></a><span id="l45.1017" class="difflineplus">+};</span>
<a href="#l45.1018"></a><span id="l45.1018" class="difflineplus">+</span>
<a href="#l45.1019"></a><span id="l45.1019" class="difflineplus">+/**</span>
<a href="#l45.1020"></a><span id="l45.1020" class="difflineplus">+ * @param {Room} room</span>
<a href="#l45.1021"></a><span id="l45.1021" class="difflineplus">+ * @param {MatrixEvent[]} stateEventList A list of state events. This is the state</span>
<a href="#l45.1022"></a><span id="l45.1022" class="difflineplus">+ * at the *START* of the timeline list if it is supplied.</span>
<a href="#l45.1023"></a><span id="l45.1023" class="difflineplus">+ * @param {?MatrixEvent[]} timelineEventList A list of timeline events. Lower index</span>
<a href="#l45.1024"></a><span id="l45.1024" class="difflineplus">+ * is earlier in time. Higher index is later.</span>
<a href="#l45.1025"></a><span id="l45.1025" class="difflineplus">+ */</span>
<a href="#l45.1026"></a><span id="l45.1026" class="difflineplus">+SyncApi.prototype._processRoomEvents = function(room, stateEventList,</span>
<a href="#l45.1027"></a><span id="l45.1027" class="difflineplus">+                                                timelineEventList) {</span>
<a href="#l45.1028"></a><span id="l45.1028" class="difflineplus">+    timelineEventList = timelineEventList || [];</span>
<a href="#l45.1029"></a><span id="l45.1029" class="difflineplus">+    var client = this.client;</span>
<a href="#l45.1030"></a><span id="l45.1030" class="difflineplus">+    // &quot;old&quot; and &quot;current&quot; state are the same initially; they</span>
<a href="#l45.1031"></a><span id="l45.1031" class="difflineplus">+    // start diverging if the user paginates.</span>
<a href="#l45.1032"></a><span id="l45.1032" class="difflineplus">+    // We must deep copy otherwise membership changes in old state</span>
<a href="#l45.1033"></a><span id="l45.1033" class="difflineplus">+    // will leak through to current state!</span>
<a href="#l45.1034"></a><span id="l45.1034" class="difflineplus">+    var oldStateEvents = utils.map(</span>
<a href="#l45.1035"></a><span id="l45.1035" class="difflineplus">+        utils.deepCopy(</span>
<a href="#l45.1036"></a><span id="l45.1036" class="difflineplus">+            stateEventList.map(function(mxEvent) { return mxEvent.event; })</span>
<a href="#l45.1037"></a><span id="l45.1037" class="difflineplus">+        ), client.getEventMapper()</span>
<a href="#l45.1038"></a><span id="l45.1038" class="difflineplus">+    );</span>
<a href="#l45.1039"></a><span id="l45.1039" class="difflineplus">+    var stateEvents = stateEventList;</span>
<a href="#l45.1040"></a><span id="l45.1040" class="difflineplus">+</span>
<a href="#l45.1041"></a><span id="l45.1041" class="difflineplus">+    // set the state of the room to as it was before the timeline executes</span>
<a href="#l45.1042"></a><span id="l45.1042" class="difflineplus">+    //</span>
<a href="#l45.1043"></a><span id="l45.1043" class="difflineplus">+    // XXX: what if we've already seen (some of) the events in the timeline,</span>
<a href="#l45.1044"></a><span id="l45.1044" class="difflineplus">+    // and they modify some of the state set in stateEvents? In that case we'll</span>
<a href="#l45.1045"></a><span id="l45.1045" class="difflineplus">+    // end up with the state from stateEvents, instead of the more recent state</span>
<a href="#l45.1046"></a><span id="l45.1046" class="difflineplus">+    // from the timeline.</span>
<a href="#l45.1047"></a><span id="l45.1047" class="difflineplus">+    room.oldState.setStateEvents(oldStateEvents);</span>
<a href="#l45.1048"></a><span id="l45.1048" class="difflineplus">+    room.currentState.setStateEvents(stateEvents);</span>
<a href="#l45.1049"></a><span id="l45.1049" class="difflineplus">+</span>
<a href="#l45.1050"></a><span id="l45.1050" class="difflineplus">+    this._resolveInvites(room);</span>
<a href="#l45.1051"></a><span id="l45.1051" class="difflineplus">+</span>
<a href="#l45.1052"></a><span id="l45.1052" class="difflineplus">+    // recalculate the room name at this point as adding events to the timeline</span>
<a href="#l45.1053"></a><span id="l45.1053" class="difflineplus">+    // may make notifications appear which should have the right name.</span>
<a href="#l45.1054"></a><span id="l45.1054" class="difflineplus">+    room.recalculate(this.client.credentials.userId);</span>
<a href="#l45.1055"></a><span id="l45.1055" class="difflineplus">+</span>
<a href="#l45.1056"></a><span id="l45.1056" class="difflineplus">+    // gather our notifications into this._notifEvents</span>
<a href="#l45.1057"></a><span id="l45.1057" class="difflineplus">+    if (client.getNotifTimelineSet()) {</span>
<a href="#l45.1058"></a><span id="l45.1058" class="difflineplus">+        for (var i = 0; i &lt; timelineEventList.length; i++) {</span>
<a href="#l45.1059"></a><span id="l45.1059" class="difflineplus">+            var pushActions = client.getPushActionsForEvent(timelineEventList[i]);</span>
<a href="#l45.1060"></a><span id="l45.1060" class="difflineplus">+            if (pushActions &amp;&amp; pushActions.notify &amp;&amp;</span>
<a href="#l45.1061"></a><span id="l45.1061" class="difflineplus">+                pushActions.tweaks &amp;&amp; pushActions.tweaks.highlight)</span>
<a href="#l45.1062"></a><span id="l45.1062" class="difflineplus">+            {</span>
<a href="#l45.1063"></a><span id="l45.1063" class="difflineplus">+                this._notifEvents.push(timelineEventList[i]);</span>
<a href="#l45.1064"></a><span id="l45.1064" class="difflineplus">+            }</span>
<a href="#l45.1065"></a><span id="l45.1065" class="difflineplus">+        }</span>
<a href="#l45.1066"></a><span id="l45.1066" class="difflineplus">+    }</span>
<a href="#l45.1067"></a><span id="l45.1067" class="difflineplus">+</span>
<a href="#l45.1068"></a><span id="l45.1068" class="difflineplus">+    // execute the timeline events, this will begin to diverge the current state</span>
<a href="#l45.1069"></a><span id="l45.1069" class="difflineplus">+    // if the timeline has any state events in it.</span>
<a href="#l45.1070"></a><span id="l45.1070" class="difflineplus">+    room.addLiveEvents(timelineEventList);</span>
<a href="#l45.1071"></a><span id="l45.1071" class="difflineplus">+};</span>
<a href="#l45.1072"></a><span id="l45.1072" class="difflineplus">+</span>
<a href="#l45.1073"></a><span id="l45.1073" class="difflineplus">+/**</span>
<a href="#l45.1074"></a><span id="l45.1074" class="difflineplus">+ * @return {string}</span>
<a href="#l45.1075"></a><span id="l45.1075" class="difflineplus">+ */</span>
<a href="#l45.1076"></a><span id="l45.1076" class="difflineplus">+SyncApi.prototype._getGuestFilter = function() {</span>
<a href="#l45.1077"></a><span id="l45.1077" class="difflineplus">+    var guestRooms = this.client._guestRooms; // FIXME: horrible gut-wrenching</span>
<a href="#l45.1078"></a><span id="l45.1078" class="difflineplus">+    if (!guestRooms) {</span>
<a href="#l45.1079"></a><span id="l45.1079" class="difflineplus">+        return &quot;{}&quot;;</span>
<a href="#l45.1080"></a><span id="l45.1080" class="difflineplus">+    }</span>
<a href="#l45.1081"></a><span id="l45.1081" class="difflineplus">+    // we just need to specify the filter inline if we're a guest because guests</span>
<a href="#l45.1082"></a><span id="l45.1082" class="difflineplus">+    // can't create filters.</span>
<a href="#l45.1083"></a><span id="l45.1083" class="difflineplus">+    return JSON.stringify({</span>
<a href="#l45.1084"></a><span id="l45.1084" class="difflineplus">+        room: {</span>
<a href="#l45.1085"></a><span id="l45.1085" class="difflineplus">+            timeline: {</span>
<a href="#l45.1086"></a><span id="l45.1086" class="difflineplus">+                limit: 20</span>
<a href="#l45.1087"></a><span id="l45.1087" class="difflineplus">+            }</span>
<a href="#l45.1088"></a><span id="l45.1088" class="difflineplus">+        }</span>
<a href="#l45.1089"></a><span id="l45.1089" class="difflineplus">+    });</span>
<a href="#l45.1090"></a><span id="l45.1090" class="difflineplus">+};</span>
<a href="#l45.1091"></a><span id="l45.1091" class="difflineplus">+</span>
<a href="#l45.1092"></a><span id="l45.1092" class="difflineplus">+/**</span>
<a href="#l45.1093"></a><span id="l45.1093" class="difflineplus">+ * Sets the sync state and emits an event to say so</span>
<a href="#l45.1094"></a><span id="l45.1094" class="difflineplus">+ * @param {String} newState The new state string</span>
<a href="#l45.1095"></a><span id="l45.1095" class="difflineplus">+ * @param {Object} data Object of additional data to emit in the event</span>
<a href="#l45.1096"></a><span id="l45.1096" class="difflineplus">+ */</span>
<a href="#l45.1097"></a><span id="l45.1097" class="difflineplus">+SyncApi.prototype._updateSyncState = function(newState, data) {</span>
<a href="#l45.1098"></a><span id="l45.1098" class="difflineplus">+    var old = this._syncState;</span>
<a href="#l45.1099"></a><span id="l45.1099" class="difflineplus">+    this._syncState = newState;</span>
<a href="#l45.1100"></a><span id="l45.1100" class="difflineplus">+    this.client.emit(&quot;sync&quot;, this._syncState, old, data);</span>
<a href="#l45.1101"></a><span id="l45.1101" class="difflineplus">+};</span>
<a href="#l45.1102"></a><span id="l45.1102" class="difflineplus">+</span>
<a href="#l45.1103"></a><span id="l45.1103" class="difflineplus">+/**</span>
<a href="#l45.1104"></a><span id="l45.1104" class="difflineplus">+ * Event handler for the 'online' event</span>
<a href="#l45.1105"></a><span id="l45.1105" class="difflineplus">+ * This event is generally unreliable and precise behaviour</span>
<a href="#l45.1106"></a><span id="l45.1106" class="difflineplus">+ * varies between browsers, so we poll for connectivity too,</span>
<a href="#l45.1107"></a><span id="l45.1107" class="difflineplus">+ * but this might help us reconnect a little faster.</span>
<a href="#l45.1108"></a><span id="l45.1108" class="difflineplus">+ */</span>
<a href="#l45.1109"></a><span id="l45.1109" class="difflineplus">+SyncApi.prototype._onOnline = function() {</span>
<a href="#l45.1110"></a><span id="l45.1110" class="difflineplus">+    debuglog(&quot;Browser thinks we are back online&quot;);</span>
<a href="#l45.1111"></a><span id="l45.1111" class="difflineplus">+    this._startKeepAlives(0);</span>
<a href="#l45.1112"></a><span id="l45.1112" class="difflineplus">+};</span>
<a href="#l45.1113"></a><span id="l45.1113" class="difflineplus">+</span>
<a href="#l45.1114"></a><span id="l45.1114" class="difflineplus">+function createNewUser(client, userId) {</span>
<a href="#l45.1115"></a><span id="l45.1115" class="difflineplus">+    var user = new User(userId);</span>
<a href="#l45.1116"></a><span id="l45.1116" class="difflineplus">+    reEmit(client, user, [</span>
<a href="#l45.1117"></a><span id="l45.1117" class="difflineplus">+        &quot;User.avatarUrl&quot;, &quot;User.displayName&quot;, &quot;User.presence&quot;,</span>
<a href="#l45.1118"></a><span id="l45.1118" class="difflineplus">+        &quot;User.currentlyActive&quot;, &quot;User.lastPresenceTs&quot;</span>
<a href="#l45.1119"></a><span id="l45.1119" class="difflineplus">+    ]);</span>
<a href="#l45.1120"></a><span id="l45.1120" class="difflineplus">+    return user;</span>
<a href="#l45.1121"></a><span id="l45.1121" class="difflineplus">+}</span>
<a href="#l45.1122"></a><span id="l45.1122" class="difflineplus">+</span>
<a href="#l45.1123"></a><span id="l45.1123" class="difflineplus">+function reEmit(reEmitEntity, emittableEntity, eventNames) {</span>
<a href="#l45.1124"></a><span id="l45.1124" class="difflineplus">+    utils.forEach(eventNames, function(eventName) {</span>
<a href="#l45.1125"></a><span id="l45.1125" class="difflineplus">+        // setup a listener on the entity (the Room, User, etc) for this event</span>
<a href="#l45.1126"></a><span id="l45.1126" class="difflineplus">+        emittableEntity.on(eventName, function() {</span>
<a href="#l45.1127"></a><span id="l45.1127" class="difflineplus">+            // take the args from the listener and reuse them, adding the</span>
<a href="#l45.1128"></a><span id="l45.1128" class="difflineplus">+            // event name to the arg list so it works with .emit()</span>
<a href="#l45.1129"></a><span id="l45.1129" class="difflineplus">+            // Transformation Example:</span>
<a href="#l45.1130"></a><span id="l45.1130" class="difflineplus">+            // listener on &quot;foo&quot; =&gt; function(a,b) { ... }</span>
<a href="#l45.1131"></a><span id="l45.1131" class="difflineplus">+            // Re-emit on &quot;thing&quot; =&gt; thing.emit(&quot;foo&quot;, a, b)</span>
<a href="#l45.1132"></a><span id="l45.1132" class="difflineplus">+            var newArgs = [eventName];</span>
<a href="#l45.1133"></a><span id="l45.1133" class="difflineplus">+            for (var i = 0; i &lt; arguments.length; i++) {</span>
<a href="#l45.1134"></a><span id="l45.1134" class="difflineplus">+                newArgs.push(arguments[i]);</span>
<a href="#l45.1135"></a><span id="l45.1135" class="difflineplus">+            }</span>
<a href="#l45.1136"></a><span id="l45.1136" class="difflineplus">+            reEmitEntity.emit.apply(reEmitEntity, newArgs);</span>
<a href="#l45.1137"></a><span id="l45.1137" class="difflineplus">+        });</span>
<a href="#l45.1138"></a><span id="l45.1138" class="difflineplus">+    });</span>
<a href="#l45.1139"></a><span id="l45.1139" class="difflineplus">+}</span>
<a href="#l45.1140"></a><span id="l45.1140" class="difflineplus">+</span>
<a href="#l45.1141"></a><span id="l45.1141" class="difflineplus">+/** */</span>
<a href="#l45.1142"></a><span id="l45.1142" class="difflineplus">+module.exports = SyncApi;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l46.1"></a><span id="l46.1">new file mode 100644</span>
<a href="#l46.2"></a><span id="l46.2" class="difflineminus">--- /dev/null</span>
<a href="#l46.3"></a><span id="l46.3" class="difflineplus">+++ b/chat/protocols/matrix/matrix-sdk/timeline-window.js</span>
<a href="#l46.4"></a><span id="l46.4" class="difflineat">@@ -0,0 +1,483 @@</span>
<a href="#l46.5"></a><span id="l46.5" class="difflineplus">+/*</span>
<a href="#l46.6"></a><span id="l46.6" class="difflineplus">+Copyright 2016 OpenMarket Ltd</span>
<a href="#l46.7"></a><span id="l46.7" class="difflineplus">+</span>
<a href="#l46.8"></a><span id="l46.8" class="difflineplus">+Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<a href="#l46.9"></a><span id="l46.9" class="difflineplus">+you may not use this file except in compliance with the License.</span>
<a href="#l46.10"></a><span id="l46.10" class="difflineplus">+You may obtain a copy of the License at</span>
<a href="#l46.11"></a><span id="l46.11" class="difflineplus">+</span>
<a href="#l46.12"></a><span id="l46.12" class="difflineplus">+    http://www.apache.org/licenses/LICENSE-2.0</span>
<a href="#l46.13"></a><span id="l46.13" class="difflineplus">+</span>
<a href="#l46.14"></a><span id="l46.14" class="difflineplus">+Unless required by applicable law or agreed to in writing, software</span>
<a href="#l46.15"></a><span id="l46.15" class="difflineplus">+distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<a href="#l46.16"></a><span id="l46.16" class="difflineplus">+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<a href="#l46.17"></a><span id="l46.17" class="difflineplus">+See the License for the specific language governing permissions and</span>
<a href="#l46.18"></a><span id="l46.18" class="difflineplus">+limitations under the License.</span>
<a href="#l46.19"></a><span id="l46.19" class="difflineplus">+*/</span>
<a href="#l46.20"></a><span id="l46.20" class="difflineplus">+&quot;use strict&quot;;</span>
<a href="#l46.21"></a><span id="l46.21" class="difflineplus">+</span>
<a href="#l46.22"></a><span id="l46.22" class="difflineplus">+/** @module timeline-window */</span>
<a href="#l46.23"></a><span id="l46.23" class="difflineplus">+</span>
<a href="#l46.24"></a><span id="l46.24" class="difflineplus">+var q = require(&quot;q&quot;);</span>
<a href="#l46.25"></a><span id="l46.25" class="difflineplus">+var EventTimeline = require(&quot;./models/event-timeline&quot;);</span>
<a href="#l46.26"></a><span id="l46.26" class="difflineplus">+</span>
<a href="#l46.27"></a><span id="l46.27" class="difflineplus">+/**</span>
<a href="#l46.28"></a><span id="l46.28" class="difflineplus">+ * @private</span>
<a href="#l46.29"></a><span id="l46.29" class="difflineplus">+ */</span>
<a href="#l46.30"></a><span id="l46.30" class="difflineplus">+var DEBUG = false;</span>
<a href="#l46.31"></a><span id="l46.31" class="difflineplus">+</span>
<a href="#l46.32"></a><span id="l46.32" class="difflineplus">+/**</span>
<a href="#l46.33"></a><span id="l46.33" class="difflineplus">+ * @private</span>
<a href="#l46.34"></a><span id="l46.34" class="difflineplus">+ */</span>
<a href="#l46.35"></a><span id="l46.35" class="difflineplus">+var debuglog = DEBUG ? console.log.bind(console) : function() {};</span>
<a href="#l46.36"></a><span id="l46.36" class="difflineplus">+</span>
<a href="#l46.37"></a><span id="l46.37" class="difflineplus">+/**</span>
<a href="#l46.38"></a><span id="l46.38" class="difflineplus">+ * the number of times we ask the server for more events before giving up</span>
<a href="#l46.39"></a><span id="l46.39" class="difflineplus">+ *</span>
<a href="#l46.40"></a><span id="l46.40" class="difflineplus">+ * @private</span>
<a href="#l46.41"></a><span id="l46.41" class="difflineplus">+ */</span>
<a href="#l46.42"></a><span id="l46.42" class="difflineplus">+var DEFAULT_PAGINATE_LOOP_LIMIT = 5;</span>
<a href="#l46.43"></a><span id="l46.43" class="difflineplus">+</span>
<a href="#l46.44"></a><span id="l46.44" class="difflineplus">+/**</span>
<a href="#l46.45"></a><span id="l46.45" class="difflineplus">+ * Construct a TimelineWindow.</span>
<a href="#l46.46"></a><span id="l46.46" class="difflineplus">+ *</span>
<a href="#l46.47"></a><span id="l46.47" class="difflineplus">+ * &lt;p&gt;This abstracts the separate timelines in a Matrix {@link</span>
<a href="#l46.48"></a><span id="l46.48" class="difflineplus">+ * module:models/room|Room} into a single iterable thing. It keeps track of</span>
<a href="#l46.49"></a><span id="l46.49" class="difflineplus">+ * the start and endpoints of the window, which can be advanced with the help</span>
<a href="#l46.50"></a><span id="l46.50" class="difflineplus">+ * of pagination requests.</span>
<a href="#l46.51"></a><span id="l46.51" class="difflineplus">+ *</span>
<a href="#l46.52"></a><span id="l46.52" class="difflineplus">+ * &lt;p&gt;Before the window is useful, it must be initialised by calling {@link</span>
<a href="#l46.53"></a><span id="l46.53" class="difflineplus">+ * module:timeline-window~TimelineWindow#load|load}.</span>
<a href="#l46.54"></a><span id="l46.54" class="difflineplus">+ *</span>
<a href="#l46.55"></a><span id="l46.55" class="difflineplus">+ * &lt;p&gt;Note that the window will not automatically extend itself when new events</span>
<a href="#l46.56"></a><span id="l46.56" class="difflineplus">+ * are received from /sync; you should arrange to call {@link</span>
<a href="#l46.57"></a><span id="l46.57" class="difflineplus">+ * module:timeline-window~TimelineWindow#paginate|paginate} on {@link</span>
<a href="#l46.58"></a><span id="l46.58" class="difflineplus">+ * module:client~MatrixClient.event:&quot;Room.timeline&quot;|Room.timeline} events.</span>
<a href="#l46.59"></a><span id="l46.59" class="difflineplus">+ *</span>
<a href="#l46.60"></a><span id="l46.60" class="difflineplus">+ * @param {MatrixClient} client   MatrixClient to be used for context/pagination</span>
<a href="#l46.61"></a><span id="l46.61" class="difflineplus">+ *   requests.</span>
<a href="#l46.62"></a><span id="l46.62" class="difflineplus">+ *</span>
<a href="#l46.63"></a><span id="l46.63" class="difflineplus">+ * @param {EventTimelineSet} timelineSet  The timelineSet to track</span>
<a href="#l46.64"></a><span id="l46.64" class="difflineplus">+ *</span>
<a href="#l46.65"></a><span id="l46.65" class="difflineplus">+ * @param {Object} [opts] Configuration options for this window</span>
<a href="#l46.66"></a><span id="l46.66" class="difflineplus">+ *</span>
<a href="#l46.67"></a><span id="l46.67" class="difflineplus">+ * @param {number} [opts.windowLimit = 1000] maximum number of events to keep</span>
<a href="#l46.68"></a><span id="l46.68" class="difflineplus">+ *    in the window. If more events are retrieved via pagination requests,</span>
<a href="#l46.69"></a><span id="l46.69" class="difflineplus">+ *    excess events will be dropped from the other end of the window.</span>
<a href="#l46.70"></a><span id="l46.70" class="difflineplus">+ *</span>
<a href="#l46.71"></a><span id="l46.71" class="difflineplus">+ * @constructor</span>
<a href="#l46.72"></a><span id="l46.72" class="difflineplus">+ */</span>
<a href="#l46.73"></a><span id="l46.73" class="difflineplus">+function TimelineWindow(client, timelineSet, opts) {</span>
<a href="#l46.74"></a><span id="l46.74" class="difflineplus">+    opts = opts || {};</span>
<a href="#l46.75"></a><span id="l46.75" class="difflineplus">+    this._client = client;</span>
<a href="#l46.76"></a><span id="l46.76" class="difflineplus">+    this._timelineSet = timelineSet;</span>
<a href="#l46.77"></a><span id="l46.77" class="difflineplus">+</span>
<a href="#l46.78"></a><span id="l46.78" class="difflineplus">+    // these will be TimelineIndex objects; they delineate the 'start' and</span>
<a href="#l46.79"></a><span id="l46.79" class="difflineplus">+    // 'end' of the window.</span>
<a href="#l46.80"></a><span id="l46.80" class="difflineplus">+    //</span>
<a href="#l46.81"></a><span id="l46.81" class="difflineplus">+    // _start.index is inclusive; _end.index is exclusive.</span>
<a href="#l46.82"></a><span id="l46.82" class="difflineplus">+    this._start = null;</span>
<a href="#l46.83"></a><span id="l46.83" class="difflineplus">+    this._end = null;</span>
<a href="#l46.84"></a><span id="l46.84" class="difflineplus">+</span>
<a href="#l46.85"></a><span id="l46.85" class="difflineplus">+    this._eventCount = 0;</span>
<a href="#l46.86"></a><span id="l46.86" class="difflineplus">+    this._windowLimit = opts.windowLimit || 1000;</span>
<a href="#l46.87"></a><span id="l46.87" class="difflineplus">+}</span>
<a href="#l46.88"></a><span id="l46.88" class="difflineplus">+</span>
<a href="#l46.89"></a><span id="l46.89" class="difflineplus">+/**</span>
<a href="#l46.90"></a><span id="l46.90" class="difflineplus">+ * Initialise the window to point at a given event, or the live timeline</span>
<a href="#l46.91"></a><span id="l46.91" class="difflineplus">+ *</span>
<a href="#l46.92"></a><span id="l46.92" class="difflineplus">+ * @param {string} [initialEventId]   If given, the window will contain the</span>
<a href="#l46.93"></a><span id="l46.93" class="difflineplus">+ *    given event</span>
<a href="#l46.94"></a><span id="l46.94" class="difflineplus">+ * @param {number} [initialWindowSize = 20]   Size of the initial window</span>
<a href="#l46.95"></a><span id="l46.95" class="difflineplus">+ *</span>
<a href="#l46.96"></a><span id="l46.96" class="difflineplus">+ * @return {module:client.Promise}</span>
<a href="#l46.97"></a><span id="l46.97" class="difflineplus">+ */</span>
<a href="#l46.98"></a><span id="l46.98" class="difflineplus">+TimelineWindow.prototype.load = function(initialEventId, initialWindowSize) {</span>
<a href="#l46.99"></a><span id="l46.99" class="difflineplus">+    var self = this;</span>
<a href="#l46.100"></a><span id="l46.100" class="difflineplus">+    initialWindowSize = initialWindowSize || 20;</span>
<a href="#l46.101"></a><span id="l46.101" class="difflineplus">+</span>
<a href="#l46.102"></a><span id="l46.102" class="difflineplus">+    // given an EventTimeline, and an event index within it, initialise our</span>
<a href="#l46.103"></a><span id="l46.103" class="difflineplus">+    // fields so that the event in question is in the middle of the window.</span>
<a href="#l46.104"></a><span id="l46.104" class="difflineplus">+    var initFields = function(timeline, eventIndex) {</span>
<a href="#l46.105"></a><span id="l46.105" class="difflineplus">+        var endIndex = Math.min(timeline.getEvents().length,</span>
<a href="#l46.106"></a><span id="l46.106" class="difflineplus">+                                eventIndex + Math.ceil(initialWindowSize / 2));</span>
<a href="#l46.107"></a><span id="l46.107" class="difflineplus">+        var startIndex = Math.max(0, endIndex - initialWindowSize);</span>
<a href="#l46.108"></a><span id="l46.108" class="difflineplus">+        self._start = new TimelineIndex(timeline, startIndex - timeline.getBaseIndex());</span>
<a href="#l46.109"></a><span id="l46.109" class="difflineplus">+        self._end = new TimelineIndex(timeline, endIndex - timeline.getBaseIndex());</span>
<a href="#l46.110"></a><span id="l46.110" class="difflineplus">+        self._eventCount = endIndex - startIndex;</span>
<a href="#l46.111"></a><span id="l46.111" class="difflineplus">+    };</span>
<a href="#l46.112"></a><span id="l46.112" class="difflineplus">+</span>
<a href="#l46.113"></a><span id="l46.113" class="difflineplus">+    // We avoid delaying the resolution of the promise by a reactor tick if</span>
<a href="#l46.114"></a><span id="l46.114" class="difflineplus">+    // we already have the data we need, which is important to keep room-switching</span>
<a href="#l46.115"></a><span id="l46.115" class="difflineplus">+    // feeling snappy.</span>
<a href="#l46.116"></a><span id="l46.116" class="difflineplus">+    //</span>
<a href="#l46.117"></a><span id="l46.117" class="difflineplus">+    // TODO: ideally we'd spot getEventTimeline returning a resolved promise and</span>
<a href="#l46.118"></a><span id="l46.118" class="difflineplus">+    // skip straight to the find-event loop.</span>
<a href="#l46.119"></a><span id="l46.119" class="difflineplus">+    if (initialEventId) {</span>
<a href="#l46.120"></a><span id="l46.120" class="difflineplus">+        return this._client.getEventTimeline(this._timelineSet, initialEventId)</span>
<a href="#l46.121"></a><span id="l46.121" class="difflineplus">+            .then(function(tl) {</span>
<a href="#l46.122"></a><span id="l46.122" class="difflineplus">+                // make sure that our window includes the event</span>
<a href="#l46.123"></a><span id="l46.123" class="difflineplus">+                for (var i = 0; i &lt; tl.getEvents().length; i++) {</span>
<a href="#l46.124"></a><span id="l46.124" class="difflineplus">+                    if (tl.getEvents()[i].getId() == initialEventId) {</span>
<a href="#l46.125"></a><span id="l46.125" class="difflineplus">+                        initFields(tl, i);</span>
<a href="#l46.126"></a><span id="l46.126" class="difflineplus">+                        return;</span>
<a href="#l46.127"></a><span id="l46.127" class="difflineplus">+                    }</span>
<a href="#l46.128"></a><span id="l46.128" class="difflineplus">+                }</span>
<a href="#l46.129"></a><span id="l46.129" class="difflineplus">+                throw new Error(&quot;getEventTimeline result didn't include requested event&quot;);</span>
<a href="#l46.130"></a><span id="l46.130" class="difflineplus">+            });</span>
<a href="#l46.131"></a><span id="l46.131" class="difflineplus">+    } else {</span>
<a href="#l46.132"></a><span id="l46.132" class="difflineplus">+        // start with the most recent events</span>
<a href="#l46.133"></a><span id="l46.133" class="difflineplus">+        var tl = this._timelineSet.getLiveTimeline();</span>
<a href="#l46.134"></a><span id="l46.134" class="difflineplus">+        initFields(tl, tl.getEvents().length);</span>
<a href="#l46.135"></a><span id="l46.135" class="difflineplus">+        return q();</span>
<a href="#l46.136"></a><span id="l46.136" class="difflineplus">+    }</span>
<a href="#l46.137"></a><span id="l46.137" class="difflineplus">+};</span>
<a href="#l46.138"></a><span id="l46.138" class="difflineplus">+</span>
<a href="#l46.139"></a><span id="l46.139" class="difflineplus">+/**</span>
<a href="#l46.140"></a><span id="l46.140" class="difflineplus">+ * Check if this window can be extended</span>
<a href="#l46.141"></a><span id="l46.141" class="difflineplus">+ *</span>
<a href="#l46.142"></a><span id="l46.142" class="difflineplus">+ * &lt;p&gt;This returns true if we either have more events, or if we have a</span>
<a href="#l46.143"></a><span id="l46.143" class="difflineplus">+ * pagination token which means we can paginate in that direction. It does not</span>
<a href="#l46.144"></a><span id="l46.144" class="difflineplus">+ * necessarily mean that there are more events available in that direction at</span>
<a href="#l46.145"></a><span id="l46.145" class="difflineplus">+ * this time.</span>
<a href="#l46.146"></a><span id="l46.146" class="difflineplus">+ *</span>
<a href="#l46.147"></a><span id="l46.147" class="difflineplus">+ * @param {string} direction   EventTimeline.BACKWARDS to check if we can</span>
<a href="#l46.148"></a><span id="l46.148" class="difflineplus">+ *   paginate backwards; EventTimeline.FORWARDS to check if we can go forwards</span>
<a href="#l46.149"></a><span id="l46.149" class="difflineplus">+ *</span>
<a href="#l46.150"></a><span id="l46.150" class="difflineplus">+ * @return {boolean} true if we can paginate in the given direction</span>
<a href="#l46.151"></a><span id="l46.151" class="difflineplus">+ */</span>
<a href="#l46.152"></a><span id="l46.152" class="difflineplus">+TimelineWindow.prototype.canPaginate = function(direction) {</span>
<a href="#l46.153"></a><span id="l46.153" class="difflineplus">+    var tl;</span>
<a href="#l46.154"></a><span id="l46.154" class="difflineplus">+    if (direction == EventTimeline.BACKWARDS) {</span>
<a href="#l46.155"></a><span id="l46.155" class="difflineplus">+        tl = this._start;</span>
<a href="#l46.156"></a><span id="l46.156" class="difflineplus">+    } else if (direction == EventTimeline.FORWARDS) {</span>
<a href="#l46.157"></a><span id="l46.157" class="difflineplus">+        tl = this._end;</span>
<a href="#l46.158"></a><span id="l46.158" class="difflineplus">+    } else {</span>
<a href="#l46.159"></a><span id="l46.159" class="difflineplus">+        throw new Error(&quot;Invalid direction '&quot; + direction + &quot;'&quot;);</span>
<a href="#l46.160"></a><span id="l46.160" class="difflineplus">+    }</span>
<a href="#l46.161"></a><span id="l46.161" class="difflineplus">+</span>
<a href="#l46.162"></a><span id="l46.162" class="difflineplus">+    if (!tl) {</span>
<a href="#l46.163"></a><span id="l46.163" class="difflineplus">+        debuglog(&quot;TimelineWindow: no timeline yet&quot;);</span>
<a href="#l46.164"></a><span id="l46.164" class="difflineplus">+        return false;</span>
<a href="#l46.165"></a><span id="l46.165" class="difflineplus">+    }</span>
<a href="#l46.166"></a><span id="l46.166" class="difflineplus">+</span>
<a href="#l46.167"></a><span id="l46.167" class="difflineplus">+    if (direction == EventTimeline.BACKWARDS) {</span>
<a href="#l46.168"></a><span id="l46.168" class="difflineplus">+        if (tl.index &gt; tl.minIndex()) { return true; }</span>
<a href="#l46.169"></a><span id="l46.169" class="difflineplus">+    } else {</span>
<a href="#l46.170"></a><span id="l46.170" class="difflineplus">+        if (tl.index &lt; tl.maxIndex()) { return true; }</span>
<a href="#l46.171"></a><span id="l46.171" class="difflineplus">+    }</span>
<a href="#l46.172"></a><span id="l46.172" class="difflineplus">+</span>
<a href="#l46.173"></a><span id="l46.173" class="difflineplus">+    return Boolean(tl.timeline.getNeighbouringTimeline(direction) ||</span>
<a href="#l46.174"></a><span id="l46.174" class="difflineplus">+                   tl.timeline.getPaginationToken(direction));</span>
<a href="#l46.175"></a><span id="l46.175" class="difflineplus">+};</span>
<a href="#l46.176"></a><span id="l46.176" class="difflineplus">+</span>
<a href="#l46.177"></a><span id="l46.177" class="difflineplus">+/**</span>
<a href="#l46.178"></a><span id="l46.178" class="difflineplus">+ * Attempt to extend the window</span>
<a href="#l46.179"></a><span id="l46.179" class="difflineplus">+ *</span>
<a href="#l46.180"></a><span id="l46.180" class="difflineplus">+ * @param {string} direction   EventTimeline.BACKWARDS to extend the window</span>
<a href="#l46.181"></a><span id="l46.181" class="difflineplus">+ *    backwards (towards older events); EventTimeline.FORWARDS to go forwards.</span>
<a href="#l46.182"></a><span id="l46.182" class="difflineplus">+ *</span>
<a href="#l46.183"></a><span id="l46.183" class="difflineplus">+ * @param {number} size   number of events to try to extend by. If fewer than this</span>
<a href="#l46.184"></a><span id="l46.184" class="difflineplus">+ *    number are immediately available, then we return immediately rather than</span>
<a href="#l46.185"></a><span id="l46.185" class="difflineplus">+ *    making an API call.</span>
<a href="#l46.186"></a><span id="l46.186" class="difflineplus">+ *</span>
<a href="#l46.187"></a><span id="l46.187" class="difflineplus">+ * @param {boolean} [makeRequest = true] whether we should make API calls to</span>
<a href="#l46.188"></a><span id="l46.188" class="difflineplus">+ *    fetch further events if we don't have any at all. (This has no effect if</span>
<a href="#l46.189"></a><span id="l46.189" class="difflineplus">+ *    the room already knows about additional events in the relevant direction,</span>
<a href="#l46.190"></a><span id="l46.190" class="difflineplus">+ *    even if there are fewer than 'size' of them, as we will just return those</span>
<a href="#l46.191"></a><span id="l46.191" class="difflineplus">+ *    we already know about.)</span>
<a href="#l46.192"></a><span id="l46.192" class="difflineplus">+ *</span>
<a href="#l46.193"></a><span id="l46.193" class="difflineplus">+ * @param {number} [requestLimit = 5] limit for the number of API requests we</span>
<a href="#l46.194"></a><span id="l46.194" class="difflineplus">+ *    should make.</span>
<a href="#l46.195"></a><span id="l46.195" class="difflineplus">+ *</span>
<a href="#l46.196"></a><span id="l46.196" class="difflineplus">+ * @return {module:client.Promise} Resolves to a boolean which is true if more events</span>
<a href="#l46.197"></a><span id="l46.197" class="difflineplus">+ *    were successfully retrieved.</span>
<a href="#l46.198"></a><span id="l46.198" class="difflineplus">+ */</span>
<a href="#l46.199"></a><span id="l46.199" class="difflineplus">+TimelineWindow.prototype.paginate = function(direction, size, makeRequest,</span>
<a href="#l46.200"></a><span id="l46.200" class="difflineplus">+                                             requestLimit) {</span>
<a href="#l46.201"></a><span id="l46.201" class="difflineplus">+    // Either wind back the message cap (if there are enough events in the</span>
<a href="#l46.202"></a><span id="l46.202" class="difflineplus">+    // timeline to do so), or fire off a pagination request.</span>
<a href="#l46.203"></a><span id="l46.203" class="difflineplus">+</span>
<a href="#l46.204"></a><span id="l46.204" class="difflineplus">+    if (makeRequest === undefined) {</span>
<a href="#l46.205"></a><span id="l46.205" class="difflineplus">+        makeRequest = true;</span>
<a href="#l46.206"></a><span id="l46.206" class="difflineplus">+    }</span>
<a href="#l46.207"></a><span id="l46.207" class="difflineplus">+</span>
<a href="#l46.208"></a><span id="l46.208" class="difflineplus">+    if (requestLimit === undefined) {</span>
<a href="#l46.209"></a><span id="l46.209" class="difflineplus">+        requestLimit = DEFAULT_PAGINATE_LOOP_LIMIT;</span>
<a href="#l46.210"></a><span id="l46.210" class="difflineplus">+    }</span>
<a href="#l46.211"></a><span id="l46.211" class="difflineplus">+</span>
<a href="#l46.212"></a><span id="l46.212" class="difflineplus">+    var tl;</span>
<a href="#l46.213"></a><span id="l46.213" class="difflineplus">+    if (direction == EventTimeline.BACKWARDS) {</span>
<a href="#l46.214"></a><span id="l46.214" class="difflineplus">+        tl = this._start;</span>
<a href="#l46.215"></a><span id="l46.215" class="difflineplus">+    } else if (direction == EventTimeline.FORWARDS) {</span>
<a href="#l46.216"></a><span id="l46.216" class="difflineplus">+        tl = this._end;</span>
<a href="#l46.217"></a><span id="l46.217" class="difflineplus">+    } else {</span>
<a href="#l46.218"></a><span id="l46.218" class="difflineplus">+        throw new Error(&quot;Invalid direction '&quot; + direction + &quot;'&quot;);</span>
<a href="#l46.219"></a><span id="l46.219" class="difflineplus">+    }</span>
<a href="#l46.220"></a><span id="l46.220" class="difflineplus">+</span>
<a href="#l46.221"></a><span id="l46.221" class="difflineplus">+    if (!tl) {</span>
<a href="#l46.222"></a><span id="l46.222" class="difflineplus">+        debuglog(&quot;TimelineWindow: no timeline yet&quot;);</span>
<a href="#l46.223"></a><span id="l46.223" class="difflineplus">+        return q(false);</span>
<a href="#l46.224"></a><span id="l46.224" class="difflineplus">+    }</span>
<a href="#l46.225"></a><span id="l46.225" class="difflineplus">+</span>
<a href="#l46.226"></a><span id="l46.226" class="difflineplus">+    if (tl.pendingPaginate) {</span>
<a href="#l46.227"></a><span id="l46.227" class="difflineplus">+        return tl.pendingPaginate;</span>
<a href="#l46.228"></a><span id="l46.228" class="difflineplus">+    }</span>
<a href="#l46.229"></a><span id="l46.229" class="difflineplus">+</span>
<a href="#l46.230"></a><span id="l46.230" class="difflineplus">+    // try moving the cap</span>
<a href="#l46.231"></a><span id="l46.231" class="difflineplus">+    var count = (direction == EventTimeline.BACKWARDS) ?</span>
<a href="#l46.232"></a><span id="l46.232" class="difflineplus">+        tl.retreat(size) : tl.advance(size);</span>
<a href="#l46.233"></a><span id="l46.233" class="difflineplus">+</span>
<a href="#l46.234"></a><span id="l46.234" class="difflineplus">+    if (count) {</span>
<a href="#l46.235"></a><span id="l46.235" class="difflineplus">+        this._eventCount += count;</span>
<a href="#l46.236"></a><span id="l46.236" class="difflineplus">+        debuglog(&quot;TimelineWindow: increased cap by &quot; + count +</span>
<a href="#l46.237"></a><span id="l46.237" class="difflineplus">+                 &quot; (now &quot; + this._eventCount + &quot;)&quot;);</span>
<a href="#l46.238"></a><span id="l46.238" class="difflineplus">+        // remove some events from the other end, if necessary</span>
<a href="#l46.239"></a><span id="l46.239" class="difflineplus">+        var excess = this._eventCount - this._windowLimit;</span>
<a href="#l46.240"></a><span id="l46.240" class="difflineplus">+        if (excess &gt; 0) {</span>
<a href="#l46.241"></a><span id="l46.241" class="difflineplus">+            this.unpaginate(excess, direction != EventTimeline.BACKWARDS);</span>
<a href="#l46.242"></a><span id="l46.242" class="difflineplus">+        }</span>
<a href="#l46.243"></a><span id="l46.243" class="difflineplus">+        return q(true);</span>
<a href="#l46.244"></a><span id="l46.244" class="difflineplus">+    }</span>
<a href="#l46.245"></a><span id="l46.245" class="difflineplus">+</span>
<a href="#l46.246"></a><span id="l46.246" class="difflineplus">+    if (!makeRequest || requestLimit === 0) {</span>
<a href="#l46.247"></a><span id="l46.247" class="difflineplus">+        // todo: should we return something different to indicate that there</span>
<a href="#l46.248"></a><span id="l46.248" class="difflineplus">+        // might be more events out there, but we haven't found them yet?</span>
<a href="#l46.249"></a><span id="l46.249" class="difflineplus">+        return q(false);</span>
<a href="#l46.250"></a><span id="l46.250" class="difflineplus">+    }</span>
<a href="#l46.251"></a><span id="l46.251" class="difflineplus">+</span>
<a href="#l46.252"></a><span id="l46.252" class="difflineplus">+    // try making a pagination request</span>
<a href="#l46.253"></a><span id="l46.253" class="difflineplus">+    var token = tl.timeline.getPaginationToken(direction);</span>
<a href="#l46.254"></a><span id="l46.254" class="difflineplus">+    if (!token) {</span>
<a href="#l46.255"></a><span id="l46.255" class="difflineplus">+        debuglog(&quot;TimelineWindow: no token&quot;);</span>
<a href="#l46.256"></a><span id="l46.256" class="difflineplus">+        return q(false);</span>
<a href="#l46.257"></a><span id="l46.257" class="difflineplus">+    }</span>
<a href="#l46.258"></a><span id="l46.258" class="difflineplus">+</span>
<a href="#l46.259"></a><span id="l46.259" class="difflineplus">+    debuglog(&quot;TimelineWindow: starting request&quot;);</span>
<a href="#l46.260"></a><span id="l46.260" class="difflineplus">+    var self = this;</span>
<a href="#l46.261"></a><span id="l46.261" class="difflineplus">+</span>
<a href="#l46.262"></a><span id="l46.262" class="difflineplus">+    var prom = this._client.paginateEventTimeline(tl.timeline, {</span>
<a href="#l46.263"></a><span id="l46.263" class="difflineplus">+        backwards: direction == EventTimeline.BACKWARDS,</span>
<a href="#l46.264"></a><span id="l46.264" class="difflineplus">+        limit: size</span>
<a href="#l46.265"></a><span id="l46.265" class="difflineplus">+    }).finally(function() {</span>
<a href="#l46.266"></a><span id="l46.266" class="difflineplus">+        tl.pendingPaginate = null;</span>
<a href="#l46.267"></a><span id="l46.267" class="difflineplus">+    }).then(function(r) {</span>
<a href="#l46.268"></a><span id="l46.268" class="difflineplus">+        debuglog(&quot;TimelineWindow: request completed with result &quot; + r);</span>
<a href="#l46.269"></a><span id="l46.269" class="difflineplus">+        if (!r) {</span>
<a href="#l46.270"></a><span id="l46.270" class="difflineplus">+            // end of timeline</span>
<a href="#l46.271"></a><span id="l46.271" class="difflineplus">+            return false;</span>
<a href="#l46.272"></a><span id="l46.272" class="difflineplus">+        }</span>
<a href="#l46.273"></a><span id="l46.273" class="difflineplus">+</span>
<a href="#l46.274"></a><span id="l46.274" class="difflineplus">+        // recurse to advance the index into the results.</span>
<a href="#l46.275"></a><span id="l46.275" class="difflineplus">+        //</span>
<a href="#l46.276"></a><span id="l46.276" class="difflineplus">+        // If we don't get any new events, we want to make sure we keep asking</span>
<a href="#l46.277"></a><span id="l46.277" class="difflineplus">+        // the server for events for as long as we have a valid pagination</span>
<a href="#l46.278"></a><span id="l46.278" class="difflineplus">+        // token. In particular, we want to know if we've actually hit the</span>
<a href="#l46.279"></a><span id="l46.279" class="difflineplus">+        // start of the timeline, or if we just happened to know about all of</span>
<a href="#l46.280"></a><span id="l46.280" class="difflineplus">+        // the events thanks to https://matrix.org/jira/browse/SYN-645.</span>
<a href="#l46.281"></a><span id="l46.281" class="difflineplus">+        //</span>
<a href="#l46.282"></a><span id="l46.282" class="difflineplus">+        // On the other hand, we necessarily want to wait forever for the</span>
<a href="#l46.283"></a><span id="l46.283" class="difflineplus">+        // server to make its mind up about whether there are other events,</span>
<a href="#l46.284"></a><span id="l46.284" class="difflineplus">+        // because it gives a bad user experience</span>
<a href="#l46.285"></a><span id="l46.285" class="difflineplus">+        // (https://github.com/vector-im/vector-web/issues/1204).</span>
<a href="#l46.286"></a><span id="l46.286" class="difflineplus">+        return self.paginate(direction, size, true, requestLimit - 1);</span>
<a href="#l46.287"></a><span id="l46.287" class="difflineplus">+    });</span>
<a href="#l46.288"></a><span id="l46.288" class="difflineplus">+    tl.pendingPaginate = prom;</span>
<a href="#l46.289"></a><span id="l46.289" class="difflineplus">+    return prom;</span>
<a href="#l46.290"></a><span id="l46.290" class="difflineplus">+};</span>
<a href="#l46.291"></a><span id="l46.291" class="difflineplus">+</span>
<a href="#l46.292"></a><span id="l46.292" class="difflineplus">+</span>
<a href="#l46.293"></a><span id="l46.293" class="difflineplus">+/**</span>
<a href="#l46.294"></a><span id="l46.294" class="difflineplus">+ * Remove `delta` events from the start or end of the timeline.</span>
<a href="#l46.295"></a><span id="l46.295" class="difflineplus">+ *</span>
<a href="#l46.296"></a><span id="l46.296" class="difflineplus">+ * @param {number}  delta           number of events to remove from the timeline</span>
<a href="#l46.297"></a><span id="l46.297" class="difflineplus">+ * @param {boolean} startOfTimeline if events should be removed from the start</span>
<a href="#l46.298"></a><span id="l46.298" class="difflineplus">+ *     of the timeline.</span>
<a href="#l46.299"></a><span id="l46.299" class="difflineplus">+ */</span>
<a href="#l46.300"></a><span id="l46.300" class="difflineplus">+TimelineWindow.prototype.unpaginate = function(delta, startOfTimeline) {</span>
<a href="#l46.301"></a><span id="l46.301" class="difflineplus">+    var tl = startOfTimeline ? this._start : this._end;</span>
<a href="#l46.302"></a><span id="l46.302" class="difflineplus">+</span>
<a href="#l46.303"></a><span id="l46.303" class="difflineplus">+    // sanity-check the delta</span>
<a href="#l46.304"></a><span id="l46.304" class="difflineplus">+    if (delta &gt; this._eventCount || delta &lt; 0) {</span>
<a href="#l46.305"></a><span id="l46.305" class="difflineplus">+        throw new Error(&quot;Attemting to unpaginate &quot; + delta + &quot; events, but &quot; +</span>
<a href="#l46.306"></a><span id="l46.306" class="difflineplus">+                        &quot;only have &quot; + this._eventCount + &quot; in the timeline&quot;);</span>
<a href="#l46.307"></a><span id="l46.307" class="difflineplus">+    }</span>
<a href="#l46.308"></a><span id="l46.308" class="difflineplus">+</span>
<a href="#l46.309"></a><span id="l46.309" class="difflineplus">+    while (delta &gt; 0) {</span>
<a href="#l46.310"></a><span id="l46.310" class="difflineplus">+        var count = startOfTimeline ? tl.advance(delta) : tl.retreat(delta);</span>
<a href="#l46.311"></a><span id="l46.311" class="difflineplus">+        if (count &lt;= 0) {</span>
<a href="#l46.312"></a><span id="l46.312" class="difflineplus">+            // sadness. This shouldn't be possible.</span>
<a href="#l46.313"></a><span id="l46.313" class="difflineplus">+            throw new Error(</span>
<a href="#l46.314"></a><span id="l46.314" class="difflineplus">+                &quot;Unable to unpaginate any further, but still have &quot; +</span>
<a href="#l46.315"></a><span id="l46.315" class="difflineplus">+                    this._eventCount + &quot; events&quot;);</span>
<a href="#l46.316"></a><span id="l46.316" class="difflineplus">+        }</span>
<a href="#l46.317"></a><span id="l46.317" class="difflineplus">+</span>
<a href="#l46.318"></a><span id="l46.318" class="difflineplus">+        delta -= count;</span>
<a href="#l46.319"></a><span id="l46.319" class="difflineplus">+        this._eventCount -= count;</span>
<a href="#l46.320"></a><span id="l46.320" class="difflineplus">+        debuglog(&quot;TimelineWindow.unpaginate: dropped &quot; + count +</span>
<a href="#l46.321"></a><span id="l46.321" class="difflineplus">+                 &quot; (now &quot; + this._eventCount + &quot;)&quot;);</span>
<a href="#l46.322"></a><span id="l46.322" class="difflineplus">+    }</span>
<a href="#l46.323"></a><span id="l46.323" class="difflineplus">+};</span>
<a href="#l46.324"></a><span id="l46.324" class="difflineplus">+</span>
<a href="#l46.325"></a><span id="l46.325" class="difflineplus">+</span>
<a href="#l46.326"></a><span id="l46.326" class="difflineplus">+/**</span>
<a href="#l46.327"></a><span id="l46.327" class="difflineplus">+ * Get a list of the events currently in the window</span>
<a href="#l46.328"></a><span id="l46.328" class="difflineplus">+ *</span>
<a href="#l46.329"></a><span id="l46.329" class="difflineplus">+ * @return {MatrixEvent[]} the events in the window</span>
<a href="#l46.330"></a><span id="l46.330" class="difflineplus">+ */</span>
<a href="#l46.331"></a><span id="l46.331" class="difflineplus">+TimelineWindow.prototype.getEvents = function() {</span>
<a href="#l46.332"></a><span id="l46.332" class="difflineplus">+    if (!this._start) {</span>
<a href="#l46.333"></a><span id="l46.333" class="difflineplus">+        // not yet loaded</span>
<a href="#l46.334"></a><span id="l46.334" class="difflineplus">+        return [];</span>
<a href="#l46.335"></a><span id="l46.335" class="difflineplus">+    }</span>
<a href="#l46.336"></a><span id="l46.336" class="difflineplus">+</span>
<a href="#l46.337"></a><span id="l46.337" class="difflineplus">+    var result = [];</span>
<a href="#l46.338"></a><span id="l46.338" class="difflineplus">+</span>
<a href="#l46.339"></a><span id="l46.339" class="difflineplus">+    // iterate through each timeline between this._start and this._end</span>
<a href="#l46.340"></a><span id="l46.340" class="difflineplus">+    // (inclusive).</span>
<a href="#l46.341"></a><span id="l46.341" class="difflineplus">+    var timeline = this._start.timeline;</span>
<a href="#l46.342"></a><span id="l46.342" class="difflineplus">+    while (true) {</span>
<a href="#l46.343"></a><span id="l46.343" class="difflineplus">+        var events = timeline.getEvents();</span>
<a href="#l46.344"></a><span id="l46.344" class="difflineplus">+</span>
<a href="#l46.345"></a><span id="l46.345" class="difflineplus">+        // For the first timeline in the chain, we want to start at</span>
<a href="#l46.346"></a><span id="l46.346" class="difflineplus">+        // this._start.index. For the last timeline in the chain, we want to</span>
<a href="#l46.347"></a><span id="l46.347" class="difflineplus">+        // stop before this._end.index. Otherwise, we want to copy all of the</span>
<a href="#l46.348"></a><span id="l46.348" class="difflineplus">+        // events in the timeline.</span>
<a href="#l46.349"></a><span id="l46.349" class="difflineplus">+        //</span>
<a href="#l46.350"></a><span id="l46.350" class="difflineplus">+        // (Note that both this._start.index and this._end.index are relative</span>
<a href="#l46.351"></a><span id="l46.351" class="difflineplus">+        // to their respective timelines' BaseIndex).</span>
<a href="#l46.352"></a><span id="l46.352" class="difflineplus">+        //</span>
<a href="#l46.353"></a><span id="l46.353" class="difflineplus">+        var startIndex = 0, endIndex = events.length;</span>
<a href="#l46.354"></a><span id="l46.354" class="difflineplus">+        if (timeline === this._start.timeline) {</span>
<a href="#l46.355"></a><span id="l46.355" class="difflineplus">+            startIndex = this._start.index + timeline.getBaseIndex();</span>
<a href="#l46.356"></a><span id="l46.356" class="difflineplus">+        }</span>
<a href="#l46.357"></a><span id="l46.357" class="difflineplus">+        if (timeline === this._end.timeline) {</span>
<a href="#l46.358"></a><span id="l46.358" class="difflineplus">+            endIndex = this._end.index + timeline.getBaseIndex();</span>
<a href="#l46.359"></a><span id="l46.359" class="difflineplus">+        }</span>
<a href="#l46.360"></a><span id="l46.360" class="difflineplus">+</span>
<a href="#l46.361"></a><span id="l46.361" class="difflineplus">+        for (var i = startIndex; i &lt; endIndex; i++) {</span>
<a href="#l46.362"></a><span id="l46.362" class="difflineplus">+            result.push(events[i]);</span>
<a href="#l46.363"></a><span id="l46.363" class="difflineplus">+        }</span>
<a href="#l46.364"></a><span id="l46.364" class="difflineplus">+</span>
<a href="#l46.365"></a><span id="l46.365" class="difflineplus">+        // if we're not done, iterate to the next timeline.</span>
<a href="#l46.366"></a><span id="l46.366" class="difflineplus">+        if (timeline === this._end.timeline) {</span>
<a href="#l46.367"></a><span id="l46.367" class="difflineplus">+            break;</span>
<a href="#l46.368"></a><span id="l46.368" class="difflineplus">+        } else {</span>
<a href="#l46.369"></a><span id="l46.369" class="difflineplus">+            timeline = timeline.getNeighbouringTimeline(EventTimeline.FORWARDS);</span>
<a href="#l46.370"></a><span id="l46.370" class="difflineplus">+        }</span>
<a href="#l46.371"></a><span id="l46.371" class="difflineplus">+    }</span>
<a href="#l46.372"></a><span id="l46.372" class="difflineplus">+</span>
<a href="#l46.373"></a><span id="l46.373" class="difflineplus">+    return result;</span>
<a href="#l46.374"></a><span id="l46.374" class="difflineplus">+};</span>
<a href="#l46.375"></a><span id="l46.375" class="difflineplus">+</span>
<a href="#l46.376"></a><span id="l46.376" class="difflineplus">+</span>
<a href="#l46.377"></a><span id="l46.377" class="difflineplus">+/**</span>
<a href="#l46.378"></a><span id="l46.378" class="difflineplus">+ * a thing which contains a timeline reference, and an index into it.</span>
<a href="#l46.379"></a><span id="l46.379" class="difflineplus">+ *</span>
<a href="#l46.380"></a><span id="l46.380" class="difflineplus">+ * @constructor</span>
<a href="#l46.381"></a><span id="l46.381" class="difflineplus">+ * @param {EventTimeline} timeline</span>
<a href="#l46.382"></a><span id="l46.382" class="difflineplus">+ * @param {number} index</span>
<a href="#l46.383"></a><span id="l46.383" class="difflineplus">+ * @private</span>
<a href="#l46.384"></a><span id="l46.384" class="difflineplus">+ */</span>
<a href="#l46.385"></a><span id="l46.385" class="difflineplus">+function TimelineIndex(timeline, index) {</span>
<a href="#l46.386"></a><span id="l46.386" class="difflineplus">+    this.timeline = timeline;</span>
<a href="#l46.387"></a><span id="l46.387" class="difflineplus">+</span>
<a href="#l46.388"></a><span id="l46.388" class="difflineplus">+    // the indexes are relative to BaseIndex, so could well be negative.</span>
<a href="#l46.389"></a><span id="l46.389" class="difflineplus">+    this.index = index;</span>
<a href="#l46.390"></a><span id="l46.390" class="difflineplus">+}</span>
<a href="#l46.391"></a><span id="l46.391" class="difflineplus">+</span>
<a href="#l46.392"></a><span id="l46.392" class="difflineplus">+/**</span>
<a href="#l46.393"></a><span id="l46.393" class="difflineplus">+ * @return {number} the minimum possible value for the index in the current</span>
<a href="#l46.394"></a><span id="l46.394" class="difflineplus">+ *    timeline</span>
<a href="#l46.395"></a><span id="l46.395" class="difflineplus">+ */</span>
<a href="#l46.396"></a><span id="l46.396" class="difflineplus">+TimelineIndex.prototype.minIndex = function() {</span>
<a href="#l46.397"></a><span id="l46.397" class="difflineplus">+    return this.timeline.getBaseIndex() * -1;</span>
<a href="#l46.398"></a><span id="l46.398" class="difflineplus">+};</span>
<a href="#l46.399"></a><span id="l46.399" class="difflineplus">+</span>
<a href="#l46.400"></a><span id="l46.400" class="difflineplus">+/**</span>
<a href="#l46.401"></a><span id="l46.401" class="difflineplus">+ * @return {number} the maximum possible value for the index in the current</span>
<a href="#l46.402"></a><span id="l46.402" class="difflineplus">+ *    timeline (exclusive - ie, it actually returns one more than the index</span>
<a href="#l46.403"></a><span id="l46.403" class="difflineplus">+ *    of the last element).</span>
<a href="#l46.404"></a><span id="l46.404" class="difflineplus">+ */</span>
<a href="#l46.405"></a><span id="l46.405" class="difflineplus">+TimelineIndex.prototype.maxIndex = function() {</span>
<a href="#l46.406"></a><span id="l46.406" class="difflineplus">+    return this.timeline.getEvents().length - this.timeline.getBaseIndex();</span>
<a href="#l46.407"></a><span id="l46.407" class="difflineplus">+};</span>
<a href="#l46.408"></a><span id="l46.408" class="difflineplus">+</span>
<a href="#l46.409"></a><span id="l46.409" class="difflineplus">+/**</span>
<a href="#l46.410"></a><span id="l46.410" class="difflineplus">+ * Try move the index forward, or into the neighbouring timeline</span>
<a href="#l46.411"></a><span id="l46.411" class="difflineplus">+ *</span>
<a href="#l46.412"></a><span id="l46.412" class="difflineplus">+ * @param {number} delta  number of events to advance by</span>
<a href="#l46.413"></a><span id="l46.413" class="difflineplus">+ * @return {number} number of events successfully advanced by</span>
<a href="#l46.414"></a><span id="l46.414" class="difflineplus">+ */</span>
<a href="#l46.415"></a><span id="l46.415" class="difflineplus">+TimelineIndex.prototype.advance = function(delta) {</span>
<a href="#l46.416"></a><span id="l46.416" class="difflineplus">+    if (!delta) {</span>
<a href="#l46.417"></a><span id="l46.417" class="difflineplus">+        return 0;</span>
<a href="#l46.418"></a><span id="l46.418" class="difflineplus">+    }</span>
<a href="#l46.419"></a><span id="l46.419" class="difflineplus">+</span>
<a href="#l46.420"></a><span id="l46.420" class="difflineplus">+    // first try moving the index in the current timeline. See if there is room</span>
<a href="#l46.421"></a><span id="l46.421" class="difflineplus">+    // to do so.</span>
<a href="#l46.422"></a><span id="l46.422" class="difflineplus">+    var cappedDelta;</span>
<a href="#l46.423"></a><span id="l46.423" class="difflineplus">+    if (delta &lt; 0) {</span>
<a href="#l46.424"></a><span id="l46.424" class="difflineplus">+        // we want to wind the index backwards.</span>
<a href="#l46.425"></a><span id="l46.425" class="difflineplus">+        //</span>
<a href="#l46.426"></a><span id="l46.426" class="difflineplus">+        // (this.minIndex() - this.index) is a negative number whose magnitude</span>
<a href="#l46.427"></a><span id="l46.427" class="difflineplus">+        // is the amount of room we have to wind back the index in the current</span>
<a href="#l46.428"></a><span id="l46.428" class="difflineplus">+        // timeline. We cap delta to this quantity.</span>
<a href="#l46.429"></a><span id="l46.429" class="difflineplus">+        cappedDelta = Math.max(delta, this.minIndex() - this.index);</span>
<a href="#l46.430"></a><span id="l46.430" class="difflineplus">+        if (cappedDelta &lt; 0) {</span>
<a href="#l46.431"></a><span id="l46.431" class="difflineplus">+            this.index += cappedDelta;</span>
<a href="#l46.432"></a><span id="l46.432" class="difflineplus">+            return cappedDelta;</span>
<a href="#l46.433"></a><span id="l46.433" class="difflineplus">+        }</span>
<a href="#l46.434"></a><span id="l46.434" class="difflineplus">+    } else {</span>
<a href="#l46.435"></a><span id="l46.435" class="difflineplus">+        // we want to wind the index forwards.</span>
<a href="#l46.436"></a><span id="l46.436" class="difflineplus">+        //</span>
<a href="#l46.437"></a><span id="l46.437" class="difflineplus">+        // (this.maxIndex() - this.index) is a (positive) number whose magnitude</span>
<a href="#l46.438"></a><span id="l46.438" class="difflineplus">+        // is the amount of room we have to wind forward the index in the current</span>
<a href="#l46.439"></a><span id="l46.439" class="difflineplus">+        // timeline. We cap delta to this quantity.</span>
<a href="#l46.440"></a><span id="l46.440" class="difflineplus">+        cappedDelta = Math.min(delta, this.maxIndex() - this.index);</span>
<a href="#l46.441"></a><span id="l46.441" class="difflineplus">+        if (cappedDelta &gt; 0) {</span>
<a href="#l46.442"></a><span id="l46.442" class="difflineplus">+            this.index += cappedDelta;</span>
<a href="#l46.443"></a><span id="l46.443" class="difflineplus">+            return cappedDelta;</span>
<a href="#l46.444"></a><span id="l46.444" class="difflineplus">+        }</span>
<a href="#l46.445"></a><span id="l46.445" class="difflineplus">+    }</span>
<a href="#l46.446"></a><span id="l46.446" class="difflineplus">+</span>
<a href="#l46.447"></a><span id="l46.447" class="difflineplus">+    // the index is already at the start/end of the current timeline.</span>
<a href="#l46.448"></a><span id="l46.448" class="difflineplus">+    //</span>
<a href="#l46.449"></a><span id="l46.449" class="difflineplus">+    // next see if there is a neighbouring timeline to switch to.</span>
<a href="#l46.450"></a><span id="l46.450" class="difflineplus">+    var neighbour = this.timeline.getNeighbouringTimeline(</span>
<a href="#l46.451"></a><span id="l46.451" class="difflineplus">+        delta &lt; 0 ? EventTimeline.BACKWARDS : EventTimeline.FORWARDS);</span>
<a href="#l46.452"></a><span id="l46.452" class="difflineplus">+    if (neighbour) {</span>
<a href="#l46.453"></a><span id="l46.453" class="difflineplus">+        this.timeline = neighbour;</span>
<a href="#l46.454"></a><span id="l46.454" class="difflineplus">+        if (delta &lt; 0) {</span>
<a href="#l46.455"></a><span id="l46.455" class="difflineplus">+            this.index = this.maxIndex();</span>
<a href="#l46.456"></a><span id="l46.456" class="difflineplus">+        } else {</span>
<a href="#l46.457"></a><span id="l46.457" class="difflineplus">+            this.index = this.minIndex();</span>
<a href="#l46.458"></a><span id="l46.458" class="difflineplus">+        }</span>
<a href="#l46.459"></a><span id="l46.459" class="difflineplus">+</span>
<a href="#l46.460"></a><span id="l46.460" class="difflineplus">+        debuglog(&quot;paginate: switched to new neighbour&quot;);</span>
<a href="#l46.461"></a><span id="l46.461" class="difflineplus">+</span>
<a href="#l46.462"></a><span id="l46.462" class="difflineplus">+        // recurse, using the next timeline</span>
<a href="#l46.463"></a><span id="l46.463" class="difflineplus">+        return this.advance(delta);</span>
<a href="#l46.464"></a><span id="l46.464" class="difflineplus">+    }</span>
<a href="#l46.465"></a><span id="l46.465" class="difflineplus">+</span>
<a href="#l46.466"></a><span id="l46.466" class="difflineplus">+    return 0;</span>
<a href="#l46.467"></a><span id="l46.467" class="difflineplus">+};</span>
<a href="#l46.468"></a><span id="l46.468" class="difflineplus">+</span>
<a href="#l46.469"></a><span id="l46.469" class="difflineplus">+/**</span>
<a href="#l46.470"></a><span id="l46.470" class="difflineplus">+ * Try move the index backwards, or into the neighbouring timeline</span>
<a href="#l46.471"></a><span id="l46.471" class="difflineplus">+ *</span>
<a href="#l46.472"></a><span id="l46.472" class="difflineplus">+ * @param {number} delta  number of events to retreat by</span>
<a href="#l46.473"></a><span id="l46.473" class="difflineplus">+ * @return {number} number of events successfully retreated by</span>
<a href="#l46.474"></a><span id="l46.474" class="difflineplus">+ */</span>
<a href="#l46.475"></a><span id="l46.475" class="difflineplus">+TimelineIndex.prototype.retreat = function(delta) {</span>
<a href="#l46.476"></a><span id="l46.476" class="difflineplus">+    return this.advance(delta * -1) * -1;</span>
<a href="#l46.477"></a><span id="l46.477" class="difflineplus">+};</span>
<a href="#l46.478"></a><span id="l46.478" class="difflineplus">+</span>
<a href="#l46.479"></a><span id="l46.479" class="difflineplus">+/**</span>
<a href="#l46.480"></a><span id="l46.480" class="difflineplus">+ * The TimelineWindow class.</span>
<a href="#l46.481"></a><span id="l46.481" class="difflineplus">+ */</span>
<a href="#l46.482"></a><span id="l46.482" class="difflineplus">+module.exports.TimelineWindow = TimelineWindow;</span>
<a href="#l46.483"></a><span id="l46.483" class="difflineplus">+</span>
<a href="#l46.484"></a><span id="l46.484" class="difflineplus">+/**</span>
<a href="#l46.485"></a><span id="l46.485" class="difflineplus">+ * The TimelineIndex class. exported here for unit testing.</span>
<a href="#l46.486"></a><span id="l46.486" class="difflineplus">+ */</span>
<a href="#l46.487"></a><span id="l46.487" class="difflineplus">+module.exports.TimelineIndex = TimelineIndex;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l47.1"></a><span id="l47.1">new file mode 100644</span>
<a href="#l47.2"></a><span id="l47.2" class="difflineminus">--- /dev/null</span>
<a href="#l47.3"></a><span id="l47.3" class="difflineplus">+++ b/chat/protocols/matrix/matrix-sdk/utils.js</span>
<a href="#l47.4"></a><span id="l47.4" class="difflineat">@@ -0,0 +1,659 @@</span>
<a href="#l47.5"></a><span id="l47.5" class="difflineplus">+/*</span>
<a href="#l47.6"></a><span id="l47.6" class="difflineplus">+Copyright 2015, 2016 OpenMarket Ltd</span>
<a href="#l47.7"></a><span id="l47.7" class="difflineplus">+</span>
<a href="#l47.8"></a><span id="l47.8" class="difflineplus">+Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<a href="#l47.9"></a><span id="l47.9" class="difflineplus">+you may not use this file except in compliance with the License.</span>
<a href="#l47.10"></a><span id="l47.10" class="difflineplus">+You may obtain a copy of the License at</span>
<a href="#l47.11"></a><span id="l47.11" class="difflineplus">+</span>
<a href="#l47.12"></a><span id="l47.12" class="difflineplus">+    http://www.apache.org/licenses/LICENSE-2.0</span>
<a href="#l47.13"></a><span id="l47.13" class="difflineplus">+</span>
<a href="#l47.14"></a><span id="l47.14" class="difflineplus">+Unless required by applicable law or agreed to in writing, software</span>
<a href="#l47.15"></a><span id="l47.15" class="difflineplus">+distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<a href="#l47.16"></a><span id="l47.16" class="difflineplus">+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<a href="#l47.17"></a><span id="l47.17" class="difflineplus">+See the License for the specific language governing permissions and</span>
<a href="#l47.18"></a><span id="l47.18" class="difflineplus">+limitations under the License.</span>
<a href="#l47.19"></a><span id="l47.19" class="difflineplus">+*/</span>
<a href="#l47.20"></a><span id="l47.20" class="difflineplus">+&quot;use strict&quot;;</span>
<a href="#l47.21"></a><span id="l47.21" class="difflineplus">+/**</span>
<a href="#l47.22"></a><span id="l47.22" class="difflineplus">+ * This is an internal module.</span>
<a href="#l47.23"></a><span id="l47.23" class="difflineplus">+ * @module utils</span>
<a href="#l47.24"></a><span id="l47.24" class="difflineplus">+ */</span>
<a href="#l47.25"></a><span id="l47.25" class="difflineplus">+</span>
<a href="#l47.26"></a><span id="l47.26" class="difflineplus">+/**</span>
<a href="#l47.27"></a><span id="l47.27" class="difflineplus">+ * Encode a dictionary of query parameters.</span>
<a href="#l47.28"></a><span id="l47.28" class="difflineplus">+ * @param {Object} params A dict of key/values to encode e.g.</span>
<a href="#l47.29"></a><span id="l47.29" class="difflineplus">+ * {&quot;foo&quot;: &quot;bar&quot;, &quot;baz&quot;: &quot;taz&quot;}</span>
<a href="#l47.30"></a><span id="l47.30" class="difflineplus">+ * @return {string} The encoded string e.g. foo=bar&amp;baz=taz</span>
<a href="#l47.31"></a><span id="l47.31" class="difflineplus">+ */</span>
<a href="#l47.32"></a><span id="l47.32" class="difflineplus">+module.exports.encodeParams = function(params) {</span>
<a href="#l47.33"></a><span id="l47.33" class="difflineplus">+    var qs = &quot;&quot;;</span>
<a href="#l47.34"></a><span id="l47.34" class="difflineplus">+    for (var key in params) {</span>
<a href="#l47.35"></a><span id="l47.35" class="difflineplus">+        if (!params.hasOwnProperty(key)) { continue; }</span>
<a href="#l47.36"></a><span id="l47.36" class="difflineplus">+        qs += &quot;&amp;&quot; + encodeURIComponent(key) + &quot;=&quot; +</span>
<a href="#l47.37"></a><span id="l47.37" class="difflineplus">+                encodeURIComponent(params[key]);</span>
<a href="#l47.38"></a><span id="l47.38" class="difflineplus">+    }</span>
<a href="#l47.39"></a><span id="l47.39" class="difflineplus">+    return qs.substring(1);</span>
<a href="#l47.40"></a><span id="l47.40" class="difflineplus">+};</span>
<a href="#l47.41"></a><span id="l47.41" class="difflineplus">+</span>
<a href="#l47.42"></a><span id="l47.42" class="difflineplus">+/**</span>
<a href="#l47.43"></a><span id="l47.43" class="difflineplus">+ * Encodes a URI according to a set of template variables. Variables will be</span>
<a href="#l47.44"></a><span id="l47.44" class="difflineplus">+ * passed through encodeURIComponent.</span>
<a href="#l47.45"></a><span id="l47.45" class="difflineplus">+ * @param {string} pathTemplate The path with template variables e.g. '/foo/$bar'.</span>
<a href="#l47.46"></a><span id="l47.46" class="difflineplus">+ * @param {Object} variables The key/value pairs to replace the template</span>
<a href="#l47.47"></a><span id="l47.47" class="difflineplus">+ * variables with. E.g. { &quot;$bar&quot;: &quot;baz&quot; }.</span>
<a href="#l47.48"></a><span id="l47.48" class="difflineplus">+ * @return {string} The result of replacing all template variables e.g. '/foo/baz'.</span>
<a href="#l47.49"></a><span id="l47.49" class="difflineplus">+ */</span>
<a href="#l47.50"></a><span id="l47.50" class="difflineplus">+module.exports.encodeUri = function(pathTemplate, variables) {</span>
<a href="#l47.51"></a><span id="l47.51" class="difflineplus">+    for (var key in variables) {</span>
<a href="#l47.52"></a><span id="l47.52" class="difflineplus">+        if (!variables.hasOwnProperty(key)) { continue; }</span>
<a href="#l47.53"></a><span id="l47.53" class="difflineplus">+        pathTemplate = pathTemplate.replace(</span>
<a href="#l47.54"></a><span id="l47.54" class="difflineplus">+            key, encodeURIComponent(variables[key])</span>
<a href="#l47.55"></a><span id="l47.55" class="difflineplus">+        );</span>
<a href="#l47.56"></a><span id="l47.56" class="difflineplus">+    }</span>
<a href="#l47.57"></a><span id="l47.57" class="difflineplus">+    return pathTemplate;</span>
<a href="#l47.58"></a><span id="l47.58" class="difflineplus">+};</span>
<a href="#l47.59"></a><span id="l47.59" class="difflineplus">+</span>
<a href="#l47.60"></a><span id="l47.60" class="difflineplus">+/**</span>
<a href="#l47.61"></a><span id="l47.61" class="difflineplus">+ * Applies a map function to the given array.</span>
<a href="#l47.62"></a><span id="l47.62" class="difflineplus">+ * @param {Array} array The array to apply the function to.</span>
<a href="#l47.63"></a><span id="l47.63" class="difflineplus">+ * @param {Function} fn The function that will be invoked for each element in</span>
<a href="#l47.64"></a><span id="l47.64" class="difflineplus">+ * the array with the signature &lt;code&gt;fn(element){...}&lt;/code&gt;</span>
<a href="#l47.65"></a><span id="l47.65" class="difflineplus">+ * @return {Array} A new array with the results of the function.</span>
<a href="#l47.66"></a><span id="l47.66" class="difflineplus">+ */</span>
<a href="#l47.67"></a><span id="l47.67" class="difflineplus">+module.exports.map = function(array, fn) {</span>
<a href="#l47.68"></a><span id="l47.68" class="difflineplus">+    var results = new Array(array.length);</span>
<a href="#l47.69"></a><span id="l47.69" class="difflineplus">+    for (var i = 0; i &lt; array.length; i++) {</span>
<a href="#l47.70"></a><span id="l47.70" class="difflineplus">+        results[i] = fn(array[i]);</span>
<a href="#l47.71"></a><span id="l47.71" class="difflineplus">+    }</span>
<a href="#l47.72"></a><span id="l47.72" class="difflineplus">+    return results;</span>
<a href="#l47.73"></a><span id="l47.73" class="difflineplus">+};</span>
<a href="#l47.74"></a><span id="l47.74" class="difflineplus">+</span>
<a href="#l47.75"></a><span id="l47.75" class="difflineplus">+/**</span>
<a href="#l47.76"></a><span id="l47.76" class="difflineplus">+ * Applies a filter function to the given array.</span>
<a href="#l47.77"></a><span id="l47.77" class="difflineplus">+ * @param {Array} array The array to apply the function to.</span>
<a href="#l47.78"></a><span id="l47.78" class="difflineplus">+ * @param {Function} fn The function that will be invoked for each element in</span>
<a href="#l47.79"></a><span id="l47.79" class="difflineplus">+ * the array. It should return true to keep the element. The function signature</span>
<a href="#l47.80"></a><span id="l47.80" class="difflineplus">+ * looks like &lt;code&gt;fn(element, index, array){...}&lt;/code&gt;.</span>
<a href="#l47.81"></a><span id="l47.81" class="difflineplus">+ * @return {Array} A new array with the results of the function.</span>
<a href="#l47.82"></a><span id="l47.82" class="difflineplus">+ */</span>
<a href="#l47.83"></a><span id="l47.83" class="difflineplus">+module.exports.filter = function(array, fn) {</span>
<a href="#l47.84"></a><span id="l47.84" class="difflineplus">+    var results = [];</span>
<a href="#l47.85"></a><span id="l47.85" class="difflineplus">+    for (var i = 0; i &lt; array.length; i++) {</span>
<a href="#l47.86"></a><span id="l47.86" class="difflineplus">+        if (fn(array[i], i, array)) {</span>
<a href="#l47.87"></a><span id="l47.87" class="difflineplus">+            results.push(array[i]);</span>
<a href="#l47.88"></a><span id="l47.88" class="difflineplus">+        }</span>
<a href="#l47.89"></a><span id="l47.89" class="difflineplus">+    }</span>
<a href="#l47.90"></a><span id="l47.90" class="difflineplus">+    return results;</span>
<a href="#l47.91"></a><span id="l47.91" class="difflineplus">+};</span>
<a href="#l47.92"></a><span id="l47.92" class="difflineplus">+</span>
<a href="#l47.93"></a><span id="l47.93" class="difflineplus">+/**</span>
<a href="#l47.94"></a><span id="l47.94" class="difflineplus">+ * Get the keys for an object. Same as &lt;code&gt;Object.keys()&lt;/code&gt;.</span>
<a href="#l47.95"></a><span id="l47.95" class="difflineplus">+ * @param {Object} obj The object to get the keys for.</span>
<a href="#l47.96"></a><span id="l47.96" class="difflineplus">+ * @return {string[]} The keys of the object.</span>
<a href="#l47.97"></a><span id="l47.97" class="difflineplus">+ */</span>
<a href="#l47.98"></a><span id="l47.98" class="difflineplus">+module.exports.keys = function(obj) {</span>
<a href="#l47.99"></a><span id="l47.99" class="difflineplus">+    var keys = [];</span>
<a href="#l47.100"></a><span id="l47.100" class="difflineplus">+    for (var key in obj) {</span>
<a href="#l47.101"></a><span id="l47.101" class="difflineplus">+        if (!obj.hasOwnProperty(key)) { continue; }</span>
<a href="#l47.102"></a><span id="l47.102" class="difflineplus">+        keys.push(key);</span>
<a href="#l47.103"></a><span id="l47.103" class="difflineplus">+    }</span>
<a href="#l47.104"></a><span id="l47.104" class="difflineplus">+    return keys;</span>
<a href="#l47.105"></a><span id="l47.105" class="difflineplus">+};</span>
<a href="#l47.106"></a><span id="l47.106" class="difflineplus">+</span>
<a href="#l47.107"></a><span id="l47.107" class="difflineplus">+/**</span>
<a href="#l47.108"></a><span id="l47.108" class="difflineplus">+ * Get the values for an object.</span>
<a href="#l47.109"></a><span id="l47.109" class="difflineplus">+ * @param {Object} obj The object to get the values for.</span>
<a href="#l47.110"></a><span id="l47.110" class="difflineplus">+ * @return {Array&lt;*&gt;} The values of the object.</span>
<a href="#l47.111"></a><span id="l47.111" class="difflineplus">+ */</span>
<a href="#l47.112"></a><span id="l47.112" class="difflineplus">+module.exports.values = function(obj) {</span>
<a href="#l47.113"></a><span id="l47.113" class="difflineplus">+    var values = [];</span>
<a href="#l47.114"></a><span id="l47.114" class="difflineplus">+    for (var key in obj) {</span>
<a href="#l47.115"></a><span id="l47.115" class="difflineplus">+        if (!obj.hasOwnProperty(key)) { continue; }</span>
<a href="#l47.116"></a><span id="l47.116" class="difflineplus">+        values.push(obj[key]);</span>
<a href="#l47.117"></a><span id="l47.117" class="difflineplus">+    }</span>
<a href="#l47.118"></a><span id="l47.118" class="difflineplus">+    return values;</span>
<a href="#l47.119"></a><span id="l47.119" class="difflineplus">+};</span>
<a href="#l47.120"></a><span id="l47.120" class="difflineplus">+</span>
<a href="#l47.121"></a><span id="l47.121" class="difflineplus">+/**</span>
<a href="#l47.122"></a><span id="l47.122" class="difflineplus">+ * Invoke a function for each item in the array.</span>
<a href="#l47.123"></a><span id="l47.123" class="difflineplus">+ * @param {Array} array The array.</span>
<a href="#l47.124"></a><span id="l47.124" class="difflineplus">+ * @param {Function} fn The function to invoke for each element. Has the</span>
<a href="#l47.125"></a><span id="l47.125" class="difflineplus">+ * function signature &lt;code&gt;fn(element, index)&lt;/code&gt;.</span>
<a href="#l47.126"></a><span id="l47.126" class="difflineplus">+ */</span>
<a href="#l47.127"></a><span id="l47.127" class="difflineplus">+module.exports.forEach = function(array, fn) {</span>
<a href="#l47.128"></a><span id="l47.128" class="difflineplus">+    for (var i = 0; i &lt; array.length; i++) {</span>
<a href="#l47.129"></a><span id="l47.129" class="difflineplus">+        fn(array[i], i);</span>
<a href="#l47.130"></a><span id="l47.130" class="difflineplus">+    }</span>
<a href="#l47.131"></a><span id="l47.131" class="difflineplus">+};</span>
<a href="#l47.132"></a><span id="l47.132" class="difflineplus">+</span>
<a href="#l47.133"></a><span id="l47.133" class="difflineplus">+/**</span>
<a href="#l47.134"></a><span id="l47.134" class="difflineplus">+ * The findElement() method returns a value in the array, if an element in the array</span>
<a href="#l47.135"></a><span id="l47.135" class="difflineplus">+ * satisfies (returns true) the provided testing function. Otherwise undefined</span>
<a href="#l47.136"></a><span id="l47.136" class="difflineplus">+ * is returned.</span>
<a href="#l47.137"></a><span id="l47.137" class="difflineplus">+ * @param {Array} array The array.</span>
<a href="#l47.138"></a><span id="l47.138" class="difflineplus">+ * @param {Function} fn Function to execute on each value in the array, with the</span>
<a href="#l47.139"></a><span id="l47.139" class="difflineplus">+ * function signature &lt;code&gt;fn(element, index, array)&lt;/code&gt;</span>
<a href="#l47.140"></a><span id="l47.140" class="difflineplus">+ * @param {boolean} reverse True to search in reverse order.</span>
<a href="#l47.141"></a><span id="l47.141" class="difflineplus">+ * @return {*} The first value in the array which returns &lt;code&gt;true&lt;/code&gt; for</span>
<a href="#l47.142"></a><span id="l47.142" class="difflineplus">+ * the given function.</span>
<a href="#l47.143"></a><span id="l47.143" class="difflineplus">+ */</span>
<a href="#l47.144"></a><span id="l47.144" class="difflineplus">+module.exports.findElement = function(array, fn, reverse) {</span>
<a href="#l47.145"></a><span id="l47.145" class="difflineplus">+    var i;</span>
<a href="#l47.146"></a><span id="l47.146" class="difflineplus">+    if (reverse) {</span>
<a href="#l47.147"></a><span id="l47.147" class="difflineplus">+        for (i = array.length - 1; i &gt;= 0; i--) {</span>
<a href="#l47.148"></a><span id="l47.148" class="difflineplus">+            if (fn(array[i], i, array)) {</span>
<a href="#l47.149"></a><span id="l47.149" class="difflineplus">+                return array[i];</span>
<a href="#l47.150"></a><span id="l47.150" class="difflineplus">+            }</span>
<a href="#l47.151"></a><span id="l47.151" class="difflineplus">+        }</span>
<a href="#l47.152"></a><span id="l47.152" class="difflineplus">+    }</span>
<a href="#l47.153"></a><span id="l47.153" class="difflineplus">+    else {</span>
<a href="#l47.154"></a><span id="l47.154" class="difflineplus">+        for (i = 0; i &lt; array.length; i++) {</span>
<a href="#l47.155"></a><span id="l47.155" class="difflineplus">+            if (fn(array[i], i, array)) {</span>
<a href="#l47.156"></a><span id="l47.156" class="difflineplus">+                return array[i];</span>
<a href="#l47.157"></a><span id="l47.157" class="difflineplus">+            }</span>
<a href="#l47.158"></a><span id="l47.158" class="difflineplus">+        }</span>
<a href="#l47.159"></a><span id="l47.159" class="difflineplus">+    }</span>
<a href="#l47.160"></a><span id="l47.160" class="difflineplus">+};</span>
<a href="#l47.161"></a><span id="l47.161" class="difflineplus">+</span>
<a href="#l47.162"></a><span id="l47.162" class="difflineplus">+/**</span>
<a href="#l47.163"></a><span id="l47.163" class="difflineplus">+ * The removeElement() method removes the first element in the array that</span>
<a href="#l47.164"></a><span id="l47.164" class="difflineplus">+ * satisfies (returns true) the provided testing function.</span>
<a href="#l47.165"></a><span id="l47.165" class="difflineplus">+ * @param {Array} array The array.</span>
<a href="#l47.166"></a><span id="l47.166" class="difflineplus">+ * @param {Function} fn Function to execute on each value in the array, with the</span>
<a href="#l47.167"></a><span id="l47.167" class="difflineplus">+ * function signature &lt;code&gt;fn(element, index, array)&lt;/code&gt;. Return true to</span>
<a href="#l47.168"></a><span id="l47.168" class="difflineplus">+ * remove this element and break.</span>
<a href="#l47.169"></a><span id="l47.169" class="difflineplus">+ * @param {boolean} reverse True to search in reverse order.</span>
<a href="#l47.170"></a><span id="l47.170" class="difflineplus">+ * @return {boolean} True if an element was removed.</span>
<a href="#l47.171"></a><span id="l47.171" class="difflineplus">+ */</span>
<a href="#l47.172"></a><span id="l47.172" class="difflineplus">+module.exports.removeElement = function(array, fn, reverse) {</span>
<a href="#l47.173"></a><span id="l47.173" class="difflineplus">+    var i;</span>
<a href="#l47.174"></a><span id="l47.174" class="difflineplus">+    var removed;</span>
<a href="#l47.175"></a><span id="l47.175" class="difflineplus">+    if (reverse) {</span>
<a href="#l47.176"></a><span id="l47.176" class="difflineplus">+        for (i = array.length - 1; i &gt;= 0; i--) {</span>
<a href="#l47.177"></a><span id="l47.177" class="difflineplus">+            if (fn(array[i], i, array)) {</span>
<a href="#l47.178"></a><span id="l47.178" class="difflineplus">+                removed = array[i];</span>
<a href="#l47.179"></a><span id="l47.179" class="difflineplus">+                array.splice(i, 1);</span>
<a href="#l47.180"></a><span id="l47.180" class="difflineplus">+                return removed;</span>
<a href="#l47.181"></a><span id="l47.181" class="difflineplus">+            }</span>
<a href="#l47.182"></a><span id="l47.182" class="difflineplus">+        }</span>
<a href="#l47.183"></a><span id="l47.183" class="difflineplus">+    }</span>
<a href="#l47.184"></a><span id="l47.184" class="difflineplus">+    else {</span>
<a href="#l47.185"></a><span id="l47.185" class="difflineplus">+        for (i = 0; i &lt; array.length; i++) {</span>
<a href="#l47.186"></a><span id="l47.186" class="difflineplus">+            if (fn(array[i], i, array)) {</span>
<a href="#l47.187"></a><span id="l47.187" class="difflineplus">+                removed = array[i];</span>
<a href="#l47.188"></a><span id="l47.188" class="difflineplus">+                array.splice(i, 1);</span>
<a href="#l47.189"></a><span id="l47.189" class="difflineplus">+                return removed;</span>
<a href="#l47.190"></a><span id="l47.190" class="difflineplus">+            }</span>
<a href="#l47.191"></a><span id="l47.191" class="difflineplus">+        }</span>
<a href="#l47.192"></a><span id="l47.192" class="difflineplus">+    }</span>
<a href="#l47.193"></a><span id="l47.193" class="difflineplus">+    return false;</span>
<a href="#l47.194"></a><span id="l47.194" class="difflineplus">+};</span>
<a href="#l47.195"></a><span id="l47.195" class="difflineplus">+</span>
<a href="#l47.196"></a><span id="l47.196" class="difflineplus">+/**</span>
<a href="#l47.197"></a><span id="l47.197" class="difflineplus">+ * Checks if the given thing is a function.</span>
<a href="#l47.198"></a><span id="l47.198" class="difflineplus">+ * @param {*} value The thing to check.</span>
<a href="#l47.199"></a><span id="l47.199" class="difflineplus">+ * @return {boolean} True if it is a function.</span>
<a href="#l47.200"></a><span id="l47.200" class="difflineplus">+ */</span>
<a href="#l47.201"></a><span id="l47.201" class="difflineplus">+module.exports.isFunction = function(value) {</span>
<a href="#l47.202"></a><span id="l47.202" class="difflineplus">+    return Object.prototype.toString.call(value) == &quot;[object Function]&quot;;</span>
<a href="#l47.203"></a><span id="l47.203" class="difflineplus">+};</span>
<a href="#l47.204"></a><span id="l47.204" class="difflineplus">+</span>
<a href="#l47.205"></a><span id="l47.205" class="difflineplus">+/**</span>
<a href="#l47.206"></a><span id="l47.206" class="difflineplus">+ * Checks if the given thing is an array.</span>
<a href="#l47.207"></a><span id="l47.207" class="difflineplus">+ * @param {*} value The thing to check.</span>
<a href="#l47.208"></a><span id="l47.208" class="difflineplus">+ * @return {boolean} True if it is an array.</span>
<a href="#l47.209"></a><span id="l47.209" class="difflineplus">+ */</span>
<a href="#l47.210"></a><span id="l47.210" class="difflineplus">+module.exports.isArray = function(value) {</span>
<a href="#l47.211"></a><span id="l47.211" class="difflineplus">+    return Array.isArray ? Array.isArray(value) :</span>
<a href="#l47.212"></a><span id="l47.212" class="difflineplus">+        Boolean(value &amp;&amp; value.constructor === Array);</span>
<a href="#l47.213"></a><span id="l47.213" class="difflineplus">+};</span>
<a href="#l47.214"></a><span id="l47.214" class="difflineplus">+</span>
<a href="#l47.215"></a><span id="l47.215" class="difflineplus">+/**</span>
<a href="#l47.216"></a><span id="l47.216" class="difflineplus">+ * Checks that the given object has the specified keys.</span>
<a href="#l47.217"></a><span id="l47.217" class="difflineplus">+ * @param {Object} obj The object to check.</span>
<a href="#l47.218"></a><span id="l47.218" class="difflineplus">+ * @param {string[]} keys The list of keys that 'obj' must have.</span>
<a href="#l47.219"></a><span id="l47.219" class="difflineplus">+ * @throws If the object is missing keys.</span>
<a href="#l47.220"></a><span id="l47.220" class="difflineplus">+ */</span>
<a href="#l47.221"></a><span id="l47.221" class="difflineplus">+module.exports.checkObjectHasKeys = function(obj, keys) {</span>
<a href="#l47.222"></a><span id="l47.222" class="difflineplus">+    for (var i = 0; i &lt; keys.length; i++) {</span>
<a href="#l47.223"></a><span id="l47.223" class="difflineplus">+        if (!obj.hasOwnProperty(keys[i])) {</span>
<a href="#l47.224"></a><span id="l47.224" class="difflineplus">+            throw new Error(&quot;Missing required key: &quot; + keys[i]);</span>
<a href="#l47.225"></a><span id="l47.225" class="difflineplus">+        }</span>
<a href="#l47.226"></a><span id="l47.226" class="difflineplus">+    }</span>
<a href="#l47.227"></a><span id="l47.227" class="difflineplus">+};</span>
<a href="#l47.228"></a><span id="l47.228" class="difflineplus">+</span>
<a href="#l47.229"></a><span id="l47.229" class="difflineplus">+/**</span>
<a href="#l47.230"></a><span id="l47.230" class="difflineplus">+ * Checks that the given object has no extra keys other than the specified ones.</span>
<a href="#l47.231"></a><span id="l47.231" class="difflineplus">+ * @param {Object} obj The object to check.</span>
<a href="#l47.232"></a><span id="l47.232" class="difflineplus">+ * @param {string[]} allowedKeys The list of allowed key names.</span>
<a href="#l47.233"></a><span id="l47.233" class="difflineplus">+ * @throws If there are extra keys.</span>
<a href="#l47.234"></a><span id="l47.234" class="difflineplus">+ */</span>
<a href="#l47.235"></a><span id="l47.235" class="difflineplus">+module.exports.checkObjectHasNoAdditionalKeys = function(obj, allowedKeys) {</span>
<a href="#l47.236"></a><span id="l47.236" class="difflineplus">+    for (var key in obj) {</span>
<a href="#l47.237"></a><span id="l47.237" class="difflineplus">+        if (!obj.hasOwnProperty(key)) { continue; }</span>
<a href="#l47.238"></a><span id="l47.238" class="difflineplus">+        if (allowedKeys.indexOf(key) === -1) {</span>
<a href="#l47.239"></a><span id="l47.239" class="difflineplus">+            throw new Error(&quot;Unknown key: &quot; + key);</span>
<a href="#l47.240"></a><span id="l47.240" class="difflineplus">+        }</span>
<a href="#l47.241"></a><span id="l47.241" class="difflineplus">+    }</span>
<a href="#l47.242"></a><span id="l47.242" class="difflineplus">+};</span>
<a href="#l47.243"></a><span id="l47.243" class="difflineplus">+</span>
<a href="#l47.244"></a><span id="l47.244" class="difflineplus">+/**</span>
<a href="#l47.245"></a><span id="l47.245" class="difflineplus">+ * Deep copy the given object. The object MUST NOT have circular references and</span>
<a href="#l47.246"></a><span id="l47.246" class="difflineplus">+ * MUST NOT have functions.</span>
<a href="#l47.247"></a><span id="l47.247" class="difflineplus">+ * @param {Object} obj The object to deep copy.</span>
<a href="#l47.248"></a><span id="l47.248" class="difflineplus">+ * @return {Object} A copy of the object without any references to the original.</span>
<a href="#l47.249"></a><span id="l47.249" class="difflineplus">+ */</span>
<a href="#l47.250"></a><span id="l47.250" class="difflineplus">+module.exports.deepCopy = function(obj) {</span>
<a href="#l47.251"></a><span id="l47.251" class="difflineplus">+    return JSON.parse(JSON.stringify(obj));</span>
<a href="#l47.252"></a><span id="l47.252" class="difflineplus">+};</span>
<a href="#l47.253"></a><span id="l47.253" class="difflineplus">+</span>
<a href="#l47.254"></a><span id="l47.254" class="difflineplus">+/**</span>
<a href="#l47.255"></a><span id="l47.255" class="difflineplus">+ * Compare two objects for equality. The objects MUST NOT have circular references.</span>
<a href="#l47.256"></a><span id="l47.256" class="difflineplus">+ *</span>
<a href="#l47.257"></a><span id="l47.257" class="difflineplus">+ * @param {Object} x The first object to compare.</span>
<a href="#l47.258"></a><span id="l47.258" class="difflineplus">+ * @param {Object} y The second object to compare.</span>
<a href="#l47.259"></a><span id="l47.259" class="difflineplus">+ *</span>
<a href="#l47.260"></a><span id="l47.260" class="difflineplus">+ * @return {boolean} true if the two objects are equal</span>
<a href="#l47.261"></a><span id="l47.261" class="difflineplus">+ */</span>
<a href="#l47.262"></a><span id="l47.262" class="difflineplus">+var deepCompare = module.exports.deepCompare = function(x, y) {</span>
<a href="#l47.263"></a><span id="l47.263" class="difflineplus">+    // Inspired by</span>
<a href="#l47.264"></a><span id="l47.264" class="difflineplus">+    // http://stackoverflow.com/questions/1068834/object-comparison-in-javascript#1144249</span>
<a href="#l47.265"></a><span id="l47.265" class="difflineplus">+</span>
<a href="#l47.266"></a><span id="l47.266" class="difflineplus">+    // Compare primitives and functions.</span>
<a href="#l47.267"></a><span id="l47.267" class="difflineplus">+    // Also check if both arguments link to the same object.</span>
<a href="#l47.268"></a><span id="l47.268" class="difflineplus">+    if (x === y) {</span>
<a href="#l47.269"></a><span id="l47.269" class="difflineplus">+        return true;</span>
<a href="#l47.270"></a><span id="l47.270" class="difflineplus">+    }</span>
<a href="#l47.271"></a><span id="l47.271" class="difflineplus">+</span>
<a href="#l47.272"></a><span id="l47.272" class="difflineplus">+    if (typeof x !== typeof y) {</span>
<a href="#l47.273"></a><span id="l47.273" class="difflineplus">+        return false;</span>
<a href="#l47.274"></a><span id="l47.274" class="difflineplus">+    }</span>
<a href="#l47.275"></a><span id="l47.275" class="difflineplus">+</span>
<a href="#l47.276"></a><span id="l47.276" class="difflineplus">+    // special-case NaN (since NaN !== NaN)</span>
<a href="#l47.277"></a><span id="l47.277" class="difflineplus">+    if (typeof x === 'number' &amp;&amp; isNaN(x) &amp;&amp; isNaN(y)) {</span>
<a href="#l47.278"></a><span id="l47.278" class="difflineplus">+         return true;</span>
<a href="#l47.279"></a><span id="l47.279" class="difflineplus">+    }</span>
<a href="#l47.280"></a><span id="l47.280" class="difflineplus">+</span>
<a href="#l47.281"></a><span id="l47.281" class="difflineplus">+    // special-case null (since typeof null == 'object', but null.constructor</span>
<a href="#l47.282"></a><span id="l47.282" class="difflineplus">+    // throws)</span>
<a href="#l47.283"></a><span id="l47.283" class="difflineplus">+    if (x === null || y === null) {</span>
<a href="#l47.284"></a><span id="l47.284" class="difflineplus">+        return x === y;</span>
<a href="#l47.285"></a><span id="l47.285" class="difflineplus">+    }</span>
<a href="#l47.286"></a><span id="l47.286" class="difflineplus">+</span>
<a href="#l47.287"></a><span id="l47.287" class="difflineplus">+    // everything else is either an unequal primitive, or an object</span>
<a href="#l47.288"></a><span id="l47.288" class="difflineplus">+    if (!(x instanceof Object)) {</span>
<a href="#l47.289"></a><span id="l47.289" class="difflineplus">+        return false;</span>
<a href="#l47.290"></a><span id="l47.290" class="difflineplus">+    }</span>
<a href="#l47.291"></a><span id="l47.291" class="difflineplus">+</span>
<a href="#l47.292"></a><span id="l47.292" class="difflineplus">+    // check they are the same type of object</span>
<a href="#l47.293"></a><span id="l47.293" class="difflineplus">+    if (x.constructor !== y.constructor || x.prototype !== y.prototype) {</span>
<a href="#l47.294"></a><span id="l47.294" class="difflineplus">+        return false;</span>
<a href="#l47.295"></a><span id="l47.295" class="difflineplus">+    }</span>
<a href="#l47.296"></a><span id="l47.296" class="difflineplus">+</span>
<a href="#l47.297"></a><span id="l47.297" class="difflineplus">+    // special-casing for some special types of object</span>
<a href="#l47.298"></a><span id="l47.298" class="difflineplus">+    if (x instanceof RegExp || x instanceof Date) {</span>
<a href="#l47.299"></a><span id="l47.299" class="difflineplus">+        return x.toString() === y.toString();</span>
<a href="#l47.300"></a><span id="l47.300" class="difflineplus">+    }</span>
<a href="#l47.301"></a><span id="l47.301" class="difflineplus">+</span>
<a href="#l47.302"></a><span id="l47.302" class="difflineplus">+    // the object algorithm works for Array, but it's sub-optimal.</span>
<a href="#l47.303"></a><span id="l47.303" class="difflineplus">+    if (x instanceof Array) {</span>
<a href="#l47.304"></a><span id="l47.304" class="difflineplus">+        if (x.length !== y.length) {</span>
<a href="#l47.305"></a><span id="l47.305" class="difflineplus">+            return false;</span>
<a href="#l47.306"></a><span id="l47.306" class="difflineplus">+        }</span>
<a href="#l47.307"></a><span id="l47.307" class="difflineplus">+</span>
<a href="#l47.308"></a><span id="l47.308" class="difflineplus">+        for (var i = 0; i &lt; x.length; i++) {</span>
<a href="#l47.309"></a><span id="l47.309" class="difflineplus">+            if (!deepCompare(x[i], y[i])) {</span>
<a href="#l47.310"></a><span id="l47.310" class="difflineplus">+                return false;</span>
<a href="#l47.311"></a><span id="l47.311" class="difflineplus">+            }</span>
<a href="#l47.312"></a><span id="l47.312" class="difflineplus">+        }</span>
<a href="#l47.313"></a><span id="l47.313" class="difflineplus">+    } else {</span>
<a href="#l47.314"></a><span id="l47.314" class="difflineplus">+        // disable jshint &quot;The body of a for in should be wrapped in an if</span>
<a href="#l47.315"></a><span id="l47.315" class="difflineplus">+        // statement&quot;</span>
<a href="#l47.316"></a><span id="l47.316" class="difflineplus">+        /* jshint -W089 */</span>
<a href="#l47.317"></a><span id="l47.317" class="difflineplus">+</span>
<a href="#l47.318"></a><span id="l47.318" class="difflineplus">+        // check that all of y's direct keys are in x</span>
<a href="#l47.319"></a><span id="l47.319" class="difflineplus">+        var p;</span>
<a href="#l47.320"></a><span id="l47.320" class="difflineplus">+        for (p in y) {</span>
<a href="#l47.321"></a><span id="l47.321" class="difflineplus">+            if (y.hasOwnProperty(p) !== x.hasOwnProperty(p)) {</span>
<a href="#l47.322"></a><span id="l47.322" class="difflineplus">+                return false;</span>
<a href="#l47.323"></a><span id="l47.323" class="difflineplus">+            }</span>
<a href="#l47.324"></a><span id="l47.324" class="difflineplus">+        }</span>
<a href="#l47.325"></a><span id="l47.325" class="difflineplus">+</span>
<a href="#l47.326"></a><span id="l47.326" class="difflineplus">+        // finally, compare each of x's keys with y</span>
<a href="#l47.327"></a><span id="l47.327" class="difflineplus">+        for (p in y) {</span>
<a href="#l47.328"></a><span id="l47.328" class="difflineplus">+            if (y.hasOwnProperty(p) !== x.hasOwnProperty(p)) {</span>
<a href="#l47.329"></a><span id="l47.329" class="difflineplus">+                return false;</span>
<a href="#l47.330"></a><span id="l47.330" class="difflineplus">+            }</span>
<a href="#l47.331"></a><span id="l47.331" class="difflineplus">+            if (!deepCompare(x[p], y[p])) {</span>
<a href="#l47.332"></a><span id="l47.332" class="difflineplus">+                return false;</span>
<a href="#l47.333"></a><span id="l47.333" class="difflineplus">+            }</span>
<a href="#l47.334"></a><span id="l47.334" class="difflineplus">+        }</span>
<a href="#l47.335"></a><span id="l47.335" class="difflineplus">+    }</span>
<a href="#l47.336"></a><span id="l47.336" class="difflineplus">+    /* jshint +W089 */</span>
<a href="#l47.337"></a><span id="l47.337" class="difflineplus">+    return true;</span>
<a href="#l47.338"></a><span id="l47.338" class="difflineplus">+};</span>
<a href="#l47.339"></a><span id="l47.339" class="difflineplus">+</span>
<a href="#l47.340"></a><span id="l47.340" class="difflineplus">+/**</span>
<a href="#l47.341"></a><span id="l47.341" class="difflineplus">+ * Copy properties from one object to another.</span>
<a href="#l47.342"></a><span id="l47.342" class="difflineplus">+ *</span>
<a href="#l47.343"></a><span id="l47.343" class="difflineplus">+ * All enumerable properties, included inherited ones, are copied.</span>
<a href="#l47.344"></a><span id="l47.344" class="difflineplus">+ *</span>
<a href="#l47.345"></a><span id="l47.345" class="difflineplus">+ * This is approximately equivalent to ES6's Object.assign, except</span>
<a href="#l47.346"></a><span id="l47.346" class="difflineplus">+ * that the latter doesn't copy inherited properties.</span>
<a href="#l47.347"></a><span id="l47.347" class="difflineplus">+ *</span>
<a href="#l47.348"></a><span id="l47.348" class="difflineplus">+ * @param {Object} target  The object that will receive new properties</span>
<a href="#l47.349"></a><span id="l47.349" class="difflineplus">+ * @param {...Object} source  Objects from which to copy properties</span>
<a href="#l47.350"></a><span id="l47.350" class="difflineplus">+ *</span>
<a href="#l47.351"></a><span id="l47.351" class="difflineplus">+ * @return {Object} target</span>
<a href="#l47.352"></a><span id="l47.352" class="difflineplus">+ */</span>
<a href="#l47.353"></a><span id="l47.353" class="difflineplus">+module.exports.extend = function() {</span>
<a href="#l47.354"></a><span id="l47.354" class="difflineplus">+    var target = arguments[0] || {};</span>
<a href="#l47.355"></a><span id="l47.355" class="difflineplus">+    // disable jshint &quot;The body of a for in should be wrapped in an if</span>
<a href="#l47.356"></a><span id="l47.356" class="difflineplus">+    // statement&quot;</span>
<a href="#l47.357"></a><span id="l47.357" class="difflineplus">+    /* jshint -W089 */</span>
<a href="#l47.358"></a><span id="l47.358" class="difflineplus">+    for (var i = 1; i &lt; arguments.length; i++) {</span>
<a href="#l47.359"></a><span id="l47.359" class="difflineplus">+        var source = arguments[i];</span>
<a href="#l47.360"></a><span id="l47.360" class="difflineplus">+        for (var propName in source) {</span>
<a href="#l47.361"></a><span id="l47.361" class="difflineplus">+            target[propName] = source[propName];</span>
<a href="#l47.362"></a><span id="l47.362" class="difflineplus">+        }</span>
<a href="#l47.363"></a><span id="l47.363" class="difflineplus">+    }</span>
<a href="#l47.364"></a><span id="l47.364" class="difflineplus">+    /* jshint +W089 */</span>
<a href="#l47.365"></a><span id="l47.365" class="difflineplus">+    return target;</span>
<a href="#l47.366"></a><span id="l47.366" class="difflineplus">+};</span>
<a href="#l47.367"></a><span id="l47.367" class="difflineplus">+</span>
<a href="#l47.368"></a><span id="l47.368" class="difflineplus">+/**</span>
<a href="#l47.369"></a><span id="l47.369" class="difflineplus">+ * Run polyfills to add Array.map and Array.filter if they are missing.</span>
<a href="#l47.370"></a><span id="l47.370" class="difflineplus">+ */</span>
<a href="#l47.371"></a><span id="l47.371" class="difflineplus">+module.exports.runPolyfills = function() {</span>
<a href="#l47.372"></a><span id="l47.372" class="difflineplus">+    //                Array.prototype.filter</span>
<a href="#l47.373"></a><span id="l47.373" class="difflineplus">+    // ========================================================</span>
<a href="#l47.374"></a><span id="l47.374" class="difflineplus">+    // SOURCE:</span>
<a href="#l47.375"></a><span id="l47.375" class="difflineplus">+    // https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/filter</span>
<a href="#l47.376"></a><span id="l47.376" class="difflineplus">+    if (!Array.prototype.filter) {</span>
<a href="#l47.377"></a><span id="l47.377" class="difflineplus">+      Array.prototype.filter = function(fun/*, thisArg*/) {</span>
<a href="#l47.378"></a><span id="l47.378" class="difflineplus">+</span>
<a href="#l47.379"></a><span id="l47.379" class="difflineplus">+        if (this === void 0 || this === null) {</span>
<a href="#l47.380"></a><span id="l47.380" class="difflineplus">+          throw new TypeError();</span>
<a href="#l47.381"></a><span id="l47.381" class="difflineplus">+        }</span>
<a href="#l47.382"></a><span id="l47.382" class="difflineplus">+</span>
<a href="#l47.383"></a><span id="l47.383" class="difflineplus">+        var t = Object(this);</span>
<a href="#l47.384"></a><span id="l47.384" class="difflineplus">+        var len = t.length &gt;&gt;&gt; 0;</span>
<a href="#l47.385"></a><span id="l47.385" class="difflineplus">+        if (typeof fun !== 'function') {</span>
<a href="#l47.386"></a><span id="l47.386" class="difflineplus">+          throw new TypeError();</span>
<a href="#l47.387"></a><span id="l47.387" class="difflineplus">+        }</span>
<a href="#l47.388"></a><span id="l47.388" class="difflineplus">+</span>
<a href="#l47.389"></a><span id="l47.389" class="difflineplus">+        var res = [];</span>
<a href="#l47.390"></a><span id="l47.390" class="difflineplus">+        var thisArg = arguments.length &gt;= 2 ? arguments[1] : void 0;</span>
<a href="#l47.391"></a><span id="l47.391" class="difflineplus">+        for (var i = 0; i &lt; len; i++) {</span>
<a href="#l47.392"></a><span id="l47.392" class="difflineplus">+          if (i in t) {</span>
<a href="#l47.393"></a><span id="l47.393" class="difflineplus">+            var val = t[i];</span>
<a href="#l47.394"></a><span id="l47.394" class="difflineplus">+</span>
<a href="#l47.395"></a><span id="l47.395" class="difflineplus">+            // NOTE: Technically this should Object.defineProperty at</span>
<a href="#l47.396"></a><span id="l47.396" class="difflineplus">+            //       the next index, as push can be affected by</span>
<a href="#l47.397"></a><span id="l47.397" class="difflineplus">+            //       properties on Object.prototype and Array.prototype.</span>
<a href="#l47.398"></a><span id="l47.398" class="difflineplus">+            //       But that method's new, and collisions should be</span>
<a href="#l47.399"></a><span id="l47.399" class="difflineplus">+            //       rare, so use the more-compatible alternative.</span>
<a href="#l47.400"></a><span id="l47.400" class="difflineplus">+            if (fun.call(thisArg, val, i, t)) {</span>
<a href="#l47.401"></a><span id="l47.401" class="difflineplus">+              res.push(val);</span>
<a href="#l47.402"></a><span id="l47.402" class="difflineplus">+            }</span>
<a href="#l47.403"></a><span id="l47.403" class="difflineplus">+          }</span>
<a href="#l47.404"></a><span id="l47.404" class="difflineplus">+        }</span>
<a href="#l47.405"></a><span id="l47.405" class="difflineplus">+</span>
<a href="#l47.406"></a><span id="l47.406" class="difflineplus">+        return res;</span>
<a href="#l47.407"></a><span id="l47.407" class="difflineplus">+      };</span>
<a href="#l47.408"></a><span id="l47.408" class="difflineplus">+    }</span>
<a href="#l47.409"></a><span id="l47.409" class="difflineplus">+</span>
<a href="#l47.410"></a><span id="l47.410" class="difflineplus">+    //                Array.prototype.map</span>
<a href="#l47.411"></a><span id="l47.411" class="difflineplus">+    // ========================================================</span>
<a href="#l47.412"></a><span id="l47.412" class="difflineplus">+    // SOURCE:</span>
<a href="#l47.413"></a><span id="l47.413" class="difflineplus">+    // https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/map</span>
<a href="#l47.414"></a><span id="l47.414" class="difflineplus">+    // Production steps of ECMA-262, Edition 5, 15.4.4.19</span>
<a href="#l47.415"></a><span id="l47.415" class="difflineplus">+    // Reference: http://es5.github.io/#x15.4.4.19</span>
<a href="#l47.416"></a><span id="l47.416" class="difflineplus">+    if (!Array.prototype.map) {</span>
<a href="#l47.417"></a><span id="l47.417" class="difflineplus">+</span>
<a href="#l47.418"></a><span id="l47.418" class="difflineplus">+      Array.prototype.map = function(callback, thisArg) {</span>
<a href="#l47.419"></a><span id="l47.419" class="difflineplus">+</span>
<a href="#l47.420"></a><span id="l47.420" class="difflineplus">+        var T, A, k;</span>
<a href="#l47.421"></a><span id="l47.421" class="difflineplus">+</span>
<a href="#l47.422"></a><span id="l47.422" class="difflineplus">+        if (this === null || this === undefined) {</span>
<a href="#l47.423"></a><span id="l47.423" class="difflineplus">+          throw new TypeError(' this is null or not defined');</span>
<a href="#l47.424"></a><span id="l47.424" class="difflineplus">+        }</span>
<a href="#l47.425"></a><span id="l47.425" class="difflineplus">+</span>
<a href="#l47.426"></a><span id="l47.426" class="difflineplus">+        // 1. Let O be the result of calling ToObject passing the |this|</span>
<a href="#l47.427"></a><span id="l47.427" class="difflineplus">+        //    value as the argument.</span>
<a href="#l47.428"></a><span id="l47.428" class="difflineplus">+        var O = Object(this);</span>
<a href="#l47.429"></a><span id="l47.429" class="difflineplus">+</span>
<a href="#l47.430"></a><span id="l47.430" class="difflineplus">+        // 2. Let lenValue be the result of calling the Get internal</span>
<a href="#l47.431"></a><span id="l47.431" class="difflineplus">+        //    method of O with the argument &quot;length&quot;.</span>
<a href="#l47.432"></a><span id="l47.432" class="difflineplus">+        // 3. Let len be ToUint32(lenValue).</span>
<a href="#l47.433"></a><span id="l47.433" class="difflineplus">+        var len = O.length &gt;&gt;&gt; 0;</span>
<a href="#l47.434"></a><span id="l47.434" class="difflineplus">+</span>
<a href="#l47.435"></a><span id="l47.435" class="difflineplus">+        // 4. If IsCallable(callback) is false, throw a TypeError exception.</span>
<a href="#l47.436"></a><span id="l47.436" class="difflineplus">+        // See: http://es5.github.com/#x9.11</span>
<a href="#l47.437"></a><span id="l47.437" class="difflineplus">+        if (typeof callback !== 'function') {</span>
<a href="#l47.438"></a><span id="l47.438" class="difflineplus">+          throw new TypeError(callback + ' is not a function');</span>
<a href="#l47.439"></a><span id="l47.439" class="difflineplus">+        }</span>
<a href="#l47.440"></a><span id="l47.440" class="difflineplus">+</span>
<a href="#l47.441"></a><span id="l47.441" class="difflineplus">+        // 5. If thisArg was supplied, let T be thisArg; else let T be undefined.</span>
<a href="#l47.442"></a><span id="l47.442" class="difflineplus">+        if (arguments.length &gt; 1) {</span>
<a href="#l47.443"></a><span id="l47.443" class="difflineplus">+          T = thisArg;</span>
<a href="#l47.444"></a><span id="l47.444" class="difflineplus">+        }</span>
<a href="#l47.445"></a><span id="l47.445" class="difflineplus">+</span>
<a href="#l47.446"></a><span id="l47.446" class="difflineplus">+        // 6. Let A be a new array created as if by the expression new Array(len)</span>
<a href="#l47.447"></a><span id="l47.447" class="difflineplus">+        //    where Array is the standard built-in constructor with that name and</span>
<a href="#l47.448"></a><span id="l47.448" class="difflineplus">+        //    len is the value of len.</span>
<a href="#l47.449"></a><span id="l47.449" class="difflineplus">+        A = new Array(len);</span>
<a href="#l47.450"></a><span id="l47.450" class="difflineplus">+</span>
<a href="#l47.451"></a><span id="l47.451" class="difflineplus">+        // 7. Let k be 0</span>
<a href="#l47.452"></a><span id="l47.452" class="difflineplus">+        k = 0;</span>
<a href="#l47.453"></a><span id="l47.453" class="difflineplus">+</span>
<a href="#l47.454"></a><span id="l47.454" class="difflineplus">+        // 8. Repeat, while k &lt; len</span>
<a href="#l47.455"></a><span id="l47.455" class="difflineplus">+        while (k &lt; len) {</span>
<a href="#l47.456"></a><span id="l47.456" class="difflineplus">+</span>
<a href="#l47.457"></a><span id="l47.457" class="difflineplus">+          var kValue, mappedValue;</span>
<a href="#l47.458"></a><span id="l47.458" class="difflineplus">+</span>
<a href="#l47.459"></a><span id="l47.459" class="difflineplus">+          // a. Let Pk be ToString(k).</span>
<a href="#l47.460"></a><span id="l47.460" class="difflineplus">+          //   This is implicit for LHS operands of the in operator</span>
<a href="#l47.461"></a><span id="l47.461" class="difflineplus">+          // b. Let kPresent be the result of calling the HasProperty internal</span>
<a href="#l47.462"></a><span id="l47.462" class="difflineplus">+          //    method of O with argument Pk.</span>
<a href="#l47.463"></a><span id="l47.463" class="difflineplus">+          //   This step can be combined with c</span>
<a href="#l47.464"></a><span id="l47.464" class="difflineplus">+          // c. If kPresent is true, then</span>
<a href="#l47.465"></a><span id="l47.465" class="difflineplus">+          if (k in O) {</span>
<a href="#l47.466"></a><span id="l47.466" class="difflineplus">+</span>
<a href="#l47.467"></a><span id="l47.467" class="difflineplus">+            // i. Let kValue be the result of calling the Get internal</span>
<a href="#l47.468"></a><span id="l47.468" class="difflineplus">+            //    method of O with argument Pk.</span>
<a href="#l47.469"></a><span id="l47.469" class="difflineplus">+            kValue = O[k];</span>
<a href="#l47.470"></a><span id="l47.470" class="difflineplus">+</span>
<a href="#l47.471"></a><span id="l47.471" class="difflineplus">+            // ii. Let mappedValue be the result of calling the Call internal</span>
<a href="#l47.472"></a><span id="l47.472" class="difflineplus">+            //     method of callback with T as the this value and argument</span>
<a href="#l47.473"></a><span id="l47.473" class="difflineplus">+            //     list containing kValue, k, and O.</span>
<a href="#l47.474"></a><span id="l47.474" class="difflineplus">+            mappedValue = callback.call(T, kValue, k, O);</span>
<a href="#l47.475"></a><span id="l47.475" class="difflineplus">+</span>
<a href="#l47.476"></a><span id="l47.476" class="difflineplus">+            // iii. Call the DefineOwnProperty internal method of A with arguments</span>
<a href="#l47.477"></a><span id="l47.477" class="difflineplus">+            // Pk, Property Descriptor</span>
<a href="#l47.478"></a><span id="l47.478" class="difflineplus">+            // { Value: mappedValue,</span>
<a href="#l47.479"></a><span id="l47.479" class="difflineplus">+            //   Writable: true,</span>
<a href="#l47.480"></a><span id="l47.480" class="difflineplus">+            //   Enumerable: true,</span>
<a href="#l47.481"></a><span id="l47.481" class="difflineplus">+            //   Configurable: true },</span>
<a href="#l47.482"></a><span id="l47.482" class="difflineplus">+            // and false.</span>
<a href="#l47.483"></a><span id="l47.483" class="difflineplus">+</span>
<a href="#l47.484"></a><span id="l47.484" class="difflineplus">+            // In browsers that support Object.defineProperty, use the following:</span>
<a href="#l47.485"></a><span id="l47.485" class="difflineplus">+            // Object.defineProperty(A, k, {</span>
<a href="#l47.486"></a><span id="l47.486" class="difflineplus">+            //   value: mappedValue,</span>
<a href="#l47.487"></a><span id="l47.487" class="difflineplus">+            //   writable: true,</span>
<a href="#l47.488"></a><span id="l47.488" class="difflineplus">+            //   enumerable: true,</span>
<a href="#l47.489"></a><span id="l47.489" class="difflineplus">+            //   configurable: true</span>
<a href="#l47.490"></a><span id="l47.490" class="difflineplus">+            // });</span>
<a href="#l47.491"></a><span id="l47.491" class="difflineplus">+</span>
<a href="#l47.492"></a><span id="l47.492" class="difflineplus">+            // For best browser support, use the following:</span>
<a href="#l47.493"></a><span id="l47.493" class="difflineplus">+            A[k] = mappedValue;</span>
<a href="#l47.494"></a><span id="l47.494" class="difflineplus">+          }</span>
<a href="#l47.495"></a><span id="l47.495" class="difflineplus">+          // d. Increase k by 1.</span>
<a href="#l47.496"></a><span id="l47.496" class="difflineplus">+          k++;</span>
<a href="#l47.497"></a><span id="l47.497" class="difflineplus">+        }</span>
<a href="#l47.498"></a><span id="l47.498" class="difflineplus">+</span>
<a href="#l47.499"></a><span id="l47.499" class="difflineplus">+        // 9. return A</span>
<a href="#l47.500"></a><span id="l47.500" class="difflineplus">+        return A;</span>
<a href="#l47.501"></a><span id="l47.501" class="difflineplus">+      };</span>
<a href="#l47.502"></a><span id="l47.502" class="difflineplus">+    }</span>
<a href="#l47.503"></a><span id="l47.503" class="difflineplus">+</span>
<a href="#l47.504"></a><span id="l47.504" class="difflineplus">+    //                Array.prototype.forEach</span>
<a href="#l47.505"></a><span id="l47.505" class="difflineplus">+    // ========================================================</span>
<a href="#l47.506"></a><span id="l47.506" class="difflineplus">+    // SOURCE:</span>
<a href="#l47.507"></a><span id="l47.507" class="difflineplus">+  // https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/forEach</span>
<a href="#l47.508"></a><span id="l47.508" class="difflineplus">+    // Production steps of ECMA-262, Edition 5, 15.4.4.18</span>
<a href="#l47.509"></a><span id="l47.509" class="difflineplus">+    // Reference: http://es5.github.io/#x15.4.4.18</span>
<a href="#l47.510"></a><span id="l47.510" class="difflineplus">+    if (!Array.prototype.forEach) {</span>
<a href="#l47.511"></a><span id="l47.511" class="difflineplus">+</span>
<a href="#l47.512"></a><span id="l47.512" class="difflineplus">+      Array.prototype.forEach = function(callback, thisArg) {</span>
<a href="#l47.513"></a><span id="l47.513" class="difflineplus">+</span>
<a href="#l47.514"></a><span id="l47.514" class="difflineplus">+        var T, k;</span>
<a href="#l47.515"></a><span id="l47.515" class="difflineplus">+</span>
<a href="#l47.516"></a><span id="l47.516" class="difflineplus">+        if (this === null || this === undefined) {</span>
<a href="#l47.517"></a><span id="l47.517" class="difflineplus">+          throw new TypeError(' this is null or not defined');</span>
<a href="#l47.518"></a><span id="l47.518" class="difflineplus">+        }</span>
<a href="#l47.519"></a><span id="l47.519" class="difflineplus">+</span>
<a href="#l47.520"></a><span id="l47.520" class="difflineplus">+        // 1. Let O be the result of calling ToObject passing the |this| value as the</span>
<a href="#l47.521"></a><span id="l47.521" class="difflineplus">+        // argument.</span>
<a href="#l47.522"></a><span id="l47.522" class="difflineplus">+        var O = Object(this);</span>
<a href="#l47.523"></a><span id="l47.523" class="difflineplus">+</span>
<a href="#l47.524"></a><span id="l47.524" class="difflineplus">+        // 2. Let lenValue be the result of calling the Get internal method of O with the</span>
<a href="#l47.525"></a><span id="l47.525" class="difflineplus">+        // argument &quot;length&quot;.</span>
<a href="#l47.526"></a><span id="l47.526" class="difflineplus">+        // 3. Let len be ToUint32(lenValue).</span>
<a href="#l47.527"></a><span id="l47.527" class="difflineplus">+        var len = O.length &gt;&gt;&gt; 0;</span>
<a href="#l47.528"></a><span id="l47.528" class="difflineplus">+</span>
<a href="#l47.529"></a><span id="l47.529" class="difflineplus">+        // 4. If IsCallable(callback) is false, throw a TypeError exception.</span>
<a href="#l47.530"></a><span id="l47.530" class="difflineplus">+        // See: http://es5.github.com/#x9.11</span>
<a href="#l47.531"></a><span id="l47.531" class="difflineplus">+        if (typeof callback !== &quot;function&quot;) {</span>
<a href="#l47.532"></a><span id="l47.532" class="difflineplus">+          throw new TypeError(callback + ' is not a function');</span>
<a href="#l47.533"></a><span id="l47.533" class="difflineplus">+        }</span>
<a href="#l47.534"></a><span id="l47.534" class="difflineplus">+</span>
<a href="#l47.535"></a><span id="l47.535" class="difflineplus">+        // 5. If thisArg was supplied, let T be thisArg; else let T be undefined.</span>
<a href="#l47.536"></a><span id="l47.536" class="difflineplus">+        if (arguments.length &gt; 1) {</span>
<a href="#l47.537"></a><span id="l47.537" class="difflineplus">+          T = thisArg;</span>
<a href="#l47.538"></a><span id="l47.538" class="difflineplus">+        }</span>
<a href="#l47.539"></a><span id="l47.539" class="difflineplus">+</span>
<a href="#l47.540"></a><span id="l47.540" class="difflineplus">+        // 6. Let k be 0</span>
<a href="#l47.541"></a><span id="l47.541" class="difflineplus">+        k = 0;</span>
<a href="#l47.542"></a><span id="l47.542" class="difflineplus">+</span>
<a href="#l47.543"></a><span id="l47.543" class="difflineplus">+        // 7. Repeat, while k &lt; len</span>
<a href="#l47.544"></a><span id="l47.544" class="difflineplus">+        while (k &lt; len) {</span>
<a href="#l47.545"></a><span id="l47.545" class="difflineplus">+</span>
<a href="#l47.546"></a><span id="l47.546" class="difflineplus">+          var kValue;</span>
<a href="#l47.547"></a><span id="l47.547" class="difflineplus">+</span>
<a href="#l47.548"></a><span id="l47.548" class="difflineplus">+          // a. Let Pk be ToString(k).</span>
<a href="#l47.549"></a><span id="l47.549" class="difflineplus">+          //   This is implicit for LHS operands of the in operator</span>
<a href="#l47.550"></a><span id="l47.550" class="difflineplus">+          // b. Let kPresent be the result of calling the HasProperty internal</span>
<a href="#l47.551"></a><span id="l47.551" class="difflineplus">+          //    method of O with</span>
<a href="#l47.552"></a><span id="l47.552" class="difflineplus">+          //    argument Pk.</span>
<a href="#l47.553"></a><span id="l47.553" class="difflineplus">+          //   This step can be combined with c</span>
<a href="#l47.554"></a><span id="l47.554" class="difflineplus">+          // c. If kPresent is true, then</span>
<a href="#l47.555"></a><span id="l47.555" class="difflineplus">+          if (k in O) {</span>
<a href="#l47.556"></a><span id="l47.556" class="difflineplus">+</span>
<a href="#l47.557"></a><span id="l47.557" class="difflineplus">+            // i. Let kValue be the result of calling the Get internal method of O with</span>
<a href="#l47.558"></a><span id="l47.558" class="difflineplus">+            // argument Pk</span>
<a href="#l47.559"></a><span id="l47.559" class="difflineplus">+            kValue = O[k];</span>
<a href="#l47.560"></a><span id="l47.560" class="difflineplus">+</span>
<a href="#l47.561"></a><span id="l47.561" class="difflineplus">+            // ii. Call the Call internal method of callback with T as the this value and</span>
<a href="#l47.562"></a><span id="l47.562" class="difflineplus">+            // argument list containing kValue, k, and O.</span>
<a href="#l47.563"></a><span id="l47.563" class="difflineplus">+            callback.call(T, kValue, k, O);</span>
<a href="#l47.564"></a><span id="l47.564" class="difflineplus">+          }</span>
<a href="#l47.565"></a><span id="l47.565" class="difflineplus">+          // d. Increase k by 1.</span>
<a href="#l47.566"></a><span id="l47.566" class="difflineplus">+          k++;</span>
<a href="#l47.567"></a><span id="l47.567" class="difflineplus">+        }</span>
<a href="#l47.568"></a><span id="l47.568" class="difflineplus">+        // 8. return undefined</span>
<a href="#l47.569"></a><span id="l47.569" class="difflineplus">+      };</span>
<a href="#l47.570"></a><span id="l47.570" class="difflineplus">+    }</span>
<a href="#l47.571"></a><span id="l47.571" class="difflineplus">+};</span>
<a href="#l47.572"></a><span id="l47.572" class="difflineplus">+</span>
<a href="#l47.573"></a><span id="l47.573" class="difflineplus">+/**</span>
<a href="#l47.574"></a><span id="l47.574" class="difflineplus">+ * Inherit the prototype methods from one constructor into another. This is a</span>
<a href="#l47.575"></a><span id="l47.575" class="difflineplus">+ * port of the Node.js implementation with an Object.create polyfill.</span>
<a href="#l47.576"></a><span id="l47.576" class="difflineplus">+ *</span>
<a href="#l47.577"></a><span id="l47.577" class="difflineplus">+ * @param {function} ctor Constructor function which needs to inherit the</span>
<a href="#l47.578"></a><span id="l47.578" class="difflineplus">+ *     prototype.</span>
<a href="#l47.579"></a><span id="l47.579" class="difflineplus">+ * @param {function} superCtor Constructor function to inherit prototype from.</span>
<a href="#l47.580"></a><span id="l47.580" class="difflineplus">+ */</span>
<a href="#l47.581"></a><span id="l47.581" class="difflineplus">+module.exports.inherits = function(ctor, superCtor) {</span>
<a href="#l47.582"></a><span id="l47.582" class="difflineplus">+    // Add Object.create polyfill for IE8</span>
<a href="#l47.583"></a><span id="l47.583" class="difflineplus">+    // Source:</span>
<a href="#l47.584"></a><span id="l47.584" class="difflineplus">+    // https://developer.mozilla.org/en-US/docs/Web/JavaScript</span>
<a href="#l47.585"></a><span id="l47.585" class="difflineplus">+    // /Reference/Global_Objects/Object/create#Polyfill</span>
<a href="#l47.586"></a><span id="l47.586" class="difflineplus">+    if (typeof Object.create != 'function') {</span>
<a href="#l47.587"></a><span id="l47.587" class="difflineplus">+      // Production steps of ECMA-262, Edition 5, 15.2.3.5</span>
<a href="#l47.588"></a><span id="l47.588" class="difflineplus">+      // Reference: http://es5.github.io/#x15.2.3.5</span>
<a href="#l47.589"></a><span id="l47.589" class="difflineplus">+      Object.create = (function() {</span>
<a href="#l47.590"></a><span id="l47.590" class="difflineplus">+        // To save on memory, use a shared constructor</span>
<a href="#l47.591"></a><span id="l47.591" class="difflineplus">+        function Temp() {}</span>
<a href="#l47.592"></a><span id="l47.592" class="difflineplus">+</span>
<a href="#l47.593"></a><span id="l47.593" class="difflineplus">+        // make a safe reference to Object.prototype.hasOwnProperty</span>
<a href="#l47.594"></a><span id="l47.594" class="difflineplus">+        var hasOwn = Object.prototype.hasOwnProperty;</span>
<a href="#l47.595"></a><span id="l47.595" class="difflineplus">+</span>
<a href="#l47.596"></a><span id="l47.596" class="difflineplus">+        return function(O) {</span>
<a href="#l47.597"></a><span id="l47.597" class="difflineplus">+          // 1. If Type(O) is not Object or Null throw a TypeError exception.</span>
<a href="#l47.598"></a><span id="l47.598" class="difflineplus">+          if (typeof O != 'object') {</span>
<a href="#l47.599"></a><span id="l47.599" class="difflineplus">+            throw new TypeError('Object prototype may only be an Object or null');</span>
<a href="#l47.600"></a><span id="l47.600" class="difflineplus">+          }</span>
<a href="#l47.601"></a><span id="l47.601" class="difflineplus">+</span>
<a href="#l47.602"></a><span id="l47.602" class="difflineplus">+          // 2. Let obj be the result of creating a new object as if by the</span>
<a href="#l47.603"></a><span id="l47.603" class="difflineplus">+          //    expression new Object() where Object is the standard built-in</span>
<a href="#l47.604"></a><span id="l47.604" class="difflineplus">+          //    constructor with that name</span>
<a href="#l47.605"></a><span id="l47.605" class="difflineplus">+          // 3. Set the [[Prototype]] internal property of obj to O.</span>
<a href="#l47.606"></a><span id="l47.606" class="difflineplus">+          Temp.prototype = O;</span>
<a href="#l47.607"></a><span id="l47.607" class="difflineplus">+          var obj = new Temp();</span>
<a href="#l47.608"></a><span id="l47.608" class="difflineplus">+          Temp.prototype = null; // Let's not keep a stray reference to O...</span>
<a href="#l47.609"></a><span id="l47.609" class="difflineplus">+</span>
<a href="#l47.610"></a><span id="l47.610" class="difflineplus">+          // 4. If the argument Properties is present and not undefined, add</span>
<a href="#l47.611"></a><span id="l47.611" class="difflineplus">+          //    own properties to obj as if by calling the standard built-in</span>
<a href="#l47.612"></a><span id="l47.612" class="difflineplus">+          //    function Object.defineProperties with arguments obj and</span>
<a href="#l47.613"></a><span id="l47.613" class="difflineplus">+          //    Properties.</span>
<a href="#l47.614"></a><span id="l47.614" class="difflineplus">+          if (arguments.length &gt; 1) {</span>
<a href="#l47.615"></a><span id="l47.615" class="difflineplus">+            // Object.defineProperties does ToObject on its first argument.</span>
<a href="#l47.616"></a><span id="l47.616" class="difflineplus">+            var Properties = Object(arguments[1]);</span>
<a href="#l47.617"></a><span id="l47.617" class="difflineplus">+            for (var prop in Properties) {</span>
<a href="#l47.618"></a><span id="l47.618" class="difflineplus">+              if (hasOwn.call(Properties, prop)) {</span>
<a href="#l47.619"></a><span id="l47.619" class="difflineplus">+                obj[prop] = Properties[prop];</span>
<a href="#l47.620"></a><span id="l47.620" class="difflineplus">+              }</span>
<a href="#l47.621"></a><span id="l47.621" class="difflineplus">+            }</span>
<a href="#l47.622"></a><span id="l47.622" class="difflineplus">+          }</span>
<a href="#l47.623"></a><span id="l47.623" class="difflineplus">+</span>
<a href="#l47.624"></a><span id="l47.624" class="difflineplus">+          // 5. Return obj</span>
<a href="#l47.625"></a><span id="l47.625" class="difflineplus">+          return obj;</span>
<a href="#l47.626"></a><span id="l47.626" class="difflineplus">+        };</span>
<a href="#l47.627"></a><span id="l47.627" class="difflineplus">+      })();</span>
<a href="#l47.628"></a><span id="l47.628" class="difflineplus">+    }</span>
<a href="#l47.629"></a><span id="l47.629" class="difflineplus">+    // END polyfill</span>
<a href="#l47.630"></a><span id="l47.630" class="difflineplus">+</span>
<a href="#l47.631"></a><span id="l47.631" class="difflineplus">+    // Add util.inherits from Node.js</span>
<a href="#l47.632"></a><span id="l47.632" class="difflineplus">+    // Source:</span>
<a href="#l47.633"></a><span id="l47.633" class="difflineplus">+    // https://github.com/joyent/node/blob/master/lib/util.js</span>
<a href="#l47.634"></a><span id="l47.634" class="difflineplus">+    // Copyright Joyent, Inc. and other Node contributors.</span>
<a href="#l47.635"></a><span id="l47.635" class="difflineplus">+    //</span>
<a href="#l47.636"></a><span id="l47.636" class="difflineplus">+    // Permission is hereby granted, free of charge, to any person obtaining a</span>
<a href="#l47.637"></a><span id="l47.637" class="difflineplus">+    // copy of this software and associated documentation files (the</span>
<a href="#l47.638"></a><span id="l47.638" class="difflineplus">+    // &quot;Software&quot;), to deal in the Software without restriction, including</span>
<a href="#l47.639"></a><span id="l47.639" class="difflineplus">+    // without limitation the rights to use, copy, modify, merge, publish,</span>
<a href="#l47.640"></a><span id="l47.640" class="difflineplus">+    // distribute, sublicense, and/or sell copies of the Software, and to permit</span>
<a href="#l47.641"></a><span id="l47.641" class="difflineplus">+    // persons to whom the Software is furnished to do so, subject to the</span>
<a href="#l47.642"></a><span id="l47.642" class="difflineplus">+    // following conditions:</span>
<a href="#l47.643"></a><span id="l47.643" class="difflineplus">+    //</span>
<a href="#l47.644"></a><span id="l47.644" class="difflineplus">+    // The above copyright notice and this permission notice shall be included</span>
<a href="#l47.645"></a><span id="l47.645" class="difflineplus">+    // in all copies or substantial portions of the Software.</span>
<a href="#l47.646"></a><span id="l47.646" class="difflineplus">+    //</span>
<a href="#l47.647"></a><span id="l47.647" class="difflineplus">+    // THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS</span>
<a href="#l47.648"></a><span id="l47.648" class="difflineplus">+    // OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF</span>
<a href="#l47.649"></a><span id="l47.649" class="difflineplus">+    // MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN</span>
<a href="#l47.650"></a><span id="l47.650" class="difflineplus">+    // NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,</span>
<a href="#l47.651"></a><span id="l47.651" class="difflineplus">+    // DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR</span>
<a href="#l47.652"></a><span id="l47.652" class="difflineplus">+    // OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE</span>
<a href="#l47.653"></a><span id="l47.653" class="difflineplus">+    // USE OR OTHER DEALINGS IN THE SOFTWARE.</span>
<a href="#l47.654"></a><span id="l47.654" class="difflineplus">+    ctor.super_ = superCtor;</span>
<a href="#l47.655"></a><span id="l47.655" class="difflineplus">+    ctor.prototype = Object.create(superCtor.prototype, {</span>
<a href="#l47.656"></a><span id="l47.656" class="difflineplus">+        constructor: {</span>
<a href="#l47.657"></a><span id="l47.657" class="difflineplus">+            value: ctor,</span>
<a href="#l47.658"></a><span id="l47.658" class="difflineplus">+            enumerable: false,</span>
<a href="#l47.659"></a><span id="l47.659" class="difflineplus">+            writable: true,</span>
<a href="#l47.660"></a><span id="l47.660" class="difflineplus">+            configurable: true</span>
<a href="#l47.661"></a><span id="l47.661" class="difflineplus">+        }</span>
<a href="#l47.662"></a><span id="l47.662" class="difflineplus">+    });</span>
<a href="#l47.663"></a><span id="l47.663" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l48.1"></a><span id="l48.1">new file mode 100644</span>
<a href="#l48.2"></a><span id="l48.2" class="difflineminus">--- /dev/null</span>
<a href="#l48.3"></a><span id="l48.3" class="difflineplus">+++ b/chat/protocols/matrix/matrix-sdk/webrtc/call.js</span>
<a href="#l48.4"></a><span id="l48.4" class="difflineat">@@ -0,0 +1,1281 @@</span>
<a href="#l48.5"></a><span id="l48.5" class="difflineplus">+/*</span>
<a href="#l48.6"></a><span id="l48.6" class="difflineplus">+Copyright 2015, 2016 OpenMarket Ltd</span>
<a href="#l48.7"></a><span id="l48.7" class="difflineplus">+</span>
<a href="#l48.8"></a><span id="l48.8" class="difflineplus">+Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<a href="#l48.9"></a><span id="l48.9" class="difflineplus">+you may not use this file except in compliance with the License.</span>
<a href="#l48.10"></a><span id="l48.10" class="difflineplus">+You may obtain a copy of the License at</span>
<a href="#l48.11"></a><span id="l48.11" class="difflineplus">+</span>
<a href="#l48.12"></a><span id="l48.12" class="difflineplus">+    http://www.apache.org/licenses/LICENSE-2.0</span>
<a href="#l48.13"></a><span id="l48.13" class="difflineplus">+</span>
<a href="#l48.14"></a><span id="l48.14" class="difflineplus">+Unless required by applicable law or agreed to in writing, software</span>
<a href="#l48.15"></a><span id="l48.15" class="difflineplus">+distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<a href="#l48.16"></a><span id="l48.16" class="difflineplus">+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<a href="#l48.17"></a><span id="l48.17" class="difflineplus">+See the License for the specific language governing permissions and</span>
<a href="#l48.18"></a><span id="l48.18" class="difflineplus">+limitations under the License.</span>
<a href="#l48.19"></a><span id="l48.19" class="difflineplus">+*/</span>
<a href="#l48.20"></a><span id="l48.20" class="difflineplus">+&quot;use strict&quot;;</span>
<a href="#l48.21"></a><span id="l48.21" class="difflineplus">+/**</span>
<a href="#l48.22"></a><span id="l48.22" class="difflineplus">+ * This is an internal module. See {@link createNewMatrixCall} for the public API.</span>
<a href="#l48.23"></a><span id="l48.23" class="difflineplus">+ * @module webrtc/call</span>
<a href="#l48.24"></a><span id="l48.24" class="difflineplus">+ */</span>
<a href="#l48.25"></a><span id="l48.25" class="difflineplus">+var utils = require(&quot;../utils&quot;);</span>
<a href="#l48.26"></a><span id="l48.26" class="difflineplus">+var EventEmitter = require(&quot;events&quot;).EventEmitter;</span>
<a href="#l48.27"></a><span id="l48.27" class="difflineplus">+var DEBUG = true;  // set true to enable console logging.</span>
<a href="#l48.28"></a><span id="l48.28" class="difflineplus">+</span>
<a href="#l48.29"></a><span id="l48.29" class="difflineplus">+// events: hangup, error(err), replaced(call), state(state, oldState)</span>
<a href="#l48.30"></a><span id="l48.30" class="difflineplus">+</span>
<a href="#l48.31"></a><span id="l48.31" class="difflineplus">+/**</span>
<a href="#l48.32"></a><span id="l48.32" class="difflineplus">+ * Construct a new Matrix Call.</span>
<a href="#l48.33"></a><span id="l48.33" class="difflineplus">+ * @constructor</span>
<a href="#l48.34"></a><span id="l48.34" class="difflineplus">+ * @param {Object} opts Config options.</span>
<a href="#l48.35"></a><span id="l48.35" class="difflineplus">+ * @param {string} opts.roomId The room ID for this call.</span>
<a href="#l48.36"></a><span id="l48.36" class="difflineplus">+ * @param {Object} opts.webRtc The WebRTC globals from the browser.</span>
<a href="#l48.37"></a><span id="l48.37" class="difflineplus">+ * @param {Object} opts.URL The URL global.</span>
<a href="#l48.38"></a><span id="l48.38" class="difflineplus">+ * @param {Array&lt;Object&gt;} opts.turnServers Optional. A list of TURN servers.</span>
<a href="#l48.39"></a><span id="l48.39" class="difflineplus">+ * @param {MatrixClient} opts.client The Matrix Client instance to send events to.</span>
<a href="#l48.40"></a><span id="l48.40" class="difflineplus">+ */</span>
<a href="#l48.41"></a><span id="l48.41" class="difflineplus">+function MatrixCall(opts) {</span>
<a href="#l48.42"></a><span id="l48.42" class="difflineplus">+    this.roomId = opts.roomId;</span>
<a href="#l48.43"></a><span id="l48.43" class="difflineplus">+    this.client = opts.client;</span>
<a href="#l48.44"></a><span id="l48.44" class="difflineplus">+    this.webRtc = opts.webRtc;</span>
<a href="#l48.45"></a><span id="l48.45" class="difflineplus">+    this.URL = opts.URL;</span>
<a href="#l48.46"></a><span id="l48.46" class="difflineplus">+    // Array of Objects with urls, username, credential keys</span>
<a href="#l48.47"></a><span id="l48.47" class="difflineplus">+    this.turnServers = opts.turnServers || [];</span>
<a href="#l48.48"></a><span id="l48.48" class="difflineplus">+    if (this.turnServers.length === 0) {</span>
<a href="#l48.49"></a><span id="l48.49" class="difflineplus">+        this.turnServers.push({</span>
<a href="#l48.50"></a><span id="l48.50" class="difflineplus">+            urls: [MatrixCall.FALLBACK_STUN_SERVER]</span>
<a href="#l48.51"></a><span id="l48.51" class="difflineplus">+        });</span>
<a href="#l48.52"></a><span id="l48.52" class="difflineplus">+    }</span>
<a href="#l48.53"></a><span id="l48.53" class="difflineplus">+    utils.forEach(this.turnServers, function(server) {</span>
<a href="#l48.54"></a><span id="l48.54" class="difflineplus">+        utils.checkObjectHasKeys(server, [&quot;urls&quot;]);</span>
<a href="#l48.55"></a><span id="l48.55" class="difflineplus">+    });</span>
<a href="#l48.56"></a><span id="l48.56" class="difflineplus">+</span>
<a href="#l48.57"></a><span id="l48.57" class="difflineplus">+    this.callId = &quot;c&quot; + new Date().getTime();</span>
<a href="#l48.58"></a><span id="l48.58" class="difflineplus">+    this.state = 'fledgling';</span>
<a href="#l48.59"></a><span id="l48.59" class="difflineplus">+    this.didConnect = false;</span>
<a href="#l48.60"></a><span id="l48.60" class="difflineplus">+</span>
<a href="#l48.61"></a><span id="l48.61" class="difflineplus">+    // A queue for candidates waiting to go out.</span>
<a href="#l48.62"></a><span id="l48.62" class="difflineplus">+    // We try to amalgamate candidates into a single candidate message where</span>
<a href="#l48.63"></a><span id="l48.63" class="difflineplus">+    // possible</span>
<a href="#l48.64"></a><span id="l48.64" class="difflineplus">+    this.candidateSendQueue = [];</span>
<a href="#l48.65"></a><span id="l48.65" class="difflineplus">+    this.candidateSendTries = 0;</span>
<a href="#l48.66"></a><span id="l48.66" class="difflineplus">+</span>
<a href="#l48.67"></a><span id="l48.67" class="difflineplus">+    // Lookup from opaque queue ID to a promise for media element operations that</span>
<a href="#l48.68"></a><span id="l48.68" class="difflineplus">+    // need to be serialised into a given queue.  Store this per-MatrixCall on the</span>
<a href="#l48.69"></a><span id="l48.69" class="difflineplus">+    // assumption that multiple matrix calls will never compete for control of the</span>
<a href="#l48.70"></a><span id="l48.70" class="difflineplus">+    // same DOM elements.</span>
<a href="#l48.71"></a><span id="l48.71" class="difflineplus">+    this.mediaPromises = Object.create(null);</span>
<a href="#l48.72"></a><span id="l48.72" class="difflineplus">+</span>
<a href="#l48.73"></a><span id="l48.73" class="difflineplus">+    this.screenSharingStream = null;</span>
<a href="#l48.74"></a><span id="l48.74" class="difflineplus">+}</span>
<a href="#l48.75"></a><span id="l48.75" class="difflineplus">+/** The length of time a call can be ringing for. */</span>
<a href="#l48.76"></a><span id="l48.76" class="difflineplus">+MatrixCall.CALL_TIMEOUT_MS = 60000;</span>
<a href="#l48.77"></a><span id="l48.77" class="difflineplus">+/** The fallback server to use for STUN. */</span>
<a href="#l48.78"></a><span id="l48.78" class="difflineplus">+MatrixCall.FALLBACK_STUN_SERVER = 'stun:stun.l.google.com:19302';</span>
<a href="#l48.79"></a><span id="l48.79" class="difflineplus">+/** An error code when the local client failed to create an offer. */</span>
<a href="#l48.80"></a><span id="l48.80" class="difflineplus">+MatrixCall.ERR_LOCAL_OFFER_FAILED = &quot;local_offer_failed&quot;;</span>
<a href="#l48.81"></a><span id="l48.81" class="difflineplus">+/**</span>
<a href="#l48.82"></a><span id="l48.82" class="difflineplus">+ * An error code when there is no local mic/camera to use. This may be because</span>
<a href="#l48.83"></a><span id="l48.83" class="difflineplus">+ * the hardware isn't plugged in, or the user has explicitly denied access.</span>
<a href="#l48.84"></a><span id="l48.84" class="difflineplus">+ */</span>
<a href="#l48.85"></a><span id="l48.85" class="difflineplus">+MatrixCall.ERR_NO_USER_MEDIA = &quot;no_user_media&quot;;</span>
<a href="#l48.86"></a><span id="l48.86" class="difflineplus">+</span>
<a href="#l48.87"></a><span id="l48.87" class="difflineplus">+utils.inherits(MatrixCall, EventEmitter);</span>
<a href="#l48.88"></a><span id="l48.88" class="difflineplus">+</span>
<a href="#l48.89"></a><span id="l48.89" class="difflineplus">+/**</span>
<a href="#l48.90"></a><span id="l48.90" class="difflineplus">+ * Place a voice call to this room.</span>
<a href="#l48.91"></a><span id="l48.91" class="difflineplus">+ * @throws If you have not specified a listener for 'error' events.</span>
<a href="#l48.92"></a><span id="l48.92" class="difflineplus">+ */</span>
<a href="#l48.93"></a><span id="l48.93" class="difflineplus">+MatrixCall.prototype.placeVoiceCall = function() {</span>
<a href="#l48.94"></a><span id="l48.94" class="difflineplus">+    debuglog(&quot;placeVoiceCall&quot;);</span>
<a href="#l48.95"></a><span id="l48.95" class="difflineplus">+    checkForErrorListener(this);</span>
<a href="#l48.96"></a><span id="l48.96" class="difflineplus">+    _placeCallWithConstraints(this, _getUserMediaVideoContraints('voice'));</span>
<a href="#l48.97"></a><span id="l48.97" class="difflineplus">+    this.type = 'voice';</span>
<a href="#l48.98"></a><span id="l48.98" class="difflineplus">+};</span>
<a href="#l48.99"></a><span id="l48.99" class="difflineplus">+</span>
<a href="#l48.100"></a><span id="l48.100" class="difflineplus">+/**</span>
<a href="#l48.101"></a><span id="l48.101" class="difflineplus">+ * Place a video call to this room.</span>
<a href="#l48.102"></a><span id="l48.102" class="difflineplus">+ * @param {Element} remoteVideoElement a &lt;code&gt;&amp;lt;video&amp;gt;&lt;/code&gt; DOM element</span>
<a href="#l48.103"></a><span id="l48.103" class="difflineplus">+ * to render video to.</span>
<a href="#l48.104"></a><span id="l48.104" class="difflineplus">+ * @param {Element} localVideoElement a &lt;code&gt;&amp;lt;video&amp;gt;&lt;/code&gt; DOM element</span>
<a href="#l48.105"></a><span id="l48.105" class="difflineplus">+ * to render the local camera preview.</span>
<a href="#l48.106"></a><span id="l48.106" class="difflineplus">+ * @throws If you have not specified a listener for 'error' events.</span>
<a href="#l48.107"></a><span id="l48.107" class="difflineplus">+ */</span>
<a href="#l48.108"></a><span id="l48.108" class="difflineplus">+MatrixCall.prototype.placeVideoCall = function(remoteVideoElement, localVideoElement) {</span>
<a href="#l48.109"></a><span id="l48.109" class="difflineplus">+    debuglog(&quot;placeVideoCall&quot;);</span>
<a href="#l48.110"></a><span id="l48.110" class="difflineplus">+    checkForErrorListener(this);</span>
<a href="#l48.111"></a><span id="l48.111" class="difflineplus">+    this.localVideoElement = localVideoElement;</span>
<a href="#l48.112"></a><span id="l48.112" class="difflineplus">+    this.remoteVideoElement = remoteVideoElement;</span>
<a href="#l48.113"></a><span id="l48.113" class="difflineplus">+    _placeCallWithConstraints(this, _getUserMediaVideoContraints('video'));</span>
<a href="#l48.114"></a><span id="l48.114" class="difflineplus">+    this.type = 'video';</span>
<a href="#l48.115"></a><span id="l48.115" class="difflineplus">+    _tryPlayRemoteStream(this);</span>
<a href="#l48.116"></a><span id="l48.116" class="difflineplus">+};</span>
<a href="#l48.117"></a><span id="l48.117" class="difflineplus">+</span>
<a href="#l48.118"></a><span id="l48.118" class="difflineplus">+/**</span>
<a href="#l48.119"></a><span id="l48.119" class="difflineplus">+ * Place a screen-sharing call to this room. This includes audio.</span>
<a href="#l48.120"></a><span id="l48.120" class="difflineplus">+ * &lt;b&gt;This method is EXPERIMENTAL and subject to change without warning. It</span>
<a href="#l48.121"></a><span id="l48.121" class="difflineplus">+ * only works in Google Chrome.&lt;/b&gt;</span>
<a href="#l48.122"></a><span id="l48.122" class="difflineplus">+ * @param {Element} remoteVideoElement a &lt;code&gt;&amp;lt;video&amp;gt;&lt;/code&gt; DOM element</span>
<a href="#l48.123"></a><span id="l48.123" class="difflineplus">+ * to render video to.</span>
<a href="#l48.124"></a><span id="l48.124" class="difflineplus">+ * @param {Element} localVideoElement a &lt;code&gt;&amp;lt;video&amp;gt;&lt;/code&gt; DOM element</span>
<a href="#l48.125"></a><span id="l48.125" class="difflineplus">+ * to render the local camera preview.</span>
<a href="#l48.126"></a><span id="l48.126" class="difflineplus">+ * @throws If you have not specified a listener for 'error' events.</span>
<a href="#l48.127"></a><span id="l48.127" class="difflineplus">+ */</span>
<a href="#l48.128"></a><span id="l48.128" class="difflineplus">+MatrixCall.prototype.placeScreenSharingCall =</span>
<a href="#l48.129"></a><span id="l48.129" class="difflineplus">+    function(remoteVideoElement, localVideoElement)</span>
<a href="#l48.130"></a><span id="l48.130" class="difflineplus">+{</span>
<a href="#l48.131"></a><span id="l48.131" class="difflineplus">+    debuglog(&quot;placeScreenSharingCall&quot;);</span>
<a href="#l48.132"></a><span id="l48.132" class="difflineplus">+    checkForErrorListener(this);</span>
<a href="#l48.133"></a><span id="l48.133" class="difflineplus">+    var screenConstraints = _getChromeScreenSharingConstraints(this);</span>
<a href="#l48.134"></a><span id="l48.134" class="difflineplus">+    if (!screenConstraints) {</span>
<a href="#l48.135"></a><span id="l48.135" class="difflineplus">+        return;</span>
<a href="#l48.136"></a><span id="l48.136" class="difflineplus">+    }</span>
<a href="#l48.137"></a><span id="l48.137" class="difflineplus">+    this.localVideoElement = localVideoElement;</span>
<a href="#l48.138"></a><span id="l48.138" class="difflineplus">+    this.remoteVideoElement = remoteVideoElement;</span>
<a href="#l48.139"></a><span id="l48.139" class="difflineplus">+    var self = this;</span>
<a href="#l48.140"></a><span id="l48.140" class="difflineplus">+    this.webRtc.getUserMedia(screenConstraints, function(stream) {</span>
<a href="#l48.141"></a><span id="l48.141" class="difflineplus">+        self.screenSharingStream = stream;</span>
<a href="#l48.142"></a><span id="l48.142" class="difflineplus">+        debuglog(&quot;Got screen stream, requesting audio stream...&quot;);</span>
<a href="#l48.143"></a><span id="l48.143" class="difflineplus">+        var audioConstraints = _getUserMediaVideoContraints('voice');</span>
<a href="#l48.144"></a><span id="l48.144" class="difflineplus">+        _placeCallWithConstraints(self, audioConstraints);</span>
<a href="#l48.145"></a><span id="l48.145" class="difflineplus">+    }, function(err) {</span>
<a href="#l48.146"></a><span id="l48.146" class="difflineplus">+        self.emit(&quot;error&quot;,</span>
<a href="#l48.147"></a><span id="l48.147" class="difflineplus">+            callError(</span>
<a href="#l48.148"></a><span id="l48.148" class="difflineplus">+                MatrixCall.ERR_NO_USER_MEDIA,</span>
<a href="#l48.149"></a><span id="l48.149" class="difflineplus">+                &quot;Failed to get screen-sharing stream: &quot; + err</span>
<a href="#l48.150"></a><span id="l48.150" class="difflineplus">+            )</span>
<a href="#l48.151"></a><span id="l48.151" class="difflineplus">+        );</span>
<a href="#l48.152"></a><span id="l48.152" class="difflineplus">+    });</span>
<a href="#l48.153"></a><span id="l48.153" class="difflineplus">+    this.type = 'video';</span>
<a href="#l48.154"></a><span id="l48.154" class="difflineplus">+    _tryPlayRemoteStream(this);</span>
<a href="#l48.155"></a><span id="l48.155" class="difflineplus">+};</span>
<a href="#l48.156"></a><span id="l48.156" class="difflineplus">+</span>
<a href="#l48.157"></a><span id="l48.157" class="difflineplus">+/**</span>
<a href="#l48.158"></a><span id="l48.158" class="difflineplus">+ * Play the given HTMLMediaElement, serialising the operation into a chain</span>
<a href="#l48.159"></a><span id="l48.159" class="difflineplus">+ * of promises to avoid racing access to the element</span>
<a href="#l48.160"></a><span id="l48.160" class="difflineplus">+ * @param {Element} HTMLMediaElement element to play</span>
<a href="#l48.161"></a><span id="l48.161" class="difflineplus">+ * @param {string} queueId Arbitrary ID to track the chain of promises to be used</span>
<a href="#l48.162"></a><span id="l48.162" class="difflineplus">+ */</span>
<a href="#l48.163"></a><span id="l48.163" class="difflineplus">+MatrixCall.prototype.playElement = function(element, queueId) {</span>
<a href="#l48.164"></a><span id="l48.164" class="difflineplus">+    console.log(&quot;queuing play on &quot; + queueId + &quot; and element &quot; + element);</span>
<a href="#l48.165"></a><span id="l48.165" class="difflineplus">+    // XXX: FIXME: Does this leak elements, given the old promises</span>
<a href="#l48.166"></a><span id="l48.166" class="difflineplus">+    // may hang around and retain a reference to them?</span>
<a href="#l48.167"></a><span id="l48.167" class="difflineplus">+    if (this.mediaPromises[queueId]) {</span>
<a href="#l48.168"></a><span id="l48.168" class="difflineplus">+        // XXX: these promises can fail (e.g. by &lt;video/&gt; being unmounted whilst</span>
<a href="#l48.169"></a><span id="l48.169" class="difflineplus">+        // pending receiving media to play - e.g. whilst switching between</span>
<a href="#l48.170"></a><span id="l48.170" class="difflineplus">+        // rooms before answering an inbound call), and throw unhandled exceptions.</span>
<a href="#l48.171"></a><span id="l48.171" class="difflineplus">+        // However, we should soldier on as best we can even if they fail, given</span>
<a href="#l48.172"></a><span id="l48.172" class="difflineplus">+        // these failures may be non-fatal (as in the case of unmounts)</span>
<a href="#l48.173"></a><span id="l48.173" class="difflineplus">+        this.mediaPromises[queueId] =</span>
<a href="#l48.174"></a><span id="l48.174" class="difflineplus">+            this.mediaPromises[queueId].then(function() {</span>
<a href="#l48.175"></a><span id="l48.175" class="difflineplus">+                console.log(&quot;previous promise completed for &quot; + queueId);</span>
<a href="#l48.176"></a><span id="l48.176" class="difflineplus">+                return element.play();</span>
<a href="#l48.177"></a><span id="l48.177" class="difflineplus">+            }, function() {</span>
<a href="#l48.178"></a><span id="l48.178" class="difflineplus">+                console.log(&quot;previous promise failed for &quot; + queueId);</span>
<a href="#l48.179"></a><span id="l48.179" class="difflineplus">+                return element.play();</span>
<a href="#l48.180"></a><span id="l48.180" class="difflineplus">+            });</span>
<a href="#l48.181"></a><span id="l48.181" class="difflineplus">+    }</span>
<a href="#l48.182"></a><span id="l48.182" class="difflineplus">+    else {</span>
<a href="#l48.183"></a><span id="l48.183" class="difflineplus">+        this.mediaPromises[queueId] = element.play();</span>
<a href="#l48.184"></a><span id="l48.184" class="difflineplus">+    }</span>
<a href="#l48.185"></a><span id="l48.185" class="difflineplus">+};</span>
<a href="#l48.186"></a><span id="l48.186" class="difflineplus">+</span>
<a href="#l48.187"></a><span id="l48.187" class="difflineplus">+/**</span>
<a href="#l48.188"></a><span id="l48.188" class="difflineplus">+ * Pause the given HTMLMediaElement, serialising the operation into a chain</span>
<a href="#l48.189"></a><span id="l48.189" class="difflineplus">+ * of promises to avoid racing access to the element</span>
<a href="#l48.190"></a><span id="l48.190" class="difflineplus">+ * @param {Element} HTMLMediaElement element to pause</span>
<a href="#l48.191"></a><span id="l48.191" class="difflineplus">+ * @param {string} queueId Arbitrary ID to track the chain of promises to be used</span>
<a href="#l48.192"></a><span id="l48.192" class="difflineplus">+ */</span>
<a href="#l48.193"></a><span id="l48.193" class="difflineplus">+MatrixCall.prototype.pauseElement = function(element, queueId) {</span>
<a href="#l48.194"></a><span id="l48.194" class="difflineplus">+    console.log(&quot;queuing pause on &quot; + queueId + &quot; and element &quot; + element);</span>
<a href="#l48.195"></a><span id="l48.195" class="difflineplus">+    if (this.mediaPromises[queueId]) {</span>
<a href="#l48.196"></a><span id="l48.196" class="difflineplus">+        this.mediaPromises[queueId] =</span>
<a href="#l48.197"></a><span id="l48.197" class="difflineplus">+            this.mediaPromises[queueId].then(function() {</span>
<a href="#l48.198"></a><span id="l48.198" class="difflineplus">+                console.log(&quot;previous promise completed for &quot; + queueId);</span>
<a href="#l48.199"></a><span id="l48.199" class="difflineplus">+                return element.pause();</span>
<a href="#l48.200"></a><span id="l48.200" class="difflineplus">+            }, function() {</span>
<a href="#l48.201"></a><span id="l48.201" class="difflineplus">+                console.log(&quot;previous promise failed for &quot; + queueId);</span>
<a href="#l48.202"></a><span id="l48.202" class="difflineplus">+                return element.pause();</span>
<a href="#l48.203"></a><span id="l48.203" class="difflineplus">+            });</span>
<a href="#l48.204"></a><span id="l48.204" class="difflineplus">+    }</span>
<a href="#l48.205"></a><span id="l48.205" class="difflineplus">+    else {</span>
<a href="#l48.206"></a><span id="l48.206" class="difflineplus">+        // pause doesn't actually return a promise, but do this for symmetry</span>
<a href="#l48.207"></a><span id="l48.207" class="difflineplus">+        // and just in case it does in future.</span>
<a href="#l48.208"></a><span id="l48.208" class="difflineplus">+        this.mediaPromises[queueId] = element.pause();</span>
<a href="#l48.209"></a><span id="l48.209" class="difflineplus">+    }</span>
<a href="#l48.210"></a><span id="l48.210" class="difflineplus">+};</span>
<a href="#l48.211"></a><span id="l48.211" class="difflineplus">+</span>
<a href="#l48.212"></a><span id="l48.212" class="difflineplus">+/**</span>
<a href="#l48.213"></a><span id="l48.213" class="difflineplus">+ * Assign the given HTMLMediaElement by setting the .src attribute on it,</span>
<a href="#l48.214"></a><span id="l48.214" class="difflineplus">+ * serialising the operation into a chain of promises to avoid racing access</span>
<a href="#l48.215"></a><span id="l48.215" class="difflineplus">+ * to the element</span>
<a href="#l48.216"></a><span id="l48.216" class="difflineplus">+ * @param {Element} HTMLMediaElement element to pause</span>
<a href="#l48.217"></a><span id="l48.217" class="difflineplus">+ * @param {string} src the src attribute value to assign to the element</span>
<a href="#l48.218"></a><span id="l48.218" class="difflineplus">+ * @param {string} queueId Arbitrary ID to track the chain of promises to be used</span>
<a href="#l48.219"></a><span id="l48.219" class="difflineplus">+ */</span>
<a href="#l48.220"></a><span id="l48.220" class="difflineplus">+MatrixCall.prototype.assignElement = function(element, src, queueId) {</span>
<a href="#l48.221"></a><span id="l48.221" class="difflineplus">+    console.log(&quot;queuing assign on &quot; + queueId + &quot; element &quot; + element + &quot; for &quot; + src);</span>
<a href="#l48.222"></a><span id="l48.222" class="difflineplus">+    if (this.mediaPromises[queueId]) {</span>
<a href="#l48.223"></a><span id="l48.223" class="difflineplus">+        this.mediaPromises[queueId] =</span>
<a href="#l48.224"></a><span id="l48.224" class="difflineplus">+            this.mediaPromises[queueId].then(function() {</span>
<a href="#l48.225"></a><span id="l48.225" class="difflineplus">+                console.log(&quot;previous promise completed for &quot; + queueId);</span>
<a href="#l48.226"></a><span id="l48.226" class="difflineplus">+                element.src = src;</span>
<a href="#l48.227"></a><span id="l48.227" class="difflineplus">+            }, function() {</span>
<a href="#l48.228"></a><span id="l48.228" class="difflineplus">+                console.log(&quot;previous promise failed for &quot; + queueId);</span>
<a href="#l48.229"></a><span id="l48.229" class="difflineplus">+                element.src = src;</span>
<a href="#l48.230"></a><span id="l48.230" class="difflineplus">+            });</span>
<a href="#l48.231"></a><span id="l48.231" class="difflineplus">+    }</span>
<a href="#l48.232"></a><span id="l48.232" class="difflineplus">+    else {</span>
<a href="#l48.233"></a><span id="l48.233" class="difflineplus">+        element.src = src;</span>
<a href="#l48.234"></a><span id="l48.234" class="difflineplus">+    }</span>
<a href="#l48.235"></a><span id="l48.235" class="difflineplus">+};</span>
<a href="#l48.236"></a><span id="l48.236" class="difflineplus">+</span>
<a href="#l48.237"></a><span id="l48.237" class="difflineplus">+/**</span>
<a href="#l48.238"></a><span id="l48.238" class="difflineplus">+ * Retrieve the local &lt;code&gt;&amp;lt;video&amp;gt;&lt;/code&gt; DOM element.</span>
<a href="#l48.239"></a><span id="l48.239" class="difflineplus">+ * @return {Element} The dom element</span>
<a href="#l48.240"></a><span id="l48.240" class="difflineplus">+ */</span>
<a href="#l48.241"></a><span id="l48.241" class="difflineplus">+MatrixCall.prototype.getLocalVideoElement = function() {</span>
<a href="#l48.242"></a><span id="l48.242" class="difflineplus">+    return this.localVideoElement;</span>
<a href="#l48.243"></a><span id="l48.243" class="difflineplus">+};</span>
<a href="#l48.244"></a><span id="l48.244" class="difflineplus">+</span>
<a href="#l48.245"></a><span id="l48.245" class="difflineplus">+/**</span>
<a href="#l48.246"></a><span id="l48.246" class="difflineplus">+ * Retrieve the remote &lt;code&gt;&amp;lt;video&amp;gt;&lt;/code&gt; DOM element</span>
<a href="#l48.247"></a><span id="l48.247" class="difflineplus">+ * used for playing back video capable streams.</span>
<a href="#l48.248"></a><span id="l48.248" class="difflineplus">+ * @return {Element} The dom element</span>
<a href="#l48.249"></a><span id="l48.249" class="difflineplus">+ */</span>
<a href="#l48.250"></a><span id="l48.250" class="difflineplus">+MatrixCall.prototype.getRemoteVideoElement = function() {</span>
<a href="#l48.251"></a><span id="l48.251" class="difflineplus">+    return this.remoteVideoElement;</span>
<a href="#l48.252"></a><span id="l48.252" class="difflineplus">+};</span>
<a href="#l48.253"></a><span id="l48.253" class="difflineplus">+</span>
<a href="#l48.254"></a><span id="l48.254" class="difflineplus">+/**</span>
<a href="#l48.255"></a><span id="l48.255" class="difflineplus">+ * Retrieve the remote &lt;code&gt;&amp;lt;audio&amp;gt;&lt;/code&gt; DOM element</span>
<a href="#l48.256"></a><span id="l48.256" class="difflineplus">+ * used for playing back audio only streams.</span>
<a href="#l48.257"></a><span id="l48.257" class="difflineplus">+ * @return {Element} The dom element</span>
<a href="#l48.258"></a><span id="l48.258" class="difflineplus">+ */</span>
<a href="#l48.259"></a><span id="l48.259" class="difflineplus">+MatrixCall.prototype.getRemoteAudioElement = function() {</span>
<a href="#l48.260"></a><span id="l48.260" class="difflineplus">+    return this.remoteAudioElement;</span>
<a href="#l48.261"></a><span id="l48.261" class="difflineplus">+};</span>
<a href="#l48.262"></a><span id="l48.262" class="difflineplus">+</span>
<a href="#l48.263"></a><span id="l48.263" class="difflineplus">+/**</span>
<a href="#l48.264"></a><span id="l48.264" class="difflineplus">+ * Set the local &lt;code&gt;&amp;lt;video&amp;gt;&lt;/code&gt; DOM element. If this call is active,</span>
<a href="#l48.265"></a><span id="l48.265" class="difflineplus">+ * video will be rendered to it immediately.</span>
<a href="#l48.266"></a><span id="l48.266" class="difflineplus">+ * @param {Element} element The &lt;code&gt;&amp;lt;video&amp;gt;&lt;/code&gt; DOM element.</span>
<a href="#l48.267"></a><span id="l48.267" class="difflineplus">+ */</span>
<a href="#l48.268"></a><span id="l48.268" class="difflineplus">+MatrixCall.prototype.setLocalVideoElement = function(element) {</span>
<a href="#l48.269"></a><span id="l48.269" class="difflineplus">+    this.localVideoElement = element;</span>
<a href="#l48.270"></a><span id="l48.270" class="difflineplus">+</span>
<a href="#l48.271"></a><span id="l48.271" class="difflineplus">+    if (element &amp;&amp; this.localAVStream &amp;&amp; this.type === 'video') {</span>
<a href="#l48.272"></a><span id="l48.272" class="difflineplus">+        element.autoplay = true;</span>
<a href="#l48.273"></a><span id="l48.273" class="difflineplus">+        this.assignElement(element,</span>
<a href="#l48.274"></a><span id="l48.274" class="difflineplus">+                           this.URL.createObjectURL(this.localAVStream),</span>
<a href="#l48.275"></a><span id="l48.275" class="difflineplus">+                           &quot;localVideo&quot;);</span>
<a href="#l48.276"></a><span id="l48.276" class="difflineplus">+        element.muted = true;</span>
<a href="#l48.277"></a><span id="l48.277" class="difflineplus">+        var self = this;</span>
<a href="#l48.278"></a><span id="l48.278" class="difflineplus">+        setTimeout(function() {</span>
<a href="#l48.279"></a><span id="l48.279" class="difflineplus">+            var vel = self.getLocalVideoElement();</span>
<a href="#l48.280"></a><span id="l48.280" class="difflineplus">+            if (vel.play) {</span>
<a href="#l48.281"></a><span id="l48.281" class="difflineplus">+                self.playElement(vel, &quot;localVideo&quot;);</span>
<a href="#l48.282"></a><span id="l48.282" class="difflineplus">+            }</span>
<a href="#l48.283"></a><span id="l48.283" class="difflineplus">+        }, 0);</span>
<a href="#l48.284"></a><span id="l48.284" class="difflineplus">+    }</span>
<a href="#l48.285"></a><span id="l48.285" class="difflineplus">+};</span>
<a href="#l48.286"></a><span id="l48.286" class="difflineplus">+</span>
<a href="#l48.287"></a><span id="l48.287" class="difflineplus">+/**</span>
<a href="#l48.288"></a><span id="l48.288" class="difflineplus">+ * Set the remote &lt;code&gt;&amp;lt;video&amp;gt;&lt;/code&gt; DOM element. If this call is active,</span>
<a href="#l48.289"></a><span id="l48.289" class="difflineplus">+ * the first received video-capable stream will be rendered to it immediately.</span>
<a href="#l48.290"></a><span id="l48.290" class="difflineplus">+ * @param {Element} element The &lt;code&gt;&amp;lt;video&amp;gt;&lt;/code&gt; DOM element.</span>
<a href="#l48.291"></a><span id="l48.291" class="difflineplus">+ */</span>
<a href="#l48.292"></a><span id="l48.292" class="difflineplus">+MatrixCall.prototype.setRemoteVideoElement = function(element) {</span>
<a href="#l48.293"></a><span id="l48.293" class="difflineplus">+    this.remoteVideoElement = element;</span>
<a href="#l48.294"></a><span id="l48.294" class="difflineplus">+    _tryPlayRemoteStream(this);</span>
<a href="#l48.295"></a><span id="l48.295" class="difflineplus">+};</span>
<a href="#l48.296"></a><span id="l48.296" class="difflineplus">+</span>
<a href="#l48.297"></a><span id="l48.297" class="difflineplus">+/**</span>
<a href="#l48.298"></a><span id="l48.298" class="difflineplus">+ * Set the remote &lt;code&gt;&amp;lt;audio&amp;gt;&lt;/code&gt; DOM element. If this call is active,</span>
<a href="#l48.299"></a><span id="l48.299" class="difflineplus">+ * the first received audio-only stream will be rendered to it immediately.</span>
<a href="#l48.300"></a><span id="l48.300" class="difflineplus">+ * The audio will *not* be rendered from the remoteVideoElement.</span>
<a href="#l48.301"></a><span id="l48.301" class="difflineplus">+ * @param {Element} element The &lt;code&gt;&amp;lt;video&amp;gt;&lt;/code&gt; DOM element.</span>
<a href="#l48.302"></a><span id="l48.302" class="difflineplus">+ */</span>
<a href="#l48.303"></a><span id="l48.303" class="difflineplus">+MatrixCall.prototype.setRemoteAudioElement = function(element) {</span>
<a href="#l48.304"></a><span id="l48.304" class="difflineplus">+    this.remoteVideoElement.muted = true;</span>
<a href="#l48.305"></a><span id="l48.305" class="difflineplus">+    this.remoteAudioElement = element;</span>
<a href="#l48.306"></a><span id="l48.306" class="difflineplus">+    _tryPlayRemoteAudioStream(this);</span>
<a href="#l48.307"></a><span id="l48.307" class="difflineplus">+};</span>
<a href="#l48.308"></a><span id="l48.308" class="difflineplus">+</span>
<a href="#l48.309"></a><span id="l48.309" class="difflineplus">+/**</span>
<a href="#l48.310"></a><span id="l48.310" class="difflineplus">+ * Configure this call from an invite event. Used by MatrixClient.</span>
<a href="#l48.311"></a><span id="l48.311" class="difflineplus">+ * @protected</span>
<a href="#l48.312"></a><span id="l48.312" class="difflineplus">+ * @param {MatrixEvent} event The m.call.invite event</span>
<a href="#l48.313"></a><span id="l48.313" class="difflineplus">+ */</span>
<a href="#l48.314"></a><span id="l48.314" class="difflineplus">+MatrixCall.prototype._initWithInvite = function(event) {</span>
<a href="#l48.315"></a><span id="l48.315" class="difflineplus">+    this.msg = event.getContent();</span>
<a href="#l48.316"></a><span id="l48.316" class="difflineplus">+    this.peerConn = _createPeerConnection(this);</span>
<a href="#l48.317"></a><span id="l48.317" class="difflineplus">+    var self = this;</span>
<a href="#l48.318"></a><span id="l48.318" class="difflineplus">+    if (this.peerConn) {</span>
<a href="#l48.319"></a><span id="l48.319" class="difflineplus">+        this.peerConn.setRemoteDescription(</span>
<a href="#l48.320"></a><span id="l48.320" class="difflineplus">+            new this.webRtc.RtcSessionDescription(this.msg.offer),</span>
<a href="#l48.321"></a><span id="l48.321" class="difflineplus">+            hookCallback(self, self._onSetRemoteDescriptionSuccess),</span>
<a href="#l48.322"></a><span id="l48.322" class="difflineplus">+            hookCallback(self, self._onSetRemoteDescriptionError)</span>
<a href="#l48.323"></a><span id="l48.323" class="difflineplus">+        );</span>
<a href="#l48.324"></a><span id="l48.324" class="difflineplus">+    }</span>
<a href="#l48.325"></a><span id="l48.325" class="difflineplus">+    setState(this, 'ringing');</span>
<a href="#l48.326"></a><span id="l48.326" class="difflineplus">+    this.direction = 'inbound';</span>
<a href="#l48.327"></a><span id="l48.327" class="difflineplus">+</span>
<a href="#l48.328"></a><span id="l48.328" class="difflineplus">+    // firefox and OpenWebRTC's RTCPeerConnection doesn't add streams until it</span>
<a href="#l48.329"></a><span id="l48.329" class="difflineplus">+    // starts getting media on them so we need to figure out whether a video</span>
<a href="#l48.330"></a><span id="l48.330" class="difflineplus">+    // channel has been offered by ourselves.</span>
<a href="#l48.331"></a><span id="l48.331" class="difflineplus">+    if (</span>
<a href="#l48.332"></a><span id="l48.332" class="difflineplus">+        this.msg.offer &amp;&amp;</span>
<a href="#l48.333"></a><span id="l48.333" class="difflineplus">+        this.msg.offer.sdp &amp;&amp;</span>
<a href="#l48.334"></a><span id="l48.334" class="difflineplus">+        this.msg.offer.sdp.indexOf('m=video') &gt; -1</span>
<a href="#l48.335"></a><span id="l48.335" class="difflineplus">+    ) {</span>
<a href="#l48.336"></a><span id="l48.336" class="difflineplus">+        this.type = 'video';</span>
<a href="#l48.337"></a><span id="l48.337" class="difflineplus">+    }</span>
<a href="#l48.338"></a><span id="l48.338" class="difflineplus">+    else {</span>
<a href="#l48.339"></a><span id="l48.339" class="difflineplus">+        this.type = 'voice';</span>
<a href="#l48.340"></a><span id="l48.340" class="difflineplus">+    }</span>
<a href="#l48.341"></a><span id="l48.341" class="difflineplus">+</span>
<a href="#l48.342"></a><span id="l48.342" class="difflineplus">+    if (event.getAge()) {</span>
<a href="#l48.343"></a><span id="l48.343" class="difflineplus">+        setTimeout(function() {</span>
<a href="#l48.344"></a><span id="l48.344" class="difflineplus">+            if (self.state == 'ringing') {</span>
<a href="#l48.345"></a><span id="l48.345" class="difflineplus">+                debuglog(&quot;Call invite has expired. Hanging up.&quot;);</span>
<a href="#l48.346"></a><span id="l48.346" class="difflineplus">+                self.hangupParty = 'remote'; // effectively</span>
<a href="#l48.347"></a><span id="l48.347" class="difflineplus">+                setState(self, 'ended');</span>
<a href="#l48.348"></a><span id="l48.348" class="difflineplus">+                stopAllMedia(self);</span>
<a href="#l48.349"></a><span id="l48.349" class="difflineplus">+                if (self.peerConn.signalingState != 'closed') {</span>
<a href="#l48.350"></a><span id="l48.350" class="difflineplus">+                    self.peerConn.close();</span>
<a href="#l48.351"></a><span id="l48.351" class="difflineplus">+                }</span>
<a href="#l48.352"></a><span id="l48.352" class="difflineplus">+                self.emit(&quot;hangup&quot;, self);</span>
<a href="#l48.353"></a><span id="l48.353" class="difflineplus">+            }</span>
<a href="#l48.354"></a><span id="l48.354" class="difflineplus">+        }, this.msg.lifetime - event.getAge());</span>
<a href="#l48.355"></a><span id="l48.355" class="difflineplus">+    }</span>
<a href="#l48.356"></a><span id="l48.356" class="difflineplus">+};</span>
<a href="#l48.357"></a><span id="l48.357" class="difflineplus">+</span>
<a href="#l48.358"></a><span id="l48.358" class="difflineplus">+/**</span>
<a href="#l48.359"></a><span id="l48.359" class="difflineplus">+ * Configure this call from a hangup event. Used by MatrixClient.</span>
<a href="#l48.360"></a><span id="l48.360" class="difflineplus">+ * @protected</span>
<a href="#l48.361"></a><span id="l48.361" class="difflineplus">+ * @param {MatrixEvent} event The m.call.hangup event</span>
<a href="#l48.362"></a><span id="l48.362" class="difflineplus">+ */</span>
<a href="#l48.363"></a><span id="l48.363" class="difflineplus">+MatrixCall.prototype._initWithHangup = function(event) {</span>
<a href="#l48.364"></a><span id="l48.364" class="difflineplus">+    // perverse as it may seem, sometimes we want to instantiate a call with a</span>
<a href="#l48.365"></a><span id="l48.365" class="difflineplus">+    // hangup message (because when getting the state of the room on load, events</span>
<a href="#l48.366"></a><span id="l48.366" class="difflineplus">+    // come in reverse order and we want to remember that a call has been hung up)</span>
<a href="#l48.367"></a><span id="l48.367" class="difflineplus">+    this.msg = event.getContent();</span>
<a href="#l48.368"></a><span id="l48.368" class="difflineplus">+    setState(this, 'ended');</span>
<a href="#l48.369"></a><span id="l48.369" class="difflineplus">+};</span>
<a href="#l48.370"></a><span id="l48.370" class="difflineplus">+</span>
<a href="#l48.371"></a><span id="l48.371" class="difflineplus">+/**</span>
<a href="#l48.372"></a><span id="l48.372" class="difflineplus">+ * Answer a call.</span>
<a href="#l48.373"></a><span id="l48.373" class="difflineplus">+ */</span>
<a href="#l48.374"></a><span id="l48.374" class="difflineplus">+MatrixCall.prototype.answer = function() {</span>
<a href="#l48.375"></a><span id="l48.375" class="difflineplus">+    debuglog(&quot;Answering call %s of type %s&quot;, this.callId, this.type);</span>
<a href="#l48.376"></a><span id="l48.376" class="difflineplus">+    var self = this;</span>
<a href="#l48.377"></a><span id="l48.377" class="difflineplus">+</span>
<a href="#l48.378"></a><span id="l48.378" class="difflineplus">+    if (!this.localAVStream &amp;&amp; !this.waitForLocalAVStream) {</span>
<a href="#l48.379"></a><span id="l48.379" class="difflineplus">+        this.webRtc.getUserMedia(</span>
<a href="#l48.380"></a><span id="l48.380" class="difflineplus">+            _getUserMediaVideoContraints(this.type),</span>
<a href="#l48.381"></a><span id="l48.381" class="difflineplus">+            hookCallback(self, self._gotUserMediaForAnswer),</span>
<a href="#l48.382"></a><span id="l48.382" class="difflineplus">+            hookCallback(self, self._getUserMediaFailed)</span>
<a href="#l48.383"></a><span id="l48.383" class="difflineplus">+        );</span>
<a href="#l48.384"></a><span id="l48.384" class="difflineplus">+        setState(this, 'wait_local_media');</span>
<a href="#l48.385"></a><span id="l48.385" class="difflineplus">+    } else if (this.localAVStream) {</span>
<a href="#l48.386"></a><span id="l48.386" class="difflineplus">+        this._gotUserMediaForAnswer(this.localAVStream);</span>
<a href="#l48.387"></a><span id="l48.387" class="difflineplus">+    } else if (this.waitForLocalAVStream) {</span>
<a href="#l48.388"></a><span id="l48.388" class="difflineplus">+        setState(this, 'wait_local_media');</span>
<a href="#l48.389"></a><span id="l48.389" class="difflineplus">+    }</span>
<a href="#l48.390"></a><span id="l48.390" class="difflineplus">+};</span>
<a href="#l48.391"></a><span id="l48.391" class="difflineplus">+</span>
<a href="#l48.392"></a><span id="l48.392" class="difflineplus">+/**</span>
<a href="#l48.393"></a><span id="l48.393" class="difflineplus">+ * Replace this call with a new call, e.g. for glare resolution. Used by</span>
<a href="#l48.394"></a><span id="l48.394" class="difflineplus">+ * MatrixClient.</span>
<a href="#l48.395"></a><span id="l48.395" class="difflineplus">+ * @protected</span>
<a href="#l48.396"></a><span id="l48.396" class="difflineplus">+ * @param {MatrixCall} newCall The new call.</span>
<a href="#l48.397"></a><span id="l48.397" class="difflineplus">+ */</span>
<a href="#l48.398"></a><span id="l48.398" class="difflineplus">+MatrixCall.prototype._replacedBy = function(newCall) {</span>
<a href="#l48.399"></a><span id="l48.399" class="difflineplus">+    debuglog(this.callId + &quot; being replaced by &quot; + newCall.callId);</span>
<a href="#l48.400"></a><span id="l48.400" class="difflineplus">+    if (this.state == 'wait_local_media') {</span>
<a href="#l48.401"></a><span id="l48.401" class="difflineplus">+        debuglog(&quot;Telling new call to wait for local media&quot;);</span>
<a href="#l48.402"></a><span id="l48.402" class="difflineplus">+        newCall.waitForLocalAVStream = true;</span>
<a href="#l48.403"></a><span id="l48.403" class="difflineplus">+    } else if (this.state == 'create_offer') {</span>
<a href="#l48.404"></a><span id="l48.404" class="difflineplus">+        debuglog(&quot;Handing local stream to new call&quot;);</span>
<a href="#l48.405"></a><span id="l48.405" class="difflineplus">+        newCall._gotUserMediaForAnswer(this.localAVStream);</span>
<a href="#l48.406"></a><span id="l48.406" class="difflineplus">+        delete(this.localAVStream);</span>
<a href="#l48.407"></a><span id="l48.407" class="difflineplus">+    } else if (this.state == 'invite_sent') {</span>
<a href="#l48.408"></a><span id="l48.408" class="difflineplus">+        debuglog(&quot;Handing local stream to new call&quot;);</span>
<a href="#l48.409"></a><span id="l48.409" class="difflineplus">+        newCall._gotUserMediaForAnswer(this.localAVStream);</span>
<a href="#l48.410"></a><span id="l48.410" class="difflineplus">+        delete(this.localAVStream);</span>
<a href="#l48.411"></a><span id="l48.411" class="difflineplus">+    }</span>
<a href="#l48.412"></a><span id="l48.412" class="difflineplus">+    newCall.localVideoElement = this.localVideoElement;</span>
<a href="#l48.413"></a><span id="l48.413" class="difflineplus">+    newCall.remoteVideoElement = this.remoteVideoElement;</span>
<a href="#l48.414"></a><span id="l48.414" class="difflineplus">+    newCall.remoteAudioElement = this.remoteAudioElement;</span>
<a href="#l48.415"></a><span id="l48.415" class="difflineplus">+    this.successor = newCall;</span>
<a href="#l48.416"></a><span id="l48.416" class="difflineplus">+    this.emit(&quot;replaced&quot;, newCall);</span>
<a href="#l48.417"></a><span id="l48.417" class="difflineplus">+    this.hangup(true);</span>
<a href="#l48.418"></a><span id="l48.418" class="difflineplus">+};</span>
<a href="#l48.419"></a><span id="l48.419" class="difflineplus">+</span>
<a href="#l48.420"></a><span id="l48.420" class="difflineplus">+/**</span>
<a href="#l48.421"></a><span id="l48.421" class="difflineplus">+ * Hangup a call.</span>
<a href="#l48.422"></a><span id="l48.422" class="difflineplus">+ * @param {string} reason The reason why the call is being hung up.</span>
<a href="#l48.423"></a><span id="l48.423" class="difflineplus">+ * @param {boolean} suppressEvent True to suppress emitting an event.</span>
<a href="#l48.424"></a><span id="l48.424" class="difflineplus">+ */</span>
<a href="#l48.425"></a><span id="l48.425" class="difflineplus">+MatrixCall.prototype.hangup = function(reason, suppressEvent) {</span>
<a href="#l48.426"></a><span id="l48.426" class="difflineplus">+    debuglog(&quot;Ending call &quot; + this.callId);</span>
<a href="#l48.427"></a><span id="l48.427" class="difflineplus">+    terminate(this, &quot;local&quot;, reason, !suppressEvent);</span>
<a href="#l48.428"></a><span id="l48.428" class="difflineplus">+    var content = {</span>
<a href="#l48.429"></a><span id="l48.429" class="difflineplus">+        version: 0,</span>
<a href="#l48.430"></a><span id="l48.430" class="difflineplus">+        call_id: this.callId,</span>
<a href="#l48.431"></a><span id="l48.431" class="difflineplus">+        reason: reason</span>
<a href="#l48.432"></a><span id="l48.432" class="difflineplus">+    };</span>
<a href="#l48.433"></a><span id="l48.433" class="difflineplus">+    sendEvent(this, 'm.call.hangup', content);</span>
<a href="#l48.434"></a><span id="l48.434" class="difflineplus">+};</span>
<a href="#l48.435"></a><span id="l48.435" class="difflineplus">+</span>
<a href="#l48.436"></a><span id="l48.436" class="difflineplus">+/**</span>
<a href="#l48.437"></a><span id="l48.437" class="difflineplus">+ * Set whether the local video preview should be muted or not.</span>
<a href="#l48.438"></a><span id="l48.438" class="difflineplus">+ * @param {boolean} muted True to mute the local video.</span>
<a href="#l48.439"></a><span id="l48.439" class="difflineplus">+ */</span>
<a href="#l48.440"></a><span id="l48.440" class="difflineplus">+MatrixCall.prototype.setLocalVideoMuted = function(muted) {</span>
<a href="#l48.441"></a><span id="l48.441" class="difflineplus">+    if (!this.localAVStream) {</span>
<a href="#l48.442"></a><span id="l48.442" class="difflineplus">+        return;</span>
<a href="#l48.443"></a><span id="l48.443" class="difflineplus">+    }</span>
<a href="#l48.444"></a><span id="l48.444" class="difflineplus">+    setTracksEnabled(this.localAVStream.getVideoTracks(), !muted);</span>
<a href="#l48.445"></a><span id="l48.445" class="difflineplus">+};</span>
<a href="#l48.446"></a><span id="l48.446" class="difflineplus">+</span>
<a href="#l48.447"></a><span id="l48.447" class="difflineplus">+/**</span>
<a href="#l48.448"></a><span id="l48.448" class="difflineplus">+ * Check if local video is muted.</span>
<a href="#l48.449"></a><span id="l48.449" class="difflineplus">+ *</span>
<a href="#l48.450"></a><span id="l48.450" class="difflineplus">+ * If there are multiple video tracks, &lt;i&gt;all&lt;/i&gt; of the tracks need to be muted</span>
<a href="#l48.451"></a><span id="l48.451" class="difflineplus">+ * for this to return true. This means if there are no video tracks, this will</span>
<a href="#l48.452"></a><span id="l48.452" class="difflineplus">+ * return true.</span>
<a href="#l48.453"></a><span id="l48.453" class="difflineplus">+ * @return {Boolean} True if the local preview video is muted, else false</span>
<a href="#l48.454"></a><span id="l48.454" class="difflineplus">+ * (including if the call is not set up yet).</span>
<a href="#l48.455"></a><span id="l48.455" class="difflineplus">+ */</span>
<a href="#l48.456"></a><span id="l48.456" class="difflineplus">+MatrixCall.prototype.isLocalVideoMuted = function() {</span>
<a href="#l48.457"></a><span id="l48.457" class="difflineplus">+    if (!this.localAVStream) {</span>
<a href="#l48.458"></a><span id="l48.458" class="difflineplus">+        return false;</span>
<a href="#l48.459"></a><span id="l48.459" class="difflineplus">+    }</span>
<a href="#l48.460"></a><span id="l48.460" class="difflineplus">+    return !isTracksEnabled(this.localAVStream.getVideoTracks());</span>
<a href="#l48.461"></a><span id="l48.461" class="difflineplus">+};</span>
<a href="#l48.462"></a><span id="l48.462" class="difflineplus">+</span>
<a href="#l48.463"></a><span id="l48.463" class="difflineplus">+/**</span>
<a href="#l48.464"></a><span id="l48.464" class="difflineplus">+ * Set whether the microphone should be muted or not.</span>
<a href="#l48.465"></a><span id="l48.465" class="difflineplus">+ * @param {boolean} muted True to mute the mic.</span>
<a href="#l48.466"></a><span id="l48.466" class="difflineplus">+ */</span>
<a href="#l48.467"></a><span id="l48.467" class="difflineplus">+MatrixCall.prototype.setMicrophoneMuted = function(muted) {</span>
<a href="#l48.468"></a><span id="l48.468" class="difflineplus">+    if (!this.localAVStream) {</span>
<a href="#l48.469"></a><span id="l48.469" class="difflineplus">+        return;</span>
<a href="#l48.470"></a><span id="l48.470" class="difflineplus">+    }</span>
<a href="#l48.471"></a><span id="l48.471" class="difflineplus">+    setTracksEnabled(this.localAVStream.getAudioTracks(), !muted);</span>
<a href="#l48.472"></a><span id="l48.472" class="difflineplus">+};</span>
<a href="#l48.473"></a><span id="l48.473" class="difflineplus">+</span>
<a href="#l48.474"></a><span id="l48.474" class="difflineplus">+/**</span>
<a href="#l48.475"></a><span id="l48.475" class="difflineplus">+ * Check if the microphone is muted.</span>
<a href="#l48.476"></a><span id="l48.476" class="difflineplus">+ *</span>
<a href="#l48.477"></a><span id="l48.477" class="difflineplus">+ * If there are multiple audio tracks, &lt;i&gt;all&lt;/i&gt; of the tracks need to be muted</span>
<a href="#l48.478"></a><span id="l48.478" class="difflineplus">+ * for this to return true. This means if there are no audio tracks, this will</span>
<a href="#l48.479"></a><span id="l48.479" class="difflineplus">+ * return true.</span>
<a href="#l48.480"></a><span id="l48.480" class="difflineplus">+ * @return {Boolean} True if the mic is muted, else false (including if the call</span>
<a href="#l48.481"></a><span id="l48.481" class="difflineplus">+ * is not set up yet).</span>
<a href="#l48.482"></a><span id="l48.482" class="difflineplus">+ */</span>
<a href="#l48.483"></a><span id="l48.483" class="difflineplus">+MatrixCall.prototype.isMicrophoneMuted = function() {</span>
<a href="#l48.484"></a><span id="l48.484" class="difflineplus">+    if (!this.localAVStream) {</span>
<a href="#l48.485"></a><span id="l48.485" class="difflineplus">+        return false;</span>
<a href="#l48.486"></a><span id="l48.486" class="difflineplus">+    }</span>
<a href="#l48.487"></a><span id="l48.487" class="difflineplus">+    return !isTracksEnabled(this.localAVStream.getAudioTracks());</span>
<a href="#l48.488"></a><span id="l48.488" class="difflineplus">+};</span>
<a href="#l48.489"></a><span id="l48.489" class="difflineplus">+</span>
<a href="#l48.490"></a><span id="l48.490" class="difflineplus">+/**</span>
<a href="#l48.491"></a><span id="l48.491" class="difflineplus">+ * Internal</span>
<a href="#l48.492"></a><span id="l48.492" class="difflineplus">+ * @private</span>
<a href="#l48.493"></a><span id="l48.493" class="difflineplus">+ * @param {Object} stream</span>
<a href="#l48.494"></a><span id="l48.494" class="difflineplus">+ */</span>
<a href="#l48.495"></a><span id="l48.495" class="difflineplus">+MatrixCall.prototype._gotUserMediaForInvite = function(stream) {</span>
<a href="#l48.496"></a><span id="l48.496" class="difflineplus">+    if (this.successor) {</span>
<a href="#l48.497"></a><span id="l48.497" class="difflineplus">+        this.successor._gotUserMediaForAnswer(stream);</span>
<a href="#l48.498"></a><span id="l48.498" class="difflineplus">+        return;</span>
<a href="#l48.499"></a><span id="l48.499" class="difflineplus">+    }</span>
<a href="#l48.500"></a><span id="l48.500" class="difflineplus">+    if (this.state == 'ended') {</span>
<a href="#l48.501"></a><span id="l48.501" class="difflineplus">+        return;</span>
<a href="#l48.502"></a><span id="l48.502" class="difflineplus">+    }</span>
<a href="#l48.503"></a><span id="l48.503" class="difflineplus">+    debuglog(&quot;_gotUserMediaForInvite -&gt; &quot; + this.type);</span>
<a href="#l48.504"></a><span id="l48.504" class="difflineplus">+    var self = this;</span>
<a href="#l48.505"></a><span id="l48.505" class="difflineplus">+    var videoEl = this.getLocalVideoElement();</span>
<a href="#l48.506"></a><span id="l48.506" class="difflineplus">+</span>
<a href="#l48.507"></a><span id="l48.507" class="difflineplus">+    if (videoEl &amp;&amp; this.type == 'video') {</span>
<a href="#l48.508"></a><span id="l48.508" class="difflineplus">+        videoEl.autoplay = true;</span>
<a href="#l48.509"></a><span id="l48.509" class="difflineplus">+        if (this.screenSharingStream) {</span>
<a href="#l48.510"></a><span id="l48.510" class="difflineplus">+            debuglog(&quot;Setting screen sharing stream to the local video element&quot;);</span>
<a href="#l48.511"></a><span id="l48.511" class="difflineplus">+            this.assignElement(videoEl,</span>
<a href="#l48.512"></a><span id="l48.512" class="difflineplus">+                   this.URL.createObjectURL(this.screenSharingStream),</span>
<a href="#l48.513"></a><span id="l48.513" class="difflineplus">+                   &quot;localVideo&quot;);</span>
<a href="#l48.514"></a><span id="l48.514" class="difflineplus">+        }</span>
<a href="#l48.515"></a><span id="l48.515" class="difflineplus">+        else {</span>
<a href="#l48.516"></a><span id="l48.516" class="difflineplus">+            this.assignElement(videoEl,</span>
<a href="#l48.517"></a><span id="l48.517" class="difflineplus">+                   this.URL.createObjectURL(stream),</span>
<a href="#l48.518"></a><span id="l48.518" class="difflineplus">+                   &quot;localVideo&quot;);</span>
<a href="#l48.519"></a><span id="l48.519" class="difflineplus">+        }</span>
<a href="#l48.520"></a><span id="l48.520" class="difflineplus">+        videoEl.muted = true;</span>
<a href="#l48.521"></a><span id="l48.521" class="difflineplus">+        setTimeout(function() {</span>
<a href="#l48.522"></a><span id="l48.522" class="difflineplus">+            var vel = self.getLocalVideoElement();</span>
<a href="#l48.523"></a><span id="l48.523" class="difflineplus">+            if (vel.play) {</span>
<a href="#l48.524"></a><span id="l48.524" class="difflineplus">+                self.playElement(vel, &quot;localVideo&quot;);</span>
<a href="#l48.525"></a><span id="l48.525" class="difflineplus">+            }</span>
<a href="#l48.526"></a><span id="l48.526" class="difflineplus">+        }, 0);</span>
<a href="#l48.527"></a><span id="l48.527" class="difflineplus">+    }</span>
<a href="#l48.528"></a><span id="l48.528" class="difflineplus">+</span>
<a href="#l48.529"></a><span id="l48.529" class="difflineplus">+    this.localAVStream = stream;</span>
<a href="#l48.530"></a><span id="l48.530" class="difflineplus">+    // why do we enable audio (and only audio) tracks here? -- matthew</span>
<a href="#l48.531"></a><span id="l48.531" class="difflineplus">+    setTracksEnabled(stream.getAudioTracks(), true);</span>
<a href="#l48.532"></a><span id="l48.532" class="difflineplus">+    this.peerConn = _createPeerConnection(this);</span>
<a href="#l48.533"></a><span id="l48.533" class="difflineplus">+    this.peerConn.addStream(stream);</span>
<a href="#l48.534"></a><span id="l48.534" class="difflineplus">+    if (this.screenSharingStream) {</span>
<a href="#l48.535"></a><span id="l48.535" class="difflineplus">+        console.log(&quot;Adding screen-sharing stream to peer connection&quot;);</span>
<a href="#l48.536"></a><span id="l48.536" class="difflineplus">+        this.peerConn.addStream(this.screenSharingStream);</span>
<a href="#l48.537"></a><span id="l48.537" class="difflineplus">+        // let's use this for the local preview...</span>
<a href="#l48.538"></a><span id="l48.538" class="difflineplus">+        this.localAVStream = this.screenSharingStream;</span>
<a href="#l48.539"></a><span id="l48.539" class="difflineplus">+    }</span>
<a href="#l48.540"></a><span id="l48.540" class="difflineplus">+    this.peerConn.createOffer(</span>
<a href="#l48.541"></a><span id="l48.541" class="difflineplus">+        hookCallback(self, self._gotLocalOffer),</span>
<a href="#l48.542"></a><span id="l48.542" class="difflineplus">+        hookCallback(self, self._getLocalOfferFailed)</span>
<a href="#l48.543"></a><span id="l48.543" class="difflineplus">+    );</span>
<a href="#l48.544"></a><span id="l48.544" class="difflineplus">+    setState(self, 'create_offer');</span>
<a href="#l48.545"></a><span id="l48.545" class="difflineplus">+};</span>
<a href="#l48.546"></a><span id="l48.546" class="difflineplus">+</span>
<a href="#l48.547"></a><span id="l48.547" class="difflineplus">+/**</span>
<a href="#l48.548"></a><span id="l48.548" class="difflineplus">+ * Internal</span>
<a href="#l48.549"></a><span id="l48.549" class="difflineplus">+ * @private</span>
<a href="#l48.550"></a><span id="l48.550" class="difflineplus">+ * @param {Object} stream</span>
<a href="#l48.551"></a><span id="l48.551" class="difflineplus">+ */</span>
<a href="#l48.552"></a><span id="l48.552" class="difflineplus">+MatrixCall.prototype._gotUserMediaForAnswer = function(stream) {</span>
<a href="#l48.553"></a><span id="l48.553" class="difflineplus">+    var self = this;</span>
<a href="#l48.554"></a><span id="l48.554" class="difflineplus">+    if (self.state == 'ended') {</span>
<a href="#l48.555"></a><span id="l48.555" class="difflineplus">+        return;</span>
<a href="#l48.556"></a><span id="l48.556" class="difflineplus">+    }</span>
<a href="#l48.557"></a><span id="l48.557" class="difflineplus">+    var localVidEl = self.getLocalVideoElement();</span>
<a href="#l48.558"></a><span id="l48.558" class="difflineplus">+</span>
<a href="#l48.559"></a><span id="l48.559" class="difflineplus">+    if (localVidEl &amp;&amp; self.type == 'video') {</span>
<a href="#l48.560"></a><span id="l48.560" class="difflineplus">+        localVidEl.autoplay = true;</span>
<a href="#l48.561"></a><span id="l48.561" class="difflineplus">+        this.assignElement(localVidEl,</span>
<a href="#l48.562"></a><span id="l48.562" class="difflineplus">+               this.URL.createObjectURL(stream),</span>
<a href="#l48.563"></a><span id="l48.563" class="difflineplus">+               &quot;localVideo&quot;);</span>
<a href="#l48.564"></a><span id="l48.564" class="difflineplus">+        localVidEl.muted = true;</span>
<a href="#l48.565"></a><span id="l48.565" class="difflineplus">+        setTimeout(function() {</span>
<a href="#l48.566"></a><span id="l48.566" class="difflineplus">+            var vel = self.getLocalVideoElement();</span>
<a href="#l48.567"></a><span id="l48.567" class="difflineplus">+            if (vel.play) {</span>
<a href="#l48.568"></a><span id="l48.568" class="difflineplus">+                self.playElement(vel, &quot;localVideo&quot;);</span>
<a href="#l48.569"></a><span id="l48.569" class="difflineplus">+            }</span>
<a href="#l48.570"></a><span id="l48.570" class="difflineplus">+        }, 0);</span>
<a href="#l48.571"></a><span id="l48.571" class="difflineplus">+    }</span>
<a href="#l48.572"></a><span id="l48.572" class="difflineplus">+</span>
<a href="#l48.573"></a><span id="l48.573" class="difflineplus">+    self.localAVStream = stream;</span>
<a href="#l48.574"></a><span id="l48.574" class="difflineplus">+    setTracksEnabled(stream.getAudioTracks(), true);</span>
<a href="#l48.575"></a><span id="l48.575" class="difflineplus">+    self.peerConn.addStream(stream);</span>
<a href="#l48.576"></a><span id="l48.576" class="difflineplus">+</span>
<a href="#l48.577"></a><span id="l48.577" class="difflineplus">+    var constraints = {</span>
<a href="#l48.578"></a><span id="l48.578" class="difflineplus">+        'mandatory': {</span>
<a href="#l48.579"></a><span id="l48.579" class="difflineplus">+            'OfferToReceiveAudio': true,</span>
<a href="#l48.580"></a><span id="l48.580" class="difflineplus">+            'OfferToReceiveVideo': self.type == 'video'</span>
<a href="#l48.581"></a><span id="l48.581" class="difflineplus">+        }</span>
<a href="#l48.582"></a><span id="l48.582" class="difflineplus">+    };</span>
<a href="#l48.583"></a><span id="l48.583" class="difflineplus">+    self.peerConn.createAnswer(function(description) {</span>
<a href="#l48.584"></a><span id="l48.584" class="difflineplus">+        debuglog(&quot;Created answer: &quot; + description);</span>
<a href="#l48.585"></a><span id="l48.585" class="difflineplus">+        self.peerConn.setLocalDescription(description, function() {</span>
<a href="#l48.586"></a><span id="l48.586" class="difflineplus">+            var content = {</span>
<a href="#l48.587"></a><span id="l48.587" class="difflineplus">+                version: 0,</span>
<a href="#l48.588"></a><span id="l48.588" class="difflineplus">+                call_id: self.callId,</span>
<a href="#l48.589"></a><span id="l48.589" class="difflineplus">+                answer: {</span>
<a href="#l48.590"></a><span id="l48.590" class="difflineplus">+                    sdp: self.peerConn.localDescription.sdp,</span>
<a href="#l48.591"></a><span id="l48.591" class="difflineplus">+                    type: self.peerConn.localDescription.type</span>
<a href="#l48.592"></a><span id="l48.592" class="difflineplus">+                }</span>
<a href="#l48.593"></a><span id="l48.593" class="difflineplus">+            };</span>
<a href="#l48.594"></a><span id="l48.594" class="difflineplus">+            sendEvent(self, 'm.call.answer', content);</span>
<a href="#l48.595"></a><span id="l48.595" class="difflineplus">+            setState(self, 'connecting');</span>
<a href="#l48.596"></a><span id="l48.596" class="difflineplus">+        }, function() {</span>
<a href="#l48.597"></a><span id="l48.597" class="difflineplus">+            debuglog(&quot;Error setting local description!&quot;);</span>
<a href="#l48.598"></a><span id="l48.598" class="difflineplus">+        }, constraints);</span>
<a href="#l48.599"></a><span id="l48.599" class="difflineplus">+    }, function(err) {</span>
<a href="#l48.600"></a><span id="l48.600" class="difflineplus">+        debuglog(&quot;Failed to create answer: &quot; + err);</span>
<a href="#l48.601"></a><span id="l48.601" class="difflineplus">+    });</span>
<a href="#l48.602"></a><span id="l48.602" class="difflineplus">+    setState(self, 'create_answer');</span>
<a href="#l48.603"></a><span id="l48.603" class="difflineplus">+};</span>
<a href="#l48.604"></a><span id="l48.604" class="difflineplus">+</span>
<a href="#l48.605"></a><span id="l48.605" class="difflineplus">+/**</span>
<a href="#l48.606"></a><span id="l48.606" class="difflineplus">+ * Internal</span>
<a href="#l48.607"></a><span id="l48.607" class="difflineplus">+ * @private</span>
<a href="#l48.608"></a><span id="l48.608" class="difflineplus">+ * @param {Object} event</span>
<a href="#l48.609"></a><span id="l48.609" class="difflineplus">+ */</span>
<a href="#l48.610"></a><span id="l48.610" class="difflineplus">+MatrixCall.prototype._gotLocalIceCandidate = function(event) {</span>
<a href="#l48.611"></a><span id="l48.611" class="difflineplus">+    if (event.candidate) {</span>
<a href="#l48.612"></a><span id="l48.612" class="difflineplus">+        debuglog(</span>
<a href="#l48.613"></a><span id="l48.613" class="difflineplus">+            &quot;Got local ICE &quot; + event.candidate.sdpMid + &quot; candidate: &quot; +</span>
<a href="#l48.614"></a><span id="l48.614" class="difflineplus">+            event.candidate.candidate</span>
<a href="#l48.615"></a><span id="l48.615" class="difflineplus">+        );</span>
<a href="#l48.616"></a><span id="l48.616" class="difflineplus">+        // As with the offer, note we need to make a copy of this object, not</span>
<a href="#l48.617"></a><span id="l48.617" class="difflineplus">+        // pass the original: that broke in Chrome ~m43.</span>
<a href="#l48.618"></a><span id="l48.618" class="difflineplus">+        var c = {</span>
<a href="#l48.619"></a><span id="l48.619" class="difflineplus">+            candidate: event.candidate.candidate,</span>
<a href="#l48.620"></a><span id="l48.620" class="difflineplus">+            sdpMid: event.candidate.sdpMid,</span>
<a href="#l48.621"></a><span id="l48.621" class="difflineplus">+            sdpMLineIndex: event.candidate.sdpMLineIndex</span>
<a href="#l48.622"></a><span id="l48.622" class="difflineplus">+        };</span>
<a href="#l48.623"></a><span id="l48.623" class="difflineplus">+        sendCandidate(this, c);</span>
<a href="#l48.624"></a><span id="l48.624" class="difflineplus">+    }</span>
<a href="#l48.625"></a><span id="l48.625" class="difflineplus">+};</span>
<a href="#l48.626"></a><span id="l48.626" class="difflineplus">+</span>
<a href="#l48.627"></a><span id="l48.627" class="difflineplus">+/**</span>
<a href="#l48.628"></a><span id="l48.628" class="difflineplus">+ * Used by MatrixClient.</span>
<a href="#l48.629"></a><span id="l48.629" class="difflineplus">+ * @protected</span>
<a href="#l48.630"></a><span id="l48.630" class="difflineplus">+ * @param {Object} cand</span>
<a href="#l48.631"></a><span id="l48.631" class="difflineplus">+ */</span>
<a href="#l48.632"></a><span id="l48.632" class="difflineplus">+MatrixCall.prototype._gotRemoteIceCandidate = function(cand) {</span>
<a href="#l48.633"></a><span id="l48.633" class="difflineplus">+    if (this.state == 'ended') {</span>
<a href="#l48.634"></a><span id="l48.634" class="difflineplus">+        //debuglog(&quot;Ignoring remote ICE candidate because call has ended&quot;);</span>
<a href="#l48.635"></a><span id="l48.635" class="difflineplus">+        return;</span>
<a href="#l48.636"></a><span id="l48.636" class="difflineplus">+    }</span>
<a href="#l48.637"></a><span id="l48.637" class="difflineplus">+    debuglog(&quot;Got remote ICE &quot; + cand.sdpMid + &quot; candidate: &quot; + cand.candidate);</span>
<a href="#l48.638"></a><span id="l48.638" class="difflineplus">+    this.peerConn.addIceCandidate(</span>
<a href="#l48.639"></a><span id="l48.639" class="difflineplus">+        new this.webRtc.RtcIceCandidate(cand),</span>
<a href="#l48.640"></a><span id="l48.640" class="difflineplus">+        function() {},</span>
<a href="#l48.641"></a><span id="l48.641" class="difflineplus">+        function(e) {}</span>
<a href="#l48.642"></a><span id="l48.642" class="difflineplus">+    );</span>
<a href="#l48.643"></a><span id="l48.643" class="difflineplus">+};</span>
<a href="#l48.644"></a><span id="l48.644" class="difflineplus">+</span>
<a href="#l48.645"></a><span id="l48.645" class="difflineplus">+/**</span>
<a href="#l48.646"></a><span id="l48.646" class="difflineplus">+ * Used by MatrixClient.</span>
<a href="#l48.647"></a><span id="l48.647" class="difflineplus">+ * @protected</span>
<a href="#l48.648"></a><span id="l48.648" class="difflineplus">+ * @param {Object} msg</span>
<a href="#l48.649"></a><span id="l48.649" class="difflineplus">+ */</span>
<a href="#l48.650"></a><span id="l48.650" class="difflineplus">+MatrixCall.prototype._receivedAnswer = function(msg) {</span>
<a href="#l48.651"></a><span id="l48.651" class="difflineplus">+    if (this.state == 'ended') {</span>
<a href="#l48.652"></a><span id="l48.652" class="difflineplus">+        return;</span>
<a href="#l48.653"></a><span id="l48.653" class="difflineplus">+    }</span>
<a href="#l48.654"></a><span id="l48.654" class="difflineplus">+</span>
<a href="#l48.655"></a><span id="l48.655" class="difflineplus">+    var self = this;</span>
<a href="#l48.656"></a><span id="l48.656" class="difflineplus">+    this.peerConn.setRemoteDescription(</span>
<a href="#l48.657"></a><span id="l48.657" class="difflineplus">+        new this.webRtc.RtcSessionDescription(msg.answer),</span>
<a href="#l48.658"></a><span id="l48.658" class="difflineplus">+        hookCallback(self, self._onSetRemoteDescriptionSuccess),</span>
<a href="#l48.659"></a><span id="l48.659" class="difflineplus">+        hookCallback(self, self._onSetRemoteDescriptionError)</span>
<a href="#l48.660"></a><span id="l48.660" class="difflineplus">+    );</span>
<a href="#l48.661"></a><span id="l48.661" class="difflineplus">+    setState(self, 'connecting');</span>
<a href="#l48.662"></a><span id="l48.662" class="difflineplus">+};</span>
<a href="#l48.663"></a><span id="l48.663" class="difflineplus">+</span>
<a href="#l48.664"></a><span id="l48.664" class="difflineplus">+/**</span>
<a href="#l48.665"></a><span id="l48.665" class="difflineplus">+ * Internal</span>
<a href="#l48.666"></a><span id="l48.666" class="difflineplus">+ * @private</span>
<a href="#l48.667"></a><span id="l48.667" class="difflineplus">+ * @param {Object} description</span>
<a href="#l48.668"></a><span id="l48.668" class="difflineplus">+ */</span>
<a href="#l48.669"></a><span id="l48.669" class="difflineplus">+MatrixCall.prototype._gotLocalOffer = function(description) {</span>
<a href="#l48.670"></a><span id="l48.670" class="difflineplus">+    var self = this;</span>
<a href="#l48.671"></a><span id="l48.671" class="difflineplus">+    debuglog(&quot;Created offer: &quot; + description);</span>
<a href="#l48.672"></a><span id="l48.672" class="difflineplus">+</span>
<a href="#l48.673"></a><span id="l48.673" class="difflineplus">+    if (self.state == 'ended') {</span>
<a href="#l48.674"></a><span id="l48.674" class="difflineplus">+        debuglog(&quot;Ignoring newly created offer on call ID &quot; + self.callId +</span>
<a href="#l48.675"></a><span id="l48.675" class="difflineplus">+            &quot; because the call has ended&quot;);</span>
<a href="#l48.676"></a><span id="l48.676" class="difflineplus">+        return;</span>
<a href="#l48.677"></a><span id="l48.677" class="difflineplus">+    }</span>
<a href="#l48.678"></a><span id="l48.678" class="difflineplus">+</span>
<a href="#l48.679"></a><span id="l48.679" class="difflineplus">+    self.peerConn.setLocalDescription(description, function() {</span>
<a href="#l48.680"></a><span id="l48.680" class="difflineplus">+        var content = {</span>
<a href="#l48.681"></a><span id="l48.681" class="difflineplus">+            version: 0,</span>
<a href="#l48.682"></a><span id="l48.682" class="difflineplus">+            call_id: self.callId,</span>
<a href="#l48.683"></a><span id="l48.683" class="difflineplus">+            // OpenWebRTC appears to add extra stuff (like the DTLS fingerprint)</span>
<a href="#l48.684"></a><span id="l48.684" class="difflineplus">+            // to the description when setting it on the peerconnection.</span>
<a href="#l48.685"></a><span id="l48.685" class="difflineplus">+            // According to the spec it should only add ICE</span>
<a href="#l48.686"></a><span id="l48.686" class="difflineplus">+            // candidates. Any ICE candidates that have already been generated</span>
<a href="#l48.687"></a><span id="l48.687" class="difflineplus">+            // at this point will probably be sent both in the offer and separately.</span>
<a href="#l48.688"></a><span id="l48.688" class="difflineplus">+            // Also, note that we have to make a new object here, copying the</span>
<a href="#l48.689"></a><span id="l48.689" class="difflineplus">+            // type and sdp properties.</span>
<a href="#l48.690"></a><span id="l48.690" class="difflineplus">+            // Passing the RTCSessionDescription object as-is doesn't work in</span>
<a href="#l48.691"></a><span id="l48.691" class="difflineplus">+            // Chrome (as of about m43).</span>
<a href="#l48.692"></a><span id="l48.692" class="difflineplus">+            offer: {</span>
<a href="#l48.693"></a><span id="l48.693" class="difflineplus">+                sdp: self.peerConn.localDescription.sdp,</span>
<a href="#l48.694"></a><span id="l48.694" class="difflineplus">+                type: self.peerConn.localDescription.type</span>
<a href="#l48.695"></a><span id="l48.695" class="difflineplus">+            },</span>
<a href="#l48.696"></a><span id="l48.696" class="difflineplus">+            lifetime: MatrixCall.CALL_TIMEOUT_MS</span>
<a href="#l48.697"></a><span id="l48.697" class="difflineplus">+        };</span>
<a href="#l48.698"></a><span id="l48.698" class="difflineplus">+        sendEvent(self, 'm.call.invite', content);</span>
<a href="#l48.699"></a><span id="l48.699" class="difflineplus">+</span>
<a href="#l48.700"></a><span id="l48.700" class="difflineplus">+        setTimeout(function() {</span>
<a href="#l48.701"></a><span id="l48.701" class="difflineplus">+            if (self.state == 'invite_sent') {</span>
<a href="#l48.702"></a><span id="l48.702" class="difflineplus">+                self.hangup('invite_timeout');</span>
<a href="#l48.703"></a><span id="l48.703" class="difflineplus">+            }</span>
<a href="#l48.704"></a><span id="l48.704" class="difflineplus">+        }, MatrixCall.CALL_TIMEOUT_MS);</span>
<a href="#l48.705"></a><span id="l48.705" class="difflineplus">+        setState(self, 'invite_sent');</span>
<a href="#l48.706"></a><span id="l48.706" class="difflineplus">+    }, function() {</span>
<a href="#l48.707"></a><span id="l48.707" class="difflineplus">+        debuglog(&quot;Error setting local description!&quot;);</span>
<a href="#l48.708"></a><span id="l48.708" class="difflineplus">+    });</span>
<a href="#l48.709"></a><span id="l48.709" class="difflineplus">+};</span>
<a href="#l48.710"></a><span id="l48.710" class="difflineplus">+</span>
<a href="#l48.711"></a><span id="l48.711" class="difflineplus">+/**</span>
<a href="#l48.712"></a><span id="l48.712" class="difflineplus">+ * Internal</span>
<a href="#l48.713"></a><span id="l48.713" class="difflineplus">+ * @private</span>
<a href="#l48.714"></a><span id="l48.714" class="difflineplus">+ * @param {Object} error</span>
<a href="#l48.715"></a><span id="l48.715" class="difflineplus">+ */</span>
<a href="#l48.716"></a><span id="l48.716" class="difflineplus">+MatrixCall.prototype._getLocalOfferFailed = function(error) {</span>
<a href="#l48.717"></a><span id="l48.717" class="difflineplus">+    this.emit(</span>
<a href="#l48.718"></a><span id="l48.718" class="difflineplus">+        &quot;error&quot;,</span>
<a href="#l48.719"></a><span id="l48.719" class="difflineplus">+        callError(MatrixCall.ERR_LOCAL_OFFER_FAILED, &quot;Failed to start audio for call!&quot;)</span>
<a href="#l48.720"></a><span id="l48.720" class="difflineplus">+    );</span>
<a href="#l48.721"></a><span id="l48.721" class="difflineplus">+};</span>
<a href="#l48.722"></a><span id="l48.722" class="difflineplus">+</span>
<a href="#l48.723"></a><span id="l48.723" class="difflineplus">+/**</span>
<a href="#l48.724"></a><span id="l48.724" class="difflineplus">+ * Internal</span>
<a href="#l48.725"></a><span id="l48.725" class="difflineplus">+ * @private</span>
<a href="#l48.726"></a><span id="l48.726" class="difflineplus">+ * @param {Object} error</span>
<a href="#l48.727"></a><span id="l48.727" class="difflineplus">+ */</span>
<a href="#l48.728"></a><span id="l48.728" class="difflineplus">+MatrixCall.prototype._getUserMediaFailed = function(error) {</span>
<a href="#l48.729"></a><span id="l48.729" class="difflineplus">+    this.emit(</span>
<a href="#l48.730"></a><span id="l48.730" class="difflineplus">+        &quot;error&quot;,</span>
<a href="#l48.731"></a><span id="l48.731" class="difflineplus">+        callError(</span>
<a href="#l48.732"></a><span id="l48.732" class="difflineplus">+            MatrixCall.ERR_NO_USER_MEDIA,</span>
<a href="#l48.733"></a><span id="l48.733" class="difflineplus">+            &quot;Couldn't start capturing media! Is your microphone set up and &quot; +</span>
<a href="#l48.734"></a><span id="l48.734" class="difflineplus">+            &quot;does this app have permission?&quot;</span>
<a href="#l48.735"></a><span id="l48.735" class="difflineplus">+        )</span>
<a href="#l48.736"></a><span id="l48.736" class="difflineplus">+    );</span>
<a href="#l48.737"></a><span id="l48.737" class="difflineplus">+    this.hangup(&quot;user_media_failed&quot;);</span>
<a href="#l48.738"></a><span id="l48.738" class="difflineplus">+};</span>
<a href="#l48.739"></a><span id="l48.739" class="difflineplus">+</span>
<a href="#l48.740"></a><span id="l48.740" class="difflineplus">+/**</span>
<a href="#l48.741"></a><span id="l48.741" class="difflineplus">+ * Internal</span>
<a href="#l48.742"></a><span id="l48.742" class="difflineplus">+ * @private</span>
<a href="#l48.743"></a><span id="l48.743" class="difflineplus">+ */</span>
<a href="#l48.744"></a><span id="l48.744" class="difflineplus">+MatrixCall.prototype._onIceConnectionStateChanged = function() {</span>
<a href="#l48.745"></a><span id="l48.745" class="difflineplus">+    if (this.state == 'ended') {</span>
<a href="#l48.746"></a><span id="l48.746" class="difflineplus">+        return; // because ICE can still complete as we're ending the call</span>
<a href="#l48.747"></a><span id="l48.747" class="difflineplus">+    }</span>
<a href="#l48.748"></a><span id="l48.748" class="difflineplus">+    debuglog(</span>
<a href="#l48.749"></a><span id="l48.749" class="difflineplus">+        &quot;Ice connection state changed to: &quot; + this.peerConn.iceConnectionState</span>
<a href="#l48.750"></a><span id="l48.750" class="difflineplus">+    );</span>
<a href="#l48.751"></a><span id="l48.751" class="difflineplus">+    // ideally we'd consider the call to be connected when we get media but</span>
<a href="#l48.752"></a><span id="l48.752" class="difflineplus">+    // chrome doesn't implement any of the 'onstarted' events yet</span>
<a href="#l48.753"></a><span id="l48.753" class="difflineplus">+    if (this.peerConn.iceConnectionState == 'completed' ||</span>
<a href="#l48.754"></a><span id="l48.754" class="difflineplus">+            this.peerConn.iceConnectionState == 'connected') {</span>
<a href="#l48.755"></a><span id="l48.755" class="difflineplus">+        setState(this, 'connected');</span>
<a href="#l48.756"></a><span id="l48.756" class="difflineplus">+        this.didConnect = true;</span>
<a href="#l48.757"></a><span id="l48.757" class="difflineplus">+    } else if (this.peerConn.iceConnectionState == 'failed') {</span>
<a href="#l48.758"></a><span id="l48.758" class="difflineplus">+        this.hangup('ice_failed');</span>
<a href="#l48.759"></a><span id="l48.759" class="difflineplus">+    }</span>
<a href="#l48.760"></a><span id="l48.760" class="difflineplus">+};</span>
<a href="#l48.761"></a><span id="l48.761" class="difflineplus">+</span>
<a href="#l48.762"></a><span id="l48.762" class="difflineplus">+/**</span>
<a href="#l48.763"></a><span id="l48.763" class="difflineplus">+ * Internal</span>
<a href="#l48.764"></a><span id="l48.764" class="difflineplus">+ * @private</span>
<a href="#l48.765"></a><span id="l48.765" class="difflineplus">+ */</span>
<a href="#l48.766"></a><span id="l48.766" class="difflineplus">+MatrixCall.prototype._onSignallingStateChanged = function() {</span>
<a href="#l48.767"></a><span id="l48.767" class="difflineplus">+    debuglog(</span>
<a href="#l48.768"></a><span id="l48.768" class="difflineplus">+        &quot;call &quot; + this.callId + &quot;: Signalling state changed to: &quot; +</span>
<a href="#l48.769"></a><span id="l48.769" class="difflineplus">+        this.peerConn.signalingState</span>
<a href="#l48.770"></a><span id="l48.770" class="difflineplus">+    );</span>
<a href="#l48.771"></a><span id="l48.771" class="difflineplus">+};</span>
<a href="#l48.772"></a><span id="l48.772" class="difflineplus">+</span>
<a href="#l48.773"></a><span id="l48.773" class="difflineplus">+/**</span>
<a href="#l48.774"></a><span id="l48.774" class="difflineplus">+ * Internal</span>
<a href="#l48.775"></a><span id="l48.775" class="difflineplus">+ * @private</span>
<a href="#l48.776"></a><span id="l48.776" class="difflineplus">+ */</span>
<a href="#l48.777"></a><span id="l48.777" class="difflineplus">+MatrixCall.prototype._onSetRemoteDescriptionSuccess = function() {</span>
<a href="#l48.778"></a><span id="l48.778" class="difflineplus">+    debuglog(&quot;Set remote description&quot;);</span>
<a href="#l48.779"></a><span id="l48.779" class="difflineplus">+};</span>
<a href="#l48.780"></a><span id="l48.780" class="difflineplus">+</span>
<a href="#l48.781"></a><span id="l48.781" class="difflineplus">+/**</span>
<a href="#l48.782"></a><span id="l48.782" class="difflineplus">+ * Internal</span>
<a href="#l48.783"></a><span id="l48.783" class="difflineplus">+ * @private</span>
<a href="#l48.784"></a><span id="l48.784" class="difflineplus">+ * @param {Object} e</span>
<a href="#l48.785"></a><span id="l48.785" class="difflineplus">+ */</span>
<a href="#l48.786"></a><span id="l48.786" class="difflineplus">+MatrixCall.prototype._onSetRemoteDescriptionError = function(e) {</span>
<a href="#l48.787"></a><span id="l48.787" class="difflineplus">+    debuglog(&quot;Failed to set remote description&quot; + e);</span>
<a href="#l48.788"></a><span id="l48.788" class="difflineplus">+};</span>
<a href="#l48.789"></a><span id="l48.789" class="difflineplus">+</span>
<a href="#l48.790"></a><span id="l48.790" class="difflineplus">+/**</span>
<a href="#l48.791"></a><span id="l48.791" class="difflineplus">+ * Internal</span>
<a href="#l48.792"></a><span id="l48.792" class="difflineplus">+ * @private</span>
<a href="#l48.793"></a><span id="l48.793" class="difflineplus">+ * @param {Object} event</span>
<a href="#l48.794"></a><span id="l48.794" class="difflineplus">+ */</span>
<a href="#l48.795"></a><span id="l48.795" class="difflineplus">+MatrixCall.prototype._onAddStream = function(event) {</span>
<a href="#l48.796"></a><span id="l48.796" class="difflineplus">+    debuglog(&quot;Stream id &quot; + event.stream.id + &quot; added&quot;);</span>
<a href="#l48.797"></a><span id="l48.797" class="difflineplus">+</span>
<a href="#l48.798"></a><span id="l48.798" class="difflineplus">+    var s = event.stream;</span>
<a href="#l48.799"></a><span id="l48.799" class="difflineplus">+</span>
<a href="#l48.800"></a><span id="l48.800" class="difflineplus">+    if (s.getVideoTracks().length &gt; 0) {</span>
<a href="#l48.801"></a><span id="l48.801" class="difflineplus">+        this.type = 'video';</span>
<a href="#l48.802"></a><span id="l48.802" class="difflineplus">+        this.remoteAVStream = s;</span>
<a href="#l48.803"></a><span id="l48.803" class="difflineplus">+        this.remoteAStream = s;</span>
<a href="#l48.804"></a><span id="l48.804" class="difflineplus">+    } else {</span>
<a href="#l48.805"></a><span id="l48.805" class="difflineplus">+        this.type = 'voice';</span>
<a href="#l48.806"></a><span id="l48.806" class="difflineplus">+        this.remoteAStream = s;</span>
<a href="#l48.807"></a><span id="l48.807" class="difflineplus">+    }</span>
<a href="#l48.808"></a><span id="l48.808" class="difflineplus">+</span>
<a href="#l48.809"></a><span id="l48.809" class="difflineplus">+    var self = this;</span>
<a href="#l48.810"></a><span id="l48.810" class="difflineplus">+    forAllTracksOnStream(s, function(t) {</span>
<a href="#l48.811"></a><span id="l48.811" class="difflineplus">+        debuglog(&quot;Track id &quot; + t.id + &quot; added&quot;);</span>
<a href="#l48.812"></a><span id="l48.812" class="difflineplus">+        // not currently implemented in chrome</span>
<a href="#l48.813"></a><span id="l48.813" class="difflineplus">+        t.onstarted = hookCallback(self, self._onRemoteStreamTrackStarted);</span>
<a href="#l48.814"></a><span id="l48.814" class="difflineplus">+    });</span>
<a href="#l48.815"></a><span id="l48.815" class="difflineplus">+</span>
<a href="#l48.816"></a><span id="l48.816" class="difflineplus">+    if (event.stream.oninactive !== undefined) {</span>
<a href="#l48.817"></a><span id="l48.817" class="difflineplus">+        event.stream.oninactive = hookCallback(self, self._onRemoteStreamEnded);</span>
<a href="#l48.818"></a><span id="l48.818" class="difflineplus">+    }</span>
<a href="#l48.819"></a><span id="l48.819" class="difflineplus">+    else {</span>
<a href="#l48.820"></a><span id="l48.820" class="difflineplus">+        // onended is deprecated from Chrome 54</span>
<a href="#l48.821"></a><span id="l48.821" class="difflineplus">+        event.stream.onended = hookCallback(self, self._onRemoteStreamEnded);</span>
<a href="#l48.822"></a><span id="l48.822" class="difflineplus">+    }</span>
<a href="#l48.823"></a><span id="l48.823" class="difflineplus">+</span>
<a href="#l48.824"></a><span id="l48.824" class="difflineplus">+    // not currently implemented in chrome</span>
<a href="#l48.825"></a><span id="l48.825" class="difflineplus">+    event.stream.onstarted = hookCallback(self, self._onRemoteStreamStarted);</span>
<a href="#l48.826"></a><span id="l48.826" class="difflineplus">+</span>
<a href="#l48.827"></a><span id="l48.827" class="difflineplus">+    if (this.type === 'video') {</span>
<a href="#l48.828"></a><span id="l48.828" class="difflineplus">+        _tryPlayRemoteStream(this);</span>
<a href="#l48.829"></a><span id="l48.829" class="difflineplus">+        _tryPlayRemoteAudioStream(this);</span>
<a href="#l48.830"></a><span id="l48.830" class="difflineplus">+    }</span>
<a href="#l48.831"></a><span id="l48.831" class="difflineplus">+    else {</span>
<a href="#l48.832"></a><span id="l48.832" class="difflineplus">+        _tryPlayRemoteAudioStream(this);</span>
<a href="#l48.833"></a><span id="l48.833" class="difflineplus">+    }</span>
<a href="#l48.834"></a><span id="l48.834" class="difflineplus">+};</span>
<a href="#l48.835"></a><span id="l48.835" class="difflineplus">+</span>
<a href="#l48.836"></a><span id="l48.836" class="difflineplus">+/**</span>
<a href="#l48.837"></a><span id="l48.837" class="difflineplus">+ * Internal</span>
<a href="#l48.838"></a><span id="l48.838" class="difflineplus">+ * @private</span>
<a href="#l48.839"></a><span id="l48.839" class="difflineplus">+ * @param {Object} event</span>
<a href="#l48.840"></a><span id="l48.840" class="difflineplus">+ */</span>
<a href="#l48.841"></a><span id="l48.841" class="difflineplus">+MatrixCall.prototype._onRemoteStreamStarted = function(event) {</span>
<a href="#l48.842"></a><span id="l48.842" class="difflineplus">+    setState(this, 'connected');</span>
<a href="#l48.843"></a><span id="l48.843" class="difflineplus">+};</span>
<a href="#l48.844"></a><span id="l48.844" class="difflineplus">+</span>
<a href="#l48.845"></a><span id="l48.845" class="difflineplus">+/**</span>
<a href="#l48.846"></a><span id="l48.846" class="difflineplus">+ * Internal</span>
<a href="#l48.847"></a><span id="l48.847" class="difflineplus">+ * @private</span>
<a href="#l48.848"></a><span id="l48.848" class="difflineplus">+ * @param {Object} event</span>
<a href="#l48.849"></a><span id="l48.849" class="difflineplus">+ */</span>
<a href="#l48.850"></a><span id="l48.850" class="difflineplus">+MatrixCall.prototype._onRemoteStreamEnded = function(event) {</span>
<a href="#l48.851"></a><span id="l48.851" class="difflineplus">+    debuglog(&quot;Remote stream ended&quot;);</span>
<a href="#l48.852"></a><span id="l48.852" class="difflineplus">+    this.hangupParty = 'remote';</span>
<a href="#l48.853"></a><span id="l48.853" class="difflineplus">+    setState(this, 'ended');</span>
<a href="#l48.854"></a><span id="l48.854" class="difflineplus">+    stopAllMedia(this);</span>
<a href="#l48.855"></a><span id="l48.855" class="difflineplus">+    if (this.peerConn.signalingState != 'closed') {</span>
<a href="#l48.856"></a><span id="l48.856" class="difflineplus">+        this.peerConn.close();</span>
<a href="#l48.857"></a><span id="l48.857" class="difflineplus">+    }</span>
<a href="#l48.858"></a><span id="l48.858" class="difflineplus">+    this.emit(&quot;hangup&quot;, this);</span>
<a href="#l48.859"></a><span id="l48.859" class="difflineplus">+};</span>
<a href="#l48.860"></a><span id="l48.860" class="difflineplus">+</span>
<a href="#l48.861"></a><span id="l48.861" class="difflineplus">+/**</span>
<a href="#l48.862"></a><span id="l48.862" class="difflineplus">+ * Internal</span>
<a href="#l48.863"></a><span id="l48.863" class="difflineplus">+ * @private</span>
<a href="#l48.864"></a><span id="l48.864" class="difflineplus">+ * @param {Object} event</span>
<a href="#l48.865"></a><span id="l48.865" class="difflineplus">+ */</span>
<a href="#l48.866"></a><span id="l48.866" class="difflineplus">+MatrixCall.prototype._onRemoteStreamTrackStarted = function(event) {</span>
<a href="#l48.867"></a><span id="l48.867" class="difflineplus">+    setState(this, 'connected');</span>
<a href="#l48.868"></a><span id="l48.868" class="difflineplus">+};</span>
<a href="#l48.869"></a><span id="l48.869" class="difflineplus">+</span>
<a href="#l48.870"></a><span id="l48.870" class="difflineplus">+/**</span>
<a href="#l48.871"></a><span id="l48.871" class="difflineplus">+ * Used by MatrixClient.</span>
<a href="#l48.872"></a><span id="l48.872" class="difflineplus">+ * @protected</span>
<a href="#l48.873"></a><span id="l48.873" class="difflineplus">+ * @param {Object} msg</span>
<a href="#l48.874"></a><span id="l48.874" class="difflineplus">+ */</span>
<a href="#l48.875"></a><span id="l48.875" class="difflineplus">+MatrixCall.prototype._onHangupReceived = function(msg) {</span>
<a href="#l48.876"></a><span id="l48.876" class="difflineplus">+    debuglog(&quot;Hangup received&quot;);</span>
<a href="#l48.877"></a><span id="l48.877" class="difflineplus">+    terminate(this, &quot;remote&quot;, msg.reason, true);</span>
<a href="#l48.878"></a><span id="l48.878" class="difflineplus">+};</span>
<a href="#l48.879"></a><span id="l48.879" class="difflineplus">+</span>
<a href="#l48.880"></a><span id="l48.880" class="difflineplus">+/**</span>
<a href="#l48.881"></a><span id="l48.881" class="difflineplus">+ * Used by MatrixClient.</span>
<a href="#l48.882"></a><span id="l48.882" class="difflineplus">+ * @protected</span>
<a href="#l48.883"></a><span id="l48.883" class="difflineplus">+ * @param {Object} msg</span>
<a href="#l48.884"></a><span id="l48.884" class="difflineplus">+ */</span>
<a href="#l48.885"></a><span id="l48.885" class="difflineplus">+MatrixCall.prototype._onAnsweredElsewhere = function(msg) {</span>
<a href="#l48.886"></a><span id="l48.886" class="difflineplus">+    debuglog(&quot;Answered elsewhere&quot;);</span>
<a href="#l48.887"></a><span id="l48.887" class="difflineplus">+    terminate(this, &quot;remote&quot;, &quot;answered_elsewhere&quot;, true);</span>
<a href="#l48.888"></a><span id="l48.888" class="difflineplus">+};</span>
<a href="#l48.889"></a><span id="l48.889" class="difflineplus">+</span>
<a href="#l48.890"></a><span id="l48.890" class="difflineplus">+var setTracksEnabled = function(tracks, enabled) {</span>
<a href="#l48.891"></a><span id="l48.891" class="difflineplus">+    for (var i = 0; i &lt; tracks.length; i++) {</span>
<a href="#l48.892"></a><span id="l48.892" class="difflineplus">+        tracks[i].enabled = enabled;</span>
<a href="#l48.893"></a><span id="l48.893" class="difflineplus">+    }</span>
<a href="#l48.894"></a><span id="l48.894" class="difflineplus">+};</span>
<a href="#l48.895"></a><span id="l48.895" class="difflineplus">+</span>
<a href="#l48.896"></a><span id="l48.896" class="difflineplus">+var isTracksEnabled = function(tracks) {</span>
<a href="#l48.897"></a><span id="l48.897" class="difflineplus">+    for (var i = 0; i &lt; tracks.length; i++) {</span>
<a href="#l48.898"></a><span id="l48.898" class="difflineplus">+        if (tracks[i].enabled) {</span>
<a href="#l48.899"></a><span id="l48.899" class="difflineplus">+            return true; // at least one track is enabled</span>
<a href="#l48.900"></a><span id="l48.900" class="difflineplus">+        }</span>
<a href="#l48.901"></a><span id="l48.901" class="difflineplus">+    }</span>
<a href="#l48.902"></a><span id="l48.902" class="difflineplus">+    return false;</span>
<a href="#l48.903"></a><span id="l48.903" class="difflineplus">+};</span>
<a href="#l48.904"></a><span id="l48.904" class="difflineplus">+</span>
<a href="#l48.905"></a><span id="l48.905" class="difflineplus">+var setState = function(self, state) {</span>
<a href="#l48.906"></a><span id="l48.906" class="difflineplus">+    var oldState = self.state;</span>
<a href="#l48.907"></a><span id="l48.907" class="difflineplus">+    self.state = state;</span>
<a href="#l48.908"></a><span id="l48.908" class="difflineplus">+    self.emit(&quot;state&quot;, state, oldState);</span>
<a href="#l48.909"></a><span id="l48.909" class="difflineplus">+};</span>
<a href="#l48.910"></a><span id="l48.910" class="difflineplus">+</span>
<a href="#l48.911"></a><span id="l48.911" class="difflineplus">+/**</span>
<a href="#l48.912"></a><span id="l48.912" class="difflineplus">+ * Internal</span>
<a href="#l48.913"></a><span id="l48.913" class="difflineplus">+ * @param {MatrixCall} self</span>
<a href="#l48.914"></a><span id="l48.914" class="difflineplus">+ * @param {string} eventType</span>
<a href="#l48.915"></a><span id="l48.915" class="difflineplus">+ * @param {Object} content</span>
<a href="#l48.916"></a><span id="l48.916" class="difflineplus">+ * @return {Promise}</span>
<a href="#l48.917"></a><span id="l48.917" class="difflineplus">+ */</span>
<a href="#l48.918"></a><span id="l48.918" class="difflineplus">+var sendEvent = function(self, eventType, content) {</span>
<a href="#l48.919"></a><span id="l48.919" class="difflineplus">+    return self.client.sendEvent(self.roomId, eventType, content);</span>
<a href="#l48.920"></a><span id="l48.920" class="difflineplus">+};</span>
<a href="#l48.921"></a><span id="l48.921" class="difflineplus">+</span>
<a href="#l48.922"></a><span id="l48.922" class="difflineplus">+var sendCandidate = function(self, content) {</span>
<a href="#l48.923"></a><span id="l48.923" class="difflineplus">+    // Sends candidates with are sent in a special way because we try to amalgamate</span>
<a href="#l48.924"></a><span id="l48.924" class="difflineplus">+    // them into one message</span>
<a href="#l48.925"></a><span id="l48.925" class="difflineplus">+    self.candidateSendQueue.push(content);</span>
<a href="#l48.926"></a><span id="l48.926" class="difflineplus">+    if (self.candidateSendTries === 0) {</span>
<a href="#l48.927"></a><span id="l48.927" class="difflineplus">+        setTimeout(function() {</span>
<a href="#l48.928"></a><span id="l48.928" class="difflineplus">+            _sendCandidateQueue(self);</span>
<a href="#l48.929"></a><span id="l48.929" class="difflineplus">+        }, 100);</span>
<a href="#l48.930"></a><span id="l48.930" class="difflineplus">+    }</span>
<a href="#l48.931"></a><span id="l48.931" class="difflineplus">+};</span>
<a href="#l48.932"></a><span id="l48.932" class="difflineplus">+</span>
<a href="#l48.933"></a><span id="l48.933" class="difflineplus">+var terminate = function(self, hangupParty, hangupReason, shouldEmit) {</span>
<a href="#l48.934"></a><span id="l48.934" class="difflineplus">+    if (self.getRemoteVideoElement()) {</span>
<a href="#l48.935"></a><span id="l48.935" class="difflineplus">+        if (self.getRemoteVideoElement().pause) {</span>
<a href="#l48.936"></a><span id="l48.936" class="difflineplus">+            self.pauseElement(self.getRemoteVideoElement(), &quot;remoteVideo&quot;);</span>
<a href="#l48.937"></a><span id="l48.937" class="difflineplus">+        }</span>
<a href="#l48.938"></a><span id="l48.938" class="difflineplus">+        self.assignElement(self.getRemoteVideoElement(), &quot;&quot;, &quot;remoteVideo&quot;);</span>
<a href="#l48.939"></a><span id="l48.939" class="difflineplus">+    }</span>
<a href="#l48.940"></a><span id="l48.940" class="difflineplus">+    if (self.getRemoteAudioElement()) {</span>
<a href="#l48.941"></a><span id="l48.941" class="difflineplus">+        if (self.getRemoteAudioElement().pause) {</span>
<a href="#l48.942"></a><span id="l48.942" class="difflineplus">+            self.pauseElement(self.getRemoteAudioElement(), &quot;remoteAudio&quot;);</span>
<a href="#l48.943"></a><span id="l48.943" class="difflineplus">+        }</span>
<a href="#l48.944"></a><span id="l48.944" class="difflineplus">+        self.assignElement(self.getRemoteAudioElement(), &quot;&quot;, &quot;remoteAudio&quot;);</span>
<a href="#l48.945"></a><span id="l48.945" class="difflineplus">+    }</span>
<a href="#l48.946"></a><span id="l48.946" class="difflineplus">+    if (self.getLocalVideoElement()) {</span>
<a href="#l48.947"></a><span id="l48.947" class="difflineplus">+        if (self.getLocalVideoElement().pause) {</span>
<a href="#l48.948"></a><span id="l48.948" class="difflineplus">+            self.pauseElement(self.getLocalVideoElement(), &quot;localVideo&quot;);</span>
<a href="#l48.949"></a><span id="l48.949" class="difflineplus">+        }</span>
<a href="#l48.950"></a><span id="l48.950" class="difflineplus">+        self.assignElement(self.getLocalVideoElement(), &quot;&quot;, &quot;localVideo&quot;);</span>
<a href="#l48.951"></a><span id="l48.951" class="difflineplus">+    }</span>
<a href="#l48.952"></a><span id="l48.952" class="difflineplus">+    self.hangupParty = hangupParty;</span>
<a href="#l48.953"></a><span id="l48.953" class="difflineplus">+    self.hangupReason = hangupReason;</span>
<a href="#l48.954"></a><span id="l48.954" class="difflineplus">+    setState(self, 'ended');</span>
<a href="#l48.955"></a><span id="l48.955" class="difflineplus">+    stopAllMedia(self);</span>
<a href="#l48.956"></a><span id="l48.956" class="difflineplus">+    if (self.peerConn &amp;&amp; self.peerConn.signalingState !== 'closed') {</span>
<a href="#l48.957"></a><span id="l48.957" class="difflineplus">+        self.peerConn.close();</span>
<a href="#l48.958"></a><span id="l48.958" class="difflineplus">+    }</span>
<a href="#l48.959"></a><span id="l48.959" class="difflineplus">+    if (shouldEmit) {</span>
<a href="#l48.960"></a><span id="l48.960" class="difflineplus">+        self.emit(&quot;hangup&quot;, self);</span>
<a href="#l48.961"></a><span id="l48.961" class="difflineplus">+    }</span>
<a href="#l48.962"></a><span id="l48.962" class="difflineplus">+};</span>
<a href="#l48.963"></a><span id="l48.963" class="difflineplus">+</span>
<a href="#l48.964"></a><span id="l48.964" class="difflineplus">+var stopAllMedia = function(self) {</span>
<a href="#l48.965"></a><span id="l48.965" class="difflineplus">+    debuglog(&quot;stopAllMedia (stream=%s)&quot;, self.localAVStream);</span>
<a href="#l48.966"></a><span id="l48.966" class="difflineplus">+    if (self.localAVStream) {</span>
<a href="#l48.967"></a><span id="l48.967" class="difflineplus">+        forAllTracksOnStream(self.localAVStream, function(t) {</span>
<a href="#l48.968"></a><span id="l48.968" class="difflineplus">+            if (t.stop) {</span>
<a href="#l48.969"></a><span id="l48.969" class="difflineplus">+                t.stop();</span>
<a href="#l48.970"></a><span id="l48.970" class="difflineplus">+            }</span>
<a href="#l48.971"></a><span id="l48.971" class="difflineplus">+        });</span>
<a href="#l48.972"></a><span id="l48.972" class="difflineplus">+        // also call stop on the main stream so firefox will stop sharing</span>
<a href="#l48.973"></a><span id="l48.973" class="difflineplus">+        // the mic</span>
<a href="#l48.974"></a><span id="l48.974" class="difflineplus">+        if (self.localAVStream.stop) {</span>
<a href="#l48.975"></a><span id="l48.975" class="difflineplus">+            self.localAVStream.stop();</span>
<a href="#l48.976"></a><span id="l48.976" class="difflineplus">+        }</span>
<a href="#l48.977"></a><span id="l48.977" class="difflineplus">+    }</span>
<a href="#l48.978"></a><span id="l48.978" class="difflineplus">+    if (self.screenSharingStream) {</span>
<a href="#l48.979"></a><span id="l48.979" class="difflineplus">+        forAllTracksOnStream(self.screenSharingStream, function(t) {</span>
<a href="#l48.980"></a><span id="l48.980" class="difflineplus">+            if (t.stop) {</span>
<a href="#l48.981"></a><span id="l48.981" class="difflineplus">+                t.stop();</span>
<a href="#l48.982"></a><span id="l48.982" class="difflineplus">+            }</span>
<a href="#l48.983"></a><span id="l48.983" class="difflineplus">+        });</span>
<a href="#l48.984"></a><span id="l48.984" class="difflineplus">+        if (self.screenSharingStream.stop) {</span>
<a href="#l48.985"></a><span id="l48.985" class="difflineplus">+            self.screenSharingStream.stop();</span>
<a href="#l48.986"></a><span id="l48.986" class="difflineplus">+        }</span>
<a href="#l48.987"></a><span id="l48.987" class="difflineplus">+    }</span>
<a href="#l48.988"></a><span id="l48.988" class="difflineplus">+    if (self.remoteAVStream) {</span>
<a href="#l48.989"></a><span id="l48.989" class="difflineplus">+        forAllTracksOnStream(self.remoteAVStream, function(t) {</span>
<a href="#l48.990"></a><span id="l48.990" class="difflineplus">+            if (t.stop) {</span>
<a href="#l48.991"></a><span id="l48.991" class="difflineplus">+                t.stop();</span>
<a href="#l48.992"></a><span id="l48.992" class="difflineplus">+            }</span>
<a href="#l48.993"></a><span id="l48.993" class="difflineplus">+        });</span>
<a href="#l48.994"></a><span id="l48.994" class="difflineplus">+    }</span>
<a href="#l48.995"></a><span id="l48.995" class="difflineplus">+    if (self.remoteAStream) {</span>
<a href="#l48.996"></a><span id="l48.996" class="difflineplus">+        forAllTracksOnStream(self.remoteAStream, function(t) {</span>
<a href="#l48.997"></a><span id="l48.997" class="difflineplus">+            if (t.stop) {</span>
<a href="#l48.998"></a><span id="l48.998" class="difflineplus">+                t.stop();</span>
<a href="#l48.999"></a><span id="l48.999" class="difflineplus">+            }</span>
<a href="#l48.1000"></a><span id="l48.1000" class="difflineplus">+        });</span>
<a href="#l48.1001"></a><span id="l48.1001" class="difflineplus">+    }</span>
<a href="#l48.1002"></a><span id="l48.1002" class="difflineplus">+};</span>
<a href="#l48.1003"></a><span id="l48.1003" class="difflineplus">+</span>
<a href="#l48.1004"></a><span id="l48.1004" class="difflineplus">+var _tryPlayRemoteStream = function(self) {</span>
<a href="#l48.1005"></a><span id="l48.1005" class="difflineplus">+    if (self.getRemoteVideoElement() &amp;&amp; self.remoteAVStream) {</span>
<a href="#l48.1006"></a><span id="l48.1006" class="difflineplus">+        var player = self.getRemoteVideoElement();</span>
<a href="#l48.1007"></a><span id="l48.1007" class="difflineplus">+        player.autoplay = true;</span>
<a href="#l48.1008"></a><span id="l48.1008" class="difflineplus">+        self.assignElement(player,</span>
<a href="#l48.1009"></a><span id="l48.1009" class="difflineplus">+                           self.URL.createObjectURL(self.remoteAVStream),</span>
<a href="#l48.1010"></a><span id="l48.1010" class="difflineplus">+                           &quot;remoteVideo&quot;);</span>
<a href="#l48.1011"></a><span id="l48.1011" class="difflineplus">+        setTimeout(function() {</span>
<a href="#l48.1012"></a><span id="l48.1012" class="difflineplus">+            var vel = self.getRemoteVideoElement();</span>
<a href="#l48.1013"></a><span id="l48.1013" class="difflineplus">+            if (vel.play) {</span>
<a href="#l48.1014"></a><span id="l48.1014" class="difflineplus">+                self.playElement(vel, &quot;remoteVideo&quot;);</span>
<a href="#l48.1015"></a><span id="l48.1015" class="difflineplus">+            }</span>
<a href="#l48.1016"></a><span id="l48.1016" class="difflineplus">+            // OpenWebRTC does not support oniceconnectionstatechange yet</span>
<a href="#l48.1017"></a><span id="l48.1017" class="difflineplus">+            if (self.webRtc.isOpenWebRTC()) {</span>
<a href="#l48.1018"></a><span id="l48.1018" class="difflineplus">+                setState(self, 'connected');</span>
<a href="#l48.1019"></a><span id="l48.1019" class="difflineplus">+            }</span>
<a href="#l48.1020"></a><span id="l48.1020" class="difflineplus">+        }, 0);</span>
<a href="#l48.1021"></a><span id="l48.1021" class="difflineplus">+    }</span>
<a href="#l48.1022"></a><span id="l48.1022" class="difflineplus">+};</span>
<a href="#l48.1023"></a><span id="l48.1023" class="difflineplus">+</span>
<a href="#l48.1024"></a><span id="l48.1024" class="difflineplus">+var _tryPlayRemoteAudioStream = function(self) {</span>
<a href="#l48.1025"></a><span id="l48.1025" class="difflineplus">+    if (self.getRemoteAudioElement() &amp;&amp; self.remoteAStream) {</span>
<a href="#l48.1026"></a><span id="l48.1026" class="difflineplus">+        var player = self.getRemoteAudioElement();</span>
<a href="#l48.1027"></a><span id="l48.1027" class="difflineplus">+        player.autoplay = true;</span>
<a href="#l48.1028"></a><span id="l48.1028" class="difflineplus">+        self.assignElement(player,</span>
<a href="#l48.1029"></a><span id="l48.1029" class="difflineplus">+                           self.URL.createObjectURL(self.remoteAStream),</span>
<a href="#l48.1030"></a><span id="l48.1030" class="difflineplus">+                           &quot;remoteAudio&quot;);</span>
<a href="#l48.1031"></a><span id="l48.1031" class="difflineplus">+        setTimeout(function() {</span>
<a href="#l48.1032"></a><span id="l48.1032" class="difflineplus">+            var ael = self.getRemoteAudioElement();</span>
<a href="#l48.1033"></a><span id="l48.1033" class="difflineplus">+            if (ael.play) {</span>
<a href="#l48.1034"></a><span id="l48.1034" class="difflineplus">+                self.playElement(ael, &quot;remoteAudio&quot;);</span>
<a href="#l48.1035"></a><span id="l48.1035" class="difflineplus">+            }</span>
<a href="#l48.1036"></a><span id="l48.1036" class="difflineplus">+            // OpenWebRTC does not support oniceconnectionstatechange yet</span>
<a href="#l48.1037"></a><span id="l48.1037" class="difflineplus">+            if (self.webRtc.isOpenWebRTC()) {</span>
<a href="#l48.1038"></a><span id="l48.1038" class="difflineplus">+                setState(self, 'connected');</span>
<a href="#l48.1039"></a><span id="l48.1039" class="difflineplus">+            }</span>
<a href="#l48.1040"></a><span id="l48.1040" class="difflineplus">+        }, 0);</span>
<a href="#l48.1041"></a><span id="l48.1041" class="difflineplus">+    }</span>
<a href="#l48.1042"></a><span id="l48.1042" class="difflineplus">+};</span>
<a href="#l48.1043"></a><span id="l48.1043" class="difflineplus">+</span>
<a href="#l48.1044"></a><span id="l48.1044" class="difflineplus">+var checkForErrorListener = function(self) {</span>
<a href="#l48.1045"></a><span id="l48.1045" class="difflineplus">+    if (self.listeners(&quot;error&quot;).length === 0) {</span>
<a href="#l48.1046"></a><span id="l48.1046" class="difflineplus">+        throw new Error(</span>
<a href="#l48.1047"></a><span id="l48.1047" class="difflineplus">+            &quot;You MUST attach an error listener using call.on('error', function() {})&quot;</span>
<a href="#l48.1048"></a><span id="l48.1048" class="difflineplus">+        );</span>
<a href="#l48.1049"></a><span id="l48.1049" class="difflineplus">+    }</span>
<a href="#l48.1050"></a><span id="l48.1050" class="difflineplus">+};</span>
<a href="#l48.1051"></a><span id="l48.1051" class="difflineplus">+</span>
<a href="#l48.1052"></a><span id="l48.1052" class="difflineplus">+var callError = function(code, msg) {</span>
<a href="#l48.1053"></a><span id="l48.1053" class="difflineplus">+    var e = new Error(msg);</span>
<a href="#l48.1054"></a><span id="l48.1054" class="difflineplus">+    e.code = code;</span>
<a href="#l48.1055"></a><span id="l48.1055" class="difflineplus">+    return e;</span>
<a href="#l48.1056"></a><span id="l48.1056" class="difflineplus">+};</span>
<a href="#l48.1057"></a><span id="l48.1057" class="difflineplus">+</span>
<a href="#l48.1058"></a><span id="l48.1058" class="difflineplus">+var debuglog = function() {</span>
<a href="#l48.1059"></a><span id="l48.1059" class="difflineplus">+    if (DEBUG) {</span>
<a href="#l48.1060"></a><span id="l48.1060" class="difflineplus">+        console.log.apply(console, arguments);</span>
<a href="#l48.1061"></a><span id="l48.1061" class="difflineplus">+    }</span>
<a href="#l48.1062"></a><span id="l48.1062" class="difflineplus">+};</span>
<a href="#l48.1063"></a><span id="l48.1063" class="difflineplus">+</span>
<a href="#l48.1064"></a><span id="l48.1064" class="difflineplus">+var _sendCandidateQueue = function(self) {</span>
<a href="#l48.1065"></a><span id="l48.1065" class="difflineplus">+    if (self.candidateSendQueue.length === 0) {</span>
<a href="#l48.1066"></a><span id="l48.1066" class="difflineplus">+        return;</span>
<a href="#l48.1067"></a><span id="l48.1067" class="difflineplus">+    }</span>
<a href="#l48.1068"></a><span id="l48.1068" class="difflineplus">+</span>
<a href="#l48.1069"></a><span id="l48.1069" class="difflineplus">+    var cands = self.candidateSendQueue;</span>
<a href="#l48.1070"></a><span id="l48.1070" class="difflineplus">+    self.candidateSendQueue = [];</span>
<a href="#l48.1071"></a><span id="l48.1071" class="difflineplus">+    ++self.candidateSendTries;</span>
<a href="#l48.1072"></a><span id="l48.1072" class="difflineplus">+    var content = {</span>
<a href="#l48.1073"></a><span id="l48.1073" class="difflineplus">+        version: 0,</span>
<a href="#l48.1074"></a><span id="l48.1074" class="difflineplus">+        call_id: self.callId,</span>
<a href="#l48.1075"></a><span id="l48.1075" class="difflineplus">+        candidates: cands</span>
<a href="#l48.1076"></a><span id="l48.1076" class="difflineplus">+    };</span>
<a href="#l48.1077"></a><span id="l48.1077" class="difflineplus">+    debuglog(&quot;Attempting to send &quot; + cands.length + &quot; candidates&quot;);</span>
<a href="#l48.1078"></a><span id="l48.1078" class="difflineplus">+    sendEvent(self, 'm.call.candidates', content).then(function() {</span>
<a href="#l48.1079"></a><span id="l48.1079" class="difflineplus">+        self.candidateSendTries = 0;</span>
<a href="#l48.1080"></a><span id="l48.1080" class="difflineplus">+        _sendCandidateQueue(self);</span>
<a href="#l48.1081"></a><span id="l48.1081" class="difflineplus">+    }, function(error) {</span>
<a href="#l48.1082"></a><span id="l48.1082" class="difflineplus">+        for (var i = 0; i &lt; cands.length; i++) {</span>
<a href="#l48.1083"></a><span id="l48.1083" class="difflineplus">+            self.candidateSendQueue.push(cands[i]);</span>
<a href="#l48.1084"></a><span id="l48.1084" class="difflineplus">+        }</span>
<a href="#l48.1085"></a><span id="l48.1085" class="difflineplus">+</span>
<a href="#l48.1086"></a><span id="l48.1086" class="difflineplus">+        if (self.candidateSendTries &gt; 5) {</span>
<a href="#l48.1087"></a><span id="l48.1087" class="difflineplus">+            debuglog(</span>
<a href="#l48.1088"></a><span id="l48.1088" class="difflineplus">+                &quot;Failed to send candidates on attempt %s. Giving up for now.&quot;,</span>
<a href="#l48.1089"></a><span id="l48.1089" class="difflineplus">+                self.candidateSendTries</span>
<a href="#l48.1090"></a><span id="l48.1090" class="difflineplus">+            );</span>
<a href="#l48.1091"></a><span id="l48.1091" class="difflineplus">+            self.candidateSendTries = 0;</span>
<a href="#l48.1092"></a><span id="l48.1092" class="difflineplus">+            return;</span>
<a href="#l48.1093"></a><span id="l48.1093" class="difflineplus">+        }</span>
<a href="#l48.1094"></a><span id="l48.1094" class="difflineplus">+</span>
<a href="#l48.1095"></a><span id="l48.1095" class="difflineplus">+        var delayMs = 500 * Math.pow(2, self.candidateSendTries);</span>
<a href="#l48.1096"></a><span id="l48.1096" class="difflineplus">+        ++self.candidateSendTries;</span>
<a href="#l48.1097"></a><span id="l48.1097" class="difflineplus">+        debuglog(&quot;Failed to send candidates. Retrying in &quot; + delayMs + &quot;ms&quot;);</span>
<a href="#l48.1098"></a><span id="l48.1098" class="difflineplus">+        setTimeout(function() {</span>
<a href="#l48.1099"></a><span id="l48.1099" class="difflineplus">+            _sendCandidateQueue(self);</span>
<a href="#l48.1100"></a><span id="l48.1100" class="difflineplus">+        }, delayMs);</span>
<a href="#l48.1101"></a><span id="l48.1101" class="difflineplus">+    });</span>
<a href="#l48.1102"></a><span id="l48.1102" class="difflineplus">+};</span>
<a href="#l48.1103"></a><span id="l48.1103" class="difflineplus">+</span>
<a href="#l48.1104"></a><span id="l48.1104" class="difflineplus">+var _placeCallWithConstraints = function(self, constraints) {</span>
<a href="#l48.1105"></a><span id="l48.1105" class="difflineplus">+    self.client.callList[self.callId] = self;</span>
<a href="#l48.1106"></a><span id="l48.1106" class="difflineplus">+    self.webRtc.getUserMedia(</span>
<a href="#l48.1107"></a><span id="l48.1107" class="difflineplus">+        constraints,</span>
<a href="#l48.1108"></a><span id="l48.1108" class="difflineplus">+        hookCallback(self, self._gotUserMediaForInvite),</span>
<a href="#l48.1109"></a><span id="l48.1109" class="difflineplus">+        hookCallback(self, self._getUserMediaFailed)</span>
<a href="#l48.1110"></a><span id="l48.1110" class="difflineplus">+    );</span>
<a href="#l48.1111"></a><span id="l48.1111" class="difflineplus">+    setState(self, 'wait_local_media');</span>
<a href="#l48.1112"></a><span id="l48.1112" class="difflineplus">+    self.direction = 'outbound';</span>
<a href="#l48.1113"></a><span id="l48.1113" class="difflineplus">+    self.config = constraints;</span>
<a href="#l48.1114"></a><span id="l48.1114" class="difflineplus">+};</span>
<a href="#l48.1115"></a><span id="l48.1115" class="difflineplus">+</span>
<a href="#l48.1116"></a><span id="l48.1116" class="difflineplus">+var _createPeerConnection = function(self) {</span>
<a href="#l48.1117"></a><span id="l48.1117" class="difflineplus">+    var servers = self.turnServers;</span>
<a href="#l48.1118"></a><span id="l48.1118" class="difflineplus">+    if (self.webRtc.vendor === &quot;mozilla&quot;) {</span>
<a href="#l48.1119"></a><span id="l48.1119" class="difflineplus">+        // modify turnServers struct to match what mozilla expects.</span>
<a href="#l48.1120"></a><span id="l48.1120" class="difflineplus">+        servers = [];</span>
<a href="#l48.1121"></a><span id="l48.1121" class="difflineplus">+        for (var i = 0; i &lt; self.turnServers.length; i++) {</span>
<a href="#l48.1122"></a><span id="l48.1122" class="difflineplus">+            for (var j = 0; j &lt; self.turnServers[i].urls.length; j++) {</span>
<a href="#l48.1123"></a><span id="l48.1123" class="difflineplus">+                servers.push({</span>
<a href="#l48.1124"></a><span id="l48.1124" class="difflineplus">+                    url: self.turnServers[i].urls[j],</span>
<a href="#l48.1125"></a><span id="l48.1125" class="difflineplus">+                    username: self.turnServers[i].username,</span>
<a href="#l48.1126"></a><span id="l48.1126" class="difflineplus">+                    credential: self.turnServers[i].credential</span>
<a href="#l48.1127"></a><span id="l48.1127" class="difflineplus">+                });</span>
<a href="#l48.1128"></a><span id="l48.1128" class="difflineplus">+            }</span>
<a href="#l48.1129"></a><span id="l48.1129" class="difflineplus">+        }</span>
<a href="#l48.1130"></a><span id="l48.1130" class="difflineplus">+    }</span>
<a href="#l48.1131"></a><span id="l48.1131" class="difflineplus">+</span>
<a href="#l48.1132"></a><span id="l48.1132" class="difflineplus">+    var pc = new self.webRtc.RtcPeerConnection({</span>
<a href="#l48.1133"></a><span id="l48.1133" class="difflineplus">+        iceServers: servers</span>
<a href="#l48.1134"></a><span id="l48.1134" class="difflineplus">+    });</span>
<a href="#l48.1135"></a><span id="l48.1135" class="difflineplus">+    pc.oniceconnectionstatechange = hookCallback(self, self._onIceConnectionStateChanged);</span>
<a href="#l48.1136"></a><span id="l48.1136" class="difflineplus">+    pc.onsignalingstatechange = hookCallback(self, self._onSignallingStateChanged);</span>
<a href="#l48.1137"></a><span id="l48.1137" class="difflineplus">+    pc.onicecandidate = hookCallback(self, self._gotLocalIceCandidate);</span>
<a href="#l48.1138"></a><span id="l48.1138" class="difflineplus">+    pc.onaddstream = hookCallback(self, self._onAddStream);</span>
<a href="#l48.1139"></a><span id="l48.1139" class="difflineplus">+    return pc;</span>
<a href="#l48.1140"></a><span id="l48.1140" class="difflineplus">+};</span>
<a href="#l48.1141"></a><span id="l48.1141" class="difflineplus">+</span>
<a href="#l48.1142"></a><span id="l48.1142" class="difflineplus">+var _getChromeScreenSharingConstraints = function(call) {</span>
<a href="#l48.1143"></a><span id="l48.1143" class="difflineplus">+    var screen = global.screen;</span>
<a href="#l48.1144"></a><span id="l48.1144" class="difflineplus">+    if (!screen) {</span>
<a href="#l48.1145"></a><span id="l48.1145" class="difflineplus">+        call.emit(&quot;error&quot;, callError(</span>
<a href="#l48.1146"></a><span id="l48.1146" class="difflineplus">+            MatrixCall.ERR_NO_USER_MEDIA,</span>
<a href="#l48.1147"></a><span id="l48.1147" class="difflineplus">+            &quot;Couldn't determine screen sharing constaints.&quot;</span>
<a href="#l48.1148"></a><span id="l48.1148" class="difflineplus">+        ));</span>
<a href="#l48.1149"></a><span id="l48.1149" class="difflineplus">+        return;</span>
<a href="#l48.1150"></a><span id="l48.1150" class="difflineplus">+    }</span>
<a href="#l48.1151"></a><span id="l48.1151" class="difflineplus">+    // it won't work at all if you're not on HTTPS so whine whine whine</span>
<a href="#l48.1152"></a><span id="l48.1152" class="difflineplus">+    if (!global.window || global.window.location.protocol !== &quot;https:&quot;) {</span>
<a href="#l48.1153"></a><span id="l48.1153" class="difflineplus">+        call.emit(&quot;error&quot;, callError(</span>
<a href="#l48.1154"></a><span id="l48.1154" class="difflineplus">+            MatrixCall.ERR_NO_USER_MEDIA,</span>
<a href="#l48.1155"></a><span id="l48.1155" class="difflineplus">+            &quot;You need to be using HTTPS to place a screen-sharing call.&quot;</span>
<a href="#l48.1156"></a><span id="l48.1156" class="difflineplus">+        ));</span>
<a href="#l48.1157"></a><span id="l48.1157" class="difflineplus">+        return;</span>
<a href="#l48.1158"></a><span id="l48.1158" class="difflineplus">+    }</span>
<a href="#l48.1159"></a><span id="l48.1159" class="difflineplus">+</span>
<a href="#l48.1160"></a><span id="l48.1160" class="difflineplus">+    return {</span>
<a href="#l48.1161"></a><span id="l48.1161" class="difflineplus">+        video: {</span>
<a href="#l48.1162"></a><span id="l48.1162" class="difflineplus">+            mandatory: {</span>
<a href="#l48.1163"></a><span id="l48.1163" class="difflineplus">+                chromeMediaSource: &quot;screen&quot;,</span>
<a href="#l48.1164"></a><span id="l48.1164" class="difflineplus">+                chromeMediaSourceId: &quot;&quot; + Date.now(),</span>
<a href="#l48.1165"></a><span id="l48.1165" class="difflineplus">+                maxWidth: screen.width,</span>
<a href="#l48.1166"></a><span id="l48.1166" class="difflineplus">+                maxHeight: screen.height,</span>
<a href="#l48.1167"></a><span id="l48.1167" class="difflineplus">+                minFrameRate: 1,</span>
<a href="#l48.1168"></a><span id="l48.1168" class="difflineplus">+                maxFrameRate: 10</span>
<a href="#l48.1169"></a><span id="l48.1169" class="difflineplus">+            }</span>
<a href="#l48.1170"></a><span id="l48.1170" class="difflineplus">+        }</span>
<a href="#l48.1171"></a><span id="l48.1171" class="difflineplus">+    };</span>
<a href="#l48.1172"></a><span id="l48.1172" class="difflineplus">+};</span>
<a href="#l48.1173"></a><span id="l48.1173" class="difflineplus">+</span>
<a href="#l48.1174"></a><span id="l48.1174" class="difflineplus">+var _getUserMediaVideoContraints = function(callType) {</span>
<a href="#l48.1175"></a><span id="l48.1175" class="difflineplus">+    switch (callType) {</span>
<a href="#l48.1176"></a><span id="l48.1176" class="difflineplus">+        case 'voice':</span>
<a href="#l48.1177"></a><span id="l48.1177" class="difflineplus">+            return ({audio: true, video: false});</span>
<a href="#l48.1178"></a><span id="l48.1178" class="difflineplus">+        case 'video':</span>
<a href="#l48.1179"></a><span id="l48.1179" class="difflineplus">+            return ({audio: true, video: {</span>
<a href="#l48.1180"></a><span id="l48.1180" class="difflineplus">+                mandatory: {</span>
<a href="#l48.1181"></a><span id="l48.1181" class="difflineplus">+                    minWidth: 640,</span>
<a href="#l48.1182"></a><span id="l48.1182" class="difflineplus">+                    maxWidth: 640,</span>
<a href="#l48.1183"></a><span id="l48.1183" class="difflineplus">+                    minHeight: 360,</span>
<a href="#l48.1184"></a><span id="l48.1184" class="difflineplus">+                    maxHeight: 360</span>
<a href="#l48.1185"></a><span id="l48.1185" class="difflineplus">+                }</span>
<a href="#l48.1186"></a><span id="l48.1186" class="difflineplus">+            }});</span>
<a href="#l48.1187"></a><span id="l48.1187" class="difflineplus">+    }</span>
<a href="#l48.1188"></a><span id="l48.1188" class="difflineplus">+};</span>
<a href="#l48.1189"></a><span id="l48.1189" class="difflineplus">+</span>
<a href="#l48.1190"></a><span id="l48.1190" class="difflineplus">+var hookCallback = function(call, fn) {</span>
<a href="#l48.1191"></a><span id="l48.1191" class="difflineplus">+    return function() {</span>
<a href="#l48.1192"></a><span id="l48.1192" class="difflineplus">+        return fn.apply(call, arguments);</span>
<a href="#l48.1193"></a><span id="l48.1193" class="difflineplus">+    };</span>
<a href="#l48.1194"></a><span id="l48.1194" class="difflineplus">+};</span>
<a href="#l48.1195"></a><span id="l48.1195" class="difflineplus">+</span>
<a href="#l48.1196"></a><span id="l48.1196" class="difflineplus">+var forAllVideoTracksOnStream = function(s, f) {</span>
<a href="#l48.1197"></a><span id="l48.1197" class="difflineplus">+    var tracks = s.getVideoTracks();</span>
<a href="#l48.1198"></a><span id="l48.1198" class="difflineplus">+    for (var i = 0; i &lt; tracks.length; i++) {</span>
<a href="#l48.1199"></a><span id="l48.1199" class="difflineplus">+        f(tracks[i]);</span>
<a href="#l48.1200"></a><span id="l48.1200" class="difflineplus">+    }</span>
<a href="#l48.1201"></a><span id="l48.1201" class="difflineplus">+};</span>
<a href="#l48.1202"></a><span id="l48.1202" class="difflineplus">+</span>
<a href="#l48.1203"></a><span id="l48.1203" class="difflineplus">+var forAllAudioTracksOnStream = function(s, f) {</span>
<a href="#l48.1204"></a><span id="l48.1204" class="difflineplus">+    var tracks = s.getAudioTracks();</span>
<a href="#l48.1205"></a><span id="l48.1205" class="difflineplus">+    for (var i = 0; i &lt; tracks.length; i++) {</span>
<a href="#l48.1206"></a><span id="l48.1206" class="difflineplus">+        f(tracks[i]);</span>
<a href="#l48.1207"></a><span id="l48.1207" class="difflineplus">+    }</span>
<a href="#l48.1208"></a><span id="l48.1208" class="difflineplus">+};</span>
<a href="#l48.1209"></a><span id="l48.1209" class="difflineplus">+</span>
<a href="#l48.1210"></a><span id="l48.1210" class="difflineplus">+var forAllTracksOnStream = function(s, f) {</span>
<a href="#l48.1211"></a><span id="l48.1211" class="difflineplus">+    forAllVideoTracksOnStream(s, f);</span>
<a href="#l48.1212"></a><span id="l48.1212" class="difflineplus">+    forAllAudioTracksOnStream(s, f);</span>
<a href="#l48.1213"></a><span id="l48.1213" class="difflineplus">+};</span>
<a href="#l48.1214"></a><span id="l48.1214" class="difflineplus">+</span>
<a href="#l48.1215"></a><span id="l48.1215" class="difflineplus">+/** The MatrixCall class. */</span>
<a href="#l48.1216"></a><span id="l48.1216" class="difflineplus">+module.exports.MatrixCall = MatrixCall;</span>
<a href="#l48.1217"></a><span id="l48.1217" class="difflineplus">+</span>
<a href="#l48.1218"></a><span id="l48.1218" class="difflineplus">+</span>
<a href="#l48.1219"></a><span id="l48.1219" class="difflineplus">+/**</span>
<a href="#l48.1220"></a><span id="l48.1220" class="difflineplus">+ * Create a new Matrix call for the browser.</span>
<a href="#l48.1221"></a><span id="l48.1221" class="difflineplus">+ * @param {MatrixClient} client The client instance to use.</span>
<a href="#l48.1222"></a><span id="l48.1222" class="difflineplus">+ * @param {string} roomId The room the call is in.</span>
<a href="#l48.1223"></a><span id="l48.1223" class="difflineplus">+ * @return {MatrixCall} the call or null if the browser doesn't support calling.</span>
<a href="#l48.1224"></a><span id="l48.1224" class="difflineplus">+ */</span>
<a href="#l48.1225"></a><span id="l48.1225" class="difflineplus">+module.exports.createNewMatrixCall = function(client, roomId) {</span>
<a href="#l48.1226"></a><span id="l48.1226" class="difflineplus">+    var w = global.window;</span>
<a href="#l48.1227"></a><span id="l48.1227" class="difflineplus">+    var doc = global.document;</span>
<a href="#l48.1228"></a><span id="l48.1228" class="difflineplus">+    if (!w || !doc) {</span>
<a href="#l48.1229"></a><span id="l48.1229" class="difflineplus">+        return null;</span>
<a href="#l48.1230"></a><span id="l48.1230" class="difflineplus">+    }</span>
<a href="#l48.1231"></a><span id="l48.1231" class="difflineplus">+    var webRtc = {};</span>
<a href="#l48.1232"></a><span id="l48.1232" class="difflineplus">+    webRtc.isOpenWebRTC = function() {</span>
<a href="#l48.1233"></a><span id="l48.1233" class="difflineplus">+        var scripts = doc.getElementById(&quot;script&quot;);</span>
<a href="#l48.1234"></a><span id="l48.1234" class="difflineplus">+        if (!scripts || !scripts.length) {</span>
<a href="#l48.1235"></a><span id="l48.1235" class="difflineplus">+            return false;</span>
<a href="#l48.1236"></a><span id="l48.1236" class="difflineplus">+        }</span>
<a href="#l48.1237"></a><span id="l48.1237" class="difflineplus">+        for (var i = 0; i &lt; scripts.length; i++) {</span>
<a href="#l48.1238"></a><span id="l48.1238" class="difflineplus">+            if (scripts[i].src.indexOf(&quot;owr.js&quot;) &gt; -1) {</span>
<a href="#l48.1239"></a><span id="l48.1239" class="difflineplus">+                return true;</span>
<a href="#l48.1240"></a><span id="l48.1240" class="difflineplus">+            }</span>
<a href="#l48.1241"></a><span id="l48.1241" class="difflineplus">+        }</span>
<a href="#l48.1242"></a><span id="l48.1242" class="difflineplus">+        return false;</span>
<a href="#l48.1243"></a><span id="l48.1243" class="difflineplus">+    };</span>
<a href="#l48.1244"></a><span id="l48.1244" class="difflineplus">+    var getUserMedia = (</span>
<a href="#l48.1245"></a><span id="l48.1245" class="difflineplus">+        w.navigator.getUserMedia || w.navigator.webkitGetUserMedia ||</span>
<a href="#l48.1246"></a><span id="l48.1246" class="difflineplus">+        w.navigator.mozGetUserMedia</span>
<a href="#l48.1247"></a><span id="l48.1247" class="difflineplus">+    );</span>
<a href="#l48.1248"></a><span id="l48.1248" class="difflineplus">+    if (getUserMedia) {</span>
<a href="#l48.1249"></a><span id="l48.1249" class="difflineplus">+        webRtc.getUserMedia = function() {</span>
<a href="#l48.1250"></a><span id="l48.1250" class="difflineplus">+            return getUserMedia.apply(w.navigator, arguments);</span>
<a href="#l48.1251"></a><span id="l48.1251" class="difflineplus">+        };</span>
<a href="#l48.1252"></a><span id="l48.1252" class="difflineplus">+    }</span>
<a href="#l48.1253"></a><span id="l48.1253" class="difflineplus">+    webRtc.RtcPeerConnection = (</span>
<a href="#l48.1254"></a><span id="l48.1254" class="difflineplus">+        w.RTCPeerConnection || w.webkitRTCPeerConnection || w.mozRTCPeerConnection</span>
<a href="#l48.1255"></a><span id="l48.1255" class="difflineplus">+    );</span>
<a href="#l48.1256"></a><span id="l48.1256" class="difflineplus">+    webRtc.RtcSessionDescription = (</span>
<a href="#l48.1257"></a><span id="l48.1257" class="difflineplus">+        w.RTCSessionDescription || w.webkitRTCSessionDescription ||</span>
<a href="#l48.1258"></a><span id="l48.1258" class="difflineplus">+        w.mozRTCSessionDescription</span>
<a href="#l48.1259"></a><span id="l48.1259" class="difflineplus">+    );</span>
<a href="#l48.1260"></a><span id="l48.1260" class="difflineplus">+    webRtc.RtcIceCandidate = (</span>
<a href="#l48.1261"></a><span id="l48.1261" class="difflineplus">+        w.RTCIceCandidate || w.webkitRTCIceCandidate || w.mozRTCIceCandidate</span>
<a href="#l48.1262"></a><span id="l48.1262" class="difflineplus">+    );</span>
<a href="#l48.1263"></a><span id="l48.1263" class="difflineplus">+    webRtc.vendor = null;</span>
<a href="#l48.1264"></a><span id="l48.1264" class="difflineplus">+    if (w.mozRTCPeerConnection) {</span>
<a href="#l48.1265"></a><span id="l48.1265" class="difflineplus">+        webRtc.vendor = &quot;mozilla&quot;;</span>
<a href="#l48.1266"></a><span id="l48.1266" class="difflineplus">+    }</span>
<a href="#l48.1267"></a><span id="l48.1267" class="difflineplus">+    else if (w.webkitRTCPeerConnection) {</span>
<a href="#l48.1268"></a><span id="l48.1268" class="difflineplus">+        webRtc.vendor = &quot;webkit&quot;;</span>
<a href="#l48.1269"></a><span id="l48.1269" class="difflineplus">+    }</span>
<a href="#l48.1270"></a><span id="l48.1270" class="difflineplus">+    else if (w.RTCPeerConnection) {</span>
<a href="#l48.1271"></a><span id="l48.1271" class="difflineplus">+        webRtc.vendor = &quot;generic&quot;;</span>
<a href="#l48.1272"></a><span id="l48.1272" class="difflineplus">+    }</span>
<a href="#l48.1273"></a><span id="l48.1273" class="difflineplus">+    if (!webRtc.RtcIceCandidate || !webRtc.RtcSessionDescription ||</span>
<a href="#l48.1274"></a><span id="l48.1274" class="difflineplus">+            !webRtc.RtcPeerConnection || !webRtc.getUserMedia) {</span>
<a href="#l48.1275"></a><span id="l48.1275" class="difflineplus">+        return null; // WebRTC is not supported.</span>
<a href="#l48.1276"></a><span id="l48.1276" class="difflineplus">+    }</span>
<a href="#l48.1277"></a><span id="l48.1277" class="difflineplus">+    var opts = {</span>
<a href="#l48.1278"></a><span id="l48.1278" class="difflineplus">+        webRtc: webRtc,</span>
<a href="#l48.1279"></a><span id="l48.1279" class="difflineplus">+        client: client,</span>
<a href="#l48.1280"></a><span id="l48.1280" class="difflineplus">+        URL: w.URL,</span>
<a href="#l48.1281"></a><span id="l48.1281" class="difflineplus">+        roomId: roomId,</span>
<a href="#l48.1282"></a><span id="l48.1282" class="difflineplus">+        turnServers: client.getTurnServers()</span>
<a href="#l48.1283"></a><span id="l48.1283" class="difflineplus">+    };</span>
<a href="#l48.1284"></a><span id="l48.1284" class="difflineplus">+    return new MatrixCall(opts);</span>
<a href="#l48.1285"></a><span id="l48.1285" class="difflineplus">+};</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

