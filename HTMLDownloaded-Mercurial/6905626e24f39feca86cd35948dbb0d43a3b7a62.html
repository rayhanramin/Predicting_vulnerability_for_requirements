<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 1000:6905626e24f39feca86cd35948dbb0d43a3b7a62</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 6905626e24f39feca86cd35948dbb0d43a3b7a62" />
<meta property="og:url" content="/comm-central/rev/6905626e24f39feca86cd35948dbb0d43a3b7a62" />
<meta property="og:description" content="fix the pending async count logging.  also, use the same connection as sync" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 6905626e24f39feca86cd35948dbb0d43a3b7a62 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/6905626e24f39feca86cd35948dbb0d43a3b7a62">shortlog</a> |
<a href="/comm-central/log/6905626e24f39feca86cd35948dbb0d43a3b7a62">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/6905626e24f39feca86cd35948dbb0d43a3b7a62">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/6905626e24f39feca86cd35948dbb0d43a3b7a62">files</a> |
changeset |
<a href="/comm-central/raw-rev/6905626e24f39feca86cd35948dbb0d43a3b7a62">raw</a>  | <a href="/comm-central/archive/6905626e24f39feca86cd35948dbb0d43a3b7a62.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
fix the pending async count logging.  also, use the same connection as sync
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#65;&#110;&#100;&#114;&#101;&#119;&#32;&#83;&#117;&#116;&#104;&#101;&#114;&#108;&#97;&#110;&#100;&#32;&#60;&#97;&#115;&#117;&#116;&#104;&#101;&#114;&#108;&#97;&#110;&#100;&#64;&#97;&#115;&#117;&#116;&#104;&#101;&#114;&#108;&#97;&#110;&#100;&#46;&#111;&#114;&#103;&#62;</td></tr>
<tr><td></td><td class="date age">Thu, 30 Oct 2008 21:20:44 -0700</td></tr>

<tr>
 <td>changeset 1000</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/6905626e24f39feca86cd35948dbb0d43a3b7a62">6905626e24f39feca86cd35948dbb0d43a3b7a62</a></td>
</tr>



<tr>
<td>parent 999</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/b4d077faa9994fd5708fa1c14f42a3189de32678">b4d077faa9994fd5708fa1c14f42a3189de32678</a>
</td>
</tr>

<tr>
<td>child 1001</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/33717d7f87a8482096197fdc3621495307db92f1">33717d7f87a8482096197fdc3621495307db92f1</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=6905626e24f39feca86cd35948dbb0d43a3b7a62">743</a></td></tr>
<tr><td>push user</td><td>dmosedale@mozilla.com</td></tr>
<tr><td>push date</td><td class="date age">Tue, 04 Nov 2008 20:01:44 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@a79b923a9cba [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=a79b923a9cba395cb3911b27c9599ffb8c997caf">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=a79b923a9cba395cb3911b27c9599ffb8c997caf&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=a79b923a9cba395cb3911b27c9599ffb8c997caf&newProject=comm-central&newRevision=d32b4cc6f46d1195ae66fd0cf8395c60b9259ca6&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=a79b923a9cba395cb3911b27c9599ffb8c997caf&newProject=comm-central&newRevision=d32b4cc6f46d1195ae66fd0cf8395c60b9259ca6&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=a79b923a9cba395cb3911b27c9599ffb8c997caf&newProject=comm-central&newRevision=d32b4cc6f46d1195ae66fd0cf8395c60b9259ca6&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>






</table></div>

<div class="page_body description">fix the pending async count logging.  also, use the same connection as sync
and async.  We don't actually use the syncConnection as such anymore, but if
we did, we would want to be using the same connection anyways.</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/6905626e24f39feca86cd35948dbb0d43a3b7a62/modules/databind.js">modules/databind.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6905626e24f39feca86cd35948dbb0d43a3b7a62/modules/databind.js">file</a> |
<a href="/comm-central/annotate/6905626e24f39feca86cd35948dbb0d43a3b7a62/modules/databind.js">annotate</a> |
<a href="/comm-central/diff/6905626e24f39feca86cd35948dbb0d43a3b7a62/modules/databind.js">diff</a> |
<a href="/comm-central/comparison/6905626e24f39feca86cd35948dbb0d43a3b7a62/modules/databind.js">comparison</a> |
<a href="/comm-central/log/6905626e24f39feca86cd35948dbb0d43a3b7a62/modules/databind.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/6905626e24f39feca86cd35948dbb0d43a3b7a62/modules/datastore.js">modules/datastore.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6905626e24f39feca86cd35948dbb0d43a3b7a62/modules/datastore.js">file</a> |
<a href="/comm-central/annotate/6905626e24f39feca86cd35948dbb0d43a3b7a62/modules/datastore.js">annotate</a> |
<a href="/comm-central/diff/6905626e24f39feca86cd35948dbb0d43a3b7a62/modules/datastore.js">diff</a> |
<a href="/comm-central/comparison/6905626e24f39feca86cd35948dbb0d43a3b7a62/modules/datastore.js">comparison</a> |
<a href="/comm-central/log/6905626e24f39feca86cd35948dbb0d43a3b7a62/modules/datastore.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/6905626e24f39feca86cd35948dbb0d43a3b7a62/modules/indexer.js">modules/indexer.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6905626e24f39feca86cd35948dbb0d43a3b7a62/modules/indexer.js">file</a> |
<a href="/comm-central/annotate/6905626e24f39feca86cd35948dbb0d43a3b7a62/modules/indexer.js">annotate</a> |
<a href="/comm-central/diff/6905626e24f39feca86cd35948dbb0d43a3b7a62/modules/indexer.js">diff</a> |
<a href="/comm-central/comparison/6905626e24f39feca86cd35948dbb0d43a3b7a62/modules/indexer.js">comparison</a> |
<a href="/comm-central/log/6905626e24f39feca86cd35948dbb0d43a3b7a62/modules/indexer.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/modules/databind.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/modules/databind.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -44,16 +44,17 @@ const Cu = Components.utils;</span>
<a href="#l1.4"></a><span id="l1.4"> </span>
<a href="#l1.5"></a><span id="l1.5"> Cu.import(&quot;resource://gloda/modules/log4moz.js&quot;);</span>
<a href="#l1.6"></a><span id="l1.6"> </span>
<a href="#l1.7"></a><span id="l1.7"> function DatabindCallback(aDatabind, aCallbackThis, aCallback, aOneShot) {</span>
<a href="#l1.8"></a><span id="l1.8">   this._databind = aDatabind;</span>
<a href="#l1.9"></a><span id="l1.9">   this._callbackThis = aCallbackThis;</span>
<a href="#l1.10"></a><span id="l1.10">   this._callback = aCallback;</span>
<a href="#l1.11"></a><span id="l1.11">   this._oneShot = aOneShot;</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+  this._databind._datastore._pendingAsyncStatements++;</span>
<a href="#l1.13"></a><span id="l1.13"> }</span>
<a href="#l1.14"></a><span id="l1.14"> DatabindCallback.prototype = {</span>
<a href="#l1.15"></a><span id="l1.15">   handleResult: function (aResultSet) {</span>
<a href="#l1.16"></a><span id="l1.16">     let rows = [];</span>
<a href="#l1.17"></a><span id="l1.17">     let rowResult;</span>
<a href="#l1.18"></a><span id="l1.18">     let getVariant = this._databind._datastore._getVariant;</span>
<a href="#l1.19"></a><span id="l1.19">     while (rowResult = aResultSet.getNextRow()) {</span>
<a href="#l1.20"></a><span id="l1.20">       let row = {};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/modules/datastore.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/modules/datastore.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -90,16 +90,17 @@ MessagesByMessageIdCallback.prototype = </span>
<a href="#l2.4"></a><span id="l2.4">     this.callback.call(this.callbackThis, this.results);</span>
<a href="#l2.5"></a><span id="l2.5">   }</span>
<a href="#l2.6"></a><span id="l2.6"> };</span>
<a href="#l2.7"></a><span id="l2.7"> </span>
<a href="#l2.8"></a><span id="l2.8"> let PCH_LOG = Log4Moz.Service.getLogger(&quot;gloda.ds.pch&quot;);</span>
<a href="#l2.9"></a><span id="l2.9"> </span>
<a href="#l2.10"></a><span id="l2.10"> function PostCommitHandler(aCallbacks) {</span>
<a href="#l2.11"></a><span id="l2.11">   this.callbacks = aCallbacks;</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+  GlodaDatastore._pendingAsyncStatements++;</span>
<a href="#l2.13"></a><span id="l2.13"> }</span>
<a href="#l2.14"></a><span id="l2.14"> </span>
<a href="#l2.15"></a><span id="l2.15"> PostCommitHandler.prototype = {</span>
<a href="#l2.16"></a><span id="l2.16">   handleResult: function gloda_ds_pch_handleResult(aResultSet) {</span>
<a href="#l2.17"></a><span id="l2.17">   },</span>
<a href="#l2.18"></a><span id="l2.18">   </span>
<a href="#l2.19"></a><span id="l2.19">   handleError: function gloda_ds_pch_handleError(aError) {</span>
<a href="#l2.20"></a><span id="l2.20">     PCH_LOG.error(&quot;database error:&quot; + aError)</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineat">@@ -742,17 +743,17 @@ var GlodaDatastore = {</span>
<a href="#l2.22"></a><span id="l2.22">           this._log.debug(&quot;Migration completed.&quot;);</span>
<a href="#l2.23"></a><span id="l2.23">         }</span>
<a href="#l2.24"></a><span id="l2.24">       }</span>
<a href="#l2.25"></a><span id="l2.25">       // Handle corrupt databases, other oddities</span>
<a href="#l2.26"></a><span id="l2.26">       // ... in the future. for now, let us die</span>
<a href="#l2.27"></a><span id="l2.27">     }</span>
<a href="#l2.28"></a><span id="l2.28"> </span>
<a href="#l2.29"></a><span id="l2.29">     this.syncConnection = dbConnection;</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineminus">-    this.asyncConnection = dbService.openUnsharedDatabase(dbFile);</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineplus">+    this.asyncConnection = dbConnection;</span>
<a href="#l2.32"></a><span id="l2.32"> </span>
<a href="#l2.33"></a><span id="l2.33">     this._log.debug(&quot;Initializing folder mappings.&quot;);</span>
<a href="#l2.34"></a><span id="l2.34">     this._getAllFolderMappings();</span>
<a href="#l2.35"></a><span id="l2.35">     // we need to figure out the next id's for all of the tables where we</span>
<a href="#l2.36"></a><span id="l2.36">     //  manage that.</span>
<a href="#l2.37"></a><span id="l2.37">     this._log.debug(&quot;Populating managed id counters.&quot;);</span>
<a href="#l2.38"></a><span id="l2.38">     this._populateAttributeDefManagedId();</span>
<a href="#l2.39"></a><span id="l2.39">     this._populateConversationManagedId();</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineat">@@ -780,35 +781,33 @@ var GlodaDatastore = {</span>
<a href="#l2.41"></a><span id="l2.41">       //  been closed out.</span>
<a href="#l2.42"></a><span id="l2.42">       this._commitTransaction();</span>
<a href="#l2.43"></a><span id="l2.43">     }</span>
<a href="#l2.44"></a><span id="l2.44"> </span>
<a href="#l2.45"></a><span id="l2.45">     let datastore = this;</span>
<a href="#l2.46"></a><span id="l2.46"> </span>
<a href="#l2.47"></a><span id="l2.47">     function finish_cleanup() {</span>
<a href="#l2.48"></a><span id="l2.48">       datastore._cleanupAsyncStatements();</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineminus">-      datastore._log.info(&quot;Closing async connection&quot;);</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineplus">+      datastore._cleanupSyncStatements();</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineplus">+      datastore._log.info(&quot;Closing db connection&quot;);</span>
<a href="#l2.52"></a><span id="l2.52">       datastore.asyncConnection.close();</span>
<a href="#l2.53"></a><span id="l2.53">       datastore.asyncConnection = null;</span>
<a href="#l2.54"></a><span id="l2.54" class="difflineminus">-</span>
<a href="#l2.55"></a><span id="l2.55" class="difflineminus">-      datastore._cleanupSyncStatements();</span>
<a href="#l2.56"></a><span id="l2.56" class="difflineminus">-      datastore._log.info(&quot;Closing sync connection&quot;);</span>
<a href="#l2.57"></a><span id="l2.57" class="difflineminus">-      datastore.syncConnection.close();</span>
<a href="#l2.58"></a><span id="l2.58">       datastore.syncConnection = null;</span>
<a href="#l2.59"></a><span id="l2.59"> </span>
<a href="#l2.60"></a><span id="l2.60">       if (aCallback) {</span>
<a href="#l2.61"></a><span id="l2.61">         aCallback.call(aCallbackThis);</span>
<a href="#l2.62"></a><span id="l2.62">       }</span>
<a href="#l2.63"></a><span id="l2.63">     }</span>
<a href="#l2.64"></a><span id="l2.64"> </span>
<a href="#l2.65"></a><span id="l2.65">     if (this._pendingAsyncStatements) {</span>
<a href="#l2.66"></a><span id="l2.66">       this._pendingAsyncCompletedListener = finish_cleanup;</span>
<a href="#l2.67"></a><span id="l2.67">       return false;</span>
<a href="#l2.68"></a><span id="l2.68">     }</span>
<a href="#l2.69"></a><span id="l2.69">     else {</span>
<a href="#l2.70"></a><span id="l2.70" class="difflineplus">+      this._log.debug(&quot;There are no pending async statements, finishing now.&quot;);</span>
<a href="#l2.71"></a><span id="l2.71">       aCallback = null;</span>
<a href="#l2.72"></a><span id="l2.72">       finish_cleanup();</span>
<a href="#l2.73"></a><span id="l2.73">       return true;</span>
<a href="#l2.74"></a><span id="l2.74">     }</span>
<a href="#l2.75"></a><span id="l2.75">   },</span>
<a href="#l2.76"></a><span id="l2.76"> </span>
<a href="#l2.77"></a><span id="l2.77">   /**</span>
<a href="#l2.78"></a><span id="l2.78">    * Create our database; basically a wrapper around _createSchema.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/modules/indexer.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/modules/indexer.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -315,19 +315,23 @@ var GlodaIndexer = {</span>
<a href="#l3.4"></a><span id="l3.4">                         getService(Ci.nsIPrefService);</span>
<a href="#l3.5"></a><span id="l3.5">     let branch = prefService.getBranch(&quot;mailnews.database.global.indexer&quot;);</span>
<a href="#l3.6"></a><span id="l3.6">     let eventDrivenEnabled = true; // default</span>
<a href="#l3.7"></a><span id="l3.7">     if (branch.prefHasUserValue(&quot;enabled&quot;))</span>
<a href="#l3.8"></a><span id="l3.8">       eventDrivenEnabled = branch.getBoolPref(&quot;enabled&quot;);</span>
<a href="#l3.9"></a><span id="l3.9">     this.enabled = eventDrivenEnabled;</span>
<a href="#l3.10"></a><span id="l3.10">   },</span>
<a href="#l3.11"></a><span id="l3.11">   </span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+  /**</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+   * @returns true on full and immediate shutdown, false if we need to pend on</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+   *     something asynchronous.</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+   */</span>
<a href="#l3.16"></a><span id="l3.16">   _shutdown: function gloda_index_shutdown(aUrlListener) {</span>
<a href="#l3.17"></a><span id="l3.17">     if (!this.enabled)</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineminus">-      return;</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineplus">+      return true;</span>
<a href="#l3.20"></a><span id="l3.20">     </span>
<a href="#l3.21"></a><span id="l3.21">     this._log.info(&quot;Shutting Down&quot;);</span>
<a href="#l3.22"></a><span id="l3.22"> </span>
<a href="#l3.23"></a><span id="l3.23">     this.suppressIndexing = true;</span>
<a href="#l3.24"></a><span id="l3.24">     this._indexerLeaveFolder(); // nop if we aren't &quot;in&quot; a folder</span>
<a href="#l3.25"></a><span id="l3.25">     this.enabled = false;</span>
<a href="#l3.26"></a><span id="l3.26"> </span>
<a href="#l3.27"></a><span id="l3.27">     // if the datastore can't stop immediately, it will call the provided</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

