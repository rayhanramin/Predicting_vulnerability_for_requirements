<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 4705:3224404d8ed990f2ed1607a0282bc8112b661627</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 3224404d8ed990f2ed1607a0282bc8112b661627" />
<meta property="og:url" content="/comm-central/rev/3224404d8ed990f2ed1607a0282bc8112b661627" />
<meta property="og:description" content="Bug 539908 - Random orange: TEST-UNEXPECTED-FAIL | test_videoAllowedInMail. add plan_for_message_display, debug helper, and improve docs v1. test-only. r=sid0." />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 3224404d8ed990f2ed1607a0282bc8112b661627 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/3224404d8ed990f2ed1607a0282bc8112b661627">shortlog</a> |
<a href="/comm-central/log/3224404d8ed990f2ed1607a0282bc8112b661627">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/3224404d8ed990f2ed1607a0282bc8112b661627">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/3224404d8ed990f2ed1607a0282bc8112b661627">files</a> |
changeset |
<a href="/comm-central/raw-rev/3224404d8ed990f2ed1607a0282bc8112b661627">raw</a>  | <a href="/comm-central/archive/3224404d8ed990f2ed1607a0282bc8112b661627.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=539908">Bug 539908</a> - Random orange: TEST-UNEXPECTED-FAIL | test_videoAllowedInMail. add plan_for_message_display, debug helper, and improve docs v1. test-only. r=sid0.
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#65;&#110;&#100;&#114;&#101;&#119;&#32;&#83;&#117;&#116;&#104;&#101;&#114;&#108;&#97;&#110;&#100;&#32;&#60;&#97;&#115;&#117;&#116;&#104;&#101;&#114;&#108;&#97;&#110;&#100;&#64;&#97;&#115;&#117;&#116;&#104;&#101;&#114;&#108;&#97;&#110;&#100;&#46;&#111;&#114;&#103;&#62;</td></tr>
<tr><td></td><td class="date age">Mon, 18 Jan 2010 00:05:10 -0800</td></tr>

<tr>
 <td>changeset 4705</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/3224404d8ed990f2ed1607a0282bc8112b661627">3224404d8ed990f2ed1607a0282bc8112b661627</a></td>
</tr>



<tr>
<td>parent 4704</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/3a004d8c38fec49f348b664633b7ec58742f6641">3a004d8c38fec49f348b664633b7ec58742f6641</a>
</td>
</tr>

<tr>
<td>child 4706</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/7f0ab878abe7496b9ca2eb5ee00af6d2843bef5c">7f0ab878abe7496b9ca2eb5ee00af6d2843bef5c</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=3224404d8ed990f2ed1607a0282bc8112b661627">3683</a></td></tr>
<tr><td>push user</td><td>bugmail@asutherland.org</td></tr>
<tr><td>push date</td><td class="date age">Mon, 18 Jan 2010 08:06:22 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@3224404d8ed9 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=3224404d8ed990f2ed1607a0282bc8112b661627">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=3224404d8ed990f2ed1607a0282bc8112b661627&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=3224404d8ed990f2ed1607a0282bc8112b661627&newProject=comm-central&newRevision=3224404d8ed990f2ed1607a0282bc8112b661627&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=3224404d8ed990f2ed1607a0282bc8112b661627&newProject=comm-central&newRevision=3224404d8ed990f2ed1607a0282bc8112b661627&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=3224404d8ed990f2ed1607a0282bc8112b661627&newProject=comm-central&newRevision=3224404d8ed990f2ed1607a0282bc8112b661627&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28sid0%29&revcount=50">sid0</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=539908">539908</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=539908">Bug 539908</a> - Random orange: TEST-UNEXPECTED-FAIL | test_videoAllowedInMail. add plan_for_message_display, debug helper, and improve docs v1. test-only. r=sid0.</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/3224404d8ed990f2ed1607a0282bc8112b661627/mail/base/content/messageDisplay.js">mail/base/content/messageDisplay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/3224404d8ed990f2ed1607a0282bc8112b661627/mail/base/content/messageDisplay.js">file</a> |
<a href="/comm-central/annotate/3224404d8ed990f2ed1607a0282bc8112b661627/mail/base/content/messageDisplay.js">annotate</a> |
<a href="/comm-central/diff/3224404d8ed990f2ed1607a0282bc8112b661627/mail/base/content/messageDisplay.js">diff</a> |
<a href="/comm-central/comparison/3224404d8ed990f2ed1607a0282bc8112b661627/mail/base/content/messageDisplay.js">comparison</a> |
<a href="/comm-central/log/3224404d8ed990f2ed1607a0282bc8112b661627/mail/base/content/messageDisplay.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/3224404d8ed990f2ed1607a0282bc8112b661627/mail/test/mozmill/content-policy/test-video-content-policy.js">mail/test/mozmill/content-policy/test-video-content-policy.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/3224404d8ed990f2ed1607a0282bc8112b661627/mail/test/mozmill/content-policy/test-video-content-policy.js">file</a> |
<a href="/comm-central/annotate/3224404d8ed990f2ed1607a0282bc8112b661627/mail/test/mozmill/content-policy/test-video-content-policy.js">annotate</a> |
<a href="/comm-central/diff/3224404d8ed990f2ed1607a0282bc8112b661627/mail/test/mozmill/content-policy/test-video-content-policy.js">diff</a> |
<a href="/comm-central/comparison/3224404d8ed990f2ed1607a0282bc8112b661627/mail/test/mozmill/content-policy/test-video-content-policy.js">comparison</a> |
<a href="/comm-central/log/3224404d8ed990f2ed1607a0282bc8112b661627/mail/test/mozmill/content-policy/test-video-content-policy.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/3224404d8ed990f2ed1607a0282bc8112b661627/mail/test/mozmill/folder-display/test-message-window.js">mail/test/mozmill/folder-display/test-message-window.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/3224404d8ed990f2ed1607a0282bc8112b661627/mail/test/mozmill/folder-display/test-message-window.js">file</a> |
<a href="/comm-central/annotate/3224404d8ed990f2ed1607a0282bc8112b661627/mail/test/mozmill/folder-display/test-message-window.js">annotate</a> |
<a href="/comm-central/diff/3224404d8ed990f2ed1607a0282bc8112b661627/mail/test/mozmill/folder-display/test-message-window.js">diff</a> |
<a href="/comm-central/comparison/3224404d8ed990f2ed1607a0282bc8112b661627/mail/test/mozmill/folder-display/test-message-window.js">comparison</a> |
<a href="/comm-central/log/3224404d8ed990f2ed1607a0282bc8112b661627/mail/test/mozmill/folder-display/test-message-window.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/3224404d8ed990f2ed1607a0282bc8112b661627/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">mail/test/mozmill/shared-modules/test-folder-display-helpers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/3224404d8ed990f2ed1607a0282bc8112b661627/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">file</a> |
<a href="/comm-central/annotate/3224404d8ed990f2ed1607a0282bc8112b661627/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">annotate</a> |
<a href="/comm-central/diff/3224404d8ed990f2ed1607a0282bc8112b661627/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">diff</a> |
<a href="/comm-central/comparison/3224404d8ed990f2ed1607a0282bc8112b661627/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">comparison</a> |
<a href="/comm-central/log/3224404d8ed990f2ed1607a0282bc8112b661627/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/3224404d8ed990f2ed1607a0282bc8112b661627/mail/test/mozmill/shared-modules/test-window-helpers.js">mail/test/mozmill/shared-modules/test-window-helpers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/3224404d8ed990f2ed1607a0282bc8112b661627/mail/test/mozmill/shared-modules/test-window-helpers.js">file</a> |
<a href="/comm-central/annotate/3224404d8ed990f2ed1607a0282bc8112b661627/mail/test/mozmill/shared-modules/test-window-helpers.js">annotate</a> |
<a href="/comm-central/diff/3224404d8ed990f2ed1607a0282bc8112b661627/mail/test/mozmill/shared-modules/test-window-helpers.js">diff</a> |
<a href="/comm-central/comparison/3224404d8ed990f2ed1607a0282bc8112b661627/mail/test/mozmill/shared-modules/test-window-helpers.js">comparison</a> |
<a href="/comm-central/log/3224404d8ed990f2ed1607a0282bc8112b661627/mail/test/mozmill/shared-modules/test-window-helpers.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/base/content/messageDisplay.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/base/content/messageDisplay.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -113,16 +113,30 @@ MessageDisplayWidget.prototype = {</span>
<a href="#l1.4"></a><span id="l1.4">   //@}</span>
<a href="#l1.5"></a><span id="l1.5"> </span>
<a href="#l1.6"></a><span id="l1.6">   /**</span>
<a href="#l1.7"></a><span id="l1.7">    * @name FolderDisplayWidget Notifications</span>
<a href="#l1.8"></a><span id="l1.8">    * @private</span>
<a href="#l1.9"></a><span id="l1.9">    */</span>
<a href="#l1.10"></a><span id="l1.10">   //@{</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+  /**</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+   * Unit testing support variable that tracks whether a message load is in</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+   *  process.  This is set to true when |onDisplayingMessage| is invoked and</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+   *  cleared by invoking |clearDisplay| or when the message finishes streaming</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineplus">+   *  and |messageLoaded| is set to true.</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineplus">+   */</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineplus">+  messageLoading: false,</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineplus">+  /**</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineplus">+   * Unit testing support variable that tracks whether there is currently a</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineplus">+   *  fully displayed message.  This is cleared when |clearDisplay| is invoked</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineplus">+   *  or we hear that a new message begins streaming via |onDisplayingMessage|.</span>
<a href="#l1.23"></a><span id="l1.23" class="difflineplus">+   */</span>
<a href="#l1.24"></a><span id="l1.24" class="difflineplus">+  messageLoaded: false,</span>
<a href="#l1.25"></a><span id="l1.25" class="difflineplus">+</span>
<a href="#l1.26"></a><span id="l1.26">   clearDisplay: function MessageDisplayWidget_clearDisplay() {</span>
<a href="#l1.27"></a><span id="l1.27">     this.displayedMessage = null;</span>
<a href="#l1.28"></a><span id="l1.28">     this.messageLoading = false;</span>
<a href="#l1.29"></a><span id="l1.29">     this.messageLoaded = false;</span>
<a href="#l1.30"></a><span id="l1.30">     ClearPendingReadTimer();</span>
<a href="#l1.31"></a><span id="l1.31">     ClearMessagePane();</span>
<a href="#l1.32"></a><span id="l1.32">   },</span>
<a href="#l1.33"></a><span id="l1.33"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/test/mozmill/content-policy/test-video-content-policy.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/test/mozmill/content-policy/test-video-content-policy.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -189,16 +189,18 @@ function test_videoDeniedInReplyWindow()</span>
<a href="#l2.4"></a><span id="l2.4">     throw new Error(&quot;Video has not been blocked in reply window as expected.&quot;);</span>
<a href="#l2.5"></a><span id="l2.5"> </span>
<a href="#l2.6"></a><span id="l2.6">   windowHelper.close_window(replyWindow);</span>
<a href="#l2.7"></a><span id="l2.7"> }</span>
<a href="#l2.8"></a><span id="l2.8"> </span>
<a href="#l2.9"></a><span id="l2.9"> function test_videoAllowedInMail() {</span>
<a href="#l2.10"></a><span id="l2.10">   addMsgToFolderAndCheckNoRemoteVideo(folder);</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+  plan_for_message_display(mc);</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+</span>
<a href="#l2.14"></a><span id="l2.14">   // Click on the allow remote content button</span>
<a href="#l2.15"></a><span id="l2.15">   mc.click(new elib.ID(mozmill.getMail3PaneController().window.document, &quot;remoteContentBarButton&quot;));</span>
<a href="#l2.16"></a><span id="l2.16"> </span>
<a href="#l2.17"></a><span id="l2.17">   wait_for_message_display_completion(mc, true);</span>
<a href="#l2.18"></a><span id="l2.18"> </span>
<a href="#l2.19"></a><span id="l2.19">   if (mozmill.getMail3PaneController().window.content.document</span>
<a href="#l2.20"></a><span id="l2.20">              .getElementById(&quot;video1&quot;).networkState ==</span>
<a href="#l2.21"></a><span id="l2.21">       Components.interfaces.nsIDOMHTMLMediaElement.NETWORK_NO_SOURCE)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/test/mozmill/folder-display/test-message-window.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/test/mozmill/folder-display/test-message-window.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -77,27 +77,29 @@ function test_open_message_window() {</span>
<a href="#l3.4"></a><span id="l3.4">   assert_selected_and_displayed(msgc, curMessage);</span>
<a href="#l3.5"></a><span id="l3.5"> }</span>
<a href="#l3.6"></a><span id="l3.6"> </span>
<a href="#l3.7"></a><span id="l3.7"> /**</span>
<a href="#l3.8"></a><span id="l3.8">  * Use the &quot;f&quot; keyboard accelerator to navigate to the next message,</span>
<a href="#l3.9"></a><span id="l3.9">  * and verify that it is indeed loaded.</span>
<a href="#l3.10"></a><span id="l3.10">  */</span>
<a href="#l3.11"></a><span id="l3.11"> function test_navigate_to_next_message() {</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+  plan_for_message_display(msgc);</span>
<a href="#l3.13"></a><span id="l3.13">   msgc.keypress(null, &quot;f&quot;, {});</span>
<a href="#l3.14"></a><span id="l3.14">   wait_for_message_display_completion(msgc, true);</span>
<a href="#l3.15"></a><span id="l3.15">   assert_selected_and_displayed(msgc, 1);</span>
<a href="#l3.16"></a><span id="l3.16"> }</span>
<a href="#l3.17"></a><span id="l3.17"> </span>
<a href="#l3.18"></a><span id="l3.18"> /**</span>
<a href="#l3.19"></a><span id="l3.19">  * Delete a single message and verify the next message is loaded. This sets</span>
<a href="#l3.20"></a><span id="l3.20">  * us up for the next test, which is delete on a collapsed thread after</span>
<a href="#l3.21"></a><span id="l3.21">  * the previous message was deleted.</span>
<a href="#l3.22"></a><span id="l3.22">  */</span>
<a href="#l3.23"></a><span id="l3.23"> function test_delete_single_message() {</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineplus">+  plan_for_message_display(msgc);</span>
<a href="#l3.25"></a><span id="l3.25">   press_delete(msgc);</span>
<a href="#l3.26"></a><span id="l3.26">   wait_for_message_display_completion(msgc, true);</span>
<a href="#l3.27"></a><span id="l3.27">   assert_selected_and_displayed(msgc, 1);</span>
<a href="#l3.28"></a><span id="l3.28"> }</span>
<a href="#l3.29"></a><span id="l3.29"> </span>
<a href="#l3.30"></a><span id="l3.30"> /**</span>
<a href="#l3.31"></a><span id="l3.31">  * Delete the current message, and verify that it only deletes</span>
<a href="#l3.32"></a><span id="l3.32">  * a single message, not the messages in the collapsed thread</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mail/test/mozmill/shared-modules/test-folder-display-helpers.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mail/test/mozmill/shared-modules/test-folder-display-helpers.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -771,17 +771,17 @@ function assert_folder_mode(aMode) {</span>
<a href="#l4.4"></a><span id="l4.4">  */</span>
<a href="#l4.5"></a><span id="l4.5"> function assert_folder_child_in_view(aChild, aParent) {</span>
<a href="#l4.6"></a><span id="l4.6">   let actualParent = mc.folderTreeView.getParentOfFolder(aChild);</span>
<a href="#l4.7"></a><span id="l4.7">   if (actualParent != aParent)</span>
<a href="#l4.8"></a><span id="l4.8">     throw new Error(&quot;Folder &quot; + aChild.URI + &quot; should be the child of &quot; +</span>
<a href="#l4.9"></a><span id="l4.9">                     (aParent &amp;&amp; aParent.URI) +</span>
<a href="#l4.10"></a><span id="l4.10">                     &quot;, but is actually the child of &quot; +</span>
<a href="#l4.11"></a><span id="l4.11">                     (actualParent &amp;&amp; actualParent.URI));</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-      </span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+</span>
<a href="#l4.14"></a><span id="l4.14"> }</span>
<a href="#l4.15"></a><span id="l4.15"> </span>
<a href="#l4.16"></a><span id="l4.16"> /**</span>
<a href="#l4.17"></a><span id="l4.17">  * Assert that the given folder is in the current folder mode and is visible.</span>
<a href="#l4.18"></a><span id="l4.18">  *</span>
<a href="#l4.19"></a><span id="l4.19">  * @returns The index of the folder, if it is visible.</span>
<a href="#l4.20"></a><span id="l4.20">  */</span>
<a href="#l4.21"></a><span id="l4.21"> function assert_folder_visible(aFolder) {</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineat">@@ -1053,27 +1053,56 @@ function wait_for_all_messages_to_load(a</span>
<a href="#l4.23"></a><span id="l4.23">                               FAST_INTERVAL, aController.folderDisplay))</span>
<a href="#l4.24"></a><span id="l4.24">     throw new Error(&quot;Messages never finished loading.  Timed Out.&quot;);</span>
<a href="#l4.25"></a><span id="l4.25">   // the above may return immediately, meaning the event queue might not get a</span>
<a href="#l4.26"></a><span id="l4.26">   //  chance.  give it a chance now.</span>
<a href="#l4.27"></a><span id="l4.27">   aController.sleep(0);</span>
<a href="#l4.28"></a><span id="l4.28"> }</span>
<a href="#l4.29"></a><span id="l4.29"> </span>
<a href="#l4.30"></a><span id="l4.30"> /**</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineminus">- * If  a message is in the process of loading, let it finish.  Otherwise we get</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineminus">- *  horrible assertions like so:</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineplus">+ * Call this before triggering a message display that you are going to wait for</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineplus">+ *  using |wait_for_message_display_completion| where you are passing true for</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineplus">+ *  the aLoadDemanded argument.  This ensures that if a message is already</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineplus">+ *  displayed for the given controller that state is sufficiently cleaned up</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineplus">+ *  so it doesn't trick us into thinking that there is no need to wait.</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineplus">+ *</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineplus">+ * @param [aController] optional controller, defaulting to |mc|.</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineplus">+ */</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineplus">+function plan_for_message_display(aController) {</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineplus">+  if (aController === undefined)</span>
<a href="#l4.43"></a><span id="l4.43" class="difflineplus">+    aController = mc;</span>
<a href="#l4.44"></a><span id="l4.44" class="difflineplus">+  aController.messageDisplay.messageLoaded = false;</span>
<a href="#l4.45"></a><span id="l4.45" class="difflineplus">+}</span>
<a href="#l4.46"></a><span id="l4.46" class="difflineplus">+</span>
<a href="#l4.47"></a><span id="l4.47" class="difflineplus">+/**</span>
<a href="#l4.48"></a><span id="l4.48" class="difflineplus">+ * If a message is in the process of loading, let it finish; optionally, be sure</span>
<a href="#l4.49"></a><span id="l4.49" class="difflineplus">+ *  to wait for a load to happen (assuming |plan_for_message_display| is used.)</span>
<a href="#l4.50"></a><span id="l4.50" class="difflineplus">+ *</span>
<a href="#l4.51"></a><span id="l4.51" class="difflineplus">+ * This method is used defensively by a lot of other code in this file that is</span>
<a href="#l4.52"></a><span id="l4.52" class="difflineplus">+ *  realy not sure whether there might be a load in progress or not.  So by</span>
<a href="#l4.53"></a><span id="l4.53" class="difflineplus">+ *  default we only do something if there is obviously a message display in</span>
<a href="#l4.54"></a><span id="l4.54" class="difflineplus">+ *  progress.  Since some events may end up getting deferred due to script</span>
<a href="#l4.55"></a><span id="l4.55" class="difflineplus">+ *  blockers or the like, it is possible the event that triggers the display</span>
<a href="#l4.56"></a><span id="l4.56" class="difflineplus">+ *  may not have happened by the time you call this.  In that case, you should</span>
<a href="#l4.57"></a><span id="l4.57" class="difflineplus">+ *  1) pass true for aLoadDemanded and 2) invoke |plan_for_message_display|</span>
<a href="#l4.58"></a><span id="l4.58" class="difflineplus">+ *  before triggering the event that will induce a message display.  You do not</span>
<a href="#l4.59"></a><span id="l4.59" class="difflineplus">+ *  need to do #2 if you are opening a new message window and can assume that</span>
<a href="#l4.60"></a><span id="l4.60" class="difflineplus">+ *  this will be the first message ever displayed in the window.</span>
<a href="#l4.61"></a><span id="l4.61" class="difflineplus">+ *</span>
<a href="#l4.62"></a><span id="l4.62" class="difflineplus">+ * If we didn't use this method defensively, we would get horrible assertions</span>
<a href="#l4.63"></a><span id="l4.63" class="difflineplus">+ *  like so:</span>
<a href="#l4.64"></a><span id="l4.64">  * ###!!! ASSERTION: Overwriting an existing document channel!</span>
<a href="#l4.65"></a><span id="l4.65">  *</span>
<a href="#l4.66"></a><span id="l4.66" class="difflineminus">- * @param aController optional controller, defaulting to |mc|.</span>
<a href="#l4.67"></a><span id="l4.67" class="difflineminus">- * @param aLoadDemanded optional indication that we expect and demand that a</span>
<a href="#l4.68"></a><span id="l4.68" class="difflineminus">- *     message be loaded.  If you call us before the message loading is</span>
<a href="#l4.69"></a><span id="l4.69" class="difflineminus">- *     initiated, you will need to pass true for this so that we don't see</span>
<a href="#l4.70"></a><span id="l4.70" class="difflineminus">- *     that a load hasn't started and assume none is required.  Defaults to</span>
<a href="#l4.71"></a><span id="l4.71" class="difflineminus">- *     false.  This relies on aController.messageDisplay.messageLoaded to</span>
<a href="#l4.72"></a><span id="l4.72" class="difflineminus">- *     be reliable; make sure it is false when entering this function.</span>
<a href="#l4.73"></a><span id="l4.73" class="difflineplus">+ *</span>
<a href="#l4.74"></a><span id="l4.74" class="difflineplus">+ * @param [aController] optional controller, defaulting to |mc|.</span>
<a href="#l4.75"></a><span id="l4.75" class="difflineplus">+ * @param [aLoadDemanded=false] Should we require that we wait for a message to</span>
<a href="#l4.76"></a><span id="l4.76" class="difflineplus">+ *     be loaded?  You should use this in conjunction with</span>
<a href="#l4.77"></a><span id="l4.77" class="difflineplus">+ *     |plan_for_message_display| as per the documentation above.  If you do</span>
<a href="#l4.78"></a><span id="l4.78" class="difflineplus">+ *     not pass true and there is no message load in process, this method will</span>
<a href="#l4.79"></a><span id="l4.79" class="difflineplus">+ *     return immediately.</span>
<a href="#l4.80"></a><span id="l4.80">  */</span>
<a href="#l4.81"></a><span id="l4.81"> function wait_for_message_display_completion(aController, aLoadDemanded) {</span>
<a href="#l4.82"></a><span id="l4.82">   if (aController === undefined)</span>
<a href="#l4.83"></a><span id="l4.83">     aController = mc;</span>
<a href="#l4.84"></a><span id="l4.84">   let contentPane = aController.contentPane;</span>
<a href="#l4.85"></a><span id="l4.85">   let oldHref = null;</span>
<a href="#l4.86"></a><span id="l4.86"> </span>
<a href="#l4.87"></a><span id="l4.87">   // There are a couple possible states the universe can be in:</span>
<a href="#l4.88"></a><span id="l4.88" class="difflineat">@@ -1083,18 +1112,20 @@ function wait_for_message_display_comple</span>
<a href="#l4.89"></a><span id="l4.89">   // 4) A message load should happen in the near future.</span>
<a href="#l4.90"></a><span id="l4.90">   //</span>
<a href="#l4.91"></a><span id="l4.91">   // We have nothing that needs to be done in cases 1 and 2.  Case 3 is pretty</span>
<a href="#l4.92"></a><span id="l4.92">   //  easy for us.  The question is differentiating between case 4 and (1, 2).</span>
<a href="#l4.93"></a><span id="l4.93">   //  We rely on MessageDisplayWidget.messageLoaded to differentiate this case</span>
<a href="#l4.94"></a><span id="l4.94">   //  for us.</span>
<a href="#l4.95"></a><span id="l4.95">   let isLoadedChecker = function() {</span>
<a href="#l4.96"></a><span id="l4.96">     // If a load is demanded, first require that MessageDisplayWidget think</span>
<a href="#l4.97"></a><span id="l4.97" class="difflineminus">-    //  that the message is loaded.  Because the notification is imperfect,</span>
<a href="#l4.98"></a><span id="l4.98" class="difflineminus">-    //  this will strictly happen before the URL finishes running.</span>
<a href="#l4.99"></a><span id="l4.99" class="difflineplus">+    //  that the message is loaded.  Because the notification that sets the flag</span>
<a href="#l4.100"></a><span id="l4.100" class="difflineplus">+    //  happens when the message reader code gets told about the last attachment,</span>
<a href="#l4.101"></a><span id="l4.101" class="difflineplus">+    //  this will actually happen before the URL is finished running.  Luckily</span>
<a href="#l4.102"></a><span id="l4.102" class="difflineplus">+    //  we have the code below to try and deal with that.</span>
<a href="#l4.103"></a><span id="l4.103">     if (aLoadDemanded &amp;&amp; !aController.messageDisplay.messageLoaded)</span>
<a href="#l4.104"></a><span id="l4.104">       return false;</span>
<a href="#l4.105"></a><span id="l4.105"> </span>
<a href="#l4.106"></a><span id="l4.106">     let docShell = contentPane.docShell;</span>
<a href="#l4.107"></a><span id="l4.107">     if (!docShell)</span>
<a href="#l4.108"></a><span id="l4.108">       return false;</span>
<a href="#l4.109"></a><span id="l4.109">     let uri = docShell.currentURI;</span>
<a href="#l4.110"></a><span id="l4.110">     // the URL will tell us if it is running, saves us from potential error</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mail/test/mozmill/shared-modules/test-window-helpers.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mail/test/mozmill/shared-modules/test-window-helpers.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -631,16 +631,35 @@ var AugmentEverybodyWith = {</span>
<a href="#l5.4"></a><span id="l5.4">       return null;</span>
<a href="#l5.5"></a><span id="l5.5">     },</span>
<a href="#l5.6"></a><span id="l5.6">     /**</span>
<a href="#l5.7"></a><span id="l5.7">      * Wraps a call to a() in an elib.Elem.</span>
<a href="#l5.8"></a><span id="l5.8">      */</span>
<a href="#l5.9"></a><span id="l5.9">     aid: function _get_anon_elementid(aId, aQuery) {</span>
<a href="#l5.10"></a><span id="l5.10">       return new elib.Elem(this.a(aId, aQuery));</span>
<a href="#l5.11"></a><span id="l5.11">     },</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+    /**</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+     * Debug helper that defers a click until the next event loop spin in order</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineplus">+     *  to create situations that are hard to test in isolation.  In order to</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineplus">+     *  fashion reliable failures, we currently use a 1-second delay to make</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineplus">+     *  sure things get sufficiently gummed up.</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineplus">+     * Only use this for locally reproducing tinderbox failures; do not commit</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineplus">+     *  code that uses this!</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineplus">+     *</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineplus">+     * This gets its own method rather than a generic deferring wrapper so we</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineplus">+     *  can strap debug on and because it's meant so you can easily just</span>
<a href="#l5.23"></a><span id="l5.23" class="difflineplus">+     *  prefix on 'defer_' and be done with it.</span>
<a href="#l5.24"></a><span id="l5.24" class="difflineplus">+     */</span>
<a href="#l5.25"></a><span id="l5.25" class="difflineplus">+    defer_click: function _augmented_defer_click(aWhatToClick) {</span>
<a href="#l5.26"></a><span id="l5.26" class="difflineplus">+      let dis = this;</span>
<a href="#l5.27"></a><span id="l5.27" class="difflineplus">+      dis.window.setTimeout(function() {</span>
<a href="#l5.28"></a><span id="l5.28" class="difflineplus">+                              dis.click(aWhatToClick);</span>
<a href="#l5.29"></a><span id="l5.29" class="difflineplus">+                            }, 1000);</span>
<a href="#l5.30"></a><span id="l5.30" class="difflineplus">+    },</span>
<a href="#l5.31"></a><span id="l5.31">   },</span>
<a href="#l5.32"></a><span id="l5.32"> };</span>
<a href="#l5.33"></a><span id="l5.33"> </span>
<a href="#l5.34"></a><span id="l5.34"> /**</span>
<a href="#l5.35"></a><span id="l5.35">  * Per-windowtype augmentations.  Please use the documentation and general</span>
<a href="#l5.36"></a><span id="l5.36">  *  example of mail:3pane as your example.</span>
<a href="#l5.37"></a><span id="l5.37">  */</span>
<a href="#l5.38"></a><span id="l5.38"> var PerWindowTypeAugmentations = {</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

