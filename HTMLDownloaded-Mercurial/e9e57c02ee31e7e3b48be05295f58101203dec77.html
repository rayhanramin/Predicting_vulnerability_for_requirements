<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 21146:e9e57c02ee31e7e3b48be05295f58101203dec77</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ e9e57c02ee31e7e3b48be05295f58101203dec77" />
<meta property="og:url" content="/comm-central/rev/e9e57c02ee31e7e3b48be05295f58101203dec77" />
<meta property="og:description" content="Bug 1338715 - Remove the Outlook Express import files. r=jorgk" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / e9e57c02ee31e7e3b48be05295f58101203dec77 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/e9e57c02ee31e7e3b48be05295f58101203dec77">shortlog</a> |
<a href="/comm-central/log/e9e57c02ee31e7e3b48be05295f58101203dec77">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/e9e57c02ee31e7e3b48be05295f58101203dec77">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/e9e57c02ee31e7e3b48be05295f58101203dec77">files</a> |
changeset |
<a href="/comm-central/raw-rev/e9e57c02ee31e7e3b48be05295f58101203dec77">raw</a>  | <a href="/comm-central/archive/e9e57c02ee31e7e3b48be05295f58101203dec77.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1338715">Bug 1338715</a> - Remove the Outlook Express import files. r=jorgk
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#82;&#105;&#99;&#104;&#97;&#114;&#100;&#32;&#77;&#97;&#114;&#116;&#105;&#32;&#60;&#114;&#105;&#99;&#104;&#97;&#114;&#100;&#46;&#109;&#97;&#114;&#116;&#105;&#64;&#103;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Sat, 11 Feb 2017 12:13:37 +0100</td></tr>

<tr>
 <td>changeset 21146</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/e9e57c02ee31e7e3b48be05295f58101203dec77">e9e57c02ee31e7e3b48be05295f58101203dec77</a></td>
</tr>



<tr>
<td>parent 21145</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/424cdd3c5239dd57a3110b6468bb79ca9d005eaa">424cdd3c5239dd57a3110b6468bb79ca9d005eaa</a>
</td>
</tr>

<tr>
<td>child 21147</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/085844c49579d07fc010bfdd2ad07586af2eb522">085844c49579d07fc010bfdd2ad07586af2eb522</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=e9e57c02ee31e7e3b48be05295f58101203dec77">12848</a></td></tr>
<tr><td>push user</td><td>mozilla@jorgk.com</td></tr>
<tr><td>push date</td><td class="date age">Sat, 11 Feb 2017 21:27:22 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@5c33fa867d03 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=5c33fa867d03e8099ab69b795f9967382eba80d2">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=5c33fa867d03e8099ab69b795f9967382eba80d2&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=5c33fa867d03e8099ab69b795f9967382eba80d2&newProject=comm-central&newRevision=e9e57c02ee31e7e3b48be05295f58101203dec77&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=5c33fa867d03e8099ab69b795f9967382eba80d2&newProject=comm-central&newRevision=e9e57c02ee31e7e3b48be05295f58101203dec77&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=5c33fa867d03e8099ab69b795f9967382eba80d2&newProject=comm-central&newRevision=e9e57c02ee31e7e3b48be05295f58101203dec77&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28jorgk%29&revcount=50">jorgk</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1338715">1338715</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1338715">Bug 1338715</a> - Remove the Outlook Express import files. r=jorgk</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e9e57c02ee31e7e3b48be05295f58101203dec77/mailnews/import/oexpress/OEDebugLog.h">mailnews/import/oexpress/OEDebugLog.h</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/e9e57c02ee31e7e3b48be05295f58101203dec77/mailnews/import/oexpress/OEDebugLog.h">diff</a> |
<a href="/comm-central/comparison/e9e57c02ee31e7e3b48be05295f58101203dec77/mailnews/import/oexpress/OEDebugLog.h">comparison</a> |
<a href="/comm-central/log/e9e57c02ee31e7e3b48be05295f58101203dec77/mailnews/import/oexpress/OEDebugLog.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e9e57c02ee31e7e3b48be05295f58101203dec77/mailnews/import/oexpress/WabObject.cpp">mailnews/import/oexpress/WabObject.cpp</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/e9e57c02ee31e7e3b48be05295f58101203dec77/mailnews/import/oexpress/WabObject.cpp">diff</a> |
<a href="/comm-central/comparison/e9e57c02ee31e7e3b48be05295f58101203dec77/mailnews/import/oexpress/WabObject.cpp">comparison</a> |
<a href="/comm-central/log/e9e57c02ee31e7e3b48be05295f58101203dec77/mailnews/import/oexpress/WabObject.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e9e57c02ee31e7e3b48be05295f58101203dec77/mailnews/import/oexpress/WabObject.h">mailnews/import/oexpress/WabObject.h</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/e9e57c02ee31e7e3b48be05295f58101203dec77/mailnews/import/oexpress/WabObject.h">diff</a> |
<a href="/comm-central/comparison/e9e57c02ee31e7e3b48be05295f58101203dec77/mailnews/import/oexpress/WabObject.h">comparison</a> |
<a href="/comm-central/log/e9e57c02ee31e7e3b48be05295f58101203dec77/mailnews/import/oexpress/WabObject.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e9e57c02ee31e7e3b48be05295f58101203dec77/mailnews/import/oexpress/moz.build">mailnews/import/oexpress/moz.build</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/e9e57c02ee31e7e3b48be05295f58101203dec77/mailnews/import/oexpress/moz.build">diff</a> |
<a href="/comm-central/comparison/e9e57c02ee31e7e3b48be05295f58101203dec77/mailnews/import/oexpress/moz.build">comparison</a> |
<a href="/comm-central/log/e9e57c02ee31e7e3b48be05295f58101203dec77/mailnews/import/oexpress/moz.build">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e9e57c02ee31e7e3b48be05295f58101203dec77/mailnews/import/oexpress/nsOE5File.cpp">mailnews/import/oexpress/nsOE5File.cpp</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/e9e57c02ee31e7e3b48be05295f58101203dec77/mailnews/import/oexpress/nsOE5File.cpp">diff</a> |
<a href="/comm-central/comparison/e9e57c02ee31e7e3b48be05295f58101203dec77/mailnews/import/oexpress/nsOE5File.cpp">comparison</a> |
<a href="/comm-central/log/e9e57c02ee31e7e3b48be05295f58101203dec77/mailnews/import/oexpress/nsOE5File.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e9e57c02ee31e7e3b48be05295f58101203dec77/mailnews/import/oexpress/nsOE5File.h">mailnews/import/oexpress/nsOE5File.h</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/e9e57c02ee31e7e3b48be05295f58101203dec77/mailnews/import/oexpress/nsOE5File.h">diff</a> |
<a href="/comm-central/comparison/e9e57c02ee31e7e3b48be05295f58101203dec77/mailnews/import/oexpress/nsOE5File.h">comparison</a> |
<a href="/comm-central/log/e9e57c02ee31e7e3b48be05295f58101203dec77/mailnews/import/oexpress/nsOE5File.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e9e57c02ee31e7e3b48be05295f58101203dec77/mailnews/import/oexpress/nsOEAddressIterator.cpp">mailnews/import/oexpress/nsOEAddressIterator.cpp</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/e9e57c02ee31e7e3b48be05295f58101203dec77/mailnews/import/oexpress/nsOEAddressIterator.cpp">diff</a> |
<a href="/comm-central/comparison/e9e57c02ee31e7e3b48be05295f58101203dec77/mailnews/import/oexpress/nsOEAddressIterator.cpp">comparison</a> |
<a href="/comm-central/log/e9e57c02ee31e7e3b48be05295f58101203dec77/mailnews/import/oexpress/nsOEAddressIterator.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e9e57c02ee31e7e3b48be05295f58101203dec77/mailnews/import/oexpress/nsOEAddressIterator.h">mailnews/import/oexpress/nsOEAddressIterator.h</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/e9e57c02ee31e7e3b48be05295f58101203dec77/mailnews/import/oexpress/nsOEAddressIterator.h">diff</a> |
<a href="/comm-central/comparison/e9e57c02ee31e7e3b48be05295f58101203dec77/mailnews/import/oexpress/nsOEAddressIterator.h">comparison</a> |
<a href="/comm-central/log/e9e57c02ee31e7e3b48be05295f58101203dec77/mailnews/import/oexpress/nsOEAddressIterator.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e9e57c02ee31e7e3b48be05295f58101203dec77/mailnews/import/oexpress/nsOEImport.cpp">mailnews/import/oexpress/nsOEImport.cpp</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/e9e57c02ee31e7e3b48be05295f58101203dec77/mailnews/import/oexpress/nsOEImport.cpp">diff</a> |
<a href="/comm-central/comparison/e9e57c02ee31e7e3b48be05295f58101203dec77/mailnews/import/oexpress/nsOEImport.cpp">comparison</a> |
<a href="/comm-central/log/e9e57c02ee31e7e3b48be05295f58101203dec77/mailnews/import/oexpress/nsOEImport.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e9e57c02ee31e7e3b48be05295f58101203dec77/mailnews/import/oexpress/nsOEImport.h">mailnews/import/oexpress/nsOEImport.h</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/e9e57c02ee31e7e3b48be05295f58101203dec77/mailnews/import/oexpress/nsOEImport.h">diff</a> |
<a href="/comm-central/comparison/e9e57c02ee31e7e3b48be05295f58101203dec77/mailnews/import/oexpress/nsOEImport.h">comparison</a> |
<a href="/comm-central/log/e9e57c02ee31e7e3b48be05295f58101203dec77/mailnews/import/oexpress/nsOEImport.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e9e57c02ee31e7e3b48be05295f58101203dec77/mailnews/import/oexpress/nsOEMailbox.cpp">mailnews/import/oexpress/nsOEMailbox.cpp</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/e9e57c02ee31e7e3b48be05295f58101203dec77/mailnews/import/oexpress/nsOEMailbox.cpp">diff</a> |
<a href="/comm-central/comparison/e9e57c02ee31e7e3b48be05295f58101203dec77/mailnews/import/oexpress/nsOEMailbox.cpp">comparison</a> |
<a href="/comm-central/log/e9e57c02ee31e7e3b48be05295f58101203dec77/mailnews/import/oexpress/nsOEMailbox.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e9e57c02ee31e7e3b48be05295f58101203dec77/mailnews/import/oexpress/nsOEMailbox.h">mailnews/import/oexpress/nsOEMailbox.h</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/e9e57c02ee31e7e3b48be05295f58101203dec77/mailnews/import/oexpress/nsOEMailbox.h">diff</a> |
<a href="/comm-central/comparison/e9e57c02ee31e7e3b48be05295f58101203dec77/mailnews/import/oexpress/nsOEMailbox.h">comparison</a> |
<a href="/comm-central/log/e9e57c02ee31e7e3b48be05295f58101203dec77/mailnews/import/oexpress/nsOEMailbox.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e9e57c02ee31e7e3b48be05295f58101203dec77/mailnews/import/oexpress/nsOERegUtil.cpp">mailnews/import/oexpress/nsOERegUtil.cpp</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/e9e57c02ee31e7e3b48be05295f58101203dec77/mailnews/import/oexpress/nsOERegUtil.cpp">diff</a> |
<a href="/comm-central/comparison/e9e57c02ee31e7e3b48be05295f58101203dec77/mailnews/import/oexpress/nsOERegUtil.cpp">comparison</a> |
<a href="/comm-central/log/e9e57c02ee31e7e3b48be05295f58101203dec77/mailnews/import/oexpress/nsOERegUtil.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e9e57c02ee31e7e3b48be05295f58101203dec77/mailnews/import/oexpress/nsOERegUtil.h">mailnews/import/oexpress/nsOERegUtil.h</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/e9e57c02ee31e7e3b48be05295f58101203dec77/mailnews/import/oexpress/nsOERegUtil.h">diff</a> |
<a href="/comm-central/comparison/e9e57c02ee31e7e3b48be05295f58101203dec77/mailnews/import/oexpress/nsOERegUtil.h">comparison</a> |
<a href="/comm-central/log/e9e57c02ee31e7e3b48be05295f58101203dec77/mailnews/import/oexpress/nsOERegUtil.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e9e57c02ee31e7e3b48be05295f58101203dec77/mailnews/import/oexpress/nsOEScanBoxes.cpp">mailnews/import/oexpress/nsOEScanBoxes.cpp</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/e9e57c02ee31e7e3b48be05295f58101203dec77/mailnews/import/oexpress/nsOEScanBoxes.cpp">diff</a> |
<a href="/comm-central/comparison/e9e57c02ee31e7e3b48be05295f58101203dec77/mailnews/import/oexpress/nsOEScanBoxes.cpp">comparison</a> |
<a href="/comm-central/log/e9e57c02ee31e7e3b48be05295f58101203dec77/mailnews/import/oexpress/nsOEScanBoxes.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e9e57c02ee31e7e3b48be05295f58101203dec77/mailnews/import/oexpress/nsOEScanBoxes.h">mailnews/import/oexpress/nsOEScanBoxes.h</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/e9e57c02ee31e7e3b48be05295f58101203dec77/mailnews/import/oexpress/nsOEScanBoxes.h">diff</a> |
<a href="/comm-central/comparison/e9e57c02ee31e7e3b48be05295f58101203dec77/mailnews/import/oexpress/nsOEScanBoxes.h">comparison</a> |
<a href="/comm-central/log/e9e57c02ee31e7e3b48be05295f58101203dec77/mailnews/import/oexpress/nsOEScanBoxes.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e9e57c02ee31e7e3b48be05295f58101203dec77/mailnews/import/oexpress/nsOESettings.cpp">mailnews/import/oexpress/nsOESettings.cpp</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/e9e57c02ee31e7e3b48be05295f58101203dec77/mailnews/import/oexpress/nsOESettings.cpp">diff</a> |
<a href="/comm-central/comparison/e9e57c02ee31e7e3b48be05295f58101203dec77/mailnews/import/oexpress/nsOESettings.cpp">comparison</a> |
<a href="/comm-central/log/e9e57c02ee31e7e3b48be05295f58101203dec77/mailnews/import/oexpress/nsOESettings.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e9e57c02ee31e7e3b48be05295f58101203dec77/mailnews/import/oexpress/nsOESettings.h">mailnews/import/oexpress/nsOESettings.h</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/e9e57c02ee31e7e3b48be05295f58101203dec77/mailnews/import/oexpress/nsOESettings.h">diff</a> |
<a href="/comm-central/comparison/e9e57c02ee31e7e3b48be05295f58101203dec77/mailnews/import/oexpress/nsOESettings.h">comparison</a> |
<a href="/comm-central/log/e9e57c02ee31e7e3b48be05295f58101203dec77/mailnews/import/oexpress/nsOESettings.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e9e57c02ee31e7e3b48be05295f58101203dec77/mailnews/import/oexpress/nsOEStringBundle.cpp">mailnews/import/oexpress/nsOEStringBundle.cpp</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/e9e57c02ee31e7e3b48be05295f58101203dec77/mailnews/import/oexpress/nsOEStringBundle.cpp">diff</a> |
<a href="/comm-central/comparison/e9e57c02ee31e7e3b48be05295f58101203dec77/mailnews/import/oexpress/nsOEStringBundle.cpp">comparison</a> |
<a href="/comm-central/log/e9e57c02ee31e7e3b48be05295f58101203dec77/mailnews/import/oexpress/nsOEStringBundle.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e9e57c02ee31e7e3b48be05295f58101203dec77/mailnews/import/oexpress/nsOEStringBundle.h">mailnews/import/oexpress/nsOEStringBundle.h</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/e9e57c02ee31e7e3b48be05295f58101203dec77/mailnews/import/oexpress/nsOEStringBundle.h">diff</a> |
<a href="/comm-central/comparison/e9e57c02ee31e7e3b48be05295f58101203dec77/mailnews/import/oexpress/nsOEStringBundle.h">comparison</a> |
<a href="/comm-central/log/e9e57c02ee31e7e3b48be05295f58101203dec77/mailnews/import/oexpress/nsOEStringBundle.h">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1">deleted file mode 100644</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineminus">--- a/mailnews/import/oexpress/OEDebugLog.h</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineplus">+++ /dev/null</span>
<a href="#l1.4"></a><span id="l1.4" class="difflineat">@@ -1,20 +0,0 @@</span>
<a href="#l1.5"></a><span id="l1.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l1.6"></a><span id="l1.6" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l1.7"></a><span id="l1.7" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l1.8"></a><span id="l1.8" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l1.9"></a><span id="l1.9" class="difflineminus">-</span>
<a href="#l1.10"></a><span id="l1.10" class="difflineminus">-#ifndef OEDebugLog_h___</span>
<a href="#l1.11"></a><span id="l1.11" class="difflineminus">-#define OEDebugLog_h___</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-// Use MOZ_LOG for logging.</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineminus">-#include &quot;mozilla/Logging.h&quot;</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineminus">-extern PRLogModuleInfo *OELOGMODULE;  // Logging module</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineminus">-</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineminus">-#define IMPORT_LOG0(x)          MOZ_LOG(OELOGMODULE, mozilla::LogLevel::Debug, (x))</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineminus">-#define IMPORT_LOG1(x, y)       MOZ_LOG(OELOGMODULE, mozilla::LogLevel::Debug, (x, y))</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineminus">-#define IMPORT_LOG2(x, y, z)    MOZ_LOG(OELOGMODULE, mozilla::LogLevel::Debug, (x, y, z))</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineminus">-#define IMPORT_LOG3(a, b, c, d) MOZ_LOG(OELOGMODULE, mozilla::LogLevel::Debug, (a, b, c, d))</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineminus">-</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineminus">-</span>
<a href="#l1.23"></a><span id="l1.23" class="difflineminus">-</span>
<a href="#l1.24"></a><span id="l1.24" class="difflineminus">-#endif /* OEDebugLog_h___ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1">deleted file mode 100644</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineminus">--- a/mailnews/import/oexpress/WabObject.cpp</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineplus">+++ /dev/null</span>
<a href="#l2.4"></a><span id="l2.4" class="difflineat">@@ -1,1132 +0,0 @@</span>
<a href="#l2.5"></a><span id="l2.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l2.6"></a><span id="l2.6" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l2.7"></a><span id="l2.7" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l2.8"></a><span id="l2.8" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l2.9"></a><span id="l2.9" class="difflineminus">-</span>
<a href="#l2.10"></a><span id="l2.10" class="difflineminus">-#include &lt;tchar.h&gt;</span>
<a href="#l2.11"></a><span id="l2.11" class="difflineminus">-#include &quot;nscore.h&quot;</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-#include &quot;nsOE5File.h&quot;</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-#include &quot;wabobject.h&quot;</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineminus">-#include &lt;algorithm&gt;</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineminus">-</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineminus">-enum {</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineminus">-    ieidPR_DISPLAY_NAME = 0,</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineminus">-    ieidPR_ENTRYID,</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineminus">-    ieidPR_OBJECT_TYPE,</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineminus">-    ieidMax</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineminus">-};</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineminus">-</span>
<a href="#l2.23"></a><span id="l2.23" class="difflineminus">-static const SizedSPropTagArray(ieidMax, ptaEid)=</span>
<a href="#l2.24"></a><span id="l2.24" class="difflineminus">-{</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineminus">-    ieidMax,</span>
<a href="#l2.26"></a><span id="l2.26" class="difflineminus">-    {</span>
<a href="#l2.27"></a><span id="l2.27" class="difflineminus">-        PR_DISPLAY_NAME,</span>
<a href="#l2.28"></a><span id="l2.28" class="difflineminus">-        PR_ENTRYID,</span>
<a href="#l2.29"></a><span id="l2.29" class="difflineminus">-    PR_OBJECT_TYPE,</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineminus">-    }</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineminus">-};</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineminus">-</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineminus">-</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineminus">-enum {</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineminus">-    iemailPR_DISPLAY_NAME = 0,</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineminus">-    iemailPR_ENTRYID,</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineminus">-    iemailPR_EMAIL_ADDRESS,</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineminus">-    iemailPR_OBJECT_TYPE,</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineminus">-    iemailMax</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineminus">-};</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineminus">-static const SizedSPropTagArray(iemailMax, ptaEmail)=</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineminus">-{</span>
<a href="#l2.43"></a><span id="l2.43" class="difflineminus">-    iemailMax,</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineminus">-    {</span>
<a href="#l2.45"></a><span id="l2.45" class="difflineminus">-        PR_DISPLAY_NAME,</span>
<a href="#l2.46"></a><span id="l2.46" class="difflineminus">-        PR_ENTRYID,</span>
<a href="#l2.47"></a><span id="l2.47" class="difflineminus">-        PR_EMAIL_ADDRESS,</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineminus">-        PR_OBJECT_TYPE</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineminus">-    }</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineminus">-};</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineminus">-</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineminus">-typedef struct {</span>
<a href="#l2.53"></a><span id="l2.53" class="difflineminus">-  bool      multiLine;</span>
<a href="#l2.54"></a><span id="l2.54" class="difflineminus">-  ULONG    tag;</span>
<a href="#l2.55"></a><span id="l2.55" class="difflineminus">-  char *    pLDIF;</span>
<a href="#l2.56"></a><span id="l2.56" class="difflineminus">-} AddrImportField;</span>
<a href="#l2.57"></a><span id="l2.57" class="difflineminus">-</span>
<a href="#l2.58"></a><span id="l2.58" class="difflineminus">-#define  kExtraUserFields  10</span>
<a href="#l2.59"></a><span id="l2.59" class="difflineminus">-AddrImportField    extraUserFields[kExtraUserFields] = {</span>
<a href="#l2.60"></a><span id="l2.60" class="difflineminus">-  {true, PR_COMMENT, &quot;description:&quot;},</span>
<a href="#l2.61"></a><span id="l2.61" class="difflineminus">-  {false, PR_BUSINESS_TELEPHONE_NUMBER, &quot;telephonenumber:&quot;},</span>
<a href="#l2.62"></a><span id="l2.62" class="difflineminus">-  {false, PR_HOME_TELEPHONE_NUMBER, &quot;homephone:&quot;},</span>
<a href="#l2.63"></a><span id="l2.63" class="difflineminus">-  {false, PR_COMPANY_NAME, &quot;o:&quot;},</span>
<a href="#l2.64"></a><span id="l2.64" class="difflineminus">-  {false, PR_TITLE, &quot;title:&quot;},</span>
<a href="#l2.65"></a><span id="l2.65" class="difflineminus">-  {false, PR_BUSINESS_FAX_NUMBER, &quot;facsimiletelephonenumber:&quot;},</span>
<a href="#l2.66"></a><span id="l2.66" class="difflineminus">-  {false, PR_LOCALITY, &quot;locality:&quot;},</span>
<a href="#l2.67"></a><span id="l2.67" class="difflineminus">-  {false, PR_STATE_OR_PROVINCE, &quot;st:&quot;},</span>
<a href="#l2.68"></a><span id="l2.68" class="difflineminus">-  {true, PR_STREET_ADDRESS, &quot;streetaddress:&quot;},</span>
<a href="#l2.69"></a><span id="l2.69" class="difflineminus">-  {false, PR_POSTAL_CODE, &quot;postalcode:&quot;}</span>
<a href="#l2.70"></a><span id="l2.70" class="difflineminus">-};</span>
<a href="#l2.71"></a><span id="l2.71" class="difflineminus">-</span>
<a href="#l2.72"></a><span id="l2.72" class="difflineminus">-#define  kWhitespace  &quot; \t\b\r\n&quot;</span>
<a href="#l2.73"></a><span id="l2.73" class="difflineminus">-</span>
<a href="#l2.74"></a><span id="l2.74" class="difflineminus">-#define TR_OUTPUT_EOL  &quot;\r\n&quot;</span>
<a href="#l2.75"></a><span id="l2.75" class="difflineminus">-</span>
<a href="#l2.76"></a><span id="l2.76" class="difflineminus">-#define  kLDIFPerson    &quot;objectclass: top&quot; TR_OUTPUT_EOL &quot;objectclass: person&quot; TR_OUTPUT_EOL</span>
<a href="#l2.77"></a><span id="l2.77" class="difflineminus">-#define kLDIFGroup    &quot;objectclass: top&quot; TR_OUTPUT_EOL &quot;objectclass: groupOfNames&quot; TR_OUTPUT_EOL</span>
<a href="#l2.78"></a><span id="l2.78" class="difflineminus">-</span>
<a href="#l2.79"></a><span id="l2.79" class="difflineminus">-/*********************************************************************************/</span>
<a href="#l2.80"></a><span id="l2.80" class="difflineminus">-</span>
<a href="#l2.81"></a><span id="l2.81" class="difflineminus">-</span>
<a href="#l2.82"></a><span id="l2.82" class="difflineminus">-// contructor for CWAB object</span>
<a href="#l2.83"></a><span id="l2.83" class="difflineminus">-//</span>
<a href="#l2.84"></a><span id="l2.84" class="difflineminus">-// pszFileName - FileName of WAB file to open</span>
<a href="#l2.85"></a><span id="l2.85" class="difflineminus">-//          if no file name is specified, opens the default</span>
<a href="#l2.86"></a><span id="l2.86" class="difflineminus">-//</span>
<a href="#l2.87"></a><span id="l2.87" class="difflineminus">-CWAB::CWAB(nsIFile *file)</span>
<a href="#l2.88"></a><span id="l2.88" class="difflineminus">-{</span>
<a href="#l2.89"></a><span id="l2.89" class="difflineminus">-    // Here we load the WAB Object and initialize it</span>
<a href="#l2.90"></a><span id="l2.90" class="difflineminus">-    m_pUniBuff = NULL;</span>
<a href="#l2.91"></a><span id="l2.91" class="difflineminus">-  m_uniBuffLen = 0;</span>
<a href="#l2.92"></a><span id="l2.92" class="difflineminus">-</span>
<a href="#l2.93"></a><span id="l2.93" class="difflineminus">-  m_bInitialized = false;</span>
<a href="#l2.94"></a><span id="l2.94" class="difflineminus">-  m_lpAdrBook = NULL;</span>
<a href="#l2.95"></a><span id="l2.95" class="difflineminus">-  m_lpWABObject = NULL;</span>
<a href="#l2.96"></a><span id="l2.96" class="difflineminus">-  m_hinstWAB = NULL;</span>
<a href="#l2.97"></a><span id="l2.97" class="difflineminus">-</span>
<a href="#l2.98"></a><span id="l2.98" class="difflineminus">-    {</span>
<a href="#l2.99"></a><span id="l2.99" class="difflineminus">-        TCHAR  szWABDllPath[MAX_PATH];</span>
<a href="#l2.100"></a><span id="l2.100" class="difflineminus">-        DWORD  dwType = 0;</span>
<a href="#l2.101"></a><span id="l2.101" class="difflineminus">-        ULONG  cbData = sizeof(szWABDllPath);</span>
<a href="#l2.102"></a><span id="l2.102" class="difflineminus">-        HKEY hKey = NULL;</span>
<a href="#l2.103"></a><span id="l2.103" class="difflineminus">-</span>
<a href="#l2.104"></a><span id="l2.104" class="difflineminus">-        *szWABDllPath = '\0';</span>
<a href="#l2.105"></a><span id="l2.105" class="difflineminus">-</span>
<a href="#l2.106"></a><span id="l2.106" class="difflineminus">-        // First we look under the default WAB DLL path location in the</span>
<a href="#l2.107"></a><span id="l2.107" class="difflineminus">-        // Registry.</span>
<a href="#l2.108"></a><span id="l2.108" class="difflineminus">-        // WAB_DLL_PATH_KEY is defined in wabapi.h</span>
<a href="#l2.109"></a><span id="l2.109" class="difflineminus">-        //</span>
<a href="#l2.110"></a><span id="l2.110" class="difflineminus">-        if (ERROR_SUCCESS == RegOpenKeyEx(HKEY_LOCAL_MACHINE, WAB_DLL_PATH_KEY, 0, KEY_READ, &amp;hKey)) {</span>
<a href="#l2.111"></a><span id="l2.111" class="difflineminus">-            RegQueryValueEx(hKey, &quot;&quot;, NULL, &amp;dwType, (LPBYTE) szWABDllPath, &amp;cbData);</span>
<a href="#l2.112"></a><span id="l2.112" class="difflineminus">-            if (dwType == REG_EXPAND_SZ) {</span>
<a href="#l2.113"></a><span id="l2.113" class="difflineminus">-                // Expand the environment variables</span>
<a href="#l2.114"></a><span id="l2.114" class="difflineminus">-                DWORD bufferSize = ExpandEnvironmentStrings(szWABDllPath, NULL, 0);</span>
<a href="#l2.115"></a><span id="l2.115" class="difflineminus">-                if (bufferSize &amp;&amp; bufferSize &lt; MAX_PATH) {</span>
<a href="#l2.116"></a><span id="l2.116" class="difflineminus">-                    TCHAR tmp[MAX_PATH];</span>
<a href="#l2.117"></a><span id="l2.117" class="difflineminus">-                    ExpandEnvironmentStrings(szWABDllPath, tmp, bufferSize);</span>
<a href="#l2.118"></a><span id="l2.118" class="difflineminus">-                    _tcscpy(szWABDllPath, tmp);</span>
<a href="#l2.119"></a><span id="l2.119" class="difflineminus">-                }</span>
<a href="#l2.120"></a><span id="l2.120" class="difflineminus">-                else {</span>
<a href="#l2.121"></a><span id="l2.121" class="difflineminus">-                    // This is an error condition. Nothing else is initialized yet, so simply return.</span>
<a href="#l2.122"></a><span id="l2.122" class="difflineminus">-                    return;</span>
<a href="#l2.123"></a><span id="l2.123" class="difflineminus">-                }</span>
<a href="#l2.124"></a><span id="l2.124" class="difflineminus">-</span>
<a href="#l2.125"></a><span id="l2.125" class="difflineminus">-            }</span>
<a href="#l2.126"></a><span id="l2.126" class="difflineminus">-        }</span>
<a href="#l2.127"></a><span id="l2.127" class="difflineminus">-        else {</span>
<a href="#l2.128"></a><span id="l2.128" class="difflineminus">-            if (GetSystemDirectory(szWABDllPath, MAX_PATH)) {</span>
<a href="#l2.129"></a><span id="l2.129" class="difflineminus">-                _tcsncat(szWABDllPath, WAB_DLL_NAME,</span>
<a href="#l2.130"></a><span id="l2.130" class="difflineminus">-                         std::min(_tcslen(WAB_DLL_NAME), MAX_PATH - _tcslen(szWABDllPath) - 1));</span>
<a href="#l2.131"></a><span id="l2.131" class="difflineminus">-            }</span>
<a href="#l2.132"></a><span id="l2.132" class="difflineminus">-            else {</span>
<a href="#l2.133"></a><span id="l2.133" class="difflineminus">-                // Yet another error condition.</span>
<a href="#l2.134"></a><span id="l2.134" class="difflineminus">-                return;</span>
<a href="#l2.135"></a><span id="l2.135" class="difflineminus">-            }</span>
<a href="#l2.136"></a><span id="l2.136" class="difflineminus">-        }</span>
<a href="#l2.137"></a><span id="l2.137" class="difflineminus">-</span>
<a href="#l2.138"></a><span id="l2.138" class="difflineminus">-        if(hKey) RegCloseKey(hKey);</span>
<a href="#l2.139"></a><span id="l2.139" class="difflineminus">-</span>
<a href="#l2.140"></a><span id="l2.140" class="difflineminus">-        // if the Registry came up blank, we do a loadlibrary on the wab32.dll</span>
<a href="#l2.141"></a><span id="l2.141" class="difflineminus">-        // WAB_DLL_NAME is defined in wabapi.h</span>
<a href="#l2.142"></a><span id="l2.142" class="difflineminus">-        //</span>
<a href="#l2.143"></a><span id="l2.143" class="difflineminus">-        m_hinstWAB = LoadLibrary((lstrlen(szWABDllPath)) ? szWABDllPath : WAB_DLL_NAME);</span>
<a href="#l2.144"></a><span id="l2.144" class="difflineminus">-    }</span>
<a href="#l2.145"></a><span id="l2.145" class="difflineminus">-</span>
<a href="#l2.146"></a><span id="l2.146" class="difflineminus">-    if(m_hinstWAB)</span>
<a href="#l2.147"></a><span id="l2.147" class="difflineminus">-    {</span>
<a href="#l2.148"></a><span id="l2.148" class="difflineminus">-        // if we loaded the dll, get the entry point</span>
<a href="#l2.149"></a><span id="l2.149" class="difflineminus">-        //</span>
<a href="#l2.150"></a><span id="l2.150" class="difflineminus">-        m_lpfnWABOpen = (LPWABOPEN) GetProcAddress(m_hinstWAB, &quot;WABOpen&quot;);</span>
<a href="#l2.151"></a><span id="l2.151" class="difflineminus">-</span>
<a href="#l2.152"></a><span id="l2.152" class="difflineminus">-        if(m_lpfnWABOpen)</span>
<a href="#l2.153"></a><span id="l2.153" class="difflineminus">-        {</span>
<a href="#l2.154"></a><span id="l2.154" class="difflineminus">-          char    fName[2] = {0, 0};</span>
<a href="#l2.155"></a><span id="l2.155" class="difflineminus">-            HRESULT hr = E_FAIL;</span>
<a href="#l2.156"></a><span id="l2.156" class="difflineminus">-            WAB_PARAM wp = {0};</span>
<a href="#l2.157"></a><span id="l2.157" class="difflineminus">-            wp.cbSize = sizeof(WAB_PARAM);</span>
<a href="#l2.158"></a><span id="l2.158" class="difflineminus">-            if (file != nullptr) {</span>
<a href="#l2.159"></a><span id="l2.159" class="difflineminus">-                nsCString path;</span>
<a href="#l2.160"></a><span id="l2.160" class="difflineminus">-              file-&gt;GetNativePath(path);</span>
<a href="#l2.161"></a><span id="l2.161" class="difflineminus">-              wp.szFileName = (LPTSTR) ToNewCString(path);</span>
<a href="#l2.162"></a><span id="l2.162" class="difflineminus">-            }</span>
<a href="#l2.163"></a><span id="l2.163" class="difflineminus">-            else</span>
<a href="#l2.164"></a><span id="l2.164" class="difflineminus">-              wp.szFileName = (LPTSTR) fName;</span>
<a href="#l2.165"></a><span id="l2.165" class="difflineminus">-</span>
<a href="#l2.166"></a><span id="l2.166" class="difflineminus">-            // if we choose not to pass in a WAB_PARAM object,</span>
<a href="#l2.167"></a><span id="l2.167" class="difflineminus">-            // the default WAB file will be opened up</span>
<a href="#l2.168"></a><span id="l2.168" class="difflineminus">-            //</span>
<a href="#l2.169"></a><span id="l2.169" class="difflineminus">-            hr = m_lpfnWABOpen(&amp;m_lpAdrBook,&amp;m_lpWABObject,&amp;wp,0);</span>
<a href="#l2.170"></a><span id="l2.170" class="difflineminus">-</span>
<a href="#l2.171"></a><span id="l2.171" class="difflineminus">-            if(!hr)</span>
<a href="#l2.172"></a><span id="l2.172" class="difflineminus">-                m_bInitialized = TRUE;</span>
<a href="#l2.173"></a><span id="l2.173" class="difflineminus">-</span>
<a href="#l2.174"></a><span id="l2.174" class="difflineminus">-        }</span>
<a href="#l2.175"></a><span id="l2.175" class="difflineminus">-    }</span>
<a href="#l2.176"></a><span id="l2.176" class="difflineminus">-</span>
<a href="#l2.177"></a><span id="l2.177" class="difflineminus">-}</span>
<a href="#l2.178"></a><span id="l2.178" class="difflineminus">-</span>
<a href="#l2.179"></a><span id="l2.179" class="difflineminus">-</span>
<a href="#l2.180"></a><span id="l2.180" class="difflineminus">-// Destructor</span>
<a href="#l2.181"></a><span id="l2.181" class="difflineminus">-//</span>
<a href="#l2.182"></a><span id="l2.182" class="difflineminus">-CWAB::~CWAB()</span>
<a href="#l2.183"></a><span id="l2.183" class="difflineminus">-{</span>
<a href="#l2.184"></a><span id="l2.184" class="difflineminus">-  if (m_pUniBuff)</span>
<a href="#l2.185"></a><span id="l2.185" class="difflineminus">-    delete [] m_pUniBuff;</span>
<a href="#l2.186"></a><span id="l2.186" class="difflineminus">-</span>
<a href="#l2.187"></a><span id="l2.187" class="difflineminus">-    if(m_bInitialized)</span>
<a href="#l2.188"></a><span id="l2.188" class="difflineminus">-    {</span>
<a href="#l2.189"></a><span id="l2.189" class="difflineminus">-        if(m_lpAdrBook)</span>
<a href="#l2.190"></a><span id="l2.190" class="difflineminus">-            m_lpAdrBook-&gt;Release();</span>
<a href="#l2.191"></a><span id="l2.191" class="difflineminus">-</span>
<a href="#l2.192"></a><span id="l2.192" class="difflineminus">-        if(m_lpWABObject)</span>
<a href="#l2.193"></a><span id="l2.193" class="difflineminus">-            m_lpWABObject-&gt;Release();</span>
<a href="#l2.194"></a><span id="l2.194" class="difflineminus">-</span>
<a href="#l2.195"></a><span id="l2.195" class="difflineminus">-        if(m_hinstWAB)</span>
<a href="#l2.196"></a><span id="l2.196" class="difflineminus">-            FreeLibrary(m_hinstWAB);</span>
<a href="#l2.197"></a><span id="l2.197" class="difflineminus">-    }</span>
<a href="#l2.198"></a><span id="l2.198" class="difflineminus">-}</span>
<a href="#l2.199"></a><span id="l2.199" class="difflineminus">-</span>
<a href="#l2.200"></a><span id="l2.200" class="difflineminus">-</span>
<a href="#l2.201"></a><span id="l2.201" class="difflineminus">-HRESULT CWAB::IterateWABContents(CWabIterator *pIter, int *pDone)</span>
<a href="#l2.202"></a><span id="l2.202" class="difflineminus">-{</span>
<a href="#l2.203"></a><span id="l2.203" class="difflineminus">-  if (!m_bInitialized || !m_lpAdrBook)</span>
<a href="#l2.204"></a><span id="l2.204" class="difflineminus">-    return E_FAIL;</span>
<a href="#l2.205"></a><span id="l2.205" class="difflineminus">-</span>
<a href="#l2.206"></a><span id="l2.206" class="difflineminus">-  ULONG      ulObjType =   0;</span>
<a href="#l2.207"></a><span id="l2.207" class="difflineminus">-  LPMAPITABLE    lpAB =  NULL;</span>
<a href="#l2.208"></a><span id="l2.208" class="difflineminus">-  ULONG      cRows =       0;</span>
<a href="#l2.209"></a><span id="l2.209" class="difflineminus">-  LPSRowSet    lpRowAB = NULL;</span>
<a href="#l2.210"></a><span id="l2.210" class="difflineminus">-  LPABCONT    lpContainer = NULL;</span>
<a href="#l2.211"></a><span id="l2.211" class="difflineminus">-  int        cNumRows = 0;</span>
<a href="#l2.212"></a><span id="l2.212" class="difflineminus">-  nsresult      keepGoing;</span>
<a href="#l2.213"></a><span id="l2.213" class="difflineminus">-</span>
<a href="#l2.214"></a><span id="l2.214" class="difflineminus">-  HRESULT      hr = E_FAIL;</span>
<a href="#l2.215"></a><span id="l2.215" class="difflineminus">-</span>
<a href="#l2.216"></a><span id="l2.216" class="difflineminus">-  ULONG      lpcbEID = 0;</span>
<a href="#l2.217"></a><span id="l2.217" class="difflineminus">-  LPENTRYID    lpEID = NULL;</span>
<a href="#l2.218"></a><span id="l2.218" class="difflineminus">-  ULONG      rowCount = 0;</span>
<a href="#l2.219"></a><span id="l2.219" class="difflineminus">-  ULONG      curCount = 0;</span>
<a href="#l2.220"></a><span id="l2.220" class="difflineminus">-</span>
<a href="#l2.221"></a><span id="l2.221" class="difflineminus">-  nsString    uniStr;</span>
<a href="#l2.222"></a><span id="l2.222" class="difflineminus">-</span>
<a href="#l2.223"></a><span id="l2.223" class="difflineminus">-  // Get the entryid of the root PAB container</span>
<a href="#l2.224"></a><span id="l2.224" class="difflineminus">-  //</span>
<a href="#l2.225"></a><span id="l2.225" class="difflineminus">-  hr = m_lpAdrBook-&gt;GetPAB(&amp;lpcbEID, &amp;lpEID);</span>
<a href="#l2.226"></a><span id="l2.226" class="difflineminus">-</span>
<a href="#l2.227"></a><span id="l2.227" class="difflineminus">-  if (HR_FAILED(hr))</span>
<a href="#l2.228"></a><span id="l2.228" class="difflineminus">-    goto exit;</span>
<a href="#l2.229"></a><span id="l2.229" class="difflineminus">-</span>
<a href="#l2.230"></a><span id="l2.230" class="difflineminus">-  ulObjType = 0;</span>
<a href="#l2.231"></a><span id="l2.231" class="difflineminus">-</span>
<a href="#l2.232"></a><span id="l2.232" class="difflineminus">-  // Open the root PAB container</span>
<a href="#l2.233"></a><span id="l2.233" class="difflineminus">-  // This is where all the WAB contents reside</span>
<a href="#l2.234"></a><span id="l2.234" class="difflineminus">-  //</span>
<a href="#l2.235"></a><span id="l2.235" class="difflineminus">-  hr = m_lpAdrBook-&gt;OpenEntry(lpcbEID,</span>
<a href="#l2.236"></a><span id="l2.236" class="difflineminus">-    (LPENTRYID)lpEID,</span>
<a href="#l2.237"></a><span id="l2.237" class="difflineminus">-    NULL,</span>
<a href="#l2.238"></a><span id="l2.238" class="difflineminus">-    0,</span>
<a href="#l2.239"></a><span id="l2.239" class="difflineminus">-    &amp;ulObjType,</span>
<a href="#l2.240"></a><span id="l2.240" class="difflineminus">-    (LPUNKNOWN *)&amp;lpContainer);</span>
<a href="#l2.241"></a><span id="l2.241" class="difflineminus">-</span>
<a href="#l2.242"></a><span id="l2.242" class="difflineminus">-  m_lpWABObject-&gt;FreeBuffer(lpEID);</span>
<a href="#l2.243"></a><span id="l2.243" class="difflineminus">-</span>
<a href="#l2.244"></a><span id="l2.244" class="difflineminus">-  lpEID = NULL;</span>
<a href="#l2.245"></a><span id="l2.245" class="difflineminus">-</span>
<a href="#l2.246"></a><span id="l2.246" class="difflineminus">-  if(HR_FAILED(hr))</span>
<a href="#l2.247"></a><span id="l2.247" class="difflineminus">-    goto exit;</span>
<a href="#l2.248"></a><span id="l2.248" class="difflineminus">-</span>
<a href="#l2.249"></a><span id="l2.249" class="difflineminus">-  // Get a contents table of all the contents in the</span>
<a href="#l2.250"></a><span id="l2.250" class="difflineminus">-  // WABs root container</span>
<a href="#l2.251"></a><span id="l2.251" class="difflineminus">-  //</span>
<a href="#l2.252"></a><span id="l2.252" class="difflineminus">-  hr = lpContainer-&gt;GetContentsTable(0, &amp;lpAB);</span>
<a href="#l2.253"></a><span id="l2.253" class="difflineminus">-</span>
<a href="#l2.254"></a><span id="l2.254" class="difflineminus">-  if(HR_FAILED(hr))</span>
<a href="#l2.255"></a><span id="l2.255" class="difflineminus">-    goto exit;</span>
<a href="#l2.256"></a><span id="l2.256" class="difflineminus">-</span>
<a href="#l2.257"></a><span id="l2.257" class="difflineminus">-  hr = lpAB-&gt;GetRowCount(0, &amp;rowCount);</span>
<a href="#l2.258"></a><span id="l2.258" class="difflineminus">-  if (HR_FAILED(hr))</span>
<a href="#l2.259"></a><span id="l2.259" class="difflineminus">-    rowCount = 100;</span>
<a href="#l2.260"></a><span id="l2.260" class="difflineminus">-  if (rowCount == 0)</span>
<a href="#l2.261"></a><span id="l2.261" class="difflineminus">-    rowCount = 1;</span>
<a href="#l2.262"></a><span id="l2.262" class="difflineminus">-</span>
<a href="#l2.263"></a><span id="l2.263" class="difflineminus">-  // Order the columns in the ContentsTable to conform to the</span>
<a href="#l2.264"></a><span id="l2.264" class="difflineminus">-  // ones we want - which are mainly DisplayName, EntryID and</span>
<a href="#l2.265"></a><span id="l2.265" class="difflineminus">-  // ObjectType</span>
<a href="#l2.266"></a><span id="l2.266" class="difflineminus">-  // The table is gauranteed to set the columns in the order</span>
<a href="#l2.267"></a><span id="l2.267" class="difflineminus">-  // requested</span>
<a href="#l2.268"></a><span id="l2.268" class="difflineminus">-  //</span>
<a href="#l2.269"></a><span id="l2.269" class="difflineminus">-  hr =lpAB-&gt;SetColumns((LPSPropTagArray)&amp;ptaEid, 0);</span>
<a href="#l2.270"></a><span id="l2.270" class="difflineminus">-</span>
<a href="#l2.271"></a><span id="l2.271" class="difflineminus">-  if(HR_FAILED(hr))</span>
<a href="#l2.272"></a><span id="l2.272" class="difflineminus">-    goto exit;</span>
<a href="#l2.273"></a><span id="l2.273" class="difflineminus">-</span>
<a href="#l2.274"></a><span id="l2.274" class="difflineminus">-</span>
<a href="#l2.275"></a><span id="l2.275" class="difflineminus">-  // Reset to the beginning of the table</span>
<a href="#l2.276"></a><span id="l2.276" class="difflineminus">-  //</span>
<a href="#l2.277"></a><span id="l2.277" class="difflineminus">-  hr = lpAB-&gt;SeekRow(BOOKMARK_BEGINNING, 0, NULL);</span>
<a href="#l2.278"></a><span id="l2.278" class="difflineminus">-</span>
<a href="#l2.279"></a><span id="l2.279" class="difflineminus">-  if(HR_FAILED(hr))</span>
<a href="#l2.280"></a><span id="l2.280" class="difflineminus">-    goto exit;</span>
<a href="#l2.281"></a><span id="l2.281" class="difflineminus">-</span>
<a href="#l2.282"></a><span id="l2.282" class="difflineminus">-  // Read all the rows of the table one by one</span>
<a href="#l2.283"></a><span id="l2.283" class="difflineminus">-  //</span>
<a href="#l2.284"></a><span id="l2.284" class="difflineminus">-</span>
<a href="#l2.285"></a><span id="l2.285" class="difflineminus">-  do {</span>
<a href="#l2.286"></a><span id="l2.286" class="difflineminus">-</span>
<a href="#l2.287"></a><span id="l2.287" class="difflineminus">-    hr = lpAB-&gt;QueryRows(1,  0, &amp;lpRowAB);</span>
<a href="#l2.288"></a><span id="l2.288" class="difflineminus">-</span>
<a href="#l2.289"></a><span id="l2.289" class="difflineminus">-    if(HR_FAILED(hr))</span>
<a href="#l2.290"></a><span id="l2.290" class="difflineminus">-      break;</span>
<a href="#l2.291"></a><span id="l2.291" class="difflineminus">-</span>
<a href="#l2.292"></a><span id="l2.292" class="difflineminus">-    if(lpRowAB)</span>
<a href="#l2.293"></a><span id="l2.293" class="difflineminus">-    {</span>
<a href="#l2.294"></a><span id="l2.294" class="difflineminus">-      cNumRows = lpRowAB-&gt;cRows;</span>
<a href="#l2.295"></a><span id="l2.295" class="difflineminus">-</span>
<a href="#l2.296"></a><span id="l2.296" class="difflineminus">-      if (cNumRows)</span>
<a href="#l2.297"></a><span id="l2.297" class="difflineminus">-      {</span>
<a href="#l2.298"></a><span id="l2.298" class="difflineminus">-        LPTSTR lpsz = lpRowAB-&gt;aRow[0].lpProps[ieidPR_DISPLAY_NAME].Value.lpszA;</span>
<a href="#l2.299"></a><span id="l2.299" class="difflineminus">-        LPENTRYID lpEID = (LPENTRYID) lpRowAB-&gt;aRow[0].lpProps[ieidPR_ENTRYID].Value.bin.lpb;</span>
<a href="#l2.300"></a><span id="l2.300" class="difflineminus">-        ULONG cbEID = lpRowAB-&gt;aRow[0].lpProps[ieidPR_ENTRYID].Value.bin.cb;</span>
<a href="#l2.301"></a><span id="l2.301" class="difflineminus">-</span>
<a href="#l2.302"></a><span id="l2.302" class="difflineminus">-        // There are 2 kinds of objects - the MAPI_MAILUSER contact object</span>
<a href="#l2.303"></a><span id="l2.303" class="difflineminus">-        // and the MAPI_DISTLIST contact object</span>
<a href="#l2.304"></a><span id="l2.304" class="difflineminus">-        // For the purposes of this sample, we will only consider MAILUSER</span>
<a href="#l2.305"></a><span id="l2.305" class="difflineminus">-        // objects</span>
<a href="#l2.306"></a><span id="l2.306" class="difflineminus">-        //</span>
<a href="#l2.307"></a><span id="l2.307" class="difflineminus">-        if(lpRowAB-&gt;aRow[0].lpProps[ieidPR_OBJECT_TYPE].Value.l == MAPI_MAILUSER)</span>
<a href="#l2.308"></a><span id="l2.308" class="difflineminus">-        {</span>
<a href="#l2.309"></a><span id="l2.309" class="difflineminus">-          // We will now take the entry-id of each object and cache it</span>
<a href="#l2.310"></a><span id="l2.310" class="difflineminus">-          // on the listview item representing that object. This enables</span>
<a href="#l2.311"></a><span id="l2.311" class="difflineminus">-          // us to uniquely identify the object later if we need to</span>
<a href="#l2.312"></a><span id="l2.312" class="difflineminus">-          //</span>
<a href="#l2.313"></a><span id="l2.313" class="difflineminus">-          CStrToUnicode(lpsz, uniStr);</span>
<a href="#l2.314"></a><span id="l2.314" class="difflineminus">-          keepGoing = pIter-&gt;EnumUser(uniStr.get(), lpEID, cbEID);</span>
<a href="#l2.315"></a><span id="l2.315" class="difflineminus">-          curCount++;</span>
<a href="#l2.316"></a><span id="l2.316" class="difflineminus">-          if (pDone) {</span>
<a href="#l2.317"></a><span id="l2.317" class="difflineminus">-            *pDone = (curCount * 100) / rowCount;</span>
<a href="#l2.318"></a><span id="l2.318" class="difflineminus">-            if (*pDone &gt; 100)</span>
<a href="#l2.319"></a><span id="l2.319" class="difflineminus">-              *pDone = 100;</span>
<a href="#l2.320"></a><span id="l2.320" class="difflineminus">-          }</span>
<a href="#l2.321"></a><span id="l2.321" class="difflineminus">-        }</span>
<a href="#l2.322"></a><span id="l2.322" class="difflineminus">-      }</span>
<a href="#l2.323"></a><span id="l2.323" class="difflineminus">-      FreeProws(lpRowAB);</span>
<a href="#l2.324"></a><span id="l2.324" class="difflineminus">-    }</span>
<a href="#l2.325"></a><span id="l2.325" class="difflineminus">-</span>
<a href="#l2.326"></a><span id="l2.326" class="difflineminus">-</span>
<a href="#l2.327"></a><span id="l2.327" class="difflineminus">-  } while (SUCCEEDED(hr) &amp;&amp; cNumRows &amp;&amp; lpRowAB &amp;&amp; NS_SUCCEEDED(keepGoing))  ;</span>
<a href="#l2.328"></a><span id="l2.328" class="difflineminus">-</span>
<a href="#l2.329"></a><span id="l2.329" class="difflineminus">-  hr = lpAB-&gt;SeekRow(BOOKMARK_BEGINNING, 0, NULL);</span>
<a href="#l2.330"></a><span id="l2.330" class="difflineminus">-</span>
<a href="#l2.331"></a><span id="l2.331" class="difflineminus">-  if(HR_FAILED(hr))</span>
<a href="#l2.332"></a><span id="l2.332" class="difflineminus">-    goto exit;</span>
<a href="#l2.333"></a><span id="l2.333" class="difflineminus">-</span>
<a href="#l2.334"></a><span id="l2.334" class="difflineminus">-  // Read all the rows of the table one by one</span>
<a href="#l2.335"></a><span id="l2.335" class="difflineminus">-  //</span>
<a href="#l2.336"></a><span id="l2.336" class="difflineminus">-  keepGoing = NS_OK;</span>
<a href="#l2.337"></a><span id="l2.337" class="difflineminus">-  do {</span>
<a href="#l2.338"></a><span id="l2.338" class="difflineminus">-</span>
<a href="#l2.339"></a><span id="l2.339" class="difflineminus">-    hr = lpAB-&gt;QueryRows(1,  0, &amp;lpRowAB);</span>
<a href="#l2.340"></a><span id="l2.340" class="difflineminus">-</span>
<a href="#l2.341"></a><span id="l2.341" class="difflineminus">-    if(HR_FAILED(hr))</span>
<a href="#l2.342"></a><span id="l2.342" class="difflineminus">-      break;</span>
<a href="#l2.343"></a><span id="l2.343" class="difflineminus">-</span>
<a href="#l2.344"></a><span id="l2.344" class="difflineminus">-    if(lpRowAB)</span>
<a href="#l2.345"></a><span id="l2.345" class="difflineminus">-    {</span>
<a href="#l2.346"></a><span id="l2.346" class="difflineminus">-      cNumRows = lpRowAB-&gt;cRows;</span>
<a href="#l2.347"></a><span id="l2.347" class="difflineminus">-</span>
<a href="#l2.348"></a><span id="l2.348" class="difflineminus">-      if (cNumRows)</span>
<a href="#l2.349"></a><span id="l2.349" class="difflineminus">-      {</span>
<a href="#l2.350"></a><span id="l2.350" class="difflineminus">-        LPTSTR lpsz = lpRowAB-&gt;aRow[0].lpProps[ieidPR_DISPLAY_NAME].Value.lpszA;</span>
<a href="#l2.351"></a><span id="l2.351" class="difflineminus">-        LPENTRYID lpEID = (LPENTRYID) lpRowAB-&gt;aRow[0].lpProps[ieidPR_ENTRYID].Value.bin.lpb;</span>
<a href="#l2.352"></a><span id="l2.352" class="difflineminus">-        ULONG cbEID = lpRowAB-&gt;aRow[0].lpProps[ieidPR_ENTRYID].Value.bin.cb;</span>
<a href="#l2.353"></a><span id="l2.353" class="difflineminus">-</span>
<a href="#l2.354"></a><span id="l2.354" class="difflineminus">-        // There are 2 kinds of objects - the MAPI_MAILUSER contact object</span>
<a href="#l2.355"></a><span id="l2.355" class="difflineminus">-        // and the MAPI_DISTLIST contact object</span>
<a href="#l2.356"></a><span id="l2.356" class="difflineminus">-        // For the purposes of this sample, we will only consider MAILUSER</span>
<a href="#l2.357"></a><span id="l2.357" class="difflineminus">-        // objects</span>
<a href="#l2.358"></a><span id="l2.358" class="difflineminus">-        //</span>
<a href="#l2.359"></a><span id="l2.359" class="difflineminus">-        if(lpRowAB-&gt;aRow[0].lpProps[ieidPR_OBJECT_TYPE].Value.l == MAPI_DISTLIST)</span>
<a href="#l2.360"></a><span id="l2.360" class="difflineminus">-        {</span>
<a href="#l2.361"></a><span id="l2.361" class="difflineminus">-          LPABCONT distListContainer = NULL;</span>
<a href="#l2.362"></a><span id="l2.362" class="difflineminus">-          // We will now take the entry-id of each object and cache it</span>
<a href="#l2.363"></a><span id="l2.363" class="difflineminus">-          // on the listview item representing that object. This enables</span>
<a href="#l2.364"></a><span id="l2.364" class="difflineminus">-          // us to uniquely identify the object later if we need to</span>
<a href="#l2.365"></a><span id="l2.365" class="difflineminus">-          //</span>
<a href="#l2.366"></a><span id="l2.366" class="difflineminus">-          hr = m_lpAdrBook-&gt;OpenEntry(cbEID, lpEID, NULL,</span>
<a href="#l2.367"></a><span id="l2.367" class="difflineminus">-            0,&amp;ulObjType,(LPUNKNOWN *)&amp;distListContainer);</span>
<a href="#l2.368"></a><span id="l2.368" class="difflineminus">-</span>
<a href="#l2.369"></a><span id="l2.369" class="difflineminus">-          LPMAPITABLE    distListTable =  NULL;</span>
<a href="#l2.370"></a><span id="l2.370" class="difflineminus">-</span>
<a href="#l2.371"></a><span id="l2.371" class="difflineminus">-</span>
<a href="#l2.372"></a><span id="l2.372" class="difflineminus">-          // Get a contents table of the dist list</span>
<a href="#l2.373"></a><span id="l2.373" class="difflineminus">-          //</span>
<a href="#l2.374"></a><span id="l2.374" class="difflineminus">-          hr = distListContainer-&gt;GetContentsTable(0, &amp;distListTable);</span>
<a href="#l2.375"></a><span id="l2.375" class="difflineminus">-          if (lpAB)</span>
<a href="#l2.376"></a><span id="l2.376" class="difflineminus">-          {</span>
<a href="#l2.377"></a><span id="l2.377" class="difflineminus">-            hr = distListTable-&gt;GetRowCount(0, &amp;rowCount);</span>
<a href="#l2.378"></a><span id="l2.378" class="difflineminus">-            if (HR_FAILED(hr))</span>
<a href="#l2.379"></a><span id="l2.379" class="difflineminus">-              rowCount = 100;</span>
<a href="#l2.380"></a><span id="l2.380" class="difflineminus">-            if (rowCount == 0)</span>
<a href="#l2.381"></a><span id="l2.381" class="difflineminus">-              rowCount = 1;</span>
<a href="#l2.382"></a><span id="l2.382" class="difflineminus">-</span>
<a href="#l2.383"></a><span id="l2.383" class="difflineminus">-            // Order the columns in the ContentsTable to conform to the</span>
<a href="#l2.384"></a><span id="l2.384" class="difflineminus">-            // ones we want - which are mainly DisplayName, EntryID and</span>
<a href="#l2.385"></a><span id="l2.385" class="difflineminus">-            // ObjectType</span>
<a href="#l2.386"></a><span id="l2.386" class="difflineminus">-            // The table is gauranteed to set the columns in the order</span>
<a href="#l2.387"></a><span id="l2.387" class="difflineminus">-            // requested</span>
<a href="#l2.388"></a><span id="l2.388" class="difflineminus">-            //</span>
<a href="#l2.389"></a><span id="l2.389" class="difflineminus">-            hr = distListTable-&gt;SetColumns((LPSPropTagArray)&amp;ptaEid, 0);</span>
<a href="#l2.390"></a><span id="l2.390" class="difflineminus">-            CStrToUnicode(lpsz, uniStr);</span>
<a href="#l2.391"></a><span id="l2.391" class="difflineminus">-            keepGoing = pIter-&gt;EnumList(uniStr.get(), lpEID, cbEID, distListTable);</span>
<a href="#l2.392"></a><span id="l2.392" class="difflineminus">-            curCount++;</span>
<a href="#l2.393"></a><span id="l2.393" class="difflineminus">-            if (pDone) {</span>
<a href="#l2.394"></a><span id="l2.394" class="difflineminus">-              *pDone = (curCount * 100) / rowCount;</span>
<a href="#l2.395"></a><span id="l2.395" class="difflineminus">-              if (*pDone &gt; 100)</span>
<a href="#l2.396"></a><span id="l2.396" class="difflineminus">-                *pDone = 100;</span>
<a href="#l2.397"></a><span id="l2.397" class="difflineminus">-            }</span>
<a href="#l2.398"></a><span id="l2.398" class="difflineminus">-          }</span>
<a href="#l2.399"></a><span id="l2.399" class="difflineminus">-          if (distListContainer)</span>
<a href="#l2.400"></a><span id="l2.400" class="difflineminus">-            distListContainer-&gt;Release();</span>
<a href="#l2.401"></a><span id="l2.401" class="difflineminus">-          if (distListTable)</span>
<a href="#l2.402"></a><span id="l2.402" class="difflineminus">-            distListTable-&gt;Release();</span>
<a href="#l2.403"></a><span id="l2.403" class="difflineminus">-        }</span>
<a href="#l2.404"></a><span id="l2.404" class="difflineminus">-      }</span>
<a href="#l2.405"></a><span id="l2.405" class="difflineminus">-      FreeProws(lpRowAB);</span>
<a href="#l2.406"></a><span id="l2.406" class="difflineminus">-    }</span>
<a href="#l2.407"></a><span id="l2.407" class="difflineminus">-</span>
<a href="#l2.408"></a><span id="l2.408" class="difflineminus">-  } while (SUCCEEDED(hr) &amp;&amp; cNumRows &amp;&amp; lpRowAB &amp;&amp; NS_SUCCEEDED(keepGoing))  ;</span>
<a href="#l2.409"></a><span id="l2.409" class="difflineminus">-</span>
<a href="#l2.410"></a><span id="l2.410" class="difflineminus">-</span>
<a href="#l2.411"></a><span id="l2.411" class="difflineminus">-exit:</span>
<a href="#l2.412"></a><span id="l2.412" class="difflineminus">-</span>
<a href="#l2.413"></a><span id="l2.413" class="difflineminus">-  if (lpContainer)</span>
<a href="#l2.414"></a><span id="l2.414" class="difflineminus">-    lpContainer-&gt;Release();</span>
<a href="#l2.415"></a><span id="l2.415" class="difflineminus">-</span>
<a href="#l2.416"></a><span id="l2.416" class="difflineminus">-  if (lpAB)</span>
<a href="#l2.417"></a><span id="l2.417" class="difflineminus">-    lpAB-&gt;Release();</span>
<a href="#l2.418"></a><span id="l2.418" class="difflineminus">-</span>
<a href="#l2.419"></a><span id="l2.419" class="difflineminus">-  return hr;</span>
<a href="#l2.420"></a><span id="l2.420" class="difflineminus">-}</span>
<a href="#l2.421"></a><span id="l2.421" class="difflineminus">-</span>
<a href="#l2.422"></a><span id="l2.422" class="difflineminus">-</span>
<a href="#l2.423"></a><span id="l2.423" class="difflineminus">-</span>
<a href="#l2.424"></a><span id="l2.424" class="difflineminus">-</span>
<a href="#l2.425"></a><span id="l2.425" class="difflineminus">-</span>
<a href="#l2.426"></a><span id="l2.426" class="difflineminus">-</span>
<a href="#l2.427"></a><span id="l2.427" class="difflineminus">-void CWAB::FreeProws(LPSRowSet prows)</span>
<a href="#l2.428"></a><span id="l2.428" class="difflineminus">-{</span>
<a href="#l2.429"></a><span id="l2.429" class="difflineminus">-  ULONG    irow;</span>
<a href="#l2.430"></a><span id="l2.430" class="difflineminus">-  if (!prows)</span>
<a href="#l2.431"></a><span id="l2.431" class="difflineminus">-    return;</span>
<a href="#l2.432"></a><span id="l2.432" class="difflineminus">-  for (irow = 0; irow &lt; prows-&gt;cRows; ++irow)</span>
<a href="#l2.433"></a><span id="l2.433" class="difflineminus">-    m_lpWABObject-&gt;FreeBuffer(prows-&gt;aRow[irow].lpProps);</span>
<a href="#l2.434"></a><span id="l2.434" class="difflineminus">-  m_lpWABObject-&gt;FreeBuffer(prows);</span>
<a href="#l2.435"></a><span id="l2.435" class="difflineminus">-}</span>
<a href="#l2.436"></a><span id="l2.436" class="difflineminus">-</span>
<a href="#l2.437"></a><span id="l2.437" class="difflineminus">-</span>
<a href="#l2.438"></a><span id="l2.438" class="difflineminus">-LPDISTLIST CWAB::GetDistList(ULONG cbEid, LPENTRYID pEid)</span>
<a href="#l2.439"></a><span id="l2.439" class="difflineminus">-{</span>
<a href="#l2.440"></a><span id="l2.440" class="difflineminus">-  if (!m_bInitialized || !m_lpAdrBook)</span>
<a href="#l2.441"></a><span id="l2.441" class="difflineminus">-    return NULL;</span>
<a href="#l2.442"></a><span id="l2.442" class="difflineminus">-</span>
<a href="#l2.443"></a><span id="l2.443" class="difflineminus">-  LPDISTLIST  lpDistList = NULL;</span>
<a href="#l2.444"></a><span id="l2.444" class="difflineminus">-  ULONG    ulObjType;</span>
<a href="#l2.445"></a><span id="l2.445" class="difflineminus">-</span>
<a href="#l2.446"></a><span id="l2.446" class="difflineminus">-  m_lpAdrBook-&gt;OpenEntry(cbEid, pEid, NULL, 0, &amp;ulObjType, (LPUNKNOWN *)&amp;lpDistList);</span>
<a href="#l2.447"></a><span id="l2.447" class="difflineminus">-  return lpDistList;</span>
<a href="#l2.448"></a><span id="l2.448" class="difflineminus">-}</span>
<a href="#l2.449"></a><span id="l2.449" class="difflineminus">-</span>
<a href="#l2.450"></a><span id="l2.450" class="difflineminus">-LPSPropValue CWAB::GetListProperty(LPDISTLIST pUser, ULONG tag)</span>
<a href="#l2.451"></a><span id="l2.451" class="difflineminus">-{</span>
<a href="#l2.452"></a><span id="l2.452" class="difflineminus">-  if (!pUser)</span>
<a href="#l2.453"></a><span id="l2.453" class="difflineminus">-    return NULL;</span>
<a href="#l2.454"></a><span id="l2.454" class="difflineminus">-</span>
<a href="#l2.455"></a><span id="l2.455" class="difflineminus">-  int  sz = CbNewSPropTagArray(1);</span>
<a href="#l2.456"></a><span id="l2.456" class="difflineminus">-  SPropTagArray *pTag = (SPropTagArray *) new char[sz];</span>
<a href="#l2.457"></a><span id="l2.457" class="difflineminus">-  pTag-&gt;cValues = 1;</span>
<a href="#l2.458"></a><span id="l2.458" class="difflineminus">-  pTag-&gt;aulPropTag[0] = tag;</span>
<a href="#l2.459"></a><span id="l2.459" class="difflineminus">-  LPSPropValue  lpProp = NULL;</span>
<a href="#l2.460"></a><span id="l2.460" class="difflineminus">-  ULONG  cValues = 0;</span>
<a href="#l2.461"></a><span id="l2.461" class="difflineminus">-  HRESULT hr = pUser-&gt;GetProps(pTag, 0, &amp;cValues, &amp;lpProp);</span>
<a href="#l2.462"></a><span id="l2.462" class="difflineminus">-  delete [] pTag;</span>
<a href="#l2.463"></a><span id="l2.463" class="difflineminus">-  if (HR_FAILED(hr) || (cValues != 1)) {</span>
<a href="#l2.464"></a><span id="l2.464" class="difflineminus">-    if (lpProp)</span>
<a href="#l2.465"></a><span id="l2.465" class="difflineminus">-      m_lpWABObject-&gt;FreeBuffer(lpProp);</span>
<a href="#l2.466"></a><span id="l2.466" class="difflineminus">-    return NULL;</span>
<a href="#l2.467"></a><span id="l2.467" class="difflineminus">-  }</span>
<a href="#l2.468"></a><span id="l2.468" class="difflineminus">-  return lpProp;</span>
<a href="#l2.469"></a><span id="l2.469" class="difflineminus">-}</span>
<a href="#l2.470"></a><span id="l2.470" class="difflineminus">-</span>
<a href="#l2.471"></a><span id="l2.471" class="difflineminus">-LPMAILUSER CWAB::GetUser(ULONG cbEid, LPENTRYID pEid)</span>
<a href="#l2.472"></a><span id="l2.472" class="difflineminus">-{</span>
<a href="#l2.473"></a><span id="l2.473" class="difflineminus">-  if (!m_bInitialized || !m_lpAdrBook)</span>
<a href="#l2.474"></a><span id="l2.474" class="difflineminus">-    return NULL;</span>
<a href="#l2.475"></a><span id="l2.475" class="difflineminus">-</span>
<a href="#l2.476"></a><span id="l2.476" class="difflineminus">-  LPMAILUSER  lpMailUser = NULL;</span>
<a href="#l2.477"></a><span id="l2.477" class="difflineminus">-  ULONG    ulObjType;</span>
<a href="#l2.478"></a><span id="l2.478" class="difflineminus">-</span>
<a href="#l2.479"></a><span id="l2.479" class="difflineminus">-  m_lpAdrBook-&gt;OpenEntry(cbEid, pEid, NULL, 0, &amp;ulObjType, (LPUNKNOWN *)&amp;lpMailUser);</span>
<a href="#l2.480"></a><span id="l2.480" class="difflineminus">-  return lpMailUser;</span>
<a href="#l2.481"></a><span id="l2.481" class="difflineminus">-}</span>
<a href="#l2.482"></a><span id="l2.482" class="difflineminus">-</span>
<a href="#l2.483"></a><span id="l2.483" class="difflineminus">-LPSPropValue CWAB::GetUserProperty(LPMAILUSER pUser, ULONG tag)</span>
<a href="#l2.484"></a><span id="l2.484" class="difflineminus">-{</span>
<a href="#l2.485"></a><span id="l2.485" class="difflineminus">-  if (!pUser)</span>
<a href="#l2.486"></a><span id="l2.486" class="difflineminus">-    return NULL;</span>
<a href="#l2.487"></a><span id="l2.487" class="difflineminus">-</span>
<a href="#l2.488"></a><span id="l2.488" class="difflineminus">-  ULONG  uTag = tag;</span>
<a href="#l2.489"></a><span id="l2.489" class="difflineminus">-  /*</span>
<a href="#l2.490"></a><span id="l2.490" class="difflineminus">-    Getting Unicode does not help with getting the right</span>
<a href="#l2.491"></a><span id="l2.491" class="difflineminus">-    international charset.  Windoze bloze.</span>
<a href="#l2.492"></a><span id="l2.492" class="difflineminus">-  */</span>
<a href="#l2.493"></a><span id="l2.493" class="difflineminus">-  /*</span>
<a href="#l2.494"></a><span id="l2.494" class="difflineminus">-  if (PROP_TYPE(uTag) == PT_STRING8) {</span>
<a href="#l2.495"></a><span id="l2.495" class="difflineminus">-    uTag = CHANGE_PROP_TYPE(tag, PT_UNICODE);</span>
<a href="#l2.496"></a><span id="l2.496" class="difflineminus">-  }</span>
<a href="#l2.497"></a><span id="l2.497" class="difflineminus">-  */</span>
<a href="#l2.498"></a><span id="l2.498" class="difflineminus">-</span>
<a href="#l2.499"></a><span id="l2.499" class="difflineminus">-  int  sz = CbNewSPropTagArray(1);</span>
<a href="#l2.500"></a><span id="l2.500" class="difflineminus">-  SPropTagArray *pTag = (SPropTagArray *) new char[sz];</span>
<a href="#l2.501"></a><span id="l2.501" class="difflineminus">-  pTag-&gt;cValues = 1;</span>
<a href="#l2.502"></a><span id="l2.502" class="difflineminus">-  pTag-&gt;aulPropTag[0] = uTag;</span>
<a href="#l2.503"></a><span id="l2.503" class="difflineminus">-  LPSPropValue  lpProp = NULL;</span>
<a href="#l2.504"></a><span id="l2.504" class="difflineminus">-  ULONG  cValues = 0;</span>
<a href="#l2.505"></a><span id="l2.505" class="difflineminus">-  HRESULT hr = pUser-&gt;GetProps(pTag, 0, &amp;cValues, &amp;lpProp);</span>
<a href="#l2.506"></a><span id="l2.506" class="difflineminus">-  if (HR_FAILED(hr) || (cValues != 1)) {</span>
<a href="#l2.507"></a><span id="l2.507" class="difflineminus">-    if (lpProp)</span>
<a href="#l2.508"></a><span id="l2.508" class="difflineminus">-      m_lpWABObject-&gt;FreeBuffer(lpProp);</span>
<a href="#l2.509"></a><span id="l2.509" class="difflineminus">-    lpProp = NULL;</span>
<a href="#l2.510"></a><span id="l2.510" class="difflineminus">-    if (uTag != tag) {</span>
<a href="#l2.511"></a><span id="l2.511" class="difflineminus">-      pTag-&gt;cValues = 1;</span>
<a href="#l2.512"></a><span id="l2.512" class="difflineminus">-      pTag-&gt;aulPropTag[0] = tag;</span>
<a href="#l2.513"></a><span id="l2.513" class="difflineminus">-      cValues = 0;</span>
<a href="#l2.514"></a><span id="l2.514" class="difflineminus">-      hr = pUser-&gt;GetProps(pTag, 0, &amp;cValues, &amp;lpProp);</span>
<a href="#l2.515"></a><span id="l2.515" class="difflineminus">-      if (HR_FAILED(hr) || (cValues != 1)) {</span>
<a href="#l2.516"></a><span id="l2.516" class="difflineminus">-        if (lpProp)</span>
<a href="#l2.517"></a><span id="l2.517" class="difflineminus">-          m_lpWABObject-&gt;FreeBuffer(lpProp);</span>
<a href="#l2.518"></a><span id="l2.518" class="difflineminus">-        lpProp = NULL;</span>
<a href="#l2.519"></a><span id="l2.519" class="difflineminus">-      }</span>
<a href="#l2.520"></a><span id="l2.520" class="difflineminus">-    }</span>
<a href="#l2.521"></a><span id="l2.521" class="difflineminus">-  }</span>
<a href="#l2.522"></a><span id="l2.522" class="difflineminus">-  delete [] pTag;</span>
<a href="#l2.523"></a><span id="l2.523" class="difflineminus">-  return lpProp;</span>
<a href="#l2.524"></a><span id="l2.524" class="difflineminus">-}</span>
<a href="#l2.525"></a><span id="l2.525" class="difflineminus">-</span>
<a href="#l2.526"></a><span id="l2.526" class="difflineminus">-void CWAB::CStrToUnicode(const char *pStr, nsString&amp; result)</span>
<a href="#l2.527"></a><span id="l2.527" class="difflineminus">-{</span>
<a href="#l2.528"></a><span id="l2.528" class="difflineminus">-  result.Truncate();</span>
<a href="#l2.529"></a><span id="l2.529" class="difflineminus">-  int wLen = MultiByteToWideChar(CP_ACP, 0, pStr, -1, wwc(m_pUniBuff), 0);</span>
<a href="#l2.530"></a><span id="l2.530" class="difflineminus">-  if (wLen &gt;= m_uniBuffLen) {</span>
<a href="#l2.531"></a><span id="l2.531" class="difflineminus">-    if (m_pUniBuff)</span>
<a href="#l2.532"></a><span id="l2.532" class="difflineminus">-      delete [] m_pUniBuff;</span>
<a href="#l2.533"></a><span id="l2.533" class="difflineminus">-    m_pUniBuff = new char16_t[wLen + 64];</span>
<a href="#l2.534"></a><span id="l2.534" class="difflineminus">-    m_uniBuffLen = wLen + 64;</span>
<a href="#l2.535"></a><span id="l2.535" class="difflineminus">-  }</span>
<a href="#l2.536"></a><span id="l2.536" class="difflineminus">-  if (wLen) {</span>
<a href="#l2.537"></a><span id="l2.537" class="difflineminus">-    MultiByteToWideChar(CP_ACP, 0, pStr, -1, wwc(m_pUniBuff), m_uniBuffLen);</span>
<a href="#l2.538"></a><span id="l2.538" class="difflineminus">-    result = m_pUniBuff;</span>
<a href="#l2.539"></a><span id="l2.539" class="difflineminus">-  }</span>
<a href="#l2.540"></a><span id="l2.540" class="difflineminus">-}</span>
<a href="#l2.541"></a><span id="l2.541" class="difflineminus">-</span>
<a href="#l2.542"></a><span id="l2.542" class="difflineminus">-// If the value is a string, get it...</span>
<a href="#l2.543"></a><span id="l2.543" class="difflineminus">-void CWAB::GetValueString(LPSPropValue pVal, nsString&amp; val)</span>
<a href="#l2.544"></a><span id="l2.544" class="difflineminus">-{</span>
<a href="#l2.545"></a><span id="l2.545" class="difflineminus">-  val.Truncate();</span>
<a href="#l2.546"></a><span id="l2.546" class="difflineminus">-</span>
<a href="#l2.547"></a><span id="l2.547" class="difflineminus">-  if (!pVal)</span>
<a href="#l2.548"></a><span id="l2.548" class="difflineminus">-    return;</span>
<a href="#l2.549"></a><span id="l2.549" class="difflineminus">-</span>
<a href="#l2.550"></a><span id="l2.550" class="difflineminus">-  switch(PROP_TYPE(pVal-&gt;ulPropTag)) {</span>
<a href="#l2.551"></a><span id="l2.551" class="difflineminus">-    case PT_STRING8:</span>
<a href="#l2.552"></a><span id="l2.552" class="difflineminus">-      CStrToUnicode((const char *) (pVal-&gt;Value.lpszA), val);</span>
<a href="#l2.553"></a><span id="l2.553" class="difflineminus">-      break;</span>
<a href="#l2.554"></a><span id="l2.554" class="difflineminus">-    case PT_UNICODE:</span>
<a href="#l2.555"></a><span id="l2.555" class="difflineminus">-      val = (char16_t *) (pVal-&gt;Value.lpszW);</span>
<a href="#l2.556"></a><span id="l2.556" class="difflineminus">-      break;</span>
<a href="#l2.557"></a><span id="l2.557" class="difflineminus">-    case PT_MV_STRING8: {</span>
<a href="#l2.558"></a><span id="l2.558" class="difflineminus">-      nsString  tmp;</span>
<a href="#l2.559"></a><span id="l2.559" class="difflineminus">-      ULONG  j;</span>
<a href="#l2.560"></a><span id="l2.560" class="difflineminus">-      for(j = 0; j &lt; pVal-&gt;Value.MVszA.cValues; j++) {</span>
<a href="#l2.561"></a><span id="l2.561" class="difflineminus">-        CStrToUnicode((const char *) (pVal-&gt;Value.MVszA.lppszA[j]), tmp);</span>
<a href="#l2.562"></a><span id="l2.562" class="difflineminus">-        val += tmp;</span>
<a href="#l2.563"></a><span id="l2.563" class="difflineminus">-        val.Append(NS_ConvertASCIItoUTF16(TR_OUTPUT_EOL));</span>
<a href="#l2.564"></a><span id="l2.564" class="difflineminus">-      }</span>
<a href="#l2.565"></a><span id="l2.565" class="difflineminus">-      break;</span>
<a href="#l2.566"></a><span id="l2.566" class="difflineminus">-    }</span>
<a href="#l2.567"></a><span id="l2.567" class="difflineminus">-    case PT_MV_UNICODE: {</span>
<a href="#l2.568"></a><span id="l2.568" class="difflineminus">-      ULONG  j;</span>
<a href="#l2.569"></a><span id="l2.569" class="difflineminus">-      for(j = 0; j &lt; pVal-&gt;Value.MVszW.cValues; j++) {</span>
<a href="#l2.570"></a><span id="l2.570" class="difflineminus">-        val += (char16_t *) (pVal-&gt;Value.MVszW.lppszW[j]);</span>
<a href="#l2.571"></a><span id="l2.571" class="difflineminus">-        val.Append(NS_ConvertASCIItoUTF16(TR_OUTPUT_EOL));</span>
<a href="#l2.572"></a><span id="l2.572" class="difflineminus">-      }</span>
<a href="#l2.573"></a><span id="l2.573" class="difflineminus">-      break;</span>
<a href="#l2.574"></a><span id="l2.574" class="difflineminus">-    }</span>
<a href="#l2.575"></a><span id="l2.575" class="difflineminus">-    case PT_I2:</span>
<a href="#l2.576"></a><span id="l2.576" class="difflineminus">-    case PT_LONG:</span>
<a href="#l2.577"></a><span id="l2.577" class="difflineminus">-    case PT_R4:</span>
<a href="#l2.578"></a><span id="l2.578" class="difflineminus">-    case PT_DOUBLE:</span>
<a href="#l2.579"></a><span id="l2.579" class="difflineminus">-    case PT_BOOLEAN: {</span>
<a href="#l2.580"></a><span id="l2.580" class="difflineminus">-      /*</span>
<a href="#l2.581"></a><span id="l2.581" class="difflineminus">-      TCHAR sz[256];</span>
<a href="#l2.582"></a><span id="l2.582" class="difflineminus">-            wsprintf(sz,&quot;%d&quot;, pVal-&gt;Value.l);</span>
<a href="#l2.583"></a><span id="l2.583" class="difflineminus">-            val = sz;</span>
<a href="#l2.584"></a><span id="l2.584" class="difflineminus">-      */</span>
<a href="#l2.585"></a><span id="l2.585" class="difflineminus">-      break;</span>
<a href="#l2.586"></a><span id="l2.586" class="difflineminus">-    }</span>
<a href="#l2.587"></a><span id="l2.587" class="difflineminus">-</span>
<a href="#l2.588"></a><span id="l2.588" class="difflineminus">-    case PT_BINARY:</span>
<a href="#l2.589"></a><span id="l2.589" class="difflineminus">-      break;</span>
<a href="#l2.590"></a><span id="l2.590" class="difflineminus">-</span>
<a href="#l2.591"></a><span id="l2.591" class="difflineminus">-    default:</span>
<a href="#l2.592"></a><span id="l2.592" class="difflineminus">-      break;</span>
<a href="#l2.593"></a><span id="l2.593" class="difflineminus">-  }</span>
<a href="#l2.594"></a><span id="l2.594" class="difflineminus">-</span>
<a href="#l2.595"></a><span id="l2.595" class="difflineminus">-  val.Trim(kWhitespace, true, true);</span>
<a href="#l2.596"></a><span id="l2.596" class="difflineminus">-}</span>
<a href="#l2.597"></a><span id="l2.597" class="difflineminus">-</span>
<a href="#l2.598"></a><span id="l2.598" class="difflineminus">-</span>
<a href="#l2.599"></a><span id="l2.599" class="difflineminus">-void CWAB::GetValueTime(LPSPropValue pVal, PRTime&amp; val)</span>
<a href="#l2.600"></a><span id="l2.600" class="difflineminus">-{</span>
<a href="#l2.601"></a><span id="l2.601" class="difflineminus">-  if (!pVal)</span>
<a href="#l2.602"></a><span id="l2.602" class="difflineminus">-    return;</span>
<a href="#l2.603"></a><span id="l2.603" class="difflineminus">-</span>
<a href="#l2.604"></a><span id="l2.604" class="difflineminus">-  if (PROP_TYPE(pVal-&gt;ulPropTag) != PT_SYSTIME)</span>
<a href="#l2.605"></a><span id="l2.605" class="difflineminus">-    return;</span>
<a href="#l2.606"></a><span id="l2.606" class="difflineminus">-</span>
<a href="#l2.607"></a><span id="l2.607" class="difflineminus">-  nsOE5File::FileTimeToPRTime(&amp;pVal-&gt;Value.ft, &amp;val);</span>
<a href="#l2.608"></a><span id="l2.608" class="difflineminus">-}</span>
<a href="#l2.609"></a><span id="l2.609" class="difflineminus">-</span>
<a href="#l2.610"></a><span id="l2.610" class="difflineminus">-bool CWAB::IsAvailable()</span>
<a href="#l2.611"></a><span id="l2.611" class="difflineminus">-{</span>
<a href="#l2.612"></a><span id="l2.612" class="difflineminus">-  if (!m_bInitialized || !m_lpAdrBook)</span>
<a href="#l2.613"></a><span id="l2.613" class="difflineminus">-    return false;</span>
<a href="#l2.614"></a><span id="l2.614" class="difflineminus">-</span>
<a href="#l2.615"></a><span id="l2.615" class="difflineminus">-  ULONG lpcbEID = 0;</span>
<a href="#l2.616"></a><span id="l2.616" class="difflineminus">-  LPENTRYID lpEID = NULL;</span>
<a href="#l2.617"></a><span id="l2.617" class="difflineminus">-  HRESULT hr = m_lpAdrBook-&gt;GetPAB(&amp;lpcbEID, &amp;lpEID);</span>
<a href="#l2.618"></a><span id="l2.618" class="difflineminus">-  if (HR_FAILED(hr))</span>
<a href="#l2.619"></a><span id="l2.619" class="difflineminus">-    return false;</span>
<a href="#l2.620"></a><span id="l2.620" class="difflineminus">-</span>
<a href="#l2.621"></a><span id="l2.621" class="difflineminus">-  ULONG ulObjType = 0;</span>
<a href="#l2.622"></a><span id="l2.622" class="difflineminus">-  LPABCONT lpContainer = NULL;</span>
<a href="#l2.623"></a><span id="l2.623" class="difflineminus">-  hr = m_lpAdrBook-&gt;OpenEntry(lpcbEID,</span>
<a href="#l2.624"></a><span id="l2.624" class="difflineminus">-                              (LPENTRYID)lpEID,</span>
<a href="#l2.625"></a><span id="l2.625" class="difflineminus">-                              NULL,</span>
<a href="#l2.626"></a><span id="l2.626" class="difflineminus">-                              0,</span>
<a href="#l2.627"></a><span id="l2.627" class="difflineminus">-                              &amp;ulObjType,</span>
<a href="#l2.628"></a><span id="l2.628" class="difflineminus">-                              (LPUNKNOWN *)&amp;lpContainer);</span>
<a href="#l2.629"></a><span id="l2.629" class="difflineminus">-  m_lpWABObject-&gt;FreeBuffer(lpEID);</span>
<a href="#l2.630"></a><span id="l2.630" class="difflineminus">-</span>
<a href="#l2.631"></a><span id="l2.631" class="difflineminus">-  LPMAPITABLE lpAB = NULL;</span>
<a href="#l2.632"></a><span id="l2.632" class="difflineminus">-  hr = lpContainer-&gt;GetContentsTable(0, &amp;lpAB);</span>
<a href="#l2.633"></a><span id="l2.633" class="difflineminus">-  if(HR_FAILED(hr)) {</span>
<a href="#l2.634"></a><span id="l2.634" class="difflineminus">-    lpContainer-&gt;Release();</span>
<a href="#l2.635"></a><span id="l2.635" class="difflineminus">-    return false;</span>
<a href="#l2.636"></a><span id="l2.636" class="difflineminus">-  }</span>
<a href="#l2.637"></a><span id="l2.637" class="difflineminus">-</span>
<a href="#l2.638"></a><span id="l2.638" class="difflineminus">-  ULONG rowCount = 0;</span>
<a href="#l2.639"></a><span id="l2.639" class="difflineminus">-  hr = lpAB-&gt;GetRowCount(0, &amp;rowCount);</span>
<a href="#l2.640"></a><span id="l2.640" class="difflineminus">-  lpContainer-&gt;Release();</span>
<a href="#l2.641"></a><span id="l2.641" class="difflineminus">-  lpAB-&gt;Release();</span>
<a href="#l2.642"></a><span id="l2.642" class="difflineminus">-  return (rowCount != 0);</span>
<a href="#l2.643"></a><span id="l2.643" class="difflineminus">-}</span>
<a href="#l2.644"></a><span id="l2.644" class="difflineminus">-</span>
<a href="#l2.645"></a><span id="l2.645" class="difflineminus">-/*</span>
<a href="#l2.646"></a><span id="l2.646" class="difflineminus">-BOOL CWabIterateProcess::SanitizeMultiLine(CString&amp; val)</span>
<a href="#l2.647"></a><span id="l2.647" class="difflineminus">-{</span>
<a href="#l2.648"></a><span id="l2.648" class="difflineminus">-  val.TrimLeft();</span>
<a href="#l2.649"></a><span id="l2.649" class="difflineminus">-  val.TrimRight();</span>
<a href="#l2.650"></a><span id="l2.650" class="difflineminus">-  int idx = val.FindOneOf(&quot;\x0D\x0A&quot;);</span>
<a href="#l2.651"></a><span id="l2.651" class="difflineminus">-  if (idx == -1)</span>
<a href="#l2.652"></a><span id="l2.652" class="difflineminus">-    return FALSE;</span>
<a href="#l2.653"></a><span id="l2.653" class="difflineminus">-</span>
<a href="#l2.654"></a><span id="l2.654" class="difflineminus">-  // needs encoding</span>
<a href="#l2.655"></a><span id="l2.655" class="difflineminus">-  U32 bufSz = UMimeEncode::GetBufferSize(val.GetLength());</span>
<a href="#l2.656"></a><span id="l2.656" class="difflineminus">-  P_U8 pBuf = new U8[bufSz];</span>
<a href="#l2.657"></a><span id="l2.657" class="difflineminus">-  U32 len = UMimeEncode::ConvertBuffer((PC_U8)((PC_S8)val), val.GetLength(), pBuf, 66, 52, &quot;\x0D\x0A &quot;);</span>
<a href="#l2.658"></a><span id="l2.658" class="difflineminus">-  pBuf[len] = 0;</span>
<a href="#l2.659"></a><span id="l2.659" class="difflineminus">-  val = pBuf;</span>
<a href="#l2.660"></a><span id="l2.660" class="difflineminus">-  delete pBuf;</span>
<a href="#l2.661"></a><span id="l2.661" class="difflineminus">-  return TRUE;</span>
<a href="#l2.662"></a><span id="l2.662" class="difflineminus">-}</span>
<a href="#l2.663"></a><span id="l2.663" class="difflineminus">-</span>
<a href="#l2.664"></a><span id="l2.664" class="difflineminus">-BOOL CWabIterateProcess::EnumUser(LPCTSTR pName, LPENTRYID pEid, ULONG cbEid)</span>
<a href="#l2.665"></a><span id="l2.665" class="difflineminus">-{</span>
<a href="#l2.666"></a><span id="l2.666" class="difflineminus">-  TRACE1(&quot;User: %s\n&quot;, pName);</span>
<a href="#l2.667"></a><span id="l2.667" class="difflineminus">-</span>
<a href="#l2.668"></a><span id="l2.668" class="difflineminus">-  LPMAILUSER  pUser = m_pWab-&gt;GetUser(cbEid, pEid);</span>
<a href="#l2.669"></a><span id="l2.669" class="difflineminus">-</span>
<a href="#l2.670"></a><span id="l2.670" class="difflineminus">-  // Get the &quot;required&quot; strings first</span>
<a href="#l2.671"></a><span id="l2.671" class="difflineminus">-  CString    lastName;</span>
<a href="#l2.672"></a><span id="l2.672" class="difflineminus">-  CString    firstName;</span>
<a href="#l2.673"></a><span id="l2.673" class="difflineminus">-  CString    eMail;</span>
<a href="#l2.674"></a><span id="l2.674" class="difflineminus">-  CString    nickName;</span>
<a href="#l2.675"></a><span id="l2.675" class="difflineminus">-  CString    middleName;</span>
<a href="#l2.676"></a><span id="l2.676" class="difflineminus">-</span>
<a href="#l2.677"></a><span id="l2.677" class="difflineminus">-  if (!pUser) {</span>
<a href="#l2.678"></a><span id="l2.678" class="difflineminus">-    UDialogs::ErrMessage1(IDS_ENTRY_ERROR, pName);</span>
<a href="#l2.679"></a><span id="l2.679" class="difflineminus">-    return FALSE;</span>
<a href="#l2.680"></a><span id="l2.680" class="difflineminus">-  }</span>
<a href="#l2.681"></a><span id="l2.681" class="difflineminus">-</span>
<a href="#l2.682"></a><span id="l2.682" class="difflineminus">-  LPSPropValue  pProp = m_pWab-&gt;GetUserProperty(pUser, PR_EMAIL_ADDRESS);</span>
<a href="#l2.683"></a><span id="l2.683" class="difflineminus">-  if (pProp) {</span>
<a href="#l2.684"></a><span id="l2.684" class="difflineminus">-    m_pWab-&gt;GetValueString(pProp, eMail);</span>
<a href="#l2.685"></a><span id="l2.685" class="difflineminus">-    SanitizeValue(eMail);</span>
<a href="#l2.686"></a><span id="l2.686" class="difflineminus">-    m_pWab-&gt;FreeProperty(pProp);</span>
<a href="#l2.687"></a><span id="l2.687" class="difflineminus">-  }</span>
<a href="#l2.688"></a><span id="l2.688" class="difflineminus">-  pProp = m_pWab-&gt;GetUserProperty(pUser, PR_GIVEN_NAME);</span>
<a href="#l2.689"></a><span id="l2.689" class="difflineminus">-  if (pProp) {</span>
<a href="#l2.690"></a><span id="l2.690" class="difflineminus">-    m_pWab-&gt;GetValueString(pProp, firstName);</span>
<a href="#l2.691"></a><span id="l2.691" class="difflineminus">-    SanitizeValue(firstName);</span>
<a href="#l2.692"></a><span id="l2.692" class="difflineminus">-    m_pWab-&gt;FreeProperty(pProp);</span>
<a href="#l2.693"></a><span id="l2.693" class="difflineminus">-  }</span>
<a href="#l2.694"></a><span id="l2.694" class="difflineminus">-  pProp = m_pWab-&gt;GetUserProperty(pUser, PR_SURNAME);</span>
<a href="#l2.695"></a><span id="l2.695" class="difflineminus">-  if (pProp) {</span>
<a href="#l2.696"></a><span id="l2.696" class="difflineminus">-    m_pWab-&gt;GetValueString(pProp, lastName);</span>
<a href="#l2.697"></a><span id="l2.697" class="difflineminus">-    SanitizeValue(lastName);</span>
<a href="#l2.698"></a><span id="l2.698" class="difflineminus">-    m_pWab-&gt;FreeProperty(pProp);</span>
<a href="#l2.699"></a><span id="l2.699" class="difflineminus">-  }</span>
<a href="#l2.700"></a><span id="l2.700" class="difflineminus">-  pProp = m_pWab-&gt;GetUserProperty(pUser, PR_MIDDLE_NAME);</span>
<a href="#l2.701"></a><span id="l2.701" class="difflineminus">-  if (pProp) {</span>
<a href="#l2.702"></a><span id="l2.702" class="difflineminus">-    m_pWab-&gt;GetValueString(pProp, middleName);</span>
<a href="#l2.703"></a><span id="l2.703" class="difflineminus">-    SanitizeValue(middleName);</span>
<a href="#l2.704"></a><span id="l2.704" class="difflineminus">-    m_pWab-&gt;FreeProperty(pProp);</span>
<a href="#l2.705"></a><span id="l2.705" class="difflineminus">-  }</span>
<a href="#l2.706"></a><span id="l2.706" class="difflineminus">-  pProp = m_pWab-&gt;GetUserProperty(pUser, PR_NICKNAME);</span>
<a href="#l2.707"></a><span id="l2.707" class="difflineminus">-  if (pProp) {</span>
<a href="#l2.708"></a><span id="l2.708" class="difflineminus">-    m_pWab-&gt;GetValueString(pProp, nickName);</span>
<a href="#l2.709"></a><span id="l2.709" class="difflineminus">-    SanitizeValue(nickName);</span>
<a href="#l2.710"></a><span id="l2.710" class="difflineminus">-    m_pWab-&gt;FreeProperty(pProp);</span>
<a href="#l2.711"></a><span id="l2.711" class="difflineminus">-  }</span>
<a href="#l2.712"></a><span id="l2.712" class="difflineminus">-  if (nickName.IsEmpty())</span>
<a href="#l2.713"></a><span id="l2.713" class="difflineminus">-    nickName = pName;</span>
<a href="#l2.714"></a><span id="l2.714" class="difflineminus">-  if (firstName.IsEmpty()) {</span>
<a href="#l2.715"></a><span id="l2.715" class="difflineminus">-    firstName = nickName;</span>
<a href="#l2.716"></a><span id="l2.716" class="difflineminus">-    middleName.Empty();</span>
<a href="#l2.717"></a><span id="l2.717" class="difflineminus">-    lastName.Empty();</span>
<a href="#l2.718"></a><span id="l2.718" class="difflineminus">-  }</span>
<a href="#l2.719"></a><span id="l2.719" class="difflineminus">-  if (lastName.IsEmpty())</span>
<a href="#l2.720"></a><span id="l2.720" class="difflineminus">-    middleName.Empty();</span>
<a href="#l2.721"></a><span id="l2.721" class="difflineminus">-</span>
<a href="#l2.722"></a><span id="l2.722" class="difflineminus">-  if (eMail.IsEmpty())</span>
<a href="#l2.723"></a><span id="l2.723" class="difflineminus">-    eMail = nickName;</span>
<a href="#l2.724"></a><span id="l2.724" class="difflineminus">-</span>
<a href="#l2.725"></a><span id="l2.725" class="difflineminus">-</span>
<a href="#l2.726"></a><span id="l2.726" class="difflineminus">-  // We now have the required fields</span>
<a href="#l2.727"></a><span id="l2.727" class="difflineminus">-  // write them out followed by any optional fields!</span>
<a href="#l2.728"></a><span id="l2.728" class="difflineminus">-  BOOL  result = TRUE;</span>
<a href="#l2.729"></a><span id="l2.729" class="difflineminus">-</span>
<a href="#l2.730"></a><span id="l2.730" class="difflineminus">-  if (m_recordsDone)</span>
<a href="#l2.731"></a><span id="l2.731" class="difflineminus">-    result = m_out.WriteEol();</span>
<a href="#l2.732"></a><span id="l2.732" class="difflineminus">-</span>
<a href="#l2.733"></a><span id="l2.733" class="difflineminus">-  CString    line;</span>
<a href="#l2.734"></a><span id="l2.734" class="difflineminus">-  CString    header;</span>
<a href="#l2.735"></a><span id="l2.735" class="difflineminus">-  line.LoadString(IDS_LDIF_DN_START);</span>
<a href="#l2.736"></a><span id="l2.736" class="difflineminus">-  line += firstName;</span>
<a href="#l2.737"></a><span id="l2.737" class="difflineminus">-  if (!middleName.IsEmpty()) {</span>
<a href="#l2.738"></a><span id="l2.738" class="difflineminus">-    line += ' ';</span>
<a href="#l2.739"></a><span id="l2.739" class="difflineminus">-    line += middleName;</span>
<a href="#l2.740"></a><span id="l2.740" class="difflineminus">-  }</span>
<a href="#l2.741"></a><span id="l2.741" class="difflineminus">-  if (!lastName.IsEmpty()) {</span>
<a href="#l2.742"></a><span id="l2.742" class="difflineminus">-    line += ' ';</span>
<a href="#l2.743"></a><span id="l2.743" class="difflineminus">-    line += lastName;</span>
<a href="#l2.744"></a><span id="l2.744" class="difflineminus">-  }</span>
<a href="#l2.745"></a><span id="l2.745" class="difflineminus">-  header.LoadString(IDS_LDIF_DN_MIDDLE);</span>
<a href="#l2.746"></a><span id="l2.746" class="difflineminus">-  line += header;</span>
<a href="#l2.747"></a><span id="l2.747" class="difflineminus">-  line += eMail;</span>
<a href="#l2.748"></a><span id="l2.748" class="difflineminus">-  result = result &amp;&amp; m_out.WriteStr(line);</span>
<a href="#l2.749"></a><span id="l2.749" class="difflineminus">-  result = result &amp;&amp; m_out.WriteEol();</span>
<a href="#l2.750"></a><span id="l2.750" class="difflineminus">-</span>
<a href="#l2.751"></a><span id="l2.751" class="difflineminus">-  line.LoadString(IDS_FIELD_LDIF_FULLNAME);</span>
<a href="#l2.752"></a><span id="l2.752" class="difflineminus">-  line += ' ';</span>
<a href="#l2.753"></a><span id="l2.753" class="difflineminus">-  line += firstName;</span>
<a href="#l2.754"></a><span id="l2.754" class="difflineminus">-  if (!middleName.IsEmpty()) {</span>
<a href="#l2.755"></a><span id="l2.755" class="difflineminus">-    line += ' ';</span>
<a href="#l2.756"></a><span id="l2.756" class="difflineminus">-    line += middleName;</span>
<a href="#l2.757"></a><span id="l2.757" class="difflineminus">-  }</span>
<a href="#l2.758"></a><span id="l2.758" class="difflineminus">-  if (!lastName.IsEmpty()) {</span>
<a href="#l2.759"></a><span id="l2.759" class="difflineminus">-    line += ' ';</span>
<a href="#l2.760"></a><span id="l2.760" class="difflineminus">-    line += lastName;</span>
<a href="#l2.761"></a><span id="l2.761" class="difflineminus">-  }</span>
<a href="#l2.762"></a><span id="l2.762" class="difflineminus">-  result = result &amp;&amp; m_out.WriteStr(line);</span>
<a href="#l2.763"></a><span id="l2.763" class="difflineminus">-  result = result &amp;&amp; m_out.WriteEol();</span>
<a href="#l2.764"></a><span id="l2.764" class="difflineminus">-</span>
<a href="#l2.765"></a><span id="l2.765" class="difflineminus">-</span>
<a href="#l2.766"></a><span id="l2.766" class="difflineminus">-  line.LoadString(IDS_FIELD_LDIF_GIVENNAME);</span>
<a href="#l2.767"></a><span id="l2.767" class="difflineminus">-  line += ' ';</span>
<a href="#l2.768"></a><span id="l2.768" class="difflineminus">-  line += firstName;</span>
<a href="#l2.769"></a><span id="l2.769" class="difflineminus">-  result = result &amp;&amp; m_out.WriteStr(line);</span>
<a href="#l2.770"></a><span id="l2.770" class="difflineminus">-  result = result &amp;&amp; m_out.WriteEol();</span>
<a href="#l2.771"></a><span id="l2.771" class="difflineminus">-</span>
<a href="#l2.772"></a><span id="l2.772" class="difflineminus">-  if (!lastName.IsEmpty()) {</span>
<a href="#l2.773"></a><span id="l2.773" class="difflineminus">-    line.LoadString(IDS_FIELD_LDIF_LASTNAME);</span>
<a href="#l2.774"></a><span id="l2.774" class="difflineminus">-    if (!middleName.IsEmpty()) {</span>
<a href="#l2.775"></a><span id="l2.775" class="difflineminus">-      line += ' ';</span>
<a href="#l2.776"></a><span id="l2.776" class="difflineminus">-      line += middleName;</span>
<a href="#l2.777"></a><span id="l2.777" class="difflineminus">-    }</span>
<a href="#l2.778"></a><span id="l2.778" class="difflineminus">-    line += ' ';</span>
<a href="#l2.779"></a><span id="l2.779" class="difflineminus">-    line += lastName;</span>
<a href="#l2.780"></a><span id="l2.780" class="difflineminus">-    result = result &amp;&amp; m_out.WriteStr(line);</span>
<a href="#l2.781"></a><span id="l2.781" class="difflineminus">-    result = result &amp;&amp; m_out.WriteEol();</span>
<a href="#l2.782"></a><span id="l2.782" class="difflineminus">-  }</span>
<a href="#l2.783"></a><span id="l2.783" class="difflineminus">-</span>
<a href="#l2.784"></a><span id="l2.784" class="difflineminus">-  result = result &amp;&amp; m_out.WriteStr(kLDIFPerson);</span>
<a href="#l2.785"></a><span id="l2.785" class="difflineminus">-</span>
<a href="#l2.786"></a><span id="l2.786" class="difflineminus">-  line.LoadString(IDS_FIELD_LDIF_EMAIL);</span>
<a href="#l2.787"></a><span id="l2.787" class="difflineminus">-  line += ' ';</span>
<a href="#l2.788"></a><span id="l2.788" class="difflineminus">-  line += eMail;</span>
<a href="#l2.789"></a><span id="l2.789" class="difflineminus">-  result = result &amp;&amp; m_out.WriteStr(line);</span>
<a href="#l2.790"></a><span id="l2.790" class="difflineminus">-  result = result &amp;&amp; m_out.WriteEol();</span>
<a href="#l2.791"></a><span id="l2.791" class="difflineminus">-</span>
<a href="#l2.792"></a><span id="l2.792" class="difflineminus">-  line.LoadString(IDS_FIELD_LDIF_NICKNAME);</span>
<a href="#l2.793"></a><span id="l2.793" class="difflineminus">-  line += ' ';</span>
<a href="#l2.794"></a><span id="l2.794" class="difflineminus">-  line += nickName;</span>
<a href="#l2.795"></a><span id="l2.795" class="difflineminus">-  result = result &amp;&amp; m_out.WriteStr(line);</span>
<a href="#l2.796"></a><span id="l2.796" class="difflineminus">-  result = result &amp;&amp; m_out.WriteEol();</span>
<a href="#l2.797"></a><span id="l2.797" class="difflineminus">-</span>
<a href="#l2.798"></a><span id="l2.798" class="difflineminus">-  // Do all of the extra fields!</span>
<a href="#l2.799"></a><span id="l2.799" class="difflineminus">-  CString  value;</span>
<a href="#l2.800"></a><span id="l2.800" class="difflineminus">-  BOOL  encoded = FALSE;</span>
<a href="#l2.801"></a><span id="l2.801" class="difflineminus">-  for (int i = 0; i &lt; kExtraUserFields; i++) {</span>
<a href="#l2.802"></a><span id="l2.802" class="difflineminus">-    value.Empty();</span>
<a href="#l2.803"></a><span id="l2.803" class="difflineminus">-    pProp = m_pWab-&gt;GetUserProperty(pUser, extraUserFields[i].tag);</span>
<a href="#l2.804"></a><span id="l2.804" class="difflineminus">-    if (pProp) {</span>
<a href="#l2.805"></a><span id="l2.805" class="difflineminus">-      m_pWab-&gt;GetValueString(pProp, value);</span>
<a href="#l2.806"></a><span id="l2.806" class="difflineminus">-      m_pWab-&gt;FreeProperty(pProp);</span>
<a href="#l2.807"></a><span id="l2.807" class="difflineminus">-    }</span>
<a href="#l2.808"></a><span id="l2.808" class="difflineminus">-    if (extraUserFields[i].multiLine) {</span>
<a href="#l2.809"></a><span id="l2.809" class="difflineminus">-      encoded = SanitizeMultiLine(value);</span>
<a href="#l2.810"></a><span id="l2.810" class="difflineminus">-    }</span>
<a href="#l2.811"></a><span id="l2.811" class="difflineminus">-    else</span>
<a href="#l2.812"></a><span id="l2.812" class="difflineminus">-      SanitizeValue(value);</span>
<a href="#l2.813"></a><span id="l2.813" class="difflineminus">-    if (!value.IsEmpty()) {</span>
<a href="#l2.814"></a><span id="l2.814" class="difflineminus">-      line = extraUserFields[i].pLDIF;</span>
<a href="#l2.815"></a><span id="l2.815" class="difflineminus">-      if (encoded) {</span>
<a href="#l2.816"></a><span id="l2.816" class="difflineminus">-        line += &quot;: &quot;;</span>
<a href="#l2.817"></a><span id="l2.817" class="difflineminus">-        encoded = FALSE;</span>
<a href="#l2.818"></a><span id="l2.818" class="difflineminus">-      }</span>
<a href="#l2.819"></a><span id="l2.819" class="difflineminus">-      else</span>
<a href="#l2.820"></a><span id="l2.820" class="difflineminus">-        line += ' ';</span>
<a href="#l2.821"></a><span id="l2.821" class="difflineminus">-      line += value;</span>
<a href="#l2.822"></a><span id="l2.822" class="difflineminus">-      result = result &amp;&amp; m_out.WriteStr(line);</span>
<a href="#l2.823"></a><span id="l2.823" class="difflineminus">-      result = result &amp;&amp; m_out.WriteEol();</span>
<a href="#l2.824"></a><span id="l2.824" class="difflineminus">-    }</span>
<a href="#l2.825"></a><span id="l2.825" class="difflineminus">-  }</span>
<a href="#l2.826"></a><span id="l2.826" class="difflineminus">-</span>
<a href="#l2.827"></a><span id="l2.827" class="difflineminus">-  m_pWab-&gt;ReleaseUser(pUser);</span>
<a href="#l2.828"></a><span id="l2.828" class="difflineminus">-</span>
<a href="#l2.829"></a><span id="l2.829" class="difflineminus">-  if (!result) {</span>
<a href="#l2.830"></a><span id="l2.830" class="difflineminus">-    UDialogs::ErrMessage0(IDS_ADDRESS_SAVE_ERROR);</span>
<a href="#l2.831"></a><span id="l2.831" class="difflineminus">-  }</span>
<a href="#l2.832"></a><span id="l2.832" class="difflineminus">-</span>
<a href="#l2.833"></a><span id="l2.833" class="difflineminus">-  m_totalDone += kValuePerUser;</span>
<a href="#l2.834"></a><span id="l2.834" class="difflineminus">-  m_recordsDone++;</span>
<a href="#l2.835"></a><span id="l2.835" class="difflineminus">-</span>
<a href="#l2.836"></a><span id="l2.836" class="difflineminus">-  return result;</span>
<a href="#l2.837"></a><span id="l2.837" class="difflineminus">-}</span>
<a href="#l2.838"></a><span id="l2.838" class="difflineminus">-*/</span>
<a href="#l2.839"></a><span id="l2.839" class="difflineminus">-</span>
<a href="#l2.840"></a><span id="l2.840" class="difflineminus">-</span>
<a href="#l2.841"></a><span id="l2.841" class="difflineminus">-</span>
<a href="#l2.842"></a><span id="l2.842" class="difflineminus">-</span>
<a href="#l2.843"></a><span id="l2.843" class="difflineminus">-/*</span>
<a href="#l2.844"></a><span id="l2.844" class="difflineminus">-BOOL CWabIterateProcess::EnumList(LPCTSTR pName, LPENTRYID pEid, ULONG cbEid)</span>
<a href="#l2.845"></a><span id="l2.845" class="difflineminus">-{</span>
<a href="#l2.846"></a><span id="l2.846" class="difflineminus">-  TRACE1(&quot;List: %s\n&quot;, pName);</span>
<a href="#l2.847"></a><span id="l2.847" class="difflineminus">-</span>
<a href="#l2.848"></a><span id="l2.848" class="difflineminus">-  LPDISTLIST    pList = m_pWab-&gt;GetDistList(cbEid, pEid);</span>
<a href="#l2.849"></a><span id="l2.849" class="difflineminus">-  if (!pList) {</span>
<a href="#l2.850"></a><span id="l2.850" class="difflineminus">-    UDialogs::ErrMessage1(IDS_ENTRY_ERROR, pName);</span>
<a href="#l2.851"></a><span id="l2.851" class="difflineminus">-    return FALSE;</span>
<a href="#l2.852"></a><span id="l2.852" class="difflineminus">-  }</span>
<a href="#l2.853"></a><span id="l2.853" class="difflineminus">-</span>
<a href="#l2.854"></a><span id="l2.854" class="difflineminus">-  // Find out if this is just a regular entry or a true list...</span>
<a href="#l2.855"></a><span id="l2.855" class="difflineminus">-  CString      eMail;</span>
<a href="#l2.856"></a><span id="l2.856" class="difflineminus">-  LPSPropValue  pProp = m_pWab-&gt;GetListProperty(pList, PR_EMAIL_ADDRESS);</span>
<a href="#l2.857"></a><span id="l2.857" class="difflineminus">-  if (pProp) {</span>
<a href="#l2.858"></a><span id="l2.858" class="difflineminus">-    m_pWab-&gt;GetValueString(pProp, eMail);</span>
<a href="#l2.859"></a><span id="l2.859" class="difflineminus">-    SanitizeValue(eMail);</span>
<a href="#l2.860"></a><span id="l2.860" class="difflineminus">-    m_pWab-&gt;FreeProperty(pProp);</span>
<a href="#l2.861"></a><span id="l2.861" class="difflineminus">-    // Treat this like a regular entry...</span>
<a href="#l2.862"></a><span id="l2.862" class="difflineminus">-    if (!eMail.IsEmpty()) {</span>
<a href="#l2.863"></a><span id="l2.863" class="difflineminus">-      m_pWab-&gt;ReleaseDistList(pList);</span>
<a href="#l2.864"></a><span id="l2.864" class="difflineminus">-      return WriteListUserEntry(pName, eMail);</span>
<a href="#l2.865"></a><span id="l2.865" class="difflineminus">-    }</span>
<a href="#l2.866"></a><span id="l2.866" class="difflineminus">-  }</span>
<a href="#l2.867"></a><span id="l2.867" class="difflineminus">-</span>
<a href="#l2.868"></a><span id="l2.868" class="difflineminus">-  // This may very well be a list, find the entries...</span>
<a href="#l2.869"></a><span id="l2.869" class="difflineminus">-  m_pListTable = OpenDistList(pList);</span>
<a href="#l2.870"></a><span id="l2.870" class="difflineminus">-  if (m_pListTable) {</span>
<a href="#l2.871"></a><span id="l2.871" class="difflineminus">-    m_pList = pList;</span>
<a href="#l2.872"></a><span id="l2.872" class="difflineminus">-    m_listName = pName;</span>
<a href="#l2.873"></a><span id="l2.873" class="difflineminus">-    m_listDone = 0;</span>
<a href="#l2.874"></a><span id="l2.874" class="difflineminus">-    m_listHeaderDone = FALSE;</span>
<a href="#l2.875"></a><span id="l2.875" class="difflineminus">-    m_state = kEnumListState;</span>
<a href="#l2.876"></a><span id="l2.876" class="difflineminus">-  }</span>
<a href="#l2.877"></a><span id="l2.877" class="difflineminus">-  else {</span>
<a href="#l2.878"></a><span id="l2.878" class="difflineminus">-    m_pWab-&gt;ReleaseDistList(pList);</span>
<a href="#l2.879"></a><span id="l2.879" class="difflineminus">-    m_recordsDone++;</span>
<a href="#l2.880"></a><span id="l2.880" class="difflineminus">-    m_totalDone += kValuePerUser;</span>
<a href="#l2.881"></a><span id="l2.881" class="difflineminus">-  }</span>
<a href="#l2.882"></a><span id="l2.882" class="difflineminus">-</span>
<a href="#l2.883"></a><span id="l2.883" class="difflineminus">-  return TRUE;</span>
<a href="#l2.884"></a><span id="l2.884" class="difflineminus">-}</span>
<a href="#l2.885"></a><span id="l2.885" class="difflineminus">-</span>
<a href="#l2.886"></a><span id="l2.886" class="difflineminus">-BOOL CWabIterateProcess::EnumNextListUser(BOOL *pDone)</span>
<a href="#l2.887"></a><span id="l2.887" class="difflineminus">-{</span>
<a href="#l2.888"></a><span id="l2.888" class="difflineminus">-  HRESULT      hr;</span>
<a href="#l2.889"></a><span id="l2.889" class="difflineminus">-  int        cNumRows = 0;</span>
<a href="#l2.890"></a><span id="l2.890" class="difflineminus">-  LPSRowSet    lpRowAB = NULL;</span>
<a href="#l2.891"></a><span id="l2.891" class="difflineminus">-  BOOL      keepGoing = TRUE;</span>
<a href="#l2.892"></a><span id="l2.892" class="difflineminus">-</span>
<a href="#l2.893"></a><span id="l2.893" class="difflineminus">-  if (!m_pListTable)</span>
<a href="#l2.894"></a><span id="l2.894" class="difflineminus">-    return FALSE;</span>
<a href="#l2.895"></a><span id="l2.895" class="difflineminus">-</span>
<a href="#l2.896"></a><span id="l2.896" class="difflineminus">-  hr = m_pListTable-&gt;QueryRows(1, 0, &amp;lpRowAB);</span>
<a href="#l2.897"></a><span id="l2.897" class="difflineminus">-</span>
<a href="#l2.898"></a><span id="l2.898" class="difflineminus">-  if(HR_FAILED(hr)) {</span>
<a href="#l2.899"></a><span id="l2.899" class="difflineminus">-    UDialogs::ErrMessage0(IDS_ERROR_READING_WAB);</span>
<a href="#l2.900"></a><span id="l2.900" class="difflineminus">-    return FALSE;</span>
<a href="#l2.901"></a><span id="l2.901" class="difflineminus">-  }</span>
<a href="#l2.902"></a><span id="l2.902" class="difflineminus">-</span>
<a href="#l2.903"></a><span id="l2.903" class="difflineminus">-  if(lpRowAB) {</span>
<a href="#l2.904"></a><span id="l2.904" class="difflineminus">-    cNumRows = lpRowAB-&gt;cRows;</span>
<a href="#l2.905"></a><span id="l2.905" class="difflineminus">-</span>
<a href="#l2.906"></a><span id="l2.906" class="difflineminus">-    if (cNumRows) {</span>
<a href="#l2.907"></a><span id="l2.907" class="difflineminus">-      LPTSTR lpsz = lpRowAB-&gt;aRow[0].lpProps[ieidPR_DISPLAY_NAME].Value.lpszA;</span>
<a href="#l2.908"></a><span id="l2.908" class="difflineminus">-      LPENTRYID lpEID = (LPENTRYID) lpRowAB-&gt;aRow[0].lpProps[ieidPR_ENTRYID].Value.bin.lpb;</span>
<a href="#l2.909"></a><span id="l2.909" class="difflineminus">-      ULONG cbEID = lpRowAB-&gt;aRow[0].lpProps[ieidPR_ENTRYID].Value.bin.cb;</span>
<a href="#l2.910"></a><span id="l2.910" class="difflineminus">-            if(lpRowAB-&gt;aRow[0].lpProps[ieidPR_OBJECT_TYPE].Value.l == MAPI_DISTLIST) {</span>
<a href="#l2.911"></a><span id="l2.911" class="difflineminus">-        keepGoing = HandleListList(lpsz, lpEID, cbEID);</span>
<a href="#l2.912"></a><span id="l2.912" class="difflineminus">-        }</span>
<a href="#l2.913"></a><span id="l2.913" class="difflineminus">-      else if (lpRowAB-&gt;aRow[0].lpProps[ieidPR_OBJECT_TYPE].Value.l == MAPI_MAILUSER) {</span>
<a href="#l2.914"></a><span id="l2.914" class="difflineminus">-        keepGoing = HandleListUser(lpsz, lpEID, cbEID);</span>
<a href="#l2.915"></a><span id="l2.915" class="difflineminus">-      }</span>
<a href="#l2.916"></a><span id="l2.916" class="difflineminus">-    }</span>
<a href="#l2.917"></a><span id="l2.917" class="difflineminus">-    m_pWab-&gt;FreeProws(lpRowAB);</span>
<a href="#l2.918"></a><span id="l2.918" class="difflineminus">-   }</span>
<a href="#l2.919"></a><span id="l2.919" class="difflineminus">-</span>
<a href="#l2.920"></a><span id="l2.920" class="difflineminus">-  if (!cNumRows || !lpRowAB) {</span>
<a href="#l2.921"></a><span id="l2.921" class="difflineminus">-    *pDone = TRUE;</span>
<a href="#l2.922"></a><span id="l2.922" class="difflineminus">-    m_pListTable-&gt;Release();</span>
<a href="#l2.923"></a><span id="l2.923" class="difflineminus">-    m_pListTable = NULL;</span>
<a href="#l2.924"></a><span id="l2.924" class="difflineminus">-    if (m_pList)</span>
<a href="#l2.925"></a><span id="l2.925" class="difflineminus">-      m_pWab-&gt;ReleaseDistList(m_pList);</span>
<a href="#l2.926"></a><span id="l2.926" class="difflineminus">-    m_pList = NULL;</span>
<a href="#l2.927"></a><span id="l2.927" class="difflineminus">-    if (m_listDone &lt; kValuePerUser)</span>
<a href="#l2.928"></a><span id="l2.928" class="difflineminus">-      m_totalDone += (kValuePerUser - m_listDone);</span>
<a href="#l2.929"></a><span id="l2.929" class="difflineminus">-    m_recordsDone++;</span>
<a href="#l2.930"></a><span id="l2.930" class="difflineminus">-    return keepGoing;</span>
<a href="#l2.931"></a><span id="l2.931" class="difflineminus">-  }</span>
<a href="#l2.932"></a><span id="l2.932" class="difflineminus">-</span>
<a href="#l2.933"></a><span id="l2.933" class="difflineminus">-  if (!keepGoing)</span>
<a href="#l2.934"></a><span id="l2.934" class="difflineminus">-    return FALSE;</span>
<a href="#l2.935"></a><span id="l2.935" class="difflineminus">-</span>
<a href="#l2.936"></a><span id="l2.936" class="difflineminus">-  if (m_listDone &lt; kValuePerUser) {</span>
<a href="#l2.937"></a><span id="l2.937" class="difflineminus">-    m_listDone++;</span>
<a href="#l2.938"></a><span id="l2.938" class="difflineminus">-    m_totalDone++;</span>
<a href="#l2.939"></a><span id="l2.939" class="difflineminus">-  }</span>
<a href="#l2.940"></a><span id="l2.940" class="difflineminus">-</span>
<a href="#l2.941"></a><span id="l2.941" class="difflineminus">-  return TRUE;</span>
<a href="#l2.942"></a><span id="l2.942" class="difflineminus">-}</span>
<a href="#l2.943"></a><span id="l2.943" class="difflineminus">-</span>
<a href="#l2.944"></a><span id="l2.944" class="difflineminus">-BOOL CWabIterateProcess::HandleListList(LPCTSTR pName, LPENTRYID lpEid, ULONG cbEid)</span>
<a href="#l2.945"></a><span id="l2.945" class="difflineminus">-{</span>
<a href="#l2.946"></a><span id="l2.946" class="difflineminus">-  BOOL      result;</span>
<a href="#l2.947"></a><span id="l2.947" class="difflineminus">-  LPDISTLIST    pList = m_pWab-&gt;GetDistList(cbEid, lpEid);</span>
<a href="#l2.948"></a><span id="l2.948" class="difflineminus">-  if (!pList) {</span>
<a href="#l2.949"></a><span id="l2.949" class="difflineminus">-    UDialogs::ErrMessage1(IDS_ENTRY_ERROR, pName);</span>
<a href="#l2.950"></a><span id="l2.950" class="difflineminus">-    return FALSE;</span>
<a href="#l2.951"></a><span id="l2.951" class="difflineminus">-  }</span>
<a href="#l2.952"></a><span id="l2.952" class="difflineminus">-</span>
<a href="#l2.953"></a><span id="l2.953" class="difflineminus">-  CString      eMail;</span>
<a href="#l2.954"></a><span id="l2.954" class="difflineminus">-  LPSPropValue  pProp = m_pWab-&gt;GetListProperty(pList, PR_EMAIL_ADDRESS);</span>
<a href="#l2.955"></a><span id="l2.955" class="difflineminus">-  if (pProp) {</span>
<a href="#l2.956"></a><span id="l2.956" class="difflineminus">-    m_pWab-&gt;GetValueString(pProp, eMail);</span>
<a href="#l2.957"></a><span id="l2.957" class="difflineminus">-    SanitizeValue(eMail);</span>
<a href="#l2.958"></a><span id="l2.958" class="difflineminus">-    m_pWab-&gt;FreeProperty(pProp);</span>
<a href="#l2.959"></a><span id="l2.959" class="difflineminus">-    // Treat this like a regular entry...</span>
<a href="#l2.960"></a><span id="l2.960" class="difflineminus">-    if (!eMail.IsEmpty()) {</span>
<a href="#l2.961"></a><span id="l2.961" class="difflineminus">-      // write out a member based on pName and eMail</span>
<a href="#l2.962"></a><span id="l2.962" class="difflineminus">-      result = WriteGroupMember(pName, eMail);</span>
<a href="#l2.963"></a><span id="l2.963" class="difflineminus">-      m_pWab-&gt;ReleaseDistList(pList);</span>
<a href="#l2.964"></a><span id="l2.964" class="difflineminus">-      return result;</span>
<a href="#l2.965"></a><span id="l2.965" class="difflineminus">-    }</span>
<a href="#l2.966"></a><span id="l2.966" class="difflineminus">-  }</span>
<a href="#l2.967"></a><span id="l2.967" class="difflineminus">-</span>
<a href="#l2.968"></a><span id="l2.968" class="difflineminus">-  // iterate the list and add each member to the top level list</span>
<a href="#l2.969"></a><span id="l2.969" class="difflineminus">-  LPMAPITABLE  pTable = OpenDistList(pList);</span>
<a href="#l2.970"></a><span id="l2.970" class="difflineminus">-  if (!pTable) {</span>
<a href="#l2.971"></a><span id="l2.971" class="difflineminus">-    TRACE0(&quot;Error opening table for list\n&quot;);</span>
<a href="#l2.972"></a><span id="l2.972" class="difflineminus">-    m_pWab-&gt;ReleaseDistList(pList);</span>
<a href="#l2.973"></a><span id="l2.973" class="difflineminus">-    UDialogs::ErrMessage1(IDS_ENTRY_ERROR, pName);</span>
<a href="#l2.974"></a><span id="l2.974" class="difflineminus">-    return FALSE;</span>
<a href="#l2.975"></a><span id="l2.975" class="difflineminus">-  }</span>
<a href="#l2.976"></a><span id="l2.976" class="difflineminus">-</span>
<a href="#l2.977"></a><span id="l2.977" class="difflineminus">-  int        cNumRows = 0;</span>
<a href="#l2.978"></a><span id="l2.978" class="difflineminus">-  LPSRowSet    lpRowAB = NULL;</span>
<a href="#l2.979"></a><span id="l2.979" class="difflineminus">-  HRESULT      hr;</span>
<a href="#l2.980"></a><span id="l2.980" class="difflineminus">-  BOOL      keepGoing = TRUE;</span>
<a href="#l2.981"></a><span id="l2.981" class="difflineminus">-</span>
<a href="#l2.982"></a><span id="l2.982" class="difflineminus">-  do {</span>
<a href="#l2.983"></a><span id="l2.983" class="difflineminus">-    hr = pTable-&gt;QueryRows(1, 0, &amp;lpRowAB);</span>
<a href="#l2.984"></a><span id="l2.984" class="difflineminus">-</span>
<a href="#l2.985"></a><span id="l2.985" class="difflineminus">-    if(HR_FAILED(hr)) {</span>
<a href="#l2.986"></a><span id="l2.986" class="difflineminus">-      UDialogs::ErrMessage0(IDS_ERROR_READING_WAB);</span>
<a href="#l2.987"></a><span id="l2.987" class="difflineminus">-      pTable-&gt;Release();</span>
<a href="#l2.988"></a><span id="l2.988" class="difflineminus">-      m_pWab-&gt;ReleaseDistList(pList);</span>
<a href="#l2.989"></a><span id="l2.989" class="difflineminus">-      return FALSE;</span>
<a href="#l2.990"></a><span id="l2.990" class="difflineminus">-    }</span>
<a href="#l2.991"></a><span id="l2.991" class="difflineminus">-</span>
<a href="#l2.992"></a><span id="l2.992" class="difflineminus">-    if(lpRowAB) {</span>
<a href="#l2.993"></a><span id="l2.993" class="difflineminus">-      cNumRows = lpRowAB-&gt;cRows;</span>
<a href="#l2.994"></a><span id="l2.994" class="difflineminus">-</span>
<a href="#l2.995"></a><span id="l2.995" class="difflineminus">-      if (cNumRows) {</span>
<a href="#l2.996"></a><span id="l2.996" class="difflineminus">-        LPTSTR lpsz = lpRowAB-&gt;aRow[0].lpProps[ieidPR_DISPLAY_NAME].Value.lpszA;</span>
<a href="#l2.997"></a><span id="l2.997" class="difflineminus">-        LPENTRYID lpEID = (LPENTRYID) lpRowAB-&gt;aRow[0].lpProps[ieidPR_ENTRYID].Value.bin.lpb;</span>
<a href="#l2.998"></a><span id="l2.998" class="difflineminus">-        ULONG cbEID = lpRowAB-&gt;aRow[0].lpProps[ieidPR_ENTRYID].Value.bin.cb;</span>
<a href="#l2.999"></a><span id="l2.999" class="difflineminus">-        if(lpRowAB-&gt;aRow[0].lpProps[ieidPR_OBJECT_TYPE].Value.l == MAPI_DISTLIST) {</span>
<a href="#l2.1000"></a><span id="l2.1000" class="difflineminus">-          keepGoing = HandleListList(lpsz, lpEID, cbEID);</span>
<a href="#l2.1001"></a><span id="l2.1001" class="difflineminus">-        }</span>
<a href="#l2.1002"></a><span id="l2.1002" class="difflineminus">-        else if (lpRowAB-&gt;aRow[0].lpProps[ieidPR_OBJECT_TYPE].Value.l == MAPI_MAILUSER) {</span>
<a href="#l2.1003"></a><span id="l2.1003" class="difflineminus">-          keepGoing = HandleListUser(lpsz, lpEID, cbEID);</span>
<a href="#l2.1004"></a><span id="l2.1004" class="difflineminus">-        }</span>
<a href="#l2.1005"></a><span id="l2.1005" class="difflineminus">-      }</span>
<a href="#l2.1006"></a><span id="l2.1006" class="difflineminus">-      m_pWab-&gt;FreeProws(lpRowAB);</span>
<a href="#l2.1007"></a><span id="l2.1007" class="difflineminus">-     }</span>
<a href="#l2.1008"></a><span id="l2.1008" class="difflineminus">-  }</span>
<a href="#l2.1009"></a><span id="l2.1009" class="difflineminus">-  while (keepGoing &amp;&amp; cNumRows &amp;&amp; lpRowAB);</span>
<a href="#l2.1010"></a><span id="l2.1010" class="difflineminus">-</span>
<a href="#l2.1011"></a><span id="l2.1011" class="difflineminus">-  pTable-&gt;Release();</span>
<a href="#l2.1012"></a><span id="l2.1012" class="difflineminus">-  m_pWab-&gt;ReleaseDistList(pList);</span>
<a href="#l2.1013"></a><span id="l2.1013" class="difflineminus">-  return keepGoing;</span>
<a href="#l2.1014"></a><span id="l2.1014" class="difflineminus">-}</span>
<a href="#l2.1015"></a><span id="l2.1015" class="difflineminus">-</span>
<a href="#l2.1016"></a><span id="l2.1016" class="difflineminus">-BOOL CWabIterateProcess::HandleListUser(LPCTSTR pName, LPENTRYID lpEid, ULONG cbEid)</span>
<a href="#l2.1017"></a><span id="l2.1017" class="difflineminus">-{</span>
<a href="#l2.1018"></a><span id="l2.1018" class="difflineminus">-  // Get the basic properties for building the member line</span>
<a href="#l2.1019"></a><span id="l2.1019" class="difflineminus">-  LPMAILUSER  pUser = m_pWab-&gt;GetUser(cbEid, lpEid);</span>
<a href="#l2.1020"></a><span id="l2.1020" class="difflineminus">-</span>
<a href="#l2.1021"></a><span id="l2.1021" class="difflineminus">-  // Get the &quot;required&quot; strings first</span>
<a href="#l2.1022"></a><span id="l2.1022" class="difflineminus">-  CString    lastName;</span>
<a href="#l2.1023"></a><span id="l2.1023" class="difflineminus">-  CString    firstName;</span>
<a href="#l2.1024"></a><span id="l2.1024" class="difflineminus">-  CString    eMail;</span>
<a href="#l2.1025"></a><span id="l2.1025" class="difflineminus">-  CString    nickName;</span>
<a href="#l2.1026"></a><span id="l2.1026" class="difflineminus">-  CString    middleName;</span>
<a href="#l2.1027"></a><span id="l2.1027" class="difflineminus">-</span>
<a href="#l2.1028"></a><span id="l2.1028" class="difflineminus">-  if (!pUser) {</span>
<a href="#l2.1029"></a><span id="l2.1029" class="difflineminus">-    UDialogs::ErrMessage1(IDS_ENTRY_ERROR, pName);</span>
<a href="#l2.1030"></a><span id="l2.1030" class="difflineminus">-    return FALSE;</span>
<a href="#l2.1031"></a><span id="l2.1031" class="difflineminus">-  }</span>
<a href="#l2.1032"></a><span id="l2.1032" class="difflineminus">-</span>
<a href="#l2.1033"></a><span id="l2.1033" class="difflineminus">-  LPSPropValue  pProp = m_pWab-&gt;GetUserProperty(pUser, PR_EMAIL_ADDRESS);</span>
<a href="#l2.1034"></a><span id="l2.1034" class="difflineminus">-  if (pProp) {</span>
<a href="#l2.1035"></a><span id="l2.1035" class="difflineminus">-    m_pWab-&gt;GetValueString(pProp, eMail);</span>
<a href="#l2.1036"></a><span id="l2.1036" class="difflineminus">-    SanitizeValue(eMail);</span>
<a href="#l2.1037"></a><span id="l2.1037" class="difflineminus">-    m_pWab-&gt;FreeProperty(pProp);</span>
<a href="#l2.1038"></a><span id="l2.1038" class="difflineminus">-  }</span>
<a href="#l2.1039"></a><span id="l2.1039" class="difflineminus">-  pProp = m_pWab-&gt;GetUserProperty(pUser, PR_GIVEN_NAME);</span>
<a href="#l2.1040"></a><span id="l2.1040" class="difflineminus">-  if (pProp) {</span>
<a href="#l2.1041"></a><span id="l2.1041" class="difflineminus">-    m_pWab-&gt;GetValueString(pProp, firstName);</span>
<a href="#l2.1042"></a><span id="l2.1042" class="difflineminus">-    SanitizeValue(firstName);</span>
<a href="#l2.1043"></a><span id="l2.1043" class="difflineminus">-    m_pWab-&gt;FreeProperty(pProp);</span>
<a href="#l2.1044"></a><span id="l2.1044" class="difflineminus">-  }</span>
<a href="#l2.1045"></a><span id="l2.1045" class="difflineminus">-  pProp = m_pWab-&gt;GetUserProperty(pUser, PR_SURNAME);</span>
<a href="#l2.1046"></a><span id="l2.1046" class="difflineminus">-  if (pProp) {</span>
<a href="#l2.1047"></a><span id="l2.1047" class="difflineminus">-    m_pWab-&gt;GetValueString(pProp, lastName);</span>
<a href="#l2.1048"></a><span id="l2.1048" class="difflineminus">-    SanitizeValue(lastName);</span>
<a href="#l2.1049"></a><span id="l2.1049" class="difflineminus">-    m_pWab-&gt;FreeProperty(pProp);</span>
<a href="#l2.1050"></a><span id="l2.1050" class="difflineminus">-  }</span>
<a href="#l2.1051"></a><span id="l2.1051" class="difflineminus">-  pProp = m_pWab-&gt;GetUserProperty(pUser, PR_MIDDLE_NAME);</span>
<a href="#l2.1052"></a><span id="l2.1052" class="difflineminus">-  if (pProp) {</span>
<a href="#l2.1053"></a><span id="l2.1053" class="difflineminus">-    m_pWab-&gt;GetValueString(pProp, middleName);</span>
<a href="#l2.1054"></a><span id="l2.1054" class="difflineminus">-    SanitizeValue(middleName);</span>
<a href="#l2.1055"></a><span id="l2.1055" class="difflineminus">-    m_pWab-&gt;FreeProperty(pProp);</span>
<a href="#l2.1056"></a><span id="l2.1056" class="difflineminus">-  }</span>
<a href="#l2.1057"></a><span id="l2.1057" class="difflineminus">-  pProp = m_pWab-&gt;GetUserProperty(pUser, PR_NICKNAME);</span>
<a href="#l2.1058"></a><span id="l2.1058" class="difflineminus">-  if (pProp) {</span>
<a href="#l2.1059"></a><span id="l2.1059" class="difflineminus">-    m_pWab-&gt;GetValueString(pProp, nickName);</span>
<a href="#l2.1060"></a><span id="l2.1060" class="difflineminus">-    SanitizeValue(nickName);</span>
<a href="#l2.1061"></a><span id="l2.1061" class="difflineminus">-    m_pWab-&gt;FreeProperty(pProp);</span>
<a href="#l2.1062"></a><span id="l2.1062" class="difflineminus">-  }</span>
<a href="#l2.1063"></a><span id="l2.1063" class="difflineminus">-  if (nickName.IsEmpty())</span>
<a href="#l2.1064"></a><span id="l2.1064" class="difflineminus">-    nickName = pName;</span>
<a href="#l2.1065"></a><span id="l2.1065" class="difflineminus">-  if (firstName.IsEmpty()) {</span>
<a href="#l2.1066"></a><span id="l2.1066" class="difflineminus">-    firstName = nickName;</span>
<a href="#l2.1067"></a><span id="l2.1067" class="difflineminus">-    middleName.Empty();</span>
<a href="#l2.1068"></a><span id="l2.1068" class="difflineminus">-    lastName.Empty();</span>
<a href="#l2.1069"></a><span id="l2.1069" class="difflineminus">-  }</span>
<a href="#l2.1070"></a><span id="l2.1070" class="difflineminus">-  if (lastName.IsEmpty())</span>
<a href="#l2.1071"></a><span id="l2.1071" class="difflineminus">-    middleName.Empty();</span>
<a href="#l2.1072"></a><span id="l2.1072" class="difflineminus">-</span>
<a href="#l2.1073"></a><span id="l2.1073" class="difflineminus">-  if (eMail.IsEmpty())</span>
<a href="#l2.1074"></a><span id="l2.1074" class="difflineminus">-    eMail = nickName;</span>
<a href="#l2.1075"></a><span id="l2.1075" class="difflineminus">-</span>
<a href="#l2.1076"></a><span id="l2.1076" class="difflineminus">-  m_pWab-&gt;ReleaseUser(pUser);</span>
<a href="#l2.1077"></a><span id="l2.1077" class="difflineminus">-</span>
<a href="#l2.1078"></a><span id="l2.1078" class="difflineminus">-  CString  name = firstName;</span>
<a href="#l2.1079"></a><span id="l2.1079" class="difflineminus">-  if (!middleName.IsEmpty()) {</span>
<a href="#l2.1080"></a><span id="l2.1080" class="difflineminus">-    name += ' ';</span>
<a href="#l2.1081"></a><span id="l2.1081" class="difflineminus">-    name += middleName;</span>
<a href="#l2.1082"></a><span id="l2.1082" class="difflineminus">-  }</span>
<a href="#l2.1083"></a><span id="l2.1083" class="difflineminus">-  if (!lastName.IsEmpty()) {</span>
<a href="#l2.1084"></a><span id="l2.1084" class="difflineminus">-    name += ' ';</span>
<a href="#l2.1085"></a><span id="l2.1085" class="difflineminus">-    name += lastName;</span>
<a href="#l2.1086"></a><span id="l2.1086" class="difflineminus">-  }</span>
<a href="#l2.1087"></a><span id="l2.1087" class="difflineminus">-  return WriteGroupMember(name, eMail);</span>
<a href="#l2.1088"></a><span id="l2.1088" class="difflineminus">-}</span>
<a href="#l2.1089"></a><span id="l2.1089" class="difflineminus">-</span>
<a href="#l2.1090"></a><span id="l2.1090" class="difflineminus">-BOOL CWabIterateProcess::WriteGroupMember(const char *pName, const char *pEmail)</span>
<a href="#l2.1091"></a><span id="l2.1091" class="difflineminus">-{</span>
<a href="#l2.1092"></a><span id="l2.1092" class="difflineminus">-  CString    middle;</span>
<a href="#l2.1093"></a><span id="l2.1093" class="difflineminus">-  CString    line;</span>
<a href="#l2.1094"></a><span id="l2.1094" class="difflineminus">-  BOOL    result;</span>
<a href="#l2.1095"></a><span id="l2.1095" class="difflineminus">-</span>
<a href="#l2.1096"></a><span id="l2.1096" class="difflineminus">-  // Check for the header first</span>
<a href="#l2.1097"></a><span id="l2.1097" class="difflineminus">-  if (!m_listHeaderDone) {</span>
<a href="#l2.1098"></a><span id="l2.1098" class="difflineminus">-    if (m_recordsDone)</span>
<a href="#l2.1099"></a><span id="l2.1099" class="difflineminus">-      result = m_out.WriteEol();</span>
<a href="#l2.1100"></a><span id="l2.1100" class="difflineminus">-    else</span>
<a href="#l2.1101"></a><span id="l2.1101" class="difflineminus">-      result = TRUE;</span>
<a href="#l2.1102"></a><span id="l2.1102" class="difflineminus">-    line.LoadString(IDS_LDIF_DN_START);</span>
<a href="#l2.1103"></a><span id="l2.1103" class="difflineminus">-    line += m_listName;</span>
<a href="#l2.1104"></a><span id="l2.1104" class="difflineminus">-    line += TR_OUTPUT_EOL;</span>
<a href="#l2.1105"></a><span id="l2.1105" class="difflineminus">-    middle.LoadString(IDS_FIELD_LDIF_FULLNAME);</span>
<a href="#l2.1106"></a><span id="l2.1106" class="difflineminus">-    line += middle;</span>
<a href="#l2.1107"></a><span id="l2.1107" class="difflineminus">-    line += m_listName;</span>
<a href="#l2.1108"></a><span id="l2.1108" class="difflineminus">-    line += TR_OUTPUT_EOL;</span>
<a href="#l2.1109"></a><span id="l2.1109" class="difflineminus">-    if (!result || !m_out.WriteStr(line) || !m_out.WriteStr(kLDIFGroup)) {</span>
<a href="#l2.1110"></a><span id="l2.1110" class="difflineminus">-      UDialogs::ErrMessage0(IDS_ADDRESS_SAVE_ERROR);</span>
<a href="#l2.1111"></a><span id="l2.1111" class="difflineminus">-      return FALSE;</span>
<a href="#l2.1112"></a><span id="l2.1112" class="difflineminus">-    }</span>
<a href="#l2.1113"></a><span id="l2.1113" class="difflineminus">-    m_listHeaderDone = TRUE;</span>
<a href="#l2.1114"></a><span id="l2.1114" class="difflineminus">-  }</span>
<a href="#l2.1115"></a><span id="l2.1115" class="difflineminus">-</span>
<a href="#l2.1116"></a><span id="l2.1116" class="difflineminus">-</span>
<a href="#l2.1117"></a><span id="l2.1117" class="difflineminus">-  line.LoadString(IDS_FIELD_LDIF_MEMBER_START);</span>
<a href="#l2.1118"></a><span id="l2.1118" class="difflineminus">-  line += pName;</span>
<a href="#l2.1119"></a><span id="l2.1119" class="difflineminus">-  middle.LoadString(IDS_LDIF_DN_MIDDLE);</span>
<a href="#l2.1120"></a><span id="l2.1120" class="difflineminus">-  line += middle;</span>
<a href="#l2.1121"></a><span id="l2.1121" class="difflineminus">-  line += pEmail;</span>
<a href="#l2.1122"></a><span id="l2.1122" class="difflineminus">-  line += TR_OUTPUT_EOL;</span>
<a href="#l2.1123"></a><span id="l2.1123" class="difflineminus">-  if (!m_out.WriteStr(line)) {</span>
<a href="#l2.1124"></a><span id="l2.1124" class="difflineminus">-    UDialogs::ErrMessage0(IDS_ADDRESS_SAVE_ERROR);</span>
<a href="#l2.1125"></a><span id="l2.1125" class="difflineminus">-    return FALSE;</span>
<a href="#l2.1126"></a><span id="l2.1126" class="difflineminus">-  }</span>
<a href="#l2.1127"></a><span id="l2.1127" class="difflineminus">-</span>
<a href="#l2.1128"></a><span id="l2.1128" class="difflineminus">-  if (m_listDone &lt; kValuePerUser) {</span>
<a href="#l2.1129"></a><span id="l2.1129" class="difflineminus">-    m_listDone++;</span>
<a href="#l2.1130"></a><span id="l2.1130" class="difflineminus">-    m_totalDone++;</span>
<a href="#l2.1131"></a><span id="l2.1131" class="difflineminus">-  }</span>
<a href="#l2.1132"></a><span id="l2.1132" class="difflineminus">-</span>
<a href="#l2.1133"></a><span id="l2.1133" class="difflineminus">-  return TRUE;</span>
<a href="#l2.1134"></a><span id="l2.1134" class="difflineminus">-}</span>
<a href="#l2.1135"></a><span id="l2.1135" class="difflineminus">-*/</span>
<a href="#l2.1136"></a><span id="l2.1136" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1">deleted file mode 100644</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineminus">--- a/mailnews/import/oexpress/WabObject.h</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineplus">+++ /dev/null</span>
<a href="#l3.4"></a><span id="l3.4" class="difflineat">@@ -1,64 +0,0 @@</span>
<a href="#l3.5"></a><span id="l3.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l3.6"></a><span id="l3.6" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l3.7"></a><span id="l3.7" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l3.8"></a><span id="l3.8" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l3.9"></a><span id="l3.9" class="difflineminus">-</span>
<a href="#l3.10"></a><span id="l3.10" class="difflineminus">-#ifndef WabObject_h___</span>
<a href="#l3.11"></a><span id="l3.11" class="difflineminus">-#define WabObject_h___</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-#include &quot;nscore.h&quot;</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineminus">-#include &quot;nsStringGlue.h&quot;</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineminus">-#include &quot;nsIFile.h&quot;</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineminus">-</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineminus">-#include &lt;windows.h&gt;</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineminus">-#include &lt;wab.h&gt;</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineminus">-</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineminus">-</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineminus">-class CWabIterator {</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineminus">-public:</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineminus">-  virtual nsresult  EnumUser(const char16_t *pName, LPENTRYID pEid, ULONG cbEid) = 0;</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineminus">-  virtual nsresult  EnumList(const char16_t *pName, LPENTRYID pEid, ULONG cbEid, LPMAPITABLE lpTable) = 0;</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineminus">-};</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineminus">-</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineminus">-</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineminus">-class CWAB</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineminus">-{</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineminus">-public:</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineminus">-    CWAB(nsIFile *fileName);</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineminus">-    ~CWAB();</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineminus">-</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineminus">-  bool      Loaded(void) { return m_bInitialized;}</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineminus">-</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineminus">-  HRESULT    IterateWABContents(CWabIterator *pIter, int *pDone);</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineminus">-</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineminus">-  // Methods for User entries</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineminus">-  LPDISTLIST    GetDistList(ULONG cbEid, LPENTRYID pEid);</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineminus">-  void      ReleaseDistList(LPDISTLIST pList) { if (pList) pList-&gt;Release();}</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineminus">-  LPMAILUSER    GetUser(ULONG cbEid, LPENTRYID pEid);</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineminus">-  void      ReleaseUser(LPMAILUSER pUser) { if (pUser) pUser-&gt;Release();}</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineminus">-  LPSPropValue  GetUserProperty(LPMAILUSER pUser, ULONG tag);</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineminus">-  LPSPropValue  GetListProperty(LPDISTLIST pList, ULONG tag);</span>
<a href="#l3.45"></a><span id="l3.45" class="difflineminus">-  void      FreeProperty(LPSPropValue pVal) { if (pVal) m_lpWABObject-&gt;FreeBuffer(pVal);}</span>
<a href="#l3.46"></a><span id="l3.46" class="difflineminus">-  void      GetValueString(LPSPropValue pVal, nsString&amp; val);</span>
<a href="#l3.47"></a><span id="l3.47" class="difflineminus">-  void      GetValueTime(LPSPropValue pVal, PRTime&amp; val);</span>
<a href="#l3.48"></a><span id="l3.48" class="difflineminus">-</span>
<a href="#l3.49"></a><span id="l3.49" class="difflineminus">-  void      CStrToUnicode(const char *pStr, nsString&amp; result);</span>
<a href="#l3.50"></a><span id="l3.50" class="difflineminus">-</span>
<a href="#l3.51"></a><span id="l3.51" class="difflineminus">-  // Utility stuff used by iterate</span>
<a href="#l3.52"></a><span id="l3.52" class="difflineminus">-  void      FreeProws(LPSRowSet prows);</span>
<a href="#l3.53"></a><span id="l3.53" class="difflineminus">-</span>
<a href="#l3.54"></a><span id="l3.54" class="difflineminus">-  bool      IsAvailable();</span>
<a href="#l3.55"></a><span id="l3.55" class="difflineminus">-</span>
<a href="#l3.56"></a><span id="l3.56" class="difflineminus">-private:</span>
<a href="#l3.57"></a><span id="l3.57" class="difflineminus">-  char16_t *  m_pUniBuff;</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineminus">-  int      m_uniBuffLen;</span>
<a href="#l3.59"></a><span id="l3.59" class="difflineminus">-  bool        m_bInitialized;</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineminus">-    HINSTANCE   m_hinstWAB;</span>
<a href="#l3.61"></a><span id="l3.61" class="difflineminus">-    LPWABOPEN   m_lpfnWABOpen;</span>
<a href="#l3.62"></a><span id="l3.62" class="difflineminus">-    LPADRBOOK   m_lpAdrBook;</span>
<a href="#l3.63"></a><span id="l3.63" class="difflineminus">-    LPWABOBJECT m_lpWABObject;</span>
<a href="#l3.64"></a><span id="l3.64" class="difflineminus">-};</span>
<a href="#l3.65"></a><span id="l3.65" class="difflineminus">-</span>
<a href="#l3.66"></a><span id="l3.66" class="difflineminus">-#endif // WABOBJECT_INCLUDED</span>
<a href="#l3.67"></a><span id="l3.67" class="difflineminus">-</span>
<a href="#l3.68"></a><span id="l3.68" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1">deleted file mode 100644</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineminus">--- a/mailnews/import/oexpress/moz.build</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineplus">+++ /dev/null</span>
<a href="#l4.4"></a><span id="l4.4" class="difflineat">@@ -1,19 +0,0 @@</span>
<a href="#l4.5"></a><span id="l4.5" class="difflineminus">-# vim: set filetype=python:</span>
<a href="#l4.6"></a><span id="l4.6" class="difflineminus">-# This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l4.7"></a><span id="l4.7" class="difflineminus">-# License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l4.8"></a><span id="l4.8" class="difflineminus">-# file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l4.9"></a><span id="l4.9" class="difflineminus">-</span>
<a href="#l4.10"></a><span id="l4.10" class="difflineminus">-SOURCES += [</span>
<a href="#l4.11"></a><span id="l4.11" class="difflineminus">-    'nsOE5File.cpp',</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-    'nsOEAddressIterator.cpp',</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineminus">-    'nsOEImport.cpp',</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineminus">-    'nsOEMailbox.cpp',</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineminus">-    'nsOERegUtil.cpp',</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineminus">-    'nsOEScanBoxes.cpp',</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineminus">-    'nsOESettings.cpp',</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineminus">-    'nsOEStringBundle.cpp',</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineminus">-    'WabObject.cpp',</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineminus">-]</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineminus">-</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineminus">-FINAL_LIBRARY = 'import'</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1">deleted file mode 100644</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineminus">--- a/mailnews/import/oexpress/nsOE5File.cpp</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineplus">+++ /dev/null</span>
<a href="#l5.4"></a><span id="l5.4" class="difflineat">@@ -1,631 +0,0 @@</span>
<a href="#l5.5"></a><span id="l5.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l5.6"></a><span id="l5.6" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l5.7"></a><span id="l5.7" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l5.8"></a><span id="l5.8" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l5.9"></a><span id="l5.9" class="difflineminus">-</span>
<a href="#l5.10"></a><span id="l5.10" class="difflineminus">-#include &quot;nsOE5File.h&quot;</span>
<a href="#l5.11"></a><span id="l5.11" class="difflineminus">-#include &quot;OEDebugLog.h&quot;</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-#include &quot;nsMsgUtils.h&quot;</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineminus">-#include &quot;msgCore.h&quot;</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineminus">-#include &quot;prprf.h&quot;</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineminus">-#include &quot;nsMsgLocalFolderHdrs.h&quot;</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineminus">-#include &quot;nsIOutputStream.h&quot;</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineminus">-#include &quot;nsIInputStream.h&quot;</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineminus">-#include &quot;nsIMsgPluggableStore.h&quot;</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineminus">-#include &quot;nsIMsgHdr.h&quot;</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineminus">-#include &quot;nsNetUtil.h&quot;</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineminus">-#include &quot;nsISeekableStream.h&quot;</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineminus">-#include &quot;nsMsgMessageFlags.h&quot;</span>
<a href="#l5.23"></a><span id="l5.23" class="difflineminus">-#include &lt;windows.h&gt;</span>
<a href="#l5.24"></a><span id="l5.24" class="difflineminus">-</span>
<a href="#l5.25"></a><span id="l5.25" class="difflineminus">-#define  kIndexGrowBy    100</span>
<a href="#l5.26"></a><span id="l5.26" class="difflineminus">-#define  kSignatureSize    12</span>
<a href="#l5.27"></a><span id="l5.27" class="difflineminus">-#define  kDontSeek      0xFFFFFFFF</span>
<a href="#l5.28"></a><span id="l5.28" class="difflineminus">-#define  MARKED        0x20     //  4</span>
<a href="#l5.29"></a><span id="l5.29" class="difflineminus">-#define  READ          0x80     //  1</span>
<a href="#l5.30"></a><span id="l5.30" class="difflineminus">-#define  HASATTACHMENT 0x4000   //  268435456  10000000h</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineminus">-#define  ISANSWERED    0x80000  //  2</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineminus">-#define  ISFORWARDED   0x100000 //  4096</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineminus">-#define  ISWATCHED     0x400000 //  256</span>
<a href="#l5.34"></a><span id="l5.34" class="difflineminus">-#define  ISIGNORED     0x800000 //  262144</span>
<a href="#l5.35"></a><span id="l5.35" class="difflineminus">-#define  XLATFLAGS(s)  (((MARKED &amp; s) ? nsMsgMessageFlags::Marked : 0) | \</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineminus">-                        ((READ &amp; s) ? nsMsgMessageFlags::Read : 0) | \</span>
<a href="#l5.37"></a><span id="l5.37" class="difflineminus">-                        ((HASATTACHMENT &amp; s) ? nsMsgMessageFlags::Attachment : 0) | \</span>
<a href="#l5.38"></a><span id="l5.38" class="difflineminus">-                        ((ISANSWERED &amp; s) ? nsMsgMessageFlags::Replied : 0) | \</span>
<a href="#l5.39"></a><span id="l5.39" class="difflineminus">-                        ((ISFORWARDED &amp; s) ? nsMsgMessageFlags::Forwarded : 0) | \</span>
<a href="#l5.40"></a><span id="l5.40" class="difflineminus">-                        ((ISWATCHED &amp; s) ? nsMsgMessageFlags::Watched : 0) | \</span>
<a href="#l5.41"></a><span id="l5.41" class="difflineminus">-                        ((ISIGNORED &amp; s) ? nsMsgMessageFlags::Ignored : 0))</span>
<a href="#l5.42"></a><span id="l5.42" class="difflineminus">-</span>
<a href="#l5.43"></a><span id="l5.43" class="difflineminus">-static char *gSig =</span>
<a href="#l5.44"></a><span id="l5.44" class="difflineminus">-  &quot;\xCF\xAD\x12\xFE\xC5\xFD\x74\x6F\x66\xE3\xD1\x11&quot;;</span>
<a href="#l5.45"></a><span id="l5.45" class="difflineminus">-</span>
<a href="#l5.46"></a><span id="l5.46" class="difflineminus">-// copied from nsprpub/pr/src/{io/prfile.c | md/windows/w95io.c} :</span>
<a href="#l5.47"></a><span id="l5.47" class="difflineminus">-// PR_FileTimeToPRTime and _PR_FileTimeToPRTime</span>
<a href="#l5.48"></a><span id="l5.48" class="difflineminus">-void nsOE5File::FileTimeToPRTime(const FILETIME *filetime, PRTime *prtm)</span>
<a href="#l5.49"></a><span id="l5.49" class="difflineminus">-{</span>
<a href="#l5.50"></a><span id="l5.50" class="difflineminus">-#ifdef __GNUC__</span>
<a href="#l5.51"></a><span id="l5.51" class="difflineminus">-    const PRTime _pr_filetime_offset = 116444736000000000LL;</span>
<a href="#l5.52"></a><span id="l5.52" class="difflineminus">-#else</span>
<a href="#l5.53"></a><span id="l5.53" class="difflineminus">-    const PRTime _pr_filetime_offset = 116444736000000000i64;</span>
<a href="#l5.54"></a><span id="l5.54" class="difflineminus">-#endif</span>
<a href="#l5.55"></a><span id="l5.55" class="difflineminus">-</span>
<a href="#l5.56"></a><span id="l5.56" class="difflineminus">-    PR_ASSERT(sizeof(FILETIME) == sizeof(PRTime));</span>
<a href="#l5.57"></a><span id="l5.57" class="difflineminus">-    ::CopyMemory(prtm, filetime, sizeof(PRTime));</span>
<a href="#l5.58"></a><span id="l5.58" class="difflineminus">-#ifdef __GNUC__</span>
<a href="#l5.59"></a><span id="l5.59" class="difflineminus">-    *prtm = (*prtm - _pr_filetime_offset) / 10LL;</span>
<a href="#l5.60"></a><span id="l5.60" class="difflineminus">-#else</span>
<a href="#l5.61"></a><span id="l5.61" class="difflineminus">-    *prtm = (*prtm - _pr_filetime_offset) / 10i64;</span>
<a href="#l5.62"></a><span id="l5.62" class="difflineminus">-#endif</span>
<a href="#l5.63"></a><span id="l5.63" class="difflineminus">-}</span>
<a href="#l5.64"></a><span id="l5.64" class="difflineminus">-</span>
<a href="#l5.65"></a><span id="l5.65" class="difflineminus">-bool nsOE5File::VerifyLocalMailFile(nsIFile *pFile)</span>
<a href="#l5.66"></a><span id="l5.66" class="difflineminus">-{</span>
<a href="#l5.67"></a><span id="l5.67" class="difflineminus">-  char    sig[kSignatureSize];</span>
<a href="#l5.68"></a><span id="l5.68" class="difflineminus">-</span>
<a href="#l5.69"></a><span id="l5.69" class="difflineminus">-  nsCOMPtr &lt;nsIInputStream&gt; inputStream;</span>
<a href="#l5.70"></a><span id="l5.70" class="difflineminus">-</span>
<a href="#l5.71"></a><span id="l5.71" class="difflineminus">-  if (NS_FAILED(NS_NewLocalFileInputStream(getter_AddRefs(inputStream), pFile)))</span>
<a href="#l5.72"></a><span id="l5.72" class="difflineminus">-    return false;</span>
<a href="#l5.73"></a><span id="l5.73" class="difflineminus">-</span>
<a href="#l5.74"></a><span id="l5.74" class="difflineminus">-  if (!ReadBytes(inputStream, sig, 0, kSignatureSize))</span>
<a href="#l5.75"></a><span id="l5.75" class="difflineminus">-    return false;</span>
<a href="#l5.76"></a><span id="l5.76" class="difflineminus">-</span>
<a href="#l5.77"></a><span id="l5.77" class="difflineminus">-  bool    result = true;</span>
<a href="#l5.78"></a><span id="l5.78" class="difflineminus">-</span>
<a href="#l5.79"></a><span id="l5.79" class="difflineminus">-  for (int i = 0; (i &lt; kSignatureSize) &amp;&amp; result; i++) {</span>
<a href="#l5.80"></a><span id="l5.80" class="difflineminus">-    if (sig[i] != gSig[i])</span>
<a href="#l5.81"></a><span id="l5.81" class="difflineminus">-      result = false;</span>
<a href="#l5.82"></a><span id="l5.82" class="difflineminus">-  }</span>
<a href="#l5.83"></a><span id="l5.83" class="difflineminus">-</span>
<a href="#l5.84"></a><span id="l5.84" class="difflineminus">-  char  storeName[14];</span>
<a href="#l5.85"></a><span id="l5.85" class="difflineminus">-  if (!ReadBytes(inputStream, storeName, 0x24C1, 12))</span>
<a href="#l5.86"></a><span id="l5.86" class="difflineminus">-    result = false;</span>
<a href="#l5.87"></a><span id="l5.87" class="difflineminus">-</span>
<a href="#l5.88"></a><span id="l5.88" class="difflineminus">-  storeName[12] = 0;</span>
<a href="#l5.89"></a><span id="l5.89" class="difflineminus">-</span>
<a href="#l5.90"></a><span id="l5.90" class="difflineminus">-  if (PL_strcasecmp(&quot;LocalStore&quot;, storeName))</span>
<a href="#l5.91"></a><span id="l5.91" class="difflineminus">-    result = false;</span>
<a href="#l5.92"></a><span id="l5.92" class="difflineminus">-</span>
<a href="#l5.93"></a><span id="l5.93" class="difflineminus">-  return result;</span>
<a href="#l5.94"></a><span id="l5.94" class="difflineminus">-}</span>
<a href="#l5.95"></a><span id="l5.95" class="difflineminus">-</span>
<a href="#l5.96"></a><span id="l5.96" class="difflineminus">-bool nsOE5File::IsLocalMailFile(nsIFile *pFile)</span>
<a href="#l5.97"></a><span id="l5.97" class="difflineminus">-{</span>
<a href="#l5.98"></a><span id="l5.98" class="difflineminus">-  nsresult  rv;</span>
<a href="#l5.99"></a><span id="l5.99" class="difflineminus">-  bool      isFile = false;</span>
<a href="#l5.100"></a><span id="l5.100" class="difflineminus">-</span>
<a href="#l5.101"></a><span id="l5.101" class="difflineminus">-  rv = pFile-&gt;IsFile(&amp;isFile);</span>
<a href="#l5.102"></a><span id="l5.102" class="difflineminus">-  if (NS_FAILED(rv) || !isFile)</span>
<a href="#l5.103"></a><span id="l5.103" class="difflineminus">-    return false;</span>
<a href="#l5.104"></a><span id="l5.104" class="difflineminus">-</span>
<a href="#l5.105"></a><span id="l5.105" class="difflineminus">-  bool result = VerifyLocalMailFile(pFile);</span>
<a href="#l5.106"></a><span id="l5.106" class="difflineminus">-</span>
<a href="#l5.107"></a><span id="l5.107" class="difflineminus">-  return result;</span>
<a href="#l5.108"></a><span id="l5.108" class="difflineminus">-}</span>
<a href="#l5.109"></a><span id="l5.109" class="difflineminus">-</span>
<a href="#l5.110"></a><span id="l5.110" class="difflineminus">-bool nsOE5File::ReadIndex(nsIInputStream *pInputStream, uint32_t **ppIndex, uint32_t *pSize)</span>
<a href="#l5.111"></a><span id="l5.111" class="difflineminus">-{</span>
<a href="#l5.112"></a><span id="l5.112" class="difflineminus">-  *ppIndex = nullptr;</span>
<a href="#l5.113"></a><span id="l5.113" class="difflineminus">-  *pSize = 0;</span>
<a href="#l5.114"></a><span id="l5.114" class="difflineminus">-</span>
<a href="#l5.115"></a><span id="l5.115" class="difflineminus">-  char    signature[4];</span>
<a href="#l5.116"></a><span id="l5.116" class="difflineminus">-  if (!ReadBytes(pInputStream, signature, 0, 4))</span>
<a href="#l5.117"></a><span id="l5.117" class="difflineminus">-    return false;</span>
<a href="#l5.118"></a><span id="l5.118" class="difflineminus">-</span>
<a href="#l5.119"></a><span id="l5.119" class="difflineminus">-  for (int i = 0; i &lt; 4; i++) {</span>
<a href="#l5.120"></a><span id="l5.120" class="difflineminus">-    if (signature[i] != gSig[i]) {</span>
<a href="#l5.121"></a><span id="l5.121" class="difflineminus">-      IMPORT_LOG0(&quot;*** Outlook 5.0 dbx file signature doesn't match\n&quot;);</span>
<a href="#l5.122"></a><span id="l5.122" class="difflineminus">-      return false;</span>
<a href="#l5.123"></a><span id="l5.123" class="difflineminus">-    }</span>
<a href="#l5.124"></a><span id="l5.124" class="difflineminus">-  }</span>
<a href="#l5.125"></a><span id="l5.125" class="difflineminus">-</span>
<a href="#l5.126"></a><span id="l5.126" class="difflineminus">-  uint32_t  offset = 0x00e4;</span>
<a href="#l5.127"></a><span id="l5.127" class="difflineminus">-  uint32_t  indexStart = 0;</span>
<a href="#l5.128"></a><span id="l5.128" class="difflineminus">-  if (!ReadBytes(pInputStream, &amp;indexStart, offset, 4)) {</span>
<a href="#l5.129"></a><span id="l5.129" class="difflineminus">-    IMPORT_LOG0(&quot;*** Unable to read offset to index start\n&quot;);</span>
<a href="#l5.130"></a><span id="l5.130" class="difflineminus">-    return false;</span>
<a href="#l5.131"></a><span id="l5.131" class="difflineminus">-  }</span>
<a href="#l5.132"></a><span id="l5.132" class="difflineminus">-</span>
<a href="#l5.133"></a><span id="l5.133" class="difflineminus">-  PRUint32Array array;</span>
<a href="#l5.134"></a><span id="l5.134" class="difflineminus">-  array.count = 0;</span>
<a href="#l5.135"></a><span id="l5.135" class="difflineminus">-  array.alloc = kIndexGrowBy;</span>
<a href="#l5.136"></a><span id="l5.136" class="difflineminus">-  array.pIndex = new uint32_t[kIndexGrowBy];</span>
<a href="#l5.137"></a><span id="l5.137" class="difflineminus">-</span>
<a href="#l5.138"></a><span id="l5.138" class="difflineminus">-  uint32_t next = ReadMsgIndex(pInputStream, indexStart, &amp;array);</span>
<a href="#l5.139"></a><span id="l5.139" class="difflineminus">-  while (next) {</span>
<a href="#l5.140"></a><span id="l5.140" class="difflineminus">-    next = ReadMsgIndex(pInputStream, next, &amp;array);</span>
<a href="#l5.141"></a><span id="l5.141" class="difflineminus">-  }</span>
<a href="#l5.142"></a><span id="l5.142" class="difflineminus">-</span>
<a href="#l5.143"></a><span id="l5.143" class="difflineminus">-  if (array.count) {</span>
<a href="#l5.144"></a><span id="l5.144" class="difflineminus">-    *pSize = array.count;</span>
<a href="#l5.145"></a><span id="l5.145" class="difflineminus">-    *ppIndex = array.pIndex;</span>
<a href="#l5.146"></a><span id="l5.146" class="difflineminus">-    return true;</span>
<a href="#l5.147"></a><span id="l5.147" class="difflineminus">-  }</span>
<a href="#l5.148"></a><span id="l5.148" class="difflineminus">-</span>
<a href="#l5.149"></a><span id="l5.149" class="difflineminus">-  delete [] array.pIndex;</span>
<a href="#l5.150"></a><span id="l5.150" class="difflineminus">-  return false;</span>
<a href="#l5.151"></a><span id="l5.151" class="difflineminus">-}</span>
<a href="#l5.152"></a><span id="l5.152" class="difflineminus">-</span>
<a href="#l5.153"></a><span id="l5.153" class="difflineminus">-</span>
<a href="#l5.154"></a><span id="l5.154" class="difflineminus">-uint32_t nsOE5File::ReadMsgIndex(nsIInputStream *pInputStream, uint32_t offset, PRUint32Array *pArray)</span>
<a href="#l5.155"></a><span id="l5.155" class="difflineminus">-{</span>
<a href="#l5.156"></a><span id="l5.156" class="difflineminus">-  // Record is:</span>
<a href="#l5.157"></a><span id="l5.157" class="difflineminus">-    // 4 byte marker</span>
<a href="#l5.158"></a><span id="l5.158" class="difflineminus">-    // 4 byte unknown</span>
<a href="#l5.159"></a><span id="l5.159" class="difflineminus">-    // 4 byte nextSubIndex</span>
<a href="#l5.160"></a><span id="l5.160" class="difflineminus">-    // 4 byte (parentIndex?)</span>
<a href="#l5.161"></a><span id="l5.161" class="difflineminus">-    // 2 bytes unknown</span>
<a href="#l5.162"></a><span id="l5.162" class="difflineminus">-    // 1 byte length - # of entries in this record</span>
<a href="#l5.163"></a><span id="l5.163" class="difflineminus">-    // 1 byte unknown</span>
<a href="#l5.164"></a><span id="l5.164" class="difflineminus">-    // 4 byte unknown</span>
<a href="#l5.165"></a><span id="l5.165" class="difflineminus">-    // length records consisting of 3 longs</span>
<a href="#l5.166"></a><span id="l5.166" class="difflineminus">-  //  1 - pointer to record</span>
<a href="#l5.167"></a><span id="l5.167" class="difflineminus">-  //  2 - child index pointer</span>
<a href="#l5.168"></a><span id="l5.168" class="difflineminus">-  //  3 - number of records in child</span>
<a href="#l5.169"></a><span id="l5.169" class="difflineminus">-</span>
<a href="#l5.170"></a><span id="l5.170" class="difflineminus">-  uint32_t  marker;</span>
<a href="#l5.171"></a><span id="l5.171" class="difflineminus">-</span>
<a href="#l5.172"></a><span id="l5.172" class="difflineminus">-  if (!ReadBytes(pInputStream, &amp;marker, offset, 4))</span>
<a href="#l5.173"></a><span id="l5.173" class="difflineminus">-    return 0;</span>
<a href="#l5.174"></a><span id="l5.174" class="difflineminus">-</span>
<a href="#l5.175"></a><span id="l5.175" class="difflineminus">-  if (marker != offset)</span>
<a href="#l5.176"></a><span id="l5.176" class="difflineminus">-    return 0;</span>
<a href="#l5.177"></a><span id="l5.177" class="difflineminus">-</span>
<a href="#l5.178"></a><span id="l5.178" class="difflineminus">-</span>
<a href="#l5.179"></a><span id="l5.179" class="difflineminus">-  uint32_t  vals[3];</span>
<a href="#l5.180"></a><span id="l5.180" class="difflineminus">-</span>
<a href="#l5.181"></a><span id="l5.181" class="difflineminus">-  if (!ReadBytes(pInputStream, vals, offset + 4, 12))</span>
<a href="#l5.182"></a><span id="l5.182" class="difflineminus">-    return 0;</span>
<a href="#l5.183"></a><span id="l5.183" class="difflineminus">-</span>
<a href="#l5.184"></a><span id="l5.184" class="difflineminus">-</span>
<a href="#l5.185"></a><span id="l5.185" class="difflineminus">-  uint8_t  len[4];</span>
<a href="#l5.186"></a><span id="l5.186" class="difflineminus">-  if (!ReadBytes(pInputStream, len, offset + 16, 4))</span>
<a href="#l5.187"></a><span id="l5.187" class="difflineminus">-    return 0;</span>
<a href="#l5.188"></a><span id="l5.188" class="difflineminus">-</span>
<a href="#l5.189"></a><span id="l5.189" class="difflineminus">-</span>
<a href="#l5.190"></a><span id="l5.190" class="difflineminus">-</span>
<a href="#l5.191"></a><span id="l5.191" class="difflineminus">-  uint32_t  cnt = (uint32_t) len[1];</span>
<a href="#l5.192"></a><span id="l5.192" class="difflineminus">-  cnt *= 3;</span>
<a href="#l5.193"></a><span id="l5.193" class="difflineminus">-  uint32_t  *pData = new uint32_t[cnt];</span>
<a href="#l5.194"></a><span id="l5.194" class="difflineminus">-</span>
<a href="#l5.195"></a><span id="l5.195" class="difflineminus">-  if (!ReadBytes(pInputStream, pData, offset + 24, cnt * 4)) {</span>
<a href="#l5.196"></a><span id="l5.196" class="difflineminus">-    delete [] pData;</span>
<a href="#l5.197"></a><span id="l5.197" class="difflineminus">-    return 0;</span>
<a href="#l5.198"></a><span id="l5.198" class="difflineminus">-  }</span>
<a href="#l5.199"></a><span id="l5.199" class="difflineminus">-</span>
<a href="#l5.200"></a><span id="l5.200" class="difflineminus">-  uint32_t  next;</span>
<a href="#l5.201"></a><span id="l5.201" class="difflineminus">-  uint32_t  indexOffset;</span>
<a href="#l5.202"></a><span id="l5.202" class="difflineminus">-  uint32_t *  pRecord = pData;</span>
<a href="#l5.203"></a><span id="l5.203" class="difflineminus">-  uint32_t *  pNewIndex;</span>
<a href="#l5.204"></a><span id="l5.204" class="difflineminus">-</span>
<a href="#l5.205"></a><span id="l5.205" class="difflineminus">-  for (uint8_t i = 0; i &lt; (uint8_t)len[1]; i++, pRecord += 3) {</span>
<a href="#l5.206"></a><span id="l5.206" class="difflineminus">-    indexOffset = pRecord[0];</span>
<a href="#l5.207"></a><span id="l5.207" class="difflineminus">-</span>
<a href="#l5.208"></a><span id="l5.208" class="difflineminus">-    if (pArray-&gt;count &gt;= pArray-&gt;alloc) {</span>
<a href="#l5.209"></a><span id="l5.209" class="difflineminus">-      pNewIndex = new uint32_t[ pArray-&gt;alloc + kIndexGrowBy];</span>
<a href="#l5.210"></a><span id="l5.210" class="difflineminus">-      memcpy(pNewIndex, pArray-&gt;pIndex, (pArray-&gt;alloc * 4));</span>
<a href="#l5.211"></a><span id="l5.211" class="difflineminus">-      (pArray-&gt;alloc) += kIndexGrowBy;</span>
<a href="#l5.212"></a><span id="l5.212" class="difflineminus">-      delete [] pArray-&gt;pIndex;</span>
<a href="#l5.213"></a><span id="l5.213" class="difflineminus">-      pArray-&gt;pIndex = pNewIndex;</span>
<a href="#l5.214"></a><span id="l5.214" class="difflineminus">-    }</span>
<a href="#l5.215"></a><span id="l5.215" class="difflineminus">-</span>
<a href="#l5.216"></a><span id="l5.216" class="difflineminus">-    /*</span>
<a href="#l5.217"></a><span id="l5.217" class="difflineminus">-    We could do some checking here if we wanted -</span>
<a href="#l5.218"></a><span id="l5.218" class="difflineminus">-    make sure the index is within the file,</span>
<a href="#l5.219"></a><span id="l5.219" class="difflineminus">-    make sure there isn't a duplicate index, etc.</span>
<a href="#l5.220"></a><span id="l5.220" class="difflineminus">-    */</span>
<a href="#l5.221"></a><span id="l5.221" class="difflineminus">-</span>
<a href="#l5.222"></a><span id="l5.222" class="difflineminus">-    pArray-&gt;pIndex[pArray-&gt;count] = indexOffset;</span>
<a href="#l5.223"></a><span id="l5.223" class="difflineminus">-    (pArray-&gt;count)++;</span>
<a href="#l5.224"></a><span id="l5.224" class="difflineminus">-</span>
<a href="#l5.225"></a><span id="l5.225" class="difflineminus">-</span>
<a href="#l5.226"></a><span id="l5.226" class="difflineminus">-</span>
<a href="#l5.227"></a><span id="l5.227" class="difflineminus">-    next = pRecord[1];</span>
<a href="#l5.228"></a><span id="l5.228" class="difflineminus">-    if (next)</span>
<a href="#l5.229"></a><span id="l5.229" class="difflineminus">-      while ((next = ReadMsgIndex(pInputStream, next, pArray)) != 0);</span>
<a href="#l5.230"></a><span id="l5.230" class="difflineminus">-  }</span>
<a href="#l5.231"></a><span id="l5.231" class="difflineminus">-  delete [] pData;</span>
<a href="#l5.232"></a><span id="l5.232" class="difflineminus">-</span>
<a href="#l5.233"></a><span id="l5.233" class="difflineminus">-  // return the pointer to the next subIndex</span>
<a href="#l5.234"></a><span id="l5.234" class="difflineminus">-  return vals[1];</span>
<a href="#l5.235"></a><span id="l5.235" class="difflineminus">-}</span>
<a href="#l5.236"></a><span id="l5.236" class="difflineminus">-</span>
<a href="#l5.237"></a><span id="l5.237" class="difflineminus">-bool nsOE5File::IsFromLine(char *pLine, uint32_t len)</span>
<a href="#l5.238"></a><span id="l5.238" class="difflineminus">-{</span>
<a href="#l5.239"></a><span id="l5.239" class="difflineminus">-   return (len &gt; 5 &amp;&amp; (pLine[0] == 'F') &amp;&amp; (pLine[1] == 'r') &amp;&amp; (pLine[2] == 'o') &amp;&amp; (pLine[3] == 'm') &amp;&amp; (pLine[4] == ' '));</span>
<a href="#l5.240"></a><span id="l5.240" class="difflineminus">-}</span>
<a href="#l5.241"></a><span id="l5.241" class="difflineminus">-</span>
<a href="#l5.242"></a><span id="l5.242" class="difflineminus">-// Anything over 16K will be assumed BAD, BAD, BAD!</span>
<a href="#l5.243"></a><span id="l5.243" class="difflineminus">-#define  kMailboxBufferSize  0x4000</span>
<a href="#l5.244"></a><span id="l5.244" class="difflineminus">-#define  kMaxAttrCount       0x0030</span>
<a href="#l5.245"></a><span id="l5.245" class="difflineminus">-const char *nsOE5File::m_pFromLineSep = &quot;From - Mon Jan 1 00:00:00 1965\x0D\x0A&quot;;</span>
<a href="#l5.246"></a><span id="l5.246" class="difflineminus">-</span>
<a href="#l5.247"></a><span id="l5.247" class="difflineminus">-nsresult nsOE5File::ImportMailbox(uint32_t *pBytesDone, bool *pAbort,</span>
<a href="#l5.248"></a><span id="l5.248" class="difflineminus">-                                  nsString&amp; name, nsIFile *inFile,</span>
<a href="#l5.249"></a><span id="l5.249" class="difflineminus">-                                  nsIMsgFolder *dstFolder, uint32_t *pCount)</span>
<a href="#l5.250"></a><span id="l5.250" class="difflineminus">-{</span>
<a href="#l5.251"></a><span id="l5.251" class="difflineminus">-  int32_t    msgCount = 0;</span>
<a href="#l5.252"></a><span id="l5.252" class="difflineminus">-  if (pCount)</span>
<a href="#l5.253"></a><span id="l5.253" class="difflineminus">-    *pCount = 0;</span>
<a href="#l5.254"></a><span id="l5.254" class="difflineminus">-</span>
<a href="#l5.255"></a><span id="l5.255" class="difflineminus">-  nsCOMPtr&lt;nsIInputStream&gt; inputStream;</span>
<a href="#l5.256"></a><span id="l5.256" class="difflineminus">-  nsresult rv = NS_NewLocalFileInputStream(getter_AddRefs(inputStream), inFile);</span>
<a href="#l5.257"></a><span id="l5.257" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.258"></a><span id="l5.258" class="difflineminus">-  nsCOMPtr&lt;nsIMsgPluggableStore&gt; msgStore;</span>
<a href="#l5.259"></a><span id="l5.259" class="difflineminus">-  rv = dstFolder-&gt;GetMsgStore(getter_AddRefs(msgStore));</span>
<a href="#l5.260"></a><span id="l5.260" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.261"></a><span id="l5.261" class="difflineminus">-</span>
<a href="#l5.262"></a><span id="l5.262" class="difflineminus">-  uint32_t *  pIndex;</span>
<a href="#l5.263"></a><span id="l5.263" class="difflineminus">-  uint32_t  indexSize;</span>
<a href="#l5.264"></a><span id="l5.264" class="difflineminus">-  uint32_t *  pFlags;</span>
<a href="#l5.265"></a><span id="l5.265" class="difflineminus">-  uint64_t  *  pTime;</span>
<a href="#l5.266"></a><span id="l5.266" class="difflineminus">-</span>
<a href="#l5.267"></a><span id="l5.267" class="difflineminus">-  if (!ReadIndex(inputStream, &amp;pIndex, &amp;indexSize)) {</span>
<a href="#l5.268"></a><span id="l5.268" class="difflineminus">-    IMPORT_LOG1(&quot;No messages found in mailbox: %s\n&quot;, NS_LossyConvertUTF16toASCII(name.get()));</span>
<a href="#l5.269"></a><span id="l5.269" class="difflineminus">-    return NS_OK;</span>
<a href="#l5.270"></a><span id="l5.270" class="difflineminus">-  }</span>
<a href="#l5.271"></a><span id="l5.271" class="difflineminus">-</span>
<a href="#l5.272"></a><span id="l5.272" class="difflineminus">-  pTime  = new uint64_t[ indexSize];</span>
<a href="#l5.273"></a><span id="l5.273" class="difflineminus">-  pFlags = new uint32_t[ indexSize];</span>
<a href="#l5.274"></a><span id="l5.274" class="difflineminus">-  char *  pBuffer = new char[kMailboxBufferSize];</span>
<a href="#l5.275"></a><span id="l5.275" class="difflineminus">-  if (!(*pAbort))</span>
<a href="#l5.276"></a><span id="l5.276" class="difflineminus">-    ConvertIndex(inputStream, pBuffer, pIndex, indexSize, pFlags, pTime);</span>
<a href="#l5.277"></a><span id="l5.277" class="difflineminus">-</span>
<a href="#l5.278"></a><span id="l5.278" class="difflineminus">-  uint32_t  block[4];</span>
<a href="#l5.279"></a><span id="l5.279" class="difflineminus">-  int32_t   sepLen = (int32_t) strlen(m_pFromLineSep);</span>
<a href="#l5.280"></a><span id="l5.280" class="difflineminus">-  uint32_t   written;</span>
<a href="#l5.281"></a><span id="l5.281" class="difflineminus">-</span>
<a href="#l5.282"></a><span id="l5.282" class="difflineminus">-  /*</span>
<a href="#l5.283"></a><span id="l5.283" class="difflineminus">-      Each block is:</span>
<a href="#l5.284"></a><span id="l5.284" class="difflineminus">-      marker - matches file offset</span>
<a href="#l5.285"></a><span id="l5.285" class="difflineminus">-      block length</span>
<a href="#l5.286"></a><span id="l5.286" class="difflineminus">-      text length in block</span>
<a href="#l5.287"></a><span id="l5.287" class="difflineminus">-      pointer to next block. (0 if end)</span>
<a href="#l5.288"></a><span id="l5.288" class="difflineminus">-</span>
<a href="#l5.289"></a><span id="l5.289" class="difflineminus">-      Each message is made up of a linked list of block data.</span>
<a href="#l5.290"></a><span id="l5.290" class="difflineminus">-      So what we do for each message is:</span>
<a href="#l5.291"></a><span id="l5.291" class="difflineminus">-      1. Read the first block data.</span>
<a href="#l5.292"></a><span id="l5.292" class="difflineminus">-      2. Write out the From message separator if the message doesn't already</span>
<a href="#l5.293"></a><span id="l5.293" class="difflineminus">-      start with one.</span>
<a href="#l5.294"></a><span id="l5.294" class="difflineminus">-      3. If the block of data doesn't end with CRLF then a line is broken into two blocks,</span>
<a href="#l5.295"></a><span id="l5.295" class="difflineminus">-      so save the incomplete line for later process when we read the next block. Then</span>
<a href="#l5.296"></a><span id="l5.296" class="difflineminus">-      write out the block excluding the partial line at the end of the block (if exists).</span>
<a href="#l5.297"></a><span id="l5.297" class="difflineminus">-      4. If there's next block of data then read next data block. Otherwise we're done.</span>
<a href="#l5.298"></a><span id="l5.298" class="difflineminus">-      If we found a partial line in step #3 then find the rest of the line from the</span>
<a href="#l5.299"></a><span id="l5.299" class="difflineminus">-      current block and write out this line separately.</span>
<a href="#l5.300"></a><span id="l5.300" class="difflineminus">-      5. Reset some of the control variables and repeat step #3.</span>
<a href="#l5.301"></a><span id="l5.301" class="difflineminus">-  */</span>
<a href="#l5.302"></a><span id="l5.302" class="difflineminus">-</span>
<a href="#l5.303"></a><span id="l5.303" class="difflineminus">-  uint32_t  didBytes = 0;</span>
<a href="#l5.304"></a><span id="l5.304" class="difflineminus">-  uint32_t  next, size;</span>
<a href="#l5.305"></a><span id="l5.305" class="difflineminus">-  char *pStart, *pEnd, *partialLineStart;</span>
<a href="#l5.306"></a><span id="l5.306" class="difflineminus">-  nsAutoCString partialLine, tempLine;</span>
<a href="#l5.307"></a><span id="l5.307" class="difflineminus">-  nsCOMPtr&lt;nsIOutputStream&gt; outputStream;</span>
<a href="#l5.308"></a><span id="l5.308" class="difflineminus">-  rv = NS_OK;</span>
<a href="#l5.309"></a><span id="l5.309" class="difflineminus">-</span>
<a href="#l5.310"></a><span id="l5.310" class="difflineminus">-  for (uint32_t i = 0; (i &lt; indexSize) &amp;&amp; !(*pAbort); i++)</span>
<a href="#l5.311"></a><span id="l5.311" class="difflineminus">-  {</span>
<a href="#l5.312"></a><span id="l5.312" class="difflineminus">-    if (! pIndex[i])</span>
<a href="#l5.313"></a><span id="l5.313" class="difflineminus">-      continue;</span>
<a href="#l5.314"></a><span id="l5.314" class="difflineminus">-</span>
<a href="#l5.315"></a><span id="l5.315" class="difflineminus">-    nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l5.316"></a><span id="l5.316" class="difflineminus">-    bool reusable;</span>
<a href="#l5.317"></a><span id="l5.317" class="difflineminus">-</span>
<a href="#l5.318"></a><span id="l5.318" class="difflineminus">-    rv = msgStore-&gt;GetNewMsgOutputStream(dstFolder, getter_AddRefs(msgHdr), &amp;reusable,</span>
<a href="#l5.319"></a><span id="l5.319" class="difflineminus">-                                         getter_AddRefs(outputStream));</span>
<a href="#l5.320"></a><span id="l5.320" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l5.321"></a><span id="l5.321" class="difflineminus">-    {</span>
<a href="#l5.322"></a><span id="l5.322" class="difflineminus">-      IMPORT_LOG1( &quot;Mbx getting outputstream error: 0x%lx\n&quot;, rv);</span>
<a href="#l5.323"></a><span id="l5.323" class="difflineminus">-      break;</span>
<a href="#l5.324"></a><span id="l5.324" class="difflineminus">-    }</span>
<a href="#l5.325"></a><span id="l5.325" class="difflineminus">-</span>
<a href="#l5.326"></a><span id="l5.326" class="difflineminus">-    if (ReadBytes(inputStream, block, pIndex[i], 16) &amp;&amp; (block[0] == pIndex[i]) &amp;&amp;</span>
<a href="#l5.327"></a><span id="l5.327" class="difflineminus">-      (block[2] &lt; kMailboxBufferSize) &amp;&amp; (ReadBytes(inputStream, pBuffer, kDontSeek, block[2])))</span>
<a href="#l5.328"></a><span id="l5.328" class="difflineminus">-    {</span>
<a href="#l5.329"></a><span id="l5.329" class="difflineminus">-      // block[2] contains the chars in the buffer (ie, buf content size).</span>
<a href="#l5.330"></a><span id="l5.330" class="difflineminus">-      // block[3] contains offset to the next block of data (0 means no more data).</span>
<a href="#l5.331"></a><span id="l5.331" class="difflineminus">-      size = block[2];</span>
<a href="#l5.332"></a><span id="l5.332" class="difflineminus">-      pStart = pBuffer;</span>
<a href="#l5.333"></a><span id="l5.333" class="difflineminus">-      pEnd = pStart + size;</span>
<a href="#l5.334"></a><span id="l5.334" class="difflineminus">-</span>
<a href="#l5.335"></a><span id="l5.335" class="difflineminus">-      // write out the from separator.</span>
<a href="#l5.336"></a><span id="l5.336" class="difflineminus">-      rv = NS_ERROR_FAILURE;</span>
<a href="#l5.337"></a><span id="l5.337" class="difflineminus">-      if (IsFromLine(pBuffer, size))</span>
<a href="#l5.338"></a><span id="l5.338" class="difflineminus">-      {</span>
<a href="#l5.339"></a><span id="l5.339" class="difflineminus">-        char *pChar = pStart;</span>
<a href="#l5.340"></a><span id="l5.340" class="difflineminus">-        while ((pChar &lt; pEnd) &amp;&amp; (*pChar != '\r') &amp;&amp; (*(pChar+1) != '\n'))</span>
<a href="#l5.341"></a><span id="l5.341" class="difflineminus">-          pChar++;</span>
<a href="#l5.342"></a><span id="l5.342" class="difflineminus">-</span>
<a href="#l5.343"></a><span id="l5.343" class="difflineminus">-        if (pChar &lt; pEnd)</span>
<a href="#l5.344"></a><span id="l5.344" class="difflineminus">-        {</span>
<a href="#l5.345"></a><span id="l5.345" class="difflineminus">-          // Get the &quot;From &quot; line so write it out.</span>
<a href="#l5.346"></a><span id="l5.346" class="difflineminus">-          rv = outputStream-&gt;Write(pStart, pChar-pStart+2, &amp;written);</span>
<a href="#l5.347"></a><span id="l5.347" class="difflineminus">-          if (NS_SUCCEEDED(rv))</span>
<a href="#l5.348"></a><span id="l5.348" class="difflineminus">-            // Now buffer starts from the 2nd line.</span>
<a href="#l5.349"></a><span id="l5.349" class="difflineminus">-            pStart = pChar + 2;</span>
<a href="#l5.350"></a><span id="l5.350" class="difflineminus">-        }</span>
<a href="#l5.351"></a><span id="l5.351" class="difflineminus">-      }</span>
<a href="#l5.352"></a><span id="l5.352" class="difflineminus">-      else if (pTime[i])</span>
<a href="#l5.353"></a><span id="l5.353" class="difflineminus">-      {</span>
<a href="#l5.354"></a><span id="l5.354" class="difflineminus">-        char              result[156] = &quot;&quot;;</span>
<a href="#l5.355"></a><span id="l5.355" class="difflineminus">-        PRExplodedTime    xpldTime;</span>
<a href="#l5.356"></a><span id="l5.356" class="difflineminus">-        char              buffer[128] = &quot;&quot;;</span>
<a href="#l5.357"></a><span id="l5.357" class="difflineminus">-        PRTime            prt;</span>
<a href="#l5.358"></a><span id="l5.358" class="difflineminus">-</span>
<a href="#l5.359"></a><span id="l5.359" class="difflineminus">-        nsOE5File::FileTimeToPRTime((FILETIME *)&amp;pTime[i], &amp;prt);</span>
<a href="#l5.360"></a><span id="l5.360" class="difflineminus">-        // modeled after nsMsgSend.cpp</span>
<a href="#l5.361"></a><span id="l5.361" class="difflineminus">-        PR_ExplodeTime(prt, PR_LocalTimeParameters, &amp;xpldTime);</span>
<a href="#l5.362"></a><span id="l5.362" class="difflineminus">-        PR_FormatTimeUSEnglish(buffer, sizeof(buffer),</span>
<a href="#l5.363"></a><span id="l5.363" class="difflineminus">-                                &quot;%a %b %d %H:%M:%S %Y&quot;,</span>
<a href="#l5.364"></a><span id="l5.364" class="difflineminus">-                                &amp;xpldTime);</span>
<a href="#l5.365"></a><span id="l5.365" class="difflineminus">-        PL_strcpy(result, &quot;From - &quot;);</span>
<a href="#l5.366"></a><span id="l5.366" class="difflineminus">-        PL_strcpy(result + 7, buffer);</span>
<a href="#l5.367"></a><span id="l5.367" class="difflineminus">-        PL_strcpy(result + 7 + 24, CRLF);</span>
<a href="#l5.368"></a><span id="l5.368" class="difflineminus">-</span>
<a href="#l5.369"></a><span id="l5.369" class="difflineminus">-        rv = outputStream-&gt;Write(result, (int32_t) strlen(result), &amp;written);</span>
<a href="#l5.370"></a><span id="l5.370" class="difflineminus">-      }</span>
<a href="#l5.371"></a><span id="l5.371" class="difflineminus">-      if (NS_FAILED(rv))</span>
<a href="#l5.372"></a><span id="l5.372" class="difflineminus">-      {</span>
<a href="#l5.373"></a><span id="l5.373" class="difflineminus">-        // Write out the default from line since there is none in the msg.</span>
<a href="#l5.374"></a><span id="l5.374" class="difflineminus">-        rv = outputStream-&gt;Write(m_pFromLineSep, sepLen, &amp;written);</span>
<a href="#l5.375"></a><span id="l5.375" class="difflineminus">-        // FIXME: Do I need to check the return value of written???</span>
<a href="#l5.376"></a><span id="l5.376" class="difflineminus">-        if (NS_FAILED(rv))</span>
<a href="#l5.377"></a><span id="l5.377" class="difflineminus">-          break;</span>
<a href="#l5.378"></a><span id="l5.378" class="difflineminus">-      }</span>
<a href="#l5.379"></a><span id="l5.379" class="difflineminus">-</span>
<a href="#l5.380"></a><span id="l5.380" class="difflineminus">-      char statusLine[50];</span>
<a href="#l5.381"></a><span id="l5.381" class="difflineminus">-      uint32_t msgFlags = XLATFLAGS(pFlags[i]);</span>
<a href="#l5.382"></a><span id="l5.382" class="difflineminus">-      PR_snprintf(statusLine, sizeof(statusLine), X_MOZILLA_STATUS_FORMAT MSG_LINEBREAK, msgFlags &amp; 0xFFFF);</span>
<a href="#l5.383"></a><span id="l5.383" class="difflineminus">-      rv = outputStream-&gt;Write(statusLine, strlen(statusLine), &amp;written);</span>
<a href="#l5.384"></a><span id="l5.384" class="difflineminus">-      NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l5.385"></a><span id="l5.385" class="difflineminus">-      PR_snprintf(statusLine, sizeof(statusLine), X_MOZILLA_STATUS2_FORMAT MSG_LINEBREAK, msgFlags &amp; 0xFFFF0000);</span>
<a href="#l5.386"></a><span id="l5.386" class="difflineminus">-      rv = outputStream-&gt;Write(statusLine, strlen(statusLine), &amp;written);</span>
<a href="#l5.387"></a><span id="l5.387" class="difflineminus">-      NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l5.388"></a><span id="l5.388" class="difflineminus">-</span>
<a href="#l5.389"></a><span id="l5.389" class="difflineminus">-      do</span>
<a href="#l5.390"></a><span id="l5.390" class="difflineminus">-      {</span>
<a href="#l5.391"></a><span id="l5.391" class="difflineminus">-        partialLine.Truncate();</span>
<a href="#l5.392"></a><span id="l5.392" class="difflineminus">-        partialLineStart = pEnd;</span>
<a href="#l5.393"></a><span id="l5.393" class="difflineminus">-</span>
<a href="#l5.394"></a><span id="l5.394" class="difflineminus">-        // If the buffer doesn't end with CRLF then a line is broken into two blocks,</span>
<a href="#l5.395"></a><span id="l5.395" class="difflineminus">-        // so save the incomplete line for later process when we read the next block.</span>
<a href="#l5.396"></a><span id="l5.396" class="difflineminus">-        if ((size &gt; 1) &amp;&amp; !(*(pEnd - 2) == '\r' &amp;&amp; *(pEnd - 1) == '\n'))</span>
<a href="#l5.397"></a><span id="l5.397" class="difflineminus">-        {</span>
<a href="#l5.398"></a><span id="l5.398" class="difflineminus">-          partialLineStart -= 2;</span>
<a href="#l5.399"></a><span id="l5.399" class="difflineminus">-          while ((partialLineStart &gt;= pStart) &amp;&amp; (*partialLineStart != '\r') &amp;&amp; (*(partialLineStart+1) != '\n'))</span>
<a href="#l5.400"></a><span id="l5.400" class="difflineminus">-            partialLineStart--;</span>
<a href="#l5.401"></a><span id="l5.401" class="difflineminus">-          if (partialLineStart != (pEnd - 2))</span>
<a href="#l5.402"></a><span id="l5.402" class="difflineminus">-            partialLineStart += 2; // skip over CRLF if we find them.</span>
<a href="#l5.403"></a><span id="l5.403" class="difflineminus">-          partialLine.Assign(partialLineStart, pEnd - partialLineStart);</span>
<a href="#l5.404"></a><span id="l5.404" class="difflineminus">-        }</span>
<a href="#l5.405"></a><span id="l5.405" class="difflineminus">-</span>
<a href="#l5.406"></a><span id="l5.406" class="difflineminus">-        // Now process the block of data which ends with CRLF.</span>
<a href="#l5.407"></a><span id="l5.407" class="difflineminus">-        rv = EscapeFromSpaceLine(outputStream, pStart, partialLineStart);</span>
<a href="#l5.408"></a><span id="l5.408" class="difflineminus">-        if (NS_FAILED(rv))</span>
<a href="#l5.409"></a><span id="l5.409" class="difflineminus">-          break;</span>
<a href="#l5.410"></a><span id="l5.410" class="difflineminus">-</span>
<a href="#l5.411"></a><span id="l5.411" class="difflineminus">-        didBytes += block[2];</span>
<a href="#l5.412"></a><span id="l5.412" class="difflineminus">-</span>
<a href="#l5.413"></a><span id="l5.413" class="difflineminus">-        next = block[3];</span>
<a href="#l5.414"></a><span id="l5.414" class="difflineminus">-        if (! next)</span>
<a href="#l5.415"></a><span id="l5.415" class="difflineminus">-        {</span>
<a href="#l5.416"></a><span id="l5.416" class="difflineminus">-          // OK, we're done so flush out the partial line if it's not empty.</span>
<a href="#l5.417"></a><span id="l5.417" class="difflineminus">-          if (partialLine.Length())</span>
<a href="#l5.418"></a><span id="l5.418" class="difflineminus">-            rv = EscapeFromSpaceLine(outputStream, (char *)partialLine.get(), (partialLine.get()+partialLine.Length()));</span>
<a href="#l5.419"></a><span id="l5.419" class="difflineminus">-        }</span>
<a href="#l5.420"></a><span id="l5.420" class="difflineminus">-        else</span>
<a href="#l5.421"></a><span id="l5.421" class="difflineminus">-          if (ReadBytes(inputStream, block, next, 16) &amp;&amp; (block[0] == next) &amp;&amp;</span>
<a href="#l5.422"></a><span id="l5.422" class="difflineminus">-            (block[2] &lt; kMailboxBufferSize) &amp;&amp; (ReadBytes(inputStream, pBuffer, kDontSeek, block[2])))</span>
<a href="#l5.423"></a><span id="l5.423" class="difflineminus">-          {</span>
<a href="#l5.424"></a><span id="l5.424" class="difflineminus">-            // See if we have a partial line from previous block. If so then build a complete</span>
<a href="#l5.425"></a><span id="l5.425" class="difflineminus">-            // line (ie, take the remaining chars from this block) and process this line. Need</span>
<a href="#l5.426"></a><span id="l5.426" class="difflineminus">-            // to adjust where data start and size in this case.</span>
<a href="#l5.427"></a><span id="l5.427" class="difflineminus">-            size = block[2];</span>
<a href="#l5.428"></a><span id="l5.428" class="difflineminus">-            pStart = pBuffer;</span>
<a href="#l5.429"></a><span id="l5.429" class="difflineminus">-            pEnd = pStart + size;</span>
<a href="#l5.430"></a><span id="l5.430" class="difflineminus">-            if (partialLine.Length())</span>
<a href="#l5.431"></a><span id="l5.431" class="difflineminus">-            {</span>
<a href="#l5.432"></a><span id="l5.432" class="difflineminus">-              while ((pStart &lt; pEnd) &amp;&amp; (*pStart != '\r') &amp;&amp; (*(pStart+1) != '\n'))</span>
<a href="#l5.433"></a><span id="l5.433" class="difflineminus">-                pStart++;</span>
<a href="#l5.434"></a><span id="l5.434" class="difflineminus">-              if (pStart &lt; pEnd)  // if we found a CRLF ..</span>
<a href="#l5.435"></a><span id="l5.435" class="difflineminus">-                pStart += 2;      // .. then copy that too.</span>
<a href="#l5.436"></a><span id="l5.436" class="difflineminus">-              tempLine.Assign(pBuffer, pStart - pBuffer);</span>
<a href="#l5.437"></a><span id="l5.437" class="difflineminus">-              partialLine.Append(tempLine);</span>
<a href="#l5.438"></a><span id="l5.438" class="difflineminus">-              rv = EscapeFromSpaceLine(outputStream, (char *)partialLine.get(), (partialLine.get()+partialLine.Length()));</span>
<a href="#l5.439"></a><span id="l5.439" class="difflineminus">-              if (NS_FAILED(rv))</span>
<a href="#l5.440"></a><span id="l5.440" class="difflineminus">-                break;</span>
<a href="#l5.441"></a><span id="l5.441" class="difflineminus">-</span>
<a href="#l5.442"></a><span id="l5.442" class="difflineminus">-              // Adjust where data start and size (since some of the data has been processed).</span>
<a href="#l5.443"></a><span id="l5.443" class="difflineminus">-              size -= (pStart - pBuffer);</span>
<a href="#l5.444"></a><span id="l5.444" class="difflineminus">-            }</span>
<a href="#l5.445"></a><span id="l5.445" class="difflineminus">-          }</span>
<a href="#l5.446"></a><span id="l5.446" class="difflineminus">-          else</span>
<a href="#l5.447"></a><span id="l5.447" class="difflineminus">-          {</span>
<a href="#l5.448"></a><span id="l5.448" class="difflineminus">-            IMPORT_LOG2(&quot;Error reading message from %s at 0x%lx\n&quot;, NS_LossyConvertUTF16toASCII(name.get()), pIndex[i]);</span>
<a href="#l5.449"></a><span id="l5.449" class="difflineminus">-            rv = outputStream-&gt;Write(&quot;\x0D\x0A&quot;, 2, &amp;written);</span>
<a href="#l5.450"></a><span id="l5.450" class="difflineminus">-            next = 0;</span>
<a href="#l5.451"></a><span id="l5.451" class="difflineminus">-          }</span>
<a href="#l5.452"></a><span id="l5.452" class="difflineminus">-      } while (next);</span>
<a href="#l5.453"></a><span id="l5.453" class="difflineminus">-</span>
<a href="#l5.454"></a><span id="l5.454" class="difflineminus">-      // Always end a msg with CRLF. This will make sure that OE msgs without body is</span>
<a href="#l5.455"></a><span id="l5.455" class="difflineminus">-      // correctly recognized as msgs. Otherwise, we'll end up with the following in</span>
<a href="#l5.456"></a><span id="l5.456" class="difflineminus">-      // the msg folder where the 2nd msg starts right after the headers of the 1st msg:</span>
<a href="#l5.457"></a><span id="l5.457" class="difflineminus">-      //</span>
<a href="#l5.458"></a><span id="l5.458" class="difflineminus">-      // From - Jan 1965 00:00:00     &lt;&lt;&lt;--- 1st msg starts here</span>
<a href="#l5.459"></a><span id="l5.459" class="difflineminus">-      // Subject: Test msg</span>
<a href="#l5.460"></a><span id="l5.460" class="difflineminus">-      // . . . (more headers)</span>
<a href="#l5.461"></a><span id="l5.461" class="difflineminus">-      // To: &lt;someone@example.com&gt;</span>
<a href="#l5.462"></a><span id="l5.462" class="difflineminus">-      // From - Jan 1965 00:00:00     &lt;&lt;&lt;--- 2nd msg starts here</span>
<a href="#l5.463"></a><span id="l5.463" class="difflineminus">-      // Subject: How are you</span>
<a href="#l5.464"></a><span id="l5.464" class="difflineminus">-      // . . .(more headers)</span>
<a href="#l5.465"></a><span id="l5.465" class="difflineminus">-      //</span>
<a href="#l5.466"></a><span id="l5.466" class="difflineminus">-      // In this case, the 1st msg is not recognized as a msg (it's skipped)</span>
<a href="#l5.467"></a><span id="l5.467" class="difflineminus">-      // when you open the folder.</span>
<a href="#l5.468"></a><span id="l5.468" class="difflineminus">-      rv = outputStream-&gt;Write(&quot;\x0D\x0A&quot;, 2, &amp;written);</span>
<a href="#l5.469"></a><span id="l5.469" class="difflineminus">-</span>
<a href="#l5.470"></a><span id="l5.470" class="difflineminus">-      if (NS_FAILED(rv)) {</span>
<a href="#l5.471"></a><span id="l5.471" class="difflineminus">-        IMPORT_LOG0( &quot;Error writing message during OE import\n&quot;);</span>
<a href="#l5.472"></a><span id="l5.472" class="difflineminus">-        msgStore-&gt;DiscardNewMessage(outputStream, msgHdr);</span>
<a href="#l5.473"></a><span id="l5.473" class="difflineminus">-        break;</span>
<a href="#l5.474"></a><span id="l5.474" class="difflineminus">-      }</span>
<a href="#l5.475"></a><span id="l5.475" class="difflineminus">-</span>
<a href="#l5.476"></a><span id="l5.476" class="difflineminus">-      msgStore-&gt;FinishNewMessage(outputStream, msgHdr);</span>
<a href="#l5.477"></a><span id="l5.477" class="difflineminus">-</span>
<a href="#l5.478"></a><span id="l5.478" class="difflineminus">-      if (!reusable)</span>
<a href="#l5.479"></a><span id="l5.479" class="difflineminus">-        outputStream-&gt;Close();</span>
<a href="#l5.480"></a><span id="l5.480" class="difflineminus">-</span>
<a href="#l5.481"></a><span id="l5.481" class="difflineminus">-      msgCount++;</span>
<a href="#l5.482"></a><span id="l5.482" class="difflineminus">-      if (pCount)</span>
<a href="#l5.483"></a><span id="l5.483" class="difflineminus">-        *pCount = msgCount;</span>
<a href="#l5.484"></a><span id="l5.484" class="difflineminus">-      if (pBytesDone)</span>
<a href="#l5.485"></a><span id="l5.485" class="difflineminus">-        *pBytesDone = didBytes;</span>
<a href="#l5.486"></a><span id="l5.486" class="difflineminus">-    }</span>
<a href="#l5.487"></a><span id="l5.487" class="difflineminus">-    else {</span>
<a href="#l5.488"></a><span id="l5.488" class="difflineminus">-      // Error reading message, should this be logged???</span>
<a href="#l5.489"></a><span id="l5.489" class="difflineminus">-      IMPORT_LOG2(&quot;Error reading message from %s at 0x%lx\n&quot;, NS_LossyConvertUTF16toASCII(name.get()), pIndex[i]);</span>
<a href="#l5.490"></a><span id="l5.490" class="difflineminus">-      *pAbort = true;</span>
<a href="#l5.491"></a><span id="l5.491" class="difflineminus">-    }</span>
<a href="#l5.492"></a><span id="l5.492" class="difflineminus">-  }</span>
<a href="#l5.493"></a><span id="l5.493" class="difflineminus">-  if (outputStream)</span>
<a href="#l5.494"></a><span id="l5.494" class="difflineminus">-    outputStream-&gt;Close();</span>
<a href="#l5.495"></a><span id="l5.495" class="difflineminus">-  delete [] pBuffer;</span>
<a href="#l5.496"></a><span id="l5.496" class="difflineminus">-  delete [] pFlags;</span>
<a href="#l5.497"></a><span id="l5.497" class="difflineminus">-  delete [] pTime;</span>
<a href="#l5.498"></a><span id="l5.498" class="difflineminus">-</span>
<a href="#l5.499"></a><span id="l5.499" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l5.500"></a><span id="l5.500" class="difflineminus">-    *pAbort = true;</span>
<a href="#l5.501"></a><span id="l5.501" class="difflineminus">-</span>
<a href="#l5.502"></a><span id="l5.502" class="difflineminus">-  return rv;</span>
<a href="#l5.503"></a><span id="l5.503" class="difflineminus">-}</span>
<a href="#l5.504"></a><span id="l5.504" class="difflineminus">-</span>
<a href="#l5.505"></a><span id="l5.505" class="difflineminus">-</span>
<a href="#l5.506"></a><span id="l5.506" class="difflineminus">-/*</span>
<a href="#l5.507"></a><span id="l5.507" class="difflineminus">-  A message index record consists of:</span>
<a href="#l5.508"></a><span id="l5.508" class="difflineminus">-  4 byte marker - matches record offset</span>
<a href="#l5.509"></a><span id="l5.509" class="difflineminus">-  4 bytes size - size of data after this header</span>
<a href="#l5.510"></a><span id="l5.510" class="difflineminus">-  2 bytes header length - not dependable</span>
<a href="#l5.511"></a><span id="l5.511" class="difflineminus">-  1 bytes - number of attributes</span>
<a href="#l5.512"></a><span id="l5.512" class="difflineminus">-  1 byte changes on this object</span>
<a href="#l5.513"></a><span id="l5.513" class="difflineminus">-  Each attribute is a 4 byte value with the 1st byte being the tag</span>
<a href="#l5.514"></a><span id="l5.514" class="difflineminus">-  and the remaing 3 bytes being data.  The data is either a direct</span>
<a href="#l5.515"></a><span id="l5.515" class="difflineminus">-  offset of an offset within the message index that points to the</span>
<a href="#l5.516"></a><span id="l5.516" class="difflineminus">-  data for the tag.</span>
<a href="#l5.517"></a><span id="l5.517" class="difflineminus">-  attr[0]:</span>
<a href="#l5.518"></a><span id="l5.518" class="difflineminus">-  -hi bit== 1 means PRUint24 data = attr[1]</span>
<a href="#l5.519"></a><span id="l5.519" class="difflineminus">-  -hi bit== 0 means (PRUint24) attr[1] = offset into data segment for data</span>
<a href="#l5.520"></a><span id="l5.520" class="difflineminus">-  -attr[0] &amp; 7f == tag index</span>
<a href="#l5.521"></a><span id="l5.521" class="difflineminus">-  Header above is 0xC bytes, attr's are number * 4 bytes then follows data segment</span>
<a href="#l5.522"></a><span id="l5.522" class="difflineminus">-  The data segment length is undefined. The index data is either part of the </span>
<a href="#l5.523"></a><span id="l5.523" class="difflineminus">-  index structure or the index structure points to address in data that follows</span>
<a href="#l5.524"></a><span id="l5.524" class="difflineminus">-  index structure table. Use that location to calculate file position of data.</span>
<a href="#l5.525"></a><span id="l5.525" class="difflineminus">-  MSDN indicates 0x28 attributes possible.</span>
<a href="#l5.526"></a><span id="l5.526" class="difflineminus">-</span>
<a href="#l5.527"></a><span id="l5.527" class="difflineminus">-  Current known tags are:</span>
<a href="#l5.528"></a><span id="l5.528" class="difflineminus">-  0x01 - flags addressed</span>
<a href="#l5.529"></a><span id="l5.529" class="difflineminus">-  0x81 - flags in attr's next 3 bytes</span>
<a href="#l5.530"></a><span id="l5.530" class="difflineminus">-  0x02 - a time value - addressed- 8 bytes</span>
<a href="#l5.531"></a><span id="l5.531" class="difflineminus">-  0x04 - text offset pointer, the data is the offset after the attribute</span>
<a href="#l5.532"></a><span id="l5.532" class="difflineminus">-         of a 4 byte pointer to the message text &lt;-- addr into data</span>
<a href="#l5.533"></a><span id="l5.533" class="difflineminus">-  0x05 - offset to truncated subject</span>
<a href="#l5.534"></a><span id="l5.534" class="difflineminus">-  0x08 - offste to subject</span>
<a href="#l5.535"></a><span id="l5.535" class="difflineminus">-  0x0D - offset to from</span>
<a href="#l5.536"></a><span id="l5.536" class="difflineminus">-  0x0E - offset to from addresses</span>
<a href="#l5.537"></a><span id="l5.537" class="difflineminus">-  0x13 - offset to to name</span>
<a href="#l5.538"></a><span id="l5.538" class="difflineminus">-  0x45 - offset to to address &lt;----correct --&gt; 0x14</span>
<a href="#l5.539"></a><span id="l5.539" class="difflineminus">-  0x80 - msgId &lt;-correction-&gt; 0x07 addr to msg id</span>
<a href="#l5.540"></a><span id="l5.540" class="difflineminus">-  0x84 - direct text offset, direct pointer to message text</span>
<a href="#l5.541"></a><span id="l5.541" class="difflineminus">-*/</span>
<a href="#l5.542"></a><span id="l5.542" class="difflineminus">-</span>
<a href="#l5.543"></a><span id="l5.543" class="difflineminus">-void nsOE5File::ConvertIndex(nsIInputStream *pFile, char *pBuffer,</span>
<a href="#l5.544"></a><span id="l5.544" class="difflineminus">-                              uint32_t *pIndex, uint32_t size,</span>
<a href="#l5.545"></a><span id="l5.545" class="difflineminus">-                              uint32_t *pFlags, uint64_t *pTime)</span>
<a href="#l5.546"></a><span id="l5.546" class="difflineminus">-{</span>
<a href="#l5.547"></a><span id="l5.547" class="difflineminus">-  // for each index record, get the actual message offset!  If there is a</span>
<a href="#l5.548"></a><span id="l5.548" class="difflineminus">-  // problem just record the message offset as 0 and the message reading code</span>
<a href="#l5.549"></a><span id="l5.549" class="difflineminus">-  // can log that error information.</span>
<a href="#l5.550"></a><span id="l5.550" class="difflineminus">-  // XXXTODO- above error reporting is not done</span>
<a href="#l5.551"></a><span id="l5.551" class="difflineminus">-</span>
<a href="#l5.552"></a><span id="l5.552" class="difflineminus">-  uint8_t   recordHead[12];</span>
<a href="#l5.553"></a><span id="l5.553" class="difflineminus">-  uint32_t  marker;</span>
<a href="#l5.554"></a><span id="l5.554" class="difflineminus">-  uint32_t  recordSize;</span>
<a href="#l5.555"></a><span id="l5.555" class="difflineminus">-  uint32_t  numAttrs;</span>
<a href="#l5.556"></a><span id="l5.556" class="difflineminus">-  uint32_t  offset;</span>
<a href="#l5.557"></a><span id="l5.557" class="difflineminus">-  uint32_t  attrIndex;</span>
<a href="#l5.558"></a><span id="l5.558" class="difflineminus">-  uint32_t  attrOffset;</span>
<a href="#l5.559"></a><span id="l5.559" class="difflineminus">-  uint8_t   tag;</span>
<a href="#l5.560"></a><span id="l5.560" class="difflineminus">-  uint32_t  tagData;</span>
<a href="#l5.561"></a><span id="l5.561" class="difflineminus">-  uint32_t  flags;</span>
<a href="#l5.562"></a><span id="l5.562" class="difflineminus">-  uint64_t  time;</span>
<a href="#l5.563"></a><span id="l5.563" class="difflineminus">-  uint32_t  dataStart;</span>
<a href="#l5.564"></a><span id="l5.564" class="difflineminus">-</span>
<a href="#l5.565"></a><span id="l5.565" class="difflineminus">-  for (uint32_t i = 0; i &lt; size; i++) {</span>
<a href="#l5.566"></a><span id="l5.566" class="difflineminus">-    offset = 0;</span>
<a href="#l5.567"></a><span id="l5.567" class="difflineminus">-    flags = 0;</span>
<a href="#l5.568"></a><span id="l5.568" class="difflineminus">-    time = 0;</span>
<a href="#l5.569"></a><span id="l5.569" class="difflineminus">-    if (ReadBytes(pFile, recordHead, pIndex[i], 12)) {</span>
<a href="#l5.570"></a><span id="l5.570" class="difflineminus">-      memcpy(&amp;marker, recordHead, 4);</span>
<a href="#l5.571"></a><span id="l5.571" class="difflineminus">-      memcpy(&amp;recordSize, recordHead + 4, 4);</span>
<a href="#l5.572"></a><span id="l5.572" class="difflineminus">-      numAttrs = (uint32_t) recordHead[10];</span>
<a href="#l5.573"></a><span id="l5.573" class="difflineminus">-      if (marker == pIndex[i] &amp;&amp; numAttrs &lt;= kMaxAttrCount) {</span>
<a href="#l5.574"></a><span id="l5.574" class="difflineminus">-        dataStart = pIndex[i] + 12 + (numAttrs * 4);</span>
<a href="#l5.575"></a><span id="l5.575" class="difflineminus">-        if (ReadBytes(pFile, pBuffer, kDontSeek, numAttrs * 4)) {</span>
<a href="#l5.576"></a><span id="l5.576" class="difflineminus">-          attrOffset = 0;</span>
<a href="#l5.577"></a><span id="l5.577" class="difflineminus">-          for (attrIndex = 0; attrIndex &lt; numAttrs; attrIndex++, attrOffset += 4) {</span>
<a href="#l5.578"></a><span id="l5.578" class="difflineminus">-            tag = (uint8_t) pBuffer[attrOffset];</span>
<a href="#l5.579"></a><span id="l5.579" class="difflineminus">-            if (tag == (uint8_t) 0x84) {</span>
<a href="#l5.580"></a><span id="l5.580" class="difflineminus">-              tagData = 0;</span>
<a href="#l5.581"></a><span id="l5.581" class="difflineminus">-              memcpy(&amp;tagData, pBuffer + attrOffset + 1, 3);</span>
<a href="#l5.582"></a><span id="l5.582" class="difflineminus">-              offset = tagData;</span>
<a href="#l5.583"></a><span id="l5.583" class="difflineminus">-            }</span>
<a href="#l5.584"></a><span id="l5.584" class="difflineminus">-            else if (tag == (uint8_t) 0x04) {</span>
<a href="#l5.585"></a><span id="l5.585" class="difflineminus">-              tagData = 0;</span>
<a href="#l5.586"></a><span id="l5.586" class="difflineminus">-              memcpy(&amp;tagData, pBuffer + attrOffset + 1, 3);</span>
<a href="#l5.587"></a><span id="l5.587" class="difflineminus">-              ReadBytes(pFile, &amp;offset, dataStart + tagData, 4);</span>
<a href="#l5.588"></a><span id="l5.588" class="difflineminus">-            }</span>
<a href="#l5.589"></a><span id="l5.589" class="difflineminus">-            else if (tag == (uint8_t) 0x81) {</span>
<a href="#l5.590"></a><span id="l5.590" class="difflineminus">-              tagData = 0;</span>
<a href="#l5.591"></a><span id="l5.591" class="difflineminus">-              memcpy(&amp;tagData, pBuffer + attrOffset +1, 3);</span>
<a href="#l5.592"></a><span id="l5.592" class="difflineminus">-              flags = tagData;</span>
<a href="#l5.593"></a><span id="l5.593" class="difflineminus">-            }</span>
<a href="#l5.594"></a><span id="l5.594" class="difflineminus">-            else if (tag == (uint8_t) 0x01) {</span>
<a href="#l5.595"></a><span id="l5.595" class="difflineminus">-              tagData = 0;</span>
<a href="#l5.596"></a><span id="l5.596" class="difflineminus">-              memcpy(&amp;tagData, pBuffer + attrOffset +1, 3);</span>
<a href="#l5.597"></a><span id="l5.597" class="difflineminus">-              ReadBytes(pFile, &amp;flags, dataStart + tagData, 4);</span>
<a href="#l5.598"></a><span id="l5.598" class="difflineminus">-            }</span>
<a href="#l5.599"></a><span id="l5.599" class="difflineminus">-            else if (tag == (uint8_t) 0x02) {</span>
<a href="#l5.600"></a><span id="l5.600" class="difflineminus">-              tagData = 0;</span>
<a href="#l5.601"></a><span id="l5.601" class="difflineminus">-              memcpy(&amp;tagData, pBuffer + attrOffset +1, 3);</span>
<a href="#l5.602"></a><span id="l5.602" class="difflineminus">-              ReadBytes(pFile, &amp;time, dataStart + tagData, 4);</span>
<a href="#l5.603"></a><span id="l5.603" class="difflineminus">-            }</span>
<a href="#l5.604"></a><span id="l5.604" class="difflineminus">-          }</span>
<a href="#l5.605"></a><span id="l5.605" class="difflineminus">-        }</span>
<a href="#l5.606"></a><span id="l5.606" class="difflineminus">-      }</span>
<a href="#l5.607"></a><span id="l5.607" class="difflineminus">-    }</span>
<a href="#l5.608"></a><span id="l5.608" class="difflineminus">-    pIndex[i] = offset;</span>
<a href="#l5.609"></a><span id="l5.609" class="difflineminus">-    pFlags[i] = flags;</span>
<a href="#l5.610"></a><span id="l5.610" class="difflineminus">-    pTime[i] = time;</span>
<a href="#l5.611"></a><span id="l5.611" class="difflineminus">-  }</span>
<a href="#l5.612"></a><span id="l5.612" class="difflineminus">-}</span>
<a href="#l5.613"></a><span id="l5.613" class="difflineminus">-</span>
<a href="#l5.614"></a><span id="l5.614" class="difflineminus">-</span>
<a href="#l5.615"></a><span id="l5.615" class="difflineminus">-bool nsOE5File::ReadBytes(nsIInputStream *stream, void *pBuffer, uint32_t offset, uint32_t bytes)</span>
<a href="#l5.616"></a><span id="l5.616" class="difflineminus">-{</span>
<a href="#l5.617"></a><span id="l5.617" class="difflineminus">-  nsresult  rv;</span>
<a href="#l5.618"></a><span id="l5.618" class="difflineminus">-</span>
<a href="#l5.619"></a><span id="l5.619" class="difflineminus">-  nsCOMPtr &lt;nsISeekableStream&gt; seekableStream = do_QueryInterface(stream);</span>
<a href="#l5.620"></a><span id="l5.620" class="difflineminus">-  if (offset != kDontSeek) {</span>
<a href="#l5.621"></a><span id="l5.621" class="difflineminus">-    rv = seekableStream-&gt;Seek(nsISeekableStream::NS_SEEK_SET, offset);</span>
<a href="#l5.622"></a><span id="l5.622" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l5.623"></a><span id="l5.623" class="difflineminus">-      return false;</span>
<a href="#l5.624"></a><span id="l5.624" class="difflineminus">-  }</span>
<a href="#l5.625"></a><span id="l5.625" class="difflineminus">-</span>
<a href="#l5.626"></a><span id="l5.626" class="difflineminus">-  if (!bytes)</span>
<a href="#l5.627"></a><span id="l5.627" class="difflineminus">-    return true;</span>
<a href="#l5.628"></a><span id="l5.628" class="difflineminus">-</span>
<a href="#l5.629"></a><span id="l5.629" class="difflineminus">-  uint32_t  cntRead;</span>
<a href="#l5.630"></a><span id="l5.630" class="difflineminus">-  char *  pReadTo = (char *)pBuffer;</span>
<a href="#l5.631"></a><span id="l5.631" class="difflineminus">-  rv = stream-&gt;Read(pReadTo, bytes, &amp;cntRead);</span>
<a href="#l5.632"></a><span id="l5.632" class="difflineminus">-  return NS_SUCCEEDED(rv) &amp;&amp; cntRead == bytes;</span>
<a href="#l5.633"></a><span id="l5.633" class="difflineminus">-</span>
<a href="#l5.634"></a><span id="l5.634" class="difflineminus">-}</span>
<a href="#l5.635"></a><span id="l5.635" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1">deleted file mode 100644</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineminus">--- a/mailnews/import/oexpress/nsOE5File.h</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineplus">+++ /dev/null</span>
<a href="#l6.4"></a><span id="l6.4" class="difflineat">@@ -1,52 +0,0 @@</span>
<a href="#l6.5"></a><span id="l6.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l6.6"></a><span id="l6.6" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l6.7"></a><span id="l6.7" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l6.8"></a><span id="l6.8" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l6.9"></a><span id="l6.9" class="difflineminus">-</span>
<a href="#l6.10"></a><span id="l6.10" class="difflineminus">-#ifndef nsOE5File_h___</span>
<a href="#l6.11"></a><span id="l6.11" class="difflineminus">-#define nsOE5File_h___</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">-#include &quot;nsStringGlue.h&quot;</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineminus">-#include &quot;nsIFile.h&quot;</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineminus">-#include &quot;nsIMsgFolder.h&quot;</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineminus">-#include &lt;windows.h&gt;</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineminus">-</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineminus">-class nsIInputStream;</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineminus">-</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineminus">-class nsOE5File</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineminus">-{</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineminus">-public:</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineminus">-    /* pFile must already be open for reading. */</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineminus">-  static bool    VerifyLocalMailFile(nsIFile *pFile);</span>
<a href="#l6.25"></a><span id="l6.25" class="difflineminus">-    /* pFile must NOT be open for reading   */</span>
<a href="#l6.26"></a><span id="l6.26" class="difflineminus">-  static bool    IsLocalMailFile(nsIFile *pFile);</span>
<a href="#l6.27"></a><span id="l6.27" class="difflineminus">-</span>
<a href="#l6.28"></a><span id="l6.28" class="difflineminus">-  static bool    ReadIndex(nsIInputStream *pFile, uint32_t **ppIndex, uint32_t *pSize);</span>
<a href="#l6.29"></a><span id="l6.29" class="difflineminus">-</span>
<a href="#l6.30"></a><span id="l6.30" class="difflineminus">-  static nsresult ImportMailbox(uint32_t *pBytesDone, bool *pAbort,</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineminus">-                                nsString&amp; name, nsIFile *inFile,</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineminus">-                                nsIMsgFolder *pDstFolder, uint32_t *pCount);</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineminus">-</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineminus">-  static void FileTimeToPRTime(const FILETIME *filetime, PRTime *prtm);</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineminus">-</span>
<a href="#l6.36"></a><span id="l6.36" class="difflineminus">-private:</span>
<a href="#l6.37"></a><span id="l6.37" class="difflineminus">-  typedef struct {</span>
<a href="#l6.38"></a><span id="l6.38" class="difflineminus">-    uint32_t *  pIndex;</span>
<a href="#l6.39"></a><span id="l6.39" class="difflineminus">-    uint32_t  count;</span>
<a href="#l6.40"></a><span id="l6.40" class="difflineminus">-    uint32_t  alloc;</span>
<a href="#l6.41"></a><span id="l6.41" class="difflineminus">-  } PRUint32Array;</span>
<a href="#l6.42"></a><span id="l6.42" class="difflineminus">-</span>
<a href="#l6.43"></a><span id="l6.43" class="difflineminus">-  static const char *m_pFromLineSep;</span>
<a href="#l6.44"></a><span id="l6.44" class="difflineminus">-</span>
<a href="#l6.45"></a><span id="l6.45" class="difflineminus">-  static bool    ReadBytes(nsIInputStream *stream, void *pBuffer, uint32_t offset, uint32_t bytes);</span>
<a href="#l6.46"></a><span id="l6.46" class="difflineminus">-  static uint32_t ReadMsgIndex(nsIInputStream *file, uint32_t offset, PRUint32Array *pArray);</span>
<a href="#l6.47"></a><span id="l6.47" class="difflineminus">-  static void  ConvertIndex(nsIInputStream *pFile, char *pBuffer, uint32_t *pIndex,</span>
<a href="#l6.48"></a><span id="l6.48" class="difflineminus">-                            uint32_t size, uint32_t *pFlags, uint64_t *pTime);</span>
<a href="#l6.49"></a><span id="l6.49" class="difflineminus">-  static bool    IsFromLine(char *pLine, uint32_t len);</span>
<a href="#l6.50"></a><span id="l6.50" class="difflineminus">-</span>
<a href="#l6.51"></a><span id="l6.51" class="difflineminus">-</span>
<a href="#l6.52"></a><span id="l6.52" class="difflineminus">-};</span>
<a href="#l6.53"></a><span id="l6.53" class="difflineminus">-</span>
<a href="#l6.54"></a><span id="l6.54" class="difflineminus">-</span>
<a href="#l6.55"></a><span id="l6.55" class="difflineminus">-</span>
<a href="#l6.56"></a><span id="l6.56" class="difflineminus">-#endif /* nsOE5File_h___ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1">deleted file mode 100644</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineminus">--- a/mailnews/import/oexpress/nsOEAddressIterator.cpp</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineplus">+++ /dev/null</span>
<a href="#l7.4"></a><span id="l7.4" class="difflineat">@@ -1,396 +0,0 @@</span>
<a href="#l7.5"></a><span id="l7.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l7.6"></a><span id="l7.6" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l7.7"></a><span id="l7.7" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l7.8"></a><span id="l7.8" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l7.9"></a><span id="l7.9" class="difflineminus">-</span>
<a href="#l7.10"></a><span id="l7.10" class="difflineminus">-</span>
<a href="#l7.11"></a><span id="l7.11" class="difflineminus">-/*</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineminus">-  A sample of XPConnect. This file contains an implementation of</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineminus">-  nsISample.</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineminus">-</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineminus">-*/</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineminus">-#include &quot;nscore.h&quot;</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineminus">-#include &quot;nsCOMPtr.h&quot;</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineminus">-#include &quot;nsStringGlue.h&quot;</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineminus">-#include &quot;nsMsgUtils.h&quot;</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineminus">-#include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineminus">-#include &quot;nsIServiceManager.h&quot;</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineminus">-#include &quot;nsIImportService.h&quot;</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineminus">-#include &quot;nsIImportFieldMap.h&quot;</span>
<a href="#l7.25"></a><span id="l7.25" class="difflineminus">-#include &quot;nsABBaseCID.h&quot;</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineminus">-#include &quot;nsIAbCard.h&quot;</span>
<a href="#l7.27"></a><span id="l7.27" class="difflineminus">-#include &quot;prprf.h&quot;</span>
<a href="#l7.28"></a><span id="l7.28" class="difflineminus">-</span>
<a href="#l7.29"></a><span id="l7.29" class="difflineminus">-#include &quot;nsOEAddressIterator.h&quot;</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineminus">-</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineminus">-#include &quot;OEDebugLog.h&quot;</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineminus">-</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineminus">-typedef struct {</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineminus">-  int32_t    mozField;</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineminus">-  int32_t    multiLine;</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineminus">-  ULONG    mapiTag;</span>
<a href="#l7.37"></a><span id="l7.37" class="difflineminus">-} MAPIFields;</span>
<a href="#l7.38"></a><span id="l7.38" class="difflineminus">-</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineminus">-enum {</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineminus">-  ieidPR_DISPLAY_NAME = 0,</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineminus">-  ieidPR_ENTRYID,</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineminus">-  ieidPR_OBJECT_TYPE,</span>
<a href="#l7.43"></a><span id="l7.43" class="difflineminus">-  ieidMax</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineminus">-};</span>
<a href="#l7.45"></a><span id="l7.45" class="difflineminus">-</span>
<a href="#l7.46"></a><span id="l7.46" class="difflineminus">-/*</span>
<a href="#l7.47"></a><span id="l7.47" class="difflineminus">-  Fields in MAPI, not in Mozilla</span>
<a href="#l7.48"></a><span id="l7.48" class="difflineminus">-  PR_OFFICE_LOCATION</span>
<a href="#l7.49"></a><span id="l7.49" class="difflineminus">-  FIX - PR_BIRTHDAY - stored as PT_SYSTIME - FIX to extract for moz address book birthday</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineminus">-  PR_DISPLAY_NAME_PREFIX - Mr., Mrs. Dr., etc.</span>
<a href="#l7.51"></a><span id="l7.51" class="difflineminus">-  PR_SPOUSE_NAME</span>
<a href="#l7.52"></a><span id="l7.52" class="difflineminus">-  PR_GENDER - integer, not text</span>
<a href="#l7.53"></a><span id="l7.53" class="difflineminus">-  FIX - PR_CONTACT_EMAIL_ADDRESSES - multiuline strings for email addresses, needs</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineminus">-    parsing to get secondary email address for mozilla</span>
<a href="#l7.55"></a><span id="l7.55" class="difflineminus">-*/</span>
<a href="#l7.56"></a><span id="l7.56" class="difflineminus">-</span>
<a href="#l7.57"></a><span id="l7.57" class="difflineminus">-#define kIsMultiLine  -2</span>
<a href="#l7.58"></a><span id="l7.58" class="difflineminus">-#define  kNoMultiLine  -1</span>
<a href="#l7.59"></a><span id="l7.59" class="difflineminus">-</span>
<a href="#l7.60"></a><span id="l7.60" class="difflineminus">-static MAPIFields  gMapiFields[] = {</span>
<a href="#l7.61"></a><span id="l7.61" class="difflineminus">-  { 35, kIsMultiLine, PR_COMMENT},</span>
<a href="#l7.62"></a><span id="l7.62" class="difflineminus">-  { 6, kNoMultiLine, PR_BUSINESS_TELEPHONE_NUMBER},</span>
<a href="#l7.63"></a><span id="l7.63" class="difflineminus">-  { 7, kNoMultiLine, PR_HOME_TELEPHONE_NUMBER},</span>
<a href="#l7.64"></a><span id="l7.64" class="difflineminus">-  { 25, kNoMultiLine, PR_COMPANY_NAME},</span>
<a href="#l7.65"></a><span id="l7.65" class="difflineminus">-  { 23, kNoMultiLine, PR_TITLE},</span>
<a href="#l7.66"></a><span id="l7.66" class="difflineminus">-  { 10, kNoMultiLine, PR_CELLULAR_TELEPHONE_NUMBER},</span>
<a href="#l7.67"></a><span id="l7.67" class="difflineminus">-  { 9, kNoMultiLine, PR_PAGER_TELEPHONE_NUMBER},</span>
<a href="#l7.68"></a><span id="l7.68" class="difflineminus">-  { 8, kNoMultiLine, PR_BUSINESS_FAX_NUMBER},</span>
<a href="#l7.69"></a><span id="l7.69" class="difflineminus">-  { 8, kNoMultiLine, PR_HOME_FAX_NUMBER},</span>
<a href="#l7.70"></a><span id="l7.70" class="difflineminus">-  { 22, kNoMultiLine, PR_COUNTRY},</span>
<a href="#l7.71"></a><span id="l7.71" class="difflineminus">-  { 19, kNoMultiLine, PR_LOCALITY},</span>
<a href="#l7.72"></a><span id="l7.72" class="difflineminus">-  { 20, kNoMultiLine, PR_STATE_OR_PROVINCE},</span>
<a href="#l7.73"></a><span id="l7.73" class="difflineminus">-  { 17, 18, PR_STREET_ADDRESS},</span>
<a href="#l7.74"></a><span id="l7.74" class="difflineminus">-  { 21, kNoMultiLine, PR_POSTAL_CODE},</span>
<a href="#l7.75"></a><span id="l7.75" class="difflineminus">-  { 27, kNoMultiLine, PR_PERSONAL_HOME_PAGE},</span>
<a href="#l7.76"></a><span id="l7.76" class="difflineminus">-  { 26, kNoMultiLine, PR_BUSINESS_HOME_PAGE},</span>
<a href="#l7.77"></a><span id="l7.77" class="difflineminus">-  { 13, kNoMultiLine, PR_HOME_ADDRESS_CITY},</span>
<a href="#l7.78"></a><span id="l7.78" class="difflineminus">-  { 16, kNoMultiLine, PR_HOME_ADDRESS_COUNTRY},</span>
<a href="#l7.79"></a><span id="l7.79" class="difflineminus">-  { 15, kNoMultiLine, PR_HOME_ADDRESS_POSTAL_CODE},</span>
<a href="#l7.80"></a><span id="l7.80" class="difflineminus">-  { 14, kNoMultiLine, PR_HOME_ADDRESS_STATE_OR_PROVINCE},</span>
<a href="#l7.81"></a><span id="l7.81" class="difflineminus">-  { 11, 12, PR_HOME_ADDRESS_STREET},</span>
<a href="#l7.82"></a><span id="l7.82" class="difflineminus">-  { 24, kNoMultiLine, PR_DEPARTMENT_NAME}</span>
<a href="#l7.83"></a><span id="l7.83" class="difflineminus">-};</span>
<a href="#l7.84"></a><span id="l7.84" class="difflineminus">-</span>
<a href="#l7.85"></a><span id="l7.85" class="difflineminus">-nsOEAddressIterator::nsOEAddressIterator(CWAB *pWab, nsIAddrDatabase *database)</span>
<a href="#l7.86"></a><span id="l7.86" class="difflineminus">-{</span>
<a href="#l7.87"></a><span id="l7.87" class="difflineminus">-  m_pWab = pWab;</span>
<a href="#l7.88"></a><span id="l7.88" class="difflineminus">-  m_database = database;</span>
<a href="#l7.89"></a><span id="l7.89" class="difflineminus">-}</span>
<a href="#l7.90"></a><span id="l7.90" class="difflineminus">-</span>
<a href="#l7.91"></a><span id="l7.91" class="difflineminus">-nsOEAddressIterator::~nsOEAddressIterator()</span>
<a href="#l7.92"></a><span id="l7.92" class="difflineminus">-{</span>
<a href="#l7.93"></a><span id="l7.93" class="difflineminus">-}</span>
<a href="#l7.94"></a><span id="l7.94" class="difflineminus">-</span>
<a href="#l7.95"></a><span id="l7.95" class="difflineminus">-nsresult nsOEAddressIterator::EnumUser(const char16_t * pName, LPENTRYID pEid, ULONG cbEid)</span>
<a href="#l7.96"></a><span id="l7.96" class="difflineminus">-{</span>
<a href="#l7.97"></a><span id="l7.97" class="difflineminus">-  IMPORT_LOG1(&quot;User: %S\n&quot;, pName);</span>
<a href="#l7.98"></a><span id="l7.98" class="difflineminus">-  nsresult   rv = NS_OK;</span>
<a href="#l7.99"></a><span id="l7.99" class="difflineminus">-  </span>
<a href="#l7.100"></a><span id="l7.100" class="difflineminus">-  if (m_database) {</span>
<a href="#l7.101"></a><span id="l7.101" class="difflineminus">-    LPMAILUSER  pUser = m_pWab-&gt;GetUser(cbEid, pEid);</span>
<a href="#l7.102"></a><span id="l7.102" class="difflineminus">-    if (pUser) {</span>
<a href="#l7.103"></a><span id="l7.103" class="difflineminus">-      // Get a new row from the database!</span>
<a href="#l7.104"></a><span id="l7.104" class="difflineminus">-      nsCOMPtr &lt;nsIMdbRow&gt; newRow;</span>
<a href="#l7.105"></a><span id="l7.105" class="difflineminus">-      rv = m_database-&gt;GetNewRow(getter_AddRefs(newRow));</span>
<a href="#l7.106"></a><span id="l7.106" class="difflineminus">-      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.107"></a><span id="l7.107" class="difflineminus">-      if (newRow &amp;&amp; BuildCard(pName, newRow, pUser))</span>
<a href="#l7.108"></a><span id="l7.108" class="difflineminus">-      {</span>
<a href="#l7.109"></a><span id="l7.109" class="difflineminus">-        rv = m_database-&gt;AddCardRowToDB(newRow);</span>
<a href="#l7.110"></a><span id="l7.110" class="difflineminus">-        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.111"></a><span id="l7.111" class="difflineminus">-        IMPORT_LOG0(&quot;* Added entry to address book database\n&quot;);</span>
<a href="#l7.112"></a><span id="l7.112" class="difflineminus">-        nsString  eMail;</span>
<a href="#l7.113"></a><span id="l7.113" class="difflineminus">-</span>
<a href="#l7.114"></a><span id="l7.114" class="difflineminus">-        LPSPropValue  pProp = m_pWab-&gt;GetUserProperty(pUser, PR_EMAIL_ADDRESS);</span>
<a href="#l7.115"></a><span id="l7.115" class="difflineminus">-        if (pProp) </span>
<a href="#l7.116"></a><span id="l7.116" class="difflineminus">-        {</span>
<a href="#l7.117"></a><span id="l7.117" class="difflineminus">-          m_pWab-&gt;GetValueString(pProp, eMail);</span>
<a href="#l7.118"></a><span id="l7.118" class="difflineminus">-          SanitizeValue(eMail);</span>
<a href="#l7.119"></a><span id="l7.119" class="difflineminus">-          m_pWab-&gt;FreeProperty(pProp);</span>
<a href="#l7.120"></a><span id="l7.120" class="difflineminus">-          m_listRows.Put(eMail, newRow);</span>
<a href="#l7.121"></a><span id="l7.121" class="difflineminus">-        }</span>
<a href="#l7.122"></a><span id="l7.122" class="difflineminus">-      }</span>
<a href="#l7.123"></a><span id="l7.123" class="difflineminus">-      m_pWab-&gt;ReleaseUser(pUser);</span>
<a href="#l7.124"></a><span id="l7.124" class="difflineminus">-    }</span>
<a href="#l7.125"></a><span id="l7.125" class="difflineminus">-  }  </span>
<a href="#l7.126"></a><span id="l7.126" class="difflineminus">-  </span>
<a href="#l7.127"></a><span id="l7.127" class="difflineminus">-  return rv;</span>
<a href="#l7.128"></a><span id="l7.128" class="difflineminus">-}</span>
<a href="#l7.129"></a><span id="l7.129" class="difflineminus">-</span>
<a href="#l7.130"></a><span id="l7.130" class="difflineminus">-void nsOEAddressIterator::FindListRow(nsString &amp;eMail, nsIMdbRow **cardRow)</span>
<a href="#l7.131"></a><span id="l7.131" class="difflineminus">-{</span>
<a href="#l7.132"></a><span id="l7.132" class="difflineminus">-  m_listRows.Get(eMail,cardRow);</span>
<a href="#l7.133"></a><span id="l7.133" class="difflineminus">-}</span>
<a href="#l7.134"></a><span id="l7.134" class="difflineminus">-</span>
<a href="#l7.135"></a><span id="l7.135" class="difflineminus">-nsresult nsOEAddressIterator::EnumList(const char16_t * pName, LPENTRYID pEid, ULONG cbEid, LPMAPITABLE lpTable)</span>
<a href="#l7.136"></a><span id="l7.136" class="difflineminus">-{</span>
<a href="#l7.137"></a><span id="l7.137" class="difflineminus">-  // If no name provided then we're done.</span>
<a href="#l7.138"></a><span id="l7.138" class="difflineminus">-  if (!pName || !(*pName))</span>
<a href="#l7.139"></a><span id="l7.139" class="difflineminus">-    return NS_OK;</span>
<a href="#l7.140"></a><span id="l7.140" class="difflineminus">-</span>
<a href="#l7.141"></a><span id="l7.141" class="difflineminus">-  nsresult rv = NS_ERROR_FAILURE;</span>
<a href="#l7.142"></a><span id="l7.142" class="difflineminus">-  HRESULT hr = E_FAIL;</span>
<a href="#l7.143"></a><span id="l7.143" class="difflineminus">-  // Make sure we have db to work with.</span>
<a href="#l7.144"></a><span id="l7.144" class="difflineminus">-  if (!m_database)</span>
<a href="#l7.145"></a><span id="l7.145" class="difflineminus">-    return rv;</span>
<a href="#l7.146"></a><span id="l7.146" class="difflineminus">-</span>
<a href="#l7.147"></a><span id="l7.147" class="difflineminus">-  nsCOMPtr &lt;nsIMdbRow&gt;  listRow;</span>
<a href="#l7.148"></a><span id="l7.148" class="difflineminus">-  rv = m_database-&gt;GetNewListRow(getter_AddRefs(listRow));</span>
<a href="#l7.149"></a><span id="l7.149" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.150"></a><span id="l7.150" class="difflineminus">-</span>
<a href="#l7.151"></a><span id="l7.151" class="difflineminus">-  rv = m_database-&gt;AddListName(listRow, NS_ConvertUTF16toUTF8(pName).get());</span>
<a href="#l7.152"></a><span id="l7.152" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.153"></a><span id="l7.153" class="difflineminus">-  rv = m_database-&gt;AddCardRowToDB(listRow);</span>
<a href="#l7.154"></a><span id="l7.154" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.155"></a><span id="l7.155" class="difflineminus">-  rv = m_database-&gt;AddListDirNode(listRow);</span>
<a href="#l7.156"></a><span id="l7.156" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.157"></a><span id="l7.157" class="difflineminus">-</span>
<a href="#l7.158"></a><span id="l7.158" class="difflineminus">-  LPSRowSet   lpRowAB = NULL;</span>
<a href="#l7.159"></a><span id="l7.159" class="difflineminus">-  ULONG        lpcbEID = 0;</span>
<a href="#l7.160"></a><span id="l7.160" class="difflineminus">-  LPENTRYID   lpEID = NULL;</span>
<a href="#l7.161"></a><span id="l7.161" class="difflineminus">-  ULONG        rowCount = 0;</span>
<a href="#l7.162"></a><span id="l7.162" class="difflineminus">-  int         cNumRows = 0;</span>
<a href="#l7.163"></a><span id="l7.163" class="difflineminus">-  int         numListElems = 0;</span>
<a href="#l7.164"></a><span id="l7.164" class="difflineminus">-  nsAutoString    uniStr;</span>
<a href="#l7.165"></a><span id="l7.165" class="difflineminus">-</span>
<a href="#l7.166"></a><span id="l7.166" class="difflineminus">-  hr = lpTable-&gt;GetRowCount(0, &amp;rowCount);</span>
<a href="#l7.167"></a><span id="l7.167" class="difflineminus">-  //</span>
<a href="#l7.168"></a><span id="l7.168" class="difflineminus">-  hr = lpTable-&gt;SeekRow(BOOKMARK_BEGINNING, 0, NULL);</span>
<a href="#l7.169"></a><span id="l7.169" class="difflineminus">-</span>
<a href="#l7.170"></a><span id="l7.170" class="difflineminus">-  if(HR_FAILED(hr))</span>
<a href="#l7.171"></a><span id="l7.171" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l7.172"></a><span id="l7.172" class="difflineminus">-</span>
<a href="#l7.173"></a><span id="l7.173" class="difflineminus">-  // Read all the rows of the table one by one</span>
<a href="#l7.174"></a><span id="l7.174" class="difflineminus">-  do </span>
<a href="#l7.175"></a><span id="l7.175" class="difflineminus">-  {</span>
<a href="#l7.176"></a><span id="l7.176" class="difflineminus">-    hr = lpTable-&gt;QueryRows(1, 0, &amp;lpRowAB);</span>
<a href="#l7.177"></a><span id="l7.177" class="difflineminus">-  </span>
<a href="#l7.178"></a><span id="l7.178" class="difflineminus">-    if(HR_FAILED(hr))</span>
<a href="#l7.179"></a><span id="l7.179" class="difflineminus">-      break;</span>
<a href="#l7.180"></a><span id="l7.180" class="difflineminus">-  </span>
<a href="#l7.181"></a><span id="l7.181" class="difflineminus">-    if(lpRowAB)</span>
<a href="#l7.182"></a><span id="l7.182" class="difflineminus">-    {</span>
<a href="#l7.183"></a><span id="l7.183" class="difflineminus">-      cNumRows = lpRowAB-&gt;cRows;</span>
<a href="#l7.184"></a><span id="l7.184" class="difflineminus">-      if (cNumRows)</span>
<a href="#l7.185"></a><span id="l7.185" class="difflineminus">-      {</span>
<a href="#l7.186"></a><span id="l7.186" class="difflineminus">-        LPTSTR lpsz = lpRowAB-&gt;aRow[0].lpProps[ieidPR_DISPLAY_NAME].Value.lpszA;</span>
<a href="#l7.187"></a><span id="l7.187" class="difflineminus">-        LPENTRYID lpEID = (LPENTRYID) lpRowAB-&gt;aRow[0].lpProps[ieidPR_ENTRYID].Value.bin.lpb;</span>
<a href="#l7.188"></a><span id="l7.188" class="difflineminus">-        ULONG cbEID = lpRowAB-&gt;aRow[0].lpProps[ieidPR_ENTRYID].Value.bin.cb;</span>
<a href="#l7.189"></a><span id="l7.189" class="difflineminus">-      </span>
<a href="#l7.190"></a><span id="l7.190" class="difflineminus">-        // There are 2 kinds of objects - the MAPI_MAILUSER contact object</span>
<a href="#l7.191"></a><span id="l7.191" class="difflineminus">-        // and the MAPI_DISTLIST contact object</span>
<a href="#l7.192"></a><span id="l7.192" class="difflineminus">-        // For distribution lists, we will only consider MAILUSER</span>
<a href="#l7.193"></a><span id="l7.193" class="difflineminus">-        // objects since we can't nest lists yet.</span>
<a href="#l7.194"></a><span id="l7.194" class="difflineminus">-        if(lpRowAB-&gt;aRow[0].lpProps[ieidPR_OBJECT_TYPE].Value.l == MAPI_MAILUSER)</span>
<a href="#l7.195"></a><span id="l7.195" class="difflineminus">-        {</span>
<a href="#l7.196"></a><span id="l7.196" class="difflineminus">-          LPMAILUSER  pUser = m_pWab-&gt;GetUser(cbEID, lpEID);</span>
<a href="#l7.197"></a><span id="l7.197" class="difflineminus">-          LPSPropValue pProp = m_pWab-&gt;GetUserProperty(pUser, PR_EMAIL_ADDRESS);</span>
<a href="#l7.198"></a><span id="l7.198" class="difflineminus">-          nsString  eMail;</span>
<a href="#l7.199"></a><span id="l7.199" class="difflineminus">-</span>
<a href="#l7.200"></a><span id="l7.200" class="difflineminus">-          nsCOMPtr &lt;nsIMdbRow&gt; cardRow;</span>
<a href="#l7.201"></a><span id="l7.201" class="difflineminus">-</span>
<a href="#l7.202"></a><span id="l7.202" class="difflineminus">-          m_pWab-&gt;GetValueString(pProp, eMail);</span>
<a href="#l7.203"></a><span id="l7.203" class="difflineminus">-          SanitizeValue(eMail);</span>
<a href="#l7.204"></a><span id="l7.204" class="difflineminus">-          FindListRow(eMail, getter_AddRefs(cardRow));</span>
<a href="#l7.205"></a><span id="l7.205" class="difflineminus">-          if (cardRow)</span>
<a href="#l7.206"></a><span id="l7.206" class="difflineminus">-          {</span>
<a href="#l7.207"></a><span id="l7.207" class="difflineminus">-            nsCOMPtr &lt;nsIAbCard&gt; userCard;</span>
<a href="#l7.208"></a><span id="l7.208" class="difflineminus">-            nsCOMPtr &lt;nsIAbCard&gt; newCard;</span>
<a href="#l7.209"></a><span id="l7.209" class="difflineminus">-            userCard = do_CreateInstance(NS_ABMDBCARD_CONTRACTID, &amp;rv);</span>
<a href="#l7.210"></a><span id="l7.210" class="difflineminus">-            NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.211"></a><span id="l7.211" class="difflineminus">-            m_database-&gt;InitCardFromRow(userCard,cardRow);</span>
<a href="#l7.212"></a><span id="l7.212" class="difflineminus">-</span>
<a href="#l7.213"></a><span id="l7.213" class="difflineminus">-            m_database-&gt;AddListCardColumnsToRow(userCard, listRow, ++numListElems,</span>
<a href="#l7.214"></a><span id="l7.214" class="difflineminus">-                                                getter_AddRefs(newCard),</span>
<a href="#l7.215"></a><span id="l7.215" class="difflineminus">-                                                true, nullptr, nullptr);</span>
<a href="#l7.216"></a><span id="l7.216" class="difflineminus">-          }</span>
<a href="#l7.217"></a><span id="l7.217" class="difflineminus">-          m_pWab-&gt;FreeProperty(pProp);</span>
<a href="#l7.218"></a><span id="l7.218" class="difflineminus">-          m_pWab-&gt;ReleaseUser(pUser);</span>
<a href="#l7.219"></a><span id="l7.219" class="difflineminus">-        }</span>
<a href="#l7.220"></a><span id="l7.220" class="difflineminus">-      }</span>
<a href="#l7.221"></a><span id="l7.221" class="difflineminus">-      m_pWab-&gt;FreeProws(lpRowAB);    </span>
<a href="#l7.222"></a><span id="l7.222" class="difflineminus">-    }</span>
<a href="#l7.223"></a><span id="l7.223" class="difflineminus">-  } while (SUCCEEDED(hr) &amp;&amp; cNumRows &amp;&amp; lpRowAB);</span>
<a href="#l7.224"></a><span id="l7.224" class="difflineminus">-</span>
<a href="#l7.225"></a><span id="l7.225" class="difflineminus">-  m_database-&gt;SetListAddressTotal(listRow, numListElems);</span>
<a href="#l7.226"></a><span id="l7.226" class="difflineminus">-  return rv;</span>
<a href="#l7.227"></a><span id="l7.227" class="difflineminus">-}</span>
<a href="#l7.228"></a><span id="l7.228" class="difflineminus">-</span>
<a href="#l7.229"></a><span id="l7.229" class="difflineminus">-void nsOEAddressIterator::SanitizeValue(nsString&amp; val)</span>
<a href="#l7.230"></a><span id="l7.230" class="difflineminus">-{</span>
<a href="#l7.231"></a><span id="l7.231" class="difflineminus">-  MsgReplaceSubstring(val, NS_LITERAL_STRING(&quot;\r\n&quot;), NS_LITERAL_STRING(&quot;, &quot;));</span>
<a href="#l7.232"></a><span id="l7.232" class="difflineminus">-  MsgReplaceChar(val, &quot;\r\n&quot;, ',');</span>
<a href="#l7.233"></a><span id="l7.233" class="difflineminus">-}</span>
<a href="#l7.234"></a><span id="l7.234" class="difflineminus">-</span>
<a href="#l7.235"></a><span id="l7.235" class="difflineminus">-void nsOEAddressIterator::SplitString(nsString&amp; val1, nsString&amp; val2)</span>
<a href="#l7.236"></a><span id="l7.236" class="difflineminus">-{</span>
<a href="#l7.237"></a><span id="l7.237" class="difflineminus">-  // Find the last line if there is more than one!</span>
<a href="#l7.238"></a><span id="l7.238" class="difflineminus">-  int32_t idx = val1.RFind(&quot;\x0D\x0A&quot;);</span>
<a href="#l7.239"></a><span id="l7.239" class="difflineminus">-  int32_t  cnt = 2;</span>
<a href="#l7.240"></a><span id="l7.240" class="difflineminus">-  if (idx == -1) {</span>
<a href="#l7.241"></a><span id="l7.241" class="difflineminus">-    cnt = 1;</span>
<a href="#l7.242"></a><span id="l7.242" class="difflineminus">-    idx = val1.RFindChar(13);</span>
<a href="#l7.243"></a><span id="l7.243" class="difflineminus">-  }</span>
<a href="#l7.244"></a><span id="l7.244" class="difflineminus">-  if (idx == -1)</span>
<a href="#l7.245"></a><span id="l7.245" class="difflineminus">-    idx= val1.RFindChar(10);</span>
<a href="#l7.246"></a><span id="l7.246" class="difflineminus">-  if (idx != -1) {</span>
<a href="#l7.247"></a><span id="l7.247" class="difflineminus">-    val2 = Substring(val1, idx + cnt);</span>
<a href="#l7.248"></a><span id="l7.248" class="difflineminus">-    val1.SetLength(idx);</span>
<a href="#l7.249"></a><span id="l7.249" class="difflineminus">-    SanitizeValue(val1);</span>
<a href="#l7.250"></a><span id="l7.250" class="difflineminus">-  }</span>
<a href="#l7.251"></a><span id="l7.251" class="difflineminus">-}</span>
<a href="#l7.252"></a><span id="l7.252" class="difflineminus">-</span>
<a href="#l7.253"></a><span id="l7.253" class="difflineminus">-void nsOEAddressIterator::SetBirthDay(nsIMdbRow *newRow, PRTime&amp; birthDay)</span>
<a href="#l7.254"></a><span id="l7.254" class="difflineminus">-{</span>
<a href="#l7.255"></a><span id="l7.255" class="difflineminus">-  PRExplodedTime exploded;</span>
<a href="#l7.256"></a><span id="l7.256" class="difflineminus">-  PR_ExplodeTime(birthDay, PR_LocalTimeParameters, &amp;exploded);</span>
<a href="#l7.257"></a><span id="l7.257" class="difflineminus">-</span>
<a href="#l7.258"></a><span id="l7.258" class="difflineminus">-  char stringValue[5];</span>
<a href="#l7.259"></a><span id="l7.259" class="difflineminus">-  PR_snprintf(stringValue, sizeof(stringValue), &quot;%04d&quot;, exploded.tm_year);</span>
<a href="#l7.260"></a><span id="l7.260" class="difflineminus">-  m_database-&gt;AddBirthYear(newRow, stringValue);</span>
<a href="#l7.261"></a><span id="l7.261" class="difflineminus">-  PR_snprintf(stringValue, sizeof(stringValue), &quot;%02d&quot;, exploded.tm_month + 1);</span>
<a href="#l7.262"></a><span id="l7.262" class="difflineminus">-  m_database-&gt;AddBirthMonth(newRow, stringValue);</span>
<a href="#l7.263"></a><span id="l7.263" class="difflineminus">-  PR_snprintf(stringValue, sizeof(stringValue), &quot;%02d&quot;, exploded.tm_mday);</span>
<a href="#l7.264"></a><span id="l7.264" class="difflineminus">-  m_database-&gt;AddBirthDay(newRow, stringValue);</span>
<a href="#l7.265"></a><span id="l7.265" class="difflineminus">-}</span>
<a href="#l7.266"></a><span id="l7.266" class="difflineminus">-</span>
<a href="#l7.267"></a><span id="l7.267" class="difflineminus">-bool nsOEAddressIterator::BuildCard(const char16_t * pName, nsIMdbRow *newRow, LPMAILUSER pUser)</span>
<a href="#l7.268"></a><span id="l7.268" class="difflineminus">-{</span>
<a href="#l7.269"></a><span id="l7.269" class="difflineminus">-  </span>
<a href="#l7.270"></a><span id="l7.270" class="difflineminus">-  nsString    lastName;</span>
<a href="#l7.271"></a><span id="l7.271" class="difflineminus">-  nsString    firstName;</span>
<a href="#l7.272"></a><span id="l7.272" class="difflineminus">-  nsString    eMail;</span>
<a href="#l7.273"></a><span id="l7.273" class="difflineminus">-  nsString    nickName;</span>
<a href="#l7.274"></a><span id="l7.274" class="difflineminus">-  nsString    middleName;</span>
<a href="#l7.275"></a><span id="l7.275" class="difflineminus">-  PRTime      birthDay = 0;</span>
<a href="#l7.276"></a><span id="l7.276" class="difflineminus">-  </span>
<a href="#l7.277"></a><span id="l7.277" class="difflineminus">-  LPSPropValue  pProp = m_pWab-&gt;GetUserProperty(pUser, PR_EMAIL_ADDRESS);</span>
<a href="#l7.278"></a><span id="l7.278" class="difflineminus">-  if (pProp) {</span>
<a href="#l7.279"></a><span id="l7.279" class="difflineminus">-    m_pWab-&gt;GetValueString(pProp, eMail);</span>
<a href="#l7.280"></a><span id="l7.280" class="difflineminus">-    SanitizeValue(eMail);</span>
<a href="#l7.281"></a><span id="l7.281" class="difflineminus">-    m_pWab-&gt;FreeProperty(pProp);</span>
<a href="#l7.282"></a><span id="l7.282" class="difflineminus">-  }</span>
<a href="#l7.283"></a><span id="l7.283" class="difflineminus">-  pProp = m_pWab-&gt;GetUserProperty(pUser, PR_GIVEN_NAME);</span>
<a href="#l7.284"></a><span id="l7.284" class="difflineminus">-  if (pProp) {</span>
<a href="#l7.285"></a><span id="l7.285" class="difflineminus">-    m_pWab-&gt;GetValueString(pProp, firstName);</span>
<a href="#l7.286"></a><span id="l7.286" class="difflineminus">-    SanitizeValue(firstName);</span>
<a href="#l7.287"></a><span id="l7.287" class="difflineminus">-    m_pWab-&gt;FreeProperty(pProp);</span>
<a href="#l7.288"></a><span id="l7.288" class="difflineminus">-  }</span>
<a href="#l7.289"></a><span id="l7.289" class="difflineminus">-  pProp = m_pWab-&gt;GetUserProperty(pUser, PR_SURNAME);</span>
<a href="#l7.290"></a><span id="l7.290" class="difflineminus">-  if (pProp) {</span>
<a href="#l7.291"></a><span id="l7.291" class="difflineminus">-    m_pWab-&gt;GetValueString(pProp, lastName);</span>
<a href="#l7.292"></a><span id="l7.292" class="difflineminus">-    SanitizeValue(lastName);</span>
<a href="#l7.293"></a><span id="l7.293" class="difflineminus">-    m_pWab-&gt;FreeProperty(pProp);</span>
<a href="#l7.294"></a><span id="l7.294" class="difflineminus">-  }</span>
<a href="#l7.295"></a><span id="l7.295" class="difflineminus">-  pProp = m_pWab-&gt;GetUserProperty(pUser, PR_MIDDLE_NAME);</span>
<a href="#l7.296"></a><span id="l7.296" class="difflineminus">-  if (pProp) {</span>
<a href="#l7.297"></a><span id="l7.297" class="difflineminus">-    m_pWab-&gt;GetValueString(pProp, middleName);</span>
<a href="#l7.298"></a><span id="l7.298" class="difflineminus">-    SanitizeValue(middleName);</span>
<a href="#l7.299"></a><span id="l7.299" class="difflineminus">-    m_pWab-&gt;FreeProperty(pProp);</span>
<a href="#l7.300"></a><span id="l7.300" class="difflineminus">-  }</span>
<a href="#l7.301"></a><span id="l7.301" class="difflineminus">-  pProp = m_pWab-&gt;GetUserProperty(pUser, PR_NICKNAME);</span>
<a href="#l7.302"></a><span id="l7.302" class="difflineminus">-  if (pProp) {</span>
<a href="#l7.303"></a><span id="l7.303" class="difflineminus">-    m_pWab-&gt;GetValueString(pProp, nickName);</span>
<a href="#l7.304"></a><span id="l7.304" class="difflineminus">-    SanitizeValue(nickName);</span>
<a href="#l7.305"></a><span id="l7.305" class="difflineminus">-    m_pWab-&gt;FreeProperty(pProp);</span>
<a href="#l7.306"></a><span id="l7.306" class="difflineminus">-  }</span>
<a href="#l7.307"></a><span id="l7.307" class="difflineminus">-  </span>
<a href="#l7.308"></a><span id="l7.308" class="difflineminus">-  // The idea here is that firstName and lastName cannot both be empty!</span>
<a href="#l7.309"></a><span id="l7.309" class="difflineminus">-  if (firstName.IsEmpty() &amp;&amp; lastName.IsEmpty())</span>
<a href="#l7.310"></a><span id="l7.310" class="difflineminus">-    firstName = pName;</span>
<a href="#l7.311"></a><span id="l7.311" class="difflineminus">-  </span>
<a href="#l7.312"></a><span id="l7.312" class="difflineminus">-  nsString  displayName;</span>
<a href="#l7.313"></a><span id="l7.313" class="difflineminus">-  pProp = m_pWab-&gt;GetUserProperty(pUser, PR_DISPLAY_NAME);</span>
<a href="#l7.314"></a><span id="l7.314" class="difflineminus">-  if (pProp) {</span>
<a href="#l7.315"></a><span id="l7.315" class="difflineminus">-    m_pWab-&gt;GetValueString(pProp, displayName);</span>
<a href="#l7.316"></a><span id="l7.316" class="difflineminus">-    SanitizeValue(displayName);</span>
<a href="#l7.317"></a><span id="l7.317" class="difflineminus">-    m_pWab-&gt;FreeProperty(pProp);</span>
<a href="#l7.318"></a><span id="l7.318" class="difflineminus">-  }</span>
<a href="#l7.319"></a><span id="l7.319" class="difflineminus">-  if (displayName.IsEmpty()) {</span>
<a href="#l7.320"></a><span id="l7.320" class="difflineminus">-    if (firstName.IsEmpty())</span>
<a href="#l7.321"></a><span id="l7.321" class="difflineminus">-      displayName = pName;</span>
<a href="#l7.322"></a><span id="l7.322" class="difflineminus">-    else {</span>
<a href="#l7.323"></a><span id="l7.323" class="difflineminus">-      displayName = firstName;</span>
<a href="#l7.324"></a><span id="l7.324" class="difflineminus">-      if (!middleName.IsEmpty()) {</span>
<a href="#l7.325"></a><span id="l7.325" class="difflineminus">-        displayName.Append(char16_t(' '));</span>
<a href="#l7.326"></a><span id="l7.326" class="difflineminus">-        displayName.Append(middleName);</span>
<a href="#l7.327"></a><span id="l7.327" class="difflineminus">-      }</span>
<a href="#l7.328"></a><span id="l7.328" class="difflineminus">-      if (!lastName.IsEmpty()) {</span>
<a href="#l7.329"></a><span id="l7.329" class="difflineminus">-        displayName.Append(char16_t(' '));</span>
<a href="#l7.330"></a><span id="l7.330" class="difflineminus">-        displayName.Append(lastName);</span>
<a href="#l7.331"></a><span id="l7.331" class="difflineminus">-      }</span>
<a href="#l7.332"></a><span id="l7.332" class="difflineminus">-    }</span>
<a href="#l7.333"></a><span id="l7.333" class="difflineminus">-  }</span>
<a href="#l7.334"></a><span id="l7.334" class="difflineminus">-</span>
<a href="#l7.335"></a><span id="l7.335" class="difflineminus">-  pProp = m_pWab-&gt;GetUserProperty(pUser, PR_BIRTHDAY);</span>
<a href="#l7.336"></a><span id="l7.336" class="difflineminus">-  if (pProp) {</span>
<a href="#l7.337"></a><span id="l7.337" class="difflineminus">-    m_pWab-&gt;GetValueTime(pProp, birthDay);</span>
<a href="#l7.338"></a><span id="l7.338" class="difflineminus">-    m_pWab-&gt;FreeProperty(pProp);</span>
<a href="#l7.339"></a><span id="l7.339" class="difflineminus">-  }</span>
<a href="#l7.340"></a><span id="l7.340" class="difflineminus">-  </span>
<a href="#l7.341"></a><span id="l7.341" class="difflineminus">-  // We now have the required fields</span>
<a href="#l7.342"></a><span id="l7.342" class="difflineminus">-  // write them out followed by any optional fields!</span>
<a href="#l7.343"></a><span id="l7.343" class="difflineminus">-  if (!displayName.IsEmpty())</span>
<a href="#l7.344"></a><span id="l7.344" class="difflineminus">-    m_database-&gt;AddDisplayName(newRow, NS_ConvertUTF16toUTF8(displayName).get());</span>
<a href="#l7.345"></a><span id="l7.345" class="difflineminus">-  if (!firstName.IsEmpty())</span>
<a href="#l7.346"></a><span id="l7.346" class="difflineminus">-    m_database-&gt;AddFirstName(newRow, NS_ConvertUTF16toUTF8(firstName).get());</span>
<a href="#l7.347"></a><span id="l7.347" class="difflineminus">-  if (!lastName.IsEmpty())</span>
<a href="#l7.348"></a><span id="l7.348" class="difflineminus">-    m_database-&gt;AddLastName(newRow, NS_ConvertUTF16toUTF8(lastName).get());</span>
<a href="#l7.349"></a><span id="l7.349" class="difflineminus">-  if (!nickName.IsEmpty())</span>
<a href="#l7.350"></a><span id="l7.350" class="difflineminus">-    m_database-&gt;AddNickName(newRow, NS_ConvertUTF16toUTF8(nickName).get());</span>
<a href="#l7.351"></a><span id="l7.351" class="difflineminus">-  if (!eMail.IsEmpty())</span>
<a href="#l7.352"></a><span id="l7.352" class="difflineminus">-    m_database-&gt;AddPrimaryEmail(newRow, NS_ConvertUTF16toUTF8(eMail).get());</span>
<a href="#l7.353"></a><span id="l7.353" class="difflineminus">-</span>
<a href="#l7.354"></a><span id="l7.354" class="difflineminus">-  if (birthDay)</span>
<a href="#l7.355"></a><span id="l7.355" class="difflineminus">-    SetBirthDay(newRow, birthDay);</span>
<a href="#l7.356"></a><span id="l7.356" class="difflineminus">-  </span>
<a href="#l7.357"></a><span id="l7.357" class="difflineminus">-  // Do all of the extra fields!</span>
<a href="#l7.358"></a><span id="l7.358" class="difflineminus">-  </span>
<a href="#l7.359"></a><span id="l7.359" class="difflineminus">-  nsString  value;</span>
<a href="#l7.360"></a><span id="l7.360" class="difflineminus">-  nsString  line2;</span>
<a href="#l7.361"></a><span id="l7.361" class="difflineminus">-  nsresult  rv;</span>
<a href="#l7.362"></a><span id="l7.362" class="difflineminus">-  // Create a field map</span>
<a href="#l7.363"></a><span id="l7.363" class="difflineminus">-  </span>
<a href="#l7.364"></a><span id="l7.364" class="difflineminus">-  nsCOMPtr&lt;nsIImportService&gt; impSvc(do_GetService(NS_IMPORTSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l7.365"></a><span id="l7.365" class="difflineminus">-  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l7.366"></a><span id="l7.366" class="difflineminus">-    nsIImportFieldMap *    pFieldMap = nullptr;</span>
<a href="#l7.367"></a><span id="l7.367" class="difflineminus">-    rv = impSvc-&gt;CreateNewFieldMap(&amp;pFieldMap);</span>
<a href="#l7.368"></a><span id="l7.368" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; pFieldMap) {</span>
<a href="#l7.369"></a><span id="l7.369" class="difflineminus">-      int max = sizeof(gMapiFields) / sizeof(MAPIFields);</span>
<a href="#l7.370"></a><span id="l7.370" class="difflineminus">-      for (int i = 0; i &lt; max; i++) {</span>
<a href="#l7.371"></a><span id="l7.371" class="difflineminus">-        pProp = m_pWab-&gt;GetUserProperty(pUser, gMapiFields[i].mapiTag);</span>
<a href="#l7.372"></a><span id="l7.372" class="difflineminus">-        if (pProp) {</span>
<a href="#l7.373"></a><span id="l7.373" class="difflineminus">-          m_pWab-&gt;GetValueString(pProp, value);</span>
<a href="#l7.374"></a><span id="l7.374" class="difflineminus">-          m_pWab-&gt;FreeProperty(pProp);</span>
<a href="#l7.375"></a><span id="l7.375" class="difflineminus">-          if (!value.IsEmpty()) {</span>
<a href="#l7.376"></a><span id="l7.376" class="difflineminus">-            if (gMapiFields[i].multiLine == kNoMultiLine) {</span>
<a href="#l7.377"></a><span id="l7.377" class="difflineminus">-              SanitizeValue(value);</span>
<a href="#l7.378"></a><span id="l7.378" class="difflineminus">-              pFieldMap-&gt;SetFieldValue(m_database, newRow, gMapiFields[i].mozField, value.get());</span>
<a href="#l7.379"></a><span id="l7.379" class="difflineminus">-            }</span>
<a href="#l7.380"></a><span id="l7.380" class="difflineminus">-            else if (gMapiFields[i].multiLine == kIsMultiLine) {</span>
<a href="#l7.381"></a><span id="l7.381" class="difflineminus">-              pFieldMap-&gt;SetFieldValue(m_database, newRow, gMapiFields[i].mozField, value.get());</span>
<a href="#l7.382"></a><span id="l7.382" class="difflineminus">-            }</span>
<a href="#l7.383"></a><span id="l7.383" class="difflineminus">-            else {</span>
<a href="#l7.384"></a><span id="l7.384" class="difflineminus">-              line2.Truncate();</span>
<a href="#l7.385"></a><span id="l7.385" class="difflineminus">-              SplitString(value, line2);</span>
<a href="#l7.386"></a><span id="l7.386" class="difflineminus">-              if (!value.IsEmpty())</span>
<a href="#l7.387"></a><span id="l7.387" class="difflineminus">-                pFieldMap-&gt;SetFieldValue(m_database, newRow, gMapiFields[i].mozField, value.get());</span>
<a href="#l7.388"></a><span id="l7.388" class="difflineminus">-              if (!line2.IsEmpty())</span>
<a href="#l7.389"></a><span id="l7.389" class="difflineminus">-                pFieldMap-&gt;SetFieldValue(m_database, newRow, gMapiFields[i].multiLine, line2.get());</span>
<a href="#l7.390"></a><span id="l7.390" class="difflineminus">-            }</span>
<a href="#l7.391"></a><span id="l7.391" class="difflineminus">-          }</span>
<a href="#l7.392"></a><span id="l7.392" class="difflineminus">-        }</span>
<a href="#l7.393"></a><span id="l7.393" class="difflineminus">-      }</span>
<a href="#l7.394"></a><span id="l7.394" class="difflineminus">-      // call fieldMap SetFieldValue based on the table of fields</span>
<a href="#l7.395"></a><span id="l7.395" class="difflineminus">-      </span>
<a href="#l7.396"></a><span id="l7.396" class="difflineminus">-      NS_RELEASE(pFieldMap);</span>
<a href="#l7.397"></a><span id="l7.397" class="difflineminus">-    }</span>
<a href="#l7.398"></a><span id="l7.398" class="difflineminus">-  }</span>
<a href="#l7.399"></a><span id="l7.399" class="difflineminus">-  return true;</span>
<a href="#l7.400"></a><span id="l7.400" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1">deleted file mode 100644</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineminus">--- a/mailnews/import/oexpress/nsOEAddressIterator.h</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineplus">+++ /dev/null</span>
<a href="#l8.4"></a><span id="l8.4" class="difflineat">@@ -1,36 +0,0 @@</span>
<a href="#l8.5"></a><span id="l8.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l8.6"></a><span id="l8.6" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l8.7"></a><span id="l8.7" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l8.8"></a><span id="l8.8" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l8.9"></a><span id="l8.9" class="difflineminus">-</span>
<a href="#l8.10"></a><span id="l8.10" class="difflineminus">-#ifndef nsOEAddressIterator_h___</span>
<a href="#l8.11"></a><span id="l8.11" class="difflineminus">-#define nsOEAddressIterator_h___</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineminus">-#include &quot;mozilla/Attributes.h&quot;</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineminus">-#include &quot;WabObject.h&quot;</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineminus">-#include &quot;nsIAddrDatabase.h&quot;</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineminus">-#include &quot;mdb.h&quot;</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineminus">-#include &quot;nsStringGlue.h&quot;</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineminus">-#include &quot;nsInterfaceHashtable.h&quot;</span>
<a href="#l8.19"></a><span id="l8.19" class="difflineminus">-</span>
<a href="#l8.20"></a><span id="l8.20" class="difflineminus">-class nsOEAddressIterator : public CWabIterator {</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineminus">-public:</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineminus">-  nsOEAddressIterator(CWAB *pWab, nsIAddrDatabase *database);</span>
<a href="#l8.23"></a><span id="l8.23" class="difflineminus">-  ~nsOEAddressIterator();</span>
<a href="#l8.24"></a><span id="l8.24" class="difflineminus">-  </span>
<a href="#l8.25"></a><span id="l8.25" class="difflineminus">-  virtual nsresult  EnumUser(const char16_t * pName, LPENTRYID pEid, ULONG cbEid) override;</span>
<a href="#l8.26"></a><span id="l8.26" class="difflineminus">-  virtual nsresult  EnumList(const char16_t * pName, LPENTRYID pEid, ULONG cbEid, LPMAPITABLE table) override;</span>
<a href="#l8.27"></a><span id="l8.27" class="difflineminus">-        void FindListRow(nsString &amp;eMail, nsIMdbRow **cardRow);</span>
<a href="#l8.28"></a><span id="l8.28" class="difflineminus">-</span>
<a href="#l8.29"></a><span id="l8.29" class="difflineminus">-private:</span>
<a href="#l8.30"></a><span id="l8.30" class="difflineminus">-  bool      BuildCard(const char16_t * pName, nsIMdbRow *card, LPMAILUSER pUser);</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineminus">-  void    SanitizeValue(nsString&amp; val);</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineminus">-  void    SplitString(nsString&amp; val1, nsString&amp; val2);</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineminus">-  void    SetBirthDay(nsIMdbRow *card, PRTime&amp; birthDay);</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineminus">-</span>
<a href="#l8.35"></a><span id="l8.35" class="difflineminus">-  CWAB *                m_pWab;</span>
<a href="#l8.36"></a><span id="l8.36" class="difflineminus">-  nsCOMPtr&lt;nsIAddrDatabase&gt;     m_database;</span>
<a href="#l8.37"></a><span id="l8.37" class="difflineminus">-  nsInterfaceHashtable &lt;nsStringHashKey, nsIMdbRow&gt; m_listRows;</span>
<a href="#l8.38"></a><span id="l8.38" class="difflineminus">-};</span>
<a href="#l8.39"></a><span id="l8.39" class="difflineminus">-</span>
<a href="#l8.40"></a><span id="l8.40" class="difflineminus">-#endif </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1">deleted file mode 100644</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineminus">--- a/mailnews/import/oexpress/nsOEImport.cpp</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineplus">+++ /dev/null</span>
<a href="#l9.4"></a><span id="l9.4" class="difflineat">@@ -1,657 +0,0 @@</span>
<a href="#l9.5"></a><span id="l9.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l9.6"></a><span id="l9.6" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l9.7"></a><span id="l9.7" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l9.8"></a><span id="l9.8" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l9.9"></a><span id="l9.9" class="difflineminus">-</span>
<a href="#l9.10"></a><span id="l9.10" class="difflineminus">-</span>
<a href="#l9.11"></a><span id="l9.11" class="difflineminus">-/*</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineminus">-  Outlook Express (Win32) import mail and addressbook interfaces</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineminus">-</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineminus">-*/</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineminus">-#include &quot;nscore.h&quot;</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineminus">-#include &quot;nsMsgUtils.h&quot;</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineminus">-#include &quot;nsStringGlue.h&quot;</span>
<a href="#l9.19"></a><span id="l9.19" class="difflineminus">-#include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l9.20"></a><span id="l9.20" class="difflineminus">-#include &quot;nsIImportService.h&quot;</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineminus">-#include &quot;nsOEImport.h&quot;</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineminus">-#include &quot;nsIMemory.h&quot;</span>
<a href="#l9.23"></a><span id="l9.23" class="difflineminus">-#include &quot;nsOEScanBoxes.h&quot;</span>
<a href="#l9.24"></a><span id="l9.24" class="difflineminus">-#include &quot;nsIImportService.h&quot;</span>
<a href="#l9.25"></a><span id="l9.25" class="difflineminus">-#include &quot;nsIImportMail.h&quot;</span>
<a href="#l9.26"></a><span id="l9.26" class="difflineminus">-#include &quot;nsIImportMailboxDescriptor.h&quot;</span>
<a href="#l9.27"></a><span id="l9.27" class="difflineminus">-#include &quot;nsIImportGeneric.h&quot;</span>
<a href="#l9.28"></a><span id="l9.28" class="difflineminus">-#include &quot;nsOEMailbox.h&quot;</span>
<a href="#l9.29"></a><span id="l9.29" class="difflineminus">-#include &quot;nsIImportAddressBooks.h&quot;</span>
<a href="#l9.30"></a><span id="l9.30" class="difflineminus">-#include &quot;nsIImportABDescriptor.h&quot;</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineminus">-#include &quot;nsIImportFieldMap.h&quot;</span>
<a href="#l9.32"></a><span id="l9.32" class="difflineminus">-#include &quot;nsIMutableArray.h&quot;</span>
<a href="#l9.33"></a><span id="l9.33" class="difflineminus">-#include &quot;nsXPCOM.h&quot;</span>
<a href="#l9.34"></a><span id="l9.34" class="difflineminus">-#include &quot;nsISupportsPrimitives.h&quot;</span>
<a href="#l9.35"></a><span id="l9.35" class="difflineminus">-#include &quot;WabObject.h&quot;</span>
<a href="#l9.36"></a><span id="l9.36" class="difflineminus">-#include &quot;nsOEAddressIterator.h&quot;</span>
<a href="#l9.37"></a><span id="l9.37" class="difflineminus">-#include &quot;nsIOutputStream.h&quot;</span>
<a href="#l9.38"></a><span id="l9.38" class="difflineminus">-#include &quot;nsOE5File.h&quot;</span>
<a href="#l9.39"></a><span id="l9.39" class="difflineminus">-#include &quot;nsIAddrDatabase.h&quot;</span>
<a href="#l9.40"></a><span id="l9.40" class="difflineminus">-#include &quot;nsOESettings.h&quot;</span>
<a href="#l9.41"></a><span id="l9.41" class="difflineminus">-#include &quot;nsTextFormatter.h&quot;</span>
<a href="#l9.42"></a><span id="l9.42" class="difflineminus">-#include &quot;nsOEStringBundle.h&quot;</span>
<a href="#l9.43"></a><span id="l9.43" class="difflineminus">-#include &quot;nsIStringBundle.h&quot;</span>
<a href="#l9.44"></a><span id="l9.44" class="difflineminus">-#include &quot;nsUnicharUtils.h&quot;</span>
<a href="#l9.45"></a><span id="l9.45" class="difflineminus">-#include &quot;nsDirectoryServiceUtils.h&quot;</span>
<a href="#l9.46"></a><span id="l9.46" class="difflineminus">-#include &quot;nsDirectoryServiceDefs.h&quot;</span>
<a href="#l9.47"></a><span id="l9.47" class="difflineminus">-</span>
<a href="#l9.48"></a><span id="l9.48" class="difflineminus">-#include &quot;OEDebugLog.h&quot;</span>
<a href="#l9.49"></a><span id="l9.49" class="difflineminus">-</span>
<a href="#l9.50"></a><span id="l9.50" class="difflineminus">-static NS_DEFINE_IID(kISupportsIID, NS_ISUPPORTS_IID);</span>
<a href="#l9.51"></a><span id="l9.51" class="difflineminus">-PRLogModuleInfo *OELOGMODULE = nullptr;</span>
<a href="#l9.52"></a><span id="l9.52" class="difflineminus">-</span>
<a href="#l9.53"></a><span id="l9.53" class="difflineminus">-class ImportOEMailImpl : public nsIImportMail</span>
<a href="#l9.54"></a><span id="l9.54" class="difflineminus">-{</span>
<a href="#l9.55"></a><span id="l9.55" class="difflineminus">-public:</span>
<a href="#l9.56"></a><span id="l9.56" class="difflineminus">-  ImportOEMailImpl();</span>
<a href="#l9.57"></a><span id="l9.57" class="difflineminus">-</span>
<a href="#l9.58"></a><span id="l9.58" class="difflineminus">-  static nsresult Create(nsIImportMail** aImport);</span>
<a href="#l9.59"></a><span id="l9.59" class="difflineminus">-</span>
<a href="#l9.60"></a><span id="l9.60" class="difflineminus">-  // nsISupports interface</span>
<a href="#l9.61"></a><span id="l9.61" class="difflineminus">-  NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l9.62"></a><span id="l9.62" class="difflineminus">-</span>
<a href="#l9.63"></a><span id="l9.63" class="difflineminus">-  // nsIImportmail interface</span>
<a href="#l9.64"></a><span id="l9.64" class="difflineminus">-</span>
<a href="#l9.65"></a><span id="l9.65" class="difflineminus">-  /* void GetDefaultLocation (out nsIFile location, out boolean found, out boolean userVerify); */</span>
<a href="#l9.66"></a><span id="l9.66" class="difflineminus">-  NS_IMETHOD GetDefaultLocation(nsIFile **location, bool *found, bool *userVerify);</span>
<a href="#l9.67"></a><span id="l9.67" class="difflineminus">-</span>
<a href="#l9.68"></a><span id="l9.68" class="difflineminus">-  /* nsIArray FindMailboxes (in nsIFile location); */</span>
<a href="#l9.69"></a><span id="l9.69" class="difflineminus">-  NS_IMETHOD FindMailboxes(nsIFile *location, nsIArray **_retval);</span>
<a href="#l9.70"></a><span id="l9.70" class="difflineminus">-</span>
<a href="#l9.71"></a><span id="l9.71" class="difflineminus">-  NS_IMETHOD ImportMailbox(nsIImportMailboxDescriptor *source,</span>
<a href="#l9.72"></a><span id="l9.72" class="difflineminus">-                           nsIMsgFolder *dstFolder,</span>
<a href="#l9.73"></a><span id="l9.73" class="difflineminus">-                           char16_t **pErrorLog, char16_t **pSuccessLog,</span>
<a href="#l9.74"></a><span id="l9.74" class="difflineminus">-                           bool *fatalError);</span>
<a href="#l9.75"></a><span id="l9.75" class="difflineminus">-</span>
<a href="#l9.76"></a><span id="l9.76" class="difflineminus">-  /* unsigned long GetImportProgress (); */</span>
<a href="#l9.77"></a><span id="l9.77" class="difflineminus">-  NS_IMETHOD GetImportProgress(uint32_t *_retval);</span>
<a href="#l9.78"></a><span id="l9.78" class="difflineminus">-</span>
<a href="#l9.79"></a><span id="l9.79" class="difflineminus">-    NS_IMETHOD TranslateFolderName(const nsAString &amp; aFolderName, nsAString &amp; _retval);</span>
<a href="#l9.80"></a><span id="l9.80" class="difflineminus">-</span>
<a href="#l9.81"></a><span id="l9.81" class="difflineminus">-public:</span>
<a href="#l9.82"></a><span id="l9.82" class="difflineminus">-  static void ReportSuccess(nsString&amp; name, int32_t count, nsString *pStream);</span>
<a href="#l9.83"></a><span id="l9.83" class="difflineminus">-  static void ReportError(int32_t errorNum, nsString&amp; name, nsString *pStream);</span>
<a href="#l9.84"></a><span id="l9.84" class="difflineminus">-  static void AddLinebreak(nsString *pStream);</span>
<a href="#l9.85"></a><span id="l9.85" class="difflineminus">-  static void SetLogs(nsString&amp; success, nsString&amp; error, char16_t **pError, char16_t **pSuccess);</span>
<a href="#l9.86"></a><span id="l9.86" class="difflineminus">-</span>
<a href="#l9.87"></a><span id="l9.87" class="difflineminus">-private:</span>
<a href="#l9.88"></a><span id="l9.88" class="difflineminus">-  virtual ~ImportOEMailImpl();</span>
<a href="#l9.89"></a><span id="l9.89" class="difflineminus">-  uint32_t m_bytesDone;</span>
<a href="#l9.90"></a><span id="l9.90" class="difflineminus">-};</span>
<a href="#l9.91"></a><span id="l9.91" class="difflineminus">-</span>
<a href="#l9.92"></a><span id="l9.92" class="difflineminus">-</span>
<a href="#l9.93"></a><span id="l9.93" class="difflineminus">-class ImportOEAddressImpl : public nsIImportAddressBooks</span>
<a href="#l9.94"></a><span id="l9.94" class="difflineminus">-{</span>
<a href="#l9.95"></a><span id="l9.95" class="difflineminus">-public:</span>
<a href="#l9.96"></a><span id="l9.96" class="difflineminus">-    ImportOEAddressImpl();</span>
<a href="#l9.97"></a><span id="l9.97" class="difflineminus">-</span>
<a href="#l9.98"></a><span id="l9.98" class="difflineminus">-  static nsresult Create(nsIImportAddressBooks** aImport);</span>
<a href="#l9.99"></a><span id="l9.99" class="difflineminus">-</span>
<a href="#l9.100"></a><span id="l9.100" class="difflineminus">-  // nsISupports interface</span>
<a href="#l9.101"></a><span id="l9.101" class="difflineminus">-  NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l9.102"></a><span id="l9.102" class="difflineminus">-</span>
<a href="#l9.103"></a><span id="l9.103" class="difflineminus">-    // nsIImportAddressBooks interface</span>
<a href="#l9.104"></a><span id="l9.104" class="difflineminus">-</span>
<a href="#l9.105"></a><span id="l9.105" class="difflineminus">-  NS_IMETHOD GetSupportsMultiple(bool *_retval) { *_retval = false; return NS_OK;}</span>
<a href="#l9.106"></a><span id="l9.106" class="difflineminus">-</span>
<a href="#l9.107"></a><span id="l9.107" class="difflineminus">-  NS_IMETHOD GetAutoFind(char16_t **description, bool *_retval);</span>
<a href="#l9.108"></a><span id="l9.108" class="difflineminus">-</span>
<a href="#l9.109"></a><span id="l9.109" class="difflineminus">-  NS_IMETHOD GetNeedsFieldMap(nsIFile *pLoc, bool *_retval) { *_retval = false; return NS_OK;}</span>
<a href="#l9.110"></a><span id="l9.110" class="difflineminus">-</span>
<a href="#l9.111"></a><span id="l9.111" class="difflineminus">-  NS_IMETHOD GetDefaultLocation(nsIFile **location, bool *found, bool *userVerify);</span>
<a href="#l9.112"></a><span id="l9.112" class="difflineminus">-</span>
<a href="#l9.113"></a><span id="l9.113" class="difflineminus">-  NS_IMETHOD FindAddressBooks(nsIFile *location, nsIArray **_retval);</span>
<a href="#l9.114"></a><span id="l9.114" class="difflineminus">-</span>
<a href="#l9.115"></a><span id="l9.115" class="difflineminus">-  NS_IMETHOD InitFieldMap(nsIImportFieldMap *fieldMap)</span>
<a href="#l9.116"></a><span id="l9.116" class="difflineminus">-    { return NS_ERROR_FAILURE; }</span>
<a href="#l9.117"></a><span id="l9.117" class="difflineminus">-</span>
<a href="#l9.118"></a><span id="l9.118" class="difflineminus">-  NS_IMETHOD ImportAddressBook(nsIImportABDescriptor *source,</span>
<a href="#l9.119"></a><span id="l9.119" class="difflineminus">-                               nsIAddrDatabase *destination,</span>
<a href="#l9.120"></a><span id="l9.120" class="difflineminus">-                               nsIImportFieldMap *fieldMap,</span>
<a href="#l9.121"></a><span id="l9.121" class="difflineminus">-                               nsISupports *aSupportService,</span>
<a href="#l9.122"></a><span id="l9.122" class="difflineminus">-                               char16_t **errorLog,</span>
<a href="#l9.123"></a><span id="l9.123" class="difflineminus">-                               char16_t **successLog,</span>
<a href="#l9.124"></a><span id="l9.124" class="difflineminus">-                               bool *fatalError);</span>
<a href="#l9.125"></a><span id="l9.125" class="difflineminus">-</span>
<a href="#l9.126"></a><span id="l9.126" class="difflineminus">-  NS_IMETHOD GetImportProgress(uint32_t *_retval);</span>
<a href="#l9.127"></a><span id="l9.127" class="difflineminus">-</span>
<a href="#l9.128"></a><span id="l9.128" class="difflineminus">-  NS_IMETHOD GetSampleData(int32_t index, bool *pFound, char16_t **pStr)</span>
<a href="#l9.129"></a><span id="l9.129" class="difflineminus">-    { return NS_ERROR_FAILURE;}</span>
<a href="#l9.130"></a><span id="l9.130" class="difflineminus">-</span>
<a href="#l9.131"></a><span id="l9.131" class="difflineminus">-  NS_IMETHOD SetSampleLocation(nsIFile *) { return NS_OK; }</span>
<a href="#l9.132"></a><span id="l9.132" class="difflineminus">-</span>
<a href="#l9.133"></a><span id="l9.133" class="difflineminus">-private:</span>
<a href="#l9.134"></a><span id="l9.134" class="difflineminus">-  virtual ~ImportOEAddressImpl();</span>
<a href="#l9.135"></a><span id="l9.135" class="difflineminus">-  static void ReportSuccess(nsString&amp; name, nsString *pStream);</span>
<a href="#l9.136"></a><span id="l9.136" class="difflineminus">-</span>
<a href="#l9.137"></a><span id="l9.137" class="difflineminus">-private:</span>
<a href="#l9.138"></a><span id="l9.138" class="difflineminus">-  CWAB * m_pWab;</span>
<a href="#l9.139"></a><span id="l9.139" class="difflineminus">-  int m_doneSoFar;</span>
<a href="#l9.140"></a><span id="l9.140" class="difflineminus">-};</span>
<a href="#l9.141"></a><span id="l9.141" class="difflineminus">-////////////////////////////////////////////////////////////////////////</span>
<a href="#l9.142"></a><span id="l9.142" class="difflineminus">-</span>
<a href="#l9.143"></a><span id="l9.143" class="difflineminus">-</span>
<a href="#l9.144"></a><span id="l9.144" class="difflineminus">-////////////////////////////////////////////////////////////////////////</span>
<a href="#l9.145"></a><span id="l9.145" class="difflineminus">-</span>
<a href="#l9.146"></a><span id="l9.146" class="difflineminus">-</span>
<a href="#l9.147"></a><span id="l9.147" class="difflineminus">-nsOEImport::nsOEImport()</span>
<a href="#l9.148"></a><span id="l9.148" class="difflineminus">-{</span>
<a href="#l9.149"></a><span id="l9.149" class="difflineminus">-  // Init logging module.</span>
<a href="#l9.150"></a><span id="l9.150" class="difflineminus">-  if (!OELOGMODULE)</span>
<a href="#l9.151"></a><span id="l9.151" class="difflineminus">-    OELOGMODULE = PR_NewLogModule(&quot;IMPORT&quot;);</span>
<a href="#l9.152"></a><span id="l9.152" class="difflineminus">-  IMPORT_LOG0(&quot;nsOEImport Module Created\n&quot;);</span>
<a href="#l9.153"></a><span id="l9.153" class="difflineminus">-  nsOEStringBundle::GetStringBundle();</span>
<a href="#l9.154"></a><span id="l9.154" class="difflineminus">-}</span>
<a href="#l9.155"></a><span id="l9.155" class="difflineminus">-</span>
<a href="#l9.156"></a><span id="l9.156" class="difflineminus">-</span>
<a href="#l9.157"></a><span id="l9.157" class="difflineminus">-nsOEImport::~nsOEImport()</span>
<a href="#l9.158"></a><span id="l9.158" class="difflineminus">-{</span>
<a href="#l9.159"></a><span id="l9.159" class="difflineminus">-  IMPORT_LOG0(&quot;nsOEImport Module Deleted\n&quot;);</span>
<a href="#l9.160"></a><span id="l9.160" class="difflineminus">-}</span>
<a href="#l9.161"></a><span id="l9.161" class="difflineminus">-</span>
<a href="#l9.162"></a><span id="l9.162" class="difflineminus">-NS_IMPL_ISUPPORTS(nsOEImport, nsIImportModule)</span>
<a href="#l9.163"></a><span id="l9.163" class="difflineminus">-</span>
<a href="#l9.164"></a><span id="l9.164" class="difflineminus">-NS_IMETHODIMP nsOEImport::GetName(char16_t **name)</span>
<a href="#l9.165"></a><span id="l9.165" class="difflineminus">-{</span>
<a href="#l9.166"></a><span id="l9.166" class="difflineminus">-  NS_ENSURE_ARG_POINTER(name);</span>
<a href="#l9.167"></a><span id="l9.167" class="difflineminus">-</span>
<a href="#l9.168"></a><span id="l9.168" class="difflineminus">-  *name = nsOEStringBundle::GetStringByID(OEIMPORT_NAME);</span>
<a href="#l9.169"></a><span id="l9.169" class="difflineminus">-</span>
<a href="#l9.170"></a><span id="l9.170" class="difflineminus">-    return NS_OK;</span>
<a href="#l9.171"></a><span id="l9.171" class="difflineminus">-}</span>
<a href="#l9.172"></a><span id="l9.172" class="difflineminus">-</span>
<a href="#l9.173"></a><span id="l9.173" class="difflineminus">-NS_IMETHODIMP nsOEImport::GetDescription(char16_t **name)</span>
<a href="#l9.174"></a><span id="l9.174" class="difflineminus">-{</span>
<a href="#l9.175"></a><span id="l9.175" class="difflineminus">-  NS_ENSURE_ARG_POINTER(name);</span>
<a href="#l9.176"></a><span id="l9.176" class="difflineminus">-</span>
<a href="#l9.177"></a><span id="l9.177" class="difflineminus">-  *name = nsOEStringBundle::GetStringByID(OEIMPORT_DESCRIPTION);</span>
<a href="#l9.178"></a><span id="l9.178" class="difflineminus">-  return NS_OK;</span>
<a href="#l9.179"></a><span id="l9.179" class="difflineminus">-}</span>
<a href="#l9.180"></a><span id="l9.180" class="difflineminus">-</span>
<a href="#l9.181"></a><span id="l9.181" class="difflineminus">-NS_IMETHODIMP nsOEImport::GetSupports(char **supports)</span>
<a href="#l9.182"></a><span id="l9.182" class="difflineminus">-{</span>
<a href="#l9.183"></a><span id="l9.183" class="difflineminus">-  NS_PRECONDITION(supports != nullptr, &quot;null ptr&quot;);</span>
<a href="#l9.184"></a><span id="l9.184" class="difflineminus">-  if (! supports)</span>
<a href="#l9.185"></a><span id="l9.185" class="difflineminus">-      return NS_ERROR_NULL_POINTER;</span>
<a href="#l9.186"></a><span id="l9.186" class="difflineminus">-</span>
<a href="#l9.187"></a><span id="l9.187" class="difflineminus">-  *supports = strdup(kOESupportsString);</span>
<a href="#l9.188"></a><span id="l9.188" class="difflineminus">-  return NS_OK;</span>
<a href="#l9.189"></a><span id="l9.189" class="difflineminus">-}</span>
<a href="#l9.190"></a><span id="l9.190" class="difflineminus">-</span>
<a href="#l9.191"></a><span id="l9.191" class="difflineminus">-</span>
<a href="#l9.192"></a><span id="l9.192" class="difflineminus">-NS_IMETHODIMP nsOEImport::GetSupportsUpgrade(bool *pUpgrade)</span>
<a href="#l9.193"></a><span id="l9.193" class="difflineminus">-{</span>
<a href="#l9.194"></a><span id="l9.194" class="difflineminus">-  NS_PRECONDITION(pUpgrade != nullptr, &quot;null ptr&quot;);</span>
<a href="#l9.195"></a><span id="l9.195" class="difflineminus">-  if (! pUpgrade)</span>
<a href="#l9.196"></a><span id="l9.196" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l9.197"></a><span id="l9.197" class="difflineminus">-</span>
<a href="#l9.198"></a><span id="l9.198" class="difflineminus">-  *pUpgrade = true;</span>
<a href="#l9.199"></a><span id="l9.199" class="difflineminus">-  return NS_OK;</span>
<a href="#l9.200"></a><span id="l9.200" class="difflineminus">-}</span>
<a href="#l9.201"></a><span id="l9.201" class="difflineminus">-</span>
<a href="#l9.202"></a><span id="l9.202" class="difflineminus">-NS_IMETHODIMP nsOEImport::GetImportInterface(const char *pImportType, nsISupports **ppInterface)</span>
<a href="#l9.203"></a><span id="l9.203" class="difflineminus">-{</span>
<a href="#l9.204"></a><span id="l9.204" class="difflineminus">-  NS_ENSURE_ARG_POINTER(pImportType);</span>
<a href="#l9.205"></a><span id="l9.205" class="difflineminus">-  NS_ENSURE_ARG_POINTER(ppInterface);</span>
<a href="#l9.206"></a><span id="l9.206" class="difflineminus">-</span>
<a href="#l9.207"></a><span id="l9.207" class="difflineminus">-  *ppInterface = nullptr;</span>
<a href="#l9.208"></a><span id="l9.208" class="difflineminus">-  nsresult rv;</span>
<a href="#l9.209"></a><span id="l9.209" class="difflineminus">-  if (!strcmp(pImportType, &quot;mail&quot;)) {</span>
<a href="#l9.210"></a><span id="l9.210" class="difflineminus">-    // create the nsIImportMail interface and return it!</span>
<a href="#l9.211"></a><span id="l9.211" class="difflineminus">-    nsIImportMail *  pMail = nullptr;</span>
<a href="#l9.212"></a><span id="l9.212" class="difflineminus">-    nsIImportGeneric *pGeneric = nullptr;</span>
<a href="#l9.213"></a><span id="l9.213" class="difflineminus">-    rv = ImportOEMailImpl::Create(&amp;pMail);</span>
<a href="#l9.214"></a><span id="l9.214" class="difflineminus">-    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l9.215"></a><span id="l9.215" class="difflineminus">-      nsCOMPtr&lt;nsIImportService&gt; impSvc(do_GetService(NS_IMPORTSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l9.216"></a><span id="l9.216" class="difflineminus">-      if (NS_SUCCEEDED(rv)) {</span>
<a href="#l9.217"></a><span id="l9.217" class="difflineminus">-        rv = impSvc-&gt;CreateNewGenericMail(&amp;pGeneric);</span>
<a href="#l9.218"></a><span id="l9.218" class="difflineminus">-        if (NS_SUCCEEDED(rv)) {</span>
<a href="#l9.219"></a><span id="l9.219" class="difflineminus">-          pGeneric-&gt;SetData(&quot;mailInterface&quot;, pMail);</span>
<a href="#l9.220"></a><span id="l9.220" class="difflineminus">-          nsString name;</span>
<a href="#l9.221"></a><span id="l9.221" class="difflineminus">-          nsOEStringBundle::GetStringByID(OEIMPORT_NAME, name);</span>
<a href="#l9.222"></a><span id="l9.222" class="difflineminus">-          nsCOMPtr&lt;nsISupportsString&gt; nameString (do_CreateInstance(NS_SUPPORTS_STRING_CONTRACTID, &amp;rv));</span>
<a href="#l9.223"></a><span id="l9.223" class="difflineminus">-          if (NS_SUCCEEDED(rv)) {</span>
<a href="#l9.224"></a><span id="l9.224" class="difflineminus">-            nameString-&gt;SetData(name);</span>
<a href="#l9.225"></a><span id="l9.225" class="difflineminus">-            pGeneric-&gt;SetData(&quot;name&quot;, nameString);</span>
<a href="#l9.226"></a><span id="l9.226" class="difflineminus">-            rv = pGeneric-&gt;QueryInterface(kISupportsIID, (void **)ppInterface);</span>
<a href="#l9.227"></a><span id="l9.227" class="difflineminus">-          }</span>
<a href="#l9.228"></a><span id="l9.228" class="difflineminus">-        }</span>
<a href="#l9.229"></a><span id="l9.229" class="difflineminus">-      }</span>
<a href="#l9.230"></a><span id="l9.230" class="difflineminus">-    }</span>
<a href="#l9.231"></a><span id="l9.231" class="difflineminus">-    NS_IF_RELEASE(pMail);</span>
<a href="#l9.232"></a><span id="l9.232" class="difflineminus">-    NS_IF_RELEASE(pGeneric);</span>
<a href="#l9.233"></a><span id="l9.233" class="difflineminus">-    return rv;</span>
<a href="#l9.234"></a><span id="l9.234" class="difflineminus">-  }</span>
<a href="#l9.235"></a><span id="l9.235" class="difflineminus">-</span>
<a href="#l9.236"></a><span id="l9.236" class="difflineminus">-  if (!strcmp(pImportType, &quot;addressbook&quot;)) {</span>
<a href="#l9.237"></a><span id="l9.237" class="difflineminus">-    // create the nsIImportMail interface and return it!</span>
<a href="#l9.238"></a><span id="l9.238" class="difflineminus">-    nsIImportAddressBooks * pAddress = nullptr;</span>
<a href="#l9.239"></a><span id="l9.239" class="difflineminus">-    nsIImportGeneric * pGeneric = nullptr;</span>
<a href="#l9.240"></a><span id="l9.240" class="difflineminus">-    rv = ImportOEAddressImpl::Create(&amp;pAddress);</span>
<a href="#l9.241"></a><span id="l9.241" class="difflineminus">-    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l9.242"></a><span id="l9.242" class="difflineminus">-      nsCOMPtr&lt;nsIImportService&gt; impSvc(do_GetService(NS_IMPORTSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l9.243"></a><span id="l9.243" class="difflineminus">-      if (NS_SUCCEEDED(rv)) {</span>
<a href="#l9.244"></a><span id="l9.244" class="difflineminus">-        rv = impSvc-&gt;CreateNewGenericAddressBooks(&amp;pGeneric);</span>
<a href="#l9.245"></a><span id="l9.245" class="difflineminus">-        if (NS_SUCCEEDED(rv)) {</span>
<a href="#l9.246"></a><span id="l9.246" class="difflineminus">-          pGeneric-&gt;SetData(&quot;addressInterface&quot;, pAddress);</span>
<a href="#l9.247"></a><span id="l9.247" class="difflineminus">-          rv = pGeneric-&gt;QueryInterface(kISupportsIID, (void **)ppInterface);</span>
<a href="#l9.248"></a><span id="l9.248" class="difflineminus">-        }</span>
<a href="#l9.249"></a><span id="l9.249" class="difflineminus">-      }</span>
<a href="#l9.250"></a><span id="l9.250" class="difflineminus">-    }</span>
<a href="#l9.251"></a><span id="l9.251" class="difflineminus">-    NS_IF_RELEASE(pAddress);</span>
<a href="#l9.252"></a><span id="l9.252" class="difflineminus">-    NS_IF_RELEASE(pGeneric);</span>
<a href="#l9.253"></a><span id="l9.253" class="difflineminus">-    return rv;</span>
<a href="#l9.254"></a><span id="l9.254" class="difflineminus">-  }</span>
<a href="#l9.255"></a><span id="l9.255" class="difflineminus">-</span>
<a href="#l9.256"></a><span id="l9.256" class="difflineminus">-  if (!strcmp(pImportType, &quot;settings&quot;)) {</span>
<a href="#l9.257"></a><span id="l9.257" class="difflineminus">-    nsIImportSettings *pSettings = nullptr;</span>
<a href="#l9.258"></a><span id="l9.258" class="difflineminus">-    rv = nsOESettings::Create(&amp;pSettings);</span>
<a href="#l9.259"></a><span id="l9.259" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l9.260"></a><span id="l9.260" class="difflineminus">-      pSettings-&gt;QueryInterface(kISupportsIID, (void **)ppInterface);</span>
<a href="#l9.261"></a><span id="l9.261" class="difflineminus">-    NS_IF_RELEASE(pSettings);</span>
<a href="#l9.262"></a><span id="l9.262" class="difflineminus">-    return rv;</span>
<a href="#l9.263"></a><span id="l9.263" class="difflineminus">-  }</span>
<a href="#l9.264"></a><span id="l9.264" class="difflineminus">-</span>
<a href="#l9.265"></a><span id="l9.265" class="difflineminus">-  return NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l9.266"></a><span id="l9.266" class="difflineminus">-}</span>
<a href="#l9.267"></a><span id="l9.267" class="difflineminus">-</span>
<a href="#l9.268"></a><span id="l9.268" class="difflineminus">-/////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l9.269"></a><span id="l9.269" class="difflineminus">-nsresult ImportOEMailImpl::Create(nsIImportMail** aImport)</span>
<a href="#l9.270"></a><span id="l9.270" class="difflineminus">-{</span>
<a href="#l9.271"></a><span id="l9.271" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aImport);</span>
<a href="#l9.272"></a><span id="l9.272" class="difflineminus">-  *aImport = new ImportOEMailImpl();</span>
<a href="#l9.273"></a><span id="l9.273" class="difflineminus">-  NS_ENSURE_TRUE(*aImport, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l9.274"></a><span id="l9.274" class="difflineminus">-  NS_ADDREF(*aImport);</span>
<a href="#l9.275"></a><span id="l9.275" class="difflineminus">-  return NS_OK;</span>
<a href="#l9.276"></a><span id="l9.276" class="difflineminus">-}</span>
<a href="#l9.277"></a><span id="l9.277" class="difflineminus">-</span>
<a href="#l9.278"></a><span id="l9.278" class="difflineminus">-ImportOEMailImpl::ImportOEMailImpl()</span>
<a href="#l9.279"></a><span id="l9.279" class="difflineminus">-{</span>
<a href="#l9.280"></a><span id="l9.280" class="difflineminus">-}</span>
<a href="#l9.281"></a><span id="l9.281" class="difflineminus">-</span>
<a href="#l9.282"></a><span id="l9.282" class="difflineminus">-</span>
<a href="#l9.283"></a><span id="l9.283" class="difflineminus">-ImportOEMailImpl::~ImportOEMailImpl()</span>
<a href="#l9.284"></a><span id="l9.284" class="difflineminus">-{</span>
<a href="#l9.285"></a><span id="l9.285" class="difflineminus">-}</span>
<a href="#l9.286"></a><span id="l9.286" class="difflineminus">-</span>
<a href="#l9.287"></a><span id="l9.287" class="difflineminus">-NS_IMPL_ISUPPORTS(ImportOEMailImpl, nsIImportMail)</span>
<a href="#l9.288"></a><span id="l9.288" class="difflineminus">-</span>
<a href="#l9.289"></a><span id="l9.289" class="difflineminus">-NS_IMETHODIMP ImportOEMailImpl::TranslateFolderName(const nsAString &amp; aFolderName, nsAString &amp; _retval)</span>
<a href="#l9.290"></a><span id="l9.290" class="difflineminus">-{</span>
<a href="#l9.291"></a><span id="l9.291" class="difflineminus">-  if (aFolderName.LowerCaseEqualsLiteral(&quot;deleted items&quot;))</span>
<a href="#l9.292"></a><span id="l9.292" class="difflineminus">-      _retval = NS_LITERAL_STRING(kDestTrashFolderName);</span>
<a href="#l9.293"></a><span id="l9.293" class="difflineminus">-  else if (aFolderName.LowerCaseEqualsLiteral(&quot;sent items&quot;))</span>
<a href="#l9.294"></a><span id="l9.294" class="difflineminus">-      _retval = NS_LITERAL_STRING(kDestSentFolderName);</span>
<a href="#l9.295"></a><span id="l9.295" class="difflineminus">-  else if (aFolderName.LowerCaseEqualsLiteral(&quot;outbox&quot;))</span>
<a href="#l9.296"></a><span id="l9.296" class="difflineminus">-      _retval = NS_LITERAL_STRING(kDestUnsentMessagesFolderName);</span>
<a href="#l9.297"></a><span id="l9.297" class="difflineminus">-  else</span>
<a href="#l9.298"></a><span id="l9.298" class="difflineminus">-      _retval = aFolderName;</span>
<a href="#l9.299"></a><span id="l9.299" class="difflineminus">-</span>
<a href="#l9.300"></a><span id="l9.300" class="difflineminus">-  return NS_OK;</span>
<a href="#l9.301"></a><span id="l9.301" class="difflineminus">-}</span>
<a href="#l9.302"></a><span id="l9.302" class="difflineminus">-</span>
<a href="#l9.303"></a><span id="l9.303" class="difflineminus">-NS_IMETHODIMP ImportOEMailImpl::GetDefaultLocation(nsIFile **ppLoc, bool *found, bool *userVerify)</span>
<a href="#l9.304"></a><span id="l9.304" class="difflineminus">-{</span>
<a href="#l9.305"></a><span id="l9.305" class="difflineminus">-  NS_PRECONDITION(ppLoc != nullptr, &quot;null ptr&quot;);</span>
<a href="#l9.306"></a><span id="l9.306" class="difflineminus">-  NS_PRECONDITION(found != nullptr, &quot;null ptr&quot;);</span>
<a href="#l9.307"></a><span id="l9.307" class="difflineminus">-  NS_PRECONDITION(userVerify != nullptr, &quot;null ptr&quot;);</span>
<a href="#l9.308"></a><span id="l9.308" class="difflineminus">-  if (!ppLoc || !found || !userVerify)</span>
<a href="#l9.309"></a><span id="l9.309" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l9.310"></a><span id="l9.310" class="difflineminus">-</span>
<a href="#l9.311"></a><span id="l9.311" class="difflineminus">-  // use scanboxes to find the location.</span>
<a href="#l9.312"></a><span id="l9.312" class="difflineminus">-  nsresult rv;</span>
<a href="#l9.313"></a><span id="l9.313" class="difflineminus">-  nsCOMPtr &lt;nsIFile&gt; file = do_CreateInstance(NS_LOCAL_FILE_CONTRACTID, &amp;rv);</span>
<a href="#l9.314"></a><span id="l9.314" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l9.315"></a><span id="l9.315" class="difflineminus">-    return rv;</span>
<a href="#l9.316"></a><span id="l9.316" class="difflineminus">-</span>
<a href="#l9.317"></a><span id="l9.317" class="difflineminus">-  if (nsOEScanBoxes::FindMail(file)) {</span>
<a href="#l9.318"></a><span id="l9.318" class="difflineminus">-    *found = true;</span>
<a href="#l9.319"></a><span id="l9.319" class="difflineminus">-    NS_IF_ADDREF(*ppLoc = file);</span>
<a href="#l9.320"></a><span id="l9.320" class="difflineminus">-  }</span>
<a href="#l9.321"></a><span id="l9.321" class="difflineminus">-  else {</span>
<a href="#l9.322"></a><span id="l9.322" class="difflineminus">-    *found = false;</span>
<a href="#l9.323"></a><span id="l9.323" class="difflineminus">-    *ppLoc = nullptr;</span>
<a href="#l9.324"></a><span id="l9.324" class="difflineminus">-  }</span>
<a href="#l9.325"></a><span id="l9.325" class="difflineminus">-  *userVerify = true;</span>
<a href="#l9.326"></a><span id="l9.326" class="difflineminus">-  return NS_OK;</span>
<a href="#l9.327"></a><span id="l9.327" class="difflineminus">-}</span>
<a href="#l9.328"></a><span id="l9.328" class="difflineminus">-</span>
<a href="#l9.329"></a><span id="l9.329" class="difflineminus">-</span>
<a href="#l9.330"></a><span id="l9.330" class="difflineminus">-NS_IMETHODIMP ImportOEMailImpl::FindMailboxes(nsIFile *pLoc, nsIArray **ppArray)</span>
<a href="#l9.331"></a><span id="l9.331" class="difflineminus">-{</span>
<a href="#l9.332"></a><span id="l9.332" class="difflineminus">-    NS_PRECONDITION(pLoc != nullptr, &quot;null ptr&quot;);</span>
<a href="#l9.333"></a><span id="l9.333" class="difflineminus">-    NS_PRECONDITION(ppArray != nullptr, &quot;null ptr&quot;);</span>
<a href="#l9.334"></a><span id="l9.334" class="difflineminus">-    if (!pLoc || !ppArray)</span>
<a href="#l9.335"></a><span id="l9.335" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l9.336"></a><span id="l9.336" class="difflineminus">-</span>
<a href="#l9.337"></a><span id="l9.337" class="difflineminus">-  bool exists = false;</span>
<a href="#l9.338"></a><span id="l9.338" class="difflineminus">-  nsresult rv = pLoc-&gt;Exists(&amp;exists);</span>
<a href="#l9.339"></a><span id="l9.339" class="difflineminus">-  if (NS_FAILED(rv) || !exists)</span>
<a href="#l9.340"></a><span id="l9.340" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l9.341"></a><span id="l9.341" class="difflineminus">-</span>
<a href="#l9.342"></a><span id="l9.342" class="difflineminus">-  nsOEScanBoxes  scan;</span>
<a href="#l9.343"></a><span id="l9.343" class="difflineminus">-</span>
<a href="#l9.344"></a><span id="l9.344" class="difflineminus">-  if (!scan.GetMailboxes(pLoc, ppArray))</span>
<a href="#l9.345"></a><span id="l9.345" class="difflineminus">-    *ppArray = nullptr;</span>
<a href="#l9.346"></a><span id="l9.346" class="difflineminus">-</span>
<a href="#l9.347"></a><span id="l9.347" class="difflineminus">-  return NS_OK;</span>
<a href="#l9.348"></a><span id="l9.348" class="difflineminus">-}</span>
<a href="#l9.349"></a><span id="l9.349" class="difflineminus">-</span>
<a href="#l9.350"></a><span id="l9.350" class="difflineminus">-void ImportOEMailImpl::AddLinebreak(nsString *pStream)</span>
<a href="#l9.351"></a><span id="l9.351" class="difflineminus">-{</span>
<a href="#l9.352"></a><span id="l9.352" class="difflineminus">-  if (pStream)</span>
<a href="#l9.353"></a><span id="l9.353" class="difflineminus">-    pStream-&gt;Append(char16_t('\n'));</span>
<a href="#l9.354"></a><span id="l9.354" class="difflineminus">-}</span>
<a href="#l9.355"></a><span id="l9.355" class="difflineminus">-</span>
<a href="#l9.356"></a><span id="l9.356" class="difflineminus">-void ImportOEMailImpl::ReportSuccess(nsString&amp; name, int32_t count, nsString *pStream)</span>
<a href="#l9.357"></a><span id="l9.357" class="difflineminus">-{</span>
<a href="#l9.358"></a><span id="l9.358" class="difflineminus">-  if (!pStream)</span>
<a href="#l9.359"></a><span id="l9.359" class="difflineminus">-    return;</span>
<a href="#l9.360"></a><span id="l9.360" class="difflineminus">-  // load the success string</span>
<a href="#l9.361"></a><span id="l9.361" class="difflineminus">-  char16_t *pFmt = nsOEStringBundle::GetStringByID(OEIMPORT_MAILBOX_SUCCESS);</span>
<a href="#l9.362"></a><span id="l9.362" class="difflineminus">-  char16_t *pText = nsTextFormatter::smprintf(pFmt, name.get(), count);</span>
<a href="#l9.363"></a><span id="l9.363" class="difflineminus">-  pStream-&gt;Append(pText);</span>
<a href="#l9.364"></a><span id="l9.364" class="difflineminus">-  nsTextFormatter::smprintf_free(pText);</span>
<a href="#l9.365"></a><span id="l9.365" class="difflineminus">-  nsOEStringBundle::FreeString(pFmt);</span>
<a href="#l9.366"></a><span id="l9.366" class="difflineminus">-  AddLinebreak(pStream);</span>
<a href="#l9.367"></a><span id="l9.367" class="difflineminus">-}</span>
<a href="#l9.368"></a><span id="l9.368" class="difflineminus">-</span>
<a href="#l9.369"></a><span id="l9.369" class="difflineminus">-void ImportOEMailImpl::ReportError(int32_t errorNum, nsString&amp; name, nsString *pStream)</span>
<a href="#l9.370"></a><span id="l9.370" class="difflineminus">-{</span>
<a href="#l9.371"></a><span id="l9.371" class="difflineminus">-  if (!pStream)</span>
<a href="#l9.372"></a><span id="l9.372" class="difflineminus">-    return;</span>
<a href="#l9.373"></a><span id="l9.373" class="difflineminus">-  // load the error string</span>
<a href="#l9.374"></a><span id="l9.374" class="difflineminus">-  char16_t *pFmt = nsOEStringBundle::GetStringByID(errorNum);</span>
<a href="#l9.375"></a><span id="l9.375" class="difflineminus">-  char16_t *pText = nsTextFormatter::smprintf(pFmt, name.get());</span>
<a href="#l9.376"></a><span id="l9.376" class="difflineminus">-  pStream-&gt;Append(pText);</span>
<a href="#l9.377"></a><span id="l9.377" class="difflineminus">-  nsTextFormatter::smprintf_free(pText);</span>
<a href="#l9.378"></a><span id="l9.378" class="difflineminus">-  nsOEStringBundle::FreeString(pFmt);</span>
<a href="#l9.379"></a><span id="l9.379" class="difflineminus">-  AddLinebreak(pStream);</span>
<a href="#l9.380"></a><span id="l9.380" class="difflineminus">-}</span>
<a href="#l9.381"></a><span id="l9.381" class="difflineminus">-</span>
<a href="#l9.382"></a><span id="l9.382" class="difflineminus">-</span>
<a href="#l9.383"></a><span id="l9.383" class="difflineminus">-void ImportOEMailImpl::SetLogs(nsString&amp; success, nsString&amp; error, char16_t **pError, char16_t **pSuccess)</span>
<a href="#l9.384"></a><span id="l9.384" class="difflineminus">-{</span>
<a href="#l9.385"></a><span id="l9.385" class="difflineminus">-  if (pError)</span>
<a href="#l9.386"></a><span id="l9.386" class="difflineminus">-    *pError = ToNewUnicode(error);</span>
<a href="#l9.387"></a><span id="l9.387" class="difflineminus">-  if (pSuccess)</span>
<a href="#l9.388"></a><span id="l9.388" class="difflineminus">-    *pSuccess = ToNewUnicode(success);</span>
<a href="#l9.389"></a><span id="l9.389" class="difflineminus">-}</span>
<a href="#l9.390"></a><span id="l9.390" class="difflineminus">-</span>
<a href="#l9.391"></a><span id="l9.391" class="difflineminus">-NS_IMETHODIMP ImportOEMailImpl::ImportMailbox(nsIImportMailboxDescriptor *pSource,</span>
<a href="#l9.392"></a><span id="l9.392" class="difflineminus">-                                              nsIMsgFolder *dstFolder,</span>
<a href="#l9.393"></a><span id="l9.393" class="difflineminus">-                                              char16_t **pErrorLog,</span>
<a href="#l9.394"></a><span id="l9.394" class="difflineminus">-                                              char16_t **pSuccessLog,</span>
<a href="#l9.395"></a><span id="l9.395" class="difflineminus">-                                              bool *fatalError)</span>
<a href="#l9.396"></a><span id="l9.396" class="difflineminus">-{</span>
<a href="#l9.397"></a><span id="l9.397" class="difflineminus">-  NS_ENSURE_ARG_POINTER(pSource);</span>
<a href="#l9.398"></a><span id="l9.398" class="difflineminus">-  NS_ENSURE_ARG_POINTER(dstFolder);</span>
<a href="#l9.399"></a><span id="l9.399" class="difflineminus">-  NS_ENSURE_ARG_POINTER(fatalError);</span>
<a href="#l9.400"></a><span id="l9.400" class="difflineminus">-</span>
<a href="#l9.401"></a><span id="l9.401" class="difflineminus">-  nsString success;</span>
<a href="#l9.402"></a><span id="l9.402" class="difflineminus">-  nsString error;</span>
<a href="#l9.403"></a><span id="l9.403" class="difflineminus">-  bool abort = false;</span>
<a href="#l9.404"></a><span id="l9.404" class="difflineminus">-  nsString name;</span>
<a href="#l9.405"></a><span id="l9.405" class="difflineminus">-  nsString pName;</span>
<a href="#l9.406"></a><span id="l9.406" class="difflineminus">-  if (NS_SUCCEEDED(pSource-&gt;GetDisplayName(getter_Copies(pName))))</span>
<a href="#l9.407"></a><span id="l9.407" class="difflineminus">-    name = pName;</span>
<a href="#l9.408"></a><span id="l9.408" class="difflineminus">-</span>
<a href="#l9.409"></a><span id="l9.409" class="difflineminus">-  uint32_t mailSize = 0;</span>
<a href="#l9.410"></a><span id="l9.410" class="difflineminus">-  pSource-&gt;GetSize(&amp;mailSize);</span>
<a href="#l9.411"></a><span id="l9.411" class="difflineminus">-  if (mailSize == 0) {</span>
<a href="#l9.412"></a><span id="l9.412" class="difflineminus">-    ReportSuccess(name, 0, &amp;success);</span>
<a href="#l9.413"></a><span id="l9.413" class="difflineminus">-    SetLogs(success, error, pErrorLog, pSuccessLog);</span>
<a href="#l9.414"></a><span id="l9.414" class="difflineminus">-    return NS_OK;</span>
<a href="#l9.415"></a><span id="l9.415" class="difflineminus">-  }</span>
<a href="#l9.416"></a><span id="l9.416" class="difflineminus">-</span>
<a href="#l9.417"></a><span id="l9.417" class="difflineminus">-  nsCOMPtr &lt;nsIFile&gt; inFile;</span>
<a href="#l9.418"></a><span id="l9.418" class="difflineminus">-  if (NS_FAILED(pSource-&gt;GetFile(getter_AddRefs(inFile)))) {</span>
<a href="#l9.419"></a><span id="l9.419" class="difflineminus">-    ReportError(OEIMPORT_MAILBOX_BADSOURCEFILE, name, &amp;error);</span>
<a href="#l9.420"></a><span id="l9.420" class="difflineminus">-    SetLogs(success, error, pErrorLog, pSuccessLog);</span>
<a href="#l9.421"></a><span id="l9.421" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l9.422"></a><span id="l9.422" class="difflineminus">-  }</span>
<a href="#l9.423"></a><span id="l9.423" class="difflineminus">-</span>
<a href="#l9.424"></a><span id="l9.424" class="difflineminus">-  nsCString pPath;</span>
<a href="#l9.425"></a><span id="l9.425" class="difflineminus">-  inFile-&gt;GetNativePath(pPath);</span>
<a href="#l9.426"></a><span id="l9.426" class="difflineminus">-  IMPORT_LOG1(&quot;Importing Outlook Express mailbox: %s\n&quot;, pPath.get());</span>
<a href="#l9.427"></a><span id="l9.427" class="difflineminus">-</span>
<a href="#l9.428"></a><span id="l9.428" class="difflineminus">-  m_bytesDone = 0;</span>
<a href="#l9.429"></a><span id="l9.429" class="difflineminus">-  uint32_t msgCount = 0;</span>
<a href="#l9.430"></a><span id="l9.430" class="difflineminus">-  nsresult rv;</span>
<a href="#l9.431"></a><span id="l9.431" class="difflineminus">-  if (nsOE5File::IsLocalMailFile(inFile)) {</span>
<a href="#l9.432"></a><span id="l9.432" class="difflineminus">-    IMPORT_LOG1(&quot;Importing OE5 mailbox: %s!\n&quot;, NS_LossyConvertUTF16toASCII(name.get()));</span>
<a href="#l9.433"></a><span id="l9.433" class="difflineminus">-    rv = nsOE5File::ImportMailbox( &amp;m_bytesDone, &amp;abort, name, inFile, dstFolder, &amp;msgCount);</span>
<a href="#l9.434"></a><span id="l9.434" class="difflineminus">-  }</span>
<a href="#l9.435"></a><span id="l9.435" class="difflineminus">-  else {</span>
<a href="#l9.436"></a><span id="l9.436" class="difflineminus">-    if (CImportMailbox::ImportMailbox( &amp;m_bytesDone, &amp;abort, name, inFile, dstFolder, &amp;msgCount))</span>
<a href="#l9.437"></a><span id="l9.437" class="difflineminus">-       rv = NS_OK;</span>
<a href="#l9.438"></a><span id="l9.438" class="difflineminus">-    else</span>
<a href="#l9.439"></a><span id="l9.439" class="difflineminus">-      rv = NS_ERROR_FAILURE;</span>
<a href="#l9.440"></a><span id="l9.440" class="difflineminus">-  }</span>
<a href="#l9.441"></a><span id="l9.441" class="difflineminus">-</span>
<a href="#l9.442"></a><span id="l9.442" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l9.443"></a><span id="l9.443" class="difflineminus">-    ReportSuccess(name, msgCount, &amp;success);</span>
<a href="#l9.444"></a><span id="l9.444" class="difflineminus">-  else</span>
<a href="#l9.445"></a><span id="l9.445" class="difflineminus">-    ReportError(OEIMPORT_MAILBOX_CONVERTERROR, name, &amp;error);</span>
<a href="#l9.446"></a><span id="l9.446" class="difflineminus">-</span>
<a href="#l9.447"></a><span id="l9.447" class="difflineminus">-  SetLogs(success, error, pErrorLog, pSuccessLog);</span>
<a href="#l9.448"></a><span id="l9.448" class="difflineminus">-</span>
<a href="#l9.449"></a><span id="l9.449" class="difflineminus">-  return rv;</span>
<a href="#l9.450"></a><span id="l9.450" class="difflineminus">-}</span>
<a href="#l9.451"></a><span id="l9.451" class="difflineminus">-</span>
<a href="#l9.452"></a><span id="l9.452" class="difflineminus">-NS_IMETHODIMP ImportOEMailImpl::GetImportProgress(uint32_t *pDoneSoFar)</span>
<a href="#l9.453"></a><span id="l9.453" class="difflineminus">-{</span>
<a href="#l9.454"></a><span id="l9.454" class="difflineminus">-  NS_ENSURE_ARG_POINTER(pDoneSoFar);</span>
<a href="#l9.455"></a><span id="l9.455" class="difflineminus">-  *pDoneSoFar = m_bytesDone;</span>
<a href="#l9.456"></a><span id="l9.456" class="difflineminus">-  return NS_OK;</span>
<a href="#l9.457"></a><span id="l9.457" class="difflineminus">-}</span>
<a href="#l9.458"></a><span id="l9.458" class="difflineminus">-</span>
<a href="#l9.459"></a><span id="l9.459" class="difflineminus">-nsresult ImportOEAddressImpl::Create(nsIImportAddressBooks** aImport)</span>
<a href="#l9.460"></a><span id="l9.460" class="difflineminus">-{</span>
<a href="#l9.461"></a><span id="l9.461" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aImport);</span>
<a href="#l9.462"></a><span id="l9.462" class="difflineminus">-</span>
<a href="#l9.463"></a><span id="l9.463" class="difflineminus">-  *aImport = new ImportOEAddressImpl();</span>
<a href="#l9.464"></a><span id="l9.464" class="difflineminus">-  NS_ENSURE_TRUE(*aImport, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l9.465"></a><span id="l9.465" class="difflineminus">-  NS_ADDREF(*aImport);</span>
<a href="#l9.466"></a><span id="l9.466" class="difflineminus">-  return NS_OK;</span>
<a href="#l9.467"></a><span id="l9.467" class="difflineminus">-}</span>
<a href="#l9.468"></a><span id="l9.468" class="difflineminus">-</span>
<a href="#l9.469"></a><span id="l9.469" class="difflineminus">-ImportOEAddressImpl::ImportOEAddressImpl()</span>
<a href="#l9.470"></a><span id="l9.470" class="difflineminus">-{</span>
<a href="#l9.471"></a><span id="l9.471" class="difflineminus">-  m_pWab = nullptr;</span>
<a href="#l9.472"></a><span id="l9.472" class="difflineminus">-}</span>
<a href="#l9.473"></a><span id="l9.473" class="difflineminus">-</span>
<a href="#l9.474"></a><span id="l9.474" class="difflineminus">-</span>
<a href="#l9.475"></a><span id="l9.475" class="difflineminus">-ImportOEAddressImpl::~ImportOEAddressImpl()</span>
<a href="#l9.476"></a><span id="l9.476" class="difflineminus">-{</span>
<a href="#l9.477"></a><span id="l9.477" class="difflineminus">-  if (m_pWab)</span>
<a href="#l9.478"></a><span id="l9.478" class="difflineminus">-    delete m_pWab;</span>
<a href="#l9.479"></a><span id="l9.479" class="difflineminus">-}</span>
<a href="#l9.480"></a><span id="l9.480" class="difflineminus">-</span>
<a href="#l9.481"></a><span id="l9.481" class="difflineminus">-NS_IMPL_ISUPPORTS(ImportOEAddressImpl, nsIImportAddressBooks)</span>
<a href="#l9.482"></a><span id="l9.482" class="difflineminus">-</span>
<a href="#l9.483"></a><span id="l9.483" class="difflineminus">-NS_IMETHODIMP ImportOEAddressImpl::GetDefaultLocation(nsIFile **aLocation,</span>
<a href="#l9.484"></a><span id="l9.484" class="difflineminus">-                                                      bool *aFound,</span>
<a href="#l9.485"></a><span id="l9.485" class="difflineminus">-                                                      bool *aUserVerify)</span>
<a href="#l9.486"></a><span id="l9.486" class="difflineminus">-{</span>
<a href="#l9.487"></a><span id="l9.487" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aLocation);</span>
<a href="#l9.488"></a><span id="l9.488" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aFound);</span>
<a href="#l9.489"></a><span id="l9.489" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aUserVerify);</span>
<a href="#l9.490"></a><span id="l9.490" class="difflineminus">-</span>
<a href="#l9.491"></a><span id="l9.491" class="difflineminus">-  *aLocation = nullptr;</span>
<a href="#l9.492"></a><span id="l9.492" class="difflineminus">-  *aUserVerify = true;</span>
<a href="#l9.493"></a><span id="l9.493" class="difflineminus">-</span>
<a href="#l9.494"></a><span id="l9.494" class="difflineminus">-  CWAB *wab = new CWAB(nullptr);</span>
<a href="#l9.495"></a><span id="l9.495" class="difflineminus">-  *aFound = wab-&gt;IsAvailable();</span>
<a href="#l9.496"></a><span id="l9.496" class="difflineminus">-  delete wab;</span>
<a href="#l9.497"></a><span id="l9.497" class="difflineminus">-</span>
<a href="#l9.498"></a><span id="l9.498" class="difflineminus">-  if (*aFound) {</span>
<a href="#l9.499"></a><span id="l9.499" class="difflineminus">-    // Unfortunately WAB interface has no function to obtain address book location.</span>
<a href="#l9.500"></a><span id="l9.500" class="difflineminus">-    // So we set a fake location here.</span>
<a href="#l9.501"></a><span id="l9.501" class="difflineminus">-    if (NS_SUCCEEDED(NS_GetSpecialDirectory(NS_XPCOM_CURRENT_PROCESS_DIR, aLocation)))</span>
<a href="#l9.502"></a><span id="l9.502" class="difflineminus">-      *aUserVerify = false;</span>
<a href="#l9.503"></a><span id="l9.503" class="difflineminus">-  }</span>
<a href="#l9.504"></a><span id="l9.504" class="difflineminus">-</span>
<a href="#l9.505"></a><span id="l9.505" class="difflineminus">-  return NS_OK;</span>
<a href="#l9.506"></a><span id="l9.506" class="difflineminus">-}</span>
<a href="#l9.507"></a><span id="l9.507" class="difflineminus">-</span>
<a href="#l9.508"></a><span id="l9.508" class="difflineminus">-NS_IMETHODIMP ImportOEAddressImpl::GetAutoFind(char16_t **description, bool *_retval)</span>
<a href="#l9.509"></a><span id="l9.509" class="difflineminus">-{</span>
<a href="#l9.510"></a><span id="l9.510" class="difflineminus">-  NS_PRECONDITION(description != nullptr, &quot;null ptr&quot;);</span>
<a href="#l9.511"></a><span id="l9.511" class="difflineminus">-  NS_PRECONDITION(_retval != nullptr, &quot;null ptr&quot;);</span>
<a href="#l9.512"></a><span id="l9.512" class="difflineminus">-  if (! description || !_retval)</span>
<a href="#l9.513"></a><span id="l9.513" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l9.514"></a><span id="l9.514" class="difflineminus">-</span>
<a href="#l9.515"></a><span id="l9.515" class="difflineminus">-  *_retval = false;</span>
<a href="#l9.516"></a><span id="l9.516" class="difflineminus">-  nsString str;</span>
<a href="#l9.517"></a><span id="l9.517" class="difflineminus">-  str.Append(nsOEStringBundle::GetStringByID(OEIMPORT_AUTOFIND));</span>
<a href="#l9.518"></a><span id="l9.518" class="difflineminus">-  *description = ToNewUnicode(str);</span>
<a href="#l9.519"></a><span id="l9.519" class="difflineminus">-  return NS_OK;</span>
<a href="#l9.520"></a><span id="l9.520" class="difflineminus">-}</span>
<a href="#l9.521"></a><span id="l9.521" class="difflineminus">-</span>
<a href="#l9.522"></a><span id="l9.522" class="difflineminus">-</span>
<a href="#l9.523"></a><span id="l9.523" class="difflineminus">-</span>
<a href="#l9.524"></a><span id="l9.524" class="difflineminus">-NS_IMETHODIMP ImportOEAddressImpl::FindAddressBooks(nsIFile *location, nsIArray **_retval)</span>
<a href="#l9.525"></a><span id="l9.525" class="difflineminus">-{</span>
<a href="#l9.526"></a><span id="l9.526" class="difflineminus">-  NS_PRECONDITION(_retval != nullptr, &quot;null ptr&quot;);</span>
<a href="#l9.527"></a><span id="l9.527" class="difflineminus">-  if (!_retval)</span>
<a href="#l9.528"></a><span id="l9.528" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l9.529"></a><span id="l9.529" class="difflineminus">-</span>
<a href="#l9.530"></a><span id="l9.530" class="difflineminus">-  nsresult rv;</span>
<a href="#l9.531"></a><span id="l9.531" class="difflineminus">-  nsCOMPtr&lt;nsIMutableArray&gt; array(do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l9.532"></a><span id="l9.532" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l9.533"></a><span id="l9.533" class="difflineminus">-    return rv;</span>
<a href="#l9.534"></a><span id="l9.534" class="difflineminus">-</span>
<a href="#l9.535"></a><span id="l9.535" class="difflineminus">-  // Make sure we can load up the windows address book...</span>
<a href="#l9.536"></a><span id="l9.536" class="difflineminus">-  rv = NS_ERROR_FAILURE;</span>
<a href="#l9.537"></a><span id="l9.537" class="difflineminus">-</span>
<a href="#l9.538"></a><span id="l9.538" class="difflineminus">-  if (m_pWab)</span>
<a href="#l9.539"></a><span id="l9.539" class="difflineminus">-    delete m_pWab;</span>
<a href="#l9.540"></a><span id="l9.540" class="difflineminus">-</span>
<a href="#l9.541"></a><span id="l9.541" class="difflineminus">-  nsCOMPtr&lt;nsIFile&gt; currentProcessDir;</span>
<a href="#l9.542"></a><span id="l9.542" class="difflineminus">-  rv = NS_GetSpecialDirectory(NS_XPCOM_CURRENT_PROCESS_DIR,</span>
<a href="#l9.543"></a><span id="l9.543" class="difflineminus">-                              getter_AddRefs(currentProcessDir));</span>
<a href="#l9.544"></a><span id="l9.544" class="difflineminus">-  bool equals = false;</span>
<a href="#l9.545"></a><span id="l9.545" class="difflineminus">-  currentProcessDir-&gt;Equals(location, &amp;equals);</span>
<a href="#l9.546"></a><span id="l9.546" class="difflineminus">-  // If the location is not a fake, use it.</span>
<a href="#l9.547"></a><span id="l9.547" class="difflineminus">-  if (location &amp;&amp; !equals) {</span>
<a href="#l9.548"></a><span id="l9.548" class="difflineminus">-    nsCOMPtr&lt;nsIFile&gt; localFile = do_QueryInterface(location, &amp;rv);</span>
<a href="#l9.549"></a><span id="l9.549" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.550"></a><span id="l9.550" class="difflineminus">-    m_pWab = new CWAB(localFile);</span>
<a href="#l9.551"></a><span id="l9.551" class="difflineminus">-  } else {</span>
<a href="#l9.552"></a><span id="l9.552" class="difflineminus">-    m_pWab = new CWAB(nullptr);</span>
<a href="#l9.553"></a><span id="l9.553" class="difflineminus">-  }</span>
<a href="#l9.554"></a><span id="l9.554" class="difflineminus">-</span>
<a href="#l9.555"></a><span id="l9.555" class="difflineminus">-  nsIImportABDescriptor * pID;</span>
<a href="#l9.556"></a><span id="l9.556" class="difflineminus">-  nsISupports * pInterface;</span>
<a href="#l9.557"></a><span id="l9.557" class="difflineminus">-  nsString str;</span>
<a href="#l9.558"></a><span id="l9.558" class="difflineminus">-  str.Append(nsOEStringBundle::GetStringByID(OEIMPORT_DEFAULT_NAME));</span>
<a href="#l9.559"></a><span id="l9.559" class="difflineminus">-</span>
<a href="#l9.560"></a><span id="l9.560" class="difflineminus">-  if (m_pWab-&gt;Loaded()) {</span>
<a href="#l9.561"></a><span id="l9.561" class="difflineminus">-    // create a new nsIImportABDescriptor and add it to the array</span>
<a href="#l9.562"></a><span id="l9.562" class="difflineminus">-    nsCOMPtr&lt;nsIImportService&gt; impSvc(do_GetService(NS_IMPORTSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l9.563"></a><span id="l9.563" class="difflineminus">-    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l9.564"></a><span id="l9.564" class="difflineminus">-      rv = impSvc-&gt;CreateNewABDescriptor(&amp;pID);</span>
<a href="#l9.565"></a><span id="l9.565" class="difflineminus">-      if (NS_SUCCEEDED(rv)) {</span>
<a href="#l9.566"></a><span id="l9.566" class="difflineminus">-        pID-&gt;SetIdentifier(0x4F453334);</span>
<a href="#l9.567"></a><span id="l9.567" class="difflineminus">-        pID-&gt;SetRef(1);</span>
<a href="#l9.568"></a><span id="l9.568" class="difflineminus">-        pID-&gt;SetSize(100);</span>
<a href="#l9.569"></a><span id="l9.569" class="difflineminus">-        pID-&gt;SetPreferredName(str);</span>
<a href="#l9.570"></a><span id="l9.570" class="difflineminus">-        rv = pID-&gt;QueryInterface(kISupportsIID, (void **) &amp;pInterface);</span>
<a href="#l9.571"></a><span id="l9.571" class="difflineminus">-        array-&gt;AppendElement(pInterface, false);</span>
<a href="#l9.572"></a><span id="l9.572" class="difflineminus">-        pInterface-&gt;Release();</span>
<a href="#l9.573"></a><span id="l9.573" class="difflineminus">-        pID-&gt;Release();</span>
<a href="#l9.574"></a><span id="l9.574" class="difflineminus">-      }</span>
<a href="#l9.575"></a><span id="l9.575" class="difflineminus">-    }</span>
<a href="#l9.576"></a><span id="l9.576" class="difflineminus">-  }</span>
<a href="#l9.577"></a><span id="l9.577" class="difflineminus">-</span>
<a href="#l9.578"></a><span id="l9.578" class="difflineminus">-  if (NS_FAILED(rv)) {</span>
<a href="#l9.579"></a><span id="l9.579" class="difflineminus">-    delete m_pWab;</span>
<a href="#l9.580"></a><span id="l9.580" class="difflineminus">-    m_pWab = nullptr;</span>
<a href="#l9.581"></a><span id="l9.581" class="difflineminus">-  }</span>
<a href="#l9.582"></a><span id="l9.582" class="difflineminus">-  array.forget(_retval);</span>
<a href="#l9.583"></a><span id="l9.583" class="difflineminus">-  return NS_OK;</span>
<a href="#l9.584"></a><span id="l9.584" class="difflineminus">-}</span>
<a href="#l9.585"></a><span id="l9.585" class="difflineminus">-</span>
<a href="#l9.586"></a><span id="l9.586" class="difflineminus">-</span>
<a href="#l9.587"></a><span id="l9.587" class="difflineminus">-</span>
<a href="#l9.588"></a><span id="l9.588" class="difflineminus">-NS_IMETHODIMP ImportOEAddressImpl::ImportAddressBook(nsIImportABDescriptor *source,</span>
<a href="#l9.589"></a><span id="l9.589" class="difflineminus">-                                                     nsIAddrDatabase *destination,</span>
<a href="#l9.590"></a><span id="l9.590" class="difflineminus">-                                                     nsIImportFieldMap *fieldMap,</span>
<a href="#l9.591"></a><span id="l9.591" class="difflineminus">-                                                     nsISupports *aSupportService,</span>
<a href="#l9.592"></a><span id="l9.592" class="difflineminus">-                                                     char16_t **errorLog,</span>
<a href="#l9.593"></a><span id="l9.593" class="difflineminus">-                                                     char16_t **successLog,</span>
<a href="#l9.594"></a><span id="l9.594" class="difflineminus">-                                                     bool *fatalError)</span>
<a href="#l9.595"></a><span id="l9.595" class="difflineminus">-{</span>
<a href="#l9.596"></a><span id="l9.596" class="difflineminus">-    NS_PRECONDITION(source != nullptr, &quot;null ptr&quot;);</span>
<a href="#l9.597"></a><span id="l9.597" class="difflineminus">-    // NS_PRECONDITION(destination != nullptr, &quot;null ptr&quot;);</span>
<a href="#l9.598"></a><span id="l9.598" class="difflineminus">-    // NS_PRECONDITION(fieldMap != nullptr, &quot;null ptr&quot;);</span>
<a href="#l9.599"></a><span id="l9.599" class="difflineminus">-    NS_PRECONDITION(fatalError != nullptr, &quot;null ptr&quot;);</span>
<a href="#l9.600"></a><span id="l9.600" class="difflineminus">-    if (!source || !fatalError)</span>
<a href="#l9.601"></a><span id="l9.601" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l9.602"></a><span id="l9.602" class="difflineminus">-</span>
<a href="#l9.603"></a><span id="l9.603" class="difflineminus">-  // we assume it is our one and only address book.</span>
<a href="#l9.604"></a><span id="l9.604" class="difflineminus">-  if (!m_pWab) {</span>
<a href="#l9.605"></a><span id="l9.605" class="difflineminus">-    IMPORT_LOG0(&quot;Wab not loaded in ImportAddressBook call\n&quot;);</span>
<a href="#l9.606"></a><span id="l9.606" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l9.607"></a><span id="l9.607" class="difflineminus">-  }</span>
<a href="#l9.608"></a><span id="l9.608" class="difflineminus">-</span>
<a href="#l9.609"></a><span id="l9.609" class="difflineminus">-  IMPORT_LOG0(&quot;IMPORTING OUTLOOK EXPRESS ADDRESS BOOK\n&quot;);</span>
<a href="#l9.610"></a><span id="l9.610" class="difflineminus">-</span>
<a href="#l9.611"></a><span id="l9.611" class="difflineminus">-  nsString success;</span>
<a href="#l9.612"></a><span id="l9.612" class="difflineminus">-  nsString error;</span>
<a href="#l9.613"></a><span id="l9.613" class="difflineminus">-  if (!source || !destination || !fatalError)</span>
<a href="#l9.614"></a><span id="l9.614" class="difflineminus">-  {</span>
<a href="#l9.615"></a><span id="l9.615" class="difflineminus">-    nsOEStringBundle::GetStringByID(OEIMPORT_ADDRESS_BADPARAM, error);</span>
<a href="#l9.616"></a><span id="l9.616" class="difflineminus">-    if (fatalError)</span>
<a href="#l9.617"></a><span id="l9.617" class="difflineminus">-      *fatalError = true;</span>
<a href="#l9.618"></a><span id="l9.618" class="difflineminus">-    ImportOEMailImpl::SetLogs(success, error, errorLog, successLog);</span>
<a href="#l9.619"></a><span id="l9.619" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l9.620"></a><span id="l9.620" class="difflineminus">-  }</span>
<a href="#l9.621"></a><span id="l9.621" class="difflineminus">-</span>
<a href="#l9.622"></a><span id="l9.622" class="difflineminus">-  m_doneSoFar = 0;</span>
<a href="#l9.623"></a><span id="l9.623" class="difflineminus">-  nsOEAddressIterator * pIter = new nsOEAddressIterator(m_pWab, destination);</span>
<a href="#l9.624"></a><span id="l9.624" class="difflineminus">-  HRESULT hr = m_pWab-&gt;IterateWABContents(pIter, &amp;m_doneSoFar);</span>
<a href="#l9.625"></a><span id="l9.625" class="difflineminus">-  delete pIter;</span>
<a href="#l9.626"></a><span id="l9.626" class="difflineminus">-</span>
<a href="#l9.627"></a><span id="l9.627" class="difflineminus">-  nsString name;</span>
<a href="#l9.628"></a><span id="l9.628" class="difflineminus">-  if (SUCCEEDED(hr) &amp;&amp; NS_SUCCEEDED(source-&gt;GetPreferredName(name)))</span>
<a href="#l9.629"></a><span id="l9.629" class="difflineminus">-    ReportSuccess(name, &amp;success);</span>
<a href="#l9.630"></a><span id="l9.630" class="difflineminus">-  else</span>
<a href="#l9.631"></a><span id="l9.631" class="difflineminus">-    ImportOEMailImpl::ReportError(OEIMPORT_ADDRESS_CONVERTERROR, name, &amp;error);</span>
<a href="#l9.632"></a><span id="l9.632" class="difflineminus">-</span>
<a href="#l9.633"></a><span id="l9.633" class="difflineminus">-  ImportOEMailImpl::SetLogs(success, error, errorLog, successLog);</span>
<a href="#l9.634"></a><span id="l9.634" class="difflineminus">-</span>
<a href="#l9.635"></a><span id="l9.635" class="difflineminus">-  nsresult rv = destination-&gt;Commit(nsAddrDBCommitType::kLargeCommit);</span>
<a href="#l9.636"></a><span id="l9.636" class="difflineminus">-  return rv;</span>
<a href="#l9.637"></a><span id="l9.637" class="difflineminus">-}</span>
<a href="#l9.638"></a><span id="l9.638" class="difflineminus">-</span>
<a href="#l9.639"></a><span id="l9.639" class="difflineminus">-</span>
<a href="#l9.640"></a><span id="l9.640" class="difflineminus">-NS_IMETHODIMP ImportOEAddressImpl::GetImportProgress(uint32_t *_retval)</span>
<a href="#l9.641"></a><span id="l9.641" class="difflineminus">-{</span>
<a href="#l9.642"></a><span id="l9.642" class="difflineminus">-  NS_PRECONDITION(_retval != nullptr, &quot;null ptr&quot;);</span>
<a href="#l9.643"></a><span id="l9.643" class="difflineminus">-  if (! _retval)</span>
<a href="#l9.644"></a><span id="l9.644" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l9.645"></a><span id="l9.645" class="difflineminus">-</span>
<a href="#l9.646"></a><span id="l9.646" class="difflineminus">-  *_retval = (uint32_t) m_doneSoFar;</span>
<a href="#l9.647"></a><span id="l9.647" class="difflineminus">-  return NS_OK;</span>
<a href="#l9.648"></a><span id="l9.648" class="difflineminus">-}</span>
<a href="#l9.649"></a><span id="l9.649" class="difflineminus">-</span>
<a href="#l9.650"></a><span id="l9.650" class="difflineminus">-void ImportOEAddressImpl::ReportSuccess(nsString&amp; name, nsString *pStream)</span>
<a href="#l9.651"></a><span id="l9.651" class="difflineminus">-{</span>
<a href="#l9.652"></a><span id="l9.652" class="difflineminus">-  if (!pStream)</span>
<a href="#l9.653"></a><span id="l9.653" class="difflineminus">-    return;</span>
<a href="#l9.654"></a><span id="l9.654" class="difflineminus">-  // load the success string</span>
<a href="#l9.655"></a><span id="l9.655" class="difflineminus">-  char16_t *pFmt = nsOEStringBundle::GetStringByID(OEIMPORT_ADDRESS_SUCCESS);</span>
<a href="#l9.656"></a><span id="l9.656" class="difflineminus">-  char16_t *pText = nsTextFormatter::smprintf(pFmt, name.get());</span>
<a href="#l9.657"></a><span id="l9.657" class="difflineminus">-  pStream-&gt;Append(pText);</span>
<a href="#l9.658"></a><span id="l9.658" class="difflineminus">-  nsTextFormatter::smprintf_free(pText);</span>
<a href="#l9.659"></a><span id="l9.659" class="difflineminus">-  nsOEStringBundle::FreeString(pFmt);</span>
<a href="#l9.660"></a><span id="l9.660" class="difflineminus">-  ImportOEMailImpl::AddLinebreak(pStream);</span>
<a href="#l9.661"></a><span id="l9.661" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1">deleted file mode 100644</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineminus">--- a/mailnews/import/oexpress/nsOEImport.h</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineplus">+++ /dev/null</span>
<a href="#l10.4"></a><span id="l10.4" class="difflineat">@@ -1,42 +0,0 @@</span>
<a href="#l10.5"></a><span id="l10.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l10.6"></a><span id="l10.6" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l10.7"></a><span id="l10.7" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l10.8"></a><span id="l10.8" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l10.9"></a><span id="l10.9" class="difflineminus">-</span>
<a href="#l10.10"></a><span id="l10.10" class="difflineminus">-#ifndef nsOEImport_h___</span>
<a href="#l10.11"></a><span id="l10.11" class="difflineminus">-#define nsOEImport_h___</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineminus">-#include &quot;nsIImportModule.h&quot;</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineminus">-#include &quot;nsCOMPtr.h&quot;</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineminus">-</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineminus">-#define NS_OEIMPORT_CID              \</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineminus">-{ /* be0bc880-1742-11d3-a206-00a0cc26da63 */      \</span>
<a href="#l10.18"></a><span id="l10.18" class="difflineminus">-   0xbe0bc880, 0x1742, 0x11d3,                   \</span>
<a href="#l10.19"></a><span id="l10.19" class="difflineminus">-   {0xa2, 0x06, 0x0, 0xa0, 0xcc, 0x26, 0xda, 0x63}}</span>
<a href="#l10.20"></a><span id="l10.20" class="difflineminus">-</span>
<a href="#l10.21"></a><span id="l10.21" class="difflineminus">-</span>
<a href="#l10.22"></a><span id="l10.22" class="difflineminus">-</span>
<a href="#l10.23"></a><span id="l10.23" class="difflineminus">-#define kOESupportsString NS_IMPORT_MAIL_STR &quot;,&quot; NS_IMPORT_ADDRESS_STR &quot;,&quot; NS_IMPORT_SETTINGS_STR</span>
<a href="#l10.24"></a><span id="l10.24" class="difflineminus">-</span>
<a href="#l10.25"></a><span id="l10.25" class="difflineminus">-class nsOEImport : public nsIImportModule</span>
<a href="#l10.26"></a><span id="l10.26" class="difflineminus">-{</span>
<a href="#l10.27"></a><span id="l10.27" class="difflineminus">-public:</span>
<a href="#l10.28"></a><span id="l10.28" class="difflineminus">-</span>
<a href="#l10.29"></a><span id="l10.29" class="difflineminus">-  nsOEImport();</span>
<a href="#l10.30"></a><span id="l10.30" class="difflineminus">-</span>
<a href="#l10.31"></a><span id="l10.31" class="difflineminus">-  NS_DECL_ISUPPORTS</span>
<a href="#l10.32"></a><span id="l10.32" class="difflineminus">-</span>
<a href="#l10.33"></a><span id="l10.33" class="difflineminus">-  ////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l10.34"></a><span id="l10.34" class="difflineminus">-  // we suppport the nsIImportModule interface</span>
<a href="#l10.35"></a><span id="l10.35" class="difflineminus">-  ////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l10.36"></a><span id="l10.36" class="difflineminus">-</span>
<a href="#l10.37"></a><span id="l10.37" class="difflineminus">-</span>
<a href="#l10.38"></a><span id="l10.38" class="difflineminus">-  NS_DECL_NSIIMPORTMODULE</span>
<a href="#l10.39"></a><span id="l10.39" class="difflineminus">-</span>
<a href="#l10.40"></a><span id="l10.40" class="difflineminus">-protected:</span>
<a href="#l10.41"></a><span id="l10.41" class="difflineminus">-  virtual ~nsOEImport();</span>
<a href="#l10.42"></a><span id="l10.42" class="difflineminus">-};</span>
<a href="#l10.43"></a><span id="l10.43" class="difflineminus">-</span>
<a href="#l10.44"></a><span id="l10.44" class="difflineminus">-</span>
<a href="#l10.45"></a><span id="l10.45" class="difflineminus">-</span>
<a href="#l10.46"></a><span id="l10.46" class="difflineminus">-#endif /* nsOEImport_h___ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1">deleted file mode 100644</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineminus">--- a/mailnews/import/oexpress/nsOEMailbox.cpp</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineplus">+++ /dev/null</span>
<a href="#l11.4"></a><span id="l11.4" class="difflineat">@@ -1,673 +0,0 @@</span>
<a href="#l11.5"></a><span id="l11.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l11.6"></a><span id="l11.6" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l11.7"></a><span id="l11.7" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l11.8"></a><span id="l11.8" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l11.9"></a><span id="l11.9" class="difflineminus">-</span>
<a href="#l11.10"></a><span id="l11.10" class="difflineminus">-#include &quot;nsOEMailbox.h&quot;</span>
<a href="#l11.11"></a><span id="l11.11" class="difflineminus">-</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-#include &quot;OEDebugLog.h&quot;</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineminus">-#include &quot;msgCore.h&quot;</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineminus">-#include &quot;prprf.h&quot;</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineminus">-#include &quot;nsMsgLocalFolderHdrs.h&quot;</span>
<a href="#l11.16"></a><span id="l11.16" class="difflineminus">-#include &quot;nsCRT.h&quot;</span>
<a href="#l11.17"></a><span id="l11.17" class="difflineminus">-#include &quot;nsNetUtil.h&quot;</span>
<a href="#l11.18"></a><span id="l11.18" class="difflineminus">-#include &quot;nsIInputStream.h&quot;</span>
<a href="#l11.19"></a><span id="l11.19" class="difflineminus">-#include &quot;nsIOutputStream.h&quot;</span>
<a href="#l11.20"></a><span id="l11.20" class="difflineminus">-#include &quot;nsIMsgFolder.h&quot;</span>
<a href="#l11.21"></a><span id="l11.21" class="difflineminus">-#include &quot;nsIMsgHdr.h&quot;</span>
<a href="#l11.22"></a><span id="l11.22" class="difflineminus">-#include &quot;nsIMsgPluggableStore.h&quot;</span>
<a href="#l11.23"></a><span id="l11.23" class="difflineminus">-#include &quot;nsISeekableStream.h&quot;</span>
<a href="#l11.24"></a><span id="l11.24" class="difflineminus">-#include &quot;nsMsgUtils.h&quot;</span>
<a href="#l11.25"></a><span id="l11.25" class="difflineminus">-</span>
<a href="#l11.26"></a><span id="l11.26" class="difflineminus">-class CMbxScanner {</span>
<a href="#l11.27"></a><span id="l11.27" class="difflineminus">-public:</span>
<a href="#l11.28"></a><span id="l11.28" class="difflineminus">-  CMbxScanner(nsString&amp; name, nsIFile * mbxFile, nsIMsgFolder *dstFolder);</span>
<a href="#l11.29"></a><span id="l11.29" class="difflineminus">-  ~CMbxScanner();</span>
<a href="#l11.30"></a><span id="l11.30" class="difflineminus">-</span>
<a href="#l11.31"></a><span id="l11.31" class="difflineminus">-  virtual bool    Initialize(void);</span>
<a href="#l11.32"></a><span id="l11.32" class="difflineminus">-  virtual bool    DoWork(bool *pAbort, uint32_t *pDone, uint32_t *pCount);</span>
<a href="#l11.33"></a><span id="l11.33" class="difflineminus">-</span>
<a href="#l11.34"></a><span id="l11.34" class="difflineminus">-  bool      WasErrorFatal(void) { return m_fatalError;}</span>
<a href="#l11.35"></a><span id="l11.35" class="difflineminus">-  uint32_t  BytesProcessed(void) { return m_didBytes;}</span>
<a href="#l11.36"></a><span id="l11.36" class="difflineminus">-</span>
<a href="#l11.37"></a><span id="l11.37" class="difflineminus">-protected:</span>
<a href="#l11.38"></a><span id="l11.38" class="difflineminus">-  bool    WriteMailItem(uint32_t flags, uint32_t offset, uint32_t size, uint32_t *pTotalMsgSize = nullptr);</span>
<a href="#l11.39"></a><span id="l11.39" class="difflineminus">-  virtual void  CleanUp(void);</span>
<a href="#l11.40"></a><span id="l11.40" class="difflineminus">-</span>
<a href="#l11.41"></a><span id="l11.41" class="difflineminus">-private:</span>
<a href="#l11.42"></a><span id="l11.42" class="difflineminus">-  void  ReportWriteError(nsIMsgFolder *folder, bool fatal = true);</span>
<a href="#l11.43"></a><span id="l11.43" class="difflineminus">-  void  ReportReadError(nsIFile * file, bool fatal = true);</span>
<a href="#l11.44"></a><span id="l11.44" class="difflineminus">-  bool CopyMbxFileBytes(uint32_t flags, uint32_t numBytes);</span>
<a href="#l11.45"></a><span id="l11.45" class="difflineminus">-  bool IsFromLineKey(uint8_t *pBuf, uint32_t max);</span>
<a href="#l11.46"></a><span id="l11.46" class="difflineminus">-</span>
<a href="#l11.47"></a><span id="l11.47" class="difflineminus">-public:</span>
<a href="#l11.48"></a><span id="l11.48" class="difflineminus">-  uint32_t      m_msgCount;</span>
<a href="#l11.49"></a><span id="l11.49" class="difflineminus">-</span>
<a href="#l11.50"></a><span id="l11.50" class="difflineminus">-protected:</span>
<a href="#l11.51"></a><span id="l11.51" class="difflineminus">-  uint32_t *    m_pDone;</span>
<a href="#l11.52"></a><span id="l11.52" class="difflineminus">-  nsString      m_name;</span>
<a href="#l11.53"></a><span id="l11.53" class="difflineminus">-  nsCOMPtr&lt;nsIFile&gt; m_mbxFile;</span>
<a href="#l11.54"></a><span id="l11.54" class="difflineminus">-  nsCOMPtr&lt;nsIMsgFolder&gt; m_dstFolder;</span>
<a href="#l11.55"></a><span id="l11.55" class="difflineminus">-  nsCOMPtr&lt;nsIInputStream&gt; m_mbxFileInputStream;</span>
<a href="#l11.56"></a><span id="l11.56" class="difflineminus">-  nsCOMPtr&lt;nsIOutputStream&gt; m_dstOutputStream;</span>
<a href="#l11.57"></a><span id="l11.57" class="difflineminus">-  nsCOMPtr&lt;nsIMsgPluggableStore&gt; m_msgStore;</span>
<a href="#l11.58"></a><span id="l11.58" class="difflineminus">-  uint8_t *     m_pInBuffer;</span>
<a href="#l11.59"></a><span id="l11.59" class="difflineminus">-  uint8_t *     m_pOutBuffer;</span>
<a href="#l11.60"></a><span id="l11.60" class="difflineminus">-  uint32_t      m_bufSz;</span>
<a href="#l11.61"></a><span id="l11.61" class="difflineminus">-  uint32_t      m_didBytes;</span>
<a href="#l11.62"></a><span id="l11.62" class="difflineminus">-  bool          m_fatalError;</span>
<a href="#l11.63"></a><span id="l11.63" class="difflineminus">-  int64_t      m_mbxFileSize;</span>
<a href="#l11.64"></a><span id="l11.64" class="difflineminus">-  uint32_t      m_mbxOffset;</span>
<a href="#l11.65"></a><span id="l11.65" class="difflineminus">-</span>
<a href="#l11.66"></a><span id="l11.66" class="difflineminus">-  static const char *  m_pFromLine;</span>
<a href="#l11.67"></a><span id="l11.67" class="difflineminus">-</span>
<a href="#l11.68"></a><span id="l11.68" class="difflineminus">-};</span>
<a href="#l11.69"></a><span id="l11.69" class="difflineminus">-</span>
<a href="#l11.70"></a><span id="l11.70" class="difflineminus">-</span>
<a href="#l11.71"></a><span id="l11.71" class="difflineminus">-class CIndexScanner : public CMbxScanner {</span>
<a href="#l11.72"></a><span id="l11.72" class="difflineminus">-public:</span>
<a href="#l11.73"></a><span id="l11.73" class="difflineminus">-  CIndexScanner(nsString&amp; name, nsIFile * idxFile, nsIFile * mbxFile, nsIMsgFolder *dstFolder);</span>
<a href="#l11.74"></a><span id="l11.74" class="difflineminus">-  ~CIndexScanner();</span>
<a href="#l11.75"></a><span id="l11.75" class="difflineminus">-</span>
<a href="#l11.76"></a><span id="l11.76" class="difflineminus">-  virtual bool    Initialize(void);</span>
<a href="#l11.77"></a><span id="l11.77" class="difflineminus">-  virtual bool    DoWork(bool *pAbort, uint32_t *pDone, uint32_t *pCount);</span>
<a href="#l11.78"></a><span id="l11.78" class="difflineminus">-</span>
<a href="#l11.79"></a><span id="l11.79" class="difflineminus">-protected:</span>
<a href="#l11.80"></a><span id="l11.80" class="difflineminus">-  virtual void    CleanUp(void);</span>
<a href="#l11.81"></a><span id="l11.81" class="difflineminus">-</span>
<a href="#l11.82"></a><span id="l11.82" class="difflineminus">-private:</span>
<a href="#l11.83"></a><span id="l11.83" class="difflineminus">-  bool            ValidateIdxFile(void);</span>
<a href="#l11.84"></a><span id="l11.84" class="difflineminus">-  bool            GetMailItem(uint32_t *pFlags, uint32_t *pOffset, uint32_t *pSize);</span>
<a href="#l11.85"></a><span id="l11.85" class="difflineminus">-</span>
<a href="#l11.86"></a><span id="l11.86" class="difflineminus">-</span>
<a href="#l11.87"></a><span id="l11.87" class="difflineminus">-private:</span>
<a href="#l11.88"></a><span id="l11.88" class="difflineminus">-  nsCOMPtr &lt;nsIFile&gt;   m_idxFile;</span>
<a href="#l11.89"></a><span id="l11.89" class="difflineminus">-  nsCOMPtr &lt;nsIInputStream&gt; m_idxFileInputStream;</span>
<a href="#l11.90"></a><span id="l11.90" class="difflineminus">-  uint32_t        m_numMessages;</span>
<a href="#l11.91"></a><span id="l11.91" class="difflineminus">-  uint32_t        m_idxOffset;</span>
<a href="#l11.92"></a><span id="l11.92" class="difflineminus">-  uint32_t        m_curItemIndex;</span>
<a href="#l11.93"></a><span id="l11.93" class="difflineminus">-};</span>
<a href="#l11.94"></a><span id="l11.94" class="difflineminus">-</span>
<a href="#l11.95"></a><span id="l11.95" class="difflineminus">-</span>
<a href="#l11.96"></a><span id="l11.96" class="difflineminus">-bool CImportMailbox::ImportMailbox(uint32_t *pDone, bool *pAbort,</span>
<a href="#l11.97"></a><span id="l11.97" class="difflineminus">-                                   nsString&amp; name, nsIFile * inFile,</span>
<a href="#l11.98"></a><span id="l11.98" class="difflineminus">-                                   nsIMsgFolder *outFolder, uint32_t *pCount)</span>
<a href="#l11.99"></a><span id="l11.99" class="difflineminus">-{</span>
<a href="#l11.100"></a><span id="l11.100" class="difflineminus">-  bool    done = false;</span>
<a href="#l11.101"></a><span id="l11.101" class="difflineminus">-  nsresult rv;</span>
<a href="#l11.102"></a><span id="l11.102" class="difflineminus">-  nsCOMPtr &lt;nsIFile&gt; idxFile = do_CreateInstance(NS_LOCAL_FILE_CONTRACTID, &amp;rv);</span>
<a href="#l11.103"></a><span id="l11.103" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l11.104"></a><span id="l11.104" class="difflineminus">-    rv  = idxFile-&gt;InitWithFile(inFile);</span>
<a href="#l11.105"></a><span id="l11.105" class="difflineminus">-  if (NS_FAILED(rv)) {</span>
<a href="#l11.106"></a><span id="l11.106" class="difflineminus">-    IMPORT_LOG0(&quot;New file spec failed!\n&quot;);</span>
<a href="#l11.107"></a><span id="l11.107" class="difflineminus">-    return false;</span>
<a href="#l11.108"></a><span id="l11.108" class="difflineminus">-  }</span>
<a href="#l11.109"></a><span id="l11.109" class="difflineminus">-</span>
<a href="#l11.110"></a><span id="l11.110" class="difflineminus">-  if (GetIndexFile(idxFile)) {</span>
<a href="#l11.111"></a><span id="l11.111" class="difflineminus">-</span>
<a href="#l11.112"></a><span id="l11.112" class="difflineminus">-    IMPORT_LOG1(&quot;Using index file for: %S\n&quot;, name.get());</span>
<a href="#l11.113"></a><span id="l11.113" class="difflineminus">-</span>
<a href="#l11.114"></a><span id="l11.114" class="difflineminus">-    CIndexScanner *pIdxScanner = new CIndexScanner(name, idxFile, inFile, outFolder);</span>
<a href="#l11.115"></a><span id="l11.115" class="difflineminus">-    if (pIdxScanner-&gt;Initialize()) {</span>
<a href="#l11.116"></a><span id="l11.116" class="difflineminus">-      if (pIdxScanner-&gt;DoWork(pAbort, pDone, pCount)) {</span>
<a href="#l11.117"></a><span id="l11.117" class="difflineminus">-        done = true;</span>
<a href="#l11.118"></a><span id="l11.118" class="difflineminus">-      }</span>
<a href="#l11.119"></a><span id="l11.119" class="difflineminus">-      else {</span>
<a href="#l11.120"></a><span id="l11.120" class="difflineminus">-        IMPORT_LOG0(&quot;CIndexScanner::DoWork() failed\n&quot;);</span>
<a href="#l11.121"></a><span id="l11.121" class="difflineminus">-      }</span>
<a href="#l11.122"></a><span id="l11.122" class="difflineminus">-    }</span>
<a href="#l11.123"></a><span id="l11.123" class="difflineminus">-    else {</span>
<a href="#l11.124"></a><span id="l11.124" class="difflineminus">-      IMPORT_LOG0(&quot;CIndexScanner::Initialize() failed\n&quot;);</span>
<a href="#l11.125"></a><span id="l11.125" class="difflineminus">-    }</span>
<a href="#l11.126"></a><span id="l11.126" class="difflineminus">-</span>
<a href="#l11.127"></a><span id="l11.127" class="difflineminus">-    delete pIdxScanner;</span>
<a href="#l11.128"></a><span id="l11.128" class="difflineminus">-  }</span>
<a href="#l11.129"></a><span id="l11.129" class="difflineminus">-</span>
<a href="#l11.130"></a><span id="l11.130" class="difflineminus">-  if (done)</span>
<a href="#l11.131"></a><span id="l11.131" class="difflineminus">-    return done;</span>
<a href="#l11.132"></a><span id="l11.132" class="difflineminus">-</span>
<a href="#l11.133"></a><span id="l11.133" class="difflineminus">-    /*</span>
<a href="#l11.134"></a><span id="l11.134" class="difflineminus">-    something went wrong with the index file, just scan the mailbox</span>
<a href="#l11.135"></a><span id="l11.135" class="difflineminus">-    file itself.</span>
<a href="#l11.136"></a><span id="l11.136" class="difflineminus">-  */</span>
<a href="#l11.137"></a><span id="l11.137" class="difflineminus">-  CMbxScanner *pMbx = new CMbxScanner(name, inFile, outFolder);</span>
<a href="#l11.138"></a><span id="l11.138" class="difflineminus">-  if (pMbx-&gt;Initialize()) {</span>
<a href="#l11.139"></a><span id="l11.139" class="difflineminus">-    if (pMbx-&gt;DoWork(pAbort, pDone, pCount)) {</span>
<a href="#l11.140"></a><span id="l11.140" class="difflineminus">-      done = true;</span>
<a href="#l11.141"></a><span id="l11.141" class="difflineminus">-    }</span>
<a href="#l11.142"></a><span id="l11.142" class="difflineminus">-    else {</span>
<a href="#l11.143"></a><span id="l11.143" class="difflineminus">-      IMPORT_LOG0(&quot;CMbxScanner::DoWork() failed\n&quot;);</span>
<a href="#l11.144"></a><span id="l11.144" class="difflineminus">-    }</span>
<a href="#l11.145"></a><span id="l11.145" class="difflineminus">-  }</span>
<a href="#l11.146"></a><span id="l11.146" class="difflineminus">-  else {</span>
<a href="#l11.147"></a><span id="l11.147" class="difflineminus">-    IMPORT_LOG0(&quot;CMbxScanner::Initialize() failed\n&quot;);</span>
<a href="#l11.148"></a><span id="l11.148" class="difflineminus">-  }</span>
<a href="#l11.149"></a><span id="l11.149" class="difflineminus">-</span>
<a href="#l11.150"></a><span id="l11.150" class="difflineminus">-  delete pMbx;</span>
<a href="#l11.151"></a><span id="l11.151" class="difflineminus">-  return done;</span>
<a href="#l11.152"></a><span id="l11.152" class="difflineminus">-}</span>
<a href="#l11.153"></a><span id="l11.153" class="difflineminus">-</span>
<a href="#l11.154"></a><span id="l11.154" class="difflineminus">-</span>
<a href="#l11.155"></a><span id="l11.155" class="difflineminus">-bool CImportMailbox::GetIndexFile(nsIFile* file)</span>
<a href="#l11.156"></a><span id="l11.156" class="difflineminus">-{</span>
<a href="#l11.157"></a><span id="l11.157" class="difflineminus">-  nsCString pLeaf;</span>
<a href="#l11.158"></a><span id="l11.158" class="difflineminus">-  if (NS_FAILED(file-&gt;GetNativeLeafName(pLeaf)))</span>
<a href="#l11.159"></a><span id="l11.159" class="difflineminus">-    return false;</span>
<a href="#l11.160"></a><span id="l11.160" class="difflineminus">-  int32_t  len = pLeaf.Length();</span>
<a href="#l11.161"></a><span id="l11.161" class="difflineminus">-  if (len &lt; 5)</span>
<a href="#l11.162"></a><span id="l11.162" class="difflineminus">-    return false;</span>
<a href="#l11.163"></a><span id="l11.163" class="difflineminus">-</span>
<a href="#l11.164"></a><span id="l11.164" class="difflineminus">-  pLeaf.Replace(len - 3, 3, NS_LITERAL_CSTRING(&quot;idx&quot;));</span>
<a href="#l11.165"></a><span id="l11.165" class="difflineminus">-</span>
<a href="#l11.166"></a><span id="l11.166" class="difflineminus">-  IMPORT_LOG1(&quot;Looking for index leaf name: %s\n&quot;, pLeaf);</span>
<a href="#l11.167"></a><span id="l11.167" class="difflineminus">-</span>
<a href="#l11.168"></a><span id="l11.168" class="difflineminus">-  nsresult  rv;</span>
<a href="#l11.169"></a><span id="l11.169" class="difflineminus">-  rv = file-&gt;SetNativeLeafName(pLeaf);</span>
<a href="#l11.170"></a><span id="l11.170" class="difflineminus">-</span>
<a href="#l11.171"></a><span id="l11.171" class="difflineminus">-  bool    isFile = false;</span>
<a href="#l11.172"></a><span id="l11.172" class="difflineminus">-  bool    exists = false;</span>
<a href="#l11.173"></a><span id="l11.173" class="difflineminus">-  if (NS_SUCCEEDED(rv)) rv = file-&gt;IsFile(&amp;isFile);</span>
<a href="#l11.174"></a><span id="l11.174" class="difflineminus">-  if (NS_SUCCEEDED(rv)) rv = file-&gt;Exists(&amp;exists);</span>
<a href="#l11.175"></a><span id="l11.175" class="difflineminus">-</span>
<a href="#l11.176"></a><span id="l11.176" class="difflineminus">-  return (isFile &amp;&amp; exists);</span>
<a href="#l11.177"></a><span id="l11.177" class="difflineminus">-}</span>
<a href="#l11.178"></a><span id="l11.178" class="difflineminus">-</span>
<a href="#l11.179"></a><span id="l11.179" class="difflineminus">-</span>
<a href="#l11.180"></a><span id="l11.180" class="difflineminus">-const char *CMbxScanner::m_pFromLine = &quot;From - Mon Jan 1 00:00:00 1965\x0D\x0A&quot;;</span>
<a href="#l11.181"></a><span id="l11.181" class="difflineminus">-// let's try a 16K buffer and see how well that works?</span>
<a href="#l11.182"></a><span id="l11.182" class="difflineminus">-#define  kBufferKB  16</span>
<a href="#l11.183"></a><span id="l11.183" class="difflineminus">-</span>
<a href="#l11.184"></a><span id="l11.184" class="difflineminus">-</span>
<a href="#l11.185"></a><span id="l11.185" class="difflineminus">-CMbxScanner::CMbxScanner(nsString&amp; name, nsIFile* mbxFile,</span>
<a href="#l11.186"></a><span id="l11.186" class="difflineminus">-                         nsIMsgFolder* dstFolder)</span>
<a href="#l11.187"></a><span id="l11.187" class="difflineminus">-{</span>
<a href="#l11.188"></a><span id="l11.188" class="difflineminus">-  m_msgCount = 0;</span>
<a href="#l11.189"></a><span id="l11.189" class="difflineminus">-  m_name = name;</span>
<a href="#l11.190"></a><span id="l11.190" class="difflineminus">-  m_mbxFile = mbxFile;</span>
<a href="#l11.191"></a><span id="l11.191" class="difflineminus">-  m_dstFolder = dstFolder;</span>
<a href="#l11.192"></a><span id="l11.192" class="difflineminus">-  m_pInBuffer = nullptr;</span>
<a href="#l11.193"></a><span id="l11.193" class="difflineminus">-  m_pOutBuffer = nullptr;</span>
<a href="#l11.194"></a><span id="l11.194" class="difflineminus">-  m_bufSz = 0;</span>
<a href="#l11.195"></a><span id="l11.195" class="difflineminus">-  m_fatalError = false;</span>
<a href="#l11.196"></a><span id="l11.196" class="difflineminus">-  m_didBytes = 0;</span>
<a href="#l11.197"></a><span id="l11.197" class="difflineminus">-  m_mbxFileSize = 0;</span>
<a href="#l11.198"></a><span id="l11.198" class="difflineminus">-  m_mbxOffset = 0;</span>
<a href="#l11.199"></a><span id="l11.199" class="difflineminus">-}</span>
<a href="#l11.200"></a><span id="l11.200" class="difflineminus">-</span>
<a href="#l11.201"></a><span id="l11.201" class="difflineminus">-CMbxScanner::~CMbxScanner()</span>
<a href="#l11.202"></a><span id="l11.202" class="difflineminus">-{</span>
<a href="#l11.203"></a><span id="l11.203" class="difflineminus">-  CleanUp();</span>
<a href="#l11.204"></a><span id="l11.204" class="difflineminus">-}</span>
<a href="#l11.205"></a><span id="l11.205" class="difflineminus">-</span>
<a href="#l11.206"></a><span id="l11.206" class="difflineminus">-void CMbxScanner::ReportWriteError(nsIMsgFolder * folder, bool fatal)</span>
<a href="#l11.207"></a><span id="l11.207" class="difflineminus">-{</span>
<a href="#l11.208"></a><span id="l11.208" class="difflineminus">-  m_fatalError = fatal;</span>
<a href="#l11.209"></a><span id="l11.209" class="difflineminus">-}</span>
<a href="#l11.210"></a><span id="l11.210" class="difflineminus">-</span>
<a href="#l11.211"></a><span id="l11.211" class="difflineminus">-void CMbxScanner::ReportReadError(nsIFile * file, bool fatal)</span>
<a href="#l11.212"></a><span id="l11.212" class="difflineminus">-{</span>
<a href="#l11.213"></a><span id="l11.213" class="difflineminus">-  m_fatalError = fatal;</span>
<a href="#l11.214"></a><span id="l11.214" class="difflineminus">-}</span>
<a href="#l11.215"></a><span id="l11.215" class="difflineminus">-</span>
<a href="#l11.216"></a><span id="l11.216" class="difflineminus">-bool CMbxScanner::Initialize(void)</span>
<a href="#l11.217"></a><span id="l11.217" class="difflineminus">-{</span>
<a href="#l11.218"></a><span id="l11.218" class="difflineminus">-  m_bufSz = (kBufferKB * 1024);</span>
<a href="#l11.219"></a><span id="l11.219" class="difflineminus">-  m_pInBuffer = new uint8_t[m_bufSz];</span>
<a href="#l11.220"></a><span id="l11.220" class="difflineminus">-  m_pOutBuffer = new uint8_t[m_bufSz];</span>
<a href="#l11.221"></a><span id="l11.221" class="difflineminus">-  if (!m_pInBuffer || !m_pOutBuffer) {</span>
<a href="#l11.222"></a><span id="l11.222" class="difflineminus">-    return false;</span>
<a href="#l11.223"></a><span id="l11.223" class="difflineminus">-  }</span>
<a href="#l11.224"></a><span id="l11.224" class="difflineminus">-</span>
<a href="#l11.225"></a><span id="l11.225" class="difflineminus">-  m_mbxFile-&gt;GetFileSize(&amp;m_mbxFileSize);</span>
<a href="#l11.226"></a><span id="l11.226" class="difflineminus">-  // open the mailbox file...</span>
<a href="#l11.227"></a><span id="l11.227" class="difflineminus">-  if (NS_FAILED(NS_NewLocalFileInputStream(getter_AddRefs(m_mbxFileInputStream), m_mbxFile))) {</span>
<a href="#l11.228"></a><span id="l11.228" class="difflineminus">-    CleanUp();</span>
<a href="#l11.229"></a><span id="l11.229" class="difflineminus">-    return false;</span>
<a href="#l11.230"></a><span id="l11.230" class="difflineminus">-  }</span>
<a href="#l11.231"></a><span id="l11.231" class="difflineminus">-</span>
<a href="#l11.232"></a><span id="l11.232" class="difflineminus">-  if (NS_FAILED(m_dstFolder-&gt;GetMsgStore(getter_AddRefs(m_msgStore)))) {</span>
<a href="#l11.233"></a><span id="l11.233" class="difflineminus">-    CleanUp();</span>
<a href="#l11.234"></a><span id="l11.234" class="difflineminus">-    return false;</span>
<a href="#l11.235"></a><span id="l11.235" class="difflineminus">-  }</span>
<a href="#l11.236"></a><span id="l11.236" class="difflineminus">-</span>
<a href="#l11.237"></a><span id="l11.237" class="difflineminus">-  return true;</span>
<a href="#l11.238"></a><span id="l11.238" class="difflineminus">-}</span>
<a href="#l11.239"></a><span id="l11.239" class="difflineminus">-</span>
<a href="#l11.240"></a><span id="l11.240" class="difflineminus">-</span>
<a href="#l11.241"></a><span id="l11.241" class="difflineminus">-#define  kMbxHeaderSize    0x0054</span>
<a href="#l11.242"></a><span id="l11.242" class="difflineminus">-#define kMbxMessageHeaderSz  16</span>
<a href="#l11.243"></a><span id="l11.243" class="difflineminus">-</span>
<a href="#l11.244"></a><span id="l11.244" class="difflineminus">-bool CMbxScanner::DoWork(bool *pAbort, uint32_t *pDone, uint32_t *pCount)</span>
<a href="#l11.245"></a><span id="l11.245" class="difflineminus">-{</span>
<a href="#l11.246"></a><span id="l11.246" class="difflineminus">-  m_mbxOffset = kMbxHeaderSize;</span>
<a href="#l11.247"></a><span id="l11.247" class="difflineminus">-  m_didBytes = kMbxHeaderSize;</span>
<a href="#l11.248"></a><span id="l11.248" class="difflineminus">-</span>
<a href="#l11.249"></a><span id="l11.249" class="difflineminus">-  while (!(*pAbort) &amp;&amp; ((m_mbxOffset + kMbxMessageHeaderSz) &lt; m_mbxFileSize)) {</span>
<a href="#l11.250"></a><span id="l11.250" class="difflineminus">-    uint32_t    msgSz;</span>
<a href="#l11.251"></a><span id="l11.251" class="difflineminus">-    if (!WriteMailItem(0, m_mbxOffset, 0, &amp;msgSz)) {</span>
<a href="#l11.252"></a><span id="l11.252" class="difflineminus">-      if (!WasErrorFatal())</span>
<a href="#l11.253"></a><span id="l11.253" class="difflineminus">-        ReportReadError(m_mbxFile);</span>
<a href="#l11.254"></a><span id="l11.254" class="difflineminus">-      return false;</span>
<a href="#l11.255"></a><span id="l11.255" class="difflineminus">-    }</span>
<a href="#l11.256"></a><span id="l11.256" class="difflineminus">-    m_mbxOffset += msgSz;</span>
<a href="#l11.257"></a><span id="l11.257" class="difflineminus">-    m_didBytes += msgSz;</span>
<a href="#l11.258"></a><span id="l11.258" class="difflineminus">-    m_msgCount++;</span>
<a href="#l11.259"></a><span id="l11.259" class="difflineminus">-    if (pDone)</span>
<a href="#l11.260"></a><span id="l11.260" class="difflineminus">-      *pDone = m_didBytes;</span>
<a href="#l11.261"></a><span id="l11.261" class="difflineminus">-    if (pCount)</span>
<a href="#l11.262"></a><span id="l11.262" class="difflineminus">-      *pCount = m_msgCount;</span>
<a href="#l11.263"></a><span id="l11.263" class="difflineminus">-  }</span>
<a href="#l11.264"></a><span id="l11.264" class="difflineminus">-</span>
<a href="#l11.265"></a><span id="l11.265" class="difflineminus">-  CleanUp();</span>
<a href="#l11.266"></a><span id="l11.266" class="difflineminus">-</span>
<a href="#l11.267"></a><span id="l11.267" class="difflineminus">-  return true;</span>
<a href="#l11.268"></a><span id="l11.268" class="difflineminus">-}</span>
<a href="#l11.269"></a><span id="l11.269" class="difflineminus">-</span>
<a href="#l11.270"></a><span id="l11.270" class="difflineminus">-</span>
<a href="#l11.271"></a><span id="l11.271" class="difflineminus">-void CMbxScanner::CleanUp(void)</span>
<a href="#l11.272"></a><span id="l11.272" class="difflineminus">-{</span>
<a href="#l11.273"></a><span id="l11.273" class="difflineminus">-  if (m_mbxFileInputStream)</span>
<a href="#l11.274"></a><span id="l11.274" class="difflineminus">-    m_mbxFileInputStream-&gt;Close();</span>
<a href="#l11.275"></a><span id="l11.275" class="difflineminus">-  if (m_dstOutputStream)</span>
<a href="#l11.276"></a><span id="l11.276" class="difflineminus">-    m_dstOutputStream-&gt;Close();</span>
<a href="#l11.277"></a><span id="l11.277" class="difflineminus">-</span>
<a href="#l11.278"></a><span id="l11.278" class="difflineminus">-  delete [] m_pInBuffer;</span>
<a href="#l11.279"></a><span id="l11.279" class="difflineminus">-  m_pInBuffer = nullptr;</span>
<a href="#l11.280"></a><span id="l11.280" class="difflineminus">-</span>
<a href="#l11.281"></a><span id="l11.281" class="difflineminus">-  delete [] m_pOutBuffer;</span>
<a href="#l11.282"></a><span id="l11.282" class="difflineminus">-  m_pOutBuffer = nullptr;</span>
<a href="#l11.283"></a><span id="l11.283" class="difflineminus">-}</span>
<a href="#l11.284"></a><span id="l11.284" class="difflineminus">-</span>
<a href="#l11.285"></a><span id="l11.285" class="difflineminus">-</span>
<a href="#l11.286"></a><span id="l11.286" class="difflineminus">-#define  kNumMbxLongsToRead  4</span>
<a href="#l11.287"></a><span id="l11.287" class="difflineminus">-</span>
<a href="#l11.288"></a><span id="l11.288" class="difflineminus">-bool CMbxScanner::WriteMailItem(uint32_t flags, uint32_t offset, uint32_t size,</span>
<a href="#l11.289"></a><span id="l11.289" class="difflineminus">-                                uint32_t *pTotalMsgSize)</span>
<a href="#l11.290"></a><span id="l11.290" class="difflineminus">-{</span>
<a href="#l11.291"></a><span id="l11.291" class="difflineminus">-  uint32_t  values[kNumMbxLongsToRead];</span>
<a href="#l11.292"></a><span id="l11.292" class="difflineminus">-  int32_t    cnt = kNumMbxLongsToRead * sizeof(uint32_t);</span>
<a href="#l11.293"></a><span id="l11.293" class="difflineminus">-  nsresult  rv;</span>
<a href="#l11.294"></a><span id="l11.294" class="difflineminus">-  uint32_t    cntRead;</span>
<a href="#l11.295"></a><span id="l11.295" class="difflineminus">-  int8_t *  pChar = (int8_t *) values;</span>
<a href="#l11.296"></a><span id="l11.296" class="difflineminus">-</span>
<a href="#l11.297"></a><span id="l11.297" class="difflineminus">-  nsCOMPtr &lt;nsISeekableStream&gt; seekableStream = do_QueryInterface(m_mbxFileInputStream);</span>
<a href="#l11.298"></a><span id="l11.298" class="difflineminus">-  rv = seekableStream-&gt;Seek(nsISeekableStream::NS_SEEK_SET,  offset);</span>
<a href="#l11.299"></a><span id="l11.299" class="difflineminus">-</span>
<a href="#l11.300"></a><span id="l11.300" class="difflineminus">-  if (NS_FAILED(rv)) {</span>
<a href="#l11.301"></a><span id="l11.301" class="difflineminus">-    IMPORT_LOG1(&quot;Mbx seek error: 0x%lx\n&quot;, offset);</span>
<a href="#l11.302"></a><span id="l11.302" class="difflineminus">-    return false;</span>
<a href="#l11.303"></a><span id="l11.303" class="difflineminus">-  }</span>
<a href="#l11.304"></a><span id="l11.304" class="difflineminus">-  rv = m_mbxFileInputStream-&gt;Read((char *) pChar, cnt, &amp;cntRead);</span>
<a href="#l11.305"></a><span id="l11.305" class="difflineminus">-  if (NS_FAILED(rv) || (cntRead != cnt)) {</span>
<a href="#l11.306"></a><span id="l11.306" class="difflineminus">-    IMPORT_LOG1(&quot;Mbx read error at: 0x%lx\n&quot;, offset);</span>
<a href="#l11.307"></a><span id="l11.307" class="difflineminus">-    return false;</span>
<a href="#l11.308"></a><span id="l11.308" class="difflineminus">-  }</span>
<a href="#l11.309"></a><span id="l11.309" class="difflineminus">-  if (values[0] != 0x7F007F00) {</span>
<a href="#l11.310"></a><span id="l11.310" class="difflineminus">-    IMPORT_LOG2(&quot;Mbx tag field doesn't match: 0x%lx, at offset: 0x%lx\n&quot;, values[0], offset);</span>
<a href="#l11.311"></a><span id="l11.311" class="difflineminus">-    return false;</span>
<a href="#l11.312"></a><span id="l11.312" class="difflineminus">-  }</span>
<a href="#l11.313"></a><span id="l11.313" class="difflineminus">-  if (size &amp;&amp; (values[2] != size)) {</span>
<a href="#l11.314"></a><span id="l11.314" class="difflineminus">-    IMPORT_LOG3(&quot;Mbx size doesn't match idx, mbx: %ld, idx: %ld, at offset: 0x%lx\n&quot;, values[2], size, offset);</span>
<a href="#l11.315"></a><span id="l11.315" class="difflineminus">-    return false;</span>
<a href="#l11.316"></a><span id="l11.316" class="difflineminus">-  }</span>
<a href="#l11.317"></a><span id="l11.317" class="difflineminus">-</span>
<a href="#l11.318"></a><span id="l11.318" class="difflineminus">-  if (pTotalMsgSize != nullptr)</span>
<a href="#l11.319"></a><span id="l11.319" class="difflineminus">-    *pTotalMsgSize = values[2];</span>
<a href="#l11.320"></a><span id="l11.320" class="difflineminus">-</span>
<a href="#l11.321"></a><span id="l11.321" class="difflineminus">-  nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l11.322"></a><span id="l11.322" class="difflineminus">-  bool reusable;</span>
<a href="#l11.323"></a><span id="l11.323" class="difflineminus">-</span>
<a href="#l11.324"></a><span id="l11.324" class="difflineminus">-  rv = m_msgStore-&gt;GetNewMsgOutputStream(m_dstFolder, getter_AddRefs(msgHdr), &amp;reusable,</span>
<a href="#l11.325"></a><span id="l11.325" class="difflineminus">-                                         getter_AddRefs(m_dstOutputStream));</span>
<a href="#l11.326"></a><span id="l11.326" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l11.327"></a><span id="l11.327" class="difflineminus">-  {</span>
<a href="#l11.328"></a><span id="l11.328" class="difflineminus">-    IMPORT_LOG1( &quot;Mbx getting outputstream error: 0x%lx\n&quot;, rv);</span>
<a href="#l11.329"></a><span id="l11.329" class="difflineminus">-    return false;</span>
<a href="#l11.330"></a><span id="l11.330" class="difflineminus">-  }</span>
<a href="#l11.331"></a><span id="l11.331" class="difflineminus">-</span>
<a href="#l11.332"></a><span id="l11.332" class="difflineminus">-  // everything looks kosher...</span>
<a href="#l11.333"></a><span id="l11.333" class="difflineminus">-  // the actual message text follows and is values[3] bytes long...</span>
<a href="#l11.334"></a><span id="l11.334" class="difflineminus">-  bool copyOK = CopyMbxFileBytes(flags,  values[3]);</span>
<a href="#l11.335"></a><span id="l11.335" class="difflineminus">-  if (copyOK)</span>
<a href="#l11.336"></a><span id="l11.336" class="difflineminus">-    m_msgStore-&gt;FinishNewMessage(m_dstOutputStream, msgHdr);</span>
<a href="#l11.337"></a><span id="l11.337" class="difflineminus">-  else {</span>
<a href="#l11.338"></a><span id="l11.338" class="difflineminus">-    m_msgStore-&gt;DiscardNewMessage(m_dstOutputStream, msgHdr);</span>
<a href="#l11.339"></a><span id="l11.339" class="difflineminus">-    IMPORT_LOG0( &quot;Mbx CopyMbxFileBytes failed\n&quot;);</span>
<a href="#l11.340"></a><span id="l11.340" class="difflineminus">-  }</span>
<a href="#l11.341"></a><span id="l11.341" class="difflineminus">-  if (!reusable)</span>
<a href="#l11.342"></a><span id="l11.342" class="difflineminus">-  {</span>
<a href="#l11.343"></a><span id="l11.343" class="difflineminus">-    m_dstOutputStream-&gt;Close();</span>
<a href="#l11.344"></a><span id="l11.344" class="difflineminus">-    m_dstOutputStream = nullptr;</span>
<a href="#l11.345"></a><span id="l11.345" class="difflineminus">-  }</span>
<a href="#l11.346"></a><span id="l11.346" class="difflineminus">-  return copyOK;</span>
<a href="#l11.347"></a><span id="l11.347" class="difflineminus">-}</span>
<a href="#l11.348"></a><span id="l11.348" class="difflineminus">-</span>
<a href="#l11.349"></a><span id="l11.349" class="difflineminus">-bool CMbxScanner::IsFromLineKey(uint8_t * pBuf, uint32_t max)</span>
<a href="#l11.350"></a><span id="l11.350" class="difflineminus">-{</span>
<a href="#l11.351"></a><span id="l11.351" class="difflineminus">-  return (max &gt; 5 &amp;&amp; (pBuf[0] == 'F') &amp;&amp; (pBuf[1] == 'r') &amp;&amp; (pBuf[2] == 'o') &amp;&amp; (pBuf[3] == 'm') &amp;&amp; (pBuf[4] == ' '));</span>
<a href="#l11.352"></a><span id="l11.352" class="difflineminus">-}</span>
<a href="#l11.353"></a><span id="l11.353" class="difflineminus">-</span>
<a href="#l11.354"></a><span id="l11.354" class="difflineminus">-</span>
<a href="#l11.355"></a><span id="l11.355" class="difflineminus">-#define IS_ANY_SPACE(_ch) ((_ch == ' ') || (_ch == '\t') || (_ch == 10) || (_ch == 13))</span>
<a href="#l11.356"></a><span id="l11.356" class="difflineminus">-</span>
<a href="#l11.357"></a><span id="l11.357" class="difflineminus">-</span>
<a href="#l11.358"></a><span id="l11.358" class="difflineminus">-bool CMbxScanner::CopyMbxFileBytes(uint32_t flags, uint32_t numBytes)</span>
<a href="#l11.359"></a><span id="l11.359" class="difflineminus">-{</span>
<a href="#l11.360"></a><span id="l11.360" class="difflineminus">-  if (!numBytes)</span>
<a href="#l11.361"></a><span id="l11.361" class="difflineminus">-    return true;</span>
<a href="#l11.362"></a><span id="l11.362" class="difflineminus">-</span>
<a href="#l11.363"></a><span id="l11.363" class="difflineminus">-  uint32_t  cnt;</span>
<a href="#l11.364"></a><span id="l11.364" class="difflineminus">-  uint8_t   last[2] = {0, 0};</span>
<a href="#l11.365"></a><span id="l11.365" class="difflineminus">-  uint32_t  inIdx = 0;</span>
<a href="#l11.366"></a><span id="l11.366" class="difflineminus">-  bool      first = true;</span>
<a href="#l11.367"></a><span id="l11.367" class="difflineminus">-  uint8_t * pIn;</span>
<a href="#l11.368"></a><span id="l11.368" class="difflineminus">-  uint8_t * pStart;</span>
<a href="#l11.369"></a><span id="l11.369" class="difflineminus">-  int32_t   fromLen = strlen(m_pFromLine);</span>
<a href="#l11.370"></a><span id="l11.370" class="difflineminus">-  nsresult  rv;</span>
<a href="#l11.371"></a><span id="l11.371" class="difflineminus">-  uint32_t   cntRead;</span>
<a href="#l11.372"></a><span id="l11.372" class="difflineminus">-  uint8_t * pChar;</span>
<a href="#l11.373"></a><span id="l11.373" class="difflineminus">-</span>
<a href="#l11.374"></a><span id="l11.374" class="difflineminus">-  while (numBytes) {</span>
<a href="#l11.375"></a><span id="l11.375" class="difflineminus">-    if (numBytes &gt; (m_bufSz - inIdx))</span>
<a href="#l11.376"></a><span id="l11.376" class="difflineminus">-      cnt = m_bufSz - inIdx;</span>
<a href="#l11.377"></a><span id="l11.377" class="difflineminus">-    else</span>
<a href="#l11.378"></a><span id="l11.378" class="difflineminus">-      cnt = numBytes;</span>
<a href="#l11.379"></a><span id="l11.379" class="difflineminus">-    // Read some of the message from the file...</span>
<a href="#l11.380"></a><span id="l11.380" class="difflineminus">-    pChar = m_pInBuffer + inIdx;</span>
<a href="#l11.381"></a><span id="l11.381" class="difflineminus">-    rv = m_mbxFileInputStream-&gt;Read((char *) pChar, (int32_t)cnt, &amp;cntRead);</span>
<a href="#l11.382"></a><span id="l11.382" class="difflineminus">-    if (NS_FAILED(rv) || (cntRead != (int32_t)cnt)) {</span>
<a href="#l11.383"></a><span id="l11.383" class="difflineminus">-      ReportReadError(m_mbxFile);</span>
<a href="#l11.384"></a><span id="l11.384" class="difflineminus">-      return false;</span>
<a href="#l11.385"></a><span id="l11.385" class="difflineminus">-    }</span>
<a href="#l11.386"></a><span id="l11.386" class="difflineminus">-    // Keep track of the last 2 bytes of the message for terminating EOL logic</span>
<a href="#l11.387"></a><span id="l11.387" class="difflineminus">-    if (cnt &lt; 2) {</span>
<a href="#l11.388"></a><span id="l11.388" class="difflineminus">-      last[0] = last[1];</span>
<a href="#l11.389"></a><span id="l11.389" class="difflineminus">-      last[1] = m_pInBuffer[cnt - 1];</span>
<a href="#l11.390"></a><span id="l11.390" class="difflineminus">-    }</span>
<a href="#l11.391"></a><span id="l11.391" class="difflineminus">-    else {</span>
<a href="#l11.392"></a><span id="l11.392" class="difflineminus">-      last[0] = m_pInBuffer[cnt - 2];</span>
<a href="#l11.393"></a><span id="l11.393" class="difflineminus">-      last[1] = m_pInBuffer[cnt - 1];</span>
<a href="#l11.394"></a><span id="l11.394" class="difflineminus">-    }</span>
<a href="#l11.395"></a><span id="l11.395" class="difflineminus">-</span>
<a href="#l11.396"></a><span id="l11.396" class="difflineminus">-    inIdx = 0;</span>
<a href="#l11.397"></a><span id="l11.397" class="difflineminus">-    // Handle the beginning line, don't duplicate an existing From separator</span>
<a href="#l11.398"></a><span id="l11.398" class="difflineminus">-    if (first) {</span>
<a href="#l11.399"></a><span id="l11.399" class="difflineminus">-      // check the first buffer to see if it already starts with a From line</span>
<a href="#l11.400"></a><span id="l11.400" class="difflineminus">-      // If it does, throw it away and use our own</span>
<a href="#l11.401"></a><span id="l11.401" class="difflineminus">-      if (IsFromLineKey(m_pInBuffer, cnt)) {</span>
<a href="#l11.402"></a><span id="l11.402" class="difflineminus">-        // skip past the first line</span>
<a href="#l11.403"></a><span id="l11.403" class="difflineminus">-        while ((inIdx &lt; cnt) &amp;&amp; (m_pInBuffer[inIdx] != nsCRT::CR))</span>
<a href="#l11.404"></a><span id="l11.404" class="difflineminus">-          inIdx++;</span>
<a href="#l11.405"></a><span id="l11.405" class="difflineminus">-        while ((inIdx &lt; cnt) &amp;&amp; (IS_ANY_SPACE(m_pInBuffer[inIdx])))</span>
<a href="#l11.406"></a><span id="l11.406" class="difflineminus">-          inIdx++;</span>
<a href="#l11.407"></a><span id="l11.407" class="difflineminus">-        if (inIdx &gt;= cnt) {</span>
<a href="#l11.408"></a><span id="l11.408" class="difflineminus">-          // This should not occurr - it means the message starts</span>
<a href="#l11.409"></a><span id="l11.409" class="difflineminus">-          // with a From separator line that is longer than our</span>
<a href="#l11.410"></a><span id="l11.410" class="difflineminus">-          // file buffer!  In this bizarre case, just skip this message</span>
<a href="#l11.411"></a><span id="l11.411" class="difflineminus">-          // since it is probably bogus anyway.</span>
<a href="#l11.412"></a><span id="l11.412" class="difflineminus">-          return true;</span>
<a href="#l11.413"></a><span id="l11.413" class="difflineminus">-        }</span>
<a href="#l11.414"></a><span id="l11.414" class="difflineminus">-</span>
<a href="#l11.415"></a><span id="l11.415" class="difflineminus">-      }</span>
<a href="#l11.416"></a><span id="l11.416" class="difflineminus">-      // Begin every message with a From separator</span>
<a href="#l11.417"></a><span id="l11.417" class="difflineminus">-      rv = m_dstOutputStream-&gt;Write(m_pFromLine, fromLen, &amp;cntRead);</span>
<a href="#l11.418"></a><span id="l11.418" class="difflineminus">-      if (NS_FAILED(rv) || (cntRead != fromLen)) {</span>
<a href="#l11.419"></a><span id="l11.419" class="difflineminus">-        ReportWriteError(m_dstFolder);</span>
<a href="#l11.420"></a><span id="l11.420" class="difflineminus">-        return false;</span>
<a href="#l11.421"></a><span id="l11.421" class="difflineminus">-      }</span>
<a href="#l11.422"></a><span id="l11.422" class="difflineminus">-      char statusLine[50];</span>
<a href="#l11.423"></a><span id="l11.423" class="difflineminus">-      uint32_t msgFlags = flags; // need to convert from OE flags to mozilla flags</span>
<a href="#l11.424"></a><span id="l11.424" class="difflineminus">-      PR_snprintf(statusLine, sizeof(statusLine), X_MOZILLA_STATUS_FORMAT MSG_LINEBREAK, msgFlags &amp; 0xFFFF);</span>
<a href="#l11.425"></a><span id="l11.425" class="difflineminus">-      rv = m_dstOutputStream-&gt;Write(statusLine, strlen(statusLine), &amp;cntRead);</span>
<a href="#l11.426"></a><span id="l11.426" class="difflineminus">-      if (NS_SUCCEEDED(rv) &amp;&amp; cntRead == fromLen)</span>
<a href="#l11.427"></a><span id="l11.427" class="difflineminus">-      {</span>
<a href="#l11.428"></a><span id="l11.428" class="difflineminus">-        PR_snprintf(statusLine, sizeof(statusLine), X_MOZILLA_STATUS2_FORMAT MSG_LINEBREAK, msgFlags &amp; 0xFFFF0000);</span>
<a href="#l11.429"></a><span id="l11.429" class="difflineminus">-        rv = m_dstOutputStream-&gt;Write(statusLine, strlen(statusLine), &amp;cntRead);</span>
<a href="#l11.430"></a><span id="l11.430" class="difflineminus">-      }</span>
<a href="#l11.431"></a><span id="l11.431" class="difflineminus">-      if (NS_FAILED(rv) || (cntRead != fromLen)) {</span>
<a href="#l11.432"></a><span id="l11.432" class="difflineminus">-        ReportWriteError(m_dstFolder);</span>
<a href="#l11.433"></a><span id="l11.433" class="difflineminus">-        return false;</span>
<a href="#l11.434"></a><span id="l11.434" class="difflineminus">-      }</span>
<a href="#l11.435"></a><span id="l11.435" class="difflineminus">-      first = false;</span>
<a href="#l11.436"></a><span id="l11.436" class="difflineminus">-    }</span>
<a href="#l11.437"></a><span id="l11.437" class="difflineminus">-</span>
<a href="#l11.438"></a><span id="l11.438" class="difflineminus">-    // Handle generic data, escape any lines that begin with &quot;From &quot;</span>
<a href="#l11.439"></a><span id="l11.439" class="difflineminus">-    pIn = m_pInBuffer + inIdx;</span>
<a href="#l11.440"></a><span id="l11.440" class="difflineminus">-    numBytes -= cnt;</span>
<a href="#l11.441"></a><span id="l11.441" class="difflineminus">-    m_didBytes += cnt;</span>
<a href="#l11.442"></a><span id="l11.442" class="difflineminus">-    pStart = pIn;</span>
<a href="#l11.443"></a><span id="l11.443" class="difflineminus">-    cnt -= inIdx;</span>
<a href="#l11.444"></a><span id="l11.444" class="difflineminus">-    inIdx = 0;</span>
<a href="#l11.445"></a><span id="l11.445" class="difflineminus">-    while (cnt) {</span>
<a href="#l11.446"></a><span id="l11.446" class="difflineminus">-      if (*pIn == nsCRT::CR) {</span>
<a href="#l11.447"></a><span id="l11.447" class="difflineminus">-        // need more in buffer?</span>
<a href="#l11.448"></a><span id="l11.448" class="difflineminus">-        if ((cnt &lt; 7) &amp;&amp; numBytes)</span>
<a href="#l11.449"></a><span id="l11.449" class="difflineminus">-          break;</span>
<a href="#l11.450"></a><span id="l11.450" class="difflineminus">-</span>
<a href="#l11.451"></a><span id="l11.451" class="difflineminus">-        if (cnt &gt; 6) {</span>
<a href="#l11.452"></a><span id="l11.452" class="difflineminus">-          if ((pIn[1] == nsCRT::LF) &amp;&amp; IsFromLineKey(pIn + 2, cnt)) {</span>
<a href="#l11.453"></a><span id="l11.453" class="difflineminus">-            inIdx += 2;</span>
<a href="#l11.454"></a><span id="l11.454" class="difflineminus">-            // Match, escape it</span>
<a href="#l11.455"></a><span id="l11.455" class="difflineminus">-            rv = m_dstOutputStream-&gt;Write((const char *)pStart, (int32_t)inIdx, &amp;cntRead);</span>
<a href="#l11.456"></a><span id="l11.456" class="difflineminus">-            if (NS_SUCCEEDED(rv) &amp;&amp; (cntRead == (int32_t)inIdx))</span>
<a href="#l11.457"></a><span id="l11.457" class="difflineminus">-              rv = m_dstOutputStream-&gt;Write(&quot;&gt;&quot;, 1, &amp;cntRead);</span>
<a href="#l11.458"></a><span id="l11.458" class="difflineminus">-            if (NS_FAILED(rv) || (cntRead != 1)) {</span>
<a href="#l11.459"></a><span id="l11.459" class="difflineminus">-              ReportWriteError(m_dstFolder);</span>
<a href="#l11.460"></a><span id="l11.460" class="difflineminus">-              return false;</span>
<a href="#l11.461"></a><span id="l11.461" class="difflineminus">-            }</span>
<a href="#l11.462"></a><span id="l11.462" class="difflineminus">-</span>
<a href="#l11.463"></a><span id="l11.463" class="difflineminus">-            cnt -= 2;</span>
<a href="#l11.464"></a><span id="l11.464" class="difflineminus">-            pIn += 2;</span>
<a href="#l11.465"></a><span id="l11.465" class="difflineminus">-            inIdx = 0;</span>
<a href="#l11.466"></a><span id="l11.466" class="difflineminus">-            pStart = pIn;</span>
<a href="#l11.467"></a><span id="l11.467" class="difflineminus">-            continue;</span>
<a href="#l11.468"></a><span id="l11.468" class="difflineminus">-          }</span>
<a href="#l11.469"></a><span id="l11.469" class="difflineminus">-        }</span>
<a href="#l11.470"></a><span id="l11.470" class="difflineminus">-      } // == nsCRT::CR</span>
<a href="#l11.471"></a><span id="l11.471" class="difflineminus">-</span>
<a href="#l11.472"></a><span id="l11.472" class="difflineminus">-      cnt--;</span>
<a href="#l11.473"></a><span id="l11.473" class="difflineminus">-      inIdx++;</span>
<a href="#l11.474"></a><span id="l11.474" class="difflineminus">-      pIn++;</span>
<a href="#l11.475"></a><span id="l11.475" class="difflineminus">-    }</span>
<a href="#l11.476"></a><span id="l11.476" class="difflineminus">-    rv = m_dstOutputStream-&gt;Write((const char *)pStart, (int32_t)inIdx, &amp;cntRead);</span>
<a href="#l11.477"></a><span id="l11.477" class="difflineminus">-    if (NS_FAILED(rv) || (cntRead != (int32_t)inIdx)) {</span>
<a href="#l11.478"></a><span id="l11.478" class="difflineminus">-      ReportWriteError(m_dstFolder);</span>
<a href="#l11.479"></a><span id="l11.479" class="difflineminus">-      return false;</span>
<a href="#l11.480"></a><span id="l11.480" class="difflineminus">-    }</span>
<a href="#l11.481"></a><span id="l11.481" class="difflineminus">-</span>
<a href="#l11.482"></a><span id="l11.482" class="difflineminus">-    if (cnt) {</span>
<a href="#l11.483"></a><span id="l11.483" class="difflineminus">-      inIdx = cnt;</span>
<a href="#l11.484"></a><span id="l11.484" class="difflineminus">-      memcpy(m_pInBuffer, pIn, cnt);</span>
<a href="#l11.485"></a><span id="l11.485" class="difflineminus">-    }</span>
<a href="#l11.486"></a><span id="l11.486" class="difflineminus">-    else</span>
<a href="#l11.487"></a><span id="l11.487" class="difflineminus">-      inIdx = 0;</span>
<a href="#l11.488"></a><span id="l11.488" class="difflineminus">-  }</span>
<a href="#l11.489"></a><span id="l11.489" class="difflineminus">-</span>
<a href="#l11.490"></a><span id="l11.490" class="difflineminus">-  // I used to check for an eol before writing one but</span>
<a href="#l11.491"></a><span id="l11.491" class="difflineminus">-  // it turns out that adding a proper EOL before the next</span>
<a href="#l11.492"></a><span id="l11.492" class="difflineminus">-  // separator never really hurts so better to be safe</span>
<a href="#l11.493"></a><span id="l11.493" class="difflineminus">-  // and always do it.</span>
<a href="#l11.494"></a><span id="l11.494" class="difflineminus">-  //  if ((last[0] != nsCRT::CR) || (last[1] != nsCRT::LF)) {</span>
<a href="#l11.495"></a><span id="l11.495" class="difflineminus">-  rv = m_dstOutputStream-&gt;Write(&quot;\x0D\x0A&quot;, 2, &amp;cntRead);</span>
<a href="#l11.496"></a><span id="l11.496" class="difflineminus">-  if (NS_FAILED(rv) || (cntRead != 2)) {</span>
<a href="#l11.497"></a><span id="l11.497" class="difflineminus">-    ReportWriteError(m_dstFolder);</span>
<a href="#l11.498"></a><span id="l11.498" class="difflineminus">-    return false;</span>
<a href="#l11.499"></a><span id="l11.499" class="difflineminus">-  }</span>
<a href="#l11.500"></a><span id="l11.500" class="difflineminus">-  //  } // != nsCRT::CR || != nsCRT::LF</span>
<a href="#l11.501"></a><span id="l11.501" class="difflineminus">-</span>
<a href="#l11.502"></a><span id="l11.502" class="difflineminus">-  return true;</span>
<a href="#l11.503"></a><span id="l11.503" class="difflineminus">-}</span>
<a href="#l11.504"></a><span id="l11.504" class="difflineminus">-</span>
<a href="#l11.505"></a><span id="l11.505" class="difflineminus">-CIndexScanner::CIndexScanner(nsString&amp; name, nsIFile * idxFile,</span>
<a href="#l11.506"></a><span id="l11.506" class="difflineminus">-                             nsIFile * mbxFile, nsIMsgFolder * dstFolder)</span>
<a href="#l11.507"></a><span id="l11.507" class="difflineminus">-  : CMbxScanner( name, mbxFile, dstFolder)</span>
<a href="#l11.508"></a><span id="l11.508" class="difflineminus">-{</span>
<a href="#l11.509"></a><span id="l11.509" class="difflineminus">-  m_idxFile = idxFile;</span>
<a href="#l11.510"></a><span id="l11.510" class="difflineminus">-  m_curItemIndex = 0;</span>
<a href="#l11.511"></a><span id="l11.511" class="difflineminus">-  m_idxOffset = 0;</span>
<a href="#l11.512"></a><span id="l11.512" class="difflineminus">-}</span>
<a href="#l11.513"></a><span id="l11.513" class="difflineminus">-</span>
<a href="#l11.514"></a><span id="l11.514" class="difflineminus">-CIndexScanner::~CIndexScanner()</span>
<a href="#l11.515"></a><span id="l11.515" class="difflineminus">-{</span>
<a href="#l11.516"></a><span id="l11.516" class="difflineminus">-  CleanUp();</span>
<a href="#l11.517"></a><span id="l11.517" class="difflineminus">-}</span>
<a href="#l11.518"></a><span id="l11.518" class="difflineminus">-</span>
<a href="#l11.519"></a><span id="l11.519" class="difflineminus">-bool CIndexScanner::Initialize(void)</span>
<a href="#l11.520"></a><span id="l11.520" class="difflineminus">-{</span>
<a href="#l11.521"></a><span id="l11.521" class="difflineminus">-  if (!CMbxScanner::Initialize())</span>
<a href="#l11.522"></a><span id="l11.522" class="difflineminus">-    return false;</span>
<a href="#l11.523"></a><span id="l11.523" class="difflineminus">-</span>
<a href="#l11.524"></a><span id="l11.524" class="difflineminus">-</span>
<a href="#l11.525"></a><span id="l11.525" class="difflineminus">-  nsresult   rv = NS_NewLocalFileInputStream(getter_AddRefs(m_idxFileInputStream), m_idxFile);</span>
<a href="#l11.526"></a><span id="l11.526" class="difflineminus">-  if (NS_FAILED(rv)) {</span>
<a href="#l11.527"></a><span id="l11.527" class="difflineminus">-    CleanUp();</span>
<a href="#l11.528"></a><span id="l11.528" class="difflineminus">-    return false;</span>
<a href="#l11.529"></a><span id="l11.529" class="difflineminus">-  }</span>
<a href="#l11.530"></a><span id="l11.530" class="difflineminus">-</span>
<a href="#l11.531"></a><span id="l11.531" class="difflineminus">-  return true;</span>
<a href="#l11.532"></a><span id="l11.532" class="difflineminus">-}</span>
<a href="#l11.533"></a><span id="l11.533" class="difflineminus">-</span>
<a href="#l11.534"></a><span id="l11.534" class="difflineminus">-bool CIndexScanner::ValidateIdxFile(void)</span>
<a href="#l11.535"></a><span id="l11.535" class="difflineminus">-{</span>
<a href="#l11.536"></a><span id="l11.536" class="difflineminus">-  int8_t      id[4];</span>
<a href="#l11.537"></a><span id="l11.537" class="difflineminus">-  int32_t      cnt = 4;</span>
<a href="#l11.538"></a><span id="l11.538" class="difflineminus">-  nsresult    rv;</span>
<a href="#l11.539"></a><span id="l11.539" class="difflineminus">-  uint32_t      cntRead;</span>
<a href="#l11.540"></a><span id="l11.540" class="difflineminus">-  int8_t *    pReadTo;</span>
<a href="#l11.541"></a><span id="l11.541" class="difflineminus">-</span>
<a href="#l11.542"></a><span id="l11.542" class="difflineminus">-  pReadTo = id;</span>
<a href="#l11.543"></a><span id="l11.543" class="difflineminus">-  rv = m_idxFileInputStream-&gt;Read((char *) pReadTo, cnt, &amp;cntRead);</span>
<a href="#l11.544"></a><span id="l11.544" class="difflineminus">-  if (NS_FAILED(rv) || (cntRead != cnt))</span>
<a href="#l11.545"></a><span id="l11.545" class="difflineminus">-    return false;</span>
<a href="#l11.546"></a><span id="l11.546" class="difflineminus">-  if ((id[0] != 'J') || (id[1] != 'M') || (id[2] != 'F') || (id[3] != '9'))</span>
<a href="#l11.547"></a><span id="l11.547" class="difflineminus">-    return false;</span>
<a href="#l11.548"></a><span id="l11.548" class="difflineminus">-  cnt = 4;</span>
<a href="#l11.549"></a><span id="l11.549" class="difflineminus">-  uint32_t    subId;</span>
<a href="#l11.550"></a><span id="l11.550" class="difflineminus">-  pReadTo = (int8_t *) &amp;subId;</span>
<a href="#l11.551"></a><span id="l11.551" class="difflineminus">-  rv = m_idxFileInputStream-&gt;Read((char *) pReadTo, cnt, &amp;cntRead);</span>
<a href="#l11.552"></a><span id="l11.552" class="difflineminus">-  if (NS_FAILED(rv) || (cntRead != cnt))</span>
<a href="#l11.553"></a><span id="l11.553" class="difflineminus">-    return false;</span>
<a href="#l11.554"></a><span id="l11.554" class="difflineminus">-  if (subId != 0x00010004) {</span>
<a href="#l11.555"></a><span id="l11.555" class="difflineminus">-    IMPORT_LOG1(&quot;Idx file subid doesn't match: 0x%lx\n&quot;, subId);</span>
<a href="#l11.556"></a><span id="l11.556" class="difflineminus">-    return false;</span>
<a href="#l11.557"></a><span id="l11.557" class="difflineminus">-  }</span>
<a href="#l11.558"></a><span id="l11.558" class="difflineminus">-</span>
<a href="#l11.559"></a><span id="l11.559" class="difflineminus">-  pReadTo = (int8_t *) &amp;m_numMessages;</span>
<a href="#l11.560"></a><span id="l11.560" class="difflineminus">-  rv = m_idxFileInputStream-&gt;Read((char *) pReadTo, cnt, &amp;cntRead);</span>
<a href="#l11.561"></a><span id="l11.561" class="difflineminus">-  if (NS_FAILED(rv) || (cntRead != cnt))</span>
<a href="#l11.562"></a><span id="l11.562" class="difflineminus">-    return false;</span>
<a href="#l11.563"></a><span id="l11.563" class="difflineminus">-</span>
<a href="#l11.564"></a><span id="l11.564" class="difflineminus">-  IMPORT_LOG1(&quot;Idx file num messages: %ld\n&quot;, m_numMessages);</span>
<a href="#l11.565"></a><span id="l11.565" class="difflineminus">-</span>
<a href="#l11.566"></a><span id="l11.566" class="difflineminus">-  m_didBytes += 80;</span>
<a href="#l11.567"></a><span id="l11.567" class="difflineminus">-  m_idxOffset = 80;</span>
<a href="#l11.568"></a><span id="l11.568" class="difflineminus">-  return true;</span>
<a href="#l11.569"></a><span id="l11.569" class="difflineminus">-}</span>
<a href="#l11.570"></a><span id="l11.570" class="difflineminus">-</span>
<a href="#l11.571"></a><span id="l11.571" class="difflineminus">-/*</span>
<a href="#l11.572"></a><span id="l11.572" class="difflineminus">-Idx file...</span>
<a href="#l11.573"></a><span id="l11.573" class="difflineminus">-Header is 80 bytes, JMF9, subId? 0x00010004, numMessages, fileSize, 1, 0x00010010</span>
<a href="#l11.574"></a><span id="l11.574" class="difflineminus">-Entries start at byte 80</span>
<a href="#l11.575"></a><span id="l11.575" class="difflineminus">-4 byte numbers</span>
<a href="#l11.576"></a><span id="l11.576" class="difflineminus">-Flags? maybe</span>
<a href="#l11.577"></a><span id="l11.577" class="difflineminus">-?? who knows</span>
<a href="#l11.578"></a><span id="l11.578" class="difflineminus">-index</span>
<a href="#l11.579"></a><span id="l11.579" class="difflineminus">-start of this entry in the file</span>
<a href="#l11.580"></a><span id="l11.580" class="difflineminus">-length of this record</span>
<a href="#l11.581"></a><span id="l11.581" class="difflineminus">-msg offset in mbx</span>
<a href="#l11.582"></a><span id="l11.582" class="difflineminus">-msg length in mbx</span>
<a href="#l11.583"></a><span id="l11.583" class="difflineminus">-</span>
<a href="#l11.584"></a><span id="l11.584" class="difflineminus">-*/</span>
<a href="#l11.585"></a><span id="l11.585" class="difflineminus">-</span>
<a href="#l11.586"></a><span id="l11.586" class="difflineminus">-// #define DEBUG_SUBJECT_AND_FLAGS  1</span>
<a href="#l11.587"></a><span id="l11.587" class="difflineminus">-#define  kNumIdxLongsToRead    7</span>
<a href="#l11.588"></a><span id="l11.588" class="difflineminus">-</span>
<a href="#l11.589"></a><span id="l11.589" class="difflineminus">-bool CIndexScanner::GetMailItem(uint32_t *pFlags, uint32_t *pOffset, uint32_t *pSize)</span>
<a href="#l11.590"></a><span id="l11.590" class="difflineminus">-{</span>
<a href="#l11.591"></a><span id="l11.591" class="difflineminus">-  uint32_t  values[kNumIdxLongsToRead];</span>
<a href="#l11.592"></a><span id="l11.592" class="difflineminus">-  int32_t    cnt = kNumIdxLongsToRead * sizeof(uint32_t);</span>
<a href="#l11.593"></a><span id="l11.593" class="difflineminus">-  int8_t *  pReadTo = (int8_t *) values;</span>
<a href="#l11.594"></a><span id="l11.594" class="difflineminus">-  uint32_t    cntRead;</span>
<a href="#l11.595"></a><span id="l11.595" class="difflineminus">-  nsresult  rv;</span>
<a href="#l11.596"></a><span id="l11.596" class="difflineminus">-</span>
<a href="#l11.597"></a><span id="l11.597" class="difflineminus">-  nsCOMPtr &lt;nsISeekableStream&gt; seekableStream = do_QueryInterface(m_idxFileInputStream);</span>
<a href="#l11.598"></a><span id="l11.598" class="difflineminus">-  rv = seekableStream-&gt;Seek(nsISeekableStream::NS_SEEK_SET, m_idxOffset);</span>
<a href="#l11.599"></a><span id="l11.599" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l11.600"></a><span id="l11.600" class="difflineminus">-    return false;</span>
<a href="#l11.601"></a><span id="l11.601" class="difflineminus">-</span>
<a href="#l11.602"></a><span id="l11.602" class="difflineminus">-  rv = m_idxFileInputStream-&gt;Read((char *) pReadTo, cnt, &amp;cntRead);</span>
<a href="#l11.603"></a><span id="l11.603" class="difflineminus">-  if (NS_FAILED(rv) || (cntRead != cnt))</span>
<a href="#l11.604"></a><span id="l11.604" class="difflineminus">-    return false;</span>
<a href="#l11.605"></a><span id="l11.605" class="difflineminus">-</span>
<a href="#l11.606"></a><span id="l11.606" class="difflineminus">-  if (values[3] != m_idxOffset) {</span>
<a href="#l11.607"></a><span id="l11.607" class="difflineminus">-    IMPORT_LOG2(&quot;Self pointer invalid: m_idxOffset=0x%lx, self=0x%lx\n&quot;, m_idxOffset, values[3]);</span>
<a href="#l11.608"></a><span id="l11.608" class="difflineminus">-    return false;</span>
<a href="#l11.609"></a><span id="l11.609" class="difflineminus">-  }</span>
<a href="#l11.610"></a><span id="l11.610" class="difflineminus">-</span>
<a href="#l11.611"></a><span id="l11.611" class="difflineminus">-  // So... what do we have here???</span>
<a href="#l11.612"></a><span id="l11.612" class="difflineminus">-#ifdef DEBUG_SUBJECT_AND_FLAGS</span>
<a href="#l11.613"></a><span id="l11.613" class="difflineminus">-  IMPORT_LOG2(&quot;Number: %ld, msg offset: 0x%lx, &quot;, values[2], values[5]);</span>
<a href="#l11.614"></a><span id="l11.614" class="difflineminus">-  IMPORT_LOG2(&quot;msg length: %ld, Flags: 0x%lx\n&quot;, values[6], values[0]);</span>
<a href="#l11.615"></a><span id="l11.615" class="difflineminus">-  seekableStream-&gt;Seek(nsISeekableStream::NS_SEEK_SET, m_idxOffset + 212);</span>
<a href="#l11.616"></a><span id="l11.616" class="difflineminus">-  uint32_t  subSz = 0;</span>
<a href="#l11.617"></a><span id="l11.617" class="difflineminus">-  cnt = 4;</span>
<a href="#l11.618"></a><span id="l11.618" class="difflineminus">-  pReadTo = (int8_t *) &amp;subSz;</span>
<a href="#l11.619"></a><span id="l11.619" class="difflineminus">-  m_idxFileInputStream-&gt;Read((char *) pReadTo, cnt, &amp;cntRead);</span>
<a href="#l11.620"></a><span id="l11.620" class="difflineminus">-  if ((subSz &gt;= 0) &amp;&amp; (subSz &lt; 1024)) {</span>
<a href="#l11.621"></a><span id="l11.621" class="difflineminus">-    char *pSub = new char[subSz + 1];</span>
<a href="#l11.622"></a><span id="l11.622" class="difflineminus">-    m_idxFileInputStream-&gt;Read(pSub, subSz, &amp;cntRead);</span>
<a href="#l11.623"></a><span id="l11.623" class="difflineminus">-    pSub[subSz] = 0;</span>
<a href="#l11.624"></a><span id="l11.624" class="difflineminus">-    IMPORT_LOG1(&quot;    Subject: %s\n&quot;, pSub);</span>
<a href="#l11.625"></a><span id="l11.625" class="difflineminus">-    delete [] pSub;</span>
<a href="#l11.626"></a><span id="l11.626" class="difflineminus">-  }</span>
<a href="#l11.627"></a><span id="l11.627" class="difflineminus">-#endif</span>
<a href="#l11.628"></a><span id="l11.628" class="difflineminus">-</span>
<a href="#l11.629"></a><span id="l11.629" class="difflineminus">-  m_idxOffset += values[4];</span>
<a href="#l11.630"></a><span id="l11.630" class="difflineminus">-  m_didBytes += values[4];</span>
<a href="#l11.631"></a><span id="l11.631" class="difflineminus">-</span>
<a href="#l11.632"></a><span id="l11.632" class="difflineminus">-  *pFlags = values[0];</span>
<a href="#l11.633"></a><span id="l11.633" class="difflineminus">-  *pOffset = values[5];</span>
<a href="#l11.634"></a><span id="l11.634" class="difflineminus">-  *pSize = values[6];</span>
<a href="#l11.635"></a><span id="l11.635" class="difflineminus">-  return true;</span>
<a href="#l11.636"></a><span id="l11.636" class="difflineminus">-}</span>
<a href="#l11.637"></a><span id="l11.637" class="difflineminus">-</span>
<a href="#l11.638"></a><span id="l11.638" class="difflineminus">-#define  kOEDeletedFlag    0x0001</span>
<a href="#l11.639"></a><span id="l11.639" class="difflineminus">-</span>
<a href="#l11.640"></a><span id="l11.640" class="difflineminus">-bool CIndexScanner::DoWork(bool *pAbort, uint32_t *pDone, uint32_t *pCount)</span>
<a href="#l11.641"></a><span id="l11.641" class="difflineminus">-{</span>
<a href="#l11.642"></a><span id="l11.642" class="difflineminus">-  m_didBytes = 0;</span>
<a href="#l11.643"></a><span id="l11.643" class="difflineminus">-  if (!ValidateIdxFile())</span>
<a href="#l11.644"></a><span id="l11.644" class="difflineminus">-    return false;</span>
<a href="#l11.645"></a><span id="l11.645" class="difflineminus">-</span>
<a href="#l11.646"></a><span id="l11.646" class="difflineminus">-  bool    failed = false;</span>
<a href="#l11.647"></a><span id="l11.647" class="difflineminus">-  while ((m_curItemIndex &lt; m_numMessages) &amp;&amp; !failed &amp;&amp; !(*pAbort)) {</span>
<a href="#l11.648"></a><span id="l11.648" class="difflineminus">-    uint32_t  flags, offset, size;</span>
<a href="#l11.649"></a><span id="l11.649" class="difflineminus">-    if (!GetMailItem(&amp;flags, &amp;offset, &amp;size)) {</span>
<a href="#l11.650"></a><span id="l11.650" class="difflineminus">-      CleanUp();</span>
<a href="#l11.651"></a><span id="l11.651" class="difflineminus">-      return false;</span>
<a href="#l11.652"></a><span id="l11.652" class="difflineminus">-    }</span>
<a href="#l11.653"></a><span id="l11.653" class="difflineminus">-    m_curItemIndex++;</span>
<a href="#l11.654"></a><span id="l11.654" class="difflineminus">-    if (!(flags &amp; kOEDeletedFlag)) {</span>
<a href="#l11.655"></a><span id="l11.655" class="difflineminus">-      if (!WriteMailItem(flags, offset, size))</span>
<a href="#l11.656"></a><span id="l11.656" class="difflineminus">-        failed = true;</span>
<a href="#l11.657"></a><span id="l11.657" class="difflineminus">-      else {</span>
<a href="#l11.658"></a><span id="l11.658" class="difflineminus">-        m_msgCount++;</span>
<a href="#l11.659"></a><span id="l11.659" class="difflineminus">-      }</span>
<a href="#l11.660"></a><span id="l11.660" class="difflineminus">-    }</span>
<a href="#l11.661"></a><span id="l11.661" class="difflineminus">-    m_didBytes += size;</span>
<a href="#l11.662"></a><span id="l11.662" class="difflineminus">-    if (pDone)</span>
<a href="#l11.663"></a><span id="l11.663" class="difflineminus">-      *pDone = m_didBytes;</span>
<a href="#l11.664"></a><span id="l11.664" class="difflineminus">-    if (pCount)</span>
<a href="#l11.665"></a><span id="l11.665" class="difflineminus">-      *pCount = m_msgCount;</span>
<a href="#l11.666"></a><span id="l11.666" class="difflineminus">-  }</span>
<a href="#l11.667"></a><span id="l11.667" class="difflineminus">-</span>
<a href="#l11.668"></a><span id="l11.668" class="difflineminus">-  CleanUp();</span>
<a href="#l11.669"></a><span id="l11.669" class="difflineminus">-  return !failed;</span>
<a href="#l11.670"></a><span id="l11.670" class="difflineminus">-}</span>
<a href="#l11.671"></a><span id="l11.671" class="difflineminus">-</span>
<a href="#l11.672"></a><span id="l11.672" class="difflineminus">-</span>
<a href="#l11.673"></a><span id="l11.673" class="difflineminus">-void CIndexScanner::CleanUp(void)</span>
<a href="#l11.674"></a><span id="l11.674" class="difflineminus">-{</span>
<a href="#l11.675"></a><span id="l11.675" class="difflineminus">-  CMbxScanner::CleanUp();</span>
<a href="#l11.676"></a><span id="l11.676" class="difflineminus">-  m_idxFileInputStream-&gt;Close();</span>
<a href="#l11.677"></a><span id="l11.677" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1">deleted file mode 100644</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineminus">--- a/mailnews/import/oexpress/nsOEMailbox.h</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineplus">+++ /dev/null</span>
<a href="#l12.4"></a><span id="l12.4" class="difflineat">@@ -1,27 +0,0 @@</span>
<a href="#l12.5"></a><span id="l12.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l12.6"></a><span id="l12.6" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l12.7"></a><span id="l12.7" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l12.8"></a><span id="l12.8" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l12.9"></a><span id="l12.9" class="difflineminus">-</span>
<a href="#l12.10"></a><span id="l12.10" class="difflineminus">-#ifndef nsOEMailbox_h___</span>
<a href="#l12.11"></a><span id="l12.11" class="difflineminus">-#define nsOEMailbox_h___</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineminus">-#include &quot;nscore.h&quot;</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineminus">-#include &quot;nsStringGlue.h&quot;</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineminus">-#include &quot;nsIFile.h&quot;</span>
<a href="#l12.16"></a><span id="l12.16" class="difflineminus">-</span>
<a href="#l12.17"></a><span id="l12.17" class="difflineminus">-class nsIMsgFolder;</span>
<a href="#l12.18"></a><span id="l12.18" class="difflineminus">-</span>
<a href="#l12.19"></a><span id="l12.19" class="difflineminus">-class CImportMailbox {</span>
<a href="#l12.20"></a><span id="l12.20" class="difflineminus">-public:</span>
<a href="#l12.21"></a><span id="l12.21" class="difflineminus">-  static bool ImportMailbox(uint32_t *pDone, bool *pAbort, nsString&amp; name,</span>
<a href="#l12.22"></a><span id="l12.22" class="difflineminus">-                            nsIFile * inFile, nsIMsgFolder * outFolder,</span>
<a href="#l12.23"></a><span id="l12.23" class="difflineminus">-                            uint32_t *pCount);</span>
<a href="#l12.24"></a><span id="l12.24" class="difflineminus">-</span>
<a href="#l12.25"></a><span id="l12.25" class="difflineminus">-private:</span>
<a href="#l12.26"></a><span id="l12.26" class="difflineminus">-  static bool    GetIndexFile(nsIFile* mbxFile);</span>
<a href="#l12.27"></a><span id="l12.27" class="difflineminus">-};</span>
<a href="#l12.28"></a><span id="l12.28" class="difflineminus">-</span>
<a href="#l12.29"></a><span id="l12.29" class="difflineminus">-</span>
<a href="#l12.30"></a><span id="l12.30" class="difflineminus">-</span>
<a href="#l12.31"></a><span id="l12.31" class="difflineminus">-#endif // nsOEMailbox_h__</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1">deleted file mode 100644</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineminus">--- a/mailnews/import/oexpress/nsOERegUtil.cpp</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineplus">+++ /dev/null</span>
<a href="#l13.4"></a><span id="l13.4" class="difflineat">@@ -1,27 +0,0 @@</span>
<a href="#l13.5"></a><span id="l13.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l13.6"></a><span id="l13.6" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l13.7"></a><span id="l13.7" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l13.8"></a><span id="l13.8" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l13.9"></a><span id="l13.9" class="difflineminus">-#include &quot;nsOERegUtil.h&quot;</span>
<a href="#l13.10"></a><span id="l13.10" class="difflineminus">-</span>
<a href="#l13.11"></a><span id="l13.11" class="difflineminus">-#include &quot;OEDebugLog.h&quot;</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-#include &lt;windows.h&gt;</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineminus">-#include &quot;nsIWindowsRegKey.h&quot;</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineminus">-#include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l13.15"></a><span id="l13.15" class="difflineminus">-</span>
<a href="#l13.16"></a><span id="l13.16" class="difflineminus">-nsresult nsOERegUtil::GetDefaultUserId(nsAString &amp;aUserId)</span>
<a href="#l13.17"></a><span id="l13.17" class="difflineminus">-{</span>
<a href="#l13.18"></a><span id="l13.18" class="difflineminus">-  nsresult rv;</span>
<a href="#l13.19"></a><span id="l13.19" class="difflineminus">-  nsCOMPtr&lt;nsIWindowsRegKey&gt; key =</span>
<a href="#l13.20"></a><span id="l13.20" class="difflineminus">-    do_CreateInstance(&quot;@mozilla.org/windows-registry-key;1&quot;, &amp;rv);</span>
<a href="#l13.21"></a><span id="l13.21" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.22"></a><span id="l13.22" class="difflineminus">-</span>
<a href="#l13.23"></a><span id="l13.23" class="difflineminus">-  rv = key-&gt;Open(nsIWindowsRegKey::ROOT_KEY_CURRENT_USER,</span>
<a href="#l13.24"></a><span id="l13.24" class="difflineminus">-                 NS_LITERAL_STRING(&quot;Identities&quot;),</span>
<a href="#l13.25"></a><span id="l13.25" class="difflineminus">-                 nsIWindowsRegKey::ACCESS_QUERY_VALUE);</span>
<a href="#l13.26"></a><span id="l13.26" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l13.27"></a><span id="l13.27" class="difflineminus">-    return rv;</span>
<a href="#l13.28"></a><span id="l13.28" class="difflineminus">-</span>
<a href="#l13.29"></a><span id="l13.29" class="difflineminus">-  return key-&gt;ReadStringValue(NS_LITERAL_STRING(&quot;Default User ID&quot;), aUserId);</span>
<a href="#l13.30"></a><span id="l13.30" class="difflineminus">-}</span>
<a href="#l13.31"></a><span id="l13.31" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1">deleted file mode 100644</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineminus">--- a/mailnews/import/oexpress/nsOERegUtil.h</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineplus">+++ /dev/null</span>
<a href="#l14.4"></a><span id="l14.4" class="difflineat">@@ -1,20 +0,0 @@</span>
<a href="#l14.5"></a><span id="l14.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l14.6"></a><span id="l14.6" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l14.7"></a><span id="l14.7" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l14.8"></a><span id="l14.8" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l14.9"></a><span id="l14.9" class="difflineminus">-</span>
<a href="#l14.10"></a><span id="l14.10" class="difflineminus">-#ifndef nsOERegUtil_h___</span>
<a href="#l14.11"></a><span id="l14.11" class="difflineminus">-#define nsOERegUtil_h___</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineminus">-#include &lt;windows.h&gt;</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineminus">-#include &quot;nsStringGlue.h&quot;</span>
<a href="#l14.15"></a><span id="l14.15" class="difflineminus">-</span>
<a href="#l14.16"></a><span id="l14.16" class="difflineminus">-class nsOERegUtil</span>
<a href="#l14.17"></a><span id="l14.17" class="difflineminus">-{</span>
<a href="#l14.18"></a><span id="l14.18" class="difflineminus">-public:</span>
<a href="#l14.19"></a><span id="l14.19" class="difflineminus">-  static nsresult GetDefaultUserId(nsAString &amp;aUserId);</span>
<a href="#l14.20"></a><span id="l14.20" class="difflineminus">-};</span>
<a href="#l14.21"></a><span id="l14.21" class="difflineminus">-</span>
<a href="#l14.22"></a><span id="l14.22" class="difflineminus">-</span>
<a href="#l14.23"></a><span id="l14.23" class="difflineminus">-</span>
<a href="#l14.24"></a><span id="l14.24" class="difflineminus">-#endif /* nsOERegUtil_h___ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1">deleted file mode 100644</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineminus">--- a/mailnews/import/oexpress/nsOEScanBoxes.cpp</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineplus">+++ /dev/null</span>
<a href="#l15.4"></a><span id="l15.4" class="difflineat">@@ -1,859 +0,0 @@</span>
<a href="#l15.5"></a><span id="l15.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l15.6"></a><span id="l15.6" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l15.7"></a><span id="l15.7" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l15.8"></a><span id="l15.8" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l15.9"></a><span id="l15.9" class="difflineminus">-#include &quot;nsOEScanBoxes.h&quot;</span>
<a href="#l15.10"></a><span id="l15.10" class="difflineminus">-#include &quot;nsMsgUtils.h&quot;</span>
<a href="#l15.11"></a><span id="l15.11" class="difflineminus">-#include &quot;nsIComponentManager.h&quot;</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-#include &quot;nsIServiceManager.h&quot;</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineminus">-#include &quot;nsIImportService.h&quot;</span>
<a href="#l15.14"></a><span id="l15.14" class="difflineminus">-#include &quot;nsIFile.h&quot;</span>
<a href="#l15.15"></a><span id="l15.15" class="difflineminus">-#include &quot;nsIImportMailboxDescriptor.h&quot;</span>
<a href="#l15.16"></a><span id="l15.16" class="difflineminus">-#include &quot;nsOERegUtil.h&quot;</span>
<a href="#l15.17"></a><span id="l15.17" class="difflineminus">-#include &quot;nsOE5File.h&quot;</span>
<a href="#l15.18"></a><span id="l15.18" class="difflineminus">-#include &quot;nsNetUtil.h&quot;</span>
<a href="#l15.19"></a><span id="l15.19" class="difflineminus">-#include &quot;OEDebugLog.h&quot;</span>
<a href="#l15.20"></a><span id="l15.20" class="difflineminus">-#include &quot;nsIInputStream.h&quot;</span>
<a href="#l15.21"></a><span id="l15.21" class="difflineminus">-#include &quot;nsISeekableStream.h&quot;</span>
<a href="#l15.22"></a><span id="l15.22" class="difflineminus">-#include &quot;plstr.h&quot;</span>
<a href="#l15.23"></a><span id="l15.23" class="difflineminus">-#include &lt;windows.h&gt;</span>
<a href="#l15.24"></a><span id="l15.24" class="difflineminus">-#include &quot;nsIWindowsRegKey.h&quot;</span>
<a href="#l15.25"></a><span id="l15.25" class="difflineminus">-</span>
<a href="#l15.26"></a><span id="l15.26" class="difflineminus">-#ifdef MOZILLA_INTERNAL_API</span>
<a href="#l15.27"></a><span id="l15.27" class="difflineminus">-#include &quot;nsNativeCharsetUtils.h&quot;</span>
<a href="#l15.28"></a><span id="l15.28" class="difflineminus">-#else</span>
<a href="#l15.29"></a><span id="l15.29" class="difflineminus">-#include &quot;nsMsgI18N.h&quot;</span>
<a href="#l15.30"></a><span id="l15.30" class="difflineminus">-#define NS_CopyNativeToUnicode(source, dest) \</span>
<a href="#l15.31"></a><span id="l15.31" class="difflineminus">-        nsMsgI18NConvertToUnicode(nsMsgI18NFileSystemCharset(), source, dest)</span>
<a href="#l15.32"></a><span id="l15.32" class="difflineminus">-#define NS_CopyUnicodeToNative(source, dest) \</span>
<a href="#l15.33"></a><span id="l15.33" class="difflineminus">-        nsMsgI18NConvertFromUnicode(nsMsgI18NFileSystemCharset(), source, dest)</span>
<a href="#l15.34"></a><span id="l15.34" class="difflineminus">-#endif</span>
<a href="#l15.35"></a><span id="l15.35" class="difflineminus">-</span>
<a href="#l15.36"></a><span id="l15.36" class="difflineminus">-/*</span>
<a href="#l15.37"></a><span id="l15.37" class="difflineminus">-  .nch file format???</span>
<a href="#l15.38"></a><span id="l15.38" class="difflineminus">-</span>
<a href="#l15.39"></a><span id="l15.39" class="difflineminus">-  offset 20 - long = offset to first record</span>
<a href="#l15.40"></a><span id="l15.40" class="difflineminus">-</span>
<a href="#l15.41"></a><span id="l15.41" class="difflineminus">-*/</span>
<a href="#l15.42"></a><span id="l15.42" class="difflineminus">-</span>
<a href="#l15.43"></a><span id="l15.43" class="difflineminus">-static NS_DEFINE_IID(kISupportsIID,      NS_ISUPPORTS_IID);</span>
<a href="#l15.44"></a><span id="l15.44" class="difflineminus">-</span>
<a href="#l15.45"></a><span id="l15.45" class="difflineminus">-nsOEScanBoxes::nsOEScanBoxes()</span>
<a href="#l15.46"></a><span id="l15.46" class="difflineminus">-{</span>
<a href="#l15.47"></a><span id="l15.47" class="difflineminus">-  m_pFirst = nullptr;</span>
<a href="#l15.48"></a><span id="l15.48" class="difflineminus">-}</span>
<a href="#l15.49"></a><span id="l15.49" class="difflineminus">-</span>
<a href="#l15.50"></a><span id="l15.50" class="difflineminus">-nsOEScanBoxes::~nsOEScanBoxes()</span>
<a href="#l15.51"></a><span id="l15.51" class="difflineminus">-{</span>
<a href="#l15.52"></a><span id="l15.52" class="difflineminus">-  int i, max;</span>
<a href="#l15.53"></a><span id="l15.53" class="difflineminus">-  MailboxEntry *pEntry;</span>
<a href="#l15.54"></a><span id="l15.54" class="difflineminus">-  for (i = 0, max = m_entryArray.Length(); i &lt; max; i++) {</span>
<a href="#l15.55"></a><span id="l15.55" class="difflineminus">-    pEntry = m_entryArray.ElementAt(i);</span>
<a href="#l15.56"></a><span id="l15.56" class="difflineminus">-    delete pEntry;</span>
<a href="#l15.57"></a><span id="l15.57" class="difflineminus">-  }</span>
<a href="#l15.58"></a><span id="l15.58" class="difflineminus">-  // Now free the unprocessed child entries (ie, those without parents for some reason).</span>
<a href="#l15.59"></a><span id="l15.59" class="difflineminus">-  for (i = 0, max = m_pendingChildArray.Length(); i &lt; max; i++)</span>
<a href="#l15.60"></a><span id="l15.60" class="difflineminus">-  {</span>
<a href="#l15.61"></a><span id="l15.61" class="difflineminus">-    pEntry = m_pendingChildArray.ElementAt(i);</span>
<a href="#l15.62"></a><span id="l15.62" class="difflineminus">-    if (!pEntry-&gt;processed)</span>
<a href="#l15.63"></a><span id="l15.63" class="difflineminus">-      delete pEntry;</span>
<a href="#l15.64"></a><span id="l15.64" class="difflineminus">-  }</span>
<a href="#l15.65"></a><span id="l15.65" class="difflineminus">-}</span>
<a href="#l15.66"></a><span id="l15.66" class="difflineminus">-</span>
<a href="#l15.67"></a><span id="l15.67" class="difflineminus">-/*</span>
<a href="#l15.68"></a><span id="l15.68" class="difflineminus">- 3.x &amp; 4.x registry</span>
<a href="#l15.69"></a><span id="l15.69" class="difflineminus">-  Software/Microsoft/Outlook Express/</span>
<a href="#l15.70"></a><span id="l15.70" class="difflineminus">-</span>
<a href="#l15.71"></a><span id="l15.71" class="difflineminus">- 5.0 registry</span>
<a href="#l15.72"></a><span id="l15.72" class="difflineminus">-  Identies - value of &quot;Default User ID&quot; is {GUID}</span>
<a href="#l15.73"></a><span id="l15.73" class="difflineminus">-  Identities/{GUID}/Software/Microsoft/Outlook Express/5.0/</span>
<a href="#l15.74"></a><span id="l15.74" class="difflineminus">-*/</span>
<a href="#l15.75"></a><span id="l15.75" class="difflineminus">-</span>
<a href="#l15.76"></a><span id="l15.76" class="difflineminus">-bool nsOEScanBoxes::Find50Mail(nsIFile *pWhere)</span>
<a href="#l15.77"></a><span id="l15.77" class="difflineminus">-{</span>
<a href="#l15.78"></a><span id="l15.78" class="difflineminus">-  nsAutoString userId;</span>
<a href="#l15.79"></a><span id="l15.79" class="difflineminus">-  nsresult rv = nsOERegUtil::GetDefaultUserId(userId);</span>
<a href="#l15.80"></a><span id="l15.80" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l15.81"></a><span id="l15.81" class="difflineminus">-</span>
<a href="#l15.82"></a><span id="l15.82" class="difflineminus">-  nsAutoString path(NS_LITERAL_STRING(&quot;Identities\\&quot;));</span>
<a href="#l15.83"></a><span id="l15.83" class="difflineminus">-  path.Append(userId);</span>
<a href="#l15.84"></a><span id="l15.84" class="difflineminus">-  path.AppendLiteral(&quot;\\Software\\Microsoft\\Outlook Express\\5.0&quot;);</span>
<a href="#l15.85"></a><span id="l15.85" class="difflineminus">-</span>
<a href="#l15.86"></a><span id="l15.86" class="difflineminus">-  nsCOMPtr&lt;nsIWindowsRegKey&gt; key =</span>
<a href="#l15.87"></a><span id="l15.87" class="difflineminus">-    do_CreateInstance(&quot;@mozilla.org/windows-registry-key;1&quot;, &amp;rv);</span>
<a href="#l15.88"></a><span id="l15.88" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l15.89"></a><span id="l15.89" class="difflineminus">-</span>
<a href="#l15.90"></a><span id="l15.90" class="difflineminus">-  rv = key-&gt;Open(nsIWindowsRegKey::ROOT_KEY_CURRENT_USER,</span>
<a href="#l15.91"></a><span id="l15.91" class="difflineminus">-                 path,</span>
<a href="#l15.92"></a><span id="l15.92" class="difflineminus">-                 nsIWindowsRegKey::ACCESS_QUERY_VALUE);</span>
<a href="#l15.93"></a><span id="l15.93" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l15.94"></a><span id="l15.94" class="difflineminus">-</span>
<a href="#l15.95"></a><span id="l15.95" class="difflineminus">-  nsAutoString storeRoot;</span>
<a href="#l15.96"></a><span id="l15.96" class="difflineminus">-  key-&gt;ReadStringValue(NS_LITERAL_STRING(&quot;Store Root&quot;), storeRoot);</span>
<a href="#l15.97"></a><span id="l15.97" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l15.98"></a><span id="l15.98" class="difflineminus">-</span>
<a href="#l15.99"></a><span id="l15.99" class="difflineminus">-  nsCOMPtr&lt;nsIFile&gt; localWhere = do_QueryInterface(pWhere);</span>
<a href="#l15.100"></a><span id="l15.100" class="difflineminus">-  localWhere-&gt;InitWithPath(storeRoot);</span>
<a href="#l15.101"></a><span id="l15.101" class="difflineminus">-</span>
<a href="#l15.102"></a><span id="l15.102" class="difflineminus">-  nsAutoCString nativeStoreRoot;</span>
<a href="#l15.103"></a><span id="l15.103" class="difflineminus">-  NS_CopyUnicodeToNative(storeRoot, nativeStoreRoot);</span>
<a href="#l15.104"></a><span id="l15.104" class="difflineminus">-  IMPORT_LOG1(&quot;Setting native path: %s\n&quot;, nativeStoreRoot.get());</span>
<a href="#l15.105"></a><span id="l15.105" class="difflineminus">-</span>
<a href="#l15.106"></a><span id="l15.106" class="difflineminus">-  bool isDir = false;</span>
<a href="#l15.107"></a><span id="l15.107" class="difflineminus">-  rv = localWhere-&gt;IsDirectory(&amp;isDir);</span>
<a href="#l15.108"></a><span id="l15.108" class="difflineminus">-  return isDir;</span>
<a href="#l15.109"></a><span id="l15.109" class="difflineminus">-}</span>
<a href="#l15.110"></a><span id="l15.110" class="difflineminus">-</span>
<a href="#l15.111"></a><span id="l15.111" class="difflineminus">-bool nsOEScanBoxes::FindMail(nsIFile *pWhere)</span>
<a href="#l15.112"></a><span id="l15.112" class="difflineminus">-{</span>
<a href="#l15.113"></a><span id="l15.113" class="difflineminus">-  if (Find50Mail(pWhere))</span>
<a href="#l15.114"></a><span id="l15.114" class="difflineminus">-    return true;</span>
<a href="#l15.115"></a><span id="l15.115" class="difflineminus">-</span>
<a href="#l15.116"></a><span id="l15.116" class="difflineminus">-  nsresult rv;</span>
<a href="#l15.117"></a><span id="l15.117" class="difflineminus">-  nsCOMPtr&lt;nsIWindowsRegKey&gt; key =</span>
<a href="#l15.118"></a><span id="l15.118" class="difflineminus">-    do_CreateInstance(&quot;@mozilla.org/windows-registry-key;1&quot;, &amp;rv);</span>
<a href="#l15.119"></a><span id="l15.119" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l15.120"></a><span id="l15.120" class="difflineminus">-</span>
<a href="#l15.121"></a><span id="l15.121" class="difflineminus">-  rv = key-&gt;Open(nsIWindowsRegKey::ROOT_KEY_CURRENT_USER,</span>
<a href="#l15.122"></a><span id="l15.122" class="difflineminus">-                 NS_LITERAL_STRING(&quot;Software\\Microsoft\\Outlook Express&quot;),</span>
<a href="#l15.123"></a><span id="l15.123" class="difflineminus">-                 nsIWindowsRegKey::ACCESS_QUERY_VALUE);</span>
<a href="#l15.124"></a><span id="l15.124" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l15.125"></a><span id="l15.125" class="difflineminus">-</span>
<a href="#l15.126"></a><span id="l15.126" class="difflineminus">-  nsAutoString storeRoot;</span>
<a href="#l15.127"></a><span id="l15.127" class="difflineminus">-  key-&gt;ReadStringValue(NS_LITERAL_STRING(&quot;Store Root&quot;), storeRoot);</span>
<a href="#l15.128"></a><span id="l15.128" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l15.129"></a><span id="l15.129" class="difflineminus">-</span>
<a href="#l15.130"></a><span id="l15.130" class="difflineminus">-  nsCOMPtr&lt;nsIFile&gt; localWhere = do_QueryInterface(pWhere);</span>
<a href="#l15.131"></a><span id="l15.131" class="difflineminus">-  localWhere-&gt;InitWithPath(storeRoot);</span>
<a href="#l15.132"></a><span id="l15.132" class="difflineminus">-  localWhere-&gt;AppendNative(NS_LITERAL_CSTRING(&quot;Mail&quot;));</span>
<a href="#l15.133"></a><span id="l15.133" class="difflineminus">-</span>
<a href="#l15.134"></a><span id="l15.134" class="difflineminus">-  bool isDir = false;</span>
<a href="#l15.135"></a><span id="l15.135" class="difflineminus">-  localWhere-&gt;IsDirectory(&amp;isDir);</span>
<a href="#l15.136"></a><span id="l15.136" class="difflineminus">-</span>
<a href="#l15.137"></a><span id="l15.137" class="difflineminus">-  return isDir;</span>
<a href="#l15.138"></a><span id="l15.138" class="difflineminus">-}</span>
<a href="#l15.139"></a><span id="l15.139" class="difflineminus">-</span>
<a href="#l15.140"></a><span id="l15.140" class="difflineminus">-bool nsOEScanBoxes::GetMailboxes(nsIFile *pWhere, nsIArray **pArray)</span>
<a href="#l15.141"></a><span id="l15.141" class="difflineminus">-{</span>
<a href="#l15.142"></a><span id="l15.142" class="difflineminus">-  nsCString path;</span>
<a href="#l15.143"></a><span id="l15.143" class="difflineminus">-  pWhere-&gt;GetNativePath(path);</span>
<a href="#l15.144"></a><span id="l15.144" class="difflineminus">-  if (!path.IsEmpty()) {</span>
<a href="#l15.145"></a><span id="l15.145" class="difflineminus">-    IMPORT_LOG1(&quot;Looking for mail in: %s\n&quot;, path.get());</span>
<a href="#l15.146"></a><span id="l15.146" class="difflineminus">-  }</span>
<a href="#l15.147"></a><span id="l15.147" class="difflineminus">-  else {</span>
<a href="#l15.148"></a><span id="l15.148" class="difflineminus">-    pWhere-&gt;GetNativeLeafName(path);</span>
<a href="#l15.149"></a><span id="l15.149" class="difflineminus">-    if (!path.IsEmpty())</span>
<a href="#l15.150"></a><span id="l15.150" class="difflineminus">-      IMPORT_LOG1(&quot;Looking for mail in: %s\n&quot;, path.get());</span>
<a href="#l15.151"></a><span id="l15.151" class="difflineminus">-    else</span>
<a href="#l15.152"></a><span id="l15.152" class="difflineminus">-      IMPORT_LOG0(&quot;Unable to get info about where to look for mail\n&quot;);</span>
<a href="#l15.153"></a><span id="l15.153" class="difflineminus">-  }</span>
<a href="#l15.154"></a><span id="l15.154" class="difflineminus">-</span>
<a href="#l15.155"></a><span id="l15.155" class="difflineminus">-  nsCOMPtr &lt;nsIFile&gt; location;</span>
<a href="#l15.156"></a><span id="l15.156" class="difflineminus">-  pWhere-&gt;Clone(getter_AddRefs(location));</span>
<a href="#l15.157"></a><span id="l15.157" class="difflineminus">-  // 1. Look for 5.0 folders.dbx</span>
<a href="#l15.158"></a><span id="l15.158" class="difflineminus">-  // 2. Look for 3.x &amp; 4.x folders.nch</span>
<a href="#l15.159"></a><span id="l15.159" class="difflineminus">-  // 3. Look for 5.0 *.dbx mailboxes</span>
<a href="#l15.160"></a><span id="l15.160" class="difflineminus">-  // 4. Look for 3.x &amp; 4.x *.mbx mailboxes</span>
<a href="#l15.161"></a><span id="l15.161" class="difflineminus">-</span>
<a href="#l15.162"></a><span id="l15.162" class="difflineminus">-  bool    result;</span>
<a href="#l15.163"></a><span id="l15.163" class="difflineminus">-</span>
<a href="#l15.164"></a><span id="l15.164" class="difflineminus">-  location-&gt;AppendNative(NS_LITERAL_CSTRING(&quot;folders.dbx&quot;));</span>
<a href="#l15.165"></a><span id="l15.165" class="difflineminus">-  if (Find50MailBoxes(location)) {</span>
<a href="#l15.166"></a><span id="l15.166" class="difflineminus">-    result = GetMailboxList(pWhere, pArray);</span>
<a href="#l15.167"></a><span id="l15.167" class="difflineminus">-  }</span>
<a href="#l15.168"></a><span id="l15.168" class="difflineminus">-  else {</span>
<a href="#l15.169"></a><span id="l15.169" class="difflineminus">-    // 2. Look for 4.x mailboxes</span>
<a href="#l15.170"></a><span id="l15.170" class="difflineminus">-    pWhere-&gt;Clone(getter_AddRefs(location));</span>
<a href="#l15.171"></a><span id="l15.171" class="difflineminus">-    location-&gt;AppendNative(NS_LITERAL_CSTRING(&quot;folders.nch&quot;));</span>
<a href="#l15.172"></a><span id="l15.172" class="difflineminus">-</span>
<a href="#l15.173"></a><span id="l15.173" class="difflineminus">-    if (FindMailBoxes(location)) {</span>
<a href="#l15.174"></a><span id="l15.174" class="difflineminus">-      result = GetMailboxList(pWhere, pArray);</span>
<a href="#l15.175"></a><span id="l15.175" class="difflineminus">-    }</span>
<a href="#l15.176"></a><span id="l15.176" class="difflineminus">-    else {</span>
<a href="#l15.177"></a><span id="l15.177" class="difflineminus">-      // 3 &amp; 4, look for the specific mailbox files.</span>
<a href="#l15.178"></a><span id="l15.178" class="difflineminus">-      pWhere-&gt;Clone(getter_AddRefs(location));</span>
<a href="#l15.179"></a><span id="l15.179" class="difflineminus">-      ScanMailboxDir(location);</span>
<a href="#l15.180"></a><span id="l15.180" class="difflineminus">-      result = GetMailboxList(pWhere, pArray);</span>
<a href="#l15.181"></a><span id="l15.181" class="difflineminus">-    }</span>
<a href="#l15.182"></a><span id="l15.182" class="difflineminus">-  }</span>
<a href="#l15.183"></a><span id="l15.183" class="difflineminus">-</span>
<a href="#l15.184"></a><span id="l15.184" class="difflineminus">-  return result;</span>
<a href="#l15.185"></a><span id="l15.185" class="difflineminus">-}</span>
<a href="#l15.186"></a><span id="l15.186" class="difflineminus">-</span>
<a href="#l15.187"></a><span id="l15.187" class="difflineminus">-</span>
<a href="#l15.188"></a><span id="l15.188" class="difflineminus">-</span>
<a href="#l15.189"></a><span id="l15.189" class="difflineminus">-void nsOEScanBoxes::Reset(void)</span>
<a href="#l15.190"></a><span id="l15.190" class="difflineminus">-{</span>
<a href="#l15.191"></a><span id="l15.191" class="difflineminus">-  int max = m_entryArray.Length();</span>
<a href="#l15.192"></a><span id="l15.192" class="difflineminus">-  for (int i = 0; i &lt; max; i++) {</span>
<a href="#l15.193"></a><span id="l15.193" class="difflineminus">-    MailboxEntry *pEntry = m_entryArray.ElementAt(i);</span>
<a href="#l15.194"></a><span id="l15.194" class="difflineminus">-    delete pEntry;</span>
<a href="#l15.195"></a><span id="l15.195" class="difflineminus">-  }</span>
<a href="#l15.196"></a><span id="l15.196" class="difflineminus">-  m_entryArray.Clear();</span>
<a href="#l15.197"></a><span id="l15.197" class="difflineminus">-  m_pFirst = nullptr;</span>
<a href="#l15.198"></a><span id="l15.198" class="difflineminus">-}</span>
<a href="#l15.199"></a><span id="l15.199" class="difflineminus">-</span>
<a href="#l15.200"></a><span id="l15.200" class="difflineminus">-</span>
<a href="#l15.201"></a><span id="l15.201" class="difflineminus">-bool nsOEScanBoxes::FindMailBoxes(nsIFile* descFile)</span>
<a href="#l15.202"></a><span id="l15.202" class="difflineminus">-{</span>
<a href="#l15.203"></a><span id="l15.203" class="difflineminus">-  Reset();</span>
<a href="#l15.204"></a><span id="l15.204" class="difflineminus">-</span>
<a href="#l15.205"></a><span id="l15.205" class="difflineminus">-  nsresult  rv;</span>
<a href="#l15.206"></a><span id="l15.206" class="difflineminus">-  bool      isFile = false;</span>
<a href="#l15.207"></a><span id="l15.207" class="difflineminus">-</span>
<a href="#l15.208"></a><span id="l15.208" class="difflineminus">-  rv = descFile-&gt;IsFile(&amp;isFile);</span>
<a href="#l15.209"></a><span id="l15.209" class="difflineminus">-  if (NS_FAILED(rv) || !isFile)</span>
<a href="#l15.210"></a><span id="l15.210" class="difflineminus">-    return false;</span>
<a href="#l15.211"></a><span id="l15.211" class="difflineminus">-</span>
<a href="#l15.212"></a><span id="l15.212" class="difflineminus">-  nsCOMPtr &lt;nsIInputStream&gt; descInputStream;</span>
<a href="#l15.213"></a><span id="l15.213" class="difflineminus">-  rv = NS_NewLocalFileInputStream(getter_AddRefs(descInputStream), descFile);</span>
<a href="#l15.214"></a><span id="l15.214" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l15.215"></a><span id="l15.215" class="difflineminus">-</span>
<a href="#l15.216"></a><span id="l15.216" class="difflineminus">-  IMPORT_LOG0(&quot;Reading the folders.nch file\n&quot;);</span>
<a href="#l15.217"></a><span id="l15.217" class="difflineminus">-</span>
<a href="#l15.218"></a><span id="l15.218" class="difflineminus">-  uint32_t    curRec;</span>
<a href="#l15.219"></a><span id="l15.219" class="difflineminus">-  if (!ReadLong(descInputStream, curRec, 20)) {</span>
<a href="#l15.220"></a><span id="l15.220" class="difflineminus">-    return false;</span>
<a href="#l15.221"></a><span id="l15.221" class="difflineminus">-  }</span>
<a href="#l15.222"></a><span id="l15.222" class="difflineminus">-</span>
<a href="#l15.223"></a><span id="l15.223" class="difflineminus">-  // Now for each record</span>
<a href="#l15.224"></a><span id="l15.224" class="difflineminus">-  bool        done = false;</span>
<a href="#l15.225"></a><span id="l15.225" class="difflineminus">-  uint32_t    equal;</span>
<a href="#l15.226"></a><span id="l15.226" class="difflineminus">-  uint32_t    size;</span>
<a href="#l15.227"></a><span id="l15.227" class="difflineminus">-  uint32_t    previous;</span>
<a href="#l15.228"></a><span id="l15.228" class="difflineminus">-  uint32_t    next;</span>
<a href="#l15.229"></a><span id="l15.229" class="difflineminus">-  MailboxEntry *  pEntry;</span>
<a href="#l15.230"></a><span id="l15.230" class="difflineminus">-  bool        failed;</span>
<a href="#l15.231"></a><span id="l15.231" class="difflineminus">-</span>
<a href="#l15.232"></a><span id="l15.232" class="difflineminus">-  while (!done) {</span>
<a href="#l15.233"></a><span id="l15.233" class="difflineminus">-    if (!ReadLong(descInputStream, equal, curRec)) return false;</span>
<a href="#l15.234"></a><span id="l15.234" class="difflineminus">-    if (curRec != equal) {</span>
<a href="#l15.235"></a><span id="l15.235" class="difflineminus">-      IMPORT_LOG1(&quot;Record start invalid: %ld\n&quot;, curRec);</span>
<a href="#l15.236"></a><span id="l15.236" class="difflineminus">-      break;</span>
<a href="#l15.237"></a><span id="l15.237" class="difflineminus">-    }</span>
<a href="#l15.238"></a><span id="l15.238" class="difflineminus">-    if (!ReadLong(descInputStream, size, curRec + 4)) return false;</span>
<a href="#l15.239"></a><span id="l15.239" class="difflineminus">-    if (!ReadLong(descInputStream, previous, curRec + 8)) return false;</span>
<a href="#l15.240"></a><span id="l15.240" class="difflineminus">-    if (!ReadLong(descInputStream, next, curRec + 12)) return false;</span>
<a href="#l15.241"></a><span id="l15.241" class="difflineminus">-    failed = false;</span>
<a href="#l15.242"></a><span id="l15.242" class="difflineminus">-    pEntry = new MailboxEntry;</span>
<a href="#l15.243"></a><span id="l15.243" class="difflineminus">-    if (!ReadLong(descInputStream, pEntry-&gt;index, curRec + 16)) failed = true;</span>
<a href="#l15.244"></a><span id="l15.244" class="difflineminus">-    if (!ReadString(descInputStream, pEntry-&gt;mailName, curRec + 20)) failed = true;</span>
<a href="#l15.245"></a><span id="l15.245" class="difflineminus">-    if (!ReadString(descInputStream, pEntry-&gt;fileName, curRec + 279)) failed = true;</span>
<a href="#l15.246"></a><span id="l15.246" class="difflineminus">-    if (!ReadLong(descInputStream, pEntry-&gt;parent, curRec + 539)) failed = true;</span>
<a href="#l15.247"></a><span id="l15.247" class="difflineminus">-    if (!ReadLong(descInputStream, pEntry-&gt;child, curRec + 543)) failed = true;</span>
<a href="#l15.248"></a><span id="l15.248" class="difflineminus">-    if (!ReadLong(descInputStream, pEntry-&gt;sibling, curRec + 547)) failed = true;</span>
<a href="#l15.249"></a><span id="l15.249" class="difflineminus">-    if (!ReadLong(descInputStream, pEntry-&gt;type, curRec + 551)) failed = true;</span>
<a href="#l15.250"></a><span id="l15.250" class="difflineminus">-    if (failed) {</span>
<a href="#l15.251"></a><span id="l15.251" class="difflineminus">-      delete pEntry;</span>
<a href="#l15.252"></a><span id="l15.252" class="difflineminus">-      return false;</span>
<a href="#l15.253"></a><span id="l15.253" class="difflineminus">-    }</span>
<a href="#l15.254"></a><span id="l15.254" class="difflineminus">-</span>
<a href="#l15.255"></a><span id="l15.255" class="difflineminus">-    #ifdef _TRACE_MAILBOX_ENTRIES</span>
<a href="#l15.256"></a><span id="l15.256" class="difflineminus">-    IMPORT_LOG0(&quot;------------\n&quot;);</span>
<a href="#l15.257"></a><span id="l15.257" class="difflineminus">-    IMPORT_LOG2(&quot;    Offset: %lx, index: %ld\n&quot;, curRec, pEntry-&gt;index);</span>
<a href="#l15.258"></a><span id="l15.258" class="difflineminus">-    IMPORT_LOG2(&quot;      previous: %lx, next: %lx\n&quot;, previous, next);</span>
<a href="#l15.259"></a><span id="l15.259" class="difflineminus">-    IMPORT_LOG2(&quot;      Name: %S, File: %s\n&quot;, (char16_t *) pEntry-&gt;mailName, (const char *) pEntry-&gt;fileName);</span>
<a href="#l15.260"></a><span id="l15.260" class="difflineminus">-    IMPORT_LOG3(&quot;      Parent: %ld, Child: %ld, Sibling: %ld\n&quot;, pEntry-&gt;parent, pEntry-&gt;child, pEntry-&gt;sibling);</span>
<a href="#l15.261"></a><span id="l15.261" class="difflineminus">-    #endif</span>
<a href="#l15.262"></a><span id="l15.262" class="difflineminus">-</span>
<a href="#l15.263"></a><span id="l15.263" class="difflineminus">-    if (!StringEndsWith(pEntry-&gt;fileName, NS_LITERAL_CSTRING(&quot;.mbx&quot;)))</span>
<a href="#l15.264"></a><span id="l15.264" class="difflineminus">-      pEntry-&gt;fileName.Append(&quot;.mbx&quot;);</span>
<a href="#l15.265"></a><span id="l15.265" class="difflineminus">-</span>
<a href="#l15.266"></a><span id="l15.266" class="difflineminus">-    m_entryArray.AppendElement(pEntry);</span>
<a href="#l15.267"></a><span id="l15.267" class="difflineminus">-</span>
<a href="#l15.268"></a><span id="l15.268" class="difflineminus">-    curRec = next;</span>
<a href="#l15.269"></a><span id="l15.269" class="difflineminus">-    if (!next)</span>
<a href="#l15.270"></a><span id="l15.270" class="difflineminus">-      done = true;</span>
<a href="#l15.271"></a><span id="l15.271" class="difflineminus">-  }</span>
<a href="#l15.272"></a><span id="l15.272" class="difflineminus">-</span>
<a href="#l15.273"></a><span id="l15.273" class="difflineminus">-  MailboxEntry *pZero = GetIndexEntry(0);</span>
<a href="#l15.274"></a><span id="l15.274" class="difflineminus">-  if (pZero)</span>
<a href="#l15.275"></a><span id="l15.275" class="difflineminus">-    m_pFirst = GetIndexEntry(pZero-&gt;child);</span>
<a href="#l15.276"></a><span id="l15.276" class="difflineminus">-</span>
<a href="#l15.277"></a><span id="l15.277" class="difflineminus">-  IMPORT_LOG1(&quot;Read the folders.nch file, found %ld mailboxes\n&quot;, (long) m_entryArray.Length());</span>
<a href="#l15.278"></a><span id="l15.278" class="difflineminus">-</span>
<a href="#l15.279"></a><span id="l15.279" class="difflineminus">-  return true;</span>
<a href="#l15.280"></a><span id="l15.280" class="difflineminus">-}</span>
<a href="#l15.281"></a><span id="l15.281" class="difflineminus">-</span>
<a href="#l15.282"></a><span id="l15.282" class="difflineminus">-bool nsOEScanBoxes::Find50MailBoxes(nsIFile* descFile)</span>
<a href="#l15.283"></a><span id="l15.283" class="difflineminus">-{</span>
<a href="#l15.284"></a><span id="l15.284" class="difflineminus">-  Reset();</span>
<a href="#l15.285"></a><span id="l15.285" class="difflineminus">-</span>
<a href="#l15.286"></a><span id="l15.286" class="difflineminus">-  nsresult  rv;</span>
<a href="#l15.287"></a><span id="l15.287" class="difflineminus">-  bool      isFile = false;</span>
<a href="#l15.288"></a><span id="l15.288" class="difflineminus">-</span>
<a href="#l15.289"></a><span id="l15.289" class="difflineminus">-  rv = descFile-&gt;IsFile(&amp;isFile);</span>
<a href="#l15.290"></a><span id="l15.290" class="difflineminus">-  if (NS_FAILED(rv) || !isFile)</span>
<a href="#l15.291"></a><span id="l15.291" class="difflineminus">-    return false;</span>
<a href="#l15.292"></a><span id="l15.292" class="difflineminus">-</span>
<a href="#l15.293"></a><span id="l15.293" class="difflineminus">-  nsCOMPtr &lt;nsIInputStream&gt; descInputStream;</span>
<a href="#l15.294"></a><span id="l15.294" class="difflineminus">-  rv = NS_NewLocalFileInputStream(getter_AddRefs(descInputStream), descFile);</span>
<a href="#l15.295"></a><span id="l15.295" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l15.296"></a><span id="l15.296" class="difflineminus">-</span>
<a href="#l15.297"></a><span id="l15.297" class="difflineminus">-  IMPORT_LOG0(&quot;Reading the folders.dbx file\n&quot;);</span>
<a href="#l15.298"></a><span id="l15.298" class="difflineminus">-</span>
<a href="#l15.299"></a><span id="l15.299" class="difflineminus">-  uint32_t *pIndex;</span>
<a href="#l15.300"></a><span id="l15.300" class="difflineminus">-  uint32_t indexSize = 0;</span>
<a href="#l15.301"></a><span id="l15.301" class="difflineminus">-  if (!nsOE5File::ReadIndex(descInputStream, &amp;pIndex, &amp;indexSize)) {</span>
<a href="#l15.302"></a><span id="l15.302" class="difflineminus">-    IMPORT_LOG0(&quot;*** NOT USING FOLDERS.DBX!!!\n&quot;);</span>
<a href="#l15.303"></a><span id="l15.303" class="difflineminus">-    return false;</span>
<a href="#l15.304"></a><span id="l15.304" class="difflineminus">-  }</span>
<a href="#l15.305"></a><span id="l15.305" class="difflineminus">-</span>
<a href="#l15.306"></a><span id="l15.306" class="difflineminus">-  uint32_t  marker;</span>
<a href="#l15.307"></a><span id="l15.307" class="difflineminus">-  uint32_t  size;</span>
<a href="#l15.308"></a><span id="l15.308" class="difflineminus">-  char      *pBytes;</span>
<a href="#l15.309"></a><span id="l15.309" class="difflineminus">-  uint32_t   cntRead;</span>
<a href="#l15.310"></a><span id="l15.310" class="difflineminus">-  int32_t    recordId;</span>
<a href="#l15.311"></a><span id="l15.311" class="difflineminus">-  int32_t    strOffset;</span>
<a href="#l15.312"></a><span id="l15.312" class="difflineminus">-</span>
<a href="#l15.313"></a><span id="l15.313" class="difflineminus">-  uint8_t    tag;</span>
<a href="#l15.314"></a><span id="l15.314" class="difflineminus">-  uint32_t   data;</span>
<a href="#l15.315"></a><span id="l15.315" class="difflineminus">-  int32_t    dataOffset;</span>
<a href="#l15.316"></a><span id="l15.316" class="difflineminus">-</span>
<a href="#l15.317"></a><span id="l15.317" class="difflineminus">-  uint32_t    id;</span>
<a href="#l15.318"></a><span id="l15.318" class="difflineminus">-  uint32_t    parent;</span>
<a href="#l15.319"></a><span id="l15.319" class="difflineminus">-  uint32_t    numMessages;</span>
<a href="#l15.320"></a><span id="l15.320" class="difflineminus">-  char *      pFileName;</span>
<a href="#l15.321"></a><span id="l15.321" class="difflineminus">-  char *      pDataSource;</span>
<a href="#l15.322"></a><span id="l15.322" class="difflineminus">-</span>
<a href="#l15.323"></a><span id="l15.323" class="difflineminus">-  MailboxEntry *  pEntry;</span>
<a href="#l15.324"></a><span id="l15.324" class="difflineminus">-  MailboxEntry *  pLastEntry = nullptr;</span>
<a href="#l15.325"></a><span id="l15.325" class="difflineminus">-</span>
<a href="#l15.326"></a><span id="l15.326" class="difflineminus">-  uint32_t  localStoreId = 0;</span>
<a href="#l15.327"></a><span id="l15.327" class="difflineminus">-</span>
<a href="#l15.328"></a><span id="l15.328" class="difflineminus">-  for (uint32_t i = 0; i &lt; indexSize; i++) {</span>
<a href="#l15.329"></a><span id="l15.329" class="difflineminus">-    if (!ReadLong(descInputStream, marker, pIndex[i])) continue;</span>
<a href="#l15.330"></a><span id="l15.330" class="difflineminus">-    if (marker != pIndex[i]) continue;</span>
<a href="#l15.331"></a><span id="l15.331" class="difflineminus">-    if (!ReadLong(descInputStream, size, pIndex[i] + 4)) continue;</span>
<a href="#l15.332"></a><span id="l15.332" class="difflineminus">-    size += 4;</span>
<a href="#l15.333"></a><span id="l15.333" class="difflineminus">-    pBytes = new char[size];</span>
<a href="#l15.334"></a><span id="l15.334" class="difflineminus">-    rv = descInputStream-&gt;Read(pBytes, size, &amp;cntRead);</span>
<a href="#l15.335"></a><span id="l15.335" class="difflineminus">-    if (NS_FAILED(rv) || ((uint32_t)cntRead != size)) {</span>
<a href="#l15.336"></a><span id="l15.336" class="difflineminus">-      delete [] pBytes;</span>
<a href="#l15.337"></a><span id="l15.337" class="difflineminus">-      continue;</span>
<a href="#l15.338"></a><span id="l15.338" class="difflineminus">-    }</span>
<a href="#l15.339"></a><span id="l15.339" class="difflineminus">-    recordId = pBytes[2];</span>
<a href="#l15.340"></a><span id="l15.340" class="difflineminus">-    strOffset = (recordId * 4) + 4;</span>
<a href="#l15.341"></a><span id="l15.341" class="difflineminus">-    if (recordId == 4)</span>
<a href="#l15.342"></a><span id="l15.342" class="difflineminus">-      strOffset += 4;</span>
<a href="#l15.343"></a><span id="l15.343" class="difflineminus">-</span>
<a href="#l15.344"></a><span id="l15.344" class="difflineminus">-    id = 0;</span>
<a href="#l15.345"></a><span id="l15.345" class="difflineminus">-    parent = 0;</span>
<a href="#l15.346"></a><span id="l15.346" class="difflineminus">-    numMessages = 0;</span>
<a href="#l15.347"></a><span id="l15.347" class="difflineminus">-    pFileName = nullptr;</span>
<a href="#l15.348"></a><span id="l15.348" class="difflineminus">-    pDataSource = nullptr;</span>
<a href="#l15.349"></a><span id="l15.349" class="difflineminus">-    dataOffset = 4;</span>
<a href="#l15.350"></a><span id="l15.350" class="difflineminus">-    while (dataOffset &lt; strOffset) {</span>
<a href="#l15.351"></a><span id="l15.351" class="difflineminus">-      tag = (uint8_t) pBytes[dataOffset];</span>
<a href="#l15.352"></a><span id="l15.352" class="difflineminus">-</span>
<a href="#l15.353"></a><span id="l15.353" class="difflineminus">-      data = 0; // make sure all bytes are 0 before copying 3 bytes over.</span>
<a href="#l15.354"></a><span id="l15.354" class="difflineminus">-      memcpy(&amp;data, &amp;(pBytes[dataOffset + 1]), 3);</span>
<a href="#l15.355"></a><span id="l15.355" class="difflineminus">-      switch(tag) {</span>
<a href="#l15.356"></a><span id="l15.356" class="difflineminus">-        case 0x80: // id record</span>
<a href="#l15.357"></a><span id="l15.357" class="difflineminus">-          id = data;</span>
<a href="#l15.358"></a><span id="l15.358" class="difflineminus">-        break;</span>
<a href="#l15.359"></a><span id="l15.359" class="difflineminus">-        case 0x81:  // parent id</span>
<a href="#l15.360"></a><span id="l15.360" class="difflineminus">-          parent = data;</span>
<a href="#l15.361"></a><span id="l15.361" class="difflineminus">-        break;</span>
<a href="#l15.362"></a><span id="l15.362" class="difflineminus">-        case 0x87:  // number of messages in this mailbox</span>
<a href="#l15.363"></a><span id="l15.363" class="difflineminus">-          numMessages = data;</span>
<a href="#l15.364"></a><span id="l15.364" class="difflineminus">-        break;</span>
<a href="#l15.365"></a><span id="l15.365" class="difflineminus">-        case 0x03:  // file name for this mailbox</span>
<a href="#l15.366"></a><span id="l15.366" class="difflineminus">-          if (((uint32_t)strOffset + data) &lt; size)</span>
<a href="#l15.367"></a><span id="l15.367" class="difflineminus">-            pFileName = (char *)(pBytes + strOffset + data);</span>
<a href="#l15.368"></a><span id="l15.368" class="difflineminus">-        break;</span>
<a href="#l15.369"></a><span id="l15.369" class="difflineminus">-        case 0x05:  // data source for this record (this is not a mailbox!)</span>
<a href="#l15.370"></a><span id="l15.370" class="difflineminus">-          if (((uint32_t)strOffset + data) &lt; size)</span>
<a href="#l15.371"></a><span id="l15.371" class="difflineminus">-            pDataSource = (char *) (pBytes + strOffset + data);</span>
<a href="#l15.372"></a><span id="l15.372" class="difflineminus">-        break;</span>
<a href="#l15.373"></a><span id="l15.373" class="difflineminus">-      }</span>
<a href="#l15.374"></a><span id="l15.374" class="difflineminus">-      dataOffset += 4;</span>
<a href="#l15.375"></a><span id="l15.375" class="difflineminus">-    }</span>
<a href="#l15.376"></a><span id="l15.376" class="difflineminus">-</span>
<a href="#l15.377"></a><span id="l15.377" class="difflineminus">-    // now build an entry if necessary!</span>
<a href="#l15.378"></a><span id="l15.378" class="difflineminus">-    if (pDataSource) {</span>
<a href="#l15.379"></a><span id="l15.379" class="difflineminus">-      if (!PL_strcasecmp(pDataSource, &quot;LocalStore&quot;))</span>
<a href="#l15.380"></a><span id="l15.380" class="difflineminus">-      {</span>
<a href="#l15.381"></a><span id="l15.381" class="difflineminus">-        localStoreId = id;</span>
<a href="#l15.382"></a><span id="l15.382" class="difflineminus">-        // See if we have any child folders that need to be added/processed for this top level parent.</span>
<a href="#l15.383"></a><span id="l15.383" class="difflineminus">-        ProcessPendingChildEntries(localStoreId, localStoreId, m_pendingChildArray);</span>
<a href="#l15.384"></a><span id="l15.384" class="difflineminus">-        // Clean up the pending list.</span>
<a href="#l15.385"></a><span id="l15.385" class="difflineminus">-        RemoveProcessedChildEntries();</span>
<a href="#l15.386"></a><span id="l15.386" class="difflineminus">-      }</span>
<a href="#l15.387"></a><span id="l15.387" class="difflineminus">-    }</span>
<a href="#l15.388"></a><span id="l15.388" class="difflineminus">-    else if (id &amp;&amp; localStoreId &amp;&amp; parent) {</span>
<a href="#l15.389"></a><span id="l15.389" class="difflineminus">-      // veryify that this mailbox is in the local store</span>
<a href="#l15.390"></a><span id="l15.390" class="difflineminus">-      data = parent;</span>
<a href="#l15.391"></a><span id="l15.391" class="difflineminus">-      while (data &amp;&amp; (data != localStoreId)) {</span>
<a href="#l15.392"></a><span id="l15.392" class="difflineminus">-        pEntry = GetIndexEntry(data);</span>
<a href="#l15.393"></a><span id="l15.393" class="difflineminus">-        if (pEntry)</span>
<a href="#l15.394"></a><span id="l15.394" class="difflineminus">-          data = pEntry-&gt;parent;</span>
<a href="#l15.395"></a><span id="l15.395" class="difflineminus">-        else</span>
<a href="#l15.396"></a><span id="l15.396" class="difflineminus">-          data = 0;</span>
<a href="#l15.397"></a><span id="l15.397" class="difflineminus">-      }</span>
<a href="#l15.398"></a><span id="l15.398" class="difflineminus">-      if (data == localStoreId) {</span>
<a href="#l15.399"></a><span id="l15.399" class="difflineminus">-        // Create an entry for this bugger</span>
<a href="#l15.400"></a><span id="l15.400" class="difflineminus">-        pEntry = NewMailboxEntry(id, parent, (const char *) (pBytes + strOffset), pFileName);</span>
<a href="#l15.401"></a><span id="l15.401" class="difflineminus">-        if (pEntry)</span>
<a href="#l15.402"></a><span id="l15.402" class="difflineminus">-        {</span>
<a href="#l15.403"></a><span id="l15.403" class="difflineminus">-          AddChildEntry(pEntry, localStoreId);</span>
<a href="#l15.404"></a><span id="l15.404" class="difflineminus">-          pEntry-&gt;processed =  true;</span>
<a href="#l15.405"></a><span id="l15.405" class="difflineminus">-          // See if we have any child folders that need to be added/processed.</span>
<a href="#l15.406"></a><span id="l15.406" class="difflineminus">-          ProcessPendingChildEntries(id, localStoreId, m_pendingChildArray);</span>
<a href="#l15.407"></a><span id="l15.407" class="difflineminus">-          // Clean up the pending list.</span>
<a href="#l15.408"></a><span id="l15.408" class="difflineminus">-          RemoveProcessedChildEntries();</span>
<a href="#l15.409"></a><span id="l15.409" class="difflineminus">-        }</span>
<a href="#l15.410"></a><span id="l15.410" class="difflineminus">-      }</span>
<a href="#l15.411"></a><span id="l15.411" class="difflineminus">-      else</span>
<a href="#l15.412"></a><span id="l15.412" class="difflineminus">-      {</span>
<a href="#l15.413"></a><span id="l15.413" class="difflineminus">-        // Put this folder into child array and process it when its parent shows up.</span>
<a href="#l15.414"></a><span id="l15.414" class="difflineminus">-        pEntry = NewMailboxEntry(id, parent, (const char *) (pBytes + strOffset), pFileName);</span>
<a href="#l15.415"></a><span id="l15.415" class="difflineminus">-        if (pEntry)</span>
<a href="#l15.416"></a><span id="l15.416" class="difflineminus">-          m_pendingChildArray.AppendElement(pEntry);</span>
<a href="#l15.417"></a><span id="l15.417" class="difflineminus">-      }</span>
<a href="#l15.418"></a><span id="l15.418" class="difflineminus">-    }</span>
<a href="#l15.419"></a><span id="l15.419" class="difflineminus">-    else if (pFileName)</span>
<a href="#l15.420"></a><span id="l15.420" class="difflineminus">-    {</span>
<a href="#l15.421"></a><span id="l15.421" class="difflineminus">-      // Put this folder into child array and process it when its parent shows up.</span>
<a href="#l15.422"></a><span id="l15.422" class="difflineminus">-      // For some reason, it's likely that child folders come before their parents.</span>
<a href="#l15.423"></a><span id="l15.423" class="difflineminus">-      pEntry = NewMailboxEntry(id, parent, (const char *) (pBytes + strOffset), pFileName);</span>
<a href="#l15.424"></a><span id="l15.424" class="difflineminus">-      if (pEntry)</span>
<a href="#l15.425"></a><span id="l15.425" class="difflineminus">-        m_pendingChildArray.AppendElement(pEntry);</span>
<a href="#l15.426"></a><span id="l15.426" class="difflineminus">-    }</span>
<a href="#l15.427"></a><span id="l15.427" class="difflineminus">-</span>
<a href="#l15.428"></a><span id="l15.428" class="difflineminus">-    delete [] pBytes;</span>
<a href="#l15.429"></a><span id="l15.429" class="difflineminus">-  }</span>
<a href="#l15.430"></a><span id="l15.430" class="difflineminus">-</span>
<a href="#l15.431"></a><span id="l15.431" class="difflineminus">-</span>
<a href="#l15.432"></a><span id="l15.432" class="difflineminus">-  delete [] pIndex;</span>
<a href="#l15.433"></a><span id="l15.433" class="difflineminus">-</span>
<a href="#l15.434"></a><span id="l15.434" class="difflineminus">-  return m_entryArray.Length();</span>
<a href="#l15.435"></a><span id="l15.435" class="difflineminus">-}</span>
<a href="#l15.436"></a><span id="l15.436" class="difflineminus">-</span>
<a href="#l15.437"></a><span id="l15.437" class="difflineminus">-nsOEScanBoxes::MailboxEntry *nsOEScanBoxes::NewMailboxEntry(uint32_t id, uint32_t parent, const char *prettyName, char *pFileName)</span>
<a href="#l15.438"></a><span id="l15.438" class="difflineminus">-{</span>
<a href="#l15.439"></a><span id="l15.439" class="difflineminus">-  MailboxEntry *pEntry = new MailboxEntry();</span>
<a href="#l15.440"></a><span id="l15.440" class="difflineminus">-  if (!pEntry)</span>
<a href="#l15.441"></a><span id="l15.441" class="difflineminus">-    return nullptr;</span>
<a href="#l15.442"></a><span id="l15.442" class="difflineminus">-</span>
<a href="#l15.443"></a><span id="l15.443" class="difflineminus">-  pEntry-&gt;index = id;</span>
<a href="#l15.444"></a><span id="l15.444" class="difflineminus">-  pEntry-&gt;parent = parent;</span>
<a href="#l15.445"></a><span id="l15.445" class="difflineminus">-  pEntry-&gt;child = 0;</span>
<a href="#l15.446"></a><span id="l15.446" class="difflineminus">-  pEntry-&gt;type = 0;</span>
<a href="#l15.447"></a><span id="l15.447" class="difflineminus">-  pEntry-&gt;sibling = -1;</span>
<a href="#l15.448"></a><span id="l15.448" class="difflineminus">-  pEntry-&gt;processed =  false;</span>
<a href="#l15.449"></a><span id="l15.449" class="difflineminus">-  NS_CopyNativeToUnicode(nsDependentCString(prettyName), pEntry-&gt;mailName);</span>
<a href="#l15.450"></a><span id="l15.450" class="difflineminus">-  if (pFileName)</span>
<a href="#l15.451"></a><span id="l15.451" class="difflineminus">-    pEntry-&gt;fileName = pFileName;</span>
<a href="#l15.452"></a><span id="l15.452" class="difflineminus">-  return pEntry;</span>
<a href="#l15.453"></a><span id="l15.453" class="difflineminus">-}</span>
<a href="#l15.454"></a><span id="l15.454" class="difflineminus">-</span>
<a href="#l15.455"></a><span id="l15.455" class="difflineminus">-void nsOEScanBoxes::ProcessPendingChildEntries(uint32_t parent, uint32_t rootIndex, nsTArray&lt;MailboxEntry*&gt;  &amp;childArray)</span>
<a href="#l15.456"></a><span id="l15.456" class="difflineminus">-{</span>
<a href="#l15.457"></a><span id="l15.457" class="difflineminus">-  int32_t i, max;</span>
<a href="#l15.458"></a><span id="l15.458" class="difflineminus">-  MailboxEntry *pEntry;</span>
<a href="#l15.459"></a><span id="l15.459" class="difflineminus">-  for (i = 0, max = childArray.Length(); i &lt; max; i++)</span>
<a href="#l15.460"></a><span id="l15.460" class="difflineminus">-  {</span>
<a href="#l15.461"></a><span id="l15.461" class="difflineminus">-    pEntry = childArray.ElementAt(i);</span>
<a href="#l15.462"></a><span id="l15.462" class="difflineminus">-    if ((!pEntry-&gt;processed) &amp;&amp; (pEntry-&gt;parent == parent))</span>
<a href="#l15.463"></a><span id="l15.463" class="difflineminus">-    {</span>
<a href="#l15.464"></a><span id="l15.464" class="difflineminus">-      AddChildEntry(pEntry, rootIndex);</span>
<a href="#l15.465"></a><span id="l15.465" class="difflineminus">-      pEntry-&gt;processed =  true; // indicate it's been processed.</span>
<a href="#l15.466"></a><span id="l15.466" class="difflineminus">-      // See if there are unprocessed child folders for this child in the</span>
<a href="#l15.467"></a><span id="l15.467" class="difflineminus">-      // array as well (ie, both child and grand-child are on the list).</span>
<a href="#l15.468"></a><span id="l15.468" class="difflineminus">-      ProcessPendingChildEntries(pEntry-&gt;index, rootIndex, childArray);</span>
<a href="#l15.469"></a><span id="l15.469" class="difflineminus">-    }</span>
<a href="#l15.470"></a><span id="l15.470" class="difflineminus">-  }</span>
<a href="#l15.471"></a><span id="l15.471" class="difflineminus">-}</span>
<a href="#l15.472"></a><span id="l15.472" class="difflineminus">-</span>
<a href="#l15.473"></a><span id="l15.473" class="difflineminus">-void nsOEScanBoxes::RemoveProcessedChildEntries()</span>
<a href="#l15.474"></a><span id="l15.474" class="difflineminus">-{</span>
<a href="#l15.475"></a><span id="l15.475" class="difflineminus">-  // Remove already processed entries from the pending list. Note that these entries are also</span>
<a href="#l15.476"></a><span id="l15.476" class="difflineminus">-  // on 'm_entryArray' list so we don't want to deallocate the space for the entries now.</span>
<a href="#l15.477"></a><span id="l15.477" class="difflineminus">-  MailboxEntry * pEntry;</span>
<a href="#l15.478"></a><span id="l15.478" class="difflineminus">-  int32_t i;</span>
<a href="#l15.479"></a><span id="l15.479" class="difflineminus">-  for (i = m_pendingChildArray.Length()-1; i &gt;= 0; i--)</span>
<a href="#l15.480"></a><span id="l15.480" class="difflineminus">-  {</span>
<a href="#l15.481"></a><span id="l15.481" class="difflineminus">-    pEntry = m_pendingChildArray.ElementAt(i);</span>
<a href="#l15.482"></a><span id="l15.482" class="difflineminus">-    if (pEntry-&gt;processed)</span>
<a href="#l15.483"></a><span id="l15.483" class="difflineminus">-      m_pendingChildArray.RemoveElementAt(i);</span>
<a href="#l15.484"></a><span id="l15.484" class="difflineminus">-  }</span>
<a href="#l15.485"></a><span id="l15.485" class="difflineminus">-}</span>
<a href="#l15.486"></a><span id="l15.486" class="difflineminus">-</span>
<a href="#l15.487"></a><span id="l15.487" class="difflineminus">-void nsOEScanBoxes::AddChildEntry(MailboxEntry *pEntry, uint32_t rootIndex)</span>
<a href="#l15.488"></a><span id="l15.488" class="difflineminus">-{</span>
<a href="#l15.489"></a><span id="l15.489" class="difflineminus">-  if (!m_pFirst) {</span>
<a href="#l15.490"></a><span id="l15.490" class="difflineminus">-    if (pEntry-&gt;parent == rootIndex) {</span>
<a href="#l15.491"></a><span id="l15.491" class="difflineminus">-      m_pFirst = pEntry;</span>
<a href="#l15.492"></a><span id="l15.492" class="difflineminus">-      m_entryArray.AppendElement(pEntry);</span>
<a href="#l15.493"></a><span id="l15.493" class="difflineminus">-    }</span>
<a href="#l15.494"></a><span id="l15.494" class="difflineminus">-    else {</span>
<a href="#l15.495"></a><span id="l15.495" class="difflineminus">-      delete pEntry;</span>
<a href="#l15.496"></a><span id="l15.496" class="difflineminus">-    }</span>
<a href="#l15.497"></a><span id="l15.497" class="difflineminus">-    return;</span>
<a href="#l15.498"></a><span id="l15.498" class="difflineminus">-  }</span>
<a href="#l15.499"></a><span id="l15.499" class="difflineminus">-</span>
<a href="#l15.500"></a><span id="l15.500" class="difflineminus">-  MailboxEntry *  pParent = nullptr;</span>
<a href="#l15.501"></a><span id="l15.501" class="difflineminus">-  MailboxEntry *  pSibling = nullptr;</span>
<a href="#l15.502"></a><span id="l15.502" class="difflineminus">-  if (pEntry-&gt;parent == rootIndex) {</span>
<a href="#l15.503"></a><span id="l15.503" class="difflineminus">-    pSibling = m_pFirst;</span>
<a href="#l15.504"></a><span id="l15.504" class="difflineminus">-  }</span>
<a href="#l15.505"></a><span id="l15.505" class="difflineminus">-  else {</span>
<a href="#l15.506"></a><span id="l15.506" class="difflineminus">-    pParent = GetIndexEntry(pEntry-&gt;parent);</span>
<a href="#l15.507"></a><span id="l15.507" class="difflineminus">-  }</span>
<a href="#l15.508"></a><span id="l15.508" class="difflineminus">-</span>
<a href="#l15.509"></a><span id="l15.509" class="difflineminus">-  if (!pParent &amp;&amp; !pSibling) {</span>
<a href="#l15.510"></a><span id="l15.510" class="difflineminus">-    delete pEntry;</span>
<a href="#l15.511"></a><span id="l15.511" class="difflineminus">-    return;</span>
<a href="#l15.512"></a><span id="l15.512" class="difflineminus">-  }</span>
<a href="#l15.513"></a><span id="l15.513" class="difflineminus">-</span>
<a href="#l15.514"></a><span id="l15.514" class="difflineminus">-  if (pParent &amp;&amp; (pParent-&gt;child == 0)) {</span>
<a href="#l15.515"></a><span id="l15.515" class="difflineminus">-    pParent-&gt;child = pEntry-&gt;index;</span>
<a href="#l15.516"></a><span id="l15.516" class="difflineminus">-    m_entryArray.AppendElement(pEntry);</span>
<a href="#l15.517"></a><span id="l15.517" class="difflineminus">-    return;</span>
<a href="#l15.518"></a><span id="l15.518" class="difflineminus">-  }</span>
<a href="#l15.519"></a><span id="l15.519" class="difflineminus">-</span>
<a href="#l15.520"></a><span id="l15.520" class="difflineminus">-  if (!pSibling)</span>
<a href="#l15.521"></a><span id="l15.521" class="difflineminus">-    pSibling = GetIndexEntry(pParent-&gt;child);</span>
<a href="#l15.522"></a><span id="l15.522" class="difflineminus">-</span>
<a href="#l15.523"></a><span id="l15.523" class="difflineminus">-  while (pSibling &amp;&amp; (pSibling-&gt;sibling != -1)) {</span>
<a href="#l15.524"></a><span id="l15.524" class="difflineminus">-    pSibling = GetIndexEntry(pSibling-&gt;sibling);</span>
<a href="#l15.525"></a><span id="l15.525" class="difflineminus">-  }</span>
<a href="#l15.526"></a><span id="l15.526" class="difflineminus">-</span>
<a href="#l15.527"></a><span id="l15.527" class="difflineminus">-  if (!pSibling) {</span>
<a href="#l15.528"></a><span id="l15.528" class="difflineminus">-    delete pEntry;</span>
<a href="#l15.529"></a><span id="l15.529" class="difflineminus">-    return;</span>
<a href="#l15.530"></a><span id="l15.530" class="difflineminus">-  }</span>
<a href="#l15.531"></a><span id="l15.531" class="difflineminus">-</span>
<a href="#l15.532"></a><span id="l15.532" class="difflineminus">-  pSibling-&gt;sibling = pEntry-&gt;index;</span>
<a href="#l15.533"></a><span id="l15.533" class="difflineminus">-  m_entryArray.AppendElement(pEntry);</span>
<a href="#l15.534"></a><span id="l15.534" class="difflineminus">-}</span>
<a href="#l15.535"></a><span id="l15.535" class="difflineminus">-</span>
<a href="#l15.536"></a><span id="l15.536" class="difflineminus">-bool nsOEScanBoxes::Scan50MailboxDir(nsIFile * srcDir)</span>
<a href="#l15.537"></a><span id="l15.537" class="difflineminus">-{</span>
<a href="#l15.538"></a><span id="l15.538" class="difflineminus">-  Reset();</span>
<a href="#l15.539"></a><span id="l15.539" class="difflineminus">-</span>
<a href="#l15.540"></a><span id="l15.540" class="difflineminus">-  MailboxEntry *pEntry;</span>
<a href="#l15.541"></a><span id="l15.541" class="difflineminus">-  int32_t      index = 1;</span>
<a href="#l15.542"></a><span id="l15.542" class="difflineminus">-  char         *pLeaf;</span>
<a href="#l15.543"></a><span id="l15.543" class="difflineminus">-</span>
<a href="#l15.544"></a><span id="l15.544" class="difflineminus">-  bool hasMore;</span>
<a href="#l15.545"></a><span id="l15.545" class="difflineminus">-  nsCOMPtr&lt;nsISimpleEnumerator&gt; directoryEnumerator;</span>
<a href="#l15.546"></a><span id="l15.546" class="difflineminus">-  nsresult rv = srcDir-&gt;GetDirectoryEntries(getter_AddRefs(directoryEnumerator));</span>
<a href="#l15.547"></a><span id="l15.547" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l15.548"></a><span id="l15.548" class="difflineminus">-</span>
<a href="#l15.549"></a><span id="l15.549" class="difflineminus">-  directoryEnumerator-&gt;HasMoreElements(&amp;hasMore);</span>
<a href="#l15.550"></a><span id="l15.550" class="difflineminus">-  bool              isFile;</span>
<a href="#l15.551"></a><span id="l15.551" class="difflineminus">-  nsCOMPtr&lt;nsIFile&gt; entry;</span>
<a href="#l15.552"></a><span id="l15.552" class="difflineminus">-  nsCString         fName;</span>
<a href="#l15.553"></a><span id="l15.553" class="difflineminus">-</span>
<a href="#l15.554"></a><span id="l15.554" class="difflineminus">-  while (hasMore &amp;&amp; NS_SUCCEEDED(rv))</span>
<a href="#l15.555"></a><span id="l15.555" class="difflineminus">-  {</span>
<a href="#l15.556"></a><span id="l15.556" class="difflineminus">-    nsCOMPtr&lt;nsISupports&gt; aSupport;</span>
<a href="#l15.557"></a><span id="l15.557" class="difflineminus">-    rv = directoryEnumerator-&gt;GetNext(getter_AddRefs(aSupport));</span>
<a href="#l15.558"></a><span id="l15.558" class="difflineminus">-    nsCOMPtr&lt;nsIFile&gt; entry(do_QueryInterface(aSupport, &amp;rv));</span>
<a href="#l15.559"></a><span id="l15.559" class="difflineminus">-    directoryEnumerator-&gt;HasMoreElements(&amp;hasMore);</span>
<a href="#l15.560"></a><span id="l15.560" class="difflineminus">-</span>
<a href="#l15.561"></a><span id="l15.561" class="difflineminus">-    isFile = false;</span>
<a href="#l15.562"></a><span id="l15.562" class="difflineminus">-    rv = entry-&gt;IsFile(&amp;isFile);</span>
<a href="#l15.563"></a><span id="l15.563" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; isFile) {</span>
<a href="#l15.564"></a><span id="l15.564" class="difflineminus">-      pLeaf = nullptr;</span>
<a href="#l15.565"></a><span id="l15.565" class="difflineminus">-      rv = entry-&gt;GetNativeLeafName(fName);</span>
<a href="#l15.566"></a><span id="l15.566" class="difflineminus">-      if (NS_SUCCEEDED(rv)  &amp;&amp;</span>
<a href="#l15.567"></a><span id="l15.567" class="difflineminus">-        (StringEndsWith(fName, NS_LITERAL_CSTRING(&quot;.dbx&quot;)))) {</span>
<a href="#l15.568"></a><span id="l15.568" class="difflineminus">-          // This is a *.dbx file in the mail directory</span>
<a href="#l15.569"></a><span id="l15.569" class="difflineminus">-          if (nsOE5File::IsLocalMailFile(entry)) {</span>
<a href="#l15.570"></a><span id="l15.570" class="difflineminus">-            pEntry = new MailboxEntry;</span>
<a href="#l15.571"></a><span id="l15.571" class="difflineminus">-            pEntry-&gt;index = index;</span>
<a href="#l15.572"></a><span id="l15.572" class="difflineminus">-            index++;</span>
<a href="#l15.573"></a><span id="l15.573" class="difflineminus">-            pEntry-&gt;parent = 0;</span>
<a href="#l15.574"></a><span id="l15.574" class="difflineminus">-            pEntry-&gt;child = 0;</span>
<a href="#l15.575"></a><span id="l15.575" class="difflineminus">-            pEntry-&gt;sibling = index;</span>
<a href="#l15.576"></a><span id="l15.576" class="difflineminus">-            pEntry-&gt;type = -1;</span>
<a href="#l15.577"></a><span id="l15.577" class="difflineminus">-            fName.SetLength(fName.Length() - 4);</span>
<a href="#l15.578"></a><span id="l15.578" class="difflineminus">-            pEntry-&gt;fileName = fName.get();</span>
<a href="#l15.579"></a><span id="l15.579" class="difflineminus">-            NS_CopyNativeToUnicode(fName, pEntry-&gt;mailName);</span>
<a href="#l15.580"></a><span id="l15.580" class="difflineminus">-            m_entryArray.AppendElement(pEntry);</span>
<a href="#l15.581"></a><span id="l15.581" class="difflineminus">-          }</span>
<a href="#l15.582"></a><span id="l15.582" class="difflineminus">-      }</span>
<a href="#l15.583"></a><span id="l15.583" class="difflineminus">-    }</span>
<a href="#l15.584"></a><span id="l15.584" class="difflineminus">-  }</span>
<a href="#l15.585"></a><span id="l15.585" class="difflineminus">-</span>
<a href="#l15.586"></a><span id="l15.586" class="difflineminus">-  if (m_entryArray.Length() &gt; 0) {</span>
<a href="#l15.587"></a><span id="l15.587" class="difflineminus">-    pEntry = m_entryArray.ElementAt(m_entryArray.Length() - 1);</span>
<a href="#l15.588"></a><span id="l15.588" class="difflineminus">-    pEntry-&gt;sibling = -1;</span>
<a href="#l15.589"></a><span id="l15.589" class="difflineminus">-    return true;</span>
<a href="#l15.590"></a><span id="l15.590" class="difflineminus">-  }</span>
<a href="#l15.591"></a><span id="l15.591" class="difflineminus">-</span>
<a href="#l15.592"></a><span id="l15.592" class="difflineminus">-  return false;</span>
<a href="#l15.593"></a><span id="l15.593" class="difflineminus">-}</span>
<a href="#l15.594"></a><span id="l15.594" class="difflineminus">-</span>
<a href="#l15.595"></a><span id="l15.595" class="difflineminus">-void nsOEScanBoxes::ScanMailboxDir(nsIFile * srcDir)</span>
<a href="#l15.596"></a><span id="l15.596" class="difflineminus">-{</span>
<a href="#l15.597"></a><span id="l15.597" class="difflineminus">-  if (Scan50MailboxDir(srcDir))</span>
<a href="#l15.598"></a><span id="l15.598" class="difflineminus">-    return;</span>
<a href="#l15.599"></a><span id="l15.599" class="difflineminus">-</span>
<a href="#l15.600"></a><span id="l15.600" class="difflineminus">-  Reset();</span>
<a href="#l15.601"></a><span id="l15.601" class="difflineminus">-</span>
<a href="#l15.602"></a><span id="l15.602" class="difflineminus">-  MailboxEntry *  pEntry;</span>
<a href="#l15.603"></a><span id="l15.603" class="difflineminus">-  int32_t      index = 1;</span>
<a href="#l15.604"></a><span id="l15.604" class="difflineminus">-  nsAutoCString pLeaf;</span>
<a href="#l15.605"></a><span id="l15.605" class="difflineminus">-  uint32_t    sLen;</span>
<a href="#l15.606"></a><span id="l15.606" class="difflineminus">-</span>
<a href="#l15.607"></a><span id="l15.607" class="difflineminus">-  bool hasMore;</span>
<a href="#l15.608"></a><span id="l15.608" class="difflineminus">-  nsCOMPtr&lt;nsISimpleEnumerator&gt; directoryEnumerator;</span>
<a href="#l15.609"></a><span id="l15.609" class="difflineminus">-  nsresult rv = srcDir-&gt;GetDirectoryEntries(getter_AddRefs(directoryEnumerator));</span>
<a href="#l15.610"></a><span id="l15.610" class="difflineminus">-  NS_ENSURE_SUCCESS_VOID(rv);</span>
<a href="#l15.611"></a><span id="l15.611" class="difflineminus">-</span>
<a href="#l15.612"></a><span id="l15.612" class="difflineminus">-  directoryEnumerator-&gt;HasMoreElements(&amp;hasMore);</span>
<a href="#l15.613"></a><span id="l15.613" class="difflineminus">-  bool              isFile;</span>
<a href="#l15.614"></a><span id="l15.614" class="difflineminus">-  nsCOMPtr&lt;nsIFile&gt; entry;</span>
<a href="#l15.615"></a><span id="l15.615" class="difflineminus">-  nsCString         fName;</span>
<a href="#l15.616"></a><span id="l15.616" class="difflineminus">-  nsCString         ext;</span>
<a href="#l15.617"></a><span id="l15.617" class="difflineminus">-  nsCString         name;</span>
<a href="#l15.618"></a><span id="l15.618" class="difflineminus">-</span>
<a href="#l15.619"></a><span id="l15.619" class="difflineminus">-  while (hasMore &amp;&amp; NS_SUCCEEDED(rv))</span>
<a href="#l15.620"></a><span id="l15.620" class="difflineminus">-  {</span>
<a href="#l15.621"></a><span id="l15.621" class="difflineminus">-    nsCOMPtr&lt;nsISupports&gt; aSupport;</span>
<a href="#l15.622"></a><span id="l15.622" class="difflineminus">-    rv = directoryEnumerator-&gt;GetNext(getter_AddRefs(aSupport));</span>
<a href="#l15.623"></a><span id="l15.623" class="difflineminus">-    nsCOMPtr&lt;nsIFile&gt; entry(do_QueryInterface(aSupport, &amp;rv));</span>
<a href="#l15.624"></a><span id="l15.624" class="difflineminus">-    directoryEnumerator-&gt;HasMoreElements(&amp;hasMore);</span>
<a href="#l15.625"></a><span id="l15.625" class="difflineminus">-</span>
<a href="#l15.626"></a><span id="l15.626" class="difflineminus">-    isFile = false;</span>
<a href="#l15.627"></a><span id="l15.627" class="difflineminus">-    rv = entry-&gt;IsFile(&amp;isFile);</span>
<a href="#l15.628"></a><span id="l15.628" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; isFile)</span>
<a href="#l15.629"></a><span id="l15.629" class="difflineminus">-    {</span>
<a href="#l15.630"></a><span id="l15.630" class="difflineminus">-      rv = entry-&gt;GetNativeLeafName(pLeaf);</span>
<a href="#l15.631"></a><span id="l15.631" class="difflineminus">-      if (NS_SUCCEEDED(rv) &amp;&amp; !pLeaf.IsEmpty() &amp;&amp;</span>
<a href="#l15.632"></a><span id="l15.632" class="difflineminus">-        ((sLen = pLeaf.Length()) &gt; 4) &amp;&amp;</span>
<a href="#l15.633"></a><span id="l15.633" class="difflineminus">-        (!PL_strcasecmp(pLeaf.get() + sLen - 3, &quot;mbx&quot;)))</span>
<a href="#l15.634"></a><span id="l15.634" class="difflineminus">-      {</span>
<a href="#l15.635"></a><span id="l15.635" class="difflineminus">-          // This is a *.mbx file in the mail directory</span>
<a href="#l15.636"></a><span id="l15.636" class="difflineminus">-          pEntry = new MailboxEntry;</span>
<a href="#l15.637"></a><span id="l15.637" class="difflineminus">-          pEntry-&gt;index = index;</span>
<a href="#l15.638"></a><span id="l15.638" class="difflineminus">-          index++;</span>
<a href="#l15.639"></a><span id="l15.639" class="difflineminus">-          pEntry-&gt;parent = 0;</span>
<a href="#l15.640"></a><span id="l15.640" class="difflineminus">-          pEntry-&gt;child = 0;</span>
<a href="#l15.641"></a><span id="l15.641" class="difflineminus">-          pEntry-&gt;sibling = index;</span>
<a href="#l15.642"></a><span id="l15.642" class="difflineminus">-          pEntry-&gt;type = -1;</span>
<a href="#l15.643"></a><span id="l15.643" class="difflineminus">-          pEntry-&gt;fileName = pLeaf;</span>
<a href="#l15.644"></a><span id="l15.644" class="difflineminus">-          pLeaf.SetLength(sLen - 4);</span>
<a href="#l15.645"></a><span id="l15.645" class="difflineminus">-          NS_CopyNativeToUnicode(pLeaf, pEntry-&gt;mailName);</span>
<a href="#l15.646"></a><span id="l15.646" class="difflineminus">-          m_entryArray.AppendElement(pEntry);</span>
<a href="#l15.647"></a><span id="l15.647" class="difflineminus">-      }</span>
<a href="#l15.648"></a><span id="l15.648" class="difflineminus">-    }</span>
<a href="#l15.649"></a><span id="l15.649" class="difflineminus">-  }</span>
<a href="#l15.650"></a><span id="l15.650" class="difflineminus">-</span>
<a href="#l15.651"></a><span id="l15.651" class="difflineminus">-  if (m_entryArray.Length() &gt; 0) {</span>
<a href="#l15.652"></a><span id="l15.652" class="difflineminus">-    pEntry = m_entryArray.ElementAt(m_entryArray.Length() - 1);</span>
<a href="#l15.653"></a><span id="l15.653" class="difflineminus">-    pEntry-&gt;sibling = -1;</span>
<a href="#l15.654"></a><span id="l15.654" class="difflineminus">-  }</span>
<a href="#l15.655"></a><span id="l15.655" class="difflineminus">-}</span>
<a href="#l15.656"></a><span id="l15.656" class="difflineminus">-</span>
<a href="#l15.657"></a><span id="l15.657" class="difflineminus">-uint32_t nsOEScanBoxes::CountMailboxes(MailboxEntry *pBox)</span>
<a href="#l15.658"></a><span id="l15.658" class="difflineminus">-{</span>
<a href="#l15.659"></a><span id="l15.659" class="difflineminus">-  if (pBox == nullptr) {</span>
<a href="#l15.660"></a><span id="l15.660" class="difflineminus">-    if (m_pFirst != nullptr)</span>
<a href="#l15.661"></a><span id="l15.661" class="difflineminus">-      pBox = m_pFirst;</span>
<a href="#l15.662"></a><span id="l15.662" class="difflineminus">-    else {</span>
<a href="#l15.663"></a><span id="l15.663" class="difflineminus">-      if (m_entryArray.Length() &gt; 0)</span>
<a href="#l15.664"></a><span id="l15.664" class="difflineminus">-        pBox = m_entryArray.ElementAt(0);</span>
<a href="#l15.665"></a><span id="l15.665" class="difflineminus">-    }</span>
<a href="#l15.666"></a><span id="l15.666" class="difflineminus">-  }</span>
<a href="#l15.667"></a><span id="l15.667" class="difflineminus">-  uint32_t    count = 0;</span>
<a href="#l15.668"></a><span id="l15.668" class="difflineminus">-</span>
<a href="#l15.669"></a><span id="l15.669" class="difflineminus">-  MailboxEntry *  pChild;</span>
<a href="#l15.670"></a><span id="l15.670" class="difflineminus">-  while (pBox) {</span>
<a href="#l15.671"></a><span id="l15.671" class="difflineminus">-    count++;</span>
<a href="#l15.672"></a><span id="l15.672" class="difflineminus">-    if (pBox-&gt;child) {</span>
<a href="#l15.673"></a><span id="l15.673" class="difflineminus">-      pChild = GetIndexEntry(pBox-&gt;child);</span>
<a href="#l15.674"></a><span id="l15.674" class="difflineminus">-      if (pChild != nullptr)</span>
<a href="#l15.675"></a><span id="l15.675" class="difflineminus">-        count += CountMailboxes(pChild);</span>
<a href="#l15.676"></a><span id="l15.676" class="difflineminus">-    }</span>
<a href="#l15.677"></a><span id="l15.677" class="difflineminus">-    if (pBox-&gt;sibling != -1) {</span>
<a href="#l15.678"></a><span id="l15.678" class="difflineminus">-      pBox = GetIndexEntry(pBox-&gt;sibling);</span>
<a href="#l15.679"></a><span id="l15.679" class="difflineminus">-    }</span>
<a href="#l15.680"></a><span id="l15.680" class="difflineminus">-    else</span>
<a href="#l15.681"></a><span id="l15.681" class="difflineminus">-      pBox = nullptr;</span>
<a href="#l15.682"></a><span id="l15.682" class="difflineminus">-  }</span>
<a href="#l15.683"></a><span id="l15.683" class="difflineminus">-</span>
<a href="#l15.684"></a><span id="l15.684" class="difflineminus">-  return count;</span>
<a href="#l15.685"></a><span id="l15.685" class="difflineminus">-}</span>
<a href="#l15.686"></a><span id="l15.686" class="difflineminus">-</span>
<a href="#l15.687"></a><span id="l15.687" class="difflineminus">-bool nsOEScanBoxes::GetMailboxList(nsIFile * root, nsIArray **pArray)</span>
<a href="#l15.688"></a><span id="l15.688" class="difflineminus">-{</span>
<a href="#l15.689"></a><span id="l15.689" class="difflineminus">-  nsresult rv;</span>
<a href="#l15.690"></a><span id="l15.690" class="difflineminus">-  nsCOMPtr&lt;nsIMutableArray&gt; array(do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l15.691"></a><span id="l15.691" class="difflineminus">-  if (NS_FAILED(rv)) {</span>
<a href="#l15.692"></a><span id="l15.692" class="difflineminus">-    IMPORT_LOG0(&quot;FAILED to allocate the nsIArray\n&quot;);</span>
<a href="#l15.693"></a><span id="l15.693" class="difflineminus">-    return false;</span>
<a href="#l15.694"></a><span id="l15.694" class="difflineminus">-  }</span>
<a href="#l15.695"></a><span id="l15.695" class="difflineminus">-</span>
<a href="#l15.696"></a><span id="l15.696" class="difflineminus">-  BuildMailboxList(nullptr, root, 1, array);</span>
<a href="#l15.697"></a><span id="l15.697" class="difflineminus">-  array.forget(pArray);</span>
<a href="#l15.698"></a><span id="l15.698" class="difflineminus">-</span>
<a href="#l15.699"></a><span id="l15.699" class="difflineminus">-  return true;</span>
<a href="#l15.700"></a><span id="l15.700" class="difflineminus">-}</span>
<a href="#l15.701"></a><span id="l15.701" class="difflineminus">-</span>
<a href="#l15.702"></a><span id="l15.702" class="difflineminus">-void nsOEScanBoxes::BuildMailboxList(MailboxEntry *pBox, nsIFile * root, int32_t depth, nsIMutableArray *pArray)</span>
<a href="#l15.703"></a><span id="l15.703" class="difflineminus">-{</span>
<a href="#l15.704"></a><span id="l15.704" class="difflineminus">-  if (pBox == nullptr) {</span>
<a href="#l15.705"></a><span id="l15.705" class="difflineminus">-    if (m_pFirst != nullptr) {</span>
<a href="#l15.706"></a><span id="l15.706" class="difflineminus">-      pBox = m_pFirst;</span>
<a href="#l15.707"></a><span id="l15.707" class="difflineminus">-</span>
<a href="#l15.708"></a><span id="l15.708" class="difflineminus">-      IMPORT_LOG0(&quot;Assigning start of mailbox list to m_pFirst\n&quot;);</span>
<a href="#l15.709"></a><span id="l15.709" class="difflineminus">-    }</span>
<a href="#l15.710"></a><span id="l15.710" class="difflineminus">-    else {</span>
<a href="#l15.711"></a><span id="l15.711" class="difflineminus">-      if (m_entryArray.Length() &gt; 0) {</span>
<a href="#l15.712"></a><span id="l15.712" class="difflineminus">-        pBox = m_entryArray.ElementAt(0);</span>
<a href="#l15.713"></a><span id="l15.713" class="difflineminus">-</span>
<a href="#l15.714"></a><span id="l15.714" class="difflineminus">-        IMPORT_LOG0(&quot;Assigning start of mailbox list to entry at index 0\n&quot;);</span>
<a href="#l15.715"></a><span id="l15.715" class="difflineminus">-      }</span>
<a href="#l15.716"></a><span id="l15.716" class="difflineminus">-    }</span>
<a href="#l15.717"></a><span id="l15.717" class="difflineminus">-</span>
<a href="#l15.718"></a><span id="l15.718" class="difflineminus">-    if (pBox == nullptr) {</span>
<a href="#l15.719"></a><span id="l15.719" class="difflineminus">-      IMPORT_LOG0(&quot;ERROR ASSIGNING STARTING MAILBOX\n&quot;);</span>
<a href="#l15.720"></a><span id="l15.720" class="difflineminus">-    }</span>
<a href="#l15.721"></a><span id="l15.721" class="difflineminus">-</span>
<a href="#l15.722"></a><span id="l15.722" class="difflineminus">-  }</span>
<a href="#l15.723"></a><span id="l15.723" class="difflineminus">-</span>
<a href="#l15.724"></a><span id="l15.724" class="difflineminus">-  nsresult rv;</span>
<a href="#l15.725"></a><span id="l15.725" class="difflineminus">-  nsCOMPtr&lt;nsIFile&gt; file;</span>
<a href="#l15.726"></a><span id="l15.726" class="difflineminus">-  MailboxEntry *pChild;</span>
<a href="#l15.727"></a><span id="l15.727" class="difflineminus">-  nsIImportMailboxDescriptor *pID;</span>
<a href="#l15.728"></a><span id="l15.728" class="difflineminus">-  nsISupports *pInterface;</span>
<a href="#l15.729"></a><span id="l15.729" class="difflineminus">-  int64_t size;</span>
<a href="#l15.730"></a><span id="l15.730" class="difflineminus">-</span>
<a href="#l15.731"></a><span id="l15.731" class="difflineminus">-  nsCOMPtr&lt;nsIImportService&gt; impSvc(do_GetService(NS_IMPORTSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l15.732"></a><span id="l15.732" class="difflineminus">-  NS_ENSURE_SUCCESS_VOID(rv);</span>
<a href="#l15.733"></a><span id="l15.733" class="difflineminus">-</span>
<a href="#l15.734"></a><span id="l15.734" class="difflineminus">-  while (pBox) {</span>
<a href="#l15.735"></a><span id="l15.735" class="difflineminus">-    rv = impSvc-&gt;CreateNewMailboxDescriptor(&amp;pID);</span>
<a href="#l15.736"></a><span id="l15.736" class="difflineminus">-    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l15.737"></a><span id="l15.737" class="difflineminus">-      pID-&gt;SetDepth(depth);</span>
<a href="#l15.738"></a><span id="l15.738" class="difflineminus">-      pID-&gt;SetIdentifier(pBox-&gt;index);</span>
<a href="#l15.739"></a><span id="l15.739" class="difflineminus">-      pID-&gt;SetDisplayName((char16_t *)pBox-&gt;mailName.get());</span>
<a href="#l15.740"></a><span id="l15.740" class="difflineminus">-      if (!pBox-&gt;fileName.IsEmpty()) {</span>
<a href="#l15.741"></a><span id="l15.741" class="difflineminus">-        pID-&gt;GetFile(getter_AddRefs(file));</span>
<a href="#l15.742"></a><span id="l15.742" class="difflineminus">-        file-&gt;InitWithFile(root);</span>
<a href="#l15.743"></a><span id="l15.743" class="difflineminus">-        file-&gt;AppendNative(pBox-&gt;fileName);</span>
<a href="#l15.744"></a><span id="l15.744" class="difflineminus">-        size = 0;</span>
<a href="#l15.745"></a><span id="l15.745" class="difflineminus">-        file-&gt;GetFileSize(&amp;size);</span>
<a href="#l15.746"></a><span id="l15.746" class="difflineminus">-        pID-&gt;SetSize(size);</span>
<a href="#l15.747"></a><span id="l15.747" class="difflineminus">-      }</span>
<a href="#l15.748"></a><span id="l15.748" class="difflineminus">-      rv = pID-&gt;QueryInterface(kISupportsIID, (void **) &amp;pInterface);</span>
<a href="#l15.749"></a><span id="l15.749" class="difflineminus">-      pArray-&gt;AppendElement(pInterface, false);</span>
<a href="#l15.750"></a><span id="l15.750" class="difflineminus">-      pInterface-&gt;Release();</span>
<a href="#l15.751"></a><span id="l15.751" class="difflineminus">-      pID-&gt;Release();</span>
<a href="#l15.752"></a><span id="l15.752" class="difflineminus">-    }</span>
<a href="#l15.753"></a><span id="l15.753" class="difflineminus">-</span>
<a href="#l15.754"></a><span id="l15.754" class="difflineminus">-    if (pBox-&gt;child) {</span>
<a href="#l15.755"></a><span id="l15.755" class="difflineminus">-      pChild = GetIndexEntry(pBox-&gt;child);</span>
<a href="#l15.756"></a><span id="l15.756" class="difflineminus">-      if (pChild != nullptr)</span>
<a href="#l15.757"></a><span id="l15.757" class="difflineminus">-        BuildMailboxList(pChild, root, depth + 1, pArray);</span>
<a href="#l15.758"></a><span id="l15.758" class="difflineminus">-    }</span>
<a href="#l15.759"></a><span id="l15.759" class="difflineminus">-    if (pBox-&gt;sibling != -1) {</span>
<a href="#l15.760"></a><span id="l15.760" class="difflineminus">-      pBox = GetIndexEntry(pBox-&gt;sibling);</span>
<a href="#l15.761"></a><span id="l15.761" class="difflineminus">-    }</span>
<a href="#l15.762"></a><span id="l15.762" class="difflineminus">-    else</span>
<a href="#l15.763"></a><span id="l15.763" class="difflineminus">-      pBox = nullptr;</span>
<a href="#l15.764"></a><span id="l15.764" class="difflineminus">-  }</span>
<a href="#l15.765"></a><span id="l15.765" class="difflineminus">-</span>
<a href="#l15.766"></a><span id="l15.766" class="difflineminus">-}</span>
<a href="#l15.767"></a><span id="l15.767" class="difflineminus">-</span>
<a href="#l15.768"></a><span id="l15.768" class="difflineminus">-nsOEScanBoxes::MailboxEntry * nsOEScanBoxes::GetIndexEntry(uint32_t index)</span>
<a href="#l15.769"></a><span id="l15.769" class="difflineminus">-{</span>
<a href="#l15.770"></a><span id="l15.770" class="difflineminus">-  int32_t max = m_entryArray.Length();</span>
<a href="#l15.771"></a><span id="l15.771" class="difflineminus">-  for (int32_t i = 0; i &lt; max; i++) {</span>
<a href="#l15.772"></a><span id="l15.772" class="difflineminus">-    MailboxEntry *pEntry = m_entryArray.ElementAt(i);</span>
<a href="#l15.773"></a><span id="l15.773" class="difflineminus">-    if (pEntry-&gt;index == index)</span>
<a href="#l15.774"></a><span id="l15.774" class="difflineminus">-      return pEntry;</span>
<a href="#l15.775"></a><span id="l15.775" class="difflineminus">-  }</span>
<a href="#l15.776"></a><span id="l15.776" class="difflineminus">-</span>
<a href="#l15.777"></a><span id="l15.777" class="difflineminus">-  return nullptr;</span>
<a href="#l15.778"></a><span id="l15.778" class="difflineminus">-}</span>
<a href="#l15.779"></a><span id="l15.779" class="difflineminus">-</span>
<a href="#l15.780"></a><span id="l15.780" class="difflineminus">-</span>
<a href="#l15.781"></a><span id="l15.781" class="difflineminus">-// -------------------------------------------------------</span>
<a href="#l15.782"></a><span id="l15.782" class="difflineminus">-// File utility routines</span>
<a href="#l15.783"></a><span id="l15.783" class="difflineminus">-// -------------------------------------------------------</span>
<a href="#l15.784"></a><span id="l15.784" class="difflineminus">-</span>
<a href="#l15.785"></a><span id="l15.785" class="difflineminus">-bool nsOEScanBoxes::ReadLong(nsIInputStream * stream, int32_t&amp; val, uint32_t offset)</span>
<a href="#l15.786"></a><span id="l15.786" class="difflineminus">-{</span>
<a href="#l15.787"></a><span id="l15.787" class="difflineminus">-  nsresult  rv;</span>
<a href="#l15.788"></a><span id="l15.788" class="difflineminus">-  nsCOMPtr &lt;nsISeekableStream&gt; seekStream = do_QueryInterface(stream, &amp;rv);</span>
<a href="#l15.789"></a><span id="l15.789" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l15.790"></a><span id="l15.790" class="difflineminus">-</span>
<a href="#l15.791"></a><span id="l15.791" class="difflineminus">-  rv = seekStream-&gt;Seek(nsISeekableStream::NS_SEEK_SET, offset);</span>
<a href="#l15.792"></a><span id="l15.792" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l15.793"></a><span id="l15.793" class="difflineminus">-</span>
<a href="#l15.794"></a><span id="l15.794" class="difflineminus">-  uint32_t  cntRead;</span>
<a href="#l15.795"></a><span id="l15.795" class="difflineminus">-  char * pReadTo = (char *)&amp;val;</span>
<a href="#l15.796"></a><span id="l15.796" class="difflineminus">-  rv = stream-&gt;Read(pReadTo, sizeof(val), &amp;cntRead);</span>
<a href="#l15.797"></a><span id="l15.797" class="difflineminus">-</span>
<a href="#l15.798"></a><span id="l15.798" class="difflineminus">-  return NS_SUCCEEDED(rv) &amp;&amp; cntRead == sizeof(val);</span>
<a href="#l15.799"></a><span id="l15.799" class="difflineminus">-}</span>
<a href="#l15.800"></a><span id="l15.800" class="difflineminus">-</span>
<a href="#l15.801"></a><span id="l15.801" class="difflineminus">-bool nsOEScanBoxes::ReadLong(nsIInputStream * stream, uint32_t&amp; val, uint32_t offset)</span>
<a href="#l15.802"></a><span id="l15.802" class="difflineminus">-{</span>
<a href="#l15.803"></a><span id="l15.803" class="difflineminus">-  nsresult rv;</span>
<a href="#l15.804"></a><span id="l15.804" class="difflineminus">-  nsCOMPtr &lt;nsISeekableStream&gt; seekStream = do_QueryInterface(stream, &amp;rv);</span>
<a href="#l15.805"></a><span id="l15.805" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l15.806"></a><span id="l15.806" class="difflineminus">-  rv = seekStream-&gt;Seek(nsISeekableStream::NS_SEEK_SET, offset);</span>
<a href="#l15.807"></a><span id="l15.807" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l15.808"></a><span id="l15.808" class="difflineminus">-</span>
<a href="#l15.809"></a><span id="l15.809" class="difflineminus">-  uint32_t  cntRead;</span>
<a href="#l15.810"></a><span id="l15.810" class="difflineminus">-  char * pReadTo = (char *)&amp;val;</span>
<a href="#l15.811"></a><span id="l15.811" class="difflineminus">-  rv = stream-&gt;Read(pReadTo, sizeof(val), &amp;cntRead);</span>
<a href="#l15.812"></a><span id="l15.812" class="difflineminus">-  if (NS_FAILED(rv) || (cntRead != sizeof(val)))</span>
<a href="#l15.813"></a><span id="l15.813" class="difflineminus">-    return false;</span>
<a href="#l15.814"></a><span id="l15.814" class="difflineminus">-</span>
<a href="#l15.815"></a><span id="l15.815" class="difflineminus">-  return true;</span>
<a href="#l15.816"></a><span id="l15.816" class="difflineminus">-}</span>
<a href="#l15.817"></a><span id="l15.817" class="difflineminus">-</span>
<a href="#l15.818"></a><span id="l15.818" class="difflineminus">-// It appears as though the strings for file name and mailbox</span>
<a href="#l15.819"></a><span id="l15.819" class="difflineminus">-// name are at least 254 chars - verified - they are probably 255</span>
<a href="#l15.820"></a><span id="l15.820" class="difflineminus">-// but why bother going that far!  If a file name is that long then</span>
<a href="#l15.821"></a><span id="l15.821" class="difflineminus">-// the heck with it.</span>
<a href="#l15.822"></a><span id="l15.822" class="difflineminus">-#define  kOutlookExpressStringLength  252</span>
<a href="#l15.823"></a><span id="l15.823" class="difflineminus">-bool nsOEScanBoxes::ReadString(nsIInputStream * stream, nsString&amp; str, uint32_t offset)</span>
<a href="#l15.824"></a><span id="l15.824" class="difflineminus">-{</span>
<a href="#l15.825"></a><span id="l15.825" class="difflineminus">-  nsresult rv;</span>
<a href="#l15.826"></a><span id="l15.826" class="difflineminus">-  nsCOMPtr&lt;nsISeekableStream&gt; seekStream = do_QueryInterface(stream, &amp;rv);</span>
<a href="#l15.827"></a><span id="l15.827" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l15.828"></a><span id="l15.828" class="difflineminus">-</span>
<a href="#l15.829"></a><span id="l15.829" class="difflineminus">-  rv = seekStream-&gt;Seek(nsISeekableStream::NS_SEEK_SET, offset);</span>
<a href="#l15.830"></a><span id="l15.830" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l15.831"></a><span id="l15.831" class="difflineminus">-</span>
<a href="#l15.832"></a><span id="l15.832" class="difflineminus">-  uint32_t cntRead;</span>
<a href="#l15.833"></a><span id="l15.833" class="difflineminus">-  char buffer[kOutlookExpressStringLength];</span>
<a href="#l15.834"></a><span id="l15.834" class="difflineminus">-  char *pReadTo = buffer;</span>
<a href="#l15.835"></a><span id="l15.835" class="difflineminus">-  rv = stream-&gt;Read(pReadTo, kOutlookExpressStringLength, &amp;cntRead);</span>
<a href="#l15.836"></a><span id="l15.836" class="difflineminus">-  if (NS_FAILED(rv) || (cntRead != kOutlookExpressStringLength))</span>
<a href="#l15.837"></a><span id="l15.837" class="difflineminus">-    return false;</span>
<a href="#l15.838"></a><span id="l15.838" class="difflineminus">-</span>
<a href="#l15.839"></a><span id="l15.839" class="difflineminus">-  buffer[kOutlookExpressStringLength - 1] = 0;</span>
<a href="#l15.840"></a><span id="l15.840" class="difflineminus">-  str.AssignASCII(buffer);</span>
<a href="#l15.841"></a><span id="l15.841" class="difflineminus">-  return true;</span>
<a href="#l15.842"></a><span id="l15.842" class="difflineminus">-}</span>
<a href="#l15.843"></a><span id="l15.843" class="difflineminus">-</span>
<a href="#l15.844"></a><span id="l15.844" class="difflineminus">-bool nsOEScanBoxes::ReadString(nsIInputStream * stream, nsCString&amp; str, uint32_t offset)</span>
<a href="#l15.845"></a><span id="l15.845" class="difflineminus">-{</span>
<a href="#l15.846"></a><span id="l15.846" class="difflineminus">-  nsresult rv;</span>
<a href="#l15.847"></a><span id="l15.847" class="difflineminus">-  nsCOMPtr&lt;nsISeekableStream&gt; seekStream = do_QueryInterface(stream, &amp;rv);</span>
<a href="#l15.848"></a><span id="l15.848" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l15.849"></a><span id="l15.849" class="difflineminus">-</span>
<a href="#l15.850"></a><span id="l15.850" class="difflineminus">-  rv = seekStream-&gt;Seek(nsISeekableStream::NS_SEEK_SET, offset);</span>
<a href="#l15.851"></a><span id="l15.851" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l15.852"></a><span id="l15.852" class="difflineminus">-</span>
<a href="#l15.853"></a><span id="l15.853" class="difflineminus">-  uint32_t  cntRead;</span>
<a href="#l15.854"></a><span id="l15.854" class="difflineminus">-  char  buffer[kOutlookExpressStringLength];</span>
<a href="#l15.855"></a><span id="l15.855" class="difflineminus">-  char *pReadTo = buffer;</span>
<a href="#l15.856"></a><span id="l15.856" class="difflineminus">-  rv = stream-&gt;Read(pReadTo, kOutlookExpressStringLength, &amp;cntRead);</span>
<a href="#l15.857"></a><span id="l15.857" class="difflineminus">-  if (NS_FAILED(rv) || (cntRead != kOutlookExpressStringLength))</span>
<a href="#l15.858"></a><span id="l15.858" class="difflineminus">-    return false;</span>
<a href="#l15.859"></a><span id="l15.859" class="difflineminus">-</span>
<a href="#l15.860"></a><span id="l15.860" class="difflineminus">-  buffer[kOutlookExpressStringLength - 1] = 0;</span>
<a href="#l15.861"></a><span id="l15.861" class="difflineminus">-  str = buffer;</span>
<a href="#l15.862"></a><span id="l15.862" class="difflineminus">-  return true;</span>
<a href="#l15.863"></a><span id="l15.863" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1">deleted file mode 100644</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineminus">--- a/mailnews/import/oexpress/nsOEScanBoxes.h</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineplus">+++ /dev/null</span>
<a href="#l16.4"></a><span id="l16.4" class="difflineat">@@ -1,76 +0,0 @@</span>
<a href="#l16.5"></a><span id="l16.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l16.6"></a><span id="l16.6" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l16.7"></a><span id="l16.7" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l16.8"></a><span id="l16.8" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l16.9"></a><span id="l16.9" class="difflineminus">-</span>
<a href="#l16.10"></a><span id="l16.10" class="difflineminus">-#ifndef nsOEScanBoxes_h___</span>
<a href="#l16.11"></a><span id="l16.11" class="difflineminus">-#define nsOEScanBoxes_h___</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineminus">-#include &quot;nsStringGlue.h&quot;</span>
<a href="#l16.14"></a><span id="l16.14" class="difflineminus">-#include &quot;nsIImportModule.h&quot;</span>
<a href="#l16.15"></a><span id="l16.15" class="difflineminus">-#include &quot;nsTArray.h&quot;</span>
<a href="#l16.16"></a><span id="l16.16" class="difflineminus">-#include &quot;nsCOMPtr.h&quot;</span>
<a href="#l16.17"></a><span id="l16.17" class="difflineminus">-#include &quot;nsIArray.h&quot;</span>
<a href="#l16.18"></a><span id="l16.18" class="difflineminus">-#include &quot;nsIMutableArray.h&quot;</span>
<a href="#l16.19"></a><span id="l16.19" class="difflineminus">-#include &quot;nsIFile.h&quot;</span>
<a href="#l16.20"></a><span id="l16.20" class="difflineminus">-#include &quot;nsIImportService.h&quot;</span>
<a href="#l16.21"></a><span id="l16.21" class="difflineminus">-</span>
<a href="#l16.22"></a><span id="l16.22" class="difflineminus">-class nsIInputStream;</span>
<a href="#l16.23"></a><span id="l16.23" class="difflineminus">-</span>
<a href="#l16.24"></a><span id="l16.24" class="difflineminus">-class nsOEScanBoxes {</span>
<a href="#l16.25"></a><span id="l16.25" class="difflineminus">-public:</span>
<a href="#l16.26"></a><span id="l16.26" class="difflineminus">-  nsOEScanBoxes();</span>
<a href="#l16.27"></a><span id="l16.27" class="difflineminus">-  ~nsOEScanBoxes();</span>
<a href="#l16.28"></a><span id="l16.28" class="difflineminus">-</span>
<a href="#l16.29"></a><span id="l16.29" class="difflineminus">-  static bool    FindMail(nsIFile *pWhere);</span>
<a href="#l16.30"></a><span id="l16.30" class="difflineminus">-</span>
<a href="#l16.31"></a><span id="l16.31" class="difflineminus">-  bool    GetMailboxes(nsIFile *pWhere, nsIArray **pArray);</span>
<a href="#l16.32"></a><span id="l16.32" class="difflineminus">-</span>
<a href="#l16.33"></a><span id="l16.33" class="difflineminus">-</span>
<a href="#l16.34"></a><span id="l16.34" class="difflineminus">-private:</span>
<a href="#l16.35"></a><span id="l16.35" class="difflineminus">-  typedef struct {</span>
<a href="#l16.36"></a><span id="l16.36" class="difflineminus">-    uint32_t  index;</span>
<a href="#l16.37"></a><span id="l16.37" class="difflineminus">-    uint32_t  parent;</span>
<a href="#l16.38"></a><span id="l16.38" class="difflineminus">-    int32_t    child;</span>
<a href="#l16.39"></a><span id="l16.39" class="difflineminus">-    int32_t    sibling;</span>
<a href="#l16.40"></a><span id="l16.40" class="difflineminus">-    int32_t    type;</span>
<a href="#l16.41"></a><span id="l16.41" class="difflineminus">-    nsString  mailName;</span>
<a href="#l16.42"></a><span id="l16.42" class="difflineminus">-    nsCString  fileName;</span>
<a href="#l16.43"></a><span id="l16.43" class="difflineminus">-    bool      processed; // used by entries on m_pendingChildArray list</span>
<a href="#l16.44"></a><span id="l16.44" class="difflineminus">-  } MailboxEntry;</span>
<a href="#l16.45"></a><span id="l16.45" class="difflineminus">-</span>
<a href="#l16.46"></a><span id="l16.46" class="difflineminus">-  static bool    Find50Mail(nsIFile *pWhere);</span>
<a href="#l16.47"></a><span id="l16.47" class="difflineminus">-</span>
<a href="#l16.48"></a><span id="l16.48" class="difflineminus">-  void  Reset(void);</span>
<a href="#l16.49"></a><span id="l16.49" class="difflineminus">-  bool    FindMailBoxes(nsIFile * descFile);</span>
<a href="#l16.50"></a><span id="l16.50" class="difflineminus">-  bool    Find50MailBoxes(nsIFile * descFile);</span>
<a href="#l16.51"></a><span id="l16.51" class="difflineminus">-</span>
<a href="#l16.52"></a><span id="l16.52" class="difflineminus">-  // If find mailboxes fails you can use this routine to get the raw mailbox file names</span>
<a href="#l16.53"></a><span id="l16.53" class="difflineminus">-  void  ScanMailboxDir(nsIFile * srcDir);</span>
<a href="#l16.54"></a><span id="l16.54" class="difflineminus">-  bool    Scan50MailboxDir(nsIFile * srcDir);</span>
<a href="#l16.55"></a><span id="l16.55" class="difflineminus">-</span>
<a href="#l16.56"></a><span id="l16.56" class="difflineminus">-  MailboxEntry *  GetIndexEntry(uint32_t index);</span>
<a href="#l16.57"></a><span id="l16.57" class="difflineminus">-  void      AddChildEntry(MailboxEntry *pEntry, uint32_t rootIndex);</span>
<a href="#l16.58"></a><span id="l16.58" class="difflineminus">-  MailboxEntry *  NewMailboxEntry(uint32_t id, uint32_t parent, const char *prettyName, char *pFileName);</span>
<a href="#l16.59"></a><span id="l16.59" class="difflineminus">-  void        ProcessPendingChildEntries(uint32_t parent, uint32_t rootIndex, nsTArray&lt;MailboxEntry*&gt; &amp;childArray);</span>
<a href="#l16.60"></a><span id="l16.60" class="difflineminus">-  void        RemoveProcessedChildEntries();</span>
<a href="#l16.61"></a><span id="l16.61" class="difflineminus">-</span>
<a href="#l16.62"></a><span id="l16.62" class="difflineminus">-</span>
<a href="#l16.63"></a><span id="l16.63" class="difflineminus">-  bool        ReadLong(nsIInputStream * stream, int32_t&amp; val, uint32_t offset);</span>
<a href="#l16.64"></a><span id="l16.64" class="difflineminus">-  bool        ReadLong(nsIInputStream * stream, uint32_t&amp; val, uint32_t offset);</span>
<a href="#l16.65"></a><span id="l16.65" class="difflineminus">-  bool        ReadString(nsIInputStream * stream, nsString&amp; str, uint32_t offset);</span>
<a href="#l16.66"></a><span id="l16.66" class="difflineminus">-  bool        ReadString(nsIInputStream * stream, nsCString&amp; str, uint32_t offset);</span>
<a href="#l16.67"></a><span id="l16.67" class="difflineminus">-  uint32_t     CountMailboxes(MailboxEntry *pBox);</span>
<a href="#l16.68"></a><span id="l16.68" class="difflineminus">-</span>
<a href="#l16.69"></a><span id="l16.69" class="difflineminus">-  void       BuildMailboxList(MailboxEntry *pBox, nsIFile * root, int32_t depth, nsIMutableArray *pArray);</span>
<a href="#l16.70"></a><span id="l16.70" class="difflineminus">-  bool         GetMailboxList(nsIFile * root, nsIArray **pArray);</span>
<a href="#l16.71"></a><span id="l16.71" class="difflineminus">-</span>
<a href="#l16.72"></a><span id="l16.72" class="difflineminus">-private:</span>
<a href="#l16.73"></a><span id="l16.73" class="difflineminus">-  MailboxEntry *        m_pFirst;</span>
<a href="#l16.74"></a><span id="l16.74" class="difflineminus">-  nsTArray&lt;MailboxEntry*&gt;  m_entryArray;</span>
<a href="#l16.75"></a><span id="l16.75" class="difflineminus">-  nsTArray&lt;MailboxEntry*&gt;  m_pendingChildArray; // contains child folders whose parent folders have not showed up.</span>
<a href="#l16.76"></a><span id="l16.76" class="difflineminus">-</span>
<a href="#l16.77"></a><span id="l16.77" class="difflineminus">-  nsCOMPtr&lt;nsIImportService&gt;  mService;</span>
<a href="#l16.78"></a><span id="l16.78" class="difflineminus">-};</span>
<a href="#l16.79"></a><span id="l16.79" class="difflineminus">-</span>
<a href="#l16.80"></a><span id="l16.80" class="difflineminus">-#endif // nsOEScanBoxes_h__</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1">deleted file mode 100644</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineminus">--- a/mailnews/import/oexpress/nsOESettings.cpp</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineplus">+++ /dev/null</span>
<a href="#l17.4"></a><span id="l17.4" class="difflineat">@@ -1,903 +0,0 @@</span>
<a href="#l17.5"></a><span id="l17.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l17.6"></a><span id="l17.6" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l17.7"></a><span id="l17.7" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l17.8"></a><span id="l17.8" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l17.9"></a><span id="l17.9" class="difflineminus">-</span>
<a href="#l17.10"></a><span id="l17.10" class="difflineminus">-/*</span>
<a href="#l17.11"></a><span id="l17.11" class="difflineminus">-</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-  Outlook Express (Win32) settings</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineminus">-</span>
<a href="#l17.14"></a><span id="l17.14" class="difflineminus">-*/</span>
<a href="#l17.15"></a><span id="l17.15" class="difflineminus">-</span>
<a href="#l17.16"></a><span id="l17.16" class="difflineminus">-#include &quot;nsOESettings.h&quot;</span>
<a href="#l17.17"></a><span id="l17.17" class="difflineminus">-#include &quot;mozilla/WindowsVersion.h&quot;</span>
<a href="#l17.18"></a><span id="l17.18" class="difflineminus">-#include &quot;nsCOMPtr.h&quot;</span>
<a href="#l17.19"></a><span id="l17.19" class="difflineminus">-#include &quot;nscore.h&quot;</span>
<a href="#l17.20"></a><span id="l17.20" class="difflineminus">-#include &quot;nsMsgUtils.h&quot;</span>
<a href="#l17.21"></a><span id="l17.21" class="difflineminus">-#include &quot;nsOEImport.h&quot;</span>
<a href="#l17.22"></a><span id="l17.22" class="difflineminus">-#include &quot;nsIComponentManager.h&quot;</span>
<a href="#l17.23"></a><span id="l17.23" class="difflineminus">-#include &quot;nsIServiceManager.h&quot;</span>
<a href="#l17.24"></a><span id="l17.24" class="difflineminus">-#include &quot;nsOERegUtil.h&quot;</span>
<a href="#l17.25"></a><span id="l17.25" class="difflineminus">-#include &quot;nsIMsgAccountManager.h&quot;</span>
<a href="#l17.26"></a><span id="l17.26" class="difflineminus">-#include &quot;nsIMsgAccount.h&quot;</span>
<a href="#l17.27"></a><span id="l17.27" class="difflineminus">-#include &quot;nsIImportSettings.h&quot;</span>
<a href="#l17.28"></a><span id="l17.28" class="difflineminus">-#include &quot;nsMsgBaseCID.h&quot;</span>
<a href="#l17.29"></a><span id="l17.29" class="difflineminus">-#include &quot;nsMsgCompCID.h&quot;</span>
<a href="#l17.30"></a><span id="l17.30" class="difflineminus">-#include &quot;nsMsgI18N.h&quot;</span>
<a href="#l17.31"></a><span id="l17.31" class="difflineminus">-#include &quot;nsISmtpService.h&quot;</span>
<a href="#l17.32"></a><span id="l17.32" class="difflineminus">-#include &quot;nsISmtpServer.h&quot;</span>
<a href="#l17.33"></a><span id="l17.33" class="difflineminus">-#include &quot;nsOEStringBundle.h&quot;</span>
<a href="#l17.34"></a><span id="l17.34" class="difflineminus">-#include &quot;OEDebugLog.h&quot;</span>
<a href="#l17.35"></a><span id="l17.35" class="difflineminus">-#include &quot;nsIPop3IncomingServer.h&quot;</span>
<a href="#l17.36"></a><span id="l17.36" class="difflineminus">-#include &quot;nsIImapIncomingServer.h&quot;</span>
<a href="#l17.37"></a><span id="l17.37" class="difflineminus">-#include &quot;nsINntpIncomingServer.h&quot;</span>
<a href="#l17.38"></a><span id="l17.38" class="difflineminus">-#include &quot;stdlib.h&quot;</span>
<a href="#l17.39"></a><span id="l17.39" class="difflineminus">-#include &lt;windows.h&gt;</span>
<a href="#l17.40"></a><span id="l17.40" class="difflineminus">-#include &quot;nsIWindowsRegKey.h&quot;</span>
<a href="#l17.41"></a><span id="l17.41" class="difflineminus">-#include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l17.42"></a><span id="l17.42" class="difflineminus">-</span>
<a href="#l17.43"></a><span id="l17.43" class="difflineminus">-#ifdef MOZILLA_INTERNAL_API</span>
<a href="#l17.44"></a><span id="l17.44" class="difflineminus">-#include &quot;nsNativeCharsetUtils.h&quot;</span>
<a href="#l17.45"></a><span id="l17.45" class="difflineminus">-#else</span>
<a href="#l17.46"></a><span id="l17.46" class="difflineminus">-#include &quot;nsMsgI18N.h&quot;</span>
<a href="#l17.47"></a><span id="l17.47" class="difflineminus">-#define NS_CopyNativeToUnicode(source, dest) \</span>
<a href="#l17.48"></a><span id="l17.48" class="difflineminus">-        nsMsgI18NConvertToUnicode(nsMsgI18NFileSystemCharset(), source, dest)</span>
<a href="#l17.49"></a><span id="l17.49" class="difflineminus">-#define NS_CopyUnicodeToNative(source, dest) \</span>
<a href="#l17.50"></a><span id="l17.50" class="difflineminus">-        nsMsgI18NConvertFromUnicode(nsMsgI18NFileSystemCharset(), source, dest)</span>
<a href="#l17.51"></a><span id="l17.51" class="difflineminus">-#endif</span>
<a href="#l17.52"></a><span id="l17.52" class="difflineminus">-</span>
<a href="#l17.53"></a><span id="l17.53" class="difflineminus">-class OESettings {</span>
<a href="#l17.54"></a><span id="l17.54" class="difflineminus">-public:</span>
<a href="#l17.55"></a><span id="l17.55" class="difflineminus">-  static nsresult GetDefaultMailAccount(nsAString &amp;aMailAccount);</span>
<a href="#l17.56"></a><span id="l17.56" class="difflineminus">-  static nsresult GetCheckMailInterval(uint32_t *aInterval);</span>
<a href="#l17.57"></a><span id="l17.57" class="difflineminus">-  static nsresult Find50Key(nsIWindowsRegKey **aKey);</span>
<a href="#l17.58"></a><span id="l17.58" class="difflineminus">-  static nsresult Find40Key(nsIWindowsRegKey **aKey);</span>
<a href="#l17.59"></a><span id="l17.59" class="difflineminus">-  static nsresult FindAccountsKey(nsIWindowsRegKey **aKey);</span>
<a href="#l17.60"></a><span id="l17.60" class="difflineminus">-</span>
<a href="#l17.61"></a><span id="l17.61" class="difflineminus">-  static bool DoImport(nsIMsgAccount **ppAccount);</span>
<a href="#l17.62"></a><span id="l17.62" class="difflineminus">-</span>
<a href="#l17.63"></a><span id="l17.63" class="difflineminus">-  static bool DoIMAPServer(nsIMsgAccountManager *aMgr,</span>
<a href="#l17.64"></a><span id="l17.64" class="difflineminus">-                           nsIWindowsRegKey *aKey,</span>
<a href="#l17.65"></a><span id="l17.65" class="difflineminus">-                           const nsString &amp;aServerName,</span>
<a href="#l17.66"></a><span id="l17.66" class="difflineminus">-                           nsIMsgAccount **ppAccount);</span>
<a href="#l17.67"></a><span id="l17.67" class="difflineminus">-  static bool DoPOP3Server(nsIMsgAccountManager *aMgr,</span>
<a href="#l17.68"></a><span id="l17.68" class="difflineminus">-                           nsIWindowsRegKey *aKey,</span>
<a href="#l17.69"></a><span id="l17.69" class="difflineminus">-                           const nsString &amp;aServerName,</span>
<a href="#l17.70"></a><span id="l17.70" class="difflineminus">-                           nsIMsgAccount **ppAccount);</span>
<a href="#l17.71"></a><span id="l17.71" class="difflineminus">-  static bool DoNNTPServer(nsIMsgAccountManager *aMgr,</span>
<a href="#l17.72"></a><span id="l17.72" class="difflineminus">-                           nsIWindowsRegKey *aKey,</span>
<a href="#l17.73"></a><span id="l17.73" class="difflineminus">-                           const nsString &amp;aServerName,</span>
<a href="#l17.74"></a><span id="l17.74" class="difflineminus">-                           nsIMsgAccount **ppAccount);</span>
<a href="#l17.75"></a><span id="l17.75" class="difflineminus">-</span>
<a href="#l17.76"></a><span id="l17.76" class="difflineminus">-  static void SetIncomingServerProperties(nsIMsgIncomingServer *aServer,</span>
<a href="#l17.77"></a><span id="l17.77" class="difflineminus">-                                          nsIWindowsRegKey *aKey,</span>
<a href="#l17.78"></a><span id="l17.78" class="difflineminus">-                                          const nsString &amp;aKeyNamePrefix);</span>
<a href="#l17.79"></a><span id="l17.79" class="difflineminus">-</span>
<a href="#l17.80"></a><span id="l17.80" class="difflineminus">-  static void SetIdentities(nsIMsgAccountManager *aMgr,</span>
<a href="#l17.81"></a><span id="l17.81" class="difflineminus">-                            nsIMsgAccount *aAccount,</span>
<a href="#l17.82"></a><span id="l17.82" class="difflineminus">-                            nsIWindowsRegKey *aKey,</span>
<a href="#l17.83"></a><span id="l17.83" class="difflineminus">-                            const nsString &amp;aIncomgUserName,</span>
<a href="#l17.84"></a><span id="l17.84" class="difflineminus">-                            int32_t authMethodIncoming, bool isNNTP);</span>
<a href="#l17.85"></a><span id="l17.85" class="difflineminus">-  static void SetSmtpServer(const nsString &amp;aSmtpServer,</span>
<a href="#l17.86"></a><span id="l17.86" class="difflineminus">-                            nsIWindowsRegKey *aKey,</span>
<a href="#l17.87"></a><span id="l17.87" class="difflineminus">-                            nsIMsgIdentity *aId,</span>
<a href="#l17.88"></a><span id="l17.88" class="difflineminus">-                            const nsString &amp;aIncomgUserName,</span>
<a href="#l17.89"></a><span id="l17.89" class="difflineminus">-                            int32_t authMethodIncoming);</span>
<a href="#l17.90"></a><span id="l17.90" class="difflineminus">-  static nsresult GetAccountName(nsIWindowsRegKey *aKey,</span>
<a href="#l17.91"></a><span id="l17.91" class="difflineminus">-                                 const nsString &amp;aDefaultName,</span>
<a href="#l17.92"></a><span id="l17.92" class="difflineminus">-                                 nsAString &amp;aAccountName);</span>
<a href="#l17.93"></a><span id="l17.93" class="difflineminus">-  static bool IsKB933612Applied();</span>
<a href="#l17.94"></a><span id="l17.94" class="difflineminus">-};</span>
<a href="#l17.95"></a><span id="l17.95" class="difflineminus">-</span>
<a href="#l17.96"></a><span id="l17.96" class="difflineminus">-static uint32_t checkNewMailTime;// OE global setting, let's default to 30</span>
<a href="#l17.97"></a><span id="l17.97" class="difflineminus">-static bool     checkNewMail;    // OE global setting, let's default to false</span>
<a href="#l17.98"></a><span id="l17.98" class="difflineminus">-                                 // This won't cause unwanted autodownloads-</span>
<a href="#l17.99"></a><span id="l17.99" class="difflineminus">-                                 // user can set prefs after import</span>
<a href="#l17.100"></a><span id="l17.100" class="difflineminus">-</span>
<a href="#l17.101"></a><span id="l17.101" class="difflineminus">-////////////////////////////////////////////////////////////////////////</span>
<a href="#l17.102"></a><span id="l17.102" class="difflineminus">-nsresult nsOESettings::Create(nsIImportSettings** aImport)</span>
<a href="#l17.103"></a><span id="l17.103" class="difflineminus">-{</span>
<a href="#l17.104"></a><span id="l17.104" class="difflineminus">-    NS_PRECONDITION(aImport != nullptr, &quot;null ptr&quot;);</span>
<a href="#l17.105"></a><span id="l17.105" class="difflineminus">-    if (! aImport)</span>
<a href="#l17.106"></a><span id="l17.106" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l17.107"></a><span id="l17.107" class="difflineminus">-</span>
<a href="#l17.108"></a><span id="l17.108" class="difflineminus">-    *aImport = new nsOESettings();</span>
<a href="#l17.109"></a><span id="l17.109" class="difflineminus">-    if (! *aImport)</span>
<a href="#l17.110"></a><span id="l17.110" class="difflineminus">-        return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l17.111"></a><span id="l17.111" class="difflineminus">-</span>
<a href="#l17.112"></a><span id="l17.112" class="difflineminus">-    NS_ADDREF(*aImport);</span>
<a href="#l17.113"></a><span id="l17.113" class="difflineminus">-    return NS_OK;</span>
<a href="#l17.114"></a><span id="l17.114" class="difflineminus">-}</span>
<a href="#l17.115"></a><span id="l17.115" class="difflineminus">-</span>
<a href="#l17.116"></a><span id="l17.116" class="difflineminus">-nsOESettings::nsOESettings()</span>
<a href="#l17.117"></a><span id="l17.117" class="difflineminus">-{</span>
<a href="#l17.118"></a><span id="l17.118" class="difflineminus">-}</span>
<a href="#l17.119"></a><span id="l17.119" class="difflineminus">-</span>
<a href="#l17.120"></a><span id="l17.120" class="difflineminus">-nsOESettings::~nsOESettings()</span>
<a href="#l17.121"></a><span id="l17.121" class="difflineminus">-{</span>
<a href="#l17.122"></a><span id="l17.122" class="difflineminus">-}</span>
<a href="#l17.123"></a><span id="l17.123" class="difflineminus">-</span>
<a href="#l17.124"></a><span id="l17.124" class="difflineminus">-NS_IMPL_ISUPPORTS(nsOESettings, nsIImportSettings)</span>
<a href="#l17.125"></a><span id="l17.125" class="difflineminus">-</span>
<a href="#l17.126"></a><span id="l17.126" class="difflineminus">-NS_IMETHODIMP nsOESettings::AutoLocate(char16_t **description, nsIFile **location, bool *_retval)</span>
<a href="#l17.127"></a><span id="l17.127" class="difflineminus">-{</span>
<a href="#l17.128"></a><span id="l17.128" class="difflineminus">-  NS_PRECONDITION(description != nullptr, &quot;null ptr&quot;);</span>
<a href="#l17.129"></a><span id="l17.129" class="difflineminus">-  NS_PRECONDITION(_retval != nullptr, &quot;null ptr&quot;);</span>
<a href="#l17.130"></a><span id="l17.130" class="difflineminus">-  if (!description || !_retval)</span>
<a href="#l17.131"></a><span id="l17.131" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l17.132"></a><span id="l17.132" class="difflineminus">-</span>
<a href="#l17.133"></a><span id="l17.133" class="difflineminus">-  *description = nsOEStringBundle::GetStringByID(OEIMPORT_NAME);</span>
<a href="#l17.134"></a><span id="l17.134" class="difflineminus">-</span>
<a href="#l17.135"></a><span id="l17.135" class="difflineminus">-  if (location)</span>
<a href="#l17.136"></a><span id="l17.136" class="difflineminus">-    *location = nullptr;</span>
<a href="#l17.137"></a><span id="l17.137" class="difflineminus">-</span>
<a href="#l17.138"></a><span id="l17.138" class="difflineminus">-  *_retval = false;</span>
<a href="#l17.139"></a><span id="l17.139" class="difflineminus">-  nsCOMPtr&lt;nsIWindowsRegKey&gt; key;</span>
<a href="#l17.140"></a><span id="l17.140" class="difflineminus">-  if (NS_FAILED(OESettings::Find50Key(getter_AddRefs(key))) &amp;&amp;</span>
<a href="#l17.141"></a><span id="l17.141" class="difflineminus">-      NS_FAILED(OESettings::Find40Key(getter_AddRefs(key))))</span>
<a href="#l17.142"></a><span id="l17.142" class="difflineminus">-    return NS_OK;</span>
<a href="#l17.143"></a><span id="l17.143" class="difflineminus">-</span>
<a href="#l17.144"></a><span id="l17.144" class="difflineminus">-  if (NS_SUCCEEDED(OESettings::FindAccountsKey(getter_AddRefs(key))))</span>
<a href="#l17.145"></a><span id="l17.145" class="difflineminus">-    *_retval = true;</span>
<a href="#l17.146"></a><span id="l17.146" class="difflineminus">-</span>
<a href="#l17.147"></a><span id="l17.147" class="difflineminus">-  return NS_OK;</span>
<a href="#l17.148"></a><span id="l17.148" class="difflineminus">-}</span>
<a href="#l17.149"></a><span id="l17.149" class="difflineminus">-</span>
<a href="#l17.150"></a><span id="l17.150" class="difflineminus">-NS_IMETHODIMP nsOESettings::SetLocation(nsIFile *location)</span>
<a href="#l17.151"></a><span id="l17.151" class="difflineminus">-{</span>
<a href="#l17.152"></a><span id="l17.152" class="difflineminus">-  return NS_OK;</span>
<a href="#l17.153"></a><span id="l17.153" class="difflineminus">-}</span>
<a href="#l17.154"></a><span id="l17.154" class="difflineminus">-</span>
<a href="#l17.155"></a><span id="l17.155" class="difflineminus">-NS_IMETHODIMP nsOESettings::Import(nsIMsgAccount **localMailAccount, bool *_retval)</span>
<a href="#l17.156"></a><span id="l17.156" class="difflineminus">-{</span>
<a href="#l17.157"></a><span id="l17.157" class="difflineminus">-  NS_PRECONDITION(_retval != nullptr, &quot;null ptr&quot;);</span>
<a href="#l17.158"></a><span id="l17.158" class="difflineminus">-</span>
<a href="#l17.159"></a><span id="l17.159" class="difflineminus">-  if (OESettings::DoImport(localMailAccount)) {</span>
<a href="#l17.160"></a><span id="l17.160" class="difflineminus">-    *_retval = true;</span>
<a href="#l17.161"></a><span id="l17.161" class="difflineminus">-    IMPORT_LOG0(&quot;Settings import appears successful\n&quot;);</span>
<a href="#l17.162"></a><span id="l17.162" class="difflineminus">-  }</span>
<a href="#l17.163"></a><span id="l17.163" class="difflineminus">-  else {</span>
<a href="#l17.164"></a><span id="l17.164" class="difflineminus">-    *_retval = false;</span>
<a href="#l17.165"></a><span id="l17.165" class="difflineminus">-    IMPORT_LOG0(&quot;Settings import returned FALSE\n&quot;);</span>
<a href="#l17.166"></a><span id="l17.166" class="difflineminus">-  }</span>
<a href="#l17.167"></a><span id="l17.167" class="difflineminus">-</span>
<a href="#l17.168"></a><span id="l17.168" class="difflineminus">-  return NS_OK;</span>
<a href="#l17.169"></a><span id="l17.169" class="difflineminus">-}</span>
<a href="#l17.170"></a><span id="l17.170" class="difflineminus">-</span>
<a href="#l17.171"></a><span id="l17.171" class="difflineminus">-nsresult OESettings::GetDefaultMailAccount(nsAString &amp;aMailAccount)</span>
<a href="#l17.172"></a><span id="l17.172" class="difflineminus">-{</span>
<a href="#l17.173"></a><span id="l17.173" class="difflineminus">-  nsresult rv;</span>
<a href="#l17.174"></a><span id="l17.174" class="difflineminus">-  nsCOMPtr&lt;nsIWindowsRegKey&gt; key =</span>
<a href="#l17.175"></a><span id="l17.175" class="difflineminus">-    do_CreateInstance(&quot;@mozilla.org/windows-registry-key;1&quot;, &amp;rv);</span>
<a href="#l17.176"></a><span id="l17.176" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.177"></a><span id="l17.177" class="difflineminus">-</span>
<a href="#l17.178"></a><span id="l17.178" class="difflineminus">-  nsAutoString userId;</span>
<a href="#l17.179"></a><span id="l17.179" class="difflineminus">-  rv = nsOERegUtil::GetDefaultUserId(userId);</span>
<a href="#l17.180"></a><span id="l17.180" class="difflineminus">-  // OE has default mail account here when it has been</span>
<a href="#l17.181"></a><span id="l17.181" class="difflineminus">-  // set up by transfer or has multiple identities</span>
<a href="#l17.182"></a><span id="l17.182" class="difflineminus">-  // look below for orig code that looked in new OE installs</span>
<a href="#l17.183"></a><span id="l17.183" class="difflineminus">-  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l17.184"></a><span id="l17.184" class="difflineminus">-    nsAutoString path(NS_LITERAL_STRING(&quot;Identities\\&quot;));</span>
<a href="#l17.185"></a><span id="l17.185" class="difflineminus">-    path.Append(userId);</span>
<a href="#l17.186"></a><span id="l17.186" class="difflineminus">-    path.AppendLiteral(&quot;\\Software\\Microsoft\\Internet Account Manager&quot;);</span>
<a href="#l17.187"></a><span id="l17.187" class="difflineminus">-    rv = key-&gt;Open(nsIWindowsRegKey::ROOT_KEY_CURRENT_USER,</span>
<a href="#l17.188"></a><span id="l17.188" class="difflineminus">-                   path,</span>
<a href="#l17.189"></a><span id="l17.189" class="difflineminus">-                   nsIWindowsRegKey::ACCESS_QUERY_VALUE);</span>
<a href="#l17.190"></a><span id="l17.190" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l17.191"></a><span id="l17.191" class="difflineminus">-      key-&gt;ReadStringValue(NS_LITERAL_STRING(&quot;Default Mail Account&quot;), aMailAccount);</span>
<a href="#l17.192"></a><span id="l17.192" class="difflineminus">-  }</span>
<a href="#l17.193"></a><span id="l17.193" class="difflineminus">-</span>
<a href="#l17.194"></a><span id="l17.194" class="difflineminus">-  if (!aMailAccount.IsEmpty())</span>
<a href="#l17.195"></a><span id="l17.195" class="difflineminus">-    return NS_OK;</span>
<a href="#l17.196"></a><span id="l17.196" class="difflineminus">-</span>
<a href="#l17.197"></a><span id="l17.197" class="difflineminus">-  // else it must be here in original install location from orig code</span>
<a href="#l17.198"></a><span id="l17.198" class="difflineminus">-  rv = key-&gt;Open(nsIWindowsRegKey::ROOT_KEY_CURRENT_USER,</span>
<a href="#l17.199"></a><span id="l17.199" class="difflineminus">-                 NS_LITERAL_STRING(&quot;Software\\Microsoft\\Outlook Express&quot;),</span>
<a href="#l17.200"></a><span id="l17.200" class="difflineminus">-                 nsIWindowsRegKey::ACCESS_QUERY_VALUE);</span>
<a href="#l17.201"></a><span id="l17.201" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l17.202"></a><span id="l17.202" class="difflineminus">-    return rv;</span>
<a href="#l17.203"></a><span id="l17.203" class="difflineminus">-</span>
<a href="#l17.204"></a><span id="l17.204" class="difflineminus">-  return key-&gt;ReadStringValue(NS_LITERAL_STRING(&quot;Default Mail Account&quot;), aMailAccount);</span>
<a href="#l17.205"></a><span id="l17.205" class="difflineminus">-}</span>
<a href="#l17.206"></a><span id="l17.206" class="difflineminus">-</span>
<a href="#l17.207"></a><span id="l17.207" class="difflineminus">-nsresult OESettings::GetCheckMailInterval(uint32_t *aInterval)</span>
<a href="#l17.208"></a><span id="l17.208" class="difflineminus">-{</span>
<a href="#l17.209"></a><span id="l17.209" class="difflineminus">-  nsCOMPtr&lt;nsIWindowsRegKey&gt; key;</span>
<a href="#l17.210"></a><span id="l17.210" class="difflineminus">-  // 'poll for messages' setting in OE is a global setting</span>
<a href="#l17.211"></a><span id="l17.211" class="difflineminus">-  // in OE options general tab and in following global OE</span>
<a href="#l17.212"></a><span id="l17.212" class="difflineminus">-  // registry location.</span>
<a href="#l17.213"></a><span id="l17.213" class="difflineminus">-  // for all accounts poll interval is a 32 bit value, 0 for</span>
<a href="#l17.214"></a><span id="l17.214" class="difflineminus">-  // &quot;don't poll&quot;, else milliseconds</span>
<a href="#l17.215"></a><span id="l17.215" class="difflineminus">-  nsresult rv = Find50Key(getter_AddRefs(key));</span>
<a href="#l17.216"></a><span id="l17.216" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l17.217"></a><span id="l17.217" class="difflineminus">-    rv = Find40Key(getter_AddRefs(key));</span>
<a href="#l17.218"></a><span id="l17.218" class="difflineminus">-</span>
<a href="#l17.219"></a><span id="l17.219" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l17.220"></a><span id="l17.220" class="difflineminus">-    return rv;</span>
<a href="#l17.221"></a><span id="l17.221" class="difflineminus">-</span>
<a href="#l17.222"></a><span id="l17.222" class="difflineminus">-  nsCOMPtr&lt;nsIWindowsRegKey&gt; subKey;</span>
<a href="#l17.223"></a><span id="l17.223" class="difflineminus">-  rv = key-&gt;OpenChild(NS_LITERAL_STRING(&quot;Mail&quot;),</span>
<a href="#l17.224"></a><span id="l17.224" class="difflineminus">-                      nsIWindowsRegKey::ACCESS_QUERY_VALUE,</span>
<a href="#l17.225"></a><span id="l17.225" class="difflineminus">-                      getter_AddRefs(subKey));</span>
<a href="#l17.226"></a><span id="l17.226" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l17.227"></a><span id="l17.227" class="difflineminus">-    return rv;</span>
<a href="#l17.228"></a><span id="l17.228" class="difflineminus">-</span>
<a href="#l17.229"></a><span id="l17.229" class="difflineminus">-  uint32_t intValue;</span>
<a href="#l17.230"></a><span id="l17.230" class="difflineminus">-  rv = subKey-&gt;ReadIntValue(NS_LITERAL_STRING(&quot;Poll For Mail&quot;), &amp;intValue);</span>
<a href="#l17.231"></a><span id="l17.231" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; intValue != PR_UINT32_MAX)</span>
<a href="#l17.232"></a><span id="l17.232" class="difflineminus">-    *aInterval = intValue / 60000;</span>
<a href="#l17.233"></a><span id="l17.233" class="difflineminus">-</span>
<a href="#l17.234"></a><span id="l17.234" class="difflineminus">-  return rv;</span>
<a href="#l17.235"></a><span id="l17.235" class="difflineminus">-}</span>
<a href="#l17.236"></a><span id="l17.236" class="difflineminus">-</span>
<a href="#l17.237"></a><span id="l17.237" class="difflineminus">-nsresult OESettings::FindAccountsKey(nsIWindowsRegKey **aKey)</span>
<a href="#l17.238"></a><span id="l17.238" class="difflineminus">-{</span>
<a href="#l17.239"></a><span id="l17.239" class="difflineminus">-  nsAutoString userId;</span>
<a href="#l17.240"></a><span id="l17.240" class="difflineminus">-  nsresult rv = nsOERegUtil::GetDefaultUserId(userId);</span>
<a href="#l17.241"></a><span id="l17.241" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l17.242"></a><span id="l17.242" class="difflineminus">-    return rv;</span>
<a href="#l17.243"></a><span id="l17.243" class="difflineminus">-</span>
<a href="#l17.244"></a><span id="l17.244" class="difflineminus">-  nsAutoString path(NS_LITERAL_STRING(&quot;Identities\\&quot;));</span>
<a href="#l17.245"></a><span id="l17.245" class="difflineminus">-  path.Append(userId);</span>
<a href="#l17.246"></a><span id="l17.246" class="difflineminus">-  path.AppendLiteral(&quot;\\Software\\Microsoft\\Internet Account Manager\\Accounts&quot;);</span>
<a href="#l17.247"></a><span id="l17.247" class="difflineminus">-</span>
<a href="#l17.248"></a><span id="l17.248" class="difflineminus">-  nsCOMPtr&lt;nsIWindowsRegKey&gt; key =</span>
<a href="#l17.249"></a><span id="l17.249" class="difflineminus">-    do_CreateInstance(&quot;@mozilla.org/windows-registry-key;1&quot;, &amp;rv);</span>
<a href="#l17.250"></a><span id="l17.250" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.251"></a><span id="l17.251" class="difflineminus">-</span>
<a href="#l17.252"></a><span id="l17.252" class="difflineminus">-  rv = key-&gt;Open(nsIWindowsRegKey::ROOT_KEY_CURRENT_USER,</span>
<a href="#l17.253"></a><span id="l17.253" class="difflineminus">-                 path,</span>
<a href="#l17.254"></a><span id="l17.254" class="difflineminus">-                 nsIWindowsRegKey::ACCESS_QUERY_VALUE |</span>
<a href="#l17.255"></a><span id="l17.255" class="difflineminus">-                 nsIWindowsRegKey::ACCESS_ENUMERATE_SUB_KEYS);</span>
<a href="#l17.256"></a><span id="l17.256" class="difflineminus">-  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l17.257"></a><span id="l17.257" class="difflineminus">-    NS_ADDREF(*aKey = key);</span>
<a href="#l17.258"></a><span id="l17.258" class="difflineminus">-    return rv;</span>
<a href="#l17.259"></a><span id="l17.259" class="difflineminus">-  }</span>
<a href="#l17.260"></a><span id="l17.260" class="difflineminus">-</span>
<a href="#l17.261"></a><span id="l17.261" class="difflineminus">-  rv = key-&gt;Open(nsIWindowsRegKey::ROOT_KEY_CURRENT_USER,</span>
<a href="#l17.262"></a><span id="l17.262" class="difflineminus">-                 NS_LITERAL_STRING(&quot;Software\\Microsoft\\Internet Account Manager\\Accounts&quot;),</span>
<a href="#l17.263"></a><span id="l17.263" class="difflineminus">-                 nsIWindowsRegKey::ACCESS_QUERY_VALUE |</span>
<a href="#l17.264"></a><span id="l17.264" class="difflineminus">-                 nsIWindowsRegKey::ACCESS_ENUMERATE_SUB_KEYS);</span>
<a href="#l17.265"></a><span id="l17.265" class="difflineminus">-  NS_IF_ADDREF(*aKey = key);</span>
<a href="#l17.266"></a><span id="l17.266" class="difflineminus">-  return rv;</span>
<a href="#l17.267"></a><span id="l17.267" class="difflineminus">-}</span>
<a href="#l17.268"></a><span id="l17.268" class="difflineminus">-</span>
<a href="#l17.269"></a><span id="l17.269" class="difflineminus">-nsresult OESettings::Find50Key(nsIWindowsRegKey **aKey)</span>
<a href="#l17.270"></a><span id="l17.270" class="difflineminus">-{</span>
<a href="#l17.271"></a><span id="l17.271" class="difflineminus">-  nsresult rv;</span>
<a href="#l17.272"></a><span id="l17.272" class="difflineminus">-  nsCOMPtr&lt;nsIWindowsRegKey&gt; key =</span>
<a href="#l17.273"></a><span id="l17.273" class="difflineminus">-    do_CreateInstance(&quot;@mozilla.org/windows-registry-key;1&quot;, &amp;rv);</span>
<a href="#l17.274"></a><span id="l17.274" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.275"></a><span id="l17.275" class="difflineminus">-</span>
<a href="#l17.276"></a><span id="l17.276" class="difflineminus">-  nsAutoString userId;</span>
<a href="#l17.277"></a><span id="l17.277" class="difflineminus">-  rv = nsOERegUtil::GetDefaultUserId(userId);</span>
<a href="#l17.278"></a><span id="l17.278" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l17.279"></a><span id="l17.279" class="difflineminus">-    return rv;</span>
<a href="#l17.280"></a><span id="l17.280" class="difflineminus">-</span>
<a href="#l17.281"></a><span id="l17.281" class="difflineminus">-  nsAutoString path(NS_LITERAL_STRING(&quot;Identities\\&quot;));</span>
<a href="#l17.282"></a><span id="l17.282" class="difflineminus">-  path.Append(userId);</span>
<a href="#l17.283"></a><span id="l17.283" class="difflineminus">-  path.AppendLiteral(&quot;\\Software\\Microsoft\\Outlook Express\\5.0&quot;);</span>
<a href="#l17.284"></a><span id="l17.284" class="difflineminus">-  rv = key-&gt;Open(nsIWindowsRegKey::ROOT_KEY_CURRENT_USER,</span>
<a href="#l17.285"></a><span id="l17.285" class="difflineminus">-                 path,</span>
<a href="#l17.286"></a><span id="l17.286" class="difflineminus">-                 nsIWindowsRegKey::ACCESS_QUERY_VALUE);</span>
<a href="#l17.287"></a><span id="l17.287" class="difflineminus">-  NS_IF_ADDREF(*aKey = key);</span>
<a href="#l17.288"></a><span id="l17.288" class="difflineminus">-</span>
<a href="#l17.289"></a><span id="l17.289" class="difflineminus">-  return rv;</span>
<a href="#l17.290"></a><span id="l17.290" class="difflineminus">-}</span>
<a href="#l17.291"></a><span id="l17.291" class="difflineminus">-</span>
<a href="#l17.292"></a><span id="l17.292" class="difflineminus">-nsresult OESettings::Find40Key(nsIWindowsRegKey **aKey)</span>
<a href="#l17.293"></a><span id="l17.293" class="difflineminus">-{</span>
<a href="#l17.294"></a><span id="l17.294" class="difflineminus">-  nsresult rv;</span>
<a href="#l17.295"></a><span id="l17.295" class="difflineminus">-  nsCOMPtr&lt;nsIWindowsRegKey&gt; key =</span>
<a href="#l17.296"></a><span id="l17.296" class="difflineminus">-    do_CreateInstance(&quot;@mozilla.org/windows-registry-key;1&quot;, &amp;rv);</span>
<a href="#l17.297"></a><span id="l17.297" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.298"></a><span id="l17.298" class="difflineminus">-</span>
<a href="#l17.299"></a><span id="l17.299" class="difflineminus">-  rv = key-&gt;Open(nsIWindowsRegKey::ROOT_KEY_CURRENT_USER,</span>
<a href="#l17.300"></a><span id="l17.300" class="difflineminus">-                 NS_LITERAL_STRING(&quot;Software\\Microsoft\\Outlook Express&quot;),</span>
<a href="#l17.301"></a><span id="l17.301" class="difflineminus">-                 nsIWindowsRegKey::ACCESS_QUERY_VALUE);</span>
<a href="#l17.302"></a><span id="l17.302" class="difflineminus">-  NS_IF_ADDREF(*aKey = key);</span>
<a href="#l17.303"></a><span id="l17.303" class="difflineminus">-</span>
<a href="#l17.304"></a><span id="l17.304" class="difflineminus">-  return rv;</span>
<a href="#l17.305"></a><span id="l17.305" class="difflineminus">-}</span>
<a href="#l17.306"></a><span id="l17.306" class="difflineminus">-</span>
<a href="#l17.307"></a><span id="l17.307" class="difflineminus">-bool OESettings::DoImport(nsIMsgAccount **aAccount)</span>
<a href="#l17.308"></a><span id="l17.308" class="difflineminus">-{</span>
<a href="#l17.309"></a><span id="l17.309" class="difflineminus">-  nsCOMPtr&lt;nsIWindowsRegKey&gt; key;</span>
<a href="#l17.310"></a><span id="l17.310" class="difflineminus">-  nsresult rv = FindAccountsKey(getter_AddRefs(key));</span>
<a href="#l17.311"></a><span id="l17.311" class="difflineminus">-  if (NS_FAILED(rv)) {</span>
<a href="#l17.312"></a><span id="l17.312" class="difflineminus">-    IMPORT_LOG0( &quot;*** Error finding Outlook Express registry account keys\n&quot;);</span>
<a href="#l17.313"></a><span id="l17.313" class="difflineminus">-    return false;</span>
<a href="#l17.314"></a><span id="l17.314" class="difflineminus">-  }</span>
<a href="#l17.315"></a><span id="l17.315" class="difflineminus">-</span>
<a href="#l17.316"></a><span id="l17.316" class="difflineminus">-  nsCOMPtr&lt;nsIMsgAccountManager&gt; accMgr =</span>
<a href="#l17.317"></a><span id="l17.317" class="difflineminus">-           do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l17.318"></a><span id="l17.318" class="difflineminus">-  if (NS_FAILED(rv)) {</span>
<a href="#l17.319"></a><span id="l17.319" class="difflineminus">-    IMPORT_LOG0(&quot;*** Failed to create a account manager!\n&quot;);</span>
<a href="#l17.320"></a><span id="l17.320" class="difflineminus">-    return false;</span>
<a href="#l17.321"></a><span id="l17.321" class="difflineminus">-  }</span>
<a href="#l17.322"></a><span id="l17.322" class="difflineminus">-</span>
<a href="#l17.323"></a><span id="l17.323" class="difflineminus">-  nsAutoString defMailName;</span>
<a href="#l17.324"></a><span id="l17.324" class="difflineminus">-  rv = GetDefaultMailAccount(defMailName);</span>
<a href="#l17.325"></a><span id="l17.325" class="difflineminus">-</span>
<a href="#l17.326"></a><span id="l17.326" class="difflineminus">-  checkNewMail = false;</span>
<a href="#l17.327"></a><span id="l17.327" class="difflineminus">-  checkNewMailTime = 30;</span>
<a href="#l17.328"></a><span id="l17.328" class="difflineminus">-  rv = GetCheckMailInterval(&amp;checkNewMailTime);</span>
<a href="#l17.329"></a><span id="l17.329" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l17.330"></a><span id="l17.330" class="difflineminus">-    checkNewMail = true;</span>
<a href="#l17.331"></a><span id="l17.331" class="difflineminus">-</span>
<a href="#l17.332"></a><span id="l17.332" class="difflineminus">-  // Iterate the accounts looking for POP3 &amp; IMAP accounts...</span>
<a href="#l17.333"></a><span id="l17.333" class="difflineminus">-  // Ignore LDAP for now!</span>
<a href="#l17.334"></a><span id="l17.334" class="difflineminus">-  uint32_t accounts = 0;</span>
<a href="#l17.335"></a><span id="l17.335" class="difflineminus">-  nsAutoString keyComp;</span>
<a href="#l17.336"></a><span id="l17.336" class="difflineminus">-  uint32_t childCount = 0;</span>
<a href="#l17.337"></a><span id="l17.337" class="difflineminus">-  key-&gt;GetChildCount(&amp;childCount);</span>
<a href="#l17.338"></a><span id="l17.338" class="difflineminus">-  for (uint32_t i = 0; i &lt; childCount; i++) {</span>
<a href="#l17.339"></a><span id="l17.339" class="difflineminus">-    nsAutoString keyName;</span>
<a href="#l17.340"></a><span id="l17.340" class="difflineminus">-    key-&gt;GetChildName(i, keyName);</span>
<a href="#l17.341"></a><span id="l17.341" class="difflineminus">-</span>
<a href="#l17.342"></a><span id="l17.342" class="difflineminus">-    nsCOMPtr&lt;nsIWindowsRegKey&gt; subKey;</span>
<a href="#l17.343"></a><span id="l17.343" class="difflineminus">-    rv = key-&gt;OpenChild(keyName,</span>
<a href="#l17.344"></a><span id="l17.344" class="difflineminus">-                        nsIWindowsRegKey::ACCESS_QUERY_VALUE,</span>
<a href="#l17.345"></a><span id="l17.345" class="difflineminus">-                        getter_AddRefs(subKey));</span>
<a href="#l17.346"></a><span id="l17.346" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l17.347"></a><span id="l17.347" class="difflineminus">-      continue;</span>
<a href="#l17.348"></a><span id="l17.348" class="difflineminus">-</span>
<a href="#l17.349"></a><span id="l17.349" class="difflineminus">-    nsAutoCString nativeKeyName;</span>
<a href="#l17.350"></a><span id="l17.350" class="difflineminus">-    NS_CopyUnicodeToNative(keyName, nativeKeyName);</span>
<a href="#l17.351"></a><span id="l17.351" class="difflineminus">-    IMPORT_LOG1(&quot;Opened Outlook Express account: %s\n&quot;,</span>
<a href="#l17.352"></a><span id="l17.352" class="difflineminus">-                nativeKeyName.get());</span>
<a href="#l17.353"></a><span id="l17.353" class="difflineminus">-</span>
<a href="#l17.354"></a><span id="l17.354" class="difflineminus">-    nsIMsgAccount  *anAccount = nullptr;</span>
<a href="#l17.355"></a><span id="l17.355" class="difflineminus">-    nsAutoString value;</span>
<a href="#l17.356"></a><span id="l17.356" class="difflineminus">-    rv = subKey-&gt;ReadStringValue(NS_LITERAL_STRING(&quot;IMAP Server&quot;), value);</span>
<a href="#l17.357"></a><span id="l17.357" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; DoIMAPServer(accMgr, subKey, value, &amp;anAccount))</span>
<a href="#l17.358"></a><span id="l17.358" class="difflineminus">-      accounts++;</span>
<a href="#l17.359"></a><span id="l17.359" class="difflineminus">-</span>
<a href="#l17.360"></a><span id="l17.360" class="difflineminus">-    rv = subKey-&gt;ReadStringValue(NS_LITERAL_STRING(&quot;NNTP Server&quot;), value);</span>
<a href="#l17.361"></a><span id="l17.361" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; DoNNTPServer(accMgr, subKey, value, &amp;anAccount))</span>
<a href="#l17.362"></a><span id="l17.362" class="difflineminus">-      accounts++;</span>
<a href="#l17.363"></a><span id="l17.363" class="difflineminus">-</span>
<a href="#l17.364"></a><span id="l17.364" class="difflineminus">-    rv = subKey-&gt;ReadStringValue(NS_LITERAL_STRING(&quot;POP3 Server&quot;), value);</span>
<a href="#l17.365"></a><span id="l17.365" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; DoPOP3Server(accMgr, subKey, value, &amp;anAccount))</span>
<a href="#l17.366"></a><span id="l17.366" class="difflineminus">-      accounts++;</span>
<a href="#l17.367"></a><span id="l17.367" class="difflineminus">-</span>
<a href="#l17.368"></a><span id="l17.368" class="difflineminus">-    if (anAccount) {</span>
<a href="#l17.369"></a><span id="l17.369" class="difflineminus">-      // Is this the default account?</span>
<a href="#l17.370"></a><span id="l17.370" class="difflineminus">-      keyComp = keyName;</span>
<a href="#l17.371"></a><span id="l17.371" class="difflineminus">-      if (keyComp.Equals(defMailName))</span>
<a href="#l17.372"></a><span id="l17.372" class="difflineminus">-        accMgr-&gt;SetDefaultAccount(anAccount);</span>
<a href="#l17.373"></a><span id="l17.373" class="difflineminus">-      NS_RELEASE(anAccount);</span>
<a href="#l17.374"></a><span id="l17.374" class="difflineminus">-    }</span>
<a href="#l17.375"></a><span id="l17.375" class="difflineminus">-  }</span>
<a href="#l17.376"></a><span id="l17.376" class="difflineminus">-</span>
<a href="#l17.377"></a><span id="l17.377" class="difflineminus">-  // Now save the new acct info to pref file.</span>
<a href="#l17.378"></a><span id="l17.378" class="difflineminus">-  rv = accMgr-&gt;SaveAccountInfo();</span>
<a href="#l17.379"></a><span id="l17.379" class="difflineminus">-  NS_ASSERTION(NS_SUCCEEDED(rv), &quot;Can't save account info to pref file&quot;);</span>
<a href="#l17.380"></a><span id="l17.380" class="difflineminus">-</span>
<a href="#l17.381"></a><span id="l17.381" class="difflineminus">-  return accounts != 0;</span>
<a href="#l17.382"></a><span id="l17.382" class="difflineminus">-}</span>
<a href="#l17.383"></a><span id="l17.383" class="difflineminus">-</span>
<a href="#l17.384"></a><span id="l17.384" class="difflineminus">-nsresult OESettings::GetAccountName(nsIWindowsRegKey *aKey,</span>
<a href="#l17.385"></a><span id="l17.385" class="difflineminus">-                                    const nsString &amp;aDefaultName,</span>
<a href="#l17.386"></a><span id="l17.386" class="difflineminus">-                                    nsAString &amp;aAccountName)</span>
<a href="#l17.387"></a><span id="l17.387" class="difflineminus">-{</span>
<a href="#l17.388"></a><span id="l17.388" class="difflineminus">-  nsresult rv;</span>
<a href="#l17.389"></a><span id="l17.389" class="difflineminus">-  rv = aKey-&gt;ReadStringValue(NS_LITERAL_STRING(&quot;Account Name&quot;), aAccountName);</span>
<a href="#l17.390"></a><span id="l17.390" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l17.391"></a><span id="l17.391" class="difflineminus">-    aAccountName.Assign(aDefaultName);</span>
<a href="#l17.392"></a><span id="l17.392" class="difflineminus">-</span>
<a href="#l17.393"></a><span id="l17.393" class="difflineminus">-  return NS_OK;</span>
<a href="#l17.394"></a><span id="l17.394" class="difflineminus">-}</span>
<a href="#l17.395"></a><span id="l17.395" class="difflineminus">-</span>
<a href="#l17.396"></a><span id="l17.396" class="difflineminus">-bool OESettings::DoIMAPServer(nsIMsgAccountManager *aMgr,</span>
<a href="#l17.397"></a><span id="l17.397" class="difflineminus">-                              nsIWindowsRegKey *aKey,</span>
<a href="#l17.398"></a><span id="l17.398" class="difflineminus">-                              const nsString &amp;aServerName,</span>
<a href="#l17.399"></a><span id="l17.399" class="difflineminus">-                              nsIMsgAccount **ppAccount)</span>
<a href="#l17.400"></a><span id="l17.400" class="difflineminus">-{</span>
<a href="#l17.401"></a><span id="l17.401" class="difflineminus">-  if (ppAccount)</span>
<a href="#l17.402"></a><span id="l17.402" class="difflineminus">-    *ppAccount = nullptr;</span>
<a href="#l17.403"></a><span id="l17.403" class="difflineminus">-</span>
<a href="#l17.404"></a><span id="l17.404" class="difflineminus">-  nsAutoString userName;</span>
<a href="#l17.405"></a><span id="l17.405" class="difflineminus">-  nsresult rv;</span>
<a href="#l17.406"></a><span id="l17.406" class="difflineminus">-  rv = aKey-&gt;ReadStringValue(NS_LITERAL_STRING(&quot;IMAP User Name&quot;), userName);</span>
<a href="#l17.407"></a><span id="l17.407" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l17.408"></a><span id="l17.408" class="difflineminus">-    return false;</span>
<a href="#l17.409"></a><span id="l17.409" class="difflineminus">-</span>
<a href="#l17.410"></a><span id="l17.410" class="difflineminus">-  nsAutoCString nativeUserName;</span>
<a href="#l17.411"></a><span id="l17.411" class="difflineminus">-  NS_CopyUnicodeToNative(userName, nativeUserName);</span>
<a href="#l17.412"></a><span id="l17.412" class="difflineminus">-  nsAutoCString nativeServerName;</span>
<a href="#l17.413"></a><span id="l17.413" class="difflineminus">-  NS_CopyUnicodeToNative(aServerName, nativeServerName);</span>
<a href="#l17.414"></a><span id="l17.414" class="difflineminus">-  // I now have a user name/server name pair, find out if it already exists?</span>
<a href="#l17.415"></a><span id="l17.415" class="difflineminus">-  nsCOMPtr&lt;nsIMsgIncomingServer&gt; in;</span>
<a href="#l17.416"></a><span id="l17.416" class="difflineminus">-  rv = aMgr-&gt;FindServer(nativeUserName,</span>
<a href="#l17.417"></a><span id="l17.417" class="difflineminus">-                        nativeServerName,</span>
<a href="#l17.418"></a><span id="l17.418" class="difflineminus">-                        NS_LITERAL_CSTRING(&quot;imap&quot;),</span>
<a href="#l17.419"></a><span id="l17.419" class="difflineminus">-                        getter_AddRefs(in));</span>
<a href="#l17.420"></a><span id="l17.420" class="difflineminus">-  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l17.421"></a><span id="l17.421" class="difflineminus">-    // for an existing server we create another identity,</span>
<a href="#l17.422"></a><span id="l17.422" class="difflineminus">-    //  TB lists under 'manage identities'</span>
<a href="#l17.423"></a><span id="l17.423" class="difflineminus">-    nsCOMPtr&lt;nsIMsgAccount&gt; account;</span>
<a href="#l17.424"></a><span id="l17.424" class="difflineminus">-    rv = aMgr-&gt;FindAccountForServer(in, getter_AddRefs(account));</span>
<a href="#l17.425"></a><span id="l17.425" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l17.426"></a><span id="l17.426" class="difflineminus">-      return false;</span>
<a href="#l17.427"></a><span id="l17.427" class="difflineminus">-</span>
<a href="#l17.428"></a><span id="l17.428" class="difflineminus">-    IMPORT_LOG0(&quot;Created an identity and added to existing IMAP incoming server\n&quot;);</span>
<a href="#l17.429"></a><span id="l17.429" class="difflineminus">-    // Fiddle with the identities</span>
<a href="#l17.430"></a><span id="l17.430" class="difflineminus">-    int32_t authMethod;</span>
<a href="#l17.431"></a><span id="l17.431" class="difflineminus">-    in-&gt;GetAuthMethod(&amp;authMethod);</span>
<a href="#l17.432"></a><span id="l17.432" class="difflineminus">-    SetIdentities(aMgr, account, aKey, userName, authMethod, false);</span>
<a href="#l17.433"></a><span id="l17.433" class="difflineminus">-    if (ppAccount)</span>
<a href="#l17.434"></a><span id="l17.434" class="difflineminus">-      account-&gt;QueryInterface(NS_GET_IID(nsIMsgAccount),</span>
<a href="#l17.435"></a><span id="l17.435" class="difflineminus">-                              (void **)ppAccount);</span>
<a href="#l17.436"></a><span id="l17.436" class="difflineminus">-    return true;</span>
<a href="#l17.437"></a><span id="l17.437" class="difflineminus">-  }</span>
<a href="#l17.438"></a><span id="l17.438" class="difflineminus">-</span>
<a href="#l17.439"></a><span id="l17.439" class="difflineminus">-  // Create the incoming server and an account for it?</span>
<a href="#l17.440"></a><span id="l17.440" class="difflineminus">-  rv = aMgr-&gt;CreateIncomingServer(nativeUserName,</span>
<a href="#l17.441"></a><span id="l17.441" class="difflineminus">-                                  nativeServerName,</span>
<a href="#l17.442"></a><span id="l17.442" class="difflineminus">-                                  NS_LITERAL_CSTRING(&quot;imap&quot;),</span>
<a href="#l17.443"></a><span id="l17.443" class="difflineminus">-                                  getter_AddRefs(in));</span>
<a href="#l17.444"></a><span id="l17.444" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l17.445"></a><span id="l17.445" class="difflineminus">-</span>
<a href="#l17.446"></a><span id="l17.446" class="difflineminus">-  nsAutoString rootFolder;</span>
<a href="#l17.447"></a><span id="l17.447" class="difflineminus">-  rv = aKey-&gt;ReadStringValue(NS_LITERAL_STRING(&quot;IMAP Root Folder&quot;), rootFolder);</span>
<a href="#l17.448"></a><span id="l17.448" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; !rootFolder.IsEmpty()) {</span>
<a href="#l17.449"></a><span id="l17.449" class="difflineminus">-    nsCOMPtr&lt;nsIImapIncomingServer&gt; imapServer = do_QueryInterface(in);</span>
<a href="#l17.450"></a><span id="l17.450" class="difflineminus">-    nsAutoCString nativeRootFolder;</span>
<a href="#l17.451"></a><span id="l17.451" class="difflineminus">-    NS_CopyUnicodeToNative(rootFolder, nativeRootFolder);</span>
<a href="#l17.452"></a><span id="l17.452" class="difflineminus">-    imapServer-&gt;SetServerDirectory(nativeRootFolder);</span>
<a href="#l17.453"></a><span id="l17.453" class="difflineminus">-  }</span>
<a href="#l17.454"></a><span id="l17.454" class="difflineminus">-</span>
<a href="#l17.455"></a><span id="l17.455" class="difflineminus">-  SetIncomingServerProperties(in, aKey, NS_LITERAL_STRING(&quot;IMAP &quot;));</span>
<a href="#l17.456"></a><span id="l17.456" class="difflineminus">-</span>
<a href="#l17.457"></a><span id="l17.457" class="difflineminus">-  IMPORT_LOG2(&quot;Created IMAP server named: %s, userName: %s\n&quot;,</span>
<a href="#l17.458"></a><span id="l17.458" class="difflineminus">-              nativeServerName.get(), nativeUserName.get());</span>
<a href="#l17.459"></a><span id="l17.459" class="difflineminus">-</span>
<a href="#l17.460"></a><span id="l17.460" class="difflineminus">-  nsAutoString prettyName;</span>
<a href="#l17.461"></a><span id="l17.461" class="difflineminus">-  if (NS_SUCCEEDED(GetAccountName(aKey, aServerName, prettyName)))</span>
<a href="#l17.462"></a><span id="l17.462" class="difflineminus">-    rv = in-&gt;SetPrettyName(prettyName);</span>
<a href="#l17.463"></a><span id="l17.463" class="difflineminus">-</span>
<a href="#l17.464"></a><span id="l17.464" class="difflineminus">-  // We have a server, create an account.</span>
<a href="#l17.465"></a><span id="l17.465" class="difflineminus">-  nsCOMPtr&lt;nsIMsgAccount&gt; account;</span>
<a href="#l17.466"></a><span id="l17.466" class="difflineminus">-  rv = aMgr-&gt;CreateAccount(getter_AddRefs(account));</span>
<a href="#l17.467"></a><span id="l17.467" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; account) {</span>
<a href="#l17.468"></a><span id="l17.468" class="difflineminus">-    rv = account-&gt;SetIncomingServer(in);</span>
<a href="#l17.469"></a><span id="l17.469" class="difflineminus">-</span>
<a href="#l17.470"></a><span id="l17.470" class="difflineminus">-    IMPORT_LOG0(&quot;Created an account and set the IMAP server as the incoming server\n&quot;);</span>
<a href="#l17.471"></a><span id="l17.471" class="difflineminus">-</span>
<a href="#l17.472"></a><span id="l17.472" class="difflineminus">-    // Fiddle with the identities</span>
<a href="#l17.473"></a><span id="l17.473" class="difflineminus">-    int32_t authMethod;</span>
<a href="#l17.474"></a><span id="l17.474" class="difflineminus">-    in-&gt;GetAuthMethod(&amp;authMethod);</span>
<a href="#l17.475"></a><span id="l17.475" class="difflineminus">-    SetIdentities(aMgr, account, aKey, userName, authMethod, false);</span>
<a href="#l17.476"></a><span id="l17.476" class="difflineminus">-    if (ppAccount)</span>
<a href="#l17.477"></a><span id="l17.477" class="difflineminus">-      account-&gt;QueryInterface(NS_GET_IID(nsIMsgAccount), (void **)ppAccount);</span>
<a href="#l17.478"></a><span id="l17.478" class="difflineminus">-    return true;</span>
<a href="#l17.479"></a><span id="l17.479" class="difflineminus">-  }</span>
<a href="#l17.480"></a><span id="l17.480" class="difflineminus">-</span>
<a href="#l17.481"></a><span id="l17.481" class="difflineminus">-  return false;</span>
<a href="#l17.482"></a><span id="l17.482" class="difflineminus">-}</span>
<a href="#l17.483"></a><span id="l17.483" class="difflineminus">-</span>
<a href="#l17.484"></a><span id="l17.484" class="difflineminus">-bool OESettings::DoPOP3Server(nsIMsgAccountManager *aMgr,</span>
<a href="#l17.485"></a><span id="l17.485" class="difflineminus">-                              nsIWindowsRegKey *aKey,</span>
<a href="#l17.486"></a><span id="l17.486" class="difflineminus">-                              const nsString &amp;aServerName,</span>
<a href="#l17.487"></a><span id="l17.487" class="difflineminus">-                              nsIMsgAccount **ppAccount)</span>
<a href="#l17.488"></a><span id="l17.488" class="difflineminus">-{</span>
<a href="#l17.489"></a><span id="l17.489" class="difflineminus">-  if (ppAccount)</span>
<a href="#l17.490"></a><span id="l17.490" class="difflineminus">-    *ppAccount = nullptr;</span>
<a href="#l17.491"></a><span id="l17.491" class="difflineminus">-</span>
<a href="#l17.492"></a><span id="l17.492" class="difflineminus">-  nsAutoString userName;</span>
<a href="#l17.493"></a><span id="l17.493" class="difflineminus">-  nsresult rv;</span>
<a href="#l17.494"></a><span id="l17.494" class="difflineminus">-  rv = aKey-&gt;ReadStringValue(NS_LITERAL_STRING(&quot;POP3 User Name&quot;), userName);</span>
<a href="#l17.495"></a><span id="l17.495" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l17.496"></a><span id="l17.496" class="difflineminus">-    return false;</span>
<a href="#l17.497"></a><span id="l17.497" class="difflineminus">-</span>
<a href="#l17.498"></a><span id="l17.498" class="difflineminus">-  nsAutoCString nativeUserName;</span>
<a href="#l17.499"></a><span id="l17.499" class="difflineminus">-  NS_CopyUnicodeToNative(userName, nativeUserName);</span>
<a href="#l17.500"></a><span id="l17.500" class="difflineminus">-  nsAutoCString nativeServerName;</span>
<a href="#l17.501"></a><span id="l17.501" class="difflineminus">-  NS_CopyUnicodeToNative(aServerName, nativeServerName);</span>
<a href="#l17.502"></a><span id="l17.502" class="difflineminus">-</span>
<a href="#l17.503"></a><span id="l17.503" class="difflineminus">-  // I now have a user name/server name pair, find out if it already exists?</span>
<a href="#l17.504"></a><span id="l17.504" class="difflineminus">-  nsCOMPtr&lt;nsIMsgIncomingServer&gt; in;</span>
<a href="#l17.505"></a><span id="l17.505" class="difflineminus">-  rv = aMgr-&gt;FindServer(nativeUserName,</span>
<a href="#l17.506"></a><span id="l17.506" class="difflineminus">-                        nativeServerName,</span>
<a href="#l17.507"></a><span id="l17.507" class="difflineminus">-                        NS_LITERAL_CSTRING(&quot;pop3&quot;),</span>
<a href="#l17.508"></a><span id="l17.508" class="difflineminus">-                        getter_AddRefs(in));</span>
<a href="#l17.509"></a><span id="l17.509" class="difflineminus">-  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l17.510"></a><span id="l17.510" class="difflineminus">-    IMPORT_LOG2(&quot;Existing POP3 server named: %s, userName: %s\n&quot;,</span>
<a href="#l17.511"></a><span id="l17.511" class="difflineminus">-                nativeUserName.get(), nativeServerName.get());</span>
<a href="#l17.512"></a><span id="l17.512" class="difflineminus">-    // for an existing server we create another identity,</span>
<a href="#l17.513"></a><span id="l17.513" class="difflineminus">-    // TB listed under 'manage identities'</span>
<a href="#l17.514"></a><span id="l17.514" class="difflineminus">-    nsCOMPtr&lt;nsIMsgAccount&gt;  account;</span>
<a href="#l17.515"></a><span id="l17.515" class="difflineminus">-    rv = aMgr-&gt;FindAccountForServer(in, getter_AddRefs(account));</span>
<a href="#l17.516"></a><span id="l17.516" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; account) {</span>
<a href="#l17.517"></a><span id="l17.517" class="difflineminus">-      IMPORT_LOG0(&quot;Created identity and added to existing POP3 incoming server.\n&quot;);</span>
<a href="#l17.518"></a><span id="l17.518" class="difflineminus">-      // Fiddle with the identities</span>
<a href="#l17.519"></a><span id="l17.519" class="difflineminus">-      int32_t authMethod;</span>
<a href="#l17.520"></a><span id="l17.520" class="difflineminus">-      in-&gt;GetAuthMethod(&amp;authMethod);</span>
<a href="#l17.521"></a><span id="l17.521" class="difflineminus">-      SetIdentities(aMgr, account, aKey, userName, authMethod, false);</span>
<a href="#l17.522"></a><span id="l17.522" class="difflineminus">-      if (ppAccount)</span>
<a href="#l17.523"></a><span id="l17.523" class="difflineminus">-        account-&gt;QueryInterface(NS_GET_IID(nsIMsgAccount), (void **)ppAccount);</span>
<a href="#l17.524"></a><span id="l17.524" class="difflineminus">-      return true;</span>
<a href="#l17.525"></a><span id="l17.525" class="difflineminus">-    }</span>
<a href="#l17.526"></a><span id="l17.526" class="difflineminus">-    return false;</span>
<a href="#l17.527"></a><span id="l17.527" class="difflineminus">-  }</span>
<a href="#l17.528"></a><span id="l17.528" class="difflineminus">-</span>
<a href="#l17.529"></a><span id="l17.529" class="difflineminus">-  // Create the incoming server and an account for it?</span>
<a href="#l17.530"></a><span id="l17.530" class="difflineminus">-  rv = aMgr-&gt;CreateIncomingServer(nativeUserName,</span>
<a href="#l17.531"></a><span id="l17.531" class="difflineminus">-                                  nativeServerName,</span>
<a href="#l17.532"></a><span id="l17.532" class="difflineminus">-                                  NS_LITERAL_CSTRING(&quot;pop3&quot;),</span>
<a href="#l17.533"></a><span id="l17.533" class="difflineminus">-                                  getter_AddRefs( in));</span>
<a href="#l17.534"></a><span id="l17.534" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l17.535"></a><span id="l17.535" class="difflineminus">-    return false;</span>
<a href="#l17.536"></a><span id="l17.536" class="difflineminus">-</span>
<a href="#l17.537"></a><span id="l17.537" class="difflineminus">-  SetIncomingServerProperties(in, aKey, NS_LITERAL_STRING(&quot;POP3 &quot;));</span>
<a href="#l17.538"></a><span id="l17.538" class="difflineminus">-</span>
<a href="#l17.539"></a><span id="l17.539" class="difflineminus">-  nsCOMPtr&lt;nsIPop3IncomingServer&gt; pop3Server = do_QueryInterface(in);</span>
<a href="#l17.540"></a><span id="l17.540" class="difflineminus">-  if (pop3Server) {</span>
<a href="#l17.541"></a><span id="l17.541" class="difflineminus">-    // set local folders as the Inbox to use for this POP3 server</span>
<a href="#l17.542"></a><span id="l17.542" class="difflineminus">-    nsCOMPtr&lt;nsIMsgIncomingServer&gt; localFoldersServer;</span>
<a href="#l17.543"></a><span id="l17.543" class="difflineminus">-    aMgr-&gt;GetLocalFoldersServer(getter_AddRefs(localFoldersServer));</span>
<a href="#l17.544"></a><span id="l17.544" class="difflineminus">-</span>
<a href="#l17.545"></a><span id="l17.545" class="difflineminus">-    if (!localFoldersServer)</span>
<a href="#l17.546"></a><span id="l17.546" class="difflineminus">-    {</span>
<a href="#l17.547"></a><span id="l17.547" class="difflineminus">-      // If Local Folders does not exist already, create it</span>
<a href="#l17.548"></a><span id="l17.548" class="difflineminus">-</span>
<a href="#l17.549"></a><span id="l17.549" class="difflineminus">-      if (NS_FAILED(aMgr-&gt;CreateLocalMailAccount())) {</span>
<a href="#l17.550"></a><span id="l17.550" class="difflineminus">-        IMPORT_LOG0(&quot;*** Failed to create Local Folders!\n&quot;);</span>
<a href="#l17.551"></a><span id="l17.551" class="difflineminus">-        return false;</span>
<a href="#l17.552"></a><span id="l17.552" class="difflineminus">-      }</span>
<a href="#l17.553"></a><span id="l17.553" class="difflineminus">-</span>
<a href="#l17.554"></a><span id="l17.554" class="difflineminus">-      aMgr-&gt;GetLocalFoldersServer(getter_AddRefs(localFoldersServer));</span>
<a href="#l17.555"></a><span id="l17.555" class="difflineminus">-    }</span>
<a href="#l17.556"></a><span id="l17.556" class="difflineminus">-</span>
<a href="#l17.557"></a><span id="l17.557" class="difflineminus">-    // now get the account for this server</span>
<a href="#l17.558"></a><span id="l17.558" class="difflineminus">-    nsCOMPtr&lt;nsIMsgAccount&gt; localFoldersAccount;</span>
<a href="#l17.559"></a><span id="l17.559" class="difflineminus">-    aMgr-&gt;FindAccountForServer(localFoldersServer, getter_AddRefs(localFoldersAccount));</span>
<a href="#l17.560"></a><span id="l17.560" class="difflineminus">-    if (localFoldersAccount)</span>
<a href="#l17.561"></a><span id="l17.561" class="difflineminus">-    {</span>
<a href="#l17.562"></a><span id="l17.562" class="difflineminus">-      nsCString localFoldersAcctKey;</span>
<a href="#l17.563"></a><span id="l17.563" class="difflineminus">-      localFoldersAccount-&gt;GetKey(localFoldersAcctKey);</span>
<a href="#l17.564"></a><span id="l17.564" class="difflineminus">-      pop3Server-&gt;SetDeferredToAccount(localFoldersAcctKey);</span>
<a href="#l17.565"></a><span id="l17.565" class="difflineminus">-    }</span>
<a href="#l17.566"></a><span id="l17.566" class="difflineminus">-</span>
<a href="#l17.567"></a><span id="l17.567" class="difflineminus">-    uint32_t intValue;</span>
<a href="#l17.568"></a><span id="l17.568" class="difflineminus">-    rv = aKey-&gt;ReadIntValue(NS_LITERAL_STRING(&quot;POP3 Skip Account&quot;), &amp;intValue);</span>
<a href="#l17.569"></a><span id="l17.569" class="difflineminus">-    // OE:0=='Include this account when receiving mail or synchronizing'==</span>
<a href="#l17.570"></a><span id="l17.570" class="difflineminus">-    // TB:1==AM:Server:advanced:Include this server when getting new mail</span>
<a href="#l17.571"></a><span id="l17.571" class="difflineminus">-    pop3Server-&gt;SetDeferGetNewMail(NS_SUCCEEDED(rv) &amp;&amp; intValue == 0);</span>
<a href="#l17.572"></a><span id="l17.572" class="difflineminus">-</span>
<a href="#l17.573"></a><span id="l17.573" class="difflineminus">-    rv = aKey-&gt;ReadIntValue(NS_LITERAL_STRING(&quot;Leave Mail On Server&quot;),</span>
<a href="#l17.574"></a><span id="l17.574" class="difflineminus">-                            &amp;intValue);</span>
<a href="#l17.575"></a><span id="l17.575" class="difflineminus">-    pop3Server-&gt;SetLeaveMessagesOnServer(NS_SUCCEEDED(rv) &amp;&amp; intValue == 1);</span>
<a href="#l17.576"></a><span id="l17.576" class="difflineminus">-</span>
<a href="#l17.577"></a><span id="l17.577" class="difflineminus">-    rv = aKey-&gt;ReadIntValue(NS_LITERAL_STRING(&quot;Remove When Deleted&quot;),</span>
<a href="#l17.578"></a><span id="l17.578" class="difflineminus">-                            &amp;intValue);</span>
<a href="#l17.579"></a><span id="l17.579" class="difflineminus">-    pop3Server-&gt;SetDeleteMailLeftOnServer(NS_SUCCEEDED(rv) &amp;&amp; intValue == 1);</span>
<a href="#l17.580"></a><span id="l17.580" class="difflineminus">-</span>
<a href="#l17.581"></a><span id="l17.581" class="difflineminus">-    rv = aKey-&gt;ReadIntValue(NS_LITERAL_STRING(&quot;Remove When Expired&quot;),</span>
<a href="#l17.582"></a><span id="l17.582" class="difflineminus">-                            &amp;intValue);</span>
<a href="#l17.583"></a><span id="l17.583" class="difflineminus">-    pop3Server-&gt;SetDeleteByAgeFromServer(NS_SUCCEEDED(rv) &amp;&amp; intValue == 1);</span>
<a href="#l17.584"></a><span id="l17.584" class="difflineminus">-</span>
<a href="#l17.585"></a><span id="l17.585" class="difflineminus">-    rv = aKey-&gt;ReadIntValue(NS_LITERAL_STRING(&quot;Expire Days&quot;),</span>
<a href="#l17.586"></a><span id="l17.586" class="difflineminus">-                            &amp;intValue);</span>
<a href="#l17.587"></a><span id="l17.587" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l17.588"></a><span id="l17.588" class="difflineminus">-      pop3Server-&gt;SetNumDaysToLeaveOnServer(static_cast&lt;int32_t&gt;(intValue));</span>
<a href="#l17.589"></a><span id="l17.589" class="difflineminus">-  }</span>
<a href="#l17.590"></a><span id="l17.590" class="difflineminus">-  IMPORT_LOG2(&quot;Created POP3 server named: %s, userName: %s\n&quot;,</span>
<a href="#l17.591"></a><span id="l17.591" class="difflineminus">-              nativeServerName.get(), nativeUserName.get());</span>
<a href="#l17.592"></a><span id="l17.592" class="difflineminus">-  nsString prettyName;</span>
<a href="#l17.593"></a><span id="l17.593" class="difflineminus">-  if (NS_SUCCEEDED(GetAccountName(aKey, aServerName, prettyName)))</span>
<a href="#l17.594"></a><span id="l17.594" class="difflineminus">-    rv = in-&gt;SetPrettyName(prettyName);</span>
<a href="#l17.595"></a><span id="l17.595" class="difflineminus">-</span>
<a href="#l17.596"></a><span id="l17.596" class="difflineminus">-  // We have a server, create an account.</span>
<a href="#l17.597"></a><span id="l17.597" class="difflineminus">-  nsCOMPtr&lt;nsIMsgAccount&gt;  account;</span>
<a href="#l17.598"></a><span id="l17.598" class="difflineminus">-  rv = aMgr-&gt;CreateAccount(getter_AddRefs( account));</span>
<a href="#l17.599"></a><span id="l17.599" class="difflineminus">-  if (NS_SUCCEEDED( rv) &amp;&amp; account) {</span>
<a href="#l17.600"></a><span id="l17.600" class="difflineminus">-    rv = account-&gt;SetIncomingServer(in);</span>
<a href="#l17.601"></a><span id="l17.601" class="difflineminus">-    IMPORT_LOG0(&quot;Created a new account and set the incoming server to the POP3 server.\n&quot;);</span>
<a href="#l17.602"></a><span id="l17.602" class="difflineminus">-</span>
<a href="#l17.603"></a><span id="l17.603" class="difflineminus">-    int32_t authMethod;</span>
<a href="#l17.604"></a><span id="l17.604" class="difflineminus">-    in-&gt;GetAuthMethod(&amp;authMethod);</span>
<a href="#l17.605"></a><span id="l17.605" class="difflineminus">-    // Fiddle with the identities</span>
<a href="#l17.606"></a><span id="l17.606" class="difflineminus">-    SetIdentities(aMgr, account, aKey, userName, authMethod, false);</span>
<a href="#l17.607"></a><span id="l17.607" class="difflineminus">-    if (ppAccount)</span>
<a href="#l17.608"></a><span id="l17.608" class="difflineminus">-      account-&gt;QueryInterface(NS_GET_IID(nsIMsgAccount),</span>
<a href="#l17.609"></a><span id="l17.609" class="difflineminus">-                               (void **)ppAccount);</span>
<a href="#l17.610"></a><span id="l17.610" class="difflineminus">-    return true;</span>
<a href="#l17.611"></a><span id="l17.611" class="difflineminus">-  }</span>
<a href="#l17.612"></a><span id="l17.612" class="difflineminus">-</span>
<a href="#l17.613"></a><span id="l17.613" class="difflineminus">-  return false;</span>
<a href="#l17.614"></a><span id="l17.614" class="difflineminus">-}</span>
<a href="#l17.615"></a><span id="l17.615" class="difflineminus">-</span>
<a href="#l17.616"></a><span id="l17.616" class="difflineminus">-bool OESettings::DoNNTPServer(nsIMsgAccountManager *aMgr,</span>
<a href="#l17.617"></a><span id="l17.617" class="difflineminus">-                              nsIWindowsRegKey *aKey,</span>
<a href="#l17.618"></a><span id="l17.618" class="difflineminus">-                              const nsString &amp;aServerName,</span>
<a href="#l17.619"></a><span id="l17.619" class="difflineminus">-                              nsIMsgAccount **ppAccount)</span>
<a href="#l17.620"></a><span id="l17.620" class="difflineminus">-{</span>
<a href="#l17.621"></a><span id="l17.621" class="difflineminus">-  if (ppAccount)</span>
<a href="#l17.622"></a><span id="l17.622" class="difflineminus">-    *ppAccount = nullptr;</span>
<a href="#l17.623"></a><span id="l17.623" class="difflineminus">-</span>
<a href="#l17.624"></a><span id="l17.624" class="difflineminus">-  nsAutoString userName;</span>
<a href="#l17.625"></a><span id="l17.625" class="difflineminus">-  nsresult rv;</span>
<a href="#l17.626"></a><span id="l17.626" class="difflineminus">-  // this only exists if NNTP server requires it or not anon login</span>
<a href="#l17.627"></a><span id="l17.627" class="difflineminus">-  rv = aKey-&gt;ReadStringValue(NS_LITERAL_STRING(&quot;NNTP User Name&quot;), userName);</span>
<a href="#l17.628"></a><span id="l17.628" class="difflineminus">-</span>
<a href="#l17.629"></a><span id="l17.629" class="difflineminus">-  bool result = false;</span>
<a href="#l17.630"></a><span id="l17.630" class="difflineminus">-</span>
<a href="#l17.631"></a><span id="l17.631" class="difflineminus">-  nsAutoCString nativeServerName;</span>
<a href="#l17.632"></a><span id="l17.632" class="difflineminus">-  NS_CopyUnicodeToNative(aServerName, nativeServerName);</span>
<a href="#l17.633"></a><span id="l17.633" class="difflineminus">-  // I now have a user name/server name pair, find out if it already exists?</span>
<a href="#l17.634"></a><span id="l17.634" class="difflineminus">-  // NNTP can have empty user name.  This is wild card in findserver</span>
<a href="#l17.635"></a><span id="l17.635" class="difflineminus">-  nsCOMPtr&lt;nsIMsgIncomingServer&gt; in;</span>
<a href="#l17.636"></a><span id="l17.636" class="difflineminus">-  rv = aMgr-&gt;FindServer(EmptyCString(),</span>
<a href="#l17.637"></a><span id="l17.637" class="difflineminus">-                        nativeServerName,</span>
<a href="#l17.638"></a><span id="l17.638" class="difflineminus">-                        NS_LITERAL_CSTRING(&quot;nntp&quot;),</span>
<a href="#l17.639"></a><span id="l17.639" class="difflineminus">-                        getter_AddRefs(in));</span>
<a href="#l17.640"></a><span id="l17.640" class="difflineminus">-  if (NS_FAILED(rv) || (in == nullptr)) {</span>
<a href="#l17.641"></a><span id="l17.641" class="difflineminus">-    // Create the incoming server and an account for it?</span>
<a href="#l17.642"></a><span id="l17.642" class="difflineminus">-    rv = aMgr-&gt;CreateIncomingServer(EmptyCString(),</span>
<a href="#l17.643"></a><span id="l17.643" class="difflineminus">-                                    nativeServerName,</span>
<a href="#l17.644"></a><span id="l17.644" class="difflineminus">-                                    NS_LITERAL_CSTRING(&quot;nntp&quot;),</span>
<a href="#l17.645"></a><span id="l17.645" class="difflineminus">-                                    getter_AddRefs(in));</span>
<a href="#l17.646"></a><span id="l17.646" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; in) {</span>
<a href="#l17.647"></a><span id="l17.647" class="difflineminus">-      uint32_t port = 0;</span>
<a href="#l17.648"></a><span id="l17.648" class="difflineminus">-      rv = aKey-&gt;ReadIntValue(NS_LITERAL_STRING(&quot;NNTP Port&quot;),</span>
<a href="#l17.649"></a><span id="l17.649" class="difflineminus">-                              &amp;port);</span>
<a href="#l17.650"></a><span id="l17.650" class="difflineminus">-      if (NS_SUCCEEDED(rv) &amp;&amp; port &amp;&amp; port != 119)</span>
<a href="#l17.651"></a><span id="l17.651" class="difflineminus">-        in-&gt;SetPort(static_cast&lt;int32_t&gt;(port));</span>
<a href="#l17.652"></a><span id="l17.652" class="difflineminus">-</span>
<a href="#l17.653"></a><span id="l17.653" class="difflineminus">-      nsAutoCString nativeUserName;</span>
<a href="#l17.654"></a><span id="l17.654" class="difflineminus">-      NS_CopyUnicodeToNative(userName, nativeUserName);</span>
<a href="#l17.655"></a><span id="l17.655" class="difflineminus">-      // do nntpincomingserver stuff</span>
<a href="#l17.656"></a><span id="l17.656" class="difflineminus">-      nsCOMPtr&lt;nsINntpIncomingServer&gt; nntpServer = do_QueryInterface(in);</span>
<a href="#l17.657"></a><span id="l17.657" class="difflineminus">-      if (nntpServer &amp;&amp; !userName.IsEmpty()) {</span>
<a href="#l17.658"></a><span id="l17.658" class="difflineminus">-        nntpServer-&gt;SetPushAuth(true);</span>
<a href="#l17.659"></a><span id="l17.659" class="difflineminus">-        in-&gt;SetUsername(nativeUserName);</span>
<a href="#l17.660"></a><span id="l17.660" class="difflineminus">-      }</span>
<a href="#l17.661"></a><span id="l17.661" class="difflineminus">-</span>
<a href="#l17.662"></a><span id="l17.662" class="difflineminus">-      IMPORT_LOG2(&quot;Created NNTP server named: %s, userName: %s\n&quot;,</span>
<a href="#l17.663"></a><span id="l17.663" class="difflineminus">-                  nativeServerName.get(), nativeUserName.get());</span>
<a href="#l17.664"></a><span id="l17.664" class="difflineminus">-</span>
<a href="#l17.665"></a><span id="l17.665" class="difflineminus">-      nsString prettyName;</span>
<a href="#l17.666"></a><span id="l17.666" class="difflineminus">-      if (NS_SUCCEEDED(GetAccountName(aKey, aServerName, prettyName)))</span>
<a href="#l17.667"></a><span id="l17.667" class="difflineminus">-        rv = in-&gt;SetPrettyName(prettyName);</span>
<a href="#l17.668"></a><span id="l17.668" class="difflineminus">-</span>
<a href="#l17.669"></a><span id="l17.669" class="difflineminus">-      // We have a server, create an account.</span>
<a href="#l17.670"></a><span id="l17.670" class="difflineminus">-      nsCOMPtr&lt;nsIMsgAccount&gt; account;</span>
<a href="#l17.671"></a><span id="l17.671" class="difflineminus">-      rv = aMgr-&gt;CreateAccount(getter_AddRefs(account));</span>
<a href="#l17.672"></a><span id="l17.672" class="difflineminus">-      if (NS_SUCCEEDED(rv) &amp;&amp; account) {</span>
<a href="#l17.673"></a><span id="l17.673" class="difflineminus">-        rv = account-&gt;SetIncomingServer(in);</span>
<a href="#l17.674"></a><span id="l17.674" class="difflineminus">-</span>
<a href="#l17.675"></a><span id="l17.675" class="difflineminus">-        IMPORT_LOG0(&quot;Created an account and set the NNTP server as the incoming server\n&quot;);</span>
<a href="#l17.676"></a><span id="l17.676" class="difflineminus">-</span>
<a href="#l17.677"></a><span id="l17.677" class="difflineminus">-        // Fiddle with the identities</span>
<a href="#l17.678"></a><span id="l17.678" class="difflineminus">-        SetIdentities(aMgr, account, aKey, userName, 0, true);</span>
<a href="#l17.679"></a><span id="l17.679" class="difflineminus">-        result = true;</span>
<a href="#l17.680"></a><span id="l17.680" class="difflineminus">-        if (ppAccount)</span>
<a href="#l17.681"></a><span id="l17.681" class="difflineminus">-          account-&gt;QueryInterface(NS_GET_IID(nsIMsgAccount), (void **)ppAccount);</span>
<a href="#l17.682"></a><span id="l17.682" class="difflineminus">-      }</span>
<a href="#l17.683"></a><span id="l17.683" class="difflineminus">-    }</span>
<a href="#l17.684"></a><span id="l17.684" class="difflineminus">-  }</span>
<a href="#l17.685"></a><span id="l17.685" class="difflineminus">-  else if (NS_SUCCEEDED(rv) &amp;&amp; in) {</span>
<a href="#l17.686"></a><span id="l17.686" class="difflineminus">-    // for the existing server...</span>
<a href="#l17.687"></a><span id="l17.687" class="difflineminus">-    nsCOMPtr&lt;nsIMsgAccount&gt; account;</span>
<a href="#l17.688"></a><span id="l17.688" class="difflineminus">-    rv = aMgr-&gt;FindAccountForServer(in, getter_AddRefs(account));</span>
<a href="#l17.689"></a><span id="l17.689" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; account) {</span>
<a href="#l17.690"></a><span id="l17.690" class="difflineminus">-      IMPORT_LOG0(&quot;Using existing account and set the NNTP server as the incoming server\n&quot;);</span>
<a href="#l17.691"></a><span id="l17.691" class="difflineminus">-      // Fiddle with the identities</span>
<a href="#l17.692"></a><span id="l17.692" class="difflineminus">-      SetIdentities(aMgr, account, aKey, userName, 0, true);</span>
<a href="#l17.693"></a><span id="l17.693" class="difflineminus">-      if (ppAccount)</span>
<a href="#l17.694"></a><span id="l17.694" class="difflineminus">-        account-&gt;QueryInterface(NS_GET_IID(nsIMsgAccount),</span>
<a href="#l17.695"></a><span id="l17.695" class="difflineminus">-                                 (void **)ppAccount);</span>
<a href="#l17.696"></a><span id="l17.696" class="difflineminus">-      return true;</span>
<a href="#l17.697"></a><span id="l17.697" class="difflineminus">-    }</span>
<a href="#l17.698"></a><span id="l17.698" class="difflineminus">-  }</span>
<a href="#l17.699"></a><span id="l17.699" class="difflineminus">-  else</span>
<a href="#l17.700"></a><span id="l17.700" class="difflineminus">-    result = true;</span>
<a href="#l17.701"></a><span id="l17.701" class="difflineminus">-</span>
<a href="#l17.702"></a><span id="l17.702" class="difflineminus">-  return result;</span>
<a href="#l17.703"></a><span id="l17.703" class="difflineminus">-}</span>
<a href="#l17.704"></a><span id="l17.704" class="difflineminus">-</span>
<a href="#l17.705"></a><span id="l17.705" class="difflineminus">-void OESettings::SetIncomingServerProperties(nsIMsgIncomingServer *aServer,</span>
<a href="#l17.706"></a><span id="l17.706" class="difflineminus">-                                             nsIWindowsRegKey *aKey,</span>
<a href="#l17.707"></a><span id="l17.707" class="difflineminus">-                                             const nsString &amp;aKeyNamePrefix)</span>
<a href="#l17.708"></a><span id="l17.708" class="difflineminus">-{</span>
<a href="#l17.709"></a><span id="l17.709" class="difflineminus">-  nsresult rv;</span>
<a href="#l17.710"></a><span id="l17.710" class="difflineminus">-  uint32_t secureConnection = 0;</span>
<a href="#l17.711"></a><span id="l17.711" class="difflineminus">-  nsString keyName(aKeyNamePrefix);</span>
<a href="#l17.712"></a><span id="l17.712" class="difflineminus">-  keyName.AppendLiteral(&quot;Secure Connection&quot;);</span>
<a href="#l17.713"></a><span id="l17.713" class="difflineminus">-  rv = aKey-&gt;ReadIntValue(keyName, &amp;secureConnection);</span>
<a href="#l17.714"></a><span id="l17.714" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; secureConnection == 1)</span>
<a href="#l17.715"></a><span id="l17.715" class="difflineminus">-    aServer-&gt;SetSocketType(nsMsgSocketType::SSL);</span>
<a href="#l17.716"></a><span id="l17.716" class="difflineminus">-</span>
<a href="#l17.717"></a><span id="l17.717" class="difflineminus">-  uint32_t port = 0;</span>
<a href="#l17.718"></a><span id="l17.718" class="difflineminus">-  keyName.SetLength(aKeyNamePrefix.Length());</span>
<a href="#l17.719"></a><span id="l17.719" class="difflineminus">-  keyName.AppendLiteral(&quot;Port&quot;);</span>
<a href="#l17.720"></a><span id="l17.720" class="difflineminus">-  rv = aKey-&gt;ReadIntValue(keyName, &amp;port);</span>
<a href="#l17.721"></a><span id="l17.721" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; port)</span>
<a href="#l17.722"></a><span id="l17.722" class="difflineminus">-    aServer-&gt;SetPort(static_cast&lt;int32_t&gt;(port));</span>
<a href="#l17.723"></a><span id="l17.723" class="difflineminus">-</span>
<a href="#l17.724"></a><span id="l17.724" class="difflineminus">-  int32_t authMethod;</span>
<a href="#l17.725"></a><span id="l17.725" class="difflineminus">-  uint32_t useSicily = 0;</span>
<a href="#l17.726"></a><span id="l17.726" class="difflineminus">-  keyName.SetLength(aKeyNamePrefix.Length());</span>
<a href="#l17.727"></a><span id="l17.727" class="difflineminus">-  keyName.AppendLiteral(&quot;Use Sicily&quot;);</span>
<a href="#l17.728"></a><span id="l17.728" class="difflineminus">-  rv = aKey-&gt;ReadIntValue(keyName, &amp;useSicily);</span>
<a href="#l17.729"></a><span id="l17.729" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; useSicily)</span>
<a href="#l17.730"></a><span id="l17.730" class="difflineminus">-    authMethod = nsMsgAuthMethod::secure;</span>
<a href="#l17.731"></a><span id="l17.731" class="difflineminus">-  else</span>
<a href="#l17.732"></a><span id="l17.732" class="difflineminus">-    authMethod = nsMsgAuthMethod::passwordCleartext;</span>
<a href="#l17.733"></a><span id="l17.733" class="difflineminus">-  aServer-&gt;SetAuthMethod(authMethod);</span>
<a href="#l17.734"></a><span id="l17.734" class="difflineminus">-</span>
<a href="#l17.735"></a><span id="l17.735" class="difflineminus">-  aServer-&gt;SetDoBiff(checkNewMail);</span>
<a href="#l17.736"></a><span id="l17.736" class="difflineminus">-  aServer-&gt;SetBiffMinutes(checkNewMailTime);</span>
<a href="#l17.737"></a><span id="l17.737" class="difflineminus">-}</span>
<a href="#l17.738"></a><span id="l17.738" class="difflineminus">-</span>
<a href="#l17.739"></a><span id="l17.739" class="difflineminus">-void OESettings::SetIdentities(nsIMsgAccountManager *aMgr,</span>
<a href="#l17.740"></a><span id="l17.740" class="difflineminus">-                               nsIMsgAccount *pAcc,</span>
<a href="#l17.741"></a><span id="l17.741" class="difflineminus">-                               nsIWindowsRegKey *aKey,</span>
<a href="#l17.742"></a><span id="l17.742" class="difflineminus">-                               const nsString &amp;aIncomgUserName,</span>
<a href="#l17.743"></a><span id="l17.743" class="difflineminus">-                               int32_t authMethodIncoming,</span>
<a href="#l17.744"></a><span id="l17.744" class="difflineminus">-                               bool isNNTP)</span>
<a href="#l17.745"></a><span id="l17.745" class="difflineminus">-{</span>
<a href="#l17.746"></a><span id="l17.746" class="difflineminus">-  // Get the relevant information for an identity</span>
<a href="#l17.747"></a><span id="l17.747" class="difflineminus">-  nsresult rv;</span>
<a href="#l17.748"></a><span id="l17.748" class="difflineminus">-  nsAutoString name;</span>
<a href="#l17.749"></a><span id="l17.749" class="difflineminus">-  rv = aKey-&gt;ReadStringValue(isNNTP ?</span>
<a href="#l17.750"></a><span id="l17.750" class="difflineminus">-                             NS_LITERAL_STRING(&quot;NNTP Display Name&quot;) :</span>
<a href="#l17.751"></a><span id="l17.751" class="difflineminus">-                             NS_LITERAL_STRING(&quot;SMTP Display Name&quot;),</span>
<a href="#l17.752"></a><span id="l17.752" class="difflineminus">-                             name);</span>
<a href="#l17.753"></a><span id="l17.753" class="difflineminus">-  nsAutoString email;</span>
<a href="#l17.754"></a><span id="l17.754" class="difflineminus">-  rv = aKey-&gt;ReadStringValue(isNNTP ?</span>
<a href="#l17.755"></a><span id="l17.755" class="difflineminus">-                             NS_LITERAL_STRING(&quot;NNTP Email Address&quot;) :</span>
<a href="#l17.756"></a><span id="l17.756" class="difflineminus">-                             NS_LITERAL_STRING(&quot;SMTP Email Address&quot;),</span>
<a href="#l17.757"></a><span id="l17.757" class="difflineminus">-                             email);</span>
<a href="#l17.758"></a><span id="l17.758" class="difflineminus">-  nsAutoString reply;</span>
<a href="#l17.759"></a><span id="l17.759" class="difflineminus">-  rv = aKey-&gt;ReadStringValue(isNNTP ?</span>
<a href="#l17.760"></a><span id="l17.760" class="difflineminus">-                             NS_LITERAL_STRING(&quot;NNTP Reply To Email Address&quot;) :</span>
<a href="#l17.761"></a><span id="l17.761" class="difflineminus">-                             NS_LITERAL_STRING(&quot;SMTP Reply To Email Address&quot;),</span>
<a href="#l17.762"></a><span id="l17.762" class="difflineminus">-                             reply);</span>
<a href="#l17.763"></a><span id="l17.763" class="difflineminus">-  nsAutoString orgName;</span>
<a href="#l17.764"></a><span id="l17.764" class="difflineminus">-  rv = aKey-&gt;ReadStringValue(isNNTP ?</span>
<a href="#l17.765"></a><span id="l17.765" class="difflineminus">-                             NS_LITERAL_STRING(&quot;NNTP Organization Name&quot;) :</span>
<a href="#l17.766"></a><span id="l17.766" class="difflineminus">-                             NS_LITERAL_STRING(&quot;SMTP Organization Name&quot;),</span>
<a href="#l17.767"></a><span id="l17.767" class="difflineminus">-                             orgName);</span>
<a href="#l17.768"></a><span id="l17.768" class="difflineminus">-</span>
<a href="#l17.769"></a><span id="l17.769" class="difflineminus">-  nsCOMPtr&lt;nsIMsgIdentity&gt; id;</span>
<a href="#l17.770"></a><span id="l17.770" class="difflineminus">-  rv = aMgr-&gt;CreateIdentity(getter_AddRefs(id));</span>
<a href="#l17.771"></a><span id="l17.771" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l17.772"></a><span id="l17.772" class="difflineminus">-    return;</span>
<a href="#l17.773"></a><span id="l17.773" class="difflineminus">-</span>
<a href="#l17.774"></a><span id="l17.774" class="difflineminus">-  id-&gt;SetFullName(name);</span>
<a href="#l17.775"></a><span id="l17.775" class="difflineminus">-  id-&gt;SetOrganization(orgName);</span>
<a href="#l17.776"></a><span id="l17.776" class="difflineminus">-</span>
<a href="#l17.777"></a><span id="l17.777" class="difflineminus">-  nsAutoCString nativeEmail;</span>
<a href="#l17.778"></a><span id="l17.778" class="difflineminus">-  NS_CopyUnicodeToNative(email, nativeEmail);</span>
<a href="#l17.779"></a><span id="l17.779" class="difflineminus">-  id-&gt;SetEmail(nativeEmail);</span>
<a href="#l17.780"></a><span id="l17.780" class="difflineminus">-  if (!reply.IsEmpty()) {</span>
<a href="#l17.781"></a><span id="l17.781" class="difflineminus">-    nsAutoCString nativeReply;</span>
<a href="#l17.782"></a><span id="l17.782" class="difflineminus">-    NS_CopyUnicodeToNative(reply, nativeReply);</span>
<a href="#l17.783"></a><span id="l17.783" class="difflineminus">-    id-&gt;SetReplyTo(nativeReply);</span>
<a href="#l17.784"></a><span id="l17.784" class="difflineminus">-  }</span>
<a href="#l17.785"></a><span id="l17.785" class="difflineminus">-</span>
<a href="#l17.786"></a><span id="l17.786" class="difflineminus">-  // Outlook Express users are used to top style quoting.</span>
<a href="#l17.787"></a><span id="l17.787" class="difflineminus">-  id-&gt;SetReplyOnTop(isNNTP ? 0 : 1);</span>
<a href="#l17.788"></a><span id="l17.788" class="difflineminus">-  pAcc-&gt;AddIdentity(id);</span>
<a href="#l17.789"></a><span id="l17.789" class="difflineminus">-</span>
<a href="#l17.790"></a><span id="l17.790" class="difflineminus">-  nsAutoCString nativeName;</span>
<a href="#l17.791"></a><span id="l17.791" class="difflineminus">-  NS_CopyUnicodeToNative(name, nativeName);</span>
<a href="#l17.792"></a><span id="l17.792" class="difflineminus">-  IMPORT_LOG0(&quot;Created identity and added to the account\n&quot;);</span>
<a href="#l17.793"></a><span id="l17.793" class="difflineminus">-  IMPORT_LOG1(&quot;\tname: %s\n&quot;, nativeName.get());</span>
<a href="#l17.794"></a><span id="l17.794" class="difflineminus">-  IMPORT_LOG1(&quot;\temail: %s\n&quot;, nativeEmail.get());</span>
<a href="#l17.795"></a><span id="l17.795" class="difflineminus">-</span>
<a href="#l17.796"></a><span id="l17.796" class="difflineminus">-  if (isNNTP)  // NNTP does not use SMTP in OE or TB</span>
<a href="#l17.797"></a><span id="l17.797" class="difflineminus">-    return;</span>
<a href="#l17.798"></a><span id="l17.798" class="difflineminus">-  nsAutoString smtpServer;</span>
<a href="#l17.799"></a><span id="l17.799" class="difflineminus">-  rv = aKey-&gt;ReadStringValue(NS_LITERAL_STRING(&quot;SMTP Server&quot;), smtpServer);</span>
<a href="#l17.800"></a><span id="l17.800" class="difflineminus">-  SetSmtpServer(smtpServer, aKey, id, aIncomgUserName, authMethodIncoming);</span>
<a href="#l17.801"></a><span id="l17.801" class="difflineminus">-}</span>
<a href="#l17.802"></a><span id="l17.802" class="difflineminus">-</span>
<a href="#l17.803"></a><span id="l17.803" class="difflineminus">-void OESettings::SetSmtpServer(const nsString &amp;aSmtpServer,</span>
<a href="#l17.804"></a><span id="l17.804" class="difflineminus">-                               nsIWindowsRegKey *aKey,</span>
<a href="#l17.805"></a><span id="l17.805" class="difflineminus">-                               nsIMsgIdentity *aId,</span>
<a href="#l17.806"></a><span id="l17.806" class="difflineminus">-                               const nsString &amp;aIncomgUserName,</span>
<a href="#l17.807"></a><span id="l17.807" class="difflineminus">-                               int32_t authMethodIncoming)</span>
<a href="#l17.808"></a><span id="l17.808" class="difflineminus">-{</span>
<a href="#l17.809"></a><span id="l17.809" class="difflineminus">-  // set the id.smtpserver accordingly</span>
<a href="#l17.810"></a><span id="l17.810" class="difflineminus">-  // first we have to calculate the smtp user name which is based on sicily</span>
<a href="#l17.811"></a><span id="l17.811" class="difflineminus">-  if (!aKey || !aId || aIncomgUserName.IsEmpty() || aSmtpServer.IsEmpty())</span>
<a href="#l17.812"></a><span id="l17.812" class="difflineminus">-    return;</span>
<a href="#l17.813"></a><span id="l17.813" class="difflineminus">-  nsCString smtpServerKey;</span>
<a href="#l17.814"></a><span id="l17.814" class="difflineminus">-  // smtp user name depends on sicily which may or not exist</span>
<a href="#l17.815"></a><span id="l17.815" class="difflineminus">-  uint32_t useSicily = 0;</span>
<a href="#l17.816"></a><span id="l17.816" class="difflineminus">-  nsresult rv = aKey-&gt;ReadIntValue(NS_LITERAL_STRING(&quot;SMTP Use Sicily&quot;),</span>
<a href="#l17.817"></a><span id="l17.817" class="difflineminus">-                                   &amp;useSicily);</span>
<a href="#l17.818"></a><span id="l17.818" class="difflineminus">-  nsAutoString userName;</span>
<a href="#l17.819"></a><span id="l17.819" class="difflineminus">-  switch (useSicily) {</span>
<a href="#l17.820"></a><span id="l17.820" class="difflineminus">-    case 1:</span>
<a href="#l17.821"></a><span id="l17.821" class="difflineminus">-    case 3:</span>
<a href="#l17.822"></a><span id="l17.822" class="difflineminus">-      // has to go in whether empty or no</span>
<a href="#l17.823"></a><span id="l17.823" class="difflineminus">-      // shouldn't be empty but better safe than sorry</span>
<a href="#l17.824"></a><span id="l17.824" class="difflineminus">-      aKey-&gt;ReadStringValue(NS_LITERAL_STRING(&quot;SMTP User Name&quot;), userName);</span>
<a href="#l17.825"></a><span id="l17.825" class="difflineminus">-      break;</span>
<a href="#l17.826"></a><span id="l17.826" class="difflineminus">-    case 2:</span>
<a href="#l17.827"></a><span id="l17.827" class="difflineminus">-      userName = aIncomgUserName;</span>
<a href="#l17.828"></a><span id="l17.828" class="difflineminus">-      break;</span>
<a href="#l17.829"></a><span id="l17.829" class="difflineminus">-    default:</span>
<a href="#l17.830"></a><span id="l17.830" class="difflineminus">-      break; // initial userName == &quot;&quot;</span>
<a href="#l17.831"></a><span id="l17.831" class="difflineminus">-  }</span>
<a href="#l17.832"></a><span id="l17.832" class="difflineminus">-</span>
<a href="#l17.833"></a><span id="l17.833" class="difflineminus">-  nsCOMPtr&lt;nsISmtpService&gt; smtpService(do_GetService(NS_SMTPSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l17.834"></a><span id="l17.834" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; smtpService) {</span>
<a href="#l17.835"></a><span id="l17.835" class="difflineminus">-    nsCOMPtr&lt;nsISmtpServer&gt; foundServer;</span>
<a href="#l17.836"></a><span id="l17.836" class="difflineminus">-    // don't try to make another server</span>
<a href="#l17.837"></a><span id="l17.837" class="difflineminus">-    // regardless if username doesn't match</span>
<a href="#l17.838"></a><span id="l17.838" class="difflineminus">-    nsAutoCString nativeUserName;</span>
<a href="#l17.839"></a><span id="l17.839" class="difflineminus">-    NS_CopyUnicodeToNative(userName, nativeUserName);</span>
<a href="#l17.840"></a><span id="l17.840" class="difflineminus">-    nsAutoCString nativeSmtpServer;</span>
<a href="#l17.841"></a><span id="l17.841" class="difflineminus">-    NS_CopyUnicodeToNative(aSmtpServer, nativeSmtpServer);</span>
<a href="#l17.842"></a><span id="l17.842" class="difflineminus">-    rv = smtpService-&gt;FindServer(nativeUserName.get(),</span>
<a href="#l17.843"></a><span id="l17.843" class="difflineminus">-                                 nativeSmtpServer.get(),</span>
<a href="#l17.844"></a><span id="l17.844" class="difflineminus">-                                 getter_AddRefs(foundServer));</span>
<a href="#l17.845"></a><span id="l17.845" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; foundServer) {</span>
<a href="#l17.846"></a><span id="l17.846" class="difflineminus">-      // set our account keyed to this smptserver key</span>
<a href="#l17.847"></a><span id="l17.847" class="difflineminus">-      foundServer-&gt;GetKey(getter_Copies(smtpServerKey));</span>
<a href="#l17.848"></a><span id="l17.848" class="difflineminus">-      aId-&gt;SetSmtpServerKey(smtpServerKey);</span>
<a href="#l17.849"></a><span id="l17.849" class="difflineminus">-</span>
<a href="#l17.850"></a><span id="l17.850" class="difflineminus">-      IMPORT_LOG1(&quot;SMTP server already exists: %s\n&quot;,</span>
<a href="#l17.851"></a><span id="l17.851" class="difflineminus">-                  nativeSmtpServer.get());</span>
<a href="#l17.852"></a><span id="l17.852" class="difflineminus">-    }</span>
<a href="#l17.853"></a><span id="l17.853" class="difflineminus">-    else {</span>
<a href="#l17.854"></a><span id="l17.854" class="difflineminus">-      nsCOMPtr&lt;nsISmtpServer&gt; smtpServer;</span>
<a href="#l17.855"></a><span id="l17.855" class="difflineminus">-      rv = smtpService-&gt;CreateServer(getter_AddRefs(smtpServer));</span>
<a href="#l17.856"></a><span id="l17.856" class="difflineminus">-      if (NS_SUCCEEDED(rv) &amp;&amp; smtpServer) {</span>
<a href="#l17.857"></a><span id="l17.857" class="difflineminus">-        uint32_t port = 0;</span>
<a href="#l17.858"></a><span id="l17.858" class="difflineminus">-        rv = aKey-&gt;ReadIntValue(NS_LITERAL_STRING(&quot;SMTP Port&quot;),</span>
<a href="#l17.859"></a><span id="l17.859" class="difflineminus">-                                &amp;port);</span>
<a href="#l17.860"></a><span id="l17.860" class="difflineminus">-        if (NS_SUCCEEDED(rv) &amp;&amp; port)</span>
<a href="#l17.861"></a><span id="l17.861" class="difflineminus">-          smtpServer-&gt;SetPort(static_cast&lt;int32_t&gt;(port));</span>
<a href="#l17.862"></a><span id="l17.862" class="difflineminus">-</span>
<a href="#l17.863"></a><span id="l17.863" class="difflineminus">-        int32_t socketType = nsMsgSocketType::plain;</span>
<a href="#l17.864"></a><span id="l17.864" class="difflineminus">-        uint32_t secureConnection = 0;</span>
<a href="#l17.865"></a><span id="l17.865" class="difflineminus">-        rv = aKey-&gt;ReadIntValue(NS_LITERAL_STRING(&quot;SMTP Secure Connection&quot;),</span>
<a href="#l17.866"></a><span id="l17.866" class="difflineminus">-                                &amp;secureConnection);</span>
<a href="#l17.867"></a><span id="l17.867" class="difflineminus">-        if (NS_SUCCEEDED(rv) &amp;&amp; secureConnection == 1) {</span>
<a href="#l17.868"></a><span id="l17.868" class="difflineminus">-          // Outlook Express does not support STARTTLS without KB933612 fix.</span>
<a href="#l17.869"></a><span id="l17.869" class="difflineminus">-          if (IsKB933612Applied() &amp;&amp; port != 465)</span>
<a href="#l17.870"></a><span id="l17.870" class="difflineminus">-            socketType = nsMsgSocketType::alwaysSTARTTLS;</span>
<a href="#l17.871"></a><span id="l17.871" class="difflineminus">-          else</span>
<a href="#l17.872"></a><span id="l17.872" class="difflineminus">-            socketType = nsMsgSocketType::SSL;</span>
<a href="#l17.873"></a><span id="l17.873" class="difflineminus">-        }</span>
<a href="#l17.874"></a><span id="l17.874" class="difflineminus">-        smtpServer-&gt;SetSocketType(socketType);</span>
<a href="#l17.875"></a><span id="l17.875" class="difflineminus">-        smtpServer-&gt;SetUsername(nativeUserName);</span>
<a href="#l17.876"></a><span id="l17.876" class="difflineminus">-        switch (useSicily) {</span>
<a href="#l17.877"></a><span id="l17.877" class="difflineminus">-          case 1 :</span>
<a href="#l17.878"></a><span id="l17.878" class="difflineminus">-            smtpServer-&gt;SetAuthMethod(nsMsgAuthMethod::secure);</span>
<a href="#l17.879"></a><span id="l17.879" class="difflineminus">-            break;</span>
<a href="#l17.880"></a><span id="l17.880" class="difflineminus">-          case 2 : // requires SMTP authentication to use the incoming server settings</span>
<a href="#l17.881"></a><span id="l17.881" class="difflineminus">-            smtpServer-&gt;SetAuthMethod(authMethodIncoming);</span>
<a href="#l17.882"></a><span id="l17.882" class="difflineminus">-            break;</span>
<a href="#l17.883"></a><span id="l17.883" class="difflineminus">-          case 3 :</span>
<a href="#l17.884"></a><span id="l17.884" class="difflineminus">-            smtpServer-&gt;SetAuthMethod(nsMsgAuthMethod::passwordCleartext);</span>
<a href="#l17.885"></a><span id="l17.885" class="difflineminus">-            break;</span>
<a href="#l17.886"></a><span id="l17.886" class="difflineminus">-          default:</span>
<a href="#l17.887"></a><span id="l17.887" class="difflineminus">-            smtpServer-&gt;SetAuthMethod(nsMsgAuthMethod::none);</span>
<a href="#l17.888"></a><span id="l17.888" class="difflineminus">-        }</span>
<a href="#l17.889"></a><span id="l17.889" class="difflineminus">-</span>
<a href="#l17.890"></a><span id="l17.890" class="difflineminus">-        smtpServer-&gt;SetHostname(nativeSmtpServer);</span>
<a href="#l17.891"></a><span id="l17.891" class="difflineminus">-</span>
<a href="#l17.892"></a><span id="l17.892" class="difflineminus">-        smtpServer-&gt;GetKey(getter_Copies(smtpServerKey));</span>
<a href="#l17.893"></a><span id="l17.893" class="difflineminus">-        aId-&gt;SetSmtpServerKey(smtpServerKey);</span>
<a href="#l17.894"></a><span id="l17.894" class="difflineminus">-</span>
<a href="#l17.895"></a><span id="l17.895" class="difflineminus">-        IMPORT_LOG1(&quot;Created new SMTP server: %s\n&quot;,</span>
<a href="#l17.896"></a><span id="l17.896" class="difflineminus">-                    nativeSmtpServer.get());</span>
<a href="#l17.897"></a><span id="l17.897" class="difflineminus">-      }</span>
<a href="#l17.898"></a><span id="l17.898" class="difflineminus">-    }</span>
<a href="#l17.899"></a><span id="l17.899" class="difflineminus">-  }</span>
<a href="#l17.900"></a><span id="l17.900" class="difflineminus">-}</span>
<a href="#l17.901"></a><span id="l17.901" class="difflineminus">-</span>
<a href="#l17.902"></a><span id="l17.902" class="difflineminus">-bool OESettings::IsKB933612Applied()</span>
<a href="#l17.903"></a><span id="l17.903" class="difflineminus">-{</span>
<a href="#l17.904"></a><span id="l17.904" class="difflineminus">-  // All supported versions of Windows include the KB933612 fix.</span>
<a href="#l17.905"></a><span id="l17.905" class="difflineminus">-  return true;</span>
<a href="#l17.906"></a><span id="l17.906" class="difflineminus">-}</span>
<a href="#l17.907"></a><span id="l17.907" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1">deleted file mode 100644</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineminus">--- a/mailnews/import/oexpress/nsOESettings.h</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineplus">+++ /dev/null</span>
<a href="#l18.4"></a><span id="l18.4" class="difflineat">@@ -1,22 +0,0 @@</span>
<a href="#l18.5"></a><span id="l18.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l18.6"></a><span id="l18.6" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l18.7"></a><span id="l18.7" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l18.8"></a><span id="l18.8" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l18.9"></a><span id="l18.9" class="difflineminus">-</span>
<a href="#l18.10"></a><span id="l18.10" class="difflineminus">-#ifndef nsOESettings_h___</span>
<a href="#l18.11"></a><span id="l18.11" class="difflineminus">-#define nsOESettings_h___</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineminus">-#include &quot;nsIImportSettings.h&quot;</span>
<a href="#l18.14"></a><span id="l18.14" class="difflineminus">-</span>
<a href="#l18.15"></a><span id="l18.15" class="difflineminus">-class nsOESettings : public nsIImportSettings {</span>
<a href="#l18.16"></a><span id="l18.16" class="difflineminus">-public:</span>
<a href="#l18.17"></a><span id="l18.17" class="difflineminus">-  nsOESettings();</span>
<a href="#l18.18"></a><span id="l18.18" class="difflineminus">-  static nsresult Create(nsIImportSettings** aImport);</span>
<a href="#l18.19"></a><span id="l18.19" class="difflineminus">-  NS_DECL_ISUPPORTS</span>
<a href="#l18.20"></a><span id="l18.20" class="difflineminus">-  NS_DECL_NSIIMPORTSETTINGS</span>
<a href="#l18.21"></a><span id="l18.21" class="difflineminus">-</span>
<a href="#l18.22"></a><span id="l18.22" class="difflineminus">-private:</span>
<a href="#l18.23"></a><span id="l18.23" class="difflineminus">-  virtual ~nsOESettings();</span>
<a href="#l18.24"></a><span id="l18.24" class="difflineminus">-};</span>
<a href="#l18.25"></a><span id="l18.25" class="difflineminus">-</span>
<a href="#l18.26"></a><span id="l18.26" class="difflineminus">-#endif /* nsOESettings_h___ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1">deleted file mode 100644</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineminus">--- a/mailnews/import/oexpress/nsOEStringBundle.cpp</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineplus">+++ /dev/null</span>
<a href="#l19.4"></a><span id="l19.4" class="difflineat">@@ -1,71 +0,0 @@</span>
<a href="#l19.5"></a><span id="l19.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l19.6"></a><span id="l19.6" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l19.7"></a><span id="l19.7" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l19.8"></a><span id="l19.8" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l19.9"></a><span id="l19.9" class="difflineminus">-#include &quot;prprf.h&quot;</span>
<a href="#l19.10"></a><span id="l19.10" class="difflineminus">-#include &quot;prmem.h&quot;</span>
<a href="#l19.11"></a><span id="l19.11" class="difflineminus">-#include &quot;nsCOMPtr.h&quot;</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-#include &quot;nsMsgUtils.h&quot;</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineminus">-#include &quot;nsIStringBundle.h&quot;</span>
<a href="#l19.14"></a><span id="l19.14" class="difflineminus">-#include &quot;nsOEStringBundle.h&quot;</span>
<a href="#l19.15"></a><span id="l19.15" class="difflineminus">-#include &quot;nsIServiceManager.h&quot;</span>
<a href="#l19.16"></a><span id="l19.16" class="difflineminus">-#include &quot;nsIURI.h&quot;</span>
<a href="#l19.17"></a><span id="l19.17" class="difflineminus">-#include &quot;mozilla/Services.h&quot;</span>
<a href="#l19.18"></a><span id="l19.18" class="difflineminus">-</span>
<a href="#l19.19"></a><span id="l19.19" class="difflineminus">-#define OE_MSGS_URL       &quot;chrome://messenger/locale/oeImportMsgs.properties&quot;</span>
<a href="#l19.20"></a><span id="l19.20" class="difflineminus">-</span>
<a href="#l19.21"></a><span id="l19.21" class="difflineminus">-nsIStringBundle *  nsOEStringBundle::m_pBundle = nullptr;</span>
<a href="#l19.22"></a><span id="l19.22" class="difflineminus">-</span>
<a href="#l19.23"></a><span id="l19.23" class="difflineminus">-nsIStringBundle *nsOEStringBundle::GetStringBundle(void)</span>
<a href="#l19.24"></a><span id="l19.24" class="difflineminus">-{</span>
<a href="#l19.25"></a><span id="l19.25" class="difflineminus">-  if (m_pBundle)</span>
<a href="#l19.26"></a><span id="l19.26" class="difflineminus">-    return m_pBundle;</span>
<a href="#l19.27"></a><span id="l19.27" class="difflineminus">-</span>
<a href="#l19.28"></a><span id="l19.28" class="difflineminus">-  char*        propertyURL = OE_MSGS_URL;</span>
<a href="#l19.29"></a><span id="l19.29" class="difflineminus">-  nsIStringBundle*  sBundle = nullptr;</span>
<a href="#l19.30"></a><span id="l19.30" class="difflineminus">-</span>
<a href="#l19.31"></a><span id="l19.31" class="difflineminus">-  nsCOMPtr&lt;nsIStringBundleService&gt; sBundleService =</span>
<a href="#l19.32"></a><span id="l19.32" class="difflineminus">-    mozilla::services::GetStringBundleService();</span>
<a href="#l19.33"></a><span id="l19.33" class="difflineminus">-  if (sBundleService) {</span>
<a href="#l19.34"></a><span id="l19.34" class="difflineminus">-    sBundleService-&gt;CreateBundle(propertyURL, &amp;sBundle);</span>
<a href="#l19.35"></a><span id="l19.35" class="difflineminus">-  }</span>
<a href="#l19.36"></a><span id="l19.36" class="difflineminus">-</span>
<a href="#l19.37"></a><span id="l19.37" class="difflineminus">-  m_pBundle = sBundle;</span>
<a href="#l19.38"></a><span id="l19.38" class="difflineminus">-</span>
<a href="#l19.39"></a><span id="l19.39" class="difflineminus">-  return sBundle;</span>
<a href="#l19.40"></a><span id="l19.40" class="difflineminus">-}</span>
<a href="#l19.41"></a><span id="l19.41" class="difflineminus">-</span>
<a href="#l19.42"></a><span id="l19.42" class="difflineminus">-</span>
<a href="#l19.43"></a><span id="l19.43" class="difflineminus">-void nsOEStringBundle::GetStringByID(int32_t stringID, nsString&amp; result)</span>
<a href="#l19.44"></a><span id="l19.44" class="difflineminus">-{</span>
<a href="#l19.45"></a><span id="l19.45" class="difflineminus">-  char16_t *ptrv = GetStringByID(stringID);</span>
<a href="#l19.46"></a><span id="l19.46" class="difflineminus">-  result.Adopt(ptrv);</span>
<a href="#l19.47"></a><span id="l19.47" class="difflineminus">-}</span>
<a href="#l19.48"></a><span id="l19.48" class="difflineminus">-</span>
<a href="#l19.49"></a><span id="l19.49" class="difflineminus">-char16_t *nsOEStringBundle::GetStringByID(int32_t stringID)</span>
<a href="#l19.50"></a><span id="l19.50" class="difflineminus">-{</span>
<a href="#l19.51"></a><span id="l19.51" class="difflineminus">-  if (!m_pBundle)</span>
<a href="#l19.52"></a><span id="l19.52" class="difflineminus">-    m_pBundle = GetStringBundle();</span>
<a href="#l19.53"></a><span id="l19.53" class="difflineminus">-</span>
<a href="#l19.54"></a><span id="l19.54" class="difflineminus">-  if (m_pBundle) {</span>
<a href="#l19.55"></a><span id="l19.55" class="difflineminus">-    char16_t *ptrv = nullptr;</span>
<a href="#l19.56"></a><span id="l19.56" class="difflineminus">-    nsresult rv = m_pBundle-&gt;GetStringFromID(stringID, &amp;ptrv);</span>
<a href="#l19.57"></a><span id="l19.57" class="difflineminus">-</span>
<a href="#l19.58"></a><span id="l19.58" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; ptrv)</span>
<a href="#l19.59"></a><span id="l19.59" class="difflineminus">-      return ptrv;</span>
<a href="#l19.60"></a><span id="l19.60" class="difflineminus">-  }</span>
<a href="#l19.61"></a><span id="l19.61" class="difflineminus">-</span>
<a href="#l19.62"></a><span id="l19.62" class="difflineminus">-  nsString resultString;</span>
<a href="#l19.63"></a><span id="l19.63" class="difflineminus">-  resultString.AppendLiteral(&quot;[StringID &quot;);</span>
<a href="#l19.64"></a><span id="l19.64" class="difflineminus">-  resultString.AppendInt(stringID);</span>
<a href="#l19.65"></a><span id="l19.65" class="difflineminus">-  resultString.AppendLiteral(&quot;?]&quot;);</span>
<a href="#l19.66"></a><span id="l19.66" class="difflineminus">-</span>
<a href="#l19.67"></a><span id="l19.67" class="difflineminus">-  return ToNewUnicode(resultString);</span>
<a href="#l19.68"></a><span id="l19.68" class="difflineminus">-}</span>
<a href="#l19.69"></a><span id="l19.69" class="difflineminus">-</span>
<a href="#l19.70"></a><span id="l19.70" class="difflineminus">-void nsOEStringBundle::Cleanup(void)</span>
<a href="#l19.71"></a><span id="l19.71" class="difflineminus">-{</span>
<a href="#l19.72"></a><span id="l19.72" class="difflineminus">-  if (m_pBundle)</span>
<a href="#l19.73"></a><span id="l19.73" class="difflineminus">-    m_pBundle-&gt;Release();</span>
<a href="#l19.74"></a><span id="l19.74" class="difflineminus">-  m_pBundle = nullptr;</span>
<a href="#l19.75"></a><span id="l19.75" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1">deleted file mode 100644</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineminus">--- a/mailnews/import/oexpress/nsOEStringBundle.h</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineplus">+++ /dev/null</span>
<a href="#l20.4"></a><span id="l20.4" class="difflineat">@@ -1,38 +0,0 @@</span>
<a href="#l20.5"></a><span id="l20.5" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l20.6"></a><span id="l20.6" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l20.7"></a><span id="l20.7" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l20.8"></a><span id="l20.8" class="difflineminus">-</span>
<a href="#l20.9"></a><span id="l20.9" class="difflineminus">-#ifndef _nsOEStringBundle_H__</span>
<a href="#l20.10"></a><span id="l20.10" class="difflineminus">-#define _nsOEStringBundle_H__</span>
<a href="#l20.11"></a><span id="l20.11" class="difflineminus">-</span>
<a href="#l20.12"></a><span id="l20.12" class="difflineminus">-#include &quot;nsStringGlue.h&quot;</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineminus">-</span>
<a href="#l20.14"></a><span id="l20.14" class="difflineminus">-class nsIStringBundle;</span>
<a href="#l20.15"></a><span id="l20.15" class="difflineminus">-</span>
<a href="#l20.16"></a><span id="l20.16" class="difflineminus">-class nsOEStringBundle {</span>
<a href="#l20.17"></a><span id="l20.17" class="difflineminus">-public:</span>
<a href="#l20.18"></a><span id="l20.18" class="difflineminus">-  static char16_t     *    GetStringByID(int32_t stringID);</span>
<a href="#l20.19"></a><span id="l20.19" class="difflineminus">-  static void          GetStringByID(int32_t stringID, nsString&amp; result);</span>
<a href="#l20.20"></a><span id="l20.20" class="difflineminus">-  static nsIStringBundle *  GetStringBundle(void); // don't release</span>
<a href="#l20.21"></a><span id="l20.21" class="difflineminus">-  static void          FreeString(char16_t *pStr) { NS_Free(pStr);}</span>
<a href="#l20.22"></a><span id="l20.22" class="difflineminus">-  static void          Cleanup(void);</span>
<a href="#l20.23"></a><span id="l20.23" class="difflineminus">-</span>
<a href="#l20.24"></a><span id="l20.24" class="difflineminus">-private:</span>
<a href="#l20.25"></a><span id="l20.25" class="difflineminus">-  static nsIStringBundle *  m_pBundle;</span>
<a href="#l20.26"></a><span id="l20.26" class="difflineminus">-};</span>
<a href="#l20.27"></a><span id="l20.27" class="difflineminus">-</span>
<a href="#l20.28"></a><span id="l20.28" class="difflineminus">-</span>
<a href="#l20.29"></a><span id="l20.29" class="difflineminus">-</span>
<a href="#l20.30"></a><span id="l20.30" class="difflineminus">-#define OEIMPORT_NAME                     2000</span>
<a href="#l20.31"></a><span id="l20.31" class="difflineminus">-#define OEIMPORT_DESCRIPTION              2011</span>
<a href="#l20.32"></a><span id="l20.32" class="difflineminus">-#define OEIMPORT_MAILBOX_SUCCESS          2002</span>
<a href="#l20.33"></a><span id="l20.33" class="difflineminus">-#define OEIMPORT_MAILBOX_BADPARAM         2003</span>
<a href="#l20.34"></a><span id="l20.34" class="difflineminus">-#define OEIMPORT_MAILBOX_BADSOURCEFILE    2004</span>
<a href="#l20.35"></a><span id="l20.35" class="difflineminus">-#define OEIMPORT_MAILBOX_CONVERTERROR     2005</span>
<a href="#l20.36"></a><span id="l20.36" class="difflineminus">-#define OEIMPORT_DEFAULT_NAME             2006</span>
<a href="#l20.37"></a><span id="l20.37" class="difflineminus">-#define OEIMPORT_AUTOFIND                 2007</span>
<a href="#l20.38"></a><span id="l20.38" class="difflineminus">-#define OEIMPORT_ADDRESS_SUCCESS          2008</span>
<a href="#l20.39"></a><span id="l20.39" class="difflineminus">-#define OEIMPORT_ADDRESS_CONVERTERROR     2009</span>
<a href="#l20.40"></a><span id="l20.40" class="difflineminus">-#define OEIMPORT_ADDRESS_BADPARAM         2010</span>
<a href="#l20.41"></a><span id="l20.41" class="difflineminus">-</span>
<a href="#l20.42"></a><span id="l20.42" class="difflineminus">-#endif /* _nsOEStringBundle_H__ */</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

