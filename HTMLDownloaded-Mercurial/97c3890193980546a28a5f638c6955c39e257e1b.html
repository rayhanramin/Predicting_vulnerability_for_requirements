<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 24336:97c3890193980546a28a5f638c6955c39e257e1b</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 97c3890193980546a28a5f638c6955c39e257e1b" />
<meta property="og:url" content="/comm-central/rev/97c3890193980546a28a5f638c6955c39e257e1b" />
<meta property="og:description" content="Bug 1456589 - Part 6 Port Bug 1439315 [defineLazyScriptGetter controller.js] to SeaMonkey places. r=IanN" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 97c3890193980546a28a5f638c6955c39e257e1b 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/97c3890193980546a28a5f638c6955c39e257e1b">shortlog</a> |
<a href="/comm-central/log/97c3890193980546a28a5f638c6955c39e257e1b">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/97c3890193980546a28a5f638c6955c39e257e1b">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/97c3890193980546a28a5f638c6955c39e257e1b">files</a> |
changeset |
<a href="/comm-central/raw-rev/97c3890193980546a28a5f638c6955c39e257e1b">raw</a>  | <a href="/comm-central/archive/97c3890193980546a28a5f638c6955c39e257e1b.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1456589">Bug 1456589</a> - Part 6 Port <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1439315">Bug 1439315</a> [defineLazyScriptGetter controller.js] to SeaMonkey places. r=IanN
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#70;&#114;&#97;&#110;&#107;&#45;&#82;&#97;&#105;&#110;&#101;&#114;&#32;&#71;&#114;&#97;&#104;&#108;&#32;&#60;&#102;&#114;&#103;&#114;&#97;&#104;&#108;&#64;&#103;&#109;&#120;&#46;&#110;&#101;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Mon, 23 Jul 2018 22:11:06 +0200</td></tr>

<tr>
 <td>changeset 24336</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/97c3890193980546a28a5f638c6955c39e257e1b">97c3890193980546a28a5f638c6955c39e257e1b</a></td>
</tr>



<tr>
<td>parent 24335</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/5515f2dd2916d6faf1276c55f0958415bcabb501">5515f2dd2916d6faf1276c55f0958415bcabb501</a>
</td>
</tr>

<tr>
<td>child 24337</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/67150548fc03c0ea26bb149baa02910bb4e174d2">67150548fc03c0ea26bb149baa02910bb4e174d2</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=97c3890193980546a28a5f638c6955c39e257e1b">14652</a></td></tr>
<tr><td>push user</td><td>frgrahl@gmx.net</td></tr>
<tr><td>push date</td><td class="date age">Mon, 23 Jul 2018 20:17:58 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@07e930aae6f2 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=07e930aae6f2e69714e5add148805bed730ea094">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=07e930aae6f2e69714e5add148805bed730ea094&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=07e930aae6f2e69714e5add148805bed730ea094&newProject=comm-central&newRevision=e9b76764d29c217810cb46d6e42de1af4acde58c&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=07e930aae6f2e69714e5add148805bed730ea094&newProject=comm-central&newRevision=e9b76764d29c217810cb46d6e42de1af4acde58c&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=07e930aae6f2e69714e5add148805bed730ea094&newProject=comm-central&newRevision=e9b76764d29c217810cb46d6e42de1af4acde58c&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28IanN%29&revcount=50">IanN</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1456589">1456589</a>, <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1439315">1439315</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1456589">Bug 1456589</a> - Part 6 Port <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1439315">Bug 1439315</a> [defineLazyScriptGetter controller.js] to SeaMonkey places. r=IanN
Ports:
part 1 [rename InsertionPoint to PlacesInsertionPoint].
part 2 [Move command utils to PlacesUIUtils].
part 3 [Don't use NetUtil.newURI].
part 4 is mozilla only. Not ported.
part 5 [defineLazyScriptGetter controller.js].
part 6 [Move some utils into PlacesController or PlacesUIUtils].
part 7 [Don't import PlacesUtils on PlacesUIUtils import].
part 8 [Remove some dangling NetUtil usage].
[eslint followup].</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/97c3890193980546a28a5f638c6955c39e257e1b/suite/base/content/nsContextMenu.js">suite/base/content/nsContextMenu.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/97c3890193980546a28a5f638c6955c39e257e1b/suite/base/content/nsContextMenu.js">file</a> |
<a href="/comm-central/annotate/97c3890193980546a28a5f638c6955c39e257e1b/suite/base/content/nsContextMenu.js">annotate</a> |
<a href="/comm-central/diff/97c3890193980546a28a5f638c6955c39e257e1b/suite/base/content/nsContextMenu.js">diff</a> |
<a href="/comm-central/comparison/97c3890193980546a28a5f638c6955c39e257e1b/suite/base/content/nsContextMenu.js">comparison</a> |
<a href="/comm-central/log/97c3890193980546a28a5f638c6955c39e257e1b/suite/base/content/nsContextMenu.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/97c3890193980546a28a5f638c6955c39e257e1b/suite/browser/browser-places.js">suite/browser/browser-places.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/97c3890193980546a28a5f638c6955c39e257e1b/suite/browser/browser-places.js">file</a> |
<a href="/comm-central/annotate/97c3890193980546a28a5f638c6955c39e257e1b/suite/browser/browser-places.js">annotate</a> |
<a href="/comm-central/diff/97c3890193980546a28a5f638c6955c39e257e1b/suite/browser/browser-places.js">diff</a> |
<a href="/comm-central/comparison/97c3890193980546a28a5f638c6955c39e257e1b/suite/browser/browser-places.js">comparison</a> |
<a href="/comm-central/log/97c3890193980546a28a5f638c6955c39e257e1b/suite/browser/browser-places.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/97c3890193980546a28a5f638c6955c39e257e1b/suite/browser/navigator.js">suite/browser/navigator.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/97c3890193980546a28a5f638c6955c39e257e1b/suite/browser/navigator.js">file</a> |
<a href="/comm-central/annotate/97c3890193980546a28a5f638c6955c39e257e1b/suite/browser/navigator.js">annotate</a> |
<a href="/comm-central/diff/97c3890193980546a28a5f638c6955c39e257e1b/suite/browser/navigator.js">diff</a> |
<a href="/comm-central/comparison/97c3890193980546a28a5f638c6955c39e257e1b/suite/browser/navigator.js">comparison</a> |
<a href="/comm-central/log/97c3890193980546a28a5f638c6955c39e257e1b/suite/browser/navigator.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/97c3890193980546a28a5f638c6955c39e257e1b/suite/components/nsSuiteGlue.js">suite/components/nsSuiteGlue.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/97c3890193980546a28a5f638c6955c39e257e1b/suite/components/nsSuiteGlue.js">file</a> |
<a href="/comm-central/annotate/97c3890193980546a28a5f638c6955c39e257e1b/suite/components/nsSuiteGlue.js">annotate</a> |
<a href="/comm-central/diff/97c3890193980546a28a5f638c6955c39e257e1b/suite/components/nsSuiteGlue.js">diff</a> |
<a href="/comm-central/comparison/97c3890193980546a28a5f638c6955c39e257e1b/suite/components/nsSuiteGlue.js">comparison</a> |
<a href="/comm-central/log/97c3890193980546a28a5f638c6955c39e257e1b/suite/components/nsSuiteGlue.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/97c3890193980546a28a5f638c6955c39e257e1b/suite/components/places/PlacesUIUtils.jsm">suite/components/places/PlacesUIUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/97c3890193980546a28a5f638c6955c39e257e1b/suite/components/places/PlacesUIUtils.jsm">file</a> |
<a href="/comm-central/annotate/97c3890193980546a28a5f638c6955c39e257e1b/suite/components/places/PlacesUIUtils.jsm">annotate</a> |
<a href="/comm-central/diff/97c3890193980546a28a5f638c6955c39e257e1b/suite/components/places/PlacesUIUtils.jsm">diff</a> |
<a href="/comm-central/comparison/97c3890193980546a28a5f638c6955c39e257e1b/suite/components/places/PlacesUIUtils.jsm">comparison</a> |
<a href="/comm-central/log/97c3890193980546a28a5f638c6955c39e257e1b/suite/components/places/PlacesUIUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/97c3890193980546a28a5f638c6955c39e257e1b/suite/components/places/content/bookmarkProperties.js">suite/components/places/content/bookmarkProperties.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/97c3890193980546a28a5f638c6955c39e257e1b/suite/components/places/content/bookmarkProperties.js">file</a> |
<a href="/comm-central/annotate/97c3890193980546a28a5f638c6955c39e257e1b/suite/components/places/content/bookmarkProperties.js">annotate</a> |
<a href="/comm-central/diff/97c3890193980546a28a5f638c6955c39e257e1b/suite/components/places/content/bookmarkProperties.js">diff</a> |
<a href="/comm-central/comparison/97c3890193980546a28a5f638c6955c39e257e1b/suite/components/places/content/bookmarkProperties.js">comparison</a> |
<a href="/comm-central/log/97c3890193980546a28a5f638c6955c39e257e1b/suite/components/places/content/bookmarkProperties.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/97c3890193980546a28a5f638c6955c39e257e1b/suite/components/places/content/browserPlacesViews.js">suite/components/places/content/browserPlacesViews.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/97c3890193980546a28a5f638c6955c39e257e1b/suite/components/places/content/browserPlacesViews.js">file</a> |
<a href="/comm-central/annotate/97c3890193980546a28a5f638c6955c39e257e1b/suite/components/places/content/browserPlacesViews.js">annotate</a> |
<a href="/comm-central/diff/97c3890193980546a28a5f638c6955c39e257e1b/suite/components/places/content/browserPlacesViews.js">diff</a> |
<a href="/comm-central/comparison/97c3890193980546a28a5f638c6955c39e257e1b/suite/components/places/content/browserPlacesViews.js">comparison</a> |
<a href="/comm-central/log/97c3890193980546a28a5f638c6955c39e257e1b/suite/components/places/content/browserPlacesViews.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/97c3890193980546a28a5f638c6955c39e257e1b/suite/components/places/content/controller.js">suite/components/places/content/controller.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/97c3890193980546a28a5f638c6955c39e257e1b/suite/components/places/content/controller.js">file</a> |
<a href="/comm-central/annotate/97c3890193980546a28a5f638c6955c39e257e1b/suite/components/places/content/controller.js">annotate</a> |
<a href="/comm-central/diff/97c3890193980546a28a5f638c6955c39e257e1b/suite/components/places/content/controller.js">diff</a> |
<a href="/comm-central/comparison/97c3890193980546a28a5f638c6955c39e257e1b/suite/components/places/content/controller.js">comparison</a> |
<a href="/comm-central/log/97c3890193980546a28a5f638c6955c39e257e1b/suite/components/places/content/controller.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/97c3890193980546a28a5f638c6955c39e257e1b/suite/components/places/content/editBookmarkOverlay.js">suite/components/places/content/editBookmarkOverlay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/97c3890193980546a28a5f638c6955c39e257e1b/suite/components/places/content/editBookmarkOverlay.js">file</a> |
<a href="/comm-central/annotate/97c3890193980546a28a5f638c6955c39e257e1b/suite/components/places/content/editBookmarkOverlay.js">annotate</a> |
<a href="/comm-central/diff/97c3890193980546a28a5f638c6955c39e257e1b/suite/components/places/content/editBookmarkOverlay.js">diff</a> |
<a href="/comm-central/comparison/97c3890193980546a28a5f638c6955c39e257e1b/suite/components/places/content/editBookmarkOverlay.js">comparison</a> |
<a href="/comm-central/log/97c3890193980546a28a5f638c6955c39e257e1b/suite/components/places/content/editBookmarkOverlay.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/97c3890193980546a28a5f638c6955c39e257e1b/suite/components/places/content/menu.xml">suite/components/places/content/menu.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/97c3890193980546a28a5f638c6955c39e257e1b/suite/components/places/content/menu.xml">file</a> |
<a href="/comm-central/annotate/97c3890193980546a28a5f638c6955c39e257e1b/suite/components/places/content/menu.xml">annotate</a> |
<a href="/comm-central/diff/97c3890193980546a28a5f638c6955c39e257e1b/suite/components/places/content/menu.xml">diff</a> |
<a href="/comm-central/comparison/97c3890193980546a28a5f638c6955c39e257e1b/suite/components/places/content/menu.xml">comparison</a> |
<a href="/comm-central/log/97c3890193980546a28a5f638c6955c39e257e1b/suite/components/places/content/menu.xml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/97c3890193980546a28a5f638c6955c39e257e1b/suite/components/places/content/placesOverlay.xul">suite/components/places/content/placesOverlay.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/97c3890193980546a28a5f638c6955c39e257e1b/suite/components/places/content/placesOverlay.xul">file</a> |
<a href="/comm-central/annotate/97c3890193980546a28a5f638c6955c39e257e1b/suite/components/places/content/placesOverlay.xul">annotate</a> |
<a href="/comm-central/diff/97c3890193980546a28a5f638c6955c39e257e1b/suite/components/places/content/placesOverlay.xul">diff</a> |
<a href="/comm-central/comparison/97c3890193980546a28a5f638c6955c39e257e1b/suite/components/places/content/placesOverlay.xul">comparison</a> |
<a href="/comm-central/log/97c3890193980546a28a5f638c6955c39e257e1b/suite/components/places/content/placesOverlay.xul">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/97c3890193980546a28a5f638c6955c39e257e1b/suite/components/places/content/tree.xml">suite/components/places/content/tree.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/97c3890193980546a28a5f638c6955c39e257e1b/suite/components/places/content/tree.xml">file</a> |
<a href="/comm-central/annotate/97c3890193980546a28a5f638c6955c39e257e1b/suite/components/places/content/tree.xml">annotate</a> |
<a href="/comm-central/diff/97c3890193980546a28a5f638c6955c39e257e1b/suite/components/places/content/tree.xml">diff</a> |
<a href="/comm-central/comparison/97c3890193980546a28a5f638c6955c39e257e1b/suite/components/places/content/tree.xml">comparison</a> |
<a href="/comm-central/log/97c3890193980546a28a5f638c6955c39e257e1b/suite/components/places/content/tree.xml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/97c3890193980546a28a5f638c6955c39e257e1b/suite/components/places/content/treeView.js">suite/components/places/content/treeView.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/97c3890193980546a28a5f638c6955c39e257e1b/suite/components/places/content/treeView.js">file</a> |
<a href="/comm-central/annotate/97c3890193980546a28a5f638c6955c39e257e1b/suite/components/places/content/treeView.js">annotate</a> |
<a href="/comm-central/diff/97c3890193980546a28a5f638c6955c39e257e1b/suite/components/places/content/treeView.js">diff</a> |
<a href="/comm-central/comparison/97c3890193980546a28a5f638c6955c39e257e1b/suite/components/places/content/treeView.js">comparison</a> |
<a href="/comm-central/log/97c3890193980546a28a5f638c6955c39e257e1b/suite/components/places/content/treeView.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/suite/base/content/nsContextMenu.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/suite/base/content/nsContextMenu.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -9,35 +9,37 @@</span>
<a href="#l1.4"></a><span id="l1.4"> |                                                                              |</span>
<a href="#l1.5"></a><span id="l1.5"> |   For usage, see references to this class in navigator.xul.                  |</span>
<a href="#l1.6"></a><span id="l1.6"> |                                                                              |</span>
<a href="#l1.7"></a><span id="l1.7"> |   Currently, this code is relatively useless for any other purpose.  In the  |</span>
<a href="#l1.8"></a><span id="l1.8"> |   longer term, this code will be restructured to make it more reusable.      |</span>
<a href="#l1.9"></a><span id="l1.9"> ------------------------------------------------------------------------------*/</span>
<a href="#l1.10"></a><span id="l1.10"> </span>
<a href="#l1.11"></a><span id="l1.11"> ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l1.13"></a><span id="l1.13"> </span>
<a href="#l1.14"></a><span id="l1.14"> var gContextMenuContentData = null;</span>
<a href="#l1.15"></a><span id="l1.15"> </span>
<a href="#l1.16"></a><span id="l1.16"> XPCOMUtils.defineLazyGetter(this, &quot;InlineSpellCheckerUI&quot;, function() {</span>
<a href="#l1.17"></a><span id="l1.17">   let tmp = {};</span>
<a href="#l1.18"></a><span id="l1.18">   ChromeUtils.import(&quot;resource://gre/modules/InlineSpellChecker.jsm&quot;, tmp);</span>
<a href="#l1.19"></a><span id="l1.19">   return new tmp.InlineSpellChecker();</span>
<a href="#l1.20"></a><span id="l1.20"> });</span>
<a href="#l1.21"></a><span id="l1.21"> </span>
<a href="#l1.22"></a><span id="l1.22"> XPCOMUtils.defineLazyGetter(this, &quot;PageMenuParent&quot;, function() {</span>
<a href="#l1.23"></a><span id="l1.23">   let tmp = {};</span>
<a href="#l1.24"></a><span id="l1.24">   ChromeUtils.import(&quot;resource://gre/modules/PageMenu.jsm&quot;, tmp);</span>
<a href="#l1.25"></a><span id="l1.25">   return new tmp.PageMenuParent();</span>
<a href="#l1.26"></a><span id="l1.26"> });</span>
<a href="#l1.27"></a><span id="l1.27"> </span>
<a href="#l1.28"></a><span id="l1.28" class="difflineminus">-ChromeUtils.defineModuleGetter(this, &quot;DevToolsShim&quot;,</span>
<a href="#l1.29"></a><span id="l1.29" class="difflineminus">-  &quot;chrome://devtools-shim/content/DevToolsShim.jsm&quot;);</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineminus">-ChromeUtils.defineModuleGetter(this, &quot;findCssSelector&quot;,</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineminus">-  &quot;resource://gre/modules/css-selector.js&quot;);</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineplus">+XPCOMUtils.defineLazyModuleGetters(this, {</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineplus">+  DevToolsShim: &quot;chrome://devtools-shim/content/DevToolsShim.jsm&quot;,</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineplus">+  findCssSelector: &quot;resource://gre/modules/css-selector.js&quot;,</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineplus">+  NetUtil: &quot;resource://gre/modules/NetUtil.jsm&quot;,</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineplus">+});</span>
<a href="#l1.37"></a><span id="l1.37"> </span>
<a href="#l1.38"></a><span id="l1.38"> function nsContextMenu(aXulMenu, aIsShift, aEvent) {</span>
<a href="#l1.39"></a><span id="l1.39">   this.shouldDisplay = true;</span>
<a href="#l1.40"></a><span id="l1.40">   this.initMenu(aXulMenu, aIsShift, aEvent);</span>
<a href="#l1.41"></a><span id="l1.41"> }</span>
<a href="#l1.42"></a><span id="l1.42"> </span>
<a href="#l1.43"></a><span id="l1.43"> // Prototype for nsContextMenu &quot;class.&quot;</span>
<a href="#l1.44"></a><span id="l1.44"> nsContextMenu.prototype = {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/suite/browser/browser-places.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/suite/browser/browser-places.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -396,17 +396,17 @@ var PlacesCommandHook = {</span>
<a href="#l2.4"></a><span id="l2.4">       PlacesUIUtils.showBookmarkDialog({ action: &quot;edit&quot;, node },</span>
<a href="#l2.5"></a><span id="l2.5">                                        window.top);</span>
<a href="#l2.6"></a><span id="l2.6">       return;</span>
<a href="#l2.7"></a><span id="l2.7">     }</span>
<a href="#l2.8"></a><span id="l2.8"> </span>
<a href="#l2.9"></a><span id="l2.9">     let parentGuid = parentId == PlacesUtils.bookmarksMenuFolderId ?</span>
<a href="#l2.10"></a><span id="l2.10">                        PlacesUtils.bookmarks.menuGuid :</span>
<a href="#l2.11"></a><span id="l2.11">                        await PlacesUtils.promiseItemGuid(parentId);</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-    let defaultInsertionPoint = new InsertionPoint({ parentId, parentGuid });</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+    let defaultInsertionPoint = new PlacesInsertionPoint({ parentId, parentGuid });</span>
<a href="#l2.14"></a><span id="l2.14"> </span>
<a href="#l2.15"></a><span id="l2.15">     PlacesUIUtils.showBookmarkDialog({ action: &quot;add&quot;,</span>
<a href="#l2.16"></a><span id="l2.16">                                        type: &quot;bookmark&quot;,</span>
<a href="#l2.17"></a><span id="l2.17">                                        uri: makeURI(url),</span>
<a href="#l2.18"></a><span id="l2.18">                                        title,</span>
<a href="#l2.19"></a><span id="l2.19">                                        description,</span>
<a href="#l2.20"></a><span id="l2.20">                                        defaultInsertionPoint,</span>
<a href="#l2.21"></a><span id="l2.21">                                        hiddenRows: [ &quot;description&quot;,</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineat">@@ -476,17 +476,17 @@ var PlacesCommandHook = {</span>
<a href="#l2.23"></a><span id="l2.23">    * @param     url</span>
<a href="#l2.24"></a><span id="l2.24">    *            The nsIURI of the page the feed was attached to</span>
<a href="#l2.25"></a><span id="l2.25">    * @title     title</span>
<a href="#l2.26"></a><span id="l2.26">    *            The title of the feed. Optional.</span>
<a href="#l2.27"></a><span id="l2.27">    * @subtitle  subtitle</span>
<a href="#l2.28"></a><span id="l2.28">    *            A short description of the feed. Optional.</span>
<a href="#l2.29"></a><span id="l2.29">    */</span>
<a href="#l2.30"></a><span id="l2.30">   async addLiveBookmark(url, feedTitle, feedSubtitle) {</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineminus">-    let toolbarIP = new InsertionPoint({</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineplus">+    let toolbarIP = new PlacesInsertionPoint({</span>
<a href="#l2.33"></a><span id="l2.33">       parentId: PlacesUtils.toolbarFolderId,</span>
<a href="#l2.34"></a><span id="l2.34">       parentGuid: PlacesUtils.bookmarks.toolbarGuid</span>
<a href="#l2.35"></a><span id="l2.35">     });</span>
<a href="#l2.36"></a><span id="l2.36"> </span>
<a href="#l2.37"></a><span id="l2.37">     let feedURI = makeURI(url);</span>
<a href="#l2.38"></a><span id="l2.38">     let title = feedTitle || gBrowser.contentTitle;</span>
<a href="#l2.39"></a><span id="l2.39">     let description = feedSubtitle;</span>
<a href="#l2.40"></a><span id="l2.40">     if (!description) {</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineat">@@ -745,34 +745,34 @@ var PlacesMenuDNDHandler = {</span>
<a href="#l2.42"></a><span id="l2.42">   },</span>
<a href="#l2.43"></a><span id="l2.43"> </span>
<a href="#l2.44"></a><span id="l2.44">   /**</span>
<a href="#l2.45"></a><span id="l2.45">    * Called when the user drags over the &lt;menu&gt; element.</span>
<a href="#l2.46"></a><span id="l2.46">    * @param   event</span>
<a href="#l2.47"></a><span id="l2.47">    *          The DragOver event.</span>
<a href="#l2.48"></a><span id="l2.48">    */</span>
<a href="#l2.49"></a><span id="l2.49">   onDragOver: function PMDH_onDragOver(event) {</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineminus">-    let ip = new InsertionPoint({</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineplus">+    let ip = new PlacesInsertionPoint({</span>
<a href="#l2.52"></a><span id="l2.52">       parentId: PlacesUtils.bookmarksMenuFolderId,</span>
<a href="#l2.53"></a><span id="l2.53">       parentGuid: PlacesUtils.bookmarks.menuGuid</span>
<a href="#l2.54"></a><span id="l2.54">     });</span>
<a href="#l2.55"></a><span id="l2.55">     if (ip &amp;&amp; PlacesControllerDragHelper.canDrop(ip, event.dataTransfer))</span>
<a href="#l2.56"></a><span id="l2.56">       event.preventDefault();</span>
<a href="#l2.57"></a><span id="l2.57"> </span>
<a href="#l2.58"></a><span id="l2.58">     event.stopPropagation();</span>
<a href="#l2.59"></a><span id="l2.59">   },</span>
<a href="#l2.60"></a><span id="l2.60"> </span>
<a href="#l2.61"></a><span id="l2.61">   /**</span>
<a href="#l2.62"></a><span id="l2.62">    * Called when the user drops on the &lt;menu&gt; element.</span>
<a href="#l2.63"></a><span id="l2.63">    * @param   event</span>
<a href="#l2.64"></a><span id="l2.64">    *          The Drop event.</span>
<a href="#l2.65"></a><span id="l2.65">    */</span>
<a href="#l2.66"></a><span id="l2.66">   onDrop: function PMDH_onDrop(event) {</span>
<a href="#l2.67"></a><span id="l2.67">     // Put the item at the end of bookmark menu.</span>
<a href="#l2.68"></a><span id="l2.68" class="difflineminus">-    let ip = new InsertionPoint({</span>
<a href="#l2.69"></a><span id="l2.69" class="difflineplus">+    let ip = new PlacesInsertionPoint({</span>
<a href="#l2.70"></a><span id="l2.70">       parentId: PlacesUtils.bookmarksMenuFolderId,</span>
<a href="#l2.71"></a><span id="l2.71">       parentGuid: PlacesUtils.bookmarks.menuGuid</span>
<a href="#l2.72"></a><span id="l2.72">     });</span>
<a href="#l2.73"></a><span id="l2.73">     PlacesControllerDragHelper.onDrop(ip, event.dataTransfer);</span>
<a href="#l2.74"></a><span id="l2.74">     event.stopPropagation();</span>
<a href="#l2.75"></a><span id="l2.75">   }</span>
<a href="#l2.76"></a><span id="l2.76"> };</span>
<a href="#l2.77"></a><span id="l2.77"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/suite/browser/navigator.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/suite/browser/navigator.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -3,16 +3,17 @@</span>
<a href="#l3.4"></a><span id="l3.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l3.5"></a><span id="l3.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l3.6"></a><span id="l3.6"> </span>
<a href="#l3.7"></a><span id="l3.7"> ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l3.8"></a><span id="l3.8"> ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l3.9"></a><span id="l3.9"> ChromeUtils.import(&quot;resource:///modules/WindowsPreviewPerTab.jsm&quot;);</span>
<a href="#l3.10"></a><span id="l3.10"> </span>
<a href="#l3.11"></a><span id="l3.11"> XPCOMUtils.defineLazyModuleGetters(this, {</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+  NetUtil: &quot;resource://gre/modules/NetUtil.jsm&quot;,</span>
<a href="#l3.13"></a><span id="l3.13">   PluralForm: &quot;resource://gre/modules/PluralForm.jsm&quot;,</span>
<a href="#l3.14"></a><span id="l3.14">   PrivateBrowsingUtils: &quot;resource://gre/modules/PrivateBrowsingUtils.jsm&quot;,</span>
<a href="#l3.15"></a><span id="l3.15">   PromiseUtils: &quot;resource://gre/modules/PromiseUtils.jsm&quot;,</span>
<a href="#l3.16"></a><span id="l3.16">   SafeBrowsing: &quot;resource://gre/modules/SafeBrowsing.jsm&quot;,</span>
<a href="#l3.17"></a><span id="l3.17"> });</span>
<a href="#l3.18"></a><span id="l3.18"> </span>
<a href="#l3.19"></a><span id="l3.19"> XPCOMUtils.defineLazyScriptGetter(this, &quot;gEditItemOverlay&quot;,</span>
<a href="#l3.20"></a><span id="l3.20">                                   &quot;chrome://communicator/content/places/editBookmarkOverlay.js&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/suite/components/nsSuiteGlue.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/suite/components/nsSuiteGlue.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -19,16 +19,17 @@ XPCOMUtils.defineLazyModuleGetters(this,</span>
<a href="#l4.4"></a><span id="l4.4">   PlacesBackups: &quot;resource://gre/modules/PlacesBackups.jsm&quot;,</span>
<a href="#l4.5"></a><span id="l4.5">   AsyncShutdown: &quot;resource://gre/modules/AsyncShutdown.jsm&quot;,</span>
<a href="#l4.6"></a><span id="l4.6">   AutoCompletePopup: &quot;resource://gre/modules/AutoCompletePopup.jsm&quot;,</span>
<a href="#l4.7"></a><span id="l4.7">   BookmarkHTMLUtils: &quot;resource://gre/modules/BookmarkHTMLUtils.jsm&quot;,</span>
<a href="#l4.8"></a><span id="l4.8">   BookmarkJSONUtils: &quot;resource://gre/modules/BookmarkJSONUtils.jsm&quot;,</span>
<a href="#l4.9"></a><span id="l4.9">   RecentWindow: &quot;resource:///modules/RecentWindow.jsm&quot;,</span>
<a href="#l4.10"></a><span id="l4.10">   Sanitizer: &quot;resource:///modules/Sanitizer.jsm&quot;,</span>
<a href="#l4.11"></a><span id="l4.11">   DownloadsCommon: &quot;resource:///modules/DownloadsCommon.jsm&quot;,</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+  PrivateBrowsingUtils: &quot;resource://gre/modules/PrivateBrowsingUtils.jsm&quot;,</span>
<a href="#l4.13"></a><span id="l4.13"> });</span>
<a href="#l4.14"></a><span id="l4.14"> </span>
<a href="#l4.15"></a><span id="l4.15"> XPCOMUtils.defineLazyGetter(this, &quot;DebuggerServer&quot;, () =&gt; {</span>
<a href="#l4.16"></a><span id="l4.16">   var tmp = {};</span>
<a href="#l4.17"></a><span id="l4.17">   ChromeUtils.import(&quot;resource://devtools/shared/Loader.jsm&quot;, tmp);</span>
<a href="#l4.18"></a><span id="l4.18">   return tmp.require(&quot;devtools/server/main&quot;).DebuggerServer;</span>
<a href="#l4.19"></a><span id="l4.19"> });</span>
<a href="#l4.20"></a><span id="l4.20"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/suite/components/places/PlacesUIUtils.jsm</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/suite/components/places/PlacesUIUtils.jsm</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -253,71 +253,16 @@ var PlacesUIUtils = {</span>
<a href="#l5.4"></a><span id="l5.4">     });</span>
<a href="#l5.5"></a><span id="l5.5">   },</span>
<a href="#l5.6"></a><span id="l5.6"> </span>
<a href="#l5.7"></a><span id="l5.7">   getString: function PUIU_getString(key) {</span>
<a href="#l5.8"></a><span id="l5.8">     return bundle.GetStringFromName(key);</span>
<a href="#l5.9"></a><span id="l5.9">   },</span>
<a href="#l5.10"></a><span id="l5.10"> </span>
<a href="#l5.11"></a><span id="l5.11">   /**</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-   * Constructs a Places Transaction for the drop or paste of a blob of data</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineminus">-   * into a container.</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineminus">-   *</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineminus">-   * @param   aData</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineminus">-   *          The unwrapped data blob of dropped or pasted data.</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineminus">-   * @param   aNewParentGuid</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineminus">-   *          GUID of the container the data was dropped or pasted into.</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineminus">-   * @param   aIndex</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineminus">-   *          The index within the container the item was dropped or pasted at.</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineminus">-   * @param   aCopy</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineminus">-   *          The drag action was copy, so don't move folders or links.</span>
<a href="#l5.23"></a><span id="l5.23" class="difflineminus">-   *</span>
<a href="#l5.24"></a><span id="l5.24" class="difflineminus">-   * @return  a Places Transaction that can be transacted for performing the</span>
<a href="#l5.25"></a><span id="l5.25" class="difflineminus">-   *          move/insert command.</span>
<a href="#l5.26"></a><span id="l5.26" class="difflineminus">-   */</span>
<a href="#l5.27"></a><span id="l5.27" class="difflineminus">-  getTransactionForData(aData, aNewParentGuid, aIndex, aCopy) {</span>
<a href="#l5.28"></a><span id="l5.28" class="difflineminus">-    if (!this.SUPPORTED_FLAVORS.includes(aData.type))</span>
<a href="#l5.29"></a><span id="l5.29" class="difflineminus">-      throw new Error(`Unsupported '${aData.type}' data type`);</span>
<a href="#l5.30"></a><span id="l5.30" class="difflineminus">-</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineminus">-    if (&quot;itemGuid&quot; in aData &amp;&amp; &quot;instanceId&quot; in aData &amp;&amp;</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineminus">-        aData.instanceId == PlacesUtils.instanceId) {</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineminus">-      if (!this.PLACES_FLAVORS.includes(aData.type))</span>
<a href="#l5.34"></a><span id="l5.34" class="difflineminus">-        throw new Error(`itemGuid unexpectedly set on ${aData.type} data`);</span>
<a href="#l5.35"></a><span id="l5.35" class="difflineminus">-</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineminus">-      let info = { guid: aData.itemGuid,</span>
<a href="#l5.37"></a><span id="l5.37" class="difflineminus">-                   newParentGuid: aNewParentGuid,</span>
<a href="#l5.38"></a><span id="l5.38" class="difflineminus">-                   newIndex: aIndex };</span>
<a href="#l5.39"></a><span id="l5.39" class="difflineminus">-      if (aCopy) {</span>
<a href="#l5.40"></a><span id="l5.40" class="difflineminus">-        info.excludingAnnotation = &quot;Places/SmartBookmark&quot;;</span>
<a href="#l5.41"></a><span id="l5.41" class="difflineminus">-        return PlacesTransactions.Copy(info);</span>
<a href="#l5.42"></a><span id="l5.42" class="difflineminus">-      }</span>
<a href="#l5.43"></a><span id="l5.43" class="difflineminus">-      return PlacesTransactions.Move(info);</span>
<a href="#l5.44"></a><span id="l5.44" class="difflineminus">-    }</span>
<a href="#l5.45"></a><span id="l5.45" class="difflineminus">-</span>
<a href="#l5.46"></a><span id="l5.46" class="difflineminus">-    // Since it's cheap and harmless, we allow the paste of separators and</span>
<a href="#l5.47"></a><span id="l5.47" class="difflineminus">-    // bookmarks from builds that use legacy transactions (i.e. when itemGuid</span>
<a href="#l5.48"></a><span id="l5.48" class="difflineminus">-    // was not set on PLACES_FLAVORS data). Containers are a different story,</span>
<a href="#l5.49"></a><span id="l5.49" class="difflineminus">-    // and thus disallowed.</span>
<a href="#l5.50"></a><span id="l5.50" class="difflineminus">-    if (aData.type == PlacesUtils.TYPE_X_MOZ_PLACE_CONTAINER)</span>
<a href="#l5.51"></a><span id="l5.51" class="difflineminus">-      throw new Error(&quot;Can't copy a container from a legacy-transactions build&quot;);</span>
<a href="#l5.52"></a><span id="l5.52" class="difflineminus">-</span>
<a href="#l5.53"></a><span id="l5.53" class="difflineminus">-    if (aData.type == PlacesUtils.TYPE_X_MOZ_PLACE_SEPARATOR) {</span>
<a href="#l5.54"></a><span id="l5.54" class="difflineminus">-      return PlacesTransactions.NewSeparator({ parentGuid: aNewParentGuid,</span>
<a href="#l5.55"></a><span id="l5.55" class="difflineminus">-                                               index: aIndex });</span>
<a href="#l5.56"></a><span id="l5.56" class="difflineminus">-    }</span>
<a href="#l5.57"></a><span id="l5.57" class="difflineminus">-</span>
<a href="#l5.58"></a><span id="l5.58" class="difflineminus">-    let title = aData.type != PlacesUtils.TYPE_UNICODE ? aData.title</span>
<a href="#l5.59"></a><span id="l5.59" class="difflineminus">-                                                       : aData.uri;</span>
<a href="#l5.60"></a><span id="l5.60" class="difflineminus">-    return PlacesTransactions.NewBookmark({ url: Services.io.newURI(aData.uri),</span>
<a href="#l5.61"></a><span id="l5.61" class="difflineminus">-                                            title,</span>
<a href="#l5.62"></a><span id="l5.62" class="difflineminus">-                                            parentGuid: aNewParentGuid,</span>
<a href="#l5.63"></a><span id="l5.63" class="difflineminus">-                                            index: aIndex });</span>
<a href="#l5.64"></a><span id="l5.64" class="difflineminus">-  },</span>
<a href="#l5.65"></a><span id="l5.65" class="difflineminus">-</span>
<a href="#l5.66"></a><span id="l5.66" class="difflineminus">-  /**</span>
<a href="#l5.67"></a><span id="l5.67">    * Shows the bookmark dialog corresponding to the specified info.</span>
<a href="#l5.68"></a><span id="l5.68">    *</span>
<a href="#l5.69"></a><span id="l5.69">    * @param aInfo</span>
<a href="#l5.70"></a><span id="l5.70">    *        Describes the item to be edited/added in the dialog.</span>
<a href="#l5.71"></a><span id="l5.71">    *        See documentation at the top of bookmarkProperties.js</span>
<a href="#l5.72"></a><span id="l5.72">    * @param aWindow</span>
<a href="#l5.73"></a><span id="l5.73">    *        Owner window for the new dialog.</span>
<a href="#l5.74"></a><span id="l5.74">    *</span>
<a href="#l5.75"></a><span id="l5.75" class="difflineat">@@ -401,16 +346,87 @@ var PlacesUIUtils = {</span>
<a href="#l5.76"></a><span id="l5.76"> </span>
<a href="#l5.77"></a><span id="l5.77">       node = node.parentNode;</span>
<a href="#l5.78"></a><span id="l5.78">     }</span>
<a href="#l5.79"></a><span id="l5.79"> </span>
<a href="#l5.80"></a><span id="l5.80">     return null;</span>
<a href="#l5.81"></a><span id="l5.81">   },</span>
<a href="#l5.82"></a><span id="l5.82"> </span>
<a href="#l5.83"></a><span id="l5.83">   /**</span>
<a href="#l5.84"></a><span id="l5.84" class="difflineplus">+   * Returns the active PlacesController for a given command.</span>
<a href="#l5.85"></a><span id="l5.85" class="difflineplus">+   *</span>
<a href="#l5.86"></a><span id="l5.86" class="difflineplus">+   * @param win The window containing the affected view</span>
<a href="#l5.87"></a><span id="l5.87" class="difflineplus">+   * @param command The command</span>
<a href="#l5.88"></a><span id="l5.88" class="difflineplus">+   * @return a PlacesController</span>
<a href="#l5.89"></a><span id="l5.89" class="difflineplus">+   */</span>
<a href="#l5.90"></a><span id="l5.90" class="difflineplus">+  getControllerForCommand(win, command) {</span>
<a href="#l5.91"></a><span id="l5.91" class="difflineplus">+    // A context menu may be built for non-focusable views.  Thus, we first try</span>
<a href="#l5.92"></a><span id="l5.92" class="difflineplus">+    // to look for a view associated with document.popupNode</span>
<a href="#l5.93"></a><span id="l5.93" class="difflineplus">+    let popupNode;</span>
<a href="#l5.94"></a><span id="l5.94" class="difflineplus">+    try {</span>
<a href="#l5.95"></a><span id="l5.95" class="difflineplus">+      popupNode = win.document.popupNode;</span>
<a href="#l5.96"></a><span id="l5.96" class="difflineplus">+    } catch (e) {</span>
<a href="#l5.97"></a><span id="l5.97" class="difflineplus">+      // The document went away (bug 797307).</span>
<a href="#l5.98"></a><span id="l5.98" class="difflineplus">+      return null;</span>
<a href="#l5.99"></a><span id="l5.99" class="difflineplus">+    }</span>
<a href="#l5.100"></a><span id="l5.100" class="difflineplus">+    if (popupNode) {</span>
<a href="#l5.101"></a><span id="l5.101" class="difflineplus">+      let view = this.getViewForNode(popupNode);</span>
<a href="#l5.102"></a><span id="l5.102" class="difflineplus">+      if (view &amp;&amp; view._contextMenuShown)</span>
<a href="#l5.103"></a><span id="l5.103" class="difflineplus">+        return view.controllers.getControllerForCommand(command);</span>
<a href="#l5.104"></a><span id="l5.104" class="difflineplus">+    }</span>
<a href="#l5.105"></a><span id="l5.105" class="difflineplus">+</span>
<a href="#l5.106"></a><span id="l5.106" class="difflineplus">+    // When we're not building a context menu, only focusable views</span>
<a href="#l5.107"></a><span id="l5.107" class="difflineplus">+    // are possible.  Thus, we can safely use the command dispatcher.</span>
<a href="#l5.108"></a><span id="l5.108" class="difflineplus">+    let controller = win.top.document.commandDispatcher</span>
<a href="#l5.109"></a><span id="l5.109" class="difflineplus">+                        .getControllerForCommand(command);</span>
<a href="#l5.110"></a><span id="l5.110" class="difflineplus">+    return controller || null;</span>
<a href="#l5.111"></a><span id="l5.111" class="difflineplus">+  },</span>
<a href="#l5.112"></a><span id="l5.112" class="difflineplus">+</span>
<a href="#l5.113"></a><span id="l5.113" class="difflineplus">+  /**</span>
<a href="#l5.114"></a><span id="l5.114" class="difflineplus">+   * Update all the Places commands for the given window.</span>
<a href="#l5.115"></a><span id="l5.115" class="difflineplus">+   *</span>
<a href="#l5.116"></a><span id="l5.116" class="difflineplus">+   * @param win The window to update.</span>
<a href="#l5.117"></a><span id="l5.117" class="difflineplus">+   */</span>
<a href="#l5.118"></a><span id="l5.118" class="difflineplus">+  updateCommands(win) {</span>
<a href="#l5.119"></a><span id="l5.119" class="difflineplus">+    // Get the controller for one of the places commands.</span>
<a href="#l5.120"></a><span id="l5.120" class="difflineplus">+    let controller = this.getControllerForCommand(win, &quot;placesCmd_open&quot;);</span>
<a href="#l5.121"></a><span id="l5.121" class="difflineplus">+    for (let command of [</span>
<a href="#l5.122"></a><span id="l5.122" class="difflineplus">+      &quot;placesCmd_open&quot;,</span>
<a href="#l5.123"></a><span id="l5.123" class="difflineplus">+      &quot;placesCmd_open:window&quot;,</span>
<a href="#l5.124"></a><span id="l5.124" class="difflineplus">+      &quot;placesCmd_open:privatewindow&quot;,</span>
<a href="#l5.125"></a><span id="l5.125" class="difflineplus">+      &quot;placesCmd_open:tab&quot;,</span>
<a href="#l5.126"></a><span id="l5.126" class="difflineplus">+      &quot;placesCmd_new:folder&quot;,</span>
<a href="#l5.127"></a><span id="l5.127" class="difflineplus">+      &quot;placesCmd_new:bookmark&quot;,</span>
<a href="#l5.128"></a><span id="l5.128" class="difflineplus">+      &quot;placesCmd_new:separator&quot;,</span>
<a href="#l5.129"></a><span id="l5.129" class="difflineplus">+      &quot;placesCmd_show:info&quot;,</span>
<a href="#l5.130"></a><span id="l5.130" class="difflineplus">+      &quot;placesCmd_reload&quot;,</span>
<a href="#l5.131"></a><span id="l5.131" class="difflineplus">+      &quot;placesCmd_sortBy:name&quot;,</span>
<a href="#l5.132"></a><span id="l5.132" class="difflineplus">+      &quot;placesCmd_cut&quot;,</span>
<a href="#l5.133"></a><span id="l5.133" class="difflineplus">+      &quot;placesCmd_copy&quot;,</span>
<a href="#l5.134"></a><span id="l5.134" class="difflineplus">+      &quot;placesCmd_paste&quot;,</span>
<a href="#l5.135"></a><span id="l5.135" class="difflineplus">+      &quot;placesCmd_delete&quot;,</span>
<a href="#l5.136"></a><span id="l5.136" class="difflineplus">+    ]) {</span>
<a href="#l5.137"></a><span id="l5.137" class="difflineplus">+      win.goSetCommandEnabled(command,</span>
<a href="#l5.138"></a><span id="l5.138" class="difflineplus">+                              controller &amp;&amp; controller.isCommandEnabled(command));</span>
<a href="#l5.139"></a><span id="l5.139" class="difflineplus">+    }</span>
<a href="#l5.140"></a><span id="l5.140" class="difflineplus">+  },</span>
<a href="#l5.141"></a><span id="l5.141" class="difflineplus">+</span>
<a href="#l5.142"></a><span id="l5.142" class="difflineplus">+  /**</span>
<a href="#l5.143"></a><span id="l5.143" class="difflineplus">+   * Executes the given command on the currently active controller.</span>
<a href="#l5.144"></a><span id="l5.144" class="difflineplus">+   *</span>
<a href="#l5.145"></a><span id="l5.145" class="difflineplus">+   * @param win The window containing the affected view</span>
<a href="#l5.146"></a><span id="l5.146" class="difflineplus">+   * @param command The command to execute</span>
<a href="#l5.147"></a><span id="l5.147" class="difflineplus">+   */</span>
<a href="#l5.148"></a><span id="l5.148" class="difflineplus">+  doCommand(win, command) {</span>
<a href="#l5.149"></a><span id="l5.149" class="difflineplus">+    let controller = this.getControllerForCommand(win, command);</span>
<a href="#l5.150"></a><span id="l5.150" class="difflineplus">+    if (controller &amp;&amp; controller.isCommandEnabled(command))</span>
<a href="#l5.151"></a><span id="l5.151" class="difflineplus">+      controller.doCommand(command);</span>
<a href="#l5.152"></a><span id="l5.152" class="difflineplus">+  },</span>
<a href="#l5.153"></a><span id="l5.153" class="difflineplus">+</span>
<a href="#l5.154"></a><span id="l5.154" class="difflineplus">+  /**</span>
<a href="#l5.155"></a><span id="l5.155">    * By calling this before visiting an URL, the visit will be associated to a</span>
<a href="#l5.156"></a><span id="l5.156">    * TRANSITION_TYPED transition (if there is no a referrer).</span>
<a href="#l5.157"></a><span id="l5.157">    * This is used when visiting pages from the history menu, history sidebar,</span>
<a href="#l5.158"></a><span id="l5.158">    * url bar, url autocomplete results, and history searches from the places</span>
<a href="#l5.159"></a><span id="l5.159">    * organizer.  If this is not called visits will be marked as</span>
<a href="#l5.160"></a><span id="l5.160">    * TRANSITION_LINK.</span>
<a href="#l5.161"></a><span id="l5.161">    */</span>
<a href="#l5.162"></a><span id="l5.162">   markPageAsTyped: function PUIU_markPageAsTyped(aURL) {</span>
<a href="#l5.163"></a><span id="l5.163" class="difflineat">@@ -1222,34 +1238,264 @@ var PlacesUIUtils = {</span>
<a href="#l5.164"></a><span id="l5.164">     try {</span>
<a href="#l5.165"></a><span id="l5.165">       await functionToWrap();</span>
<a href="#l5.166"></a><span id="l5.166">     } finally {</span>
<a href="#l5.167"></a><span id="l5.167">       if (itemsBeingChanged &gt; ITEM_CHANGED_BATCH_NOTIFICATION_THRESHOLD) {</span>
<a href="#l5.168"></a><span id="l5.168">         resultNode.onEndUpdateBatch();</span>
<a href="#l5.169"></a><span id="l5.169">       }</span>
<a href="#l5.170"></a><span id="l5.170">     }</span>
<a href="#l5.171"></a><span id="l5.171">   },</span>
<a href="#l5.172"></a><span id="l5.172" class="difflineplus">+</span>
<a href="#l5.173"></a><span id="l5.173" class="difflineplus">+  /**</span>
<a href="#l5.174"></a><span id="l5.174" class="difflineplus">+   * Constructs a Places Transaction for the drop or paste of a blob of data</span>
<a href="#l5.175"></a><span id="l5.175" class="difflineplus">+   * into a container.</span>
<a href="#l5.176"></a><span id="l5.176" class="difflineplus">+   *</span>
<a href="#l5.177"></a><span id="l5.177" class="difflineplus">+   * @param   aData</span>
<a href="#l5.178"></a><span id="l5.178" class="difflineplus">+   *          The unwrapped data blob of dropped or pasted data.</span>
<a href="#l5.179"></a><span id="l5.179" class="difflineplus">+   * @param   aNewParentGuid</span>
<a href="#l5.180"></a><span id="l5.180" class="difflineplus">+   *          GUID of the container the data was dropped or pasted into.</span>
<a href="#l5.181"></a><span id="l5.181" class="difflineplus">+   * @param   aIndex</span>
<a href="#l5.182"></a><span id="l5.182" class="difflineplus">+   *          The index within the container the item was dropped or pasted at.</span>
<a href="#l5.183"></a><span id="l5.183" class="difflineplus">+   * @param   aCopy</span>
<a href="#l5.184"></a><span id="l5.184" class="difflineplus">+   *          The drag action was copy, so don't move folders or links.</span>
<a href="#l5.185"></a><span id="l5.185" class="difflineplus">+   *</span>
<a href="#l5.186"></a><span id="l5.186" class="difflineplus">+   * @return  a Places Transaction that can be transacted for performing the</span>
<a href="#l5.187"></a><span id="l5.187" class="difflineplus">+   *          move/insert command.</span>
<a href="#l5.188"></a><span id="l5.188" class="difflineplus">+   */</span>
<a href="#l5.189"></a><span id="l5.189" class="difflineplus">+  getTransactionForData(aData, aNewParentGuid, aIndex, aCopy) {</span>
<a href="#l5.190"></a><span id="l5.190" class="difflineplus">+    if (!this.SUPPORTED_FLAVORS.includes(aData.type))</span>
<a href="#l5.191"></a><span id="l5.191" class="difflineplus">+      throw new Error(`Unsupported '${aData.type}' data type`);</span>
<a href="#l5.192"></a><span id="l5.192" class="difflineplus">+</span>
<a href="#l5.193"></a><span id="l5.193" class="difflineplus">+    if (&quot;itemGuid&quot; in aData &amp;&amp; &quot;instanceId&quot; in aData &amp;&amp;</span>
<a href="#l5.194"></a><span id="l5.194" class="difflineplus">+        aData.instanceId == PlacesUtils.instanceId) {</span>
<a href="#l5.195"></a><span id="l5.195" class="difflineplus">+      if (!this.PLACES_FLAVORS.includes(aData.type))</span>
<a href="#l5.196"></a><span id="l5.196" class="difflineplus">+        throw new Error(`itemGuid unexpectedly set on ${aData.type} data`);</span>
<a href="#l5.197"></a><span id="l5.197" class="difflineplus">+</span>
<a href="#l5.198"></a><span id="l5.198" class="difflineplus">+      let info = { guid: aData.itemGuid,</span>
<a href="#l5.199"></a><span id="l5.199" class="difflineplus">+                   newParentGuid: aNewParentGuid,</span>
<a href="#l5.200"></a><span id="l5.200" class="difflineplus">+                   newIndex: aIndex };</span>
<a href="#l5.201"></a><span id="l5.201" class="difflineplus">+      if (aCopy) {</span>
<a href="#l5.202"></a><span id="l5.202" class="difflineplus">+        info.excludingAnnotation = &quot;Places/SmartBookmark&quot;;</span>
<a href="#l5.203"></a><span id="l5.203" class="difflineplus">+        return PlacesTransactions.Copy(info);</span>
<a href="#l5.204"></a><span id="l5.204" class="difflineplus">+      }</span>
<a href="#l5.205"></a><span id="l5.205" class="difflineplus">+      return PlacesTransactions.Move(info);</span>
<a href="#l5.206"></a><span id="l5.206" class="difflineplus">+    }</span>
<a href="#l5.207"></a><span id="l5.207" class="difflineplus">+</span>
<a href="#l5.208"></a><span id="l5.208" class="difflineplus">+    // Since it's cheap and harmless, we allow the paste of separators and</span>
<a href="#l5.209"></a><span id="l5.209" class="difflineplus">+    // bookmarks from builds that use legacy transactions (i.e. when itemGuid</span>
<a href="#l5.210"></a><span id="l5.210" class="difflineplus">+    // was not set on PLACES_FLAVORS data). Containers are a different story,</span>
<a href="#l5.211"></a><span id="l5.211" class="difflineplus">+    // and thus disallowed.</span>
<a href="#l5.212"></a><span id="l5.212" class="difflineplus">+    if (aData.type == PlacesUtils.TYPE_X_MOZ_PLACE_CONTAINER)</span>
<a href="#l5.213"></a><span id="l5.213" class="difflineplus">+      throw new Error(&quot;Can't copy a container from a legacy-transactions build&quot;);</span>
<a href="#l5.214"></a><span id="l5.214" class="difflineplus">+</span>
<a href="#l5.215"></a><span id="l5.215" class="difflineplus">+    if (aData.type == PlacesUtils.TYPE_X_MOZ_PLACE_SEPARATOR) {</span>
<a href="#l5.216"></a><span id="l5.216" class="difflineplus">+      return PlacesTransactions.NewSeparator({ parentGuid: aNewParentGuid,</span>
<a href="#l5.217"></a><span id="l5.217" class="difflineplus">+                                               index: aIndex });</span>
<a href="#l5.218"></a><span id="l5.218" class="difflineplus">+    }</span>
<a href="#l5.219"></a><span id="l5.219" class="difflineplus">+</span>
<a href="#l5.220"></a><span id="l5.220" class="difflineplus">+    let title = aData.type != PlacesUtils.TYPE_UNICODE ? aData.title</span>
<a href="#l5.221"></a><span id="l5.221" class="difflineplus">+                                                       : aData.uri;</span>
<a href="#l5.222"></a><span id="l5.222" class="difflineplus">+    return PlacesTransactions.NewBookmark({ url: Services.io.newURI(aData.uri),</span>
<a href="#l5.223"></a><span id="l5.223" class="difflineplus">+                                            title,</span>
<a href="#l5.224"></a><span id="l5.224" class="difflineplus">+                                            parentGuid: aNewParentGuid,</span>
<a href="#l5.225"></a><span id="l5.225" class="difflineplus">+                                            index: aIndex });</span>
<a href="#l5.226"></a><span id="l5.226" class="difflineplus">+  },</span>
<a href="#l5.227"></a><span id="l5.227" class="difflineplus">+</span>
<a href="#l5.228"></a><span id="l5.228" class="difflineplus">+  /**</span>
<a href="#l5.229"></a><span id="l5.229" class="difflineplus">+   * Processes a set of transfer items that have been dropped or pasted.</span>
<a href="#l5.230"></a><span id="l5.230" class="difflineplus">+   * Batching will be applied where necessary.</span>
<a href="#l5.231"></a><span id="l5.231" class="difflineplus">+   *</span>
<a href="#l5.232"></a><span id="l5.232" class="difflineplus">+   * @param {Array} items A list of unwrapped nodes to process.</span>
<a href="#l5.233"></a><span id="l5.233" class="difflineplus">+   * @param {Object} insertionPoint The requested point for insertion.</span>
<a href="#l5.234"></a><span id="l5.234" class="difflineplus">+   * @param {Boolean} doCopy Set to true to copy the items, false will move them</span>
<a href="#l5.235"></a><span id="l5.235" class="difflineplus">+   *                         if possible.</span>
<a href="#l5.236"></a><span id="l5.236" class="difflineplus">+   * @paramt {Object} view The view that should be used for batching.</span>
<a href="#l5.237"></a><span id="l5.237" class="difflineplus">+   * @return {Array} Returns an empty array when the insertion point is a tag, else</span>
<a href="#l5.238"></a><span id="l5.238" class="difflineplus">+   *                 returns an array of copied or moved guids.</span>
<a href="#l5.239"></a><span id="l5.239" class="difflineplus">+   */</span>
<a href="#l5.240"></a><span id="l5.240" class="difflineplus">+  async handleTransferItems(items, insertionPoint, doCopy, view) {</span>
<a href="#l5.241"></a><span id="l5.241" class="difflineplus">+    let transactions;</span>
<a href="#l5.242"></a><span id="l5.242" class="difflineplus">+    let itemsCount;</span>
<a href="#l5.243"></a><span id="l5.243" class="difflineplus">+    if (insertionPoint.isTag) {</span>
<a href="#l5.244"></a><span id="l5.244" class="difflineplus">+      let urls = items.filter(item =&gt; &quot;uri&quot; in item).map(item =&gt; item.uri);</span>
<a href="#l5.245"></a><span id="l5.245" class="difflineplus">+      itemsCount = urls.length;</span>
<a href="#l5.246"></a><span id="l5.246" class="difflineplus">+      transactions = [PlacesTransactions.Tag({ urls, tag: insertionPoint.tagName })];</span>
<a href="#l5.247"></a><span id="l5.247" class="difflineplus">+    } else {</span>
<a href="#l5.248"></a><span id="l5.248" class="difflineplus">+      let insertionIndex = await insertionPoint.getIndex();</span>
<a href="#l5.249"></a><span id="l5.249" class="difflineplus">+      itemsCount = items.length;</span>
<a href="#l5.250"></a><span id="l5.250" class="difflineplus">+      transactions = await getTransactionsForTransferItems(</span>
<a href="#l5.251"></a><span id="l5.251" class="difflineplus">+        items, insertionIndex, insertionPoint.guid, doCopy);</span>
<a href="#l5.252"></a><span id="l5.252" class="difflineplus">+    }</span>
<a href="#l5.253"></a><span id="l5.253" class="difflineplus">+</span>
<a href="#l5.254"></a><span id="l5.254" class="difflineplus">+    // Check if we actually have something to add, if we don't it probably wasn't</span>
<a href="#l5.255"></a><span id="l5.255" class="difflineplus">+    // valid, or it was moving to the same location, so just ignore it.</span>
<a href="#l5.256"></a><span id="l5.256" class="difflineplus">+    if (!transactions.length) {</span>
<a href="#l5.257"></a><span id="l5.257" class="difflineplus">+      return [];</span>
<a href="#l5.258"></a><span id="l5.258" class="difflineplus">+    }</span>
<a href="#l5.259"></a><span id="l5.259" class="difflineplus">+</span>
<a href="#l5.260"></a><span id="l5.260" class="difflineplus">+    let guidsToSelect = [];</span>
<a href="#l5.261"></a><span id="l5.261" class="difflineplus">+    let resultForBatching = getResultForBatching(view);</span>
<a href="#l5.262"></a><span id="l5.262" class="difflineplus">+</span>
<a href="#l5.263"></a><span id="l5.263" class="difflineplus">+    // If we're inserting into a tag, we don't get the guid, so we'll just</span>
<a href="#l5.264"></a><span id="l5.264" class="difflineplus">+    // pass the transactions direct to the batch function.</span>
<a href="#l5.265"></a><span id="l5.265" class="difflineplus">+    let batchingItem = transactions;</span>
<a href="#l5.266"></a><span id="l5.266" class="difflineplus">+    if (!insertionPoint.isTag) {</span>
<a href="#l5.267"></a><span id="l5.267" class="difflineplus">+      // If we're not a tag, then we need to get the ids of the items to select.</span>
<a href="#l5.268"></a><span id="l5.268" class="difflineplus">+      batchingItem = async () =&gt; {</span>
<a href="#l5.269"></a><span id="l5.269" class="difflineplus">+        for (let transaction of transactions) {</span>
<a href="#l5.270"></a><span id="l5.270" class="difflineplus">+          let guid = await transaction.transact();</span>
<a href="#l5.271"></a><span id="l5.271" class="difflineplus">+          if (guid) {</span>
<a href="#l5.272"></a><span id="l5.272" class="difflineplus">+            guidsToSelect.push(guid);</span>
<a href="#l5.273"></a><span id="l5.273" class="difflineplus">+          }</span>
<a href="#l5.274"></a><span id="l5.274" class="difflineplus">+        }</span>
<a href="#l5.275"></a><span id="l5.275" class="difflineplus">+      };</span>
<a href="#l5.276"></a><span id="l5.276" class="difflineplus">+    }</span>
<a href="#l5.277"></a><span id="l5.277" class="difflineplus">+</span>
<a href="#l5.278"></a><span id="l5.278" class="difflineplus">+    await this.batchUpdatesForNode(resultForBatching, itemsCount, async () =&gt; {</span>
<a href="#l5.279"></a><span id="l5.279" class="difflineplus">+      await PlacesTransactions.batch(batchingItem);</span>
<a href="#l5.280"></a><span id="l5.280" class="difflineplus">+    });</span>
<a href="#l5.281"></a><span id="l5.281" class="difflineplus">+</span>
<a href="#l5.282"></a><span id="l5.282" class="difflineplus">+    return guidsToSelect;</span>
<a href="#l5.283"></a><span id="l5.283" class="difflineplus">+  },</span>
<a href="#l5.284"></a><span id="l5.284"> };</span>
<a href="#l5.285"></a><span id="l5.285"> </span>
<a href="#l5.286"></a><span id="l5.286" class="difflineminus">-</span>
<a href="#l5.287"></a><span id="l5.287" class="difflineminus">-PlacesUIUtils.PLACES_FLAVORS = [PlacesUtils.TYPE_X_MOZ_PLACE_CONTAINER,</span>
<a href="#l5.288"></a><span id="l5.288" class="difflineminus">-                                PlacesUtils.TYPE_X_MOZ_PLACE_SEPARATOR,</span>
<a href="#l5.289"></a><span id="l5.289" class="difflineminus">-                                PlacesUtils.TYPE_X_MOZ_PLACE];</span>
<a href="#l5.290"></a><span id="l5.290" class="difflineminus">-</span>
<a href="#l5.291"></a><span id="l5.291" class="difflineminus">-PlacesUIUtils.URI_FLAVORS = [PlacesUtils.TYPE_X_MOZ_URL,</span>
<a href="#l5.292"></a><span id="l5.292" class="difflineminus">-                             TAB_DROP_TYPE,</span>
<a href="#l5.293"></a><span id="l5.293" class="difflineminus">-                             PlacesUtils.TYPE_UNICODE],</span>
<a href="#l5.294"></a><span id="l5.294" class="difflineminus">-</span>
<a href="#l5.295"></a><span id="l5.295" class="difflineminus">-PlacesUIUtils.SUPPORTED_FLAVORS = [...PlacesUIUtils.PLACES_FLAVORS,</span>
<a href="#l5.296"></a><span id="l5.296" class="difflineminus">-                                   ...PlacesUIUtils.URI_FLAVORS];</span>
<a href="#l5.297"></a><span id="l5.297" class="difflineplus">+// These are lazy getters to avoid importing PlacesUtils immediately.</span>
<a href="#l5.298"></a><span id="l5.298" class="difflineplus">+XPCOMUtils.defineLazyGetter(PlacesUIUtils, &quot;PLACES_FLAVORS&quot;, () =&gt; {</span>
<a href="#l5.299"></a><span id="l5.299" class="difflineplus">+  return [PlacesUtils.TYPE_X_MOZ_PLACE_CONTAINER,</span>
<a href="#l5.300"></a><span id="l5.300" class="difflineplus">+          PlacesUtils.TYPE_X_MOZ_PLACE_SEPARATOR,</span>
<a href="#l5.301"></a><span id="l5.301" class="difflineplus">+          PlacesUtils.TYPE_X_MOZ_PLACE];</span>
<a href="#l5.302"></a><span id="l5.302" class="difflineplus">+});</span>
<a href="#l5.303"></a><span id="l5.303" class="difflineplus">+XPCOMUtils.defineLazyGetter(PlacesUIUtils, &quot;URI_FLAVORS&quot;, () =&gt; {</span>
<a href="#l5.304"></a><span id="l5.304" class="difflineplus">+  return [PlacesUtils.TYPE_X_MOZ_URL,</span>
<a href="#l5.305"></a><span id="l5.305" class="difflineplus">+          TAB_DROP_TYPE,</span>
<a href="#l5.306"></a><span id="l5.306" class="difflineplus">+          PlacesUtils.TYPE_UNICODE];</span>
<a href="#l5.307"></a><span id="l5.307" class="difflineplus">+});</span>
<a href="#l5.308"></a><span id="l5.308" class="difflineplus">+XPCOMUtils.defineLazyGetter(PlacesUIUtils, &quot;SUPPORTED_FLAVORS&quot;, () =&gt; {</span>
<a href="#l5.309"></a><span id="l5.309" class="difflineplus">+  return [...PlacesUIUtils.PLACES_FLAVORS,</span>
<a href="#l5.310"></a><span id="l5.310" class="difflineplus">+          ...PlacesUIUtils.URI_FLAVORS];</span>
<a href="#l5.311"></a><span id="l5.311" class="difflineplus">+});</span>
<a href="#l5.312"></a><span id="l5.312"> </span>
<a href="#l5.313"></a><span id="l5.313"> XPCOMUtils.defineLazyGetter(PlacesUIUtils, &quot;ellipsis&quot;, function() {</span>
<a href="#l5.314"></a><span id="l5.314">   return Services.prefs.getComplexValue(&quot;intl.ellipsis&quot;,</span>
<a href="#l5.315"></a><span id="l5.315">                                         Ci.nsIPrefLocalizedString).data;</span>
<a href="#l5.316"></a><span id="l5.316"> });</span>
<a href="#l5.317"></a><span id="l5.317"> </span>
<a href="#l5.318"></a><span id="l5.318"> XPCOMUtils.defineLazyServiceGetter(this, &quot;focusManager&quot;,</span>
<a href="#l5.319"></a><span id="l5.319">                                    &quot;@mozilla.org/focus-manager;1&quot;,</span>
<a href="#l5.320"></a><span id="l5.320">                                    &quot;nsIFocusManager&quot;);</span>
<a href="#l5.321"></a><span id="l5.321"> XPCOMUtils.defineLazyPreferenceGetter(PlacesUIUtils, &quot;loadBookmarksInBackground&quot;,</span>
<a href="#l5.322"></a><span id="l5.322">                                       PREF_LOAD_BOOKMARKS_IN_BACKGROUND, false);</span>
<a href="#l5.323"></a><span id="l5.323"> XPCOMUtils.defineLazyPreferenceGetter(PlacesUIUtils, &quot;loadBookmarksInTabs&quot;,</span>
<a href="#l5.324"></a><span id="l5.324">                                       PREF_LOAD_BOOKMARKS_IN_TABS, false);</span>
<a href="#l5.325"></a><span id="l5.325" class="difflineplus">+</span>
<a href="#l5.326"></a><span id="l5.326" class="difflineplus">+/**</span>
<a href="#l5.327"></a><span id="l5.327" class="difflineplus">+ * Determines if an unwrapped node can be moved.</span>
<a href="#l5.328"></a><span id="l5.328" class="difflineplus">+ *</span>
<a href="#l5.329"></a><span id="l5.329" class="difflineplus">+ * @param unwrappedNode</span>
<a href="#l5.330"></a><span id="l5.330" class="difflineplus">+ *        A node unwrapped by PlacesUtils.unwrapNodes().</span>
<a href="#l5.331"></a><span id="l5.331" class="difflineplus">+ * @return True if the node can be moved, false otherwise.</span>
<a href="#l5.332"></a><span id="l5.332" class="difflineplus">+ */</span>
<a href="#l5.333"></a><span id="l5.333" class="difflineplus">+function canMoveUnwrappedNode(unwrappedNode) {</span>
<a href="#l5.334"></a><span id="l5.334" class="difflineplus">+  if ((unwrappedNode.concreteGuid &amp;&amp; PlacesUtils.isRootItem(unwrappedNode.concreteGuid)) ||</span>
<a href="#l5.335"></a><span id="l5.335" class="difflineplus">+      unwrappedNode.id &lt;= 0 || PlacesUtils.isRootItem(unwrappedNode.id)) {</span>
<a href="#l5.336"></a><span id="l5.336" class="difflineplus">+    return false;</span>
<a href="#l5.337"></a><span id="l5.337" class="difflineplus">+  }</span>
<a href="#l5.338"></a><span id="l5.338" class="difflineplus">+</span>
<a href="#l5.339"></a><span id="l5.339" class="difflineplus">+  let parentGuid = unwrappedNode.parentGuid;</span>
<a href="#l5.340"></a><span id="l5.340" class="difflineplus">+  // If there's no parent Guid, this was likely a virtual query that returns</span>
<a href="#l5.341"></a><span id="l5.341" class="difflineplus">+  // bookmarks, such as a tags query.</span>
<a href="#l5.342"></a><span id="l5.342" class="difflineplus">+  if (!parentGuid ||</span>
<a href="#l5.343"></a><span id="l5.343" class="difflineplus">+      parentGuid == PlacesUtils.bookmarks.rootGuid) {</span>
<a href="#l5.344"></a><span id="l5.344" class="difflineplus">+    return false;</span>
<a href="#l5.345"></a><span id="l5.345" class="difflineplus">+  }</span>
<a href="#l5.346"></a><span id="l5.346" class="difflineplus">+  // leftPaneFolderId and allBookmarksFolderId are lazy getters running</span>
<a href="#l5.347"></a><span id="l5.347" class="difflineplus">+  // at least a synchronous DB query. Therefore we don't want to invoke</span>
<a href="#l5.348"></a><span id="l5.348" class="difflineplus">+  // them first, especially because isCommandEnabled may be called way</span>
<a href="#l5.349"></a><span id="l5.349" class="difflineplus">+  // before the left pane folder is even necessary.</span>
<a href="#l5.350"></a><span id="l5.350" class="difflineplus">+  if (typeof Object.getOwnPropertyDescriptor(PlacesUIUtils, &quot;leftPaneFolderId&quot;).get != &quot;function&quot; &amp;&amp;</span>
<a href="#l5.351"></a><span id="l5.351" class="difflineplus">+      (unwrappedNode.parent == PlacesUIUtils.leftPaneFolderId)) {</span>
<a href="#l5.352"></a><span id="l5.352" class="difflineplus">+    return false;</span>
<a href="#l5.353"></a><span id="l5.353" class="difflineplus">+  }</span>
<a href="#l5.354"></a><span id="l5.354" class="difflineplus">+  return true;</span>
<a href="#l5.355"></a><span id="l5.355" class="difflineplus">+}</span>
<a href="#l5.356"></a><span id="l5.356" class="difflineplus">+</span>
<a href="#l5.357"></a><span id="l5.357" class="difflineplus">+/**</span>
<a href="#l5.358"></a><span id="l5.358" class="difflineplus">+ * This gets the most appropriate item for using for batching. In the case of multiple</span>
<a href="#l5.359"></a><span id="l5.359" class="difflineplus">+ * views being related, the method returns the most expensive result to batch.</span>
<a href="#l5.360"></a><span id="l5.360" class="difflineplus">+ * For example, if it detects the left-hand library pane, then it will look for</span>
<a href="#l5.361"></a><span id="l5.361" class="difflineplus">+ * and return the reference to the right-hand pane.</span>
<a href="#l5.362"></a><span id="l5.362" class="difflineplus">+ *</span>
<a href="#l5.363"></a><span id="l5.363" class="difflineplus">+ * @param {Object} viewOrElement The item to check.</span>
<a href="#l5.364"></a><span id="l5.364" class="difflineplus">+ * @return {Object} Will return the best result node to batch, or null</span>
<a href="#l5.365"></a><span id="l5.365" class="difflineplus">+ *                  if one could not be found.</span>
<a href="#l5.366"></a><span id="l5.366" class="difflineplus">+ */</span>
<a href="#l5.367"></a><span id="l5.367" class="difflineplus">+function getResultForBatching(viewOrElement) {</span>
<a href="#l5.368"></a><span id="l5.368" class="difflineplus">+  if (viewOrElement &amp;&amp; Element.isInstance(viewOrElement) &amp;&amp;</span>
<a href="#l5.369"></a><span id="l5.369" class="difflineplus">+      viewOrElement.id === &quot;placesList&quot;) {</span>
<a href="#l5.370"></a><span id="l5.370" class="difflineplus">+    // Note: fall back to the existing item if we can't find the right-hane pane.</span>
<a href="#l5.371"></a><span id="l5.371" class="difflineplus">+    viewOrElement = viewOrElement.ownerDocument.getElementById(&quot;placeContent&quot;) || viewOrElement;</span>
<a href="#l5.372"></a><span id="l5.372" class="difflineplus">+  }</span>
<a href="#l5.373"></a><span id="l5.373" class="difflineplus">+</span>
<a href="#l5.374"></a><span id="l5.374" class="difflineplus">+  if (viewOrElement &amp;&amp; viewOrElement.result) {</span>
<a href="#l5.375"></a><span id="l5.375" class="difflineplus">+    return viewOrElement.result;</span>
<a href="#l5.376"></a><span id="l5.376" class="difflineplus">+  }</span>
<a href="#l5.377"></a><span id="l5.377" class="difflineplus">+</span>
<a href="#l5.378"></a><span id="l5.378" class="difflineplus">+  return null;</span>
<a href="#l5.379"></a><span id="l5.379" class="difflineplus">+}</span>
<a href="#l5.380"></a><span id="l5.380" class="difflineplus">+</span>
<a href="#l5.381"></a><span id="l5.381" class="difflineplus">+/**</span>
<a href="#l5.382"></a><span id="l5.382" class="difflineplus">+ * Processes a set of transfer items and returns transactions to insert or</span>
<a href="#l5.383"></a><span id="l5.383" class="difflineplus">+ * move them.</span>
<a href="#l5.384"></a><span id="l5.384" class="difflineplus">+ *</span>
<a href="#l5.385"></a><span id="l5.385" class="difflineplus">+ * @param {Array} items A list of unwrapped nodes to get transactions for.</span>
<a href="#l5.386"></a><span id="l5.386" class="difflineplus">+ * @param {Integer} insertionIndex The requested index for insertion.</span>
<a href="#l5.387"></a><span id="l5.387" class="difflineplus">+ * @param {String} insertionParentGuid The guid of the parent folder to insert</span>
<a href="#l5.388"></a><span id="l5.388" class="difflineplus">+ *                                     or move the items to.</span>
<a href="#l5.389"></a><span id="l5.389" class="difflineplus">+ * @param {Boolean} doCopy Set to true to copy the items, false will move them</span>
<a href="#l5.390"></a><span id="l5.390" class="difflineplus">+ *                         if possible.</span>
<a href="#l5.391"></a><span id="l5.391" class="difflineplus">+ * @return {Array} Returns an array of created PlacesTransactions.</span>
<a href="#l5.392"></a><span id="l5.392" class="difflineplus">+ */</span>
<a href="#l5.393"></a><span id="l5.393" class="difflineplus">+async function getTransactionsForTransferItems(items, insertionIndex,</span>
<a href="#l5.394"></a><span id="l5.394" class="difflineplus">+                                               insertionParentGuid, doCopy) {</span>
<a href="#l5.395"></a><span id="l5.395" class="difflineplus">+  let transactions = [];</span>
<a href="#l5.396"></a><span id="l5.396" class="difflineplus">+  let index = insertionIndex;</span>
<a href="#l5.397"></a><span id="l5.397" class="difflineplus">+</span>
<a href="#l5.398"></a><span id="l5.398" class="difflineplus">+  for (let item of items) {</span>
<a href="#l5.399"></a><span id="l5.399" class="difflineplus">+    if (index != -1 &amp;&amp; item.itemGuid) {</span>
<a href="#l5.400"></a><span id="l5.400" class="difflineplus">+      // Note: we use the parent from the existing bookmark as the sidebar</span>
<a href="#l5.401"></a><span id="l5.401" class="difflineplus">+      // gives us an unwrapped.parent that is actually a query and not the real</span>
<a href="#l5.402"></a><span id="l5.402" class="difflineplus">+      // parent.</span>
<a href="#l5.403"></a><span id="l5.403" class="difflineplus">+      let existingBookmark = await PlacesUtils.bookmarks.fetch(item.itemGuid);</span>
<a href="#l5.404"></a><span id="l5.404" class="difflineplus">+</span>
<a href="#l5.405"></a><span id="l5.405" class="difflineplus">+      // If we're dropping on the same folder, then we may need to adjust</span>
<a href="#l5.406"></a><span id="l5.406" class="difflineplus">+      // the index to insert at the correct place.</span>
<a href="#l5.407"></a><span id="l5.407" class="difflineplus">+      if (existingBookmark &amp;&amp; insertionParentGuid == existingBookmark.parentGuid) {</span>
<a href="#l5.408"></a><span id="l5.408" class="difflineplus">+        if (index &gt; existingBookmark.index) {</span>
<a href="#l5.409"></a><span id="l5.409" class="difflineplus">+          // If we're dragging down, we need to go one lower to insert at</span>
<a href="#l5.410"></a><span id="l5.410" class="difflineplus">+          // the real point as moving the element changes the index of</span>
<a href="#l5.411"></a><span id="l5.411" class="difflineplus">+          // everything below by 1.</span>
<a href="#l5.412"></a><span id="l5.412" class="difflineplus">+          index--;</span>
<a href="#l5.413"></a><span id="l5.413" class="difflineplus">+        } else if (index == existingBookmark.index) {</span>
<a href="#l5.414"></a><span id="l5.414" class="difflineplus">+          // This isn't moving so we skip it.</span>
<a href="#l5.415"></a><span id="l5.415" class="difflineplus">+          continue;</span>
<a href="#l5.416"></a><span id="l5.416" class="difflineplus">+        }</span>
<a href="#l5.417"></a><span id="l5.417" class="difflineplus">+      }</span>
<a href="#l5.418"></a><span id="l5.418" class="difflineplus">+    }</span>
<a href="#l5.419"></a><span id="l5.419" class="difflineplus">+</span>
<a href="#l5.420"></a><span id="l5.420" class="difflineplus">+    // If this is not a copy, check for safety that we can move the</span>
<a href="#l5.421"></a><span id="l5.421" class="difflineplus">+    // source, otherwise report an error and fallback to a copy.</span>
<a href="#l5.422"></a><span id="l5.422" class="difflineplus">+    if (!doCopy &amp;&amp; !canMoveUnwrappedNode(item)) {</span>
<a href="#l5.423"></a><span id="l5.423" class="difflineplus">+      Cu.reportError(&quot;Tried to move an unmovable Places &quot; +</span>
<a href="#l5.424"></a><span id="l5.424" class="difflineplus">+                     &quot;node, reverting to a copy operation.&quot;);</span>
<a href="#l5.425"></a><span id="l5.425" class="difflineplus">+      doCopy = true;</span>
<a href="#l5.426"></a><span id="l5.426" class="difflineplus">+    }</span>
<a href="#l5.427"></a><span id="l5.427" class="difflineplus">+    transactions.push(</span>
<a href="#l5.428"></a><span id="l5.428" class="difflineplus">+      PlacesUIUtils.getTransactionForData(item,</span>
<a href="#l5.429"></a><span id="l5.429" class="difflineplus">+                                          insertionParentGuid,</span>
<a href="#l5.430"></a><span id="l5.430" class="difflineplus">+                                          index,</span>
<a href="#l5.431"></a><span id="l5.431" class="difflineplus">+                                          doCopy));</span>
<a href="#l5.432"></a><span id="l5.432" class="difflineplus">+</span>
<a href="#l5.433"></a><span id="l5.433" class="difflineplus">+    if (index != -1 &amp;&amp; item.itemGuid) {</span>
<a href="#l5.434"></a><span id="l5.434" class="difflineplus">+      index++;</span>
<a href="#l5.435"></a><span id="l5.435" class="difflineplus">+    }</span>
<a href="#l5.436"></a><span id="l5.436" class="difflineplus">+  }</span>
<a href="#l5.437"></a><span id="l5.437" class="difflineplus">+  return transactions;</span>
<a href="#l5.438"></a><span id="l5.438" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/suite/components/places/content/bookmarkProperties.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/suite/components/places/content/bookmarkProperties.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -156,17 +156,17 @@ var BookmarkPropertiesPanel = {</span>
<a href="#l6.4"></a><span id="l6.4"> </span>
<a href="#l6.5"></a><span id="l6.5">       if (&quot;title&quot; in dialogInfo)</span>
<a href="#l6.6"></a><span id="l6.6">         this._title = dialogInfo.title;</span>
<a href="#l6.7"></a><span id="l6.7"> </span>
<a href="#l6.8"></a><span id="l6.8">       if (&quot;defaultInsertionPoint&quot; in dialogInfo) {</span>
<a href="#l6.9"></a><span id="l6.9">         this._defaultInsertionPoint = dialogInfo.defaultInsertionPoint;</span>
<a href="#l6.10"></a><span id="l6.10">       } else {</span>
<a href="#l6.11"></a><span id="l6.11">         this._defaultInsertionPoint =</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-          new InsertionPoint({</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+          new PlacesInsertionPoint({</span>
<a href="#l6.14"></a><span id="l6.14">             parentId: PlacesUtils.bookmarksMenuFolderId,</span>
<a href="#l6.15"></a><span id="l6.15">             parentGuid: PlacesUtils.bookmarks.menuGuid</span>
<a href="#l6.16"></a><span id="l6.16">           });</span>
<a href="#l6.17"></a><span id="l6.17">       }</span>
<a href="#l6.18"></a><span id="l6.18"> </span>
<a href="#l6.19"></a><span id="l6.19">       switch (dialogInfo.type) {</span>
<a href="#l6.20"></a><span id="l6.20">         case &quot;bookmark&quot;:</span>
<a href="#l6.21"></a><span id="l6.21">           this._itemType = BOOKMARK_ITEM;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/suite/components/places/content/browserPlacesViews.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/suite/components/places/content/browserPlacesViews.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -212,20 +212,20 @@ PlacesViewBase.prototype = {</span>
<a href="#l7.4"></a><span id="l7.4">           tagName = container.title;</span>
<a href="#l7.5"></a><span id="l7.5">           // TODO (Bug 1160193): properly support dropping on a tag root.</span>
<a href="#l7.6"></a><span id="l7.6">           if (!tagName)</span>
<a href="#l7.7"></a><span id="l7.7">             return null;</span>
<a href="#l7.8"></a><span id="l7.8">         }</span>
<a href="#l7.9"></a><span id="l7.9">       }</span>
<a href="#l7.10"></a><span id="l7.10">     }</span>
<a href="#l7.11"></a><span id="l7.11"> </span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-    if (PlacesControllerDragHelper.disallowInsertion(container, this))</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+    if (this.controller.disallowInsertion(container))</span>
<a href="#l7.14"></a><span id="l7.14">       return null;</span>
<a href="#l7.15"></a><span id="l7.15"> </span>
<a href="#l7.16"></a><span id="l7.16" class="difflineminus">-    return new InsertionPoint({</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineplus">+    return new PlacesInsertionPoint({</span>
<a href="#l7.18"></a><span id="l7.18">       parentId: PlacesUtils.getConcreteItemId(container),</span>
<a href="#l7.19"></a><span id="l7.19">       parentGuid: PlacesUtils.getConcreteItemGuid(container),</span>
<a href="#l7.20"></a><span id="l7.20">       index, orientation, tagName</span>
<a href="#l7.21"></a><span id="l7.21">     });</span>
<a href="#l7.22"></a><span id="l7.22">   },</span>
<a href="#l7.23"></a><span id="l7.23"> </span>
<a href="#l7.24"></a><span id="l7.24">   buildContextMenu: function PVB_buildContextMenu(aPopup) {</span>
<a href="#l7.25"></a><span id="l7.25">     this._contextMenuShown = aPopup;</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineat">@@ -1507,86 +1507,86 @@ PlacesToolbar.prototype = {</span>
<a href="#l7.27"></a><span id="l7.27">         // This is a folder.</span>
<a href="#l7.28"></a><span id="l7.28">         // If we are in the middle of it, drop inside it.</span>
<a href="#l7.29"></a><span id="l7.29">         // Otherwise, drop before it, with regards to RTL mode.</span>
<a href="#l7.30"></a><span id="l7.30">         let threshold = eltRect.width * 0.25;</span>
<a href="#l7.31"></a><span id="l7.31">         if (this.isRTL ? (aEvent.clientX &gt; eltRect.right - threshold)</span>
<a href="#l7.32"></a><span id="l7.32">                        : (aEvent.clientX &lt; eltRect.left + threshold)) {</span>
<a href="#l7.33"></a><span id="l7.33">           // Drop before this folder.</span>
<a href="#l7.34"></a><span id="l7.34">           dropPoint.ip =</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineminus">-            new InsertionPoint({</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineplus">+            new PlacesInsertionPoint({</span>
<a href="#l7.37"></a><span id="l7.37">               parentId: PlacesUtils.getConcreteItemId(this._resultNode),</span>
<a href="#l7.38"></a><span id="l7.38">               parentGuid: PlacesUtils.getConcreteItemGuid(this._resultNode),</span>
<a href="#l7.39"></a><span id="l7.39">               index: eltIndex,</span>
<a href="#l7.40"></a><span id="l7.40">               orientation: Ci.nsITreeView.DROP_BEFORE</span>
<a href="#l7.41"></a><span id="l7.41">             });</span>
<a href="#l7.42"></a><span id="l7.42">           dropPoint.beforeIndex = eltIndex;</span>
<a href="#l7.43"></a><span id="l7.43">         } else if (this.isRTL ? (aEvent.clientX &gt; eltRect.left + threshold)</span>
<a href="#l7.44"></a><span id="l7.44">                             : (aEvent.clientX &lt; eltRect.right - threshold)) {</span>
<a href="#l7.45"></a><span id="l7.45">           // Drop inside this folder.</span>
<a href="#l7.46"></a><span id="l7.46">           let tagName = PlacesUtils.nodeIsTagQuery(elt._placesNode) ?</span>
<a href="#l7.47"></a><span id="l7.47">                         elt._placesNode.title : null;</span>
<a href="#l7.48"></a><span id="l7.48">           dropPoint.ip =</span>
<a href="#l7.49"></a><span id="l7.49" class="difflineminus">-            new InsertionPoint({</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineplus">+            new PlacesInsertionPoint({</span>
<a href="#l7.51"></a><span id="l7.51">               parentId: PlacesUtils.getConcreteItemId(elt._placesNode),</span>
<a href="#l7.52"></a><span id="l7.52">               parentGuid: PlacesUtils.getConcreteItemGuid(elt._placesNode),</span>
<a href="#l7.53"></a><span id="l7.53">               tagName</span>
<a href="#l7.54"></a><span id="l7.54">             });</span>
<a href="#l7.55"></a><span id="l7.55">           dropPoint.beforeIndex = eltIndex;</span>
<a href="#l7.56"></a><span id="l7.56">           dropPoint.folderElt = elt;</span>
<a href="#l7.57"></a><span id="l7.57">         } else {</span>
<a href="#l7.58"></a><span id="l7.58">           // Drop after this folder.</span>
<a href="#l7.59"></a><span id="l7.59">           let beforeIndex =</span>
<a href="#l7.60"></a><span id="l7.60">             (eltIndex == this._rootElt.childNodes.length - 1) ?</span>
<a href="#l7.61"></a><span id="l7.61">             -1 : eltIndex + 1;</span>
<a href="#l7.62"></a><span id="l7.62"> </span>
<a href="#l7.63"></a><span id="l7.63">           dropPoint.ip =</span>
<a href="#l7.64"></a><span id="l7.64" class="difflineminus">-            new InsertionPoint({</span>
<a href="#l7.65"></a><span id="l7.65" class="difflineplus">+            new PlacesInsertionPoint({</span>
<a href="#l7.66"></a><span id="l7.66">               parentId: PlacesUtils.getConcreteItemId(this._resultNode),</span>
<a href="#l7.67"></a><span id="l7.67">               parentGuid: PlacesUtils.getConcreteItemGuid(this._resultNode),</span>
<a href="#l7.68"></a><span id="l7.68">               index: beforeIndex,</span>
<a href="#l7.69"></a><span id="l7.69">               orientation: Ci.nsITreeView.DROP_BEFORE</span>
<a href="#l7.70"></a><span id="l7.70">             });</span>
<a href="#l7.71"></a><span id="l7.71">           dropPoint.beforeIndex = beforeIndex;</span>
<a href="#l7.72"></a><span id="l7.72">         }</span>
<a href="#l7.73"></a><span id="l7.73">       } else {</span>
<a href="#l7.74"></a><span id="l7.74">         // This is a non-folder node or a read-only folder.</span>
<a href="#l7.75"></a><span id="l7.75">         // Drop before it with regards to RTL mode.</span>
<a href="#l7.76"></a><span id="l7.76">         let threshold = eltRect.width * 0.5;</span>
<a href="#l7.77"></a><span id="l7.77">         if (this.isRTL ? (aEvent.clientX &gt; eltRect.left + threshold)</span>
<a href="#l7.78"></a><span id="l7.78">                        : (aEvent.clientX &lt; eltRect.left + threshold)) {</span>
<a href="#l7.79"></a><span id="l7.79">           // Drop before this bookmark.</span>
<a href="#l7.80"></a><span id="l7.80">           dropPoint.ip =</span>
<a href="#l7.81"></a><span id="l7.81" class="difflineminus">-            new InsertionPoint({</span>
<a href="#l7.82"></a><span id="l7.82" class="difflineplus">+            new PlacesInsertionPoint({</span>
<a href="#l7.83"></a><span id="l7.83">               parentId: PlacesUtils.getConcreteItemId(this._resultNode),</span>
<a href="#l7.84"></a><span id="l7.84">               parentGuid: PlacesUtils.getConcreteItemGuid(this._resultNode),</span>
<a href="#l7.85"></a><span id="l7.85">               index: eltIndex,</span>
<a href="#l7.86"></a><span id="l7.86">               orientation: Ci.nsITreeView.DROP_BEFORE</span>
<a href="#l7.87"></a><span id="l7.87">             });</span>
<a href="#l7.88"></a><span id="l7.88">           dropPoint.beforeIndex = eltIndex;</span>
<a href="#l7.89"></a><span id="l7.89">         } else {</span>
<a href="#l7.90"></a><span id="l7.90">           // Drop after this bookmark.</span>
<a href="#l7.91"></a><span id="l7.91">           let beforeIndex =</span>
<a href="#l7.92"></a><span id="l7.92">             eltIndex == this._rootElt.childNodes.length - 1 ?</span>
<a href="#l7.93"></a><span id="l7.93">             -1 : eltIndex + 1;</span>
<a href="#l7.94"></a><span id="l7.94">           dropPoint.ip =</span>
<a href="#l7.95"></a><span id="l7.95" class="difflineminus">-            new InsertionPoint({</span>
<a href="#l7.96"></a><span id="l7.96" class="difflineplus">+            new PlacesInsertionPoint({</span>
<a href="#l7.97"></a><span id="l7.97">               parentId: PlacesUtils.getConcreteItemId(this._resultNode),</span>
<a href="#l7.98"></a><span id="l7.98">               parentGuid: PlacesUtils.getConcreteItemGuid(this._resultNode),</span>
<a href="#l7.99"></a><span id="l7.99">               index: beforeIndex,</span>
<a href="#l7.100"></a><span id="l7.100">               orientation: Ci.nsITreeView.DROP_BEFORE</span>
<a href="#l7.101"></a><span id="l7.101">             });</span>
<a href="#l7.102"></a><span id="l7.102">           dropPoint.beforeIndex = beforeIndex;</span>
<a href="#l7.103"></a><span id="l7.103">         }</span>
<a href="#l7.104"></a><span id="l7.104">       }</span>
<a href="#l7.105"></a><span id="l7.105">     } else {</span>
<a href="#l7.106"></a><span id="l7.106">       // We are most likely dragging on the empty area of the</span>
<a href="#l7.107"></a><span id="l7.107">       // toolbar, we should drop after the last node.</span>
<a href="#l7.108"></a><span id="l7.108">       dropPoint.ip =</span>
<a href="#l7.109"></a><span id="l7.109" class="difflineminus">-        new InsertionPoint({</span>
<a href="#l7.110"></a><span id="l7.110" class="difflineplus">+        new PlacesInsertionPoint({</span>
<a href="#l7.111"></a><span id="l7.111">           parentId: PlacesUtils.getConcreteItemId(this._resultNode),</span>
<a href="#l7.112"></a><span id="l7.112">           parentGuid: PlacesUtils.getConcreteItemGuid(this._resultNode),</span>
<a href="#l7.113"></a><span id="l7.113">           orientation: Ci.nsITreeView.DROP_BEFORE</span>
<a href="#l7.114"></a><span id="l7.114">         });</span>
<a href="#l7.115"></a><span id="l7.115">       dropPoint.beforeIndex = -1;</span>
<a href="#l7.116"></a><span id="l7.116">     }</span>
<a href="#l7.117"></a><span id="l7.117"> </span>
<a href="#l7.118"></a><span id="l7.118">     return dropPoint;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/suite/components/places/content/controller.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/suite/components/places/content/controller.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -1,20 +1,13 @@</span>
<a href="#l8.4"></a><span id="l8.4"> /* -*- indent-tabs-mode: nil; js-indent-level: 2 -*- */</span>
<a href="#l8.5"></a><span id="l8.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l8.6"></a><span id="l8.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l8.7"></a><span id="l8.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l8.8"></a><span id="l8.8"> </span>
<a href="#l8.9"></a><span id="l8.9" class="difflineminus">-ChromeUtils.defineModuleGetter(this, &quot;ForgetAboutSite&quot;,</span>
<a href="#l8.10"></a><span id="l8.10" class="difflineminus">-                               &quot;resource://gre/modules/ForgetAboutSite.jsm&quot;);</span>
<a href="#l8.11"></a><span id="l8.11" class="difflineminus">-ChromeUtils.defineModuleGetter(this, &quot;NetUtil&quot;,</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-                               &quot;resource://gre/modules/NetUtil.jsm&quot;);</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineminus">-ChromeUtils.defineModuleGetter(this, &quot;PrivateBrowsingUtils&quot;,</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineminus">-                               &quot;resource://gre/modules/PrivateBrowsingUtils.jsm&quot;);</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineminus">-</span>
<a href="#l8.16"></a><span id="l8.16"> /**</span>
<a href="#l8.17"></a><span id="l8.17">  * Represents an insertion point within a container where we can insert</span>
<a href="#l8.18"></a><span id="l8.18">  * items.</span>
<a href="#l8.19"></a><span id="l8.19">  * @param {object} an object containing the following properties:</span>
<a href="#l8.20"></a><span id="l8.20">  *   - parentId</span>
<a href="#l8.21"></a><span id="l8.21">  *     The identifier of the parent container</span>
<a href="#l8.22"></a><span id="l8.22">  *   - parentGuid</span>
<a href="#l8.23"></a><span id="l8.23">  *     The unique identifier of the parent container</span>
<a href="#l8.24"></a><span id="l8.24" class="difflineat">@@ -25,30 +18,30 @@ ChromeUtils.defineModuleGetter(this, &quot;Pr</span>
<a href="#l8.25"></a><span id="l8.25">  *     insertion point to accommodate the orientation should be done by</span>
<a href="#l8.26"></a><span id="l8.26">  *     the person who constructs the IP, not the user. The orientation</span>
<a href="#l8.27"></a><span id="l8.27">  *     is provided for informational purposes only! Defaults to DROP_ON.</span>
<a href="#l8.28"></a><span id="l8.28">  *   - tagName</span>
<a href="#l8.29"></a><span id="l8.29">  *     The tag name if this IP is set to a tag, null otherwise.</span>
<a href="#l8.30"></a><span id="l8.30">  *   - dropNearNode</span>
<a href="#l8.31"></a><span id="l8.31">  *     When defined index will be calculated based on this node</span>
<a href="#l8.32"></a><span id="l8.32">  */</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineminus">-function InsertionPoint({ parentId, parentGuid,</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineminus">-                          index = PlacesUtils.bookmarks.DEFAULT_INDEX,</span>
<a href="#l8.35"></a><span id="l8.35" class="difflineminus">-                          orientation = Ci.nsITreeView.DROP_ON,</span>
<a href="#l8.36"></a><span id="l8.36" class="difflineminus">-                          tagName = null,</span>
<a href="#l8.37"></a><span id="l8.37" class="difflineminus">-                          dropNearNode = null }) {</span>
<a href="#l8.38"></a><span id="l8.38" class="difflineplus">+function PlacesInsertionPoint({ parentId, parentGuid,</span>
<a href="#l8.39"></a><span id="l8.39" class="difflineplus">+                                index = PlacesUtils.bookmarks.DEFAULT_INDEX,</span>
<a href="#l8.40"></a><span id="l8.40" class="difflineplus">+                                orientation = Ci.nsITreeView.DROP_ON,</span>
<a href="#l8.41"></a><span id="l8.41" class="difflineplus">+                                tagName = null,</span>
<a href="#l8.42"></a><span id="l8.42" class="difflineplus">+                                dropNearNode = null }) {</span>
<a href="#l8.43"></a><span id="l8.43">   this.itemId = parentId;</span>
<a href="#l8.44"></a><span id="l8.44">   this.guid = parentGuid;</span>
<a href="#l8.45"></a><span id="l8.45">   this._index = index;</span>
<a href="#l8.46"></a><span id="l8.46">   this.orientation = orientation;</span>
<a href="#l8.47"></a><span id="l8.47">   this.tagName = tagName;</span>
<a href="#l8.48"></a><span id="l8.48">   this.dropNearNode = dropNearNode;</span>
<a href="#l8.49"></a><span id="l8.49"> }</span>
<a href="#l8.50"></a><span id="l8.50"> </span>
<a href="#l8.51"></a><span id="l8.51" class="difflineminus">-InsertionPoint.prototype = {</span>
<a href="#l8.52"></a><span id="l8.52" class="difflineplus">+PlacesInsertionPoint.prototype = {</span>
<a href="#l8.53"></a><span id="l8.53">   set index(val) {</span>
<a href="#l8.54"></a><span id="l8.54">     return this._index = val;</span>
<a href="#l8.55"></a><span id="l8.55">   },</span>
<a href="#l8.56"></a><span id="l8.56"> </span>
<a href="#l8.57"></a><span id="l8.57">   async getIndex() {</span>
<a href="#l8.58"></a><span id="l8.58">     if (this.dropNearNode) {</span>
<a href="#l8.59"></a><span id="l8.59">       // If dropNearNode is set up we must calculate the index of the item near</span>
<a href="#l8.60"></a><span id="l8.60">       // which we will drop.</span>
<a href="#l8.61"></a><span id="l8.61" class="difflineat">@@ -217,17 +210,17 @@ PlacesController.prototype = {</span>
<a href="#l8.62"></a><span id="l8.62">       this.remove(&quot;Remove Selection&quot;).catch(Cu.reportError);</span>
<a href="#l8.63"></a><span id="l8.63">       break;</span>
<a href="#l8.64"></a><span id="l8.64">     case &quot;placesCmd_deleteDataHost&quot;:</span>
<a href="#l8.65"></a><span id="l8.65">       var host;</span>
<a href="#l8.66"></a><span id="l8.66">       if (PlacesUtils.nodeIsHost(this._view.selectedNode)) {</span>
<a href="#l8.67"></a><span id="l8.67">         var queries = this._view.selectedNode.getQueries();</span>
<a href="#l8.68"></a><span id="l8.68">         host = queries[0].domain;</span>
<a href="#l8.69"></a><span id="l8.69">       } else</span>
<a href="#l8.70"></a><span id="l8.70" class="difflineminus">-        host = NetUtil.newURI(this._view.selectedNode.uri).host;</span>
<a href="#l8.71"></a><span id="l8.71" class="difflineplus">+        host = Services.io.newURI(this._view.selectedNode.uri).host;</span>
<a href="#l8.72"></a><span id="l8.72">       ForgetAboutSite.removeDataFromDomain(host)</span>
<a href="#l8.73"></a><span id="l8.73">                      .catch(Cu.reportError);</span>
<a href="#l8.74"></a><span id="l8.74">       break;</span>
<a href="#l8.75"></a><span id="l8.75">     case &quot;cmd_selectAll&quot;:</span>
<a href="#l8.76"></a><span id="l8.76">       this.selectAll();</span>
<a href="#l8.77"></a><span id="l8.77">       break;</span>
<a href="#l8.78"></a><span id="l8.78">     case &quot;placesCmd_open&quot;:</span>
<a href="#l8.79"></a><span id="l8.79">       PlacesUIUtils.openNodeIn(this._view.selectedNode, &quot;current&quot;, this._view);</span>
<a href="#l8.80"></a><span id="l8.80" class="difflineat">@@ -262,17 +255,17 @@ PlacesController.prototype = {</span>
<a href="#l8.81"></a><span id="l8.81">     case &quot;placesCmd_createBookmark&quot;:</span>
<a href="#l8.82"></a><span id="l8.82">       let node = this._view.selectedNode;</span>
<a href="#l8.83"></a><span id="l8.83">       PlacesUIUtils.showBookmarkDialog({ action: &quot;add&quot;,</span>
<a href="#l8.84"></a><span id="l8.84">                                          type: &quot;bookmark&quot;,</span>
<a href="#l8.85"></a><span id="l8.85">                                          hiddenRows: [ &quot;description&quot;,</span>
<a href="#l8.86"></a><span id="l8.86">                                                         &quot;keyword&quot;,</span>
<a href="#l8.87"></a><span id="l8.87">                                                         &quot;location&quot;,</span>
<a href="#l8.88"></a><span id="l8.88">                                                         &quot;loadInSidebar&quot; ],</span>
<a href="#l8.89"></a><span id="l8.89" class="difflineminus">-                                         uri: NetUtil.newURI(node.uri),</span>
<a href="#l8.90"></a><span id="l8.90" class="difflineplus">+                                         uri: Services.io.newURI(node.uri),</span>
<a href="#l8.91"></a><span id="l8.91">                                          title: node.title</span>
<a href="#l8.92"></a><span id="l8.92">                                        }, window.top);</span>
<a href="#l8.93"></a><span id="l8.93">       break;</span>
<a href="#l8.94"></a><span id="l8.94">     }</span>
<a href="#l8.95"></a><span id="l8.95">   },</span>
<a href="#l8.96"></a><span id="l8.96"> </span>
<a href="#l8.97"></a><span id="l8.97">   onEvent: function PC_onEvent(eventName) { },</span>
<a href="#l8.98"></a><span id="l8.98"> </span>
<a href="#l8.99"></a><span id="l8.99" class="difflineat">@@ -415,17 +408,17 @@ PlacesController.prototype = {</span>
<a href="#l8.100"></a><span id="l8.100">         case Ci.nsINavHistoryResultNode.RESULT_TYPE_FOLDER_SHORTCUT:</span>
<a href="#l8.101"></a><span id="l8.101">           nodeData.folder = true;</span>
<a href="#l8.102"></a><span id="l8.102">           break;</span>
<a href="#l8.103"></a><span id="l8.103">         case Ci.nsINavHistoryResultNode.RESULT_TYPE_SEPARATOR:</span>
<a href="#l8.104"></a><span id="l8.104">           nodeData.separator = true;</span>
<a href="#l8.105"></a><span id="l8.105">           break;</span>
<a href="#l8.106"></a><span id="l8.106">         case Ci.nsINavHistoryResultNode.RESULT_TYPE_URI:</span>
<a href="#l8.107"></a><span id="l8.107">           nodeData.link = true;</span>
<a href="#l8.108"></a><span id="l8.108" class="difflineminus">-          uri = NetUtil.newURI(node.uri);</span>
<a href="#l8.109"></a><span id="l8.109" class="difflineplus">+          uri = Services.io.newURI(node.uri);</span>
<a href="#l8.110"></a><span id="l8.110">           if (PlacesUtils.nodeIsBookmark(node)) {</span>
<a href="#l8.111"></a><span id="l8.111">             nodeData.bookmark = true;</span>
<a href="#l8.112"></a><span id="l8.112">             var parentNode = node.parent;</span>
<a href="#l8.113"></a><span id="l8.113">             if (parentNode) {</span>
<a href="#l8.114"></a><span id="l8.114">               if (PlacesUtils.nodeIsTagQuery(parentNode))</span>
<a href="#l8.115"></a><span id="l8.115">                 nodeData.tagChild = true;</span>
<a href="#l8.116"></a><span id="l8.116">               else if (this.hasCachedLivemarkInfo(parentNode))</span>
<a href="#l8.117"></a><span id="l8.117">                 nodeData.livemarkChild = true;</span>
<a href="#l8.118"></a><span id="l8.118" class="difflineat">@@ -1200,17 +1193,17 @@ PlacesController.prototype = {</span>
<a href="#l8.119"></a><span id="l8.119">       type = type.value;</span>
<a href="#l8.120"></a><span id="l8.120">       items = PlacesUtils.unwrapNodes(data, type);</span>
<a href="#l8.121"></a><span id="l8.121">     } catch (ex) {</span>
<a href="#l8.122"></a><span id="l8.122">       // No supported data exists or nodes unwrap failed, just bail out.</span>
<a href="#l8.123"></a><span id="l8.123">       return;</span>
<a href="#l8.124"></a><span id="l8.124">     }</span>
<a href="#l8.125"></a><span id="l8.125"> </span>
<a href="#l8.126"></a><span id="l8.126">     let doCopy = action == &quot;copy&quot;;</span>
<a href="#l8.127"></a><span id="l8.127" class="difflineminus">-    let itemsToSelect = await handleTransferItems(items, ip, doCopy, this._view);</span>
<a href="#l8.128"></a><span id="l8.128" class="difflineplus">+    let itemsToSelect = await PlacesUIUtils.handleTransferItems(items, ip, doCopy, this._view);</span>
<a href="#l8.129"></a><span id="l8.129"> </span>
<a href="#l8.130"></a><span id="l8.130">     // Cut/past operations are not repeatable, so clear the clipboard.</span>
<a href="#l8.131"></a><span id="l8.131">     if (action == &quot;cut&quot;) {</span>
<a href="#l8.132"></a><span id="l8.132">       this._clearClipboard();</span>
<a href="#l8.133"></a><span id="l8.133">     }</span>
<a href="#l8.134"></a><span id="l8.134"> </span>
<a href="#l8.135"></a><span id="l8.135">     if (itemsToSelect.length &gt; 0)</span>
<a href="#l8.136"></a><span id="l8.136">       this._view.selectItems(itemsToSelect, false);</span>
<a href="#l8.137"></a><span id="l8.137" class="difflineat">@@ -1243,17 +1236,51 @@ PlacesController.prototype = {</span>
<a href="#l8.138"></a><span id="l8.138">    * Returns the cached livemark info for a node, if set by cacheLivemarkInfo,</span>
<a href="#l8.139"></a><span id="l8.139">    * null otherwise.</span>
<a href="#l8.140"></a><span id="l8.140">    * @param aNode</span>
<a href="#l8.141"></a><span id="l8.141">    *        a places result node.</span>
<a href="#l8.142"></a><span id="l8.142">    * @return the mozILivemarkInfo object for aNode, if set, null otherwise.</span>
<a href="#l8.143"></a><span id="l8.143">    */</span>
<a href="#l8.144"></a><span id="l8.144">   getCachedLivemarkInfo: function PC_getCachedLivemarkInfo(aNode) {</span>
<a href="#l8.145"></a><span id="l8.145">     return this._cachedLivemarkInfoObjects.get(aNode, null);</span>
<a href="#l8.146"></a><span id="l8.146" class="difflineminus">-  }</span>
<a href="#l8.147"></a><span id="l8.147" class="difflineplus">+  },</span>
<a href="#l8.148"></a><span id="l8.148" class="difflineplus">+</span>
<a href="#l8.149"></a><span id="l8.149" class="difflineplus">+  /**</span>
<a href="#l8.150"></a><span id="l8.150" class="difflineplus">+   * Checks if we can insert into a container.</span>
<a href="#l8.151"></a><span id="l8.151" class="difflineplus">+   * @param   container</span>
<a href="#l8.152"></a><span id="l8.152" class="difflineplus">+   *          The container were we are want to drop</span>
<a href="#l8.153"></a><span id="l8.153" class="difflineplus">+   */</span>
<a href="#l8.154"></a><span id="l8.154" class="difflineplus">+  disallowInsertion(container) {</span>
<a href="#l8.155"></a><span id="l8.155" class="difflineplus">+    NS_ASSERT(container, &quot;empty container&quot;);</span>
<a href="#l8.156"></a><span id="l8.156" class="difflineplus">+    // Allow dropping into Tag containers and editable folders.</span>
<a href="#l8.157"></a><span id="l8.157" class="difflineplus">+    return !PlacesUtils.nodeIsTagQuery(container) &amp;&amp;</span>
<a href="#l8.158"></a><span id="l8.158" class="difflineplus">+           (!PlacesUtils.nodeIsFolder(container) ||</span>
<a href="#l8.159"></a><span id="l8.159" class="difflineplus">+            PlacesUIUtils.isFolderReadOnly(container, this._view));</span>
<a href="#l8.160"></a><span id="l8.160" class="difflineplus">+  },</span>
<a href="#l8.161"></a><span id="l8.161" class="difflineplus">+</span>
<a href="#l8.162"></a><span id="l8.162" class="difflineplus">+  /**</span>
<a href="#l8.163"></a><span id="l8.163" class="difflineplus">+   * Determines if a node can be moved.</span>
<a href="#l8.164"></a><span id="l8.164" class="difflineplus">+   *</span>
<a href="#l8.165"></a><span id="l8.165" class="difflineplus">+   * @param   aNode</span>
<a href="#l8.166"></a><span id="l8.166" class="difflineplus">+   *          A nsINavHistoryResultNode node.</span>
<a href="#l8.167"></a><span id="l8.167" class="difflineplus">+   * @return True if the node can be moved, false otherwise.</span>
<a href="#l8.168"></a><span id="l8.168" class="difflineplus">+   */</span>
<a href="#l8.169"></a><span id="l8.169" class="difflineplus">+  canMoveNode(node) {</span>
<a href="#l8.170"></a><span id="l8.170" class="difflineplus">+    // Only bookmark items are movable.</span>
<a href="#l8.171"></a><span id="l8.171" class="difflineplus">+    if (node.itemId == -1)</span>
<a href="#l8.172"></a><span id="l8.172" class="difflineplus">+      return false;</span>
<a href="#l8.173"></a><span id="l8.173" class="difflineplus">+</span>
<a href="#l8.174"></a><span id="l8.174" class="difflineplus">+    // Once tags and bookmarked are divorced, the tag-query check should be</span>
<a href="#l8.175"></a><span id="l8.175" class="difflineplus">+    // removed.</span>
<a href="#l8.176"></a><span id="l8.176" class="difflineplus">+    let parentNode = node.parent;</span>
<a href="#l8.177"></a><span id="l8.177" class="difflineplus">+    return parentNode != null &amp;&amp;</span>
<a href="#l8.178"></a><span id="l8.178" class="difflineplus">+           PlacesUtils.nodeIsFolder(parentNode) &amp;&amp;</span>
<a href="#l8.179"></a><span id="l8.179" class="difflineplus">+           !PlacesUIUtils.isFolderReadOnly(parentNode, this._view) &amp;&amp;</span>
<a href="#l8.180"></a><span id="l8.180" class="difflineplus">+           !PlacesUtils.nodeIsTagQuery(parentNode);</span>
<a href="#l8.181"></a><span id="l8.181" class="difflineplus">+  },</span>
<a href="#l8.182"></a><span id="l8.182"> };</span>
<a href="#l8.183"></a><span id="l8.183"> </span>
<a href="#l8.184"></a><span id="l8.184"> /**</span>
<a href="#l8.185"></a><span id="l8.185">  * Handles drag and drop operations for views. Note that this is view agnostic!</span>
<a href="#l8.186"></a><span id="l8.186">  * You should not use PlacesController._view within these methods, since</span>
<a href="#l8.187"></a><span id="l8.187">  * the view that the item(s) have been dropped on was not necessarily active.</span>
<a href="#l8.188"></a><span id="l8.188">  * Drop functions are passed the view that is being dropped on.</span>
<a href="#l8.189"></a><span id="l8.189">  */</span>
<a href="#l8.190"></a><span id="l8.190" class="difflineat">@@ -1366,72 +1393,16 @@ var PlacesControllerDragHelper = {</span>
<a href="#l8.191"></a><span id="l8.191">           }</span>
<a href="#l8.192"></a><span id="l8.192">         }</span>
<a href="#l8.193"></a><span id="l8.193">       }</span>
<a href="#l8.194"></a><span id="l8.194">     }</span>
<a href="#l8.195"></a><span id="l8.195">     return true;</span>
<a href="#l8.196"></a><span id="l8.196">   },</span>
<a href="#l8.197"></a><span id="l8.197"> </span>
<a href="#l8.198"></a><span id="l8.198">   /**</span>
<a href="#l8.199"></a><span id="l8.199" class="difflineminus">-   * Determines if an unwrapped node can be moved.</span>
<a href="#l8.200"></a><span id="l8.200" class="difflineminus">-   *</span>
<a href="#l8.201"></a><span id="l8.201" class="difflineminus">-   * @param unwrappedNode</span>
<a href="#l8.202"></a><span id="l8.202" class="difflineminus">-   *        A node unwrapped by PlacesUtils.unwrapNodes().</span>
<a href="#l8.203"></a><span id="l8.203" class="difflineminus">-   * @return True if the node can be moved, false otherwise.</span>
<a href="#l8.204"></a><span id="l8.204" class="difflineminus">-   */</span>
<a href="#l8.205"></a><span id="l8.205" class="difflineminus">-  canMoveUnwrappedNode(unwrappedNode) {</span>
<a href="#l8.206"></a><span id="l8.206" class="difflineminus">-    if ((unwrappedNode.concreteGuid &amp;&amp; PlacesUtils.isRootItem(unwrappedNode.concreteGuid)) ||</span>
<a href="#l8.207"></a><span id="l8.207" class="difflineminus">-        unwrappedNode.id &lt;= 0 || PlacesUtils.isRootItem(unwrappedNode.id)) {</span>
<a href="#l8.208"></a><span id="l8.208" class="difflineminus">-      return false;</span>
<a href="#l8.209"></a><span id="l8.209" class="difflineminus">-    }</span>
<a href="#l8.210"></a><span id="l8.210" class="difflineminus">-</span>
<a href="#l8.211"></a><span id="l8.211" class="difflineminus">-    let parentGuid = unwrappedNode.parentGuid;</span>
<a href="#l8.212"></a><span id="l8.212" class="difflineminus">-    // If there's no parent Guid, this was likely a virtual query that returns</span>
<a href="#l8.213"></a><span id="l8.213" class="difflineminus">-    // bookmarks, such as a tags query.</span>
<a href="#l8.214"></a><span id="l8.214" class="difflineminus">-    if (!parentGuid ||</span>
<a href="#l8.215"></a><span id="l8.215" class="difflineminus">-        parentGuid == PlacesUtils.bookmarks.rootGuid) {</span>
<a href="#l8.216"></a><span id="l8.216" class="difflineminus">-      return false;</span>
<a href="#l8.217"></a><span id="l8.217" class="difflineminus">-    }</span>
<a href="#l8.218"></a><span id="l8.218" class="difflineminus">-    // leftPaneFolderId and allBookmarksFolderId are lazy getters running</span>
<a href="#l8.219"></a><span id="l8.219" class="difflineminus">-    // at least a synchronous DB query. Therefore we don't want to invoke</span>
<a href="#l8.220"></a><span id="l8.220" class="difflineminus">-    // them first, especially because isCommandEnabled may be called way</span>
<a href="#l8.221"></a><span id="l8.221" class="difflineminus">-    // before the left pane folder is even necessary.</span>
<a href="#l8.222"></a><span id="l8.222" class="difflineminus">-    if (typeof Object.getOwnPropertyDescriptor(PlacesUIUtils, &quot;leftPaneFolderId&quot;).get != &quot;function&quot; &amp;&amp;</span>
<a href="#l8.223"></a><span id="l8.223" class="difflineminus">-        (unwrappedNode.parent == PlacesUIUtils.leftPaneFolderId)) {</span>
<a href="#l8.224"></a><span id="l8.224" class="difflineminus">-      return false;</span>
<a href="#l8.225"></a><span id="l8.225" class="difflineminus">-    }</span>
<a href="#l8.226"></a><span id="l8.226" class="difflineminus">-    return true;</span>
<a href="#l8.227"></a><span id="l8.227" class="difflineminus">-  },</span>
<a href="#l8.228"></a><span id="l8.228" class="difflineminus">-</span>
<a href="#l8.229"></a><span id="l8.229" class="difflineminus">-  /**</span>
<a href="#l8.230"></a><span id="l8.230" class="difflineminus">-   * Determines if a node can be moved.</span>
<a href="#l8.231"></a><span id="l8.231" class="difflineminus">-   *</span>
<a href="#l8.232"></a><span id="l8.232" class="difflineminus">-   * @param   aNode</span>
<a href="#l8.233"></a><span id="l8.233" class="difflineminus">-   *          A nsINavHistoryResultNode node.</span>
<a href="#l8.234"></a><span id="l8.234" class="difflineminus">-   * @param   aView</span>
<a href="#l8.235"></a><span id="l8.235" class="difflineminus">-   *          The view originating the request</span>
<a href="#l8.236"></a><span id="l8.236" class="difflineminus">-   * @param   [optional] aDOMNode</span>
<a href="#l8.237"></a><span id="l8.237" class="difflineminus">-   *          A XUL DOM node.</span>
<a href="#l8.238"></a><span id="l8.238" class="difflineminus">-   * @return True if the node can be moved, false otherwise.</span>
<a href="#l8.239"></a><span id="l8.239" class="difflineminus">-   */</span>
<a href="#l8.240"></a><span id="l8.240" class="difflineminus">-  canMoveNode(aNode, aView) {</span>
<a href="#l8.241"></a><span id="l8.241" class="difflineminus">-    // Only bookmark items are movable.</span>
<a href="#l8.242"></a><span id="l8.242" class="difflineminus">-    if (aNode.itemId == -1)</span>
<a href="#l8.243"></a><span id="l8.243" class="difflineminus">-      return false;</span>
<a href="#l8.244"></a><span id="l8.244" class="difflineminus">-</span>
<a href="#l8.245"></a><span id="l8.245" class="difflineminus">-    // Once tags and bookmarked are divorced, the tag-query check should be</span>
<a href="#l8.246"></a><span id="l8.246" class="difflineminus">-    // removed.</span>
<a href="#l8.247"></a><span id="l8.247" class="difflineminus">-    let parentNode = aNode.parent;</span>
<a href="#l8.248"></a><span id="l8.248" class="difflineminus">-    return parentNode != null &amp;&amp;</span>
<a href="#l8.249"></a><span id="l8.249" class="difflineminus">-           PlacesUtils.nodeIsFolder(parentNode) &amp;&amp;</span>
<a href="#l8.250"></a><span id="l8.250" class="difflineminus">-           !PlacesUIUtils.isFolderReadOnly(parentNode, aView) &amp;&amp;</span>
<a href="#l8.251"></a><span id="l8.251" class="difflineminus">-           !PlacesUtils.nodeIsTagQuery(parentNode);</span>
<a href="#l8.252"></a><span id="l8.252" class="difflineminus">-  },</span>
<a href="#l8.253"></a><span id="l8.253" class="difflineminus">-</span>
<a href="#l8.254"></a><span id="l8.254" class="difflineminus">-  /**</span>
<a href="#l8.255"></a><span id="l8.255">    * Handles the drop of one or more items onto a view.</span>
<a href="#l8.256"></a><span id="l8.256">    *</span>
<a href="#l8.257"></a><span id="l8.257">    * @param {Object} insertionPoint The insertion point where the items should</span>
<a href="#l8.258"></a><span id="l8.258">    *                                be dropped.</span>
<a href="#l8.259"></a><span id="l8.259">    * @param {Object} dt             The dataTransfer information for the drop.</span>
<a href="#l8.260"></a><span id="l8.260">    * @param {Object} view           The view or the tree element. This allows</span>
<a href="#l8.261"></a><span id="l8.261">    *                                batching to take place.</span>
<a href="#l8.262"></a><span id="l8.262">    */</span>
<a href="#l8.263"></a><span id="l8.263" class="difflineat">@@ -1473,226 +1444,14 @@ var PlacesControllerDragHelper = {</span>
<a href="#l8.264"></a><span id="l8.264">           title: data.label,</span>
<a href="#l8.265"></a><span id="l8.265">           type: PlacesUtils.TYPE_X_MOZ_URL</span>
<a href="#l8.266"></a><span id="l8.266">         });</span>
<a href="#l8.267"></a><span id="l8.267">       } else {</span>
<a href="#l8.268"></a><span id="l8.268">         throw new Error(&quot;bogus data was passed as a tab&quot;);</span>
<a href="#l8.269"></a><span id="l8.269">       }</span>
<a href="#l8.270"></a><span id="l8.270">     }</span>
<a href="#l8.271"></a><span id="l8.271"> </span>
<a href="#l8.272"></a><span id="l8.272" class="difflineminus">-    await handleTransferItems(nodes, insertionPoint, doCopy, view);</span>
<a href="#l8.273"></a><span id="l8.273" class="difflineplus">+    await PlacesUIUtils.handleTransferItems(nodes, insertionPoint, doCopy, view);</span>
<a href="#l8.274"></a><span id="l8.274">   },</span>
<a href="#l8.275"></a><span id="l8.275"> </span>
<a href="#l8.276"></a><span id="l8.276" class="difflineminus">-  /**</span>
<a href="#l8.277"></a><span id="l8.277" class="difflineminus">-   * Checks if we can insert into a container.</span>
<a href="#l8.278"></a><span id="l8.278" class="difflineminus">-   * @param   aContainer</span>
<a href="#l8.279"></a><span id="l8.279" class="difflineminus">-   *          The container were we are want to drop</span>
<a href="#l8.280"></a><span id="l8.280" class="difflineminus">-   * @param   aView</span>
<a href="#l8.281"></a><span id="l8.281" class="difflineminus">-   *          The view generating the request</span>
<a href="#l8.282"></a><span id="l8.282" class="difflineminus">-   */</span>
<a href="#l8.283"></a><span id="l8.283" class="difflineminus">-  disallowInsertion(aContainer, aView) {</span>
<a href="#l8.284"></a><span id="l8.284" class="difflineminus">-    NS_ASSERT(aContainer, &quot;empty container&quot;);</span>
<a href="#l8.285"></a><span id="l8.285" class="difflineminus">-    // Allow dropping into Tag containers and editable folders.</span>
<a href="#l8.286"></a><span id="l8.286" class="difflineminus">-    return !PlacesUtils.nodeIsTagQuery(aContainer) &amp;&amp;</span>
<a href="#l8.287"></a><span id="l8.287" class="difflineminus">-           (!PlacesUtils.nodeIsFolder(aContainer) ||</span>
<a href="#l8.288"></a><span id="l8.288" class="difflineminus">-            PlacesUIUtils.isFolderReadOnly(aContainer, aView));</span>
<a href="#l8.289"></a><span id="l8.289" class="difflineminus">-  }</span>
<a href="#l8.290"></a><span id="l8.290" class="difflineminus">-};</span>
<a href="#l8.291"></a><span id="l8.291" class="difflineminus">-</span>
<a href="#l8.292"></a><span id="l8.292" class="difflineminus">-</span>
<a href="#l8.293"></a><span id="l8.293"> XPCOMUtils.defineLazyServiceGetter(PlacesControllerDragHelper, &quot;dragService&quot;,</span>
<a href="#l8.294"></a><span id="l8.294">                                    &quot;@mozilla.org/widget/dragservice;1&quot;,</span>
<a href="#l8.295"></a><span id="l8.295">                                    &quot;nsIDragService&quot;);</span>
<a href="#l8.296"></a><span id="l8.296" class="difflineminus">-</span>
<a href="#l8.297"></a><span id="l8.297" class="difflineminus">-function goUpdatePlacesCommands() {</span>
<a href="#l8.298"></a><span id="l8.298" class="difflineminus">-  // Get the controller for one of the places commands.</span>
<a href="#l8.299"></a><span id="l8.299" class="difflineminus">-  var placesController = doGetPlacesControllerForCommand(&quot;placesCmd_open&quot;);</span>
<a href="#l8.300"></a><span id="l8.300" class="difflineminus">-  function updatePlacesCommand(aCommand) {</span>
<a href="#l8.301"></a><span id="l8.301" class="difflineminus">-    goSetCommandEnabled(aCommand, placesController &amp;&amp;</span>
<a href="#l8.302"></a><span id="l8.302" class="difflineminus">-                                  placesController.isCommandEnabled(aCommand));</span>
<a href="#l8.303"></a><span id="l8.303" class="difflineminus">-  }</span>
<a href="#l8.304"></a><span id="l8.304" class="difflineminus">-</span>
<a href="#l8.305"></a><span id="l8.305" class="difflineminus">-  updatePlacesCommand(&quot;placesCmd_open&quot;);</span>
<a href="#l8.306"></a><span id="l8.306" class="difflineminus">-  updatePlacesCommand(&quot;placesCmd_open:window&quot;);</span>
<a href="#l8.307"></a><span id="l8.307" class="difflineminus">-  updatePlacesCommand(&quot;placesCmd_open:privatewindow&quot;);</span>
<a href="#l8.308"></a><span id="l8.308" class="difflineminus">-  updatePlacesCommand(&quot;placesCmd_open:tab&quot;);</span>
<a href="#l8.309"></a><span id="l8.309" class="difflineminus">-  updatePlacesCommand(&quot;placesCmd_new:folder&quot;);</span>
<a href="#l8.310"></a><span id="l8.310" class="difflineminus">-  updatePlacesCommand(&quot;placesCmd_new:bookmark&quot;);</span>
<a href="#l8.311"></a><span id="l8.311" class="difflineminus">-  updatePlacesCommand(&quot;placesCmd_new:separator&quot;);</span>
<a href="#l8.312"></a><span id="l8.312" class="difflineminus">-  updatePlacesCommand(&quot;placesCmd_show:info&quot;);</span>
<a href="#l8.313"></a><span id="l8.313" class="difflineminus">-  updatePlacesCommand(&quot;placesCmd_reload&quot;);</span>
<a href="#l8.314"></a><span id="l8.314" class="difflineminus">-  updatePlacesCommand(&quot;placesCmd_sortBy:name&quot;);</span>
<a href="#l8.315"></a><span id="l8.315" class="difflineminus">-  updatePlacesCommand(&quot;placesCmd_cut&quot;);</span>
<a href="#l8.316"></a><span id="l8.316" class="difflineminus">-  updatePlacesCommand(&quot;placesCmd_copy&quot;);</span>
<a href="#l8.317"></a><span id="l8.317" class="difflineminus">-  updatePlacesCommand(&quot;placesCmd_paste&quot;);</span>
<a href="#l8.318"></a><span id="l8.318" class="difflineminus">-  updatePlacesCommand(&quot;placesCmd_delete&quot;);</span>
<a href="#l8.319"></a><span id="l8.319" class="difflineminus">-}</span>
<a href="#l8.320"></a><span id="l8.320" class="difflineminus">-</span>
<a href="#l8.321"></a><span id="l8.321" class="difflineminus">-function doGetPlacesControllerForCommand(aCommand) {</span>
<a href="#l8.322"></a><span id="l8.322" class="difflineminus">-  // A context menu may be built for non-focusable views.  Thus, we first try</span>
<a href="#l8.323"></a><span id="l8.323" class="difflineminus">-  // to look for a view associated with document.popupNode</span>
<a href="#l8.324"></a><span id="l8.324" class="difflineminus">-  let popupNode;</span>
<a href="#l8.325"></a><span id="l8.325" class="difflineminus">-  try {</span>
<a href="#l8.326"></a><span id="l8.326" class="difflineminus">-    popupNode = document.popupNode;</span>
<a href="#l8.327"></a><span id="l8.327" class="difflineminus">-  } catch (e) {</span>
<a href="#l8.328"></a><span id="l8.328" class="difflineminus">-    // The document went away (bug 797307).</span>
<a href="#l8.329"></a><span id="l8.329" class="difflineminus">-    return null;</span>
<a href="#l8.330"></a><span id="l8.330" class="difflineminus">-  }</span>
<a href="#l8.331"></a><span id="l8.331" class="difflineminus">-  if (popupNode) {</span>
<a href="#l8.332"></a><span id="l8.332" class="difflineminus">-    let view = PlacesUIUtils.getViewForNode(popupNode);</span>
<a href="#l8.333"></a><span id="l8.333" class="difflineminus">-    if (view &amp;&amp; view._contextMenuShown)</span>
<a href="#l8.334"></a><span id="l8.334" class="difflineminus">-      return view.controllers.getControllerForCommand(aCommand);</span>
<a href="#l8.335"></a><span id="l8.335" class="difflineminus">-  }</span>
<a href="#l8.336"></a><span id="l8.336" class="difflineminus">-</span>
<a href="#l8.337"></a><span id="l8.337" class="difflineminus">-  // When we're not building a context menu, only focusable views</span>
<a href="#l8.338"></a><span id="l8.338" class="difflineminus">-  // are possible.  Thus, we can safely use the command dispatcher.</span>
<a href="#l8.339"></a><span id="l8.339" class="difflineminus">-  let controller = top.document.commandDispatcher</span>
<a href="#l8.340"></a><span id="l8.340" class="difflineminus">-                      .getControllerForCommand(aCommand);</span>
<a href="#l8.341"></a><span id="l8.341" class="difflineminus">-  if (controller)</span>
<a href="#l8.342"></a><span id="l8.342" class="difflineminus">-    return controller;</span>
<a href="#l8.343"></a><span id="l8.343" class="difflineminus">-</span>
<a href="#l8.344"></a><span id="l8.344" class="difflineminus">-  return null;</span>
<a href="#l8.345"></a><span id="l8.345" class="difflineminus">-}</span>
<a href="#l8.346"></a><span id="l8.346" class="difflineminus">-</span>
<a href="#l8.347"></a><span id="l8.347" class="difflineminus">-function goDoPlacesCommand(aCommand) {</span>
<a href="#l8.348"></a><span id="l8.348" class="difflineminus">-  let controller = doGetPlacesControllerForCommand(aCommand);</span>
<a href="#l8.349"></a><span id="l8.349" class="difflineminus">-  if (controller &amp;&amp; controller.isCommandEnabled(aCommand))</span>
<a href="#l8.350"></a><span id="l8.350" class="difflineminus">-    controller.doCommand(aCommand);</span>
<a href="#l8.351"></a><span id="l8.351" class="difflineminus">-}</span>
<a href="#l8.352"></a><span id="l8.352" class="difflineminus">-</span>
<a href="#l8.353"></a><span id="l8.353" class="difflineminus">-/**</span>
<a href="#l8.354"></a><span id="l8.354" class="difflineminus">- * This gets the most appropriate item for using for batching. In the case of multiple</span>
<a href="#l8.355"></a><span id="l8.355" class="difflineminus">- * views being related, the method returns the most expensive result to batch.</span>
<a href="#l8.356"></a><span id="l8.356" class="difflineminus">- * For example, if it detects the left-hand library pane, then it will look for</span>
<a href="#l8.357"></a><span id="l8.357" class="difflineminus">- * and return the reference to the right-hand pane.</span>
<a href="#l8.358"></a><span id="l8.358" class="difflineminus">- *</span>
<a href="#l8.359"></a><span id="l8.359" class="difflineminus">- * @param {Object} viewOrElement The item to check.</span>
<a href="#l8.360"></a><span id="l8.360" class="difflineminus">- * @return {Object} Will return the best result node to batch, or null</span>
<a href="#l8.361"></a><span id="l8.361" class="difflineminus">- *                  if one could not be found.</span>
<a href="#l8.362"></a><span id="l8.362" class="difflineminus">- */</span>
<a href="#l8.363"></a><span id="l8.363" class="difflineminus">-function getResultForBatching(viewOrElement) {</span>
<a href="#l8.364"></a><span id="l8.364" class="difflineminus">-  if (viewOrElement &amp;&amp; Element.isInstance(viewOrElement) &amp;&amp;</span>
<a href="#l8.365"></a><span id="l8.365" class="difflineminus">-      viewOrElement.id === &quot;placesList&quot;) {</span>
<a href="#l8.366"></a><span id="l8.366" class="difflineminus">-    // Note: fall back to the existing item if we can't find the right-hane pane.</span>
<a href="#l8.367"></a><span id="l8.367" class="difflineminus">-    viewOrElement = document.getElementById(&quot;placeContent&quot;) || viewOrElement;</span>
<a href="#l8.368"></a><span id="l8.368" class="difflineminus">-  }</span>
<a href="#l8.369"></a><span id="l8.369" class="difflineminus">-</span>
<a href="#l8.370"></a><span id="l8.370" class="difflineminus">-  if (viewOrElement &amp;&amp; viewOrElement.result) {</span>
<a href="#l8.371"></a><span id="l8.371" class="difflineminus">-    return viewOrElement.result;</span>
<a href="#l8.372"></a><span id="l8.372" class="difflineminus">-  }</span>
<a href="#l8.373"></a><span id="l8.373" class="difflineminus">-</span>
<a href="#l8.374"></a><span id="l8.374" class="difflineminus">-  return null;</span>
<a href="#l8.375"></a><span id="l8.375" class="difflineminus">-}</span>
<a href="#l8.376"></a><span id="l8.376" class="difflineminus">-</span>
<a href="#l8.377"></a><span id="l8.377" class="difflineminus">-/**</span>
<a href="#l8.378"></a><span id="l8.378" class="difflineminus">- * Processes a set of transfer items that have been dropped or pasted.</span>
<a href="#l8.379"></a><span id="l8.379" class="difflineminus">- * Batching will be applied where necessary.</span>
<a href="#l8.380"></a><span id="l8.380" class="difflineminus">- *</span>
<a href="#l8.381"></a><span id="l8.381" class="difflineminus">- * @param {Array} items A list of unwrapped nodes to process.</span>
<a href="#l8.382"></a><span id="l8.382" class="difflineminus">- * @param {Object} insertionPoint The requested point for insertion.</span>
<a href="#l8.383"></a><span id="l8.383" class="difflineminus">- * @param {Boolean} doCopy Set to true to copy the items, false will move them</span>
<a href="#l8.384"></a><span id="l8.384" class="difflineminus">- *                         if possible.</span>
<a href="#l8.385"></a><span id="l8.385" class="difflineminus">- * @return {Array} Returns an empty array when the insertion point is a tag, else</span>
<a href="#l8.386"></a><span id="l8.386" class="difflineminus">- *                 returns an array of copied or moved guids.</span>
<a href="#l8.387"></a><span id="l8.387" class="difflineminus">- */</span>
<a href="#l8.388"></a><span id="l8.388" class="difflineminus">-async function handleTransferItems(items, insertionPoint, doCopy, view) {</span>
<a href="#l8.389"></a><span id="l8.389" class="difflineminus">-  let transactions;</span>
<a href="#l8.390"></a><span id="l8.390" class="difflineminus">-  let itemsCount;</span>
<a href="#l8.391"></a><span id="l8.391" class="difflineminus">-  if (insertionPoint.isTag) {</span>
<a href="#l8.392"></a><span id="l8.392" class="difflineminus">-    let urls = items.filter(item =&gt; &quot;uri&quot; in item).map(item =&gt; item.uri);</span>
<a href="#l8.393"></a><span id="l8.393" class="difflineminus">-    itemsCount = urls.length;</span>
<a href="#l8.394"></a><span id="l8.394" class="difflineminus">-    transactions = [PlacesTransactions.Tag({ urls, tag: insertionPoint.tagName })];</span>
<a href="#l8.395"></a><span id="l8.395" class="difflineminus">-  } else {</span>
<a href="#l8.396"></a><span id="l8.396" class="difflineminus">-    let insertionIndex = await insertionPoint.getIndex();</span>
<a href="#l8.397"></a><span id="l8.397" class="difflineminus">-    itemsCount = items.length;</span>
<a href="#l8.398"></a><span id="l8.398" class="difflineminus">-    transactions = await getTransactionsForTransferItems(</span>
<a href="#l8.399"></a><span id="l8.399" class="difflineminus">-      items, insertionIndex, insertionPoint.guid, doCopy);</span>
<a href="#l8.400"></a><span id="l8.400" class="difflineminus">-  }</span>
<a href="#l8.401"></a><span id="l8.401" class="difflineminus">-</span>
<a href="#l8.402"></a><span id="l8.402" class="difflineminus">-  // Check if we actually have something to add, if we don't it probably wasn't</span>
<a href="#l8.403"></a><span id="l8.403" class="difflineminus">-  // valid, or it was moving to the same location, so just ignore it.</span>
<a href="#l8.404"></a><span id="l8.404" class="difflineminus">-  if (!transactions.length) {</span>
<a href="#l8.405"></a><span id="l8.405" class="difflineminus">-    return [];</span>
<a href="#l8.406"></a><span id="l8.406" class="difflineminus">-  }</span>
<a href="#l8.407"></a><span id="l8.407" class="difflineminus">-</span>
<a href="#l8.408"></a><span id="l8.408" class="difflineminus">-  let guidsToSelect = [];</span>
<a href="#l8.409"></a><span id="l8.409" class="difflineminus">-  let resultForBatching = getResultForBatching(view);</span>
<a href="#l8.410"></a><span id="l8.410" class="difflineminus">-</span>
<a href="#l8.411"></a><span id="l8.411" class="difflineminus">-  // If we're inserting into a tag, we don't get the guid, so we'll just</span>
<a href="#l8.412"></a><span id="l8.412" class="difflineminus">-  // pass the transactions direct to the batch function.</span>
<a href="#l8.413"></a><span id="l8.413" class="difflineminus">-  let batchingItem = transactions;</span>
<a href="#l8.414"></a><span id="l8.414" class="difflineminus">-  if (!insertionPoint.isTag) {</span>
<a href="#l8.415"></a><span id="l8.415" class="difflineminus">-    // If we're not a tag, then we need to get the ids of the items to select.</span>
<a href="#l8.416"></a><span id="l8.416" class="difflineminus">-    batchingItem = async () =&gt; {</span>
<a href="#l8.417"></a><span id="l8.417" class="difflineminus">-      for (let transaction of transactions) {</span>
<a href="#l8.418"></a><span id="l8.418" class="difflineminus">-        let guid = await transaction.transact();</span>
<a href="#l8.419"></a><span id="l8.419" class="difflineminus">-        if (guid) {</span>
<a href="#l8.420"></a><span id="l8.420" class="difflineminus">-          guidsToSelect.push(guid);</span>
<a href="#l8.421"></a><span id="l8.421" class="difflineminus">-        }</span>
<a href="#l8.422"></a><span id="l8.422" class="difflineminus">-      }</span>
<a href="#l8.423"></a><span id="l8.423" class="difflineminus">-    };</span>
<a href="#l8.424"></a><span id="l8.424" class="difflineminus">-  }</span>
<a href="#l8.425"></a><span id="l8.425" class="difflineminus">-</span>
<a href="#l8.426"></a><span id="l8.426" class="difflineminus">-  await PlacesUIUtils.batchUpdatesForNode(resultForBatching, itemsCount, async () =&gt; {</span>
<a href="#l8.427"></a><span id="l8.427" class="difflineminus">-    await PlacesTransactions.batch(batchingItem);</span>
<a href="#l8.428"></a><span id="l8.428" class="difflineminus">-  });</span>
<a href="#l8.429"></a><span id="l8.429" class="difflineminus">-</span>
<a href="#l8.430"></a><span id="l8.430" class="difflineminus">-  return guidsToSelect;</span>
<a href="#l8.431"></a><span id="l8.431" class="difflineminus">-}</span>
<a href="#l8.432"></a><span id="l8.432" class="difflineminus">-</span>
<a href="#l8.433"></a><span id="l8.433" class="difflineminus">-/**</span>
<a href="#l8.434"></a><span id="l8.434" class="difflineminus">- * Processes a set of transfer items and returns transactions to insert or</span>
<a href="#l8.435"></a><span id="l8.435" class="difflineminus">- * move them.</span>
<a href="#l8.436"></a><span id="l8.436" class="difflineminus">- *</span>
<a href="#l8.437"></a><span id="l8.437" class="difflineminus">- * @param {Array} items A list of unwrapped nodes to get transactions for.</span>
<a href="#l8.438"></a><span id="l8.438" class="difflineminus">- * @param {Integer} insertionIndex The requested index for insertion.</span>
<a href="#l8.439"></a><span id="l8.439" class="difflineminus">- * @param {String} insertionParentGuid The guid of the parent folder to insert</span>
<a href="#l8.440"></a><span id="l8.440" class="difflineminus">- *                                     or move the items to.</span>
<a href="#l8.441"></a><span id="l8.441" class="difflineminus">- * @param {Boolean} doCopy Set to true to copy the items, false will move them</span>
<a href="#l8.442"></a><span id="l8.442" class="difflineminus">- *                         if possible.</span>
<a href="#l8.443"></a><span id="l8.443" class="difflineminus">- * @return {Array} Returns an array of created PlacesTransactions.</span>
<a href="#l8.444"></a><span id="l8.444" class="difflineminus">- */</span>
<a href="#l8.445"></a><span id="l8.445" class="difflineminus">-async function getTransactionsForTransferItems(items, insertionIndex,</span>
<a href="#l8.446"></a><span id="l8.446" class="difflineminus">-                                               insertionParentGuid, doCopy) {</span>
<a href="#l8.447"></a><span id="l8.447" class="difflineminus">-  let transactions = [];</span>
<a href="#l8.448"></a><span id="l8.448" class="difflineminus">-  let index = insertionIndex;</span>
<a href="#l8.449"></a><span id="l8.449" class="difflineminus">-</span>
<a href="#l8.450"></a><span id="l8.450" class="difflineminus">-  for (let item of items) {</span>
<a href="#l8.451"></a><span id="l8.451" class="difflineminus">-    if (index != -1 &amp;&amp; item.itemGuid) {</span>
<a href="#l8.452"></a><span id="l8.452" class="difflineminus">-      // Note: we use the parent from the existing bookmark as the sidebar</span>
<a href="#l8.453"></a><span id="l8.453" class="difflineminus">-      // gives us an unwrapped.parent that is actually a query and not the real</span>
<a href="#l8.454"></a><span id="l8.454" class="difflineminus">-      // parent.</span>
<a href="#l8.455"></a><span id="l8.455" class="difflineminus">-      let existingBookmark = await PlacesUtils.bookmarks.fetch(item.itemGuid);</span>
<a href="#l8.456"></a><span id="l8.456" class="difflineminus">-</span>
<a href="#l8.457"></a><span id="l8.457" class="difflineminus">-      // If we're dropping on the same folder, then we may need to adjust</span>
<a href="#l8.458"></a><span id="l8.458" class="difflineminus">-      // the index to insert at the correct place.</span>
<a href="#l8.459"></a><span id="l8.459" class="difflineminus">-      if (existingBookmark &amp;&amp; insertionParentGuid == existingBookmark.parentGuid) {</span>
<a href="#l8.460"></a><span id="l8.460" class="difflineminus">-        if (index &gt; existingBookmark.index) {</span>
<a href="#l8.461"></a><span id="l8.461" class="difflineminus">-          // If we're dragging down, we need to go one lower to insert at</span>
<a href="#l8.462"></a><span id="l8.462" class="difflineminus">-          // the real point as moving the element changes the index of</span>
<a href="#l8.463"></a><span id="l8.463" class="difflineminus">-          // everything below by 1.</span>
<a href="#l8.464"></a><span id="l8.464" class="difflineminus">-          index--;</span>
<a href="#l8.465"></a><span id="l8.465" class="difflineminus">-        } else if (index == existingBookmark.index) {</span>
<a href="#l8.466"></a><span id="l8.466" class="difflineminus">-          // This isn't moving so we skip it.</span>
<a href="#l8.467"></a><span id="l8.467" class="difflineminus">-          continue;</span>
<a href="#l8.468"></a><span id="l8.468" class="difflineminus">-        }</span>
<a href="#l8.469"></a><span id="l8.469" class="difflineminus">-      }</span>
<a href="#l8.470"></a><span id="l8.470" class="difflineminus">-    }</span>
<a href="#l8.471"></a><span id="l8.471" class="difflineminus">-</span>
<a href="#l8.472"></a><span id="l8.472" class="difflineminus">-    // If this is not a copy, check for safety that we can move the</span>
<a href="#l8.473"></a><span id="l8.473" class="difflineminus">-    // source, otherwise report an error and fallback to a copy.</span>
<a href="#l8.474"></a><span id="l8.474" class="difflineminus">-    if (!doCopy &amp;&amp; !PlacesControllerDragHelper.canMoveUnwrappedNode(item)) {</span>
<a href="#l8.475"></a><span id="l8.475" class="difflineminus">-      Cu.reportError(&quot;Tried to move an unmovable Places &quot; +</span>
<a href="#l8.476"></a><span id="l8.476" class="difflineminus">-                                   &quot;node, reverting to a copy operation.&quot;);</span>
<a href="#l8.477"></a><span id="l8.477" class="difflineminus">-      doCopy = true;</span>
<a href="#l8.478"></a><span id="l8.478" class="difflineminus">-    }</span>
<a href="#l8.479"></a><span id="l8.479" class="difflineminus">-    transactions.push(</span>
<a href="#l8.480"></a><span id="l8.480" class="difflineminus">-      PlacesUIUtils.getTransactionForData(item,</span>
<a href="#l8.481"></a><span id="l8.481" class="difflineminus">-                                          insertionParentGuid,</span>
<a href="#l8.482"></a><span id="l8.482" class="difflineminus">-                                          index,</span>
<a href="#l8.483"></a><span id="l8.483" class="difflineminus">-                                          doCopy));</span>
<a href="#l8.484"></a><span id="l8.484" class="difflineminus">-</span>
<a href="#l8.485"></a><span id="l8.485" class="difflineminus">-    if (index != -1 &amp;&amp; item.itemGuid) {</span>
<a href="#l8.486"></a><span id="l8.486" class="difflineminus">-      index++;</span>
<a href="#l8.487"></a><span id="l8.487" class="difflineminus">-    }</span>
<a href="#l8.488"></a><span id="l8.488" class="difflineminus">-  }</span>
<a href="#l8.489"></a><span id="l8.489" class="difflineminus">-  return transactions;</span>
<a href="#l8.490"></a><span id="l8.490" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/suite/components/places/content/editBookmarkOverlay.js</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/suite/components/places/content/editBookmarkOverlay.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -1,13 +1,14 @@</span>
<a href="#l9.4"></a><span id="l9.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l9.5"></a><span id="l9.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l9.6"></a><span id="l9.6">  * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l9.7"></a><span id="l9.7"> </span>
<a href="#l9.8"></a><span id="l9.8"> ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l9.9"></a><span id="l9.9" class="difflineplus">+ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l9.10"></a><span id="l9.10"> </span>
<a href="#l9.11"></a><span id="l9.11"> const LAST_USED_ANNO = &quot;bookmarkPropertiesDialog/folderLastUsed&quot;;</span>
<a href="#l9.12"></a><span id="l9.12"> const MAX_FOLDER_ITEM_IN_MENU_LIST = 5;</span>
<a href="#l9.13"></a><span id="l9.13"> </span>
<a href="#l9.14"></a><span id="l9.14"> var gEditItemOverlay = {</span>
<a href="#l9.15"></a><span id="l9.15">   _observersAdded: false,</span>
<a href="#l9.16"></a><span id="l9.16">   _staticFoldersListBuilt: false,</span>
<a href="#l9.17"></a><span id="l9.17"> </span>
<a href="#l9.18"></a><span id="l9.18" class="difflineat">@@ -34,17 +35,17 @@ var gEditItemOverlay = {</span>
<a href="#l9.19"></a><span id="l9.19">                            node.type == Ci.nsINavHistoryResultNode.RESULT_TYPE_FOLDER_SHORTCUT;</span>
<a href="#l9.20"></a><span id="l9.20">     let isTag = node &amp;&amp; PlacesUtils.nodeIsTagQuery(node);</span>
<a href="#l9.21"></a><span id="l9.21">     if (isTag) {</span>
<a href="#l9.22"></a><span id="l9.22">       itemId = PlacesUtils.getConcreteItemId(node);</span>
<a href="#l9.23"></a><span id="l9.23">       // For now we don't have access to the item guid synchronously for tags,</span>
<a href="#l9.24"></a><span id="l9.24">       // so we'll need to fetch it later.</span>
<a href="#l9.25"></a><span id="l9.25">     }</span>
<a href="#l9.26"></a><span id="l9.26">     let isURI = node &amp;&amp; PlacesUtils.nodeIsURI(node);</span>
<a href="#l9.27"></a><span id="l9.27" class="difflineminus">-    let uri = isURI ? NetUtil.newURI(node.uri) : null;</span>
<a href="#l9.28"></a><span id="l9.28" class="difflineplus">+    let uri = isURI ? Services.io.newURI(node.uri) : null;</span>
<a href="#l9.29"></a><span id="l9.29">     let title = node ? node.title : null;</span>
<a href="#l9.30"></a><span id="l9.30">     let isBookmark = isItem &amp;&amp; isURI;</span>
<a href="#l9.31"></a><span id="l9.31">     let bulkTagging = !node;</span>
<a href="#l9.32"></a><span id="l9.32">     let uris = bulkTagging ? aInitInfo.uris : null;</span>
<a href="#l9.33"></a><span id="l9.33">     let visibleRows = new Set();</span>
<a href="#l9.34"></a><span id="l9.34">     let isParentReadOnly = false;</span>
<a href="#l9.35"></a><span id="l9.35">     let postData = aInitInfo.postData;</span>
<a href="#l9.36"></a><span id="l9.36">     let parentId = -1;</span>
<a href="#l9.37"></a><span id="l9.37" class="difflineat">@@ -929,17 +930,17 @@ var gEditItemOverlay = {</span>
<a href="#l9.38"></a><span id="l9.38">                .filter(tag =&gt; tag.length &gt; 0); // Kill empty tags.</span>
<a href="#l9.39"></a><span id="l9.39">   },</span>
<a href="#l9.40"></a><span id="l9.40"> </span>
<a href="#l9.41"></a><span id="l9.41">   async newFolder() {</span>
<a href="#l9.42"></a><span id="l9.42">     let ip = this._folderTree.insertionPoint;</span>
<a href="#l9.43"></a><span id="l9.43"> </span>
<a href="#l9.44"></a><span id="l9.44">     // default to the bookmarks menu folder</span>
<a href="#l9.45"></a><span id="l9.45">     if (!ip) {</span>
<a href="#l9.46"></a><span id="l9.46" class="difflineminus">-      ip = new InsertionPoint({</span>
<a href="#l9.47"></a><span id="l9.47" class="difflineplus">+      ip = new PlacesInsertionPoint({</span>
<a href="#l9.48"></a><span id="l9.48">         parentId: PlacesUtils.bookmarksMenuFolderId,</span>
<a href="#l9.49"></a><span id="l9.49">         parentGuid: PlacesUtils.bookmarks.menuGuid</span>
<a href="#l9.50"></a><span id="l9.50">       });</span>
<a href="#l9.51"></a><span id="l9.51">     }</span>
<a href="#l9.52"></a><span id="l9.52"> </span>
<a href="#l9.53"></a><span id="l9.53">     // XXXmano: add a separate &quot;New Folder&quot; string at some point...</span>
<a href="#l9.54"></a><span id="l9.54">     let title = this._element(&quot;newFolderButton&quot;).label;</span>
<a href="#l9.55"></a><span id="l9.55">     await PlacesTransactions.NewFolder({ parentGuid: ip.guid, title,</span>
<a href="#l9.56"></a><span id="l9.56" class="difflineat">@@ -1069,17 +1070,17 @@ var gEditItemOverlay = {</span>
<a href="#l9.57"></a><span id="l9.57">     }</span>
<a href="#l9.58"></a><span id="l9.58"> </span>
<a href="#l9.59"></a><span id="l9.59">     if (!this._paneInfo.isItem || this._paneInfo.itemId != aItemId) {</span>
<a href="#l9.60"></a><span id="l9.60">       return;</span>
<a href="#l9.61"></a><span id="l9.61">     }</span>
<a href="#l9.62"></a><span id="l9.62"> </span>
<a href="#l9.63"></a><span id="l9.63">     switch (aProperty) {</span>
<a href="#l9.64"></a><span id="l9.64">     case &quot;uri&quot;:</span>
<a href="#l9.65"></a><span id="l9.65" class="difflineminus">-      let newURI = NetUtil.newURI(aValue);</span>
<a href="#l9.66"></a><span id="l9.66" class="difflineplus">+      let newURI = Services.ui.newURI(aValue);</span>
<a href="#l9.67"></a><span id="l9.67">       if (!newURI.equals(this._paneInfo.uri)) {</span>
<a href="#l9.68"></a><span id="l9.68">         this._paneInfo.uri = newURI;</span>
<a href="#l9.69"></a><span id="l9.69">         if (this._paneInfo.visibleRows.has(&quot;locationRow&quot;))</span>
<a href="#l9.70"></a><span id="l9.70">           this._initLocationField();</span>
<a href="#l9.71"></a><span id="l9.71"> </span>
<a href="#l9.72"></a><span id="l9.72">         if (this._paneInfo.visibleRows.has(&quot;tagsRow&quot;)) {</span>
<a href="#l9.73"></a><span id="l9.73">           delete this._paneInfo._cachedCommonTags;</span>
<a href="#l9.74"></a><span id="l9.74">           this._onTagsChange(aGuid, newURI).catch(Cu.reportError);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/suite/components/places/content/menu.xml</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/suite/components/places/content/menu.xml</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -85,17 +85,17 @@</span>
<a href="#l10.4"></a><span id="l10.4">             let eventY = aEvent.layerY + (scrollbox.boxObject.y - this.boxObject.y);</span>
<a href="#l10.5"></a><span id="l10.5">             let scrollboxOffset = scrollbox.scrollBoxObject.y -</span>
<a href="#l10.6"></a><span id="l10.6">                                   (scrollbox.boxObject.y - this.boxObject.y);</span>
<a href="#l10.7"></a><span id="l10.7">             let eltY = elt.boxObject.y - scrollboxOffset;</span>
<a href="#l10.8"></a><span id="l10.8">             let eltHeight = elt.boxObject.height;</span>
<a href="#l10.9"></a><span id="l10.9"> </span>
<a href="#l10.10"></a><span id="l10.10">             if (!elt._placesNode) {</span>
<a href="#l10.11"></a><span id="l10.11">               // If we are dragging over a non places node drop at the end.</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-              dropPoint.ip = new InsertionPoint({</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+              dropPoint.ip = new PlacesInsertionPoint({</span>
<a href="#l10.14"></a><span id="l10.14">                 parentId: PlacesUtils.getConcreteItemId(resultNode),</span>
<a href="#l10.15"></a><span id="l10.15">                 parentGuid: PlacesUtils.getConcreteItemGuid(resultNode)</span>
<a href="#l10.16"></a><span id="l10.16">               });</span>
<a href="#l10.17"></a><span id="l10.17">               // We can set folderElt if we are dropping over a static menu that</span>
<a href="#l10.18"></a><span id="l10.18">               // has an internal placespopup.</span>
<a href="#l10.19"></a><span id="l10.19">               let isMenu = elt.localName == &quot;menu&quot; ||</span>
<a href="#l10.20"></a><span id="l10.20">                  (elt.localName == &quot;toolbarbutton&quot; &amp;&amp;</span>
<a href="#l10.21"></a><span id="l10.21">                   elt.getAttribute(&quot;type&quot;) == &quot;menu&quot;);</span>
<a href="#l10.22"></a><span id="l10.22" class="difflineat">@@ -108,49 +108,49 @@</span>
<a href="#l10.23"></a><span id="l10.23">             let tagName = PlacesUtils.nodeIsTagQuery(elt._placesNode) ?</span>
<a href="#l10.24"></a><span id="l10.24">                             elt._placesNode.title : null;</span>
<a href="#l10.25"></a><span id="l10.25">             if ((PlacesUtils.nodeIsFolder(elt._placesNode) &amp;&amp;</span>
<a href="#l10.26"></a><span id="l10.26">                  !PlacesUIUtils.isFolderReadOnly(elt._placesNode, this._rootView)) ||</span>
<a href="#l10.27"></a><span id="l10.27">                 PlacesUtils.nodeIsTagQuery(elt._placesNode)) {</span>
<a href="#l10.28"></a><span id="l10.28">               // This is a folder or a tag container.</span>
<a href="#l10.29"></a><span id="l10.29">               if (eventY - eltY &lt; eltHeight * 0.20) {</span>
<a href="#l10.30"></a><span id="l10.30">                 // If mouse is in the top part of the element, drop above folder.</span>
<a href="#l10.31"></a><span id="l10.31" class="difflineminus">-                dropPoint.ip = new InsertionPoint({</span>
<a href="#l10.32"></a><span id="l10.32" class="difflineplus">+                dropPoint.ip = new PlacesInsertionPoint({</span>
<a href="#l10.33"></a><span id="l10.33">                   parentId: PlacesUtils.getConcreteItemId(resultNode),</span>
<a href="#l10.34"></a><span id="l10.34">                   parentGuid: PlacesUtils.getConcreteItemGuid(resultNode),</span>
<a href="#l10.35"></a><span id="l10.35">                   orientation: Ci.nsITreeView.DROP_BEFORE,</span>
<a href="#l10.36"></a><span id="l10.36">                   tagName,</span>
<a href="#l10.37"></a><span id="l10.37">                   dropNearNode: elt._placesNode</span>
<a href="#l10.38"></a><span id="l10.38">                 });</span>
<a href="#l10.39"></a><span id="l10.39">                 return dropPoint;</span>
<a href="#l10.40"></a><span id="l10.40">               } else if (eventY - eltY &lt; eltHeight * 0.80) {</span>
<a href="#l10.41"></a><span id="l10.41">                 // If mouse is in the middle of the element, drop inside folder.</span>
<a href="#l10.42"></a><span id="l10.42" class="difflineminus">-                dropPoint.ip = new InsertionPoint({</span>
<a href="#l10.43"></a><span id="l10.43" class="difflineplus">+                dropPoint.ip = new PlacesInsertionPoint({</span>
<a href="#l10.44"></a><span id="l10.44">                   parentId: PlacesUtils.getConcreteItemId(elt._placesNode),</span>
<a href="#l10.45"></a><span id="l10.45">                   parentGuid: PlacesUtils.getConcreteItemGuid(elt._placesNode),</span>
<a href="#l10.46"></a><span id="l10.46">                   tagName</span>
<a href="#l10.47"></a><span id="l10.47">                 });</span>
<a href="#l10.48"></a><span id="l10.48">                 dropPoint.folderElt = elt;</span>
<a href="#l10.49"></a><span id="l10.49">                 return dropPoint;</span>
<a href="#l10.50"></a><span id="l10.50">               }</span>
<a href="#l10.51"></a><span id="l10.51">             } else if (eventY - eltY &lt;= eltHeight / 2) {</span>
<a href="#l10.52"></a><span id="l10.52">               // This is a non-folder node or a readonly folder.</span>
<a href="#l10.53"></a><span id="l10.53">               // If the mouse is above the middle, drop above this item.</span>
<a href="#l10.54"></a><span id="l10.54" class="difflineminus">-              dropPoint.ip = new InsertionPoint({</span>
<a href="#l10.55"></a><span id="l10.55" class="difflineplus">+              dropPoint.ip = new PlacesInsertionPoint({</span>
<a href="#l10.56"></a><span id="l10.56">                 parentId: PlacesUtils.getConcreteItemId(resultNode),</span>
<a href="#l10.57"></a><span id="l10.57">                 parentGuid: PlacesUtils.getConcreteItemGuid(resultNode),</span>
<a href="#l10.58"></a><span id="l10.58">                 orientation: Ci.nsITreeView.DROP_BEFORE,</span>
<a href="#l10.59"></a><span id="l10.59">                 tagName,</span>
<a href="#l10.60"></a><span id="l10.60">                 dropNearNode: elt._placesNode</span>
<a href="#l10.61"></a><span id="l10.61">               });</span>
<a href="#l10.62"></a><span id="l10.62">               return dropPoint;</span>
<a href="#l10.63"></a><span id="l10.63">             }</span>
<a href="#l10.64"></a><span id="l10.64"> </span>
<a href="#l10.65"></a><span id="l10.65">             // Drop below the item.</span>
<a href="#l10.66"></a><span id="l10.66" class="difflineminus">-            dropPoint.ip = new InsertionPoint({</span>
<a href="#l10.67"></a><span id="l10.67" class="difflineplus">+            dropPoint.ip = new PlacesInsertionPoint({</span>
<a href="#l10.68"></a><span id="l10.68">               parentId: PlacesUtils.getConcreteItemId(resultNode),</span>
<a href="#l10.69"></a><span id="l10.69">               parentGuid: PlacesUtils.getConcreteItemGuid(resultNode),</span>
<a href="#l10.70"></a><span id="l10.70">               orientation: Ci.nsITreeView.DROP_AFTER,</span>
<a href="#l10.71"></a><span id="l10.71">               tagName,</span>
<a href="#l10.72"></a><span id="l10.72">               dropNearNode: elt._placesNode,</span>
<a href="#l10.73"></a><span id="l10.73">             });</span>
<a href="#l10.74"></a><span id="l10.74">             return dropPoint;</span>
<a href="#l10.75"></a><span id="l10.75">         ]]&gt;&lt;/body&gt;</span>
<a href="#l10.76"></a><span id="l10.76" class="difflineat">@@ -345,17 +345,17 @@</span>
<a href="#l10.77"></a><span id="l10.77">         let elt = event.target;</span>
<a href="#l10.78"></a><span id="l10.78">         if (!elt._placesNode)</span>
<a href="#l10.79"></a><span id="l10.79">           return;</span>
<a href="#l10.80"></a><span id="l10.80"> </span>
<a href="#l10.81"></a><span id="l10.81">         let draggedElt = elt._placesNode;</span>
<a href="#l10.82"></a><span id="l10.82"> </span>
<a href="#l10.83"></a><span id="l10.83">         // Force a copy action if parent node is a query or we are dragging a</span>
<a href="#l10.84"></a><span id="l10.84">         // not-removable node.</span>
<a href="#l10.85"></a><span id="l10.85" class="difflineminus">-        if (!PlacesControllerDragHelper.canMoveNode(draggedElt, this._rootView))</span>
<a href="#l10.86"></a><span id="l10.86" class="difflineplus">+        if (!this._rootView.controller.canMoveNode(draggedElt))</span>
<a href="#l10.87"></a><span id="l10.87">           event.dataTransfer.effectAllowed = &quot;copyLink&quot;;</span>
<a href="#l10.88"></a><span id="l10.88"> </span>
<a href="#l10.89"></a><span id="l10.89">         // Activate the view and cache the dragged element.</span>
<a href="#l10.90"></a><span id="l10.90">         this._rootView._draggedElt = draggedElt;</span>
<a href="#l10.91"></a><span id="l10.91">         this._rootView.controller.setDataTransfer(event);</span>
<a href="#l10.92"></a><span id="l10.92">         this.setAttribute(&quot;dragstart&quot;, &quot;true&quot;);</span>
<a href="#l10.93"></a><span id="l10.93">         event.stopPropagation();</span>
<a href="#l10.94"></a><span id="l10.94">       ]]&gt;&lt;/handler&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/suite/components/places/content/placesOverlay.xul</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/suite/components/places/content/placesOverlay.xul</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -18,73 +18,79 @@</span>
<a href="#l11.4"></a><span id="l11.4">   &lt;script type=&quot;application/javascript&quot;&gt;&lt;![CDATA[</span>
<a href="#l11.5"></a><span id="l11.5">     ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l11.6"></a><span id="l11.6">     ChromeUtils.defineModuleGetter(window,</span>
<a href="#l11.7"></a><span id="l11.7">       &quot;PlacesUtils&quot;, &quot;resource://gre/modules/PlacesUtils.jsm&quot;);</span>
<a href="#l11.8"></a><span id="l11.8">     ChromeUtils.defineModuleGetter(window,</span>
<a href="#l11.9"></a><span id="l11.9">       &quot;PlacesUIUtils&quot;, &quot;resource:///modules/PlacesUIUtils.jsm&quot;);</span>
<a href="#l11.10"></a><span id="l11.10">     ChromeUtils.defineModuleGetter(window,</span>
<a href="#l11.11"></a><span id="l11.11">       &quot;PlacesTransactions&quot;, &quot;resource://gre/modules/PlacesTransactions.jsm&quot;);</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineplus">+    ChromeUtils.defineModuleGetter(window,</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+      &quot;ForgetAboutSite&quot;, &quot;resource://gre/modules/ForgetAboutSite.jsm&quot;);</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineplus">+    ChromeUtils.defineModuleGetter(window,</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineplus">+      &quot;PrivateBrowsingUtils&quot;, &quot;resource://gre/modules/PrivateBrowsingUtils.jsm&quot;);</span>
<a href="#l11.16"></a><span id="l11.16" class="difflineplus">+</span>
<a href="#l11.17"></a><span id="l11.17">     XPCOMUtils.defineLazyScriptGetter(window, &quot;PlacesTreeView&quot;,</span>
<a href="#l11.18"></a><span id="l11.18">       &quot;chrome://communicator/content/places/treeView.js&quot;);</span>
<a href="#l11.19"></a><span id="l11.19" class="difflineplus">+    XPCOMUtils.defineLazyScriptGetter(window,</span>
<a href="#l11.20"></a><span id="l11.20" class="difflineplus">+      [&quot;PlacesInsertionPoint&quot;, &quot;PlacesController&quot;, &quot;PlacesControllerDragHelper&quot;],</span>
<a href="#l11.21"></a><span id="l11.21" class="difflineplus">+      &quot;chrome://communicator/content/places/controller.js&quot;);</span>
<a href="#l11.22"></a><span id="l11.22">   ]]&gt;&lt;/script&gt;</span>
<a href="#l11.23"></a><span id="l11.23" class="difflineminus">-  &lt;script type=&quot;application/javascript&quot;</span>
<a href="#l11.24"></a><span id="l11.24" class="difflineminus">-          src=&quot;chrome://communicator/content/places/controller.js&quot;/&gt;</span>
<a href="#l11.25"></a><span id="l11.25"> </span>
<a href="#l11.26"></a><span id="l11.26">   &lt;!-- Bookmarks and history tooltip --&gt;</span>
<a href="#l11.27"></a><span id="l11.27">   &lt;tooltip id=&quot;bhTooltip&quot; noautohide=&quot;true&quot;</span>
<a href="#l11.28"></a><span id="l11.28">            onpopupshowing=&quot;return window.top.BookmarksEventHandler.fillInBHTooltip(document, event)&quot;&gt;</span>
<a href="#l11.29"></a><span id="l11.29">     &lt;vbox id=&quot;bhTooltipTextBox&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l11.30"></a><span id="l11.30">       &lt;label id=&quot;bhtTitleText&quot; class=&quot;tooltip-label&quot; /&gt;</span>
<a href="#l11.31"></a><span id="l11.31">       &lt;label id=&quot;bhtUrlText&quot; crop=&quot;center&quot; class=&quot;tooltip-label uri-element&quot; /&gt;</span>
<a href="#l11.32"></a><span id="l11.32">     &lt;/vbox&gt;</span>
<a href="#l11.33"></a><span id="l11.33">   &lt;/tooltip&gt;</span>
<a href="#l11.34"></a><span id="l11.34"> </span>
<a href="#l11.35"></a><span id="l11.35">   &lt;commandset id=&quot;placesCommands&quot;</span>
<a href="#l11.36"></a><span id="l11.36">               commandupdater=&quot;true&quot;</span>
<a href="#l11.37"></a><span id="l11.37">               events=&quot;focus,sort,places&quot;</span>
<a href="#l11.38"></a><span id="l11.38" class="difflineminus">-              oncommandupdate=&quot;goUpdatePlacesCommands();&quot;&gt;</span>
<a href="#l11.39"></a><span id="l11.39" class="difflineplus">+              oncommandupdate=&quot;PlacesUIUtils.updateCommands(window);&quot;&gt;</span>
<a href="#l11.40"></a><span id="l11.40">     &lt;command id=&quot;placesCmd_open&quot;</span>
<a href="#l11.41"></a><span id="l11.41" class="difflineminus">-             oncommand=&quot;goDoPlacesCommand('placesCmd_open');&quot;/&gt;</span>
<a href="#l11.42"></a><span id="l11.42" class="difflineplus">+             oncommand=&quot;PlacesUIUtils.doCommand(window, 'placesCmd_open');&quot;/&gt;</span>
<a href="#l11.43"></a><span id="l11.43">     &lt;command id=&quot;placesCmd_open:window&quot;</span>
<a href="#l11.44"></a><span id="l11.44" class="difflineminus">-             oncommand=&quot;goDoPlacesCommand('placesCmd_open:window');&quot;/&gt;</span>
<a href="#l11.45"></a><span id="l11.45" class="difflineplus">+             oncommand=&quot;PlacesUIUtils.doCommand(window, 'placesCmd_open:window');&quot;/&gt;</span>
<a href="#l11.46"></a><span id="l11.46">     &lt;command id=&quot;placesCmd_open:privatewindow&quot;</span>
<a href="#l11.47"></a><span id="l11.47" class="difflineminus">-             oncommand=&quot;goDoPlacesCommand('placesCmd_open:privatewindow');&quot;/&gt;</span>
<a href="#l11.48"></a><span id="l11.48" class="difflineplus">+             oncommand=&quot;PlacesUIUtils.doCommand(window, 'placesCmd_open:privatewindow');&quot;/&gt;</span>
<a href="#l11.49"></a><span id="l11.49">     &lt;command id=&quot;placesCmd_open:tab&quot;</span>
<a href="#l11.50"></a><span id="l11.50" class="difflineminus">-             oncommand=&quot;goDoPlacesCommand('placesCmd_open:tab');&quot;/&gt;</span>
<a href="#l11.51"></a><span id="l11.51" class="difflineplus">+             oncommand=&quot;PlacesUIUtils.doCommand(window, 'placesCmd_open:tab');&quot;/&gt;</span>
<a href="#l11.52"></a><span id="l11.52"> </span>
<a href="#l11.53"></a><span id="l11.53">     &lt;command id=&quot;placesCmd_new:bookmark&quot;</span>
<a href="#l11.54"></a><span id="l11.54" class="difflineminus">-             oncommand=&quot;goDoPlacesCommand('placesCmd_new:bookmark');&quot;/&gt;</span>
<a href="#l11.55"></a><span id="l11.55" class="difflineplus">+             oncommand=&quot;PlacesUIUtils.doCommand(window, 'placesCmd_new:bookmark');&quot;/&gt;</span>
<a href="#l11.56"></a><span id="l11.56">     &lt;command id=&quot;placesCmd_new:folder&quot;</span>
<a href="#l11.57"></a><span id="l11.57" class="difflineminus">-             oncommand=&quot;goDoPlacesCommand('placesCmd_new:folder');&quot;/&gt;</span>
<a href="#l11.58"></a><span id="l11.58" class="difflineplus">+             oncommand=&quot;PlacesUIUtils.doCommand(window, 'placesCmd_new:folder');&quot;/&gt;</span>
<a href="#l11.59"></a><span id="l11.59">     &lt;command id=&quot;placesCmd_new:separator&quot;</span>
<a href="#l11.60"></a><span id="l11.60" class="difflineminus">-             oncommand=&quot;goDoPlacesCommand('placesCmd_new:separator');&quot;/&gt;</span>
<a href="#l11.61"></a><span id="l11.61" class="difflineplus">+             oncommand=&quot;PlacesUIUtils.doCommand(window, 'placesCmd_new:separator');&quot;/&gt;</span>
<a href="#l11.62"></a><span id="l11.62">     &lt;command id=&quot;placesCmd_show:info&quot;</span>
<a href="#l11.63"></a><span id="l11.63" class="difflineminus">-             oncommand=&quot;goDoPlacesCommand('placesCmd_show:info');&quot;/&gt;</span>
<a href="#l11.64"></a><span id="l11.64" class="difflineplus">+             oncommand=&quot;PlacesUIUtils.doCommand(window, 'placesCmd_show:info');&quot;/&gt;</span>
<a href="#l11.65"></a><span id="l11.65">     &lt;command id=&quot;placesCmd_rename&quot;</span>
<a href="#l11.66"></a><span id="l11.66" class="difflineminus">-             oncommand=&quot;goDoPlacesCommand('placesCmd_show:info');&quot;</span>
<a href="#l11.67"></a><span id="l11.67" class="difflineplus">+             oncommand=&quot;PlacesUIUtils.doCommand(window, 'placesCmd_show:info');&quot;</span>
<a href="#l11.68"></a><span id="l11.68">              observes=&quot;placesCmd_show:info&quot;/&gt;</span>
<a href="#l11.69"></a><span id="l11.69">     &lt;command id=&quot;placesCmd_reload&quot;</span>
<a href="#l11.70"></a><span id="l11.70" class="difflineminus">-             oncommand=&quot;goDoPlacesCommand('placesCmd_reload');&quot;/&gt;</span>
<a href="#l11.71"></a><span id="l11.71" class="difflineplus">+             oncommand=&quot;PlacesUIUtils.doCommand(window, 'placesCmd_reload');&quot;/&gt;</span>
<a href="#l11.72"></a><span id="l11.72">     &lt;command id=&quot;placesCmd_sortBy:name&quot;</span>
<a href="#l11.73"></a><span id="l11.73" class="difflineminus">-             oncommand=&quot;goDoPlacesCommand('placesCmd_sortBy:name');&quot;/&gt;</span>
<a href="#l11.74"></a><span id="l11.74" class="difflineplus">+             oncommand=&quot;PlacesUIUtils.doCommand(window, 'placesCmd_sortBy:name');&quot;/&gt;</span>
<a href="#l11.75"></a><span id="l11.75">     &lt;command id=&quot;placesCmd_deleteDataHost&quot;</span>
<a href="#l11.76"></a><span id="l11.76" class="difflineminus">-             oncommand=&quot;goDoPlacesCommand('placesCmd_deleteDataHost');&quot;/&gt;</span>
<a href="#l11.77"></a><span id="l11.77" class="difflineplus">+             oncommand=&quot;PlacesUIUtils.doCommand(window, 'placesCmd_deleteDataHost');&quot;/&gt;</span>
<a href="#l11.78"></a><span id="l11.78">     &lt;command id=&quot;placesCmd_createBookmark&quot;</span>
<a href="#l11.79"></a><span id="l11.79" class="difflineminus">-             oncommand=&quot;goDoPlacesCommand('placesCmd_createBookmark');&quot;/&gt;</span>
<a href="#l11.80"></a><span id="l11.80" class="difflineplus">+             oncommand=&quot;PlacesUIUtils.doCommand(window, 'placesCmd_createBookmark');&quot;/&gt;</span>
<a href="#l11.81"></a><span id="l11.81"> </span>
<a href="#l11.82"></a><span id="l11.82">     &lt;!-- Special versions of cut/copy/paste/delete which check for an open context menu. --&gt;</span>
<a href="#l11.83"></a><span id="l11.83">     &lt;command id=&quot;placesCmd_cut&quot;</span>
<a href="#l11.84"></a><span id="l11.84" class="difflineminus">-             oncommand=&quot;goDoPlacesCommand('placesCmd_cut');&quot;/&gt;</span>
<a href="#l11.85"></a><span id="l11.85" class="difflineplus">+             oncommand=&quot;PlacesUIUtils.doCommand(window, 'placesCmd_cut');&quot;/&gt;</span>
<a href="#l11.86"></a><span id="l11.86">     &lt;command id=&quot;placesCmd_copy&quot;</span>
<a href="#l11.87"></a><span id="l11.87" class="difflineminus">-             oncommand=&quot;goDoPlacesCommand('placesCmd_copy');&quot;/&gt;</span>
<a href="#l11.88"></a><span id="l11.88" class="difflineplus">+             oncommand=&quot;PlacesUIUtils.doCommand(window, 'placesCmd_copy');&quot;/&gt;</span>
<a href="#l11.89"></a><span id="l11.89">     &lt;command id=&quot;placesCmd_paste&quot;</span>
<a href="#l11.90"></a><span id="l11.90" class="difflineminus">-             oncommand=&quot;goDoPlacesCommand('placesCmd_paste');&quot;/&gt;</span>
<a href="#l11.91"></a><span id="l11.91" class="difflineplus">+             oncommand=&quot;PlacesUIUtils.doCommand(window, 'placesCmd_paste');&quot;/&gt;</span>
<a href="#l11.92"></a><span id="l11.92">     &lt;command id=&quot;placesCmd_delete&quot;</span>
<a href="#l11.93"></a><span id="l11.93" class="difflineminus">-             oncommand=&quot;goDoPlacesCommand('placesCmd_delete');&quot;/&gt;</span>
<a href="#l11.94"></a><span id="l11.94" class="difflineplus">+             oncommand=&quot;PlacesUIUtils.doCommand(window, 'placesCmd_delete');&quot;/&gt;</span>
<a href="#l11.95"></a><span id="l11.95">   &lt;/commandset&gt;</span>
<a href="#l11.96"></a><span id="l11.96"> </span>
<a href="#l11.97"></a><span id="l11.97">   &lt;menupopup id=&quot;placesContext&quot;</span>
<a href="#l11.98"></a><span id="l11.98">              onpopupshowing=&quot;this._view = PlacesUIUtils.getViewForNode(document.popupNode);</span>
<a href="#l11.99"></a><span id="l11.99">                              if (!PlacesUIUtils.openInTabClosesMenu) {</span>
<a href="#l11.100"></a><span id="l11.100">                                document.getElementById ('placesContext_open:newtab')</span>
<a href="#l11.101"></a><span id="l11.101">                                .setAttribute('closemenu', 'single');</span>
<a href="#l11.102"></a><span id="l11.102">                              }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/suite/components/places/content/tree.xml</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/suite/components/places/content/tree.xml</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -496,17 +496,17 @@</span>
<a href="#l12.4"></a><span id="l12.4">               container = lastSelected.parent;</span>
<a href="#l12.5"></a><span id="l12.5"> </span>
<a href="#l12.6"></a><span id="l12.6">               // See comment in the treeView.js's copy of this method</span>
<a href="#l12.7"></a><span id="l12.7">               if (!container || !container.containerOpen)</span>
<a href="#l12.8"></a><span id="l12.8">                 return null;</span>
<a href="#l12.9"></a><span id="l12.9"> </span>
<a href="#l12.10"></a><span id="l12.10">               // Avoid the potentially expensive call to getChildIndex</span>
<a href="#l12.11"></a><span id="l12.11">               // if we know this container doesn't allow insertion</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-              if (PlacesControllerDragHelper.disallowInsertion(container, this))</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+              if (this.controller.disallowInsertion(container))</span>
<a href="#l12.14"></a><span id="l12.14">                 return null;</span>
<a href="#l12.15"></a><span id="l12.15"> </span>
<a href="#l12.16"></a><span id="l12.16">               var queryOptions = PlacesUtils.asQuery(result.root).queryOptions;</span>
<a href="#l12.17"></a><span id="l12.17">               if (queryOptions.sortingMode !=</span>
<a href="#l12.18"></a><span id="l12.18">                     Ci.nsINavHistoryQueryOptions.SORT_BY_NONE) {</span>
<a href="#l12.19"></a><span id="l12.19">                 // If we are within a sorted view, insert at the end</span>
<a href="#l12.20"></a><span id="l12.20">                 index = -1;</span>
<a href="#l12.21"></a><span id="l12.21">               } else if (queryOptions.excludeItems ||</span>
<a href="#l12.22"></a><span id="l12.22" class="difflineat">@@ -519,28 +519,28 @@</span>
<a href="#l12.23"></a><span id="l12.23">                 dropNearNode = lastSelected;</span>
<a href="#l12.24"></a><span id="l12.24">               } else {</span>
<a href="#l12.25"></a><span id="l12.25">                 var lsi = container.getChildIndex(lastSelected);</span>
<a href="#l12.26"></a><span id="l12.26">                 index = orientation == Ci.nsITreeView.DROP_BEFORE ? lsi : lsi + 1;</span>
<a href="#l12.27"></a><span id="l12.27">               }</span>
<a href="#l12.28"></a><span id="l12.28">             }</span>
<a href="#l12.29"></a><span id="l12.29">           }</span>
<a href="#l12.30"></a><span id="l12.30"> </span>
<a href="#l12.31"></a><span id="l12.31" class="difflineminus">-          if (PlacesControllerDragHelper.disallowInsertion(container, this))</span>
<a href="#l12.32"></a><span id="l12.32" class="difflineplus">+          if (this.controller.disallowInsertion(container))</span>
<a href="#l12.33"></a><span id="l12.33">             return null;</span>
<a href="#l12.34"></a><span id="l12.34"> </span>
<a href="#l12.35"></a><span id="l12.35">           // TODO (Bug 1160193): properly support dropping on a tag root.</span>
<a href="#l12.36"></a><span id="l12.36">           let tagName = null;</span>
<a href="#l12.37"></a><span id="l12.37">           if (PlacesUtils.nodeIsTagQuery(container)) {</span>
<a href="#l12.38"></a><span id="l12.38">             tagName = container.title;</span>
<a href="#l12.39"></a><span id="l12.39">             if (!tagName)</span>
<a href="#l12.40"></a><span id="l12.40">               return null;</span>
<a href="#l12.41"></a><span id="l12.41">           }</span>
<a href="#l12.42"></a><span id="l12.42"> </span>
<a href="#l12.43"></a><span id="l12.43" class="difflineminus">-          return new InsertionPoint({</span>
<a href="#l12.44"></a><span id="l12.44" class="difflineplus">+          return new PlacesInsertionPoint({</span>
<a href="#l12.45"></a><span id="l12.45">             parentId: PlacesUtils.getConcreteItemId(container),</span>
<a href="#l12.46"></a><span id="l12.46">             parentGuid: PlacesUtils.getConcreteItemGuid(container),</span>
<a href="#l12.47"></a><span id="l12.47">             index, orientation, tagName, dropNearNode</span>
<a href="#l12.48"></a><span id="l12.48">           });</span>
<a href="#l12.49"></a><span id="l12.49">         ]]&gt;&lt;/body&gt;</span>
<a href="#l12.50"></a><span id="l12.50">       &lt;/method&gt;</span>
<a href="#l12.51"></a><span id="l12.51"> </span>
<a href="#l12.52"></a><span id="l12.52">       &lt;!-- nsIPlacesView --&gt;</span>
<a href="#l12.53"></a><span id="l12.53" class="difflineat">@@ -745,17 +745,17 @@</span>
<a href="#l12.54"></a><span id="l12.54">           if (!node.parent) {</span>
<a href="#l12.55"></a><span id="l12.55">             event.preventDefault();</span>
<a href="#l12.56"></a><span id="l12.56">             event.stopPropagation();</span>
<a href="#l12.57"></a><span id="l12.57">             return;</span>
<a href="#l12.58"></a><span id="l12.58">           }</span>
<a href="#l12.59"></a><span id="l12.59"> </span>
<a href="#l12.60"></a><span id="l12.60">           // If this node is child of a readonly container (e.g. a livemark)</span>
<a href="#l12.61"></a><span id="l12.61">           // or cannot be moved, we must force a copy.</span>
<a href="#l12.62"></a><span id="l12.62" class="difflineminus">-          if (!PlacesControllerDragHelper.canMoveNode(node, this)) {</span>
<a href="#l12.63"></a><span id="l12.63" class="difflineplus">+          if (!this.controller.canMoveNode(node)) {</span>
<a href="#l12.64"></a><span id="l12.64">             event.dataTransfer.effectAllowed = &quot;copyLink&quot;;</span>
<a href="#l12.65"></a><span id="l12.65">             break;</span>
<a href="#l12.66"></a><span id="l12.66">           }</span>
<a href="#l12.67"></a><span id="l12.67">         }</span>
<a href="#l12.68"></a><span id="l12.68"> </span>
<a href="#l12.69"></a><span id="l12.69">         this._controller.setDataTransfer(event);</span>
<a href="#l12.70"></a><span id="l12.70">         event.stopPropagation();</span>
<a href="#l12.71"></a><span id="l12.71">       ]]&gt;&lt;/handler&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/suite/components/places/content/treeView.js</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/suite/components/places/content/treeView.js</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -1427,17 +1427,17 @@ PlacesTreeView.prototype = {</span>
<a href="#l13.4"></a><span id="l13.4">         // container here.  However, we can simply bail out when this happens,</span>
<a href="#l13.5"></a><span id="l13.5">         // because we would then be back here in less than a millisecond, when</span>
<a href="#l13.6"></a><span id="l13.6">         // the container had been reopened.</span>
<a href="#l13.7"></a><span id="l13.7">         if (!container || !container.containerOpen)</span>
<a href="#l13.8"></a><span id="l13.8">           return null;</span>
<a href="#l13.9"></a><span id="l13.9"> </span>
<a href="#l13.10"></a><span id="l13.10">         // Avoid the potentially expensive call to getChildIndex</span>
<a href="#l13.11"></a><span id="l13.11">         // if we know this container doesn't allow insertion.</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-        if (PlacesControllerDragHelper.disallowInsertion(container, this._tree.element))</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+        if (this._controller.disallowInsertion(container))</span>
<a href="#l13.14"></a><span id="l13.14">           return null;</span>
<a href="#l13.15"></a><span id="l13.15"> </span>
<a href="#l13.16"></a><span id="l13.16">         let queryOptions = PlacesUtils.asQuery(this._result.root).queryOptions;</span>
<a href="#l13.17"></a><span id="l13.17">         if (queryOptions.sortingMode !=</span>
<a href="#l13.18"></a><span id="l13.18">               Ci.nsINavHistoryQueryOptions.SORT_BY_NONE) {</span>
<a href="#l13.19"></a><span id="l13.19">           // If we are within a sorted view, insert at the end.</span>
<a href="#l13.20"></a><span id="l13.20">           index = -1;</span>
<a href="#l13.21"></a><span id="l13.21">         } else if (queryOptions.excludeItems ||</span>
<a href="#l13.22"></a><span id="l13.22" class="difflineat">@@ -1450,28 +1450,28 @@ PlacesTreeView.prototype = {</span>
<a href="#l13.23"></a><span id="l13.23">           dropNearNode = lastSelected;</span>
<a href="#l13.24"></a><span id="l13.24">         } else {</span>
<a href="#l13.25"></a><span id="l13.25">           let lsi = container.getChildIndex(lastSelected);</span>
<a href="#l13.26"></a><span id="l13.26">           index = orientation == Ci.nsITreeView.DROP_BEFORE ? lsi : lsi + 1;</span>
<a href="#l13.27"></a><span id="l13.27">         }</span>
<a href="#l13.28"></a><span id="l13.28">       }</span>
<a href="#l13.29"></a><span id="l13.29">     }</span>
<a href="#l13.30"></a><span id="l13.30"> </span>
<a href="#l13.31"></a><span id="l13.31" class="difflineminus">-    if (PlacesControllerDragHelper.disallowInsertion(container, this._tree.element))</span>
<a href="#l13.32"></a><span id="l13.32" class="difflineplus">+    if (this._controller.disallowInsertion(container))</span>
<a href="#l13.33"></a><span id="l13.33">       return null;</span>
<a href="#l13.34"></a><span id="l13.34"> </span>
<a href="#l13.35"></a><span id="l13.35">     // TODO (Bug 1160193): properly support dropping on a tag root.</span>
<a href="#l13.36"></a><span id="l13.36">     let tagName = null;</span>
<a href="#l13.37"></a><span id="l13.37">     if (PlacesUtils.nodeIsTagQuery(container)) {</span>
<a href="#l13.38"></a><span id="l13.38">       tagName = container.title;</span>
<a href="#l13.39"></a><span id="l13.39">       if (!tagName)</span>
<a href="#l13.40"></a><span id="l13.40">         return null;</span>
<a href="#l13.41"></a><span id="l13.41">     }</span>
<a href="#l13.42"></a><span id="l13.42"> </span>
<a href="#l13.43"></a><span id="l13.43" class="difflineminus">-    return new InsertionPoint({</span>
<a href="#l13.44"></a><span id="l13.44" class="difflineplus">+    return new PlacesInsertionPoint({</span>
<a href="#l13.45"></a><span id="l13.45">       parentId: PlacesUtils.getConcreteItemId(container),</span>
<a href="#l13.46"></a><span id="l13.46">       parentGuid: PlacesUtils.getConcreteItemGuid(container),</span>
<a href="#l13.47"></a><span id="l13.47">       index, orientation, tagName, dropNearNode</span>
<a href="#l13.48"></a><span id="l13.48">     });</span>
<a href="#l13.49"></a><span id="l13.49">   },</span>
<a href="#l13.50"></a><span id="l13.50"> </span>
<a href="#l13.51"></a><span id="l13.51">   drop: function PTV_drop(aRow, aOrientation, aDataTransfer) {</span>
<a href="#l13.52"></a><span id="l13.52">     // We are responsible for translating the |index| and |orientation|</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:33Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

