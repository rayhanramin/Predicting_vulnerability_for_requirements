<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 2895:6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a" />
<meta property="og:url" content="/comm-central/rev/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a" />
<meta property="og:description" content="Merge for rev. 2894" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a">shortlog</a> |
<a href="/comm-central/log/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a">files</a> |
changeset |
<a href="/comm-central/raw-rev/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a">raw</a>  | <a href="/comm-central/archive/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
Merge for rev. 2894
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#75;&#97;&#114;&#115;&#116;&#101;&#110;&#32;&#68;&#252;&#115;&#116;&#101;&#114;&#108;&#111;&#104;&#32;&#60;&#109;&#110;&#121;&#114;&#111;&#109;&#121;&#114;&#64;&#116;&#112;&#114;&#97;&#99;&#46;&#100;&#101;&#62;</td></tr>
<tr><td></td><td class="date age">Fri, 19 Jun 2009 23:35:33 +0200</td></tr>

<tr>
 <td>changeset 2895</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a">6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a</a></td>
</tr>



<tr>
<td>parent 2894</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/5ce9e897332fe5f297ca9cbcd0e7d0c7d7a062c5">5ce9e897332fe5f297ca9cbcd0e7d0c7d7a062c5</a> (current diff)
</td>
</tr>
<tr>
<td>parent 2893</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/9b0a71e2f69851f51381ed384f533b91c9addf0c">9b0a71e2f69851f51381ed384f533b91c9addf0c</a> (<a href="/comm-central/rev/9b0a71e2f69851f51381ed384f533b91c9addf0c:6f5baa0cddd2">diff</a>)
</td>
</tr>

<tr>
<td>child 2896</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/6bcbb9a88f88db5a99c1b13692a9ae8df098ab0c">6bcbb9a88f88db5a99c1b13692a9ae8df098ab0c</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a">2345</a></td></tr>
<tr><td>push user</td><td>mnyromyr@tprac.de</td></tr>
<tr><td>push date</td><td class="date age">Fri, 19 Jun 2009 21:37:09 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@6f5baa0cddd2 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a&newProject=comm-central&newRevision=5ce9e897332fe5f297ca9cbcd0e7d0c7d7a062c5&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a&newProject=comm-central&newRevision=5ce9e897332fe5f297ca9cbcd0e7d0c7d7a062c5&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a&newProject=comm-central&newRevision=5ce9e897332fe5f297ca9cbcd0e7d0c7d7a062c5&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>






</table></div>

<div class="page_body description">Merge for rev. 2894</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a/calendar/test/homegrown/caldav/jsDriver-hook.pl">calendar/test/homegrown/caldav/jsDriver-hook.pl</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a/calendar/test/homegrown/caldav/jsDriver-hook.pl">diff</a> |
<a href="/comm-central/comparison/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a/calendar/test/homegrown/caldav/jsDriver-hook.pl">comparison</a> |
<a href="/comm-central/log/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a/calendar/test/homegrown/caldav/jsDriver-hook.pl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a/calendar/test/homegrown/caldav/shell.js">calendar/test/homegrown/caldav/shell.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a/calendar/test/homegrown/caldav/shell.js">diff</a> |
<a href="/comm-central/comparison/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a/calendar/test/homegrown/caldav/shell.js">comparison</a> |
<a href="/comm-central/log/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a/calendar/test/homegrown/caldav/shell.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a/calendar/test/homegrown/ics2ics.js">calendar/test/homegrown/ics2ics.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a/calendar/test/homegrown/ics2ics.js">diff</a> |
<a href="/comm-central/comparison/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a/calendar/test/homegrown/ics2ics.js">comparison</a> |
<a href="/comm-central/log/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a/calendar/test/homegrown/ics2ics.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a/calendar/test/homegrown/memory/add-get-delete-event.js">calendar/test/homegrown/memory/add-get-delete-event.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a/calendar/test/homegrown/memory/add-get-delete-event.js">diff</a> |
<a href="/comm-central/comparison/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a/calendar/test/homegrown/memory/add-get-delete-event.js">comparison</a> |
<a href="/comm-central/log/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a/calendar/test/homegrown/memory/add-get-delete-event.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a/calendar/test/homegrown/memory/add-get-delete-events.js">calendar/test/homegrown/memory/add-get-delete-events.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a/calendar/test/homegrown/memory/add-get-delete-events.js">diff</a> |
<a href="/comm-central/comparison/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a/calendar/test/homegrown/memory/add-get-delete-events.js">comparison</a> |
<a href="/comm-central/log/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a/calendar/test/homegrown/memory/add-get-delete-events.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a/calendar/test/homegrown/memory/shell.js">calendar/test/homegrown/memory/shell.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a/calendar/test/homegrown/memory/shell.js">diff</a> |
<a href="/comm-central/comparison/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a/calendar/test/homegrown/memory/shell.js">comparison</a> |
<a href="/comm-central/log/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a/calendar/test/homegrown/memory/shell.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a/calendar/test/homegrown/misc/attendee.js">calendar/test/homegrown/misc/attendee.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a/calendar/test/homegrown/misc/attendee.js">diff</a> |
<a href="/comm-central/comparison/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a/calendar/test/homegrown/misc/attendee.js">comparison</a> |
<a href="/comm-central/log/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a/calendar/test/homegrown/misc/attendee.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a/calendar/test/homegrown/misc/ics-roundtrip.js">calendar/test/homegrown/misc/ics-roundtrip.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a/calendar/test/homegrown/misc/ics-roundtrip.js">diff</a> |
<a href="/comm-central/comparison/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a/calendar/test/homegrown/misc/ics-roundtrip.js">comparison</a> |
<a href="/comm-central/log/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a/calendar/test/homegrown/misc/ics-roundtrip.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a/calendar/test/homegrown/misc/simple-item-mutability.js">calendar/test/homegrown/misc/simple-item-mutability.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a/calendar/test/homegrown/misc/simple-item-mutability.js">diff</a> |
<a href="/comm-central/comparison/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a/calendar/test/homegrown/misc/simple-item-mutability.js">comparison</a> |
<a href="/comm-central/log/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a/calendar/test/homegrown/misc/simple-item-mutability.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a/calendar/test/homegrown/misc/synchronization.js">calendar/test/homegrown/misc/synchronization.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a/calendar/test/homegrown/misc/synchronization.js">diff</a> |
<a href="/comm-central/comparison/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a/calendar/test/homegrown/misc/synchronization.js">comparison</a> |
<a href="/comm-central/log/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a/calendar/test/homegrown/misc/synchronization.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a/calendar/test/homegrown/shell.js">calendar/test/homegrown/shell.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a/calendar/test/homegrown/shell.js">diff</a> |
<a href="/comm-central/comparison/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a/calendar/test/homegrown/shell.js">comparison</a> |
<a href="/comm-central/log/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a/calendar/test/homegrown/shell.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a/calendar/test/jsDriver.pl">calendar/test/jsDriver.pl</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a/calendar/test/jsDriver.pl">diff</a> |
<a href="/comm-central/comparison/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a/calendar/test/jsDriver.pl">comparison</a> |
<a href="/comm-central/log/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a/calendar/test/jsDriver.pl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a/mail/themes/gnomestripe/mail/icons/chevron.png">mail/themes/gnomestripe/mail/icons/chevron.png</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a/mail/themes/gnomestripe/mail/icons/chevron.png">diff</a> |
<a href="/comm-central/comparison/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a/mail/themes/gnomestripe/mail/icons/chevron.png">comparison</a> |
<a href="/comm-central/log/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a/mail/themes/gnomestripe/mail/icons/chevron.png">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a/mail/themes/gnomestripe/mail/icons/sort-asc.gif">mail/themes/gnomestripe/mail/icons/sort-asc.gif</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a/mail/themes/gnomestripe/mail/icons/sort-asc.gif">diff</a> |
<a href="/comm-central/comparison/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a/mail/themes/gnomestripe/mail/icons/sort-asc.gif">comparison</a> |
<a href="/comm-central/log/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a/mail/themes/gnomestripe/mail/icons/sort-asc.gif">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a/mail/themes/gnomestripe/mail/icons/sort-dsc.gif">mail/themes/gnomestripe/mail/icons/sort-dsc.gif</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a/mail/themes/gnomestripe/mail/icons/sort-dsc.gif">diff</a> |
<a href="/comm-central/comparison/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a/mail/themes/gnomestripe/mail/icons/sort-dsc.gif">comparison</a> |
<a href="/comm-central/log/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a/mail/themes/gnomestripe/mail/icons/sort-dsc.gif">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a/mail/themes/gnomestripe/mail/tree.css">mail/themes/gnomestripe/mail/tree.css</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a/mail/themes/gnomestripe/mail/tree.css">diff</a> |
<a href="/comm-central/comparison/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a/mail/themes/gnomestripe/mail/tree.css">comparison</a> |
<a href="/comm-central/log/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a/mail/themes/gnomestripe/mail/tree.css">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a/mail/themes/pinstripe/mail/icons/chevron.png">mail/themes/pinstripe/mail/icons/chevron.png</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a/mail/themes/pinstripe/mail/icons/chevron.png">diff</a> |
<a href="/comm-central/comparison/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a/mail/themes/pinstripe/mail/icons/chevron.png">comparison</a> |
<a href="/comm-central/log/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a/mail/themes/pinstripe/mail/icons/chevron.png">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a/mail/themes/pinstripe/mail/icons/twisty-closed.gif">mail/themes/pinstripe/mail/icons/twisty-closed.gif</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a/mail/themes/pinstripe/mail/icons/twisty-closed.gif">diff</a> |
<a href="/comm-central/comparison/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a/mail/themes/pinstripe/mail/icons/twisty-closed.gif">comparison</a> |
<a href="/comm-central/log/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a/mail/themes/pinstripe/mail/icons/twisty-closed.gif">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a/mail/themes/qute/mail/icons/chevron.png">mail/themes/qute/mail/icons/chevron.png</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a/mail/themes/qute/mail/icons/chevron.png">diff</a> |
<a href="/comm-central/comparison/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a/mail/themes/qute/mail/icons/chevron.png">comparison</a> |
<a href="/comm-central/log/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a/mail/themes/qute/mail/icons/chevron.png">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a/mail/themes/qute/mail/icons/croppedchevron.png">mail/themes/qute/mail/icons/croppedchevron.png</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a/mail/themes/qute/mail/icons/croppedchevron.png">diff</a> |
<a href="/comm-central/comparison/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a/mail/themes/qute/mail/icons/croppedchevron.png">comparison</a> |
<a href="/comm-central/log/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a/mail/themes/qute/mail/icons/croppedchevron.png">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a/mail/themes/qute/mail/icons/sort-asc.gif">mail/themes/qute/mail/icons/sort-asc.gif</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a/mail/themes/qute/mail/icons/sort-asc.gif">diff</a> |
<a href="/comm-central/comparison/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a/mail/themes/qute/mail/icons/sort-asc.gif">comparison</a> |
<a href="/comm-central/log/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a/mail/themes/qute/mail/icons/sort-asc.gif">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a/mail/themes/qute/mail/icons/sort-dsc.gif">mail/themes/qute/mail/icons/sort-dsc.gif</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a/mail/themes/qute/mail/icons/sort-dsc.gif">diff</a> |
<a href="/comm-central/comparison/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a/mail/themes/qute/mail/icons/sort-dsc.gif">comparison</a> |
<a href="/comm-central/log/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a/mail/themes/qute/mail/icons/sort-dsc.gif">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a/mail/themes/qute/mail/tree.css">mail/themes/qute/mail/tree.css</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a/mail/themes/qute/mail/tree.css">diff</a> |
<a href="/comm-central/comparison/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a/mail/themes/qute/mail/tree.css">comparison</a> |
<a href="/comm-central/log/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a/mail/themes/qute/mail/tree.css">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a/mailnews/base/resources/content/msgViewNavigation.js">mailnews/base/resources/content/msgViewNavigation.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a/mailnews/base/resources/content/msgViewNavigation.js">diff</a> |
<a href="/comm-central/comparison/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a/mailnews/base/resources/content/msgViewNavigation.js">comparison</a> |
<a href="/comm-central/log/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a/mailnews/base/resources/content/msgViewNavigation.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a/mailnews/compose/public/nsIMsgComposeProgress.idl">mailnews/compose/public/nsIMsgComposeProgress.idl</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a/mailnews/compose/public/nsIMsgComposeProgress.idl">diff</a> |
<a href="/comm-central/comparison/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a/mailnews/compose/public/nsIMsgComposeProgress.idl">comparison</a> |
<a href="/comm-central/log/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a/mailnews/compose/public/nsIMsgComposeProgress.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a/suite/locales/en-US/chrome/common/pref/pref-applications-edit.dtd">suite/locales/en-US/chrome/common/pref/pref-applications-edit.dtd</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a/suite/locales/en-US/chrome/common/pref/pref-applications-edit.dtd">diff</a> |
<a href="/comm-central/comparison/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a/suite/locales/en-US/chrome/common/pref/pref-applications-edit.dtd">comparison</a> |
<a href="/comm-central/log/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a/suite/locales/en-US/chrome/common/pref/pref-applications-edit.dtd">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a/suite/mailnews/tabmail.xml">suite/mailnews/tabmail.xml</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a/suite/mailnews/tabmail.xml">diff</a> |
<a href="/comm-central/comparison/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a/suite/mailnews/tabmail.xml">comparison</a> |
<a href="/comm-central/log/6f5baa0cddd240bb7c0ecc6e9f57e78adc94b90a/suite/mailnews/tabmail.xml">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/calendar/base/content/calendar-dnd-listener.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/calendar/base/content/calendar-dnd-listener.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -17,16 +17,17 @@</span>
<a href="#l1.4"></a><span id="l1.4">  *   Joey Minta &lt;jminta@gmail.com&gt;</span>
<a href="#l1.5"></a><span id="l1.5">  * Portions created by the Initial Developer are Copyright (C) 2006</span>
<a href="#l1.6"></a><span id="l1.6">  * the Initial Developer. All Rights Reserved.</span>
<a href="#l1.7"></a><span id="l1.7">  *</span>
<a href="#l1.8"></a><span id="l1.8">  * Contributor(s):</span>
<a href="#l1.9"></a><span id="l1.9">  *   Michael Buettner &lt;michael.buettner@sun.com&gt;</span>
<a href="#l1.10"></a><span id="l1.10">  *   Philipp Kewisch &lt;mozilla@kewis.ch&gt;</span>
<a href="#l1.11"></a><span id="l1.11">  *   Berend Cornelius &lt;berend.cornelius@sun.com&gt;</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+ *   Martin Schroeder &lt;mschroeder@mozilla.x-home.org&gt;</span>
<a href="#l1.13"></a><span id="l1.13">  *</span>
<a href="#l1.14"></a><span id="l1.14">  * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l1.15"></a><span id="l1.15">  * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l1.16"></a><span id="l1.16">  * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l1.17"></a><span id="l1.17">  * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l1.18"></a><span id="l1.18">  * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l1.19"></a><span id="l1.19">  * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l1.20"></a><span id="l1.20">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineat">@@ -40,70 +41,50 @@</span>
<a href="#l1.22"></a><span id="l1.22"> Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l1.23"></a><span id="l1.23"> Components.utils.import(&quot;resource://calendar/modules/calAlarmUtils.jsm&quot;);</span>
<a href="#l1.24"></a><span id="l1.24"> </span>
<a href="#l1.25"></a><span id="l1.25"> var itemConversion = {</span>
<a href="#l1.26"></a><span id="l1.26"> </span>
<a href="#l1.27"></a><span id="l1.27">     /**</span>
<a href="#l1.28"></a><span id="l1.28">      * Converts an email message to a calendar item.</span>
<a href="#l1.29"></a><span id="l1.29">      *</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineminus">-     * XXX Currently, only the title is taken from the passed message. Aside</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineminus">-     * from that, the currently visible message in the preview pane is used.</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineminus">-     *</span>
<a href="#l1.33"></a><span id="l1.33">      * @param aItem     The target calIItemBase.</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineminus">-     * @param aMessage  The message  to convert from</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineplus">+     * @param aMessage  The nsIMsgHdr to convert from.</span>
<a href="#l1.36"></a><span id="l1.36">      */</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineminus">-    calendarItemFromMessage: function iC_calendarItemFromMessage(aItem, aMessage) {</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineplus">+    calendarItemFromMessage: function iC_calendarItemFromMessage(aItem, aMsgHdr) {</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineplus">+        let msgFolder = aMsgHdr.folder;</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineplus">+        let msgUri = msgFolder.getUriForMsg(aMsgHdr);</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineplus">+</span>
<a href="#l1.42"></a><span id="l1.42">         aItem.calendar = getSelectedCalendar();</span>
<a href="#l1.43"></a><span id="l1.43" class="difflineminus">-        aItem.title = aMessage.mime2DecodedSubject;</span>
<a href="#l1.44"></a><span id="l1.44" class="difflineplus">+        aItem.title = aMsgHdr.mime2DecodedSubject;</span>
<a href="#l1.45"></a><span id="l1.45"> </span>
<a href="#l1.46"></a><span id="l1.46" class="difflineminus">-        setDefaultStartEndHour(aItem);</span>
<a href="#l1.47"></a><span id="l1.47" class="difflineplus">+        cal.setDefaultStartEndHour(aItem);</span>
<a href="#l1.48"></a><span id="l1.48">         cal.alarms.setDefaultValues(aItem);</span>
<a href="#l1.49"></a><span id="l1.49"> </span>
<a href="#l1.50"></a><span id="l1.50" class="difflineminus">-        // XXX It would be great if nsPlainTextParser could take care of this.</span>
<a href="#l1.51"></a><span id="l1.51" class="difflineminus">-        function htmlToPlainText(html) {</span>
<a href="#l1.52"></a><span id="l1.52" class="difflineminus">-          var texts = html.split(/(&lt;\/?[^&gt;]+&gt;)/);</span>
<a href="#l1.53"></a><span id="l1.53" class="difflineminus">-          var text = texts.map(function hTPT_map(string) {</span>
<a href="#l1.54"></a><span id="l1.54" class="difflineminus">-              if (string.length &gt; 0 &amp;&amp; string[0] == '&lt;') {</span>
<a href="#l1.55"></a><span id="l1.55" class="difflineminus">-                  var regExpRes = string.match(/^&lt;img.*?alt\s*=\s*['&quot;](.*)[&quot;']/i)</span>
<a href="#l1.56"></a><span id="l1.56" class="difflineminus">-                  if (regExpRes) {</span>
<a href="#l1.57"></a><span id="l1.57" class="difflineminus">-                      return regExpRes[1];</span>
<a href="#l1.58"></a><span id="l1.58" class="difflineminus">-                  } else {</span>
<a href="#l1.59"></a><span id="l1.59" class="difflineminus">-                      return &quot;&quot;;</span>
<a href="#l1.60"></a><span id="l1.60" class="difflineminus">-                  }</span>
<a href="#l1.61"></a><span id="l1.61" class="difflineminus">-              } else {</span>
<a href="#l1.62"></a><span id="l1.62" class="difflineminus">-                  return string.replace(/&amp;([^;]+);/g, function hTPT_replace(str, p1) {</span>
<a href="#l1.63"></a><span id="l1.63" class="difflineminus">-                        switch (p1) {</span>
<a href="#l1.64"></a><span id="l1.64" class="difflineminus">-                            case &quot;nbsp&quot;: return &quot; &quot;;</span>
<a href="#l1.65"></a><span id="l1.65" class="difflineminus">-                            case &quot;amp&quot;: return &quot;&amp;&quot;;</span>
<a href="#l1.66"></a><span id="l1.66" class="difflineminus">-                            case &quot;lt&quot;: return &quot;&lt;&quot;;</span>
<a href="#l1.67"></a><span id="l1.67" class="difflineminus">-                            case &quot;gt&quot;: return &quot;&gt;&quot;;</span>
<a href="#l1.68"></a><span id="l1.68" class="difflineminus">-                            case &quot;quot&quot;: return '\&quot;';</span>
<a href="#l1.69"></a><span id="l1.69" class="difflineminus">-                        }</span>
<a href="#l1.70"></a><span id="l1.70" class="difflineminus">-                        return &quot; &quot;;</span>
<a href="#l1.71"></a><span id="l1.71" class="difflineminus">-                    });</span>
<a href="#l1.72"></a><span id="l1.72" class="difflineminus">-              }</span>
<a href="#l1.73"></a><span id="l1.73" class="difflineminus">-          }).join(&quot;&quot;);</span>
<a href="#l1.74"></a><span id="l1.74" class="difflineplus">+        let messenger = Components.classes[&quot;@mozilla.org/messenger;1&quot;]</span>
<a href="#l1.75"></a><span id="l1.75" class="difflineplus">+                                  .createInstance(Components.interfaces.nsIMessenger);</span>
<a href="#l1.76"></a><span id="l1.76" class="difflineplus">+        let streamListener = Components.classes[&quot;@mozilla.org/network/sync-stream-listener;1&quot;]</span>
<a href="#l1.77"></a><span id="l1.77" class="difflineplus">+                                       .createInstance(Components.interfaces.nsISyncStreamListener);</span>
<a href="#l1.78"></a><span id="l1.78" class="difflineplus">+        messenger.messageServiceFromURI(msgUri).streamMessage(msgUri,</span>
<a href="#l1.79"></a><span id="l1.79" class="difflineplus">+                                                              streamListener,</span>
<a href="#l1.80"></a><span id="l1.80" class="difflineplus">+                                                              null,</span>
<a href="#l1.81"></a><span id="l1.81" class="difflineplus">+                                                              null,</span>
<a href="#l1.82"></a><span id="l1.82" class="difflineplus">+                                                              false,</span>
<a href="#l1.83"></a><span id="l1.83" class="difflineplus">+                                                              &quot;&quot;,</span>
<a href="#l1.84"></a><span id="l1.84" class="difflineplus">+                                                              false);</span>
<a href="#l1.85"></a><span id="l1.85"> </span>
<a href="#l1.86"></a><span id="l1.86" class="difflineminus">-          return text;</span>
<a href="#l1.87"></a><span id="l1.87" class="difflineminus">-        }</span>
<a href="#l1.88"></a><span id="l1.88" class="difflineminus">-</span>
<a href="#l1.89"></a><span id="l1.89" class="difflineminus">-        var content = document.getElementById(&quot;messagepane&quot;);</span>
<a href="#l1.90"></a><span id="l1.90" class="difflineminus">-        if (content) {</span>
<a href="#l1.91"></a><span id="l1.91" class="difflineminus">-            var messagePrefix = /^mailbox-message:|^imap-message:|^news-message:/i;</span>
<a href="#l1.92"></a><span id="l1.92" class="difflineminus">-            if (messagePrefix.test(GetLoadedMessage())) {</span>
<a href="#l1.93"></a><span id="l1.93" class="difflineminus">-                var message = content.contentDocument;</span>
<a href="#l1.94"></a><span id="l1.94" class="difflineminus">-                var body = message.body;</span>
<a href="#l1.95"></a><span id="l1.95" class="difflineminus">-                if (body) {</span>
<a href="#l1.96"></a><span id="l1.96" class="difflineminus">-                    aItem.setProperty(</span>
<a href="#l1.97"></a><span id="l1.97" class="difflineminus">-                        &quot;DESCRIPTION&quot;,</span>
<a href="#l1.98"></a><span id="l1.98" class="difflineminus">-                        htmlToPlainText(body.innerHTML));</span>
<a href="#l1.99"></a><span id="l1.99" class="difflineminus">-                }</span>
<a href="#l1.100"></a><span id="l1.100" class="difflineminus">-            }</span>
<a href="#l1.101"></a><span id="l1.101" class="difflineminus">-        }</span>
<a href="#l1.102"></a><span id="l1.102" class="difflineplus">+        let plainTextMessage = &quot;&quot;;</span>
<a href="#l1.103"></a><span id="l1.103" class="difflineplus">+        plainTextMessage = msgFolder.getMsgTextFromStream(streamListener.inputStream,</span>
<a href="#l1.104"></a><span id="l1.104" class="difflineplus">+                                                          aMsgHdr.Charset,</span>
<a href="#l1.105"></a><span id="l1.105" class="difflineplus">+                                                          65536,</span>
<a href="#l1.106"></a><span id="l1.106" class="difflineplus">+                                                          32768,</span>
<a href="#l1.107"></a><span id="l1.107" class="difflineplus">+                                                          false,</span>
<a href="#l1.108"></a><span id="l1.108" class="difflineplus">+                                                          true,</span>
<a href="#l1.109"></a><span id="l1.109" class="difflineplus">+                                                          {});</span>
<a href="#l1.110"></a><span id="l1.110" class="difflineplus">+        aItem.setProperty(&quot;DESCRIPTION&quot;, plainTextMessage);</span>
<a href="#l1.111"></a><span id="l1.111">     },</span>
<a href="#l1.112"></a><span id="l1.112"> </span>
<a href="#l1.113"></a><span id="l1.113">     /**</span>
<a href="#l1.114"></a><span id="l1.114">      * Copy base item properties from aItem to aTarget. This includes properties</span>
<a href="#l1.115"></a><span id="l1.115">      * like title, location, description, priority, transparency,</span>
<a href="#l1.116"></a><span id="l1.116">      * attendees, categories, calendar, recurrence and possibly more.</span>
<a href="#l1.117"></a><span id="l1.117">      *</span>
<a href="#l1.118"></a><span id="l1.118">      * @param aItem     The item to copy from.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/calendar/base/content/calendar-month-view.xml</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/calendar/base/content/calendar-month-view.xml</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -19,20 +19,21 @@</span>
<a href="#l2.4"></a><span id="l2.4">    -   Oracle Corporation</span>
<a href="#l2.5"></a><span id="l2.5">    - Portions created by the Initial Developer are Copyright (C) 2005</span>
<a href="#l2.6"></a><span id="l2.6">    - the Initial Developer. All Rights Reserved.</span>
<a href="#l2.7"></a><span id="l2.7">    -</span>
<a href="#l2.8"></a><span id="l2.8">    - Contributor(s):</span>
<a href="#l2.9"></a><span id="l2.9">    -   Vladimir Vukicevic &lt;vladimir@pobox.com&gt;</span>
<a href="#l2.10"></a><span id="l2.10">    -   Stefan Sitter &lt;ssitter@googlemail.com&gt;</span>
<a href="#l2.11"></a><span id="l2.11">    -   Clint Talbert &lt;cmtalbert@myfastmail.com&gt;</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-   -   Michael BÃ¼ttner &lt;michael.buettner@sun.com&gt;</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+   -   Michael Buettner &lt;michael.buettner@sun.com&gt;</span>
<a href="#l2.14"></a><span id="l2.14">    -   Philipp Kewisch &lt;mozilla@kewis.ch&gt;</span>
<a href="#l2.15"></a><span id="l2.15">    -   Markus Adrario &lt;MarkusAdrario@web.de&gt;</span>
<a href="#l2.16"></a><span id="l2.16">    -   Berend Cornelius &lt;berend.cornelius@sun.com&gt;</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineplus">+   -   Martin Schroeder &lt;mschroeder@mozilla.x-home.org&gt;</span>
<a href="#l2.18"></a><span id="l2.18">    -</span>
<a href="#l2.19"></a><span id="l2.19">    - Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l2.20"></a><span id="l2.20">    - either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l2.21"></a><span id="l2.21">    - the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l2.22"></a><span id="l2.22">    - in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l2.23"></a><span id="l2.23">    - of those above. If you wish to allow use of your version of this file only</span>
<a href="#l2.24"></a><span id="l2.24">    - under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l2.25"></a><span id="l2.25">    - use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l2.26"></a><span id="l2.26" class="difflineat">@@ -50,60 +51,68 @@</span>
<a href="#l2.27"></a><span id="l2.27"> </span>
<a href="#l2.28"></a><span id="l2.28"> &lt;bindings id=&quot;calendar-month-view-bindings&quot;</span>
<a href="#l2.29"></a><span id="l2.29">   xmlns=&quot;http://www.mozilla.org/xbl&quot;</span>
<a href="#l2.30"></a><span id="l2.30">   xmlns:html=&quot;http://www.w3.org/1999/xhtml&quot;</span>
<a href="#l2.31"></a><span id="l2.31">   xmlns:xul=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;</span>
<a href="#l2.32"></a><span id="l2.32">   xmlns:xbl=&quot;http://www.mozilla.org/xbl&quot;&gt;</span>
<a href="#l2.33"></a><span id="l2.33"> </span>
<a href="#l2.34"></a><span id="l2.34">   &lt;binding id=&quot;calendar-month-day-box-item&quot; extends=&quot;chrome://calendar/content/calendar-view-core.xml#calendar-editable-item&quot;&gt;</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineminus">-    &lt;content tooltip=&quot;itemTooltip&quot;&gt;</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineplus">+    &lt;content mousethrough=&quot;never&quot; tooltip=&quot;itemTooltip&quot;&gt;</span>
<a href="#l2.37"></a><span id="l2.37">       &lt;xul:vbox flex=&quot;1&quot;&gt;</span>
<a href="#l2.38"></a><span id="l2.38">         &lt;xul:hbox&gt;</span>
<a href="#l2.39"></a><span id="l2.39">           &lt;xul:box anonid=&quot;event-container&quot;</span>
<a href="#l2.40"></a><span id="l2.40">                    class=&quot;calendar-color-box&quot;</span>
<a href="#l2.41"></a><span id="l2.41">                    xbl:inherits=&quot;calendar-uri,calendar-id&quot;</span>
<a href="#l2.42"></a><span id="l2.42">                    flex=&quot;1&quot;&gt;</span>
<a href="#l2.43"></a><span id="l2.43">             &lt;xul:box class=&quot;calendar-event-selection&quot; orient=&quot;horizontal&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l2.44"></a><span id="l2.44">               &lt;xul:stack anonid=&quot;eventbox&quot;</span>
<a href="#l2.45"></a><span id="l2.45">                          class=&quot;calendar-event-box-container&quot;</span>
<a href="#l2.46"></a><span id="l2.46">                          xbl:inherits=&quot;readonly,flashing,alarm,allday,priority,progress,status,calendar,categories&quot;</span>
<a href="#l2.47"></a><span id="l2.47">                          flex=&quot;1&quot;&gt;</span>
<a href="#l2.48"></a><span id="l2.48">                 &lt;xul:hbox class=&quot;calendar-event-details&quot;&gt;</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineminus">-                  &lt;xul:image anonid=&quot;item-icon&quot;</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineminus">-                             class=&quot;calendar-month-day-box-item-image&quot;</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineminus">-                             xbl:inherits=&quot;progress,allday&quot;/&gt;</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineplus">+                  &lt;xul:vbox pack=&quot;center&quot;&gt;</span>
<a href="#l2.53"></a><span id="l2.53" class="difflineplus">+                    &lt;xul:image anonid=&quot;item-icon&quot;</span>
<a href="#l2.54"></a><span id="l2.54" class="difflineplus">+                               class=&quot;calendar-month-day-box-item-image&quot;</span>
<a href="#l2.55"></a><span id="l2.55" class="difflineplus">+                               xbl:inherits=&quot;progress,allday&quot;/&gt;</span>
<a href="#l2.56"></a><span id="l2.56" class="difflineplus">+                  &lt;/xul:vbox&gt;</span>
<a href="#l2.57"></a><span id="l2.57">                   &lt;xul:label anonid=&quot;item-label&quot;</span>
<a href="#l2.58"></a><span id="l2.58">                              class=&quot;calendar-month-day-box-item-label&quot;</span>
<a href="#l2.59"></a><span id="l2.59">                              xbl:inherits=&quot;context&quot;/&gt;</span>
<a href="#l2.60"></a><span id="l2.60">                   &lt;xul:vbox align=&quot;left&quot;</span>
<a href="#l2.61"></a><span id="l2.61">                             flex=&quot;1&quot;</span>
<a href="#l2.62"></a><span id="l2.62">                             xbl:inherits=&quot;context&quot;&gt;</span>
<a href="#l2.63"></a><span id="l2.63">                     &lt;xul:label anonid=&quot;event-name&quot;</span>
<a href="#l2.64"></a><span id="l2.64">                                crop=&quot;end&quot;</span>
<a href="#l2.65"></a><span id="l2.65">                                flex=&quot;1&quot;</span>
<a href="#l2.66"></a><span id="l2.66" class="difflineminus">-                               style=&quot;margin: 0;&quot;/&gt;</span>
<a href="#l2.67"></a><span id="l2.67" class="difflineplus">+                               style=&quot;margin: 0;&quot;&gt;</span>
<a href="#l2.68"></a><span id="l2.68" class="difflineplus">+                        &lt;html:div anonid=&quot;event-name-div&quot;/&gt;</span>
<a href="#l2.69"></a><span id="l2.69" class="difflineplus">+                    &lt;/xul:label&gt;</span>
<a href="#l2.70"></a><span id="l2.70">                     &lt;xul:textbox anonid=&quot;event-name-textbox&quot;</span>
<a href="#l2.71"></a><span id="l2.71">                                  class=&quot;plain calendar-event-name-textbox&quot;</span>
<a href="#l2.72"></a><span id="l2.72">                                  crop=&quot;end&quot;</span>
<a href="#l2.73"></a><span id="l2.73">                                  hidden=&quot;true&quot;</span>
<a href="#l2.74"></a><span id="l2.74">                                  wrap=&quot;true&quot;/&gt;</span>
<a href="#l2.75"></a><span id="l2.75">                     &lt;xul:spacer flex=&quot;1&quot;/&gt;</span>
<a href="#l2.76"></a><span id="l2.76">                   &lt;/xul:vbox&gt;</span>
<a href="#l2.77"></a><span id="l2.77" class="difflineminus">-                  &lt;xul:hbox anonid=&quot;alarm-icons-box&quot;</span>
<a href="#l2.78"></a><span id="l2.78" class="difflineminus">-                            class=&quot;alarm-icons-box&quot;</span>
<a href="#l2.79"></a><span id="l2.79" class="difflineminus">-                            align=&quot;center&quot;</span>
<a href="#l2.80"></a><span id="l2.80" class="difflineminus">-                            xbl:inherits=&quot;flashing&quot;/&gt;</span>
<a href="#l2.81"></a><span id="l2.81" class="difflineplus">+                  &lt;xul:stack&gt;</span>
<a href="#l2.82"></a><span id="l2.82" class="difflineplus">+                    &lt;xul:calendar-category-box anonid=&quot;category-box&quot; xbl:inherits=&quot;categories&quot; pack=&quot;end&quot;/&gt;</span>
<a href="#l2.83"></a><span id="l2.83" class="difflineplus">+                    &lt;xul:hbox anonid=&quot;alarm-icons-box&quot;</span>
<a href="#l2.84"></a><span id="l2.84" class="difflineplus">+                              class=&quot;alarm-icons-box&quot;</span>
<a href="#l2.85"></a><span id="l2.85" class="difflineplus">+                              align=&quot;center&quot;</span>
<a href="#l2.86"></a><span id="l2.86" class="difflineplus">+                              pack=&quot;end&quot;</span>
<a href="#l2.87"></a><span id="l2.87" class="difflineplus">+                              xbl:inherits=&quot;flashing&quot;/&gt;</span>
<a href="#l2.88"></a><span id="l2.88" class="difflineplus">+                  &lt;/xul:stack&gt;</span>
<a href="#l2.89"></a><span id="l2.89">                 &lt;/xul:hbox&gt;</span>
<a href="#l2.90"></a><span id="l2.90">                 &lt;xul:image anonid=&quot;gradient&quot;</span>
<a href="#l2.91"></a><span id="l2.91">                            class=&quot;calendar-event-box-gradient&quot;</span>
<a href="#l2.92"></a><span id="l2.92" class="difflineminus">-                           height=&quot;1px&quot;/&gt;</span>
<a href="#l2.93"></a><span id="l2.93" class="difflineplus">+                           height=&quot;1px&quot;</span>
<a href="#l2.94"></a><span id="l2.94" class="difflineplus">+                           mousethrough=&quot;always&quot;/&gt;</span>
<a href="#l2.95"></a><span id="l2.95">               &lt;/xul:stack&gt;</span>
<a href="#l2.96"></a><span id="l2.96">             &lt;/xul:box&gt;</span>
<a href="#l2.97"></a><span id="l2.97" class="difflineminus">-            &lt;xul:calendar-category-box anonid=&quot;category-box&quot; xbl:inherits=&quot;categories&quot;/&gt;</span>
<a href="#l2.98"></a><span id="l2.98">           &lt;/xul:box&gt;</span>
<a href="#l2.99"></a><span id="l2.99">         &lt;/xul:hbox&gt;</span>
<a href="#l2.100"></a><span id="l2.100">       &lt;/xul:vbox&gt;</span>
<a href="#l2.101"></a><span id="l2.101">     &lt;/content&gt;</span>
<a href="#l2.102"></a><span id="l2.102">     &lt;implementation&gt;</span>
<a href="#l2.103"></a><span id="l2.103">       &lt;property name=&quot;occurrence&quot;&gt;</span>
<a href="#l2.104"></a><span id="l2.104">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l2.105"></a><span id="l2.105">             return this.mOccurrence;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/calendar/base/content/calendar-multiday-view.xml</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/calendar/base/content/calendar-multiday-view.xml</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -23,16 +23,17 @@</span>
<a href="#l3.4"></a><span id="l3.4">    - Contributor(s):</span>
<a href="#l3.5"></a><span id="l3.5">    -   Vladimir Vukicevic &lt;vladimir.vukicevic@oracle.com&gt;</span>
<a href="#l3.6"></a><span id="l3.6">    -   Thomas Benisch &lt;thomas.benisch@sun.com&gt;</span>
<a href="#l3.7"></a><span id="l3.7">    -   Dan Mosedale &lt;dan.mosedale@oracle.com&gt;</span>
<a href="#l3.8"></a><span id="l3.8">    -   Michael Buettner &lt;michael.buettner@sun.com&gt;</span>
<a href="#l3.9"></a><span id="l3.9">    -   Philipp Kewisch &lt;mozilla@kewis.ch&gt;</span>
<a href="#l3.10"></a><span id="l3.10">    -   Markus Adrario &lt;MarkusAdrario@web.de&gt;</span>
<a href="#l3.11"></a><span id="l3.11">    -   Berend Cornelius &lt;berend.cornelius@sun.com&gt;</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+   -   Martin Schroeder &lt;mschroeder@mozilla.x-home.org&gt;</span>
<a href="#l3.13"></a><span id="l3.13">    -</span>
<a href="#l3.14"></a><span id="l3.14">    - Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l3.15"></a><span id="l3.15">    - either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l3.16"></a><span id="l3.16">    - the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l3.17"></a><span id="l3.17">    - in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l3.18"></a><span id="l3.18">    - of those above. If you wish to allow use of your version of this file only</span>
<a href="#l3.19"></a><span id="l3.19">    - under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l3.20"></a><span id="l3.20">    - use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineat">@@ -1891,53 +1892,58 @@</span>
<a href="#l3.22"></a><span id="l3.22">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l3.23"></a><span id="l3.23">     &lt;/handlers&gt;</span>
<a href="#l3.24"></a><span id="l3.24">   &lt;/binding&gt;</span>
<a href="#l3.25"></a><span id="l3.25"> </span>
<a href="#l3.26"></a><span id="l3.26">   &lt;!--</span>
<a href="#l3.27"></a><span id="l3.27">      -  An individual event box, to be inserted into a column.</span>
<a href="#l3.28"></a><span id="l3.28">     --&gt;</span>
<a href="#l3.29"></a><span id="l3.29">   &lt;binding id=&quot;calendar-event-box&quot; extends=&quot;chrome://calendar/content/calendar-view-core.xml#calendar-editable-item&quot;&gt;</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineminus">-    &lt;content tooltip=&quot;itemTooltip&quot; mousethrough=&quot;never&quot;&gt;</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineplus">+    &lt;content mousethrough=&quot;never&quot; tooltip=&quot;itemTooltip&quot;&gt;</span>
<a href="#l3.32"></a><span id="l3.32">         &lt;xul:box xbl:inherits=&quot;orient,width,height&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l3.33"></a><span id="l3.33">           &lt;xul:box anonid=&quot;event-container&quot;</span>
<a href="#l3.34"></a><span id="l3.34">                    class=&quot;calendar-color-box&quot;</span>
<a href="#l3.35"></a><span id="l3.35">                    xbl:inherits=&quot;orient,readonly,flashing,alarm,allday,priority,progress,status,calendar,categories,calendar-uri,calendar-id&quot;</span>
<a href="#l3.36"></a><span id="l3.36">                    flex=&quot;1&quot;&gt;</span>
<a href="#l3.37"></a><span id="l3.37">             &lt;xul:box class=&quot;calendar-event-selection&quot; orient=&quot;horizontal&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l3.38"></a><span id="l3.38">               &lt;xul:stack anonid=&quot;eventbox&quot;</span>
<a href="#l3.39"></a><span id="l3.39">                          align=&quot;stretch&quot;</span>
<a href="#l3.40"></a><span id="l3.40">                          class=&quot;calendar-event-box-container&quot;</span>
<a href="#l3.41"></a><span id="l3.41">                          flex=&quot;1&quot;</span>
<a href="#l3.42"></a><span id="l3.42">                          xbl:inherits=&quot;context,parentorient=orient,readonly,flashing,alarm,allday,priority,progress,status,calendar,categories&quot;&gt;</span>
<a href="#l3.43"></a><span id="l3.43">                 &lt;xul:image flex=&quot;1&quot; class=&quot;calendar-event-box-gradient&quot;/&gt;</span>
<a href="#l3.44"></a><span id="l3.44">                 &lt;xul:vbox class=&quot;calendar-event-details&quot; anonid=&quot;calendar-event-details&quot;&gt;</span>
<a href="#l3.45"></a><span id="l3.45" class="difflineminus">-                  &lt;xul:description anonid=&quot;event-name&quot; class=&quot;calendar-event-details-core&quot; flex=&quot;1&quot;/&gt;</span>
<a href="#l3.46"></a><span id="l3.46" class="difflineplus">+                  &lt;xul:description anonid=&quot;event-name&quot; class=&quot;calendar-event-details-core&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l3.47"></a><span id="l3.47" class="difflineplus">+                    &lt;html:div anonid=&quot;event-name-div&quot;/&gt;</span>
<a href="#l3.48"></a><span id="l3.48" class="difflineplus">+                  &lt;/xul:description&gt;</span>
<a href="#l3.49"></a><span id="l3.49" class="difflineplus">+</span>
<a href="#l3.50"></a><span id="l3.50">                   &lt;xul:textbox anonid=&quot;event-name-textbox&quot;</span>
<a href="#l3.51"></a><span id="l3.51">                                class=&quot;plain calendar-event-details-core calendar-event-name-textbox&quot;</span>
<a href="#l3.52"></a><span id="l3.52">                                flex=&quot;1&quot;</span>
<a href="#l3.53"></a><span id="l3.53">                                hidden=&quot;true&quot;</span>
<a href="#l3.54"></a><span id="l3.54">                                wrap=&quot;true&quot;/&gt;</span>
<a href="#l3.55"></a><span id="l3.55">                 &lt;/xul:vbox&gt;</span>
<a href="#l3.56"></a><span id="l3.56" class="difflineminus">-                &lt;xul:hbox pack=&quot;end&quot;&gt;</span>
<a href="#l3.57"></a><span id="l3.57" class="difflineminus">-                   &lt;xul:hbox anonid=&quot;alarm-icons-box&quot;</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineminus">-                             class=&quot;alarm-icons-box&quot;</span>
<a href="#l3.59"></a><span id="l3.59" class="difflineminus">-                             pack=&quot;end&quot;</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineminus">-                             align=&quot;top&quot;</span>
<a href="#l3.61"></a><span id="l3.61" class="difflineminus">-                             xbl:inherits=&quot;flashing&quot;/&gt;</span>
<a href="#l3.62"></a><span id="l3.62" class="difflineminus">-                   &lt;xul:calendar-category-box anonid=&quot;category-box&quot; xbl:inherits=&quot;categories&quot; pack=&quot;end&quot;/&gt;</span>
<a href="#l3.63"></a><span id="l3.63" class="difflineminus">-                &lt;/xul:hbox&gt;</span>
<a href="#l3.64"></a><span id="l3.64" class="difflineplus">+                &lt;xul:stack mousethrough=&quot;always&quot;&gt;</span>
<a href="#l3.65"></a><span id="l3.65" class="difflineplus">+                  &lt;xul:calendar-category-box anonid=&quot;category-box&quot; xbl:inherits=&quot;categories&quot; pack=&quot;end&quot; /&gt;</span>
<a href="#l3.66"></a><span id="l3.66" class="difflineplus">+                  &lt;xul:hbox anonid=&quot;alarm-icons-box&quot;</span>
<a href="#l3.67"></a><span id="l3.67" class="difflineplus">+                            class=&quot;alarm-icons-box&quot;</span>
<a href="#l3.68"></a><span id="l3.68" class="difflineplus">+                            pack=&quot;end&quot;</span>
<a href="#l3.69"></a><span id="l3.69" class="difflineplus">+                            align=&quot;top&quot;</span>
<a href="#l3.70"></a><span id="l3.70" class="difflineplus">+                            xbl:inherits=&quot;flashing&quot;/&gt;</span>
<a href="#l3.71"></a><span id="l3.71" class="difflineplus">+                &lt;/xul:stack&gt;</span>
<a href="#l3.72"></a><span id="l3.72">                 &lt;xul:box xbl:inherits=&quot;orient&quot;&gt;</span>
<a href="#l3.73"></a><span id="l3.73">                   &lt;xul:calendar-event-gripbar anonid=&quot;gripbar1&quot;</span>
<a href="#l3.74"></a><span id="l3.74">                                               class=&quot;calendar-event-box-grippy-top&quot;</span>
<a href="#l3.75"></a><span id="l3.75" class="difflineplus">+                                              mousethrough=&quot;never&quot;</span>
<a href="#l3.76"></a><span id="l3.76">                                               whichside=&quot;start&quot;</span>
<a href="#l3.77"></a><span id="l3.77">                                               xbl:inherits=&quot;parentorient=orient&quot;/&gt;</span>
<a href="#l3.78"></a><span id="l3.78" class="difflineminus">-                  &lt;xul:spacer flex=&quot;1&quot;/&gt;</span>
<a href="#l3.79"></a><span id="l3.79" class="difflineplus">+                  &lt;xul:spacer mousethrough=&quot;always&quot; flex=&quot;1&quot;/&gt;</span>
<a href="#l3.80"></a><span id="l3.80">                   &lt;xul:calendar-event-gripbar anonid=&quot;gripbar2&quot;</span>
<a href="#l3.81"></a><span id="l3.81">                                               class=&quot;calendar-event-box-grippy-bottom&quot;</span>
<a href="#l3.82"></a><span id="l3.82" class="difflineplus">+                                              mousethrough=&quot;never&quot;</span>
<a href="#l3.83"></a><span id="l3.83">                                               whichside=&quot;end&quot;</span>
<a href="#l3.84"></a><span id="l3.84">                                               xbl:inherits=&quot;parentorient=orient&quot;/&gt;</span>
<a href="#l3.85"></a><span id="l3.85">                 &lt;/xul:box&gt;</span>
<a href="#l3.86"></a><span id="l3.86">                 &lt;!-- Do not insert anything here, otherwise the event boxes will</span>
<a href="#l3.87"></a><span id="l3.87">                      not be resizable using the gripbars. If you want to insert</span>
<a href="#l3.88"></a><span id="l3.88">                      additional elements, do so above the box with the gripbars. --&gt;</span>
<a href="#l3.89"></a><span id="l3.89">               &lt;/xul:stack&gt;</span>
<a href="#l3.90"></a><span id="l3.90">             &lt;/xul:box&gt;</span>
<a href="#l3.91"></a><span id="l3.91" class="difflineat">@@ -2020,29 +2026,34 @@</span>
<a href="#l3.92"></a><span id="l3.92">                 return 0;</span>
<a href="#l3.93"></a><span id="l3.93">             var endDate = this.mOccurrence.endDate || this.mOccurrence.dueDate;</span>
<a href="#l3.94"></a><span id="l3.94">             return endDate.hour * 60 + endDate.minute;</span>
<a href="#l3.95"></a><span id="l3.95">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l3.96"></a><span id="l3.96">       &lt;/property&gt;</span>
<a href="#l3.97"></a><span id="l3.97"> </span>
<a href="#l3.98"></a><span id="l3.98">       &lt;method name=&quot;setEditableLabel&quot;&gt;</span>
<a href="#l3.99"></a><span id="l3.99">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l3.100"></a><span id="l3.100" class="difflineminus">-          var evl = this.eventNameLabel;</span>
<a href="#l3.101"></a><span id="l3.101" class="difflineminus">-          var item = this.mOccurrence;</span>
<a href="#l3.102"></a><span id="l3.102" class="difflineplus">+          let evldiv = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;event-name-div&quot;);</span>
<a href="#l3.103"></a><span id="l3.103" class="difflineplus">+          let item = this.mOccurrence;</span>
<a href="#l3.104"></a><span id="l3.104"> </span>
<a href="#l3.105"></a><span id="l3.105">           if (item.title &amp;&amp; item.title != &quot;&quot;) {</span>
<a href="#l3.106"></a><span id="l3.106">             // Use &lt;description&gt; textContent so it can wrap.</span>
<a href="#l3.107"></a><span id="l3.107" class="difflineminus">-            evl.textContent = item.title;</span>
<a href="#l3.108"></a><span id="l3.108" class="difflineplus">+            evldiv.textContent = item.title;</span>
<a href="#l3.109"></a><span id="l3.109">           } else {</span>
<a href="#l3.110"></a><span id="l3.110" class="difflineminus">-            evl.textContent = calGetString(&quot;calendar&quot;, &quot;eventUntitled&quot;);</span>
<a href="#l3.111"></a><span id="l3.111" class="difflineplus">+            evldiv.textContent = calGetString(&quot;calendar&quot;, &quot;eventUntitled&quot;);</span>
<a href="#l3.112"></a><span id="l3.112">           }</span>
<a href="#l3.113"></a><span id="l3.113"> </span>
<a href="#l3.114"></a><span id="l3.114">           var gripbar = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;gripbar1&quot;).boxObject.height;</span>
<a href="#l3.115"></a><span id="l3.115">           var height = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;eventbox&quot;).boxObject.height;</span>
<a href="#l3.116"></a><span id="l3.116" class="difflineminus">-          evl.setAttribute(&quot;style&quot;, &quot;max-height: &quot; + Math.max(0, height-gripbar*2) + &quot;px&quot;);</span>
<a href="#l3.117"></a><span id="l3.117" class="difflineplus">+          </span>
<a href="#l3.118"></a><span id="l3.118" class="difflineplus">+          if(this.orient == &quot;vertical&quot;) {</span>
<a href="#l3.119"></a><span id="l3.119" class="difflineplus">+            evldiv.setAttribute(&quot;style&quot;, &quot;max-height: &quot; + Math.max(0, height-gripbar*2) + &quot;px&quot;);</span>
<a href="#l3.120"></a><span id="l3.120" class="difflineplus">+          } else {</span>
<a href="#l3.121"></a><span id="l3.121" class="difflineplus">+            evldiv.setAttribute(&quot;style&quot;, &quot;max-height: &quot; + height + &quot;px&quot;);</span>
<a href="#l3.122"></a><span id="l3.122" class="difflineplus">+          }</span>
<a href="#l3.123"></a><span id="l3.123">         ]]&gt;&lt;/body&gt;</span>
<a href="#l3.124"></a><span id="l3.124">       &lt;/method&gt;</span>
<a href="#l3.125"></a><span id="l3.125">     &lt;/implementation&gt;</span>
<a href="#l3.126"></a><span id="l3.126"> </span>
<a href="#l3.127"></a><span id="l3.127">     &lt;handlers&gt;</span>
<a href="#l3.128"></a><span id="l3.128">       &lt;handler event=&quot;mousedown&quot; button=&quot;0&quot;&gt;&lt;![CDATA[</span>
<a href="#l3.129"></a><span id="l3.129">         event.stopPropagation();</span>
<a href="#l3.130"></a><span id="l3.130"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/calendar/base/content/calendar-view-core.xml</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/calendar/base/content/calendar-view-core.xml</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -18,16 +18,17 @@</span>
<a href="#l4.4"></a><span id="l4.4">    - The Initial Developer of the Original Code is</span>
<a href="#l4.5"></a><span id="l4.5">    -   Joey Minta &lt;jminta@gmail.com&gt;</span>
<a href="#l4.6"></a><span id="l4.6">    - Portions created by the Initial Developer are Copyright (C) 2005</span>
<a href="#l4.7"></a><span id="l4.7">    - the Initial Developer. All Rights Reserved.</span>
<a href="#l4.8"></a><span id="l4.8">    -</span>
<a href="#l4.9"></a><span id="l4.9">    - Contributor(s):</span>
<a href="#l4.10"></a><span id="l4.10">    -   Michael BÃ¼ttner &lt;michael.buettner@sun.com&gt;</span>
<a href="#l4.11"></a><span id="l4.11">    -   Philipp Kewisch &lt;mozilla@kewis.ch&gt;</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+   -   Martin Schroeder &lt;mschroeder@mozilla.x-home.org&gt;</span>
<a href="#l4.13"></a><span id="l4.13">    -</span>
<a href="#l4.14"></a><span id="l4.14">    - Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l4.15"></a><span id="l4.15">    - either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l4.16"></a><span id="l4.16">    - the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l4.17"></a><span id="l4.17">    - in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l4.18"></a><span id="l4.18">    - of those above. If you wish to allow use of your version of this file only</span>
<a href="#l4.19"></a><span id="l4.19">    - under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l4.20"></a><span id="l4.20">    - use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineat">@@ -43,17 +44,17 @@</span>
<a href="#l4.22"></a><span id="l4.22"> </span>
<a href="#l4.23"></a><span id="l4.23"> &lt;bindings id=&quot;calendar-core-view-bindings&quot;</span>
<a href="#l4.24"></a><span id="l4.24">     xmlns=&quot;http://www.mozilla.org/xbl&quot;</span>
<a href="#l4.25"></a><span id="l4.25">     xmlns:html=&quot;http://www.w3.org/1999/xhtml&quot;</span>
<a href="#l4.26"></a><span id="l4.26">     xmlns:xul=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;</span>
<a href="#l4.27"></a><span id="l4.27">     xmlns:xbl=&quot;http://www.mozilla.org/xbl&quot;&gt;</span>
<a href="#l4.28"></a><span id="l4.28"> </span>
<a href="#l4.29"></a><span id="l4.29">   &lt;binding id=&quot;calendar-editable-item&quot;&gt;</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineminus">-    &lt;content tooltip=&quot;itemTooltip&quot;&gt;</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineplus">+    &lt;content mousethrough=&quot;never&quot; tooltip=&quot;itemTooltip&quot;&gt;</span>
<a href="#l4.32"></a><span id="l4.32">       &lt;xul:vbox flex=&quot;1&quot;&gt;</span>
<a href="#l4.33"></a><span id="l4.33">         &lt;xul:hbox&gt;</span>
<a href="#l4.34"></a><span id="l4.34">           &lt;xul:box anonid=&quot;event-container&quot;</span>
<a href="#l4.35"></a><span id="l4.35">                    class=&quot;calendar-color-box&quot;</span>
<a href="#l4.36"></a><span id="l4.36">                    xbl:inherits=&quot;calendar-uri,calendar-id&quot;</span>
<a href="#l4.37"></a><span id="l4.37">                    flex=&quot;1&quot;&gt;</span>
<a href="#l4.38"></a><span id="l4.38">             &lt;xul:box class=&quot;calendar-event-selection&quot; orient=&quot;horizontal&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l4.39"></a><span id="l4.39">               &lt;xul:stack anonid=&quot;eventbox&quot;</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineat">@@ -62,67 +63,76 @@</span>
<a href="#l4.41"></a><span id="l4.41">                          xbl:inherits=&quot;readonly,flashing,alarm,allday,priority,progress,status,calendar,categories&quot;&gt;</span>
<a href="#l4.42"></a><span id="l4.42">                 &lt;xul:hbox class=&quot;calendar-event-details&quot;&gt;</span>
<a href="#l4.43"></a><span id="l4.43">                   &lt;xul:vbox align=&quot;left&quot;</span>
<a href="#l4.44"></a><span id="l4.44">                             flex=&quot;1&quot;</span>
<a href="#l4.45"></a><span id="l4.45">                             xbl:inherits=&quot;context&quot;&gt;</span>
<a href="#l4.46"></a><span id="l4.46">                     &lt;xul:label anonid=&quot;event-name&quot;</span>
<a href="#l4.47"></a><span id="l4.47">                                crop=&quot;end&quot;</span>
<a href="#l4.48"></a><span id="l4.48">                                flex=&quot;1&quot;</span>
<a href="#l4.49"></a><span id="l4.49" class="difflineminus">-                               style=&quot;margin: 0;&quot;/&gt;</span>
<a href="#l4.50"></a><span id="l4.50" class="difflineplus">+                               style=&quot;margin: 0;&quot;&gt;</span>
<a href="#l4.51"></a><span id="l4.51" class="difflineplus">+                      &lt;html:div anonid=&quot;event-name-div&quot;/&gt;</span>
<a href="#l4.52"></a><span id="l4.52" class="difflineplus">+                    &lt;/xul:label&gt;</span>
<a href="#l4.53"></a><span id="l4.53">                     &lt;xul:textbox anonid=&quot;event-name-textbox&quot;</span>
<a href="#l4.54"></a><span id="l4.54">                                  class=&quot;plain&quot;</span>
<a href="#l4.55"></a><span id="l4.55">                                  crop=&quot;end&quot;</span>
<a href="#l4.56"></a><span id="l4.56">                                  hidden=&quot;true&quot;</span>
<a href="#l4.57"></a><span id="l4.57">                                  style=&quot;background: transparent !important;&quot;</span>
<a href="#l4.58"></a><span id="l4.58">                                  wrap=&quot;true&quot;/&gt;</span>
<a href="#l4.59"></a><span id="l4.59">                     &lt;xul:spacer flex=&quot;1&quot;/&gt;</span>
<a href="#l4.60"></a><span id="l4.60">                   &lt;/xul:vbox&gt;</span>
<a href="#l4.61"></a><span id="l4.61" class="difflineminus">-                  &lt;xul:hbox anonid=&quot;alarm-icons-box&quot;</span>
<a href="#l4.62"></a><span id="l4.62" class="difflineminus">-                            class=&quot;alarm-icons-box&quot;</span>
<a href="#l4.63"></a><span id="l4.63" class="difflineminus">-                            align=&quot;center&quot;</span>
<a href="#l4.64"></a><span id="l4.64" class="difflineminus">-                            xbl:inherits=&quot;flashing&quot;/&gt;</span>
<a href="#l4.65"></a><span id="l4.65" class="difflineplus">+                  &lt;xul:stack&gt;</span>
<a href="#l4.66"></a><span id="l4.66" class="difflineplus">+                    &lt;xul:calendar-category-box anonid=&quot;category-box&quot;</span>
<a href="#l4.67"></a><span id="l4.67" class="difflineplus">+                                               xbl:inherits=&quot;categories&quot;</span>
<a href="#l4.68"></a><span id="l4.68" class="difflineplus">+                                               pack=&quot;end&quot;/&gt;</span>
<a href="#l4.69"></a><span id="l4.69" class="difflineplus">+                    &lt;xul:hbox anonid=&quot;alarm-icons-box&quot;</span>
<a href="#l4.70"></a><span id="l4.70" class="difflineplus">+                              class=&quot;alarm-icons-box&quot;</span>
<a href="#l4.71"></a><span id="l4.71" class="difflineplus">+                              align=&quot;center&quot;</span>
<a href="#l4.72"></a><span id="l4.72" class="difflineplus">+                              xbl:inherits=&quot;flashing&quot;/&gt;</span>
<a href="#l4.73"></a><span id="l4.73" class="difflineplus">+                  &lt;/xul:stack&gt;</span>
<a href="#l4.74"></a><span id="l4.74">                 &lt;/xul:hbox&gt;</span>
<a href="#l4.75"></a><span id="l4.75">                 &lt;xul:image anonid=&quot;gradient&quot;</span>
<a href="#l4.76"></a><span id="l4.76">                            class=&quot;calendar-event-box-gradient&quot;</span>
<a href="#l4.77"></a><span id="l4.77" class="difflineminus">-                           height=&quot;1px&quot;/&gt;</span>
<a href="#l4.78"></a><span id="l4.78" class="difflineplus">+                           height=&quot;1px&quot;</span>
<a href="#l4.79"></a><span id="l4.79" class="difflineplus">+                           mousethrough=&quot;always&quot;/&gt;</span>
<a href="#l4.80"></a><span id="l4.80">               &lt;/xul:stack&gt;</span>
<a href="#l4.81"></a><span id="l4.81">             &lt;/xul:box&gt;</span>
<a href="#l4.82"></a><span id="l4.82" class="difflineminus">-            &lt;xul:calendar-category-box anonid=&quot;category-box&quot; xbl:inherits=&quot;categories&quot;/&gt;</span>
<a href="#l4.83"></a><span id="l4.83">           &lt;/xul:box&gt;</span>
<a href="#l4.84"></a><span id="l4.84">         &lt;/xul:hbox&gt;</span>
<a href="#l4.85"></a><span id="l4.85">       &lt;/xul:vbox&gt;</span>
<a href="#l4.86"></a><span id="l4.86">     &lt;/content&gt;</span>
<a href="#l4.87"></a><span id="l4.87"> </span>
<a href="#l4.88"></a><span id="l4.88">     &lt;implementation&gt;</span>
<a href="#l4.89"></a><span id="l4.89">       &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l4.90"></a><span id="l4.90">          Components.utils.import(&quot;resource://calendar/modules/calAlarmUtils.jsm&quot;);</span>
<a href="#l4.91"></a><span id="l4.91"> </span>
<a href="#l4.92"></a><span id="l4.92" class="difflineminus">-         var self = this;</span>
<a href="#l4.93"></a><span id="l4.93" class="difflineminus">-         this.eventNameInput.onblur = function onBlur() { self.stopEditing(true); };</span>
<a href="#l4.94"></a><span id="l4.94" class="difflineminus">-         this.eventNameInput.onkeypress = function onKeyPress(event) {</span>
<a href="#l4.95"></a><span id="l4.95" class="difflineplus">+         let self = this;</span>
<a href="#l4.96"></a><span id="l4.96" class="difflineplus">+         this.eventNameTextbox.onblur = function onBlur() {</span>
<a href="#l4.97"></a><span id="l4.97" class="difflineplus">+             self.stopEditing(true);</span>
<a href="#l4.98"></a><span id="l4.98" class="difflineplus">+         };</span>
<a href="#l4.99"></a><span id="l4.99" class="difflineplus">+         this.eventNameTextbox.onkeypress = function onKeyPress(event) {</span>
<a href="#l4.100"></a><span id="l4.100">              // save on enter</span>
<a href="#l4.101"></a><span id="l4.101">              if (event.keyCode == 13)</span>
<a href="#l4.102"></a><span id="l4.102">                  self.stopEditing(true);</span>
<a href="#l4.103"></a><span id="l4.103">              // abort on escape</span>
<a href="#l4.104"></a><span id="l4.104">              else if (event.keyCode == 27)</span>
<a href="#l4.105"></a><span id="l4.105">                  self.stopEditing(false);</span>
<a href="#l4.106"></a><span id="l4.106">          };</span>
<a href="#l4.107"></a><span id="l4.107">          function stopPropagationIfEditing(event) { </span>
<a href="#l4.108"></a><span id="l4.108">            if (self.mEditing) {</span>
<a href="#l4.109"></a><span id="l4.109">              event.stopPropagation();</span>
<a href="#l4.110"></a><span id="l4.110">            }</span>
<a href="#l4.111"></a><span id="l4.111">          }</span>
<a href="#l4.112"></a><span id="l4.112">          // while editing, single click positions cursor, so don't propagate.</span>
<a href="#l4.113"></a><span id="l4.113" class="difflineminus">-         this.eventNameInput.onclick = stopPropagationIfEditing;</span>
<a href="#l4.114"></a><span id="l4.114" class="difflineplus">+         this.eventNameTextbox.onclick = stopPropagationIfEditing;</span>
<a href="#l4.115"></a><span id="l4.115">          // while editing, double click selects words, so don't propagate.</span>
<a href="#l4.116"></a><span id="l4.116" class="difflineminus">-         this.eventNameInput.ondblclick = stopPropagationIfEditing;</span>
<a href="#l4.117"></a><span id="l4.117" class="difflineplus">+         this.eventNameTextbox.ondblclick = stopPropagationIfEditing;</span>
<a href="#l4.118"></a><span id="l4.118">          // while editing, don't propagate mousedown/up (selects calEvent).</span>
<a href="#l4.119"></a><span id="l4.119" class="difflineminus">-         this.eventNameInput.onmousedown = stopPropagationIfEditing;</span>
<a href="#l4.120"></a><span id="l4.120" class="difflineminus">-         this.eventNameInput.onmouseup = stopPropagationIfEditing;</span>
<a href="#l4.121"></a><span id="l4.121" class="difflineplus">+         this.eventNameTextbox.onmousedown = stopPropagationIfEditing;</span>
<a href="#l4.122"></a><span id="l4.122" class="difflineplus">+         this.eventNameTextbox.onmouseup = stopPropagationIfEditing;</span>
<a href="#l4.123"></a><span id="l4.123">       ]]&gt;&lt;/constructor&gt;</span>
<a href="#l4.124"></a><span id="l4.124"> </span>
<a href="#l4.125"></a><span id="l4.125">       &lt;field name=&quot;mOccurrence&quot;&gt;null&lt;/field&gt;</span>
<a href="#l4.126"></a><span id="l4.126">       &lt;field name=&quot;mSelected&quot;&gt;false&lt;/field&gt;</span>
<a href="#l4.127"></a><span id="l4.127">       &lt;field name=&quot;mCalendarView&quot;&gt;null&lt;/field&gt;</span>
<a href="#l4.128"></a><span id="l4.128"> </span>
<a href="#l4.129"></a><span id="l4.129">       &lt;property name=&quot;selected&quot;&gt;</span>
<a href="#l4.130"></a><span id="l4.130">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l4.131"></a><span id="l4.131" class="difflineat">@@ -160,28 +170,26 @@</span>
<a href="#l4.132"></a><span id="l4.132">           return val;</span>
<a href="#l4.133"></a><span id="l4.133">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l4.134"></a><span id="l4.134">       &lt;/property&gt;</span>
<a href="#l4.135"></a><span id="l4.135"> </span>
<a href="#l4.136"></a><span id="l4.136">       &lt;property name=&quot;eventNameLabel&quot; readonly=&quot;true&quot;</span>
<a href="#l4.137"></a><span id="l4.137">         onget=&quot;return document.getAnonymousElementByAttribute(this, 'anonid', 'event-name');&quot;/&gt;</span>
<a href="#l4.138"></a><span id="l4.138">       &lt;property name=&quot;eventNameTextbox&quot; readonly=&quot;true&quot;</span>
<a href="#l4.139"></a><span id="l4.139">         onget=&quot;return document.getAnonymousElementByAttribute(this, 'anonid', 'event-name-textbox');&quot;/&gt;</span>
<a href="#l4.140"></a><span id="l4.140" class="difflineminus">-      &lt;property name=&quot;eventNameInput&quot; readonly=&quot;true&quot;</span>
<a href="#l4.141"></a><span id="l4.141" class="difflineminus">-        onget=&quot;return document.getAnonymousElementByAttribute(this, 'anonid', 'event-name-textbox').inputField;&quot;/&gt;</span>
<a href="#l4.142"></a><span id="l4.142" class="difflineplus">+</span>
<a href="#l4.143"></a><span id="l4.143">       &lt;method name=&quot;setEditableLabel&quot;&gt;</span>
<a href="#l4.144"></a><span id="l4.144">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l4.145"></a><span id="l4.145" class="difflineminus">-          var evl = this.eventNameLabel;</span>
<a href="#l4.146"></a><span id="l4.146" class="difflineminus">-          var item = this.mOccurrence;</span>
<a href="#l4.147"></a><span id="l4.147" class="difflineminus">-</span>
<a href="#l4.148"></a><span id="l4.148" class="difflineplus">+          let evldiv = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;event-name-div&quot;);</span>
<a href="#l4.149"></a><span id="l4.149" class="difflineplus">+          let item = this.mOccurrence;</span>
<a href="#l4.150"></a><span id="l4.150"> </span>
<a href="#l4.151"></a><span id="l4.151">           if (item.title &amp;&amp; item.title != &quot;&quot;) {</span>
<a href="#l4.152"></a><span id="l4.152" class="difflineminus">-            evl.value = item.title;</span>
<a href="#l4.153"></a><span id="l4.153" class="difflineplus">+            evldiv.textContent = item.title;</span>
<a href="#l4.154"></a><span id="l4.154">           } else {</span>
<a href="#l4.155"></a><span id="l4.155" class="difflineminus">-            evl.value = calGetString(&quot;calendar&quot;, &quot;eventUntitled&quot;)</span>
<a href="#l4.156"></a><span id="l4.156" class="difflineplus">+            evldiv.textContent = calGetString(&quot;calendar&quot;, &quot;eventUntitled&quot;);</span>
<a href="#l4.157"></a><span id="l4.157">           }</span>
<a href="#l4.158"></a><span id="l4.158">         ]]&gt;&lt;/body&gt;</span>
<a href="#l4.159"></a><span id="l4.159">       &lt;/method&gt;</span>
<a href="#l4.160"></a><span id="l4.160"> </span>
<a href="#l4.161"></a><span id="l4.161">       &lt;method name=&quot;setCSSClasses&quot;&gt;</span>
<a href="#l4.162"></a><span id="l4.162">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l4.163"></a><span id="l4.163">           var item = this.mOccurrence;          </span>
<a href="#l4.164"></a><span id="l4.164">           this.setAttribute(&quot;calendar-uri&quot;, item.calendar.uri.spec);</span>
<a href="#l4.165"></a><span id="l4.165" class="difflineat">@@ -231,17 +239,17 @@</span>
<a href="#l4.166"></a><span id="l4.166">           if (item.priority &gt; 0 &amp;&amp; item.priority &lt; 5) {</span>
<a href="#l4.167"></a><span id="l4.167">               this.setAttribute(&quot;priority&quot;, &quot;high&quot;);</span>
<a href="#l4.168"></a><span id="l4.168">           } else if (item.priority &gt; 5 &amp;&amp; item.priority &lt; 10) {</span>
<a href="#l4.169"></a><span id="l4.169">               this.setAttribute(&quot;priority&quot;, &quot;low&quot;);</span>
<a href="#l4.170"></a><span id="l4.170">           }</span>
<a href="#l4.171"></a><span id="l4.171"> </span>
<a href="#l4.172"></a><span id="l4.172">           // status attribute</span>
<a href="#l4.173"></a><span id="l4.173">           if (item.status) {</span>
<a href="#l4.174"></a><span id="l4.174" class="difflineminus">-              this.setAttribute(&quot;status&quot;, item.status.toLowerCase());</span>
<a href="#l4.175"></a><span id="l4.175" class="difflineplus">+              this.setAttribute(&quot;status&quot;, item.status.toUpperCase());</span>
<a href="#l4.176"></a><span id="l4.176">           }</span>
<a href="#l4.177"></a><span id="l4.177"> </span>
<a href="#l4.178"></a><span id="l4.178">           // calendar name</span>
<a href="#l4.179"></a><span id="l4.179">           this.setAttribute(&quot;calendar&quot;, item.calendar.name.toLowerCase());</span>
<a href="#l4.180"></a><span id="l4.180"> </span>
<a href="#l4.181"></a><span id="l4.181">           // Invitation</span>
<a href="#l4.182"></a><span id="l4.182">           if (item.calendar instanceof Components.interfaces.calISchedulingSupport &amp;&amp;</span>
<a href="#l4.183"></a><span id="l4.183">               item.calendar.isInvitation(item)) {</span>
<a href="#l4.184"></a><span id="l4.184" class="difflineat">@@ -259,18 +267,17 @@</span>
<a href="#l4.185"></a><span id="l4.185">           this.mOriginalTextLabel = this.mOccurrence.title;</span>
<a href="#l4.186"></a><span id="l4.186"> </span>
<a href="#l4.187"></a><span id="l4.187">           this.eventNameLabel.setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l4.188"></a><span id="l4.188"> </span>
<a href="#l4.189"></a><span id="l4.189">           this.mEditing = true;</span>
<a href="#l4.190"></a><span id="l4.190"> </span>
<a href="#l4.191"></a><span id="l4.191">           this.eventNameTextbox.value = this.mOriginalTextLabel;</span>
<a href="#l4.192"></a><span id="l4.192">           this.eventNameTextbox.removeAttribute(&quot;hidden&quot;);</span>
<a href="#l4.193"></a><span id="l4.193" class="difflineminus">-          this.eventNameInput.focus();</span>
<a href="#l4.194"></a><span id="l4.194" class="difflineminus">-          this.eventNameInput.select();</span>
<a href="#l4.195"></a><span id="l4.195" class="difflineplus">+          this.eventNameTextbox.select();</span>
<a href="#l4.196"></a><span id="l4.196">         ]]&gt;&lt;/body&gt;</span>
<a href="#l4.197"></a><span id="l4.197">       &lt;/method&gt;</span>
<a href="#l4.198"></a><span id="l4.198">       &lt;method name=&quot;select&quot;&gt;</span>
<a href="#l4.199"></a><span id="l4.199">         &lt;parameter name=&quot;event&quot;/&gt;</span>
<a href="#l4.200"></a><span id="l4.200">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l4.201"></a><span id="l4.201">             if (!this.calendarView) {</span>
<a href="#l4.202"></a><span id="l4.202">                 return;</span>
<a href="#l4.203"></a><span id="l4.203">             }</span>
<a href="#l4.204"></a><span id="l4.204" class="difflineat">@@ -324,17 +331,17 @@</span>
<a href="#l4.205"></a><span id="l4.205">         // the 'single click edit' timeout. Otherwise select the item too.</span>
<a href="#l4.206"></a><span id="l4.206">         // Also, check if the calendar is readOnly or we are offline.</span>
<a href="#l4.207"></a><span id="l4.207"> </span>
<a href="#l4.208"></a><span id="l4.208">         if (this.selected &amp;&amp; isCalendarWritable(this.mOccurrence.calendar)) {</span>
<a href="#l4.209"></a><span id="l4.209">             var self = this;</span>
<a href="#l4.210"></a><span id="l4.210">             if (this.editingTimer) {</span>
<a href="#l4.211"></a><span id="l4.211">                 clearTimeout(this.editingTimer);</span>
<a href="#l4.212"></a><span id="l4.212">             }</span>
<a href="#l4.213"></a><span id="l4.213" class="difflineminus">-            this.editingTimer = setTimeout(function alldayTimeout() { self.startEditing(); }, 350);</span>
<a href="#l4.214"></a><span id="l4.214" class="difflineplus">+            this.editingTimer = setTimeout(function editingTimeout() { self.startEditing(); }, 350);</span>
<a href="#l4.215"></a><span id="l4.215">         } else {</span>
<a href="#l4.216"></a><span id="l4.216">             this.select(event);</span>
<a href="#l4.217"></a><span id="l4.217">             event.stopPropagation();</span>
<a href="#l4.218"></a><span id="l4.218">         }</span>
<a href="#l4.219"></a><span id="l4.219">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l4.220"></a><span id="l4.220"> </span>
<a href="#l4.221"></a><span id="l4.221">       &lt;handler event=&quot;dblclick&quot; button=&quot;0&quot;&gt;&lt;![CDATA[</span>
<a href="#l4.222"></a><span id="l4.222">         event.stopPropagation();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-event-dialog-attendees.xul</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-event-dialog-attendees.xul</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -16,16 +16,17 @@</span>
<a href="#l5.4"></a><span id="l5.4">    -</span>
<a href="#l5.5"></a><span id="l5.5">    - The Initial Developer of the Original Code is Sun Microsystems.</span>
<a href="#l5.6"></a><span id="l5.6">    - Portions created by the Initial Developer are Copyright (C) 2006</span>
<a href="#l5.7"></a><span id="l5.7">    - the Initial Developer. All Rights Reserved.</span>
<a href="#l5.8"></a><span id="l5.8">    -</span>
<a href="#l5.9"></a><span id="l5.9">    - Contributor(s):</span>
<a href="#l5.10"></a><span id="l5.10">    -   Michael Buettner &lt;michael.buettner@sun.com&gt;</span>
<a href="#l5.11"></a><span id="l5.11">    -   Simon Vaillancourt &lt;simon.at.orcl@gmail.com&gt;   </span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+   -   Stefan Sitter &lt;ssitter@gmail.com&gt;</span>
<a href="#l5.13"></a><span id="l5.13">    -</span>
<a href="#l5.14"></a><span id="l5.14">    - Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l5.15"></a><span id="l5.15">    - either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l5.16"></a><span id="l5.16">    - the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l5.17"></a><span id="l5.17">    - in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l5.18"></a><span id="l5.18">    - of those above. If you wish to allow use of your version of this file only</span>
<a href="#l5.19"></a><span id="l5.19">    - under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l5.20"></a><span id="l5.20">    - use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineat">@@ -122,85 +123,102 @@</span>
<a href="#l5.22"></a><span id="l5.22">                  flex=&quot;1&quot;</span>
<a href="#l5.23"></a><span id="l5.23">                  id=&quot;vertical-scrollbar&quot;</span>
<a href="#l5.24"></a><span id="l5.24">                  maxpos=&quot;100&quot;/&gt;</span>
<a href="#l5.25"></a><span id="l5.25">       &lt;box class=&quot;attendee-spacer-bottom&quot;/&gt;</span>
<a href="#l5.26"></a><span id="l5.26">     &lt;/vbox&gt;</span>
<a href="#l5.27"></a><span id="l5.27">   &lt;/hbox&gt;</span>
<a href="#l5.28"></a><span id="l5.28">   &lt;hbox&gt;</span>
<a href="#l5.29"></a><span id="l5.29">     &lt;vbox&gt;</span>
<a href="#l5.30"></a><span id="l5.30" class="difflineminus">-      &lt;hbox align=&quot;center&quot;&gt;</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineminus">-        &lt;box class=&quot;legend&quot; status=&quot;FREE&quot;/&gt;</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineminus">-        &lt;label value=&quot;&amp;event.freebusy.legend.free;&quot;/&gt;</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineminus">-      &lt;/hbox&gt;</span>
<a href="#l5.34"></a><span id="l5.34" class="difflineminus">-      &lt;hbox align=&quot;center&quot;&gt;</span>
<a href="#l5.35"></a><span id="l5.35" class="difflineminus">-        &lt;box class=&quot;legend&quot; status=&quot;BUSY_TENTATIVE&quot;/&gt;</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineminus">-        &lt;label value=&quot;&amp;event.freebusy.legend.busy_tentative;&quot;/&gt;</span>
<a href="#l5.37"></a><span id="l5.37" class="difflineminus">-      &lt;/hbox&gt;        </span>
<a href="#l5.38"></a><span id="l5.38" class="difflineminus">-      &lt;hbox align=&quot;center&quot;&gt;</span>
<a href="#l5.39"></a><span id="l5.39" class="difflineminus">-        &lt;box class=&quot;legend&quot; status=&quot;BUSY&quot;/&gt;</span>
<a href="#l5.40"></a><span id="l5.40" class="difflineminus">-        &lt;label value=&quot;&amp;event.freebusy.legend.busy;&quot;/&gt;</span>
<a href="#l5.41"></a><span id="l5.41" class="difflineminus">-      &lt;/hbox&gt;</span>
<a href="#l5.42"></a><span id="l5.42">       &lt;hbox&gt;</span>
<a href="#l5.43"></a><span id="l5.43" class="difflineminus">-        &lt;button label=&quot;&amp;event.freebusy.minus;&quot;</span>
<a href="#l5.44"></a><span id="l5.44" class="difflineminus">-                oncommand=&quot;onMinus();&quot;/&gt;</span>
<a href="#l5.45"></a><span id="l5.45" class="difflineminus">-        &lt;button label=&quot;&amp;event.freebusy.plus;&quot;</span>
<a href="#l5.46"></a><span id="l5.46" class="difflineminus">-                oncommand=&quot;onPlus();&quot;/&gt;</span>
<a href="#l5.47"></a><span id="l5.47" class="difflineminus">-      &lt;/hbox&gt;</span>
<a href="#l5.48"></a><span id="l5.48" class="difflineminus">-      &lt;hbox collapsed=&quot;true&quot;&gt;</span>
<a href="#l5.49"></a><span id="l5.49" class="difflineminus">-        &lt;label value=&quot;&amp;event.organizer.label;&quot; disabled=&quot;true&quot; control=&quot;event-organizer&quot;/&gt;</span>
<a href="#l5.50"></a><span id="l5.50" class="difflineminus">-        &lt;textbox id=&quot;event-organizer&quot;</span>
<a href="#l5.51"></a><span id="l5.51" class="difflineminus">-                 disabled=&quot;true&quot;</span>
<a href="#l5.52"></a><span id="l5.52" class="difflineminus">-                 flex=&quot;true&quot;/&gt;</span>
<a href="#l5.53"></a><span id="l5.53" class="difflineminus">-      &lt;/hbox&gt;</span>
<a href="#l5.54"></a><span id="l5.54" class="difflineminus">-    &lt;/vbox&gt;</span>
<a href="#l5.55"></a><span id="l5.55" class="difflineminus">-    &lt;vbox&gt;</span>
<a href="#l5.56"></a><span id="l5.56" class="difflineminus">-      &lt;hbox align=&quot;center&quot;&gt;</span>
<a href="#l5.57"></a><span id="l5.57" class="difflineminus">-        &lt;box class=&quot;legend&quot; status=&quot;BUSY_UNAVAILABLE&quot;/&gt;</span>
<a href="#l5.58"></a><span id="l5.58" class="difflineminus">-        &lt;label value=&quot;&amp;event.freebusy.legend.busy_unavailable;&quot;/&gt;</span>
<a href="#l5.59"></a><span id="l5.59" class="difflineplus">+        &lt;grid&gt;</span>
<a href="#l5.60"></a><span id="l5.60" class="difflineplus">+          &lt;columns&gt;</span>
<a href="#l5.61"></a><span id="l5.61" class="difflineplus">+            &lt;column/&gt;&lt;!-- role icon --&gt;</span>
<a href="#l5.62"></a><span id="l5.62" class="difflineplus">+            &lt;column/&gt;&lt;!-- role description --&gt;</span>
<a href="#l5.63"></a><span id="l5.63" class="difflineplus">+            &lt;column/&gt;&lt;!-- status color --&gt;</span>
<a href="#l5.64"></a><span id="l5.64" class="difflineplus">+            &lt;column/&gt;&lt;!-- status description --&gt;</span>
<a href="#l5.65"></a><span id="l5.65" class="difflineplus">+            &lt;column/&gt;&lt;!-- status color --&gt;</span>
<a href="#l5.66"></a><span id="l5.66" class="difflineplus">+            &lt;column/&gt;&lt;!-- status description --&gt;</span>
<a href="#l5.67"></a><span id="l5.67" class="difflineplus">+          &lt;/columns&gt;</span>
<a href="#l5.68"></a><span id="l5.68" class="difflineplus">+          &lt;rows&gt;</span>
<a href="#l5.69"></a><span id="l5.69" class="difflineplus">+            &lt;row align=&quot;center&quot;&gt;</span>
<a href="#l5.70"></a><span id="l5.70" class="difflineplus">+              &lt;image class=&quot;role-icon&quot; role=&quot;REQ-PARTICIPANT&quot;/&gt;</span>
<a href="#l5.71"></a><span id="l5.71" class="difflineplus">+              &lt;label value=&quot;&amp;event.attendee.role.required;&quot;/&gt;</span>
<a href="#l5.72"></a><span id="l5.72" class="difflineplus">+              &lt;box class=&quot;legend&quot; status=&quot;FREE&quot;/&gt;</span>
<a href="#l5.73"></a><span id="l5.73" class="difflineplus">+              &lt;label value=&quot;&amp;event.freebusy.legend.free;&quot;/&gt;</span>
<a href="#l5.74"></a><span id="l5.74" class="difflineplus">+              &lt;box class=&quot;legend&quot; status=&quot;BUSY_UNAVAILABLE&quot;/&gt;</span>
<a href="#l5.75"></a><span id="l5.75" class="difflineplus">+              &lt;label value=&quot;&amp;event.freebusy.legend.busy_unavailable;&quot;/&gt;</span>
<a href="#l5.76"></a><span id="l5.76" class="difflineplus">+            &lt;/row&gt;</span>
<a href="#l5.77"></a><span id="l5.77" class="difflineplus">+            &lt;row align=&quot;center&quot;&gt;</span>
<a href="#l5.78"></a><span id="l5.78" class="difflineplus">+              &lt;image class=&quot;role-icon&quot; role=&quot;OPT-PARTICIPANT&quot;/&gt;</span>
<a href="#l5.79"></a><span id="l5.79" class="difflineplus">+              &lt;label value=&quot;&amp;event.attendee.role.optional;&quot;/&gt;</span>
<a href="#l5.80"></a><span id="l5.80" class="difflineplus">+              &lt;box class=&quot;legend&quot; status=&quot;BUSY_TENTATIVE&quot;/&gt;</span>
<a href="#l5.81"></a><span id="l5.81" class="difflineplus">+              &lt;label value=&quot;&amp;event.freebusy.legend.busy_tentative;&quot;/&gt;</span>
<a href="#l5.82"></a><span id="l5.82" class="difflineplus">+              &lt;box class=&quot;legend&quot; status=&quot;UNKNOWN&quot;/&gt;</span>
<a href="#l5.83"></a><span id="l5.83" class="difflineplus">+              &lt;label value=&quot;&amp;event.freebusy.legend.unknown;&quot;/&gt;</span>
<a href="#l5.84"></a><span id="l5.84" class="difflineplus">+            &lt;/row&gt;</span>
<a href="#l5.85"></a><span id="l5.85" class="difflineplus">+            &lt;row align=&quot;center&quot;&gt;</span>
<a href="#l5.86"></a><span id="l5.86" class="difflineplus">+              &lt;image class=&quot;role-icon&quot; role=&quot;CHAIR&quot;/&gt;</span>
<a href="#l5.87"></a><span id="l5.87" class="difflineplus">+              &lt;label value=&quot;&amp;event.attendee.role.chair;&quot;/&gt;</span>
<a href="#l5.88"></a><span id="l5.88" class="difflineplus">+              &lt;box class=&quot;legend&quot; status=&quot;BUSY&quot;/&gt;</span>
<a href="#l5.89"></a><span id="l5.89" class="difflineplus">+              &lt;label value=&quot;&amp;event.freebusy.legend.busy;&quot;/&gt;</span>
<a href="#l5.90"></a><span id="l5.90" class="difflineplus">+            &lt;/row&gt;</span>
<a href="#l5.91"></a><span id="l5.91" class="difflineplus">+          &lt;/rows&gt;</span>
<a href="#l5.92"></a><span id="l5.92" class="difflineplus">+        &lt;/grid&gt;</span>
<a href="#l5.93"></a><span id="l5.93">       &lt;/hbox&gt;</span>
<a href="#l5.94"></a><span id="l5.94">       &lt;hbox align=&quot;center&quot;&gt;</span>
<a href="#l5.95"></a><span id="l5.95" class="difflineminus">-        &lt;box class=&quot;legend&quot; status=&quot;UNKNOWN&quot;/&gt;</span>
<a href="#l5.96"></a><span id="l5.96" class="difflineminus">-        &lt;label value=&quot;&amp;event.freebusy.legend.unknown;&quot;/&gt;</span>
<a href="#l5.97"></a><span id="l5.97" class="difflineminus">-      &lt;/hbox&gt;</span>
<a href="#l5.98"></a><span id="l5.98" class="difflineminus">-    &lt;/vbox&gt;      </span>
<a href="#l5.99"></a><span id="l5.99" class="difflineminus">-    &lt;spacer flex=&quot;1&quot;/&gt;</span>
<a href="#l5.100"></a><span id="l5.100" class="difflineminus">-    &lt;grid&gt;</span>
<a href="#l5.101"></a><span id="l5.101" class="difflineminus">-      &lt;columns&gt;</span>
<a href="#l5.102"></a><span id="l5.102" class="difflineminus">-        &lt;column/&gt;</span>
<a href="#l5.103"></a><span id="l5.103" class="difflineminus">-        &lt;column flex=&quot;1&quot;/&gt;</span>
<a href="#l5.104"></a><span id="l5.104" class="difflineminus">-      &lt;/columns&gt;</span>
<a href="#l5.105"></a><span id="l5.105" class="difflineminus">-      &lt;rows&gt;</span>
<a href="#l5.106"></a><span id="l5.106" class="difflineminus">-        &lt;row align=&quot;center&quot;&gt;</span>
<a href="#l5.107"></a><span id="l5.107" class="difflineplus">+          &lt;button label=&quot;&amp;event.freebusy.minus;&quot; oncommand=&quot;onMinus();&quot;/&gt;</span>
<a href="#l5.108"></a><span id="l5.108" class="difflineplus">+          &lt;button label=&quot;&amp;event.freebusy.plus;&quot;  oncommand=&quot;onPlus();&quot;/&gt;</span>
<a href="#l5.109"></a><span id="l5.109">           &lt;spacer/&gt;</span>
<a href="#l5.110"></a><span id="l5.110" class="difflineminus">-          &lt;checkbox id=&quot;all-day&quot;</span>
<a href="#l5.111"></a><span id="l5.111" class="difflineminus">-                    oncommand=&quot;changeAllDay();&quot;</span>
<a href="#l5.112"></a><span id="l5.112" class="difflineminus">-                    label=&quot;&amp;event.alldayevent.label;&quot;/&gt;</span>
<a href="#l5.113"></a><span id="l5.113" class="difflineminus">-        &lt;/row&gt;</span>
<a href="#l5.114"></a><span id="l5.114" class="difflineminus">-        &lt;row align=&quot;center&quot;&gt;</span>
<a href="#l5.115"></a><span id="l5.115" class="difflineminus">-          &lt;label value=&quot;&amp;newevent.from.label;&quot; control=&quot;event-starttime&quot;/&gt;</span>
<a href="#l5.116"></a><span id="l5.116" class="difflineminus">-          &lt;datetimepicker id=&quot;event-starttime&quot;</span>
<a href="#l5.117"></a><span id="l5.117" class="difflineminus">-                          onchange=&quot;updateStartTime();&quot;/&gt;</span>
<a href="#l5.118"></a><span id="l5.118" class="difflineminus">-          &lt;label id=&quot;timezone-starttime&quot;</span>
<a href="#l5.119"></a><span id="l5.119" class="difflineminus">-                 crop=&quot;right&quot;</span>
<a href="#l5.120"></a><span id="l5.120" class="difflineminus">-                 class=&quot;text-link&quot;</span>
<a href="#l5.121"></a><span id="l5.121" class="difflineminus">-                 flex=&quot;1&quot;</span>
<a href="#l5.122"></a><span id="l5.122" class="difflineplus">+          &lt;label value=&quot;&amp;event.organizer.label;&quot;</span>
<a href="#l5.123"></a><span id="l5.123">                  collapsed=&quot;true&quot;</span>
<a href="#l5.124"></a><span id="l5.124" class="difflineminus">-                 hyperlink=&quot;true&quot;</span>
<a href="#l5.125"></a><span id="l5.125" class="difflineminus">-                 onclick=&quot;editStartTimezone()&quot;/&gt;</span>
<a href="#l5.126"></a><span id="l5.126" class="difflineminus">-        &lt;/row&gt;</span>
<a href="#l5.127"></a><span id="l5.127" class="difflineminus">-        &lt;row align=&quot;center&quot;&gt;</span>
<a href="#l5.128"></a><span id="l5.128" class="difflineminus">-          &lt;label value=&quot;&amp;newevent.to.label;&quot; control=&quot;event-endtime&quot;/&gt;</span>
<a href="#l5.129"></a><span id="l5.129" class="difflineminus">-          &lt;datetimepicker id=&quot;event-endtime&quot;</span>
<a href="#l5.130"></a><span id="l5.130" class="difflineminus">-                          onchange=&quot;updateEndTime();&quot;/&gt;</span>
<a href="#l5.131"></a><span id="l5.131" class="difflineminus">-          &lt;label id=&quot;timezone-endtime&quot;</span>
<a href="#l5.132"></a><span id="l5.132" class="difflineminus">-                 crop=&quot;right&quot;</span>
<a href="#l5.133"></a><span id="l5.133" class="difflineminus">-                 class=&quot;text-link&quot;</span>
<a href="#l5.134"></a><span id="l5.134" class="difflineminus">-                 flex=&quot;1&quot;</span>
<a href="#l5.135"></a><span id="l5.135" class="difflineminus">-                 collapsed=&quot;true&quot;</span>
<a href="#l5.136"></a><span id="l5.136" class="difflineminus">-                 hyperlink=&quot;true&quot;</span>
<a href="#l5.137"></a><span id="l5.137" class="difflineminus">-                 onclick=&quot;editEndTimezone()&quot;/&gt;</span>
<a href="#l5.138"></a><span id="l5.138" class="difflineminus">-        &lt;/row&gt;</span>
<a href="#l5.139"></a><span id="l5.139" class="difflineminus">-      &lt;/rows&gt;</span>
<a href="#l5.140"></a><span id="l5.140" class="difflineminus">-    &lt;/grid&gt;</span>
<a href="#l5.141"></a><span id="l5.141" class="difflineplus">+                 disabled=&quot;true&quot;</span>
<a href="#l5.142"></a><span id="l5.142" class="difflineplus">+                 control=&quot;event-organizer&quot;/&gt;</span>
<a href="#l5.143"></a><span id="l5.143" class="difflineplus">+          &lt;textbox id=&quot;event-organizer&quot;</span>
<a href="#l5.144"></a><span id="l5.144" class="difflineplus">+                   collapsed=&quot;true&quot;</span>
<a href="#l5.145"></a><span id="l5.145" class="difflineplus">+                   disabled=&quot;true&quot;</span>
<a href="#l5.146"></a><span id="l5.146" class="difflineplus">+                   flex=&quot;true&quot;/&gt;</span>
<a href="#l5.147"></a><span id="l5.147" class="difflineplus">+      &lt;/hbox&gt;</span>
<a href="#l5.148"></a><span id="l5.148" class="difflineplus">+    &lt;/vbox&gt;</span>
<a href="#l5.149"></a><span id="l5.149" class="difflineplus">+    &lt;spacer flex=&quot;1&quot;/&gt;</span>
<a href="#l5.150"></a><span id="l5.150" class="difflineplus">+    &lt;vbox&gt;</span>
<a href="#l5.151"></a><span id="l5.151" class="difflineplus">+      &lt;grid&gt;</span>
<a href="#l5.152"></a><span id="l5.152" class="difflineplus">+        &lt;columns&gt;</span>
<a href="#l5.153"></a><span id="l5.153" class="difflineplus">+          &lt;column/&gt;</span>
<a href="#l5.154"></a><span id="l5.154" class="difflineplus">+          &lt;column flex=&quot;1&quot;/&gt;</span>
<a href="#l5.155"></a><span id="l5.155" class="difflineplus">+        &lt;/columns&gt;</span>
<a href="#l5.156"></a><span id="l5.156" class="difflineplus">+        &lt;rows&gt;</span>
<a href="#l5.157"></a><span id="l5.157" class="difflineplus">+          &lt;row align=&quot;center&quot;&gt;</span>
<a href="#l5.158"></a><span id="l5.158" class="difflineplus">+            &lt;spacer/&gt;</span>
<a href="#l5.159"></a><span id="l5.159" class="difflineplus">+            &lt;checkbox id=&quot;all-day&quot;</span>
<a href="#l5.160"></a><span id="l5.160" class="difflineplus">+                      oncommand=&quot;changeAllDay();&quot;</span>
<a href="#l5.161"></a><span id="l5.161" class="difflineplus">+                      label=&quot;&amp;event.alldayevent.label;&quot;/&gt;</span>
<a href="#l5.162"></a><span id="l5.162" class="difflineplus">+          &lt;/row&gt;</span>
<a href="#l5.163"></a><span id="l5.163" class="difflineplus">+          &lt;row align=&quot;center&quot;&gt;</span>
<a href="#l5.164"></a><span id="l5.164" class="difflineplus">+            &lt;label value=&quot;&amp;newevent.from.label;&quot; control=&quot;event-starttime&quot;/&gt;</span>
<a href="#l5.165"></a><span id="l5.165" class="difflineplus">+            &lt;datetimepicker id=&quot;event-starttime&quot;</span>
<a href="#l5.166"></a><span id="l5.166" class="difflineplus">+                            onchange=&quot;updateStartTime();&quot;/&gt;</span>
<a href="#l5.167"></a><span id="l5.167" class="difflineplus">+            &lt;label id=&quot;timezone-starttime&quot;</span>
<a href="#l5.168"></a><span id="l5.168" class="difflineplus">+                   crop=&quot;right&quot;</span>
<a href="#l5.169"></a><span id="l5.169" class="difflineplus">+                   class=&quot;text-link&quot;</span>
<a href="#l5.170"></a><span id="l5.170" class="difflineplus">+                   flex=&quot;1&quot;</span>
<a href="#l5.171"></a><span id="l5.171" class="difflineplus">+                   collapsed=&quot;true&quot;</span>
<a href="#l5.172"></a><span id="l5.172" class="difflineplus">+                   hyperlink=&quot;true&quot;</span>
<a href="#l5.173"></a><span id="l5.173" class="difflineplus">+                   onclick=&quot;editStartTimezone()&quot;/&gt;</span>
<a href="#l5.174"></a><span id="l5.174" class="difflineplus">+          &lt;/row&gt;</span>
<a href="#l5.175"></a><span id="l5.175" class="difflineplus">+          &lt;row align=&quot;center&quot;&gt;</span>
<a href="#l5.176"></a><span id="l5.176" class="difflineplus">+            &lt;label value=&quot;&amp;newevent.to.label;&quot; control=&quot;event-endtime&quot;/&gt;</span>
<a href="#l5.177"></a><span id="l5.177" class="difflineplus">+            &lt;datetimepicker id=&quot;event-endtime&quot;</span>
<a href="#l5.178"></a><span id="l5.178" class="difflineplus">+                            onchange=&quot;updateEndTime();&quot;/&gt;</span>
<a href="#l5.179"></a><span id="l5.179" class="difflineplus">+            &lt;label id=&quot;timezone-endtime&quot;</span>
<a href="#l5.180"></a><span id="l5.180" class="difflineplus">+                   crop=&quot;right&quot;</span>
<a href="#l5.181"></a><span id="l5.181" class="difflineplus">+                   class=&quot;text-link&quot;</span>
<a href="#l5.182"></a><span id="l5.182" class="difflineplus">+                   flex=&quot;1&quot;</span>
<a href="#l5.183"></a><span id="l5.183" class="difflineplus">+                   collapsed=&quot;true&quot;</span>
<a href="#l5.184"></a><span id="l5.184" class="difflineplus">+                   hyperlink=&quot;true&quot;</span>
<a href="#l5.185"></a><span id="l5.185" class="difflineplus">+                   onclick=&quot;editEndTimezone()&quot;/&gt;</span>
<a href="#l5.186"></a><span id="l5.186" class="difflineplus">+          &lt;/row&gt;</span>
<a href="#l5.187"></a><span id="l5.187" class="difflineplus">+        &lt;/rows&gt;</span>
<a href="#l5.188"></a><span id="l5.188" class="difflineplus">+      &lt;/grid&gt;</span>
<a href="#l5.189"></a><span id="l5.189" class="difflineplus">+    &lt;/vbox&gt;</span>
<a href="#l5.190"></a><span id="l5.190">   &lt;/hbox&gt;</span>
<a href="#l5.191"></a><span id="l5.191">   &lt;separator class=&quot;groove&quot;/&gt;</span>
<a href="#l5.192"></a><span id="l5.192"> &lt;/dialog&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-event-dialog.xul</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-event-dialog.xul</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -493,31 +493,35 @@</span>
<a href="#l6.4"></a><span id="l6.4">                   &lt;menu id=&quot;options-status-menu&quot;</span>
<a href="#l6.5"></a><span id="l6.5">                         label=&quot;&amp;newevent.status.label;&quot;</span>
<a href="#l6.6"></a><span id="l6.6">                         accesskey=&quot;&amp;newevent.status.accesskey;&quot;</span>
<a href="#l6.7"></a><span id="l6.7">                         class=&quot;event-only&quot;</span>
<a href="#l6.8"></a><span id="l6.8">                         disable-on-readonly=&quot;true&quot;&gt;</span>
<a href="#l6.9"></a><span id="l6.9">                     &lt;menupopup id=&quot;options-status-menupopup&quot;&gt;</span>
<a href="#l6.10"></a><span id="l6.10">                       &lt;menuitem id=&quot;options-status-none-menuitem&quot;</span>
<a href="#l6.11"></a><span id="l6.11">                                 label=&quot;&amp;newevent.status.none.label;&quot;</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineplus">+                                accesskey=&quot;&amp;newevent.status.none.accesskey;&quot;</span>
<a href="#l6.13"></a><span id="l6.13">                                 type=&quot;checkbox&quot;</span>
<a href="#l6.14"></a><span id="l6.14">                                 command=&quot;cmd_status_none&quot;</span>
<a href="#l6.15"></a><span id="l6.15">                                 disable-on-readonly=&quot;true&quot;/&gt;</span>
<a href="#l6.16"></a><span id="l6.16">                       &lt;menuitem id=&quot;options-status-tentative-menuitem&quot;</span>
<a href="#l6.17"></a><span id="l6.17">                                 label=&quot;&amp;newevent.status.tentative.label;&quot;</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineplus">+                                accesskey=&quot;&amp;newevent.status.tentative.accesskey;&quot;</span>
<a href="#l6.19"></a><span id="l6.19">                                 type=&quot;checkbox&quot;</span>
<a href="#l6.20"></a><span id="l6.20">                                 command=&quot;cmd_status_tentative&quot;</span>
<a href="#l6.21"></a><span id="l6.21">                                 disable-on-readonly=&quot;true&quot;/&gt;</span>
<a href="#l6.22"></a><span id="l6.22">                       &lt;menuitem id=&quot;options-status-confirmed-menuitem&quot;</span>
<a href="#l6.23"></a><span id="l6.23">                                 label=&quot;&amp;newevent.status.confirmed.label;&quot;</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineplus">+                                accesskey=&quot;&amp;newevent.status.confirmed.accesskey;&quot;</span>
<a href="#l6.25"></a><span id="l6.25">                                 type=&quot;checkbox&quot;</span>
<a href="#l6.26"></a><span id="l6.26">                                 command=&quot;cmd_status_confirmed&quot;</span>
<a href="#l6.27"></a><span id="l6.27">                                 disable-on-readonly=&quot;true&quot;/&gt;</span>
<a href="#l6.28"></a><span id="l6.28">                       &lt;menuitem id=&quot;options-status-canceled-menuitem&quot;</span>
<a href="#l6.29"></a><span id="l6.29">                                 label=&quot;&amp;newevent.status.cancelled.label;&quot;</span>
<a href="#l6.30"></a><span id="l6.30" class="difflineplus">+                                accesskey=&quot;&amp;newevent.status.cancelled.accesskey;&quot;</span>
<a href="#l6.31"></a><span id="l6.31">                                 type=&quot;checkbox&quot;</span>
<a href="#l6.32"></a><span id="l6.32">                                 command=&quot;cmd_status_cancelled&quot;</span>
<a href="#l6.33"></a><span id="l6.33">                                 disable-on-readonly=&quot;true&quot;/&gt;</span>
<a href="#l6.34"></a><span id="l6.34">                     &lt;/menupopup&gt;</span>
<a href="#l6.35"></a><span id="l6.35">                   &lt;/menu&gt;</span>
<a href="#l6.36"></a><span id="l6.36">                   &lt;menuseparator id=&quot;options-menuseparator2&quot;/&gt;</span>
<a href="#l6.37"></a><span id="l6.37">                   &lt;menu id=&quot;options-freebusy-menu&quot;</span>
<a href="#l6.38"></a><span id="l6.38">                         label=&quot;&amp;event.menu.options.show.time.label;&quot;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/calendar/base/src/calCalendarManager.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/calendar/base/src/calCalendarManager.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -416,16 +416,19 @@ calCalendarManager.prototype = {</span>
<a href="#l7.4"></a><span id="l7.4">                             break;</span>
<a href="#l7.5"></a><span id="l7.5">                         case &quot;cache.updatetimer&quot;:</span>
<a href="#l7.6"></a><span id="l7.6">                             cal.setPref(getPrefBranchFor(id) + &quot;cache.updateTimer&quot;, Number(value));</span>
<a href="#l7.7"></a><span id="l7.7">                             break;</span>
<a href="#l7.8"></a><span id="l7.8">                         case &quot;backup-time&quot;:</span>
<a href="#l7.9"></a><span id="l7.9">                         case &quot;uniquenum&quot;:</span>
<a href="#l7.10"></a><span id="l7.10">                             cal.setPref(getPrefBranchFor(id) + name, Number(value));</span>
<a href="#l7.11"></a><span id="l7.11">                             break;</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineplus">+                        case &quot;name&quot;:</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+                            cal.setLocalizedPref(getPrefBranchFor(id) + name, value);</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+                            break;</span>
<a href="#l7.15"></a><span id="l7.15">                         default: // keep as string</span>
<a href="#l7.16"></a><span id="l7.16">                             cal.setPref(getPrefBranchFor(id) + name, value);</span>
<a href="#l7.17"></a><span id="l7.17">                             break;</span>
<a href="#l7.18"></a><span id="l7.18">                     }</span>
<a href="#l7.19"></a><span id="l7.19">                 }</span>
<a href="#l7.20"></a><span id="l7.20">                 selectPrefs.reset();</span>
<a href="#l7.21"></a><span id="l7.21">             }</span>
<a href="#l7.22"></a><span id="l7.22"> </span>
<a href="#l7.23"></a><span id="l7.23" class="difflineat">@@ -786,31 +789,41 @@ calCalendarManager.prototype = {</span>
<a href="#l7.24"></a><span id="l7.24">         }</span>
<a href="#l7.25"></a><span id="l7.25">     },</span>
<a href="#l7.26"></a><span id="l7.26"> </span>
<a href="#l7.27"></a><span id="l7.27">     getCalendarPref_: function(calendar, name) {</span>
<a href="#l7.28"></a><span id="l7.28">         cal.ASSERT(calendar, &quot;Invalid Calendar!&quot;);</span>
<a href="#l7.29"></a><span id="l7.29">         cal.ASSERT(calendar.id !== null, &quot;Calendar id needs to be set!&quot;);</span>
<a href="#l7.30"></a><span id="l7.30">         cal.ASSERT(name &amp;&amp; name.length &gt; 0, &quot;Pref Name must be non-empty!&quot;);</span>
<a href="#l7.31"></a><span id="l7.31"> </span>
<a href="#l7.32"></a><span id="l7.32" class="difflineminus">-        return cal.getPrefSafe(getPrefBranchFor(calendar.id) + name, null);</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineplus">+        let branch = (getPrefBranchFor(calendar.id) + name);</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineplus">+</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineplus">+        if ( name === &quot;name&quot; ) {</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineplus">+            return cal.getLocalizedPref(branch, null);</span>
<a href="#l7.37"></a><span id="l7.37" class="difflineplus">+        }</span>
<a href="#l7.38"></a><span id="l7.38" class="difflineplus">+        return cal.getPrefSafe(branch, null);</span>
<a href="#l7.39"></a><span id="l7.39">     },</span>
<a href="#l7.40"></a><span id="l7.40"> </span>
<a href="#l7.41"></a><span id="l7.41">     setCalendarPref_: function(calendar, name, value) {</span>
<a href="#l7.42"></a><span id="l7.42">         cal.ASSERT(calendar, &quot;Invalid Calendar!&quot;);</span>
<a href="#l7.43"></a><span id="l7.43">         cal.ASSERT(calendar.id !== null, &quot;Calendar id needs to be set!&quot;);</span>
<a href="#l7.44"></a><span id="l7.44">         cal.ASSERT(name &amp;&amp; name.length &gt; 0, &quot;Pref Name must be non-empty!&quot;);</span>
<a href="#l7.45"></a><span id="l7.45"> </span>
<a href="#l7.46"></a><span id="l7.46">         let branch = (getPrefBranchFor(calendar.id) + name);</span>
<a href="#l7.47"></a><span id="l7.47"> </span>
<a href="#l7.48"></a><span id="l7.48">         let prefService = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l7.49"></a><span id="l7.49">                                     .getService(Components.interfaces.nsIPrefBranch);</span>
<a href="#l7.50"></a><span id="l7.50">         // delete before to allow pref-type changes:</span>
<a href="#l7.51"></a><span id="l7.51">         prefService.deleteBranch(branch);</span>
<a href="#l7.52"></a><span id="l7.52" class="difflineminus">-        cal.setPref(branch, value);</span>
<a href="#l7.53"></a><span id="l7.53" class="difflineplus">+</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineplus">+        if ( name === &quot;name&quot; ) {</span>
<a href="#l7.55"></a><span id="l7.55" class="difflineplus">+            cal.setLocalizedPref(branch, value);</span>
<a href="#l7.56"></a><span id="l7.56" class="difflineplus">+        } else {</span>
<a href="#l7.57"></a><span id="l7.57" class="difflineplus">+            cal.setPref(branch, value);</span>
<a href="#l7.58"></a><span id="l7.58" class="difflineplus">+        }</span>
<a href="#l7.59"></a><span id="l7.59">     },</span>
<a href="#l7.60"></a><span id="l7.60"> </span>
<a href="#l7.61"></a><span id="l7.61">     deleteCalendarPref_: function(calendar, name) {</span>
<a href="#l7.62"></a><span id="l7.62">         cal.ASSERT(calendar, &quot;Invalid Calendar!&quot;);</span>
<a href="#l7.63"></a><span id="l7.63">         cal.ASSERT(calendar.id !== null, &quot;Calendar id needs to be set!&quot;);</span>
<a href="#l7.64"></a><span id="l7.64">         cal.ASSERT(name &amp;&amp; name.length &gt; 0, &quot;Pref Name must be non-empty!&quot;);</span>
<a href="#l7.65"></a><span id="l7.65"> </span>
<a href="#l7.66"></a><span id="l7.66">         let prefService = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1">index 023150b1d23dc34655cc96788fc6bc6e69e45441..d44fb602621d54a80e5a48869dad02ddeb11d66d</span>
<a href="#l8.2"></a><span id="l8.2">GIT binary patch
literal 969
zc$@*r12+7LP)&lt;h;3K|Lk000e1NJLTq000L7002M;1ONa4d&lt;LbA0009RX+uL$P-t&amp;-
zZ*ypGa3D!TLm+T+Z)Rz1WdHzp+GAi~p5W-&gt;&lt;jN$#z)(&lt;BQsf@w7#R^6rNDlkfsKKg
zfq{X6fgv%uxWF+Wz=wf&gt;fgvwHFO&gt;lmFfuTFyT-uCz`($8S=Z6U$(4aLz?xi8RKmc(
zaDah&lt;!6+rQIGKTg;R^!;Lwb2hK?wr`V+;cWgGf?#K?wr`V*vvLgGhErkTU}VV+#WV
z6HiHMMF|4~1A}vZL1j^9dPa$Yp{1pzf@4a4QmR65WpPPrZn1)AUUGg&gt;L4HwUNoooM
z0|V3!1_lNOUYGn51^2|vJOv{IRR$`9h{z}f2n!KD2r&amp;dmE-fm92PFf80D}U90fPfW
z07D`}J;MTqqYQ5t#Ti`~OBq)%-eVGD3SyeTbb(ozIg)uH^BWdRmJXI%ta_}itoPU~
z*`~35V-IKF&amp;7s86#qotRk@EtVBi9ygP3{FeQan?6g?K0N3G+?km*HP5pd+wD&amp;{gn?
zP^!=m;a(9Hk-ehfqF=-&amp;i5rPuk*JWAlRPGsFD)&amp;7LZ(bsUG|n-pS+9wABC-og-Uu#
zZ&lt;W`o6sVf0{!}}t-lY+$sigTq&gt;wxwoom5&gt;bJwd%!`bP{F7}gra7~7i2n=+feG`nEF
z(_)F`1gkphT$?!CKs#4^YX@UT9VazsB^L!(c{c@jWe;^vT`v=F8y|PyV7~&lt;a{DAtv
zi9t()cZFOGeHqRaAs1;C6%kz#Gc$Hi+=B$RMBSvY&lt;c5?rsW;O(GAuGPv*u=B%w^BB
z&amp;#x%hRQRq~yCkc0RoR;g{mPQ6T{VogUUgIJA2#YW)ij@Nm1`?(KiVnXRn&amp;dDSGBLP
z|L#PaNwX*aof&lt;#w@C=Qa{j&lt;K$Ntk&lt;jzWIWsi$oT;F8Q`BbNRiMA*)WWaap@&gt;z2$~&amp;
zn@l!u*=n+F`wpv}`**wUIlC`x|AT`$hkhPuKPG;B#YyW^=guUb{dIoQMeR#RuOwdm
zcYV%Hn_GA9)ZbISf8t@@W3eaupJl!fd3o@4{#*HX7d|w7GX4DO&gt;w@p$KLviB`qTQ)
z@&amp;A7S4FC@``j+us00002VoOIv0RM-N%)bBt010qNS#tmY3ljhU3ljkVnw%H_000Mc
zNliru*#sB{0uZvqFrxqf05(ZPK~yNuWBlL1@R$J(m&gt;5t13j+hge^R*r21qeUvj3&gt;3
rmlBHx%H)4T(1Wy#&amp;_R-b$&lt;1W|i%3BGGO41{00000NkvXXu0mjf#lxEm</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/calendar/base/themes/pinstripe/calendar-views.css</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/calendar/base/themes/pinstripe/calendar-views.css</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -410,28 +410,36 @@ calendar-month-day-box-item {</span>
<a href="#l9.4"></a><span id="l9.4">     padding: 0px 1px;</span>
<a href="#l9.5"></a><span id="l9.5"> }</span>
<a href="#l9.6"></a><span id="l9.6"> </span>
<a href="#l9.7"></a><span id="l9.7"> calendar-month-day-box-item[selected=&quot;true&quot;] .calendar-event-selection {</span>
<a href="#l9.8"></a><span id="l9.8">     color: #000000 !important;</span>
<a href="#l9.9"></a><span id="l9.9">     background-color: #ffdb67 !important;</span>
<a href="#l9.10"></a><span id="l9.10"> }</span>
<a href="#l9.11"></a><span id="l9.11"> </span>
<a href="#l9.12"></a><span id="l9.12" class="difflineplus">+.calendar-color-box {</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+    /* This rule should be adopted if the alarm image size is changed */</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineplus">+    min-height: 13px;</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineplus">+}</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineplus">+</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineplus">+calendar-month-day-box-item[selected=&quot;true&quot;] .calendar-color-box {</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineplus">+    color: #000000;</span>
<a href="#l9.19"></a><span id="l9.19" class="difflineplus">+}</span>
<a href="#l9.20"></a><span id="l9.20" class="difflineplus">+</span>
<a href="#l9.21"></a><span id="l9.21"> .calendar-month-day-box-item-label {</span>
<a href="#l9.22"></a><span id="l9.22">     padding: 0px;</span>
<a href="#l9.23"></a><span id="l9.23">     margin: 0px;</span>
<a href="#l9.24"></a><span id="l9.24"> }</span>
<a href="#l9.25"></a><span id="l9.25"> </span>
<a href="#l9.26"></a><span id="l9.26"> .calendar-month-day-box-item-label[time=&quot;true&quot;] {</span>
<a href="#l9.27"></a><span id="l9.27">     -moz-margin-end: 4px;</span>
<a href="#l9.28"></a><span id="l9.28"> }</span>
<a href="#l9.29"></a><span id="l9.29"> </span>
<a href="#l9.30"></a><span id="l9.30"> .calendar-month-day-box-item-image {</span>
<a href="#l9.31"></a><span id="l9.31">     list-style-image: url(&quot;chrome://calendar/skin/day-box-item-image.png&quot;);</span>
<a href="#l9.32"></a><span id="l9.32" class="difflineminus">-    margin: 2px;</span>
<a href="#l9.33"></a><span id="l9.33">     -moz-margin-end: 4px;</span>
<a href="#l9.34"></a><span id="l9.34">     display: none;</span>
<a href="#l9.35"></a><span id="l9.35"> }</span>
<a href="#l9.36"></a><span id="l9.36"> </span>
<a href="#l9.37"></a><span id="l9.37"> .calendar-month-day-box-item-image[type=&quot;todo&quot;]:not([progress]) {</span>
<a href="#l9.38"></a><span id="l9.38">     -moz-image-region: rect(0px 11px 11px 0px);</span>
<a href="#l9.39"></a><span id="l9.39">     display: inline;</span>
<a href="#l9.40"></a><span id="l9.40"> }</span>
<a href="#l9.41"></a><span id="l9.41" class="difflineat">@@ -581,24 +589,34 @@ calendar-event-box[invitation-status=&quot;NE</span>
<a href="#l9.42"></a><span id="l9.42"> calendar-editable-item[invitation-status=&quot;NEEDS-ACTION&quot;],</span>
<a href="#l9.43"></a><span id="l9.43"> calendar-month-day-box-item[invitation-status=&quot;NEEDS-ACTION&quot;] {</span>
<a href="#l9.44"></a><span id="l9.44">     border: 2px dotted black;</span>
<a href="#l9.45"></a><span id="l9.45">     opacity: 0.5;</span>
<a href="#l9.46"></a><span id="l9.46"> }</span>
<a href="#l9.47"></a><span id="l9.47"> </span>
<a href="#l9.48"></a><span id="l9.48"> calendar-event-box[invitation-status=&quot;TENTATIVE&quot;],</span>
<a href="#l9.49"></a><span id="l9.49"> calendar-editable-item[invitation-status=&quot;TENTATIVE&quot;],</span>
<a href="#l9.50"></a><span id="l9.50" class="difflineminus">-calendar-month-day-box-item[invitation-status=&quot;TENTATIVE&quot;] {</span>
<a href="#l9.51"></a><span id="l9.51" class="difflineplus">+calendar-month-day-box-item[invitation-status=&quot;TENTATIVE&quot;],</span>
<a href="#l9.52"></a><span id="l9.52" class="difflineplus">+calendar-event-box[status=&quot;TENTATIVE&quot;],</span>
<a href="#l9.53"></a><span id="l9.53" class="difflineplus">+calendar-editable-item[status=&quot;TENTATIVE&quot;],</span>
<a href="#l9.54"></a><span id="l9.54" class="difflineplus">+calendar-month-day-box-item[status=&quot;TENTATIVE&quot;] {</span>
<a href="#l9.55"></a><span id="l9.55">     opacity: 0.5;</span>
<a href="#l9.56"></a><span id="l9.56"> }</span>
<a href="#l9.57"></a><span id="l9.57"> </span>
<a href="#l9.58"></a><span id="l9.58"> calendar-event-box[invitation-status=&quot;DECLINED&quot;],</span>
<a href="#l9.59"></a><span id="l9.59"> calendar-editable-item[invitation-status=&quot;DECLINED&quot;],</span>
<a href="#l9.60"></a><span id="l9.60" class="difflineminus">-calendar-month-day-box-item[invitation-status=&quot;DECLINED&quot;] {</span>
<a href="#l9.61"></a><span id="l9.61" class="difflineminus">-    opacity: 0.3;</span>
<a href="#l9.62"></a><span id="l9.62" class="difflineplus">+calendar-month-day-box-item[invitation-status=&quot;DECLINED&quot;],</span>
<a href="#l9.63"></a><span id="l9.63" class="difflineplus">+calendar-event-box[status=&quot;CANCELLED&quot;],</span>
<a href="#l9.64"></a><span id="l9.64" class="difflineplus">+calendar-editable-item[status=&quot;CANCELLED&quot;],</span>
<a href="#l9.65"></a><span id="l9.65" class="difflineplus">+calendar-month-day-box-item[status=&quot;CANCELLED&quot;] {</span>
<a href="#l9.66"></a><span id="l9.66" class="difflineplus">+    opacity: 0.5;</span>
<a href="#l9.67"></a><span id="l9.67" class="difflineplus">+ }</span>
<a href="#l9.68"></a><span id="l9.68" class="difflineplus">+</span>
<a href="#l9.69"></a><span id="l9.69" class="difflineplus">+.calendar-event-box-container[status=&quot;CANCELLED&quot;] div {</span>
<a href="#l9.70"></a><span id="l9.70" class="difflineplus">+    text-decoration: line-through;</span>
<a href="#l9.71"></a><span id="l9.71"> }</span>
<a href="#l9.72"></a><span id="l9.72"> </span>
<a href="#l9.73"></a><span id="l9.73"> /* Navigation controls for the views */</span>
<a href="#l9.74"></a><span id="l9.74"> #calendar-nav-control {</span>
<a href="#l9.75"></a><span id="l9.75">     background-color: white;</span>
<a href="#l9.76"></a><span id="l9.76">     border: solid ThreeDShadow;</span>
<a href="#l9.77"></a><span id="l9.77">     border-width: 1px 1px 0;</span>
<a href="#l9.78"></a><span id="l9.78"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/calendar/base/themes/winstripe/calendar-views.css</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/calendar/base/themes/winstripe/calendar-views.css</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -410,28 +410,36 @@ calendar-month-day-box-item {</span>
<a href="#l10.4"></a><span id="l10.4">     padding: 0px 1px;</span>
<a href="#l10.5"></a><span id="l10.5"> }</span>
<a href="#l10.6"></a><span id="l10.6"> </span>
<a href="#l10.7"></a><span id="l10.7"> calendar-month-day-box-item[selected=&quot;true&quot;] .calendar-event-selection {</span>
<a href="#l10.8"></a><span id="l10.8">     color: #000000 !important;</span>
<a href="#l10.9"></a><span id="l10.9">     background-color: #ffdb67 !important;</span>
<a href="#l10.10"></a><span id="l10.10"> }</span>
<a href="#l10.11"></a><span id="l10.11"> </span>
<a href="#l10.12"></a><span id="l10.12" class="difflineplus">+.calendar-color-box {</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+    /* This rule should be adopted if the alarm image size is changed */</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineplus">+    min-height: 13px;</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineplus">+}</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineplus">+</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineplus">+calendar-month-day-box-item[selected=&quot;true&quot;] .calendar-color-box {</span>
<a href="#l10.18"></a><span id="l10.18" class="difflineplus">+    color: #000000;</span>
<a href="#l10.19"></a><span id="l10.19" class="difflineplus">+}</span>
<a href="#l10.20"></a><span id="l10.20" class="difflineplus">+</span>
<a href="#l10.21"></a><span id="l10.21"> .calendar-month-day-box-item-label {</span>
<a href="#l10.22"></a><span id="l10.22">     padding: 0px;</span>
<a href="#l10.23"></a><span id="l10.23">     margin: 0px;</span>
<a href="#l10.24"></a><span id="l10.24"> }</span>
<a href="#l10.25"></a><span id="l10.25"> </span>
<a href="#l10.26"></a><span id="l10.26"> .calendar-month-day-box-item-label[time=&quot;true&quot;] {</span>
<a href="#l10.27"></a><span id="l10.27">     -moz-margin-end: 4px;</span>
<a href="#l10.28"></a><span id="l10.28"> }</span>
<a href="#l10.29"></a><span id="l10.29"> </span>
<a href="#l10.30"></a><span id="l10.30"> .calendar-month-day-box-item-image {</span>
<a href="#l10.31"></a><span id="l10.31">     list-style-image: url(&quot;chrome://calendar/skin/day-box-item-image.png&quot;);</span>
<a href="#l10.32"></a><span id="l10.32" class="difflineminus">-    margin: 2px;</span>
<a href="#l10.33"></a><span id="l10.33">     -moz-margin-end: 4px;</span>
<a href="#l10.34"></a><span id="l10.34">     display: none;</span>
<a href="#l10.35"></a><span id="l10.35"> }</span>
<a href="#l10.36"></a><span id="l10.36"> </span>
<a href="#l10.37"></a><span id="l10.37"> .calendar-month-day-box-item-image[type=&quot;todo&quot;] {</span>
<a href="#l10.38"></a><span id="l10.38">     -moz-image-region: rect(0px 11px 11px 0px);</span>
<a href="#l10.39"></a><span id="l10.39">     display: inline;</span>
<a href="#l10.40"></a><span id="l10.40"> }</span>
<a href="#l10.41"></a><span id="l10.41" class="difflineat">@@ -581,24 +589,34 @@ calendar-event-box[invitation-status=&quot;NE</span>
<a href="#l10.42"></a><span id="l10.42"> calendar-editable-item[invitation-status=&quot;NEEDS-ACTION&quot;],</span>
<a href="#l10.43"></a><span id="l10.43"> calendar-month-day-box-item[invitation-status=&quot;NEEDS-ACTION&quot;] {</span>
<a href="#l10.44"></a><span id="l10.44">     border: 2px dotted black;</span>
<a href="#l10.45"></a><span id="l10.45">     opacity: 0.6;</span>
<a href="#l10.46"></a><span id="l10.46"> }</span>
<a href="#l10.47"></a><span id="l10.47"> </span>
<a href="#l10.48"></a><span id="l10.48"> calendar-event-box[invitation-status=&quot;TENTATIVE&quot;],</span>
<a href="#l10.49"></a><span id="l10.49"> calendar-editable-item[invitation-status=&quot;TENTATIVE&quot;],</span>
<a href="#l10.50"></a><span id="l10.50" class="difflineminus">-calendar-month-day-box-item[invitation-status=&quot;TENTATIVE&quot;] {</span>
<a href="#l10.51"></a><span id="l10.51" class="difflineplus">+calendar-month-day-box-item[invitation-status=&quot;TENTATIVE&quot;],</span>
<a href="#l10.52"></a><span id="l10.52" class="difflineplus">+calendar-event-box[status=&quot;TENTATIVE&quot;],</span>
<a href="#l10.53"></a><span id="l10.53" class="difflineplus">+calendar-editable-item[status=&quot;TENTATIVE&quot;],</span>
<a href="#l10.54"></a><span id="l10.54" class="difflineplus">+calendar-month-day-box-item[status=&quot;TENTATIVE&quot;] {</span>
<a href="#l10.55"></a><span id="l10.55">     opacity: 0.6;</span>
<a href="#l10.56"></a><span id="l10.56"> }</span>
<a href="#l10.57"></a><span id="l10.57"> </span>
<a href="#l10.58"></a><span id="l10.58"> calendar-event-box[invitation-status=&quot;DECLINED&quot;],</span>
<a href="#l10.59"></a><span id="l10.59"> calendar-editable-item[invitation-status=&quot;DECLINED&quot;],</span>
<a href="#l10.60"></a><span id="l10.60" class="difflineminus">-calendar-month-day-box-item[invitation-status=&quot;DECLINED&quot;] {</span>
<a href="#l10.61"></a><span id="l10.61" class="difflineminus">-    opacity: 0.3;</span>
<a href="#l10.62"></a><span id="l10.62" class="difflineplus">+calendar-month-day-box-item[invitation-status=&quot;DECLINED&quot;],</span>
<a href="#l10.63"></a><span id="l10.63" class="difflineplus">+calendar-event-box[status=&quot;CANCELLED&quot;],</span>
<a href="#l10.64"></a><span id="l10.64" class="difflineplus">+calendar-editable-item[status=&quot;CANCELLED&quot;],</span>
<a href="#l10.65"></a><span id="l10.65" class="difflineplus">+calendar-month-day-box-item[status=&quot;CANCELLED&quot;] {</span>
<a href="#l10.66"></a><span id="l10.66" class="difflineplus">+    opacity: 0.5;</span>
<a href="#l10.67"></a><span id="l10.67" class="difflineplus">+ }</span>
<a href="#l10.68"></a><span id="l10.68" class="difflineplus">+</span>
<a href="#l10.69"></a><span id="l10.69" class="difflineplus">+.calendar-event-box-container[status=&quot;CANCELLED&quot;] div {</span>
<a href="#l10.70"></a><span id="l10.70" class="difflineplus">+    text-decoration: line-through;</span>
<a href="#l10.71"></a><span id="l10.71"> }</span>
<a href="#l10.72"></a><span id="l10.72"> </span>
<a href="#l10.73"></a><span id="l10.73"> /* Navigation controls for the views */</span>
<a href="#l10.74"></a><span id="l10.74"> #calendar-nav-control {</span>
<a href="#l10.75"></a><span id="l10.75">     background-color: white;</span>
<a href="#l10.76"></a><span id="l10.76">     border: solid ThreeDShadow;</span>
<a href="#l10.77"></a><span id="l10.77">     border-width: 1px 1px 0;</span>
<a href="#l10.78"></a><span id="l10.78"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/calendar/lightning/jar.mn</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/calendar/lightning/jar.mn</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -1,11 +1,10 @@</span>
<a href="#l11.4"></a><span id="l11.4"> #filter substitution</span>
<a href="#l11.5"></a><span id="l11.5"> lightning.jar:</span>
<a href="#l11.6"></a><span id="l11.6" class="difflineminus">-% content messagebody %content/messagebody/ contentaccessible=yes</span>
<a href="#l11.7"></a><span id="l11.7"> % override chrome://messagebody/skin/imip.css chrome://lightning/skin/imip.css</span>
<a href="#l11.8"></a><span id="l11.8"> % overlay chrome://messenger/content/messenger.xul chrome://lightning/content/lightning-migration.xul</span>
<a href="#l11.9"></a><span id="l11.9"> % overlay chrome://messenger/content/msgAccountCentral.xul chrome://lightning/content/messenger-overlay-accountCentral.xul</span>
<a href="#l11.10"></a><span id="l11.10"> % overlay chrome://messenger/content/messenger.xul chrome://lightning/content/messenger-overlay-sidebar.xul</span>
<a href="#l11.11"></a><span id="l11.11"> % overlay chrome://messenger/content/messageWindow.xul chrome://lightning/content/imip-bar-overlay.xul</span>
<a href="#l11.12"></a><span id="l11.12"> % overlay chrome://messenger/content/messageWindow.xul chrome://lightning/content/messenger-overlay-messageWindow.xul</span>
<a href="#l11.13"></a><span id="l11.13"> % overlay chrome://lightning/content/messenger-overlay-sidebar.xul chrome://lightning/content/imip-bar-overlay.xul</span>
<a href="#l11.14"></a><span id="l11.14"> % overlay chrome://messenger/content/preferences/preferences.xul chrome://lightning/content/messenger-overlay-preferences.xul</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/calendar/locales/en-US/chrome/calendar/calendar-event-dialog.dtd</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/calendar/locales/en-US/chrome/calendar/calendar-event-dialog.dtd</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -44,25 +44,29 @@</span>
<a href="#l12.4"></a><span id="l12.4"> </span>
<a href="#l12.5"></a><span id="l12.5"> &lt;!ENTITY event.title.label                  &quot;Edit Item&quot; &gt;</span>
<a href="#l12.6"></a><span id="l12.6"> </span>
<a href="#l12.7"></a><span id="l12.7"> </span>
<a href="#l12.8"></a><span id="l12.8"> &lt;!ENTITY newevent.from.label                &quot;From&quot; &gt;</span>
<a href="#l12.9"></a><span id="l12.9"> &lt;!ENTITY newevent.to.label                  &quot;To&quot; &gt;</span>
<a href="#l12.10"></a><span id="l12.10"> &lt;!ENTITY newevent.attendees.notify.label    &quot;Notify attendees&quot;&gt;</span>
<a href="#l12.11"></a><span id="l12.11"> </span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-&lt;!ENTITY newevent.status.label              &quot;Status&quot; &gt;</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineminus">-&lt;!ENTITY newevent.status.accesskey          &quot;S&quot; &gt;</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineminus">-&lt;!ENTITY newevent.status.none.label         &quot;Not specified&quot; &gt;</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineminus">-&lt;!ENTITY newevent.status.cancelled.label    &quot;Cancelled&quot; &gt;</span>
<a href="#l12.16"></a><span id="l12.16" class="difflineminus">-&lt;!ENTITY newevent.status.tentative.label    &quot;Tentative&quot; &gt;</span>
<a href="#l12.17"></a><span id="l12.17" class="difflineminus">-&lt;!ENTITY newevent.status.confirmed.label    &quot;Confirmed&quot; &gt;</span>
<a href="#l12.18"></a><span id="l12.18" class="difflineminus">-&lt;!ENTITY newevent.status.needsaction.label  &quot;Needs Action&quot; &gt;</span>
<a href="#l12.19"></a><span id="l12.19" class="difflineminus">-&lt;!ENTITY newevent.status.inprogress.label   &quot;In Process&quot; &gt;</span>
<a href="#l12.20"></a><span id="l12.20" class="difflineminus">-&lt;!ENTITY newevent.status.completed.label    &quot;Completed on&quot; &gt;</span>
<a href="#l12.21"></a><span id="l12.21" class="difflineplus">+&lt;!ENTITY newevent.status.label                &quot;Status&quot; &gt;</span>
<a href="#l12.22"></a><span id="l12.22" class="difflineplus">+&lt;!ENTITY newevent.status.accesskey            &quot;S&quot; &gt;</span>
<a href="#l12.23"></a><span id="l12.23" class="difflineplus">+&lt;!ENTITY newevent.status.none.label           &quot;Not specified&quot; &gt;</span>
<a href="#l12.24"></a><span id="l12.24" class="difflineplus">+&lt;!ENTITY newevent.status.none.accesskey       &quot;o&quot; &gt;</span>
<a href="#l12.25"></a><span id="l12.25" class="difflineplus">+&lt;!ENTITY newevent.status.cancelled.label      &quot;Cancelled&quot; &gt;</span>
<a href="#l12.26"></a><span id="l12.26" class="difflineplus">+&lt;!ENTITY newevent.status.cancelled.accesskey  &quot;n&quot; &gt;</span>
<a href="#l12.27"></a><span id="l12.27" class="difflineplus">+&lt;!ENTITY newevent.status.tentative.label      &quot;Tentative&quot; &gt;</span>
<a href="#l12.28"></a><span id="l12.28" class="difflineplus">+&lt;!ENTITY newevent.status.tentative.accesskey  &quot;T&quot; &gt;</span>
<a href="#l12.29"></a><span id="l12.29" class="difflineplus">+&lt;!ENTITY newevent.status.confirmed.label      &quot;Confirmed&quot; &gt;</span>
<a href="#l12.30"></a><span id="l12.30" class="difflineplus">+&lt;!ENTITY newevent.status.confirmed.accesskey  &quot;C&quot; &gt;</span>
<a href="#l12.31"></a><span id="l12.31" class="difflineplus">+&lt;!ENTITY newevent.status.needsaction.label    &quot;Needs Action&quot; &gt;</span>
<a href="#l12.32"></a><span id="l12.32" class="difflineplus">+&lt;!ENTITY newevent.status.inprogress.label     &quot;In Process&quot; &gt;</span>
<a href="#l12.33"></a><span id="l12.33" class="difflineplus">+&lt;!ENTITY newevent.status.completed.label      &quot;Completed on&quot; &gt;</span>
<a href="#l12.34"></a><span id="l12.34"> </span>
<a href="#l12.35"></a><span id="l12.35"> &lt;!-- The following entity is for New Task dialog only --&gt;</span>
<a href="#l12.36"></a><span id="l12.36"> &lt;!ENTITY newtodo.percentcomplete.label      &quot;&amp;#37; complete&quot;&gt;</span>
<a href="#l12.37"></a><span id="l12.37"> </span>
<a href="#l12.38"></a><span id="l12.38"> &lt;!-- Menubar --&gt;</span>
<a href="#l12.39"></a><span id="l12.39"> &lt;!ENTITY  event.menu.file.label                           &quot;File&quot;&gt;</span>
<a href="#l12.40"></a><span id="l12.40"> &lt;!ENTITY  event.menu.file.accesskey                       &quot;F&quot;&gt;</span>
<a href="#l12.41"></a><span id="l12.41"> &lt;!ENTITY  event.menu.file.new.label                       &quot;New&quot;&gt;</span>
<a href="#l12.42"></a><span id="l12.42" class="difflineat">@@ -344,16 +348,19 @@</span>
<a href="#l12.43"></a><span id="l12.43"> &lt;!ENTITY event.freebusy.zoom                    &quot;Zoom:&quot;&gt;</span>
<a href="#l12.44"></a><span id="l12.44"> &lt;!ENTITY event.freebusy.plus                    &quot;Next hour&quot; &gt;</span>
<a href="#l12.45"></a><span id="l12.45"> &lt;!ENTITY event.freebusy.minus                   &quot;Previous hour&quot; &gt;</span>
<a href="#l12.46"></a><span id="l12.46"> &lt;!ENTITY event.freebusy.legend.free             &quot;Free&quot; &gt;</span>
<a href="#l12.47"></a><span id="l12.47"> &lt;!ENTITY event.freebusy.legend.busy             &quot;Busy&quot; &gt;</span>
<a href="#l12.48"></a><span id="l12.48"> &lt;!ENTITY event.freebusy.legend.busy_tentative   &quot;Tentative&quot; &gt;</span>
<a href="#l12.49"></a><span id="l12.49"> &lt;!ENTITY event.freebusy.legend.busy_unavailable &quot;Out of Office&quot; &gt;</span>
<a href="#l12.50"></a><span id="l12.50"> &lt;!ENTITY event.freebusy.legend.unknown          &quot;No Information&quot; &gt;</span>
<a href="#l12.51"></a><span id="l12.51" class="difflineplus">+&lt;!ENTITY event.attendee.role.required           &quot;Required Attendee&quot;&gt;</span>
<a href="#l12.52"></a><span id="l12.52" class="difflineplus">+&lt;!ENTITY event.attendee.role.optional           &quot;Optional Attendee&quot;&gt;</span>
<a href="#l12.53"></a><span id="l12.53" class="difflineplus">+&lt;!ENTITY event.attendee.role.chair              &quot;Chair&quot;&gt;</span>
<a href="#l12.54"></a><span id="l12.54"> </span>
<a href="#l12.55"></a><span id="l12.55"> &lt;!-- Timezone dialog --&gt;</span>
<a href="#l12.56"></a><span id="l12.56"> &lt;!ENTITY timezone.title.label            &quot;Please Specify the Timezone&quot;&gt;</span>
<a href="#l12.57"></a><span id="l12.57"> </span>
<a href="#l12.58"></a><span id="l12.58"> &lt;!-- Read-Only dialog --&gt;</span>
<a href="#l12.59"></a><span id="l12.59"> &lt;!ENTITY read.only.general.label         &quot;General&quot;&gt;</span>
<a href="#l12.60"></a><span id="l12.60"> &lt;!ENTITY read.only.title.label           &quot;Title:&quot;&gt;</span>
<a href="#l12.61"></a><span id="l12.61"> &lt;!ENTITY read.only.repeat.label          &quot;Repeat:&quot;&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/calendar/providers/caldav/calDavCalendar.js</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/calendar/providers/caldav/calDavCalendar.js</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -1298,16 +1298,17 @@ calDavCalendar.prototype = {</span>
<a href="#l13.4"></a><span id="l13.4">             try {</span>
<a href="#l13.5"></a><span id="l13.5">                 cal.LOG(&quot;CalDAV: Status &quot; + request.responseStatus +</span>
<a href="#l13.6"></a><span id="l13.6">                         &quot; on initial PROPFIND for calendar &quot; + thisCalendar.name);</span>
<a href="#l13.7"></a><span id="l13.7">             } catch (ex) {</span>
<a href="#l13.8"></a><span id="l13.8">                 cal.LOG(&quot;CalDAV: Error without status on initial PROPFIND for calendar &quot; +</span>
<a href="#l13.9"></a><span id="l13.9">                         thisCalendar.name);</span>
<a href="#l13.10"></a><span id="l13.10">                 thisCalendar.completeCheckServerInfo(aChangeLogListener,</span>
<a href="#l13.11"></a><span id="l13.11">                                                      Components.interfaces.calIErrors.DAV_NOT_DAV);</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineplus">+                return;</span>
<a href="#l13.13"></a><span id="l13.13">             }</span>
<a href="#l13.14"></a><span id="l13.14">             var wwwauth;</span>
<a href="#l13.15"></a><span id="l13.15">             try {</span>
<a href="#l13.16"></a><span id="l13.16">                 wwwauth = request.getRequestHeader(&quot;Authorization&quot;);</span>
<a href="#l13.17"></a><span id="l13.17">                 thisCalendar.mAuthScheme = wwwauth.split(&quot; &quot;)[0];</span>
<a href="#l13.18"></a><span id="l13.18">             } catch (ex) {</span>
<a href="#l13.19"></a><span id="l13.19">                 // no auth header could mean a public calendar</span>
<a href="#l13.20"></a><span id="l13.20">                 thisCalendar.mAuthScheme = &quot;none&quot;;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1">deleted file mode 100644</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineminus">--- a/calendar/test/homegrown/caldav/jsDriver-hook.pl</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineplus">+++ /dev/null</span>
<a href="#l14.4"></a><span id="l14.4" class="difflineat">@@ -1,2 +0,0 @@</span>
<a href="#l14.5"></a><span id="l14.5" class="difflineminus">-</span>
<a href="#l14.6"></a><span id="l14.6" class="difflineminus">-../memory</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1">deleted file mode 100644</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineminus">--- a/calendar/test/homegrown/caldav/shell.js</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineplus">+++ /dev/null</span>
<a href="#l15.4"></a><span id="l15.4" class="difflineat">@@ -1,6 +0,0 @@</span>
<a href="#l15.5"></a><span id="l15.5" class="difflineminus">-// init file for each test in this directory.  executed in the xpcshell before</span>
<a href="#l15.6"></a><span id="l15.6" class="difflineminus">-// starting each test</span>
<a href="#l15.7"></a><span id="l15.7" class="difflineminus">-</span>
<a href="#l15.8"></a><span id="l15.8" class="difflineminus">-// create a memory calendar</span>
<a href="#l15.9"></a><span id="l15.9" class="difflineminus">-createCal(&quot;caldav&quot;);</span>
<a href="#l15.10"></a><span id="l15.10" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1">deleted file mode 100644</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineminus">--- a/calendar/test/homegrown/ics2ics.js</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineplus">+++ /dev/null</span>
<a href="#l16.4"></a><span id="l16.4" class="difflineat">@@ -1,26 +0,0 @@</span>
<a href="#l16.5"></a><span id="l16.5" class="difflineminus">-var str = &quot;BEGIN:VCALENDAR\n&quot;;</span>
<a href="#l16.6"></a><span id="l16.6" class="difflineminus">-   str += &quot;BEGIN:VEVENT\n&quot;;</span>
<a href="#l16.7"></a><span id="l16.7" class="difflineminus">-   str += &quot;CREATED:20050104T211235\n&quot;;</span>
<a href="#l16.8"></a><span id="l16.8" class="difflineminus">-   str += &quot;LAST-MODIFIED:20050108T182742\n&quot;;</span>
<a href="#l16.9"></a><span id="l16.9" class="difflineminus">-   str += &quot;DTSTAMP:20050104T211235\n&quot;;</span>
<a href="#l16.10"></a><span id="l16.10" class="difflineminus">-   str += &quot;UID:uuid:1104873174977\n&quot;;</span>
<a href="#l16.11"></a><span id="l16.11" class="difflineminus">-   str += &quot;SUMMARY:teste\n&quot;;</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-   str += &quot;DTSTART:20050107T094500\n&quot;;</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineminus">-   str += &quot;DTEND:20050107T104500\n&quot;;</span>
<a href="#l16.14"></a><span id="l16.14" class="difflineminus">-   str += &quot;RRULE:FREQ=DAILY;COUNT=43;INTERVAL=5\n&quot;;</span>
<a href="#l16.15"></a><span id="l16.15" class="difflineminus">-   str += &quot;ATTENDEE:MAILTO:test@example.com\n&quot;;</span>
<a href="#l16.16"></a><span id="l16.16" class="difflineminus">-   str += &quot;END:VEVENT\n&quot;;</span>
<a href="#l16.17"></a><span id="l16.17" class="difflineminus">-   str += &quot;END:VCALENDAR\n&quot;;</span>
<a href="#l16.18"></a><span id="l16.18" class="difflineminus">-</span>
<a href="#l16.19"></a><span id="l16.19" class="difflineminus">-var icsServ = Components.classes[&quot;@mozilla.org/calendar/ics-service;1&quot;]</span>
<a href="#l16.20"></a><span id="l16.20" class="difflineminus">-                        .getService(Components.interfaces.calIICSService);</span>
<a href="#l16.21"></a><span id="l16.21" class="difflineminus">-</span>
<a href="#l16.22"></a><span id="l16.22" class="difflineminus">-var calComp = icsServ.parseICS(str, null);</span>
<a href="#l16.23"></a><span id="l16.23" class="difflineminus">-var subComp = calComp.getFirstSubcomponent(&quot;VEVENT&quot;);</span>
<a href="#l16.24"></a><span id="l16.24" class="difflineminus">-var event = Components.classes[&quot;@mozilla.org/calendar/event;1&quot;]</span>
<a href="#l16.25"></a><span id="l16.25" class="difflineminus">-                      .createInstance(Components.interfaces.calIEvent);</span>
<a href="#l16.26"></a><span id="l16.26" class="difflineminus">-event.icalComponent = subComp;</span>
<a href="#l16.27"></a><span id="l16.27" class="difflineminus">-</span>
<a href="#l16.28"></a><span id="l16.28" class="difflineminus">-var newCalComp = event.icalComponent;</span>
<a href="#l16.29"></a><span id="l16.29" class="difflineminus">-dump(newCalComp.serializeToICS());</span>
<a href="#l16.30"></a><span id="l16.30" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1">deleted file mode 100644</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineminus">--- a/calendar/test/homegrown/memory/add-get-delete-event.js</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineplus">+++ /dev/null</span>
<a href="#l17.4"></a><span id="l17.4" class="difflineat">@@ -1,26 +0,0 @@</span>
<a href="#l17.5"></a><span id="l17.5" class="difflineminus">-// create an event</span>
<a href="#l17.6"></a><span id="l17.6" class="difflineminus">-var item = createItem();</span>
<a href="#l17.7"></a><span id="l17.7" class="difflineminus">-</span>
<a href="#l17.8"></a><span id="l17.8" class="difflineminus">-item.title = &quot;Test Event&quot;;</span>
<a href="#l17.9"></a><span id="l17.9" class="difflineminus">-</span>
<a href="#l17.10"></a><span id="l17.10" class="difflineminus">-// add it to the calendar</span>
<a href="#l17.11"></a><span id="l17.11" class="difflineminus">-var newItem = addItem(item);</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-dump(&quot;newItem = &quot; + newItem + &quot;\n&quot;);</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineminus">-</span>
<a href="#l17.14"></a><span id="l17.14" class="difflineminus">-// XXX what should happen to untyped item?</span>
<a href="#l17.15"></a><span id="l17.15" class="difflineminus">-</span>
<a href="#l17.16"></a><span id="l17.16" class="difflineminus">-// XXX compare newItem to item</span>
<a href="#l17.17"></a><span id="l17.17" class="difflineminus">-</span>
<a href="#l17.18"></a><span id="l17.18" class="difflineminus">-// get it from the calendar</span>
<a href="#l17.19"></a><span id="l17.19" class="difflineminus">-var gottenItem = getItem(newItem.id);</span>
<a href="#l17.20"></a><span id="l17.20" class="difflineminus">-dump(&quot;gottenItem = &quot; + gottenItem + &quot;\n&quot;);</span>
<a href="#l17.21"></a><span id="l17.21" class="difflineminus">-</span>
<a href="#l17.22"></a><span id="l17.22" class="difflineminus">-// XXX compare gottenItem to item</span>
<a href="#l17.23"></a><span id="l17.23" class="difflineminus">-</span>
<a href="#l17.24"></a><span id="l17.24" class="difflineminus">-// delete it from the calendar</span>
<a href="#l17.25"></a><span id="l17.25" class="difflineminus">-var deletedItem = deleteItem(gottenItem);</span>
<a href="#l17.26"></a><span id="l17.26" class="difflineminus">-dump(&quot;deletedItem = &quot; + deletedItem + &quot;\n&quot;);</span>
<a href="#l17.27"></a><span id="l17.27" class="difflineminus">-</span>
<a href="#l17.28"></a><span id="l17.28" class="difflineminus">-// XXX compare deletedItem to gottenItem</span>
<a href="#l17.29"></a><span id="l17.29" class="difflineminus">-</span>
<a href="#l17.30"></a><span id="l17.30" class="difflineminus">-// XXX make sure getting and deleting again both fail</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1">deleted file mode 100644</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineminus">--- a/calendar/test/homegrown/memory/add-get-delete-events.js</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineplus">+++ /dev/null</span>
<a href="#l18.4"></a><span id="l18.4" class="difflineat">@@ -1,37 +0,0 @@</span>
<a href="#l18.5"></a><span id="l18.5" class="difflineminus">-// create some events</span>
<a href="#l18.6"></a><span id="l18.6" class="difflineminus">-var item1 = createItem();</span>
<a href="#l18.7"></a><span id="l18.7" class="difflineminus">-item1.title = &quot;Test Event 1&quot;;</span>
<a href="#l18.8"></a><span id="l18.8" class="difflineminus">-var item2 = createItem();</span>
<a href="#l18.9"></a><span id="l18.9" class="difflineminus">-item2.title = &quot;Test Event 2&quot;;</span>
<a href="#l18.10"></a><span id="l18.10" class="difflineminus">-</span>
<a href="#l18.11"></a><span id="l18.11" class="difflineminus">-// add them to the calendar</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-var newItem1 = addItem(item1);</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineminus">-dump(&quot;newItem1 = &quot; + newItem1 + &quot;\n&quot;);</span>
<a href="#l18.14"></a><span id="l18.14" class="difflineminus">-var newItem2 = addItem(item2);</span>
<a href="#l18.15"></a><span id="l18.15" class="difflineminus">-dump(&quot;newItem2 = &quot; + newItem2 + &quot;\n&quot;);</span>
<a href="#l18.16"></a><span id="l18.16" class="difflineminus">-</span>
<a href="#l18.17"></a><span id="l18.17" class="difflineminus">-// XXX what should happen untyped items?</span>
<a href="#l18.18"></a><span id="l18.18" class="difflineminus">-</span>
<a href="#l18.19"></a><span id="l18.19" class="difflineminus">-// XXX compare newItems to items</span>
<a href="#l18.20"></a><span id="l18.20" class="difflineminus">-</span>
<a href="#l18.21"></a><span id="l18.21" class="difflineminus">-// get them from the calendar</span>
<a href="#l18.22"></a><span id="l18.22" class="difflineminus">-var gottenItems = getItems(Ci.calICalendar.ITEM_FILTER_COMPLETED_ALL | </span>
<a href="#l18.23"></a><span id="l18.23" class="difflineminus">-			   Ci.calICalendar.ITEM_FILTER_TYPE_EVENT, 0, null, </span>
<a href="#l18.24"></a><span id="l18.24" class="difflineminus">-			   null);</span>
<a href="#l18.25"></a><span id="l18.25" class="difflineminus">-</span>
<a href="#l18.26"></a><span id="l18.26" class="difflineminus">-dump(&quot;gottenItems = &quot; + gottenItems + &quot;\n&quot;);</span>
<a href="#l18.27"></a><span id="l18.27" class="difflineminus">-</span>
<a href="#l18.28"></a><span id="l18.28" class="difflineminus">-// XXX compare gottenItem to item</span>
<a href="#l18.29"></a><span id="l18.29" class="difflineminus">-</span>
<a href="#l18.30"></a><span id="l18.30" class="difflineminus">-// delete it from the calendar</span>
<a href="#l18.31"></a><span id="l18.31" class="difflineminus">-var deletedItem1 = deleteItem(gottenItems[0]);</span>
<a href="#l18.32"></a><span id="l18.32" class="difflineminus">-dump(&quot;deletedItem1 = &quot; + deletedItem1 + &quot;\n&quot;);</span>
<a href="#l18.33"></a><span id="l18.33" class="difflineminus">-var deletedItem2 = deleteItem(gottenItems[1]);</span>
<a href="#l18.34"></a><span id="l18.34" class="difflineminus">-dump(&quot;deletedItem2 = &quot; + deletedItem2 + &quot;\n&quot;);</span>
<a href="#l18.35"></a><span id="l18.35" class="difflineminus">-</span>
<a href="#l18.36"></a><span id="l18.36" class="difflineminus">-// XXX compare deletedItem to gottenItem</span>
<a href="#l18.37"></a><span id="l18.37" class="difflineminus">-</span>
<a href="#l18.38"></a><span id="l18.38" class="difflineminus">-// XXX make sure getting and deleting again both fail</span>
<a href="#l18.39"></a><span id="l18.39" class="difflineminus">-</span>
<a href="#l18.40"></a><span id="l18.40" class="difflineminus">-</span>
<a href="#l18.41"></a><span id="l18.41" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1">deleted file mode 100644</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineminus">--- a/calendar/test/homegrown/memory/shell.js</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineplus">+++ /dev/null</span>
<a href="#l19.4"></a><span id="l19.4" class="difflineat">@@ -1,6 +0,0 @@</span>
<a href="#l19.5"></a><span id="l19.5" class="difflineminus">-// init file for each test in this directory.  executed in the xpcshell before</span>
<a href="#l19.6"></a><span id="l19.6" class="difflineminus">-// starting each test</span>
<a href="#l19.7"></a><span id="l19.7" class="difflineminus">-</span>
<a href="#l19.8"></a><span id="l19.8" class="difflineminus">-// create a memory calendar</span>
<a href="#l19.9"></a><span id="l19.9" class="difflineminus">-createCal(&quot;memory&quot;);</span>
<a href="#l19.10"></a><span id="l19.10" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1">deleted file mode 100644</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineminus">--- a/calendar/test/homegrown/misc/attendee.js</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineplus">+++ /dev/null</span>
<a href="#l20.4"></a><span id="l20.4" class="difflineat">@@ -1,156 +0,0 @@</span>
<a href="#l20.5"></a><span id="l20.5" class="difflineminus">-var eventClass = C.classes[&quot;@mozilla.org/calendar/event;1&quot;];</span>
<a href="#l20.6"></a><span id="l20.6" class="difflineminus">-var eventIID = C.interfaces.calIEvent;</span>
<a href="#l20.7"></a><span id="l20.7" class="difflineminus">-</span>
<a href="#l20.8"></a><span id="l20.8" class="difflineminus">-var attendeeClass = C.classes[&quot;@mozilla.org/calendar/attendee;1&quot;];</span>
<a href="#l20.9"></a><span id="l20.9" class="difflineminus">-var attendeeIID = C.interfaces.calIAttendee;</span>
<a href="#l20.10"></a><span id="l20.10" class="difflineminus">-</span>
<a href="#l20.11"></a><span id="l20.11" class="difflineminus">-dump(&quot;* Creating event.\n&quot;);</span>
<a href="#l20.12"></a><span id="l20.12" class="difflineminus">-var e = eventClass.createInstance(eventIID);</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineminus">-dump(&quot;* Creating attendee.\n&quot;);</span>
<a href="#l20.14"></a><span id="l20.14" class="difflineminus">-var a1 = attendeeClass.createInstance(attendeeIID);</span>
<a href="#l20.15"></a><span id="l20.15" class="difflineminus">-dump(&quot;* Testing attendee set/get.\n&quot;);</span>
<a href="#l20.16"></a><span id="l20.16" class="difflineminus">-var properties = [&quot;id&quot;, &quot;commonName&quot;, &quot;rsvp&quot;, &quot;role&quot;, &quot;participationStatus&quot;,</span>
<a href="#l20.17"></a><span id="l20.17" class="difflineminus">-		  &quot;userType&quot;];</span>
<a href="#l20.18"></a><span id="l20.18" class="difflineminus">-var values = [&quot;myid&quot;, &quot;mycn&quot;, &quot;TRUE&quot;, attendeeIID.ROLE_CHAIR,</span>
<a href="#l20.19"></a><span id="l20.19" class="difflineminus">-	      attendeeIID.PARTSTAT_DECLINED,</span>
<a href="#l20.20"></a><span id="l20.20" class="difflineminus">-	      attendeeIID.CUTYPE_RESOURCE];</span>
<a href="#l20.21"></a><span id="l20.21" class="difflineminus">-if (properties.length != values.length)</span>
<a href="#l20.22"></a><span id="l20.22" class="difflineminus">-    throw &quot;Test bug: mismatched properties and values arrays!&quot;;</span>
<a href="#l20.23"></a><span id="l20.23" class="difflineminus">-</span>
<a href="#l20.24"></a><span id="l20.24" class="difflineminus">-for (var i = 0; i &lt; properties.length; i++) {</span>
<a href="#l20.25"></a><span id="l20.25" class="difflineminus">-    a1[properties[i]] = values[i];</span>
<a href="#l20.26"></a><span id="l20.26" class="difflineminus">-    if (a1[properties[i]] != values[i]) {</span>
<a href="#l20.27"></a><span id="l20.27" class="difflineminus">-	throw &quot;FAILED! &quot; + properties[i] + &quot; not set to &quot; + values[i];</span>
<a href="#l20.28"></a><span id="l20.28" class="difflineminus">-    }</span>
<a href="#l20.29"></a><span id="l20.29" class="difflineminus">-}</span>
<a href="#l20.30"></a><span id="l20.30" class="difflineminus">-</span>
<a href="#l20.31"></a><span id="l20.31" class="difflineminus">-dump(&quot;* Adding attendee to event.\n&quot;);</span>
<a href="#l20.32"></a><span id="l20.32" class="difflineminus">-e.addAttendee(a1);</span>
<a href="#l20.33"></a><span id="l20.33" class="difflineminus">-dump(&quot;* Adding 2nd attendee to event.\n&quot;);</span>
<a href="#l20.34"></a><span id="l20.34" class="difflineminus">-var a2 = attendeeClass.createInstance(attendeeIID);</span>
<a href="#l20.35"></a><span id="l20.35" class="difflineminus">-a2.id = &quot;myid2&quot;;</span>
<a href="#l20.36"></a><span id="l20.36" class="difflineminus">-e.addAttendee(a2);</span>
<a href="#l20.37"></a><span id="l20.37" class="difflineminus">-</span>
<a href="#l20.38"></a><span id="l20.38" class="difflineminus">-dump(&quot;* Finding by ID.\n&quot;);</span>
<a href="#l20.39"></a><span id="l20.39" class="difflineminus">-</span>
<a href="#l20.40"></a><span id="l20.40" class="difflineminus">-function findById(id, a) {</span>
<a href="#l20.41"></a><span id="l20.41" class="difflineminus">-    var foundAttendee = e.getAttendeeById(id);</span>
<a href="#l20.42"></a><span id="l20.42" class="difflineminus">-    if (foundAttendee != a) {</span>
<a href="#l20.43"></a><span id="l20.43" class="difflineminus">-	throw &quot;FAILED! wrong attendee returned for + '&quot; +</span>
<a href="#l20.44"></a><span id="l20.44" class="difflineminus">-	    id + &quot;' (got &quot; + foundAttendee + &quot;, expected &quot; + a + &quot;)&quot;;</span>
<a href="#l20.45"></a><span id="l20.45" class="difflineminus">-    }</span>
<a href="#l20.46"></a><span id="l20.46" class="difflineminus">-}    </span>
<a href="#l20.47"></a><span id="l20.47" class="difflineminus">-</span>
<a href="#l20.48"></a><span id="l20.48" class="difflineminus">-findById(&quot;myid&quot;, a1);</span>
<a href="#l20.49"></a><span id="l20.49" class="difflineminus">-findById(&quot;myid2&quot;, a2);</span>
<a href="#l20.50"></a><span id="l20.50" class="difflineminus">-</span>
<a href="#l20.51"></a><span id="l20.51" class="difflineminus">-dump(&quot;* Searching getAttendees results\n&quot;);</span>
<a href="#l20.52"></a><span id="l20.52" class="difflineminus">-var found1, found2;</span>
<a href="#l20.53"></a><span id="l20.53" class="difflineminus">-</span>
<a href="#l20.54"></a><span id="l20.54" class="difflineminus">-function findAttendeesInResults(expectedCount) {</span>
<a href="#l20.55"></a><span id="l20.55" class="difflineminus">-    if (expectedCount == undefined)</span>
<a href="#l20.56"></a><span id="l20.56" class="difflineminus">-	throw &quot;TEST BUG: expectedCount not passed to findAttendeesInResults&quot;;</span>
<a href="#l20.57"></a><span id="l20.57" class="difflineminus">-    var countObj = {};</span>
<a href="#l20.58"></a><span id="l20.58" class="difflineminus">-    dump(&quot;    Getting all attendees.\n&quot;);</span>
<a href="#l20.59"></a><span id="l20.59" class="difflineminus">-    var allAttendees = e.getAttendees(countObj);</span>
<a href="#l20.60"></a><span id="l20.60" class="difflineminus">-    if (countObj.value != allAttendees.length) {</span>
<a href="#l20.61"></a><span id="l20.61" class="difflineminus">-	throw &quot;FAILED! out count (&quot; + countObj.value + &quot;) != .length (&quot; +</span>
<a href="#l20.62"></a><span id="l20.62" class="difflineminus">-	    allAttendees.length + &quot;)&quot;;</span>
<a href="#l20.63"></a><span id="l20.63" class="difflineminus">-    }</span>
<a href="#l20.64"></a><span id="l20.64" class="difflineminus">-    </span>
<a href="#l20.65"></a><span id="l20.65" class="difflineminus">-    if (allAttendees.length != expectedCount) {</span>
<a href="#l20.66"></a><span id="l20.66" class="difflineminus">-	throw &quot;FAILED! expected to get back &quot; + expectedCount +</span>
<a href="#l20.67"></a><span id="l20.67" class="difflineminus">-    &quot; attendees, got &quot; + allAttendees.length;</span>
<a href="#l20.68"></a><span id="l20.68" class="difflineminus">-    }</span>
<a href="#l20.69"></a><span id="l20.69" class="difflineminus">-</span>
<a href="#l20.70"></a><span id="l20.70" class="difflineminus">-    found1 = false, found2 = false;</span>
<a href="#l20.71"></a><span id="l20.71" class="difflineminus">-    for (var i = 0; i &lt; expectedCount; i++) {</span>
<a href="#l20.72"></a><span id="l20.72" class="difflineminus">-	if (allAttendees[i] == a1)</span>
<a href="#l20.73"></a><span id="l20.73" class="difflineminus">-	    found1 = true;</span>
<a href="#l20.74"></a><span id="l20.74" class="difflineminus">-	else if (allAttendees[i] == a2)</span>
<a href="#l20.75"></a><span id="l20.75" class="difflineminus">-	    found2 = true;</span>
<a href="#l20.76"></a><span id="l20.76" class="difflineminus">-	else {</span>
<a href="#l20.77"></a><span id="l20.77" class="difflineminus">-	    throw &quot;FAILED! unknown attendee &quot; + allAttendees[i] + </span>
<a href="#l20.78"></a><span id="l20.78" class="difflineminus">-		&quot; (we added &quot; + a1 + &quot; and &quot; + a2 + + &quot;)&quot;;</span>
<a href="#l20.79"></a><span id="l20.79" class="difflineminus">-	}</span>
<a href="#l20.80"></a><span id="l20.80" class="difflineminus">-    }</span>
<a href="#l20.81"></a><span id="l20.81" class="difflineminus">-}</span>
<a href="#l20.82"></a><span id="l20.82" class="difflineminus">-findAttendeesInResults(2);</span>
<a href="#l20.83"></a><span id="l20.83" class="difflineminus">-if (!found1)</span>
<a href="#l20.84"></a><span id="l20.84" class="difflineminus">-    throw &quot;FAILED! didn't find attendee1 (&quot; + a1 + &quot;) in results&quot;;</span>
<a href="#l20.85"></a><span id="l20.85" class="difflineminus">-if (!found2)</span>
<a href="#l20.86"></a><span id="l20.86" class="difflineminus">-    throw &quot;FAILED! didn't find attendee2 (&quot; + a2 + &quot;) in results&quot;;</span>
<a href="#l20.87"></a><span id="l20.87" class="difflineminus">-</span>
<a href="#l20.88"></a><span id="l20.88" class="difflineminus">-dump(&quot;* Removing attendee.\n&quot;);</span>
<a href="#l20.89"></a><span id="l20.89" class="difflineminus">-e.removeAttendee(a1);</span>
<a href="#l20.90"></a><span id="l20.90" class="difflineminus">-if (e.getAttendeeById(a1.id) != null)</span>
<a href="#l20.91"></a><span id="l20.91" class="difflineminus">-    throw &quot;FAILED! got back removed attendee &quot; + a1 + &quot; by id&quot;;</span>
<a href="#l20.92"></a><span id="l20.92" class="difflineminus">-findById(&quot;myid2&quot;, a2);</span>
<a href="#l20.93"></a><span id="l20.93" class="difflineminus">-found1 = false, found2 = false;</span>
<a href="#l20.94"></a><span id="l20.94" class="difflineminus">-findAttendeesInResults(1);</span>
<a href="#l20.95"></a><span id="l20.95" class="difflineminus">-if (found1)</span>
<a href="#l20.96"></a><span id="l20.96" class="difflineminus">-    throw &quot;FAILED! found removed attendee &quot; + a1 + &quot; in getAttendees results&quot;;</span>
<a href="#l20.97"></a><span id="l20.97" class="difflineminus">-if (!found2) {</span>
<a href="#l20.98"></a><span id="l20.98" class="difflineminus">-    throw &quot;FAILED! didn't find remaining attendee &quot; + a2 +</span>
<a href="#l20.99"></a><span id="l20.99" class="difflineminus">-	&quot; in getAttendees results&quot;;</span>
<a href="#l20.100"></a><span id="l20.100" class="difflineminus">-}</span>
<a href="#l20.101"></a><span id="l20.101" class="difflineminus">-</span>
<a href="#l20.102"></a><span id="l20.102" class="difflineminus">-dump(&quot;* Readding attendee.\n&quot;);</span>
<a href="#l20.103"></a><span id="l20.103" class="difflineminus">-e.addAttendee(a1);</span>
<a href="#l20.104"></a><span id="l20.104" class="difflineminus">-findById(&quot;myid&quot;, a1);</span>
<a href="#l20.105"></a><span id="l20.105" class="difflineminus">-findById(&quot;myid2&quot;, a2);</span>
<a href="#l20.106"></a><span id="l20.106" class="difflineminus">-findAttendeesInResults(2);</span>
<a href="#l20.107"></a><span id="l20.107" class="difflineminus">-if (!found1)</span>
<a href="#l20.108"></a><span id="l20.108" class="difflineminus">-    throw &quot;FAILED! didn't find attendee1 (&quot; + a1 + &quot;) in results&quot;;</span>
<a href="#l20.109"></a><span id="l20.109" class="difflineminus">-if (!found2)</span>
<a href="#l20.110"></a><span id="l20.110" class="difflineminus">-    throw &quot;FAILED! didn't find attendee2 (&quot; + a2 + &quot;) in results&quot;;</span>
<a href="#l20.111"></a><span id="l20.111" class="difflineminus">-</span>
<a href="#l20.112"></a><span id="l20.112" class="difflineminus">-dump(&quot;* Making attendee immutable.\n&quot;);</span>
<a href="#l20.113"></a><span id="l20.113" class="difflineminus">-a1.makeImmutable();</span>
<a href="#l20.114"></a><span id="l20.114" class="difflineminus">-function testImmutability(a) {</span>
<a href="#l20.115"></a><span id="l20.115" class="difflineminus">-    if (a.isMutable) {</span>
<a href="#l20.116"></a><span id="l20.116" class="difflineminus">-	throw &quot;FAILED! Attendee &quot; + a + </span>
<a href="#l20.117"></a><span id="l20.117" class="difflineminus">-	    &quot; should be immutable, but claims otherwise&quot;;</span>
<a href="#l20.118"></a><span id="l20.118" class="difflineminus">-    }</span>
<a href="#l20.119"></a><span id="l20.119" class="difflineminus">-    for (var i = 0; i &lt; properties.length; i++) {</span>
<a href="#l20.120"></a><span id="l20.120" class="difflineminus">-	var old = a[properties[i]];</span>
<a href="#l20.121"></a><span id="l20.121" class="difflineminus">-	var threw;</span>
<a href="#l20.122"></a><span id="l20.122" class="difflineminus">-	try {</span>
<a href="#l20.123"></a><span id="l20.123" class="difflineminus">-	    a[properties[i]] = old + 1;</span>
<a href="#l20.124"></a><span id="l20.124" class="difflineminus">-	    threw = false;</span>
<a href="#l20.125"></a><span id="l20.125" class="difflineminus">-	} catch (e) {</span>
<a href="#l20.126"></a><span id="l20.126" class="difflineminus">-	    threw = true;</span>
<a href="#l20.127"></a><span id="l20.127" class="difflineminus">-	}</span>
<a href="#l20.128"></a><span id="l20.128" class="difflineminus">-	if (!threw) {</span>
<a href="#l20.129"></a><span id="l20.129" class="difflineminus">-	    throw &quot;FAILED! no error thrown setting &quot; + properties[i] +</span>
<a href="#l20.130"></a><span id="l20.130" class="difflineminus">-		&quot;on immutable attendee &quot; + a;</span>
<a href="#l20.131"></a><span id="l20.131" class="difflineminus">-	}</span>
<a href="#l20.132"></a><span id="l20.132" class="difflineminus">-	if (a[properties[i]] != old) {</span>
<a href="#l20.133"></a><span id="l20.133" class="difflineminus">-	    throw &quot;FAILED! setting &quot; + properties[i] + &quot; on &quot; + a +</span>
<a href="#l20.134"></a><span id="l20.134" class="difflineminus">-		&quot; threw, but changed value anyway!&quot;;</span>
<a href="#l20.135"></a><span id="l20.135" class="difflineminus">-	}</span>
<a href="#l20.136"></a><span id="l20.136" class="difflineminus">-    }</span>
<a href="#l20.137"></a><span id="l20.137" class="difflineminus">-}	    </span>
<a href="#l20.138"></a><span id="l20.138" class="difflineminus">-</span>
<a href="#l20.139"></a><span id="l20.139" class="difflineminus">-testImmutability(a1);</span>
<a href="#l20.140"></a><span id="l20.140" class="difflineminus">-dump(&quot;* Testing cascaded immutability (event -&gt; attendee).\n&quot;);</span>
<a href="#l20.141"></a><span id="l20.141" class="difflineminus">-e.makeImmutable();</span>
<a href="#l20.142"></a><span id="l20.142" class="difflineminus">-testImmutability(a2);</span>
<a href="#l20.143"></a><span id="l20.143" class="difflineminus">-</span>
<a href="#l20.144"></a><span id="l20.144" class="difflineminus">-dump(&quot;* Testing cloning\n&quot;);</span>
<a href="#l20.145"></a><span id="l20.145" class="difflineminus">-var ec = e.clone();</span>
<a href="#l20.146"></a><span id="l20.146" class="difflineminus">-var clonedatts = ec.getAttendees({});</span>
<a href="#l20.147"></a><span id="l20.147" class="difflineminus">-var atts = e.getAttendees({});</span>
<a href="#l20.148"></a><span id="l20.148" class="difflineminus">-if (atts.length != clonedatts.length) {</span>
<a href="#l20.149"></a><span id="l20.149" class="difflineminus">-    throw &quot;FAILED! cloned event has &quot; + clonedatts.length +</span>
<a href="#l20.150"></a><span id="l20.150" class="difflineminus">-        &quot;attendees, original had &quot; + atts.length;</span>
<a href="#l20.151"></a><span id="l20.151" class="difflineminus">-}</span>
<a href="#l20.152"></a><span id="l20.152" class="difflineminus">-for (i = 0; i &lt; clonedatts.length; i++) {</span>
<a href="#l20.153"></a><span id="l20.153" class="difflineminus">-    if (atts[i] == clonedatts[i])</span>
<a href="#l20.154"></a><span id="l20.154" class="difflineminus">-        throw &quot;FAILED! attendee &quot; + atts[i].id + &quot; shared with clone!&quot;;</span>
<a href="#l20.155"></a><span id="l20.155" class="difflineminus">-    if (atts[i].id != clonedatts[i].id) {</span>
<a href="#l20.156"></a><span id="l20.156" class="difflineminus">-        throw &quot;FAILED! id mismatch on index &quot; + i + &quot;: &quot; +</span>
<a href="#l20.157"></a><span id="l20.157" class="difflineminus">-            atts[i].id + &quot; != &quot; + clonedatts[i].id;</span>
<a href="#l20.158"></a><span id="l20.158" class="difflineminus">-    }</span>
<a href="#l20.159"></a><span id="l20.159" class="difflineminus">-}</span>
<a href="#l20.160"></a><span id="l20.160" class="difflineminus">-dump(&quot;PASSED!\n&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1">deleted file mode 100644</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineminus">--- a/calendar/test/homegrown/misc/ics-roundtrip.js</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineplus">+++ /dev/null</span>
<a href="#l21.4"></a><span id="l21.4" class="difflineat">@@ -1,41 +0,0 @@</span>
<a href="#l21.5"></a><span id="l21.5" class="difflineminus">-var eventClass = C.classes[&quot;@mozilla.org/calendar/event;1&quot;];</span>
<a href="#l21.6"></a><span id="l21.6" class="difflineminus">-var eventIID = C.interfaces.calIEvent;</span>
<a href="#l21.7"></a><span id="l21.7" class="difflineminus">-</span>
<a href="#l21.8"></a><span id="l21.8" class="difflineminus">-dump(&quot;* Creating event.\n&quot;);</span>
<a href="#l21.9"></a><span id="l21.9" class="difflineminus">-var e = eventClass.createInstance(eventIID);</span>
<a href="#l21.10"></a><span id="l21.10" class="difflineminus">-</span>
<a href="#l21.11"></a><span id="l21.11" class="difflineminus">-var ics_xmas = </span>
<a href="#l21.12"></a><span id="l21.12" class="difflineminus">-'BEGIN:VCALENDAR\nPRODID:-//ORACLE//NONSGML CSDK 9.0.5 - CalDAVServlet 9.0.5//EN\nVERSION:2.0\nBEGIN:VEVENT\nUID:20041119T052239Z-1000472-1-5c0746bb-Oracle\nORGANIZER;X-ORACLE-GUID=E9359406791C763EE0305794071A39A4;CN=Simon Vaillan\n court:mailto:simon.vaillancourt@oracle.com\nSEQUENCE:0\nDTSTAMP:20041124T010028Z\nCREATED:20041119T052239Z\nX-ORACLE-EVENTINSTANCE-GUID:I1+16778354+1+1+438153759\nX-ORACLE-EVENT-GUID:E1+16778354+1+438153759\nX-ORACLE-EVENTTYPE:DAY EVENT\nTRANSP:TRANSPARENT\nSUMMARY:Christmas\nSTATUS:CONFIRMED\nPRIORITY:0\nDTSTART;VALUE=DATE:20041125\nDTEND;VALUE=DATE:20041125\nCLASS:PUBLIC\nATTENDEE;X-ORACLE-GUID=E92F51FB4A48E91CE0305794071A149C;CUTYPE=INDIVIDUAL\n ;RSVP=TRUE;CN=James Stevens;PARTSTAT=NEEDS-ACTION:mailto:james.stevens@o\n racle.com\nATTENDEE;X-ORACLE-GUID=E9359406791C763EE0305794071A39A4;CUTYPE=INDIVIDUAL\n ;RSVP=FALSE;CN=Simon Vaillancourt;PARTSTAT=ACCEPTED:mailto:simon.vaillan\n court@oracle.com\nATTENDEE;X-ORACLE-GUID=E9359406791D763EE0305794071A39A4;CUTYPE=INDIVIDUAL\n ;RSVP=TRUE;CN=Bernard Desruisseaux;PARTSTAT=NEEDS-ACTION:mailto:bernard.\n desruisseaux@oracle.com\nATTENDEE;X-ORACLE-GUID=E9359406791E763EE0305794071A39A4;CUTYPE=INDIVIDUAL\n ;RSVP=TRUE;CN=Mario Bonin;PARTSTAT=NEEDS-ACTION:mailto:mario.bonin@oracl\n e.com\nATTENDEE;X-ORACLE-GUID=E9359406791F763EE0305794071A39A4;CUTYPE=INDIVIDUAL\n ;RSVP=TRUE;CN=Jeremy Chone;PARTSTAT=NEEDS-ACTION:mailto:jeremy.chone@ora\n cle.com\nATTENDEE;X-ORACLE-PERSONAL-COMMENT-ISDIRTY=TRUE;X-ORACLE-GUID=E9359406792\n 0763EE0305794071A39A4;CUTYPE=INDIVIDUAL;RSVP=TRUE;CN=Mike Shaver;PARTSTA\n T=NEEDS-ACTION:mailto:mike.x.shaver@oracle.com\nATTENDEE;X-ORACLE-GUID=E93594067921763EE0305794071A39A4;CUTYPE=INDIVIDUAL\n ;RSVP=TRUE;CN=David Ball;PARTSTAT=NEEDS-ACTION:mailto:david.ball@oracle.\n com\nATTENDEE;X-ORACLE-GUID=E93594067922763EE0305794071A39A4;CUTYPE=INDIVIDUAL\n ;RSVP=TRUE;CN=Marten Haring;PARTSTAT=NEEDS-ACTION:mailto:marten.den.hari\n ng@oracle.com\nATTENDEE;X-ORACLE-GUID=E93594067923763EE0305794071A39A4;CUTYPE=INDIVIDUAL\n ;RSVP=TRUE;CN=Peter Egyed;PARTSTAT=NEEDS-ACTION:mailto:peter.egyed@oracl\n e.com\nATTENDEE;X-ORACLE-GUID=E93594067924763EE0305794071A39A4;CUTYPE=INDIVIDUAL\n ;RSVP=TRUE;CN=Francois Perrault;PARTSTAT=NEEDS-ACTION:mailto:francois.pe\n rrault@oracle.com\nATTENDEE;X-ORACLE-GUID=E93594067925763EE0305794071A39A4;CUTYPE=INDIVIDUAL\n ;RSVP=TRUE;CN=Vladimir Vukicevic;PARTSTAT=NEEDS-ACTION:mailto:vladimir.v\n ukicevic@oracle.com\nATTENDEE;X-ORACLE-GUID=E93594067926763EE0305794071A39A4;CUTYPE=INDIVIDUAL\n ;RSVP=TRUE;CN=Cyrus Daboo;PARTSTAT=NEEDS-ACTION:mailto:daboo@isamet.com\nATTENDEE;X-ORACLE-GUID=E93594067927763EE0305794071A39A4;CUTYPE=INDIVIDUAL\n ;RSVP=TRUE;CN=Lisa Dusseault;PARTSTAT=NEEDS-ACTION:mailto:lisa@osafounda\n tion.org\nATTENDEE;X-ORACLE-GUID=E93594067928763EE0305794071A39A4;CUTYPE=INDIVIDUAL\n ;RSVP=TRUE;CN=Dan Mosedale;PARTSTAT=NEEDS-ACTION:mailto:dan.mosedale@ora\n cle.com\nATTENDEE;X-ORACLE-GUID=E93594067929763EE0305794071A39A4;CUTYPE=INDIVIDUAL\n ;RSVP=TRUE;CN=Stuart Parmenter;PARTSTAT=NEEDS-ACTION:mailto:stuart.parme\n nter@oracle.com\nEND:VEVENT\nEND:VCALENDAR\n\n';</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineminus">-</span>
<a href="#l21.14"></a><span id="l21.14" class="difflineminus">-dump(&quot;* Setting ical string (xmas)\n&quot;);</span>
<a href="#l21.15"></a><span id="l21.15" class="difflineminus">-e.icalString = ics_xmas;</span>
<a href="#l21.16"></a><span id="l21.16" class="difflineminus">-dump(&quot;* Checking basic properties\n&quot;);</span>
<a href="#l21.17"></a><span id="l21.17" class="difflineminus">-var expectedProps =</span>
<a href="#l21.18"></a><span id="l21.18" class="difflineminus">-  [[&quot;title&quot;, &quot;Christmas&quot;],</span>
<a href="#l21.19"></a><span id="l21.19" class="difflineminus">-   [&quot;id&quot;, &quot;20041119T052239Z-1000472-1-5c0746bb-Oracle&quot;],</span>
<a href="#l21.20"></a><span id="l21.20" class="difflineminus">-   [&quot;priority&quot;, 0],</span>
<a href="#l21.21"></a><span id="l21.21" class="difflineminus">-   [&quot;status&quot;, &quot;CONFIRMED&quot;],</span>
<a href="#l21.22"></a><span id="l21.22" class="difflineminus">-   [&quot;generation&quot;, 0],</span>
<a href="#l21.23"></a><span id="l21.23" class="difflineminus">-   [&quot;isAllDay&quot;, true]];</span>
<a href="#l21.24"></a><span id="l21.24" class="difflineminus">-function checkProps(expectedProps, obj) {</span>
<a href="#l21.25"></a><span id="l21.25" class="difflineminus">-  for (var i = 0; i &lt; expectedProps.length; i++) {</span>
<a href="#l21.26"></a><span id="l21.26" class="difflineminus">-    if (obj[expectedProps[i][0]] != expectedProps[i][1]) {</span>
<a href="#l21.27"></a><span id="l21.27" class="difflineminus">-      throw &quot;FAILED! expected &quot; + expectedProps[i][0] + &quot; to be &quot; +</span>
<a href="#l21.28"></a><span id="l21.28" class="difflineminus">-        expectedProps[i][1] + &quot; but got &quot; + obj[expectedProps[i][0]];</span>
<a href="#l21.29"></a><span id="l21.29" class="difflineminus">-    }</span>
<a href="#l21.30"></a><span id="l21.30" class="difflineminus">-  }</span>
<a href="#l21.31"></a><span id="l21.31" class="difflineminus">-}</span>
<a href="#l21.32"></a><span id="l21.32" class="difflineminus">-</span>
<a href="#l21.33"></a><span id="l21.33" class="difflineminus">-checkProps(expectedProps, e);</span>
<a href="#l21.34"></a><span id="l21.34" class="difflineminus">-</span>
<a href="#l21.35"></a><span id="l21.35" class="difflineminus">-dump(&quot;* Checking start date\n&quot;);</span>
<a href="#l21.36"></a><span id="l21.36" class="difflineminus">-expectedProps =</span>
<a href="#l21.37"></a><span id="l21.37" class="difflineminus">-  [[&quot;month&quot;, 10],</span>
<a href="#l21.38"></a><span id="l21.38" class="difflineminus">-   [&quot;day&quot;, 25],</span>
<a href="#l21.39"></a><span id="l21.39" class="difflineminus">-   [&quot;year&quot;, 2004],</span>
<a href="#l21.40"></a><span id="l21.40" class="difflineminus">-   [&quot;isDate&quot;, true]];</span>
<a href="#l21.41"></a><span id="l21.41" class="difflineminus">-checkProps(expectedProps, e.startDate);</span>
<a href="#l21.42"></a><span id="l21.42" class="difflineminus">-dump(&quot;* Checking end date\n&quot;);</span>
<a href="#l21.43"></a><span id="l21.43" class="difflineminus">-checkProps(expectedProps, e.endDate);</span>
<a href="#l21.44"></a><span id="l21.44" class="difflineminus">-</span>
<a href="#l21.45"></a><span id="l21.45" class="difflineminus">-dump(&quot;PASSED!\n&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1">deleted file mode 100644</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineminus">--- a/calendar/test/homegrown/misc/simple-item-mutability.js</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineplus">+++ /dev/null</span>
<a href="#l22.4"></a><span id="l22.4" class="difflineat">@@ -1,35 +0,0 @@</span>
<a href="#l22.5"></a><span id="l22.5" class="difflineminus">-//</span>
<a href="#l22.6"></a><span id="l22.6" class="difflineminus">-// simple test bits</span>
<a href="#l22.7"></a><span id="l22.7" class="difflineminus">-//</span>
<a href="#l22.8"></a><span id="l22.8" class="difflineminus">-</span>
<a href="#l22.9"></a><span id="l22.9" class="difflineminus">-</span>
<a href="#l22.10"></a><span id="l22.10" class="difflineminus">-const eventContractID = &quot;@mozilla.org/calendar/event;1&quot;;</span>
<a href="#l22.11"></a><span id="l22.11" class="difflineminus">-const eventIID = Components.interfaces.calIEvent;</span>
<a href="#l22.12"></a><span id="l22.12" class="difflineminus">-</span>
<a href="#l22.13"></a><span id="l22.13" class="difflineminus">-dump (&quot;Creating mutable event...\n&quot;);</span>
<a href="#l22.14"></a><span id="l22.14" class="difflineminus">-var me = Components.classes[eventContractID].createInstance(eventIID);</span>
<a href="#l22.15"></a><span id="l22.15" class="difflineminus">-</span>
<a href="#l22.16"></a><span id="l22.16" class="difflineminus">-me.title = &quot;Test Title&quot;;</span>
<a href="#l22.17"></a><span id="l22.17" class="difflineminus">-dump (&quot;Title is: &quot; + me.title + &quot; (jsobj: &quot; + me.wrappedJSObject.mTitle + &quot;)\n&quot;);</span>
<a href="#l22.18"></a><span id="l22.18" class="difflineminus">-if (me.title != &quot;Test Title&quot;) {</span>
<a href="#l22.19"></a><span id="l22.19" class="difflineminus">-  throw(&quot;FAILED!  Title on mutable event contained unexpected value.&quot;);</span>
<a href="#l22.20"></a><span id="l22.20" class="difflineminus">-}</span>
<a href="#l22.21"></a><span id="l22.21" class="difflineminus">-</span>
<a href="#l22.22"></a><span id="l22.22" class="difflineminus">-dump (&quot;Setting event-to be non-mutable...\n&quot;);</span>
<a href="#l22.23"></a><span id="l22.23" class="difflineminus">-me.makeImmutable();</span>
<a href="#l22.24"></a><span id="l22.24" class="difflineminus">-</span>
<a href="#l22.25"></a><span id="l22.25" class="difflineminus">-dump (&quot;Trying to set title (should fail)\n&quot;);</span>
<a href="#l22.26"></a><span id="l22.26" class="difflineminus">-try {</span>
<a href="#l22.27"></a><span id="l22.27" class="difflineminus">-  // this should cause an exception</span>
<a href="#l22.28"></a><span id="l22.28" class="difflineminus">-  me.title = &quot;Fail&quot;;</span>
<a href="#l22.29"></a><span id="l22.29" class="difflineminus">-  </span>
<a href="#l22.30"></a><span id="l22.30" class="difflineminus">-  // so we'll only get here if something is wrong, and there's no exception</span>
<a href="#l22.31"></a><span id="l22.31" class="difflineminus">-  dump(&quot;FAILED\n!&quot;);</span>
<a href="#l22.32"></a><span id="l22.32" class="difflineminus">-} catch (ex) {</span>
<a href="#l22.33"></a><span id="l22.33" class="difflineminus">-}</span>
<a href="#l22.34"></a><span id="l22.34" class="difflineminus">-</span>
<a href="#l22.35"></a><span id="l22.35" class="difflineminus">-if (me.title != &quot;Test Title&quot;) {</span>
<a href="#l22.36"></a><span id="l22.36" class="difflineminus">-  throw(&quot;FAILED!  Title on immutable event contained unexpected value: &quot; </span>
<a href="#l22.37"></a><span id="l22.37" class="difflineminus">-	+ me.title);</span>
<a href="#l22.38"></a><span id="l22.38" class="difflineminus">-}</span>
<a href="#l22.39"></a><span id="l22.39" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1">deleted file mode 100644</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineminus">--- a/calendar/test/homegrown/misc/synchronization.js</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineplus">+++ /dev/null</span>
<a href="#l23.4"></a><span id="l23.4" class="difflineat">@@ -1,192 +0,0 @@</span>
<a href="#l23.5"></a><span id="l23.5" class="difflineminus">-/*</span>
<a href="#l23.6"></a><span id="l23.6" class="difflineminus">- * This is the memory hog version. Read all events in memory, then sync</span>
<a href="#l23.7"></a><span id="l23.7" class="difflineminus">- * from there.</span>
<a href="#l23.8"></a><span id="l23.8" class="difflineminus">- * Doing it the right async way gives me too many headaches.</span>
<a href="#l23.9"></a><span id="l23.9" class="difflineminus">- */</span>
<a href="#l23.10"></a><span id="l23.10" class="difflineminus">-</span>
<a href="#l23.11"></a><span id="l23.11" class="difflineminus">-const calICalendar = Components.interfaces.calICalendar;</span>
<a href="#l23.12"></a><span id="l23.12" class="difflineminus">-</span>
<a href="#l23.13"></a><span id="l23.13" class="difflineminus">-var emptyListener =</span>
<a href="#l23.14"></a><span id="l23.14" class="difflineminus">-{</span>
<a href="#l23.15"></a><span id="l23.15" class="difflineminus">-  onOperationComplete: function(aCalendar, aStatus, aOperationType, aId, aDetail) {},</span>
<a href="#l23.16"></a><span id="l23.16" class="difflineminus">-  onGetResult: function(aCalendar, aStatus, aItemType, aDetail, aCount, aItems) {}</span>
<a href="#l23.17"></a><span id="l23.17" class="difflineminus">-};</span>
<a href="#l23.18"></a><span id="l23.18" class="difflineminus">-</span>
<a href="#l23.19"></a><span id="l23.19" class="difflineminus">-var localcal = Components.classes[&quot;@mozilla.org/calendar/calendar;1?type=memory&quot;]</span>
<a href="#l23.20"></a><span id="l23.20" class="difflineminus">-                         .createInstance(Components.interfaces.calICalendar);</span>
<a href="#l23.21"></a><span id="l23.21" class="difflineminus">-var remotecal = Components.classes[&quot;@mozilla.org/calendar/calendar;1?type=memory&quot;]</span>
<a href="#l23.22"></a><span id="l23.22" class="difflineminus">-                          .createInstance(Components.interfaces.calICalendar);</span>
<a href="#l23.23"></a><span id="l23.23" class="difflineminus">-var changecal = Components.classes[&quot;@mozilla.org/calendar/calendar;1?type=memory&quot;]</span>
<a href="#l23.24"></a><span id="l23.24" class="difflineminus">-                          .createInstance(Components.interfaces.calICalendar);</span>
<a href="#l23.25"></a><span id="l23.25" class="difflineminus">-</span>
<a href="#l23.26"></a><span id="l23.26" class="difflineminus">-</span>
<a href="#l23.27"></a><span id="l23.27" class="difflineminus">-// local: B CC</span>
<a href="#l23.28"></a><span id="l23.28" class="difflineminus">-// change: A, B, C</span>
<a href="#l23.29"></a><span id="l23.29" class="difflineminus">-// remote: A, C</span>
<a href="#l23.30"></a><span id="l23.30" class="difflineminus">-// expected: B, CC</span>
<a href="#l23.31"></a><span id="l23.31" class="difflineminus">-createEvent(&quot;i2&quot;, &quot;B&quot;, localcal);</span>
<a href="#l23.32"></a><span id="l23.32" class="difflineminus">-createEvent(&quot;i3&quot;, &quot;CC&quot;, localcal);</span>
<a href="#l23.33"></a><span id="l23.33" class="difflineminus">-createEvent(&quot;i1&quot;, &quot;A&quot;, remotecal);</span>
<a href="#l23.34"></a><span id="l23.34" class="difflineminus">-createEvent(&quot;i3&quot;, &quot;C&quot;, remotecal);</span>
<a href="#l23.35"></a><span id="l23.35" class="difflineminus">-createEvent(&quot;i1&quot;, &quot;A&quot;, changecal);</span>
<a href="#l23.36"></a><span id="l23.36" class="difflineminus">-createEvent(&quot;i2&quot;, &quot;B&quot;, changecal);</span>
<a href="#l23.37"></a><span id="l23.37" class="difflineminus">-createEvent(&quot;i3&quot;, &quot;C&quot;, changecal);</span>
<a href="#l23.38"></a><span id="l23.38" class="difflineminus">-</span>
<a href="#l23.39"></a><span id="l23.39" class="difflineminus">-dump(&quot;Before\n&quot;);</span>
<a href="#l23.40"></a><span id="l23.40" class="difflineminus">-dumpCals();</span>
<a href="#l23.41"></a><span id="l23.41" class="difflineminus">-</span>
<a href="#l23.42"></a><span id="l23.42" class="difflineminus">-// Start by getting all the items into an array</span>
<a href="#l23.43"></a><span id="l23.43" class="difflineminus">-var localItems = [];</span>
<a href="#l23.44"></a><span id="l23.44" class="difflineminus">-var remoteItems = [];</span>
<a href="#l23.45"></a><span id="l23.45" class="difflineminus">-var changeItems = [];</span>
<a href="#l23.46"></a><span id="l23.46" class="difflineminus">-</span>
<a href="#l23.47"></a><span id="l23.47" class="difflineminus">-// This will get the items from the calendars into the global arrays,</span>
<a href="#l23.48"></a><span id="l23.48" class="difflineminus">-// then call doSync()</span>
<a href="#l23.49"></a><span id="l23.49" class="difflineminus">-getCalendarItems();</span>
<a href="#l23.50"></a><span id="l23.50" class="difflineminus">-</span>
<a href="#l23.51"></a><span id="l23.51" class="difflineminus">-function doSync()</span>
<a href="#l23.52"></a><span id="l23.52" class="difflineminus">-{</span>
<a href="#l23.53"></a><span id="l23.53" class="difflineminus">-  /*</span>
<a href="#l23.54"></a><span id="l23.54" class="difflineminus">-   * forall changeEvents</span>
<a href="#l23.55"></a><span id="l23.55" class="difflineminus">-   *   if (!remoteEvent)</span>
<a href="#l23.56"></a><span id="l23.56" class="difflineminus">-   *     remoteCalendar.add(localEvent);</span>
<a href="#l23.57"></a><span id="l23.57" class="difflineminus">-   *   else if (remoteEvent != changedEvent)</span>
<a href="#l23.58"></a><span id="l23.58" class="difflineminus">-   *     conflict();</span>
<a href="#l23.59"></a><span id="l23.59" class="difflineminus">-   *   else if (!localEvent)</span>
<a href="#l23.60"></a><span id="l23.60" class="difflineminus">-   *     remoteCalendar.deleteEvent(changedEvent.id)</span>
<a href="#l23.61"></a><span id="l23.61" class="difflineminus">-   */</span>
<a href="#l23.62"></a><span id="l23.62" class="difflineminus">-</span>
<a href="#l23.63"></a><span id="l23.63" class="difflineminus">-  for (id in changeItems) {</span>
<a href="#l23.64"></a><span id="l23.64" class="difflineminus">-    if (!remoteItems[id])</span>
<a href="#l23.65"></a><span id="l23.65" class="difflineminus">-      remotecal.addItem(localItems[id].clone(), emptyListener);</span>
<a href="#l23.66"></a><span id="l23.66" class="difflineminus">-    else if (!itemsAreEqual(remoteItems[id], changeItems[id]))</span>
<a href="#l23.67"></a><span id="l23.67" class="difflineminus">-      dump(&quot;Conflict! wheep! &quot;+remoteItems[id].title+&quot; != &quot;+changeItems[id].title+&quot;\n&quot;);</span>
<a href="#l23.68"></a><span id="l23.68" class="difflineminus">-    else if (!localItems[id]) {</span>
<a href="#l23.69"></a><span id="l23.69" class="difflineminus">-      remotecal.deleteItem(remoteItems[id], emptyListener);</span>
<a href="#l23.70"></a><span id="l23.70" class="difflineminus">-      delete remoteItems[id];</span>
<a href="#l23.71"></a><span id="l23.71" class="difflineminus">-    }</span>
<a href="#l23.72"></a><span id="l23.72" class="difflineminus">-  }</span>
<a href="#l23.73"></a><span id="l23.73" class="difflineminus">-</span>
<a href="#l23.74"></a><span id="l23.74" class="difflineminus">-  //dump(&quot;Halfway\n&quot;);</span>
<a href="#l23.75"></a><span id="l23.75" class="difflineminus">-  //dumpCals();</span>
<a href="#l23.76"></a><span id="l23.76" class="difflineminus">-</span>
<a href="#l23.77"></a><span id="l23.77" class="difflineminus">-  // now for part two: remote to local</span>
<a href="#l23.78"></a><span id="l23.78" class="difflineminus">-</span>
<a href="#l23.79"></a><span id="l23.79" class="difflineminus">-  /*</span>
<a href="#l23.80"></a><span id="l23.80" class="difflineminus">-   * forall remoteEvents</span>
<a href="#l23.81"></a><span id="l23.81" class="difflineminus">-   *   if (!localEvent)</span>
<a href="#l23.82"></a><span id="l23.82" class="difflineminus">-   *     localCalendar.add(remoteEvent);</span>
<a href="#l23.83"></a><span id="l23.83" class="difflineminus">-   *   else if (localEvent != remoteEvent)</span>
<a href="#l23.84"></a><span id="l23.84" class="difflineminus">-   *     if (!changeEvent)</span>
<a href="#l23.85"></a><span id="l23.85" class="difflineminus">-   *       localCalendar.modify(localEvent.id, remoteEvent);</span>
<a href="#l23.86"></a><span id="l23.86" class="difflineminus">-   *     else if (changeEvent == remoteEvent)</span>
<a href="#l23.87"></a><span id="l23.87" class="difflineminus">-   *       remoteCalendar.modify(remoteEvent.id, localEvent);</span>
<a href="#l23.88"></a><span id="l23.88" class="difflineminus">-   *     else</span>
<a href="#l23.89"></a><span id="l23.89" class="difflineminus">-   *       conflict();</span>
<a href="#l23.90"></a><span id="l23.90" class="difflineminus">-   */</span>
<a href="#l23.91"></a><span id="l23.91" class="difflineminus">-</span>
<a href="#l23.92"></a><span id="l23.92" class="difflineminus">-  for (id in remoteItems) {</span>
<a href="#l23.93"></a><span id="l23.93" class="difflineminus">-    if (!localItems[id])</span>
<a href="#l23.94"></a><span id="l23.94" class="difflineminus">-      localcal.addItem(remoteItems[i].clone(), emptyListener);</span>
<a href="#l23.95"></a><span id="l23.95" class="difflineminus">-    if (!itemsAreEqual(localItems[id], remoteItems[id])) {</span>
<a href="#l23.96"></a><span id="l23.96" class="difflineminus">-      if (!changeItems[id]) {</span>
<a href="#l23.97"></a><span id="l23.97" class="difflineminus">-        copyItems(remoteItems[id], localItems[id]);</span>
<a href="#l23.98"></a><span id="l23.98" class="difflineminus">-        localcal.modifyItem(localItems[id], emptyListener);</span>
<a href="#l23.99"></a><span id="l23.99" class="difflineminus">-      } else if (itemsAreEqual(remoteItems[id], changeItems[id])) {</span>
<a href="#l23.100"></a><span id="l23.100" class="difflineminus">-        copyItems(localItems[id], remoteItems[id]);</span>
<a href="#l23.101"></a><span id="l23.101" class="difflineminus">-        remotecal.modifyItem(remoteItems[id], emptyListener);</span>
<a href="#l23.102"></a><span id="l23.102" class="difflineminus">-      } else {</span>
<a href="#l23.103"></a><span id="l23.103" class="difflineminus">-        // There is a conflict, but that was already detected before when</span>
<a href="#l23.104"></a><span id="l23.104" class="difflineminus">-        // dealing with locally changed items. No need to do that again.</span>
<a href="#l23.105"></a><span id="l23.105" class="difflineminus">-        //dump(&quot;Conflict\n&quot;);</span>
<a href="#l23.106"></a><span id="l23.106" class="difflineminus">-      }</span>
<a href="#l23.107"></a><span id="l23.107" class="difflineminus">-</span>
<a href="#l23.108"></a><span id="l23.108" class="difflineminus">-    }</span>
<a href="#l23.109"></a><span id="l23.109" class="difflineminus">-  }</span>
<a href="#l23.110"></a><span id="l23.110" class="difflineminus">-</span>
<a href="#l23.111"></a><span id="l23.111" class="difflineminus">-  dump(&quot;After\n&quot;);</span>
<a href="#l23.112"></a><span id="l23.112" class="difflineminus">-  dumpCals();</span>
<a href="#l23.113"></a><span id="l23.113" class="difflineminus">-}</span>
<a href="#l23.114"></a><span id="l23.114" class="difflineminus">-</span>
<a href="#l23.115"></a><span id="l23.115" class="difflineminus">-</span>
<a href="#l23.116"></a><span id="l23.116" class="difflineminus">-function itemsAreEqual(itemA, itemB)</span>
<a href="#l23.117"></a><span id="l23.117" class="difflineminus">-{</span>
<a href="#l23.118"></a><span id="l23.118" class="difflineminus">-  return (itemA.id == itemB.id &amp;&amp; itemA.title == itemB.title)</span>
<a href="#l23.119"></a><span id="l23.119" class="difflineminus">-}</span>
<a href="#l23.120"></a><span id="l23.120" class="difflineminus">-</span>
<a href="#l23.121"></a><span id="l23.121" class="difflineminus">-function copyItems(aSource, aDest)</span>
<a href="#l23.122"></a><span id="l23.122" class="difflineminus">-{</span>
<a href="#l23.123"></a><span id="l23.123" class="difflineminus">-  aDest.title = aSource.title;</span>
<a href="#l23.124"></a><span id="l23.124" class="difflineminus">-}</span>
<a href="#l23.125"></a><span id="l23.125" class="difflineminus">-</span>
<a href="#l23.126"></a><span id="l23.126" class="difflineminus">-function createEvent(aID, aTitle, aCal)</span>
<a href="#l23.127"></a><span id="l23.127" class="difflineminus">-{</span>
<a href="#l23.128"></a><span id="l23.128" class="difflineminus">-  var event = Components.classes[&quot;@mozilla.org/calendar/event;1&quot;]</span>
<a href="#l23.129"></a><span id="l23.129" class="difflineminus">-                        .createInstance(Components.interfaces.calIEvent);</span>
<a href="#l23.130"></a><span id="l23.130" class="difflineminus">-  event.title = aTitle;</span>
<a href="#l23.131"></a><span id="l23.131" class="difflineminus">-  event.id = aID;</span>
<a href="#l23.132"></a><span id="l23.132" class="difflineminus">-  aCal.addItem(event, emptyListener);</span>
<a href="#l23.133"></a><span id="l23.133" class="difflineminus">-}</span>
<a href="#l23.134"></a><span id="l23.134" class="difflineminus">-</span>
<a href="#l23.135"></a><span id="l23.135" class="difflineminus">-function getCalendarItems()</span>
<a href="#l23.136"></a><span id="l23.136" class="difflineminus">-{</span>
<a href="#l23.137"></a><span id="l23.137" class="difflineminus">-  var calendarsFinished = 0;</span>
<a href="#l23.138"></a><span id="l23.138" class="difflineminus">-</span>
<a href="#l23.139"></a><span id="l23.139" class="difflineminus">-  var getListener =</span>
<a href="#l23.140"></a><span id="l23.140" class="difflineminus">-  {</span>
<a href="#l23.141"></a><span id="l23.141" class="difflineminus">-    onOperationComplete: function(aCalendar, aStatus, aOperationType, aId, aDetail)</span>
<a href="#l23.142"></a><span id="l23.142" class="difflineminus">-    {</span>
<a href="#l23.143"></a><span id="l23.143" class="difflineminus">-      calendarsFinished++;</span>
<a href="#l23.144"></a><span id="l23.144" class="difflineminus">-      if (calendarsFinished == 3) {</span>
<a href="#l23.145"></a><span id="l23.145" class="difflineminus">-        doSync();</span>
<a href="#l23.146"></a><span id="l23.146" class="difflineminus">-      }</span>
<a href="#l23.147"></a><span id="l23.147" class="difflineminus">-    },</span>
<a href="#l23.148"></a><span id="l23.148" class="difflineminus">-    onGetResult: function(aCalendar, aStatus, aItemType, aDetail, aCount, aItems)</span>
<a href="#l23.149"></a><span id="l23.149" class="difflineminus">-    {</span>
<a href="#l23.150"></a><span id="l23.150" class="difflineminus">-      if (aCount) {</span>
<a href="#l23.151"></a><span id="l23.151" class="difflineminus">-        var ar;</span>
<a href="#l23.152"></a><span id="l23.152" class="difflineminus">-        if (aCalendar == localcal)</span>
<a href="#l23.153"></a><span id="l23.153" class="difflineminus">-          items = localItems;</span>
<a href="#l23.154"></a><span id="l23.154" class="difflineminus">-        else if (aCalendar == remotecal)</span>
<a href="#l23.155"></a><span id="l23.155" class="difflineminus">-          items = remoteItems;</span>
<a href="#l23.156"></a><span id="l23.156" class="difflineminus">-        else if (aCalendar == changecal)</span>
<a href="#l23.157"></a><span id="l23.157" class="difflineminus">-          items = changeItems;</span>
<a href="#l23.158"></a><span id="l23.158" class="difflineminus">-</span>
<a href="#l23.159"></a><span id="l23.159" class="difflineminus">-        for (var i=0; i&lt;aCount; ++i) {</span>
<a href="#l23.160"></a><span id="l23.160" class="difflineminus">-          items[aItems[i].id] = aItems[i];</span>
<a href="#l23.161"></a><span id="l23.161" class="difflineminus">-        }  </span>
<a href="#l23.162"></a><span id="l23.162" class="difflineminus">-      }</span>
<a href="#l23.163"></a><span id="l23.163" class="difflineminus">-    }</span>
<a href="#l23.164"></a><span id="l23.164" class="difflineminus">-  };</span>
<a href="#l23.165"></a><span id="l23.165" class="difflineminus">-</span>
<a href="#l23.166"></a><span id="l23.166" class="difflineminus">-  localcal.getItems(calICalendar.ITEM_FILTER_TYPE_ALL | calICalendar.ITEM_FILTER_COMPLETED_ALL,</span>
<a href="#l23.167"></a><span id="l23.167" class="difflineminus">-                    0, null, null, getListener);</span>
<a href="#l23.168"></a><span id="l23.168" class="difflineminus">-  remotecal.getItems(calICalendar.ITEM_FILTER_TYPE_ALL | calICalendar.ITEM_FILTER_COMPLETED_ALL,</span>
<a href="#l23.169"></a><span id="l23.169" class="difflineminus">-                    0, null, null, getListener);</span>
<a href="#l23.170"></a><span id="l23.170" class="difflineminus">-  changecal.getItems(calICalendar.ITEM_FILTER_TYPE_ALL | calICalendar.ITEM_FILTER_COMPLETED_ALL,</span>
<a href="#l23.171"></a><span id="l23.171" class="difflineminus">-                    0, null, null, getListener);</span>
<a href="#l23.172"></a><span id="l23.172" class="difflineminus">-}</span>
<a href="#l23.173"></a><span id="l23.173" class="difflineminus">-</span>
<a href="#l23.174"></a><span id="l23.174" class="difflineminus">-</span>
<a href="#l23.175"></a><span id="l23.175" class="difflineminus">-function dumpCals()</span>
<a href="#l23.176"></a><span id="l23.176" class="difflineminus">-{</span>
<a href="#l23.177"></a><span id="l23.177" class="difflineminus">-  var dumpListener =</span>
<a href="#l23.178"></a><span id="l23.178" class="difflineminus">-  {</span>
<a href="#l23.179"></a><span id="l23.179" class="difflineminus">-    onOperationComplete: function(aCalendar, aStatus, aOperationType, aId, aDetail) {},</span>
<a href="#l23.180"></a><span id="l23.180" class="difflineminus">-    onGetResult: function(aCalendar, aStatus, aItemType, aDetail, aCount, aItems)</span>
<a href="#l23.181"></a><span id="l23.181" class="difflineminus">-    {</span>
<a href="#l23.182"></a><span id="l23.182" class="difflineminus">-      for (var i=0; i&lt;aCount; ++i) {</span>
<a href="#l23.183"></a><span id="l23.183" class="difflineminus">-        dump(&quot;  &quot;+i+&quot; &quot;+aItems[i].id+&quot; &quot;+aItems[i].title+&quot;\n&quot;);</span>
<a href="#l23.184"></a><span id="l23.184" class="difflineminus">-      }</span>
<a href="#l23.185"></a><span id="l23.185" class="difflineminus">-    }</span>
<a href="#l23.186"></a><span id="l23.186" class="difflineminus">-  };</span>
<a href="#l23.187"></a><span id="l23.187" class="difflineminus">-</span>
<a href="#l23.188"></a><span id="l23.188" class="difflineminus">-  dump(&quot; Local: \n&quot;);</span>
<a href="#l23.189"></a><span id="l23.189" class="difflineminus">-  localcal.getItems(calICalendar.ITEM_FILTER_TYPE_ALL | calICalendar.ITEM_FILTER_COMPLETED_ALL,</span>
<a href="#l23.190"></a><span id="l23.190" class="difflineminus">-                     0, null, null, dumpListener);</span>
<a href="#l23.191"></a><span id="l23.191" class="difflineminus">-  dump(&quot;\n Remote: \n&quot;);</span>
<a href="#l23.192"></a><span id="l23.192" class="difflineminus">-  remotecal.getItems(calICalendar.ITEM_FILTER_TYPE_ALL | calICalendar.ITEM_FILTER_COMPLETED_ALL,</span>
<a href="#l23.193"></a><span id="l23.193" class="difflineminus">-                     0, null, null, dumpListener);</span>
<a href="#l23.194"></a><span id="l23.194" class="difflineminus">-  dump(&quot;\n&quot;);</span>
<a href="#l23.195"></a><span id="l23.195" class="difflineminus">-}</span>
<a href="#l23.196"></a><span id="l23.196" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1">deleted file mode 100644</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineminus">--- a/calendar/test/homegrown/shell.js</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineplus">+++ /dev/null</span>
<a href="#l24.4"></a><span id="l24.4" class="difflineat">@@ -1,239 +0,0 @@</span>
<a href="#l24.5"></a><span id="l24.5" class="difflineminus">-/* -*- Mode: javascript; tab-width: 20; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l24.6"></a><span id="l24.6" class="difflineminus">-/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l24.7"></a><span id="l24.7" class="difflineminus">- * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l24.8"></a><span id="l24.8" class="difflineminus">- *</span>
<a href="#l24.9"></a><span id="l24.9" class="difflineminus">- * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l24.10"></a><span id="l24.10" class="difflineminus">- * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l24.11"></a><span id="l24.11" class="difflineminus">- * the License. You may obtain a copy of the License at</span>
<a href="#l24.12"></a><span id="l24.12" class="difflineminus">- * http://www.mozilla.org/MPL/</span>
<a href="#l24.13"></a><span id="l24.13" class="difflineminus">- *</span>
<a href="#l24.14"></a><span id="l24.14" class="difflineminus">- * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l24.15"></a><span id="l24.15" class="difflineminus">- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l24.16"></a><span id="l24.16" class="difflineminus">- * for the specific language governing rights and limitations under the</span>
<a href="#l24.17"></a><span id="l24.17" class="difflineminus">- * License.</span>
<a href="#l24.18"></a><span id="l24.18" class="difflineminus">- *</span>
<a href="#l24.19"></a><span id="l24.19" class="difflineminus">- * The Original Code is mozilla.org calendar code.</span>
<a href="#l24.20"></a><span id="l24.20" class="difflineminus">- *</span>
<a href="#l24.21"></a><span id="l24.21" class="difflineminus">- * The Initial Developer of the Original Code is Oracle Corporation</span>
<a href="#l24.22"></a><span id="l24.22" class="difflineminus">- * Portions created by the Initial Developer are Copyright (C) 2004</span>
<a href="#l24.23"></a><span id="l24.23" class="difflineminus">- * the Initial Developer. All Rights Reserved.</span>
<a href="#l24.24"></a><span id="l24.24" class="difflineminus">- *</span>
<a href="#l24.25"></a><span id="l24.25" class="difflineminus">- * Contributor(s): Dan Mosedale &lt;dan.mosedale@oracle.com&gt;</span>
<a href="#l24.26"></a><span id="l24.26" class="difflineminus">- *                 Mike Shaver &lt;mike.x.shaver@oracle.com&gt;</span>
<a href="#l24.27"></a><span id="l24.27" class="difflineminus">- *</span>
<a href="#l24.28"></a><span id="l24.28" class="difflineminus">- * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l24.29"></a><span id="l24.29" class="difflineminus">- * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l24.30"></a><span id="l24.30" class="difflineminus">- * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l24.31"></a><span id="l24.31" class="difflineminus">- * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l24.32"></a><span id="l24.32" class="difflineminus">- * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l24.33"></a><span id="l24.33" class="difflineminus">- * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l24.34"></a><span id="l24.34" class="difflineminus">- * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l24.35"></a><span id="l24.35" class="difflineminus">- * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l24.36"></a><span id="l24.36" class="difflineminus">- * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l24.37"></a><span id="l24.37" class="difflineminus">- * the provisions above, a recipient may use your version of this file under</span>
<a href="#l24.38"></a><span id="l24.38" class="difflineminus">- * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l24.39"></a><span id="l24.39" class="difflineminus">- *</span>
<a href="#l24.40"></a><span id="l24.40" class="difflineminus">- * ***** END LICENSE BLOCK ***** */</span>
<a href="#l24.41"></a><span id="l24.41" class="difflineminus">-</span>
<a href="#l24.42"></a><span id="l24.42" class="difflineminus">-/*</span>
<a href="#l24.43"></a><span id="l24.43" class="difflineminus">- * This file is intended to allow for an easy synchronous interface to </span>
<a href="#l24.44"></a><span id="l24.44" class="difflineminus">- * the calendar methods, both for writing tests simply, and for typing at</span>
<a href="#l24.45"></a><span id="l24.45" class="difflineminus">- * a shell by hand to experiment with calendar methods.  &quot;make calshell&quot; in</span>
<a href="#l24.46"></a><span id="l24.46" class="difflineminus">- * mozilla/calendar/test (or the equivalent objdir) will start a shell with</span>
<a href="#l24.47"></a><span id="l24.47" class="difflineminus">- * this code pre-loaded.</span>
<a href="#l24.48"></a><span id="l24.48" class="difflineminus">- */</span>
<a href="#l24.49"></a><span id="l24.49" class="difflineminus">- </span>
<a href="#l24.50"></a><span id="l24.50" class="difflineminus">-const C = Components;</span>
<a href="#l24.51"></a><span id="l24.51" class="difflineminus">-const Ci = C.interfaces;</span>
<a href="#l24.52"></a><span id="l24.52" class="difflineminus">-const CC = C.classes;</span>
<a href="#l24.53"></a><span id="l24.53" class="difflineminus">-</span>
<a href="#l24.54"></a><span id="l24.54" class="difflineminus">-const evQSvc = getService(&quot;@mozilla.org/event-queue-service;1&quot;,</span>
<a href="#l24.55"></a><span id="l24.55" class="difflineminus">-                          &quot;nsIEventQueueService&quot;);</span>
<a href="#l24.56"></a><span id="l24.56" class="difflineminus">-const evQ = evQSvc.getSpecialEventQueue(Ci.nsIEventQueueService.CURRENT_THREAD_EVENT_QUEUE);</span>
<a href="#l24.57"></a><span id="l24.57" class="difflineminus">-</span>
<a href="#l24.58"></a><span id="l24.58" class="difflineminus">-// this is necessary so that the event pump isn't used with providers which</span>
<a href="#l24.59"></a><span id="l24.59" class="difflineminus">-// call the listener before returning, since it would run forever in that case.</span>
<a href="#l24.60"></a><span id="l24.60" class="difflineminus">-var done = false;</span>
<a href="#l24.61"></a><span id="l24.61" class="difflineminus">-</span>
<a href="#l24.62"></a><span id="l24.62" class="difflineminus">-function runEventPump()</span>
<a href="#l24.63"></a><span id="l24.63" class="difflineminus">-{</span>
<a href="#l24.64"></a><span id="l24.64" class="difflineminus">-    if (done) { // XXX needed?</span>
<a href="#l24.65"></a><span id="l24.65" class="difflineminus">-        done = false;</span>
<a href="#l24.66"></a><span id="l24.66" class="difflineminus">-        return;</span>
<a href="#l24.67"></a><span id="l24.67" class="difflineminus">-    }</span>
<a href="#l24.68"></a><span id="l24.68" class="difflineminus">-    pumpRunning = true;</span>
<a href="#l24.69"></a><span id="l24.69" class="difflineminus">-    while (pumpRunning) {</span>
<a href="#l24.70"></a><span id="l24.70" class="difflineminus">-        evQ.processPendingEvents();</span>
<a href="#l24.71"></a><span id="l24.71" class="difflineminus">-    }</span>
<a href="#l24.72"></a><span id="l24.72" class="difflineminus">-    done = false; // XXX needed?</span>
<a href="#l24.73"></a><span id="l24.73" class="difflineminus">-    return;</span>
<a href="#l24.74"></a><span id="l24.74" class="difflineminus">-}</span>
<a href="#l24.75"></a><span id="l24.75" class="difflineminus">-</span>
<a href="#l24.76"></a><span id="l24.76" class="difflineminus">-function stopEventPump()</span>
<a href="#l24.77"></a><span id="l24.77" class="difflineminus">-{</span>
<a href="#l24.78"></a><span id="l24.78" class="difflineminus">-    pumpRunning = false;</span>
<a href="#l24.79"></a><span id="l24.79" class="difflineminus">-}</span>
<a href="#l24.80"></a><span id="l24.80" class="difflineminus">-</span>
<a href="#l24.81"></a><span id="l24.81" class="difflineminus">-// I wonder how many copies of this are floating around</span>
<a href="#l24.82"></a><span id="l24.82" class="difflineminus">-function findErr(result)</span>
<a href="#l24.83"></a><span id="l24.83" class="difflineminus">-{</span>
<a href="#l24.84"></a><span id="l24.84" class="difflineminus">-    for (var i in C.results) {</span>
<a href="#l24.85"></a><span id="l24.85" class="difflineminus">-        if (C.results[i] == result) {</span>
<a href="#l24.86"></a><span id="l24.86" class="difflineminus">-            return i;</span>
<a href="#l24.87"></a><span id="l24.87" class="difflineminus">-        }</span>
<a href="#l24.88"></a><span id="l24.88" class="difflineminus">-    }</span>
<a href="#l24.89"></a><span id="l24.89" class="difflineminus">-    dump(&quot;No result code found for &quot; + result + &quot;\n&quot;);</span>
<a href="#l24.90"></a><span id="l24.90" class="difflineminus">-}</span>
<a href="#l24.91"></a><span id="l24.91" class="difflineminus">-// I wonder how many copies of this are floating around</span>
<a href="#l24.92"></a><span id="l24.92" class="difflineminus">-function findIface(iface)</span>
<a href="#l24.93"></a><span id="l24.93" class="difflineminus">-{</span>
<a href="#l24.94"></a><span id="l24.94" class="difflineminus">-    for (var i in Ci) {</span>
<a href="#l24.95"></a><span id="l24.95" class="difflineminus">-        if (iface.equals(Ci[i])) {</span>
<a href="#l24.96"></a><span id="l24.96" class="difflineminus">-            return i;</span>
<a href="#l24.97"></a><span id="l24.97" class="difflineminus">-        }</span>
<a href="#l24.98"></a><span id="l24.98" class="difflineminus">-    }</span>
<a href="#l24.99"></a><span id="l24.99" class="difflineminus">-    dump(&quot;No interface found for &quot; + iface + &quot;\n&quot;);</span>
<a href="#l24.100"></a><span id="l24.100" class="difflineminus">-}</span>
<a href="#l24.101"></a><span id="l24.101" class="difflineminus">-</span>
<a href="#l24.102"></a><span id="l24.102" class="difflineminus">-function findOpName(op)</span>
<a href="#l24.103"></a><span id="l24.103" class="difflineminus">-{</span>
<a href="#l24.104"></a><span id="l24.104" class="difflineminus">-    for (var i in Ci.calIOperationListener) {</span>
<a href="#l24.105"></a><span id="l24.105" class="difflineminus">-        if (op == Ci.calIOperationListener[i]) {</span>
<a href="#l24.106"></a><span id="l24.106" class="difflineminus">-            return i;</span>
<a href="#l24.107"></a><span id="l24.107" class="difflineminus">-        }</span>
<a href="#l24.108"></a><span id="l24.108" class="difflineminus">-    }</span>
<a href="#l24.109"></a><span id="l24.109" class="difflineminus">-    dump(&quot;Operation type &quot; + op + &quot;unknown\n&quot;);</span>
<a href="#l24.110"></a><span id="l24.110" class="difflineminus">-}</span>
<a href="#l24.111"></a><span id="l24.111" class="difflineminus">-</span>
<a href="#l24.112"></a><span id="l24.112" class="difflineminus">-function getService(contract, iface)</span>
<a href="#l24.113"></a><span id="l24.113" class="difflineminus">-{</span>
<a href="#l24.114"></a><span id="l24.114" class="difflineminus">-    return C.classes[contract].getService(Ci[iface]);</span>
<a href="#l24.115"></a><span id="l24.115" class="difflineminus">-}</span>
<a href="#l24.116"></a><span id="l24.116" class="difflineminus">-</span>
<a href="#l24.117"></a><span id="l24.117" class="difflineminus">-function createInstance(contract, iface)</span>
<a href="#l24.118"></a><span id="l24.118" class="difflineminus">-{</span>
<a href="#l24.119"></a><span id="l24.119" class="difflineminus">-    return C.classes[contract].createInstance(Ci[iface]);</span>
<a href="#l24.120"></a><span id="l24.120" class="difflineminus">-}</span>
<a href="#l24.121"></a><span id="l24.121" class="difflineminus">-</span>
<a href="#l24.122"></a><span id="l24.122" class="difflineminus">-function calOpListener() {</span>
<a href="#l24.123"></a><span id="l24.123" class="difflineminus">-}</span>
<a href="#l24.124"></a><span id="l24.124" class="difflineminus">-</span>
<a href="#l24.125"></a><span id="l24.125" class="difflineminus">-calOpListener.prototype = </span>
<a href="#l24.126"></a><span id="l24.126" class="difflineminus">-{</span>
<a href="#l24.127"></a><span id="l24.127" class="difflineminus">-    mItems: [],</span>
<a href="#l24.128"></a><span id="l24.128" class="difflineminus">-    mDetail: null,</span>
<a href="#l24.129"></a><span id="l24.129" class="difflineminus">-    mId: null,</span>
<a href="#l24.130"></a><span id="l24.130" class="difflineminus">-    mStatus: null,</span>
<a href="#l24.131"></a><span id="l24.131" class="difflineminus">-</span>
<a href="#l24.132"></a><span id="l24.132" class="difflineminus">-    onOperationComplete: function(aCalendar, aStatus, aOperationType, aId, </span>
<a href="#l24.133"></a><span id="l24.133" class="difflineminus">-                                  aDetail) {</span>
<a href="#l24.134"></a><span id="l24.134" class="difflineminus">-        stopEventPump();</span>
<a href="#l24.135"></a><span id="l24.135" class="difflineminus">-</span>
<a href="#l24.136"></a><span id="l24.136" class="difflineminus">-        this.mDetail = aDetail;</span>
<a href="#l24.137"></a><span id="l24.137" class="difflineminus">-        this.mStatus = aStatus;</span>
<a href="#l24.138"></a><span id="l24.138" class="difflineminus">-        this.mId = aId;</span>
<a href="#l24.139"></a><span id="l24.139" class="difflineminus">-</span>
<a href="#l24.140"></a><span id="l24.140" class="difflineminus">-        // XXX verify aCalendar == cal</span>
<a href="#l24.141"></a><span id="l24.141" class="difflineminus">-</span>
<a href="#l24.142"></a><span id="l24.142" class="difflineminus">-        done = true;</span>
<a href="#l24.143"></a><span id="l24.143" class="difflineminus">-        return;</span>
<a href="#l24.144"></a><span id="l24.144" class="difflineminus">-    },</span>
<a href="#l24.145"></a><span id="l24.145" class="difflineminus">-</span>
<a href="#l24.146"></a><span id="l24.146" class="difflineminus">-    onGetResult: function(aCalendar, aStatus, aItemType, aDetail, aCount, </span>
<a href="#l24.147"></a><span id="l24.147" class="difflineminus">-                          aItems) {</span>
<a href="#l24.148"></a><span id="l24.148" class="difflineminus">-</span>
<a href="#l24.149"></a><span id="l24.149" class="difflineminus">-        // XXX check success(?); dump un-returned data, </span>
<a href="#l24.150"></a><span id="l24.150" class="difflineminus">-</span>
<a href="#l24.151"></a><span id="l24.151" class="difflineminus">-        this.mItems = aItems;</span>
<a href="#l24.152"></a><span id="l24.152" class="difflineminus">-</span>
<a href="#l24.153"></a><span id="l24.153" class="difflineminus">-        return;</span>
<a href="#l24.154"></a><span id="l24.154" class="difflineminus">-    }</span>
<a href="#l24.155"></a><span id="l24.155" class="difflineminus">-}</span>
<a href="#l24.156"></a><span id="l24.156" class="difflineminus">-</span>
<a href="#l24.157"></a><span id="l24.157" class="difflineminus">-const ioSvc = getService(&quot;@mozilla.org/network/io-service;1&quot;, &quot;nsIIOService&quot;);</span>
<a href="#l24.158"></a><span id="l24.158" class="difflineminus">- </span>
<a href="#l24.159"></a><span id="l24.159" class="difflineminus">-function URLFromSpec(spec)</span>
<a href="#l24.160"></a><span id="l24.160" class="difflineminus">-{</span>
<a href="#l24.161"></a><span id="l24.161" class="difflineminus">-    return ioSvc.newURI(spec, null, null);</span>
<a href="#l24.162"></a><span id="l24.162" class="difflineminus">-}</span>
<a href="#l24.163"></a><span id="l24.163" class="difflineminus">-</span>
<a href="#l24.164"></a><span id="l24.164" class="difflineminus">-/**</span>
<a href="#l24.165"></a><span id="l24.165" class="difflineminus">- * convenience var/method for setting up the global calendarn &quot;cal&quot;</span>
<a href="#l24.166"></a><span id="l24.166" class="difflineminus">- */</span>
<a href="#l24.167"></a><span id="l24.167" class="difflineminus">-var cal;</span>
<a href="#l24.168"></a><span id="l24.168" class="difflineminus">-function createCal(type, uri) {</span>
<a href="#l24.169"></a><span id="l24.169" class="difflineminus">-    cal = createInstance(&quot;@mozilla.org/calendar/calendar;1?type=&quot; + type,</span>
<a href="#l24.170"></a><span id="l24.170" class="difflineminus">-                         Ci.calICalendar);</span>
<a href="#l24.171"></a><span id="l24.171" class="difflineminus">-</span>
<a href="#l24.172"></a><span id="l24.172" class="difflineminus">-    // if a uri has been specified, set it</span>
<a href="#l24.173"></a><span id="l24.173" class="difflineminus">-    if (uri) {</span>
<a href="#l24.174"></a><span id="l24.174" class="difflineminus">-        cal.uri = URLFromSpec(calendarUri);</span>
<a href="#l24.175"></a><span id="l24.175" class="difflineminus">-    }</span>
<a href="#l24.176"></a><span id="l24.176" class="difflineminus">-</span>
<a href="#l24.177"></a><span id="l24.177" class="difflineminus">-    return;</span>
<a href="#l24.178"></a><span id="l24.178" class="difflineminus">-}</span>
<a href="#l24.179"></a><span id="l24.179" class="difflineminus">-</span>
<a href="#l24.180"></a><span id="l24.180" class="difflineminus">-/**</span>
<a href="#l24.181"></a><span id="l24.181" class="difflineminus">- * convenience method to create an item and potentially initialize it from ICS</span>
<a href="#l24.182"></a><span id="l24.182" class="difflineminus">- */</span>
<a href="#l24.183"></a><span id="l24.183" class="difflineminus">-function createItem(icalString) {</span>
<a href="#l24.184"></a><span id="l24.184" class="difflineminus">-</span>
<a href="#l24.185"></a><span id="l24.185" class="difflineminus">-    var item = createInstance(&quot;@mozilla.org/calendar/event;1&quot;, Ci.calIEvent);</span>
<a href="#l24.186"></a><span id="l24.186" class="difflineminus">-    if (icalString) {</span>
<a href="#l24.187"></a><span id="l24.187" class="difflineminus">-        item.icalString = &quot;icalString&quot;;</span>
<a href="#l24.188"></a><span id="l24.188" class="difflineminus">-    }</span>
<a href="#l24.189"></a><span id="l24.189" class="difflineminus">-</span>
<a href="#l24.190"></a><span id="l24.190" class="difflineminus">-    return item;</span>
<a href="#l24.191"></a><span id="l24.191" class="difflineminus">-}</span>
<a href="#l24.192"></a><span id="l24.192" class="difflineminus">-</span>
<a href="#l24.193"></a><span id="l24.193" class="difflineminus">-/**</span>
<a href="#l24.194"></a><span id="l24.194" class="difflineminus">- * convenience wrappers around various calICalendar methods so that shell </span>
<a href="#l24.195"></a><span id="l24.195" class="difflineminus">- * callers don't have to deal with the listener</span>
<a href="#l24.196"></a><span id="l24.196" class="difflineminus">- */</span>
<a href="#l24.197"></a><span id="l24.197" class="difflineminus">-function addItem(item) {</span>
<a href="#l24.198"></a><span id="l24.198" class="difflineminus">-    done = false;</span>
<a href="#l24.199"></a><span id="l24.199" class="difflineminus">-    var listener = new calOpListener();</span>
<a href="#l24.200"></a><span id="l24.200" class="difflineminus">-    cal.addItem(item, listener);</span>
<a href="#l24.201"></a><span id="l24.201" class="difflineminus">-    runEventPump();</span>
<a href="#l24.202"></a><span id="l24.202" class="difflineminus">-</span>
<a href="#l24.203"></a><span id="l24.203" class="difflineminus">-    if (!C.isSuccessCode(listener.mStatus)) {</span>
<a href="#l24.204"></a><span id="l24.204" class="difflineminus">-        throw new Exception(listener.mStatus, listener.mDetail);</span>
<a href="#l24.205"></a><span id="l24.205" class="difflineminus">-    }</span>
<a href="#l24.206"></a><span id="l24.206" class="difflineminus">-    return listener.mDetail.QueryInterface(Ci.calIItemBase);</span>
<a href="#l24.207"></a><span id="l24.207" class="difflineminus">-}</span>
<a href="#l24.208"></a><span id="l24.208" class="difflineminus">-</span>
<a href="#l24.209"></a><span id="l24.209" class="difflineminus">-function getItem(id) {</span>
<a href="#l24.210"></a><span id="l24.210" class="difflineminus">-    done = false;</span>
<a href="#l24.211"></a><span id="l24.211" class="difflineminus">-    var listener = new calOpListener();</span>
<a href="#l24.212"></a><span id="l24.212" class="difflineminus">-    cal.getItem(id, listener);</span>
<a href="#l24.213"></a><span id="l24.213" class="difflineminus">-    runEventPump();</span>
<a href="#l24.214"></a><span id="l24.214" class="difflineminus">-</span>
<a href="#l24.215"></a><span id="l24.215" class="difflineminus">-    if (!C.isSuccessCode(listener.mStatus)) {</span>
<a href="#l24.216"></a><span id="l24.216" class="difflineminus">-        throw new Exception(listener.mStatus, listener.mDetail);</span>
<a href="#l24.217"></a><span id="l24.217" class="difflineminus">-    }</span>
<a href="#l24.218"></a><span id="l24.218" class="difflineminus">-    return listener.mItems[0];</span>
<a href="#l24.219"></a><span id="l24.219" class="difflineminus">-}</span>
<a href="#l24.220"></a><span id="l24.220" class="difflineminus">-</span>
<a href="#l24.221"></a><span id="l24.221" class="difflineminus">-function getItems(filter, count, rangeStart, rangeEnd) {</span>
<a href="#l24.222"></a><span id="l24.222" class="difflineminus">-    done = false;</span>
<a href="#l24.223"></a><span id="l24.223" class="difflineminus">-    var listener = new calOpListener();</span>
<a href="#l24.224"></a><span id="l24.224" class="difflineminus">-    cal.getItems(filter, count, rangeStart, rangeEnd, listener);</span>
<a href="#l24.225"></a><span id="l24.225" class="difflineminus">-    runEventPump();</span>
<a href="#l24.226"></a><span id="l24.226" class="difflineminus">-</span>
<a href="#l24.227"></a><span id="l24.227" class="difflineminus">-    if (!C.isSuccessCode(listener.mStatus)) {</span>
<a href="#l24.228"></a><span id="l24.228" class="difflineminus">-        throw new Exception(listener.mStatus, listener.mDetail);</span>
<a href="#l24.229"></a><span id="l24.229" class="difflineminus">-    }</span>
<a href="#l24.230"></a><span id="l24.230" class="difflineminus">-    return listener.mItems;</span>
<a href="#l24.231"></a><span id="l24.231" class="difflineminus">-}</span>
<a href="#l24.232"></a><span id="l24.232" class="difflineminus">-</span>
<a href="#l24.233"></a><span id="l24.233" class="difflineminus">-function deleteItem(item) {</span>
<a href="#l24.234"></a><span id="l24.234" class="difflineminus">-    done = false;</span>
<a href="#l24.235"></a><span id="l24.235" class="difflineminus">-    var listener = new calOpListener();</span>
<a href="#l24.236"></a><span id="l24.236" class="difflineminus">-    cal.deleteItem(item, listener);</span>
<a href="#l24.237"></a><span id="l24.237" class="difflineminus">-    runEventPump();</span>
<a href="#l24.238"></a><span id="l24.238" class="difflineminus">-</span>
<a href="#l24.239"></a><span id="l24.239" class="difflineminus">-    if (!C.isSuccessCode(listener.mStatus)) {</span>
<a href="#l24.240"></a><span id="l24.240" class="difflineminus">-        throw new Exception(listener.mStatus, listener.mDetail);</span>
<a href="#l24.241"></a><span id="l24.241" class="difflineminus">-    }</span>
<a href="#l24.242"></a><span id="l24.242" class="difflineminus">-    return listener.mId;</span>
<a href="#l24.243"></a><span id="l24.243" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1">deleted file mode 100755</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineminus">--- a/calendar/test/jsDriver.pl</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineplus">+++ /dev/null</span>
<a href="#l25.4"></a><span id="l25.4" class="difflineat">@@ -1,1295 +0,0 @@</span>
<a href="#l25.5"></a><span id="l25.5" class="difflineminus">-#!/usr/bin/perl</span>
<a href="#l25.6"></a><span id="l25.6" class="difflineminus">-#</span>
<a href="#l25.7"></a><span id="l25.7" class="difflineminus">-# ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l25.8"></a><span id="l25.8" class="difflineminus">-# Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l25.9"></a><span id="l25.9" class="difflineminus">-#</span>
<a href="#l25.10"></a><span id="l25.10" class="difflineminus">-# The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l25.11"></a><span id="l25.11" class="difflineminus">-# 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l25.12"></a><span id="l25.12" class="difflineminus">-# the License. You may obtain a copy of the License at</span>
<a href="#l25.13"></a><span id="l25.13" class="difflineminus">-# http://www.mozilla.org/MPL/</span>
<a href="#l25.14"></a><span id="l25.14" class="difflineminus">-#</span>
<a href="#l25.15"></a><span id="l25.15" class="difflineminus">-# Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l25.16"></a><span id="l25.16" class="difflineminus">-# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l25.17"></a><span id="l25.17" class="difflineminus">-# for the specific language governing rights and limitations under the</span>
<a href="#l25.18"></a><span id="l25.18" class="difflineminus">-# License.</span>
<a href="#l25.19"></a><span id="l25.19" class="difflineminus">-#</span>
<a href="#l25.20"></a><span id="l25.20" class="difflineminus">-# The Original Code is JavaScript Core Tests.</span>
<a href="#l25.21"></a><span id="l25.21" class="difflineminus">-#</span>
<a href="#l25.22"></a><span id="l25.22" class="difflineminus">-# The Initial Developer of the Original Code is</span>
<a href="#l25.23"></a><span id="l25.23" class="difflineminus">-# Netscape Communications Corporation.</span>
<a href="#l25.24"></a><span id="l25.24" class="difflineminus">-# Portions created by the Initial Developer are Copyright (C) 1997-1999</span>
<a href="#l25.25"></a><span id="l25.25" class="difflineminus">-# the Initial Developer. All Rights Reserved.</span>
<a href="#l25.26"></a><span id="l25.26" class="difflineminus">-#</span>
<a href="#l25.27"></a><span id="l25.27" class="difflineminus">-# Contributor(s):</span>
<a href="#l25.28"></a><span id="l25.28" class="difflineminus">-#   Robert Ginda &lt;rginda@netscape.com&gt;</span>
<a href="#l25.29"></a><span id="l25.29" class="difflineminus">-#   Second cut at runtests.pl script originally by</span>
<a href="#l25.30"></a><span id="l25.30" class="difflineminus">-#   Christine Begle (cbegle@netscape.com)</span>
<a href="#l25.31"></a><span id="l25.31" class="difflineminus">-#   Branched 11/01/99</span>
<a href="#l25.32"></a><span id="l25.32" class="difflineminus">-#</span>
<a href="#l25.33"></a><span id="l25.33" class="difflineminus">-# Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l25.34"></a><span id="l25.34" class="difflineminus">-# either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l25.35"></a><span id="l25.35" class="difflineminus">-# the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l25.36"></a><span id="l25.36" class="difflineminus">-# in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l25.37"></a><span id="l25.37" class="difflineminus">-# of those above. If you wish to allow use of your version of this file only</span>
<a href="#l25.38"></a><span id="l25.38" class="difflineminus">-# under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l25.39"></a><span id="l25.39" class="difflineminus">-# use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l25.40"></a><span id="l25.40" class="difflineminus">-# decision by deleting the provisions above and replace them with the notice</span>
<a href="#l25.41"></a><span id="l25.41" class="difflineminus">-# and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l25.42"></a><span id="l25.42" class="difflineminus">-# the provisions above, a recipient may use your version of this file under</span>
<a href="#l25.43"></a><span id="l25.43" class="difflineminus">-# the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l25.44"></a><span id="l25.44" class="difflineminus">-#</span>
<a href="#l25.45"></a><span id="l25.45" class="difflineminus">-# ***** END LICENSE BLOCK *****</span>
<a href="#l25.46"></a><span id="l25.46" class="difflineminus">-</span>
<a href="#l25.47"></a><span id="l25.47" class="difflineminus">-use strict;</span>
<a href="#l25.48"></a><span id="l25.48" class="difflineminus">-use Getopt::Mixed &quot;nextOption&quot;;</span>
<a href="#l25.49"></a><span id="l25.49" class="difflineminus">-</span>
<a href="#l25.50"></a><span id="l25.50" class="difflineminus">-my $os_type = &amp;get_os_type;</span>
<a href="#l25.51"></a><span id="l25.51" class="difflineminus">-my $unixish = (($os_type ne &quot;WIN&quot;) &amp;&amp; ($os_type ne &quot;MAC&quot;));</span>
<a href="#l25.52"></a><span id="l25.52" class="difflineminus">-my $path_sep = ($os_type eq &quot;MAC&quot;) ? &quot;:&quot; : &quot;/&quot;;</span>
<a href="#l25.53"></a><span id="l25.53" class="difflineminus">-my $win_sep  = ($os_type eq &quot;WIN&quot;)? &amp;get_win_sep : &quot;&quot;;</span>
<a href="#l25.54"></a><span id="l25.54" class="difflineminus">-my $redirect_command = ($os_type ne &quot;MAC&quot;) ? &quot; 2&gt;&amp;1&quot; : &quot;&quot;;</span>
<a href="#l25.55"></a><span id="l25.55" class="difflineminus">-</span>
<a href="#l25.56"></a><span id="l25.56" class="difflineminus">-# command line option defaults</span>
<a href="#l25.57"></a><span id="l25.57" class="difflineminus">-my $opt_suite_path;</span>
<a href="#l25.58"></a><span id="l25.58" class="difflineminus">-my $opt_trace = 0;</span>
<a href="#l25.59"></a><span id="l25.59" class="difflineminus">-my $opt_classpath = &quot;&quot;;</span>
<a href="#l25.60"></a><span id="l25.60" class="difflineminus">-my $opt_rhino_opt = 0;</span>
<a href="#l25.61"></a><span id="l25.61" class="difflineminus">-my $opt_rhino_ms = 0;</span>
<a href="#l25.62"></a><span id="l25.62" class="difflineminus">-my @opt_engine_list;</span>
<a href="#l25.63"></a><span id="l25.63" class="difflineminus">-my $opt_engine_type = &quot;&quot;;</span>
<a href="#l25.64"></a><span id="l25.64" class="difflineminus">-my $opt_engine_params = &quot;&quot;;</span>
<a href="#l25.65"></a><span id="l25.65" class="difflineminus">-my $opt_user_output_file = 0;</span>
<a href="#l25.66"></a><span id="l25.66" class="difflineminus">-my $opt_output_file = &quot;&quot;;</span>
<a href="#l25.67"></a><span id="l25.67" class="difflineminus">-my @opt_test_list_files;</span>
<a href="#l25.68"></a><span id="l25.68" class="difflineminus">-my @opt_neg_list_files;</span>
<a href="#l25.69"></a><span id="l25.69" class="difflineminus">-my $opt_shell_path = &quot;&quot;;</span>
<a href="#l25.70"></a><span id="l25.70" class="difflineminus">-my $opt_java_path = &quot;&quot;;</span>
<a href="#l25.71"></a><span id="l25.71" class="difflineminus">-my $opt_bug_url = &quot;http://bugzilla.mozilla.org/show_bug.cgi?id=&quot;;</span>
<a href="#l25.72"></a><span id="l25.72" class="difflineminus">-my $opt_console_failures = 0;</span>
<a href="#l25.73"></a><span id="l25.73" class="difflineminus">-my $opt_lxr_url = &quot;http://lxr.mozilla.org/mozilla/source/js/tests/&quot;;</span>
<a href="#l25.74"></a><span id="l25.74" class="difflineminus">-my $opt_exit_munge = ($os_type ne &quot;MAC&quot;) ? 1 : 0;</span>
<a href="#l25.75"></a><span id="l25.75" class="difflineminus">-</span>
<a href="#l25.76"></a><span id="l25.76" class="difflineminus">-# command line option definition</span>
<a href="#l25.77"></a><span id="l25.77" class="difflineminus">-my $options = &quot;b=s bugurl&gt;b c=s classpath&gt;c e=s engine&gt;e f=s file&gt;f &quot; .</span>
<a href="#l25.78"></a><span id="l25.78" class="difflineminus">-  &quot;h help&gt;h i j=s javapath&gt;j k confail&gt;k l=s list&gt;l L=s neglist&gt;L &quot; .</span>
<a href="#l25.79"></a><span id="l25.79" class="difflineminus">-  &quot;o=s opt&gt;o p=s testpath&gt;p s=s shellpath&gt;s t trace&gt;t u=s lxrurl&gt;u &quot; .</span>
<a href="#l25.80"></a><span id="l25.80" class="difflineminus">-  &quot;x noexitmunge&gt;x&quot;;</span>
<a href="#l25.81"></a><span id="l25.81" class="difflineminus">-</span>
<a href="#l25.82"></a><span id="l25.82" class="difflineminus">-if ($os_type eq &quot;MAC&quot;) {</span>
<a href="#l25.83"></a><span id="l25.83" class="difflineminus">-    $opt_suite_path = `directory`;</span>
<a href="#l25.84"></a><span id="l25.84" class="difflineminus">-    $opt_suite_path =~ s/[\n\r]//g;</span>
<a href="#l25.85"></a><span id="l25.85" class="difflineminus">-    $opt_suite_path .= &quot;:&quot;;</span>
<a href="#l25.86"></a><span id="l25.86" class="difflineminus">-} else {</span>
<a href="#l25.87"></a><span id="l25.87" class="difflineminus">-    $opt_suite_path = &quot;./&quot;;</span>
<a href="#l25.88"></a><span id="l25.88" class="difflineminus">-}</span>
<a href="#l25.89"></a><span id="l25.89" class="difflineminus">-</span>
<a href="#l25.90"></a><span id="l25.90" class="difflineminus">-&amp;parse_args;</span>
<a href="#l25.91"></a><span id="l25.91" class="difflineminus">-</span>
<a href="#l25.92"></a><span id="l25.92" class="difflineminus">-my $user_exit = 0;</span>
<a href="#l25.93"></a><span id="l25.93" class="difflineminus">-my ($engine_command, $html, $failures_reported, $tests_completed,</span>
<a href="#l25.94"></a><span id="l25.94" class="difflineminus">-    $exec_time_string); </span>
<a href="#l25.95"></a><span id="l25.95" class="difflineminus">-my @failed_tests;</span>
<a href="#l25.96"></a><span id="l25.96" class="difflineminus">-my @test_list = &amp;get_test_list;</span>
<a href="#l25.97"></a><span id="l25.97" class="difflineminus">-</span>
<a href="#l25.98"></a><span id="l25.98" class="difflineminus">-if ($#test_list == -1) {</span>
<a href="#l25.99"></a><span id="l25.99" class="difflineminus">-    die (&quot;Nothing to test.\n&quot;);</span>
<a href="#l25.100"></a><span id="l25.100" class="difflineminus">-}</span>
<a href="#l25.101"></a><span id="l25.101" class="difflineminus">-</span>
<a href="#l25.102"></a><span id="l25.102" class="difflineminus">-if ($unixish) {</span>
<a href="#l25.103"></a><span id="l25.103" class="difflineminus">-    # on unix, ^C pauses the tests, and gives the user a chance to quit but </span>
<a href="#l25.104"></a><span id="l25.104" class="difflineminus">-    # report on what has been done, to just quit, or to continue (the</span>
<a href="#l25.105"></a><span id="l25.105" class="difflineminus">-    # interrupted test will still be skipped.)</span>
<a href="#l25.106"></a><span id="l25.106" class="difflineminus">-    # windows doesn't handle the int handler they way we want it to,</span>
<a href="#l25.107"></a><span id="l25.107" class="difflineminus">-    # so don't even pretend to let the user continue.</span>
<a href="#l25.108"></a><span id="l25.108" class="difflineminus">-    $SIG{INT} = 'int_handler';</span>
<a href="#l25.109"></a><span id="l25.109" class="difflineminus">-}</span>
<a href="#l25.110"></a><span id="l25.110" class="difflineminus">-</span>
<a href="#l25.111"></a><span id="l25.111" class="difflineminus">-&amp;main;</span>
<a href="#l25.112"></a><span id="l25.112" class="difflineminus">-</span>
<a href="#l25.113"></a><span id="l25.113" class="difflineminus">-#End.</span>
<a href="#l25.114"></a><span id="l25.114" class="difflineminus">-</span>
<a href="#l25.115"></a><span id="l25.115" class="difflineminus">-sub main {</span>
<a href="#l25.116"></a><span id="l25.116" class="difflineminus">-    my $start_time;</span>
<a href="#l25.117"></a><span id="l25.117" class="difflineminus">-</span>
<a href="#l25.118"></a><span id="l25.118" class="difflineminus">-    while ($opt_engine_type = pop (@opt_engine_list)) {</span>
<a href="#l25.119"></a><span id="l25.119" class="difflineminus">-        dd (&quot;Testing engine '$opt_engine_type'&quot;);</span>
<a href="#l25.120"></a><span id="l25.120" class="difflineminus">-</span>
<a href="#l25.121"></a><span id="l25.121" class="difflineminus">-        $engine_command = &amp;get_engine_command;</span>
<a href="#l25.122"></a><span id="l25.122" class="difflineminus">-        $html = &quot;&quot;;</span>
<a href="#l25.123"></a><span id="l25.123" class="difflineminus">-        @failed_tests = ();</span>
<a href="#l25.124"></a><span id="l25.124" class="difflineminus">-        $failures_reported = 0;</span>
<a href="#l25.125"></a><span id="l25.125" class="difflineminus">-        $tests_completed = 0;</span>
<a href="#l25.126"></a><span id="l25.126" class="difflineminus">-        $start_time = time;</span>
<a href="#l25.127"></a><span id="l25.127" class="difflineminus">-</span>
<a href="#l25.128"></a><span id="l25.128" class="difflineminus">-</span>
<a href="#l25.129"></a><span id="l25.129" class="difflineminus">-        &amp;execute_tests (@test_list);</span>
<a href="#l25.130"></a><span id="l25.130" class="difflineminus">-</span>
<a href="#l25.131"></a><span id="l25.131" class="difflineminus">-        my $exec_time = (time - $start_time);</span>
<a href="#l25.132"></a><span id="l25.132" class="difflineminus">-        my $exec_hours = int($exec_time / 60 / 60);</span>
<a href="#l25.133"></a><span id="l25.133" class="difflineminus">-        $exec_time -= $exec_hours * 60 * 60;</span>
<a href="#l25.134"></a><span id="l25.134" class="difflineminus">-        my $exec_mins = int($exec_time / 60);</span>
<a href="#l25.135"></a><span id="l25.135" class="difflineminus">-        $exec_time -= $exec_mins * 60;</span>
<a href="#l25.136"></a><span id="l25.136" class="difflineminus">-        my $exec_secs = ($exec_time % 60);</span>
<a href="#l25.137"></a><span id="l25.137" class="difflineminus">-</span>
<a href="#l25.138"></a><span id="l25.138" class="difflineminus">-        if ($exec_hours &gt; 0) {</span>
<a href="#l25.139"></a><span id="l25.139" class="difflineminus">-            $exec_time_string = &quot;$exec_hours hours, $exec_mins minutes, &quot; .</span>
<a href="#l25.140"></a><span id="l25.140" class="difflineminus">-              &quot;$exec_secs seconds&quot;;</span>
<a href="#l25.141"></a><span id="l25.141" class="difflineminus">-        } elsif ($exec_mins &gt; 0) {</span>
<a href="#l25.142"></a><span id="l25.142" class="difflineminus">-            $exec_time_string = &quot;$exec_mins minutes, $exec_secs seconds&quot;;</span>
<a href="#l25.143"></a><span id="l25.143" class="difflineminus">-        } else {</span>
<a href="#l25.144"></a><span id="l25.144" class="difflineminus">-            $exec_time_string = &quot;$exec_secs seconds&quot;;</span>
<a href="#l25.145"></a><span id="l25.145" class="difflineminus">-        }</span>
<a href="#l25.146"></a><span id="l25.146" class="difflineminus">-</span>
<a href="#l25.147"></a><span id="l25.147" class="difflineminus">-        if (!$opt_user_output_file) {</span>
<a href="#l25.148"></a><span id="l25.148" class="difflineminus">-            $opt_output_file = &amp;get_tempfile_name;</span>
<a href="#l25.149"></a><span id="l25.149" class="difflineminus">-        }</span>
<a href="#l25.150"></a><span id="l25.150" class="difflineminus">-</span>
<a href="#l25.151"></a><span id="l25.151" class="difflineminus">-        &amp;write_results;</span>
<a href="#l25.152"></a><span id="l25.152" class="difflineminus">-</span>
<a href="#l25.153"></a><span id="l25.153" class="difflineminus">-    }</span>
<a href="#l25.154"></a><span id="l25.154" class="difflineminus">-}</span>
<a href="#l25.155"></a><span id="l25.155" class="difflineminus">-</span>
<a href="#l25.156"></a><span id="l25.156" class="difflineminus">-sub execute_tests {</span>
<a href="#l25.157"></a><span id="l25.157" class="difflineminus">-    my (@test_list) = @_;</span>
<a href="#l25.158"></a><span id="l25.158" class="difflineminus">-    my ($test, $shell_command, $line, @output, $path);</span>
<a href="#l25.159"></a><span id="l25.159" class="difflineminus">-    my $file_param = &quot; -f &quot;;</span>
<a href="#l25.160"></a><span id="l25.160" class="difflineminus">-    my ($last_suite, $last_test_dir);</span>
<a href="#l25.161"></a><span id="l25.161" class="difflineminus">-</span>
<a href="#l25.162"></a><span id="l25.162" class="difflineminus">-    &amp;status (&quot;Executing &quot; . ($#test_list + 1) . &quot; test(s).&quot;);</span>
<a href="#l25.163"></a><span id="l25.163" class="difflineminus">-</span>
<a href="#l25.164"></a><span id="l25.164" class="difflineminus">-    foreach $test (@test_list) {</span>
<a href="#l25.165"></a><span id="l25.165" class="difflineminus">-        my ($suite, $test_dir, $test_file) = split($path_sep, $test);</span>
<a href="#l25.166"></a><span id="l25.166" class="difflineminus">-        # *-n.js is a negative test, expect exit code 3 (runtime error)</span>
<a href="#l25.167"></a><span id="l25.167" class="difflineminus">-        my $expected_exit = ($test =~ /\-n\.js$/) ? 3 : 0;</span>
<a href="#l25.168"></a><span id="l25.168" class="difflineminus">-        my ($got_exit, $exit_signal);</span>
<a href="#l25.169"></a><span id="l25.169" class="difflineminus">-        my $failure_lines;</span>
<a href="#l25.170"></a><span id="l25.170" class="difflineminus">-        my $bug_number;</span>
<a href="#l25.171"></a><span id="l25.171" class="difflineminus">-        my $status_lines;</span>
<a href="#l25.172"></a><span id="l25.172" class="difflineminus">-</span>
<a href="#l25.173"></a><span id="l25.173" class="difflineminus">-        # user selected [Q]uit from ^C handler.</span>
<a href="#l25.174"></a><span id="l25.174" class="difflineminus">-        if ($user_exit) {</span>
<a href="#l25.175"></a><span id="l25.175" class="difflineminus">-            return;</span>
<a href="#l25.176"></a><span id="l25.176" class="difflineminus">-        }</span>
<a href="#l25.177"></a><span id="l25.177" class="difflineminus">-</span>
<a href="#l25.178"></a><span id="l25.178" class="difflineminus">-        # Append the shell.js files to the shell_command if they're there.</span>
<a href="#l25.179"></a><span id="l25.179" class="difflineminus">-        # (only check for their existance if the suite or test_dir has changed</span>
<a href="#l25.180"></a><span id="l25.180" class="difflineminus">-        # since the last time we looked.)</span>
<a href="#l25.181"></a><span id="l25.181" class="difflineminus">-        if ($last_suite ne $suite || $last_test_dir ne $test_dir) {</span>
<a href="#l25.182"></a><span id="l25.182" class="difflineminus">-            $shell_command = &amp;xp_path($engine_command);</span>
<a href="#l25.183"></a><span id="l25.183" class="difflineminus">-</span>
<a href="#l25.184"></a><span id="l25.184" class="difflineminus">-            $path = &amp;xp_path($opt_suite_path . $suite . &quot;/shell.js&quot;);</span>
<a href="#l25.185"></a><span id="l25.185" class="difflineminus">-            if (-f $path) {</span>
<a href="#l25.186"></a><span id="l25.186" class="difflineminus">-                $shell_command .= $file_param . $path;</span>
<a href="#l25.187"></a><span id="l25.187" class="difflineminus">-            }</span>
<a href="#l25.188"></a><span id="l25.188" class="difflineminus">-</span>
<a href="#l25.189"></a><span id="l25.189" class="difflineminus">-            $path = &amp;xp_path($opt_suite_path . $suite . &quot;/&quot; .</span>
<a href="#l25.190"></a><span id="l25.190" class="difflineminus">-                             $test_dir . &quot;/shell.js&quot;);</span>
<a href="#l25.191"></a><span id="l25.191" class="difflineminus">-            if (-f $path) {</span>
<a href="#l25.192"></a><span id="l25.192" class="difflineminus">-                $shell_command .= $file_param . $path;</span>
<a href="#l25.193"></a><span id="l25.193" class="difflineminus">-            }</span>
<a href="#l25.194"></a><span id="l25.194" class="difflineminus">-</span>
<a href="#l25.195"></a><span id="l25.195" class="difflineminus">-            $last_suite = $suite;</span>
<a href="#l25.196"></a><span id="l25.196" class="difflineminus">-            $last_test_dir = $test_dir;</span>
<a href="#l25.197"></a><span id="l25.197" class="difflineminus">-        }</span>
<a href="#l25.198"></a><span id="l25.198" class="difflineminus">-         </span>
<a href="#l25.199"></a><span id="l25.199" class="difflineminus">-        $path = &amp;xp_path($opt_suite_path . $test);</span>
<a href="#l25.200"></a><span id="l25.200" class="difflineminus">-        &amp;dd (&quot;executing: &quot; . $shell_command . $file_param . $path);</span>
<a href="#l25.201"></a><span id="l25.201" class="difflineminus">-</span>
<a href="#l25.202"></a><span id="l25.202" class="difflineminus">-        open (OUTPUT, $shell_command . $file_param . $path .</span>
<a href="#l25.203"></a><span id="l25.203" class="difflineminus">-              $redirect_command . &quot; |&quot;);</span>
<a href="#l25.204"></a><span id="l25.204" class="difflineminus">-        @output = &lt;OUTPUT&gt;;</span>
<a href="#l25.205"></a><span id="l25.205" class="difflineminus">-        close (OUTPUT);</span>
<a href="#l25.206"></a><span id="l25.206" class="difflineminus">-</span>
<a href="#l25.207"></a><span id="l25.207" class="difflineminus">-        @output = grep (!/js\&gt;/, @output);</span>
<a href="#l25.208"></a><span id="l25.208" class="difflineminus">-</span>
<a href="#l25.209"></a><span id="l25.209" class="difflineminus">-        if ($opt_exit_munge == 1) {</span>
<a href="#l25.210"></a><span id="l25.210" class="difflineminus">-            # signal information in the lower 8 bits, exit code above that</span>
<a href="#l25.211"></a><span id="l25.211" class="difflineminus">-            $got_exit = ($? &gt;&gt; 8);</span>
<a href="#l25.212"></a><span id="l25.212" class="difflineminus">-            $exit_signal = ($? &amp; 255);</span>
<a href="#l25.213"></a><span id="l25.213" class="difflineminus">-        } else {</span>
<a href="#l25.214"></a><span id="l25.214" class="difflineminus">-            # user says not to munge the exit code</span>
<a href="#l25.215"></a><span id="l25.215" class="difflineminus">-            $got_exit = $?;</span>
<a href="#l25.216"></a><span id="l25.216" class="difflineminus">-            $exit_signal = 0;</span>
<a href="#l25.217"></a><span id="l25.217" class="difflineminus">-        }</span>
<a href="#l25.218"></a><span id="l25.218" class="difflineminus">-</span>
<a href="#l25.219"></a><span id="l25.219" class="difflineminus">-        $failure_lines = &quot;&quot;;</span>
<a href="#l25.220"></a><span id="l25.220" class="difflineminus">-        $bug_number = &quot;&quot;;</span>
<a href="#l25.221"></a><span id="l25.221" class="difflineminus">-        $status_lines = &quot;&quot;;</span>
<a href="#l25.222"></a><span id="l25.222" class="difflineminus">-</span>
<a href="#l25.223"></a><span id="l25.223" class="difflineminus">-        foreach $line (@output) {</span>
<a href="#l25.224"></a><span id="l25.224" class="difflineminus">-</span>
<a href="#l25.225"></a><span id="l25.225" class="difflineminus">-            # watch for testcase to proclaim what exit code it expects to</span>
<a href="#l25.226"></a><span id="l25.226" class="difflineminus">-            # produce (0 by default)</span>
<a href="#l25.227"></a><span id="l25.227" class="difflineminus">-            if ($line =~ /expect(ed)?\s*exit\s*code\s*\:?\s*(\d+)/i) {</span>
<a href="#l25.228"></a><span id="l25.228" class="difflineminus">-                $expected_exit = $2;</span>
<a href="#l25.229"></a><span id="l25.229" class="difflineminus">-                &amp;dd (&quot;Test case expects exit code $expected_exit&quot;);</span>
<a href="#l25.230"></a><span id="l25.230" class="difflineminus">-            }</span>
<a href="#l25.231"></a><span id="l25.231" class="difflineminus">-</span>
<a href="#l25.232"></a><span id="l25.232" class="difflineminus">-            # watch for failures</span>
<a href="#l25.233"></a><span id="l25.233" class="difflineminus">-            if ($line =~ /failed!/i) {</span>
<a href="#l25.234"></a><span id="l25.234" class="difflineminus">-                $failure_lines .= $line;</span>
<a href="#l25.235"></a><span id="l25.235" class="difflineminus">-            }</span>
<a href="#l25.236"></a><span id="l25.236" class="difflineminus">-</span>
<a href="#l25.237"></a><span id="l25.237" class="difflineminus">-            # and watch for bugnumbers</span>
<a href="#l25.238"></a><span id="l25.238" class="difflineminus">-            # XXX This only allows 1 bugnumber per testfile, should be</span>
<a href="#l25.239"></a><span id="l25.239" class="difflineminus">-            # XXX modified to allow for multiple.</span>
<a href="#l25.240"></a><span id="l25.240" class="difflineminus">-            if ($line =~ /bugnumber\s*\:?\s*(.*)/i) {</span>
<a href="#l25.241"></a><span id="l25.241" class="difflineminus">-                $1 =~ /(\n+)/;</span>
<a href="#l25.242"></a><span id="l25.242" class="difflineminus">-                $bug_number = $1;</span>
<a href="#l25.243"></a><span id="l25.243" class="difflineminus">-            }</span>
<a href="#l25.244"></a><span id="l25.244" class="difflineminus">-</span>
<a href="#l25.245"></a><span id="l25.245" class="difflineminus">-            # and watch for status</span>
<a href="#l25.246"></a><span id="l25.246" class="difflineminus">-            if ($line =~ /status/i) {</span>
<a href="#l25.247"></a><span id="l25.247" class="difflineminus">-                $status_lines .= $line;</span>
<a href="#l25.248"></a><span id="l25.248" class="difflineminus">-            }</span>
<a href="#l25.249"></a><span id="l25.249" class="difflineminus">-</span>
<a href="#l25.250"></a><span id="l25.250" class="difflineminus">-        }</span>
<a href="#l25.251"></a><span id="l25.251" class="difflineminus">-</span>
<a href="#l25.252"></a><span id="l25.252" class="difflineminus">-        if (!@output) {</span>
<a href="#l25.253"></a><span id="l25.253" class="difflineminus">-            @output = (&quot;Testcase produced no output!&quot;);</span>
<a href="#l25.254"></a><span id="l25.254" class="difflineminus">-        }</span>
<a href="#l25.255"></a><span id="l25.255" class="difflineminus">-</span>
<a href="#l25.256"></a><span id="l25.256" class="difflineminus">-        if ($got_exit != $expected_exit) {</span>
<a href="#l25.257"></a><span id="l25.257" class="difflineminus">-            # full testcase output dumped on mismatched exit codes,</span>
<a href="#l25.258"></a><span id="l25.258" class="difflineminus">-            &amp;report_failure ($test, &quot;Expected exit code &quot; .</span>
<a href="#l25.259"></a><span id="l25.259" class="difflineminus">-                             &quot;$expected_exit, got $got_exit\n&quot; .</span>
<a href="#l25.260"></a><span id="l25.260" class="difflineminus">-                             &quot;Testcase terminated with signal $exit_signal\n&quot; .</span>
<a href="#l25.261"></a><span id="l25.261" class="difflineminus">-                             &quot;Complete testcase output was:\n&quot; .</span>
<a href="#l25.262"></a><span id="l25.262" class="difflineminus">-                             join (&quot;\n&quot;,@output), $bug_number);</span>
<a href="#l25.263"></a><span id="l25.263" class="difflineminus">-        } elsif ($failure_lines) {</span>
<a href="#l25.264"></a><span id="l25.264" class="difflineminus">-            # only offending lines if exit codes matched</span>
<a href="#l25.265"></a><span id="l25.265" class="difflineminus">-            &amp;report_failure ($test, &quot;$status_lines\n&quot;.</span>
<a href="#l25.266"></a><span id="l25.266" class="difflineminus">-                             &quot;Failure messages were:\n$failure_lines&quot;,</span>
<a href="#l25.267"></a><span id="l25.267" class="difflineminus">-                             $bug_number);</span>
<a href="#l25.268"></a><span id="l25.268" class="difflineminus">-        }</span>
<a href="#l25.269"></a><span id="l25.269" class="difflineminus">-</span>
<a href="#l25.270"></a><span id="l25.270" class="difflineminus">-        &amp;dd (&quot;exit code $got_exit, exit signal $exit_signal.&quot;);</span>
<a href="#l25.271"></a><span id="l25.271" class="difflineminus">-</span>
<a href="#l25.272"></a><span id="l25.272" class="difflineminus">-        $tests_completed++;</span>
<a href="#l25.273"></a><span id="l25.273" class="difflineminus">-    }</span>
<a href="#l25.274"></a><span id="l25.274" class="difflineminus">-}</span>
<a href="#l25.275"></a><span id="l25.275" class="difflineminus">-</span>
<a href="#l25.276"></a><span id="l25.276" class="difflineminus">-sub write_results {</span>
<a href="#l25.277"></a><span id="l25.277" class="difflineminus">-    my ($list_name, $neglist_name);</span>
<a href="#l25.278"></a><span id="l25.278" class="difflineminus">-    my $completion_date = localtime;</span>
<a href="#l25.279"></a><span id="l25.279" class="difflineminus">-    my $failure_pct = int(($failures_reported / $tests_completed) * 10000) /</span>
<a href="#l25.280"></a><span id="l25.280" class="difflineminus">-      100;</span>
<a href="#l25.281"></a><span id="l25.281" class="difflineminus">-    &amp;dd (&quot;Writing output to $opt_output_file.&quot;);</span>
<a href="#l25.282"></a><span id="l25.282" class="difflineminus">-</span>
<a href="#l25.283"></a><span id="l25.283" class="difflineminus">-    if ($#opt_test_list_files == -1) {</span>
<a href="#l25.284"></a><span id="l25.284" class="difflineminus">-        $list_name = &quot;All tests&quot;;</span>
<a href="#l25.285"></a><span id="l25.285" class="difflineminus">-    } elsif ($#opt_test_list_files &lt; 10) {</span>
<a href="#l25.286"></a><span id="l25.286" class="difflineminus">-        $list_name = join (&quot;, &quot;, @opt_test_list_files);</span>
<a href="#l25.287"></a><span id="l25.287" class="difflineminus">-    } else {</span>
<a href="#l25.288"></a><span id="l25.288" class="difflineminus">-        $list_name = &quot;($#opt_test_list_files test files specified)&quot;;</span>
<a href="#l25.289"></a><span id="l25.289" class="difflineminus">-    }</span>
<a href="#l25.290"></a><span id="l25.290" class="difflineminus">-</span>
<a href="#l25.291"></a><span id="l25.291" class="difflineminus">-    if ($#opt_neg_list_files == -1) {</span>
<a href="#l25.292"></a><span id="l25.292" class="difflineminus">-        $neglist_name = &quot;(none)&quot;;</span>
<a href="#l25.293"></a><span id="l25.293" class="difflineminus">-    } elsif ($#opt_test_list_files &lt; 10) {</span>
<a href="#l25.294"></a><span id="l25.294" class="difflineminus">-        $neglist_name = join (&quot;, &quot;, @opt_neg_list_files);</span>
<a href="#l25.295"></a><span id="l25.295" class="difflineminus">-    } else {</span>
<a href="#l25.296"></a><span id="l25.296" class="difflineminus">-        $neglist_name = &quot;($#opt_neg_list_files skip files specified)&quot;;</span>
<a href="#l25.297"></a><span id="l25.297" class="difflineminus">-    }</span>
<a href="#l25.298"></a><span id="l25.298" class="difflineminus">-</span>
<a href="#l25.299"></a><span id="l25.299" class="difflineminus">-    open (OUTPUT, &quot;&gt; $opt_output_file&quot;) ||</span>
<a href="#l25.300"></a><span id="l25.300" class="difflineminus">-      die (&quot;Could not create output file $opt_output_file&quot;);</span>
<a href="#l25.301"></a><span id="l25.301" class="difflineminus">-</span>
<a href="#l25.302"></a><span id="l25.302" class="difflineminus">-    print OUTPUT </span>
<a href="#l25.303"></a><span id="l25.303" class="difflineminus">-      (&quot;&lt;html&gt;&lt;head&gt;\n&quot; .</span>
<a href="#l25.304"></a><span id="l25.304" class="difflineminus">-       &quot;&lt;title&gt;Test results, $opt_engine_type&lt;/title&gt;\n&quot; .</span>
<a href="#l25.305"></a><span id="l25.305" class="difflineminus">-       &quot;&lt;/head&gt;\n&quot; .</span>
<a href="#l25.306"></a><span id="l25.306" class="difflineminus">-       &quot;&lt;body bgcolor='white'&gt;\n&quot; .</span>
<a href="#l25.307"></a><span id="l25.307" class="difflineminus">-       &quot;&lt;a name='tippy_top'&gt;&lt;/a&gt;\n&quot; .</span>
<a href="#l25.308"></a><span id="l25.308" class="difflineminus">-       &quot;&lt;h2&gt;Test results, $opt_engine_type&lt;/h2&gt;&lt;br&gt;\n&quot; .</span>
<a href="#l25.309"></a><span id="l25.309" class="difflineminus">-       &quot;&lt;p class='results_summary'&gt;\n&quot; .</span>
<a href="#l25.310"></a><span id="l25.310" class="difflineminus">-       &quot;Test List: $list_name&lt;br&gt;\n&quot; .</span>
<a href="#l25.311"></a><span id="l25.311" class="difflineminus">-       &quot;Skip List: $neglist_name&lt;br&gt;\n&quot; .</span>
<a href="#l25.312"></a><span id="l25.312" class="difflineminus">-       ($#test_list + 1) . &quot; test(s) selected, $tests_completed test(s) &quot; .</span>
<a href="#l25.313"></a><span id="l25.313" class="difflineminus">-       &quot;completed, $failures_reported failures reported &quot; .</span>
<a href="#l25.314"></a><span id="l25.314" class="difflineminus">-       &quot;($failure_pct% failed)&lt;br&gt;\n&quot; .</span>
<a href="#l25.315"></a><span id="l25.315" class="difflineminus">-       &quot;Engine command line: $engine_command&lt;br&gt;\n&quot; .</span>
<a href="#l25.316"></a><span id="l25.316" class="difflineminus">-       &quot;OS type: $os_type&lt;br&gt;\n&quot;);</span>
<a href="#l25.317"></a><span id="l25.317" class="difflineminus">-</span>
<a href="#l25.318"></a><span id="l25.318" class="difflineminus">-    if ($opt_engine_type =~ /^rhino/) {</span>
<a href="#l25.319"></a><span id="l25.319" class="difflineminus">-        open (JAVAOUTPUT, $opt_java_path . &quot;java -fullversion &quot; .</span>
<a href="#l25.320"></a><span id="l25.320" class="difflineminus">-              $redirect_command . &quot; |&quot;);</span>
<a href="#l25.321"></a><span id="l25.321" class="difflineminus">-        print OUTPUT &lt;JAVAOUTPUT&gt;;</span>
<a href="#l25.322"></a><span id="l25.322" class="difflineminus">-        print OUTPUT &quot;&lt;BR&gt;&quot;;</span>
<a href="#l25.323"></a><span id="l25.323" class="difflineminus">-        close (JAVAOUTPUT);</span>
<a href="#l25.324"></a><span id="l25.324" class="difflineminus">-    }</span>
<a href="#l25.325"></a><span id="l25.325" class="difflineminus">-</span>
<a href="#l25.326"></a><span id="l25.326" class="difflineminus">-    print OUTPUT </span>
<a href="#l25.327"></a><span id="l25.327" class="difflineminus">-      (&quot;Testcase execution time: $exec_time_string.&lt;br&gt;\n&quot; .</span>
<a href="#l25.328"></a><span id="l25.328" class="difflineminus">-       &quot;Tests completed on $completion_date.&lt;br&gt;&lt;br&gt;\n&quot;);</span>
<a href="#l25.329"></a><span id="l25.329" class="difflineminus">-</span>
<a href="#l25.330"></a><span id="l25.330" class="difflineminus">-    if ($failures_reported &gt; 0) {</span>
<a href="#l25.331"></a><span id="l25.331" class="difflineminus">-        print OUTPUT</span>
<a href="#l25.332"></a><span id="l25.332" class="difflineminus">-          (&quot;[ &lt;a href='#fail_detail'&gt;Failure Details&lt;/a&gt; | &quot; .</span>
<a href="#l25.333"></a><span id="l25.333" class="difflineminus">-           &quot;&lt;a href='#retest_list'&gt;Retest List&lt;/a&gt; | &quot; .</span>
<a href="#l25.334"></a><span id="l25.334" class="difflineminus">-           &quot;&lt;a href='menu.html'&gt;Test Selection Page&lt;/a&gt; ]&lt;br&gt;\n&quot; .</span>
<a href="#l25.335"></a><span id="l25.335" class="difflineminus">-           &quot;&lt;hr&gt;\n&quot; .</span>
<a href="#l25.336"></a><span id="l25.336" class="difflineminus">-           &quot;&lt;a name='fail_detail'&gt;&lt;/a&gt;\n&quot; .</span>
<a href="#l25.337"></a><span id="l25.337" class="difflineminus">-           &quot;&lt;h2&gt;Failure Details&lt;/h2&gt;&lt;br&gt;\n&lt;dl&gt;&quot; .</span>
<a href="#l25.338"></a><span id="l25.338" class="difflineminus">-           $html .</span>
<a href="#l25.339"></a><span id="l25.339" class="difflineminus">-           &quot;&lt;/dl&gt;\n[ &lt;a href='#tippy_top'&gt;Top of Page&lt;/a&gt; | &quot; .</span>
<a href="#l25.340"></a><span id="l25.340" class="difflineminus">-           &quot;&lt;a href='#fail_detail'&gt;Top of Failures&lt;/a&gt; ]&lt;br&gt;\n&quot; .</span>
<a href="#l25.341"></a><span id="l25.341" class="difflineminus">-           &quot;&lt;hr&gt;\n&quot; .</span>
<a href="#l25.342"></a><span id="l25.342" class="difflineminus">-           &quot;&lt;a name='retest_list'&gt;&lt;/a&gt;\n&quot; .</span>
<a href="#l25.343"></a><span id="l25.343" class="difflineminus">-           &quot;&lt;h2&gt;Retest List&lt;/h2&gt;&lt;br&gt;\n&quot; .</span>
<a href="#l25.344"></a><span id="l25.344" class="difflineminus">-           &quot;&lt;pre&gt;\n&quot; .</span>
<a href="#l25.345"></a><span id="l25.345" class="difflineminus">-           &quot;# Retest List, $opt_engine_type, &quot; .</span>
<a href="#l25.346"></a><span id="l25.346" class="difflineminus">-           &quot;generated $completion_date.\n&quot; .</span>
<a href="#l25.347"></a><span id="l25.347" class="difflineminus">-           &quot;# Original test base was: $list_name.\n&quot; .</span>
<a href="#l25.348"></a><span id="l25.348" class="difflineminus">-           &quot;# $tests_completed of &quot; . ($#test_list + 1) .</span>
<a href="#l25.349"></a><span id="l25.349" class="difflineminus">-           &quot; test(s) were completed, &quot; .</span>
<a href="#l25.350"></a><span id="l25.350" class="difflineminus">-           &quot;$failures_reported failures reported.\n&quot; .</span>
<a href="#l25.351"></a><span id="l25.351" class="difflineminus">-           join (&quot;\n&quot;, @failed_tests) .</span>
<a href="#l25.352"></a><span id="l25.352" class="difflineminus">-           &quot;&lt;/pre&gt;\n&quot; .</span>
<a href="#l25.353"></a><span id="l25.353" class="difflineminus">-           &quot;[ &lt;a href='#tippy_top'&gt;Top of Page&lt;/a&gt; | &quot; .</span>
<a href="#l25.354"></a><span id="l25.354" class="difflineminus">-           &quot;&lt;a href='#retest_list'&gt;Top of Retest List&lt;/a&gt; ]&lt;br&gt;\n&quot;);</span>
<a href="#l25.355"></a><span id="l25.355" class="difflineminus">-    } else {</span>
<a href="#l25.356"></a><span id="l25.356" class="difflineminus">-        print OUTPUT </span>
<a href="#l25.357"></a><span id="l25.357" class="difflineminus">-          (&quot;&lt;h1&gt;Whoop-de-doo, nothing failed!&lt;/h1&gt;\n&quot;);</span>
<a href="#l25.358"></a><span id="l25.358" class="difflineminus">-    }</span>
<a href="#l25.359"></a><span id="l25.359" class="difflineminus">-</span>
<a href="#l25.360"></a><span id="l25.360" class="difflineminus">-    print OUTPUT &quot;&lt;/body&gt;&quot;;</span>
<a href="#l25.361"></a><span id="l25.361" class="difflineminus">-</span>
<a href="#l25.362"></a><span id="l25.362" class="difflineminus">-    close (OUTPUT);</span>
<a href="#l25.363"></a><span id="l25.363" class="difflineminus">-</span>
<a href="#l25.364"></a><span id="l25.364" class="difflineminus">-    &amp;status (&quot;Wrote results to '$opt_output_file'.&quot;);</span>
<a href="#l25.365"></a><span id="l25.365" class="difflineminus">-</span>
<a href="#l25.366"></a><span id="l25.366" class="difflineminus">-    if ($opt_console_failures) {</span>
<a href="#l25.367"></a><span id="l25.367" class="difflineminus">-        &amp;status (&quot;$failures_reported test(s) failed&quot;);</span>
<a href="#l25.368"></a><span id="l25.368" class="difflineminus">-    }</span>
<a href="#l25.369"></a><span id="l25.369" class="difflineminus">-</span>
<a href="#l25.370"></a><span id="l25.370" class="difflineminus">-}</span>
<a href="#l25.371"></a><span id="l25.371" class="difflineminus">-</span>
<a href="#l25.372"></a><span id="l25.372" class="difflineminus">-sub parse_args {</span>
<a href="#l25.373"></a><span id="l25.373" class="difflineminus">-    my ($option, $value, $lastopt);</span>
<a href="#l25.374"></a><span id="l25.374" class="difflineminus">-</span>
<a href="#l25.375"></a><span id="l25.375" class="difflineminus">-    &amp;dd (&quot;checking command line options.&quot;);</span>
<a href="#l25.376"></a><span id="l25.376" class="difflineminus">-</span>
<a href="#l25.377"></a><span id="l25.377" class="difflineminus">-    Getopt::Mixed::init ($options);</span>
<a href="#l25.378"></a><span id="l25.378" class="difflineminus">-    $Getopt::Mixed::order = $Getopt::Mixed::RETURN_IN_ORDER;</span>
<a href="#l25.379"></a><span id="l25.379" class="difflineminus">-</span>
<a href="#l25.380"></a><span id="l25.380" class="difflineminus">-    while (($option, $value) = nextOption()) {</span>
<a href="#l25.381"></a><span id="l25.381" class="difflineminus">-</span>
<a href="#l25.382"></a><span id="l25.382" class="difflineminus">-        if ($option eq &quot;b&quot;) {</span>
<a href="#l25.383"></a><span id="l25.383" class="difflineminus">-            &amp;dd (&quot;opt: setting bugurl to '$value'.&quot;);</span>
<a href="#l25.384"></a><span id="l25.384" class="difflineminus">-            $opt_bug_url = $value;</span>
<a href="#l25.385"></a><span id="l25.385" class="difflineminus">-</span>
<a href="#l25.386"></a><span id="l25.386" class="difflineminus">-        } elsif ($option eq &quot;c&quot;) {</span>
<a href="#l25.387"></a><span id="l25.387" class="difflineminus">-            &amp;dd (&quot;opt: setting classpath to '$value'.&quot;);</span>
<a href="#l25.388"></a><span id="l25.388" class="difflineminus">-            $opt_classpath = $value;</span>
<a href="#l25.389"></a><span id="l25.389" class="difflineminus">-</span>
<a href="#l25.390"></a><span id="l25.390" class="difflineminus">-        } elsif (($option eq &quot;e&quot;) || (($option eq &quot;&quot;) &amp;&amp; ($lastopt eq &quot;e&quot;))) {</span>
<a href="#l25.391"></a><span id="l25.391" class="difflineminus">-            &amp;dd (&quot;opt: adding engine $value.&quot;);</span>
<a href="#l25.392"></a><span id="l25.392" class="difflineminus">-            push (@opt_engine_list, $value);</span>
<a href="#l25.393"></a><span id="l25.393" class="difflineminus">-</span>
<a href="#l25.394"></a><span id="l25.394" class="difflineminus">-        } elsif ($option eq &quot;f&quot;) {</span>
<a href="#l25.395"></a><span id="l25.395" class="difflineminus">-            if (!$value) {</span>
<a href="#l25.396"></a><span id="l25.396" class="difflineminus">-                die (&quot;Output file cannot be null.\n&quot;);</span>
<a href="#l25.397"></a><span id="l25.397" class="difflineminus">-            }</span>
<a href="#l25.398"></a><span id="l25.398" class="difflineminus">-            &amp;dd (&quot;opt: setting output file to '$value'.&quot;);</span>
<a href="#l25.399"></a><span id="l25.399" class="difflineminus">-            $opt_user_output_file = 1;</span>
<a href="#l25.400"></a><span id="l25.400" class="difflineminus">-            $opt_output_file = $value;</span>
<a href="#l25.401"></a><span id="l25.401" class="difflineminus">-</span>
<a href="#l25.402"></a><span id="l25.402" class="difflineminus">-        } elsif ($option eq &quot;h&quot;) {</span>
<a href="#l25.403"></a><span id="l25.403" class="difflineminus">-            &amp;usage;</span>
<a href="#l25.404"></a><span id="l25.404" class="difflineminus">-</span>
<a href="#l25.405"></a><span id="l25.405" class="difflineminus">-        } elsif ($option eq &quot;j&quot;) {</span>
<a href="#l25.406"></a><span id="l25.406" class="difflineminus">-            if (!($value =~ /[\/\\]$/)) {</span>
<a href="#l25.407"></a><span id="l25.407" class="difflineminus">-                $value .= &quot;/&quot;;</span>
<a href="#l25.408"></a><span id="l25.408" class="difflineminus">-            }</span>
<a href="#l25.409"></a><span id="l25.409" class="difflineminus">-            &amp;dd (&quot;opt: setting java path to '$value'.&quot;);</span>
<a href="#l25.410"></a><span id="l25.410" class="difflineminus">-            $opt_java_path = $value;</span>
<a href="#l25.411"></a><span id="l25.411" class="difflineminus">-</span>
<a href="#l25.412"></a><span id="l25.412" class="difflineminus">-        } elsif ($option eq &quot;k&quot;) {</span>
<a href="#l25.413"></a><span id="l25.413" class="difflineminus">-            &amp;dd (&quot;opt: displaying failures on console.&quot;);</span>
<a href="#l25.414"></a><span id="l25.414" class="difflineminus">-            $opt_console_failures=1;</span>
<a href="#l25.415"></a><span id="l25.415" class="difflineminus">-</span>
<a href="#l25.416"></a><span id="l25.416" class="difflineminus">-        } elsif ($option eq &quot;l&quot; || (($option eq &quot;&quot;) &amp;&amp; ($lastopt eq &quot;l&quot;))) {</span>
<a href="#l25.417"></a><span id="l25.417" class="difflineminus">-            $option = &quot;l&quot;;</span>
<a href="#l25.418"></a><span id="l25.418" class="difflineminus">-            &amp;dd (&quot;opt: adding test list '$value'.&quot;);</span>
<a href="#l25.419"></a><span id="l25.419" class="difflineminus">-            push (@opt_test_list_files, $value);</span>
<a href="#l25.420"></a><span id="l25.420" class="difflineminus">-</span>
<a href="#l25.421"></a><span id="l25.421" class="difflineminus">-        } elsif ($option eq &quot;L&quot; || (($option eq &quot;&quot;) &amp;&amp; ($lastopt eq &quot;L&quot;))) {</span>
<a href="#l25.422"></a><span id="l25.422" class="difflineminus">-            $option = &quot;L&quot;;</span>
<a href="#l25.423"></a><span id="l25.423" class="difflineminus">-            &amp;dd (&quot;opt: adding negative list '$value'.&quot;);</span>
<a href="#l25.424"></a><span id="l25.424" class="difflineminus">-            push (@opt_neg_list_files, $value);</span>
<a href="#l25.425"></a><span id="l25.425" class="difflineminus">-</span>
<a href="#l25.426"></a><span id="l25.426" class="difflineminus">-        } elsif ($option eq &quot;o&quot;) {</span>
<a href="#l25.427"></a><span id="l25.427" class="difflineminus">-            $opt_engine_params = $value;</span>
<a href="#l25.428"></a><span id="l25.428" class="difflineminus">-            &amp;dd (&quot;opt: setting engine params to '$opt_engine_params'.&quot;);</span>
<a href="#l25.429"></a><span id="l25.429" class="difflineminus">-</span>
<a href="#l25.430"></a><span id="l25.430" class="difflineminus">-        } elsif ($option eq &quot;p&quot;) {</span>
<a href="#l25.431"></a><span id="l25.431" class="difflineminus">-            $opt_suite_path = $value;</span>
<a href="#l25.432"></a><span id="l25.432" class="difflineminus">-</span>
<a href="#l25.433"></a><span id="l25.433" class="difflineminus">-            if ($os_type eq &quot;MAC&quot;) {</span>
<a href="#l25.434"></a><span id="l25.434" class="difflineminus">-                if (!($opt_suite_path =~ /\:$/)) {</span>
<a href="#l25.435"></a><span id="l25.435" class="difflineminus">-                    $opt_suite_path .= &quot;:&quot;;</span>
<a href="#l25.436"></a><span id="l25.436" class="difflineminus">-                }</span>
<a href="#l25.437"></a><span id="l25.437" class="difflineminus">-            } else {</span>
<a href="#l25.438"></a><span id="l25.438" class="difflineminus">-                if (!($opt_suite_path =~ /[\/\\]$/)) {</span>
<a href="#l25.439"></a><span id="l25.439" class="difflineminus">-                    $opt_suite_path .= &quot;/&quot;;</span>
<a href="#l25.440"></a><span id="l25.440" class="difflineminus">-                }</span>
<a href="#l25.441"></a><span id="l25.441" class="difflineminus">-            }</span>
<a href="#l25.442"></a><span id="l25.442" class="difflineminus">-</span>
<a href="#l25.443"></a><span id="l25.443" class="difflineminus">-            &amp;dd (&quot;opt: setting suite path to '$opt_suite_path'.&quot;);</span>
<a href="#l25.444"></a><span id="l25.444" class="difflineminus">-</span>
<a href="#l25.445"></a><span id="l25.445" class="difflineminus">-        } elsif ($option eq &quot;s&quot;) {</span>
<a href="#l25.446"></a><span id="l25.446" class="difflineminus">-            $opt_shell_path = $value;</span>
<a href="#l25.447"></a><span id="l25.447" class="difflineminus">-            &amp;dd (&quot;opt: setting shell path to '$opt_shell_path'.&quot;);</span>
<a href="#l25.448"></a><span id="l25.448" class="difflineminus">-</span>
<a href="#l25.449"></a><span id="l25.449" class="difflineminus">-        } elsif ($option eq &quot;t&quot;) {</span>
<a href="#l25.450"></a><span id="l25.450" class="difflineminus">-            &amp;dd (&quot;opt: tracing output.  (console failures at no extra charge.)&quot;);</span>
<a href="#l25.451"></a><span id="l25.451" class="difflineminus">-            $opt_console_failures = 1;</span>
<a href="#l25.452"></a><span id="l25.452" class="difflineminus">-            $opt_trace = 1;</span>
<a href="#l25.453"></a><span id="l25.453" class="difflineminus">-</span>
<a href="#l25.454"></a><span id="l25.454" class="difflineminus">-        } elsif ($option eq &quot;u&quot;) {</span>
<a href="#l25.455"></a><span id="l25.455" class="difflineminus">-            &amp;dd (&quot;opt: setting lxr url to '$value'.&quot;);</span>
<a href="#l25.456"></a><span id="l25.456" class="difflineminus">-            $opt_lxr_url = $value;</span>
<a href="#l25.457"></a><span id="l25.457" class="difflineminus">-</span>
<a href="#l25.458"></a><span id="l25.458" class="difflineminus">-        } elsif ($option eq &quot;x&quot;) {</span>
<a href="#l25.459"></a><span id="l25.459" class="difflineminus">-            &amp;dd (&quot;opt: turning off exit munging.&quot;);</span>
<a href="#l25.460"></a><span id="l25.460" class="difflineminus">-            $opt_exit_munge = 0;</span>
<a href="#l25.461"></a><span id="l25.461" class="difflineminus">-</span>
<a href="#l25.462"></a><span id="l25.462" class="difflineminus">-        } else {</span>
<a href="#l25.463"></a><span id="l25.463" class="difflineminus">-            &amp;usage;</span>
<a href="#l25.464"></a><span id="l25.464" class="difflineminus">-        }</span>
<a href="#l25.465"></a><span id="l25.465" class="difflineminus">-</span>
<a href="#l25.466"></a><span id="l25.466" class="difflineminus">-        $lastopt = $option;</span>
<a href="#l25.467"></a><span id="l25.467" class="difflineminus">-</span>
<a href="#l25.468"></a><span id="l25.468" class="difflineminus">-    }</span>
<a href="#l25.469"></a><span id="l25.469" class="difflineminus">-</span>
<a href="#l25.470"></a><span id="l25.470" class="difflineminus">-    Getopt::Mixed::cleanup();</span>
<a href="#l25.471"></a><span id="l25.471" class="difflineminus">-</span>
<a href="#l25.472"></a><span id="l25.472" class="difflineminus">-    if ($#opt_engine_list == -1) {</span>
<a href="#l25.473"></a><span id="l25.473" class="difflineminus">-        die &quot;You must select a shell to test in.\n&quot;;</span>
<a href="#l25.474"></a><span id="l25.474" class="difflineminus">-    }</span>
<a href="#l25.475"></a><span id="l25.475" class="difflineminus">-</span>
<a href="#l25.476"></a><span id="l25.476" class="difflineminus">-}</span>
<a href="#l25.477"></a><span id="l25.477" class="difflineminus">-</span>
<a href="#l25.478"></a><span id="l25.478" class="difflineminus">-#</span>
<a href="#l25.479"></a><span id="l25.479" class="difflineminus">-# print the arguments that this script expects</span>
<a href="#l25.480"></a><span id="l25.480" class="difflineminus">-#</span>
<a href="#l25.481"></a><span id="l25.481" class="difflineminus">-sub usage {</span>
<a href="#l25.482"></a><span id="l25.482" class="difflineminus">-    print STDERR </span>
<a href="#l25.483"></a><span id="l25.483" class="difflineminus">-      (&quot;\nusage: $0 [&lt;options&gt;] \n&quot; .</span>
<a href="#l25.484"></a><span id="l25.484" class="difflineminus">-       &quot;(-b|--bugurl)             Bugzilla URL.\n&quot; .</span>
<a href="#l25.485"></a><span id="l25.485" class="difflineminus">-       &quot;                          (default is $opt_bug_url)\n&quot; .</span>
<a href="#l25.486"></a><span id="l25.486" class="difflineminus">-       &quot;(-c|--classpath)          Classpath (Rhino only.)\n&quot; .</span>
<a href="#l25.487"></a><span id="l25.487" class="difflineminus">-       &quot;(-e|--engine) &lt;type&gt; ...  Specify the type of engine(s) to test.\n&quot; .</span>
<a href="#l25.488"></a><span id="l25.488" class="difflineminus">-       &quot;                          &lt;type&gt; is one or more of\n&quot; .</span>
<a href="#l25.489"></a><span id="l25.489" class="difflineminus">-       &quot;                          (smopt|smdebug|lcopt|lcdebug|xpcshell|&quot; .</span>
<a href="#l25.490"></a><span id="l25.490" class="difflineminus">-       &quot;rhino|rhinoi|rhinoms|rhinomsi|rhino9|rhinoms9).\n&quot; .</span>
<a href="#l25.491"></a><span id="l25.491" class="difflineminus">-       &quot;(-f|--file) &lt;file&gt;        Redirect output to file named &lt;file&gt;.\n&quot; .</span>
<a href="#l25.492"></a><span id="l25.492" class="difflineminus">-       &quot;                          (default is &quot; .</span>
<a href="#l25.493"></a><span id="l25.493" class="difflineminus">-       &quot;results-&lt;engine-type&gt;-&lt;date-stamp&gt;.html)\n&quot; .</span>
<a href="#l25.494"></a><span id="l25.494" class="difflineminus">-       &quot;(-h|--help)               Print this message.\n&quot; .</span>
<a href="#l25.495"></a><span id="l25.495" class="difflineminus">-       &quot;(-j|--javapath)           Location of java executable.\n&quot; .</span>
<a href="#l25.496"></a><span id="l25.496" class="difflineminus">-       &quot;(-k|--confail)            Log failures to console (also.)\n&quot; . </span>
<a href="#l25.497"></a><span id="l25.497" class="difflineminus">-       &quot;(-l|--list) &lt;file&gt; ...    List of tests to execute.\n&quot; . </span>
<a href="#l25.498"></a><span id="l25.498" class="difflineminus">-       &quot;(-L|--neglist) &lt;file&gt; ... List of tests to skip.\n&quot; . </span>
<a href="#l25.499"></a><span id="l25.499" class="difflineminus">-       &quot;(-o|--opt) &lt;options&gt;      Options to pass to the JavaScript engine.\n&quot; .</span>
<a href="#l25.500"></a><span id="l25.500" class="difflineminus">-       &quot;                          (Make sure to quote them!)\n&quot; .</span>
<a href="#l25.501"></a><span id="l25.501" class="difflineminus">-       &quot;(-p|--testpath) &lt;path&gt;    Root of the test suite. (default is ./)\n&quot; .</span>
<a href="#l25.502"></a><span id="l25.502" class="difflineminus">-       &quot;(-s|--shellpath) &lt;path&gt;   Location of JavaScript shell.\n&quot; .</span>
<a href="#l25.503"></a><span id="l25.503" class="difflineminus">-       &quot;(-t|--trace)              Trace script execution.\n&quot; .</span>
<a href="#l25.504"></a><span id="l25.504" class="difflineminus">-       &quot;(-u|--lxrurl) &lt;url&gt;       Complete URL to tests subdirectory on lxr.\n&quot; .</span>
<a href="#l25.505"></a><span id="l25.505" class="difflineminus">-       &quot;                          (default is $opt_lxr_url)\n&quot; .</span>
<a href="#l25.506"></a><span id="l25.506" class="difflineminus">-       &quot;(-x|--noexitmunge)        Don't do exit code munging (try this if it\n&quot; .</span>
<a href="#l25.507"></a><span id="l25.507" class="difflineminus">-       &quot;                          seems like your exit codes are turning up\n&quot; .</span>
<a href="#l25.508"></a><span id="l25.508" class="difflineminus">-       &quot;                          as exit signals.)\n&quot;);</span>
<a href="#l25.509"></a><span id="l25.509" class="difflineminus">-    exit (1);</span>
<a href="#l25.510"></a><span id="l25.510" class="difflineminus">-</span>
<a href="#l25.511"></a><span id="l25.511" class="difflineminus">-}</span>
<a href="#l25.512"></a><span id="l25.512" class="difflineminus">-</span>
<a href="#l25.513"></a><span id="l25.513" class="difflineminus">-#</span>
<a href="#l25.514"></a><span id="l25.514" class="difflineminus">-# get the shell command used to start the (either) engine</span>
<a href="#l25.515"></a><span id="l25.515" class="difflineminus">-#</span>
<a href="#l25.516"></a><span id="l25.516" class="difflineminus">-sub get_engine_command {</span>
<a href="#l25.517"></a><span id="l25.517" class="difflineminus">-</span>
<a href="#l25.518"></a><span id="l25.518" class="difflineminus">-    my $retval;</span>
<a href="#l25.519"></a><span id="l25.519" class="difflineminus">-</span>
<a href="#l25.520"></a><span id="l25.520" class="difflineminus">-    if ($opt_engine_type eq &quot;rhino&quot;) {</span>
<a href="#l25.521"></a><span id="l25.521" class="difflineminus">-        &amp;dd (&quot;getting rhino engine command.&quot;);</span>
<a href="#l25.522"></a><span id="l25.522" class="difflineminus">-        $opt_rhino_opt = 0;</span>
<a href="#l25.523"></a><span id="l25.523" class="difflineminus">-        $opt_rhino_ms = 0;</span>
<a href="#l25.524"></a><span id="l25.524" class="difflineminus">-        $retval = &amp;get_rhino_engine_command;</span>
<a href="#l25.525"></a><span id="l25.525" class="difflineminus">-    } elsif ($opt_engine_type eq &quot;rhinoi&quot;) {</span>
<a href="#l25.526"></a><span id="l25.526" class="difflineminus">-        &amp;dd (&quot;getting rhinoi engine command.&quot;);</span>
<a href="#l25.527"></a><span id="l25.527" class="difflineminus">-        $opt_rhino_opt = -1;</span>
<a href="#l25.528"></a><span id="l25.528" class="difflineminus">-        $opt_rhino_ms = 0;</span>
<a href="#l25.529"></a><span id="l25.529" class="difflineminus">-        $retval = &amp;get_rhino_engine_command;</span>
<a href="#l25.530"></a><span id="l25.530" class="difflineminus">-    } elsif ($opt_engine_type eq &quot;rhino9&quot;) {</span>
<a href="#l25.531"></a><span id="l25.531" class="difflineminus">-        &amp;dd (&quot;getting rhino engine command.&quot;);</span>
<a href="#l25.532"></a><span id="l25.532" class="difflineminus">-        $opt_rhino_opt = 9;</span>
<a href="#l25.533"></a><span id="l25.533" class="difflineminus">-        $opt_rhino_ms = 0;</span>
<a href="#l25.534"></a><span id="l25.534" class="difflineminus">-        $retval = &amp;get_rhino_engine_command;</span>
<a href="#l25.535"></a><span id="l25.535" class="difflineminus">-    } elsif ($opt_engine_type eq &quot;rhinoms&quot;) {</span>
<a href="#l25.536"></a><span id="l25.536" class="difflineminus">-        &amp;dd (&quot;getting rhinoms engine command.&quot;);</span>
<a href="#l25.537"></a><span id="l25.537" class="difflineminus">-        $opt_rhino_opt = 0;</span>
<a href="#l25.538"></a><span id="l25.538" class="difflineminus">-        $opt_rhino_ms = 1;</span>
<a href="#l25.539"></a><span id="l25.539" class="difflineminus">-        $retval = &amp;get_rhino_engine_command;</span>
<a href="#l25.540"></a><span id="l25.540" class="difflineminus">-    } elsif ($opt_engine_type eq &quot;rhinomsi&quot;) {</span>
<a href="#l25.541"></a><span id="l25.541" class="difflineminus">-        &amp;dd (&quot;getting rhinomsi engine command.&quot;);</span>
<a href="#l25.542"></a><span id="l25.542" class="difflineminus">-        $opt_rhino_opt = -1;</span>
<a href="#l25.543"></a><span id="l25.543" class="difflineminus">-        $opt_rhino_ms = 1;</span>
<a href="#l25.544"></a><span id="l25.544" class="difflineminus">-        $retval = &amp;get_rhino_engine_command;</span>
<a href="#l25.545"></a><span id="l25.545" class="difflineminus">-    } elsif ($opt_engine_type eq &quot;rhinoms9&quot;) {</span>
<a href="#l25.546"></a><span id="l25.546" class="difflineminus">-        &amp;dd (&quot;getting rhinomsi engine command.&quot;);</span>
<a href="#l25.547"></a><span id="l25.547" class="difflineminus">-        $opt_rhino_opt = 9;</span>
<a href="#l25.548"></a><span id="l25.548" class="difflineminus">-        $opt_rhino_ms = 1;</span>
<a href="#l25.549"></a><span id="l25.549" class="difflineminus">-        $retval = &amp;get_rhino_engine_command;</span>
<a href="#l25.550"></a><span id="l25.550" class="difflineminus">-    } elsif ($opt_engine_type eq &quot;xpcshell&quot;) {</span>
<a href="#l25.551"></a><span id="l25.551" class="difflineminus">-        &amp;dd (&quot;getting xpcshell engine command.&quot;);</span>
<a href="#l25.552"></a><span id="l25.552" class="difflineminus">-        $retval = &amp;get_xpc_engine_command;</span>
<a href="#l25.553"></a><span id="l25.553" class="difflineminus">-    } elsif ($opt_engine_type =~ /^lc(opt|debug)$/) {</span>
<a href="#l25.554"></a><span id="l25.554" class="difflineminus">-        &amp;dd (&quot;getting liveconnect engine command.&quot;);</span>
<a href="#l25.555"></a><span id="l25.555" class="difflineminus">-        $retval = &amp;get_lc_engine_command;   </span>
<a href="#l25.556"></a><span id="l25.556" class="difflineminus">-    } elsif ($opt_engine_type =~ /^sm(opt|debug)$/) {</span>
<a href="#l25.557"></a><span id="l25.557" class="difflineminus">-        &amp;dd (&quot;getting spidermonkey engine command.&quot;);</span>
<a href="#l25.558"></a><span id="l25.558" class="difflineminus">-        $retval = &amp;get_sm_engine_command;</span>
<a href="#l25.559"></a><span id="l25.559" class="difflineminus">-    }  elsif ($opt_engine_type =~ /^ep(opt|debug)$/) {</span>
<a href="#l25.560"></a><span id="l25.560" class="difflineminus">-        &amp;dd (&quot;getting epimetheus engine command.&quot;);</span>
<a href="#l25.561"></a><span id="l25.561" class="difflineminus">-        $retval = &amp;get_ep_engine_command;</span>
<a href="#l25.562"></a><span id="l25.562" class="difflineminus">-    } else {</span>
<a href="#l25.563"></a><span id="l25.563" class="difflineminus">-        die (&quot;Unknown engine type selected, '$opt_engine_type'.\n&quot;);</span>
<a href="#l25.564"></a><span id="l25.564" class="difflineminus">-    }</span>
<a href="#l25.565"></a><span id="l25.565" class="difflineminus">-</span>
<a href="#l25.566"></a><span id="l25.566" class="difflineminus">-    $retval .= &quot; $opt_engine_params&quot;;</span>
<a href="#l25.567"></a><span id="l25.567" class="difflineminus">-</span>
<a href="#l25.568"></a><span id="l25.568" class="difflineminus">-    &amp;dd (&quot;got '$retval'&quot;);</span>
<a href="#l25.569"></a><span id="l25.569" class="difflineminus">-</span>
<a href="#l25.570"></a><span id="l25.570" class="difflineminus">-    return $retval;</span>
<a href="#l25.571"></a><span id="l25.571" class="difflineminus">-</span>
<a href="#l25.572"></a><span id="l25.572" class="difflineminus">-}</span>
<a href="#l25.573"></a><span id="l25.573" class="difflineminus">-</span>
<a href="#l25.574"></a><span id="l25.574" class="difflineminus">-#</span>
<a href="#l25.575"></a><span id="l25.575" class="difflineminus">-# get the shell command used to run rhino</span>
<a href="#l25.576"></a><span id="l25.576" class="difflineminus">-#</span>
<a href="#l25.577"></a><span id="l25.577" class="difflineminus">-sub get_rhino_engine_command {</span>
<a href="#l25.578"></a><span id="l25.578" class="difflineminus">-    my $retval = $opt_java_path . ($opt_rhino_ms ? &quot;jview &quot; : &quot;java &quot;);</span>
<a href="#l25.579"></a><span id="l25.579" class="difflineminus">-</span>
<a href="#l25.580"></a><span id="l25.580" class="difflineminus">-    if ($opt_shell_path) {</span>
<a href="#l25.581"></a><span id="l25.581" class="difflineminus">-        $opt_classpath = ($opt_classpath) ?</span>
<a href="#l25.582"></a><span id="l25.582" class="difflineminus">-          $opt_classpath . &quot;:&quot; . $opt_shell_path :</span>
<a href="#l25.583"></a><span id="l25.583" class="difflineminus">-            $opt_shell_path;</span>
<a href="#l25.584"></a><span id="l25.584" class="difflineminus">-    }</span>
<a href="#l25.585"></a><span id="l25.585" class="difflineminus">-</span>
<a href="#l25.586"></a><span id="l25.586" class="difflineminus">-    if ($opt_classpath) {</span>
<a href="#l25.587"></a><span id="l25.587" class="difflineminus">-        $retval .= ($opt_rhino_ms ? &quot;/cp:p&quot; : &quot;-classpath&quot;) . &quot; $opt_classpath &quot;;</span>
<a href="#l25.588"></a><span id="l25.588" class="difflineminus">-    }</span>
<a href="#l25.589"></a><span id="l25.589" class="difflineminus">-</span>
<a href="#l25.590"></a><span id="l25.590" class="difflineminus">-    $retval .= &quot;org.mozilla.javascript.tools.shell.Main&quot;;</span>
<a href="#l25.591"></a><span id="l25.591" class="difflineminus">-</span>
<a href="#l25.592"></a><span id="l25.592" class="difflineminus">-    if ($opt_rhino_opt) {</span>
<a href="#l25.593"></a><span id="l25.593" class="difflineminus">-        $retval .= &quot; -opt $opt_rhino_opt&quot;;</span>
<a href="#l25.594"></a><span id="l25.594" class="difflineminus">-    }</span>
<a href="#l25.595"></a><span id="l25.595" class="difflineminus">-</span>
<a href="#l25.596"></a><span id="l25.596" class="difflineminus">-    return $retval;</span>
<a href="#l25.597"></a><span id="l25.597" class="difflineminus">-</span>
<a href="#l25.598"></a><span id="l25.598" class="difflineminus">-}</span>
<a href="#l25.599"></a><span id="l25.599" class="difflineminus">-</span>
<a href="#l25.600"></a><span id="l25.600" class="difflineminus">-#</span>
<a href="#l25.601"></a><span id="l25.601" class="difflineminus">-# get the shell command used to run xpcshell</span>
<a href="#l25.602"></a><span id="l25.602" class="difflineminus">-#</span>
<a href="#l25.603"></a><span id="l25.603" class="difflineminus">-sub get_xpc_engine_command {</span>
<a href="#l25.604"></a><span id="l25.604" class="difflineminus">-    my $retval;</span>
<a href="#l25.605"></a><span id="l25.605" class="difflineminus">-    my $m5_home = @ENV{&quot;MOZILLA_FIVE_HOME&quot;} ||</span>
<a href="#l25.606"></a><span id="l25.606" class="difflineminus">-      die (&quot;You must set MOZILLA_FIVE_HOME to use the xpcshell&quot; ,</span>
<a href="#l25.607"></a><span id="l25.607" class="difflineminus">-           (!$unixish) ? &quot;.&quot; : &quot;, also &quot; .</span>
<a href="#l25.608"></a><span id="l25.608" class="difflineminus">-           &quot;setting LD_LIBRARY_PATH to the same directory may get rid of &quot; .</span>
<a href="#l25.609"></a><span id="l25.609" class="difflineminus">-           &quot;any 'library not found' errors.\n&quot;);</span>
<a href="#l25.610"></a><span id="l25.610" class="difflineminus">-</span>
<a href="#l25.611"></a><span id="l25.611" class="difflineminus">-    if (($unixish) &amp;&amp; (!@ENV{&quot;LD_LIBRARY_PATH&quot;})) {</span>
<a href="#l25.612"></a><span id="l25.612" class="difflineminus">-        print STDERR &quot;-#- WARNING: LD_LIBRARY_PATH is not set, xpcshell may &quot; .</span>
<a href="#l25.613"></a><span id="l25.613" class="difflineminus">-          &quot;not be able to find the required components.\n&quot;;</span>
<a href="#l25.614"></a><span id="l25.614" class="difflineminus">-    }</span>
<a href="#l25.615"></a><span id="l25.615" class="difflineminus">-</span>
<a href="#l25.616"></a><span id="l25.616" class="difflineminus">-    if (!($m5_home =~ /[\/\\]$/)) {</span>
<a href="#l25.617"></a><span id="l25.617" class="difflineminus">-        $m5_home .= &quot;/&quot;;</span>
<a href="#l25.618"></a><span id="l25.618" class="difflineminus">-    }</span>
<a href="#l25.619"></a><span id="l25.619" class="difflineminus">-</span>
<a href="#l25.620"></a><span id="l25.620" class="difflineminus">-    $retval = $m5_home . &quot;xpcshell&quot;;</span>
<a href="#l25.621"></a><span id="l25.621" class="difflineminus">-</span>
<a href="#l25.622"></a><span id="l25.622" class="difflineminus">-    if ($os_type eq &quot;WIN&quot;) {</span>
<a href="#l25.623"></a><span id="l25.623" class="difflineminus">-        $retval .= &quot;.exe&quot;;</span>
<a href="#l25.624"></a><span id="l25.624" class="difflineminus">-    }</span>
<a href="#l25.625"></a><span id="l25.625" class="difflineminus">-</span>
<a href="#l25.626"></a><span id="l25.626" class="difflineminus">-    $retval = &amp;xp_path($retval);</span>
<a href="#l25.627"></a><span id="l25.627" class="difflineminus">-</span>
<a href="#l25.628"></a><span id="l25.628" class="difflineminus">-    if (($os_type ne &quot;MAC&quot;) &amp;&amp; !(-x $retval)) {</span>
<a href="#l25.629"></a><span id="l25.629" class="difflineminus">-        # mac doesn't seem to deal with -x correctly</span>
<a href="#l25.630"></a><span id="l25.630" class="difflineminus">-        die ($retval . &quot; is not a valid executable on this system.\n&quot;);</span>
<a href="#l25.631"></a><span id="l25.631" class="difflineminus">-    }</span>
<a href="#l25.632"></a><span id="l25.632" class="difflineminus">-</span>
<a href="#l25.633"></a><span id="l25.633" class="difflineminus">-    return $retval;</span>
<a href="#l25.634"></a><span id="l25.634" class="difflineminus">-</span>
<a href="#l25.635"></a><span id="l25.635" class="difflineminus">-}</span>
<a href="#l25.636"></a><span id="l25.636" class="difflineminus">-</span>
<a href="#l25.637"></a><span id="l25.637" class="difflineminus">-#</span>
<a href="#l25.638"></a><span id="l25.638" class="difflineminus">-# get the shell command used to run spidermonkey</span>
<a href="#l25.639"></a><span id="l25.639" class="difflineminus">-#</span>
<a href="#l25.640"></a><span id="l25.640" class="difflineminus">-sub get_sm_engine_command {</span>
<a href="#l25.641"></a><span id="l25.641" class="difflineminus">-    my $retval;</span>
<a href="#l25.642"></a><span id="l25.642" class="difflineminus">-</span>
<a href="#l25.643"></a><span id="l25.643" class="difflineminus">-    # Look for Makefile.ref style make first.</span>
<a href="#l25.644"></a><span id="l25.644" class="difflineminus">-    # (On Windows, spidermonkey can be made by two makefiles, each putting the</span>
<a href="#l25.645"></a><span id="l25.645" class="difflineminus">-    # executable in a diferent directory, under a different name.)</span>
<a href="#l25.646"></a><span id="l25.646" class="difflineminus">-</span>
<a href="#l25.647"></a><span id="l25.647" class="difflineminus">-    if ($opt_shell_path) {</span>
<a href="#l25.648"></a><span id="l25.648" class="difflineminus">-        # if the user provided a path to the shell, return that.</span>
<a href="#l25.649"></a><span id="l25.649" class="difflineminus">-        $retval = $opt_shell_path;</span>
<a href="#l25.650"></a><span id="l25.650" class="difflineminus">-</span>
<a href="#l25.651"></a><span id="l25.651" class="difflineminus">-    } else {</span>
<a href="#l25.652"></a><span id="l25.652" class="difflineminus">-</span>
<a href="#l25.653"></a><span id="l25.653" class="difflineminus">-        if ($os_type eq &quot;MAC&quot;) {</span>
<a href="#l25.654"></a><span id="l25.654" class="difflineminus">-            $retval = $opt_suite_path . &quot;:src:macbuild:JS&quot;;</span>
<a href="#l25.655"></a><span id="l25.655" class="difflineminus">-        } else {</span>
<a href="#l25.656"></a><span id="l25.656" class="difflineminus">-            $retval = $opt_suite_path . &quot;../src/&quot;;</span>
<a href="#l25.657"></a><span id="l25.657" class="difflineminus">-            opendir (SRC_DIR_FILES, $retval);</span>
<a href="#l25.658"></a><span id="l25.658" class="difflineminus">-            my @src_dir_files = readdir(SRC_DIR_FILES);</span>
<a href="#l25.659"></a><span id="l25.659" class="difflineminus">-            closedir (SRC_DIR_FILES);</span>
<a href="#l25.660"></a><span id="l25.660" class="difflineminus">-</span>
<a href="#l25.661"></a><span id="l25.661" class="difflineminus">-            my ($dir, $object_dir);</span>
<a href="#l25.662"></a><span id="l25.662" class="difflineminus">-            my $pattern = ($opt_engine_type eq &quot;smdebug&quot;) ?</span>
<a href="#l25.663"></a><span id="l25.663" class="difflineminus">-              'DBG.OBJ' : 'OPT.OBJ';</span>
<a href="#l25.664"></a><span id="l25.664" class="difflineminus">-</span>
<a href="#l25.665"></a><span id="l25.665" class="difflineminus">-            # scan for the first directory matching</span>
<a href="#l25.666"></a><span id="l25.666" class="difflineminus">-            # the pattern expected to hold this type (debug or opt) of engine</span>
<a href="#l25.667"></a><span id="l25.667" class="difflineminus">-            foreach $dir (@src_dir_files) {</span>
<a href="#l25.668"></a><span id="l25.668" class="difflineminus">-                if ($dir =~ $pattern) {</span>
<a href="#l25.669"></a><span id="l25.669" class="difflineminus">-                    $object_dir = $dir;</span>
<a href="#l25.670"></a><span id="l25.670" class="difflineminus">-                    last;</span>
<a href="#l25.671"></a><span id="l25.671" class="difflineminus">-                }</span>
<a href="#l25.672"></a><span id="l25.672" class="difflineminus">-            }</span>
<a href="#l25.673"></a><span id="l25.673" class="difflineminus">-</span>
<a href="#l25.674"></a><span id="l25.674" class="difflineminus">-            if (!$object_dir &amp;&amp; $os_type ne &quot;WIN&quot;) {</span>
<a href="#l25.675"></a><span id="l25.675" class="difflineminus">-                die (&quot;Could not locate an object directory in $retval &quot; .</span>
<a href="#l25.676"></a><span id="l25.676" class="difflineminus">-                     &quot;matching the pattern *$pattern.  Have you built the &quot; .</span>
<a href="#l25.677"></a><span id="l25.677" class="difflineminus">-                     &quot;engine?\n&quot;);</span>
<a href="#l25.678"></a><span id="l25.678" class="difflineminus">-            }</span>
<a href="#l25.679"></a><span id="l25.679" class="difflineminus">-</span>
<a href="#l25.680"></a><span id="l25.680" class="difflineminus">-            if (!(-x $retval . $object_dir . &quot;/js.exe&quot;) &amp;&amp; ($os_type eq &quot;WIN&quot;)) {</span>
<a href="#l25.681"></a><span id="l25.681" class="difflineminus">-                # On windows, you can build with js.mak as well as Makefile.ref</span>
<a href="#l25.682"></a><span id="l25.682" class="difflineminus">-                # (Can you say WTF boys and girls?  I knew you could.)</span>
<a href="#l25.683"></a><span id="l25.683" class="difflineminus">-                # So, if the exe the would have been built by Makefile.ref isn't </span>
<a href="#l25.684"></a><span id="l25.684" class="difflineminus">-                # here, check for the js.mak version before dying.</span>
<a href="#l25.685"></a><span id="l25.685" class="difflineminus">-                if ($opt_shell_path) {</span>
<a href="#l25.686"></a><span id="l25.686" class="difflineminus">-                    $retval = $opt_shell_path;</span>
<a href="#l25.687"></a><span id="l25.687" class="difflineminus">-                    if (!($retval =~ /[\/\\]$/)) {</span>
<a href="#l25.688"></a><span id="l25.688" class="difflineminus">-                        $retval .= &quot;/&quot;;</span>
<a href="#l25.689"></a><span id="l25.689" class="difflineminus">-                    }</span>
<a href="#l25.690"></a><span id="l25.690" class="difflineminus">-                } else {</span>
<a href="#l25.691"></a><span id="l25.691" class="difflineminus">-                    if ($opt_engine_type eq &quot;smopt&quot;) {</span>
<a href="#l25.692"></a><span id="l25.692" class="difflineminus">-                        $retval = &quot;../src/Release/&quot;;</span>
<a href="#l25.693"></a><span id="l25.693" class="difflineminus">-                    } else {</span>
<a href="#l25.694"></a><span id="l25.694" class="difflineminus">-                        $retval = &quot;../src/Debug/&quot;;</span>
<a href="#l25.695"></a><span id="l25.695" class="difflineminus">-                    }</span>
<a href="#l25.696"></a><span id="l25.696" class="difflineminus">-                }</span>
<a href="#l25.697"></a><span id="l25.697" class="difflineminus">-</span>
<a href="#l25.698"></a><span id="l25.698" class="difflineminus">-                $retval .= &quot;jsshell.exe&quot;;</span>
<a href="#l25.699"></a><span id="l25.699" class="difflineminus">-</span>
<a href="#l25.700"></a><span id="l25.700" class="difflineminus">-            } else {</span>
<a href="#l25.701"></a><span id="l25.701" class="difflineminus">-                $retval .= $object_dir . &quot;/js&quot;;</span>
<a href="#l25.702"></a><span id="l25.702" class="difflineminus">-                if ($os_type eq &quot;WIN&quot;) {</span>
<a href="#l25.703"></a><span id="l25.703" class="difflineminus">-                    $retval .= &quot;.exe&quot;;</span>
<a href="#l25.704"></a><span id="l25.704" class="difflineminus">-                }</span>
<a href="#l25.705"></a><span id="l25.705" class="difflineminus">-            }</span>
<a href="#l25.706"></a><span id="l25.706" class="difflineminus">-        } # mac/ not mac</span>
<a href="#l25.707"></a><span id="l25.707" class="difflineminus">-</span>
<a href="#l25.708"></a><span id="l25.708" class="difflineminus">-        $retval = &amp;xp_path($retval);</span>
<a href="#l25.709"></a><span id="l25.709" class="difflineminus">-</span>
<a href="#l25.710"></a><span id="l25.710" class="difflineminus">-    } # (user provided a path)</span>
<a href="#l25.711"></a><span id="l25.711" class="difflineminus">-</span>
<a href="#l25.712"></a><span id="l25.712" class="difflineminus">-</span>
<a href="#l25.713"></a><span id="l25.713" class="difflineminus">-    if (($os_type ne &quot;MAC&quot;) &amp;&amp; !(-x $retval)) {</span>
<a href="#l25.714"></a><span id="l25.714" class="difflineminus">-        # mac doesn't seem to deal with -x correctly</span>
<a href="#l25.715"></a><span id="l25.715" class="difflineminus">-        die ($retval . &quot; is not a valid executable on this system.\n&quot;);</span>
<a href="#l25.716"></a><span id="l25.716" class="difflineminus">-    }</span>
<a href="#l25.717"></a><span id="l25.717" class="difflineminus">-</span>
<a href="#l25.718"></a><span id="l25.718" class="difflineminus">-    return $retval;</span>
<a href="#l25.719"></a><span id="l25.719" class="difflineminus">-</span>
<a href="#l25.720"></a><span id="l25.720" class="difflineminus">-}</span>
<a href="#l25.721"></a><span id="l25.721" class="difflineminus">-</span>
<a href="#l25.722"></a><span id="l25.722" class="difflineminus">-#</span>
<a href="#l25.723"></a><span id="l25.723" class="difflineminus">-# get the shell command used to run epimetheus</span>
<a href="#l25.724"></a><span id="l25.724" class="difflineminus">-#</span>
<a href="#l25.725"></a><span id="l25.725" class="difflineminus">-sub get_ep_engine_command {</span>
<a href="#l25.726"></a><span id="l25.726" class="difflineminus">-    my $retval;</span>
<a href="#l25.727"></a><span id="l25.727" class="difflineminus">-</span>
<a href="#l25.728"></a><span id="l25.728" class="difflineminus">-    if ($opt_shell_path) {</span>
<a href="#l25.729"></a><span id="l25.729" class="difflineminus">-        # if the user provided a path to the shell, return that -</span>
<a href="#l25.730"></a><span id="l25.730" class="difflineminus">-        $retval = $opt_shell_path;</span>
<a href="#l25.731"></a><span id="l25.731" class="difflineminus">-</span>
<a href="#l25.732"></a><span id="l25.732" class="difflineminus">-    } else {</span>
<a href="#l25.733"></a><span id="l25.733" class="difflineminus">-        my $dir;</span>
<a href="#l25.734"></a><span id="l25.734" class="difflineminus">-        my $os;</span>
<a href="#l25.735"></a><span id="l25.735" class="difflineminus">-        my $debug;</span>
<a href="#l25.736"></a><span id="l25.736" class="difflineminus">-        my $opt;</span>
<a href="#l25.737"></a><span id="l25.737" class="difflineminus">-        my $exe;</span>
<a href="#l25.738"></a><span id="l25.738" class="difflineminus">-</span>
<a href="#l25.739"></a><span id="l25.739" class="difflineminus">-        $dir = $opt_suite_path . &quot;../../js2/src/&quot;;</span>
<a href="#l25.740"></a><span id="l25.740" class="difflineminus">-</span>
<a href="#l25.741"></a><span id="l25.741" class="difflineminus">-        if ($os_type eq &quot;MAC&quot;) {</span>
<a href="#l25.742"></a><span id="l25.742" class="difflineminus">-            #</span>
<a href="#l25.743"></a><span id="l25.743" class="difflineminus">-            # On the Mac, the debug and opt builds lie in the same directory -</span>
<a href="#l25.744"></a><span id="l25.744" class="difflineminus">-            #</span>
<a href="#l25.745"></a><span id="l25.745" class="difflineminus">-            $os = &quot;macbuild:&quot;;</span>
<a href="#l25.746"></a><span id="l25.746" class="difflineminus">-            $debug = &quot;&quot;;</span>
<a href="#l25.747"></a><span id="l25.747" class="difflineminus">-            $opt = &quot;&quot;;</span>
<a href="#l25.748"></a><span id="l25.748" class="difflineminus">-            $exe = &quot;JS2&quot;;</span>
<a href="#l25.749"></a><span id="l25.749" class="difflineminus">-        } elsif ($os_type eq &quot;WIN&quot;) {</span>
<a href="#l25.750"></a><span id="l25.750" class="difflineminus">-            $os = &quot;winbuild/Epimetheus/&quot;;</span>
<a href="#l25.751"></a><span id="l25.751" class="difflineminus">-            $debug = &quot;Debug/&quot;;</span>
<a href="#l25.752"></a><span id="l25.752" class="difflineminus">-            $opt = &quot;Release/&quot;;</span>
<a href="#l25.753"></a><span id="l25.753" class="difflineminus">-            $exe = &quot;Epimetheus.exe&quot;;</span>
<a href="#l25.754"></a><span id="l25.754" class="difflineminus">-        } else {</span>
<a href="#l25.755"></a><span id="l25.755" class="difflineminus">-            $os = &quot;&quot;;</span>
<a href="#l25.756"></a><span id="l25.756" class="difflineminus">-            $debug = &quot;&quot;;</span>
<a href="#l25.757"></a><span id="l25.757" class="difflineminus">-            $opt = &quot;&quot;;    # &lt;&lt;&lt;----- XXX THIS IS NOT RIGHT! CHANGE IT!</span>
<a href="#l25.758"></a><span id="l25.758" class="difflineminus">-            $exe = &quot;epimetheus&quot;;</span>
<a href="#l25.759"></a><span id="l25.759" class="difflineminus">-        }</span>
<a href="#l25.760"></a><span id="l25.760" class="difflineminus">-</span>
<a href="#l25.761"></a><span id="l25.761" class="difflineminus">-</span>
<a href="#l25.762"></a><span id="l25.762" class="difflineminus">-        if ($opt_engine_type eq &quot;epdebug&quot;) {</span>
<a href="#l25.763"></a><span id="l25.763" class="difflineminus">-            $retval = $dir . $os . $debug . $exe;</span>
<a href="#l25.764"></a><span id="l25.764" class="difflineminus">-        } else {</span>
<a href="#l25.765"></a><span id="l25.765" class="difflineminus">-            $retval = $dir . $os . $opt . $exe;</span>
<a href="#l25.766"></a><span id="l25.766" class="difflineminus">-        }</span>
<a href="#l25.767"></a><span id="l25.767" class="difflineminus">-</span>
<a href="#l25.768"></a><span id="l25.768" class="difflineminus">-        $retval = &amp;xp_path($retval);</span>
<a href="#l25.769"></a><span id="l25.769" class="difflineminus">-</span>
<a href="#l25.770"></a><span id="l25.770" class="difflineminus">-    }# (user provided a path)</span>
<a href="#l25.771"></a><span id="l25.771" class="difflineminus">-</span>
<a href="#l25.772"></a><span id="l25.772" class="difflineminus">-</span>
<a href="#l25.773"></a><span id="l25.773" class="difflineminus">-    if (($os_type ne &quot;MAC&quot;) &amp;&amp; !(-x $retval)) {</span>
<a href="#l25.774"></a><span id="l25.774" class="difflineminus">-        # mac doesn't seem to deal with -x correctly</span>
<a href="#l25.775"></a><span id="l25.775" class="difflineminus">-        die ($retval . &quot; is not a valid executable on this system.\n&quot;);</span>
<a href="#l25.776"></a><span id="l25.776" class="difflineminus">-    }</span>
<a href="#l25.777"></a><span id="l25.777" class="difflineminus">-</span>
<a href="#l25.778"></a><span id="l25.778" class="difflineminus">-    return $retval;</span>
<a href="#l25.779"></a><span id="l25.779" class="difflineminus">-}</span>
<a href="#l25.780"></a><span id="l25.780" class="difflineminus">-</span>
<a href="#l25.781"></a><span id="l25.781" class="difflineminus">-#</span>
<a href="#l25.782"></a><span id="l25.782" class="difflineminus">-# get the shell command used to run the liveconnect shell</span>
<a href="#l25.783"></a><span id="l25.783" class="difflineminus">-#</span>
<a href="#l25.784"></a><span id="l25.784" class="difflineminus">-sub get_lc_engine_command {</span>
<a href="#l25.785"></a><span id="l25.785" class="difflineminus">-    my $retval;</span>
<a href="#l25.786"></a><span id="l25.786" class="difflineminus">-</span>
<a href="#l25.787"></a><span id="l25.787" class="difflineminus">-    if ($opt_shell_path) {</span>
<a href="#l25.788"></a><span id="l25.788" class="difflineminus">-        $retval = $opt_shell_path;</span>
<a href="#l25.789"></a><span id="l25.789" class="difflineminus">-    } else {</span>
<a href="#l25.790"></a><span id="l25.790" class="difflineminus">-        if ($os_type eq &quot;MAC&quot;) {</span>
<a href="#l25.791"></a><span id="l25.791" class="difflineminus">-            die &quot;Don't know how to run the lc shell on the mac yet.\n&quot;;</span>
<a href="#l25.792"></a><span id="l25.792" class="difflineminus">-        } else {</span>
<a href="#l25.793"></a><span id="l25.793" class="difflineminus">-            $retval = $opt_suite_path . &quot;../src/liveconnect/&quot;;</span>
<a href="#l25.794"></a><span id="l25.794" class="difflineminus">-            opendir (SRC_DIR_FILES, $retval);</span>
<a href="#l25.795"></a><span id="l25.795" class="difflineminus">-            my @src_dir_files = readdir(SRC_DIR_FILES);</span>
<a href="#l25.796"></a><span id="l25.796" class="difflineminus">-            closedir (SRC_DIR_FILES);</span>
<a href="#l25.797"></a><span id="l25.797" class="difflineminus">-</span>
<a href="#l25.798"></a><span id="l25.798" class="difflineminus">-            my ($dir, $object_dir);</span>
<a href="#l25.799"></a><span id="l25.799" class="difflineminus">-            my $pattern = ($opt_engine_type eq &quot;lcdebug&quot;) ?</span>
<a href="#l25.800"></a><span id="l25.800" class="difflineminus">-              'DBG.OBJ' : 'OPT.OBJ';</span>
<a href="#l25.801"></a><span id="l25.801" class="difflineminus">-</span>
<a href="#l25.802"></a><span id="l25.802" class="difflineminus">-            foreach $dir (@src_dir_files) {</span>
<a href="#l25.803"></a><span id="l25.803" class="difflineminus">-                if ($dir =~ $pattern) {</span>
<a href="#l25.804"></a><span id="l25.804" class="difflineminus">-                    $object_dir = $dir;</span>
<a href="#l25.805"></a><span id="l25.805" class="difflineminus">-                    last;</span>
<a href="#l25.806"></a><span id="l25.806" class="difflineminus">-                }</span>
<a href="#l25.807"></a><span id="l25.807" class="difflineminus">-            }</span>
<a href="#l25.808"></a><span id="l25.808" class="difflineminus">-</span>
<a href="#l25.809"></a><span id="l25.809" class="difflineminus">-            if (!$object_dir) {</span>
<a href="#l25.810"></a><span id="l25.810" class="difflineminus">-                die (&quot;Could not locate an object directory in $retval &quot; .</span>
<a href="#l25.811"></a><span id="l25.811" class="difflineminus">-                     &quot;matching the pattern *$pattern.  Have you built the &quot; .</span>
<a href="#l25.812"></a><span id="l25.812" class="difflineminus">-                     &quot;engine?\n&quot;);</span>
<a href="#l25.813"></a><span id="l25.813" class="difflineminus">-            }</span>
<a href="#l25.814"></a><span id="l25.814" class="difflineminus">-</span>
<a href="#l25.815"></a><span id="l25.815" class="difflineminus">-            $retval .= $object_dir . &quot;/&quot;;</span>
<a href="#l25.816"></a><span id="l25.816" class="difflineminus">-</span>
<a href="#l25.817"></a><span id="l25.817" class="difflineminus">-            if ($os_type eq &quot;WIN&quot;) {</span>
<a href="#l25.818"></a><span id="l25.818" class="difflineminus">-                $retval .= &quot;lcshell.exe&quot;;</span>
<a href="#l25.819"></a><span id="l25.819" class="difflineminus">-            } else {</span>
<a href="#l25.820"></a><span id="l25.820" class="difflineminus">-                $retval .= &quot;lcshell&quot;;</span>
<a href="#l25.821"></a><span id="l25.821" class="difflineminus">-            }</span>
<a href="#l25.822"></a><span id="l25.822" class="difflineminus">-        } # mac/ not mac</span>
<a href="#l25.823"></a><span id="l25.823" class="difflineminus">-</span>
<a href="#l25.824"></a><span id="l25.824" class="difflineminus">-        $retval = &amp;xp_path($retval);</span>
<a href="#l25.825"></a><span id="l25.825" class="difflineminus">-</span>
<a href="#l25.826"></a><span id="l25.826" class="difflineminus">-    } # (user provided a path)</span>
<a href="#l25.827"></a><span id="l25.827" class="difflineminus">-</span>
<a href="#l25.828"></a><span id="l25.828" class="difflineminus">-</span>
<a href="#l25.829"></a><span id="l25.829" class="difflineminus">-    if (($os_type ne &quot;MAC&quot;) &amp;&amp; !(-x $retval)) {</span>
<a href="#l25.830"></a><span id="l25.830" class="difflineminus">-        # mac doesn't seem to deal with -x correctly</span>
<a href="#l25.831"></a><span id="l25.831" class="difflineminus">-        die (&quot;$retval is not a valid executable on this system.\n&quot;);</span>
<a href="#l25.832"></a><span id="l25.832" class="difflineminus">-    }</span>
<a href="#l25.833"></a><span id="l25.833" class="difflineminus">-</span>
<a href="#l25.834"></a><span id="l25.834" class="difflineminus">-    return $retval;</span>
<a href="#l25.835"></a><span id="l25.835" class="difflineminus">-</span>
<a href="#l25.836"></a><span id="l25.836" class="difflineminus">-}</span>
<a href="#l25.837"></a><span id="l25.837" class="difflineminus">-</span>
<a href="#l25.838"></a><span id="l25.838" class="difflineminus">-sub get_os_type {</span>
<a href="#l25.839"></a><span id="l25.839" class="difflineminus">-</span>
<a href="#l25.840"></a><span id="l25.840" class="difflineminus">-    if (&quot;\n&quot; eq &quot;\015&quot;) {</span>
<a href="#l25.841"></a><span id="l25.841" class="difflineminus">-        return &quot;MAC&quot;;</span>
<a href="#l25.842"></a><span id="l25.842" class="difflineminus">-    }</span>
<a href="#l25.843"></a><span id="l25.843" class="difflineminus">-</span>
<a href="#l25.844"></a><span id="l25.844" class="difflineminus">-    my $uname = `uname -a`;</span>
<a href="#l25.845"></a><span id="l25.845" class="difflineminus">-</span>
<a href="#l25.846"></a><span id="l25.846" class="difflineminus">-    if ($uname =~ /WIN/) {</span>
<a href="#l25.847"></a><span id="l25.847" class="difflineminus">-        $uname = &quot;WIN&quot;;</span>
<a href="#l25.848"></a><span id="l25.848" class="difflineminus">-    } else {</span>
<a href="#l25.849"></a><span id="l25.849" class="difflineminus">-        chop $uname;</span>
<a href="#l25.850"></a><span id="l25.850" class="difflineminus">-    }</span>
<a href="#l25.851"></a><span id="l25.851" class="difflineminus">-</span>
<a href="#l25.852"></a><span id="l25.852" class="difflineminus">-    &amp;dd (&quot;get_os_type returning '$uname'.&quot;);</span>
<a href="#l25.853"></a><span id="l25.853" class="difflineminus">-    return $uname;</span>
<a href="#l25.854"></a><span id="l25.854" class="difflineminus">-</span>
<a href="#l25.855"></a><span id="l25.855" class="difflineminus">-}</span>
<a href="#l25.856"></a><span id="l25.856" class="difflineminus">-</span>
<a href="#l25.857"></a><span id="l25.857" class="difflineminus">-sub get_test_list {</span>
<a href="#l25.858"></a><span id="l25.858" class="difflineminus">-    my @test_list;</span>
<a href="#l25.859"></a><span id="l25.859" class="difflineminus">-    my @neg_list;</span>
<a href="#l25.860"></a><span id="l25.860" class="difflineminus">-</span>
<a href="#l25.861"></a><span id="l25.861" class="difflineminus">-    if ($#opt_test_list_files &gt; -1) {</span>
<a href="#l25.862"></a><span id="l25.862" class="difflineminus">-        my $list_file;</span>
<a href="#l25.863"></a><span id="l25.863" class="difflineminus">-</span>
<a href="#l25.864"></a><span id="l25.864" class="difflineminus">-        &amp;dd (&quot;getting test list from user specified source.&quot;);</span>
<a href="#l25.865"></a><span id="l25.865" class="difflineminus">-</span>
<a href="#l25.866"></a><span id="l25.866" class="difflineminus">-        foreach $list_file (@opt_test_list_files) {</span>
<a href="#l25.867"></a><span id="l25.867" class="difflineminus">-            push (@test_list, &amp;expand_user_test_list($list_file));</span>
<a href="#l25.868"></a><span id="l25.868" class="difflineminus">-        }</span>
<a href="#l25.869"></a><span id="l25.869" class="difflineminus">-    } else {</span>
<a href="#l25.870"></a><span id="l25.870" class="difflineminus">-        &amp;dd (&quot;no list file, groveling in '$opt_suite_path'.&quot;);</span>
<a href="#l25.871"></a><span id="l25.871" class="difflineminus">-</span>
<a href="#l25.872"></a><span id="l25.872" class="difflineminus">-        @test_list = &amp;get_default_test_list($opt_suite_path);</span>
<a href="#l25.873"></a><span id="l25.873" class="difflineminus">-    }</span>
<a href="#l25.874"></a><span id="l25.874" class="difflineminus">-</span>
<a href="#l25.875"></a><span id="l25.875" class="difflineminus">-    if ($#opt_neg_list_files &gt; -1) {</span>
<a href="#l25.876"></a><span id="l25.876" class="difflineminus">-        my $list_file;</span>
<a href="#l25.877"></a><span id="l25.877" class="difflineminus">-        my $orig_size = $#test_list + 1;</span>
<a href="#l25.878"></a><span id="l25.878" class="difflineminus">-        my $actually_skipped;</span>
<a href="#l25.879"></a><span id="l25.879" class="difflineminus">-</span>
<a href="#l25.880"></a><span id="l25.880" class="difflineminus">-        &amp;dd (&quot;getting negative list from user specified source.&quot;);</span>
<a href="#l25.881"></a><span id="l25.881" class="difflineminus">-</span>
<a href="#l25.882"></a><span id="l25.882" class="difflineminus">-        foreach $list_file (@opt_neg_list_files) {</span>
<a href="#l25.883"></a><span id="l25.883" class="difflineminus">-            push (@neg_list, &amp;expand_user_test_list($list_file));</span>
<a href="#l25.884"></a><span id="l25.884" class="difflineminus">-        }</span>
<a href="#l25.885"></a><span id="l25.885" class="difflineminus">-</span>
<a href="#l25.886"></a><span id="l25.886" class="difflineminus">-        @test_list = &amp;subtract_arrays (\@test_list, \@neg_list);</span>
<a href="#l25.887"></a><span id="l25.887" class="difflineminus">-</span>
<a href="#l25.888"></a><span id="l25.888" class="difflineminus">-        $actually_skipped = $orig_size - ($#test_list + 1);</span>
<a href="#l25.889"></a><span id="l25.889" class="difflineminus">-</span>
<a href="#l25.890"></a><span id="l25.890" class="difflineminus">-        &amp;dd ($actually_skipped . &quot; of &quot; . $orig_size .</span>
<a href="#l25.891"></a><span id="l25.891" class="difflineminus">-             &quot; tests will be skipped.&quot;);</span>
<a href="#l25.892"></a><span id="l25.892" class="difflineminus">-        &amp;dd ((($#neg_list + 1) - $actually_skipped) . &quot; skip tests were &quot; .</span>
<a href="#l25.893"></a><span id="l25.893" class="difflineminus">-             &quot;not actually part of the test list.&quot;);</span>
<a href="#l25.894"></a><span id="l25.894" class="difflineminus">-</span>
<a href="#l25.895"></a><span id="l25.895" class="difflineminus">-    }</span>
<a href="#l25.896"></a><span id="l25.896" class="difflineminus">-</span>
<a href="#l25.897"></a><span id="l25.897" class="difflineminus">-</span>
<a href="#l25.898"></a><span id="l25.898" class="difflineminus">-    # Don't run any shell.js files as tests; they are only utility files</span>
<a href="#l25.899"></a><span id="l25.899" class="difflineminus">-    @test_list = grep (!/shell.*\.js$/, @test_list);</span>
<a href="#l25.900"></a><span id="l25.900" class="difflineminus">-</span>
<a href="#l25.901"></a><span id="l25.901" class="difflineminus">-    return @test_list;</span>
<a href="#l25.902"></a><span id="l25.902" class="difflineminus">-</span>
<a href="#l25.903"></a><span id="l25.903" class="difflineminus">-}</span>
<a href="#l25.904"></a><span id="l25.904" class="difflineminus">-</span>
<a href="#l25.905"></a><span id="l25.905" class="difflineminus">-#</span>
<a href="#l25.906"></a><span id="l25.906" class="difflineminus">-# reads $list_file, storing non-comment lines into an array.</span>
<a href="#l25.907"></a><span id="l25.907" class="difflineminus">-# lines in the form suite_dir/[*] or suite_dir/test_dir/[*] are expanded</span>
<a href="#l25.908"></a><span id="l25.908" class="difflineminus">-# to include all test files under the specified directory</span>
<a href="#l25.909"></a><span id="l25.909" class="difflineminus">-#</span>
<a href="#l25.910"></a><span id="l25.910" class="difflineminus">-sub expand_user_test_list {</span>
<a href="#l25.911"></a><span id="l25.911" class="difflineminus">-    my ($list_file) = @_;</span>
<a href="#l25.912"></a><span id="l25.912" class="difflineminus">-    my @retval = ();</span>
<a href="#l25.913"></a><span id="l25.913" class="difflineminus">-</span>
<a href="#l25.914"></a><span id="l25.914" class="difflineminus">-    #</span>
<a href="#l25.915"></a><span id="l25.915" class="difflineminus">-    # Trim off the leading path separator that begins relative paths on the Mac.</span>
<a href="#l25.916"></a><span id="l25.916" class="difflineminus">-    # Each path will get concatenated with $opt_suite_path, which ends in one.</span>
<a href="#l25.917"></a><span id="l25.917" class="difflineminus">-    #</span>
<a href="#l25.918"></a><span id="l25.918" class="difflineminus">-    # Also note:</span>
<a href="#l25.919"></a><span id="l25.919" class="difflineminus">-    #</span>
<a href="#l25.920"></a><span id="l25.920" class="difflineminus">-    # We will call expand_test_list_entry(), which does pattern-matching on $list_file.</span>
<a href="#l25.921"></a><span id="l25.921" class="difflineminus">-    # This will make the pattern-matching the same as it would be on Linux/Windows -</span>
<a href="#l25.922"></a><span id="l25.922" class="difflineminus">-    #</span>
<a href="#l25.923"></a><span id="l25.923" class="difflineminus">-    if ($os_type eq &quot;MAC&quot;) {</span>
<a href="#l25.924"></a><span id="l25.924" class="difflineminus">-        $list_file =~ s/^$path_sep//;</span>
<a href="#l25.925"></a><span id="l25.925" class="difflineminus">-    }</span>
<a href="#l25.926"></a><span id="l25.926" class="difflineminus">-</span>
<a href="#l25.927"></a><span id="l25.927" class="difflineminus">-    if ($list_file =~ /\.js$/ || -d $opt_suite_path . $list_file) {</span>
<a href="#l25.928"></a><span id="l25.928" class="difflineminus">-</span>
<a href="#l25.929"></a><span id="l25.929" class="difflineminus">-        push (@retval, &amp;expand_test_list_entry($list_file));</span>
<a href="#l25.930"></a><span id="l25.930" class="difflineminus">-</span>
<a href="#l25.931"></a><span id="l25.931" class="difflineminus">-    } else {</span>
<a href="#l25.932"></a><span id="l25.932" class="difflineminus">-</span>
<a href="#l25.933"></a><span id="l25.933" class="difflineminus">-        open (TESTLIST, $list_file) ||</span>
<a href="#l25.934"></a><span id="l25.934" class="difflineminus">-          die(&quot;Error opening test list file '$list_file': $!\n&quot;);</span>
<a href="#l25.935"></a><span id="l25.935" class="difflineminus">-</span>
<a href="#l25.936"></a><span id="l25.936" class="difflineminus">-        while (&lt;TESTLIST&gt;) {</span>
<a href="#l25.937"></a><span id="l25.937" class="difflineminus">-            s/\r*\n*$//;</span>
<a href="#l25.938"></a><span id="l25.938" class="difflineminus">-            if (!(/\s*\#/)) {</span>
<a href="#l25.939"></a><span id="l25.939" class="difflineminus">-                # It's not a comment, so process it</span>
<a href="#l25.940"></a><span id="l25.940" class="difflineminus">-                push (@retval, &amp;expand_test_list_entry($_));</span>
<a href="#l25.941"></a><span id="l25.941" class="difflineminus">-            }</span>
<a href="#l25.942"></a><span id="l25.942" class="difflineminus">-        }</span>
<a href="#l25.943"></a><span id="l25.943" class="difflineminus">-</span>
<a href="#l25.944"></a><span id="l25.944" class="difflineminus">-        close (TESTLIST);</span>
<a href="#l25.945"></a><span id="l25.945" class="difflineminus">-</span>
<a href="#l25.946"></a><span id="l25.946" class="difflineminus">-    }</span>
<a href="#l25.947"></a><span id="l25.947" class="difflineminus">-</span>
<a href="#l25.948"></a><span id="l25.948" class="difflineminus">-    return @retval;</span>
<a href="#l25.949"></a><span id="l25.949" class="difflineminus">-</span>
<a href="#l25.950"></a><span id="l25.950" class="difflineminus">-}</span>
<a href="#l25.951"></a><span id="l25.951" class="difflineminus">-</span>
<a href="#l25.952"></a><span id="l25.952" class="difflineminus">-</span>
<a href="#l25.953"></a><span id="l25.953" class="difflineminus">-#</span>
<a href="#l25.954"></a><span id="l25.954" class="difflineminus">-# Currently expect all paths to be RELATIVE to the top-level tests directory.</span>
<a href="#l25.955"></a><span id="l25.955" class="difflineminus">-# One day, this should be improved to allow absolute paths as well -</span>
<a href="#l25.956"></a><span id="l25.956" class="difflineminus">-#</span>
<a href="#l25.957"></a><span id="l25.957" class="difflineminus">-sub expand_test_list_entry {</span>
<a href="#l25.958"></a><span id="l25.958" class="difflineminus">-    my ($entry) = @_;</span>
<a href="#l25.959"></a><span id="l25.959" class="difflineminus">-    my @retval;</span>
<a href="#l25.960"></a><span id="l25.960" class="difflineminus">-</span>
<a href="#l25.961"></a><span id="l25.961" class="difflineminus">-    if ($entry =~ /\.js$/) {</span>
<a href="#l25.962"></a><span id="l25.962" class="difflineminus">-        # it's a regular entry, add it to the list</span>
<a href="#l25.963"></a><span id="l25.963" class="difflineminus">-        if (-f $opt_suite_path . $entry) {</span>
<a href="#l25.964"></a><span id="l25.964" class="difflineminus">-            push (@retval, $entry);</span>
<a href="#l25.965"></a><span id="l25.965" class="difflineminus">-        } else {</span>
<a href="#l25.966"></a><span id="l25.966" class="difflineminus">-            status (&quot;testcase '$entry' not found.&quot;);</span>
<a href="#l25.967"></a><span id="l25.967" class="difflineminus">-        }</span>
<a href="#l25.968"></a><span id="l25.968" class="difflineminus">-    } elsif ($entry =~ /(.*$path_sep[^\*][^$path_sep]*)$path_sep?\*?$/) {</span>
<a href="#l25.969"></a><span id="l25.969" class="difflineminus">-        # Entry is in the form suite_dir/test_dir[/*]</span>
<a href="#l25.970"></a><span id="l25.970" class="difflineminus">-        # so iterate all tests under it</span>
<a href="#l25.971"></a><span id="l25.971" class="difflineminus">-        my $suite_and_test_dir = $1;</span>
<a href="#l25.972"></a><span id="l25.972" class="difflineminus">-        my @test_files = &amp;get_js_files ($opt_suite_path . </span>
<a href="#l25.973"></a><span id="l25.973" class="difflineminus">-                                        $suite_and_test_dir);</span>
<a href="#l25.974"></a><span id="l25.974" class="difflineminus">-        my $i;</span>
<a href="#l25.975"></a><span id="l25.975" class="difflineminus">-</span>
<a href="#l25.976"></a><span id="l25.976" class="difflineminus">-        foreach $i (0 .. $#test_files) {</span>
<a href="#l25.977"></a><span id="l25.977" class="difflineminus">-            $test_files[$i] = $suite_and_test_dir . $path_sep .</span>
<a href="#l25.978"></a><span id="l25.978" class="difflineminus">-              $test_files[$i];</span>
<a href="#l25.979"></a><span id="l25.979" class="difflineminus">-        }</span>
<a href="#l25.980"></a><span id="l25.980" class="difflineminus">-</span>
<a href="#l25.981"></a><span id="l25.981" class="difflineminus">-        splice (@retval, $#retval + 1, 0, @test_files);</span>
<a href="#l25.982"></a><span id="l25.982" class="difflineminus">-</span>
<a href="#l25.983"></a><span id="l25.983" class="difflineminus">-    } elsif ($entry =~ /([^\*][^$path_sep]*)$path_sep?\*?$/) {</span>
<a href="#l25.984"></a><span id="l25.984" class="difflineminus">-        # Entry is in the form suite_dir[/*]</span>
<a href="#l25.985"></a><span id="l25.985" class="difflineminus">-        # so iterate all test dirs and tests under it</span>
<a href="#l25.986"></a><span id="l25.986" class="difflineminus">-        my $suite = $1;</span>
<a href="#l25.987"></a><span id="l25.987" class="difflineminus">-        my @test_dirs = &amp;get_subdirs ($opt_suite_path . $suite);</span>
<a href="#l25.988"></a><span id="l25.988" class="difflineminus">-        my $test_dir;</span>
<a href="#l25.989"></a><span id="l25.989" class="difflineminus">-</span>
<a href="#l25.990"></a><span id="l25.990" class="difflineminus">-        foreach $test_dir (@test_dirs) {</span>
<a href="#l25.991"></a><span id="l25.991" class="difflineminus">-            my @test_files = &amp;get_js_files ($opt_suite_path . $suite .</span>
<a href="#l25.992"></a><span id="l25.992" class="difflineminus">-                                            $path_sep . $test_dir);</span>
<a href="#l25.993"></a><span id="l25.993" class="difflineminus">-            my $i;</span>
<a href="#l25.994"></a><span id="l25.994" class="difflineminus">-</span>
<a href="#l25.995"></a><span id="l25.995" class="difflineminus">-            foreach $i (0 .. $#test_files) {</span>
<a href="#l25.996"></a><span id="l25.996" class="difflineminus">-                $test_files[$i] = $suite . $path_sep . $test_dir . $path_sep .</span>
<a href="#l25.997"></a><span id="l25.997" class="difflineminus">-                  $test_files[$i];</span>
<a href="#l25.998"></a><span id="l25.998" class="difflineminus">-            }</span>
<a href="#l25.999"></a><span id="l25.999" class="difflineminus">-</span>
<a href="#l25.1000"></a><span id="l25.1000" class="difflineminus">-            splice (@retval, $#retval + 1, 0, @test_files);</span>
<a href="#l25.1001"></a><span id="l25.1001" class="difflineminus">-        }</span>
<a href="#l25.1002"></a><span id="l25.1002" class="difflineminus">-</span>
<a href="#l25.1003"></a><span id="l25.1003" class="difflineminus">-    } else {</span>
<a href="#l25.1004"></a><span id="l25.1004" class="difflineminus">-        die (&quot;Dont know what to do with list entry '$entry'.\n&quot;);</span>
<a href="#l25.1005"></a><span id="l25.1005" class="difflineminus">-    }</span>
<a href="#l25.1006"></a><span id="l25.1006" class="difflineminus">-</span>
<a href="#l25.1007"></a><span id="l25.1007" class="difflineminus">-    return @retval;</span>
<a href="#l25.1008"></a><span id="l25.1008" class="difflineminus">-</span>
<a href="#l25.1009"></a><span id="l25.1009" class="difflineminus">-}</span>
<a href="#l25.1010"></a><span id="l25.1010" class="difflineminus">-</span>
<a href="#l25.1011"></a><span id="l25.1011" class="difflineminus">-#</span>
<a href="#l25.1012"></a><span id="l25.1012" class="difflineminus">-# Grovels through $suite_path, searching for *all* test files.  Used when the</span>
<a href="#l25.1013"></a><span id="l25.1013" class="difflineminus">-# user doesn't supply a test list.</span>
<a href="#l25.1014"></a><span id="l25.1014" class="difflineminus">-#</span>
<a href="#l25.1015"></a><span id="l25.1015" class="difflineminus">-sub get_default_test_list {</span>
<a href="#l25.1016"></a><span id="l25.1016" class="difflineminus">-    my ($suite_path) = @_;</span>
<a href="#l25.1017"></a><span id="l25.1017" class="difflineminus">-    my @suite_list = &amp;get_subdirs($suite_path);</span>
<a href="#l25.1018"></a><span id="l25.1018" class="difflineminus">-    my $suite;</span>
<a href="#l25.1019"></a><span id="l25.1019" class="difflineminus">-    my @retval;</span>
<a href="#l25.1020"></a><span id="l25.1020" class="difflineminus">-</span>
<a href="#l25.1021"></a><span id="l25.1021" class="difflineminus">-    foreach $suite (@suite_list) {</span>
<a href="#l25.1022"></a><span id="l25.1022" class="difflineminus">-        my @test_dir_list = get_subdirs ($suite_path . $suite);</span>
<a href="#l25.1023"></a><span id="l25.1023" class="difflineminus">-        my $test_dir;</span>
<a href="#l25.1024"></a><span id="l25.1024" class="difflineminus">-</span>
<a href="#l25.1025"></a><span id="l25.1025" class="difflineminus">-        foreach $test_dir (@test_dir_list) {</span>
<a href="#l25.1026"></a><span id="l25.1026" class="difflineminus">-            my @test_list = get_js_files ($suite_path . $suite . $path_sep .</span>
<a href="#l25.1027"></a><span id="l25.1027" class="difflineminus">-                                          $test_dir);</span>
<a href="#l25.1028"></a><span id="l25.1028" class="difflineminus">-            my $test;</span>
<a href="#l25.1029"></a><span id="l25.1029" class="difflineminus">-</span>
<a href="#l25.1030"></a><span id="l25.1030" class="difflineminus">-            foreach $test (@test_list) {</span>
<a href="#l25.1031"></a><span id="l25.1031" class="difflineminus">-                $retval[$#retval + 1] = $suite . $path_sep . $test_dir .</span>
<a href="#l25.1032"></a><span id="l25.1032" class="difflineminus">-                  $path_sep . $test;</span>
<a href="#l25.1033"></a><span id="l25.1033" class="difflineminus">-            }</span>
<a href="#l25.1034"></a><span id="l25.1034" class="difflineminus">-        }</span>
<a href="#l25.1035"></a><span id="l25.1035" class="difflineminus">-    }</span>
<a href="#l25.1036"></a><span id="l25.1036" class="difflineminus">-</span>
<a href="#l25.1037"></a><span id="l25.1037" class="difflineminus">-    return @retval;</span>
<a href="#l25.1038"></a><span id="l25.1038" class="difflineminus">-</span>
<a href="#l25.1039"></a><span id="l25.1039" class="difflineminus">-}</span>
<a href="#l25.1040"></a><span id="l25.1040" class="difflineminus">-</span>
<a href="#l25.1041"></a><span id="l25.1041" class="difflineminus">-#</span>
<a href="#l25.1042"></a><span id="l25.1042" class="difflineminus">-# generate an output file name based on the date</span>
<a href="#l25.1043"></a><span id="l25.1043" class="difflineminus">-#</span>
<a href="#l25.1044"></a><span id="l25.1044" class="difflineminus">-sub get_tempfile_name {</span>
<a href="#l25.1045"></a><span id="l25.1045" class="difflineminus">-    my ($sec, $min, $hour, $mday, $mon, $year, $wday, $yday, $isdst) =</span>
<a href="#l25.1046"></a><span id="l25.1046" class="difflineminus">-      &amp;get_padded_time (localtime);</span>
<a href="#l25.1047"></a><span id="l25.1047" class="difflineminus">-    my $rv;</span>
<a href="#l25.1048"></a><span id="l25.1048" class="difflineminus">-</span>
<a href="#l25.1049"></a><span id="l25.1049" class="difflineminus">-    if ($os_type ne &quot;MAC&quot;) {</span>
<a href="#l25.1050"></a><span id="l25.1050" class="difflineminus">-        $rv = &quot;results-&quot; . $year . &quot;-&quot; . $mon . &quot;-&quot; . $mday . &quot;-&quot; . $hour .</span>
<a href="#l25.1051"></a><span id="l25.1051" class="difflineminus">-          $min . $sec . &quot;-&quot; . $opt_engine_type;</span>
<a href="#l25.1052"></a><span id="l25.1052" class="difflineminus">-    } else {</span>
<a href="#l25.1053"></a><span id="l25.1053" class="difflineminus">-        $rv = &quot;res-&quot; . $year . $mon . $mday . $hour . $min . $sec . &quot;-&quot; .</span>
<a href="#l25.1054"></a><span id="l25.1054" class="difflineminus">-          $opt_engine_type</span>
<a href="#l25.1055"></a><span id="l25.1055" class="difflineminus">-    }</span>
<a href="#l25.1056"></a><span id="l25.1056" class="difflineminus">-</span>
<a href="#l25.1057"></a><span id="l25.1057" class="difflineminus">-    return $rv . &quot;.html&quot;;</span>
<a href="#l25.1058"></a><span id="l25.1058" class="difflineminus">-}</span>
<a href="#l25.1059"></a><span id="l25.1059" class="difflineminus">-</span>
<a href="#l25.1060"></a><span id="l25.1060" class="difflineminus">-sub get_padded_time {</span>
<a href="#l25.1061"></a><span id="l25.1061" class="difflineminus">-    my ($sec, $min, $hour, $mday, $mon, $year, $wday, $yday, $isdst) = @_;</span>
<a href="#l25.1062"></a><span id="l25.1062" class="difflineminus">-</span>
<a href="#l25.1063"></a><span id="l25.1063" class="difflineminus">-    $mon++;</span>
<a href="#l25.1064"></a><span id="l25.1064" class="difflineminus">-    $mon = &amp;zero_pad($mon);</span>
<a href="#l25.1065"></a><span id="l25.1065" class="difflineminus">-    $year += 1900;</span>
<a href="#l25.1066"></a><span id="l25.1066" class="difflineminus">-    $mday= &amp;zero_pad($mday);</span>
<a href="#l25.1067"></a><span id="l25.1067" class="difflineminus">-    $sec = &amp;zero_pad($sec);</span>
<a href="#l25.1068"></a><span id="l25.1068" class="difflineminus">-    $min = &amp;zero_pad($min);</span>
<a href="#l25.1069"></a><span id="l25.1069" class="difflineminus">-    $hour = &amp;zero_pad($hour);</span>
<a href="#l25.1070"></a><span id="l25.1070" class="difflineminus">-</span>
<a href="#l25.1071"></a><span id="l25.1071" class="difflineminus">-    return ($sec, $min, $hour, $mday, $mon, $year, $wday, $yday, $isdst);</span>
<a href="#l25.1072"></a><span id="l25.1072" class="difflineminus">-</span>
<a href="#l25.1073"></a><span id="l25.1073" class="difflineminus">-}</span>
<a href="#l25.1074"></a><span id="l25.1074" class="difflineminus">-</span>
<a href="#l25.1075"></a><span id="l25.1075" class="difflineminus">-sub zero_pad {</span>
<a href="#l25.1076"></a><span id="l25.1076" class="difflineminus">-    my ($string) = @_;</span>
<a href="#l25.1077"></a><span id="l25.1077" class="difflineminus">-</span>
<a href="#l25.1078"></a><span id="l25.1078" class="difflineminus">-    $string = ($string &lt; 10) ? &quot;0&quot; . $string : $string;</span>
<a href="#l25.1079"></a><span id="l25.1079" class="difflineminus">-    return $string;</span>
<a href="#l25.1080"></a><span id="l25.1080" class="difflineminus">-}</span>
<a href="#l25.1081"></a><span id="l25.1081" class="difflineminus">-</span>
<a href="#l25.1082"></a><span id="l25.1082" class="difflineminus">-sub subtract_arrays {</span>
<a href="#l25.1083"></a><span id="l25.1083" class="difflineminus">-    my ($whole_ref, $part_ref) = @_;</span>
<a href="#l25.1084"></a><span id="l25.1084" class="difflineminus">-    my @whole = @$whole_ref;</span>
<a href="#l25.1085"></a><span id="l25.1085" class="difflineminus">-    my @part = @$part_ref;</span>
<a href="#l25.1086"></a><span id="l25.1086" class="difflineminus">-    my $line;</span>
<a href="#l25.1087"></a><span id="l25.1087" class="difflineminus">-</span>
<a href="#l25.1088"></a><span id="l25.1088" class="difflineminus">-    foreach $line (@part) {</span>
<a href="#l25.1089"></a><span id="l25.1089" class="difflineminus">-        @whole = grep (!/$line/, @whole);</span>
<a href="#l25.1090"></a><span id="l25.1090" class="difflineminus">-    }</span>
<a href="#l25.1091"></a><span id="l25.1091" class="difflineminus">-</span>
<a href="#l25.1092"></a><span id="l25.1092" class="difflineminus">-    return @whole;</span>
<a href="#l25.1093"></a><span id="l25.1093" class="difflineminus">-</span>
<a href="#l25.1094"></a><span id="l25.1094" class="difflineminus">-}</span>
<a href="#l25.1095"></a><span id="l25.1095" class="difflineminus">-</span>
<a href="#l25.1096"></a><span id="l25.1096" class="difflineminus">-#</span>
<a href="#l25.1097"></a><span id="l25.1097" class="difflineminus">-# Convert unix path to mac style.</span>
<a href="#l25.1098"></a><span id="l25.1098" class="difflineminus">-#</span>
<a href="#l25.1099"></a><span id="l25.1099" class="difflineminus">-sub unix_to_mac {</span>
<a href="#l25.1100"></a><span id="l25.1100" class="difflineminus">-    my ($path) = @_;</span>
<a href="#l25.1101"></a><span id="l25.1101" class="difflineminus">-    my @path_elements = split (&quot;/&quot;, $path);</span>
<a href="#l25.1102"></a><span id="l25.1102" class="difflineminus">-    my $rv = &quot;&quot;;</span>
<a href="#l25.1103"></a><span id="l25.1103" class="difflineminus">-    my $i;</span>
<a href="#l25.1104"></a><span id="l25.1104" class="difflineminus">-</span>
<a href="#l25.1105"></a><span id="l25.1105" class="difflineminus">-    foreach $i (0 .. $#path_elements) {</span>
<a href="#l25.1106"></a><span id="l25.1106" class="difflineminus">-        if ($path_elements[$i] eq &quot;.&quot;) {</span>
<a href="#l25.1107"></a><span id="l25.1107" class="difflineminus">-            if (!($rv =~ /\:$/)) {</span>
<a href="#l25.1108"></a><span id="l25.1108" class="difflineminus">-                $rv .= &quot;:&quot;;</span>
<a href="#l25.1109"></a><span id="l25.1109" class="difflineminus">-            }</span>
<a href="#l25.1110"></a><span id="l25.1110" class="difflineminus">-        } elsif ($path_elements[$i] eq &quot;..&quot;) {</span>
<a href="#l25.1111"></a><span id="l25.1111" class="difflineminus">-            if (!($rv =~ /\:$/)) {</span>
<a href="#l25.1112"></a><span id="l25.1112" class="difflineminus">-                $rv .= &quot;::&quot;;</span>
<a href="#l25.1113"></a><span id="l25.1113" class="difflineminus">-            } else {</span>
<a href="#l25.1114"></a><span id="l25.1114" class="difflineminus">-                $rv .= &quot;:&quot;;</span>
<a href="#l25.1115"></a><span id="l25.1115" class="difflineminus">-            }</span>
<a href="#l25.1116"></a><span id="l25.1116" class="difflineminus">-        } elsif ($path_elements[$i] ne &quot;&quot;) {</span>
<a href="#l25.1117"></a><span id="l25.1117" class="difflineminus">-            $rv .= $path_elements[$i] . &quot;:&quot;;</span>
<a href="#l25.1118"></a><span id="l25.1118" class="difflineminus">-        }</span>
<a href="#l25.1119"></a><span id="l25.1119" class="difflineminus">-</span>
<a href="#l25.1120"></a><span id="l25.1120" class="difflineminus">-    }</span>
<a href="#l25.1121"></a><span id="l25.1121" class="difflineminus">-</span>
<a href="#l25.1122"></a><span id="l25.1122" class="difflineminus">-    $rv =~ s/\:$//;</span>
<a href="#l25.1123"></a><span id="l25.1123" class="difflineminus">-</span>
<a href="#l25.1124"></a><span id="l25.1124" class="difflineminus">-    return $rv;</span>
<a href="#l25.1125"></a><span id="l25.1125" class="difflineminus">-}</span>
<a href="#l25.1126"></a><span id="l25.1126" class="difflineminus">-</span>
<a href="#l25.1127"></a><span id="l25.1127" class="difflineminus">-#</span>
<a href="#l25.1128"></a><span id="l25.1128" class="difflineminus">-# Convert unix path to win style.</span>
<a href="#l25.1129"></a><span id="l25.1129" class="difflineminus">-#</span>
<a href="#l25.1130"></a><span id="l25.1130" class="difflineminus">-sub unix_to_win {</span>
<a href="#l25.1131"></a><span id="l25.1131" class="difflineminus">-  my ($path) = @_;</span>
<a href="#l25.1132"></a><span id="l25.1132" class="difflineminus">-</span>
<a href="#l25.1133"></a><span id="l25.1133" class="difflineminus">-  if ($path_sep ne $win_sep) {</span>
<a href="#l25.1134"></a><span id="l25.1134" class="difflineminus">-      $path =~ s/$path_sep/$win_sep/g;</span>
<a href="#l25.1135"></a><span id="l25.1135" class="difflineminus">-  }</span>
<a href="#l25.1136"></a><span id="l25.1136" class="difflineminus">-</span>
<a href="#l25.1137"></a><span id="l25.1137" class="difflineminus">-  # translate cygwin-style paths, since the shells are not linked with cygwin</span>
<a href="#l25.1138"></a><span id="l25.1138" class="difflineminus">-  $path =~ s#^/cygdrive/([a-zA-Z])/#\1:/#;</span>
<a href="#l25.1139"></a><span id="l25.1139" class="difflineminus">-  return $path;</span>
<a href="#l25.1140"></a><span id="l25.1140" class="difflineminus">-}</span>
<a href="#l25.1141"></a><span id="l25.1141" class="difflineminus">-</span>
<a href="#l25.1142"></a><span id="l25.1142" class="difflineminus">-#</span>
<a href="#l25.1143"></a><span id="l25.1143" class="difflineminus">-# Windows shells require &quot;/&quot; or &quot;\&quot; as path separator.</span>
<a href="#l25.1144"></a><span id="l25.1144" class="difflineminus">-# Find out the one used in the current Windows shell.</span>
<a href="#l25.1145"></a><span id="l25.1145" class="difflineminus">-#</span>
<a href="#l25.1146"></a><span id="l25.1146" class="difflineminus">-sub get_win_sep {</span>
<a href="#l25.1147"></a><span id="l25.1147" class="difflineminus">-  my $path = $ENV{&quot;PATH&quot;} || $ENV{&quot;Path&quot;} || $ENV{&quot;path&quot;};</span>
<a href="#l25.1148"></a><span id="l25.1148" class="difflineminus">-  $path =~ /\\|\//;</span>
<a href="#l25.1149"></a><span id="l25.1149" class="difflineminus">-  return $&amp;;</span>
<a href="#l25.1150"></a><span id="l25.1150" class="difflineminus">-}</span>
<a href="#l25.1151"></a><span id="l25.1151" class="difflineminus">-</span>
<a href="#l25.1152"></a><span id="l25.1152" class="difflineminus">-#</span>
<a href="#l25.1153"></a><span id="l25.1153" class="difflineminus">-# Convert unix path to correct style based on platform.</span>
<a href="#l25.1154"></a><span id="l25.1154" class="difflineminus">-#</span>
<a href="#l25.1155"></a><span id="l25.1155" class="difflineminus">-sub xp_path {</span>
<a href="#l25.1156"></a><span id="l25.1156" class="difflineminus">-    my ($path) = @_;</span>
<a href="#l25.1157"></a><span id="l25.1157" class="difflineminus">-</span>
<a href="#l25.1158"></a><span id="l25.1158" class="difflineminus">-    if ($os_type eq &quot;MAC&quot;) {</span>
<a href="#l25.1159"></a><span id="l25.1159" class="difflineminus">-        return &amp;unix_to_mac($path);</span>
<a href="#l25.1160"></a><span id="l25.1160" class="difflineminus">-    } elsif($os_type eq &quot;WIN&quot;) {</span>
<a href="#l25.1161"></a><span id="l25.1161" class="difflineminus">-        return &amp;unix_to_win($path);</span>
<a href="#l25.1162"></a><span id="l25.1162" class="difflineminus">-    } else {</span>
<a href="#l25.1163"></a><span id="l25.1163" class="difflineminus">-        return $path;</span>
<a href="#l25.1164"></a><span id="l25.1164" class="difflineminus">-    }</span>
<a href="#l25.1165"></a><span id="l25.1165" class="difflineminus">-}</span>
<a href="#l25.1166"></a><span id="l25.1166" class="difflineminus">-</span>
<a href="#l25.1167"></a><span id="l25.1167" class="difflineminus">-#</span>
<a href="#l25.1168"></a><span id="l25.1168" class="difflineminus">-# given a directory, return an array of all subdirectories</span>
<a href="#l25.1169"></a><span id="l25.1169" class="difflineminus">-#</span>
<a href="#l25.1170"></a><span id="l25.1170" class="difflineminus">-sub get_subdirs {</span>
<a href="#l25.1171"></a><span id="l25.1171" class="difflineminus">-    my ($dir)  = @_;</span>
<a href="#l25.1172"></a><span id="l25.1172" class="difflineminus">-    my @subdirs;</span>
<a href="#l25.1173"></a><span id="l25.1173" class="difflineminus">-</span>
<a href="#l25.1174"></a><span id="l25.1174" class="difflineminus">-    if ($os_type ne &quot;MAC&quot;) {</span>
<a href="#l25.1175"></a><span id="l25.1175" class="difflineminus">-        if (!($dir =~ /\/$/)) {</span>
<a href="#l25.1176"></a><span id="l25.1176" class="difflineminus">-            $dir = $dir . &quot;/&quot;;</span>
<a href="#l25.1177"></a><span id="l25.1177" class="difflineminus">-        }</span>
<a href="#l25.1178"></a><span id="l25.1178" class="difflineminus">-    } else {</span>
<a href="#l25.1179"></a><span id="l25.1179" class="difflineminus">-        if (!($dir =~ /\:$/)) {</span>
<a href="#l25.1180"></a><span id="l25.1180" class="difflineminus">-            $dir = $dir . &quot;:&quot;;</span>
<a href="#l25.1181"></a><span id="l25.1181" class="difflineminus">-        }</span>
<a href="#l25.1182"></a><span id="l25.1182" class="difflineminus">-    }</span>
<a href="#l25.1183"></a><span id="l25.1183" class="difflineminus">-    opendir (DIR, $dir) || die (&quot;couldn't open directory $dir: $!&quot;);</span>
<a href="#l25.1184"></a><span id="l25.1184" class="difflineminus">-    my @testdir_contents = readdir(DIR);</span>
<a href="#l25.1185"></a><span id="l25.1185" class="difflineminus">-    closedir(DIR);</span>
<a href="#l25.1186"></a><span id="l25.1186" class="difflineminus">-</span>
<a href="#l25.1187"></a><span id="l25.1187" class="difflineminus">-    foreach (@testdir_contents) {</span>
<a href="#l25.1188"></a><span id="l25.1188" class="difflineminus">-        if ((-d ($dir . $_)) &amp;&amp; ($_ ne 'CVS') &amp;&amp; ($_ ne '.') &amp;&amp; ($_ ne '..')) {</span>
<a href="#l25.1189"></a><span id="l25.1189" class="difflineminus">-            @subdirs[$#subdirs + 1] = $_;</span>
<a href="#l25.1190"></a><span id="l25.1190" class="difflineminus">-        }</span>
<a href="#l25.1191"></a><span id="l25.1191" class="difflineminus">-    }</span>
<a href="#l25.1192"></a><span id="l25.1192" class="difflineminus">-</span>
<a href="#l25.1193"></a><span id="l25.1193" class="difflineminus">-    return @subdirs;</span>
<a href="#l25.1194"></a><span id="l25.1194" class="difflineminus">-}</span>
<a href="#l25.1195"></a><span id="l25.1195" class="difflineminus">-</span>
<a href="#l25.1196"></a><span id="l25.1196" class="difflineminus">-#</span>
<a href="#l25.1197"></a><span id="l25.1197" class="difflineminus">-# given a directory, return an array of all the js files that are in it.</span>
<a href="#l25.1198"></a><span id="l25.1198" class="difflineminus">-#</span>
<a href="#l25.1199"></a><span id="l25.1199" class="difflineminus">-sub get_js_files {</span>
<a href="#l25.1200"></a><span id="l25.1200" class="difflineminus">-    my ($test_subdir) = @_;</span>
<a href="#l25.1201"></a><span id="l25.1201" class="difflineminus">-    my (@js_file_array, @subdir_files);</span>
<a href="#l25.1202"></a><span id="l25.1202" class="difflineminus">-</span>
<a href="#l25.1203"></a><span id="l25.1203" class="difflineminus">-    opendir (TEST_SUBDIR, $test_subdir) || die (&quot;couldn't open directory &quot; .</span>
<a href="#l25.1204"></a><span id="l25.1204" class="difflineminus">-                                                &quot;$test_subdir: $!&quot;);</span>
<a href="#l25.1205"></a><span id="l25.1205" class="difflineminus">-    @subdir_files = readdir(TEST_SUBDIR);</span>
<a href="#l25.1206"></a><span id="l25.1206" class="difflineminus">-    closedir( TEST_SUBDIR );</span>
<a href="#l25.1207"></a><span id="l25.1207" class="difflineminus">-</span>
<a href="#l25.1208"></a><span id="l25.1208" class="difflineminus">-    foreach (@subdir_files) {</span>
<a href="#l25.1209"></a><span id="l25.1209" class="difflineminus">-        if ($_ =~ /\.js$/) {</span>
<a href="#l25.1210"></a><span id="l25.1210" class="difflineminus">-            $js_file_array[$#js_file_array+1] = $_;</span>
<a href="#l25.1211"></a><span id="l25.1211" class="difflineminus">-        }</span>
<a href="#l25.1212"></a><span id="l25.1212" class="difflineminus">-    }</span>
<a href="#l25.1213"></a><span id="l25.1213" class="difflineminus">-</span>
<a href="#l25.1214"></a><span id="l25.1214" class="difflineminus">-    return @js_file_array;</span>
<a href="#l25.1215"></a><span id="l25.1215" class="difflineminus">-}</span>
<a href="#l25.1216"></a><span id="l25.1216" class="difflineminus">-</span>
<a href="#l25.1217"></a><span id="l25.1217" class="difflineminus">-sub report_failure {</span>
<a href="#l25.1218"></a><span id="l25.1218" class="difflineminus">-    my ($test, $message, $bug_number) = @_;</span>
<a href="#l25.1219"></a><span id="l25.1219" class="difflineminus">-    my $bug_line = &quot;&quot;;</span>
<a href="#l25.1220"></a><span id="l25.1220" class="difflineminus">-</span>
<a href="#l25.1221"></a><span id="l25.1221" class="difflineminus">-    $failures_reported++;</span>
<a href="#l25.1222"></a><span id="l25.1222" class="difflineminus">-</span>
<a href="#l25.1223"></a><span id="l25.1223" class="difflineminus">-    $message =~ s/\n+/\n/g;</span>
<a href="#l25.1224"></a><span id="l25.1224" class="difflineminus">-    $test =~ s/\:/\//g;</span>
<a href="#l25.1225"></a><span id="l25.1225" class="difflineminus">-</span>
<a href="#l25.1226"></a><span id="l25.1226" class="difflineminus">-    if ($opt_console_failures) {</span>
<a href="#l25.1227"></a><span id="l25.1227" class="difflineminus">-        if($bug_number) {</span>
<a href="#l25.1228"></a><span id="l25.1228" class="difflineminus">-            print STDERR (&quot;*-* Testcase $test failed:\nBug Number $bug_number&quot;.</span>
<a href="#l25.1229"></a><span id="l25.1229" class="difflineminus">-                          &quot;\n$message\n&quot;);</span>
<a href="#l25.1230"></a><span id="l25.1230" class="difflineminus">-        } else {</span>
<a href="#l25.1231"></a><span id="l25.1231" class="difflineminus">-            print STDERR (&quot;*-* Testcase $test failed:\n$message\n&quot;);</span>
<a href="#l25.1232"></a><span id="l25.1232" class="difflineminus">-        }</span>
<a href="#l25.1233"></a><span id="l25.1233" class="difflineminus">-    }</span>
<a href="#l25.1234"></a><span id="l25.1234" class="difflineminus">-</span>
<a href="#l25.1235"></a><span id="l25.1235" class="difflineminus">-    $message =~ s/\n/&lt;br&gt;\n/g;</span>
<a href="#l25.1236"></a><span id="l25.1236" class="difflineminus">-    $html .= &quot;&lt;a name='failure$failures_reported'&gt;&lt;/a&gt;&quot;;</span>
<a href="#l25.1237"></a><span id="l25.1237" class="difflineminus">-</span>
<a href="#l25.1238"></a><span id="l25.1238" class="difflineminus">-    if ($bug_number) {</span>
<a href="#l25.1239"></a><span id="l25.1239" class="difflineminus">-        my $bug_url = ($bug_number =~ /^\d+$/) ? &quot;$opt_bug_url$bug_number&quot; : $bug_number;</span>
<a href="#l25.1240"></a><span id="l25.1240" class="difflineminus">-        $bug_line = &quot;&lt;a href='$bug_url' target='other_window'&gt;&quot;.</span>
<a href="#l25.1241"></a><span id="l25.1241" class="difflineminus">-                    &quot;Bug Number $bug_number&lt;/a&gt;&quot;;</span>
<a href="#l25.1242"></a><span id="l25.1242" class="difflineminus">-    }</span>
<a href="#l25.1243"></a><span id="l25.1243" class="difflineminus">-</span>
<a href="#l25.1244"></a><span id="l25.1244" class="difflineminus">-    if ($opt_lxr_url) {</span>
<a href="#l25.1245"></a><span id="l25.1245" class="difflineminus">-        $test =~ /\/?([^\/]+\/[^\/]+\/[^\/]+)$/;</span>
<a href="#l25.1246"></a><span id="l25.1246" class="difflineminus">-        $test = $1;</span>
<a href="#l25.1247"></a><span id="l25.1247" class="difflineminus">-        $html .= &quot;&lt;dd&gt;&lt;b&gt;&quot;.</span>
<a href="#l25.1248"></a><span id="l25.1248" class="difflineminus">-          &quot;Testcase &lt;a target='other_window' href='$opt_lxr_url$test'&gt;$1&lt;/a&gt; &quot; .</span>
<a href="#l25.1249"></a><span id="l25.1249" class="difflineminus">-            &quot;failed&lt;/b&gt; $bug_line&lt;br&gt;\n&quot;;</span>
<a href="#l25.1250"></a><span id="l25.1250" class="difflineminus">-    } else {</span>
<a href="#l25.1251"></a><span id="l25.1251" class="difflineminus">-        $html .= &quot;&lt;dd&gt;&lt;b&gt;&quot;.</span>
<a href="#l25.1252"></a><span id="l25.1252" class="difflineminus">-          &quot;Testcase $test failed&lt;/b&gt; $bug_line&lt;br&gt;\n&quot;;</span>
<a href="#l25.1253"></a><span id="l25.1253" class="difflineminus">-    }</span>
<a href="#l25.1254"></a><span id="l25.1254" class="difflineminus">-</span>
<a href="#l25.1255"></a><span id="l25.1255" class="difflineminus">-    $html .= &quot; [ &quot;;</span>
<a href="#l25.1256"></a><span id="l25.1256" class="difflineminus">-    if ($failures_reported &gt; 1) {</span>
<a href="#l25.1257"></a><span id="l25.1257" class="difflineminus">-        $html .= &quot;&lt;a href='#failure&quot; . ($failures_reported - 1) . &quot;'&gt;&quot; .</span>
<a href="#l25.1258"></a><span id="l25.1258" class="difflineminus">-          &quot;Previous Failure&lt;/a&gt; | &quot;;</span>
<a href="#l25.1259"></a><span id="l25.1259" class="difflineminus">-    }</span>
<a href="#l25.1260"></a><span id="l25.1260" class="difflineminus">-</span>
<a href="#l25.1261"></a><span id="l25.1261" class="difflineminus">-    $html .= &quot;&lt;a href='#failure&quot; . ($failures_reported + 1) . &quot;'&gt;&quot; .</span>
<a href="#l25.1262"></a><span id="l25.1262" class="difflineminus">-      &quot;Next Failure&lt;/a&gt; | &quot; .</span>
<a href="#l25.1263"></a><span id="l25.1263" class="difflineminus">-        &quot;&lt;a href='#tippy_top'&gt;Top of Page&lt;/a&gt; ]&lt;br&gt;\n&quot; .</span>
<a href="#l25.1264"></a><span id="l25.1264" class="difflineminus">-          &quot;&lt;tt&gt;$message&lt;/tt&gt;&lt;br&gt;\n&quot;;</span>
<a href="#l25.1265"></a><span id="l25.1265" class="difflineminus">-</span>
<a href="#l25.1266"></a><span id="l25.1266" class="difflineminus">-    @failed_tests[$#failed_tests + 1] = $test;</span>
<a href="#l25.1267"></a><span id="l25.1267" class="difflineminus">-</span>
<a href="#l25.1268"></a><span id="l25.1268" class="difflineminus">-}</span>
<a href="#l25.1269"></a><span id="l25.1269" class="difflineminus">-</span>
<a href="#l25.1270"></a><span id="l25.1270" class="difflineminus">-sub dd {</span>
<a href="#l25.1271"></a><span id="l25.1271" class="difflineminus">-</span>
<a href="#l25.1272"></a><span id="l25.1272" class="difflineminus">-    if ($opt_trace) {</span>
<a href="#l25.1273"></a><span id="l25.1273" class="difflineminus">-        print (&quot;-*- &quot;, @_ , &quot;\n&quot;);</span>
<a href="#l25.1274"></a><span id="l25.1274" class="difflineminus">-    }</span>
<a href="#l25.1275"></a><span id="l25.1275" class="difflineminus">-</span>
<a href="#l25.1276"></a><span id="l25.1276" class="difflineminus">-}</span>
<a href="#l25.1277"></a><span id="l25.1277" class="difflineminus">-</span>
<a href="#l25.1278"></a><span id="l25.1278" class="difflineminus">-sub status {</span>
<a href="#l25.1279"></a><span id="l25.1279" class="difflineminus">-</span>
<a href="#l25.1280"></a><span id="l25.1280" class="difflineminus">-    print (&quot;-#- &quot;, @_ , &quot;\n&quot;);</span>
<a href="#l25.1281"></a><span id="l25.1281" class="difflineminus">-</span>
<a href="#l25.1282"></a><span id="l25.1282" class="difflineminus">-}</span>
<a href="#l25.1283"></a><span id="l25.1283" class="difflineminus">-</span>
<a href="#l25.1284"></a><span id="l25.1284" class="difflineminus">-sub int_handler {</span>
<a href="#l25.1285"></a><span id="l25.1285" class="difflineminus">-    my $resp;</span>
<a href="#l25.1286"></a><span id="l25.1286" class="difflineminus">-</span>
<a href="#l25.1287"></a><span id="l25.1287" class="difflineminus">-    do {</span>
<a href="#l25.1288"></a><span id="l25.1288" class="difflineminus">-        print (&quot;\n*** User Break: Just [Q]uit, Quit and [R]eport, [C]ontinue ?&quot;);</span>
<a href="#l25.1289"></a><span id="l25.1289" class="difflineminus">-        $resp = &lt;STDIN&gt;;</span>
<a href="#l25.1290"></a><span id="l25.1290" class="difflineminus">-    } until ($resp =~ /[QqRrCc]/);</span>
<a href="#l25.1291"></a><span id="l25.1291" class="difflineminus">-</span>
<a href="#l25.1292"></a><span id="l25.1292" class="difflineminus">-    if ($resp =~ /[Qq]/) {</span>
<a href="#l25.1293"></a><span id="l25.1293" class="difflineminus">-        print (&quot;User Exit.  No results were generated.\n&quot;);</span>
<a href="#l25.1294"></a><span id="l25.1294" class="difflineminus">-        exit;</span>
<a href="#l25.1295"></a><span id="l25.1295" class="difflineminus">-    } elsif ($resp =~ /[Rr]/) {</span>
<a href="#l25.1296"></a><span id="l25.1296" class="difflineminus">-        $user_exit = 1;</span>
<a href="#l25.1297"></a><span id="l25.1297" class="difflineminus">-    }</span>
<a href="#l25.1298"></a><span id="l25.1298" class="difflineminus">-</span>
<a href="#l25.1299"></a><span id="l25.1299" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1">old mode 100644</span>
<a href="#l26.2"></a><span id="l26.2">new mode 100755</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineminus">--- a/client.py</span>
<a href="#l26.4"></a><span id="l26.4" class="difflineplus">+++ b/client.py</span>
<a href="#l26.5"></a><span id="l26.5" class="difflineat">@@ -1,9 +1,9 @@</span>
<a href="#l26.6"></a><span id="l26.6" class="difflineminus">-#!/usr/bin/python</span>
<a href="#l26.7"></a><span id="l26.7" class="difflineplus">+#!/usr/bin/env python</span>
<a href="#l26.8"></a><span id="l26.8"> </span>
<a href="#l26.9"></a><span id="l26.9"> LDAPCSDK_CO_TAG = 'LDAPCSDK_6_0_6B_MOZILLA_RTM'</span>
<a href="#l26.10"></a><span id="l26.10"> </span>
<a href="#l26.11"></a><span id="l26.11"> CHATZILLA_CO_TAG = 'HEAD'</span>
<a href="#l26.12"></a><span id="l26.12"> </span>
<a href="#l26.13"></a><span id="l26.13"> LDAPCSDK_DIRS = ('directory/c-sdk',)</span>
<a href="#l26.14"></a><span id="l26.14"> </span>
<a href="#l26.15"></a><span id="l26.15"> CHATZILLA_DIRS = ('extensions/irc',)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l27.1"></a><span id="l27.1" class="difflineminus">--- a/mail/Makefile.in</span>
<a href="#l27.2"></a><span id="l27.2" class="difflineplus">+++ b/mail/Makefile.in</span>
<a href="#l27.3"></a><span id="l27.3" class="difflineat">@@ -38,17 +38,17 @@</span>
<a href="#l27.4"></a><span id="l27.4"> DEPTH		= ..</span>
<a href="#l27.5"></a><span id="l27.5"> topsrcdir	= @top_srcdir@</span>
<a href="#l27.6"></a><span id="l27.6"> srcdir		= @srcdir@</span>
<a href="#l27.7"></a><span id="l27.7"> VPATH		= @srcdir@</span>
<a href="#l27.8"></a><span id="l27.8"> </span>
<a href="#l27.9"></a><span id="l27.9"> include $(topsrcdir)/config/config.mk</span>
<a href="#l27.10"></a><span id="l27.10"> </span>
<a href="#l27.11"></a><span id="l27.11"> # app is always last as it packages up the built files on mac</span>
<a href="#l27.12"></a><span id="l27.12" class="difflineminus">-DIRS		= base locales components extensions themes app</span>
<a href="#l27.13"></a><span id="l27.13" class="difflineplus">+DIRS		= base locales components extensions steel themes app</span>
<a href="#l27.14"></a><span id="l27.14"> </span>
<a href="#l27.15"></a><span id="l27.15"> ifeq ($(OS_ARCH),WINNT)</span>
<a href="#l27.16"></a><span id="l27.16"> ifdef MOZ_INSTALLER</span>
<a href="#l27.17"></a><span id="l27.17"> # though some lasts are more last than others</span>
<a href="#l27.18"></a><span id="l27.18"> DIRS += installer/windows</span>
<a href="#l27.19"></a><span id="l27.19"> endif</span>
<a href="#l27.20"></a><span id="l27.20"> endif</span>
<a href="#l27.21"></a><span id="l27.21"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l28.1"></a><span id="l28.1" class="difflineminus">--- a/mail/app/profile/all-thunderbird.js</span>
<a href="#l28.2"></a><span id="l28.2" class="difflineplus">+++ b/mail/app/profile/all-thunderbird.js</span>
<a href="#l28.3"></a><span id="l28.3" class="difflineat">@@ -253,38 +253,16 @@ pref(&quot;mail.default_html_action&quot;, 3);</span>
<a href="#l28.4"></a><span id="l28.4"> /////////////////////////////////////////////////////////////////</span>
<a href="#l28.5"></a><span id="l28.5"> // End seamonkey suite mailnews.js pref overrides</span>
<a href="#l28.6"></a><span id="l28.6"> ///////////////////////////////////////////////////////////////// </span>
<a href="#l28.7"></a><span id="l28.7"> </span>
<a href="#l28.8"></a><span id="l28.8"> /////////////////////////////////////////////////////////////////</span>
<a href="#l28.9"></a><span id="l28.9"> // Overrides for generic app behavior from the seamonkey suite's all.js</span>
<a href="#l28.10"></a><span id="l28.10"> /////////////////////////////////////////////////////////////////</span>
<a href="#l28.11"></a><span id="l28.11"> </span>
<a href="#l28.12"></a><span id="l28.12" class="difflineminus">-// l12n and i18n</span>
<a href="#l28.13"></a><span id="l28.13" class="difflineminus">-pref(&quot;intl.charsetmenu.mailedit&quot;, &quot;chrome://global/locale/intl.properties&quot;);</span>
<a href="#l28.14"></a><span id="l28.14" class="difflineminus">-pref(&quot;intl.accept_languages&quot;, &quot;chrome://global/locale/intl.properties&quot;);</span>
<a href="#l28.15"></a><span id="l28.15" class="difflineminus">-pref(&quot;intl.charsetmenu.browser.static&quot;, &quot;chrome://global/locale/intl.properties&quot;);</span>
<a href="#l28.16"></a><span id="l28.16" class="difflineminus">-pref(&quot;intl.charsetmenu.browser.more1&quot;,  &quot;chrome://global/locale/intl.properties&quot;);</span>
<a href="#l28.17"></a><span id="l28.17" class="difflineminus">-pref(&quot;intl.charsetmenu.browser.more2&quot;,  &quot;chrome://global/locale/intl.properties&quot;);</span>
<a href="#l28.18"></a><span id="l28.18" class="difflineminus">-pref(&quot;intl.charsetmenu.browser.more3&quot;,  &quot;chrome://global/locale/intl.properties&quot;);</span>
<a href="#l28.19"></a><span id="l28.19" class="difflineminus">-pref(&quot;intl.charsetmenu.browser.more4&quot;,  &quot;chrome://global/locale/intl.properties&quot;);</span>
<a href="#l28.20"></a><span id="l28.20" class="difflineminus">-pref(&quot;intl.charsetmenu.browser.more5&quot;,  &quot;chrome://global/locale/intl.properties&quot;);</span>
<a href="#l28.21"></a><span id="l28.21" class="difflineminus">-pref(&quot;intl.charsetmenu.browser.unicode&quot;,  &quot;chrome://global/locale/intl.properties&quot;);</span>
<a href="#l28.22"></a><span id="l28.22" class="difflineminus">-pref(&quot;intl.charset.detector&quot;, &quot;chrome://global/locale/intl.properties&quot;);</span>
<a href="#l28.23"></a><span id="l28.23" class="difflineminus">-pref(&quot;intl.charset.default&quot;,  &quot;chrome://global-platform/locale/intl.properties&quot;);</span>
<a href="#l28.24"></a><span id="l28.24" class="difflineminus">-pref(&quot;font.language.group&quot;, &quot;chrome://global/locale/intl.properties&quot;);</span>
<a href="#l28.25"></a><span id="l28.25" class="difflineminus">-pref(&quot;intl.menuitems.alwaysappendaccesskeys&quot;,&quot;chrome://global/locale/intl.properties&quot;);</span>
<a href="#l28.26"></a><span id="l28.26" class="difflineminus">-pref(&quot;intl.menuitems.insertseparatorbeforeaccesskeys&quot;,&quot;chrome://global/locale/intl.properties&quot;);</span>
<a href="#l28.27"></a><span id="l28.27" class="difflineminus">-</span>
<a href="#l28.28"></a><span id="l28.28" class="difflineminus">-pref(&quot;signon.rememberSignons&quot;,              true);</span>
<a href="#l28.29"></a><span id="l28.29" class="difflineminus">-pref(&quot;signon.expireMasterPassword&quot;,         false);</span>
<a href="#l28.30"></a><span id="l28.30" class="difflineminus">-pref(&quot;signon.SignonFileName&quot;,               &quot;signons.txt&quot;);</span>
<a href="#l28.31"></a><span id="l28.31" class="difflineminus">-pref(&quot;signon.SignonFileName2&quot;,              &quot;signons2.txt&quot;);</span>
<a href="#l28.32"></a><span id="l28.32" class="difflineminus">-pref(&quot;signon.SignonFileName3&quot;,              &quot;signons3.txt&quot;);</span>
<a href="#l28.33"></a><span id="l28.33" class="difflineminus">-</span>
<a href="#l28.34"></a><span id="l28.34"> pref(&quot;browser.hiddenWindowChromeURL&quot;, &quot;chrome://messenger/content/hiddenWindow.xul&quot;);</span>
<a href="#l28.35"></a><span id="l28.35"> </span>
<a href="#l28.36"></a><span id="l28.36"> pref(&quot;offline.startup_state&quot;,            2);</span>
<a href="#l28.37"></a><span id="l28.37"> // 0 Ask before sending unsent messages when going online</span>
<a href="#l28.38"></a><span id="l28.38"> // 1 Always send unsent messages when going online</span>
<a href="#l28.39"></a><span id="l28.39"> // 2 Never send unsent messages when going online</span>
<a href="#l28.40"></a><span id="l28.40"> pref(&quot;offline.send.unsent_messages&quot;,            0);</span>
<a href="#l28.41"></a><span id="l28.41"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l29.1"></a><span id="l29.1" class="difflineminus">--- a/mail/base/content/FilterListDialog.js</span>
<a href="#l29.2"></a><span id="l29.2" class="difflineplus">+++ b/mail/base/content/FilterListDialog.js</span>
<a href="#l29.3"></a><span id="l29.3" class="difflineat">@@ -145,17 +145,17 @@ function CanRunFiltersAfterTheFact(aServ</span>
<a href="#l29.4"></a><span id="l29.4"> </span>
<a href="#l29.5"></a><span id="l29.5"> // roots the tree at the specified folder</span>
<a href="#l29.6"></a><span id="l29.6"> function setFolder(msgFolder)</span>
<a href="#l29.7"></a><span id="l29.7"> {</span>
<a href="#l29.8"></a><span id="l29.8">    if (msgFolder == gCurrentFolder)</span>
<a href="#l29.9"></a><span id="l29.9">      return;</span>
<a href="#l29.10"></a><span id="l29.10"> </span>
<a href="#l29.11"></a><span id="l29.11">    //Calling getFilterList will detect any errors in rules.dat, backup the file, and alert the user</span>
<a href="#l29.12"></a><span id="l29.12" class="difflineminus">-   var filterList = msgFolder.getFilterList(gFilterListMsgWindow);</span>
<a href="#l29.13"></a><span id="l29.13" class="difflineplus">+   var filterList = msgFolder.getEditableFilterList(gFilterListMsgWindow);</span>
<a href="#l29.14"></a><span id="l29.14">    rebuildFilterList(filterList);</span>
<a href="#l29.15"></a><span id="l29.15"> </span>
<a href="#l29.16"></a><span id="l29.16">    // Select the first item in the list, if there is one.</span>
<a href="#l29.17"></a><span id="l29.17">    var list = document.getElementById(&quot;filterList&quot;);</span>
<a href="#l29.18"></a><span id="l29.18">    if (list.getRowCount())</span>
<a href="#l29.19"></a><span id="l29.19">      list.selectItem(list.getItemAtIndex(0));</span>
<a href="#l29.20"></a><span id="l29.20"> </span>
<a href="#l29.21"></a><span id="l29.21">    // root the folder picker to this server</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l30.1"></a><span id="l30.1" class="difflineminus">--- a/mail/base/content/SearchDialog.js</span>
<a href="#l30.2"></a><span id="l30.2" class="difflineplus">+++ b/mail/base/content/SearchDialog.js</span>
<a href="#l30.3"></a><span id="l30.3" class="difflineat">@@ -1,10 +1,9 @@</span>
<a href="#l30.4"></a><span id="l30.4" class="difflineminus">-/* -*- Mode: Java; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*-</span>
<a href="#l30.5"></a><span id="l30.5" class="difflineminus">- * ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l30.6"></a><span id="l30.6" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l30.7"></a><span id="l30.7">  * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l30.8"></a><span id="l30.8">  *</span>
<a href="#l30.9"></a><span id="l30.9">  * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l30.10"></a><span id="l30.10">  * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l30.11"></a><span id="l30.11">  * the License. You may obtain a copy of the License at</span>
<a href="#l30.12"></a><span id="l30.12">  * http://www.mozilla.org/MPL/</span>
<a href="#l30.13"></a><span id="l30.13">  *</span>
<a href="#l30.14"></a><span id="l30.14">  * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l30.15"></a><span id="l30.15" class="difflineat">@@ -17,49 +16,47 @@</span>
<a href="#l30.16"></a><span id="l30.16">  *</span>
<a href="#l30.17"></a><span id="l30.17">  * The Initial Developer of the Original Code is</span>
<a href="#l30.18"></a><span id="l30.18">  * Netscape Communications Corporation.</span>
<a href="#l30.19"></a><span id="l30.19">  * Portions created by the Initial Developer are Copyright (C) 1998-1999</span>
<a href="#l30.20"></a><span id="l30.20">  * the Initial Developer. All Rights Reserved.</span>
<a href="#l30.21"></a><span id="l30.21">  *</span>
<a href="#l30.22"></a><span id="l30.22">  * Contributor(s):</span>
<a href="#l30.23"></a><span id="l30.23">  *   Håkan Waara &lt;hwaara@chello.se&gt;</span>
<a href="#l30.24"></a><span id="l30.24" class="difflineplus">+ *   Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a href="#l30.25"></a><span id="l30.25">  *</span>
<a href="#l30.26"></a><span id="l30.26">  * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l30.27"></a><span id="l30.27">  * either of the GNU General Public License Version 2 or later (the &quot;GPL&quot;),</span>
<a href="#l30.28"></a><span id="l30.28">  * or the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l30.29"></a><span id="l30.29">  * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l30.30"></a><span id="l30.30">  * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l30.31"></a><span id="l30.31">  * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l30.32"></a><span id="l30.32">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l30.33"></a><span id="l30.33">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l30.34"></a><span id="l30.34">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l30.35"></a><span id="l30.35">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l30.36"></a><span id="l30.36">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l30.37"></a><span id="l30.37">  *</span>
<a href="#l30.38"></a><span id="l30.38">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l30.39"></a><span id="l30.39"> </span>
<a href="#l30.40"></a><span id="l30.40" class="difflineminus">-var searchSessionContractID = &quot;@mozilla.org/messenger/searchSession;1&quot;;</span>
<a href="#l30.41"></a><span id="l30.41" class="difflineminus">-var gSearchView;</span>
<a href="#l30.42"></a><span id="l30.42" class="difflineminus">-var gSearchSession;</span>
<a href="#l30.43"></a><span id="l30.43"> var gCurrentFolder;</span>
<a href="#l30.44"></a><span id="l30.44"> </span>
<a href="#l30.45"></a><span id="l30.45" class="difflineminus">-var nsIMsgFolder = Components.interfaces.nsIMsgFolder;</span>
<a href="#l30.46"></a><span id="l30.46" class="difflineplus">+var gFolderDisplay;</span>
<a href="#l30.47"></a><span id="l30.47" class="difflineplus">+// Although we don't display messages, we have a message display object to</span>
<a href="#l30.48"></a><span id="l30.48" class="difflineplus">+//  simplify our code.  It's just always disabled.</span>
<a href="#l30.49"></a><span id="l30.49" class="difflineplus">+var gMessageDisplay;</span>
<a href="#l30.50"></a><span id="l30.50" class="difflineplus">+</span>
<a href="#l30.51"></a><span id="l30.51"> var nsIMsgWindow = Components.interfaces.nsIMsgWindow;</span>
<a href="#l30.52"></a><span id="l30.52" class="difflineminus">-var nsIMsgRDFDataSource = Components.interfaces.nsIMsgRDFDataSource;</span>
<a href="#l30.53"></a><span id="l30.53" class="difflineminus">-var nsMsgSearchScope = Components.interfaces.nsMsgSearchScope;</span>
<a href="#l30.54"></a><span id="l30.54"> </span>
<a href="#l30.55"></a><span id="l30.55" class="difflineminus">-var gFolderDatasource;</span>
<a href="#l30.56"></a><span id="l30.56"> var gFolderPicker;</span>
<a href="#l30.57"></a><span id="l30.57"> var gStatusFeedback;</span>
<a href="#l30.58"></a><span id="l30.58"> var gTimelineEnabled = false;</span>
<a href="#l30.59"></a><span id="l30.59"> var gMessengerBundle = null;</span>
<a href="#l30.60"></a><span id="l30.60"> var RDF;</span>
<a href="#l30.61"></a><span id="l30.61"> var gSearchBundle;</span>
<a href="#l30.62"></a><span id="l30.62" class="difflineminus">-var gNextMessageViewIndexAfterDelete = -2;</span>
<a href="#l30.63"></a><span id="l30.63"> </span>
<a href="#l30.64"></a><span id="l30.64"> // Datasource search listener -- made global as it has to be registered</span>
<a href="#l30.65"></a><span id="l30.65"> // and unregistered in different functions.</span>
<a href="#l30.66"></a><span id="l30.66"> var gDataSourceSearchListener;</span>
<a href="#l30.67"></a><span id="l30.67"> var gViewSearchListener;</span>
<a href="#l30.68"></a><span id="l30.68"> </span>
<a href="#l30.69"></a><span id="l30.69"> var gSearchStopButton;</span>
<a href="#l30.70"></a><span id="l30.70"> </span>
<a href="#l30.71"></a><span id="l30.71" class="difflineat">@@ -84,34 +81,35 @@ var nsSearchResultsController =</span>
<a href="#l30.72"></a><span id="l30.72">     },</span>
<a href="#l30.73"></a><span id="l30.73"> </span>
<a href="#l30.74"></a><span id="l30.74">     // this controller only handles commands</span>
<a href="#l30.75"></a><span id="l30.75">     // that rely on items being selected in</span>
<a href="#l30.76"></a><span id="l30.76">     // the search results pane.</span>
<a href="#l30.77"></a><span id="l30.77">     isCommandEnabled: function(command)</span>
<a href="#l30.78"></a><span id="l30.78">     {</span>
<a href="#l30.79"></a><span id="l30.79">         var enabled = true;</span>
<a href="#l30.80"></a><span id="l30.80" class="difflineminus">-        </span>
<a href="#l30.81"></a><span id="l30.81" class="difflineminus">-        switch (command) { </span>
<a href="#l30.82"></a><span id="l30.82" class="difflineplus">+</span>
<a href="#l30.83"></a><span id="l30.83" class="difflineplus">+        switch (command) {</span>
<a href="#l30.84"></a><span id="l30.84">           case &quot;goto_folder_button&quot;:</span>
<a href="#l30.85"></a><span id="l30.85">             if (GetNumSelectedMessages() != 1)</span>
<a href="#l30.86"></a><span id="l30.86">               enabled = false;</span>
<a href="#l30.87"></a><span id="l30.87">             break;</span>
<a href="#l30.88"></a><span id="l30.88">           case &quot;cmd_delete&quot;:</span>
<a href="#l30.89"></a><span id="l30.89">           case &quot;cmd_shiftDelete&quot;:</span>
<a href="#l30.90"></a><span id="l30.90">           case &quot;button_delete&quot;:</span>
<a href="#l30.91"></a><span id="l30.91">             // this assumes that advanced searches don't cross accounts</span>
<a href="#l30.92"></a><span id="l30.92" class="difflineminus">-            if (GetNumSelectedMessages() &lt;= 0 || isNewsURI(gSearchView.getURIForViewIndex(0)))</span>
<a href="#l30.93"></a><span id="l30.93" class="difflineplus">+            if (GetNumSelectedMessages() &lt;= 0 ||</span>
<a href="#l30.94"></a><span id="l30.94" class="difflineplus">+                isNewsURI(gFolderDisplay.view.dbView.getURIForViewIndex(0)))</span>
<a href="#l30.95"></a><span id="l30.95">               enabled = false;</span>
<a href="#l30.96"></a><span id="l30.96">             break;</span>
<a href="#l30.97"></a><span id="l30.97">           case &quot;saveas_vf_button&quot;:</span>
<a href="#l30.98"></a><span id="l30.98">               // need someway to see if there are any search criteria...</span>
<a href="#l30.99"></a><span id="l30.99">               return true;</span>
<a href="#l30.100"></a><span id="l30.100">           case &quot;cmd_selectAll&quot;:</span>
<a href="#l30.101"></a><span id="l30.101" class="difflineminus">-            return GetDBView() != null;              </span>
<a href="#l30.102"></a><span id="l30.102" class="difflineplus">+            return true;</span>
<a href="#l30.103"></a><span id="l30.103">           default:</span>
<a href="#l30.104"></a><span id="l30.104">             if (GetNumSelectedMessages() &lt;= 0)</span>
<a href="#l30.105"></a><span id="l30.105">               enabled = false;</span>
<a href="#l30.106"></a><span id="l30.106">             break;</span>
<a href="#l30.107"></a><span id="l30.107">         }</span>
<a href="#l30.108"></a><span id="l30.108"> </span>
<a href="#l30.109"></a><span id="l30.109">         return enabled;</span>
<a href="#l30.110"></a><span id="l30.110">     },</span>
<a href="#l30.111"></a><span id="l30.111" class="difflineat">@@ -137,230 +135,218 @@ var nsSearchResultsController =</span>
<a href="#l30.112"></a><span id="l30.112"> </span>
<a href="#l30.113"></a><span id="l30.113">         case &quot;saveas_vf_button&quot;:</span>
<a href="#l30.114"></a><span id="l30.114">             saveAsVirtualFolder();</span>
<a href="#l30.115"></a><span id="l30.115">             return true;</span>
<a href="#l30.116"></a><span id="l30.116"> </span>
<a href="#l30.117"></a><span id="l30.117">         case &quot;cmd_selectAll&quot;:</span>
<a href="#l30.118"></a><span id="l30.118">             // move the focus to the search results pane</span>
<a href="#l30.119"></a><span id="l30.119">             GetThreadTree().focus();</span>
<a href="#l30.120"></a><span id="l30.120" class="difflineminus">-            GetDBView().doCommand(nsMsgViewCommandType.selectAll)</span>
<a href="#l30.121"></a><span id="l30.121" class="difflineplus">+            gFolderDisplay.doCommand(nsMsgViewCommandType.selectAll);</span>
<a href="#l30.122"></a><span id="l30.122">             return true;</span>
<a href="#l30.123"></a><span id="l30.123" class="difflineminus">-                            </span>
<a href="#l30.124"></a><span id="l30.124" class="difflineplus">+</span>
<a href="#l30.125"></a><span id="l30.125">         default:</span>
<a href="#l30.126"></a><span id="l30.126">             return false;</span>
<a href="#l30.127"></a><span id="l30.127">         }</span>
<a href="#l30.128"></a><span id="l30.128"> </span>
<a href="#l30.129"></a><span id="l30.129">     },</span>
<a href="#l30.130"></a><span id="l30.130"> </span>
<a href="#l30.131"></a><span id="l30.131">     onEvent: function(event)</span>
<a href="#l30.132"></a><span id="l30.132">     {</span>
<a href="#l30.133"></a><span id="l30.133">     }</span>
<a href="#l30.134"></a><span id="l30.134"> }</span>
<a href="#l30.135"></a><span id="l30.135"> </span>
<a href="#l30.136"></a><span id="l30.136"> function UpdateMailSearch(caller)</span>
<a href="#l30.137"></a><span id="l30.137"> {</span>
<a href="#l30.138"></a><span id="l30.138" class="difflineminus">-  //dump(&quot;XXX update mail-search &quot; + caller + &quot;\n&quot;);</span>
<a href="#l30.139"></a><span id="l30.139">   document.commandDispatcher.updateCommands('mail-search');</span>
<a href="#l30.140"></a><span id="l30.140"> }</span>
<a href="#l30.141"></a><span id="l30.141" class="difflineplus">+/**</span>
<a href="#l30.142"></a><span id="l30.142" class="difflineplus">+ * FolderDisplayWidget currently calls this function when the command updater</span>
<a href="#l30.143"></a><span id="l30.143" class="difflineplus">+ *  notification for updateCommandStatus is called.  We don't have a toolbar,</span>
<a href="#l30.144"></a><span id="l30.144" class="difflineplus">+ *  but our 'mail-search' command set serves the same purpose.</span>
<a href="#l30.145"></a><span id="l30.145" class="difflineplus">+ */</span>
<a href="#l30.146"></a><span id="l30.146" class="difflineplus">+var UpdateMailToolbar = UpdateMailSearch;</span>
<a href="#l30.147"></a><span id="l30.147" class="difflineplus">+</span>
<a href="#l30.148"></a><span id="l30.148" class="difflineplus">+/**</span>
<a href="#l30.149"></a><span id="l30.149" class="difflineplus">+ * No-op clear message pane function for FolderDisplayWidget.</span>
<a href="#l30.150"></a><span id="l30.150" class="difflineplus">+ */</span>
<a href="#l30.151"></a><span id="l30.151" class="difflineplus">+function ClearMessagePane() {</span>
<a href="#l30.152"></a><span id="l30.152" class="difflineplus">+}</span>
<a href="#l30.153"></a><span id="l30.153"> </span>
<a href="#l30.154"></a><span id="l30.154"> function SetAdvancedSearchStatusText(aNumHits)</span>
<a href="#l30.155"></a><span id="l30.155"> {</span>
<a href="#l30.156"></a><span id="l30.156" class="difflineminus">-  var statusMsg;</span>
<a href="#l30.157"></a><span id="l30.157" class="difflineminus">-  // if there are no hits, it means no matches were found in the search.</span>
<a href="#l30.158"></a><span id="l30.158" class="difflineminus">-  if (aNumHits == 0)</span>
<a href="#l30.159"></a><span id="l30.159" class="difflineminus">-    statusMsg = gSearchBundle.getString(&quot;searchFailureMessage&quot;);</span>
<a href="#l30.160"></a><span id="l30.160" class="difflineminus">-  else </span>
<a href="#l30.161"></a><span id="l30.161" class="difflineminus">-  {</span>
<a href="#l30.162"></a><span id="l30.162" class="difflineminus">-    if (aNumHits == 1) </span>
<a href="#l30.163"></a><span id="l30.163" class="difflineminus">-      statusMsg = gSearchBundle.getString(&quot;searchSuccessMessage&quot;);</span>
<a href="#l30.164"></a><span id="l30.164" class="difflineminus">-    else</span>
<a href="#l30.165"></a><span id="l30.165" class="difflineminus">-      statusMsg = gSearchBundle.getFormattedString(&quot;searchSuccessMessages&quot;, [aNumHits]);</span>
<a href="#l30.166"></a><span id="l30.166" class="difflineminus">-  }</span>
<a href="#l30.167"></a><span id="l30.167" class="difflineminus">-</span>
<a href="#l30.168"></a><span id="l30.168" class="difflineminus">-  gStatusFeedback.showStatusString(statusMsg);</span>
<a href="#l30.169"></a><span id="l30.169"> }</span>
<a href="#l30.170"></a><span id="l30.170"> </span>
<a href="#l30.171"></a><span id="l30.171" class="difflineminus">-// nsIMsgSearchNotify object</span>
<a href="#l30.172"></a><span id="l30.172" class="difflineminus">-var gSearchNotificationListener =</span>
<a href="#l30.173"></a><span id="l30.173" class="difflineminus">-{</span>
<a href="#l30.174"></a><span id="l30.174" class="difflineminus">-    onSearchHit: function(header, folder)</span>
<a href="#l30.175"></a><span id="l30.175" class="difflineminus">-    {</span>
<a href="#l30.176"></a><span id="l30.176" class="difflineminus">-        // XXX TODO</span>
<a href="#l30.177"></a><span id="l30.177" class="difflineminus">-        // update status text?</span>
<a href="#l30.178"></a><span id="l30.178" class="difflineminus">-    },</span>
<a href="#l30.179"></a><span id="l30.179" class="difflineminus">-</span>
<a href="#l30.180"></a><span id="l30.180" class="difflineminus">-    onSearchDone: function(status)</span>
<a href="#l30.181"></a><span id="l30.181" class="difflineminus">-    {</span>
<a href="#l30.182"></a><span id="l30.182" class="difflineminus">-        gSearchStopButton.setAttribute(&quot;label&quot;, gSearchBundle.getString(&quot;labelForSearchButton&quot;));</span>
<a href="#l30.183"></a><span id="l30.183" class="difflineminus">-        gSearchStopButton.setAttribute(&quot;accesskey&quot;, gSearchBundle.getString(&quot;labelForSearchButton.accesskey&quot;));</span>
<a href="#l30.184"></a><span id="l30.184" class="difflineminus">-        gStatusFeedback._stopMeteors();</span>
<a href="#l30.185"></a><span id="l30.185" class="difflineminus">-        SetAdvancedSearchStatusText(gSearchView.QueryInterface(Components.interfaces.nsITreeView).rowCount);</span>
<a href="#l30.186"></a><span id="l30.186" class="difflineminus">-    },</span>
<a href="#l30.187"></a><span id="l30.187" class="difflineminus">-</span>
<a href="#l30.188"></a><span id="l30.188" class="difflineminus">-    onNewSearch: function()</span>
<a href="#l30.189"></a><span id="l30.189" class="difflineminus">-    {</span>
<a href="#l30.190"></a><span id="l30.190" class="difflineminus">-      gSearchStopButton.setAttribute(&quot;label&quot;, gSearchBundle.getString(&quot;labelForStopButton&quot;));</span>
<a href="#l30.191"></a><span id="l30.191" class="difflineminus">-      gSearchStopButton.setAttribute(&quot;accesskey&quot;, gSearchBundle.getString(&quot;labelForStopButton.accesskey&quot;));</span>
<a href="#l30.192"></a><span id="l30.192" class="difflineminus">-      UpdateMailSearch(&quot;new-search&quot;);	</span>
<a href="#l30.193"></a><span id="l30.193" class="difflineminus">-      gStatusFeedback._startMeteors();</span>
<a href="#l30.194"></a><span id="l30.194" class="difflineminus">-      gStatusFeedback.showStatusString(gSearchBundle.getString(&quot;searchingMessage&quot;));</span>
<a href="#l30.195"></a><span id="l30.195" class="difflineminus">-    }</span>
<a href="#l30.196"></a><span id="l30.196" class="difflineplus">+/**</span>
<a href="#l30.197"></a><span id="l30.197" class="difflineplus">+ * Subclass the FolderDisplayWidget to deal with UI specific to the search</span>
<a href="#l30.198"></a><span id="l30.198" class="difflineplus">+ *  window.</span>
<a href="#l30.199"></a><span id="l30.199" class="difflineplus">+ */</span>
<a href="#l30.200"></a><span id="l30.200" class="difflineplus">+function SearchFolderDisplayWidget(aMessageDisplay) {</span>
<a href="#l30.201"></a><span id="l30.201" class="difflineplus">+  FolderDisplayWidget.call(this, /* no tab info */ null, aMessageDisplay);</span>
<a href="#l30.202"></a><span id="l30.202"> }</span>
<a href="#l30.203"></a><span id="l30.203"> </span>
<a href="#l30.204"></a><span id="l30.204" class="difflineminus">-// the folderListener object</span>
<a href="#l30.205"></a><span id="l30.205" class="difflineminus">-var gFolderListener = {</span>
<a href="#l30.206"></a><span id="l30.206" class="difflineminus">-    OnItemAdded: function(parentItem, item) {},</span>
<a href="#l30.207"></a><span id="l30.207" class="difflineplus">+SearchFolderDisplayWidget.prototype = {</span>
<a href="#l30.208"></a><span id="l30.208" class="difflineplus">+  __proto__: FolderDisplayWidget.prototype,</span>
<a href="#l30.209"></a><span id="l30.209" class="difflineplus">+</span>
<a href="#l30.210"></a><span id="l30.210" class="difflineplus">+  /// folder display will want to show the thread pane; we need do nothing</span>
<a href="#l30.211"></a><span id="l30.211" class="difflineplus">+  _showThreadPane: function () {},</span>
<a href="#l30.212"></a><span id="l30.212"> </span>
<a href="#l30.213"></a><span id="l30.213" class="difflineminus">-    OnItemRemoved: function(parentItem, item){},</span>
<a href="#l30.214"></a><span id="l30.214" class="difflineplus">+  onSearching: function SearchFolderDisplayWidget_onSearch(aIsSearching) {</span>
<a href="#l30.215"></a><span id="l30.215" class="difflineplus">+    if (aIsSearching) {</span>
<a href="#l30.216"></a><span id="l30.216" class="difflineplus">+      // Search button becomes the &quot;stop&quot; button</span>
<a href="#l30.217"></a><span id="l30.217" class="difflineplus">+      gSearchStopButton.setAttribute(</span>
<a href="#l30.218"></a><span id="l30.218" class="difflineplus">+        &quot;label&quot;, gSearchBundle.getString(&quot;labelForStopButton&quot;));</span>
<a href="#l30.219"></a><span id="l30.219" class="difflineplus">+      gSearchStopButton.setAttribute(</span>
<a href="#l30.220"></a><span id="l30.220" class="difflineplus">+        &quot;accesskey&quot;, gSearchBundle.getString(&quot;labelForStopButton.accesskey&quot;));</span>
<a href="#l30.221"></a><span id="l30.221"> </span>
<a href="#l30.222"></a><span id="l30.222" class="difflineminus">-    OnItemPropertyChanged: function(item, property, oldValue, newValue) {},</span>
<a href="#l30.223"></a><span id="l30.223" class="difflineminus">-</span>
<a href="#l30.224"></a><span id="l30.224" class="difflineminus">-    OnItemIntPropertyChanged: function(item, property, oldValue, newValue) {},</span>
<a href="#l30.225"></a><span id="l30.225" class="difflineminus">-</span>
<a href="#l30.226"></a><span id="l30.226" class="difflineminus">-    OnItemBoolPropertyChanged: function(item, property, oldValue, newValue) {},</span>
<a href="#l30.227"></a><span id="l30.227" class="difflineminus">-</span>
<a href="#l30.228"></a><span id="l30.228" class="difflineminus">-    OnItemUnicharPropertyChanged: function(item, property, oldValue, newValue){},</span>
<a href="#l30.229"></a><span id="l30.229" class="difflineminus">-    OnItemPropertyFlagChanged: function(item, property, oldFlag, newFlag) {},</span>
<a href="#l30.230"></a><span id="l30.230" class="difflineplus">+      // update our toolbar equivalent</span>
<a href="#l30.231"></a><span id="l30.231" class="difflineplus">+      UpdateMailSearch(&quot;new-search&quot;);</span>
<a href="#l30.232"></a><span id="l30.232" class="difflineplus">+      // spin the meteors</span>
<a href="#l30.233"></a><span id="l30.233" class="difflineplus">+      gStatusFeedback._startMeteors();</span>
<a href="#l30.234"></a><span id="l30.234" class="difflineplus">+      // tell the user that we're searching</span>
<a href="#l30.235"></a><span id="l30.235" class="difflineplus">+      gStatusFeedback.showStatusString(</span>
<a href="#l30.236"></a><span id="l30.236" class="difflineplus">+        gSearchBundle.getString(&quot;searchingMessage&quot;));</span>
<a href="#l30.237"></a><span id="l30.237" class="difflineplus">+    }</span>
<a href="#l30.238"></a><span id="l30.238" class="difflineplus">+    else {</span>
<a href="#l30.239"></a><span id="l30.239" class="difflineplus">+      // Stop button resumes being the &quot;search&quot; button</span>
<a href="#l30.240"></a><span id="l30.240" class="difflineplus">+      gSearchStopButton.setAttribute(</span>
<a href="#l30.241"></a><span id="l30.241" class="difflineplus">+        &quot;label&quot;, gSearchBundle.getString(&quot;labelForSearchButton&quot;));</span>
<a href="#l30.242"></a><span id="l30.242" class="difflineplus">+      gSearchStopButton.setAttribute(</span>
<a href="#l30.243"></a><span id="l30.243" class="difflineplus">+        &quot;accesskey&quot;, gSearchBundle.getString(&quot;labelForSearchButton.accesskey&quot;));</span>
<a href="#l30.244"></a><span id="l30.244"> </span>
<a href="#l30.245"></a><span id="l30.245" class="difflineminus">-    OnItemEvent: function(folder, event) {</span>
<a href="#l30.246"></a><span id="l30.246" class="difflineminus">-        var eventType = event.toString();</span>
<a href="#l30.247"></a><span id="l30.247" class="difflineminus">-        </span>
<a href="#l30.248"></a><span id="l30.248" class="difflineminus">-        if (eventType == &quot;DeleteOrMoveMsgCompleted&quot;) {</span>
<a href="#l30.249"></a><span id="l30.249" class="difflineminus">-            HandleDeleteOrMoveMessageCompleted(folder);</span>
<a href="#l30.250"></a><span id="l30.250" class="difflineminus">-        }     </span>
<a href="#l30.251"></a><span id="l30.251" class="difflineminus">-        else if (eventType == &quot;DeleteOrMoveMsgFailed&quot;) {</span>
<a href="#l30.252"></a><span id="l30.252" class="difflineminus">-            HandleDeleteOrMoveMessageFailed(folder);</span>
<a href="#l30.253"></a><span id="l30.253" class="difflineminus">-        }</span>
<a href="#l30.254"></a><span id="l30.254" class="difflineplus">+      // update our toolbar equivalent</span>
<a href="#l30.255"></a><span id="l30.255" class="difflineplus">+      UpdateMailSearch(&quot;done-search&quot;);</span>
<a href="#l30.256"></a><span id="l30.256" class="difflineplus">+      // stop spining the meteors</span>
<a href="#l30.257"></a><span id="l30.257" class="difflineplus">+      gStatusFeedback._stopMeteors();</span>
<a href="#l30.258"></a><span id="l30.258" class="difflineplus">+      // set the result test</span>
<a href="#l30.259"></a><span id="l30.259" class="difflineplus">+      this.updateStatusResultText();</span>
<a href="#l30.260"></a><span id="l30.260">     }</span>
<a href="#l30.261"></a><span id="l30.261" class="difflineminus">-}</span>
<a href="#l30.262"></a><span id="l30.262" class="difflineplus">+  },</span>
<a href="#l30.263"></a><span id="l30.263"> </span>
<a href="#l30.264"></a><span id="l30.264" class="difflineminus">-function HideSearchColumn(id)</span>
<a href="#l30.265"></a><span id="l30.265" class="difflineminus">-{</span>
<a href="#l30.266"></a><span id="l30.266" class="difflineminus">-  var col = document.getElementById(id);</span>
<a href="#l30.267"></a><span id="l30.267" class="difflineminus">-  if (col) {</span>
<a href="#l30.268"></a><span id="l30.268" class="difflineminus">-    col.setAttribute(&quot;hidden&quot;,&quot;true&quot;);</span>
<a href="#l30.269"></a><span id="l30.269" class="difflineminus">-    col.setAttribute(&quot;ignoreincolumnpicker&quot;,&quot;true&quot;);</span>
<a href="#l30.270"></a><span id="l30.270" class="difflineminus">-  }</span>
<a href="#l30.271"></a><span id="l30.271" class="difflineminus">-}</span>
<a href="#l30.272"></a><span id="l30.272" class="difflineplus">+  /**</span>
<a href="#l30.273"></a><span id="l30.273" class="difflineplus">+   * If messages were removed, we might have lost some search results and so</span>
<a href="#l30.274"></a><span id="l30.274" class="difflineplus">+   *  should update our search result text.  Also, defer to our super-class.</span>
<a href="#l30.275"></a><span id="l30.275" class="difflineplus">+   */</span>
<a href="#l30.276"></a><span id="l30.276" class="difflineplus">+  onMessagesRemoved: function SearchFolderDisplayWidget_onMessagesRemoved() {</span>
<a href="#l30.277"></a><span id="l30.277" class="difflineplus">+    // result text is only for when we are not searching</span>
<a href="#l30.278"></a><span id="l30.278" class="difflineplus">+    if (!this.view.searching)</span>
<a href="#l30.279"></a><span id="l30.279" class="difflineplus">+      this.updateStatusResultText();</span>
<a href="#l30.280"></a><span id="l30.280" class="difflineplus">+    this.__proto__.__proto__.onMessagesRemoved.call(this);</span>
<a href="#l30.281"></a><span id="l30.281" class="difflineplus">+  },</span>
<a href="#l30.282"></a><span id="l30.282"> </span>
<a href="#l30.283"></a><span id="l30.283" class="difflineminus">-function ShowSearchColumn(id)</span>
<a href="#l30.284"></a><span id="l30.284" class="difflineminus">-{</span>
<a href="#l30.285"></a><span id="l30.285" class="difflineminus">-  var col = document.getElementById(id);</span>
<a href="#l30.286"></a><span id="l30.286" class="difflineminus">-  if (col) {</span>
<a href="#l30.287"></a><span id="l30.287" class="difflineminus">-    col.removeAttribute(&quot;hidden&quot;);</span>
<a href="#l30.288"></a><span id="l30.288" class="difflineminus">-    col.removeAttribute(&quot;ignoreincolumnpicker&quot;);</span>
<a href="#l30.289"></a><span id="l30.289" class="difflineminus">-  }</span>
<a href="#l30.290"></a><span id="l30.290" class="difflineminus">-}</span>
<a href="#l30.291"></a><span id="l30.291" class="difflineplus">+  updateStatusResultText: function() {</span>
<a href="#l30.292"></a><span id="l30.292" class="difflineplus">+    let statusMsg, rowCount = this.view.dbView.rowCount;</span>
<a href="#l30.293"></a><span id="l30.293" class="difflineplus">+    // if there are no hits, it means no matches were found in the search.</span>
<a href="#l30.294"></a><span id="l30.294" class="difflineplus">+    if (rowCount == 0)</span>
<a href="#l30.295"></a><span id="l30.295" class="difflineplus">+      statusMsg = gSearchBundle.getString(&quot;searchFailureMessage&quot;);</span>
<a href="#l30.296"></a><span id="l30.296" class="difflineplus">+    else if (rowCount == 1)</span>
<a href="#l30.297"></a><span id="l30.297" class="difflineplus">+      statusMsg = gSearchBundle.getString(&quot;searchSuccessMessage&quot;);</span>
<a href="#l30.298"></a><span id="l30.298" class="difflineplus">+    else</span>
<a href="#l30.299"></a><span id="l30.299" class="difflineplus">+      statusMsg = gSearchBundle.getFormattedString(&quot;searchSuccessMessages&quot;,</span>
<a href="#l30.300"></a><span id="l30.300" class="difflineplus">+                                                   [rowCount]);</span>
<a href="#l30.301"></a><span id="l30.301" class="difflineplus">+</span>
<a href="#l30.302"></a><span id="l30.302" class="difflineplus">+    gStatusFeedback.showStatusString(statusMsg);</span>
<a href="#l30.303"></a><span id="l30.303" class="difflineplus">+  },</span>
<a href="#l30.304"></a><span id="l30.304" class="difflineplus">+};</span>
<a href="#l30.305"></a><span id="l30.305" class="difflineplus">+</span>
<a href="#l30.306"></a><span id="l30.306"> </span>
<a href="#l30.307"></a><span id="l30.307"> function searchOnLoad()</span>
<a href="#l30.308"></a><span id="l30.308"> {</span>
<a href="#l30.309"></a><span id="l30.309">   initializeSearchWidgets();</span>
<a href="#l30.310"></a><span id="l30.310">   initializeSearchWindowWidgets();</span>
<a href="#l30.311"></a><span id="l30.311">   messenger = Components.classes[&quot;@mozilla.org/messenger;1&quot;]</span>
<a href="#l30.312"></a><span id="l30.312">                         .createInstance(Components.interfaces.nsIMessenger);</span>
<a href="#l30.313"></a><span id="l30.313"> </span>
<a href="#l30.314"></a><span id="l30.314">   gSearchBundle = document.getElementById(&quot;bundle_search&quot;);</span>
<a href="#l30.315"></a><span id="l30.315">   gSearchStopButton.setAttribute(&quot;label&quot;, gSearchBundle.getString(&quot;labelForSearchButton&quot;));</span>
<a href="#l30.316"></a><span id="l30.316">   gSearchStopButton.setAttribute(&quot;accesskey&quot;, gSearchBundle.getString(&quot;labelForSearchButton.accesskey&quot;));</span>
<a href="#l30.317"></a><span id="l30.317">   gMessengerBundle = document.getElementById(&quot;bundle_messenger&quot;);</span>
<a href="#l30.318"></a><span id="l30.318" class="difflineminus">-  setupDatasource();</span>
<a href="#l30.319"></a><span id="l30.319" class="difflineminus">-  setupSearchListener();</span>
<a href="#l30.320"></a><span id="l30.320" class="difflineplus">+</span>
<a href="#l30.321"></a><span id="l30.321" class="difflineplus">+  gMessageDisplay = new NeverVisisbleMessageDisplayWidget();</span>
<a href="#l30.322"></a><span id="l30.322" class="difflineplus">+  gFolderDisplay = new SearchFolderDisplayWidget(gMessageDisplay);</span>
<a href="#l30.323"></a><span id="l30.323" class="difflineplus">+  gFolderDisplay.messenger = messenger;</span>
<a href="#l30.324"></a><span id="l30.324" class="difflineplus">+  gFolderDisplay.msgWindow = msgWindow;</span>
<a href="#l30.325"></a><span id="l30.325" class="difflineplus">+  gFolderDisplay.tree = document.getElementById(&quot;threadTree&quot;);</span>
<a href="#l30.326"></a><span id="l30.326" class="difflineplus">+  gFolderDisplay.treeBox = gFolderDisplay.tree.boxObject.QueryInterface(</span>
<a href="#l30.327"></a><span id="l30.327" class="difflineplus">+                             Components.interfaces.nsITreeBoxObject);</span>
<a href="#l30.328"></a><span id="l30.328" class="difflineplus">+  gFolderDisplay.view.openSearchView();</span>
<a href="#l30.329"></a><span id="l30.329" class="difflineplus">+  gFolderDisplay.makeActive();</span>
<a href="#l30.330"></a><span id="l30.330" class="difflineplus">+</span>
<a href="#l30.331"></a><span id="l30.331" class="difflineplus">+  gFolderDisplay.setVisibleColumns({subjectCol: true,</span>
<a href="#l30.332"></a><span id="l30.332" class="difflineplus">+                                    senderCol: true,</span>
<a href="#l30.333"></a><span id="l30.333" class="difflineplus">+                                    dateCol: true,</span>
<a href="#l30.334"></a><span id="l30.334" class="difflineplus">+                                    locationCol: true,</span>
<a href="#l30.335"></a><span id="l30.335" class="difflineplus">+                                    });</span>
<a href="#l30.336"></a><span id="l30.336"> </span>
<a href="#l30.337"></a><span id="l30.337">   if (window.arguments &amp;&amp; window.arguments[0])</span>
<a href="#l30.338"></a><span id="l30.338">       selectFolder(window.arguments[0].folder);</span>
<a href="#l30.339"></a><span id="l30.339"> </span>
<a href="#l30.340"></a><span id="l30.340" class="difflineplus">+  // trigger searchTermOverlay.js to create the first criterion</span>
<a href="#l30.341"></a><span id="l30.341">   onMore(null);</span>
<a href="#l30.342"></a><span id="l30.342" class="difflineplus">+  // make sure all the buttons are configured</span>
<a href="#l30.343"></a><span id="l30.343">   UpdateMailSearch(&quot;onload&quot;);</span>
<a href="#l30.344"></a><span id="l30.344" class="difflineminus">-  </span>
<a href="#l30.345"></a><span id="l30.345" class="difflineminus">-  // hide and remove these columns from the column picker.  you can't thread search results</span>
<a href="#l30.346"></a><span id="l30.346" class="difflineminus">-  HideSearchColumn(&quot;threadCol&quot;); // since you can't thread search results</span>
<a href="#l30.347"></a><span id="l30.347" class="difflineminus">-  HideSearchColumn(&quot;totalCol&quot;); // since you can't thread search results</span>
<a href="#l30.348"></a><span id="l30.348" class="difflineminus">-  HideSearchColumn(&quot;unreadCol&quot;); // since you can't thread search results</span>
<a href="#l30.349"></a><span id="l30.349" class="difflineminus">-  HideSearchColumn(&quot;unreadButtonColHeader&quot;);</span>
<a href="#l30.350"></a><span id="l30.350" class="difflineminus">-  HideSearchColumn(&quot;statusCol&quot;);</span>
<a href="#l30.351"></a><span id="l30.351" class="difflineminus">-  HideSearchColumn(&quot;flaggedCol&quot;);</span>
<a href="#l30.352"></a><span id="l30.352" class="difflineminus">-  HideSearchColumn(&quot;idCol&quot;);</span>
<a href="#l30.353"></a><span id="l30.353" class="difflineminus">-  HideSearchColumn(&quot;junkStatusCol&quot;);</span>
<a href="#l30.354"></a><span id="l30.354" class="difflineminus">-  HideSearchColumn(&quot;accountCol&quot;);</span>
<a href="#l30.355"></a><span id="l30.355" class="difflineminus">-  </span>
<a href="#l30.356"></a><span id="l30.356" class="difflineminus">-  // we want to show the location column for search</span>
<a href="#l30.357"></a><span id="l30.357" class="difflineminus">-  ShowSearchColumn(&quot;locationCol&quot;);</span>
<a href="#l30.358"></a><span id="l30.358"> }</span>
<a href="#l30.359"></a><span id="l30.359"> </span>
<a href="#l30.360"></a><span id="l30.360"> function searchOnUnload()</span>
<a href="#l30.361"></a><span id="l30.361"> {</span>
<a href="#l30.362"></a><span id="l30.362" class="difflineminus">-    // unregister listeners</span>
<a href="#l30.363"></a><span id="l30.363" class="difflineminus">-    gSearchSession.unregisterListener(gViewSearchListener);</span>
<a href="#l30.364"></a><span id="l30.364" class="difflineminus">-    gSearchSession.unregisterListener(gSearchNotificationListener);</span>
<a href="#l30.365"></a><span id="l30.365" class="difflineplus">+  gFolderDisplay.close();</span>
<a href="#l30.366"></a><span id="l30.366" class="difflineplus">+  top.controllers.removeController(nsSearchResultsController);</span>
<a href="#l30.367"></a><span id="l30.367"> </span>
<a href="#l30.368"></a><span id="l30.368" class="difflineminus">-    Components.classes[&quot;@mozilla.org/messenger/services/session;1&quot;]</span>
<a href="#l30.369"></a><span id="l30.369" class="difflineminus">-              .getService(Components.interfaces.nsIMsgMailSession)</span>
<a href="#l30.370"></a><span id="l30.370" class="difflineminus">-              .RemoveFolderListener(gFolderListener);</span>
<a href="#l30.371"></a><span id="l30.371" class="difflineminus">-	</span>
<a href="#l30.372"></a><span id="l30.372" class="difflineminus">-    if (gSearchView) {</span>
<a href="#l30.373"></a><span id="l30.373" class="difflineminus">-	gSearchView.close();</span>
<a href="#l30.374"></a><span id="l30.374" class="difflineminus">-	gSearchView = null;</span>
<a href="#l30.375"></a><span id="l30.375" class="difflineminus">-    }</span>
<a href="#l30.376"></a><span id="l30.376" class="difflineminus">-</span>
<a href="#l30.377"></a><span id="l30.377" class="difflineminus">-    top.controllers.removeController(nsSearchResultsController);</span>
<a href="#l30.378"></a><span id="l30.378" class="difflineminus">-</span>
<a href="#l30.379"></a><span id="l30.379" class="difflineminus">-    // release this early because msgWindow holds a weak reference</span>
<a href="#l30.380"></a><span id="l30.380" class="difflineminus">-    msgWindow.rootDocShell = null;</span>
<a href="#l30.381"></a><span id="l30.381" class="difflineplus">+  // release this early because msgWindow holds a weak reference</span>
<a href="#l30.382"></a><span id="l30.382" class="difflineplus">+  msgWindow.rootDocShell = null;</span>
<a href="#l30.383"></a><span id="l30.383"> }</span>
<a href="#l30.384"></a><span id="l30.384"> </span>
<a href="#l30.385"></a><span id="l30.385"> function initializeSearchWindowWidgets()</span>
<a href="#l30.386"></a><span id="l30.386"> {</span>
<a href="#l30.387"></a><span id="l30.387">     gFolderPicker = document.getElementById(&quot;searchableFolders&quot;);</span>
<a href="#l30.388"></a><span id="l30.388">     gSearchStopButton = document.getElementById(&quot;search-button&quot;);</span>
<a href="#l30.389"></a><span id="l30.389">     hideMatchAllItem();</span>
<a href="#l30.390"></a><span id="l30.390" class="difflineminus">-    </span>
<a href="#l30.391"></a><span id="l30.391" class="difflineplus">+</span>
<a href="#l30.392"></a><span id="l30.392">     msgWindow = Components.classes[&quot;@mozilla.org/messenger/msgwindow;1&quot;]</span>
<a href="#l30.393"></a><span id="l30.393">                           .createInstance(nsIMsgWindow);</span>
<a href="#l30.394"></a><span id="l30.394">     msgWindow.domWindow = window;</span>
<a href="#l30.395"></a><span id="l30.395">     msgWindow.rootDocShell.appType = Components.interfaces.nsIDocShell.APP_TYPE_MAIL;</span>
<a href="#l30.396"></a><span id="l30.396"> </span>
<a href="#l30.397"></a><span id="l30.397">     gStatusFeedback = new nsMsgStatusFeedback();</span>
<a href="#l30.398"></a><span id="l30.398">     msgWindow.statusFeedback = gStatusFeedback;</span>
<a href="#l30.399"></a><span id="l30.399"> </span>
<a href="#l30.400"></a><span id="l30.400">     // functionality to enable/disable buttons using nsSearchResultsController</span>
<a href="#l30.401"></a><span id="l30.401">     // depending of whether items are selected in the search results thread pane.</span>
<a href="#l30.402"></a><span id="l30.402">     top.controllers.insertControllerAt(0, nsSearchResultsController);</span>
<a href="#l30.403"></a><span id="l30.403"> }</span>
<a href="#l30.404"></a><span id="l30.404"> </span>
<a href="#l30.405"></a><span id="l30.405"> </span>
<a href="#l30.406"></a><span id="l30.406"> function onSearchStop() {</span>
<a href="#l30.407"></a><span id="l30.407" class="difflineminus">-    gSearchSession.interruptSearch();</span>
<a href="#l30.408"></a><span id="l30.408" class="difflineplus">+  gFolderDisplay.view.search.session.interruptSearch();</span>
<a href="#l30.409"></a><span id="l30.409"> }</span>
<a href="#l30.410"></a><span id="l30.410"> </span>
<a href="#l30.411"></a><span id="l30.411"> function onResetSearch(event) {</span>
<a href="#l30.412"></a><span id="l30.412" class="difflineminus">-    onReset(event);</span>
<a href="#l30.413"></a><span id="l30.413" class="difflineminus">-    </span>
<a href="#l30.414"></a><span id="l30.414" class="difflineminus">-    var tree = GetThreadTree();</span>
<a href="#l30.415"></a><span id="l30.415" class="difflineminus">-    tree.treeBoxObject.view = null;</span>
<a href="#l30.416"></a><span id="l30.416" class="difflineminus">-    gStatusFeedback.showStatusString(&quot;&quot;);</span>
<a href="#l30.417"></a><span id="l30.417" class="difflineplus">+  onReset(event);</span>
<a href="#l30.418"></a><span id="l30.418" class="difflineplus">+  gFolderDisplay.view.search.clear();</span>
<a href="#l30.419"></a><span id="l30.419" class="difflineplus">+</span>
<a href="#l30.420"></a><span id="l30.420" class="difflineplus">+  gStatusFeedback.showStatusString(&quot;&quot;);</span>
<a href="#l30.421"></a><span id="l30.421"> }</span>
<a href="#l30.422"></a><span id="l30.422"> </span>
<a href="#l30.423"></a><span id="l30.423" class="difflineminus">-function selectFolder(folder) </span>
<a href="#l30.424"></a><span id="l30.424" class="difflineplus">+function selectFolder(folder)</span>
<a href="#l30.425"></a><span id="l30.425"> {</span>
<a href="#l30.426"></a><span id="l30.426">     var folderURI;</span>
<a href="#l30.427"></a><span id="l30.427"> </span>
<a href="#l30.428"></a><span id="l30.428">     // if we can't search messages on this folder, just select the first one</span>
<a href="#l30.429"></a><span id="l30.429">     if (!folder || !folder.server.canSearchMessages ||</span>
<a href="#l30.430"></a><span id="l30.430">         (folder.flags &amp; Components.interfaces.nsMsgFolderFlags.Virtual)) {</span>
<a href="#l30.431"></a><span id="l30.431">         // find first item in our folder picker menu list</span>
<a href="#l30.432"></a><span id="l30.432">         folderURI = gFolderPicker.firstChild.tree.builderView.getResourceAtIndex(0).Value;</span>
<a href="#l30.433"></a><span id="l30.433">     } else {</span>
<a href="#l30.434"></a><span id="l30.434">         folderURI = folder.URI;</span>
<a href="#l30.435"></a><span id="l30.435">     }</span>
<a href="#l30.436"></a><span id="l30.436">     updateSearchFolderPicker(folderURI);</span>
<a href="#l30.437"></a><span id="l30.437"> }</span>
<a href="#l30.438"></a><span id="l30.438"> </span>
<a href="#l30.439"></a><span id="l30.439" class="difflineminus">-function updateSearchFolderPicker(folderURI) </span>
<a href="#l30.440"></a><span id="l30.440" class="difflineminus">-{ </span>
<a href="#l30.441"></a><span id="l30.441" class="difflineplus">+function updateSearchFolderPicker(folderURI)</span>
<a href="#l30.442"></a><span id="l30.442" class="difflineplus">+{</span>
<a href="#l30.443"></a><span id="l30.443">     SetFolderPicker(folderURI, gFolderPicker.id);</span>
<a href="#l30.444"></a><span id="l30.444"> </span>
<a href="#l30.445"></a><span id="l30.445">     // use the URI to get the real folder</span>
<a href="#l30.446"></a><span id="l30.446">     gCurrentFolder = GetMsgFolderFromUri(folderURI);</span>
<a href="#l30.447"></a><span id="l30.447"> </span>
<a href="#l30.448"></a><span id="l30.448">     var searchLocalSystem = document.getElementById(&quot;checkSearchLocalSystem&quot;);</span>
<a href="#l30.449"></a><span id="l30.449">     if (searchLocalSystem)</span>
<a href="#l30.450"></a><span id="l30.450">         searchLocalSystem.disabled = gCurrentFolder.server.searchScope == nsMsgSearchScope.offlineMail;</span>
<a href="#l30.451"></a><span id="l30.451" class="difflineat">@@ -384,80 +370,96 @@ function onChooseFolder(event) {</span>
<a href="#l30.452"></a><span id="l30.452">     }</span>
<a href="#l30.453"></a><span id="l30.453"> }</span>
<a href="#l30.454"></a><span id="l30.454"> </span>
<a href="#l30.455"></a><span id="l30.455"> function onEnterInSearchTerm()</span>
<a href="#l30.456"></a><span id="l30.456"> {</span>
<a href="#l30.457"></a><span id="l30.457">   // on enter</span>
<a href="#l30.458"></a><span id="l30.458">   // if not searching, start the search</span>
<a href="#l30.459"></a><span id="l30.459">   // if searching, stop and then start again</span>
<a href="#l30.460"></a><span id="l30.460" class="difflineminus">-  if (gSearchStopButton.getAttribute(&quot;label&quot;) == gSearchBundle.getString(&quot;labelForSearchButton&quot;)) { </span>
<a href="#l30.461"></a><span id="l30.461" class="difflineminus">-     onSearch(); </span>
<a href="#l30.462"></a><span id="l30.462" class="difflineplus">+  if (gSearchStopButton.getAttribute(&quot;label&quot;) == gSearchBundle.getString(&quot;labelForSearchButton&quot;)) {</span>
<a href="#l30.463"></a><span id="l30.463" class="difflineplus">+     onSearch();</span>
<a href="#l30.464"></a><span id="l30.464">   }</span>
<a href="#l30.465"></a><span id="l30.465">   else {</span>
<a href="#l30.466"></a><span id="l30.466">      onSearchStop();</span>
<a href="#l30.467"></a><span id="l30.467">      onSearch();</span>
<a href="#l30.468"></a><span id="l30.468">   }</span>
<a href="#l30.469"></a><span id="l30.469"> }</span>
<a href="#l30.470"></a><span id="l30.470"> </span>
<a href="#l30.471"></a><span id="l30.471"> function onSearch()</span>
<a href="#l30.472"></a><span id="l30.472"> {</span>
<a href="#l30.473"></a><span id="l30.473" class="difflineminus">-    // set the view.  do this on every search, to</span>
<a href="#l30.474"></a><span id="l30.474" class="difflineminus">-    // allow the tree to reset itself</span>
<a href="#l30.475"></a><span id="l30.475" class="difflineminus">-    var treeView = gSearchView.QueryInterface(Components.interfaces.nsITreeView);</span>
<a href="#l30.476"></a><span id="l30.476" class="difflineminus">-    if (treeView)</span>
<a href="#l30.477"></a><span id="l30.477" class="difflineminus">-    {</span>
<a href="#l30.478"></a><span id="l30.478" class="difflineminus">-      var tree = GetThreadTree();</span>
<a href="#l30.479"></a><span id="l30.479" class="difflineminus">-      tree.treeBoxObject.view = treeView;</span>
<a href="#l30.480"></a><span id="l30.480" class="difflineminus">-    }</span>
<a href="#l30.481"></a><span id="l30.481" class="difflineminus">-</span>
<a href="#l30.482"></a><span id="l30.482" class="difflineminus">-    gSearchSession.clearScopes();</span>
<a href="#l30.483"></a><span id="l30.483" class="difflineminus">-    // tell the search session what the new scope is</span>
<a href="#l30.484"></a><span id="l30.484" class="difflineminus">-    if (!gCurrentFolder.isServer &amp;&amp; !gCurrentFolder.noSelect)</span>
<a href="#l30.485"></a><span id="l30.485" class="difflineminus">-        gSearchSession.addScopeTerm(GetScopeForFolder(gCurrentFolder),</span>
<a href="#l30.486"></a><span id="l30.486" class="difflineminus">-                                    gCurrentFolder);</span>
<a href="#l30.487"></a><span id="l30.487" class="difflineplus">+  let viewWrapper = gFolderDisplay.view;</span>
<a href="#l30.488"></a><span id="l30.488" class="difflineplus">+  let searchTerms = getSearchTerms();</span>
<a href="#l30.489"></a><span id="l30.489"> </span>
<a href="#l30.490"></a><span id="l30.490" class="difflineminus">-    var searchSubfolders = document.getElementById(&quot;checkSearchSubFolders&quot;).checked;</span>
<a href="#l30.491"></a><span id="l30.491" class="difflineminus">-    if (gCurrentFolder &amp;&amp; (searchSubfolders || gCurrentFolder.isServer || gCurrentFolder.noSelect))</span>
<a href="#l30.492"></a><span id="l30.492" class="difflineminus">-    {</span>
<a href="#l30.493"></a><span id="l30.493" class="difflineminus">-        AddSubFolders(gCurrentFolder);</span>
<a href="#l30.494"></a><span id="l30.494" class="difflineminus">-    }</span>
<a href="#l30.495"></a><span id="l30.495" class="difflineminus">-    // reflect the search widgets back into the search session</span>
<a href="#l30.496"></a><span id="l30.496" class="difflineminus">-    saveSearchTerms(gSearchSession.searchTerms, gSearchSession);</span>
<a href="#l30.497"></a><span id="l30.497" class="difflineminus">-</span>
<a href="#l30.498"></a><span id="l30.498" class="difflineminus">-    try</span>
<a href="#l30.499"></a><span id="l30.499" class="difflineminus">-    {</span>
<a href="#l30.500"></a><span id="l30.500" class="difflineminus">-      gSearchSession.search(msgWindow);</span>
<a href="#l30.501"></a><span id="l30.501" class="difflineminus">-    }</span>
<a href="#l30.502"></a><span id="l30.502" class="difflineminus">-    catch(ex)</span>
<a href="#l30.503"></a><span id="l30.503" class="difflineminus">-    {</span>
<a href="#l30.504"></a><span id="l30.504" class="difflineminus">-       dump(&quot;Search Exception\n&quot;);</span>
<a href="#l30.505"></a><span id="l30.505" class="difflineminus">-    }</span>
<a href="#l30.506"></a><span id="l30.506" class="difflineminus">-    // refresh the tree after the search starts, because initiating the</span>
<a href="#l30.507"></a><span id="l30.507" class="difflineminus">-    // search will cause the datasource to clear itself</span>
<a href="#l30.508"></a><span id="l30.508" class="difflineplus">+  viewWrapper.beginViewUpdate();</span>
<a href="#l30.509"></a><span id="l30.509" class="difflineplus">+  viewWrapper.search.userTerms = searchTerms.length ? searchTerms : null;</span>
<a href="#l30.510"></a><span id="l30.510" class="difflineplus">+  viewWrapper.searchFolders = getSearchFolders();</span>
<a href="#l30.511"></a><span id="l30.511" class="difflineplus">+  viewWrapper.endViewUpdate();</span>
<a href="#l30.512"></a><span id="l30.512"> }</span>
<a href="#l30.513"></a><span id="l30.513"> </span>
<a href="#l30.514"></a><span id="l30.514" class="difflineminus">-function AddSubFolders(folder) {</span>
<a href="#l30.515"></a><span id="l30.515" class="difflineplus">+/**</span>
<a href="#l30.516"></a><span id="l30.516" class="difflineplus">+ * Get the current set of search terms, returning them as a list.  We filter out</span>
<a href="#l30.517"></a><span id="l30.517" class="difflineplus">+ *  dangerous and insane predicates.</span>
<a href="#l30.518"></a><span id="l30.518" class="difflineplus">+ */</span>
<a href="#l30.519"></a><span id="l30.519" class="difflineplus">+function getSearchTerms() {</span>
<a href="#l30.520"></a><span id="l30.520" class="difflineplus">+  let termCreator = gFolderDisplay.view.search.session;</span>
<a href="#l30.521"></a><span id="l30.521" class="difflineplus">+</span>
<a href="#l30.522"></a><span id="l30.522" class="difflineplus">+  let searchTerms = [];</span>
<a href="#l30.523"></a><span id="l30.523" class="difflineplus">+  // searchTermOverlay stores wrapper objects in its gSearchTerms array.  Pluck</span>
<a href="#l30.524"></a><span id="l30.524" class="difflineplus">+  //  them.</span>
<a href="#l30.525"></a><span id="l30.525" class="difflineplus">+  for (let iTerm = 0; iTerm &lt; gSearchTerms.length; iTerm++) {</span>
<a href="#l30.526"></a><span id="l30.526" class="difflineplus">+    let termWrapper = gSearchTerms[iTerm].obj;</span>
<a href="#l30.527"></a><span id="l30.527" class="difflineplus">+    let realTerm = termCreator.createTerm();</span>
<a href="#l30.528"></a><span id="l30.528" class="difflineplus">+    termWrapper.saveTo(realTerm);</span>
<a href="#l30.529"></a><span id="l30.529" class="difflineplus">+    // A header search of &quot;&quot; is illegal for IMAP and will cause us to</span>
<a href="#l30.530"></a><span id="l30.530" class="difflineplus">+    //  explode.  You don't want that and I don't want that.  So let's check</span>
<a href="#l30.531"></a><span id="l30.531" class="difflineplus">+    //  if the bloody term is a subject search on a blank string, and if it</span>
<a href="#l30.532"></a><span id="l30.532" class="difflineplus">+    //  is, let's secretly not add the term.  Everyone wins!</span>
<a href="#l30.533"></a><span id="l30.533" class="difflineplus">+    if ((realTerm.attrib != Components.interfaces.nsMsgSearchAttrib.Subject) ||</span>
<a href="#l30.534"></a><span id="l30.534" class="difflineplus">+        (realTerm.value.str != &quot;&quot;))</span>
<a href="#l30.535"></a><span id="l30.535" class="difflineplus">+      searchTerms.push(realTerm);</span>
<a href="#l30.536"></a><span id="l30.536" class="difflineplus">+  }</span>
<a href="#l30.537"></a><span id="l30.537" class="difflineplus">+</span>
<a href="#l30.538"></a><span id="l30.538" class="difflineplus">+  return searchTerms;</span>
<a href="#l30.539"></a><span id="l30.539" class="difflineplus">+}</span>
<a href="#l30.540"></a><span id="l30.540" class="difflineplus">+</span>
<a href="#l30.541"></a><span id="l30.541" class="difflineplus">+/**</span>
<a href="#l30.542"></a><span id="l30.542" class="difflineplus">+ * @return the list of folders the search should cover.</span>
<a href="#l30.543"></a><span id="l30.543" class="difflineplus">+ */</span>
<a href="#l30.544"></a><span id="l30.544" class="difflineplus">+function getSearchFolders() {</span>
<a href="#l30.545"></a><span id="l30.545" class="difflineplus">+  let searchFolders = [];</span>
<a href="#l30.546"></a><span id="l30.546" class="difflineplus">+</span>
<a href="#l30.547"></a><span id="l30.547" class="difflineplus">+  if (!gCurrentFolder.isServer &amp;&amp; !gCurrentFolder.noSelect)</span>
<a href="#l30.548"></a><span id="l30.548" class="difflineplus">+    searchFolders.push(gCurrentFolder);</span>
<a href="#l30.549"></a><span id="l30.549" class="difflineplus">+</span>
<a href="#l30.550"></a><span id="l30.550" class="difflineplus">+  var searchSubfolders =</span>
<a href="#l30.551"></a><span id="l30.551" class="difflineplus">+    document.getElementById(&quot;checkSearchSubFolders&quot;).checked;</span>
<a href="#l30.552"></a><span id="l30.552" class="difflineplus">+  if (gCurrentFolder &amp;&amp;</span>
<a href="#l30.553"></a><span id="l30.553" class="difflineplus">+      (searchSubfolders || gCurrentFolder.isServer || gCurrentFolder.noSelect))</span>
<a href="#l30.554"></a><span id="l30.554" class="difflineplus">+    AddSubFolders(gCurrentFolder, searchFolders);</span>
<a href="#l30.555"></a><span id="l30.555" class="difflineplus">+</span>
<a href="#l30.556"></a><span id="l30.556" class="difflineplus">+  return searchFolders;</span>
<a href="#l30.557"></a><span id="l30.557" class="difflineplus">+}</span>
<a href="#l30.558"></a><span id="l30.558" class="difflineplus">+</span>
<a href="#l30.559"></a><span id="l30.559" class="difflineplus">+function AddSubFolders(folder, outFolders) {</span>
<a href="#l30.560"></a><span id="l30.560">   var subFolders = folder.subFolders;</span>
<a href="#l30.561"></a><span id="l30.561" class="difflineminus">-  while (subFolders.hasMoreElements())</span>
<a href="#l30.562"></a><span id="l30.562" class="difflineminus">-  {</span>
<a href="#l30.563"></a><span id="l30.563" class="difflineplus">+  while (subFolders.hasMoreElements()) {</span>
<a href="#l30.564"></a><span id="l30.564">     var nextFolder =</span>
<a href="#l30.565"></a><span id="l30.565">       subFolders.getNext().QueryInterface(Components.interfaces.nsIMsgFolder);</span>
<a href="#l30.566"></a><span id="l30.566"> </span>
<a href="#l30.567"></a><span id="l30.567" class="difflineminus">-    if (!(nextFolder.flags &amp; Components.interfaces.nsMsgFolderFlags.Virtual))</span>
<a href="#l30.568"></a><span id="l30.568" class="difflineminus">-    {</span>
<a href="#l30.569"></a><span id="l30.569" class="difflineplus">+    if (!(nextFolder.flags &amp; Components.interfaces.nsMsgFolderFlags.Virtual)) {</span>
<a href="#l30.570"></a><span id="l30.570">       if (!nextFolder.noSelect)</span>
<a href="#l30.571"></a><span id="l30.571" class="difflineminus">-        gSearchSession.addScopeTerm(GetScopeForFolder(nextFolder), nextFolder);</span>
<a href="#l30.572"></a><span id="l30.572" class="difflineplus">+        outFolders.push(nextFolder);</span>
<a href="#l30.573"></a><span id="l30.573"> </span>
<a href="#l30.574"></a><span id="l30.574" class="difflineminus">-      AddSubFolders(nextFolder);</span>
<a href="#l30.575"></a><span id="l30.575" class="difflineplus">+      AddSubFolders(nextFolder, outFolders);</span>
<a href="#l30.576"></a><span id="l30.576">     }</span>
<a href="#l30.577"></a><span id="l30.577">   }</span>
<a href="#l30.578"></a><span id="l30.578"> }</span>
<a href="#l30.579"></a><span id="l30.579"> </span>
<a href="#l30.580"></a><span id="l30.580" class="difflineminus">-function AddSubFoldersToURI(folder) </span>
<a href="#l30.581"></a><span id="l30.581" class="difflineplus">+function AddSubFoldersToURI(folder)</span>
<a href="#l30.582"></a><span id="l30.582"> {</span>
<a href="#l30.583"></a><span id="l30.583">   var returnString = &quot;&quot;;</span>
<a href="#l30.584"></a><span id="l30.584"> </span>
<a href="#l30.585"></a><span id="l30.585">   var subFolders = folder.subFolders;</span>
<a href="#l30.586"></a><span id="l30.586"> </span>
<a href="#l30.587"></a><span id="l30.587">   while (subFolders.hasMoreElements())</span>
<a href="#l30.588"></a><span id="l30.588">   {</span>
<a href="#l30.589"></a><span id="l30.589">     var nextFolder =</span>
<a href="#l30.590"></a><span id="l30.590" class="difflineat">@@ -479,17 +481,17 @@ function AddSubFoldersToURI(folder)</span>
<a href="#l30.591"></a><span id="l30.591">         returnString += subFoldersString;</span>
<a href="#l30.592"></a><span id="l30.592">       }</span>
<a href="#l30.593"></a><span id="l30.593">     }</span>
<a href="#l30.594"></a><span id="l30.594">   }</span>
<a href="#l30.595"></a><span id="l30.595">   return returnString;</span>
<a href="#l30.596"></a><span id="l30.596"> }</span>
<a href="#l30.597"></a><span id="l30.597"> </span>
<a href="#l30.598"></a><span id="l30.598"> </span>
<a href="#l30.599"></a><span id="l30.599" class="difflineminus">-function GetScopeForFolder(folder) </span>
<a href="#l30.600"></a><span id="l30.600" class="difflineplus">+function GetScopeForFolder(folder)</span>
<a href="#l30.601"></a><span id="l30.601"> {</span>
<a href="#l30.602"></a><span id="l30.602">   var searchLocalSystem = document.getElementById(&quot;checkSearchLocalSystem&quot;);</span>
<a href="#l30.603"></a><span id="l30.603">   return searchLocalSystem &amp;&amp; searchLocalSystem.checked ? nsMsgSearchScope.offlineMail : folder.server.searchScope;</span>
<a href="#l30.604"></a><span id="l30.604"> }</span>
<a href="#l30.605"></a><span id="l30.605"> </span>
<a href="#l30.606"></a><span id="l30.606"> var nsMsgViewSortType = Components.interfaces.nsMsgViewSortType;</span>
<a href="#l30.607"></a><span id="l30.607"> var nsMsgViewSortOrder = Components.interfaces.nsMsgViewSortOrder;</span>
<a href="#l30.608"></a><span id="l30.608"> var nsMsgViewFlagsType = Components.interfaces.nsMsgViewFlagsType;</span>
<a href="#l30.609"></a><span id="l30.609" class="difflineat">@@ -502,287 +504,89 @@ function goUpdateSearchItems(commandset)</span>
<a href="#l30.610"></a><span id="l30.610">     var commandID = commandset.childNodes[i].getAttribute(&quot;id&quot;);</span>
<a href="#l30.611"></a><span id="l30.611">     if (commandID)</span>
<a href="#l30.612"></a><span id="l30.612">     {</span>
<a href="#l30.613"></a><span id="l30.613">       goUpdateCommand(commandID);</span>
<a href="#l30.614"></a><span id="l30.614">     }</span>
<a href="#l30.615"></a><span id="l30.615">   }</span>
<a href="#l30.616"></a><span id="l30.616"> }</span>
<a href="#l30.617"></a><span id="l30.617"> </span>
<a href="#l30.618"></a><span id="l30.618" class="difflineminus">-function nsMsgSearchCommandUpdater()</span>
<a href="#l30.619"></a><span id="l30.619" class="difflineminus">-{}</span>
<a href="#l30.620"></a><span id="l30.620" class="difflineminus">-</span>
<a href="#l30.621"></a><span id="l30.621" class="difflineminus">-nsMsgSearchCommandUpdater.prototype =</span>
<a href="#l30.622"></a><span id="l30.622" class="difflineminus">-{</span>
<a href="#l30.623"></a><span id="l30.623" class="difflineminus">-  updateCommandStatus : function()</span>
<a href="#l30.624"></a><span id="l30.624" class="difflineminus">-  {</span>
<a href="#l30.625"></a><span id="l30.625" class="difflineminus">-    // the back end is smart and is only telling us to update command status</span>
<a href="#l30.626"></a><span id="l30.626" class="difflineminus">-    // when the # of items in the selection has actually changed.</span>
<a href="#l30.627"></a><span id="l30.627" class="difflineminus">-    document.commandDispatcher.updateCommands('mail-search');</span>
<a href="#l30.628"></a><span id="l30.628" class="difflineminus">-  },</span>
<a href="#l30.629"></a><span id="l30.629" class="difflineminus">-  displayMessageChanged : function(aFolder, aSubject, aKeywords)</span>
<a href="#l30.630"></a><span id="l30.630" class="difflineminus">-  {</span>
<a href="#l30.631"></a><span id="l30.631" class="difflineminus">-  },</span>
<a href="#l30.632"></a><span id="l30.632" class="difflineminus">-</span>
<a href="#l30.633"></a><span id="l30.633" class="difflineminus">-  updateNextMessageAfterDelete : function()</span>
<a href="#l30.634"></a><span id="l30.634" class="difflineminus">-  {</span>
<a href="#l30.635"></a><span id="l30.635" class="difflineminus">-    SetNextMessageAfterDelete();</span>
<a href="#l30.636"></a><span id="l30.636" class="difflineminus">-  },</span>
<a href="#l30.637"></a><span id="l30.637" class="difflineminus">-</span>
<a href="#l30.638"></a><span id="l30.638" class="difflineminus">-  summarizeSelection : function() {return false},</span>
<a href="#l30.639"></a><span id="l30.639" class="difflineminus">-</span>
<a href="#l30.640"></a><span id="l30.640" class="difflineminus">-  QueryInterface : function(iid)</span>
<a href="#l30.641"></a><span id="l30.641" class="difflineminus">-  {</span>
<a href="#l30.642"></a><span id="l30.642" class="difflineminus">-    if (iid.equals(Components.interfaces.nsIMsgDBViewCommandUpdater) ||</span>
<a href="#l30.643"></a><span id="l30.643" class="difflineminus">-        iid.equals(Components.interfaces.nsISupports))</span>
<a href="#l30.644"></a><span id="l30.644" class="difflineminus">-      return this;</span>
<a href="#l30.645"></a><span id="l30.645" class="difflineminus">-</span>
<a href="#l30.646"></a><span id="l30.646" class="difflineminus">-    throw Components.results.NS_NOINTERFACE;</span>
<a href="#l30.647"></a><span id="l30.647" class="difflineminus">-  }</span>
<a href="#l30.648"></a><span id="l30.648" class="difflineminus">-}</span>
<a href="#l30.649"></a><span id="l30.649" class="difflineminus">-</span>
<a href="#l30.650"></a><span id="l30.650" class="difflineminus">-function setupDatasource() {</span>
<a href="#l30.651"></a><span id="l30.651" class="difflineminus">-    gSearchView = Components.classes[&quot;@mozilla.org/messenger/msgdbview;1?type=search&quot;].createInstance(Components.interfaces.nsIMsgDBView);</span>
<a href="#l30.652"></a><span id="l30.652" class="difflineminus">-    var count = new Object;</span>
<a href="#l30.653"></a><span id="l30.653" class="difflineminus">-    var cmdupdator = new nsMsgSearchCommandUpdater();</span>
<a href="#l30.654"></a><span id="l30.654" class="difflineminus">-</span>
<a href="#l30.655"></a><span id="l30.655" class="difflineminus">-    gSearchView.init(messenger, msgWindow, cmdupdator);</span>
<a href="#l30.656"></a><span id="l30.656" class="difflineminus">-    gSearchView.open(null, nsMsgViewSortType.byId, nsMsgViewSortOrder.ascending, nsMsgViewFlagsType.kNone, count);</span>
<a href="#l30.657"></a><span id="l30.657" class="difflineminus">-</span>
<a href="#l30.658"></a><span id="l30.658" class="difflineminus">-    // the thread pane needs to use the search datasource (to get the</span>
<a href="#l30.659"></a><span id="l30.659" class="difflineminus">-    // actual list of messages) and the message datasource (to get any</span>
<a href="#l30.660"></a><span id="l30.660" class="difflineminus">-    // attributes about each message)</span>
<a href="#l30.661"></a><span id="l30.661" class="difflineminus">-    gSearchSession = Components.classes[searchSessionContractID].createInstance(Components.interfaces.nsIMsgSearchSession);</span>
<a href="#l30.662"></a><span id="l30.662" class="difflineminus">-</span>
<a href="#l30.663"></a><span id="l30.663" class="difflineminus">-    var nsIFolderListener = Components.interfaces.nsIFolderListener;</span>
<a href="#l30.664"></a><span id="l30.664" class="difflineminus">-    var notifyFlags = nsIFolderListener.event;</span>
<a href="#l30.665"></a><span id="l30.665" class="difflineminus">-    Components.classes[&quot;@mozilla.org/messenger/services/session;1&quot;]</span>
<a href="#l30.666"></a><span id="l30.666" class="difflineminus">-              .getService(Components.interfaces.nsIMsgMailSession)</span>
<a href="#l30.667"></a><span id="l30.667" class="difflineminus">-              .AddFolderListener(gFolderListener, notifyFlags);</span>
<a href="#l30.668"></a><span id="l30.668" class="difflineminus">-</span>
<a href="#l30.669"></a><span id="l30.669" class="difflineminus">-    // the datasource is a listener on the search results</span>
<a href="#l30.670"></a><span id="l30.670" class="difflineminus">-    gViewSearchListener = gSearchView.QueryInterface(Components.interfaces.nsIMsgSearchNotify);</span>
<a href="#l30.671"></a><span id="l30.671" class="difflineminus">-    gSearchSession.registerListener(gViewSearchListener);</span>
<a href="#l30.672"></a><span id="l30.672" class="difflineminus">-}</span>
<a href="#l30.673"></a><span id="l30.673" class="difflineminus">-</span>
<a href="#l30.674"></a><span id="l30.674" class="difflineminus">-</span>
<a href="#l30.675"></a><span id="l30.675" class="difflineminus">-function setupSearchListener()</span>
<a href="#l30.676"></a><span id="l30.676" class="difflineminus">-{</span>
<a href="#l30.677"></a><span id="l30.677" class="difflineminus">-    // Setup the javascript object as a listener on the search results</span>
<a href="#l30.678"></a><span id="l30.678" class="difflineminus">-    gSearchSession.registerListener(gSearchNotificationListener);</span>
<a href="#l30.679"></a><span id="l30.679" class="difflineminus">-}</span>
<a href="#l30.680"></a><span id="l30.680" class="difflineminus">-</span>
<a href="#l30.681"></a><span id="l30.681" class="difflineminus">-// stuff after this is implemented to make the thread pane work</span>
<a href="#l30.682"></a><span id="l30.682" class="difflineminus">-function GetFolderDatasource()</span>
<a href="#l30.683"></a><span id="l30.683" class="difflineminus">-{</span>
<a href="#l30.684"></a><span id="l30.684" class="difflineminus">-    if (!gFolderDatasource)</span>
<a href="#l30.685"></a><span id="l30.685" class="difflineminus">-        gFolderDatasource = Components.classes[&quot;@mozilla.org/rdf/datasource;1?name=mailnewsfolders&quot;]</span>
<a href="#l30.686"></a><span id="l30.686" class="difflineminus">-                                      .getService(Components.interfaces.nsIRDFDataSource);</span>
<a href="#l30.687"></a><span id="l30.687" class="difflineminus">-    return gFolderDatasource;</span>
<a href="#l30.688"></a><span id="l30.688" class="difflineminus">-}</span>
<a href="#l30.689"></a><span id="l30.689" class="difflineminus">-</span>
<a href="#l30.690"></a><span id="l30.690" class="difflineminus">-// used to determine if we should try to load a message</span>
<a href="#l30.691"></a><span id="l30.691" class="difflineminus">-function IsThreadAndMessagePaneSplitterCollapsed()</span>
<a href="#l30.692"></a><span id="l30.692" class="difflineminus">-{</span>
<a href="#l30.693"></a><span id="l30.693" class="difflineminus">-    return true;</span>
<a href="#l30.694"></a><span id="l30.694" class="difflineminus">-}</span>
<a href="#l30.695"></a><span id="l30.695" class="difflineminus">-</span>
<a href="#l30.696"></a><span id="l30.696"> // used to toggle functionality for Search/Stop button.</span>
<a href="#l30.697"></a><span id="l30.697"> function onSearchButton(event)</span>
<a href="#l30.698"></a><span id="l30.698"> {</span>
<a href="#l30.699"></a><span id="l30.699">     if (event.target.label == gSearchBundle.getString(&quot;labelForSearchButton&quot;))</span>
<a href="#l30.700"></a><span id="l30.700">         onSearch();</span>
<a href="#l30.701"></a><span id="l30.701">     else</span>
<a href="#l30.702"></a><span id="l30.702">         onSearchStop();</span>
<a href="#l30.703"></a><span id="l30.703"> }</span>
<a href="#l30.704"></a><span id="l30.704"> </span>
<a href="#l30.705"></a><span id="l30.705"> // threadPane.js will be needing this, too</span>
<a href="#l30.706"></a><span id="l30.706"> function GetNumSelectedMessages()</span>
<a href="#l30.707"></a><span id="l30.707"> {</span>
<a href="#l30.708"></a><span id="l30.708" class="difflineminus">-   try {</span>
<a href="#l30.709"></a><span id="l30.709" class="difflineminus">-       return gSearchView.numSelected;</span>
<a href="#l30.710"></a><span id="l30.710" class="difflineminus">-   }</span>
<a href="#l30.711"></a><span id="l30.711" class="difflineminus">-   catch (ex) {</span>
<a href="#l30.712"></a><span id="l30.712" class="difflineminus">-       return 0;</span>
<a href="#l30.713"></a><span id="l30.713" class="difflineminus">-   }</span>
<a href="#l30.714"></a><span id="l30.714" class="difflineminus">-}</span>
<a href="#l30.715"></a><span id="l30.715" class="difflineminus">-</span>
<a href="#l30.716"></a><span id="l30.716" class="difflineminus">-function GetDBView()</span>
<a href="#l30.717"></a><span id="l30.717" class="difflineminus">-{</span>
<a href="#l30.718"></a><span id="l30.718" class="difflineminus">-    return gSearchView;</span>
<a href="#l30.719"></a><span id="l30.719" class="difflineplus">+  return gFolderDisplay.treeSelection.count;</span>
<a href="#l30.720"></a><span id="l30.720"> }</span>
<a href="#l30.721"></a><span id="l30.721"> </span>
<a href="#l30.722"></a><span id="l30.722"> function MsgDeleteSelectedMessages(aCommandType)</span>
<a href="#l30.723"></a><span id="l30.723"> {</span>
<a href="#l30.724"></a><span id="l30.724">     // we don't delete news messages, we just return in that case</span>
<a href="#l30.725"></a><span id="l30.725" class="difflineminus">-    if (isNewsURI(gSearchView.getURIForViewIndex(0))) </span>
<a href="#l30.726"></a><span id="l30.726" class="difflineplus">+    if (gFolderDisplay.selectedMessageIsNews)</span>
<a href="#l30.727"></a><span id="l30.727">         return;</span>
<a href="#l30.728"></a><span id="l30.728"> </span>
<a href="#l30.729"></a><span id="l30.729">     // if mail messages delete</span>
<a href="#l30.730"></a><span id="l30.730" class="difflineminus">-    SetNextMessageAfterDelete();</span>
<a href="#l30.731"></a><span id="l30.731" class="difflineminus">-    gSearchView.doCommand(aCommandType);</span>
<a href="#l30.732"></a><span id="l30.732" class="difflineminus">-}</span>
<a href="#l30.733"></a><span id="l30.733" class="difflineminus">-</span>
<a href="#l30.734"></a><span id="l30.734" class="difflineminus">-function SetNextMessageAfterDelete()</span>
<a href="#l30.735"></a><span id="l30.735" class="difflineminus">-{</span>
<a href="#l30.736"></a><span id="l30.736" class="difflineminus">-  gNextMessageViewIndexAfterDelete = gSearchView.msgToSelectAfterDelete;</span>
<a href="#l30.737"></a><span id="l30.737" class="difflineminus">-}</span>
<a href="#l30.738"></a><span id="l30.738" class="difflineminus">-</span>
<a href="#l30.739"></a><span id="l30.739" class="difflineminus">-function HandleDeleteOrMoveMessageFailed(folder)</span>
<a href="#l30.740"></a><span id="l30.740" class="difflineminus">-{</span>
<a href="#l30.741"></a><span id="l30.741" class="difflineminus">-  gNextMessageViewIndexAfterDelete = -2;</span>
<a href="#l30.742"></a><span id="l30.742" class="difflineminus">-}</span>
<a href="#l30.743"></a><span id="l30.743" class="difflineminus">-</span>
<a href="#l30.744"></a><span id="l30.744" class="difflineminus">-function HandleDeleteOrMoveMessageCompleted(folder)</span>
<a href="#l30.745"></a><span id="l30.745" class="difflineminus">-{</span>
<a href="#l30.746"></a><span id="l30.746" class="difflineminus">-  var treeView = gSearchView.QueryInterface(Components.interfaces.nsITreeView);</span>
<a href="#l30.747"></a><span id="l30.747" class="difflineminus">-  var treeSelection = treeView.selection;</span>
<a href="#l30.748"></a><span id="l30.748" class="difflineminus">-  var viewSize = treeView.rowCount;</span>
<a href="#l30.749"></a><span id="l30.749" class="difflineminus">-</span>
<a href="#l30.750"></a><span id="l30.750" class="difflineminus">-  if (gNextMessageViewIndexAfterDelete == -2) {</span>
<a href="#l30.751"></a><span id="l30.751" class="difflineminus">-    // a move or delete can cause our selection can change underneath us.</span>
<a href="#l30.752"></a><span id="l30.752" class="difflineminus">-    // this can happen when the user</span>
<a href="#l30.753"></a><span id="l30.753" class="difflineminus">-    // deletes message from the stand alone msg window</span>
<a href="#l30.754"></a><span id="l30.754" class="difflineminus">-    // or the three pane</span>
<a href="#l30.755"></a><span id="l30.755" class="difflineminus">-    if (!treeSelection) {</span>
<a href="#l30.756"></a><span id="l30.756" class="difflineminus">-      // this can happen if you open the search window</span>
<a href="#l30.757"></a><span id="l30.757" class="difflineminus">-      // and before you do any searches</span>
<a href="#l30.758"></a><span id="l30.758" class="difflineminus">-      // and you do delete from another mail window</span>
<a href="#l30.759"></a><span id="l30.759" class="difflineminus">-      return;</span>
<a href="#l30.760"></a><span id="l30.760" class="difflineminus">-    }</span>
<a href="#l30.761"></a><span id="l30.761" class="difflineminus">-    else if (treeSelection.count == 0) {</span>
<a href="#l30.762"></a><span id="l30.762" class="difflineminus">-      // this can happen if you double clicked a message</span>
<a href="#l30.763"></a><span id="l30.763" class="difflineminus">-      // in the thread pane, and deleted it from the stand alone msg window</span>
<a href="#l30.764"></a><span id="l30.764" class="difflineminus">-      // see bug #185147</span>
<a href="#l30.765"></a><span id="l30.765" class="difflineminus">-      treeSelection.clearSelection();</span>
<a href="#l30.766"></a><span id="l30.766" class="difflineminus">-</span>
<a href="#l30.767"></a><span id="l30.767" class="difflineminus">-      UpdateMailSearch(&quot;delete from another view, 0 rows now selected&quot;);</span>
<a href="#l30.768"></a><span id="l30.768" class="difflineminus">-    }</span>
<a href="#l30.769"></a><span id="l30.769" class="difflineminus">-    else if (treeSelection.count == 1) {</span>
<a href="#l30.770"></a><span id="l30.770" class="difflineminus">-      // this can happen if you had two messages selected</span>
<a href="#l30.771"></a><span id="l30.771" class="difflineminus">-      // in the search results pane, and you deleted one of them from another view</span>
<a href="#l30.772"></a><span id="l30.772" class="difflineminus">-      // (like the view in the stand alone msg window or the three pane)</span>
<a href="#l30.773"></a><span id="l30.773" class="difflineminus">-      // since one item is selected, we should load it.</span>
<a href="#l30.774"></a><span id="l30.774" class="difflineminus">-      var startIndex = {};</span>
<a href="#l30.775"></a><span id="l30.775" class="difflineminus">-      var endIndex = {};</span>
<a href="#l30.776"></a><span id="l30.776" class="difflineminus">-      treeSelection.getRangeAt(0, startIndex, endIndex);</span>
<a href="#l30.777"></a><span id="l30.777" class="difflineminus">-        </span>
<a href="#l30.778"></a><span id="l30.778" class="difflineminus">-      // select the selected item, so we'll load it</span>
<a href="#l30.779"></a><span id="l30.779" class="difflineminus">-      treeSelection.select(startIndex.value); </span>
<a href="#l30.780"></a><span id="l30.780" class="difflineminus">-      treeView.selectionChanged();</span>
<a href="#l30.781"></a><span id="l30.781" class="difflineminus">-</span>
<a href="#l30.782"></a><span id="l30.782" class="difflineminus">-      EnsureRowInThreadTreeIsVisible(startIndex.value); </span>
<a href="#l30.783"></a><span id="l30.783" class="difflineminus">-      UpdateMailSearch(&quot;delete from another view, 1 row now selected&quot;);</span>
<a href="#l30.784"></a><span id="l30.784" class="difflineminus">-    }</span>
<a href="#l30.785"></a><span id="l30.785" class="difflineminus">-    else {</span>
<a href="#l30.786"></a><span id="l30.786" class="difflineminus">-      // this can happen if you have more than 2 messages selected</span>
<a href="#l30.787"></a><span id="l30.787" class="difflineminus">-      // in the search results pane, and you deleted one of them from another view</span>
<a href="#l30.788"></a><span id="l30.788" class="difflineminus">-      // (like the view in the stand alone msg window or the three pane)</span>
<a href="#l30.789"></a><span id="l30.789" class="difflineminus">-      // since multiple messages are still selected, do nothing.</span>
<a href="#l30.790"></a><span id="l30.790" class="difflineminus">-    }</span>
<a href="#l30.791"></a><span id="l30.791" class="difflineminus">-  }</span>
<a href="#l30.792"></a><span id="l30.792" class="difflineminus">-  else {</span>
<a href="#l30.793"></a><span id="l30.793" class="difflineminus">-    if (gNextMessageViewIndexAfterDelete != nsMsgViewIndex_None &amp;&amp; gNextMessageViewIndexAfterDelete &gt;= viewSize) </span>
<a href="#l30.794"></a><span id="l30.794" class="difflineminus">-    {</span>
<a href="#l30.795"></a><span id="l30.795" class="difflineminus">-      if (viewSize &gt; 0)</span>
<a href="#l30.796"></a><span id="l30.796" class="difflineminus">-        gNextMessageViewIndexAfterDelete = viewSize - 1;</span>
<a href="#l30.797"></a><span id="l30.797" class="difflineminus">-      else</span>
<a href="#l30.798"></a><span id="l30.798" class="difflineminus">-      {           </span>
<a href="#l30.799"></a><span id="l30.799" class="difflineminus">-        gNextMessageViewIndexAfterDelete = nsMsgViewIndex_None;</span>
<a href="#l30.800"></a><span id="l30.800" class="difflineminus">-</span>
<a href="#l30.801"></a><span id="l30.801" class="difflineminus">-        // there is nothing to select since viewSize is 0</span>
<a href="#l30.802"></a><span id="l30.802" class="difflineminus">-        treeSelection.clearSelection();</span>
<a href="#l30.803"></a><span id="l30.803" class="difflineminus">-</span>
<a href="#l30.804"></a><span id="l30.804" class="difflineminus">-        UpdateMailSearch(&quot;delete from current view, 0 rows left&quot;);</span>
<a href="#l30.805"></a><span id="l30.805" class="difflineminus">-      }</span>
<a href="#l30.806"></a><span id="l30.806" class="difflineminus">-    }</span>
<a href="#l30.807"></a><span id="l30.807" class="difflineminus">-</span>
<a href="#l30.808"></a><span id="l30.808" class="difflineminus">-    // if we are about to set the selection with a new element then DON'T clear</span>
<a href="#l30.809"></a><span id="l30.809" class="difflineminus">-    // the selection then add the next message to select. This just generates</span>
<a href="#l30.810"></a><span id="l30.810" class="difflineminus">-    // an extra round of command updating notifications that we are trying to</span>
<a href="#l30.811"></a><span id="l30.811" class="difflineminus">-    // optimize away.</span>
<a href="#l30.812"></a><span id="l30.812" class="difflineminus">-    if (gNextMessageViewIndexAfterDelete != nsMsgViewIndex_None) </span>
<a href="#l30.813"></a><span id="l30.813" class="difflineminus">-    {</span>
<a href="#l30.814"></a><span id="l30.814" class="difflineminus">-      treeSelection.select(gNextMessageViewIndexAfterDelete);</span>
<a href="#l30.815"></a><span id="l30.815" class="difflineminus">-      // since gNextMessageViewIndexAfterDelete probably has the same value</span>
<a href="#l30.816"></a><span id="l30.816" class="difflineminus">-      // as the last index we had selected, the tree isn't generating a new</span>
<a href="#l30.817"></a><span id="l30.817" class="difflineminus">-      // selectionChanged notification for the tree view. So we aren't loading the </span>
<a href="#l30.818"></a><span id="l30.818" class="difflineminus">-      // next message. to fix this, force the selection changed update.</span>
<a href="#l30.819"></a><span id="l30.819" class="difflineminus">-      if (treeView)</span>
<a href="#l30.820"></a><span id="l30.820" class="difflineminus">-        treeView.selectionChanged();</span>
<a href="#l30.821"></a><span id="l30.821" class="difflineminus">-</span>
<a href="#l30.822"></a><span id="l30.822" class="difflineminus">-      EnsureRowInThreadTreeIsVisible(gNextMessageViewIndexAfterDelete); </span>
<a href="#l30.823"></a><span id="l30.823" class="difflineminus">-</span>
<a href="#l30.824"></a><span id="l30.824" class="difflineminus">-      // XXX TODO</span>
<a href="#l30.825"></a><span id="l30.825" class="difflineminus">-      // I think there is a bug in the suppression code above.</span>
<a href="#l30.826"></a><span id="l30.826" class="difflineminus">-      // what if I have two rows selected, and I hit delete, </span>
<a href="#l30.827"></a><span id="l30.827" class="difflineminus">-      // and so we load the next row.</span>
<a href="#l30.828"></a><span id="l30.828" class="difflineminus">-      // what if I have commands that only enable where </span>
<a href="#l30.829"></a><span id="l30.829" class="difflineminus">-      // exactly one row is selected?</span>
<a href="#l30.830"></a><span id="l30.830" class="difflineminus">-      UpdateMailSearch(&quot;delete from current view, at least one row selected&quot;);</span>
<a href="#l30.831"></a><span id="l30.831" class="difflineminus">-    }</span>
<a href="#l30.832"></a><span id="l30.832" class="difflineminus">-  }</span>
<a href="#l30.833"></a><span id="l30.833" class="difflineminus">-</span>
<a href="#l30.834"></a><span id="l30.834" class="difflineminus">-  // default value after delete/move/copy is over</span>
<a href="#l30.835"></a><span id="l30.835" class="difflineminus">-  gNextMessageViewIndexAfterDelete = -2;</span>
<a href="#l30.836"></a><span id="l30.836" class="difflineminus">-</span>
<a href="#l30.837"></a><span id="l30.837" class="difflineminus">-  // something might have been deleted, so update the status text</span>
<a href="#l30.838"></a><span id="l30.838" class="difflineminus">-  SetAdvancedSearchStatusText(viewSize);</span>
<a href="#l30.839"></a><span id="l30.839" class="difflineplus">+    gFolderDisplay.hintAboutToDeleteMessages();</span>
<a href="#l30.840"></a><span id="l30.840" class="difflineplus">+    gFolderDisplay.doCommand(aCommandType);</span>
<a href="#l30.841"></a><span id="l30.841"> }</span>
<a href="#l30.842"></a><span id="l30.842"> </span>
<a href="#l30.843"></a><span id="l30.843"> function MoveMessageInSearch(destFolder)</span>
<a href="#l30.844"></a><span id="l30.844"> {</span>
<a href="#l30.845"></a><span id="l30.845" class="difflineminus">-    try {</span>
<a href="#l30.846"></a><span id="l30.846" class="difflineminus">-        // get the msg folder we're moving messages into</span>
<a href="#l30.847"></a><span id="l30.847" class="difflineminus">-        // if the id (uri) is not set, use file-uri which is set for</span>
<a href="#l30.848"></a><span id="l30.848" class="difflineminus">-        // &quot;File Here&quot;</span>
<a href="#l30.849"></a><span id="l30.849" class="difflineminus">-        var destUri = destFolder.getAttribute('id');</span>
<a href="#l30.850"></a><span id="l30.850" class="difflineminus">-        if (destUri.length == 0) { </span>
<a href="#l30.851"></a><span id="l30.851" class="difflineminus">-          destUri = destFolder.getAttribute('file-uri')</span>
<a href="#l30.852"></a><span id="l30.852" class="difflineminus">-        }</span>
<a href="#l30.853"></a><span id="l30.853" class="difflineplus">+  // Get the msg folder we're moving messages into.</span>
<a href="#l30.854"></a><span id="l30.854" class="difflineplus">+  // If the id (uri) is not set, use file-uri which is set for</span>
<a href="#l30.855"></a><span id="l30.855" class="difflineplus">+  // &quot;File Here&quot;.</span>
<a href="#l30.856"></a><span id="l30.856" class="difflineplus">+  let destUri = destFolder.getAttribute('id');</span>
<a href="#l30.857"></a><span id="l30.857" class="difflineplus">+  if (destUri.length == 0)</span>
<a href="#l30.858"></a><span id="l30.858" class="difflineplus">+    destUri = destFolder.getAttribute('file-uri');</span>
<a href="#l30.859"></a><span id="l30.859"> </span>
<a href="#l30.860"></a><span id="l30.860" class="difflineminus">-        var destMsgFolder = GetMsgFolderFromUri(destUri).QueryInterface(Components.interfaces.nsIMsgFolder);</span>
<a href="#l30.861"></a><span id="l30.861" class="difflineplus">+  let destMsgFolder = GetMsgFolderFromUri(destUri).QueryInterface(</span>
<a href="#l30.862"></a><span id="l30.862" class="difflineplus">+                        Components.interfaces.nsIMsgFolder);</span>
<a href="#l30.863"></a><span id="l30.863"> </span>
<a href="#l30.864"></a><span id="l30.864" class="difflineminus">-        // we don't move news messages, we copy them</span>
<a href="#l30.865"></a><span id="l30.865" class="difflineminus">-        if (isNewsURI(gSearchView.getURIForViewIndex(0))) {</span>
<a href="#l30.866"></a><span id="l30.866" class="difflineminus">-          gSearchView.doCommandWithFolder(nsMsgViewCommandType.copyMessages, destMsgFolder);</span>
<a href="#l30.867"></a><span id="l30.867" class="difflineminus">-        }</span>
<a href="#l30.868"></a><span id="l30.868" class="difflineminus">-        else {</span>
<a href="#l30.869"></a><span id="l30.869" class="difflineminus">-            SetNextMessageAfterDelete();</span>
<a href="#l30.870"></a><span id="l30.870" class="difflineminus">-            gSearchView.doCommandWithFolder(nsMsgViewCommandType.moveMessages, destMsgFolder);</span>
<a href="#l30.871"></a><span id="l30.871" class="difflineminus">-        } </span>
<a href="#l30.872"></a><span id="l30.872" class="difflineminus">-    }</span>
<a href="#l30.873"></a><span id="l30.873" class="difflineminus">-    catch (ex) {</span>
<a href="#l30.874"></a><span id="l30.874" class="difflineminus">-        dump(&quot;MsgMoveMessage failed: &quot; + ex + &quot;\n&quot;);</span>
<a href="#l30.875"></a><span id="l30.875" class="difflineminus">-    }   </span>
<a href="#l30.876"></a><span id="l30.876" class="difflineplus">+  // we don't move news messages, we copy them</span>
<a href="#l30.877"></a><span id="l30.877" class="difflineplus">+  if (gFolderDisplay.selectedMessageIsNews) {</span>
<a href="#l30.878"></a><span id="l30.878" class="difflineplus">+    gFolderDisplay.doCommandWithFolder(nsMsgViewCommandType.copyMessages,</span>
<a href="#l30.879"></a><span id="l30.879" class="difflineplus">+                                       destMsgFolder);</span>
<a href="#l30.880"></a><span id="l30.880" class="difflineplus">+  }</span>
<a href="#l30.881"></a><span id="l30.881" class="difflineplus">+  else {</span>
<a href="#l30.882"></a><span id="l30.882" class="difflineplus">+    gFolderDisplay.hintAboutToDeleteMessages();</span>
<a href="#l30.883"></a><span id="l30.883" class="difflineplus">+    gFolderDisplay.doCommandWithFolder(nsMsgViewCommandType.moveMessages,</span>
<a href="#l30.884"></a><span id="l30.884" class="difflineplus">+                                       destMsgFolder);</span>
<a href="#l30.885"></a><span id="l30.885" class="difflineplus">+  }</span>
<a href="#l30.886"></a><span id="l30.886"> }</span>
<a href="#l30.887"></a><span id="l30.887"> </span>
<a href="#l30.888"></a><span id="l30.888"> function GoToFolder()</span>
<a href="#l30.889"></a><span id="l30.889"> {</span>
<a href="#l30.890"></a><span id="l30.890" class="difflineminus">-  var hdr = gSearchView.hdrForFirstSelectedMessage;</span>
<a href="#l30.891"></a><span id="l30.891" class="difflineminus">-  MsgOpenNewWindowForFolder(hdr.folder.URI, hdr.messageKey);</span>
<a href="#l30.892"></a><span id="l30.892" class="difflineplus">+  MsgOpenNewWindowForFolder(gFolderDisplay.selectedMessage);</span>
<a href="#l30.893"></a><span id="l30.893"> }</span>
<a href="#l30.894"></a><span id="l30.894"> </span>
<a href="#l30.895"></a><span id="l30.895"> function BeginDragThreadPane(event)</span>
<a href="#l30.896"></a><span id="l30.896"> {</span>
<a href="#l30.897"></a><span id="l30.897">     // no search pane dnd yet</span>
<a href="#l30.898"></a><span id="l30.898">     return false;</span>
<a href="#l30.899"></a><span id="l30.899"> }</span>
<a href="#l30.900"></a><span id="l30.900"> </span>
<a href="#l30.901"></a><span id="l30.901"> function saveAsVirtualFolder()</span>
<a href="#l30.902"></a><span id="l30.902"> {</span>
<a href="#l30.903"></a><span id="l30.903" class="difflineminus">-  searchFolderURIs = window.arguments[0].folder.URI;</span>
<a href="#l30.904"></a><span id="l30.904" class="difflineplus">+  var searchFolderURIs = window.arguments[0].folder.URI;</span>
<a href="#l30.905"></a><span id="l30.905"> </span>
<a href="#l30.906"></a><span id="l30.906">   var searchSubfolders = document.getElementById(&quot;checkSearchSubFolders&quot;).checked;</span>
<a href="#l30.907"></a><span id="l30.907">   if (gCurrentFolder &amp;&amp; (searchSubfolders || gCurrentFolder.isServer || gCurrentFolder.noSelect))</span>
<a href="#l30.908"></a><span id="l30.908">   {</span>
<a href="#l30.909"></a><span id="l30.909">     var subFolderURIs = AddSubFoldersToURI(gCurrentFolder);</span>
<a href="#l30.910"></a><span id="l30.910">     if (subFolderURIs.length &gt; 0)</span>
<a href="#l30.911"></a><span id="l30.911">       searchFolderURIs += '|' + subFolderURIs;</span>
<a href="#l30.912"></a><span id="l30.912">   }</span>
<a href="#l30.913"></a><span id="l30.913"> </span>
<a href="#l30.914"></a><span id="l30.914">   var dialog = window.openDialog(&quot;chrome://messenger/content/virtualFolderProperties.xul&quot;, &quot;&quot;,</span>
<a href="#l30.915"></a><span id="l30.915">                                  &quot;chrome,titlebar,modal,centerscreen&quot;,</span>
<a href="#l30.916"></a><span id="l30.916" class="difflineminus">-                                 {folder:window.arguments[0].folder,</span>
<a href="#l30.917"></a><span id="l30.917" class="difflineminus">-                                  searchTerms:gSearchSession.searchTerms,</span>
<a href="#l30.918"></a><span id="l30.918" class="difflineplus">+                                 {folder: window.arguments[0].folder,</span>
<a href="#l30.919"></a><span id="l30.919" class="difflineplus">+                                  searchTerms: toXPCOMArray(getSearchTerms(),</span>
<a href="#l30.920"></a><span id="l30.920" class="difflineplus">+                                                            Components.interfaces.nsISupportsArray),</span>
<a href="#l30.921"></a><span id="l30.921">                                   searchFolderURIs: searchFolderURIs});</span>
<a href="#l30.922"></a><span id="l30.922"> }</span>
<a href="#l30.923"></a><span id="l30.923"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l31.1"></a><span id="l31.1" class="difflineminus">--- a/mail/base/content/SearchDialog.xul</span>
<a href="#l31.2"></a><span id="l31.2" class="difflineplus">+++ b/mail/base/content/SearchDialog.xul</span>
<a href="#l31.3"></a><span id="l31.3" class="difflineat">@@ -53,16 +53,18 @@</span>
<a href="#l31.4"></a><span id="l31.4">         style=&quot;width: 52em; height: 34em;&quot;</span>
<a href="#l31.5"></a><span id="l31.5">         persist=&quot;screenX screenY width height sizemode&quot;&gt;</span>
<a href="#l31.6"></a><span id="l31.6"> </span>
<a href="#l31.7"></a><span id="l31.7">   &lt;stringbundle id=&quot;bundle_search&quot; src=&quot;chrome://messenger/locale/search.properties&quot;/&gt;</span>
<a href="#l31.8"></a><span id="l31.8">   &lt;stringbundle id=&quot;bundle_messenger&quot; src=&quot;chrome://messenger/locale/messenger.properties&quot;/&gt;</span>
<a href="#l31.9"></a><span id="l31.9">   &lt;stringbundle id=&quot;bundle_brand&quot; src=&quot;chrome://branding/locale/brand.properties&quot;/&gt;</span>
<a href="#l31.10"></a><span id="l31.10"> </span>
<a href="#l31.11"></a><span id="l31.11">   &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://messenger/content/mailWindow.js&quot;/&gt;</span>
<a href="#l31.12"></a><span id="l31.12" class="difflineplus">+  &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://messenger/content/folderDisplay.js&quot;/&gt;</span>
<a href="#l31.13"></a><span id="l31.13" class="difflineplus">+  &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://messenger/content/messageDisplay.js&quot;/&gt;</span>
<a href="#l31.14"></a><span id="l31.14">   &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://messenger/content/threadPane.js&quot;/&gt;</span>
<a href="#l31.15"></a><span id="l31.15">   &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://messenger/content/msgMail3PaneWindow.js&quot;/&gt;</span>
<a href="#l31.16"></a><span id="l31.16">   &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://global/content/globalOverlay.js&quot;/&gt;</span>
<a href="#l31.17"></a><span id="l31.17">   &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://messenger/content/mailCommands.js&quot;/&gt;</span>
<a href="#l31.18"></a><span id="l31.18">   &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://messenger/content/mailWindowOverlay.js&quot;/&gt;</span>
<a href="#l31.19"></a><span id="l31.19">   &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://messenger/content/commandglue.js&quot;/&gt;</span>
<a href="#l31.20"></a><span id="l31.20">   &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://messenger/content/SearchDialog.js&quot;/&gt;</span>
<a href="#l31.21"></a><span id="l31.21">   &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://messenger/content/messengerdnd.js&quot;/&gt;</span>
<a href="#l31.22"></a><span id="l31.22" class="difflineat">@@ -110,34 +112,35 @@</span>
<a href="#l31.23"></a><span id="l31.23">          &lt;label value=&quot;&amp;searchHeading.label;&quot; accesskey=&quot;&amp;searchHeading.accesskey;&quot;</span>
<a href="#l31.24"></a><span id="l31.24">                 control=&quot;searchableFolders&quot;/&gt;</span>
<a href="#l31.25"></a><span id="l31.25">          &lt;menulist id=&quot;searchableFolders&quot; flex=&quot;2&quot;&gt;</span>
<a href="#l31.26"></a><span id="l31.26">            &lt;menupopup class=&quot;searchPopup&quot; oncommand=&quot;updateSearchFolderPicker(this.getAttribute('uri'));&quot;/&gt;</span>
<a href="#l31.27"></a><span id="l31.27">          &lt;/menulist&gt;</span>
<a href="#l31.28"></a><span id="l31.28">          &lt;spacer flex=&quot;10&quot;/&gt;</span>
<a href="#l31.29"></a><span id="l31.29">          &lt;button id=&quot;search-button&quot; oncommand=&quot;onSearchButton(event);&quot; default=&quot;true&quot;/&gt;</span>
<a href="#l31.30"></a><span id="l31.30">         &lt;/hbox&gt;</span>
<a href="#l31.31"></a><span id="l31.31" class="difflineminus">-        </span>
<a href="#l31.32"></a><span id="l31.32" class="difflineplus">+</span>
<a href="#l31.33"></a><span id="l31.33">          &lt;hbox align=&quot;center&quot;&gt;</span>
<a href="#l31.34"></a><span id="l31.34">            &lt;checkbox id=&quot;checkSearchSubFolders&quot; label=&quot;&amp;searchSubfolders.label;&quot; checked=&quot;true&quot; accesskey=&quot;&amp;searchSubfolders.accesskey;&quot;/&gt;</span>
<a href="#l31.35"></a><span id="l31.35">            &lt;spacer flex=&quot;10&quot;/&gt;</span>
<a href="#l31.36"></a><span id="l31.36">            &lt;button label=&quot;&amp;resetButton.label;&quot; oncommand=&quot;onResetSearch(event);&quot; accesskey=&quot;&amp;resetButton.accesskey;&quot;/&gt;</span>
<a href="#l31.37"></a><span id="l31.37">          &lt;/hbox&gt;</span>
<a href="#l31.38"></a><span id="l31.38">       &lt;/vbox&gt;</span>
<a href="#l31.39"></a><span id="l31.39"> </span>
<a href="#l31.40"></a><span id="l31.40">       &lt;hbox flex=&quot;1&quot;&gt;</span>
<a href="#l31.41"></a><span id="l31.41">         &lt;vbox id=&quot;searchTermListBox&quot; flex=&quot;1&quot;/&gt;</span>
<a href="#l31.42"></a><span id="l31.42">       &lt;/hbox&gt;</span>
<a href="#l31.43"></a><span id="l31.43">     &lt;/vbox&gt;</span>
<a href="#l31.44"></a><span id="l31.44" class="difflineminus">-    </span>
<a href="#l31.45"></a><span id="l31.45" class="difflineplus">+</span>
<a href="#l31.46"></a><span id="l31.46">     &lt;splitter id=&quot;gray_horizontal_splitter&quot; collapse=&quot;after&quot; persist=&quot;state&quot;/&gt;</span>
<a href="#l31.47"></a><span id="l31.47" class="difflineminus">-    </span>
<a href="#l31.48"></a><span id="l31.48" class="difflineplus">+</span>
<a href="#l31.49"></a><span id="l31.49">     &lt;vbox id=&quot;searchResults&quot; flex=&quot;4&quot; persist=&quot;height&quot;&gt;</span>
<a href="#l31.50"></a><span id="l31.50">       &lt;vbox id=&quot;searchResultListBox&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l31.51"></a><span id="l31.51" class="difflineminus">-        &lt;tree id=&quot;threadTree&quot; persist=&quot;lastfoldersent&quot; flex=&quot;1&quot; enableColumnDrag=&quot;true&quot; _selectDelay=&quot;500&quot; class=&quot;plain focusring&quot; lastfoldersent=&quot;false&quot;</span>
<a href="#l31.52"></a><span id="l31.52" class="difflineplus">+        &lt;tree id=&quot;threadTree&quot; class=&quot;plain&quot; persist=&quot;lastfoldersent&quot; flex=&quot;1&quot;</span>
<a href="#l31.53"></a><span id="l31.53" class="difflineplus">+              enableColumnDrag=&quot;true&quot; _selectDelay=&quot;500&quot; lastfoldersent=&quot;false&quot;</span>
<a href="#l31.54"></a><span id="l31.54">               disableKeyNavigation=&quot;true&quot;</span>
<a href="#l31.55"></a><span id="l31.55">               context=&quot;mailContext&quot;</span>
<a href="#l31.56"></a><span id="l31.56">               onkeypress=&quot;ThreadPaneKeyPress(event);&quot;</span>
<a href="#l31.57"></a><span id="l31.57">               onselect=&quot;ThreadPaneSelectionChanged();&quot;&gt;</span>
<a href="#l31.58"></a><span id="l31.58">           &lt;treecols id=&quot;threadCols&quot; pickertooltiptext=&quot;&amp;columnChooser.tooltip;&quot;&gt;</span>
<a href="#l31.59"></a><span id="l31.59">             &lt;treecol id=&quot;threadCol&quot; persist=&quot;hidden ordinal&quot; fixed=&quot;true&quot; cycler=&quot;true&quot;</span>
<a href="#l31.60"></a><span id="l31.60">                      class=&quot;treecol-image threadColumnHeader&quot; currentView=&quot;unthreaded&quot;</span>
<a href="#l31.61"></a><span id="l31.61">                      label=&quot;&amp;threadColumn.label;&quot; tooltiptext=&quot;&amp;threadColumn.tooltip;&quot;/&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l32.1"></a><span id="l32.1" class="difflineminus">--- a/mail/base/content/aboutRights.xhtml</span>
<a href="#l32.2"></a><span id="l32.2" class="difflineplus">+++ b/mail/base/content/aboutRights.xhtml</span>
<a href="#l32.3"></a><span id="l32.3" class="difflineat">@@ -43,17 +43,17 @@</span>
<a href="#l32.4"></a><span id="l32.4"> # the provisions above, a recipient may use your version of this file under</span>
<a href="#l32.5"></a><span id="l32.5"> # the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l32.6"></a><span id="l32.6"> #</span>
<a href="#l32.7"></a><span id="l32.7"> # ***** END LICENSE BLOCK *****</span>
<a href="#l32.8"></a><span id="l32.8"> </span>
<a href="#l32.9"></a><span id="l32.9"> &lt;html xmlns=&quot;http://www.w3.org/1999/xhtml&quot;&gt;</span>
<a href="#l32.10"></a><span id="l32.10"> </span>
<a href="#l32.11"></a><span id="l32.11"> &lt;head&gt;</span>
<a href="#l32.12"></a><span id="l32.12" class="difflineminus">-  &lt;title&gt;&amp;rights.pagetitle;&lt;/title&gt;</span>
<a href="#l32.13"></a><span id="l32.13" class="difflineplus">+  &lt;title&gt;&amp;rights.title;&lt;/title&gt;</span>
<a href="#l32.14"></a><span id="l32.14">   &lt;link rel=&quot;stylesheet&quot; href=&quot;chrome://global/skin/about.css&quot; type=&quot;text/css&quot;/&gt;</span>
<a href="#l32.15"></a><span id="l32.15"> &lt;/head&gt;</span>
<a href="#l32.16"></a><span id="l32.16"> </span>
<a href="#l32.17"></a><span id="l32.17"> &lt;body id=&quot;your-rights&quot; dir=&quot;&amp;rights.locale-direction;&quot; class=&quot;aboutPageWideContainer&quot;&gt;</span>
<a href="#l32.18"></a><span id="l32.18"> </span>
<a href="#l32.19"></a><span id="l32.19"> &lt;h1&gt;&amp;rights.intro-header;&lt;/h1&gt;</span>
<a href="#l32.20"></a><span id="l32.20"> </span>
<a href="#l32.21"></a><span id="l32.21"> &lt;p&gt;&amp;rights.intro;&lt;/p&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l33.1"></a><span id="l33.1" class="difflineminus">--- a/mail/base/content/commandglue.js</span>
<a href="#l33.2"></a><span id="l33.2" class="difflineplus">+++ b/mail/base/content/commandglue.js</span>
<a href="#l33.3"></a><span id="l33.3" class="difflineat">@@ -1,485 +1,111 @@</span>
<a href="#l33.4"></a><span id="l33.4" class="difflineminus">-# -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*-</span>
<a href="#l33.5"></a><span id="l33.5" class="difflineminus">-# ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l33.6"></a><span id="l33.6" class="difflineminus">-# Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l33.7"></a><span id="l33.7" class="difflineminus">-#</span>
<a href="#l33.8"></a><span id="l33.8" class="difflineminus">-# The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l33.9"></a><span id="l33.9" class="difflineminus">-# 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l33.10"></a><span id="l33.10" class="difflineminus">-# the License. You may obtain a copy of the License at</span>
<a href="#l33.11"></a><span id="l33.11" class="difflineminus">-# http://www.mozilla.org/MPL/</span>
<a href="#l33.12"></a><span id="l33.12" class="difflineminus">-#</span>
<a href="#l33.13"></a><span id="l33.13" class="difflineminus">-# Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l33.14"></a><span id="l33.14" class="difflineminus">-# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l33.15"></a><span id="l33.15" class="difflineminus">-# for the specific language governing rights and limitations under the</span>
<a href="#l33.16"></a><span id="l33.16" class="difflineminus">-# License.</span>
<a href="#l33.17"></a><span id="l33.17" class="difflineminus">-#</span>
<a href="#l33.18"></a><span id="l33.18" class="difflineminus">-# The Original Code is Mozilla Communicator client code, released</span>
<a href="#l33.19"></a><span id="l33.19" class="difflineminus">-# March 31, 1998.</span>
<a href="#l33.20"></a><span id="l33.20" class="difflineminus">-#</span>
<a href="#l33.21"></a><span id="l33.21" class="difflineminus">-# The Initial Developer of the Original Code is</span>
<a href="#l33.22"></a><span id="l33.22" class="difflineminus">-# Netscape Communications Corporation.</span>
<a href="#l33.23"></a><span id="l33.23" class="difflineminus">-# Portions created by the Initial Developer are Copyright (C) 1998-1999</span>
<a href="#l33.24"></a><span id="l33.24" class="difflineminus">-# the Initial Developer. All Rights Reserved.</span>
<a href="#l33.25"></a><span id="l33.25" class="difflineminus">-#</span>
<a href="#l33.26"></a><span id="l33.26" class="difflineminus">-# Contributor(s):</span>
<a href="#l33.27"></a><span id="l33.27" class="difflineminus">-#   Jan Varga &lt;varga@nixcorp.com&gt;</span>
<a href="#l33.28"></a><span id="l33.28" class="difflineminus">-#   HÃ¥kan Waara (hwaara@chello.se)</span>
<a href="#l33.29"></a><span id="l33.29" class="difflineminus">-#   David Bienvenu (bienvenu@nventure.com)</span>
<a href="#l33.30"></a><span id="l33.30" class="difflineminus">-#   Jeremy Morton (bugzilla@game-point.net)</span>
<a href="#l33.31"></a><span id="l33.31" class="difflineminus">-#</span>
<a href="#l33.32"></a><span id="l33.32" class="difflineminus">-# Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l33.33"></a><span id="l33.33" class="difflineminus">-# either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l33.34"></a><span id="l33.34" class="difflineminus">-# the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l33.35"></a><span id="l33.35" class="difflineminus">-# in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l33.36"></a><span id="l33.36" class="difflineminus">-# of those above. If you wish to allow use of your version of this file only</span>
<a href="#l33.37"></a><span id="l33.37" class="difflineminus">-# under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l33.38"></a><span id="l33.38" class="difflineminus">-# use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l33.39"></a><span id="l33.39" class="difflineminus">-# decision by deleting the provisions above and replace them with the notice</span>
<a href="#l33.40"></a><span id="l33.40" class="difflineminus">-# and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l33.41"></a><span id="l33.41" class="difflineminus">-# the provisions above, a recipient may use your version of this file under</span>
<a href="#l33.42"></a><span id="l33.42" class="difflineminus">-# the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l33.43"></a><span id="l33.43" class="difflineminus">-#</span>
<a href="#l33.44"></a><span id="l33.44" class="difflineminus">-# ***** END LICENSE BLOCK *****</span>
<a href="#l33.45"></a><span id="l33.45" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l33.46"></a><span id="l33.46" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l33.47"></a><span id="l33.47" class="difflineplus">+ *</span>
<a href="#l33.48"></a><span id="l33.48" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l33.49"></a><span id="l33.49" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l33.50"></a><span id="l33.50" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l33.51"></a><span id="l33.51" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l33.52"></a><span id="l33.52" class="difflineplus">+ *</span>
<a href="#l33.53"></a><span id="l33.53" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l33.54"></a><span id="l33.54" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l33.55"></a><span id="l33.55" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l33.56"></a><span id="l33.56" class="difflineplus">+ * License.</span>
<a href="#l33.57"></a><span id="l33.57" class="difflineplus">+ *</span>
<a href="#l33.58"></a><span id="l33.58" class="difflineplus">+ * The Original Code is Mozilla Communicator client code, released</span>
<a href="#l33.59"></a><span id="l33.59" class="difflineplus">+ * March 31, 1998.</span>
<a href="#l33.60"></a><span id="l33.60" class="difflineplus">+ *</span>
<a href="#l33.61"></a><span id="l33.61" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l33.62"></a><span id="l33.62" class="difflineplus">+ * Netscape Communications Corporation.</span>
<a href="#l33.63"></a><span id="l33.63" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 1998-1999</span>
<a href="#l33.64"></a><span id="l33.64" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l33.65"></a><span id="l33.65" class="difflineplus">+ *</span>
<a href="#l33.66"></a><span id="l33.66" class="difflineplus">+ * Contributor(s):</span>
<a href="#l33.67"></a><span id="l33.67" class="difflineplus">+ *   Jan Varga &lt;varga@nixcorp.com&gt;</span>
<a href="#l33.68"></a><span id="l33.68" class="difflineplus">+ *   HÃ¥kan Waara (hwaara@chello.se)</span>
<a href="#l33.69"></a><span id="l33.69" class="difflineplus">+ *   David Bienvenu (bienvenu@nventure.com)</span>
<a href="#l33.70"></a><span id="l33.70" class="difflineplus">+ *   Jeremy Morton (bugzilla@game-point.net)</span>
<a href="#l33.71"></a><span id="l33.71" class="difflineplus">+ *   Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a href="#l33.72"></a><span id="l33.72" class="difflineplus">+ *</span>
<a href="#l33.73"></a><span id="l33.73" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l33.74"></a><span id="l33.74" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l33.75"></a><span id="l33.75" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l33.76"></a><span id="l33.76" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l33.77"></a><span id="l33.77" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l33.78"></a><span id="l33.78" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l33.79"></a><span id="l33.79" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l33.80"></a><span id="l33.80" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l33.81"></a><span id="l33.81" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l33.82"></a><span id="l33.82" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l33.83"></a><span id="l33.83" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l33.84"></a><span id="l33.84" class="difflineplus">+ *</span>
<a href="#l33.85"></a><span id="l33.85" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l33.86"></a><span id="l33.86" class="difflineplus">+</span>
<a href="#l33.87"></a><span id="l33.87"> /*</span>
<a href="#l33.88"></a><span id="l33.88">  * Command-specific code. This stuff should be called by the widgets</span>
<a href="#l33.89"></a><span id="l33.89">  */</span>
<a href="#l33.90"></a><span id="l33.90"> </span>
<a href="#l33.91"></a><span id="l33.91"> Components.utils.import(&quot;resource://gre/modules/iteratorUtils.jsm&quot;);</span>
<a href="#l33.92"></a><span id="l33.92"> </span>
<a href="#l33.93"></a><span id="l33.93"> //NOTE: gMessengerBundle and gBrandBundle must be defined and set</span>
<a href="#l33.94"></a><span id="l33.94"> //      for this Overlay to work properly</span>
<a href="#l33.95"></a><span id="l33.95"> </span>
<a href="#l33.96"></a><span id="l33.96" class="difflineminus">-var gFolderJustSwitched = false;</span>
<a href="#l33.97"></a><span id="l33.97" class="difflineminus">-var gVirtualFolderTerms;</span>
<a href="#l33.98"></a><span id="l33.98" class="difflineminus">-var gXFVirtualFolderTerms;</span>
<a href="#l33.99"></a><span id="l33.99" class="difflineminus">-var gCurrentVirtualFolderUri;</span>
<a href="#l33.100"></a><span id="l33.100" class="difflineminus">-var gPrevFolderFlags;</span>
<a href="#l33.101"></a><span id="l33.101" class="difflineminus">-var gPrevSelectedFolder;</span>
<a href="#l33.102"></a><span id="l33.102"> var gMsgFolderSelected;</span>
<a href="#l33.103"></a><span id="l33.103"> </span>
<a href="#l33.104"></a><span id="l33.104" class="difflineminus">-function setTitleFromFolder(msgfolder, subject)</span>
<a href="#l33.105"></a><span id="l33.105" class="difflineminus">-{</span>
<a href="#l33.106"></a><span id="l33.106" class="difflineminus">-    var wintype = document.documentElement.getAttribute('windowtype');</span>
<a href="#l33.107"></a><span id="l33.107" class="difflineminus">-    var title; </span>
<a href="#l33.108"></a><span id="l33.108" class="difflineminus">-</span>
<a href="#l33.109"></a><span id="l33.109" class="difflineminus">-    // If we are showing the mail:3pane. Never include the subject of the selected</span>
<a href="#l33.110"></a><span id="l33.110" class="difflineminus">-    // message in the title. (&quot;Inbox - My Mail - Mozilla Thunderbird&quot;)</span>
<a href="#l33.111"></a><span id="l33.111" class="difflineminus">-    // If we are a stand alone message window, we should show the Subject</span>
<a href="#l33.112"></a><span id="l33.112" class="difflineminus">-    // and the product but not the account name: &quot;Re: New window Title - Mozilla Thunderbird&quot;</span>
<a href="#l33.113"></a><span id="l33.113" class="difflineminus">-</span>
<a href="#l33.114"></a><span id="l33.114" class="difflineminus">-    if (wintype == &quot;mail:messageWindow&quot;)  </span>
<a href="#l33.115"></a><span id="l33.115" class="difflineminus">-      title = subject ? subject : &quot;&quot;;</span>
<a href="#l33.116"></a><span id="l33.116" class="difflineminus">-    else if (msgfolder)</span>
<a href="#l33.117"></a><span id="l33.117" class="difflineminus">-    {</span>
<a href="#l33.118"></a><span id="l33.118" class="difflineminus">-      title = msgfolder.prettyName;</span>
<a href="#l33.119"></a><span id="l33.119" class="difflineminus">-</span>
<a href="#l33.120"></a><span id="l33.120" class="difflineminus">-      if (!msgfolder.isServer)</span>
<a href="#l33.121"></a><span id="l33.121" class="difflineminus">-      {</span>
<a href="#l33.122"></a><span id="l33.122" class="difflineminus">-        var server = msgfolder.server;</span>
<a href="#l33.123"></a><span id="l33.123" class="difflineminus">-        var middle;</span>
<a href="#l33.124"></a><span id="l33.124" class="difflineminus">-        var end;</span>
<a href="#l33.125"></a><span id="l33.125" class="difflineminus">-        if (server.type == &quot;nntp&quot;) {</span>
<a href="#l33.126"></a><span id="l33.126" class="difflineminus">-            // &lt;folder&gt; on &lt;hostname&gt;</span>
<a href="#l33.127"></a><span id="l33.127" class="difflineminus">-            middle = gMessengerBundle.getString(&quot;titleNewsPreHost&quot;);</span>
<a href="#l33.128"></a><span id="l33.128" class="difflineminus">-            end = server.hostName;</span>
<a href="#l33.129"></a><span id="l33.129" class="difflineminus">-        }</span>
<a href="#l33.130"></a><span id="l33.130" class="difflineminus">-        else {</span>
<a href="#l33.131"></a><span id="l33.131" class="difflineminus">-          // &lt;folder&gt; - &lt;server.prettyName&gt;</span>
<a href="#l33.132"></a><span id="l33.132" class="difflineminus">-          middle = &quot;-&quot;;</span>
<a href="#l33.133"></a><span id="l33.133" class="difflineminus">-          end = server.prettyName;</span>
<a href="#l33.134"></a><span id="l33.134" class="difflineminus">-        }</span>
<a href="#l33.135"></a><span id="l33.135" class="difflineminus">-        if (middle) title += &quot; &quot; + middle;</span>
<a href="#l33.136"></a><span id="l33.136" class="difflineminus">-        if (end) title += &quot; &quot; + end;</span>
<a href="#l33.137"></a><span id="l33.137" class="difflineminus">-      }</span>
<a href="#l33.138"></a><span id="l33.138" class="difflineminus">-    }</span>
<a href="#l33.139"></a><span id="l33.139" class="difflineminus">-</span>
<a href="#l33.140"></a><span id="l33.140" class="difflineminus">-#ifndef XP_MACOSX</span>
<a href="#l33.141"></a><span id="l33.141" class="difflineminus">-    title += &quot; - &quot; + gBrandBundle.getString(&quot;brandFullName&quot;);</span>
<a href="#l33.142"></a><span id="l33.142" class="difflineminus">-#endif</span>
<a href="#l33.143"></a><span id="l33.143" class="difflineminus">-    document.title = title;</span>
<a href="#l33.144"></a><span id="l33.144" class="difflineminus">-}</span>
<a href="#l33.145"></a><span id="l33.145" class="difflineminus">-</span>
<a href="#l33.146"></a><span id="l33.146"> function UpdateMailToolbar(caller)</span>
<a href="#l33.147"></a><span id="l33.147"> {</span>
<a href="#l33.148"></a><span id="l33.148">   //dump(&quot;XXX update mail-toolbar &quot; + caller + &quot;\n&quot;);</span>
<a href="#l33.149"></a><span id="l33.149">   document.commandDispatcher.updateCommands('mail-toolbar');</span>
<a href="#l33.150"></a><span id="l33.150"> </span>
<a href="#l33.151"></a><span id="l33.151">   // hook for extra toolbar items</span>
<a href="#l33.152"></a><span id="l33.152">   var observerService = Components.classes[&quot;@mozilla.org/observer-service;1&quot;].getService(Components.interfaces.nsIObserverService);</span>
<a href="#l33.153"></a><span id="l33.153">   observerService.notifyObservers(window, &quot;mail:updateToolbarItems&quot;, null);</span>
<a href="#l33.154"></a><span id="l33.154"> }</span>
<a href="#l33.155"></a><span id="l33.155"> </span>
<a href="#l33.156"></a><span id="l33.156" class="difflineminus">-/**</span>
<a href="#l33.157"></a><span id="l33.157" class="difflineminus">- * @param   folder                - If viewFolder is a single folder saved</span>
<a href="#l33.158"></a><span id="l33.158" class="difflineminus">-                                  - search, this folder is the scope of the</span>
<a href="#l33.159"></a><span id="l33.159" class="difflineminus">-                                  - saved search, the real, underlying folder.</span>
<a href="#l33.160"></a><span id="l33.160" class="difflineminus">-                                  - Otherwise, it's the same as the viewFolder.</span>
<a href="#l33.161"></a><span id="l33.161" class="difflineminus">- * @param   viewFolder            - nsIMsgFolder selected in the folder pane.</span>
<a href="#l33.162"></a><span id="l33.162" class="difflineminus">-                                  - Will be the same as folder, except if</span>
<a href="#l33.163"></a><span id="l33.163" class="difflineminus">-                                  - it's a single folder saved search.</span>
<a href="#l33.164"></a><span id="l33.164" class="difflineminus">- * @param   viewType              - nsMsgViewType (see nsIMsgDBView.idl)</span>
<a href="#l33.165"></a><span id="l33.165" class="difflineminus">- * @param   viewFlags             - nsMsgViewFlagsType (see nsIMsgDBView.idl)</span>
<a href="#l33.166"></a><span id="l33.166" class="difflineminus">- * @param   sortType              - nsMsgViewSortType (see nsIMsgDBView.idl)</span>
<a href="#l33.167"></a><span id="l33.167" class="difflineminus">- * @param   sortOrder             - nsMsgViewSortOrder (see nsIMsgDBView.idl)</span>
<a href="#l33.168"></a><span id="l33.168" class="difflineminus">- **/</span>
<a href="#l33.169"></a><span id="l33.169" class="difflineminus">-function ChangeFolder(folder, viewFolder, viewType, viewFlags, sortType, sortOrder)</span>
<a href="#l33.170"></a><span id="l33.170" class="difflineminus">-{</span>
<a href="#l33.171"></a><span id="l33.171" class="difflineminus">-  if (folder.URI == gCurrentLoadingFolderURI)</span>
<a href="#l33.172"></a><span id="l33.172" class="difflineminus">-    return;</span>
<a href="#l33.173"></a><span id="l33.173" class="difflineminus">-</span>
<a href="#l33.174"></a><span id="l33.174" class="difflineminus">-  // hook for extra toolbar items</span>
<a href="#l33.175"></a><span id="l33.175" class="difflineminus">-  var observerService = Components.classes[&quot;@mozilla.org/observer-service;1&quot;].getService(Components.interfaces.nsIObserverService);</span>
<a href="#l33.176"></a><span id="l33.176" class="difflineminus">-  observerService.notifyObservers(window, &quot;mail:setupToolbarItems&quot;, folder.URI);</span>
<a href="#l33.177"></a><span id="l33.177" class="difflineminus">-</span>
<a href="#l33.178"></a><span id="l33.178" class="difflineminus">-  try {</span>
<a href="#l33.179"></a><span id="l33.179" class="difflineminus">-      setTitleFromFolder(viewFolder, null);</span>
<a href="#l33.180"></a><span id="l33.180" class="difflineminus">-  } catch (ex) {</span>
<a href="#l33.181"></a><span id="l33.181" class="difflineminus">-      dump(&quot;error setting title: &quot; + ex + &quot;\n&quot;);</span>
<a href="#l33.182"></a><span id="l33.182" class="difflineminus">-  }</span>
<a href="#l33.183"></a><span id="l33.183" class="difflineminus">-</span>
<a href="#l33.184"></a><span id="l33.184" class="difflineminus">-  //if it's a server, clear the threadpane and don't bother trying to load.</span>
<a href="#l33.185"></a><span id="l33.185" class="difflineminus">-  if(folder.isServer)</span>
<a href="#l33.186"></a><span id="l33.186" class="difflineminus">-  {</span>
<a href="#l33.187"></a><span id="l33.187" class="difflineminus">-    msgWindow.openFolder = null;</span>
<a href="#l33.188"></a><span id="l33.188" class="difflineminus">-    ClearThreadPane();</span>
<a href="#l33.189"></a><span id="l33.189" class="difflineminus">-    UpdateStatusQuota(null);</span>
<a href="#l33.190"></a><span id="l33.190" class="difflineminus">-    // Load AccountCentral page here.</span>
<a href="#l33.191"></a><span id="l33.191" class="difflineminus">-    ShowAccountCentral();</span>
<a href="#l33.192"></a><span id="l33.192" class="difflineminus">-    return;</span>
<a href="#l33.193"></a><span id="l33.193" class="difflineminus">-  }</span>
<a href="#l33.194"></a><span id="l33.194" class="difflineminus">-  else</span>
<a href="#l33.195"></a><span id="l33.195" class="difflineminus">-  {</span>
<a href="#l33.196"></a><span id="l33.196" class="difflineminus">-    if (folder.server.displayStartupPage)</span>
<a href="#l33.197"></a><span id="l33.197" class="difflineminus">-    {</span>
<a href="#l33.198"></a><span id="l33.198" class="difflineminus">-      gDisplayStartupPage = true;</span>
<a href="#l33.199"></a><span id="l33.199" class="difflineminus">-      folder.server.displayStartupPage = false;</span>
<a href="#l33.200"></a><span id="l33.200" class="difflineminus">-    }</span>
<a href="#l33.201"></a><span id="l33.201" class="difflineminus">-  }</span>
<a href="#l33.202"></a><span id="l33.202" class="difflineminus">-</span>
<a href="#l33.203"></a><span id="l33.203" class="difflineminus">-  // If the user clicks on msgfolder, time to display thread pane and message pane.</span>
<a href="#l33.204"></a><span id="l33.204" class="difflineminus">-  ShowThreadPane();</span>
<a href="#l33.205"></a><span id="l33.205" class="difflineminus">-</span>
<a href="#l33.206"></a><span id="l33.206" class="difflineminus">-  gCurrentLoadingFolderURI = folder.URI;</span>
<a href="#l33.207"></a><span id="l33.207" class="difflineminus">-  gNextMessageAfterDelete = null; // forget what message to select, if any</span>
<a href="#l33.208"></a><span id="l33.208" class="difflineminus">-</span>
<a href="#l33.209"></a><span id="l33.209" class="difflineminus">-  gCurrentFolderToReroot = folder.URI;</span>
<a href="#l33.210"></a><span id="l33.210" class="difflineminus">-  gCurrentLoadingFolderViewFlags = viewFlags;</span>
<a href="#l33.211"></a><span id="l33.211" class="difflineminus">-  gCurrentLoadingFolderViewType = viewType;</span>
<a href="#l33.212"></a><span id="l33.212" class="difflineminus">-  gCurrentLoadingFolderSortType = sortType;</span>
<a href="#l33.213"></a><span id="l33.213" class="difflineminus">-  gCurrentLoadingFolderSortOrder = sortOrder;</span>
<a href="#l33.214"></a><span id="l33.214" class="difflineminus">-</span>
<a href="#l33.215"></a><span id="l33.215" class="difflineminus">-  var showMessagesAfterLoading;</span>
<a href="#l33.216"></a><span id="l33.216" class="difflineminus">-  try {</span>
<a href="#l33.217"></a><span id="l33.217" class="difflineminus">-    var server = folder.server;</span>
<a href="#l33.218"></a><span id="l33.218" class="difflineminus">-    if (gPrefBranch.getBoolPref(&quot;mail.password_protect_local_cache&quot;))</span>
<a href="#l33.219"></a><span id="l33.219" class="difflineminus">-    {</span>
<a href="#l33.220"></a><span id="l33.220" class="difflineminus">-      showMessagesAfterLoading = server.passwordPromptRequired;</span>
<a href="#l33.221"></a><span id="l33.221" class="difflineminus">-      // servers w/o passwords (like local mail) will always be non-authenticated.</span>
<a href="#l33.222"></a><span id="l33.222" class="difflineminus">-      // So we need to use the account manager for that case.</span>
<a href="#l33.223"></a><span id="l33.223" class="difflineminus">-    }</span>
<a href="#l33.224"></a><span id="l33.224" class="difflineminus">-    else</span>
<a href="#l33.225"></a><span id="l33.225" class="difflineminus">-      showMessagesAfterLoading = false;</span>
<a href="#l33.226"></a><span id="l33.226" class="difflineminus">-  }</span>
<a href="#l33.227"></a><span id="l33.227" class="difflineminus">-  catch (ex) {</span>
<a href="#l33.228"></a><span id="l33.228" class="difflineminus">-    showMessagesAfterLoading = false;</span>
<a href="#l33.229"></a><span id="l33.229" class="difflineminus">-  }</span>
<a href="#l33.230"></a><span id="l33.230" class="difflineminus">-</span>
<a href="#l33.231"></a><span id="l33.231" class="difflineminus">-  if (viewType != nsMsgViewType.eShowVirtualFolderResults &amp;&amp; (folder.manyHeadersToDownload || showMessagesAfterLoading))</span>
<a href="#l33.232"></a><span id="l33.232" class="difflineminus">-  {</span>
<a href="#l33.233"></a><span id="l33.233" class="difflineminus">-    gRerootOnFolderLoad = true;</span>
<a href="#l33.234"></a><span id="l33.234" class="difflineminus">-    try</span>
<a href="#l33.235"></a><span id="l33.235" class="difflineminus">-    {</span>
<a href="#l33.236"></a><span id="l33.236" class="difflineminus">-      ClearThreadPane();</span>
<a href="#l33.237"></a><span id="l33.237" class="difflineminus">-      SetBusyCursor(window, true);</span>
<a href="#l33.238"></a><span id="l33.238" class="difflineminus">-      folder.startFolderLoading();</span>
<a href="#l33.239"></a><span id="l33.239" class="difflineminus">-      folder.updateFolder(msgWindow);</span>
<a href="#l33.240"></a><span id="l33.240" class="difflineminus">-    }</span>
<a href="#l33.241"></a><span id="l33.241" class="difflineminus">-    catch(ex)</span>
<a href="#l33.242"></a><span id="l33.242" class="difflineminus">-    {</span>
<a href="#l33.243"></a><span id="l33.243" class="difflineminus">-      SetBusyCursor(window, false);</span>
<a href="#l33.244"></a><span id="l33.244" class="difflineminus">-      dump(&quot;Error loading with many headers to download: &quot; + ex + &quot;\n&quot;);</span>
<a href="#l33.245"></a><span id="l33.245" class="difflineminus">-    }</span>
<a href="#l33.246"></a><span id="l33.246" class="difflineminus">-  }</span>
<a href="#l33.247"></a><span id="l33.247" class="difflineminus">-  else</span>
<a href="#l33.248"></a><span id="l33.248" class="difflineminus">-  {</span>
<a href="#l33.249"></a><span id="l33.249" class="difflineminus">-    if (viewType != nsMsgViewType.eShowVirtualFolderResults)</span>
<a href="#l33.250"></a><span id="l33.250" class="difflineminus">-      SetBusyCursor(window, true);</span>
<a href="#l33.251"></a><span id="l33.251" class="difflineminus">-    RerootFolder(folder.URI, folder, viewType, viewFlags, sortType, sortOrder);</span>
<a href="#l33.252"></a><span id="l33.252" class="difflineminus">-    gRerootOnFolderLoad = false;</span>
<a href="#l33.253"></a><span id="l33.253" class="difflineminus">-    folder.startFolderLoading();</span>
<a href="#l33.254"></a><span id="l33.254" class="difflineminus">-</span>
<a href="#l33.255"></a><span id="l33.255" class="difflineminus">-    //Need to do this after rerooting folder.  Otherwise possibility of receiving folder loaded</span>
<a href="#l33.256"></a><span id="l33.256" class="difflineminus">-    //notification before folder has actually changed.</span>
<a href="#l33.257"></a><span id="l33.257" class="difflineminus">-    if (viewType != nsMsgViewType.eShowVirtualFolderResults)</span>
<a href="#l33.258"></a><span id="l33.258" class="difflineminus">-      folder.updateFolder(msgWindow);</span>
<a href="#l33.259"></a><span id="l33.259" class="difflineminus">-  }</span>
<a href="#l33.260"></a><span id="l33.260" class="difflineminus">-}</span>
<a href="#l33.261"></a><span id="l33.261" class="difflineminus">-</span>
<a href="#l33.262"></a><span id="l33.262"> function isNewsURI(uri)</span>
<a href="#l33.263"></a><span id="l33.263"> {</span>
<a href="#l33.264"></a><span id="l33.264">     if (!uri || uri[0] != 'n') {</span>
<a href="#l33.265"></a><span id="l33.265">         return false;</span>
<a href="#l33.266"></a><span id="l33.266">     }</span>
<a href="#l33.267"></a><span id="l33.267">     else {</span>
<a href="#l33.268"></a><span id="l33.268">         return ((uri.substring(0,6) == &quot;news:/&quot;) || (uri.substring(0,14) == &quot;news-message:/&quot;));</span>
<a href="#l33.269"></a><span id="l33.269">     }</span>
<a href="#l33.270"></a><span id="l33.270"> }</span>
<a href="#l33.271"></a><span id="l33.271"> </span>
<a href="#l33.272"></a><span id="l33.272" class="difflineminus">-function UpdateColumnsForView(folder, viewType)</span>
<a href="#l33.273"></a><span id="l33.273" class="difflineminus">-{</span>
<a href="#l33.274"></a><span id="l33.274" class="difflineminus">-  const nsMsgFolderFlags = Components.interfaces.nsMsgFolderFlags;</span>
<a href="#l33.275"></a><span id="l33.275" class="difflineminus">-  // if this is the drafts, sent, or send later folder,</span>
<a href="#l33.276"></a><span id="l33.276" class="difflineminus">-  // we show &quot;Recipient&quot; instead of &quot;Author&quot;</span>
<a href="#l33.277"></a><span id="l33.277" class="difflineminus">-  SetSentFolderColumns(IsSpecialFolder(folder, nsMsgFolderFlags.SentMail | nsMsgFolderFlags.Drafts | nsMsgFolderFlags.Queue, true));</span>
<a href="#l33.278"></a><span id="l33.278" class="difflineminus">-  ShowLocationColumn(viewType == nsMsgViewType.eShowVirtualFolderResults);</span>
<a href="#l33.279"></a><span id="l33.279" class="difflineminus">-  // Only show 'Received' column for e-mails.  For newsgroup messages, the 'Date' header is as reliable as an e-mail's</span>
<a href="#l33.280"></a><span id="l33.280" class="difflineminus">-  // 'Received' header, as it is replaced with the news server's (more reliable) date.</span>
<a href="#l33.281"></a><span id="l33.281" class="difflineminus">-  UpdateReceivedColumn(folder);</span>
<a href="#l33.282"></a><span id="l33.282" class="difflineminus">-}</span>
<a href="#l33.283"></a><span id="l33.283" class="difflineminus">-</span>
<a href="#l33.284"></a><span id="l33.284" class="difflineminus">-function RerootFolder(uri, newFolder, viewType, viewFlags, sortType, sortOrder)</span>
<a href="#l33.285"></a><span id="l33.285" class="difflineminus">-{</span>
<a href="#l33.286"></a><span id="l33.286" class="difflineminus">-  viewDebug(&quot;In reroot folder, sortType = &quot; +  sortType + &quot;viewType = &quot; + viewType + &quot;\n&quot;);</span>
<a href="#l33.287"></a><span id="l33.287" class="difflineminus">-</span>
<a href="#l33.288"></a><span id="l33.288" class="difflineminus">-  if (sortType == 0)</span>
<a href="#l33.289"></a><span id="l33.289" class="difflineminus">-  {</span>
<a href="#l33.290"></a><span id="l33.290" class="difflineminus">-    try</span>
<a href="#l33.291"></a><span id="l33.291" class="difflineminus">-    {</span>
<a href="#l33.292"></a><span id="l33.292" class="difflineminus">-      var dbFolderInfo = newFolder.msgDatabase.dBFolderInfo;</span>
<a href="#l33.293"></a><span id="l33.293" class="difflineminus">-      sortType = dbFolderInfo.sortType;</span>
<a href="#l33.294"></a><span id="l33.294" class="difflineminus">-      sortOrder = dbFolderInfo.sortOrder;</span>
<a href="#l33.295"></a><span id="l33.295" class="difflineminus">-      viewFlags = dbFolderInfo.viewFlags;</span>
<a href="#l33.296"></a><span id="l33.296" class="difflineminus">-      viewType = dbFolderInfo.viewType;</span>
<a href="#l33.297"></a><span id="l33.297" class="difflineminus">-      dbFolderInfo = null;</span>
<a href="#l33.298"></a><span id="l33.298" class="difflineminus">-    }</span>
<a href="#l33.299"></a><span id="l33.299" class="difflineminus">-    catch(ex)</span>
<a href="#l33.300"></a><span id="l33.300" class="difflineminus">-    {</span>
<a href="#l33.301"></a><span id="l33.301" class="difflineminus">-      dump(&quot;invalid db in RerootFolder: &quot; + ex + &quot;\n&quot;);</span>
<a href="#l33.302"></a><span id="l33.302" class="difflineminus">-    }</span>
<a href="#l33.303"></a><span id="l33.303" class="difflineminus">-  }</span>
<a href="#l33.304"></a><span id="l33.304" class="difflineminus">-</span>
<a href="#l33.305"></a><span id="l33.305" class="difflineminus">-  // workaround for #39655</span>
<a href="#l33.306"></a><span id="l33.306" class="difflineminus">-  gFolderJustSwitched = true;</span>
<a href="#l33.307"></a><span id="l33.307" class="difflineminus">-</span>
<a href="#l33.308"></a><span id="l33.308" class="difflineminus">-  ClearThreadPaneSelection();</span>
<a href="#l33.309"></a><span id="l33.309" class="difflineminus">-</span>
<a href="#l33.310"></a><span id="l33.310" class="difflineminus">-  //Clear the new messages of the old folder</span>
<a href="#l33.311"></a><span id="l33.311" class="difflineminus">-  var oldFolder = gPrevSelectedFolder;</span>
<a href="#l33.312"></a><span id="l33.312" class="difflineminus">-  if (oldFolder) {</span>
<a href="#l33.313"></a><span id="l33.313" class="difflineminus">-    oldFolder.clearNewMessages();</span>
<a href="#l33.314"></a><span id="l33.314" class="difflineminus">-    oldFolder.hasNewMessages = false;</span>
<a href="#l33.315"></a><span id="l33.315" class="difflineminus">-  }</span>
<a href="#l33.316"></a><span id="l33.316" class="difflineminus">-</span>
<a href="#l33.317"></a><span id="l33.317" class="difflineminus">-  //Set the window's new open folder.</span>
<a href="#l33.318"></a><span id="l33.318" class="difflineminus">-  msgWindow.openFolder = newFolder;</span>
<a href="#l33.319"></a><span id="l33.319" class="difflineminus">-</span>
<a href="#l33.320"></a><span id="l33.320" class="difflineminus">-  //the new folder being selected should have its biff state get cleared.</span>
<a href="#l33.321"></a><span id="l33.321" class="difflineminus">-  if(newFolder)</span>
<a href="#l33.322"></a><span id="l33.322" class="difflineminus">-  {</span>
<a href="#l33.323"></a><span id="l33.323" class="difflineminus">-    newFolder.biffState =</span>
<a href="#l33.324"></a><span id="l33.324" class="difflineminus">-          Components.interfaces.nsIMsgFolder.nsMsgBiffState_NoMail;</span>
<a href="#l33.325"></a><span id="l33.325" class="difflineminus">-  }</span>
<a href="#l33.326"></a><span id="l33.326" class="difflineminus">-</span>
<a href="#l33.327"></a><span id="l33.327" class="difflineminus">-  //Clear out the thread pane so that we can sort it with the new sort id without taking any time.</span>
<a href="#l33.328"></a><span id="l33.328" class="difflineminus">-  // folder.setAttribute('ref', &quot;&quot;);</span>
<a href="#l33.329"></a><span id="l33.329" class="difflineminus">-</span>
<a href="#l33.330"></a><span id="l33.330" class="difflineminus">-  // null this out, so we don't try sort.</span>
<a href="#l33.331"></a><span id="l33.331" class="difflineminus">-  if (gDBView) {</span>
<a href="#l33.332"></a><span id="l33.332" class="difflineminus">-    gDBView.close();</span>
<a href="#l33.333"></a><span id="l33.333" class="difflineminus">-    gDBView = null;</span>
<a href="#l33.334"></a><span id="l33.334" class="difflineminus">-  }</span>
<a href="#l33.335"></a><span id="l33.335" class="difflineminus">-</span>
<a href="#l33.336"></a><span id="l33.336" class="difflineminus">-  // cancel the pending mark as read timer</span>
<a href="#l33.337"></a><span id="l33.337" class="difflineminus">-  ClearPendingReadTimer();</span>
<a href="#l33.338"></a><span id="l33.338" class="difflineminus">-</span>
<a href="#l33.339"></a><span id="l33.339" class="difflineminus">-  UpdateColumnsForView(newFolder, viewType);</span>
<a href="#l33.340"></a><span id="l33.340" class="difflineminus">-  // now create the db view, which will sort it.</span>
<a href="#l33.341"></a><span id="l33.341" class="difflineminus">-  CreateDBView(newFolder, viewType, viewFlags, sortType, sortOrder);</span>
<a href="#l33.342"></a><span id="l33.342" class="difflineminus">-</span>
<a href="#l33.343"></a><span id="l33.343" class="difflineminus">-  if (oldFolder)</span>
<a href="#l33.344"></a><span id="l33.344" class="difflineminus">-  {</span>
<a href="#l33.345"></a><span id="l33.345" class="difflineminus">-    /* we don't null out the db reference for inbox because inbox is like the &quot;main&quot; folder</span>
<a href="#l33.346"></a><span id="l33.346" class="difflineminus">-               and performance outweighs footprint*/</span>
<a href="#l33.347"></a><span id="l33.347" class="difflineminus">-    if (!IsSpecialFolder(oldFolder, Components.interfaces.nsMsgFolderFlags.Inbox, false))</span>
<a href="#l33.348"></a><span id="l33.348" class="difflineminus">-    {</span>
<a href="#l33.349"></a><span id="l33.349" class="difflineminus">-      if (oldFolder.URI != newFolder.URI)</span>
<a href="#l33.350"></a><span id="l33.350" class="difflineminus">-        oldFolder.msgDatabase = null;</span>
<a href="#l33.351"></a><span id="l33.351" class="difflineminus">-    }</span>
<a href="#l33.352"></a><span id="l33.352" class="difflineminus">-  }</span>
<a href="#l33.353"></a><span id="l33.353" class="difflineminus">-  // that should have initialized gDBView, now re-root the thread pane</span>
<a href="#l33.354"></a><span id="l33.354" class="difflineminus">-  RerootThreadPane();</span>
<a href="#l33.355"></a><span id="l33.355" class="difflineminus">-  SetUpToolbarButtons(uri);</span>
<a href="#l33.356"></a><span id="l33.356" class="difflineminus">-  UpdateStatusMessageCounts(gMsgFolderSelected);</span>
<a href="#l33.357"></a><span id="l33.357" class="difflineminus">-  </span>
<a href="#l33.358"></a><span id="l33.358" class="difflineminus">-  // hook for extra toolbar items</span>
<a href="#l33.359"></a><span id="l33.359" class="difflineminus">-  var observerService = Components.classes[&quot;@mozilla.org/observer-service;1&quot;].getService(Components.interfaces.nsIObserverService);</span>
<a href="#l33.360"></a><span id="l33.360" class="difflineminus">-  observerService.notifyObservers(window, &quot;mail:updateToolbarItems&quot;, null);</span>
<a href="#l33.361"></a><span id="l33.361" class="difflineminus">-  // this is to kick off cross-folder searches for virtual folders.</span>
<a href="#l33.362"></a><span id="l33.362" class="difflineminus">-  if (gSearchSession &amp;&amp; !gVirtualFolderTerms) // another var might be better...</span>
<a href="#l33.363"></a><span id="l33.363" class="difflineminus">-  {</span>
<a href="#l33.364"></a><span id="l33.364" class="difflineminus">-    viewDebug(&quot;doing a xf folder search in rerootFolder\n&quot;);</span>
<a href="#l33.365"></a><span id="l33.365" class="difflineminus">-    gCurrentLoadingFolderURI = &quot;&quot;</span>
<a href="#l33.366"></a><span id="l33.366" class="difflineminus">-    ViewChangeByFolder(newFolder);</span>
<a href="#l33.367"></a><span id="l33.367" class="difflineminus">-    gPreQuickSearchView = null; // don't remember the cross folder search</span>
<a href="#l33.368"></a><span id="l33.368" class="difflineminus">-    ScrollToMessageAfterFolderLoad(newFolder);</span>
<a href="#l33.369"></a><span id="l33.369" class="difflineminus">-  }</span>
<a href="#l33.370"></a><span id="l33.370" class="difflineminus">-}</span>
<a href="#l33.371"></a><span id="l33.371" class="difflineminus">-</span>
<a href="#l33.372"></a><span id="l33.372"> function SwitchView(command)</span>
<a href="#l33.373"></a><span id="l33.373"> {</span>
<a href="#l33.374"></a><span id="l33.374">   // when switching thread views, we might be coming out of quick search</span>
<a href="#l33.375"></a><span id="l33.375">   // or a message view.</span>
<a href="#l33.376"></a><span id="l33.376">   // first set view picker to all</span>
<a href="#l33.377"></a><span id="l33.377" class="difflineminus">-  if (gCurrentViewValue != kViewItemAll)</span>
<a href="#l33.378"></a><span id="l33.378" class="difflineminus">-    ViewChangeByValue(kViewItemAll);</span>
<a href="#l33.379"></a><span id="l33.379" class="difflineplus">+  if (gFolderDisplay.view.mailViewIndex != kViewItemAll)</span>
<a href="#l33.380"></a><span id="l33.380" class="difflineplus">+    gFolderDisplay.view.setMailView(kViewItemAll);</span>
<a href="#l33.381"></a><span id="l33.381"> </span>
<a href="#l33.382"></a><span id="l33.382" class="difflineminus">-  // clear the QS text, if we need to</span>
<a href="#l33.383"></a><span id="l33.383" class="difflineminus">-  ClearQSIfNecessary();</span>
<a href="#l33.384"></a><span id="l33.384" class="difflineminus">-  </span>
<a href="#l33.385"></a><span id="l33.385" class="difflineminus">-  var oldSortType, oldSortOrder, viewFlags, viewType, db;</span>
<a href="#l33.386"></a><span id="l33.386" class="difflineminus">-  // now switch views</span>
<a href="#l33.387"></a><span id="l33.387" class="difflineminus">-  if (gDBView) </span>
<a href="#l33.388"></a><span id="l33.388" class="difflineminus">-  {</span>
<a href="#l33.389"></a><span id="l33.389" class="difflineminus">-    oldSortType = gDBView.sortType;</span>
<a href="#l33.390"></a><span id="l33.390" class="difflineminus">-    oldSortOrder = gDBView.sortOrder;</span>
<a href="#l33.391"></a><span id="l33.391" class="difflineminus">-    viewFlags = gDBView.viewFlags;</span>
<a href="#l33.392"></a><span id="l33.392" class="difflineminus">-    viewType = gDBView.viewType;</span>
<a href="#l33.393"></a><span id="l33.393" class="difflineminus">-    db = gDBView.db;</span>
<a href="#l33.394"></a><span id="l33.394" class="difflineminus">-    gDBView.close();</span>
<a href="#l33.395"></a><span id="l33.395" class="difflineminus">-    gDBView = null; </span>
<a href="#l33.396"></a><span id="l33.396" class="difflineminus">-  }</span>
<a href="#l33.397"></a><span id="l33.397" class="difflineminus">-  else</span>
<a href="#l33.398"></a><span id="l33.398" class="difflineminus">-  {</span>
<a href="#l33.399"></a><span id="l33.399" class="difflineminus">-    oldSortType = nsMsgViewSortType.byThread;</span>
<a href="#l33.400"></a><span id="l33.400" class="difflineminus">-    oldSortOrder = nsMsgViewSortOrder.ascending;</span>
<a href="#l33.401"></a><span id="l33.401" class="difflineminus">-    viewFlags = gCurViewFlags;</span>
<a href="#l33.402"></a><span id="l33.402" class="difflineminus">-    viewType = nsMsgViewType.eShowAllThreads;</span>
<a href="#l33.403"></a><span id="l33.403" class="difflineminus">-    db = null;</span>
<a href="#l33.404"></a><span id="l33.404" class="difflineminus">-  }</span>
<a href="#l33.405"></a><span id="l33.405">   switch(command)</span>
<a href="#l33.406"></a><span id="l33.406">   {</span>
<a href="#l33.407"></a><span id="l33.407">     // &quot;All&quot; threads and &quot;Unread&quot; threads don't change threading state</span>
<a href="#l33.408"></a><span id="l33.408">     case &quot;cmd_viewAllMsgs&quot;:</span>
<a href="#l33.409"></a><span id="l33.409" class="difflineminus">-      viewType = nsMsgViewType.eShowAllThreads;</span>
<a href="#l33.410"></a><span id="l33.410" class="difflineminus">-      viewFlags = viewFlags &amp; ~nsMsgViewFlagsType.kUnreadOnly;</span>
<a href="#l33.411"></a><span id="l33.411" class="difflineplus">+      gFolderDisplay.view.showUnreadOnly = false;</span>
<a href="#l33.412"></a><span id="l33.412">       break;</span>
<a href="#l33.413"></a><span id="l33.413">     case &quot;cmd_viewUnreadMsgs&quot;:</span>
<a href="#l33.414"></a><span id="l33.414" class="difflineminus">-      viewType = nsMsgViewType.eShowAllThreads;</span>
<a href="#l33.415"></a><span id="l33.415" class="difflineminus">-      viewFlags = viewFlags | nsMsgViewFlagsType.kUnreadOnly;</span>
<a href="#l33.416"></a><span id="l33.416" class="difflineplus">+      gFolderDisplay.view.showUnreadOnly = true;</span>
<a href="#l33.417"></a><span id="l33.417">       break;</span>
<a href="#l33.418"></a><span id="l33.418">     // &quot;Threads with Unread&quot; and &quot;Watched Threads with Unread&quot; force threading</span>
<a href="#l33.419"></a><span id="l33.419">     case &quot;cmd_viewWatchedThreadsWithUnread&quot;:</span>
<a href="#l33.420"></a><span id="l33.420" class="difflineminus">-      viewType = nsMsgViewType.eShowWatchedThreadsWithUnread;</span>
<a href="#l33.421"></a><span id="l33.421" class="difflineminus">-      viewFlags |= nsMsgViewFlagsType.kThreadedDisplay;</span>
<a href="#l33.422"></a><span id="l33.422" class="difflineplus">+      gFolderDisplay.view.specialViewWatchedThreadsWithUnread = true;</span>
<a href="#l33.423"></a><span id="l33.423">       break;</span>
<a href="#l33.424"></a><span id="l33.424">     case &quot;cmd_viewThreadsWithUnread&quot;:</span>
<a href="#l33.425"></a><span id="l33.425" class="difflineminus">-      viewType = nsMsgViewType.eShowThreadsWithUnread;</span>
<a href="#l33.426"></a><span id="l33.426" class="difflineminus">-      viewFlags |= nsMsgViewFlagsType.kThreadedDisplay;</span>
<a href="#l33.427"></a><span id="l33.427" class="difflineplus">+      gFolderDisplay.view.specialViewThreadsWithUnread = true;</span>
<a href="#l33.428"></a><span id="l33.428">       break;</span>
<a href="#l33.429"></a><span id="l33.429">     // &quot;Ignored Threads&quot; toggles 'ignored' inclusion --</span>
<a href="#l33.430"></a><span id="l33.430">     //   but it also resets 'With Unread' views to 'All'</span>
<a href="#l33.431"></a><span id="l33.431">     case &quot;cmd_viewIgnoredThreads&quot;:</span>
<a href="#l33.432"></a><span id="l33.432" class="difflineminus">-      viewType = nsMsgViewType.eShowAllThreads;</span>
<a href="#l33.433"></a><span id="l33.433" class="difflineminus">-      if (viewFlags &amp; nsMsgViewFlagsType.kShowIgnored)</span>
<a href="#l33.434"></a><span id="l33.434" class="difflineminus">-        viewFlags = viewFlags &amp; ~nsMsgViewFlagsType.kShowIgnored;</span>
<a href="#l33.435"></a><span id="l33.435" class="difflineminus">-      else</span>
<a href="#l33.436"></a><span id="l33.436" class="difflineminus">-        viewFlags = viewFlags | nsMsgViewFlagsType.kShowIgnored;</span>
<a href="#l33.437"></a><span id="l33.437" class="difflineplus">+      gFolderDisplay.view.showIgnored = !gFolderDisplay.view.showIgnored;</span>
<a href="#l33.438"></a><span id="l33.438">       break;</span>
<a href="#l33.439"></a><span id="l33.439">   }</span>
<a href="#l33.440"></a><span id="l33.440" class="difflineminus">-</span>
<a href="#l33.441"></a><span id="l33.441" class="difflineminus">-  if (db &amp;&amp; viewType == nsMsgViewType.eShowVirtualFolderResults)</span>
<a href="#l33.442"></a><span id="l33.442" class="difflineminus">-  {</span>
<a href="#l33.443"></a><span id="l33.443" class="difflineminus">-      db.dBFolderInfo.viewFlags = viewFlags;</span>
<a href="#l33.444"></a><span id="l33.444" class="difflineminus">-      gMsgFolderSelected = null;</span>
<a href="#l33.445"></a><span id="l33.445" class="difflineminus">-      msgWindow.openFolder = null;</span>
<a href="#l33.446"></a><span id="l33.446" class="difflineminus">-      FolderPaneSelectionChange();</span>
<a href="#l33.447"></a><span id="l33.447" class="difflineminus">-      LoadCurrentlyDisplayedMessage();</span>
<a href="#l33.448"></a><span id="l33.448" class="difflineminus">-  }</span>
<a href="#l33.449"></a><span id="l33.449" class="difflineminus">-  else</span>
<a href="#l33.450"></a><span id="l33.450" class="difflineminus">-  {</span>
<a href="#l33.451"></a><span id="l33.451" class="difflineminus">-    CreateDBView(msgWindow.openFolder, viewType, viewFlags, oldSortType,</span>
<a href="#l33.452"></a><span id="l33.452" class="difflineminus">-                 oldSortOrder);</span>
<a href="#l33.453"></a><span id="l33.453" class="difflineminus">-  RerootThreadPane();</span>
<a href="#l33.454"></a><span id="l33.454" class="difflineminus">-  }</span>
<a href="#l33.455"></a><span id="l33.455" class="difflineminus">-}</span>
<a href="#l33.456"></a><span id="l33.456" class="difflineminus">-</span>
<a href="#l33.457"></a><span id="l33.457" class="difflineminus">-function SetSentFolderColumns(isSentFolder)</span>
<a href="#l33.458"></a><span id="l33.458" class="difflineminus">-{</span>
<a href="#l33.459"></a><span id="l33.459" class="difflineminus">-  var tree = GetThreadTree();</span>
<a href="#l33.460"></a><span id="l33.460" class="difflineminus">-</span>
<a href="#l33.461"></a><span id="l33.461" class="difflineminus">-  var lastFolderSent = tree.getAttribute(&quot;lastfoldersent&quot;) == &quot;true&quot;;</span>
<a href="#l33.462"></a><span id="l33.462" class="difflineminus">-  if (isSentFolder != lastFolderSent)</span>
<a href="#l33.463"></a><span id="l33.463" class="difflineminus">-  {</span>
<a href="#l33.464"></a><span id="l33.464" class="difflineminus">-    var senderColumn = document.getElementById(&quot;senderCol&quot;);</span>
<a href="#l33.465"></a><span id="l33.465" class="difflineminus">-    var recipientColumn = document.getElementById(&quot;recipientCol&quot;);</span>
<a href="#l33.466"></a><span id="l33.466" class="difflineminus">-    </span>
<a href="#l33.467"></a><span id="l33.467" class="difflineminus">-    var saveHidden = senderColumn.getAttribute(&quot;hidden&quot;);</span>
<a href="#l33.468"></a><span id="l33.468" class="difflineminus">-    senderColumn.setAttribute(&quot;hidden&quot;, senderColumn.getAttribute(&quot;swappedhidden&quot;));</span>
<a href="#l33.469"></a><span id="l33.469" class="difflineminus">-    senderColumn.setAttribute(&quot;swappedhidden&quot;, saveHidden);</span>
<a href="#l33.470"></a><span id="l33.470" class="difflineminus">-</span>
<a href="#l33.471"></a><span id="l33.471" class="difflineminus">-    saveHidden = recipientColumn.getAttribute(&quot;hidden&quot;);</span>
<a href="#l33.472"></a><span id="l33.472" class="difflineminus">-    recipientColumn.setAttribute(&quot;hidden&quot;, recipientColumn.getAttribute(&quot;swappedhidden&quot;));</span>
<a href="#l33.473"></a><span id="l33.473" class="difflineminus">-    recipientColumn.setAttribute(&quot;swappedhidden&quot;, saveHidden);</span>
<a href="#l33.474"></a><span id="l33.474" class="difflineminus">-  }</span>
<a href="#l33.475"></a><span id="l33.475" class="difflineminus">-</span>
<a href="#l33.476"></a><span id="l33.476" class="difflineminus">-  if(isSentFolder)</span>
<a href="#l33.477"></a><span id="l33.477" class="difflineminus">-    tree.setAttribute(&quot;lastfoldersent&quot;, &quot;true&quot;);</span>
<a href="#l33.478"></a><span id="l33.478" class="difflineminus">-  else</span>
<a href="#l33.479"></a><span id="l33.479" class="difflineminus">-    tree.setAttribute(&quot;lastfoldersent&quot;, &quot;false&quot;);</span>
<a href="#l33.480"></a><span id="l33.480" class="difflineminus">-}</span>
<a href="#l33.481"></a><span id="l33.481" class="difflineminus">-</span>
<a href="#l33.482"></a><span id="l33.482" class="difflineminus">-function ShowLocationColumn(show)</span>
<a href="#l33.483"></a><span id="l33.483" class="difflineminus">-{</span>
<a href="#l33.484"></a><span id="l33.484" class="difflineminus">-  var col = document.getElementById(&quot;locationCol&quot;);</span>
<a href="#l33.485"></a><span id="l33.485" class="difflineminus">-  if (col) {</span>
<a href="#l33.486"></a><span id="l33.486" class="difflineminus">-    if (show) {</span>
<a href="#l33.487"></a><span id="l33.487" class="difflineminus">-      col.removeAttribute(&quot;hidden&quot;);</span>
<a href="#l33.488"></a><span id="l33.488" class="difflineminus">-      col.removeAttribute(&quot;ignoreincolumnpicker&quot;);</span>
<a href="#l33.489"></a><span id="l33.489" class="difflineminus">-    }</span>
<a href="#l33.490"></a><span id="l33.490" class="difflineminus">-    else {</span>
<a href="#l33.491"></a><span id="l33.491" class="difflineminus">-      col.setAttribute(&quot;hidden&quot;,&quot;true&quot;);</span>
<a href="#l33.492"></a><span id="l33.492" class="difflineminus">-      col.setAttribute(&quot;ignoreincolumnpicker&quot;,&quot;true&quot;);</span>
<a href="#l33.493"></a><span id="l33.493" class="difflineminus">-    }</span>
<a href="#l33.494"></a><span id="l33.494" class="difflineminus">-  }</span>
<a href="#l33.495"></a><span id="l33.495" class="difflineminus">-}</span>
<a href="#l33.496"></a><span id="l33.496" class="difflineminus">-</span>
<a href="#l33.497"></a><span id="l33.497" class="difflineminus">-function UpdateReceivedColumn(newFolder)</span>
<a href="#l33.498"></a><span id="l33.498" class="difflineminus">-{</span>
<a href="#l33.499"></a><span id="l33.499" class="difflineminus">-  // Only show 'Received' column for e-mails.  For newsgroup messages, the 'Date' header is as reliable as an e-mail's</span>
<a href="#l33.500"></a><span id="l33.500" class="difflineminus">-  // 'Received' header, as it is replaced with the news server's (more reliable) date.</span>
<a href="#l33.501"></a><span id="l33.501" class="difflineminus">-  var receivedColumn = document.getElementById(&quot;receivedCol&quot;);</span>
<a href="#l33.502"></a><span id="l33.502" class="difflineminus">-</span>
<a href="#l33.503"></a><span id="l33.503" class="difflineminus">-  const nsMsgFolderFlags = Components.interfaces.nsMsgFolderFlags;</span>
<a href="#l33.504"></a><span id="l33.504" class="difflineminus">-  var newFolderShowsRcvd = (newFolder.flags &amp; nsMsgFolderFlags.Mail) &amp;&amp;</span>
<a href="#l33.505"></a><span id="l33.505" class="difflineminus">-    !(newFolder.flags &amp; (nsMsgFolderFlags.Queue | nsMsgFolderFlags.Drafts |</span>
<a href="#l33.506"></a><span id="l33.506" class="difflineminus">-                         nsMsgFolderFlags.Templates |</span>
<a href="#l33.507"></a><span id="l33.507" class="difflineminus">-                         nsMsgFolderFlags.SentMail));</span>
<a href="#l33.508"></a><span id="l33.508" class="difflineminus">-    </span>
<a href="#l33.509"></a><span id="l33.509" class="difflineminus">-  var tempHidden = receivedColumn.getAttribute(&quot;temphidden&quot;) == &quot;true&quot;;</span>
<a href="#l33.510"></a><span id="l33.510" class="difflineminus">-  var isHidden = receivedColumn.getAttribute(&quot;hidden&quot;) == &quot;true&quot;;</span>
<a href="#l33.511"></a><span id="l33.511" class="difflineminus">-  </span>
<a href="#l33.512"></a><span id="l33.512" class="difflineminus">-  if (!newFolderShowsRcvd &amp;&amp; !isHidden)</span>
<a href="#l33.513"></a><span id="l33.513" class="difflineminus">-  {</span>
<a href="#l33.514"></a><span id="l33.514" class="difflineminus">-    // Record state &amp; hide</span>
<a href="#l33.515"></a><span id="l33.515" class="difflineminus">-    receivedColumn.setAttribute(&quot;temphidden&quot;, &quot;true&quot;);</span>
<a href="#l33.516"></a><span id="l33.516" class="difflineminus">-    receivedColumn.setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l33.517"></a><span id="l33.517" class="difflineminus">-  }</span>
<a href="#l33.518"></a><span id="l33.518" class="difflineminus">-  else if (newFolderShowsRcvd &amp;&amp; tempHidden &amp;&amp; isHidden)</span>
<a href="#l33.519"></a><span id="l33.519" class="difflineminus">-  {</span>
<a href="#l33.520"></a><span id="l33.520" class="difflineminus">-    receivedColumn.setAttribute(&quot;hidden&quot;, &quot;false&quot;);</span>
<a href="#l33.521"></a><span id="l33.521" class="difflineminus">-  }</span>
<a href="#l33.522"></a><span id="l33.522" class="difflineminus">-  </span>
<a href="#l33.523"></a><span id="l33.523" class="difflineminus">-  if (newFolderShowsRcvd)</span>
<a href="#l33.524"></a><span id="l33.524" class="difflineminus">-  {</span>
<a href="#l33.525"></a><span id="l33.525" class="difflineminus">-    receivedColumn.removeAttribute(&quot;ignoreincolumnpicker&quot;);</span>
<a href="#l33.526"></a><span id="l33.526" class="difflineminus">-    receivedColumn.removeAttribute(&quot;temphidden&quot;);</span>
<a href="#l33.527"></a><span id="l33.527" class="difflineminus">-  }</span>
<a href="#l33.528"></a><span id="l33.528" class="difflineminus">-  else</span>
<a href="#l33.529"></a><span id="l33.529" class="difflineminus">-    receivedColumn.setAttribute(&quot;ignoreincolumnpicker&quot;, &quot;true&quot;);</span>
<a href="#l33.530"></a><span id="l33.530"> }</span>
<a href="#l33.531"></a><span id="l33.531"> </span>
<a href="#l33.532"></a><span id="l33.532"> function SetNewsFolderColumns()</span>
<a href="#l33.533"></a><span id="l33.533"> {</span>
<a href="#l33.534"></a><span id="l33.534">   var sizeColumn = document.getElementById(&quot;sizeCol&quot;);</span>
<a href="#l33.535"></a><span id="l33.535"> </span>
<a href="#l33.536"></a><span id="l33.536">   if (gDBView.usingLines) {</span>
<a href="#l33.537"></a><span id="l33.537">      sizeColumn.setAttribute(&quot;label&quot;,gMessengerBundle.getString(&quot;linesColumnHeader&quot;));</span>
<a href="#l33.538"></a><span id="l33.538" class="difflineat">@@ -494,17 +120,17 @@ function UpdateStatusMessageCounts(folde</span>
<a href="#l33.539"></a><span id="l33.539">   var unreadElement = GetUnreadCountElement();</span>
<a href="#l33.540"></a><span id="l33.540">   var totalElement = GetTotalCountElement();</span>
<a href="#l33.541"></a><span id="l33.541">   if(folder &amp;&amp; unreadElement &amp;&amp; totalElement)</span>
<a href="#l33.542"></a><span id="l33.542">   {</span>
<a href="#l33.543"></a><span id="l33.543">     var numSelected = GetNumSelectedMessages();</span>
<a href="#l33.544"></a><span id="l33.544"> </span>
<a href="#l33.545"></a><span id="l33.545">     var numUnread = (numSelected &gt; 1) ?</span>
<a href="#l33.546"></a><span id="l33.546">             gMessengerBundle.getFormattedString(&quot;selectedMsgStatus&quot;,</span>
<a href="#l33.547"></a><span id="l33.547" class="difflineminus">-                                                [numSelected]) :    </span>
<a href="#l33.548"></a><span id="l33.548" class="difflineplus">+                                                [numSelected]) :</span>
<a href="#l33.549"></a><span id="l33.549">             gMessengerBundle.getFormattedString(&quot;unreadMsgStatus&quot;,</span>
<a href="#l33.550"></a><span id="l33.550">                                                 [ folder.getNumUnread(false)]);</span>
<a href="#l33.551"></a><span id="l33.551">     var numTotal =</span>
<a href="#l33.552"></a><span id="l33.552">             gMessengerBundle.getFormattedString(&quot;totalMsgStatus&quot;,</span>
<a href="#l33.553"></a><span id="l33.553">                                                 [folder.getTotalMessages(false)]);</span>
<a href="#l33.554"></a><span id="l33.554"> </span>
<a href="#l33.555"></a><span id="l33.555">     unreadElement.setAttribute(&quot;label&quot;, numUnread);</span>
<a href="#l33.556"></a><span id="l33.556">     totalElement.setAttribute(&quot;label&quot;, numTotal);</span>
<a href="#l33.557"></a><span id="l33.557" class="difflineat">@@ -637,19 +263,18 @@ function ConvertSortTypeToColumnID(sortK</span>
<a href="#l33.558"></a><span id="l33.558">     case nsMsgViewSortType.byAttachments:</span>
<a href="#l33.559"></a><span id="l33.559">       columnID = &quot;attachmentCol&quot;;</span>
<a href="#l33.560"></a><span id="l33.560">       break;</span>
<a href="#l33.561"></a><span id="l33.561">     case nsMsgViewSortType.byCustom:</span>
<a href="#l33.562"></a><span id="l33.562"> </span>
<a href="#l33.563"></a><span id="l33.563">       //TODO: either change try() catch to if (property exists) or restore the getColumnHandler() check</span>
<a href="#l33.564"></a><span id="l33.564">       try //getColumnHandler throws an errror when the ID is not handled</span>
<a href="#l33.565"></a><span id="l33.565">       {</span>
<a href="#l33.566"></a><span id="l33.566" class="difflineminus">-        columnID = gDBView.db.dBFolderInfo.getProperty('customSortCol');</span>
<a href="#l33.567"></a><span id="l33.567" class="difflineplus">+        columnID = gDBView.curCustomColumn;</span>
<a href="#l33.568"></a><span id="l33.568">       }</span>
<a href="#l33.569"></a><span id="l33.569" class="difflineminus">-</span>
<a href="#l33.570"></a><span id="l33.570">       catch (err) { //error - means no handler</span>
<a href="#l33.571"></a><span id="l33.571">         dump(&quot;ConvertSortTypeToColumnID: custom sort key but no handler for column '&quot; + columnID + &quot;'\n&quot;);</span>
<a href="#l33.572"></a><span id="l33.572">         columnID = &quot;dateCol&quot;;</span>
<a href="#l33.573"></a><span id="l33.573">       }</span>
<a href="#l33.574"></a><span id="l33.574"> </span>
<a href="#l33.575"></a><span id="l33.575">       break;</span>
<a href="#l33.576"></a><span id="l33.576">     default:</span>
<a href="#l33.577"></a><span id="l33.577">       dump(&quot;unsupported sort key: &quot; + sortKey + &quot;\n&quot;);</span>
<a href="#l33.578"></a><span id="l33.578" class="difflineat">@@ -665,314 +290,86 @@ var nsMsgViewFlagsType = Components.inte</span>
<a href="#l33.579"></a><span id="l33.579"> var nsMsgViewCommandType = Components.interfaces.nsMsgViewCommandType;</span>
<a href="#l33.580"></a><span id="l33.580"> var nsMsgViewType = Components.interfaces.nsMsgViewType;</span>
<a href="#l33.581"></a><span id="l33.581"> var nsMsgNavigationType = Components.interfaces.nsMsgNavigationType;</span>
<a href="#l33.582"></a><span id="l33.582"> </span>
<a href="#l33.583"></a><span id="l33.583"> var gDBView = null;</span>
<a href="#l33.584"></a><span id="l33.584"> var gCurViewFlags;</span>
<a href="#l33.585"></a><span id="l33.585"> var gCurSortType;</span>
<a href="#l33.586"></a><span id="l33.586"> </span>
<a href="#l33.587"></a><span id="l33.587" class="difflineminus">-// CreateDBView is called when we have a thread pane. CreateBareDBView is called when there is no</span>
<a href="#l33.588"></a><span id="l33.588" class="difflineminus">-// tree associated with the view. CreateDBView will call into CreateBareDBView...</span>
<a href="#l33.589"></a><span id="l33.589" class="difflineminus">-</span>
<a href="#l33.590"></a><span id="l33.590" class="difflineminus">-function CreateBareDBView(originalView, msgFolder, viewType, viewFlags, sortType, sortOrder)</span>
<a href="#l33.591"></a><span id="l33.591" class="difflineminus">-{</span>
<a href="#l33.592"></a><span id="l33.592" class="difflineminus">-  var dbviewContractId = &quot;@mozilla.org/messenger/msgdbview;1?type=&quot;;</span>
<a href="#l33.593"></a><span id="l33.593" class="difflineminus">-  // hack to turn this into an integer, if it was a string</span>
<a href="#l33.594"></a><span id="l33.594" class="difflineminus">-  // it would be a string if it came from localStore.rdf</span>
<a href="#l33.595"></a><span id="l33.595" class="difflineminus">-  viewType = viewType - 0;</span>
<a href="#l33.596"></a><span id="l33.596" class="difflineminus">-</span>
<a href="#l33.597"></a><span id="l33.597" class="difflineminus">-  switch (viewType) {</span>
<a href="#l33.598"></a><span id="l33.598" class="difflineminus">-      case nsMsgViewType.eShowQuickSearchResults:</span>
<a href="#l33.599"></a><span id="l33.599" class="difflineminus">-          dbviewContractId += &quot;quicksearch&quot;;</span>
<a href="#l33.600"></a><span id="l33.600" class="difflineminus">-          break;</span>
<a href="#l33.601"></a><span id="l33.601" class="difflineminus">-      case nsMsgViewType.eShowThreadsWithUnread:</span>
<a href="#l33.602"></a><span id="l33.602" class="difflineminus">-          dbviewContractId += &quot;threadswithunread&quot;;</span>
<a href="#l33.603"></a><span id="l33.603" class="difflineminus">-          break;</span>
<a href="#l33.604"></a><span id="l33.604" class="difflineminus">-      case nsMsgViewType.eShowWatchedThreadsWithUnread:</span>
<a href="#l33.605"></a><span id="l33.605" class="difflineminus">-          dbviewContractId += &quot;watchedthreadswithunread&quot;;</span>
<a href="#l33.606"></a><span id="l33.606" class="difflineminus">-          break;</span>
<a href="#l33.607"></a><span id="l33.607" class="difflineminus">-      case nsMsgViewType.eShowVirtualFolderResults:</span>
<a href="#l33.608"></a><span id="l33.608" class="difflineminus">-          dbviewContractId += &quot;xfvf&quot;;</span>
<a href="#l33.609"></a><span id="l33.609" class="difflineminus">-          break;</span>
<a href="#l33.610"></a><span id="l33.610" class="difflineminus">-      case nsMsgViewType.eShowSearch:</span>
<a href="#l33.611"></a><span id="l33.611" class="difflineminus">-          dbviewContractId += &quot;search&quot;;</span>
<a href="#l33.612"></a><span id="l33.612" class="difflineminus">-          break;</span>
<a href="#l33.613"></a><span id="l33.613" class="difflineminus">-      case nsMsgViewType.eShowAllThreads:</span>
<a href="#l33.614"></a><span id="l33.614" class="difflineminus">-      default:</span>
<a href="#l33.615"></a><span id="l33.615" class="difflineminus">-          if (sortType == nsMsgViewSortType.byThread || sortType == nsMsgViewSortType.byId</span>
<a href="#l33.616"></a><span id="l33.616" class="difflineminus">-            || sortType == nsMsgViewSortType.byNone)</span>
<a href="#l33.617"></a><span id="l33.617" class="difflineminus">-            viewFlags &amp;= ~nsMsgViewFlagsType.kGroupBySort;</span>
<a href="#l33.618"></a><span id="l33.618" class="difflineminus">-</span>
<a href="#l33.619"></a><span id="l33.619" class="difflineminus">-          if (viewFlags &amp; nsMsgViewFlagsType.kGroupBySort)</span>
<a href="#l33.620"></a><span id="l33.620" class="difflineminus">-            dbviewContractId += &quot;group&quot;;</span>
<a href="#l33.621"></a><span id="l33.621" class="difflineminus">-          else</span>
<a href="#l33.622"></a><span id="l33.622" class="difflineminus">-            dbviewContractId += &quot;threaded&quot;;</span>
<a href="#l33.623"></a><span id="l33.623" class="difflineminus">-          break;</span>
<a href="#l33.624"></a><span id="l33.624" class="difflineminus">-  }</span>
<a href="#l33.625"></a><span id="l33.625" class="difflineminus">-</span>
<a href="#l33.626"></a><span id="l33.626" class="difflineminus">-  //  dump (&quot;contract id = &quot; + dbviewContractId + &quot;original view = &quot; + originalView + &quot;\n&quot;);</span>
<a href="#l33.627"></a><span id="l33.627" class="difflineminus">-  if (!originalView)</span>
<a href="#l33.628"></a><span id="l33.628" class="difflineminus">-    gDBView = Components.classes[dbviewContractId].createInstance(Components.interfaces.nsIMsgDBView);</span>
<a href="#l33.629"></a><span id="l33.629" class="difflineminus">-</span>
<a href="#l33.630"></a><span id="l33.630" class="difflineminus">-  gCurViewFlags = viewFlags;</span>
<a href="#l33.631"></a><span id="l33.631" class="difflineminus">-  var count = new Object;</span>
<a href="#l33.632"></a><span id="l33.632" class="difflineminus">-  if (!gThreadPaneCommandUpdater)</span>
<a href="#l33.633"></a><span id="l33.633" class="difflineminus">-    gThreadPaneCommandUpdater = new nsMsgDBViewCommandUpdater();</span>
<a href="#l33.634"></a><span id="l33.634" class="difflineminus">-</span>
<a href="#l33.635"></a><span id="l33.635" class="difflineminus">-  gCurSortType = sortType;</span>
<a href="#l33.636"></a><span id="l33.636" class="difflineminus">-</span>
<a href="#l33.637"></a><span id="l33.637" class="difflineminus">-  if (!originalView) {</span>
<a href="#l33.638"></a><span id="l33.638" class="difflineminus">-    gDBView.init(messenger, msgWindow, gThreadPaneCommandUpdater);</span>
<a href="#l33.639"></a><span id="l33.639" class="difflineminus">-    gDBView.open(msgFolder, gCurSortType, sortOrder, viewFlags, count);</span>
<a href="#l33.640"></a><span id="l33.640" class="difflineminus">-    if (viewType == nsMsgViewType.eShowVirtualFolderResults)</span>
<a href="#l33.641"></a><span id="l33.641" class="difflineminus">-    {</span>
<a href="#l33.642"></a><span id="l33.642" class="difflineminus">-      // the view is a listener on the search results</span>
<a href="#l33.643"></a><span id="l33.643" class="difflineminus">-      gViewSearchListener = gDBView.QueryInterface(Components.interfaces.nsIMsgSearchNotify);</span>
<a href="#l33.644"></a><span id="l33.644" class="difflineminus">-      gSearchSession.registerListener(gViewSearchListener);</span>
<a href="#l33.645"></a><span id="l33.645" class="difflineminus">-    }</span>
<a href="#l33.646"></a><span id="l33.646" class="difflineminus">-  } </span>
<a href="#l33.647"></a><span id="l33.647" class="difflineminus">-  else {</span>
<a href="#l33.648"></a><span id="l33.648" class="difflineminus">-    gDBView = originalView.cloneDBView(messenger, msgWindow, gThreadPaneCommandUpdater);</span>
<a href="#l33.649"></a><span id="l33.649" class="difflineminus">-  }</span>
<a href="#l33.650"></a><span id="l33.650" class="difflineminus">-}</span>
<a href="#l33.651"></a><span id="l33.651" class="difflineminus">-</span>
<a href="#l33.652"></a><span id="l33.652" class="difflineminus">-function CreateDBView(msgFolder, viewType, viewFlags, sortType, sortOrder)</span>
<a href="#l33.653"></a><span id="l33.653" class="difflineminus">-{</span>
<a href="#l33.654"></a><span id="l33.654" class="difflineminus">-  // call the inner create method</span>
<a href="#l33.655"></a><span id="l33.655" class="difflineminus">-  CreateBareDBView(null, msgFolder, viewType, viewFlags, sortType, sortOrder);</span>
<a href="#l33.656"></a><span id="l33.656" class="difflineminus">-</span>
<a href="#l33.657"></a><span id="l33.657" class="difflineminus">-  // now do tree specific work</span>
<a href="#l33.658"></a><span id="l33.658" class="difflineminus">-</span>
<a href="#l33.659"></a><span id="l33.659" class="difflineminus">-  // based on the collapsed state of the thread pane/message pane splitter,</span>
<a href="#l33.660"></a><span id="l33.660" class="difflineminus">-  // suppress message display if appropriate.</span>
<a href="#l33.661"></a><span id="l33.661" class="difflineminus">-  gDBView.suppressMsgDisplay = IsMessagePaneCollapsed();</span>
<a href="#l33.662"></a><span id="l33.662" class="difflineminus">-</span>
<a href="#l33.663"></a><span id="l33.663" class="difflineminus">-  UpdateSortIndicators(gCurSortType, sortOrder);</span>
<a href="#l33.664"></a><span id="l33.664" class="difflineminus">-  var ObserverService = Components.classes[&quot;@mozilla.org/observer-service;1&quot;].getService(Components.interfaces.nsIObserverService);</span>
<a href="#l33.665"></a><span id="l33.665" class="difflineminus">-  ObserverService.notifyObservers(msgFolder, &quot;MsgCreateDBView&quot;, viewType + &quot;:&quot; + viewFlags);</span>
<a href="#l33.666"></a><span id="l33.666" class="difflineminus">-}</span>
<a href="#l33.667"></a><span id="l33.667"> </span>
<a href="#l33.668"></a><span id="l33.668"> function ChangeMessagePaneVisibility(now_hidden)</span>
<a href="#l33.669"></a><span id="l33.669"> {</span>
<a href="#l33.670"></a><span id="l33.670">   // we also have to hide the File/Attachments menuitem</span>
<a href="#l33.671"></a><span id="l33.671">   var node = document.getElementById(&quot;fileAttachmentMenu&quot;);</span>
<a href="#l33.672"></a><span id="l33.672">   if (node)</span>
<a href="#l33.673"></a><span id="l33.673">     node.hidden = now_hidden;</span>
<a href="#l33.674"></a><span id="l33.674"> </span>
<a href="#l33.675"></a><span id="l33.675" class="difflineminus">-  if (gDBView) {</span>
<a href="#l33.676"></a><span id="l33.676" class="difflineminus">-    // the collapsed state is the state after we released the mouse </span>
<a href="#l33.677"></a><span id="l33.677" class="difflineminus">-    // so we take it as it is</span>
<a href="#l33.678"></a><span id="l33.678" class="difflineminus">-    gDBView.suppressMsgDisplay = now_hidden;</span>
<a href="#l33.679"></a><span id="l33.679" class="difflineminus">-  }</span>
<a href="#l33.680"></a><span id="l33.680" class="difflineplus">+  gMessageDisplay.visible = !now_hidden;</span>
<a href="#l33.681"></a><span id="l33.681" class="difflineplus">+</span>
<a href="#l33.682"></a><span id="l33.682">   var event = document.createEvent('Events');</span>
<a href="#l33.683"></a><span id="l33.683">   if (now_hidden) {</span>
<a href="#l33.684"></a><span id="l33.684">     event.initEvent('messagepane-hide', false, true);</span>
<a href="#l33.685"></a><span id="l33.685">   }</span>
<a href="#l33.686"></a><span id="l33.686">   else {</span>
<a href="#l33.687"></a><span id="l33.687">     event.initEvent('messagepane-unhide', false, true);</span>
<a href="#l33.688"></a><span id="l33.688">   }</span>
<a href="#l33.689"></a><span id="l33.689">   document.getElementById(&quot;messengerWindow&quot;).dispatchEvent(event);</span>
<a href="#l33.690"></a><span id="l33.690"> }</span>
<a href="#l33.691"></a><span id="l33.691"> </span>
<a href="#l33.692"></a><span id="l33.692"> function OnMouseUpThreadAndMessagePaneSplitter()</span>
<a href="#l33.693"></a><span id="l33.693"> {</span>
<a href="#l33.694"></a><span id="l33.694" class="difflineminus">-  // the collapsed state is the state after we released the mouse </span>
<a href="#l33.695"></a><span id="l33.695" class="difflineminus">-  // so we take it as it is</span>
<a href="#l33.696"></a><span id="l33.696" class="difflineplus">+  // The collapsed state is the state after we released the mouse,</span>
<a href="#l33.697"></a><span id="l33.697" class="difflineplus">+  // so we take it as it is.</span>
<a href="#l33.698"></a><span id="l33.698">   ChangeMessagePaneVisibility(IsMessagePaneCollapsed());</span>
<a href="#l33.699"></a><span id="l33.699"> }</span>
<a href="#l33.700"></a><span id="l33.700"> </span>
<a href="#l33.701"></a><span id="l33.701" class="difflineplus">+/**</span>
<a href="#l33.702"></a><span id="l33.702" class="difflineplus">+ * Our multiplexed tabbing model ends up sending synthetic folder pane</span>
<a href="#l33.703"></a><span id="l33.703" class="difflineplus">+ *  selection change notifications.  We want to ignore these because the</span>
<a href="#l33.704"></a><span id="l33.704" class="difflineplus">+ *  user may explicitly re-select a folder intentionally, and we want to</span>
<a href="#l33.705"></a><span id="l33.705" class="difflineplus">+ *  be able to know that.  So we filter out the synthetics here.</span>
<a href="#l33.706"></a><span id="l33.706" class="difflineplus">+ * The tabbing logic sets this global to help us out.</span>
<a href="#l33.707"></a><span id="l33.707" class="difflineplus">+ */</span>
<a href="#l33.708"></a><span id="l33.708" class="difflineplus">+var gIgnoreSyntheticFolderPaneSelectionChange = false;</span>
<a href="#l33.709"></a><span id="l33.709"> function FolderPaneSelectionChange()</span>
<a href="#l33.710"></a><span id="l33.710"> {</span>
<a href="#l33.711"></a><span id="l33.711" class="difflineminus">-    var folderSelection = gFolderTreeView.selection;</span>
<a href="#l33.712"></a><span id="l33.712" class="difflineminus">-</span>
<a href="#l33.713"></a><span id="l33.713" class="difflineminus">-    // This prevents a folder from being loaded in the case that the user</span>
<a href="#l33.714"></a><span id="l33.714" class="difflineminus">-    // has right-clicked on a folder different from the one that was</span>
<a href="#l33.715"></a><span id="l33.715" class="difflineminus">-    // originally highlighted.  On a right-click, the highlight (selection)</span>
<a href="#l33.716"></a><span id="l33.716" class="difflineminus">-    // of a row will be different from the value of currentIndex, thus if</span>
<a href="#l33.717"></a><span id="l33.717" class="difflineminus">-    // the currentIndex is not selected, it means the user right-clicked</span>
<a href="#l33.718"></a><span id="l33.718" class="difflineminus">-    // and we don't want to load the contents of the folder.</span>
<a href="#l33.719"></a><span id="l33.719" class="difflineminus">-    if (!folderSelection.isSelected(folderSelection.currentIndex))</span>
<a href="#l33.720"></a><span id="l33.720" class="difflineminus">-      return;</span>
<a href="#l33.721"></a><span id="l33.721" class="difflineminus">-</span>
<a href="#l33.722"></a><span id="l33.722" class="difflineminus">-    gVirtualFolderTerms = null;</span>
<a href="#l33.723"></a><span id="l33.723" class="difflineminus">-    gXFVirtualFolderTerms = null;</span>
<a href="#l33.724"></a><span id="l33.724" class="difflineminus">-</span>
<a href="#l33.725"></a><span id="l33.725" class="difflineminus">-    var folders = GetSelectedMsgFolders();</span>
<a href="#l33.726"></a><span id="l33.726" class="difflineminus">-    if (folders.length == 1)</span>
<a href="#l33.727"></a><span id="l33.727" class="difflineminus">-    {</span>
<a href="#l33.728"></a><span id="l33.728" class="difflineminus">-        var msgFolder = folders[0];</span>
<a href="#l33.729"></a><span id="l33.729" class="difflineminus">-        var uriToLoad = msgFolder.URI;</span>
<a href="#l33.730"></a><span id="l33.730" class="difflineplus">+  if (gIgnoreSyntheticFolderPaneSelectionChange) {</span>
<a href="#l33.731"></a><span id="l33.731" class="difflineplus">+    gIgnoreSyntheticFolderPaneSelectionChange = false;</span>
<a href="#l33.732"></a><span id="l33.732" class="difflineplus">+    return;</span>
<a href="#l33.733"></a><span id="l33.733" class="difflineplus">+  }</span>
<a href="#l33.734"></a><span id="l33.734"> </span>
<a href="#l33.735"></a><span id="l33.735" class="difflineminus">-        if (msgFolder == gMsgFolderSelected)</span>
<a href="#l33.736"></a><span id="l33.736" class="difflineminus">-           return;</span>
<a href="#l33.737"></a><span id="l33.737" class="difflineminus">-        // If msgFolder turns out to be a single folder saved search, a virtual folder,</span>
<a href="#l33.738"></a><span id="l33.738" class="difflineminus">-        // realFolder will get set to the underlying folder the</span>
<a href="#l33.739"></a><span id="l33.739" class="difflineminus">-        // saved search is based on.</span>
<a href="#l33.740"></a><span id="l33.740" class="difflineminus">-        var realFolder = msgFolder;</span>
<a href="#l33.741"></a><span id="l33.741" class="difflineminus">-        gPrevSelectedFolder = gMsgFolderSelected;</span>
<a href="#l33.742"></a><span id="l33.742" class="difflineminus">-        gMsgFolderSelected = msgFolder;</span>
<a href="#l33.743"></a><span id="l33.743" class="difflineminus">-        var folderFlags = msgFolder.flags;</span>
<a href="#l33.744"></a><span id="l33.744" class="difflineminus">-        // If this is same folder, and we're not showing a virtual folder</span>
<a href="#l33.745"></a><span id="l33.745" class="difflineminus">-        // then do nothing.</span>
<a href="#l33.746"></a><span id="l33.746" class="difflineminus">-        const nsMsgFolderFlags = Components.interfaces.nsMsgFolderFlags;</span>
<a href="#l33.747"></a><span id="l33.747" class="difflineminus">-        if (msgFolder == msgWindow.openFolder &amp;&amp;</span>
<a href="#l33.748"></a><span id="l33.748" class="difflineminus">-            !(folderFlags &amp; nsMsgFolderFlags.Virtual) &amp;&amp;</span>
<a href="#l33.749"></a><span id="l33.749" class="difflineminus">-            !(gPrevFolderFlags &amp; nsMsgFolderFlags.Virtual))</span>
<a href="#l33.750"></a><span id="l33.750" class="difflineminus">-        {</span>
<a href="#l33.751"></a><span id="l33.751" class="difflineminus">-            return;</span>
<a href="#l33.752"></a><span id="l33.752" class="difflineminus">-        }</span>
<a href="#l33.753"></a><span id="l33.753" class="difflineminus">-        else</span>
<a href="#l33.754"></a><span id="l33.754" class="difflineminus">-        {</span>
<a href="#l33.755"></a><span id="l33.755" class="difflineminus">-            const outFolderFlagMask = nsMsgFolderFlags.SentMail |</span>
<a href="#l33.756"></a><span id="l33.756" class="difflineminus">-              nsMsgFolderFlags.Drafts | nsMsgFolderFlags.Queue |</span>
<a href="#l33.757"></a><span id="l33.757" class="difflineminus">-              nsMsgFolderFlags.Templates;</span>
<a href="#l33.758"></a><span id="l33.758" class="difflineminus">-            if (IsSpecialFolder(gMsgFolderSelected, outFolderFlagMask, true))</span>
<a href="#l33.759"></a><span id="l33.759" class="difflineminus">-            {</span>
<a href="#l33.760"></a><span id="l33.760" class="difflineminus">-              if (!gPrevSelectedFolder ||</span>
<a href="#l33.761"></a><span id="l33.761" class="difflineminus">-                  !IsSpecialFolder(gPrevSelectedFolder, outFolderFlagMask, true))</span>
<a href="#l33.762"></a><span id="l33.762" class="difflineminus">-                onSearchFolderTypeChanged(true);</span>
<a href="#l33.763"></a><span id="l33.763" class="difflineminus">-            }</span>
<a href="#l33.764"></a><span id="l33.764" class="difflineminus">-            else</span>
<a href="#l33.765"></a><span id="l33.765" class="difflineminus">-            {</span>
<a href="#l33.766"></a><span id="l33.766" class="difflineminus">-              if (!gPrevSelectedFolder ||</span>
<a href="#l33.767"></a><span id="l33.767" class="difflineminus">-                  IsSpecialFolder(gPrevSelectedFolder, outFolderFlagMask, true))</span>
<a href="#l33.768"></a><span id="l33.768" class="difflineminus">-                onSearchFolderTypeChanged(false);</span>
<a href="#l33.769"></a><span id="l33.769" class="difflineminus">-            }</span>
<a href="#l33.770"></a><span id="l33.770" class="difflineplus">+  let folderSelection = gFolderTreeView.selection;</span>
<a href="#l33.771"></a><span id="l33.771"> </span>
<a href="#l33.772"></a><span id="l33.772" class="difflineminus">-            OnLeavingFolder(gPrevSelectedFolder);  // mark all read in last folder</span>
<a href="#l33.773"></a><span id="l33.773" class="difflineminus">-            var sortType = 0;</span>
<a href="#l33.774"></a><span id="l33.774" class="difflineminus">-            var sortOrder = 0;</span>
<a href="#l33.775"></a><span id="l33.775" class="difflineminus">-            var viewFlags = 0;</span>
<a href="#l33.776"></a><span id="l33.776" class="difflineminus">-            var viewType = 0;</span>
<a href="#l33.777"></a><span id="l33.777" class="difflineminus">-            gDefaultSearchViewTerms = null;</span>
<a href="#l33.778"></a><span id="l33.778" class="difflineminus">-            gVirtualFolderTerms = null;</span>
<a href="#l33.779"></a><span id="l33.779" class="difflineminus">-            gXFVirtualFolderTerms = null;</span>
<a href="#l33.780"></a><span id="l33.780" class="difflineminus">-            gPrevFolderFlags = folderFlags;</span>
<a href="#l33.781"></a><span id="l33.781" class="difflineminus">-            gCurrentVirtualFolderUri = null;</span>
<a href="#l33.782"></a><span id="l33.782" class="difflineminus">-            // don't get the db if this folder is a server</span>
<a href="#l33.783"></a><span id="l33.783" class="difflineminus">-            // we're going to be display account central</span>
<a href="#l33.784"></a><span id="l33.784" class="difflineminus">-            if (!(msgFolder.isServer)) </span>
<a href="#l33.785"></a><span id="l33.785" class="difflineminus">-            {</span>
<a href="#l33.786"></a><span id="l33.786" class="difflineminus">-              try </span>
<a href="#l33.787"></a><span id="l33.787" class="difflineminus">-              {</span>
<a href="#l33.788"></a><span id="l33.788" class="difflineminus">-                var msgDatabase = msgFolder.msgDatabase;</span>
<a href="#l33.789"></a><span id="l33.789" class="difflineminus">-                if (msgDatabase)</span>
<a href="#l33.790"></a><span id="l33.790" class="difflineminus">-                {</span>
<a href="#l33.791"></a><span id="l33.791" class="difflineminus">-                  var dbFolderInfo = msgDatabase.dBFolderInfo;</span>
<a href="#l33.792"></a><span id="l33.792" class="difflineminus">-                  sortType = dbFolderInfo.sortType;</span>
<a href="#l33.793"></a><span id="l33.793" class="difflineminus">-                  sortOrder = dbFolderInfo.sortOrder;</span>
<a href="#l33.794"></a><span id="l33.794" class="difflineminus">-                  viewFlags = dbFolderInfo.viewFlags;</span>
<a href="#l33.795"></a><span id="l33.795" class="difflineminus">-                  if (folderFlags &amp; Components.interfaces.nsMsgFolderFlags.Virtual)</span>
<a href="#l33.796"></a><span id="l33.796" class="difflineminus">-                  {</span>
<a href="#l33.797"></a><span id="l33.797" class="difflineminus">-                    viewType = nsMsgViewType.eShowQuickSearchResults;</span>
<a href="#l33.798"></a><span id="l33.798" class="difflineminus">-                    var searchTermString = dbFolderInfo.getCharProperty(&quot;searchStr&quot;);</span>
<a href="#l33.799"></a><span id="l33.799" class="difflineminus">-                    var searchOnline = dbFolderInfo.getBooleanProperty(&quot;searchOnline&quot;, false);</span>
<a href="#l33.800"></a><span id="l33.800" class="difflineminus">-                    // trick the view code into updating the real folder...</span>
<a href="#l33.801"></a><span id="l33.801" class="difflineminus">-                    gCurrentVirtualFolderUri = uriToLoad;</span>
<a href="#l33.802"></a><span id="l33.802" class="difflineminus">-                    viewDebug(&quot;uriToLoad = &quot; + uriToLoad + &quot;\n&quot;);</span>
<a href="#l33.803"></a><span id="l33.803" class="difflineminus">-                    var srchFolderUri = dbFolderInfo.getCharProperty(&quot;searchFolderUri&quot;);</span>
<a href="#l33.804"></a><span id="l33.804" class="difflineminus">-                    var srchFolderUriArray = srchFolderUri.split('|');</span>
<a href="#l33.805"></a><span id="l33.805" class="difflineminus">-                    // cross folder search</span>
<a href="#l33.806"></a><span id="l33.806" class="difflineminus">-                    var filterService = Components.classes[&quot;@mozilla.org/messenger/services/filters;1&quot;].getService(Components.interfaces.nsIMsgFilterService);</span>
<a href="#l33.807"></a><span id="l33.807" class="difflineminus">-                    var filterList = filterService.getTempFilterList(msgFolder);</span>
<a href="#l33.808"></a><span id="l33.808" class="difflineminus">-                    var tempFilter = filterList.createFilter(&quot;temp&quot;);</span>
<a href="#l33.809"></a><span id="l33.809" class="difflineminus">-                    filterList.parseCondition(tempFilter, searchTermString);</span>
<a href="#l33.810"></a><span id="l33.810" class="difflineminus">-                    if (srchFolderUriArray.length &gt; 1)</span>
<a href="#l33.811"></a><span id="l33.811" class="difflineminus">-                    {</span>
<a href="#l33.812"></a><span id="l33.812" class="difflineminus">-                      viewType = nsMsgViewType.eShowVirtualFolderResults;</span>
<a href="#l33.813"></a><span id="l33.813" class="difflineminus">-                      gXFVirtualFolderTerms = CreateGroupedSearchTerms(tempFilter.searchTerms);</span>
<a href="#l33.814"></a><span id="l33.814" class="difflineminus">-                      setupXFVirtualFolderSearch(srchFolderUriArray, gXFVirtualFolderTerms, searchOnline);</span>
<a href="#l33.815"></a><span id="l33.815" class="difflineminus">-                      // need to set things up so that reroot folder issues the search</span>
<a href="#l33.816"></a><span id="l33.816" class="difflineminus">-                    }</span>
<a href="#l33.817"></a><span id="l33.817" class="difflineminus">-                    else</span>
<a href="#l33.818"></a><span id="l33.818" class="difflineminus">-                    {</span>
<a href="#l33.819"></a><span id="l33.819" class="difflineminus">-                      gSearchSession = null;</span>
<a href="#l33.820"></a><span id="l33.820" class="difflineminus">-                      uriToLoad = srchFolderUri;</span>
<a href="#l33.821"></a><span id="l33.821" class="difflineminus">-                      // we need to load the db for the actual folder so that many hdrs to download</span>
<a href="#l33.822"></a><span id="l33.822" class="difflineminus">-                      // will return false...</span>
<a href="#l33.823"></a><span id="l33.823" class="difflineminus">-                      realFolder = GetMsgFolderFromUri(uriToLoad);</span>
<a href="#l33.824"></a><span id="l33.824" class="difflineminus">-                      msgDatabase = realFolder.msgDatabase;</span>
<a href="#l33.825"></a><span id="l33.825" class="difflineminus">-                      gVirtualFolderTerms = CreateGroupedSearchTerms(tempFilter.searchTerms);</span>
<a href="#l33.826"></a><span id="l33.826" class="difflineminus">-                    }</span>
<a href="#l33.827"></a><span id="l33.827" class="difflineminus">-                  }</span>
<a href="#l33.828"></a><span id="l33.828" class="difflineminus">-                  else</span>
<a href="#l33.829"></a><span id="l33.829" class="difflineminus">-                  {</span>
<a href="#l33.830"></a><span id="l33.830" class="difflineminus">-                    gSearchSession = null;</span>
<a href="#l33.831"></a><span id="l33.831" class="difflineminus">-                    viewFlags = dbFolderInfo.viewFlags;</span>
<a href="#l33.832"></a><span id="l33.832" class="difflineminus">-                    viewType = dbFolderInfo.viewType;</span>
<a href="#l33.833"></a><span id="l33.833" class="difflineminus">-                  }</span>
<a href="#l33.834"></a><span id="l33.834" class="difflineminus">-                  msgDatabase = null;</span>
<a href="#l33.835"></a><span id="l33.835" class="difflineminus">-                  dbFolderInfo = null;</span>
<a href="#l33.836"></a><span id="l33.836" class="difflineminus">-                }</span>
<a href="#l33.837"></a><span id="l33.837" class="difflineminus">-              }</span>
<a href="#l33.838"></a><span id="l33.838" class="difflineminus">-              catch (ex)</span>
<a href="#l33.839"></a><span id="l33.839" class="difflineminus">-              {</span>
<a href="#l33.840"></a><span id="l33.840" class="difflineminus">-                dump(&quot;failed to get view &amp; sort values.  ex = &quot; + ex +&quot;\n&quot;);</span>
<a href="#l33.841"></a><span id="l33.841" class="difflineminus">-              }</span>
<a href="#l33.842"></a><span id="l33.842" class="difflineminus">-            }</span>
<a href="#l33.843"></a><span id="l33.843" class="difflineminus">-            if (gDBView &amp;&amp; gDBView.viewType == nsMsgViewType.eShowQuickSearchResults)</span>
<a href="#l33.844"></a><span id="l33.844" class="difflineminus">-            {</span>
<a href="#l33.845"></a><span id="l33.845" class="difflineminus">-              if (gPreQuickSearchView) //close cached view before quick search</span>
<a href="#l33.846"></a><span id="l33.846" class="difflineminus">-              {</span>
<a href="#l33.847"></a><span id="l33.847" class="difflineminus">-                gPreQuickSearchView.close();</span>
<a href="#l33.848"></a><span id="l33.848" class="difflineminus">-                gPreQuickSearchView = null;  </span>
<a href="#l33.849"></a><span id="l33.849" class="difflineminus">-              }</span>
<a href="#l33.850"></a><span id="l33.850" class="difflineminus">-              ClearQSIfNecessary();</span>
<a href="#l33.851"></a><span id="l33.851" class="difflineminus">-            }</span>
<a href="#l33.852"></a><span id="l33.852" class="difflineminus">-            ClearMessagePane();</span>
<a href="#l33.853"></a><span id="l33.853" class="difflineplus">+  // This prevents a folder from being loaded in the case that the user</span>
<a href="#l33.854"></a><span id="l33.854" class="difflineplus">+  // has right-clicked on a folder different from the one that was</span>
<a href="#l33.855"></a><span id="l33.855" class="difflineplus">+  // originally highlighted.  On a right-click, the highlight (selection)</span>
<a href="#l33.856"></a><span id="l33.856" class="difflineplus">+  // of a row will be different from the value of currentIndex, thus if</span>
<a href="#l33.857"></a><span id="l33.857" class="difflineplus">+  // the currentIndex is not selected, it means the user right-clicked</span>
<a href="#l33.858"></a><span id="l33.858" class="difflineplus">+  // and we don't want to load the contents of the folder.</span>
<a href="#l33.859"></a><span id="l33.859" class="difflineplus">+  if (!folderSelection.isSelected(folderSelection.currentIndex))</span>
<a href="#l33.860"></a><span id="l33.860" class="difflineplus">+    return;</span>
<a href="#l33.861"></a><span id="l33.861"> </span>
<a href="#l33.862"></a><span id="l33.862" class="difflineminus">-            if (gXFVirtualFolderTerms)</span>
<a href="#l33.863"></a><span id="l33.863" class="difflineminus">-              viewType = nsMsgViewType.eShowVirtualFolderResults;</span>
<a href="#l33.864"></a><span id="l33.864" class="difflineminus">-            else if (gSearchEmailAddress || gVirtualFolderTerms)</span>
<a href="#l33.865"></a><span id="l33.865" class="difflineminus">-              viewType = nsMsgViewType.eShowQuickSearchResults;</span>
<a href="#l33.866"></a><span id="l33.866" class="difflineminus">-            else if (viewType == nsMsgViewType.eShowQuickSearchResults)</span>
<a href="#l33.867"></a><span id="l33.867" class="difflineminus">-              viewType = nsMsgViewType.eShowAllThreads;  //override viewType - we don't want to start w/ quick search</span>
<a href="#l33.868"></a><span id="l33.868" class="difflineminus">-            ChangeFolder(realFolder, msgFolder, viewType, viewFlags, sortType, sortOrder);</span>
<a href="#l33.869"></a><span id="l33.869" class="difflineminus">-            if (gVirtualFolderTerms)</span>
<a href="#l33.870"></a><span id="l33.870" class="difflineminus">-              gDBView.viewFolder = msgFolder;</span>
<a href="#l33.871"></a><span id="l33.871" class="difflineminus">-        }</span>
<a href="#l33.872"></a><span id="l33.872" class="difflineminus">-        document.getElementById('tabmail').setTabTitle(null);</span>
<a href="#l33.873"></a><span id="l33.873" class="difflineminus">-    }</span>
<a href="#l33.874"></a><span id="l33.874" class="difflineminus">-    else</span>
<a href="#l33.875"></a><span id="l33.875" class="difflineminus">-    {</span>
<a href="#l33.876"></a><span id="l33.876" class="difflineminus">-      msgWindow.openFolder = null;</span>
<a href="#l33.877"></a><span id="l33.877" class="difflineminus">-      ClearThreadPane();</span>
<a href="#l33.878"></a><span id="l33.878" class="difflineminus">-    }</span>
<a href="#l33.879"></a><span id="l33.879" class="difflineminus">-</span>
<a href="#l33.880"></a><span id="l33.880" class="difflineminus">-    var startpageenabled = gPrefBranch.getBoolPref(&quot;mailnews.start_page.enabled&quot;);</span>
<a href="#l33.881"></a><span id="l33.881" class="difflineminus">-    if (gDisplayStartupPage &amp;&amp; startpageenabled)</span>
<a href="#l33.882"></a><span id="l33.882" class="difflineminus">-    {</span>
<a href="#l33.883"></a><span id="l33.883" class="difflineminus">-      loadStartPage();</span>
<a href="#l33.884"></a><span id="l33.884" class="difflineminus">-      gDisplayStartupPage = false;</span>
<a href="#l33.885"></a><span id="l33.885" class="difflineminus">-    }</span>
<a href="#l33.886"></a><span id="l33.886" class="difflineminus">-    UpdateMailToolbar(&quot;FolderPaneSelectionChange&quot;);</span>
<a href="#l33.887"></a><span id="l33.887" class="difflineminus">-}</span>
<a href="#l33.888"></a><span id="l33.888" class="difflineminus">-</span>
<a href="#l33.889"></a><span id="l33.889" class="difflineminus">-function ClearThreadPane()</span>
<a href="#l33.890"></a><span id="l33.890" class="difflineminus">-{</span>
<a href="#l33.891"></a><span id="l33.891" class="difflineminus">-  if (gDBView) {</span>
<a href="#l33.892"></a><span id="l33.892" class="difflineminus">-    gDBView.close();</span>
<a href="#l33.893"></a><span id="l33.893" class="difflineminus">-    gDBView = null; </span>
<a href="#l33.894"></a><span id="l33.894" class="difflineminus">-  }</span>
<a href="#l33.895"></a><span id="l33.895" class="difflineplus">+  let folders = GetSelectedMsgFolders();</span>
<a href="#l33.896"></a><span id="l33.896" class="difflineplus">+  gFolderDisplay.show(folders.length ? folders[0] : null);</span>
<a href="#l33.897"></a><span id="l33.897"> }</span>
<a href="#l33.898"></a><span id="l33.898"> </span>
<a href="#l33.899"></a><span id="l33.899"> function IsSpecialFolder(msgFolder, flags, checkAncestors)</span>
<a href="#l33.900"></a><span id="l33.900"> {</span>
<a href="#l33.901"></a><span id="l33.901" class="difflineminus">-    if (!msgFolder) </span>
<a href="#l33.902"></a><span id="l33.902" class="difflineplus">+    if (!msgFolder)</span>
<a href="#l33.903"></a><span id="l33.903">         return false;</span>
<a href="#l33.904"></a><span id="l33.904">     else if ((msgFolder.flags &amp; flags) == 0)</span>
<a href="#l33.905"></a><span id="l33.905">     {</span>
<a href="#l33.906"></a><span id="l33.906">       var parentMsgFolder = msgFolder.parentMsgFolder;</span>
<a href="#l33.907"></a><span id="l33.907"> </span>
<a href="#l33.908"></a><span id="l33.908">       return (parentMsgFolder &amp;&amp; checkAncestors) ? IsSpecialFolder(parentMsgFolder, flags, true) : false;</span>
<a href="#l33.909"></a><span id="l33.909">     }</span>
<a href="#l33.910"></a><span id="l33.910">     else {</span>
<a href="#l33.911"></a><span id="l33.911">         // the user can set their INBOX to be their SENT folder.</span>
<a href="#l33.912"></a><span id="l33.912" class="difflineminus">-        // in that case, we want this folder to act like an INBOX, </span>
<a href="#l33.913"></a><span id="l33.913" class="difflineplus">+        // in that case, we want this folder to act like an INBOX,</span>
<a href="#l33.914"></a><span id="l33.914">         // and not a SENT folder</span>
<a href="#l33.915"></a><span id="l33.915">         const nsMsgFolderFlags = Components.interfaces.nsMsgFolderFlags;</span>
<a href="#l33.916"></a><span id="l33.916">         return !((flags &amp; nsMsgFolderFlags.SentMail) &amp;&amp;</span>
<a href="#l33.917"></a><span id="l33.917">                  (msgFolder.flags &amp; nsMsgFolderFlags.Inbox));</span>
<a href="#l33.918"></a><span id="l33.918">     }</span>
<a href="#l33.919"></a><span id="l33.919"> }</span>
<a href="#l33.920"></a><span id="l33.920"> </span>
<a href="#l33.921"></a><span id="l33.921"> function Undo()</span>
<a href="#l33.922"></a><span id="l33.922" class="difflineat">@@ -980,166 +377,10 @@ function Undo()</span>
<a href="#l33.923"></a><span id="l33.923">     messenger.undo(msgWindow);</span>
<a href="#l33.924"></a><span id="l33.924"> }</span>
<a href="#l33.925"></a><span id="l33.925"> </span>
<a href="#l33.926"></a><span id="l33.926"> function Redo()</span>
<a href="#l33.927"></a><span id="l33.927"> {</span>
<a href="#l33.928"></a><span id="l33.928">     messenger.redo(msgWindow);</span>
<a href="#l33.929"></a><span id="l33.929"> }</span>
<a href="#l33.930"></a><span id="l33.930"> </span>
<a href="#l33.931"></a><span id="l33.931" class="difflineminus">-function getSearchTermString(searchTerms)</span>
<a href="#l33.932"></a><span id="l33.932" class="difflineminus">-{</span>
<a href="#l33.933"></a><span id="l33.933" class="difflineminus">-  var searchIndex;</span>
<a href="#l33.934"></a><span id="l33.934" class="difflineminus">-  var condition = &quot;&quot;;</span>
<a href="#l33.935"></a><span id="l33.935" class="difflineminus">-  var count = searchTerms.Count();</span>
<a href="#l33.936"></a><span id="l33.936" class="difflineminus">-  for (searchIndex = 0; searchIndex &lt; count; )</span>
<a href="#l33.937"></a><span id="l33.937" class="difflineminus">-  {</span>
<a href="#l33.938"></a><span id="l33.938" class="difflineminus">-    var term = searchTerms.QueryElementAt(searchIndex++, Components.interfaces.nsIMsgSearchTerm);</span>
<a href="#l33.939"></a><span id="l33.939" class="difflineminus">-    </span>
<a href="#l33.940"></a><span id="l33.940" class="difflineminus">-    if (condition.length &gt; 1)</span>
<a href="#l33.941"></a><span id="l33.941" class="difflineminus">-      condition += ' ';</span>
<a href="#l33.942"></a><span id="l33.942" class="difflineminus">-    </span>
<a href="#l33.943"></a><span id="l33.943" class="difflineminus">-    if (term.matchAll)</span>
<a href="#l33.944"></a><span id="l33.944" class="difflineminus">-    {</span>
<a href="#l33.945"></a><span id="l33.945" class="difflineminus">-        condition = &quot;ALL&quot;;</span>
<a href="#l33.946"></a><span id="l33.946" class="difflineminus">-        break;</span>
<a href="#l33.947"></a><span id="l33.947" class="difflineminus">-    }</span>
<a href="#l33.948"></a><span id="l33.948" class="difflineminus">-    condition += (term.booleanAnd) ? &quot;AND (&quot; : &quot;OR (&quot;;</span>
<a href="#l33.949"></a><span id="l33.949" class="difflineminus">-    condition += term.termAsString + ')';</span>
<a href="#l33.950"></a><span id="l33.950" class="difflineminus">-  }</span>
<a href="#l33.951"></a><span id="l33.951" class="difflineminus">-  return condition;</span>
<a href="#l33.952"></a><span id="l33.952" class="difflineminus">-}</span>
<a href="#l33.953"></a><span id="l33.953" class="difflineminus">-</span>
<a href="#l33.954"></a><span id="l33.954" class="difflineminus">-function  CreateVirtualFolder(newName, parentFolder, searchFolderURIs, searchTerms, searchOnline)</span>
<a href="#l33.955"></a><span id="l33.955" class="difflineminus">-{</span>
<a href="#l33.956"></a><span id="l33.956" class="difflineminus">-  // ### need to make sure view/folder doesn't exist.</span>
<a href="#l33.957"></a><span id="l33.957" class="difflineminus">-  if (searchFolderURIs &amp;&amp; (searchFolderURIs != &quot;&quot;) &amp;&amp; newName &amp;&amp; (newName != &quot;&quot;)) </span>
<a href="#l33.958"></a><span id="l33.958" class="difflineminus">-  {</span>
<a href="#l33.959"></a><span id="l33.959" class="difflineminus">-    try</span>
<a href="#l33.960"></a><span id="l33.960" class="difflineminus">-    {</span>
<a href="#l33.961"></a><span id="l33.961" class="difflineminus">-      var newFolder = parentFolder.addSubfolder(newName);</span>
<a href="#l33.962"></a><span id="l33.962" class="difflineminus">-      newFolder.prettyName = newName;</span>
<a href="#l33.963"></a><span id="l33.963" class="difflineminus">-      newFolder.setFlag(Components.interfaces.nsMsgFolderFlags.Virtual);</span>
<a href="#l33.964"></a><span id="l33.964" class="difflineminus">-      var vfdb = newFolder.msgDatabase;</span>
<a href="#l33.965"></a><span id="l33.965" class="difflineminus">-      var searchTermString = getSearchTermString(searchTerms);</span>
<a href="#l33.966"></a><span id="l33.966" class="difflineminus">-      var dbFolderInfo = vfdb.dBFolderInfo;</span>
<a href="#l33.967"></a><span id="l33.967" class="difflineminus">-      // set the view string as a property of the db folder info</span>
<a href="#l33.968"></a><span id="l33.968" class="difflineminus">-      // set the original folder name as well.</span>
<a href="#l33.969"></a><span id="l33.969" class="difflineminus">-      dbFolderInfo.setCharProperty(&quot;searchStr&quot;, searchTermString);</span>
<a href="#l33.970"></a><span id="l33.970" class="difflineminus">-      dbFolderInfo.setCharProperty(&quot;searchFolderUri&quot;, searchFolderURIs);</span>
<a href="#l33.971"></a><span id="l33.971" class="difflineminus">-      dbFolderInfo.setBooleanProperty(&quot;searchOnline&quot;, searchOnline);</span>
<a href="#l33.972"></a><span id="l33.972" class="difflineminus">-</span>
<a href="#l33.973"></a><span id="l33.973" class="difflineminus">-      vfdb.summaryValid = true;</span>
<a href="#l33.974"></a><span id="l33.974" class="difflineminus">-      vfdb.Close(true);</span>
<a href="#l33.975"></a><span id="l33.975" class="difflineminus">-      parentFolder.NotifyItemAdded(newFolder);</span>
<a href="#l33.976"></a><span id="l33.976" class="difflineminus">-      var accountManager = Components.classes[&quot;@mozilla.org/messenger/account-manager;1&quot;].getService(Components.interfaces.nsIMsgAccountManager);</span>
<a href="#l33.977"></a><span id="l33.977" class="difflineminus">-      accountManager.saveVirtualFolders();</span>
<a href="#l33.978"></a><span id="l33.978" class="difflineminus">-    }</span>
<a href="#l33.979"></a><span id="l33.979" class="difflineminus">-    catch(e)</span>
<a href="#l33.980"></a><span id="l33.980" class="difflineminus">-    {</span>
<a href="#l33.981"></a><span id="l33.981" class="difflineminus">-      throw(e); // so that the dialog does not automatically close</span>
<a href="#l33.982"></a><span id="l33.982" class="difflineminus">-      dump (&quot;Exception : creating virtual folder \n&quot;);</span>
<a href="#l33.983"></a><span id="l33.983" class="difflineminus">-    }</span>
<a href="#l33.984"></a><span id="l33.984" class="difflineminus">-  }</span>
<a href="#l33.985"></a><span id="l33.985" class="difflineminus">-  else </span>
<a href="#l33.986"></a><span id="l33.986" class="difflineminus">-  {</span>
<a href="#l33.987"></a><span id="l33.987" class="difflineminus">-    dump(&quot;no name or nothing selected\n&quot;);</span>
<a href="#l33.988"></a><span id="l33.988" class="difflineminus">-  }   </span>
<a href="#l33.989"></a><span id="l33.989" class="difflineminus">-}</span>
<a href="#l33.990"></a><span id="l33.990" class="difflineminus">-</span>
<a href="#l33.991"></a><span id="l33.991" class="difflineminus">-var gSearchSession;</span>
<a href="#l33.992"></a><span id="l33.992" class="difflineminus">-</span>
<a href="#l33.993"></a><span id="l33.993" class="difflineminus">-var nsMsgSearchScope = Components.interfaces.nsMsgSearchScope;</span>
<a href="#l33.994"></a><span id="l33.994" class="difflineminus">-</span>
<a href="#l33.995"></a><span id="l33.995"> var gMessengerBundle = null;</span>
<a href="#l33.996"></a><span id="l33.996"> </span>
<a href="#l33.997"></a><span id="l33.997" class="difflineminus">-// Datasource search listener -- made global as it has to be registered</span>
<a href="#l33.998"></a><span id="l33.998" class="difflineminus">-// and unregistered in different functions.</span>
<a href="#l33.999"></a><span id="l33.999" class="difflineminus">-var gViewSearchListener;</span>
<a href="#l33.1000"></a><span id="l33.1000" class="difflineminus">-</span>
<a href="#l33.1001"></a><span id="l33.1001" class="difflineminus">-function GetScopeForFolder(folder) </span>
<a href="#l33.1002"></a><span id="l33.1002" class="difflineminus">-{</span>
<a href="#l33.1003"></a><span id="l33.1003" class="difflineminus">-  return folder.server.searchScope;</span>
<a href="#l33.1004"></a><span id="l33.1004" class="difflineminus">-}</span>
<a href="#l33.1005"></a><span id="l33.1005" class="difflineminus">-</span>
<a href="#l33.1006"></a><span id="l33.1006" class="difflineminus">-function setupXFVirtualFolderSearch(folderUrisToSearch, searchTerms, searchOnline)</span>
<a href="#l33.1007"></a><span id="l33.1007" class="difflineminus">-{</span>
<a href="#l33.1008"></a><span id="l33.1008" class="difflineminus">-  const Ci = Components.interfaces;</span>
<a href="#l33.1009"></a><span id="l33.1009" class="difflineminus">-  var count = new Object;</span>
<a href="#l33.1010"></a><span id="l33.1010" class="difflineminus">-  var i;</span>
<a href="#l33.1011"></a><span id="l33.1011" class="difflineminus">-</span>
<a href="#l33.1012"></a><span id="l33.1012" class="difflineminus">-  gSearchSession = Components.classes[&quot;@mozilla.org/messenger/searchSession;1&quot;]</span>
<a href="#l33.1013"></a><span id="l33.1013" class="difflineminus">-                             .createInstance(Ci.nsIMsgSearchSession);</span>
<a href="#l33.1014"></a><span id="l33.1014" class="difflineminus">-</span>
<a href="#l33.1015"></a><span id="l33.1015" class="difflineminus">-  for (i in folderUrisToSearch)</span>
<a href="#l33.1016"></a><span id="l33.1016" class="difflineminus">-    {</span>
<a href="#l33.1017"></a><span id="l33.1017" class="difflineminus">-      var realFolder = GetMsgFolderFromUri(folderUrisToSearch[i]);</span>
<a href="#l33.1018"></a><span id="l33.1018" class="difflineminus">-      if (!realFolder.isServer)</span>
<a href="#l33.1019"></a><span id="l33.1019" class="difflineminus">-        gSearchSession.addScopeTerm(!searchOnline ? nsMsgSearchScope.offlineMail : GetScopeForFolder(realFolder), realFolder);</span>
<a href="#l33.1020"></a><span id="l33.1020" class="difflineminus">-    }</span>
<a href="#l33.1021"></a><span id="l33.1021" class="difflineminus">-</span>
<a href="#l33.1022"></a><span id="l33.1022" class="difflineminus">-    var termsArray = searchTerms.QueryInterface(Components.interfaces.nsISupportsArray);</span>
<a href="#l33.1023"></a><span id="l33.1023" class="difflineminus">-    const nsIMsgSearchTerm = Components.interfaces.nsIMsgSearchTerm;</span>
<a href="#l33.1024"></a><span id="l33.1024" class="difflineminus">-    for each (var term in fixIterator(termsArray, nsIMsgSearchTerm)) {</span>
<a href="#l33.1025"></a><span id="l33.1025" class="difflineminus">-      gSearchSession.appendTerm(term);</span>
<a href="#l33.1026"></a><span id="l33.1026" class="difflineminus">-    }</span>
<a href="#l33.1027"></a><span id="l33.1027" class="difflineminus">-}</span>
<a href="#l33.1028"></a><span id="l33.1028" class="difflineminus">-</span>
<a href="#l33.1029"></a><span id="l33.1029" class="difflineminus">-function CreateGroupedSearchTerms(searchTermsArray)</span>
<a href="#l33.1030"></a><span id="l33.1030" class="difflineminus">-{</span>
<a href="#l33.1031"></a><span id="l33.1031" class="difflineminus">-  const Ci = Components.interfaces;</span>
<a href="#l33.1032"></a><span id="l33.1032" class="difflineminus">-  var searchSession = gSearchSession;</span>
<a href="#l33.1033"></a><span id="l33.1033" class="difflineminus">-  if (!searchSession) {</span>
<a href="#l33.1034"></a><span id="l33.1034" class="difflineminus">-    searchSession = Components.classes[&quot;@mozilla.org/messenger/searchSession;1&quot;]</span>
<a href="#l33.1035"></a><span id="l33.1035" class="difflineminus">-                              .createInstance(Ci.nsIMsgSearchSession);</span>
<a href="#l33.1036"></a><span id="l33.1036" class="difflineminus">-  }</span>
<a href="#l33.1037"></a><span id="l33.1037" class="difflineminus">-</span>
<a href="#l33.1038"></a><span id="l33.1038" class="difflineminus">-  // create a temporary isupports array to store our search terms</span>
<a href="#l33.1039"></a><span id="l33.1039" class="difflineminus">-  // since we will be modifying the terms so they work with quick search</span>
<a href="#l33.1040"></a><span id="l33.1040" class="difflineminus">-  var searchTermsArrayForQS = Components.classes[&quot;@mozilla.org/supports-array;1&quot;].createInstance(Components.interfaces.nsISupportsArray);</span>
<a href="#l33.1041"></a><span id="l33.1041" class="difflineminus">-  </span>
<a href="#l33.1042"></a><span id="l33.1042" class="difflineminus">-  var numEntries = searchTermsArray.Count();</span>
<a href="#l33.1043"></a><span id="l33.1043" class="difflineminus">-  for (var i = 0; i &lt; numEntries; i++) {</span>
<a href="#l33.1044"></a><span id="l33.1044" class="difflineminus">-    var searchTerm = searchTermsArray.GetElementAt(i).QueryInterface(Components.interfaces.nsIMsgSearchTerm); </span>
<a href="#l33.1045"></a><span id="l33.1045" class="difflineminus">-</span>
<a href="#l33.1046"></a><span id="l33.1046" class="difflineminus">-    // clone the term, since we might be modifying it</span>
<a href="#l33.1047"></a><span id="l33.1047" class="difflineminus">-    var searchTermForQS = searchSession.createTerm();</span>
<a href="#l33.1048"></a><span id="l33.1048" class="difflineminus">-    searchTermForQS.value = searchTerm.value;</span>
<a href="#l33.1049"></a><span id="l33.1049" class="difflineminus">-    searchTermForQS.attrib = searchTerm.attrib;</span>
<a href="#l33.1050"></a><span id="l33.1050" class="difflineminus">-    searchTermForQS.arbitraryHeader = searchTerm.arbitraryHeader</span>
<a href="#l33.1051"></a><span id="l33.1051" class="difflineminus">-    searchTermForQS.op = searchTerm.op;</span>
<a href="#l33.1052"></a><span id="l33.1052" class="difflineminus">-</span>
<a href="#l33.1053"></a><span id="l33.1053" class="difflineminus">-    // mark the first node as a group</span>
<a href="#l33.1054"></a><span id="l33.1054" class="difflineminus">-    if (i == 0)</span>
<a href="#l33.1055"></a><span id="l33.1055" class="difflineminus">-      searchTermForQS.beginsGrouping = true;</span>
<a href="#l33.1056"></a><span id="l33.1056" class="difflineminus">-    else if (i == numEntries - 1)</span>
<a href="#l33.1057"></a><span id="l33.1057" class="difflineminus">-      searchTermForQS.endsGrouping = true;</span>
<a href="#l33.1058"></a><span id="l33.1058" class="difflineminus">-</span>
<a href="#l33.1059"></a><span id="l33.1059" class="difflineminus">-    // turn the first term to true to work with quick search...</span>
<a href="#l33.1060"></a><span id="l33.1060" class="difflineminus">-    searchTermForQS.booleanAnd = i ? searchTerm.booleanAnd : true; </span>
<a href="#l33.1061"></a><span id="l33.1061" class="difflineminus">-    </span>
<a href="#l33.1062"></a><span id="l33.1062" class="difflineminus">-    searchTermsArrayForQS.AppendElement(searchTermForQS);</span>
<a href="#l33.1063"></a><span id="l33.1063" class="difflineminus">-  }</span>
<a href="#l33.1064"></a><span id="l33.1064" class="difflineminus">-  return searchTermsArrayForQS;</span>
<a href="#l33.1065"></a><span id="l33.1065" class="difflineminus">-}</span>
<a href="#l33.1066"></a><span id="l33.1066" class="difflineminus">-</span>
<a href="#l33.1067"></a><span id="l33.1067" class="difflineminus">-function OnLeavingFolder(aFolder)</span>
<a href="#l33.1068"></a><span id="l33.1068" class="difflineminus">-{</span>
<a href="#l33.1069"></a><span id="l33.1069" class="difflineminus">-  try</span>
<a href="#l33.1070"></a><span id="l33.1070" class="difflineminus">-  {</span>
<a href="#l33.1071"></a><span id="l33.1071" class="difflineminus">-    // Mark all messages of aFolder as read:</span>
<a href="#l33.1072"></a><span id="l33.1072" class="difflineminus">-    // We can't use the command controller, because it is already tuned in to the</span>
<a href="#l33.1073"></a><span id="l33.1073" class="difflineminus">-    // new folder, so we just mimic its behaviour wrt goDoCommand('cmd_markAllRead').</span>
<a href="#l33.1074"></a><span id="l33.1074" class="difflineminus">-    if (gDBView &amp;&amp; gPrefBranch.getBoolPref(&quot;mailnews.mark_message_read.&quot; + aFolder.server.type))</span>
<a href="#l33.1075"></a><span id="l33.1075" class="difflineminus">-    {</span>
<a href="#l33.1076"></a><span id="l33.1076" class="difflineminus">-      gDBView.doCommand(nsMsgViewCommandType.markAllRead);</span>
<a href="#l33.1077"></a><span id="l33.1077" class="difflineminus">-    }</span>
<a href="#l33.1078"></a><span id="l33.1078" class="difflineminus">-  }</span>
<a href="#l33.1079"></a><span id="l33.1079" class="difflineminus">-  catch(e){/* ignore */}</span>
<a href="#l33.1080"></a><span id="l33.1080" class="difflineminus">-}</span>
<a href="#l33.1081"></a><span id="l33.1081" class="difflineminus">-</span>
<a href="#l33.1082"></a><span id="l33.1082" class="difflineminus">-var gViewDebug = false;</span>
<a href="#l33.1083"></a><span id="l33.1083" class="difflineminus">-</span>
<a href="#l33.1084"></a><span id="l33.1084" class="difflineminus">-function viewDebug(str)</span>
<a href="#l33.1085"></a><span id="l33.1085" class="difflineminus">-{</span>
<a href="#l33.1086"></a><span id="l33.1086" class="difflineminus">-  if (gViewDebug)</span>
<a href="#l33.1087"></a><span id="l33.1087" class="difflineminus">-    dump(str);</span>
<a href="#l33.1088"></a><span id="l33.1088" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l34.1"></a><span id="l34.1" class="difflineminus">--- a/mail/base/content/extraCustomizeItems.xul</span>
<a href="#l34.2"></a><span id="l34.2" class="difflineplus">+++ b/mail/base/content/extraCustomizeItems.xul</span>
<a href="#l34.3"></a><span id="l34.3" class="difflineat">@@ -1,46 +1,48 @@</span>
<a href="#l34.4"></a><span id="l34.4"> &lt;?xml version=&quot;1.0&quot;?&gt;</span>
<a href="#l34.5"></a><span id="l34.5" class="difflineminus">-# ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l34.6"></a><span id="l34.6" class="difflineminus">-# Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l34.7"></a><span id="l34.7" class="difflineminus">-#</span>
<a href="#l34.8"></a><span id="l34.8" class="difflineminus">-# The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l34.9"></a><span id="l34.9" class="difflineminus">-# 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l34.10"></a><span id="l34.10" class="difflineminus">-# the License. You may obtain a copy of the License at</span>
<a href="#l34.11"></a><span id="l34.11" class="difflineminus">-# http://www.mozilla.org/MPL/</span>
<a href="#l34.12"></a><span id="l34.12" class="difflineminus">-#</span>
<a href="#l34.13"></a><span id="l34.13" class="difflineminus">-# Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l34.14"></a><span id="l34.14" class="difflineminus">-# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l34.15"></a><span id="l34.15" class="difflineminus">-# for the specific language governing rights and limitations under the</span>
<a href="#l34.16"></a><span id="l34.16" class="difflineminus">-# License.</span>
<a href="#l34.17"></a><span id="l34.17" class="difflineminus">-#</span>
<a href="#l34.18"></a><span id="l34.18" class="difflineminus">-# The Original Code is Mozilla Communicator client code, released</span>
<a href="#l34.19"></a><span id="l34.19" class="difflineminus">-# March 31, 1998.</span>
<a href="#l34.20"></a><span id="l34.20" class="difflineminus">-#</span>
<a href="#l34.21"></a><span id="l34.21" class="difflineminus">-# The Initial Developer of the Original Code is</span>
<a href="#l34.22"></a><span id="l34.22" class="difflineminus">-# Netscape Communications Corporation.</span>
<a href="#l34.23"></a><span id="l34.23" class="difflineminus">-# Portions created by the Initial Developer are Copyright (C) 1998-1999</span>
<a href="#l34.24"></a><span id="l34.24" class="difflineminus">-# the Initial Developer. All Rights Reserved.</span>
<a href="#l34.25"></a><span id="l34.25" class="difflineminus">-#</span>
<a href="#l34.26"></a><span id="l34.26" class="difflineminus">-# Contributor(s):</span>
<a href="#l34.27"></a><span id="l34.27" class="difflineminus">-#   Karsten DÃ¼sterloh &lt;mnyromyr@tprac.de&gt;</span>
<a href="#l34.28"></a><span id="l34.28" class="difflineminus">-#   Simon Paquet &lt;bugzilla@babylonsounds.com&gt;</span>
<a href="#l34.29"></a><span id="l34.29" class="difflineminus">-#</span>
<a href="#l34.30"></a><span id="l34.30" class="difflineminus">-# Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l34.31"></a><span id="l34.31" class="difflineminus">-# either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l34.32"></a><span id="l34.32" class="difflineminus">-# the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l34.33"></a><span id="l34.33" class="difflineminus">-# in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l34.34"></a><span id="l34.34" class="difflineminus">-# of those above. If you wish to allow use of your version of this file only</span>
<a href="#l34.35"></a><span id="l34.35" class="difflineminus">-# under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l34.36"></a><span id="l34.36" class="difflineminus">-# use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l34.37"></a><span id="l34.37" class="difflineminus">-# and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l34.38"></a><span id="l34.38" class="difflineminus">-# the provisions above, a recipient may use your version of this file under</span>
<a href="#l34.39"></a><span id="l34.39" class="difflineminus">-# the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l34.40"></a><span id="l34.40" class="difflineminus">-#</span>
<a href="#l34.41"></a><span id="l34.41" class="difflineminus">-# ***** END LICENSE BLOCK *****</span>
<a href="#l34.42"></a><span id="l34.42" class="difflineplus">+&lt;!--</span>
<a href="#l34.43"></a><span id="l34.43" class="difflineplus">+ - ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l34.44"></a><span id="l34.44" class="difflineplus">+ - Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l34.45"></a><span id="l34.45" class="difflineplus">+ -</span>
<a href="#l34.46"></a><span id="l34.46" class="difflineplus">+ - The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l34.47"></a><span id="l34.47" class="difflineplus">+ - 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l34.48"></a><span id="l34.48" class="difflineplus">+ - the License. You may obtain a copy of the License at</span>
<a href="#l34.49"></a><span id="l34.49" class="difflineplus">+ - http://www.mozilla.org/MPL/</span>
<a href="#l34.50"></a><span id="l34.50" class="difflineplus">+ -</span>
<a href="#l34.51"></a><span id="l34.51" class="difflineplus">+ - Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l34.52"></a><span id="l34.52" class="difflineplus">+ - WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l34.53"></a><span id="l34.53" class="difflineplus">+ - for the specific language governing rights and limitations under the</span>
<a href="#l34.54"></a><span id="l34.54" class="difflineplus">+ - License.</span>
<a href="#l34.55"></a><span id="l34.55" class="difflineplus">+ -</span>
<a href="#l34.56"></a><span id="l34.56" class="difflineplus">+ - The Original Code is Mozilla Communicator client code, released</span>
<a href="#l34.57"></a><span id="l34.57" class="difflineplus">+ - March 31, 1998.</span>
<a href="#l34.58"></a><span id="l34.58" class="difflineplus">+ -</span>
<a href="#l34.59"></a><span id="l34.59" class="difflineplus">+ - The Initial Developer of the Original Code is</span>
<a href="#l34.60"></a><span id="l34.60" class="difflineplus">+ - Netscape Communications Corporation.</span>
<a href="#l34.61"></a><span id="l34.61" class="difflineplus">+ - Portions created by the Initial Developer are Copyright (C) 1998-1999</span>
<a href="#l34.62"></a><span id="l34.62" class="difflineplus">+ - the Initial Developer. All Rights Reserved.</span>
<a href="#l34.63"></a><span id="l34.63" class="difflineplus">+ -</span>
<a href="#l34.64"></a><span id="l34.64" class="difflineplus">+ - Contributor(s):</span>
<a href="#l34.65"></a><span id="l34.65" class="difflineplus">+ -   Karsten DÃ¼sterloh &lt;mnyromyr@tprac.de&gt;</span>
<a href="#l34.66"></a><span id="l34.66" class="difflineplus">+ -   Simon Paquet &lt;bugzilla@babylonsounds.com&gt;</span>
<a href="#l34.67"></a><span id="l34.67" class="difflineplus">+ -</span>
<a href="#l34.68"></a><span id="l34.68" class="difflineplus">+ - Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l34.69"></a><span id="l34.69" class="difflineplus">+ - either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l34.70"></a><span id="l34.70" class="difflineplus">+ - the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l34.71"></a><span id="l34.71" class="difflineplus">+ - in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l34.72"></a><span id="l34.72" class="difflineplus">+ - of those above. If you wish to allow use of your version of this file only</span>
<a href="#l34.73"></a><span id="l34.73" class="difflineplus">+ - under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l34.74"></a><span id="l34.74" class="difflineplus">+ - use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l34.75"></a><span id="l34.75" class="difflineplus">+ - and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l34.76"></a><span id="l34.76" class="difflineplus">+ - the provisions above, a recipient may use your version of this file under</span>
<a href="#l34.77"></a><span id="l34.77" class="difflineplus">+ - the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l34.78"></a><span id="l34.78" class="difflineplus">+ -</span>
<a href="#l34.79"></a><span id="l34.79" class="difflineplus">+ - ***** END LICENSE BLOCK *****</span>
<a href="#l34.80"></a><span id="l34.80" class="difflineplus">+ --&gt;</span>
<a href="#l34.81"></a><span id="l34.81"> </span>
<a href="#l34.82"></a><span id="l34.82"> &lt;!DOCTYPE overlay [</span>
<a href="#l34.83"></a><span id="l34.83">   &lt;!ENTITY % globalDTD SYSTEM &quot;chrome://global/locale/global.dtd&quot;&gt;</span>
<a href="#l34.84"></a><span id="l34.84">   %globalDTD;</span>
<a href="#l34.85"></a><span id="l34.85">   &lt;!ENTITY % messengerDTD SYSTEM &quot;chrome://messenger/locale/messenger.dtd&quot;&gt;</span>
<a href="#l34.86"></a><span id="l34.86">   %messengerDTD;</span>
<a href="#l34.87"></a><span id="l34.87">   &lt;!ENTITY % msgViewPickerDTD SYSTEM &quot;chrome://messenger/locale/msgViewPickerOverlay.dtd&quot; &gt;</span>
<a href="#l34.88"></a><span id="l34.88">   %msgViewPickerDTD;</span>
<a href="#l34.89"></a><span id="l34.89" class="difflineat">@@ -152,20 +154,26 @@</span>
<a href="#l34.90"></a><span id="l34.90">                  title=&quot;&amp;mailViewsToolbarItem.title;&quot;</span>
<a href="#l34.91"></a><span id="l34.91">                  align=&quot;center&quot;</span>
<a href="#l34.92"></a><span id="l34.92">                  class=&quot;chromeclass-toolbar-additional&quot;&gt;</span>
<a href="#l34.93"></a><span id="l34.93">       &lt;label id=&quot;viewPickerLabel&quot;</span>
<a href="#l34.94"></a><span id="l34.94">              value=&quot;&amp;viewPicker.label;&quot;</span>
<a href="#l34.95"></a><span id="l34.95">              control=&quot;viewPicker&quot;</span>
<a href="#l34.96"></a><span id="l34.96">              accesskey=&quot;&amp;viewPicker.accesskey;&quot;/&gt;</span>
<a href="#l34.97"></a><span id="l34.97">       &lt;menulist id=&quot;viewPicker&quot; oncommand=&quot;ViewChangeByMenuitem(event.target);&quot;&gt;</span>
<a href="#l34.98"></a><span id="l34.98" class="difflineminus">-        &lt;menupopup id=&quot;viewPickerPopup&quot; onpopupshowing=&quot;RefreshViewPopup(this, false);&quot;&gt;</span>
<a href="#l34.99"></a><span id="l34.99" class="difflineminus">-          &lt;menuitem id=&quot;viewPickerAll&quot; value=&quot;0&quot; label=&quot;&amp;viewAll.label;&quot;/&gt;</span>
<a href="#l34.100"></a><span id="l34.100" class="difflineminus">-          &lt;menuitem id=&quot;viewPickerUnread&quot; value=&quot;1&quot; label=&quot;&amp;viewUnread.label;&quot;/&gt;</span>
<a href="#l34.101"></a><span id="l34.101" class="difflineminus">-          &lt;menuitem id=&quot;viewPickerNotDeleted&quot; value=&quot;3&quot; label=&quot;&amp;viewNotDeleted.label;&quot;/&gt;</span>
<a href="#l34.102"></a><span id="l34.102" class="difflineplus">+        &lt;menupopup id=&quot;viewPickerPopup&quot; onpopupshowing=&quot;RefreshViewPopup(this);&quot;&gt;</span>
<a href="#l34.103"></a><span id="l34.103" class="difflineplus">+          &lt;menuitem id=&quot;viewPickerAll&quot; value=&quot;0&quot;</span>
<a href="#l34.104"></a><span id="l34.104" class="difflineplus">+                    label=&quot;&amp;viewAll.label;&quot;</span>
<a href="#l34.105"></a><span id="l34.105" class="difflineplus">+                    type=&quot;radio&quot;/&gt;</span>
<a href="#l34.106"></a><span id="l34.106" class="difflineplus">+          &lt;menuitem id=&quot;viewPickerUnread&quot; value=&quot;1&quot;</span>
<a href="#l34.107"></a><span id="l34.107" class="difflineplus">+                    label=&quot;&amp;viewUnread.label;&quot;</span>
<a href="#l34.108"></a><span id="l34.108" class="difflineplus">+                    type=&quot;radio&quot;/&gt;</span>
<a href="#l34.109"></a><span id="l34.109" class="difflineplus">+          &lt;menuitem id=&quot;viewPickerNotDeleted&quot; value=&quot;3&quot;</span>
<a href="#l34.110"></a><span id="l34.110" class="difflineplus">+                    label=&quot;&amp;viewNotDeleted.label;&quot;</span>
<a href="#l34.111"></a><span id="l34.111" class="difflineplus">+                    type=&quot;radio&quot;/&gt;</span>
<a href="#l34.112"></a><span id="l34.112">           &lt;menuseparator id=&quot;afterViewPickerUnreadSeparator&quot;/&gt;</span>
<a href="#l34.113"></a><span id="l34.113">           &lt;menu id=&quot;viewPickerTags&quot; label=&quot;&amp;viewTags.label;&quot;&gt;</span>
<a href="#l34.114"></a><span id="l34.114">             &lt;menupopup id=&quot;viewPickerTagsPopup&quot;</span>
<a href="#l34.115"></a><span id="l34.115">                        class=&quot;menulist-menupopup&quot;</span>
<a href="#l34.116"></a><span id="l34.116">                        onpopupshowing=&quot;RefreshTagsPopup(this, true);&quot;/&gt;</span>
<a href="#l34.117"></a><span id="l34.117">           &lt;/menu&gt;</span>
<a href="#l34.118"></a><span id="l34.118">           &lt;menu id=&quot;viewPickerCustomViews&quot; label=&quot;&amp;viewCustomViews.label;&quot;&gt;</span>
<a href="#l34.119"></a><span id="l34.119">             &lt;menupopup id=&quot;viewPickerCustomViewsPopup&quot;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l35.1"></a><span id="l35.1">new file mode 100644</span>
<a href="#l35.2"></a><span id="l35.2" class="difflineminus">--- /dev/null</span>
<a href="#l35.3"></a><span id="l35.3" class="difflineplus">+++ b/mail/base/content/folderDisplay.js</span>
<a href="#l35.4"></a><span id="l35.4" class="difflineat">@@ -0,0 +1,2075 @@</span>
<a href="#l35.5"></a><span id="l35.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l35.6"></a><span id="l35.6" class="difflineplus">+ *   Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l35.7"></a><span id="l35.7" class="difflineplus">+ *</span>
<a href="#l35.8"></a><span id="l35.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l35.9"></a><span id="l35.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l35.10"></a><span id="l35.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l35.11"></a><span id="l35.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l35.12"></a><span id="l35.12" class="difflineplus">+ *</span>
<a href="#l35.13"></a><span id="l35.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l35.14"></a><span id="l35.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l35.15"></a><span id="l35.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l35.16"></a><span id="l35.16" class="difflineplus">+ * License.</span>
<a href="#l35.17"></a><span id="l35.17" class="difflineplus">+ *</span>
<a href="#l35.18"></a><span id="l35.18" class="difflineplus">+ * The Original Code is Thunderbird Mail Client.</span>
<a href="#l35.19"></a><span id="l35.19" class="difflineplus">+ *</span>
<a href="#l35.20"></a><span id="l35.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l35.21"></a><span id="l35.21" class="difflineplus">+ * Mozilla Messaging, Inc.</span>
<a href="#l35.22"></a><span id="l35.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l35.23"></a><span id="l35.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l35.24"></a><span id="l35.24" class="difflineplus">+ *</span>
<a href="#l35.25"></a><span id="l35.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l35.26"></a><span id="l35.26" class="difflineplus">+ *   Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a href="#l35.27"></a><span id="l35.27" class="difflineplus">+ *   David Bienvenu &lt;bienvenu@nventure.com&gt;</span>
<a href="#l35.28"></a><span id="l35.28" class="difflineplus">+ *   Siddharth Agarwal &lt;sid.bugzilla@gmail.com&gt;</span>
<a href="#l35.29"></a><span id="l35.29" class="difflineplus">+ *</span>
<a href="#l35.30"></a><span id="l35.30" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l35.31"></a><span id="l35.31" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l35.32"></a><span id="l35.32" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l35.33"></a><span id="l35.33" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l35.34"></a><span id="l35.34" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l35.35"></a><span id="l35.35" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l35.36"></a><span id="l35.36" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l35.37"></a><span id="l35.37" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l35.38"></a><span id="l35.38" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l35.39"></a><span id="l35.39" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l35.40"></a><span id="l35.40" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l35.41"></a><span id="l35.41" class="difflineplus">+ *</span>
<a href="#l35.42"></a><span id="l35.42" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l35.43"></a><span id="l35.43" class="difflineplus">+</span>
<a href="#l35.44"></a><span id="l35.44" class="difflineplus">+Components.utils.import(&quot;resource://app/modules/dbViewWrapper.js&quot;);</span>
<a href="#l35.45"></a><span id="l35.45" class="difflineplus">+</span>
<a href="#l35.46"></a><span id="l35.46" class="difflineplus">+var gFolderDisplay = null;</span>
<a href="#l35.47"></a><span id="l35.47" class="difflineplus">+var gMessageDisplay = null;</span>
<a href="#l35.48"></a><span id="l35.48" class="difflineplus">+</span>
<a href="#l35.49"></a><span id="l35.49" class="difflineplus">+var nsMsgFolderFlags = Components.interfaces.nsMsgFolderFlags;</span>
<a href="#l35.50"></a><span id="l35.50" class="difflineplus">+</span>
<a href="#l35.51"></a><span id="l35.51" class="difflineplus">+/**</span>
<a href="#l35.52"></a><span id="l35.52" class="difflineplus">+ * Abstraction for a widget that (roughly speaking) displays the contents of</span>
<a href="#l35.53"></a><span id="l35.53" class="difflineplus">+ *  folders.  The widget belongs to a tab and has a lifetime as long as the tab</span>
<a href="#l35.54"></a><span id="l35.54" class="difflineplus">+ *  that contains it.  This class is strictly concerned with the UI aspects of</span>
<a href="#l35.55"></a><span id="l35.55" class="difflineplus">+ *  this; the DBViewWrapper class handles the view details (and is exposed on</span>
<a href="#l35.56"></a><span id="l35.56" class="difflineplus">+ *  the 'view' attribute.)</span>
<a href="#l35.57"></a><span id="l35.57" class="difflineplus">+ *</span>
<a href="#l35.58"></a><span id="l35.58" class="difflineplus">+ * The search window subclasses this into the SearchFolderDisplayWidget rather</span>
<a href="#l35.59"></a><span id="l35.59" class="difflineplus">+ *  than us attempting to generalize everything excessively.  This is because</span>
<a href="#l35.60"></a><span id="l35.60" class="difflineplus">+ *  we hate the search window and don't want to clutter up this code for it.</span>
<a href="#l35.61"></a><span id="l35.61" class="difflineplus">+ * The standalone message display window also subclasses us; we do not hate it,</span>
<a href="#l35.62"></a><span id="l35.62" class="difflineplus">+ *  but it's not invited to our birthday party either.</span>
<a href="#l35.63"></a><span id="l35.63" class="difflineplus">+ * For reasons of simplicity and the original order of implementation, this</span>
<a href="#l35.64"></a><span id="l35.64" class="difflineplus">+ *  class does alter its behavior slightly for the benefit of the standalone</span>
<a href="#l35.65"></a><span id="l35.65" class="difflineplus">+ *  message window.  If no tab info is provided, we avoid touching tabmail</span>
<a href="#l35.66"></a><span id="l35.66" class="difflineplus">+ *  (which is good, because it won't exist!)  And now we guard against treeBox</span>
<a href="#l35.67"></a><span id="l35.67" class="difflineplus">+ *  manipulations...</span>
<a href="#l35.68"></a><span id="l35.68" class="difflineplus">+ */</span>
<a href="#l35.69"></a><span id="l35.69" class="difflineplus">+function FolderDisplayWidget(aTabInfo, aMessageDisplayWidget) {</span>
<a href="#l35.70"></a><span id="l35.70" class="difflineplus">+  this._tabInfo = aTabInfo;</span>
<a href="#l35.71"></a><span id="l35.71" class="difflineplus">+</span>
<a href="#l35.72"></a><span id="l35.72" class="difflineplus">+  /// If the folder does not get handled by the DBViewWrapper, stash it here.</span>
<a href="#l35.73"></a><span id="l35.73" class="difflineplus">+  ///  ex: when isServer is true.</span>
<a href="#l35.74"></a><span id="l35.74" class="difflineplus">+  this._nonViewFolder = null;</span>
<a href="#l35.75"></a><span id="l35.75" class="difflineplus">+</span>
<a href="#l35.76"></a><span id="l35.76" class="difflineplus">+  this.view = new DBViewWrapper(this);</span>
<a href="#l35.77"></a><span id="l35.77" class="difflineplus">+  this.messageDisplay = aMessageDisplayWidget;</span>
<a href="#l35.78"></a><span id="l35.78" class="difflineplus">+  this.messageDisplay.folderDisplay = this;</span>
<a href="#l35.79"></a><span id="l35.79" class="difflineplus">+</span>
<a href="#l35.80"></a><span id="l35.80" class="difflineplus">+  /**</span>
<a href="#l35.81"></a><span id="l35.81" class="difflineplus">+   * The XUL tree node, as retrieved by getDocumentElementById.  The caller is</span>
<a href="#l35.82"></a><span id="l35.82" class="difflineplus">+   *  responsible for setting this.</span>
<a href="#l35.83"></a><span id="l35.83" class="difflineplus">+   */</span>
<a href="#l35.84"></a><span id="l35.84" class="difflineplus">+  this.tree = null;</span>
<a href="#l35.85"></a><span id="l35.85" class="difflineplus">+  /**</span>
<a href="#l35.86"></a><span id="l35.86" class="difflineplus">+   * The nsITreeBoxObject on the XUL tree node, accessible from this.tree as</span>
<a href="#l35.87"></a><span id="l35.87" class="difflineplus">+   *  this.tree.boxObject and QueryInterfaced as such.  The caller is</span>
<a href="#l35.88"></a><span id="l35.88" class="difflineplus">+   *  responsible for setting this.</span>
<a href="#l35.89"></a><span id="l35.89" class="difflineplus">+   */</span>
<a href="#l35.90"></a><span id="l35.90" class="difflineplus">+  this.treeBox = null;</span>
<a href="#l35.91"></a><span id="l35.91" class="difflineplus">+</span>
<a href="#l35.92"></a><span id="l35.92" class="difflineplus">+  /**</span>
<a href="#l35.93"></a><span id="l35.93" class="difflineplus">+   * The nsIMsgWindow corresponding to the window that holds us.  There is only</span>
<a href="#l35.94"></a><span id="l35.94" class="difflineplus">+   *  one of these per tab.  The caller is responsible for setting this.</span>
<a href="#l35.95"></a><span id="l35.95" class="difflineplus">+   */</span>
<a href="#l35.96"></a><span id="l35.96" class="difflineplus">+  this.msgWindow = null;</span>
<a href="#l35.97"></a><span id="l35.97" class="difflineplus">+  /**</span>
<a href="#l35.98"></a><span id="l35.98" class="difflineplus">+   * The nsIMessenger instance that corresponds to our tab/window.  We do not</span>
<a href="#l35.99"></a><span id="l35.99" class="difflineplus">+   *  use this ourselves, but are responsible for using it to update the</span>
<a href="#l35.100"></a><span id="l35.100" class="difflineplus">+   *  global |messenger| object so that our tab maintains its own undo and</span>
<a href="#l35.101"></a><span id="l35.101" class="difflineplus">+   *  navigation history.  At some point we might touch it for those reasons.</span>
<a href="#l35.102"></a><span id="l35.102" class="difflineplus">+   */</span>
<a href="#l35.103"></a><span id="l35.103" class="difflineplus">+  this.messenger = null;</span>
<a href="#l35.104"></a><span id="l35.104" class="difflineplus">+  this.threadPaneCommandUpdater = this;</span>
<a href="#l35.105"></a><span id="l35.105" class="difflineplus">+</span>
<a href="#l35.106"></a><span id="l35.106" class="difflineplus">+  /**</span>
<a href="#l35.107"></a><span id="l35.107" class="difflineplus">+   * Flag to expose whether all messages are loaded or not.  Set by</span>
<a href="#l35.108"></a><span id="l35.108" class="difflineplus">+   *  onAllMessagesLoaded.</span>
<a href="#l35.109"></a><span id="l35.109" class="difflineplus">+   */</span>
<a href="#l35.110"></a><span id="l35.110" class="difflineplus">+  this._allMessagesLoaded = false;</span>
<a href="#l35.111"></a><span id="l35.111" class="difflineplus">+</span>
<a href="#l35.112"></a><span id="l35.112" class="difflineplus">+  /**</span>
<a href="#l35.113"></a><span id="l35.113" class="difflineplus">+   * Save the top row displayed when we go inactive, restore when we go active,</span>
<a href="#l35.114"></a><span id="l35.114" class="difflineplus">+   *  nuke it when we destroy the view.</span>
<a href="#l35.115"></a><span id="l35.115" class="difflineplus">+   */</span>
<a href="#l35.116"></a><span id="l35.116" class="difflineplus">+  this._savedFirstVisibleRow = null;</span>
<a href="#l35.117"></a><span id="l35.117" class="difflineplus">+  /** the next view index to select once the delete completes */</span>
<a href="#l35.118"></a><span id="l35.118" class="difflineplus">+  this._nextViewIndexAfterDelete = null;</span>
<a href="#l35.119"></a><span id="l35.119" class="difflineplus">+  /**</span>
<a href="#l35.120"></a><span id="l35.120" class="difflineplus">+   * Track when a mass move is in effect (we get told by hintMassMoveStarting,</span>
<a href="#l35.121"></a><span id="l35.121" class="difflineplus">+   *  and hintMassMoveCompleted) so that we can avoid deletion-triggered</span>
<a href="#l35.122"></a><span id="l35.122" class="difflineplus">+   *  moving to _nextViewIndexAfterDelete until the mass move completes.</span>
<a href="#l35.123"></a><span id="l35.123" class="difflineplus">+   */</span>
<a href="#l35.124"></a><span id="l35.124" class="difflineplus">+  this._massMoveActive = false;</span>
<a href="#l35.125"></a><span id="l35.125" class="difflineplus">+</span>
<a href="#l35.126"></a><span id="l35.126" class="difflineplus">+  /**</span>
<a href="#l35.127"></a><span id="l35.127" class="difflineplus">+   * Used by pushNavigation to queue a navigation request for when we enter the</span>
<a href="#l35.128"></a><span id="l35.128" class="difflineplus">+   *  next folder; onAllMessagesLoaded is the one that processes it.</span>
<a href="#l35.129"></a><span id="l35.129" class="difflineplus">+   */</span>
<a href="#l35.130"></a><span id="l35.130" class="difflineplus">+  this._pendingNavigation = null;</span>
<a href="#l35.131"></a><span id="l35.131" class="difflineplus">+</span>
<a href="#l35.132"></a><span id="l35.132" class="difflineplus">+  this._active = false;</span>
<a href="#l35.133"></a><span id="l35.133" class="difflineplus">+  /**</span>
<a href="#l35.134"></a><span id="l35.134" class="difflineplus">+   * A list of methods to call on 'this' object when we are next made active.</span>
<a href="#l35.135"></a><span id="l35.135" class="difflineplus">+   *  This list is populated by calls to |_notifyWhenActive| when we are</span>
<a href="#l35.136"></a><span id="l35.136" class="difflineplus">+   *  not active at the moment.</span>
<a href="#l35.137"></a><span id="l35.137" class="difflineplus">+   */</span>
<a href="#l35.138"></a><span id="l35.138" class="difflineplus">+  this._notificationsPendingActivation = [];</span>
<a href="#l35.139"></a><span id="l35.139" class="difflineplus">+</span>
<a href="#l35.140"></a><span id="l35.140" class="difflineplus">+  let dummyDOMNode = document.getElementById('mail-toolbox');</span>
<a href="#l35.141"></a><span id="l35.141" class="difflineplus">+  /**</span>
<a href="#l35.142"></a><span id="l35.142" class="difflineplus">+   * Create a fake tree box object for if/when this folder is in the background.</span>
<a href="#l35.143"></a><span id="l35.143" class="difflineplus">+   * We need to give it a bogus DOM object to send events to, so we choose the</span>
<a href="#l35.144"></a><span id="l35.144" class="difflineplus">+   *  mail-toolbox, who is hopefully unlikely to take offense.</span>
<a href="#l35.145"></a><span id="l35.145" class="difflineplus">+   */</span>
<a href="#l35.146"></a><span id="l35.146" class="difflineplus">+  this._fakeTreeBox = dummyDOMNode ?</span>
<a href="#l35.147"></a><span id="l35.147" class="difflineplus">+                        new FakeTreeBoxObject(dummyDOMNode.boxObject) : null;</span>
<a href="#l35.148"></a><span id="l35.148" class="difflineplus">+</span>
<a href="#l35.149"></a><span id="l35.149" class="difflineplus">+  this._mostRecentSelectionCounts = [];</span>
<a href="#l35.150"></a><span id="l35.150" class="difflineplus">+  this._mostRecentCurrentIndices = [];</span>
<a href="#l35.151"></a><span id="l35.151" class="difflineplus">+}</span>
<a href="#l35.152"></a><span id="l35.152" class="difflineplus">+FolderDisplayWidget.prototype = {</span>
<a href="#l35.153"></a><span id="l35.153" class="difflineplus">+  /**</span>
<a href="#l35.154"></a><span id="l35.154" class="difflineplus">+   * @return the currently displayed folder.  This is just proxied from the</span>
<a href="#l35.155"></a><span id="l35.155" class="difflineplus">+   *     view wrapper.</span>
<a href="#l35.156"></a><span id="l35.156" class="difflineplus">+   */</span>
<a href="#l35.157"></a><span id="l35.157" class="difflineplus">+  get displayedFolder() {</span>
<a href="#l35.158"></a><span id="l35.158" class="difflineplus">+    return this._nonViewFolder || this.view.displayedFolder;</span>
<a href="#l35.159"></a><span id="l35.159" class="difflineplus">+  },</span>
<a href="#l35.160"></a><span id="l35.160" class="difflineplus">+</span>
<a href="#l35.161"></a><span id="l35.161" class="difflineplus">+  /**</span>
<a href="#l35.162"></a><span id="l35.162" class="difflineplus">+   * @return the nsITreeSelection object for our tree view if there is one,</span>
<a href="#l35.163"></a><span id="l35.163" class="difflineplus">+   *     null otherwise.</span>
<a href="#l35.164"></a><span id="l35.164" class="difflineplus">+   */</span>
<a href="#l35.165"></a><span id="l35.165" class="difflineplus">+  get treeSelection() {</span>
<a href="#l35.166"></a><span id="l35.166" class="difflineplus">+    if (this.view.dbView)</span>
<a href="#l35.167"></a><span id="l35.167" class="difflineplus">+      return this.view.dbView.selection;</span>
<a href="#l35.168"></a><span id="l35.168" class="difflineplus">+    else</span>
<a href="#l35.169"></a><span id="l35.169" class="difflineplus">+      return null;</span>
<a href="#l35.170"></a><span id="l35.170" class="difflineplus">+  },</span>
<a href="#l35.171"></a><span id="l35.171" class="difflineplus">+</span>
<a href="#l35.172"></a><span id="l35.172" class="difflineplus">+  /**</span>
<a href="#l35.173"></a><span id="l35.173" class="difflineplus">+   * Number of headers to tell the message database to cache when we enter a</span>
<a href="#l35.174"></a><span id="l35.174" class="difflineplus">+   *  folder.  This value is being propagated from legacy code which provided</span>
<a href="#l35.175"></a><span id="l35.175" class="difflineplus">+   *  no explanation for its choice.</span>
<a href="#l35.176"></a><span id="l35.176" class="difflineplus">+   *</span>
<a href="#l35.177"></a><span id="l35.177" class="difflineplus">+   * We definitely want the header cache size to be larger than the number of</span>
<a href="#l35.178"></a><span id="l35.178" class="difflineplus">+   *  rows that can be displayed on screen simultaneously.</span>
<a href="#l35.179"></a><span id="l35.179" class="difflineplus">+   */</span>
<a href="#l35.180"></a><span id="l35.180" class="difflineplus">+  PERF_HEADER_CACHE_SIZE: 100,</span>
<a href="#l35.181"></a><span id="l35.181" class="difflineplus">+</span>
<a href="#l35.182"></a><span id="l35.182" class="difflineplus">+  /**</span>
<a href="#l35.183"></a><span id="l35.183" class="difflineplus">+   * An optional list where each item is an object with the following</span>
<a href="#l35.184"></a><span id="l35.184" class="difflineplus">+   *  attributes sufficient to re-establish the selected items even in the face</span>
<a href="#l35.185"></a><span id="l35.185" class="difflineplus">+   *  of folder renaming.</span>
<a href="#l35.186"></a><span id="l35.186" class="difflineplus">+   * - messageId: The value of the message's message-id header.</span>
<a href="#l35.187"></a><span id="l35.187" class="difflineplus">+   *</span>
<a href="#l35.188"></a><span id="l35.188" class="difflineplus">+   * That's right, we only save the message-id header value.  This is arguably</span>
<a href="#l35.189"></a><span id="l35.189" class="difflineplus">+   *  overkill and ambiguous in the face of duplicate messages, but it's the</span>
<a href="#l35.190"></a><span id="l35.190" class="difflineplus">+   *  most persistent/reliable thing we have without gloda.</span>
<a href="#l35.191"></a><span id="l35.191" class="difflineplus">+   * Using the view index was ruled out because it is hardly stable.  Using the</span>
<a href="#l35.192"></a><span id="l35.192" class="difflineplus">+   *  message key alone is insufficient for cross-folder searches.  Using a</span>
<a href="#l35.193"></a><span id="l35.193" class="difflineplus">+   *  folder identifier and message key is insufficent for local folders in the</span>
<a href="#l35.194"></a><span id="l35.194" class="difflineplus">+   *  face of compaction, let alone complexities where the folder name may</span>
<a href="#l35.195"></a><span id="l35.195" class="difflineplus">+   *  change due to renaming/moving.  Which means we eventually need to fall</span>
<a href="#l35.196"></a><span id="l35.196" class="difflineplus">+   *  back to message-id anyways.  Feel free to add in lots of complexity if</span>
<a href="#l35.197"></a><span id="l35.197" class="difflineplus">+   *  you actually write unit tests for all the many possible cases.</span>
<a href="#l35.198"></a><span id="l35.198" class="difflineplus">+   * Additional justification is that selection saving/restoration should not</span>
<a href="#l35.199"></a><span id="l35.199" class="difflineplus">+   *  happen all that frequently.  A nice freebie is that message-id is</span>
<a href="#l35.200"></a><span id="l35.200" class="difflineplus">+   *  definitely persistable.</span>
<a href="#l35.201"></a><span id="l35.201" class="difflineplus">+   */</span>
<a href="#l35.202"></a><span id="l35.202" class="difflineplus">+  _savedSelection: null,</span>
<a href="#l35.203"></a><span id="l35.203" class="difflineplus">+</span>
<a href="#l35.204"></a><span id="l35.204" class="difflineplus">+  /**</span>
<a href="#l35.205"></a><span id="l35.205" class="difflineplus">+   * Save the current view selection for when we the view is getting destroyed</span>
<a href="#l35.206"></a><span id="l35.206" class="difflineplus">+   *  or otherwise re-ordered in such a way that the nsITreeSelection will lose</span>
<a href="#l35.207"></a><span id="l35.207" class="difflineplus">+   *  track of things (because it just has a naive view-index 'view' of the</span>
<a href="#l35.208"></a><span id="l35.208" class="difflineplus">+   *  world.)  We just save each message's message-id header.  This is overkill</span>
<a href="#l35.209"></a><span id="l35.209" class="difflineplus">+   *  and ambiguous in the face of duplicate messages (and expensive to</span>
<a href="#l35.210"></a><span id="l35.210" class="difflineplus">+   *  restore), but is also the most reliable option for this use case.</span>
<a href="#l35.211"></a><span id="l35.211" class="difflineplus">+   */</span>
<a href="#l35.212"></a><span id="l35.212" class="difflineplus">+  _saveSelection: function FolderDisplayWidget_saveSelection() {</span>
<a href="#l35.213"></a><span id="l35.213" class="difflineplus">+    this._savedSelection = [{messageId: msgHdr.messageId} for each</span>
<a href="#l35.214"></a><span id="l35.214" class="difflineplus">+                              ([, msgHdr] in Iterator(this.selectedMessages))];</span>
<a href="#l35.215"></a><span id="l35.215" class="difflineplus">+  },</span>
<a href="#l35.216"></a><span id="l35.216" class="difflineplus">+</span>
<a href="#l35.217"></a><span id="l35.217" class="difflineplus">+  /**</span>
<a href="#l35.218"></a><span id="l35.218" class="difflineplus">+   * Clear the saved selection.</span>
<a href="#l35.219"></a><span id="l35.219" class="difflineplus">+   */</span>
<a href="#l35.220"></a><span id="l35.220" class="difflineplus">+  _clearSavedSelection: function FolderDisplayWidget_clearSavedSelection() {</span>
<a href="#l35.221"></a><span id="l35.221" class="difflineplus">+    this._savedSelection = null;</span>
<a href="#l35.222"></a><span id="l35.222" class="difflineplus">+  },</span>
<a href="#l35.223"></a><span id="l35.223" class="difflineplus">+</span>
<a href="#l35.224"></a><span id="l35.224" class="difflineplus">+  /**</span>
<a href="#l35.225"></a><span id="l35.225" class="difflineplus">+   * Restore the view selection if we have a saved selection.  We must be</span>
<a href="#l35.226"></a><span id="l35.226" class="difflineplus">+   *  active!</span>
<a href="#l35.227"></a><span id="l35.227" class="difflineplus">+   *</span>
<a href="#l35.228"></a><span id="l35.228" class="difflineplus">+   * @return true if we were able to restore the selection and there was</span>
<a href="#l35.229"></a><span id="l35.229" class="difflineplus">+   *     a selection, false if there was no selection (anymore).</span>
<a href="#l35.230"></a><span id="l35.230" class="difflineplus">+   */</span>
<a href="#l35.231"></a><span id="l35.231" class="difflineplus">+  _restoreSelection: function FolderDisplayWidget_restoreSelection() {</span>
<a href="#l35.232"></a><span id="l35.232" class="difflineplus">+    if (!this._savedSelection || !this._active)</span>
<a href="#l35.233"></a><span id="l35.233" class="difflineplus">+      return false;</span>
<a href="#l35.234"></a><span id="l35.234" class="difflineplus">+</span>
<a href="#l35.235"></a><span id="l35.235" class="difflineplus">+    // translate message IDs back to messages.  this is O(s(m+n)) where:</span>
<a href="#l35.236"></a><span id="l35.236" class="difflineplus">+    // - s is the number of messages saved in the selection</span>
<a href="#l35.237"></a><span id="l35.237" class="difflineplus">+    // - m is the number of messages in the view (from findIndexOfMsgHdr)</span>
<a href="#l35.238"></a><span id="l35.238" class="difflineplus">+    // - n is the number of messages in the underlying folders (from</span>
<a href="#l35.239"></a><span id="l35.239" class="difflineplus">+    //   DBViewWrapper.getMsgHdrForMessageID).</span>
<a href="#l35.240"></a><span id="l35.240" class="difflineplus">+    // which ends up being O(sn)</span>
<a href="#l35.241"></a><span id="l35.241" class="difflineplus">+    var msgHdr;</span>
<a href="#l35.242"></a><span id="l35.242" class="difflineplus">+    let messages =</span>
<a href="#l35.243"></a><span id="l35.243" class="difflineplus">+      [msgHdr for each</span>
<a href="#l35.244"></a><span id="l35.244" class="difflineplus">+        ([, savedInfo] in Iterator(this._savedSelection)) if</span>
<a href="#l35.245"></a><span id="l35.245" class="difflineplus">+        ((msgHdr = this.view.getMsgHdrForMessageID(savedInfo.messageId)))];</span>
<a href="#l35.246"></a><span id="l35.246" class="difflineplus">+</span>
<a href="#l35.247"></a><span id="l35.247" class="difflineplus">+    this.selectMessages(messages, true);</span>
<a href="#l35.248"></a><span id="l35.248" class="difflineplus">+    this._savedSelection = null;</span>
<a href="#l35.249"></a><span id="l35.249" class="difflineplus">+</span>
<a href="#l35.250"></a><span id="l35.250" class="difflineplus">+    return this.selectedCount != 0;</span>
<a href="#l35.251"></a><span id="l35.251" class="difflineplus">+  },</span>
<a href="#l35.252"></a><span id="l35.252" class="difflineplus">+</span>
<a href="#l35.253"></a><span id="l35.253" class="difflineplus">+  /**</span>
<a href="#l35.254"></a><span id="l35.254" class="difflineplus">+   * Maps column ids to functions that test whether the column is legal for</span>
<a href="#l35.255"></a><span id="l35.255" class="difflineplus">+   *  display for the folder.  Each function should expect a DBViewWrapper</span>
<a href="#l35.256"></a><span id="l35.256" class="difflineplus">+   *  instance as its argument.  The intent is that the various helper</span>
<a href="#l35.257"></a><span id="l35.257" class="difflineplus">+   *  properties like isMailFolder/isIncomingFolder/isOutgoingFolder allow the</span>
<a href="#l35.258"></a><span id="l35.258" class="difflineplus">+   *  constraint to be expressed concisely.  If a helper does not exist, add</span>
<a href="#l35.259"></a><span id="l35.259" class="difflineplus">+   *  one! (If doing so is out of reach, than access viewWrapper.displayedFolder</span>
<a href="#l35.260"></a><span id="l35.260" class="difflineplus">+   *  to get at the nsIMsgFolder.)</span>
<a href="#l35.261"></a><span id="l35.261" class="difflineplus">+   * If a column does not have a function, it is assumed to be legal for display</span>
<a href="#l35.262"></a><span id="l35.262" class="difflineplus">+   *  in all cases.</span>
<a href="#l35.263"></a><span id="l35.263" class="difflineplus">+   */</span>
<a href="#l35.264"></a><span id="l35.264" class="difflineplus">+  COLUMN_LEGALITY_TESTERS: {</span>
<a href="#l35.265"></a><span id="l35.265" class="difflineplus">+    // Only show 'Received' column for e-mails.  For newsgroup messages, the</span>
<a href="#l35.266"></a><span id="l35.266" class="difflineplus">+    // 'Date' header is as reliable as an e-mail's 'Received' header, as it is</span>
<a href="#l35.267"></a><span id="l35.267" class="difflineplus">+    // replaced with the news server's (more reliable) date.</span>
<a href="#l35.268"></a><span id="l35.268" class="difflineplus">+    receivedCol: function (viewWrapper) {</span>
<a href="#l35.269"></a><span id="l35.269" class="difflineplus">+      return viewWrapper.isMailFolder &amp;&amp; !viewWrapper.isOutgoingFolder;</span>
<a href="#l35.270"></a><span id="l35.270" class="difflineplus">+    },</span>
<a href="#l35.271"></a><span id="l35.271" class="difflineplus">+    // senderCol = From.  You only care in incoming folders.</span>
<a href="#l35.272"></a><span id="l35.272" class="difflineplus">+    senderCol: function (viewWrapper) {</span>
<a href="#l35.273"></a><span id="l35.273" class="difflineplus">+      return viewWrapper.isIncomingFolder;</span>
<a href="#l35.274"></a><span id="l35.274" class="difflineplus">+    },</span>
<a href="#l35.275"></a><span id="l35.275" class="difflineplus">+    // recipient = To. You only care in outgoing folders.</span>
<a href="#l35.276"></a><span id="l35.276" class="difflineplus">+    recipientCol: function (viewWrapper) {</span>
<a href="#l35.277"></a><span id="l35.277" class="difflineplus">+      return viewWrapper.isOutgoingFolder;</span>
<a href="#l35.278"></a><span id="l35.278" class="difflineplus">+    },</span>
<a href="#l35.279"></a><span id="l35.279" class="difflineplus">+    // Only show the location column for non-single-folder results</span>
<a href="#l35.280"></a><span id="l35.280" class="difflineplus">+    locationCol: function(viewWrapper) {</span>
<a href="#l35.281"></a><span id="l35.281" class="difflineplus">+      return !viewWrapper.isSingleFolder;</span>
<a href="#l35.282"></a><span id="l35.282" class="difflineplus">+    },</span>
<a href="#l35.283"></a><span id="l35.283" class="difflineplus">+  },</span>
<a href="#l35.284"></a><span id="l35.284" class="difflineplus">+</span>
<a href="#l35.285"></a><span id="l35.285" class="difflineplus">+  /**</span>
<a href="#l35.286"></a><span id="l35.286" class="difflineplus">+   * If we determine that a column is illegal but was displayed, use this</span>
<a href="#l35.287"></a><span id="l35.287" class="difflineplus">+   *  mapping to find suggested legal alternatives.  This basically exists</span>
<a href="#l35.288"></a><span id="l35.288" class="difflineplus">+   *  just to flip-flop between senderCol and recipientCol.</span>
<a href="#l35.289"></a><span id="l35.289" class="difflineplus">+   */</span>
<a href="#l35.290"></a><span id="l35.290" class="difflineplus">+  COLUMN_LEGAL_ALTERNATIVES: {</span>
<a href="#l35.291"></a><span id="l35.291" class="difflineplus">+    // swap between sender and recipient</span>
<a href="#l35.292"></a><span id="l35.292" class="difflineplus">+    senderCol: [&quot;recipientCol&quot;],</span>
<a href="#l35.293"></a><span id="l35.293" class="difflineplus">+    recipientCol: [&quot;senderCol&quot;],</span>
<a href="#l35.294"></a><span id="l35.294" class="difflineplus">+    // if we nuke received, put back date...</span>
<a href="#l35.295"></a><span id="l35.295" class="difflineplus">+    receivedCol: [&quot;dateCol&quot;],</span>
<a href="#l35.296"></a><span id="l35.296" class="difflineplus">+  },</span>
<a href="#l35.297"></a><span id="l35.297" class="difflineplus">+</span>
<a href="#l35.298"></a><span id="l35.298" class="difflineplus">+  /**</span>
<a href="#l35.299"></a><span id="l35.299" class="difflineplus">+   * Columns to display whenever we can.  This is currently a bit of a hack to</span>
<a href="#l35.300"></a><span id="l35.300" class="difflineplus">+   *  always show the location column when relevant.  Arguably, it would be</span>
<a href="#l35.301"></a><span id="l35.301" class="difflineplus">+   *  better to use this as a default for a folder you've never been in and</span>
<a href="#l35.302"></a><span id="l35.302" class="difflineplus">+   *  the rest of the time we restore the last column set for that folder from</span>
<a href="#l35.303"></a><span id="l35.303" class="difflineplus">+   *  properties.</span>
<a href="#l35.304"></a><span id="l35.304" class="difflineplus">+   */</span>
<a href="#l35.305"></a><span id="l35.305" class="difflineplus">+  COLUMNS_DISPLAY_WHEN_POSSIBLE: [&quot;locationCol&quot;],</span>
<a href="#l35.306"></a><span id="l35.306" class="difflineplus">+</span>
<a href="#l35.307"></a><span id="l35.307" class="difflineplus">+  /**</span>
<a href="#l35.308"></a><span id="l35.308" class="difflineplus">+   * Update the displayed columns so that:</span>
<a href="#l35.309"></a><span id="l35.309" class="difflineplus">+   * - Only legal columns (per COLUMN_LEGALITY_TESTERS) are displayed.</span>
<a href="#l35.310"></a><span id="l35.310" class="difflineplus">+   * - Alternatives to now-illegal columns may be displayed.</span>
<a href="#l35.311"></a><span id="l35.311" class="difflineplus">+   */</span>
<a href="#l35.312"></a><span id="l35.312" class="difflineplus">+  updateColumns: function() {</span>
<a href="#l35.313"></a><span id="l35.313" class="difflineplus">+    // Keep a list of columns we might want to make show up if they are not</span>
<a href="#l35.314"></a><span id="l35.314" class="difflineplus">+    //  illegal.</span>
<a href="#l35.315"></a><span id="l35.315" class="difflineplus">+    let legalize = this.COLUMNS_DISPLAY_WHEN_POSSIBLE.concat();</span>
<a href="#l35.316"></a><span id="l35.316" class="difflineplus">+</span>
<a href="#l35.317"></a><span id="l35.317" class="difflineplus">+    // figure out who is illegal and make them go away</span>
<a href="#l35.318"></a><span id="l35.318" class="difflineplus">+    for (let [colId, legalityFunc] in Iterator(this.COLUMN_LEGALITY_TESTERS)) {</span>
<a href="#l35.319"></a><span id="l35.319" class="difflineplus">+      let column = document.getElementById(colId);</span>
<a href="#l35.320"></a><span id="l35.320" class="difflineplus">+      // The search window does not have all the columns we know about, bail in</span>
<a href="#l35.321"></a><span id="l35.321" class="difflineplus">+      //  such cases.</span>
<a href="#l35.322"></a><span id="l35.322" class="difflineplus">+      if (!column)</span>
<a href="#l35.323"></a><span id="l35.323" class="difflineplus">+        continue;</span>
<a href="#l35.324"></a><span id="l35.324" class="difflineplus">+      let legal = legalityFunc(this.view);</span>
<a href="#l35.325"></a><span id="l35.325" class="difflineplus">+</span>
<a href="#l35.326"></a><span id="l35.326" class="difflineplus">+      if (!legal) {</span>
<a href="#l35.327"></a><span id="l35.327" class="difflineplus">+        let isHidden = column.getAttribute(&quot;hidden&quot;) == &quot;true&quot;;</span>
<a href="#l35.328"></a><span id="l35.328" class="difflineplus">+        // If it wasn't hidden, consider making its alternatives visible in the</span>
<a href="#l35.329"></a><span id="l35.329" class="difflineplus">+        //  next pass.</span>
<a href="#l35.330"></a><span id="l35.330" class="difflineplus">+        if (!isHidden &amp;&amp; (colId in this.COLUMN_LEGAL_ALTERNATIVES))</span>
<a href="#l35.331"></a><span id="l35.331" class="difflineplus">+          legalize = legalize.concat(this.COLUMN_LEGAL_ALTERNATIVES[colId]);</span>
<a href="#l35.332"></a><span id="l35.332" class="difflineplus">+        // but definitely hide the heck out of it right now</span>
<a href="#l35.333"></a><span id="l35.333" class="difflineplus">+        column.setAttribute(&quot;hidden&quot;, true);</span>
<a href="#l35.334"></a><span id="l35.334" class="difflineplus">+        column.setAttribute(&quot;ignoreincolumnpicker&quot;, true);</span>
<a href="#l35.335"></a><span id="l35.335" class="difflineplus">+      }</span>
<a href="#l35.336"></a><span id="l35.336" class="difflineplus">+      else {</span>
<a href="#l35.337"></a><span id="l35.337" class="difflineplus">+        column.removeAttribute(&quot;ignoreincolumnpicker&quot;);</span>
<a href="#l35.338"></a><span id="l35.338" class="difflineplus">+      }</span>
<a href="#l35.339"></a><span id="l35.339" class="difflineplus">+    }</span>
<a href="#l35.340"></a><span id="l35.340" class="difflineplus">+    // If we have any columns we should consider making visible because they are</span>
<a href="#l35.341"></a><span id="l35.341" class="difflineplus">+    //  alternatives to columns that became illegal, uh, do that.</span>
<a href="#l35.342"></a><span id="l35.342" class="difflineplus">+    for each (let [, colId] in Iterator(legalize)) {</span>
<a href="#l35.343"></a><span id="l35.343" class="difflineplus">+      let column = document.getElementById(colId);</span>
<a href="#l35.344"></a><span id="l35.344" class="difflineplus">+      let isLegal = column.getAttribute(&quot;ignoreincolumnpicker&quot;) != &quot;true&quot;;</span>
<a href="#l35.345"></a><span id="l35.345" class="difflineplus">+      let isHidden = column.getAttribute(&quot;hidden&quot;) == &quot;true&quot;;</span>
<a href="#l35.346"></a><span id="l35.346" class="difflineplus">+      if (isLegal &amp;&amp; isHidden)</span>
<a href="#l35.347"></a><span id="l35.347" class="difflineplus">+        column.removeAttribute(&quot;hidden&quot;);</span>
<a href="#l35.348"></a><span id="l35.348" class="difflineplus">+    }</span>
<a href="#l35.349"></a><span id="l35.349" class="difflineplus">+  },</span>
<a href="#l35.350"></a><span id="l35.350" class="difflineplus">+</span>
<a href="#l35.351"></a><span id="l35.351" class="difflineplus">+  /**</span>
<a href="#l35.352"></a><span id="l35.352" class="difflineplus">+   * @param aColumnMap an object where the attribute names are column ids and</span>
<a href="#l35.353"></a><span id="l35.353" class="difflineplus">+   *     the values are a boolean indicating whether the column should be</span>
<a href="#l35.354"></a><span id="l35.354" class="difflineplus">+   *     visible or not.  If a column is not in the map, it is assumed that it</span>
<a href="#l35.355"></a><span id="l35.355" class="difflineplus">+   *     should be hidden.</span>
<a href="#l35.356"></a><span id="l35.356" class="difflineplus">+   */</span>
<a href="#l35.357"></a><span id="l35.357" class="difflineplus">+  setVisibleColumns: function(aColumnMap) {</span>
<a href="#l35.358"></a><span id="l35.358" class="difflineplus">+    let cols = document.getElementById(&quot;threadCols&quot;);</span>
<a href="#l35.359"></a><span id="l35.359" class="difflineplus">+    let colChildren = cols.children;</span>
<a href="#l35.360"></a><span id="l35.360" class="difflineplus">+</span>
<a href="#l35.361"></a><span id="l35.361" class="difflineplus">+    // because the splitter correspondence can be confusing and tricky, let's</span>
<a href="#l35.362"></a><span id="l35.362" class="difflineplus">+    //  build a list of the nodes ordered by their ordinal</span>
<a href="#l35.363"></a><span id="l35.363" class="difflineplus">+    let ordinalOrdered = [], iKid;</span>
<a href="#l35.364"></a><span id="l35.364" class="difflineplus">+    for (iKid = 0; iKid &lt; colChildren.length; iKid++)</span>
<a href="#l35.365"></a><span id="l35.365" class="difflineplus">+      ordinalOrdered.push(null);</span>
<a href="#l35.366"></a><span id="l35.366" class="difflineplus">+</span>
<a href="#l35.367"></a><span id="l35.367" class="difflineplus">+    for (iKid = 0; iKid &lt; colChildren.length; iKid++) {</span>
<a href="#l35.368"></a><span id="l35.368" class="difflineplus">+      let colChild = colChildren[iKid];</span>
<a href="#l35.369"></a><span id="l35.369" class="difflineplus">+      let ordinal = colChild.getAttribute(&quot;ordinal&quot;) - 1;</span>
<a href="#l35.370"></a><span id="l35.370" class="difflineplus">+      ordinalOrdered[ordinal] = colChild;</span>
<a href="#l35.371"></a><span id="l35.371" class="difflineplus">+    }</span>
<a href="#l35.372"></a><span id="l35.372" class="difflineplus">+</span>
<a href="#l35.373"></a><span id="l35.373" class="difflineplus">+    function twiddleAround(index, makeHidden) {</span>
<a href="#l35.374"></a><span id="l35.374" class="difflineplus">+      if (index + 1 &lt; ordinalOrdered.length) {</span>
<a href="#l35.375"></a><span id="l35.375" class="difflineplus">+        let nexty = ordinalOrdered[index+1];</span>
<a href="#l35.376"></a><span id="l35.376" class="difflineplus">+        if (nexty) {</span>
<a href="#l35.377"></a><span id="l35.377" class="difflineplus">+          let isHidden = nexty.getAttribute(&quot;hidden&quot;) == &quot;true&quot;;</span>
<a href="#l35.378"></a><span id="l35.378" class="difflineplus">+          if (isHidden != makeHidden) {</span>
<a href="#l35.379"></a><span id="l35.379" class="difflineplus">+            nexty.setAttribute(&quot;hidden&quot;, true);</span>
<a href="#l35.380"></a><span id="l35.380" class="difflineplus">+            return;</span>
<a href="#l35.381"></a><span id="l35.381" class="difflineplus">+          }</span>
<a href="#l35.382"></a><span id="l35.382" class="difflineplus">+        }</span>
<a href="#l35.383"></a><span id="l35.383" class="difflineplus">+      }</span>
<a href="#l35.384"></a><span id="l35.384" class="difflineplus">+      if (index - 1 &gt; 0) {</span>
<a href="#l35.385"></a><span id="l35.385" class="difflineplus">+        let prevy = ordinalOrdered[index-1];</span>
<a href="#l35.386"></a><span id="l35.386" class="difflineplus">+        if (prevy) {</span>
<a href="#l35.387"></a><span id="l35.387" class="difflineplus">+          let isHidden = prevy.getAttribute(&quot;hidden&quot;) == &quot;true&quot;;</span>
<a href="#l35.388"></a><span id="l35.388" class="difflineplus">+          if (isHidden != makeHidden) {</span>
<a href="#l35.389"></a><span id="l35.389" class="difflineplus">+            prevy.setAttribute(&quot;hidden&quot;, true);</span>
<a href="#l35.390"></a><span id="l35.390" class="difflineplus">+            return;</span>
<a href="#l35.391"></a><span id="l35.391" class="difflineplus">+          }</span>
<a href="#l35.392"></a><span id="l35.392" class="difflineplus">+        }</span>
<a href="#l35.393"></a><span id="l35.393" class="difflineplus">+      }</span>
<a href="#l35.394"></a><span id="l35.394" class="difflineplus">+    }</span>
<a href="#l35.395"></a><span id="l35.395" class="difflineplus">+</span>
<a href="#l35.396"></a><span id="l35.396" class="difflineplus">+    for (iKid = 0; iKid &lt; ordinalOrdered.length; iKid++) {</span>
<a href="#l35.397"></a><span id="l35.397" class="difflineplus">+      let colChild = ordinalOrdered[iKid];</span>
<a href="#l35.398"></a><span id="l35.398" class="difflineplus">+      if (colChild == null)</span>
<a href="#l35.399"></a><span id="l35.399" class="difflineplus">+        continue;</span>
<a href="#l35.400"></a><span id="l35.400" class="difflineplus">+</span>
<a href="#l35.401"></a><span id="l35.401" class="difflineplus">+      if (colChild.tagName == &quot;treecol&quot;) {</span>
<a href="#l35.402"></a><span id="l35.402" class="difflineplus">+        if (colChild.id in aColumnMap) {</span>
<a href="#l35.403"></a><span id="l35.403" class="difflineplus">+          // only need to do something if currently hidden</span>
<a href="#l35.404"></a><span id="l35.404" class="difflineplus">+          if (colChild.getAttribute(&quot;hidden&quot;) == &quot;true&quot;) {</span>
<a href="#l35.405"></a><span id="l35.405" class="difflineplus">+            colChild.removeAttribute(&quot;hidden&quot;);</span>
<a href="#l35.406"></a><span id="l35.406" class="difflineplus">+            twiddleAround(iKid, false);</span>
<a href="#l35.407"></a><span id="l35.407" class="difflineplus">+          }</span>
<a href="#l35.408"></a><span id="l35.408" class="difflineplus">+        }</span>
<a href="#l35.409"></a><span id="l35.409" class="difflineplus">+        else {</span>
<a href="#l35.410"></a><span id="l35.410" class="difflineplus">+          // only need to do something if currently visible</span>
<a href="#l35.411"></a><span id="l35.411" class="difflineplus">+          if (colChild.getAttribute(&quot;hidden&quot;) != &quot;true&quot;) {</span>
<a href="#l35.412"></a><span id="l35.412" class="difflineplus">+            colChild.setAttribute(&quot;hidden&quot;, true);</span>
<a href="#l35.413"></a><span id="l35.413" class="difflineplus">+            twiddleAround(iKid, true);</span>
<a href="#l35.414"></a><span id="l35.414" class="difflineplus">+          }</span>
<a href="#l35.415"></a><span id="l35.415" class="difflineplus">+        }</span>
<a href="#l35.416"></a><span id="l35.416" class="difflineplus">+      }</span>
<a href="#l35.417"></a><span id="l35.417" class="difflineplus">+    }</span>
<a href="#l35.418"></a><span id="l35.418" class="difflineplus">+  },</span>
<a href="#l35.419"></a><span id="l35.419" class="difflineplus">+</span>
<a href="#l35.420"></a><span id="l35.420" class="difflineplus">+  _savedColumnStates: null,</span>
<a href="#l35.421"></a><span id="l35.421" class="difflineplus">+</span>
<a href="#l35.422"></a><span id="l35.422" class="difflineplus">+  /**</span>
<a href="#l35.423"></a><span id="l35.423" class="difflineplus">+   * For now, just save the visible columns into a dictionary for use in a</span>
<a href="#l35.424"></a><span id="l35.424" class="difflineplus">+   *  subsequent call to setVisibleColumns.  This does not do anything about</span>
<a href="#l35.425"></a><span id="l35.425" class="difflineplus">+   *  re-arranging columns.</span>
<a href="#l35.426"></a><span id="l35.426" class="difflineplus">+   */</span>
<a href="#l35.427"></a><span id="l35.427" class="difflineplus">+  saveColumnStates: function() {</span>
<a href="#l35.428"></a><span id="l35.428" class="difflineplus">+    // In the actual nsITreeColumn, the index property indicates the column</span>
<a href="#l35.429"></a><span id="l35.429" class="difflineplus">+    //  number.  This column number is a 0-based index with no gaps; it only</span>
<a href="#l35.430"></a><span id="l35.430" class="difflineplus">+    //  increments the number each time it sees a column.</span>
<a href="#l35.431"></a><span id="l35.431" class="difflineplus">+    // However, this is subservient to the 'ordinal' property which</span>
<a href="#l35.432"></a><span id="l35.432" class="difflineplus">+    //  defines the _apparent content sequence_ provided by GetNextSibling.</span>
<a href="#l35.433"></a><span id="l35.433" class="difflineplus">+    //  The underlying content ordering is still the same, which is how</span>
<a href="#l35.434"></a><span id="l35.434" class="difflineplus">+    //  restoreNaturalOrder can reset things to their XUL definition sequence.</span>
<a href="#l35.435"></a><span id="l35.435" class="difflineplus">+    //  The 'ordinal' stuff works because nsBoxFrame::RelayoutChildAtOrdinal</span>
<a href="#l35.436"></a><span id="l35.436" class="difflineplus">+    //  messes with the sibling relationship.</span>
<a href="#l35.437"></a><span id="l35.437" class="difflineplus">+    // Ordinals are 1-based.  restoreNaturalOrder apparently is dumb and does</span>
<a href="#l35.438"></a><span id="l35.438" class="difflineplus">+    //  not know this, although the ordering is relative so it doesn't actually</span>
<a href="#l35.439"></a><span id="l35.439" class="difflineplus">+    //  matter.  The annoying splitters do have ordinals, and live between</span>
<a href="#l35.440"></a><span id="l35.440" class="difflineplus">+    //  tree columns.  The splitters adjacent to a tree column do not need to</span>
<a href="#l35.441"></a><span id="l35.441" class="difflineplus">+    //  have any 'ordinal' relationship, although it would appear user activity</span>
<a href="#l35.442"></a><span id="l35.442" class="difflineplus">+    //  tends to move them around in a predictable fashion with oddness involved</span>
<a href="#l35.443"></a><span id="l35.443" class="difflineplus">+    //  at the edges.</span>
<a href="#l35.444"></a><span id="l35.444" class="difflineplus">+    // Changes to the ordinal attribute should take immediate effect in terms of</span>
<a href="#l35.445"></a><span id="l35.445" class="difflineplus">+    //  sibling relationship, but will merely invalidate the columns rather than</span>
<a href="#l35.446"></a><span id="l35.446" class="difflineplus">+    //  cause a re-computaiton of column relationships every time.</span>
<a href="#l35.447"></a><span id="l35.447" class="difflineplus">+    // restoreNaturalOrder invalidates the tree when it is done re-ordering; I'm</span>
<a href="#l35.448"></a><span id="l35.448" class="difflineplus">+    //  not sure that's entirely necessary...</span>
<a href="#l35.449"></a><span id="l35.449" class="difflineplus">+</span>
<a href="#l35.450"></a><span id="l35.450" class="difflineplus">+    let visibleMap = {};</span>
<a href="#l35.451"></a><span id="l35.451" class="difflineplus">+</span>
<a href="#l35.452"></a><span id="l35.452" class="difflineplus">+    let cols = document.getElementById(&quot;threadCols&quot;);</span>
<a href="#l35.453"></a><span id="l35.453" class="difflineplus">+    let colChildren = cols.children;</span>
<a href="#l35.454"></a><span id="l35.454" class="difflineplus">+    for (let iKid = 0; iKid &lt; colChildren.length; iKid++) {</span>
<a href="#l35.455"></a><span id="l35.455" class="difflineplus">+      let colChild = colChildren[iKid];</span>
<a href="#l35.456"></a><span id="l35.456" class="difflineplus">+      if (colChild.getAttribute(&quot;hidden&quot;) != &quot;true&quot;)</span>
<a href="#l35.457"></a><span id="l35.457" class="difflineplus">+        visibleMap[colChild.id] = true;</span>
<a href="#l35.458"></a><span id="l35.458" class="difflineplus">+    }</span>
<a href="#l35.459"></a><span id="l35.459" class="difflineplus">+</span>
<a href="#l35.460"></a><span id="l35.460" class="difflineplus">+    this._savedColumnStates = visibleMap;</span>
<a href="#l35.461"></a><span id="l35.461" class="difflineplus">+  },</span>
<a href="#l35.462"></a><span id="l35.462" class="difflineplus">+</span>
<a href="#l35.463"></a><span id="l35.463" class="difflineplus">+  /**</span>
<a href="#l35.464"></a><span id="l35.464" class="difflineplus">+   * Restores the visible columns saved by saveColumnStates.  Some day, in the</span>
<a href="#l35.465"></a><span id="l35.465" class="difflineplus">+   *  future we might do something about positions and the like.  But we don't</span>
<a href="#l35.466"></a><span id="l35.466" class="difflineplus">+   *  currently.</span>
<a href="#l35.467"></a><span id="l35.467" class="difflineplus">+   */</span>
<a href="#l35.468"></a><span id="l35.468" class="difflineplus">+  restoreColumnStates: function () {</span>
<a href="#l35.469"></a><span id="l35.469" class="difflineplus">+    if (this._savedColumnStates) {</span>
<a href="#l35.470"></a><span id="l35.470" class="difflineplus">+      this.setVisibleColumns(this._savedColumnStates);</span>
<a href="#l35.471"></a><span id="l35.471" class="difflineplus">+      this._savedColumnStates = null;</span>
<a href="#l35.472"></a><span id="l35.472" class="difflineplus">+    }</span>
<a href="#l35.473"></a><span id="l35.473" class="difflineplus">+  },</span>
<a href="#l35.474"></a><span id="l35.474" class="difflineplus">+</span>
<a href="#l35.475"></a><span id="l35.475" class="difflineplus">+  showFolderUri: function FolderDisplayWidget_showFolderUri(aFolderURI) {</span>
<a href="#l35.476"></a><span id="l35.476" class="difflineplus">+    return this.show(GetMsgFolderFromUri(aFolderURI));</span>
<a href="#l35.477"></a><span id="l35.477" class="difflineplus">+  },</span>
<a href="#l35.478"></a><span id="l35.478" class="difflineplus">+</span>
<a href="#l35.479"></a><span id="l35.479" class="difflineplus">+  /**</span>
<a href="#l35.480"></a><span id="l35.480" class="difflineplus">+   * Invoked by showFolder when it turns out the folder is in fact a server.</span>
<a href="#l35.481"></a><span id="l35.481" class="difflineplus">+   */</span>
<a href="#l35.482"></a><span id="l35.482" class="difflineplus">+  _showServer: function FolderDisplayWidget__showServer() {</span>
<a href="#l35.483"></a><span id="l35.483" class="difflineplus">+    // currently nothing to do.  makeActive handles everything for us (because</span>
<a href="#l35.484"></a><span id="l35.484" class="difflineplus">+    //  what is displayed needs to be re-asserted each time we are activated</span>
<a href="#l35.485"></a><span id="l35.485" class="difflineplus">+    //  too.)</span>
<a href="#l35.486"></a><span id="l35.486" class="difflineplus">+  },</span>
<a href="#l35.487"></a><span id="l35.487" class="difflineplus">+</span>
<a href="#l35.488"></a><span id="l35.488" class="difflineplus">+  /**</span>
<a href="#l35.489"></a><span id="l35.489" class="difflineplus">+   * Select a folder for display.</span>
<a href="#l35.490"></a><span id="l35.490" class="difflineplus">+   *</span>
<a href="#l35.491"></a><span id="l35.491" class="difflineplus">+   * @param aFolder The nsIMsgDBFolder to display.</span>
<a href="#l35.492"></a><span id="l35.492" class="difflineplus">+   */</span>
<a href="#l35.493"></a><span id="l35.493" class="difflineplus">+  show: function FolderDisplayWidget_show(aFolder) {</span>
<a href="#l35.494"></a><span id="l35.494" class="difflineplus">+    if (aFolder == null) {</span>
<a href="#l35.495"></a><span id="l35.495" class="difflineplus">+      this._nonViewFolder = null;</span>
<a href="#l35.496"></a><span id="l35.496" class="difflineplus">+      this.view.close();</span>
<a href="#l35.497"></a><span id="l35.497" class="difflineplus">+    }</span>
<a href="#l35.498"></a><span id="l35.498" class="difflineplus">+    else if (aFolder instanceof Components.interfaces.nsIMsgFolder) {</span>
<a href="#l35.499"></a><span id="l35.499" class="difflineplus">+      if (aFolder.isServer) {</span>
<a href="#l35.500"></a><span id="l35.500" class="difflineplus">+        this._nonViewFolder = aFolder;</span>
<a href="#l35.501"></a><span id="l35.501" class="difflineplus">+        this._showServer();</span>
<a href="#l35.502"></a><span id="l35.502" class="difflineplus">+        this.view.close();</span>
<a href="#l35.503"></a><span id="l35.503" class="difflineplus">+        // A server is fully loaded immediately, for now.  (When we have the</span>
<a href="#l35.504"></a><span id="l35.504" class="difflineplus">+        //  account summary, we might want to change this to wait for the page</span>
<a href="#l35.505"></a><span id="l35.505" class="difflineplus">+        //  load to complete.)</span>
<a href="#l35.506"></a><span id="l35.506" class="difflineplus">+        this._allMessagesLoaded = true;</span>
<a href="#l35.507"></a><span id="l35.507" class="difflineplus">+      }</span>
<a href="#l35.508"></a><span id="l35.508" class="difflineplus">+      else {</span>
<a href="#l35.509"></a><span id="l35.509" class="difflineplus">+        this._nonViewFolder = null;</span>
<a href="#l35.510"></a><span id="l35.510" class="difflineplus">+        this.view.open(aFolder);</span>
<a href="#l35.511"></a><span id="l35.511" class="difflineplus">+      }</span>
<a href="#l35.512"></a><span id="l35.512" class="difflineplus">+    }</span>
<a href="#l35.513"></a><span id="l35.513" class="difflineplus">+    // it must be a synthetic view</span>
<a href="#l35.514"></a><span id="l35.514" class="difflineplus">+    else {</span>
<a href="#l35.515"></a><span id="l35.515" class="difflineplus">+      this.view.openSynthetic(aFolder);</span>
<a href="#l35.516"></a><span id="l35.516" class="difflineplus">+    }</span>
<a href="#l35.517"></a><span id="l35.517" class="difflineplus">+    if (this._active)</span>
<a href="#l35.518"></a><span id="l35.518" class="difflineplus">+      this.makeActive();</span>
<a href="#l35.519"></a><span id="l35.519" class="difflineplus">+</span>
<a href="#l35.520"></a><span id="l35.520" class="difflineplus">+    if (this._tabInfo)</span>
<a href="#l35.521"></a><span id="l35.521" class="difflineplus">+      document.getElementById('tabmail').setTabTitle(this._tabInfo);</span>
<a href="#l35.522"></a><span id="l35.522" class="difflineplus">+  },</span>
<a href="#l35.523"></a><span id="l35.523" class="difflineplus">+</span>
<a href="#l35.524"></a><span id="l35.524" class="difflineplus">+  /**</span>
<a href="#l35.525"></a><span id="l35.525" class="difflineplus">+   * Clone an existing view wrapper as the basis for our display.</span>
<a href="#l35.526"></a><span id="l35.526" class="difflineplus">+   */</span>
<a href="#l35.527"></a><span id="l35.527" class="difflineplus">+  cloneView: function FolderDisplayWidget_cloneView(aViewWrapper) {</span>
<a href="#l35.528"></a><span id="l35.528" class="difflineplus">+    this.view = aViewWrapper.clone(this);</span>
<a href="#l35.529"></a><span id="l35.529" class="difflineplus">+    // generate a view created notification; this will cause us to do the right</span>
<a href="#l35.530"></a><span id="l35.530" class="difflineplus">+    //  thing in terms of associating the view with the tree and such.</span>
<a href="#l35.531"></a><span id="l35.531" class="difflineplus">+    this.onCreatedView();</span>
<a href="#l35.532"></a><span id="l35.532" class="difflineplus">+    if (this._active)</span>
<a href="#l35.533"></a><span id="l35.533" class="difflineplus">+      this.makeActive();</span>
<a href="#l35.534"></a><span id="l35.534" class="difflineplus">+  },</span>
<a href="#l35.535"></a><span id="l35.535" class="difflineplus">+</span>
<a href="#l35.536"></a><span id="l35.536" class="difflineplus">+  /**</span>
<a href="#l35.537"></a><span id="l35.537" class="difflineplus">+   * Close resources associated with the currently displayed folder because you</span>
<a href="#l35.538"></a><span id="l35.538" class="difflineplus">+   *  no longer care about this FolderDisplayWidget.</span>
<a href="#l35.539"></a><span id="l35.539" class="difflineplus">+   */</span>
<a href="#l35.540"></a><span id="l35.540" class="difflineplus">+  close: function FolderDisplayWidget_close() {</span>
<a href="#l35.541"></a><span id="l35.541" class="difflineplus">+    // Mark ourselves as inactive without doing any of the hard work of becoming</span>
<a href="#l35.542"></a><span id="l35.542" class="difflineplus">+    //  inactive.  This saves us from trying to update things as they go away.</span>
<a href="#l35.543"></a><span id="l35.543" class="difflineplus">+    this._active = false;</span>
<a href="#l35.544"></a><span id="l35.544" class="difflineplus">+    // Tell the message display to close itself too.  We do this before we do</span>
<a href="#l35.545"></a><span id="l35.545" class="difflineplus">+    //  anything else because closing the view could theoretically propagate</span>
<a href="#l35.546"></a><span id="l35.546" class="difflineplus">+    //  down to the message display and we don't want it doing anything it</span>
<a href="#l35.547"></a><span id="l35.547" class="difflineplus">+    //  doesn't have to do.</span>
<a href="#l35.548"></a><span id="l35.548" class="difflineplus">+    this.messageDisplay._close();</span>
<a href="#l35.549"></a><span id="l35.549" class="difflineplus">+</span>
<a href="#l35.550"></a><span id="l35.550" class="difflineplus">+    this.view.close();</span>
<a href="#l35.551"></a><span id="l35.551" class="difflineplus">+    this.messenger.setWindow(null, null);</span>
<a href="#l35.552"></a><span id="l35.552" class="difflineplus">+    this.messenger = null;</span>
<a href="#l35.553"></a><span id="l35.553" class="difflineplus">+    this._fakeTreeBox = null;</span>
<a href="#l35.554"></a><span id="l35.554" class="difflineplus">+  },</span>
<a href="#l35.555"></a><span id="l35.555" class="difflineplus">+</span>
<a href="#l35.556"></a><span id="l35.556" class="difflineplus">+  /*   ===============================   */</span>
<a href="#l35.557"></a><span id="l35.557" class="difflineplus">+  /* ===== IDBViewWrapper Listener ===== */</span>
<a href="#l35.558"></a><span id="l35.558" class="difflineplus">+  /*   ===============================   */</span>
<a href="#l35.559"></a><span id="l35.559" class="difflineplus">+</span>
<a href="#l35.560"></a><span id="l35.560" class="difflineplus">+  /**</span>
<a href="#l35.561"></a><span id="l35.561" class="difflineplus">+   * @return true if the mail view picker is visible.  This affects whether the</span>
<a href="#l35.562"></a><span id="l35.562" class="difflineplus">+   *     DBViewWrapper will actually use the persisted mail view or not.</span>
<a href="#l35.563"></a><span id="l35.563" class="difflineplus">+   */</span>
<a href="#l35.564"></a><span id="l35.564" class="difflineplus">+  get shouldUseMailViews() {</span>
<a href="#l35.565"></a><span id="l35.565" class="difflineplus">+    return ViewPickerBinding.isVisible;</span>
<a href="#l35.566"></a><span id="l35.566" class="difflineplus">+  },</span>
<a href="#l35.567"></a><span id="l35.567" class="difflineplus">+</span>
<a href="#l35.568"></a><span id="l35.568" class="difflineplus">+  /**</span>
<a href="#l35.569"></a><span id="l35.569" class="difflineplus">+   * Let the viewWrapper know if we should defer message display because we</span>
<a href="#l35.570"></a><span id="l35.570" class="difflineplus">+   *  want the user to connect to the server first so password authentication</span>
<a href="#l35.571"></a><span id="l35.571" class="difflineplus">+   *  can occur.</span>
<a href="#l35.572"></a><span id="l35.572" class="difflineplus">+   *</span>
<a href="#l35.573"></a><span id="l35.573" class="difflineplus">+   * @return true if the folder should be shown immediately, false if we should</span>
<a href="#l35.574"></a><span id="l35.574" class="difflineplus">+   *     wait for updateFolder to complete.</span>
<a href="#l35.575"></a><span id="l35.575" class="difflineplus">+   */</span>
<a href="#l35.576"></a><span id="l35.576" class="difflineplus">+  get shouldDeferMessageDisplayUntilAfterServerConnect() {</span>
<a href="#l35.577"></a><span id="l35.577" class="difflineplus">+    let passwordPromptRequired = false;</span>
<a href="#l35.578"></a><span id="l35.578" class="difflineplus">+</span>
<a href="#l35.579"></a><span id="l35.579" class="difflineplus">+    if (gPrefBranch.getBoolPref(&quot;mail.password_protect_local_cache&quot;))</span>
<a href="#l35.580"></a><span id="l35.580" class="difflineplus">+      passwordPromptRequired =</span>
<a href="#l35.581"></a><span id="l35.581" class="difflineplus">+        this.view.displayedFolder.server.passwordPromptRequired;</span>
<a href="#l35.582"></a><span id="l35.582" class="difflineplus">+</span>
<a href="#l35.583"></a><span id="l35.583" class="difflineplus">+    return passwordPromptRequired;</span>
<a href="#l35.584"></a><span id="l35.584" class="difflineplus">+  },</span>
<a href="#l35.585"></a><span id="l35.585" class="difflineplus">+</span>
<a href="#l35.586"></a><span id="l35.586" class="difflineplus">+  /**</span>
<a href="#l35.587"></a><span id="l35.587" class="difflineplus">+   * Let the viewWrapper know if it should mark the messages read when leaving</span>
<a href="#l35.588"></a><span id="l35.588" class="difflineplus">+   *  the provided folder.</span>
<a href="#l35.589"></a><span id="l35.589" class="difflineplus">+   *</span>
<a href="#l35.590"></a><span id="l35.590" class="difflineplus">+   * @return true if the preference is set for the folder's server type.</span>
<a href="#l35.591"></a><span id="l35.591" class="difflineplus">+   */</span>
<a href="#l35.592"></a><span id="l35.592" class="difflineplus">+  shouldMarkMessagesReadOnLeavingFolder:</span>
<a href="#l35.593"></a><span id="l35.593" class="difflineplus">+    function FolderDisplayWidget_crazyMarkOnReadChecker (aMsgFolder) {</span>
<a href="#l35.594"></a><span id="l35.594" class="difflineplus">+      return gPrefBranch.getBoolPref(&quot;mailnews.mark_message_read.&quot; +</span>
<a href="#l35.595"></a><span id="l35.595" class="difflineplus">+                                     aMsgFolder.server.type);</span>
<a href="#l35.596"></a><span id="l35.596" class="difflineplus">+  },</span>
<a href="#l35.597"></a><span id="l35.597" class="difflineplus">+</span>
<a href="#l35.598"></a><span id="l35.598" class="difflineplus">+  /**</span>
<a href="#l35.599"></a><span id="l35.599" class="difflineplus">+   * The view wrapper tells us when it starts loading a folder, and we set the</span>
<a href="#l35.600"></a><span id="l35.600" class="difflineplus">+   *  cursor busy.  Setting the cursor busy on a per-tab basis is us being</span>
<a href="#l35.601"></a><span id="l35.601" class="difflineplus">+   *  nice to the future. Loading a folder is a blocking operation that is going</span>
<a href="#l35.602"></a><span id="l35.602" class="difflineplus">+   *  to make us unresponsive and accordingly make it very hard for the user to</span>
<a href="#l35.603"></a><span id="l35.603" class="difflineplus">+   *  change tabs.</span>
<a href="#l35.604"></a><span id="l35.604" class="difflineplus">+   */</span>
<a href="#l35.605"></a><span id="l35.605" class="difflineplus">+  onFolderLoading: function(aFolderLoading) {</span>
<a href="#l35.606"></a><span id="l35.606" class="difflineplus">+    if (this._tabInfo)</span>
<a href="#l35.607"></a><span id="l35.607" class="difflineplus">+      document.getElementById(&quot;tabmail&quot;).setTabBusy(this._tabInfo,</span>
<a href="#l35.608"></a><span id="l35.608" class="difflineplus">+                                                    aFolderLoading);</span>
<a href="#l35.609"></a><span id="l35.609" class="difflineplus">+  },</span>
<a href="#l35.610"></a><span id="l35.610" class="difflineplus">+</span>
<a href="#l35.611"></a><span id="l35.611" class="difflineplus">+  /**</span>
<a href="#l35.612"></a><span id="l35.612" class="difflineplus">+   * The view wrapper tells us when a search is active, and we mark the tab as</span>
<a href="#l35.613"></a><span id="l35.613" class="difflineplus">+   *  thinking so the user knows something is happening.  'Searching' in this</span>
<a href="#l35.614"></a><span id="l35.614" class="difflineplus">+   *  case is more than just a user-initiated search.  Virtual folders / saved</span>
<a href="#l35.615"></a><span id="l35.615" class="difflineplus">+   *  searches, mail views, plus the more obvious quick search are all based off</span>
<a href="#l35.616"></a><span id="l35.616" class="difflineplus">+   *  of searches and we will receive a notification for them.</span>
<a href="#l35.617"></a><span id="l35.617" class="difflineplus">+   */</span>
<a href="#l35.618"></a><span id="l35.618" class="difflineplus">+  onSearching: function(aIsSearching) {</span>
<a href="#l35.619"></a><span id="l35.619" class="difflineplus">+    // getDocumentElements() sets gSearchBundle</span>
<a href="#l35.620"></a><span id="l35.620" class="difflineplus">+    getDocumentElements();</span>
<a href="#l35.621"></a><span id="l35.621" class="difflineplus">+    if (this._tabInfo)</span>
<a href="#l35.622"></a><span id="l35.622" class="difflineplus">+      document.getElementById(&quot;tabmail&quot;).setTabThinking(</span>
<a href="#l35.623"></a><span id="l35.623" class="difflineplus">+        this._tabInfo,</span>
<a href="#l35.624"></a><span id="l35.624" class="difflineplus">+        aIsSearching &amp;&amp; gSearchBundle.getString(&quot;searchingMessage&quot;));</span>
<a href="#l35.625"></a><span id="l35.625" class="difflineplus">+  },</span>
<a href="#l35.626"></a><span id="l35.626" class="difflineplus">+</span>
<a href="#l35.627"></a><span id="l35.627" class="difflineplus">+  /**</span>
<a href="#l35.628"></a><span id="l35.628" class="difflineplus">+   * Things we do on creating a view:</span>
<a href="#l35.629"></a><span id="l35.629" class="difflineplus">+   * - notify the observer service so that custom column handler providers can</span>
<a href="#l35.630"></a><span id="l35.630" class="difflineplus">+   *   add their custom columns to our view.</span>
<a href="#l35.631"></a><span id="l35.631" class="difflineplus">+   */</span>
<a href="#l35.632"></a><span id="l35.632" class="difflineplus">+  onCreatedView: function FolderDisplayWidget_onCreatedView() {</span>
<a href="#l35.633"></a><span id="l35.633" class="difflineplus">+    // All of our messages are not displayed if the view was just created.  We</span>
<a href="#l35.634"></a><span id="l35.634" class="difflineplus">+    //  will get an onAllMessagesLoaded nearly immediately if this is a local</span>
<a href="#l35.635"></a><span id="l35.635" class="difflineplus">+    //  folder where view creation is synonymous with having all messages.</span>
<a href="#l35.636"></a><span id="l35.636" class="difflineplus">+    this._allMessagesLoaded = false;</span>
<a href="#l35.637"></a><span id="l35.637" class="difflineplus">+    this.messageDisplay.onCreatedView();</span>
<a href="#l35.638"></a><span id="l35.638" class="difflineplus">+    this._notifyWhenActive(this._activeCreatedView);</span>
<a href="#l35.639"></a><span id="l35.639" class="difflineplus">+  },</span>
<a href="#l35.640"></a><span id="l35.640" class="difflineplus">+  _activeCreatedView: function() {</span>
<a href="#l35.641"></a><span id="l35.641" class="difflineplus">+    gDBView = this.view.dbView;</span>
<a href="#l35.642"></a><span id="l35.642" class="difflineplus">+</span>
<a href="#l35.643"></a><span id="l35.643" class="difflineplus">+    // A change in view may result in changes to sorts, the view menu, etc.</span>
<a href="#l35.644"></a><span id="l35.644" class="difflineplus">+    // Do this before we 'reroot' the dbview.</span>
<a href="#l35.645"></a><span id="l35.645" class="difflineplus">+    this._updateThreadDisplay();</span>
<a href="#l35.646"></a><span id="l35.646" class="difflineplus">+</span>
<a href="#l35.647"></a><span id="l35.647" class="difflineplus">+    // this creates a new selection object for the view.</span>
<a href="#l35.648"></a><span id="l35.648" class="difflineplus">+    if (this.treeBox)</span>
<a href="#l35.649"></a><span id="l35.649" class="difflineplus">+      this.treeBox.view = this.view.dbView;</span>
<a href="#l35.650"></a><span id="l35.650" class="difflineplus">+</span>
<a href="#l35.651"></a><span id="l35.651" class="difflineplus">+    let ObserverService =</span>
<a href="#l35.652"></a><span id="l35.652" class="difflineplus">+      Components.classes[&quot;@mozilla.org/observer-service;1&quot;]</span>
<a href="#l35.653"></a><span id="l35.653" class="difflineplus">+                .getService(Components.interfaces.nsIObserverService);</span>
<a href="#l35.654"></a><span id="l35.654" class="difflineplus">+    // The data payload used to be viewType + &quot;:&quot; + viewFlags.  We no longer</span>
<a href="#l35.655"></a><span id="l35.655" class="difflineplus">+    //  do this because we already have the implied contract that gDBView is</span>
<a href="#l35.656"></a><span id="l35.656" class="difflineplus">+    //  valid at the time we generate the notification.  In such a case, you</span>
<a href="#l35.657"></a><span id="l35.657" class="difflineplus">+    //  can easily get that information from the gDBView.  (The documentation</span>
<a href="#l35.658"></a><span id="l35.658" class="difflineplus">+    //  on creating a custom column assumes gDBView.)</span>
<a href="#l35.659"></a><span id="l35.659" class="difflineplus">+    ObserverService.notifyObservers(this.displayedFolder,</span>
<a href="#l35.660"></a><span id="l35.660" class="difflineplus">+                                    &quot;MsgCreateDBView&quot;, &quot;&quot;);</span>
<a href="#l35.661"></a><span id="l35.661" class="difflineplus">+  },</span>
<a href="#l35.662"></a><span id="l35.662" class="difflineplus">+</span>
<a href="#l35.663"></a><span id="l35.663" class="difflineplus">+  /**</span>
<a href="#l35.664"></a><span id="l35.664" class="difflineplus">+   * If our view is being destroyed and it is coming back, we want to save the</span>
<a href="#l35.665"></a><span id="l35.665" class="difflineplus">+   *  current selection so we can restore it when the view comes back.</span>
<a href="#l35.666"></a><span id="l35.666" class="difflineplus">+   */</span>
<a href="#l35.667"></a><span id="l35.667" class="difflineplus">+  onDestroyingView: function FolderDisplayWidget_onDestroyingView(</span>
<a href="#l35.668"></a><span id="l35.668" class="difflineplus">+      aFolderIsComingBack) {</span>
<a href="#l35.669"></a><span id="l35.669" class="difflineplus">+    // try and persist the selection's content if we can</span>
<a href="#l35.670"></a><span id="l35.670" class="difflineplus">+    if (this._active) {</span>
<a href="#l35.671"></a><span id="l35.671" class="difflineplus">+      if (aFolderIsComingBack)</span>
<a href="#l35.672"></a><span id="l35.672" class="difflineplus">+        this._saveSelection();</span>
<a href="#l35.673"></a><span id="l35.673" class="difflineplus">+      else</span>
<a href="#l35.674"></a><span id="l35.674" class="difflineplus">+        this._clearSavedSelection();</span>
<a href="#l35.675"></a><span id="l35.675" class="difflineplus">+      gDBView = null;</span>
<a href="#l35.676"></a><span id="l35.676" class="difflineplus">+    }</span>
<a href="#l35.677"></a><span id="l35.677" class="difflineplus">+</span>
<a href="#l35.678"></a><span id="l35.678" class="difflineplus">+    // if we have no view, no messages could be loaded.</span>
<a href="#l35.679"></a><span id="l35.679" class="difflineplus">+    this._allMessagesLoaded = false;</span>
<a href="#l35.680"></a><span id="l35.680" class="difflineplus">+</span>
<a href="#l35.681"></a><span id="l35.681" class="difflineplus">+    // but the actual tree view selection (based on view indicies) is a goner no</span>
<a href="#l35.682"></a><span id="l35.682" class="difflineplus">+    //  matter what, make everyone forget.</span>
<a href="#l35.683"></a><span id="l35.683" class="difflineplus">+    this.view.dbView.selection = null;</span>
<a href="#l35.684"></a><span id="l35.684" class="difflineplus">+    this._savedFirstVisibleRow = null;</span>
<a href="#l35.685"></a><span id="l35.685" class="difflineplus">+    this._nextViewIndexAfterDelete = null;</span>
<a href="#l35.686"></a><span id="l35.686" class="difflineplus">+    // although the move may still be active, its relation to the view is moot.</span>
<a href="#l35.687"></a><span id="l35.687" class="difflineplus">+    this._massMoveActive = false;</span>
<a href="#l35.688"></a><span id="l35.688" class="difflineplus">+</span>
<a href="#l35.689"></a><span id="l35.689" class="difflineplus">+    // Anything pending needs to get cleared out; the new view and its related</span>
<a href="#l35.690"></a><span id="l35.690" class="difflineplus">+    //  events will re-schedule anything required or simply run it when it</span>
<a href="#l35.691"></a><span id="l35.691" class="difflineplus">+    //  has its initial call to makeActive compelled.</span>
<a href="#l35.692"></a><span id="l35.692" class="difflineplus">+    this._notificationsPendingActivation = [];</span>
<a href="#l35.693"></a><span id="l35.693" class="difflineplus">+</span>
<a href="#l35.694"></a><span id="l35.694" class="difflineplus">+    // and the message display needs to forget</span>
<a href="#l35.695"></a><span id="l35.695" class="difflineplus">+    this.messageDisplay.onDestroyingView(aFolderIsComingBack);</span>
<a href="#l35.696"></a><span id="l35.696" class="difflineplus">+  },</span>
<a href="#l35.697"></a><span id="l35.697" class="difflineplus">+  /**</span>
<a href="#l35.698"></a><span id="l35.698" class="difflineplus">+   * We are entering the folder for display, set the header cache size.</span>
<a href="#l35.699"></a><span id="l35.699" class="difflineplus">+   */</span>
<a href="#l35.700"></a><span id="l35.700" class="difflineplus">+  onDisplayingFolder: function FolderDisplayWidget_onDisplayingFolder() {</span>
<a href="#l35.701"></a><span id="l35.701" class="difflineplus">+    let msgDatabase = this.view.displayedFolder.msgDatabase;</span>
<a href="#l35.702"></a><span id="l35.702" class="difflineplus">+    if (msgDatabase) {</span>
<a href="#l35.703"></a><span id="l35.703" class="difflineplus">+      msgDatabase.resetHdrCacheSize(this.PERF_HEADER_CACHE_SIZE);</span>
<a href="#l35.704"></a><span id="l35.704" class="difflineplus">+    }</span>
<a href="#l35.705"></a><span id="l35.705" class="difflineplus">+</span>
<a href="#l35.706"></a><span id="l35.706" class="difflineplus">+    // the quick-search gets nuked when we show a new folder</span>
<a href="#l35.707"></a><span id="l35.707" class="difflineplus">+    ClearQSIfNecessary();</span>
<a href="#l35.708"></a><span id="l35.708" class="difflineplus">+    // update the quick-search relative to whether it's incoming/outgoing</span>
<a href="#l35.709"></a><span id="l35.709" class="difflineplus">+    onSearchFolderTypeChanged(this.view.isOutgoingFolder);</span>
<a href="#l35.710"></a><span id="l35.710" class="difflineplus">+</span>
<a href="#l35.711"></a><span id="l35.711" class="difflineplus">+    if (this.active)</span>
<a href="#l35.712"></a><span id="l35.712" class="difflineplus">+      this.makeActive();</span>
<a href="#l35.713"></a><span id="l35.713" class="difflineplus">+  },</span>
<a href="#l35.714"></a><span id="l35.714" class="difflineplus">+</span>
<a href="#l35.715"></a><span id="l35.715" class="difflineplus">+  /**</span>
<a href="#l35.716"></a><span id="l35.716" class="difflineplus">+   * Notification from DBViewWrapper that it is closing the folder.  This can</span>
<a href="#l35.717"></a><span id="l35.717" class="difflineplus">+   *  happen for reasons other than our own 'close' method closing the view.</span>
<a href="#l35.718"></a><span id="l35.718" class="difflineplus">+   *  For example, user deletion of the folder or underlying folder closes it.</span>
<a href="#l35.719"></a><span id="l35.719" class="difflineplus">+   */</span>
<a href="#l35.720"></a><span id="l35.720" class="difflineplus">+  onLeavingFolder: function FolderDisplayWidget_onLeavingFolder() {</span>
<a href="#l35.721"></a><span id="l35.721" class="difflineplus">+    // Keep the msgWindow's openFolder up-to-date; it powers nsMessenger's</span>
<a href="#l35.722"></a><span id="l35.722" class="difflineplus">+    //  concept of history so that it can bring you back to the actual folder</span>
<a href="#l35.723"></a><span id="l35.723" class="difflineplus">+    //  you were looking at, rather than just the underlying folder.</span>
<a href="#l35.724"></a><span id="l35.724" class="difflineplus">+    if (this._active)</span>
<a href="#l35.725"></a><span id="l35.725" class="difflineplus">+      msgWindow.openFolder = null;</span>
<a href="#l35.726"></a><span id="l35.726" class="difflineplus">+  },</span>
<a href="#l35.727"></a><span id="l35.727" class="difflineplus">+</span>
<a href="#l35.728"></a><span id="l35.728" class="difflineplus">+  /**</span>
<a href="#l35.729"></a><span id="l35.729" class="difflineplus">+   * Indictes whether we are done loading the messages that should be in this</span>
<a href="#l35.730"></a><span id="l35.730" class="difflineplus">+   *  folder.  This is being surfaced for testing purposes, but could be useful</span>
<a href="#l35.731"></a><span id="l35.731" class="difflineplus">+   *  to other code as well.  But don't poll this property; ask for an event</span>
<a href="#l35.732"></a><span id="l35.732" class="difflineplus">+   *  that you can hook.</span>
<a href="#l35.733"></a><span id="l35.733" class="difflineplus">+   */</span>
<a href="#l35.734"></a><span id="l35.734" class="difflineplus">+  get allMessagesLoaded FolderDisplayWidget_get_allMessagesLoaded() {</span>
<a href="#l35.735"></a><span id="l35.735" class="difflineplus">+    return this._allMessagesLoaded;</span>
<a href="#l35.736"></a><span id="l35.736" class="difflineplus">+  },</span>
<a href="#l35.737"></a><span id="l35.737" class="difflineplus">+</span>
<a href="#l35.738"></a><span id="l35.738" class="difflineplus">+  /**</span>
<a href="#l35.739"></a><span id="l35.739" class="difflineplus">+   * Things to do once all the messages that should show up in a folder have</span>
<a href="#l35.740"></a><span id="l35.740" class="difflineplus">+   *  shown up.  For a real folder, this happens when the folder is entered.</span>
<a href="#l35.741"></a><span id="l35.741" class="difflineplus">+   *  For a virtual folder, this happens when the search completes.</span>
<a href="#l35.742"></a><span id="l35.742" class="difflineplus">+   *</span>
<a href="#l35.743"></a><span id="l35.743" class="difflineplus">+   * What we do:</span>
<a href="#l35.744"></a><span id="l35.744" class="difflineplus">+   * - Any scrolling required!</span>
<a href="#l35.745"></a><span id="l35.745" class="difflineplus">+   */</span>
<a href="#l35.746"></a><span id="l35.746" class="difflineplus">+  onAllMessagesLoaded: function FolderDisplayWidget_onAllMessagesLoaded() {</span>
<a href="#l35.747"></a><span id="l35.747" class="difflineplus">+    this._allMessagesLoaded = true;</span>
<a href="#l35.748"></a><span id="l35.748" class="difflineplus">+    this._notifyWhenActive(this._activeAllMessagesLoaded);</span>
<a href="#l35.749"></a><span id="l35.749" class="difflineplus">+  },</span>
<a href="#l35.750"></a><span id="l35.750" class="difflineplus">+  _activeAllMessagesLoaded:</span>
<a href="#l35.751"></a><span id="l35.751" class="difflineplus">+      function FolderDisplayWidget__activeAllMessagesLoaded() {</span>
<a href="#l35.752"></a><span id="l35.752" class="difflineplus">+    // - restore selection</span>
<a href="#l35.753"></a><span id="l35.753" class="difflineplus">+    // Attempt to restore the selection (if we saved it because the view was</span>
<a href="#l35.754"></a><span id="l35.754" class="difflineplus">+    //  being destroyed or otherwise manipulated in a fashion that the normal</span>
<a href="#l35.755"></a><span id="l35.755" class="difflineplus">+    //  nsTreeSelection would be unable to handle.)</span>
<a href="#l35.756"></a><span id="l35.756" class="difflineplus">+    if (this._restoreSelection()) {</span>
<a href="#l35.757"></a><span id="l35.757" class="difflineplus">+      this.ensureRowIsVisible(this.view.dbView.viewIndexForFirstSelectedMsg);</span>
<a href="#l35.758"></a><span id="l35.758" class="difflineplus">+      return;</span>
<a href="#l35.759"></a><span id="l35.759" class="difflineplus">+    }</span>
<a href="#l35.760"></a><span id="l35.760" class="difflineplus">+</span>
<a href="#l35.761"></a><span id="l35.761" class="difflineplus">+    // - pending navigation from pushNavigation (probably spacebar triggered)</span>
<a href="#l35.762"></a><span id="l35.762" class="difflineplus">+    if (this._pendingNavigation) {</span>
<a href="#l35.763"></a><span id="l35.763" class="difflineplus">+      // Move it to a local and clear the state in case something bad happens.</span>
<a href="#l35.764"></a><span id="l35.764" class="difflineplus">+      //  (We don't want to swallow the exception.)</span>
<a href="#l35.765"></a><span id="l35.765" class="difflineplus">+      let pendingNavigation = this._pendingNavigation;</span>
<a href="#l35.766"></a><span id="l35.766" class="difflineplus">+      this._pendingNavigation = null;</span>
<a href="#l35.767"></a><span id="l35.767" class="difflineplus">+      this.navigate.apply(this, pendingNavigation);</span>
<a href="#l35.768"></a><span id="l35.768" class="difflineplus">+      return;</span>
<a href="#l35.769"></a><span id="l35.769" class="difflineplus">+    }</span>
<a href="#l35.770"></a><span id="l35.770" class="difflineplus">+</span>
<a href="#l35.771"></a><span id="l35.771" class="difflineplus">+    // - new messages</span>
<a href="#l35.772"></a><span id="l35.772" class="difflineplus">+    // if configured to scroll to new messages, try that</span>
<a href="#l35.773"></a><span id="l35.773" class="difflineplus">+    if (gPrefBranch.getBoolPref(&quot;mailnews.scroll_to_new_message&quot;) &amp;&amp;</span>
<a href="#l35.774"></a><span id="l35.774" class="difflineplus">+        this.navigate(nsMsgNavigationType.firstNew, /* select */ false))</span>
<a href="#l35.775"></a><span id="l35.775" class="difflineplus">+      return;</span>
<a href="#l35.776"></a><span id="l35.776" class="difflineplus">+</span>
<a href="#l35.777"></a><span id="l35.777" class="difflineplus">+    // - last selected message</span>
<a href="#l35.778"></a><span id="l35.778" class="difflineplus">+    // if configured to load the last selected message (this is currently more</span>
<a href="#l35.779"></a><span id="l35.779" class="difflineplus">+    //  persistent than our saveSelection/restoreSelection stuff), and the view</span>
<a href="#l35.780"></a><span id="l35.780" class="difflineplus">+    //  is backed by a single underlying folder (the only way having just a</span>
<a href="#l35.781"></a><span id="l35.781" class="difflineplus">+    //  message key works out), try that</span>
<a href="#l35.782"></a><span id="l35.782" class="difflineplus">+    if (gPrefBranch.getBoolPref(&quot;mailnews.remember_selected_message&quot;) &amp;&amp;</span>
<a href="#l35.783"></a><span id="l35.783" class="difflineplus">+        this.view.isSingleFolder) {</span>
<a href="#l35.784"></a><span id="l35.784" class="difflineplus">+      // use the displayed folder; nsMsgDBView goes to the effort to save the</span>
<a href="#l35.785"></a><span id="l35.785" class="difflineplus">+      //  state to the viewFolder, so this is the correct course of action.</span>
<a href="#l35.786"></a><span id="l35.786" class="difflineplus">+      let lastLoadedMessageKey = this.view.displayedFolder.lastMessageLoaded;</span>
<a href="#l35.787"></a><span id="l35.787" class="difflineplus">+      if (lastLoadedMessageKey != nsMsgKey_None) {</span>
<a href="#l35.788"></a><span id="l35.788" class="difflineplus">+        this.view.dbView.selectMsgByKey(lastLoadedMessageKey);</span>
<a href="#l35.789"></a><span id="l35.789" class="difflineplus">+        // The message key may not be present in the view for a variety of</span>
<a href="#l35.790"></a><span id="l35.790" class="difflineplus">+        //  reasons.  Beyond message deletion, it simply may not match the</span>
<a href="#l35.791"></a><span id="l35.791" class="difflineplus">+        //  active mail view or quick search, for example.</span>
<a href="#l35.792"></a><span id="l35.792" class="difflineplus">+        if (this.view.dbView.numSelected) {</span>
<a href="#l35.793"></a><span id="l35.793" class="difflineplus">+          this.ensureRowIsVisible(</span>
<a href="#l35.794"></a><span id="l35.794" class="difflineplus">+            this.view.dbView.viewIndexForFirstSelectedMsg);</span>
<a href="#l35.795"></a><span id="l35.795" class="difflineplus">+          return;</span>
<a href="#l35.796"></a><span id="l35.796" class="difflineplus">+        }</span>
<a href="#l35.797"></a><span id="l35.797" class="difflineplus">+      }</span>
<a href="#l35.798"></a><span id="l35.798" class="difflineplus">+    }</span>
<a href="#l35.799"></a><span id="l35.799" class="difflineplus">+</span>
<a href="#l35.800"></a><span id="l35.800" class="difflineplus">+    // - towards the newest messages, but don't select</span>
<a href="#l35.801"></a><span id="l35.801" class="difflineplus">+    if (this.view.isSortedAscending &amp;&amp; this.view.sortImpliesTemporalOrdering &amp;&amp;</span>
<a href="#l35.802"></a><span id="l35.802" class="difflineplus">+      this.navigate(nsMsgNavigationType.lastMessage, /* select */ false))</span>
<a href="#l35.803"></a><span id="l35.803" class="difflineplus">+      return;</span>
<a href="#l35.804"></a><span id="l35.804" class="difflineplus">+</span>
<a href="#l35.805"></a><span id="l35.805" class="difflineplus">+    // - to the top, the coliseum</span>
<a href="#l35.806"></a><span id="l35.806" class="difflineplus">+    this.ensureRowIsVisible(0);</span>
<a href="#l35.807"></a><span id="l35.807" class="difflineplus">+  },</span>
<a href="#l35.808"></a><span id="l35.808" class="difflineplus">+</span>
<a href="#l35.809"></a><span id="l35.809" class="difflineplus">+  /**</span>
<a href="#l35.810"></a><span id="l35.810" class="difflineplus">+   * The DBViewWrapper tells us when someone (possibly the wrapper itself)</span>
<a href="#l35.811"></a><span id="l35.811" class="difflineplus">+   *  changes the active mail view so that we can kick the UI to update.</span>
<a href="#l35.812"></a><span id="l35.812" class="difflineplus">+   */</span>
<a href="#l35.813"></a><span id="l35.813" class="difflineplus">+  onMailViewChanged: function FolderDisplayWidget_onMailViewChanged() {</span>
<a href="#l35.814"></a><span id="l35.814" class="difflineplus">+    // only do this if we're currently active.  no need to queue it because we</span>
<a href="#l35.815"></a><span id="l35.815" class="difflineplus">+    //  always update the mail view whenever we are made active.</span>
<a href="#l35.816"></a><span id="l35.816" class="difflineplus">+    if (this.active) {</span>
<a href="#l35.817"></a><span id="l35.817" class="difflineplus">+      let event = document.createEvent(&quot;datacontainerevents&quot;);</span>
<a href="#l35.818"></a><span id="l35.818" class="difflineplus">+      // you cannot cancel a view change!</span>
<a href="#l35.819"></a><span id="l35.819" class="difflineplus">+      event.initEvent(&quot;MailViewChanged&quot;, false, false);</span>
<a href="#l35.820"></a><span id="l35.820" class="difflineplus">+      //event.setData(&quot;folderDisplay&quot;, this);</span>
<a href="#l35.821"></a><span id="l35.821" class="difflineplus">+      window.dispatchEvent(event);</span>
<a href="#l35.822"></a><span id="l35.822" class="difflineplus">+    }</span>
<a href="#l35.823"></a><span id="l35.823" class="difflineplus">+  },</span>
<a href="#l35.824"></a><span id="l35.824" class="difflineplus">+</span>
<a href="#l35.825"></a><span id="l35.825" class="difflineplus">+  /**</span>
<a href="#l35.826"></a><span id="l35.826" class="difflineplus">+   * Just the sort or threading was changed, without changing other things.  We</span>
<a href="#l35.827"></a><span id="l35.827" class="difflineplus">+   *  will not get this notification if the view was re-created, for example.</span>
<a href="#l35.828"></a><span id="l35.828" class="difflineplus">+   */</span>
<a href="#l35.829"></a><span id="l35.829" class="difflineplus">+  onSortChanged: function FolderDisplayWidget_onSortChanged() {</span>
<a href="#l35.830"></a><span id="l35.830" class="difflineplus">+    if (this.active)</span>
<a href="#l35.831"></a><span id="l35.831" class="difflineplus">+      UpdateSortIndicators(this.view.primarySortType,</span>
<a href="#l35.832"></a><span id="l35.832" class="difflineplus">+                           this.view.primarySortOrder);</span>
<a href="#l35.833"></a><span id="l35.833" class="difflineplus">+  },</span>
<a href="#l35.834"></a><span id="l35.834" class="difflineplus">+</span>
<a href="#l35.835"></a><span id="l35.835" class="difflineplus">+  /**</span>
<a href="#l35.836"></a><span id="l35.836" class="difflineplus">+   * Messages (that may have been displayed) have been removed; this may impact</span>
<a href="#l35.837"></a><span id="l35.837" class="difflineplus">+   *  our message selection.  If we saw this coming, then</span>
<a href="#l35.838"></a><span id="l35.838" class="difflineplus">+   *  this._nextViewIndexAfterDelete should know what view index we should</span>
<a href="#l35.839"></a><span id="l35.839" class="difflineplus">+   *  select next.  If we didn't see this coming, the cause is likely an</span>
<a href="#l35.840"></a><span id="l35.840" class="difflineplus">+   *  explicit deletion in another tab/window.</span>
<a href="#l35.841"></a><span id="l35.841" class="difflineplus">+   * Because the nsMsgDBView is on top of things, it will already have called</span>
<a href="#l35.842"></a><span id="l35.842" class="difflineplus">+   *  summarizeSelection as a result of the changes to the message display.</span>
<a href="#l35.843"></a><span id="l35.843" class="difflineplus">+   *  So our job here is really just to try and potentially improve on the</span>
<a href="#l35.844"></a><span id="l35.844" class="difflineplus">+   *  default selection logic.</span>
<a href="#l35.845"></a><span id="l35.845" class="difflineplus">+   */</span>
<a href="#l35.846"></a><span id="l35.846" class="difflineplus">+  onMessagesRemoved: function FolderDisplayWidget_onMessagesRemoved() {</span>
<a href="#l35.847"></a><span id="l35.847" class="difflineplus">+    // - we saw this coming</span>
<a href="#l35.848"></a><span id="l35.848" class="difflineplus">+    let rowCount = this.view.dbView.rowCount;</span>
<a href="#l35.849"></a><span id="l35.849" class="difflineplus">+    if (!this._massMoveActive &amp;&amp; (this._nextViewIndexAfterDelete != null)) {</span>
<a href="#l35.850"></a><span id="l35.850" class="difflineplus">+      // adjust the index if it is after the last row...</span>
<a href="#l35.851"></a><span id="l35.851" class="difflineplus">+      // (this can happen if the &quot;mail.delete_matches_sort_order&quot; pref is not</span>
<a href="#l35.852"></a><span id="l35.852" class="difflineplus">+      //  set and the message is the last message in the view.)</span>
<a href="#l35.853"></a><span id="l35.853" class="difflineplus">+      if (this._nextViewIndexAfterDelete &gt;= rowCount)</span>
<a href="#l35.854"></a><span id="l35.854" class="difflineplus">+        this._nextViewIndexAfterDelete = rowCount - 1;</span>
<a href="#l35.855"></a><span id="l35.855" class="difflineplus">+      // just select the index and get on with our lives</span>
<a href="#l35.856"></a><span id="l35.856" class="difflineplus">+      this.selectViewIndex(this._nextViewIndexAfterDelete);</span>
<a href="#l35.857"></a><span id="l35.857" class="difflineplus">+      this._nextViewIndexAfterDelete = null;</span>
<a href="#l35.858"></a><span id="l35.858" class="difflineplus">+      return;</span>
<a href="#l35.859"></a><span id="l35.859" class="difflineplus">+    }</span>
<a href="#l35.860"></a><span id="l35.860" class="difflineplus">+</span>
<a href="#l35.861"></a><span id="l35.861" class="difflineplus">+    // - surprise!</span>
<a href="#l35.862"></a><span id="l35.862" class="difflineplus">+    // A deletion happened to our folder.</span>
<a href="#l35.863"></a><span id="l35.863" class="difflineplus">+    let treeSelection = this.treeSelection;</span>
<a href="#l35.864"></a><span id="l35.864" class="difflineplus">+    // we can't fix the selection if we have no selection</span>
<a href="#l35.865"></a><span id="l35.865" class="difflineplus">+    if (!treeSelection)</span>
<a href="#l35.866"></a><span id="l35.866" class="difflineplus">+      return;</span>
<a href="#l35.867"></a><span id="l35.867" class="difflineplus">+</span>
<a href="#l35.868"></a><span id="l35.868" class="difflineplus">+    // For reasons unknown (but theoretically knowable), sometimes the selection</span>
<a href="#l35.869"></a><span id="l35.869" class="difflineplus">+    //  object will be invalid.  At least, I've reliably seen a selection of</span>
<a href="#l35.870"></a><span id="l35.870" class="difflineplus">+    //  [0, 0] with 0 rows.  If that happens, we need to fix up the selection</span>
<a href="#l35.871"></a><span id="l35.871" class="difflineplus">+    //  here.</span>
<a href="#l35.872"></a><span id="l35.872" class="difflineplus">+    if (rowCount == 0 &amp;&amp; treeSelection.count)</span>
<a href="#l35.873"></a><span id="l35.873" class="difflineplus">+      // nsTreeSelection does't generate an event if we use clearRange, so use</span>
<a href="#l35.874"></a><span id="l35.874" class="difflineplus">+      //  that to avoid spurious events, given that we are going to definitely</span>
<a href="#l35.875"></a><span id="l35.875" class="difflineplus">+      //  trigger a change notification below.</span>
<a href="#l35.876"></a><span id="l35.876" class="difflineplus">+      treeSelection.clearRange(0, 0);</span>
<a href="#l35.877"></a><span id="l35.877" class="difflineplus">+</span>
<a href="#l35.878"></a><span id="l35.878" class="difflineplus">+    // Check if we now no longer have a selection, but we had exactly one</span>
<a href="#l35.879"></a><span id="l35.879" class="difflineplus">+    //  message selected previously.  If we did, then try and do some</span>
<a href="#l35.880"></a><span id="l35.880" class="difflineplus">+    //  'persistence of having a thing selected'.</span>
<a href="#l35.881"></a><span id="l35.881" class="difflineplus">+    if (treeSelection.count == 0 &amp;&amp;</span>
<a href="#l35.882"></a><span id="l35.882" class="difflineplus">+        this._mostRecentSelectionCounts.length &gt; 1 &amp;&amp;</span>
<a href="#l35.883"></a><span id="l35.883" class="difflineplus">+        this._mostRecentSelectionCounts[1] == 1 &amp;&amp;</span>
<a href="#l35.884"></a><span id="l35.884" class="difflineplus">+        this._mostRecentCurrentIndices[1] != -1) {</span>
<a href="#l35.885"></a><span id="l35.885" class="difflineplus">+      let targetIndex = this._mostRecentCurrentIndices[1];</span>
<a href="#l35.886"></a><span id="l35.886" class="difflineplus">+      if (targetIndex &gt;= rowCount)</span>
<a href="#l35.887"></a><span id="l35.887" class="difflineplus">+        targetIndex = rowCount - 1;</span>
<a href="#l35.888"></a><span id="l35.888" class="difflineplus">+      this.selectViewIndex(targetIndex);</span>
<a href="#l35.889"></a><span id="l35.889" class="difflineplus">+      return;</span>
<a href="#l35.890"></a><span id="l35.890" class="difflineplus">+    }</span>
<a href="#l35.891"></a><span id="l35.891" class="difflineplus">+</span>
<a href="#l35.892"></a><span id="l35.892" class="difflineplus">+    // Otherwise, just tell the view that things have changed so it can update</span>
<a href="#l35.893"></a><span id="l35.893" class="difflineplus">+    //  itself to the new state of things.</span>
<a href="#l35.894"></a><span id="l35.894" class="difflineplus">+    // tell the view that things have changed so it can update itself suitably.</span>
<a href="#l35.895"></a><span id="l35.895" class="difflineplus">+    if (this.view.dbView)</span>
<a href="#l35.896"></a><span id="l35.896" class="difflineplus">+      this.view.dbView.selectionChanged();</span>
<a href="#l35.897"></a><span id="l35.897" class="difflineplus">+  },</span>
<a href="#l35.898"></a><span id="l35.898" class="difflineplus">+</span>
<a href="#l35.899"></a><span id="l35.899" class="difflineplus">+  /**</span>
<a href="#l35.900"></a><span id="l35.900" class="difflineplus">+   * Messages were not actually removed, but we were expecting that they would</span>
<a href="#l35.901"></a><span id="l35.901" class="difflineplus">+   *  be.  Clean-up what onMessagesRemoved would have cleaned up, namely the</span>
<a href="#l35.902"></a><span id="l35.902" class="difflineplus">+   *  next view index to select.</span>
<a href="#l35.903"></a><span id="l35.903" class="difflineplus">+   */</span>
<a href="#l35.904"></a><span id="l35.904" class="difflineplus">+  onMessageRemovalFailed:</span>
<a href="#l35.905"></a><span id="l35.905" class="difflineplus">+      function FolderDisplayWidget_onMessageRemovalFailed() {</span>
<a href="#l35.906"></a><span id="l35.906" class="difflineplus">+    this._nextViewIndexAfterDelete = null;</span>
<a href="#l35.907"></a><span id="l35.907" class="difflineplus">+  },</span>
<a href="#l35.908"></a><span id="l35.908" class="difflineplus">+</span>
<a href="#l35.909"></a><span id="l35.909" class="difflineplus">+  /**</span>
<a href="#l35.910"></a><span id="l35.910" class="difflineplus">+   * Update the status bar to reflect our exciting message counts.</span>
<a href="#l35.911"></a><span id="l35.911" class="difflineplus">+   */</span>
<a href="#l35.912"></a><span id="l35.912" class="difflineplus">+  onMessageCountsChanged: function FolderDisplayWidget_onMessageCountsChaned() {</span>
<a href="#l35.913"></a><span id="l35.913" class="difflineplus">+    if (this.active)</span>
<a href="#l35.914"></a><span id="l35.914" class="difflineplus">+      UpdateStatusMessageCounts(this.displayedFolder);</span>
<a href="#l35.915"></a><span id="l35.915" class="difflineplus">+  },</span>
<a href="#l35.916"></a><span id="l35.916" class="difflineplus">+</span>
<a href="#l35.917"></a><span id="l35.917" class="difflineplus">+  /* ===== End IDBViewWrapperListener ===== */</span>
<a href="#l35.918"></a><span id="l35.918" class="difflineplus">+</span>
<a href="#l35.919"></a><span id="l35.919" class="difflineplus">+  /*   ==================================   */</span>
<a href="#l35.920"></a><span id="l35.920" class="difflineplus">+  /* ===== nsIMsgDBViewCommandUpdater ===== */</span>
<a href="#l35.921"></a><span id="l35.921" class="difflineplus">+  /*   ==================================   */</span>
<a href="#l35.922"></a><span id="l35.922" class="difflineplus">+</span>
<a href="#l35.923"></a><span id="l35.923" class="difflineplus">+  /**</span>
<a href="#l35.924"></a><span id="l35.924" class="difflineplus">+   * This gets called when the selection changes AND !suppressCommandUpdating</span>
<a href="#l35.925"></a><span id="l35.925" class="difflineplus">+   *  AND (we're not removing a row OR we are now out of rows).</span>
<a href="#l35.926"></a><span id="l35.926" class="difflineplus">+   * In response, we update the toolbar.</span>
<a href="#l35.927"></a><span id="l35.927" class="difflineplus">+   */</span>
<a href="#l35.928"></a><span id="l35.928" class="difflineplus">+  updateCommandStatus: function FolderDisplayWidget_updateCommandStatus() {</span>
<a href="#l35.929"></a><span id="l35.929" class="difflineplus">+    UpdateMailToolbar(&quot;FolderDisplayWidget command updater notification&quot;);</span>
<a href="#l35.930"></a><span id="l35.930" class="difflineplus">+  },</span>
<a href="#l35.931"></a><span id="l35.931" class="difflineplus">+</span>
<a href="#l35.932"></a><span id="l35.932" class="difflineplus">+  /**</span>
<a href="#l35.933"></a><span id="l35.933" class="difflineplus">+   * This gets called by nsMsgDBView::UpdateDisplayMessage following a call</span>
<a href="#l35.934"></a><span id="l35.934" class="difflineplus">+   *  to nsIMessenger.OpenURL to kick off message display OR (UDM gets called)</span>
<a href="#l35.935"></a><span id="l35.935" class="difflineplus">+   *  by nsMsgDBView::SelectionChanged in lieu of loading the message because</span>
<a href="#l35.936"></a><span id="l35.936" class="difflineplus">+   *  mSupressMsgDisplay.</span>
<a href="#l35.937"></a><span id="l35.937" class="difflineplus">+   * In other words, we get notified immediately after the process of displaying</span>
<a href="#l35.938"></a><span id="l35.938" class="difflineplus">+   *  a message triggered by the nsMsgDBView happens.  We get some arguments</span>
<a href="#l35.939"></a><span id="l35.939" class="difflineplus">+   *  that are display optimizations for historical reasons (as usual).</span>
<a href="#l35.940"></a><span id="l35.940" class="difflineplus">+   *</span>
<a href="#l35.941"></a><span id="l35.941" class="difflineplus">+   * Things this makes us want to do:</span>
<a href="#l35.942"></a><span id="l35.942" class="difflineplus">+   * - Set the tab title, perhaps.  (If we are a message display.)</span>
<a href="#l35.943"></a><span id="l35.943" class="difflineplus">+   * - Update message counts, because things might have changed, why not.</span>
<a href="#l35.944"></a><span id="l35.944" class="difflineplus">+   * - Update some toolbar buttons, why not.</span>
<a href="#l35.945"></a><span id="l35.945" class="difflineplus">+   *</span>
<a href="#l35.946"></a><span id="l35.946" class="difflineplus">+   * @param aFolder The display/view folder, as opposed to the backing folder.</span>
<a href="#l35.947"></a><span id="l35.947" class="difflineplus">+   * @param aSubject The subject with &quot;Re: &quot; if it's got one, which makes it</span>
<a href="#l35.948"></a><span id="l35.948" class="difflineplus">+   *     notably different from just directly accessing the message header's</span>
<a href="#l35.949"></a><span id="l35.949" class="difflineplus">+   *     subject.</span>
<a href="#l35.950"></a><span id="l35.950" class="difflineplus">+   * @param aKeywords The keywords, which roughly translates to message tags.</span>
<a href="#l35.951"></a><span id="l35.951" class="difflineplus">+   */</span>
<a href="#l35.952"></a><span id="l35.952" class="difflineplus">+  displayMessageChanged: function FolderDisplayWidget_displayMessageChanged(</span>
<a href="#l35.953"></a><span id="l35.953" class="difflineplus">+      aFolder, aSubject, aKeywords) {</span>
<a href="#l35.954"></a><span id="l35.954" class="difflineplus">+    UpdateMailToolbar(&quot;FolderDisplayWidget displayed message changed&quot;);</span>
<a href="#l35.955"></a><span id="l35.955" class="difflineplus">+    let viewIndex = this.view.dbView.currentlyDisplayedMessage;</span>
<a href="#l35.956"></a><span id="l35.956" class="difflineplus">+    let msgHdr = (viewIndex != nsMsgViewIndex_None) ?</span>
<a href="#l35.957"></a><span id="l35.957" class="difflineplus">+                   this.view.dbView.getMsgHdrAt(viewIndex) : null;</span>
<a href="#l35.958"></a><span id="l35.958" class="difflineplus">+    this.messageDisplay.onDisplayingMessage(msgHdr);</span>
<a href="#l35.959"></a><span id="l35.959" class="difflineplus">+</span>
<a href="#l35.960"></a><span id="l35.960" class="difflineplus">+    // Although deletes should now be so fast that the user has no time to do</span>
<a href="#l35.961"></a><span id="l35.961" class="difflineplus">+    //  anything, treat the user explicitly choosing to display a different</span>
<a href="#l35.962"></a><span id="l35.962" class="difflineplus">+    //  message as invalidating the choice we automatically made for them when</span>
<a href="#l35.963"></a><span id="l35.963" class="difflineplus">+    //  they initiated the message delete / move. (bug 243532)</span>
<a href="#l35.964"></a><span id="l35.964" class="difflineplus">+    // Note: legacy code used to check whether the message being displayed was</span>
<a href="#l35.965"></a><span id="l35.965" class="difflineplus">+    //  the one being deleted, so it didn't erroneously clear the next message</span>
<a href="#l35.966"></a><span id="l35.966" class="difflineplus">+    //  to display (bug 183394).  This is not a problem for us because we hook</span>
<a href="#l35.967"></a><span id="l35.967" class="difflineplus">+    //  our notification when the message load is initiated, rather than when</span>
<a href="#l35.968"></a><span id="l35.968" class="difflineplus">+    //  the message completes loading.</span>
<a href="#l35.969"></a><span id="l35.969" class="difflineplus">+    this._nextViewIndexAfterDelete = null;</span>
<a href="#l35.970"></a><span id="l35.970" class="difflineplus">+  },</span>
<a href="#l35.971"></a><span id="l35.971" class="difflineplus">+</span>
<a href="#l35.972"></a><span id="l35.972" class="difflineplus">+  /**</span>
<a href="#l35.973"></a><span id="l35.973" class="difflineplus">+   * This gets called as a hint that the currently selected message is junk and</span>
<a href="#l35.974"></a><span id="l35.974" class="difflineplus">+   *  said junked message is going to be moved out of the current folder.  The</span>
<a href="#l35.975"></a><span id="l35.975" class="difflineplus">+   *  legacy behaviour is to retrieve the msgToSelectAfterDelete attribute off</span>
<a href="#l35.976"></a><span id="l35.976" class="difflineplus">+   *  the db view, stashing it for benefit of the code that gets called when a</span>
<a href="#l35.977"></a><span id="l35.977" class="difflineplus">+   *  message move/deletion is completed so that we can trigger its display.</span>
<a href="#l35.978"></a><span id="l35.978" class="difflineplus">+   */</span>
<a href="#l35.979"></a><span id="l35.979" class="difflineplus">+  updateNextMessageAfterDelete:</span>
<a href="#l35.980"></a><span id="l35.980" class="difflineplus">+      function FolderDisplayWidget_updateNextMessageAfterDelete() {</span>
<a href="#l35.981"></a><span id="l35.981" class="difflineplus">+    this.hintAboutToDeleteMessages();</span>
<a href="#l35.982"></a><span id="l35.982" class="difflineplus">+  },</span>
<a href="#l35.983"></a><span id="l35.983" class="difflineplus">+</span>
<a href="#l35.984"></a><span id="l35.984" class="difflineplus">+  /**</span>
<a href="#l35.985"></a><span id="l35.985" class="difflineplus">+   * The most recent currentIndexes on the selection (from the last time</span>
<a href="#l35.986"></a><span id="l35.986" class="difflineplus">+   *  summarizeSelection got called).  We use this in onMessagesRemoved if</span>
<a href="#l35.987"></a><span id="l35.987" class="difflineplus">+   *  we get an unexpected notification.</span>
<a href="#l35.988"></a><span id="l35.988" class="difflineplus">+   * We keep a maximum of 2 entries in this list.</span>
<a href="#l35.989"></a><span id="l35.989" class="difflineplus">+   */</span>
<a href="#l35.990"></a><span id="l35.990" class="difflineplus">+  _mostRecentCurrentIndices: undefined, // initialized in constructor</span>
<a href="#l35.991"></a><span id="l35.991" class="difflineplus">+  /**</span>
<a href="#l35.992"></a><span id="l35.992" class="difflineplus">+   * The most recent counts on the selection (from the last time</span>
<a href="#l35.993"></a><span id="l35.993" class="difflineplus">+   *  summarizeSelection got called).  We use this in onMessagesRemoved if</span>
<a href="#l35.994"></a><span id="l35.994" class="difflineplus">+   *  we get an unexpected notification.</span>
<a href="#l35.995"></a><span id="l35.995" class="difflineplus">+   * We keep a maximum of 2 entries in this list.</span>
<a href="#l35.996"></a><span id="l35.996" class="difflineplus">+   */</span>
<a href="#l35.997"></a><span id="l35.997" class="difflineplus">+  _mostRecentSelectionCounts: undefined, // initialized in constructor</span>
<a href="#l35.998"></a><span id="l35.998" class="difflineplus">+</span>
<a href="#l35.999"></a><span id="l35.999" class="difflineplus">+  /**</span>
<a href="#l35.1000"></a><span id="l35.1000" class="difflineplus">+   * Always called by the db view when the selection changes in</span>
<a href="#l35.1001"></a><span id="l35.1001" class="difflineplus">+   *  SelectionChanged.  This event will come after the notification to</span>
<a href="#l35.1002"></a><span id="l35.1002" class="difflineplus">+   *  displayMessageChanged (if one happens), and before the notification to</span>
<a href="#l35.1003"></a><span id="l35.1003" class="difflineplus">+   *  updateCommandStatus (if one happens).</span>
<a href="#l35.1004"></a><span id="l35.1004" class="difflineplus">+   */</span>
<a href="#l35.1005"></a><span id="l35.1005" class="difflineplus">+  summarizeSelection: function FolderDisplayWidget_summarizeSelection() {</span>
<a href="#l35.1006"></a><span id="l35.1006" class="difflineplus">+    // save the current index off in case the selection gets deleted out from</span>
<a href="#l35.1007"></a><span id="l35.1007" class="difflineplus">+    //  under us and we want to have persistence of actually-having-something</span>
<a href="#l35.1008"></a><span id="l35.1008" class="difflineplus">+    //  selected.</span>
<a href="#l35.1009"></a><span id="l35.1009" class="difflineplus">+    let treeSelection = this.treeSelection;</span>
<a href="#l35.1010"></a><span id="l35.1010" class="difflineplus">+    if (treeSelection) {</span>
<a href="#l35.1011"></a><span id="l35.1011" class="difflineplus">+      this._mostRecentCurrentIndices.unshift(treeSelection.currentIndex);</span>
<a href="#l35.1012"></a><span id="l35.1012" class="difflineplus">+      this._mostRecentCurrentIndices.splice(2);</span>
<a href="#l35.1013"></a><span id="l35.1013" class="difflineplus">+      this._mostRecentSelectionCounts.unshift(treeSelection.count);</span>
<a href="#l35.1014"></a><span id="l35.1014" class="difflineplus">+      this._mostRecentSelectionCounts.splice(2);</span>
<a href="#l35.1015"></a><span id="l35.1015" class="difflineplus">+    }</span>
<a href="#l35.1016"></a><span id="l35.1016" class="difflineplus">+    return this.messageDisplay.onSelectedMessagesChanged();</span>
<a href="#l35.1017"></a><span id="l35.1017" class="difflineplus">+  },</span>
<a href="#l35.1018"></a><span id="l35.1018" class="difflineplus">+</span>
<a href="#l35.1019"></a><span id="l35.1019" class="difflineplus">+  /* ===== End nsIMsgDBViewCommandUpdater ===== */</span>
<a href="#l35.1020"></a><span id="l35.1020" class="difflineplus">+</span>
<a href="#l35.1021"></a><span id="l35.1021" class="difflineplus">+  /* ===== Hints from the command infrastructure ===== */</span>
<a href="#l35.1022"></a><span id="l35.1022" class="difflineplus">+</span>
<a href="#l35.1023"></a><span id="l35.1023" class="difflineplus">+  /**</span>
<a href="#l35.1024"></a><span id="l35.1024" class="difflineplus">+   * doCommand helps us out by telling us when it is telling the view to delete</span>
<a href="#l35.1025"></a><span id="l35.1025" class="difflineplus">+   *  some messages.  Ideally it should go through us / the DB View Wrapper to</span>
<a href="#l35.1026"></a><span id="l35.1026" class="difflineplus">+   *  kick off the delete in the first place, but that's a thread I don't want</span>
<a href="#l35.1027"></a><span id="l35.1027" class="difflineplus">+   *  to pull on right now.</span>
<a href="#l35.1028"></a><span id="l35.1028" class="difflineplus">+   * We use this hint to figure out the next message to display once the</span>
<a href="#l35.1029"></a><span id="l35.1029" class="difflineplus">+   *  deletion completes.  We do this before the deletion happens because the</span>
<a href="#l35.1030"></a><span id="l35.1030" class="difflineplus">+   *  selection is probably going away (except in the IMAP delete model), and it</span>
<a href="#l35.1031"></a><span id="l35.1031" class="difflineplus">+   *  might be too late to figure this out after the deletion happens.</span>
<a href="#l35.1032"></a><span id="l35.1032" class="difflineplus">+   * Our automated complement (that calls us) is updateNextMessageAfterDelete.</span>
<a href="#l35.1033"></a><span id="l35.1033" class="difflineplus">+   */</span>
<a href="#l35.1034"></a><span id="l35.1034" class="difflineplus">+  hintAboutToDeleteMessages:</span>
<a href="#l35.1035"></a><span id="l35.1035" class="difflineplus">+      function FolderDisplayWidget_hintAboutToDeleteMessages() {</span>
<a href="#l35.1036"></a><span id="l35.1036" class="difflineplus">+    // If there is a right click going on, then the possibilities are:</span>
<a href="#l35.1037"></a><span id="l35.1037" class="difflineplus">+    // 1) The user right-clicked in the selection.  In this case, the selection</span>
<a href="#l35.1038"></a><span id="l35.1038" class="difflineplus">+    //    is maintained.  This holds true for one or multiple messages.</span>
<a href="#l35.1039"></a><span id="l35.1039" class="difflineplus">+    // 2) The user right-clicked outside the selection.  In this case, the</span>
<a href="#l35.1040"></a><span id="l35.1040" class="difflineplus">+    //    selection, but not the current index, reflects the single message</span>
<a href="#l35.1041"></a><span id="l35.1041" class="difflineplus">+    //    the user right-clicked on.</span>
<a href="#l35.1042"></a><span id="l35.1042" class="difflineplus">+    // We want to treat case #1 as if a right-click was not involved and we</span>
<a href="#l35.1043"></a><span id="l35.1043" class="difflineplus">+    //  want to ignore case #2 by bailing because our existing selection (or</span>
<a href="#l35.1044"></a><span id="l35.1044" class="difflineplus">+    //  lack thereof) we want maintained.</span>
<a href="#l35.1045"></a><span id="l35.1045" class="difflineplus">+//    if (gRightMouseButtonDown &amp;&amp; gRightMouseButtonChangedSelection)</span>
<a href="#l35.1046"></a><span id="l35.1046" class="difflineplus">+//      return;</span>
<a href="#l35.1047"></a><span id="l35.1047" class="difflineplus">+</span>
<a href="#l35.1048"></a><span id="l35.1048" class="difflineplus">+    // save the value, even if it is nsMsgViewIndex_None.</span>
<a href="#l35.1049"></a><span id="l35.1049" class="difflineplus">+    this._nextViewIndexAfterDelete = this.view.dbView.msgToSelectAfterDelete;</span>
<a href="#l35.1050"></a><span id="l35.1050" class="difflineplus">+  },</span>
<a href="#l35.1051"></a><span id="l35.1051" class="difflineplus">+</span>
<a href="#l35.1052"></a><span id="l35.1052" class="difflineplus">+  /**</span>
<a href="#l35.1053"></a><span id="l35.1053" class="difflineplus">+   * The archive code tells us when it is starting to archive messages.  This</span>
<a href="#l35.1054"></a><span id="l35.1054" class="difflineplus">+   *  is different from hinting about deletion because it will also tell us</span>
<a href="#l35.1055"></a><span id="l35.1055" class="difflineplus">+   *  when it has completed its mass move.</span>
<a href="#l35.1056"></a><span id="l35.1056" class="difflineplus">+   * The UI goal is that we do not immediately jump beyond the selected messages</span>
<a href="#l35.1057"></a><span id="l35.1057" class="difflineplus">+   *  to the next message until all of the selected messages have been</span>
<a href="#l35.1058"></a><span id="l35.1058" class="difflineplus">+   *  processed (moved).  Ideally we would also do this when deleting messages</span>
<a href="#l35.1059"></a><span id="l35.1059" class="difflineplus">+   *  from a multiple-folder backed message view, but we don't know when the</span>
<a href="#l35.1060"></a><span id="l35.1060" class="difflineplus">+   *  last job completes in that case (whereas in this case we do because of the</span>
<a href="#l35.1061"></a><span id="l35.1061" class="difflineplus">+   *  call to hintMassMoveCompleted.)</span>
<a href="#l35.1062"></a><span id="l35.1062" class="difflineplus">+   */</span>
<a href="#l35.1063"></a><span id="l35.1063" class="difflineplus">+  hintMassMoveStarting:</span>
<a href="#l35.1064"></a><span id="l35.1064" class="difflineplus">+      function FolderDisplayWidget_hintMassMoveStarting() {</span>
<a href="#l35.1065"></a><span id="l35.1065" class="difflineplus">+    this.hintAboutToDeleteMessages();</span>
<a href="#l35.1066"></a><span id="l35.1066" class="difflineplus">+    this._massMoveActive = true;</span>
<a href="#l35.1067"></a><span id="l35.1067" class="difflineplus">+  },</span>
<a href="#l35.1068"></a><span id="l35.1068" class="difflineplus">+</span>
<a href="#l35.1069"></a><span id="l35.1069" class="difflineplus">+  /**</span>
<a href="#l35.1070"></a><span id="l35.1070" class="difflineplus">+   * The archival has completed, we can finally let onMessagseRemoved run to</span>
<a href="#l35.1071"></a><span id="l35.1071" class="difflineplus">+   *  completion.</span>
<a href="#l35.1072"></a><span id="l35.1072" class="difflineplus">+   */</span>
<a href="#l35.1073"></a><span id="l35.1073" class="difflineplus">+  hintMassMoveCompleted:</span>
<a href="#l35.1074"></a><span id="l35.1074" class="difflineplus">+      function FolderDisplayWidget_hintMassMoveCompleted() {</span>
<a href="#l35.1075"></a><span id="l35.1075" class="difflineplus">+    this._massMoveActive = false;</span>
<a href="#l35.1076"></a><span id="l35.1076" class="difflineplus">+    this.onMessagesRemoved();</span>
<a href="#l35.1077"></a><span id="l35.1077" class="difflineplus">+  },</span>
<a href="#l35.1078"></a><span id="l35.1078" class="difflineplus">+</span>
<a href="#l35.1079"></a><span id="l35.1079" class="difflineplus">+  /**</span>
<a href="#l35.1080"></a><span id="l35.1080" class="difflineplus">+   * When a right-click on the thread pane is going to alter our selection, we</span>
<a href="#l35.1081"></a><span id="l35.1081" class="difflineplus">+   *  get this notification (currently from |ChangeSelectionWithoutContentLoad|</span>
<a href="#l35.1082"></a><span id="l35.1082" class="difflineplus">+   *  in msgMail3PaneWindow.js), which lets us save our state.</span>
<a href="#l35.1083"></a><span id="l35.1083" class="difflineplus">+   * This ends one of two ways: we get made inactive because a new tab popped up</span>
<a href="#l35.1084"></a><span id="l35.1084" class="difflineplus">+   *  or we get a call to |hintRightClickSelectionPerturbationDone|.</span>
<a href="#l35.1085"></a><span id="l35.1085" class="difflineplus">+   *</span>
<a href="#l35.1086"></a><span id="l35.1086" class="difflineplus">+   * Ideally, we could just save off our current nsITreeSelection and restore it</span>
<a href="#l35.1087"></a><span id="l35.1087" class="difflineplus">+   *  when this is all over.  This assumption would rely on the underlying view</span>
<a href="#l35.1088"></a><span id="l35.1088" class="difflineplus">+   *  not having any changes to its rows before we restore the selection.  I am</span>
<a href="#l35.1089"></a><span id="l35.1089" class="difflineplus">+   *  not confident we can rule out background processes making changes, plus</span>
<a href="#l35.1090"></a><span id="l35.1090" class="difflineplus">+   *  the right-click itself may mutate the view (although we could try and get</span>
<a href="#l35.1091"></a><span id="l35.1091" class="difflineplus">+   *  it to restore the selection before it gets to the mutation part).  Our</span>
<a href="#l35.1092"></a><span id="l35.1092" class="difflineplus">+   *  only way to resolve this would be to create a 'tee' like fake selection</span>
<a href="#l35.1093"></a><span id="l35.1093" class="difflineplus">+   *  that would proxy view change notifications to both sets of selections.</span>
<a href="#l35.1094"></a><span id="l35.1094" class="difflineplus">+   *  That is hard.</span>
<a href="#l35.1095"></a><span id="l35.1095" class="difflineplus">+   * So we just use the existing _saveSelection/_restoreSelection mechanism</span>
<a href="#l35.1096"></a><span id="l35.1096" class="difflineplus">+   *  which is potentially very costly.</span>
<a href="#l35.1097"></a><span id="l35.1097" class="difflineplus">+   */</span>
<a href="#l35.1098"></a><span id="l35.1098" class="difflineplus">+  hintRightClickPerturbingSelection:</span>
<a href="#l35.1099"></a><span id="l35.1099" class="difflineplus">+      function FolderDisplayWidget_hintRightClickPerturbingSelect() {</span>
<a href="#l35.1100"></a><span id="l35.1100" class="difflineplus">+    this._saveSelection();</span>
<a href="#l35.1101"></a><span id="l35.1101" class="difflineplus">+  },</span>
<a href="#l35.1102"></a><span id="l35.1102" class="difflineplus">+</span>
<a href="#l35.1103"></a><span id="l35.1103" class="difflineplus">+  /**</span>
<a href="#l35.1104"></a><span id="l35.1104" class="difflineplus">+   * When a right-click on the thread pane altered our selection (which we</span>
<a href="#l35.1105"></a><span id="l35.1105" class="difflineplus">+   *  should have received a call to |hintRightClickPerturbingSelection| for),</span>
<a href="#l35.1106"></a><span id="l35.1106" class="difflineplus">+   *  we should receive this notification from</span>
<a href="#l35.1107"></a><span id="l35.1107" class="difflineplus">+   *  |RestoreSelectionWithoutContentLoad| when it wants to put things back.</span>
<a href="#l35.1108"></a><span id="l35.1108" class="difflineplus">+   */</span>
<a href="#l35.1109"></a><span id="l35.1109" class="difflineplus">+  hintRightClickSelectionPerturbationDone:</span>
<a href="#l35.1110"></a><span id="l35.1110" class="difflineplus">+      function FolderDisplayWidget_hintRightClickSelectionPerturbationDone() {</span>
<a href="#l35.1111"></a><span id="l35.1111" class="difflineplus">+    this._restoreSelection();</span>
<a href="#l35.1112"></a><span id="l35.1112" class="difflineplus">+  },</span>
<a href="#l35.1113"></a><span id="l35.1113" class="difflineplus">+</span>
<a href="#l35.1114"></a><span id="l35.1114" class="difflineplus">+  /* ===== End hints from the command infrastructure ==== */</span>
<a href="#l35.1115"></a><span id="l35.1115" class="difflineplus">+</span>
<a href="#l35.1116"></a><span id="l35.1116" class="difflineplus">+  _updateThreadDisplay: function FolderDisplayWidget__updateThreadDisplay() {</span>
<a href="#l35.1117"></a><span id="l35.1117" class="difflineplus">+    if (this.active) {</span>
<a href="#l35.1118"></a><span id="l35.1118" class="difflineplus">+      if (this.view.dbView) {</span>
<a href="#l35.1119"></a><span id="l35.1119" class="difflineplus">+        this.updateColumns();</span>
<a href="#l35.1120"></a><span id="l35.1120" class="difflineplus">+        UpdateSortIndicators(this.view.dbView.sortType,</span>
<a href="#l35.1121"></a><span id="l35.1121" class="difflineplus">+                             this.view.dbView.sortOrder);</span>
<a href="#l35.1122"></a><span id="l35.1122" class="difflineplus">+        SetNewsFolderColumns();</span>
<a href="#l35.1123"></a><span id="l35.1123" class="difflineplus">+      }</span>
<a href="#l35.1124"></a><span id="l35.1124" class="difflineplus">+    }</span>
<a href="#l35.1125"></a><span id="l35.1125" class="difflineplus">+  },</span>
<a href="#l35.1126"></a><span id="l35.1126" class="difflineplus">+</span>
<a href="#l35.1127"></a><span id="l35.1127" class="difflineplus">+  /**</span>
<a href="#l35.1128"></a><span id="l35.1128" class="difflineplus">+   * Update the UI display apart from the thread tree because the folder being</span>
<a href="#l35.1129"></a><span id="l35.1129" class="difflineplus">+   *  displayed has changed.  This can be the result of changing the folder in</span>
<a href="#l35.1130"></a><span id="l35.1130" class="difflineplus">+   *  this FolderDisplayWidget, or because this FolderDisplayWidget is being</span>
<a href="#l35.1131"></a><span id="l35.1131" class="difflineplus">+   *  made active.  _updateThreadDisplay handles the parts of the thread tree</span>
<a href="#l35.1132"></a><span id="l35.1132" class="difflineplus">+   *  that need updating.</span>
<a href="#l35.1133"></a><span id="l35.1133" class="difflineplus">+   */</span>
<a href="#l35.1134"></a><span id="l35.1134" class="difflineplus">+  _updateContextDisplay: function FolderDisplayWidget__updateContextDisplay() {</span>
<a href="#l35.1135"></a><span id="l35.1135" class="difflineplus">+    if (this.active) {</span>
<a href="#l35.1136"></a><span id="l35.1136" class="difflineplus">+      UpdateMailToolbar(&quot;FolderDisplayWidget updating context&quot;);</span>
<a href="#l35.1137"></a><span id="l35.1137" class="difflineplus">+      UpdateStatusQuota(this.displayedFolder);</span>
<a href="#l35.1138"></a><span id="l35.1138" class="difflineplus">+      UpdateStatusMessageCounts(this.displayedFolder);</span>
<a href="#l35.1139"></a><span id="l35.1139" class="difflineplus">+</span>
<a href="#l35.1140"></a><span id="l35.1140" class="difflineplus">+      // - mail view combo-box.</span>
<a href="#l35.1141"></a><span id="l35.1141" class="difflineplus">+      this.onMailViewChanged();</span>
<a href="#l35.1142"></a><span id="l35.1142" class="difflineplus">+    }</span>
<a href="#l35.1143"></a><span id="l35.1143" class="difflineplus">+  },</span>
<a href="#l35.1144"></a><span id="l35.1144" class="difflineplus">+</span>
<a href="#l35.1145"></a><span id="l35.1145" class="difflineplus">+  /**</span>
<a href="#l35.1146"></a><span id="l35.1146" class="difflineplus">+   * Run the provided notification function right now if we are 'active' (the</span>
<a href="#l35.1147"></a><span id="l35.1147" class="difflineplus">+   *  currently displayed tab), otherwise queue it to be run when we become</span>
<a href="#l35.1148"></a><span id="l35.1148" class="difflineplus">+   *  active.  We do this because our tabbing model uses multiplexed (reused)</span>
<a href="#l35.1149"></a><span id="l35.1149" class="difflineplus">+   *  widgets, and extensions likewise depend on these global/singleton things.</span>
<a href="#l35.1150"></a><span id="l35.1150" class="difflineplus">+   * If the requested notification function is already queued, it will not be</span>
<a href="#l35.1151"></a><span id="l35.1151" class="difflineplus">+   *  added a second time, and the original call ordering will be maintained.</span>
<a href="#l35.1152"></a><span id="l35.1152" class="difflineplus">+   *  If a new call ordering is required, the list of notifications should</span>
<a href="#l35.1153"></a><span id="l35.1153" class="difflineplus">+   *  probably be reset by the 'big bang' event (new view creation?).</span>
<a href="#l35.1154"></a><span id="l35.1154" class="difflineplus">+   */</span>
<a href="#l35.1155"></a><span id="l35.1155" class="difflineplus">+  _notifyWhenActive:</span>
<a href="#l35.1156"></a><span id="l35.1156" class="difflineplus">+      function FolderDisplayWidget__notifyWhenActive(aNotificationFunc) {</span>
<a href="#l35.1157"></a><span id="l35.1157" class="difflineplus">+    if (this._active) {</span>
<a href="#l35.1158"></a><span id="l35.1158" class="difflineplus">+      aNotificationFunc.call(this);</span>
<a href="#l35.1159"></a><span id="l35.1159" class="difflineplus">+    }</span>
<a href="#l35.1160"></a><span id="l35.1160" class="difflineplus">+    else {</span>
<a href="#l35.1161"></a><span id="l35.1161" class="difflineplus">+      if (this._notificationsPendingActivation.indexOf(aNotificationFunc) == -1)</span>
<a href="#l35.1162"></a><span id="l35.1162" class="difflineplus">+        this._notificationsPendingActivation.push(aNotificationFunc);</span>
<a href="#l35.1163"></a><span id="l35.1163" class="difflineplus">+    }</span>
<a href="#l35.1164"></a><span id="l35.1164" class="difflineplus">+  },</span>
<a href="#l35.1165"></a><span id="l35.1165" class="difflineplus">+</span>
<a href="#l35.1166"></a><span id="l35.1166" class="difflineplus">+  /**</span>
<a href="#l35.1167"></a><span id="l35.1167" class="difflineplus">+   * Some notifications cannot run while the FolderDisplayWidget is inactive</span>
<a href="#l35.1168"></a><span id="l35.1168" class="difflineplus">+   *  (presumbly because it is in a background tab).  We accumulate those in</span>
<a href="#l35.1169"></a><span id="l35.1169" class="difflineplus">+   *  _notificationsPendingActivation and then this method runs them when we</span>
<a href="#l35.1170"></a><span id="l35.1170" class="difflineplus">+   *  become active again.</span>
<a href="#l35.1171"></a><span id="l35.1171" class="difflineplus">+   */</span>
<a href="#l35.1172"></a><span id="l35.1172" class="difflineplus">+  _runNotificationsPendingActivation:</span>
<a href="#l35.1173"></a><span id="l35.1173" class="difflineplus">+      function FolderDisplayWidget__runNotificationsPendingActivation() {</span>
<a href="#l35.1174"></a><span id="l35.1174" class="difflineplus">+    if (!this._notificationsPendingActivation.length)</span>
<a href="#l35.1175"></a><span id="l35.1175" class="difflineplus">+      return;</span>
<a href="#l35.1176"></a><span id="l35.1176" class="difflineplus">+</span>
<a href="#l35.1177"></a><span id="l35.1177" class="difflineplus">+    let pendingNotifications = this._notificationsPendingActivation;</span>
<a href="#l35.1178"></a><span id="l35.1178" class="difflineplus">+    this._notificationsPendingActivation = [];</span>
<a href="#l35.1179"></a><span id="l35.1179" class="difflineplus">+    for each (let [, notif] in Iterator(pendingNotifications)) {</span>
<a href="#l35.1180"></a><span id="l35.1180" class="difflineplus">+      notif.call(this);</span>
<a href="#l35.1181"></a><span id="l35.1181" class="difflineplus">+    }</span>
<a href="#l35.1182"></a><span id="l35.1182" class="difflineplus">+  },</span>
<a href="#l35.1183"></a><span id="l35.1183" class="difflineplus">+</span>
<a href="#l35.1184"></a><span id="l35.1184" class="difflineplus">+  get active() {</span>
<a href="#l35.1185"></a><span id="l35.1185" class="difflineplus">+    return this._active;</span>
<a href="#l35.1186"></a><span id="l35.1186" class="difflineplus">+  },</span>
<a href="#l35.1187"></a><span id="l35.1187" class="difflineplus">+</span>
<a href="#l35.1188"></a><span id="l35.1188" class="difflineplus">+  /**</span>
<a href="#l35.1189"></a><span id="l35.1189" class="difflineplus">+   * Make this FolderDisplayWidget the 'active' widget by updating globals and</span>
<a href="#l35.1190"></a><span id="l35.1190" class="difflineplus">+   *  linking us up to the UI widgets.  This is intended for use by the tabbing</span>
<a href="#l35.1191"></a><span id="l35.1191" class="difflineplus">+   *  logic.</span>
<a href="#l35.1192"></a><span id="l35.1192" class="difflineplus">+   */</span>
<a href="#l35.1193"></a><span id="l35.1193" class="difflineplus">+  makeActive: function FolderDisplayWidget_makeActive(aWasInactive) {</span>
<a href="#l35.1194"></a><span id="l35.1194" class="difflineplus">+    let wasInactive = !this._active;</span>
<a href="#l35.1195"></a><span id="l35.1195" class="difflineplus">+</span>
<a href="#l35.1196"></a><span id="l35.1196" class="difflineplus">+    // -- globals</span>
<a href="#l35.1197"></a><span id="l35.1197" class="difflineplus">+    // update per-tab globals that we own</span>
<a href="#l35.1198"></a><span id="l35.1198" class="difflineplus">+    gFolderDisplay = this;</span>
<a href="#l35.1199"></a><span id="l35.1199" class="difflineplus">+    gMessageDisplay = this.messageDisplay;</span>
<a href="#l35.1200"></a><span id="l35.1200" class="difflineplus">+    gDBView = this.view.dbView;</span>
<a href="#l35.1201"></a><span id="l35.1201" class="difflineplus">+    messenger = this.messenger;</span>
<a href="#l35.1202"></a><span id="l35.1202" class="difflineplus">+</span>
<a href="#l35.1203"></a><span id="l35.1203" class="difflineplus">+    // update singleton globals' state</span>
<a href="#l35.1204"></a><span id="l35.1204" class="difflineplus">+    msgWindow.openFolder = this.view.displayedFolder;</span>
<a href="#l35.1205"></a><span id="l35.1205" class="difflineplus">+</span>
<a href="#l35.1206"></a><span id="l35.1206" class="difflineplus">+    this._active = true;</span>
<a href="#l35.1207"></a><span id="l35.1207" class="difflineplus">+    this._runNotificationsPendingActivation();</span>
<a href="#l35.1208"></a><span id="l35.1208" class="difflineplus">+</span>
<a href="#l35.1209"></a><span id="l35.1209" class="difflineplus">+    // -- UI</span>
<a href="#l35.1210"></a><span id="l35.1210" class="difflineplus">+</span>
<a href="#l35.1211"></a><span id="l35.1211" class="difflineplus">+    // thread pane if we have a db view</span>
<a href="#l35.1212"></a><span id="l35.1212" class="difflineplus">+    if (this.view.dbView) {</span>
<a href="#l35.1213"></a><span id="l35.1213" class="difflineplus">+      // Make sure said thread pane is visible.  If we do this after we re-root</span>
<a href="#l35.1214"></a><span id="l35.1214" class="difflineplus">+      //  the tree, the thread pane may not actually replace the account central</span>
<a href="#l35.1215"></a><span id="l35.1215" class="difflineplus">+      //  pane.  Concerning...</span>
<a href="#l35.1216"></a><span id="l35.1216" class="difflineplus">+      this._showThreadPane();</span>
<a href="#l35.1217"></a><span id="l35.1217" class="difflineplus">+</span>
<a href="#l35.1218"></a><span id="l35.1218" class="difflineplus">+      // some things only need to happen if we are transitioning from inactive</span>
<a href="#l35.1219"></a><span id="l35.1219" class="difflineplus">+      //  to active</span>
<a href="#l35.1220"></a><span id="l35.1220" class="difflineplus">+      if (wasInactive) {</span>
<a href="#l35.1221"></a><span id="l35.1221" class="difflineplus">+        // Setting the 'view' attribute on treeBox results in the following</span>
<a href="#l35.1222"></a><span id="l35.1222" class="difflineplus">+        //  effective calls, noting that in makeInactive we made sure to null</span>
<a href="#l35.1223"></a><span id="l35.1223" class="difflineplus">+        //  out its view so that it won't try and clean up any views or their</span>
<a href="#l35.1224"></a><span id="l35.1224" class="difflineplus">+        //  selections.  (The actual actions happen in nsTreeBodyFrame::SetView)</span>
<a href="#l35.1225"></a><span id="l35.1225" class="difflineplus">+        // - this.view.dbView.selection.tree = this.treeBox</span>
<a href="#l35.1226"></a><span id="l35.1226" class="difflineplus">+        // - this.view.dbView.setTree(this.treeBox)</span>
<a href="#l35.1227"></a><span id="l35.1227" class="difflineplus">+        // - this.treeBox.view = this.view.dbView (in nsTreeBodyObject::SetView)</span>
<a href="#l35.1228"></a><span id="l35.1228" class="difflineplus">+        if (this.treeBox) {</span>
<a href="#l35.1229"></a><span id="l35.1229" class="difflineplus">+          this.treeBox.view = this.view.dbView;</span>
<a href="#l35.1230"></a><span id="l35.1230" class="difflineplus">+          if (this._savedFirstVisibleRow != null)</span>
<a href="#l35.1231"></a><span id="l35.1231" class="difflineplus">+            this.treeBox.scrollToRow(this._savedFirstVisibleRow);</span>
<a href="#l35.1232"></a><span id="l35.1232" class="difflineplus">+</span>
<a href="#l35.1233"></a><span id="l35.1233" class="difflineplus">+          this.restoreColumnStates();</span>
<a href="#l35.1234"></a><span id="l35.1234" class="difflineplus">+        }</span>
<a href="#l35.1235"></a><span id="l35.1235" class="difflineplus">+</span>
<a href="#l35.1236"></a><span id="l35.1236" class="difflineplus">+        // restore the quick search widget</span>
<a href="#l35.1237"></a><span id="l35.1237" class="difflineplus">+        let searchInput = document.getElementById(&quot;searchInput&quot;);</span>
<a href="#l35.1238"></a><span id="l35.1238" class="difflineplus">+        if (searchInput &amp;&amp; this._savedQuickSearch) {</span>
<a href="#l35.1239"></a><span id="l35.1239" class="difflineplus">+          searchInput.searchMode = this._savedQuickSearch.searchMode;</span>
<a href="#l35.1240"></a><span id="l35.1240" class="difflineplus">+          if (this._savedQuickSearch.text) {</span>
<a href="#l35.1241"></a><span id="l35.1241" class="difflineplus">+            searchInput.value = this._savedQuickSearch.text;</span>
<a href="#l35.1242"></a><span id="l35.1242" class="difflineplus">+            searchInput.showingSearchCriteria = false;</span>
<a href="#l35.1243"></a><span id="l35.1243" class="difflineplus">+            searchInput.clearButtonHidden = false;</span>
<a href="#l35.1244"></a><span id="l35.1244" class="difflineplus">+          }</span>
<a href="#l35.1245"></a><span id="l35.1245" class="difflineplus">+          else {</span>
<a href="#l35.1246"></a><span id="l35.1246" class="difflineplus">+            searchInput.setSearchCriteriaText();</span>
<a href="#l35.1247"></a><span id="l35.1247" class="difflineplus">+          }</span>
<a href="#l35.1248"></a><span id="l35.1248" class="difflineplus">+        }</span>
<a href="#l35.1249"></a><span id="l35.1249" class="difflineplus">+      }</span>
<a href="#l35.1250"></a><span id="l35.1250" class="difflineplus">+</span>
<a href="#l35.1251"></a><span id="l35.1251" class="difflineplus">+      // the tab mode knows whether we are folder or message display, which</span>
<a href="#l35.1252"></a><span id="l35.1252" class="difflineplus">+      //  impacts the legal modes</span>
<a href="#l35.1253"></a><span id="l35.1253" class="difflineplus">+      if (this._tabInfo)</span>
<a href="#l35.1254"></a><span id="l35.1254" class="difflineplus">+        mailTabType._setPaneStates(this._tabInfo.mode.legalPanes,</span>
<a href="#l35.1255"></a><span id="l35.1255" class="difflineplus">+          {folder: !this._tabInfo.folderPaneCollapsed,</span>
<a href="#l35.1256"></a><span id="l35.1256" class="difflineplus">+           message: !this._tabInfo.messagePaneCollapsed});</span>
<a href="#l35.1257"></a><span id="l35.1257" class="difflineplus">+</span>
<a href="#l35.1258"></a><span id="l35.1258" class="difflineplus">+      // update the columns and such that live inside the thread pane</span>
<a href="#l35.1259"></a><span id="l35.1259" class="difflineplus">+      this._updateThreadDisplay();</span>
<a href="#l35.1260"></a><span id="l35.1260" class="difflineplus">+</span>
<a href="#l35.1261"></a><span id="l35.1261" class="difflineplus">+      this.messageDisplay.makeActive();</span>
<a href="#l35.1262"></a><span id="l35.1262" class="difflineplus">+    }</span>
<a href="#l35.1263"></a><span id="l35.1263" class="difflineplus">+    // account central stuff when we don't have a dbview</span>
<a href="#l35.1264"></a><span id="l35.1264" class="difflineplus">+    else {</span>
<a href="#l35.1265"></a><span id="l35.1265" class="difflineplus">+      this._showAccountCentral();</span>
<a href="#l35.1266"></a><span id="l35.1266" class="difflineplus">+      if (this._tabInfo)</span>
<a href="#l35.1267"></a><span id="l35.1267" class="difflineplus">+        mailTabType._setPaneStates(this._tabInfo.mode.legalPanes,</span>
<a href="#l35.1268"></a><span id="l35.1268" class="difflineplus">+                                   {folder: !this._tabInfo.folderPaneCollapsed,</span>
<a href="#l35.1269"></a><span id="l35.1269" class="difflineplus">+                                    message: false});</span>
<a href="#l35.1270"></a><span id="l35.1270" class="difflineplus">+    }</span>
<a href="#l35.1271"></a><span id="l35.1271" class="difflineplus">+</span>
<a href="#l35.1272"></a><span id="l35.1272" class="difflineplus">+    this._updateContextDisplay();</span>
<a href="#l35.1273"></a><span id="l35.1273" class="difflineplus">+  },</span>
<a href="#l35.1274"></a><span id="l35.1274" class="difflineplus">+</span>
<a href="#l35.1275"></a><span id="l35.1275" class="difflineplus">+  /**</span>
<a href="#l35.1276"></a><span id="l35.1276" class="difflineplus">+   * Cause the displayDeck to display the thread pane.</span>
<a href="#l35.1277"></a><span id="l35.1277" class="difflineplus">+   */</span>
<a href="#l35.1278"></a><span id="l35.1278" class="difflineplus">+  _showThreadPane: function FolderDisplayWidget__showThreadPane() {</span>
<a href="#l35.1279"></a><span id="l35.1279" class="difflineplus">+    document.getElementById(&quot;displayDeck&quot;).selectedPanel =</span>
<a href="#l35.1280"></a><span id="l35.1280" class="difflineplus">+      document.getElementById(&quot;threadPaneBox&quot;);</span>
<a href="#l35.1281"></a><span id="l35.1281" class="difflineplus">+  },</span>
<a href="#l35.1282"></a><span id="l35.1282" class="difflineplus">+</span>
<a href="#l35.1283"></a><span id="l35.1283" class="difflineplus">+  /**</span>
<a href="#l35.1284"></a><span id="l35.1284" class="difflineplus">+   * Cause the displayDeck to display the (preference configurable) account</span>
<a href="#l35.1285"></a><span id="l35.1285" class="difflineplus">+   *  central page.</span>
<a href="#l35.1286"></a><span id="l35.1286" class="difflineplus">+   */</span>
<a href="#l35.1287"></a><span id="l35.1287" class="difflineplus">+  _showAccountCentral: function FolderDisplayWidget__showAccountCentral() {</span>
<a href="#l35.1288"></a><span id="l35.1288" class="difflineplus">+    var accountBox = document.getElementById(&quot;accountCentralBox&quot;);</span>
<a href="#l35.1289"></a><span id="l35.1289" class="difflineplus">+    document.getElementById(&quot;displayDeck&quot;).selectedPanel = accountBox;</span>
<a href="#l35.1290"></a><span id="l35.1290" class="difflineplus">+    var prefName = &quot;mailnews.account_central_page.url&quot;;</span>
<a href="#l35.1291"></a><span id="l35.1291" class="difflineplus">+    // oh yeah, 'pref' is a global all right.</span>
<a href="#l35.1292"></a><span id="l35.1292" class="difflineplus">+    var acctCentralPage =</span>
<a href="#l35.1293"></a><span id="l35.1293" class="difflineplus">+      pref.getComplexValue(prefName,</span>
<a href="#l35.1294"></a><span id="l35.1294" class="difflineplus">+                           Components.interfaces.nsIPrefLocalizedString).data;</span>
<a href="#l35.1295"></a><span id="l35.1295" class="difflineplus">+    window.frames[&quot;accountCentralPane&quot;].location.href = acctCentralPage;</span>
<a href="#l35.1296"></a><span id="l35.1296" class="difflineplus">+  },</span>
<a href="#l35.1297"></a><span id="l35.1297" class="difflineplus">+</span>
<a href="#l35.1298"></a><span id="l35.1298" class="difflineplus">+  /**</span>
<a href="#l35.1299"></a><span id="l35.1299" class="difflineplus">+   * Call this when the tab using us is being hidden.</span>
<a href="#l35.1300"></a><span id="l35.1300" class="difflineplus">+   */</span>
<a href="#l35.1301"></a><span id="l35.1301" class="difflineplus">+  makeInactive: function FolderDisplayWidget_makeInactive() {</span>
<a href="#l35.1302"></a><span id="l35.1302" class="difflineplus">+    this._active = false;</span>
<a href="#l35.1303"></a><span id="l35.1303" class="difflineplus">+    // save the folder pane's state always</span>
<a href="#l35.1304"></a><span id="l35.1304" class="difflineplus">+    this.folderPaneCollapsed =</span>
<a href="#l35.1305"></a><span id="l35.1305" class="difflineplus">+      document.getElementById(&quot;folderPaneBox&quot;).collapsed;</span>
<a href="#l35.1306"></a><span id="l35.1306" class="difflineplus">+</span>
<a href="#l35.1307"></a><span id="l35.1307" class="difflineplus">+    if (this.view.dbView) {</span>
<a href="#l35.1308"></a><span id="l35.1308" class="difflineplus">+      if (this.treeBox)</span>
<a href="#l35.1309"></a><span id="l35.1309" class="difflineplus">+        this._savedFirstVisibleRow = this.treeBox.getFirstVisibleRow();</span>
<a href="#l35.1310"></a><span id="l35.1310" class="difflineplus">+</span>
<a href="#l35.1311"></a><span id="l35.1311" class="difflineplus">+      // save column states</span>
<a href="#l35.1312"></a><span id="l35.1312" class="difflineplus">+      this.saveColumnStates();</span>
<a href="#l35.1313"></a><span id="l35.1313" class="difflineplus">+</span>
<a href="#l35.1314"></a><span id="l35.1314" class="difflineplus">+      // save the message pane's state only when it is potentially visible</span>
<a href="#l35.1315"></a><span id="l35.1315" class="difflineplus">+      this.messagePaneCollapsed =</span>
<a href="#l35.1316"></a><span id="l35.1316" class="difflineplus">+        document.getElementById(&quot;messagepanebox&quot;).collapsed;</span>
<a href="#l35.1317"></a><span id="l35.1317" class="difflineplus">+</span>
<a href="#l35.1318"></a><span id="l35.1318" class="difflineplus">+      // save the actual quick-search query text</span>
<a href="#l35.1319"></a><span id="l35.1319" class="difflineplus">+      let searchInput = document.getElementById(&quot;searchInput&quot;);</span>
<a href="#l35.1320"></a><span id="l35.1320" class="difflineplus">+      if (searchInput) {</span>
<a href="#l35.1321"></a><span id="l35.1321" class="difflineplus">+        this._savedQuickSearch = {</span>
<a href="#l35.1322"></a><span id="l35.1322" class="difflineplus">+          text: searchInput.showingSearchCriteria ? null : searchInput.value,</span>
<a href="#l35.1323"></a><span id="l35.1323" class="difflineplus">+          searchMode: searchInput.searchMode</span>
<a href="#l35.1324"></a><span id="l35.1324" class="difflineplus">+        };</span>
<a href="#l35.1325"></a><span id="l35.1325" class="difflineplus">+      }</span>
<a href="#l35.1326"></a><span id="l35.1326" class="difflineplus">+</span>
<a href="#l35.1327"></a><span id="l35.1327" class="difflineplus">+      // save off the tree selection object.  the nsTreeBodyFrame will make the</span>
<a href="#l35.1328"></a><span id="l35.1328" class="difflineplus">+      //  view forget about it when our view is removed, so it's up to us to</span>
<a href="#l35.1329"></a><span id="l35.1329" class="difflineplus">+      //  save it.</span>
<a href="#l35.1330"></a><span id="l35.1330" class="difflineplus">+      let treeViewSelection = this.view.dbView.selection;</span>
<a href="#l35.1331"></a><span id="l35.1331" class="difflineplus">+      // make the tree forget about the view right now so we can tell the db</span>
<a href="#l35.1332"></a><span id="l35.1332" class="difflineplus">+      //  view about its selection object so it can try and keep it up-to-date</span>
<a href="#l35.1333"></a><span id="l35.1333" class="difflineplus">+      //  even while hidden in the background</span>
<a href="#l35.1334"></a><span id="l35.1334" class="difflineplus">+      if (this.treeBox)</span>
<a href="#l35.1335"></a><span id="l35.1335" class="difflineplus">+        this.treeBox.view = null;</span>
<a href="#l35.1336"></a><span id="l35.1336" class="difflineplus">+      // (and tell the db view about its selection again...)</span>
<a href="#l35.1337"></a><span id="l35.1337" class="difflineplus">+      this.view.dbView.selection = treeViewSelection;</span>
<a href="#l35.1338"></a><span id="l35.1338" class="difflineplus">+</span>
<a href="#l35.1339"></a><span id="l35.1339" class="difflineplus">+      // hook the dbview up to the fake tree box</span>
<a href="#l35.1340"></a><span id="l35.1340" class="difflineplus">+      this._fakeTreeBox.view = this.view.dbView;</span>
<a href="#l35.1341"></a><span id="l35.1341" class="difflineplus">+      this.view.dbView.setTree(this._fakeTreeBox);</span>
<a href="#l35.1342"></a><span id="l35.1342" class="difflineplus">+      treeViewSelection.tree = this._fakeTreeBox;</span>
<a href="#l35.1343"></a><span id="l35.1343" class="difflineplus">+    }</span>
<a href="#l35.1344"></a><span id="l35.1344" class="difflineplus">+</span>
<a href="#l35.1345"></a><span id="l35.1345" class="difflineplus">+    this.messageDisplay.makeInactive();</span>
<a href="#l35.1346"></a><span id="l35.1346" class="difflineplus">+  },</span>
<a href="#l35.1347"></a><span id="l35.1347" class="difflineplus">+</span>
<a href="#l35.1348"></a><span id="l35.1348" class="difflineplus">+  /**</span>
<a href="#l35.1349"></a><span id="l35.1349" class="difflineplus">+   * @return true if there is a db view and the command is enabled on the view.</span>
<a href="#l35.1350"></a><span id="l35.1350" class="difflineplus">+   *  This function hides some of the XPCOM-odditities of the getCommandStatus</span>
<a href="#l35.1351"></a><span id="l35.1351" class="difflineplus">+   *  call.</span>
<a href="#l35.1352"></a><span id="l35.1352" class="difflineplus">+   */</span>
<a href="#l35.1353"></a><span id="l35.1353" class="difflineplus">+  getCommandStatus: function FolderDisplayWidget_getCommandStatus(</span>
<a href="#l35.1354"></a><span id="l35.1354" class="difflineplus">+      aCommandType, aEnabledObj, aCheckStatusObj) {</span>
<a href="#l35.1355"></a><span id="l35.1355" class="difflineplus">+    // no view means not enabled</span>
<a href="#l35.1356"></a><span id="l35.1356" class="difflineplus">+    if (!this.view.dbView)</span>
<a href="#l35.1357"></a><span id="l35.1357" class="difflineplus">+      return false;</span>
<a href="#l35.1358"></a><span id="l35.1358" class="difflineplus">+    let enabledObj = {}, checkStatusObj = {};</span>
<a href="#l35.1359"></a><span id="l35.1359" class="difflineplus">+    this.view.dbView.getCommandStatus(aCommandType, enabledObj, checkStatusObj);</span>
<a href="#l35.1360"></a><span id="l35.1360" class="difflineplus">+    return enabledObj.value;</span>
<a href="#l35.1361"></a><span id="l35.1361" class="difflineplus">+  },</span>
<a href="#l35.1362"></a><span id="l35.1362" class="difflineplus">+</span>
<a href="#l35.1363"></a><span id="l35.1363" class="difflineplus">+  /**</span>
<a href="#l35.1364"></a><span id="l35.1364" class="difflineplus">+   * Make code cleaner by allowing peoples to call doCommand on us rather than</span>
<a href="#l35.1365"></a><span id="l35.1365" class="difflineplus">+   *  having to do folderDisplayWidget.view.dbView.doCommand.</span>
<a href="#l35.1366"></a><span id="l35.1366" class="difflineplus">+   *</span>
<a href="#l35.1367"></a><span id="l35.1367" class="difflineplus">+   * @param aCommandName The command name to invoke.</span>
<a href="#l35.1368"></a><span id="l35.1368" class="difflineplus">+   */</span>
<a href="#l35.1369"></a><span id="l35.1369" class="difflineplus">+  doCommand: function FolderDisplayWidget_doCommand(aCommandName) {</span>
<a href="#l35.1370"></a><span id="l35.1370" class="difflineplus">+    return this.view.dbView &amp;&amp; this.view.dbView.doCommand(aCommandName);</span>
<a href="#l35.1371"></a><span id="l35.1371" class="difflineplus">+  },</span>
<a href="#l35.1372"></a><span id="l35.1372" class="difflineplus">+</span>
<a href="#l35.1373"></a><span id="l35.1373" class="difflineplus">+  /**</span>
<a href="#l35.1374"></a><span id="l35.1374" class="difflineplus">+   * Make code cleaner by allowing peoples to call doCommandWithFolder on us</span>
<a href="#l35.1375"></a><span id="l35.1375" class="difflineplus">+   *  rather than having to do:</span>
<a href="#l35.1376"></a><span id="l35.1376" class="difflineplus">+   *  folderDisplayWidget.view.dbView.doCommandWithFolder.</span>
<a href="#l35.1377"></a><span id="l35.1377" class="difflineplus">+   *</span>
<a href="#l35.1378"></a><span id="l35.1378" class="difflineplus">+   * @param aCommandName The command name to invoke.</span>
<a href="#l35.1379"></a><span id="l35.1379" class="difflineplus">+   * @param aFolder The folder context for the command.</span>
<a href="#l35.1380"></a><span id="l35.1380" class="difflineplus">+   */</span>
<a href="#l35.1381"></a><span id="l35.1381" class="difflineplus">+  doCommandWithFolder: function FolderDisplayWidget_doCommandWithFolder(</span>
<a href="#l35.1382"></a><span id="l35.1382" class="difflineplus">+      aCommandName, aFolder) {</span>
<a href="#l35.1383"></a><span id="l35.1383" class="difflineplus">+    return this.view.dbView &amp;&amp;</span>
<a href="#l35.1384"></a><span id="l35.1384" class="difflineplus">+           this.view.dbView.doCommandWithFolder(aCommandName, aFolder);</span>
<a href="#l35.1385"></a><span id="l35.1385" class="difflineplus">+  },</span>
<a href="#l35.1386"></a><span id="l35.1386" class="difflineplus">+</span>
<a href="#l35.1387"></a><span id="l35.1387" class="difflineplus">+</span>
<a href="#l35.1388"></a><span id="l35.1388" class="difflineplus">+</span>
<a href="#l35.1389"></a><span id="l35.1389" class="difflineplus">+  /**</span>
<a href="#l35.1390"></a><span id="l35.1390" class="difflineplus">+   * Navigate using nsMsgNavigationType rules and ensuring the resulting row is</span>
<a href="#l35.1391"></a><span id="l35.1391" class="difflineplus">+   *  visible.  This is trickier than it used to be because we now support</span>
<a href="#l35.1392"></a><span id="l35.1392" class="difflineplus">+   *  treating collapsed threads as the set of all the messages in the collapsed</span>
<a href="#l35.1393"></a><span id="l35.1393" class="difflineplus">+   *  thread rather than just the root message in that thread.</span>
<a href="#l35.1394"></a><span id="l35.1394" class="difflineplus">+   *</span>
<a href="#l35.1395"></a><span id="l35.1395" class="difflineplus">+   * @param aNavType {nsMsgNavigationType} navigation command.</span>
<a href="#l35.1396"></a><span id="l35.1396" class="difflineplus">+   * @param aSelect {Boolean} should we select the message if we find one?</span>
<a href="#l35.1397"></a><span id="l35.1397" class="difflineplus">+   *     Defaults to true if omitted.</span>
<a href="#l35.1398"></a><span id="l35.1398" class="difflineplus">+   *</span>
<a href="#l35.1399"></a><span id="l35.1399" class="difflineplus">+   * @return true if the navigation constraint matched anything, false if not.</span>
<a href="#l35.1400"></a><span id="l35.1400" class="difflineplus">+   *     We will have navigated if true, we will have done nothing if false.</span>
<a href="#l35.1401"></a><span id="l35.1401" class="difflineplus">+   */</span>
<a href="#l35.1402"></a><span id="l35.1402" class="difflineplus">+  navigate: function FolderDisplayWidget_navigate(aNavType, aSelect) {</span>
<a href="#l35.1403"></a><span id="l35.1403" class="difflineplus">+    if (aSelect === undefined)</span>
<a href="#l35.1404"></a><span id="l35.1404" class="difflineplus">+      aSelect = true;</span>
<a href="#l35.1405"></a><span id="l35.1405" class="difflineplus">+    let resultKeyObj = {}, resultIndexObj = {}, threadIndexObj = {};</span>
<a href="#l35.1406"></a><span id="l35.1406" class="difflineplus">+</span>
<a href="#l35.1407"></a><span id="l35.1407" class="difflineplus">+    let summarizeSelection =</span>
<a href="#l35.1408"></a><span id="l35.1408" class="difflineplus">+      gPrefBranch.getBoolPref(&quot;mail.operate_on_msgs_in_collapsed_threads&quot;);</span>
<a href="#l35.1409"></a><span id="l35.1409" class="difflineplus">+</span>
<a href="#l35.1410"></a><span id="l35.1410" class="difflineplus">+    let treeSelection = this.treeSelection; // potentially magic getter</span>
<a href="#l35.1411"></a><span id="l35.1411" class="difflineplus">+    let currentIndex = treeSelection ? treeSelection.currentIndex : 0;</span>
<a href="#l35.1412"></a><span id="l35.1412" class="difflineplus">+</span>
<a href="#l35.1413"></a><span id="l35.1413" class="difflineplus">+    let viewIndex;</span>
<a href="#l35.1414"></a><span id="l35.1414" class="difflineplus">+    // if we're doing next unread, and a collapsed thread is selected, and</span>
<a href="#l35.1415"></a><span id="l35.1415" class="difflineplus">+    // the top level message is unread, just set the result manually to</span>
<a href="#l35.1416"></a><span id="l35.1416" class="difflineplus">+    // the top level message, without using viewNavigate.</span>
<a href="#l35.1417"></a><span id="l35.1417" class="difflineplus">+    if (summarizeSelection &amp;&amp;</span>
<a href="#l35.1418"></a><span id="l35.1418" class="difflineplus">+        aNavType == nsMsgNavigationType.nextUnreadMessage &amp;&amp;</span>
<a href="#l35.1419"></a><span id="l35.1419" class="difflineplus">+        currentIndex != -1 &amp;&amp;</span>
<a href="#l35.1420"></a><span id="l35.1420" class="difflineplus">+        this.view.isCollapsedThreadAtIndex(currentIndex) &amp;&amp;</span>
<a href="#l35.1421"></a><span id="l35.1421" class="difflineplus">+        !(this.view.dbView.getFlagsAt(currentIndex) &amp;</span>
<a href="#l35.1422"></a><span id="l35.1422" class="difflineplus">+          nsMsgMessageFlags.Read)) {</span>
<a href="#l35.1423"></a><span id="l35.1423" class="difflineplus">+      viewIndex = currentIndex;</span>
<a href="#l35.1424"></a><span id="l35.1424" class="difflineplus">+    }</span>
<a href="#l35.1425"></a><span id="l35.1425" class="difflineplus">+    else {</span>
<a href="#l35.1426"></a><span id="l35.1426" class="difflineplus">+      // always 'wrap' because the start index is relative to the selection.</span>
<a href="#l35.1427"></a><span id="l35.1427" class="difflineplus">+      // (keep in mind that many forms of navigation do not care about the</span>
<a href="#l35.1428"></a><span id="l35.1428" class="difflineplus">+      //  starting position or 'wrap' at all; for example, firstNew just finds</span>
<a href="#l35.1429"></a><span id="l35.1429" class="difflineplus">+      //  the first new message.)</span>
<a href="#l35.1430"></a><span id="l35.1430" class="difflineplus">+      // allegedly this does tree-expansion for us.</span>
<a href="#l35.1431"></a><span id="l35.1431" class="difflineplus">+      this.view.dbView.viewNavigate(aNavType, resultKeyObj, resultIndexObj,</span>
<a href="#l35.1432"></a><span id="l35.1432" class="difflineplus">+                                    threadIndexObj, true);</span>
<a href="#l35.1433"></a><span id="l35.1433" class="difflineplus">+      viewIndex = resultIndexObj.value;</span>
<a href="#l35.1434"></a><span id="l35.1434" class="difflineplus">+    }</span>
<a href="#l35.1435"></a><span id="l35.1435" class="difflineplus">+</span>
<a href="#l35.1436"></a><span id="l35.1436" class="difflineplus">+    if (viewIndex == nsMsgViewIndex_None)</span>
<a href="#l35.1437"></a><span id="l35.1437" class="difflineplus">+      return false;</span>
<a href="#l35.1438"></a><span id="l35.1438" class="difflineplus">+</span>
<a href="#l35.1439"></a><span id="l35.1439" class="difflineplus">+    // - Expand if required.</span>
<a href="#l35.1440"></a><span id="l35.1440" class="difflineplus">+    // (The nsMsgDBView isn't really aware of the varying semantics of</span>
<a href="#l35.1441"></a><span id="l35.1441" class="difflineplus">+    //  collapsed threads, so viewNavigate might tell us about the root message</span>
<a href="#l35.1442"></a><span id="l35.1442" class="difflineplus">+    //  and leave it collapsed, not realizing that it needs to be expanded.)</span>
<a href="#l35.1443"></a><span id="l35.1443" class="difflineplus">+    if (summarizeSelection &amp;&amp;</span>
<a href="#l35.1444"></a><span id="l35.1444" class="difflineplus">+        this.view.isCollapsedThreadAtIndex(viewIndex))</span>
<a href="#l35.1445"></a><span id="l35.1445" class="difflineplus">+      this.view.dbView.toggleOpenState(viewIndex);</span>
<a href="#l35.1446"></a><span id="l35.1446" class="difflineplus">+</span>
<a href="#l35.1447"></a><span id="l35.1447" class="difflineplus">+    if (aSelect)</span>
<a href="#l35.1448"></a><span id="l35.1448" class="difflineplus">+      this.selectViewIndex(viewIndex);</span>
<a href="#l35.1449"></a><span id="l35.1449" class="difflineplus">+    else</span>
<a href="#l35.1450"></a><span id="l35.1450" class="difflineplus">+      this.ensureRowIsVisible(viewIndex);</span>
<a href="#l35.1451"></a><span id="l35.1451" class="difflineplus">+    return true;</span>
<a href="#l35.1452"></a><span id="l35.1452" class="difflineplus">+  },</span>
<a href="#l35.1453"></a><span id="l35.1453" class="difflineplus">+</span>
<a href="#l35.1454"></a><span id="l35.1454" class="difflineplus">+  /**</span>
<a href="#l35.1455"></a><span id="l35.1455" class="difflineplus">+   * Push a call to |navigate| to be what we do once we successfully open the</span>
<a href="#l35.1456"></a><span id="l35.1456" class="difflineplus">+   *  next folder.  This is intended to be used by cross-folder navigation</span>
<a href="#l35.1457"></a><span id="l35.1457" class="difflineplus">+   *  code.  It should call this method before triggering the folder change.</span>
<a href="#l35.1458"></a><span id="l35.1458" class="difflineplus">+   */</span>
<a href="#l35.1459"></a><span id="l35.1459" class="difflineplus">+  pushNavigation: function FolderDisplayWidget_navigate(aNavType, aSelect) {</span>
<a href="#l35.1460"></a><span id="l35.1460" class="difflineplus">+    this._pendingNavigation = [aNavType, aSelect];</span>
<a href="#l35.1461"></a><span id="l35.1461" class="difflineplus">+  },</span>
<a href="#l35.1462"></a><span id="l35.1462" class="difflineplus">+</span>
<a href="#l35.1463"></a><span id="l35.1463" class="difflineplus">+  /**</span>
<a href="#l35.1464"></a><span id="l35.1464" class="difflineplus">+   * @return true if we are able to navigate using the given navigation type at</span>
<a href="#l35.1465"></a><span id="l35.1465" class="difflineplus">+   *  this time.</span>
<a href="#l35.1466"></a><span id="l35.1466" class="difflineplus">+   */</span>
<a href="#l35.1467"></a><span id="l35.1467" class="difflineplus">+  navigateStatus: function FolderDisplayWidget_navigateStatus(aNavType) {</span>
<a href="#l35.1468"></a><span id="l35.1468" class="difflineplus">+    if (!this.view.dbView)</span>
<a href="#l35.1469"></a><span id="l35.1469" class="difflineplus">+      return false;</span>
<a href="#l35.1470"></a><span id="l35.1470" class="difflineplus">+    return this.view.dbView.navigateStatus(aNavType);</span>
<a href="#l35.1471"></a><span id="l35.1471" class="difflineplus">+  },</span>
<a href="#l35.1472"></a><span id="l35.1472" class="difflineplus">+</span>
<a href="#l35.1473"></a><span id="l35.1473" class="difflineplus">+  /**</span>
<a href="#l35.1474"></a><span id="l35.1474" class="difflineplus">+   * @returns the message header for the first selected message, or null if</span>
<a href="#l35.1475"></a><span id="l35.1475" class="difflineplus">+   *  there is no selected message.</span>
<a href="#l35.1476"></a><span id="l35.1476" class="difflineplus">+   *</span>
<a href="#l35.1477"></a><span id="l35.1477" class="difflineplus">+   * If the user has right-clicked on a message, this method will return that</span>
<a href="#l35.1478"></a><span id="l35.1478" class="difflineplus">+   *  message and not the 'current index' (the dude with the dotted selection</span>
<a href="#l35.1479"></a><span id="l35.1479" class="difflineplus">+   *  rectangle around him.)  If you instead always want the currently</span>
<a href="#l35.1480"></a><span id="l35.1480" class="difflineplus">+   *  displayed message (which is not impacted by right-clicking), then you</span>
<a href="#l35.1481"></a><span id="l35.1481" class="difflineplus">+   *  would want to access the displayedMessage property on the</span>
<a href="#l35.1482"></a><span id="l35.1482" class="difflineplus">+   *  MessageDisplayWidget.  You can get to that via the messageDisplay</span>
<a href="#l35.1483"></a><span id="l35.1483" class="difflineplus">+   *  attribute on this object or (potentially) via the gMessageDisplay object.</span>
<a href="#l35.1484"></a><span id="l35.1484" class="difflineplus">+   */</span>
<a href="#l35.1485"></a><span id="l35.1485" class="difflineplus">+  get selectedMessage FolderDisplayWidget_get_selectedMessage() {</span>
<a href="#l35.1486"></a><span id="l35.1486" class="difflineplus">+    // there are inconsistencies in hdrForFirstSelectedMessage between</span>
<a href="#l35.1487"></a><span id="l35.1487" class="difflineplus">+    //  nsMsgDBView and nsMsgSearchDBView in whether they use currentIndex,</span>
<a href="#l35.1488"></a><span id="l35.1488" class="difflineplus">+    //  do it ourselves.  (nsMsgDBView does not use currentIndex, search does.)</span>
<a href="#l35.1489"></a><span id="l35.1489" class="difflineplus">+    let treeSelection = this.treeSelection;</span>
<a href="#l35.1490"></a><span id="l35.1490" class="difflineplus">+    if (!treeSelection || !treeSelection.count)</span>
<a href="#l35.1491"></a><span id="l35.1491" class="difflineplus">+      return null;</span>
<a href="#l35.1492"></a><span id="l35.1492" class="difflineplus">+    let minObj = {}, maxObj = {};</span>
<a href="#l35.1493"></a><span id="l35.1493" class="difflineplus">+    treeSelection.getRangeAt(0, minObj, maxObj);</span>
<a href="#l35.1494"></a><span id="l35.1494" class="difflineplus">+    return this.view.dbView.getMsgHdrAt(minObj.value);</span>
<a href="#l35.1495"></a><span id="l35.1495" class="difflineplus">+  },</span>
<a href="#l35.1496"></a><span id="l35.1496" class="difflineplus">+</span>
<a href="#l35.1497"></a><span id="l35.1497" class="difflineplus">+  /**</span>
<a href="#l35.1498"></a><span id="l35.1498" class="difflineplus">+   * @return true if there is a selected message and it's an RSS feed message.</span>
<a href="#l35.1499"></a><span id="l35.1499" class="difflineplus">+   */</span>
<a href="#l35.1500"></a><span id="l35.1500" class="difflineplus">+  get selectedMessageIsFeed FolderDisplayWidget_get_selectedMessageIsFeed() {</span>
<a href="#l35.1501"></a><span id="l35.1501" class="difflineplus">+    let message = this.selectedMessage;</span>
<a href="#l35.1502"></a><span id="l35.1502" class="difflineplus">+    return Boolean(message &amp;&amp; message.folder &amp;&amp;</span>
<a href="#l35.1503"></a><span id="l35.1503" class="difflineplus">+                   message.folder.server.type == 'rss');</span>
<a href="#l35.1504"></a><span id="l35.1504" class="difflineplus">+  },</span>
<a href="#l35.1505"></a><span id="l35.1505" class="difflineplus">+</span>
<a href="#l35.1506"></a><span id="l35.1506" class="difflineplus">+  /**</span>
<a href="#l35.1507"></a><span id="l35.1507" class="difflineplus">+   * @return true if there is a selected message and it's an IMAP message.</span>
<a href="#l35.1508"></a><span id="l35.1508" class="difflineplus">+   */</span>
<a href="#l35.1509"></a><span id="l35.1509" class="difflineplus">+  get selectedMessageIsImap FolderDisplayWidget_get_selectedMessageIsImap() {</span>
<a href="#l35.1510"></a><span id="l35.1510" class="difflineplus">+    let message = this.selectedMessage;</span>
<a href="#l35.1511"></a><span id="l35.1511" class="difflineplus">+    return Boolean(message &amp;&amp; message.folder &amp;&amp;</span>
<a href="#l35.1512"></a><span id="l35.1512" class="difflineplus">+                   message.folder.flags &amp; nsMsgFolderFlags.ImapBox);</span>
<a href="#l35.1513"></a><span id="l35.1513" class="difflineplus">+  },</span>
<a href="#l35.1514"></a><span id="l35.1514" class="difflineplus">+</span>
<a href="#l35.1515"></a><span id="l35.1515" class="difflineplus">+  /**</span>
<a href="#l35.1516"></a><span id="l35.1516" class="difflineplus">+   * @return true if there is a selected message and it's a news message.  It</span>
<a href="#l35.1517"></a><span id="l35.1517" class="difflineplus">+   *  would be great if messages knew this about themselves, but they don't.</span>
<a href="#l35.1518"></a><span id="l35.1518" class="difflineplus">+   */</span>
<a href="#l35.1519"></a><span id="l35.1519" class="difflineplus">+  get selectedMessageIsNews FolderDisplayWidget_get_selectedMessageIsNews() {</span>
<a href="#l35.1520"></a><span id="l35.1520" class="difflineplus">+    let message = this.selectedMessage;</span>
<a href="#l35.1521"></a><span id="l35.1521" class="difflineplus">+    return Boolean(message &amp;&amp; message.folder &amp;&amp;</span>
<a href="#l35.1522"></a><span id="l35.1522" class="difflineplus">+                   (message.folder.flags &amp; nsMsgFolderFlags.Newsgroup));</span>
<a href="#l35.1523"></a><span id="l35.1523" class="difflineplus">+  },</span>
<a href="#l35.1524"></a><span id="l35.1524" class="difflineplus">+</span>
<a href="#l35.1525"></a><span id="l35.1525" class="difflineplus">+  /**</span>
<a href="#l35.1526"></a><span id="l35.1526" class="difflineplus">+   * @return true if there is a selected message and it's an external message,</span>
<a href="#l35.1527"></a><span id="l35.1527" class="difflineplus">+   *  meaning it is loaded from an .eml file on disk or is an rfc822 attachment</span>
<a href="#l35.1528"></a><span id="l35.1528" class="difflineplus">+   *  on a message.</span>
<a href="#l35.1529"></a><span id="l35.1529" class="difflineplus">+   */</span>
<a href="#l35.1530"></a><span id="l35.1530" class="difflineplus">+  get selectedMessageIsExternal</span>
<a href="#l35.1531"></a><span id="l35.1531" class="difflineplus">+      FolderDisplayWidget_get_selectedMessageIsExternal() {</span>
<a href="#l35.1532"></a><span id="l35.1532" class="difflineplus">+    let message = this.selectedMessage;</span>
<a href="#l35.1533"></a><span id="l35.1533" class="difflineplus">+    // Dummy messages currently lack a folder.  This is not a great heuristic.</span>
<a href="#l35.1534"></a><span id="l35.1534" class="difflineplus">+    // I have annotated msgHdrViewOverlay.js which provides the dummy header to</span>
<a href="#l35.1535"></a><span id="l35.1535" class="difflineplus">+    //  express this implementation dependency.</span>
<a href="#l35.1536"></a><span id="l35.1536" class="difflineplus">+    // (Currently, since external mails can only be opened in standalone windows</span>
<a href="#l35.1537"></a><span id="l35.1537" class="difflineplus">+    //  which subclass us, we could always return false, and have the subclass</span>
<a href="#l35.1538"></a><span id="l35.1538" class="difflineplus">+    //  return true using its own heuristics.  But since we are moving to a tab</span>
<a href="#l35.1539"></a><span id="l35.1539" class="difflineplus">+    //  model more heavily, at some point the 3-pane will need this.)</span>
<a href="#l35.1540"></a><span id="l35.1540" class="difflineplus">+    return Boolean(message &amp;&amp; !message.folder);</span>
<a href="#l35.1541"></a><span id="l35.1541" class="difflineplus">+  },</span>
<a href="#l35.1542"></a><span id="l35.1542" class="difflineplus">+</span>
<a href="#l35.1543"></a><span id="l35.1543" class="difflineplus">+  /**</span>
<a href="#l35.1544"></a><span id="l35.1544" class="difflineplus">+   * @return the number of selected messages.  If the</span>
<a href="#l35.1545"></a><span id="l35.1545" class="difflineplus">+   *  &quot;mail.operate_on_msgs_in_collapsed_threads&quot; preference is enabled, then</span>
<a href="#l35.1546"></a><span id="l35.1546" class="difflineplus">+   *  any collapsed thread roots that are selected will also conceptually have</span>
<a href="#l35.1547"></a><span id="l35.1547" class="difflineplus">+   *  all of the messages in that thread selected.</span>
<a href="#l35.1548"></a><span id="l35.1548" class="difflineplus">+   */</span>
<a href="#l35.1549"></a><span id="l35.1549" class="difflineplus">+  get selectedCount FolderDisplayWidget_get_selectedCount() {</span>
<a href="#l35.1550"></a><span id="l35.1550" class="difflineplus">+    if (!this.view.dbView)</span>
<a href="#l35.1551"></a><span id="l35.1551" class="difflineplus">+      return 0;</span>
<a href="#l35.1552"></a><span id="l35.1552" class="difflineplus">+    return this.view.dbView.numSelected;</span>
<a href="#l35.1553"></a><span id="l35.1553" class="difflineplus">+  },</span>
<a href="#l35.1554"></a><span id="l35.1554" class="difflineplus">+</span>
<a href="#l35.1555"></a><span id="l35.1555" class="difflineplus">+  /**</span>
<a href="#l35.1556"></a><span id="l35.1556" class="difflineplus">+   * Provides a list of the view indices that are selected which is *not* the</span>
<a href="#l35.1557"></a><span id="l35.1557" class="difflineplus">+   *  same as the rows of the selected messages.  When the</span>
<a href="#l35.1558"></a><span id="l35.1558" class="difflineplus">+   *  &quot;mail.operate_on_msgs_in_collapsed_threads&quot; preference is enabled,</span>
<a href="#l35.1559"></a><span id="l35.1559" class="difflineplus">+   *  messages may be selected but not visible (because the thread root is</span>
<a href="#l35.1560"></a><span id="l35.1560" class="difflineplus">+   *  selected.)</span>
<a href="#l35.1561"></a><span id="l35.1561" class="difflineplus">+   * You probably want to use the |selectedMessages| attribute instead of this</span>
<a href="#l35.1562"></a><span id="l35.1562" class="difflineplus">+   *  one.  (Or selectedMessageUris in some rare cases.)</span>
<a href="#l35.1563"></a><span id="l35.1563" class="difflineplus">+   *</span>
<a href="#l35.1564"></a><span id="l35.1564" class="difflineplus">+   * If the user has right-clicked on a message, this will return that message</span>
<a href="#l35.1565"></a><span id="l35.1565" class="difflineplus">+   *  and not the selection prior to the right-click.</span>
<a href="#l35.1566"></a><span id="l35.1566" class="difflineplus">+   *</span>
<a href="#l35.1567"></a><span id="l35.1567" class="difflineplus">+   * @return a list of the view indices that are currently selected</span>
<a href="#l35.1568"></a><span id="l35.1568" class="difflineplus">+   */</span>
<a href="#l35.1569"></a><span id="l35.1569" class="difflineplus">+  get selectedIndices FolderDisplayWidget_get_selectedIndices() {</span>
<a href="#l35.1570"></a><span id="l35.1570" class="difflineplus">+    if (!this.view.dbView)</span>
<a href="#l35.1571"></a><span id="l35.1571" class="difflineplus">+      return [];</span>
<a href="#l35.1572"></a><span id="l35.1572" class="difflineplus">+</span>
<a href="#l35.1573"></a><span id="l35.1573" class="difflineplus">+    return this.view.dbView.getIndicesForSelection({});</span>
<a href="#l35.1574"></a><span id="l35.1574" class="difflineplus">+  },</span>
<a href="#l35.1575"></a><span id="l35.1575" class="difflineplus">+</span>
<a href="#l35.1576"></a><span id="l35.1576" class="difflineplus">+  /**</span>
<a href="#l35.1577"></a><span id="l35.1577" class="difflineplus">+   * Provides a list of the message headers for the currently selected messages.</span>
<a href="#l35.1578"></a><span id="l35.1578" class="difflineplus">+   *  If the &quot;mail.operate_on_msgs_in_collapsed_threads&quot; preference is enabled,</span>
<a href="#l35.1579"></a><span id="l35.1579" class="difflineplus">+   *  then any collapsed thread roots that are selected will also (conceptually)</span>
<a href="#l35.1580"></a><span id="l35.1580" class="difflineplus">+   *  have all of the messages in that thread selected and they will be included</span>
<a href="#l35.1581"></a><span id="l35.1581" class="difflineplus">+   *  in the returned list.</span>
<a href="#l35.1582"></a><span id="l35.1582" class="difflineplus">+   *</span>
<a href="#l35.1583"></a><span id="l35.1583" class="difflineplus">+   * If the user has right-clicked on a message, this will return that message</span>
<a href="#l35.1584"></a><span id="l35.1584" class="difflineplus">+   *  (and any collapsed children if so enabled) and not the selection prior to</span>
<a href="#l35.1585"></a><span id="l35.1585" class="difflineplus">+   *  the right-click.</span>
<a href="#l35.1586"></a><span id="l35.1586" class="difflineplus">+   *</span>
<a href="#l35.1587"></a><span id="l35.1587" class="difflineplus">+   * @return a list of the message headers for the currently selected messages.</span>
<a href="#l35.1588"></a><span id="l35.1588" class="difflineplus">+   *     If there are no selected messages, the result is an empty list.</span>
<a href="#l35.1589"></a><span id="l35.1589" class="difflineplus">+   */</span>
<a href="#l35.1590"></a><span id="l35.1590" class="difflineplus">+  get selectedMessages FolderDisplayWidget_get_selectedMessages() {</span>
<a href="#l35.1591"></a><span id="l35.1591" class="difflineplus">+    if (!this.view.dbView)</span>
<a href="#l35.1592"></a><span id="l35.1592" class="difflineplus">+      return [];</span>
<a href="#l35.1593"></a><span id="l35.1593" class="difflineplus">+    // getMsgHdrsForSelection returns an nsIMutableArray.  We want our callers</span>
<a href="#l35.1594"></a><span id="l35.1594" class="difflineplus">+    //  to have a user-friendly JS array and not have to worry about</span>
<a href="#l35.1595"></a><span id="l35.1595" class="difflineplus">+    //  QueryInterfacing the values (or needing to know to use fixIterator).</span>
<a href="#l35.1596"></a><span id="l35.1596" class="difflineplus">+    return [msgHdr for each</span>
<a href="#l35.1597"></a><span id="l35.1597" class="difflineplus">+              (msgHdr in fixIterator(</span>
<a href="#l35.1598"></a><span id="l35.1598" class="difflineplus">+                          this.view.dbView.getMsgHdrsForSelection().enumerate(),</span>
<a href="#l35.1599"></a><span id="l35.1599" class="difflineplus">+                          Components.interfaces.nsIMsgDBHdr))];</span>
<a href="#l35.1600"></a><span id="l35.1600" class="difflineplus">+  },</span>
<a href="#l35.1601"></a><span id="l35.1601" class="difflineplus">+</span>
<a href="#l35.1602"></a><span id="l35.1602" class="difflineplus">+  /**</span>
<a href="#l35.1603"></a><span id="l35.1603" class="difflineplus">+   * @return a list of the URIs for the currently selected messages or null</span>
<a href="#l35.1604"></a><span id="l35.1604" class="difflineplus">+   *     (instead of a list) if there are no selected messages.  Do not</span>
<a href="#l35.1605"></a><span id="l35.1605" class="difflineplus">+   *     pass around URIs unless you have a good reason.  Legacy code is an</span>
<a href="#l35.1606"></a><span id="l35.1606" class="difflineplus">+   *     ok reason.</span>
<a href="#l35.1607"></a><span id="l35.1607" class="difflineplus">+   *</span>
<a href="#l35.1608"></a><span id="l35.1608" class="difflineplus">+   * If the user has right-clicked on a message, this will return that message's</span>
<a href="#l35.1609"></a><span id="l35.1609" class="difflineplus">+   *  URI and not the selection prior to the right-click.</span>
<a href="#l35.1610"></a><span id="l35.1610" class="difflineplus">+   */</span>
<a href="#l35.1611"></a><span id="l35.1611" class="difflineplus">+  get selectedMessageUris FolderDisplayWidget_get_selectedMessageUris() {</span>
<a href="#l35.1612"></a><span id="l35.1612" class="difflineplus">+    if (!this.view.dbView)</span>
<a href="#l35.1613"></a><span id="l35.1613" class="difflineplus">+      return null;</span>
<a href="#l35.1614"></a><span id="l35.1614" class="difflineplus">+</span>
<a href="#l35.1615"></a><span id="l35.1615" class="difflineplus">+    let messageArray = this.view.dbView.getURIsForSelection({});</span>
<a href="#l35.1616"></a><span id="l35.1616" class="difflineplus">+    return messageArray.length ? messageArray : null;</span>
<a href="#l35.1617"></a><span id="l35.1617" class="difflineplus">+  },</span>
<a href="#l35.1618"></a><span id="l35.1618" class="difflineplus">+</span>
<a href="#l35.1619"></a><span id="l35.1619" class="difflineplus">+  /**</span>
<a href="#l35.1620"></a><span id="l35.1620" class="difflineplus">+   * Clear the tree selection, making sure the message pane is cleared and</span>
<a href="#l35.1621"></a><span id="l35.1621" class="difflineplus">+   *  the context display (toolbars, etc.) are updated.</span>
<a href="#l35.1622"></a><span id="l35.1622" class="difflineplus">+   */</span>
<a href="#l35.1623"></a><span id="l35.1623" class="difflineplus">+  clearSelection: function FolderDisplayWidget_clearSelection() {</span>
<a href="#l35.1624"></a><span id="l35.1624" class="difflineplus">+    let treeSelection = this.treeSelection; // potentially magic getter</span>
<a href="#l35.1625"></a><span id="l35.1625" class="difflineplus">+    if (!treeSelection)</span>
<a href="#l35.1626"></a><span id="l35.1626" class="difflineplus">+      return;</span>
<a href="#l35.1627"></a><span id="l35.1627" class="difflineplus">+    treeSelection.clearSelection();</span>
<a href="#l35.1628"></a><span id="l35.1628" class="difflineplus">+    this.messageDisplay.clearDisplay();</span>
<a href="#l35.1629"></a><span id="l35.1629" class="difflineplus">+    this._updateContextDisplay();</span>
<a href="#l35.1630"></a><span id="l35.1630" class="difflineplus">+  },</span>
<a href="#l35.1631"></a><span id="l35.1631" class="difflineplus">+</span>
<a href="#l35.1632"></a><span id="l35.1632" class="difflineplus">+  /**</span>
<a href="#l35.1633"></a><span id="l35.1633" class="difflineplus">+   * Select a message for display by header.  If the view is active, attempt</span>
<a href="#l35.1634"></a><span id="l35.1634" class="difflineplus">+   *  to select the message right now.  If the view is not active or we were</span>
<a href="#l35.1635"></a><span id="l35.1635" class="difflineplus">+   *  unable to find it, update our saved selection to want to display the</span>
<a href="#l35.1636"></a><span id="l35.1636" class="difflineplus">+   *  message.  Threads are expanded to find the header.</span>
<a href="#l35.1637"></a><span id="l35.1637" class="difflineplus">+   *</span>
<a href="#l35.1638"></a><span id="l35.1638" class="difflineplus">+   * @param aMsgHdr The message header to select for display.</span>
<a href="#l35.1639"></a><span id="l35.1639" class="difflineplus">+   */</span>
<a href="#l35.1640"></a><span id="l35.1640" class="difflineplus">+  selectMessage: function FolderDisplayWidget_selectMessage(aMsgHdr,</span>
<a href="#l35.1641"></a><span id="l35.1641" class="difflineplus">+      aForceNotification) {</span>
<a href="#l35.1642"></a><span id="l35.1642" class="difflineplus">+    if (this.active) {</span>
<a href="#l35.1643"></a><span id="l35.1643" class="difflineplus">+      let viewIndex = this.view.dbView.findIndexOfMsgHdr(aMsgHdr, true);</span>
<a href="#l35.1644"></a><span id="l35.1644" class="difflineplus">+      if (viewIndex != nsMsgViewIndex_None) {</span>
<a href="#l35.1645"></a><span id="l35.1645" class="difflineplus">+        this.selectViewIndex(viewIndex);</span>
<a href="#l35.1646"></a><span id="l35.1646" class="difflineplus">+        return;</span>
<a href="#l35.1647"></a><span id="l35.1647" class="difflineplus">+      }</span>
<a href="#l35.1648"></a><span id="l35.1648" class="difflineplus">+    }</span>
<a href="#l35.1649"></a><span id="l35.1649" class="difflineplus">+    this._savedSelection = [{messageId: aMsgHdr.messageId}];</span>
<a href="#l35.1650"></a><span id="l35.1650" class="difflineplus">+    // queue the selection to be restored once we become active if we are not</span>
<a href="#l35.1651"></a><span id="l35.1651" class="difflineplus">+    //  active.</span>
<a href="#l35.1652"></a><span id="l35.1652" class="difflineplus">+    if (!this.active)</span>
<a href="#l35.1653"></a><span id="l35.1653" class="difflineplus">+      this._notifyWhenActive(this._restoreSelection);</span>
<a href="#l35.1654"></a><span id="l35.1654" class="difflineplus">+  },</span>
<a href="#l35.1655"></a><span id="l35.1655" class="difflineplus">+</span>
<a href="#l35.1656"></a><span id="l35.1656" class="difflineplus">+  /**</span>
<a href="#l35.1657"></a><span id="l35.1657" class="difflineplus">+   * Select all of the provided nsIMsgDBHdrs in the aMessages array, expanding</span>
<a href="#l35.1658"></a><span id="l35.1658" class="difflineplus">+   *  threads as required.  If the view is not active, or we were not able to</span>
<a href="#l35.1659"></a><span id="l35.1659" class="difflineplus">+   *  find all of the messages, update our saved selection to want to display</span>
<a href="#l35.1660"></a><span id="l35.1660" class="difflineplus">+   *  the messages.  The messages will then be selected when we are made active</span>
<a href="#l35.1661"></a><span id="l35.1661" class="difflineplus">+   *  or all messages in the folder complete loading.  This is to accomodate the</span>
<a href="#l35.1662"></a><span id="l35.1662" class="difflineplus">+   *  use-case where we are backed by an in-progress search and no</span>
<a href="#l35.1663"></a><span id="l35.1663" class="difflineplus">+   *</span>
<a href="#l35.1664"></a><span id="l35.1664" class="difflineplus">+   * @param aMessages An array of nsIMsgDBHdr instances.</span>
<a href="#l35.1665"></a><span id="l35.1665" class="difflineplus">+   * @param aDoNotNeedToFindAll If true (can be omitted and left undefined), we</span>
<a href="#l35.1666"></a><span id="l35.1666" class="difflineplus">+   *     do not attempt to save the selection for future use.  This is intended</span>
<a href="#l35.1667"></a><span id="l35.1667" class="difflineplus">+   *     for use by the _restoreSelection call which is the end-of-the-line for</span>
<a href="#l35.1668"></a><span id="l35.1668" class="difflineplus">+   *     restoring the selection.  (Once it gets called all of our messages</span>
<a href="#l35.1669"></a><span id="l35.1669" class="difflineplus">+   *     should have already been loaded.)</span>
<a href="#l35.1670"></a><span id="l35.1670" class="difflineplus">+   */</span>
<a href="#l35.1671"></a><span id="l35.1671" class="difflineplus">+  selectMessages: function FolderDisplayWidget_selectMessages(</span>
<a href="#l35.1672"></a><span id="l35.1672" class="difflineplus">+    aMessages, aDoNotNeedToFindAll) {</span>
<a href="#l35.1673"></a><span id="l35.1673" class="difflineplus">+    if (this.active &amp;&amp; this.treeSelection) {</span>
<a href="#l35.1674"></a><span id="l35.1674" class="difflineplus">+      let foundAll = true;</span>
<a href="#l35.1675"></a><span id="l35.1675" class="difflineplus">+      let treeSelection = this.treeSelection;</span>
<a href="#l35.1676"></a><span id="l35.1676" class="difflineplus">+      let dbView = this.view.dbView;</span>
<a href="#l35.1677"></a><span id="l35.1677" class="difflineplus">+      let minRow = null, maxRow = null;</span>
<a href="#l35.1678"></a><span id="l35.1678" class="difflineplus">+</span>
<a href="#l35.1679"></a><span id="l35.1679" class="difflineplus">+      treeSelection.selectEventsSuppressed = true;</span>
<a href="#l35.1680"></a><span id="l35.1680" class="difflineplus">+      treeSelection.clearSelection();</span>
<a href="#l35.1681"></a><span id="l35.1681" class="difflineplus">+</span>
<a href="#l35.1682"></a><span id="l35.1682" class="difflineplus">+      for each (let [, msgHdr] in Iterator(aMessages)) {</span>
<a href="#l35.1683"></a><span id="l35.1683" class="difflineplus">+        let viewIndex = dbView.findIndexOfMsgHdr(msgHdr, true);</span>
<a href="#l35.1684"></a><span id="l35.1684" class="difflineplus">+        if (viewIndex != nsMsgViewIndex_None) {</span>
<a href="#l35.1685"></a><span id="l35.1685" class="difflineplus">+          if (minRow == null || viewIndex &lt; minRow)</span>
<a href="#l35.1686"></a><span id="l35.1686" class="difflineplus">+            minRow = viewIndex;</span>
<a href="#l35.1687"></a><span id="l35.1687" class="difflineplus">+          if (maxRow == null || viewIndex &gt; maxRow )</span>
<a href="#l35.1688"></a><span id="l35.1688" class="difflineplus">+            maxRow = viewIndex;</span>
<a href="#l35.1689"></a><span id="l35.1689" class="difflineplus">+          // nsTreeSelection is actually very clever about doing this</span>
<a href="#l35.1690"></a><span id="l35.1690" class="difflineplus">+          //  efficiently.</span>
<a href="#l35.1691"></a><span id="l35.1691" class="difflineplus">+          treeSelection.rangedSelect(viewIndex, viewIndex, true);</span>
<a href="#l35.1692"></a><span id="l35.1692" class="difflineplus">+        }</span>
<a href="#l35.1693"></a><span id="l35.1693" class="difflineplus">+        else {</span>
<a href="#l35.1694"></a><span id="l35.1694" class="difflineplus">+          foundAll = false;</span>
<a href="#l35.1695"></a><span id="l35.1695" class="difflineplus">+        }</span>
<a href="#l35.1696"></a><span id="l35.1696" class="difflineplus">+</span>
<a href="#l35.1697"></a><span id="l35.1697" class="difflineplus">+        // make sure the selection is as visible as possible</span>
<a href="#l35.1698"></a><span id="l35.1698" class="difflineplus">+        if (minRow != null)</span>
<a href="#l35.1699"></a><span id="l35.1699" class="difflineplus">+          this.ensureRowRangeIsVisible(minRow, maxRow);</span>
<a href="#l35.1700"></a><span id="l35.1700" class="difflineplus">+      }</span>
<a href="#l35.1701"></a><span id="l35.1701" class="difflineplus">+</span>
<a href="#l35.1702"></a><span id="l35.1702" class="difflineplus">+      treeSelection.selectEventsSuppressed = false;</span>
<a href="#l35.1703"></a><span id="l35.1703" class="difflineplus">+</span>
<a href="#l35.1704"></a><span id="l35.1704" class="difflineplus">+      if (!aDoNotNeedToFindAll || foundAll)</span>
<a href="#l35.1705"></a><span id="l35.1705" class="difflineplus">+        return;</span>
<a href="#l35.1706"></a><span id="l35.1706" class="difflineplus">+    }</span>
<a href="#l35.1707"></a><span id="l35.1707" class="difflineplus">+    this._savedSelection = [{messageId: msgHdr.messageId} for each</span>
<a href="#l35.1708"></a><span id="l35.1708" class="difflineplus">+                            ([, msgHdr] in Iterator(aMessages))];</span>
<a href="#l35.1709"></a><span id="l35.1709" class="difflineplus">+    if (!this.active)</span>
<a href="#l35.1710"></a><span id="l35.1710" class="difflineplus">+      this._notifyWhenActive(this._restoreSelection);</span>
<a href="#l35.1711"></a><span id="l35.1711" class="difflineplus">+  },</span>
<a href="#l35.1712"></a><span id="l35.1712" class="difflineplus">+</span>
<a href="#l35.1713"></a><span id="l35.1713" class="difflineplus">+  /**</span>
<a href="#l35.1714"></a><span id="l35.1714" class="difflineplus">+   * Select the message at view index.</span>
<a href="#l35.1715"></a><span id="l35.1715" class="difflineplus">+   *</span>
<a href="#l35.1716"></a><span id="l35.1716" class="difflineplus">+   * @param aViewIndex The view index to select.  This will be bounds-checked</span>
<a href="#l35.1717"></a><span id="l35.1717" class="difflineplus">+   *     and if it is outside the bounds, we will clear the selection and</span>
<a href="#l35.1718"></a><span id="l35.1718" class="difflineplus">+   *     bail.</span>
<a href="#l35.1719"></a><span id="l35.1719" class="difflineplus">+   */</span>
<a href="#l35.1720"></a><span id="l35.1720" class="difflineplus">+  selectViewIndex: function FolderDisplayWidget_selectViewIndex(aViewIndex) {</span>
<a href="#l35.1721"></a><span id="l35.1721" class="difflineplus">+    let treeSelection = this.treeSelection;</span>
<a href="#l35.1722"></a><span id="l35.1722" class="difflineplus">+    // if we have no selection, we can't select something</span>
<a href="#l35.1723"></a><span id="l35.1723" class="difflineplus">+    if (!treeSelection)</span>
<a href="#l35.1724"></a><span id="l35.1724" class="difflineplus">+      return;</span>
<a href="#l35.1725"></a><span id="l35.1725" class="difflineplus">+    let rowCount = this.view.dbView.rowCount;</span>
<a href="#l35.1726"></a><span id="l35.1726" class="difflineplus">+    if ((aViewIndex == nsMsgViewIndex_None) ||</span>
<a href="#l35.1727"></a><span id="l35.1727" class="difflineplus">+        (aViewIndex &lt; 0) || (aViewIndex &gt;= rowCount)) {</span>
<a href="#l35.1728"></a><span id="l35.1728" class="difflineplus">+      this.clearSelection();</span>
<a href="#l35.1729"></a><span id="l35.1729" class="difflineplus">+      return;</span>
<a href="#l35.1730"></a><span id="l35.1730" class="difflineplus">+    }</span>
<a href="#l35.1731"></a><span id="l35.1731" class="difflineplus">+</span>
<a href="#l35.1732"></a><span id="l35.1732" class="difflineplus">+    // Check whether the index is already selected/current.  This can be the</span>
<a href="#l35.1733"></a><span id="l35.1733" class="difflineplus">+    //  case when we are here as the result of a deletion.  Assuming</span>
<a href="#l35.1734"></a><span id="l35.1734" class="difflineplus">+    //  nsMsgDBView::NoteChange ran and was not suppressing change</span>
<a href="#l35.1735"></a><span id="l35.1735" class="difflineplus">+    //  notifications, then it's very possible the selection is already where</span>
<a href="#l35.1736"></a><span id="l35.1736" class="difflineplus">+    //  we want it to go.  However, in that case, nsMsgDBView::SelectionChanged</span>
<a href="#l35.1737"></a><span id="l35.1737" class="difflineplus">+    //  bailed without doing anything because m_deletingRows...</span>
<a href="#l35.1738"></a><span id="l35.1738" class="difflineplus">+    // So we want to generate a change notification if that is the case. (And</span>
<a href="#l35.1739"></a><span id="l35.1739" class="difflineplus">+    //  we still want to call ensureRowIsVisible, as there may be padding</span>
<a href="#l35.1740"></a><span id="l35.1740" class="difflineplus">+    //  required.)</span>
<a href="#l35.1741"></a><span id="l35.1741" class="difflineplus">+    if ((treeSelection.count == 1) &amp;&amp;</span>
<a href="#l35.1742"></a><span id="l35.1742" class="difflineplus">+        ((treeSelection.currentIndex == aViewIndex) ||</span>
<a href="#l35.1743"></a><span id="l35.1743" class="difflineplus">+         treeSelection.isSelected(aViewIndex))) {</span>
<a href="#l35.1744"></a><span id="l35.1744" class="difflineplus">+      // Make sure the index we just selected is also the current index.</span>
<a href="#l35.1745"></a><span id="l35.1745" class="difflineplus">+      //  This can happen when the tree selection adjusts itself as a result of</span>
<a href="#l35.1746"></a><span id="l35.1746" class="difflineplus">+      //  changes to the tree as a result of deletion.  This will not trigger</span>
<a href="#l35.1747"></a><span id="l35.1747" class="difflineplus">+      //  a notification.</span>
<a href="#l35.1748"></a><span id="l35.1748" class="difflineplus">+      treeSelection.select(aViewIndex);</span>
<a href="#l35.1749"></a><span id="l35.1749" class="difflineplus">+      this.view.dbView.selectionChanged();</span>
<a href="#l35.1750"></a><span id="l35.1750" class="difflineplus">+    }</span>
<a href="#l35.1751"></a><span id="l35.1751" class="difflineplus">+    // Previous code was concerned about avoiding updating commands on the</span>
<a href="#l35.1752"></a><span id="l35.1752" class="difflineplus">+    //  assumption that only the selection count mattered.  We no longer</span>
<a href="#l35.1753"></a><span id="l35.1753" class="difflineplus">+    //  make this assumption.</span>
<a href="#l35.1754"></a><span id="l35.1754" class="difflineplus">+    // Things that may surprise you about the call to treeSelection.select:</span>
<a href="#l35.1755"></a><span id="l35.1755" class="difflineplus">+    // 1) This ends up calling the onselect method defined on the XUL 'tree'</span>
<a href="#l35.1756"></a><span id="l35.1756" class="difflineplus">+    //    tag.  For the 3pane this is the ThreadPaneSelectionChanged method in</span>
<a href="#l35.1757"></a><span id="l35.1757" class="difflineplus">+    //    threadPane.js.  That code checks a global to see if it is dealing</span>
<a href="#l35.1758"></a><span id="l35.1758" class="difflineplus">+    //    with a right-click, and ignores it if so.</span>
<a href="#l35.1759"></a><span id="l35.1759" class="difflineplus">+    else {</span>
<a href="#l35.1760"></a><span id="l35.1760" class="difflineplus">+      treeSelection.select(aViewIndex);</span>
<a href="#l35.1761"></a><span id="l35.1761" class="difflineplus">+    }</span>
<a href="#l35.1762"></a><span id="l35.1762" class="difflineplus">+</span>
<a href="#l35.1763"></a><span id="l35.1763" class="difflineplus">+    this.ensureRowIsVisible(aViewIndex);</span>
<a href="#l35.1764"></a><span id="l35.1764" class="difflineplus">+  },</span>
<a href="#l35.1765"></a><span id="l35.1765" class="difflineplus">+</span>
<a href="#l35.1766"></a><span id="l35.1766" class="difflineplus">+  /**</span>
<a href="#l35.1767"></a><span id="l35.1767" class="difflineplus">+   * For every selected message in the display that is part of a (displayed)</span>
<a href="#l35.1768"></a><span id="l35.1768" class="difflineplus">+   *  thread and is not the root message, de-select it and ensure that the</span>
<a href="#l35.1769"></a><span id="l35.1769" class="difflineplus">+   *  root message of the thread is selected.</span>
<a href="#l35.1770"></a><span id="l35.1770" class="difflineplus">+   * This is primarily intended to be used when collapsing visible threads.</span>
<a href="#l35.1771"></a><span id="l35.1771" class="difflineplus">+   *</span>
<a href="#l35.1772"></a><span id="l35.1772" class="difflineplus">+   * We do nothing if we are not in a threaded display mode.</span>
<a href="#l35.1773"></a><span id="l35.1773" class="difflineplus">+   */</span>
<a href="#l35.1774"></a><span id="l35.1774" class="difflineplus">+  selectSelectedThreadRoots:</span>
<a href="#l35.1775"></a><span id="l35.1775" class="difflineplus">+      function FolderDisplayWidget_selectSelectedThreadRoots() {</span>
<a href="#l35.1776"></a><span id="l35.1776" class="difflineplus">+    if (!this.view.showThreaded)</span>
<a href="#l35.1777"></a><span id="l35.1777" class="difflineplus">+      return;</span>
<a href="#l35.1778"></a><span id="l35.1778" class="difflineplus">+</span>
<a href="#l35.1779"></a><span id="l35.1779" class="difflineplus">+    // There are basically two implementation strategies available to us:</span>
<a href="#l35.1780"></a><span id="l35.1780" class="difflineplus">+    // 1) For each selected view index with a level &gt; 0, keep walking 'up'</span>
<a href="#l35.1781"></a><span id="l35.1781" class="difflineplus">+    //    (numerically smaller) until we find a message with level 0.</span>
<a href="#l35.1782"></a><span id="l35.1782" class="difflineplus">+    //    The inefficiency here is the potentially large number of JS calls</span>
<a href="#l35.1783"></a><span id="l35.1783" class="difflineplus">+    //    into XPCOM space that will be required.</span>
<a href="#l35.1784"></a><span id="l35.1784" class="difflineplus">+    // 2) Ask for the thread that each view index belongs to, use that to</span>
<a href="#l35.1785"></a><span id="l35.1785" class="difflineplus">+    //    efficiently retrieve the thread root, then find the root using</span>
<a href="#l35.1786"></a><span id="l35.1786" class="difflineplus">+    //    the message header.  The inefficiency here is that the view</span>
<a href="#l35.1787"></a><span id="l35.1787" class="difflineplus">+    //    currently does a linear scan, albeit a relatively efficient one.</span>
<a href="#l35.1788"></a><span id="l35.1788" class="difflineplus">+    // And the winner is... option 2, because the code is simpler because we</span>
<a href="#l35.1789"></a><span id="l35.1789" class="difflineplus">+    //  can reuse selectMessages to do most of the work.</span>
<a href="#l35.1790"></a><span id="l35.1790" class="difflineplus">+    let selectedIndices = this.selectedIndices;</span>
<a href="#l35.1791"></a><span id="l35.1791" class="difflineplus">+    let newSelectedMessages = [];</span>
<a href="#l35.1792"></a><span id="l35.1792" class="difflineplus">+    let dbView = this.view.dbView;</span>
<a href="#l35.1793"></a><span id="l35.1793" class="difflineplus">+    for each (let [, index] in Iterator(selectedIndices)) {</span>
<a href="#l35.1794"></a><span id="l35.1794" class="difflineplus">+      let thread = dbView.getThreadContainingIndex(index);</span>
<a href="#l35.1795"></a><span id="l35.1795" class="difflineplus">+      // We use getChildHdrAt instead of getRootHdr because getRootHdr has</span>
<a href="#l35.1796"></a><span id="l35.1796" class="difflineplus">+      //  a useless out-param and just calls getChildHdrAt anyways.</span>
<a href="#l35.1797"></a><span id="l35.1797" class="difflineplus">+      newSelectedMessages.push(thread.getChildHdrAt(0));</span>
<a href="#l35.1798"></a><span id="l35.1798" class="difflineplus">+    }</span>
<a href="#l35.1799"></a><span id="l35.1799" class="difflineplus">+    this.selectMessages(newSelectedMessages);</span>
<a href="#l35.1800"></a><span id="l35.1800" class="difflineplus">+  },</span>
<a href="#l35.1801"></a><span id="l35.1801" class="difflineplus">+</span>
<a href="#l35.1802"></a><span id="l35.1802" class="difflineplus">+  /**</span>
<a href="#l35.1803"></a><span id="l35.1803" class="difflineplus">+   * Number of padding messages before the 'focused' message when it is at the</span>
<a href="#l35.1804"></a><span id="l35.1804" class="difflineplus">+   *  top of the thread pane.</span>
<a href="#l35.1805"></a><span id="l35.1805" class="difflineplus">+   */</span>
<a href="#l35.1806"></a><span id="l35.1806" class="difflineplus">+  TOP_VIEW_PADDING: 1,</span>
<a href="#l35.1807"></a><span id="l35.1807" class="difflineplus">+  /**</span>
<a href="#l35.1808"></a><span id="l35.1808" class="difflineplus">+   * Number of padding messages after the 'focused' message when it is at the</span>
<a href="#l35.1809"></a><span id="l35.1809" class="difflineplus">+   *  bottom of the thread pane and lip padding does not apply.</span>
<a href="#l35.1810"></a><span id="l35.1810" class="difflineplus">+   */</span>
<a href="#l35.1811"></a><span id="l35.1811" class="difflineplus">+  BOTTOM_VIEW_PADDING: 1,</span>
<a href="#l35.1812"></a><span id="l35.1812" class="difflineplus">+</span>
<a href="#l35.1813"></a><span id="l35.1813" class="difflineplus">+  /**</span>
<a href="#l35.1814"></a><span id="l35.1814" class="difflineplus">+   * Ensure the given view index is visible, preferably with some padding.</span>
<a href="#l35.1815"></a><span id="l35.1815" class="difflineplus">+   * By padding, we mean that the index will not be the first or last message</span>
<a href="#l35.1816"></a><span id="l35.1816" class="difflineplus">+   *  displayed, but rather have messages on either side.</span>
<a href="#l35.1817"></a><span id="l35.1817" class="difflineplus">+   * If we get near the end of the list of messages, we 'snap' to the last page</span>
<a href="#l35.1818"></a><span id="l35.1818" class="difflineplus">+   *  of messages.  The intent is that we later implement a</span>
<a href="#l35.1819"></a><span id="l35.1819" class="difflineplus">+   * We have the concept of a 'lip' when we are at the end of the message</span>
<a href="#l35.1820"></a><span id="l35.1820" class="difflineplus">+   *  display.  If we are near the end of the display, we want to show an</span>
<a href="#l35.1821"></a><span id="l35.1821" class="difflineplus">+   *  empty row (at the bottom) so the user knows they are at the end.  Also,</span>
<a href="#l35.1822"></a><span id="l35.1822" class="difflineplus">+   *  if a message shows up that is new and things are sorted ascending, this</span>
<a href="#l35.1823"></a><span id="l35.1823" class="difflineplus">+   *  turns out to be useful.</span>
<a href="#l35.1824"></a><span id="l35.1824" class="difflineplus">+   */</span>
<a href="#l35.1825"></a><span id="l35.1825" class="difflineplus">+  ensureRowIsVisible: function FolderDisplayWidget_ensureRowIsVisible(</span>
<a href="#l35.1826"></a><span id="l35.1826" class="difflineplus">+      aViewIndex, aBounced) {</span>
<a href="#l35.1827"></a><span id="l35.1827" class="difflineplus">+    // Dealing with the tree view layout is a nightmare, let's just always make</span>
<a href="#l35.1828"></a><span id="l35.1828" class="difflineplus">+    //  sure we re-schedule ourselves.  The most particular rationale here is</span>
<a href="#l35.1829"></a><span id="l35.1829" class="difflineplus">+    //  that the message pane may be toggling its state and it's much simpler</span>
<a href="#l35.1830"></a><span id="l35.1830" class="difflineplus">+    //  and reliable if we ensure that all of FolderDisplayWidget's state</span>
<a href="#l35.1831"></a><span id="l35.1831" class="difflineplus">+    //  change logic gets to run to completion before we run ourselves.</span>
<a href="#l35.1832"></a><span id="l35.1832" class="difflineplus">+    if (!aBounced) {</span>
<a href="#l35.1833"></a><span id="l35.1833" class="difflineplus">+      let dis = this;</span>
<a href="#l35.1834"></a><span id="l35.1834" class="difflineplus">+      window.setTimeout(function() {</span>
<a href="#l35.1835"></a><span id="l35.1835" class="difflineplus">+          dis.ensureRowIsVisible(aViewIndex, true);</span>
<a href="#l35.1836"></a><span id="l35.1836" class="difflineplus">+        }, 0);</span>
<a href="#l35.1837"></a><span id="l35.1837" class="difflineplus">+    }</span>
<a href="#l35.1838"></a><span id="l35.1838" class="difflineplus">+</span>
<a href="#l35.1839"></a><span id="l35.1839" class="difflineplus">+    let treeBox = this.treeBox;</span>
<a href="#l35.1840"></a><span id="l35.1840" class="difflineplus">+    if (!treeBox)</span>
<a href="#l35.1841"></a><span id="l35.1841" class="difflineplus">+      return;</span>
<a href="#l35.1842"></a><span id="l35.1842" class="difflineplus">+</span>
<a href="#l35.1843"></a><span id="l35.1843" class="difflineplus">+    // try and trigger a reflow...</span>
<a href="#l35.1844"></a><span id="l35.1844" class="difflineplus">+    treeBox.height;</span>
<a href="#l35.1845"></a><span id="l35.1845" class="difflineplus">+</span>
<a href="#l35.1846"></a><span id="l35.1846" class="difflineplus">+    let maxIndex = this.view.dbView.rowCount - 1;</span>
<a href="#l35.1847"></a><span id="l35.1847" class="difflineplus">+</span>
<a href="#l35.1848"></a><span id="l35.1848" class="difflineplus">+    let first = treeBox.getFirstVisibleRow();</span>
<a href="#l35.1849"></a><span id="l35.1849" class="difflineplus">+    // Assume the bottom row is half-visible and should generally be ignored.</span>
<a href="#l35.1850"></a><span id="l35.1850" class="difflineplus">+    // (We could actually do the legwork to see if there is a partial one...)</span>
<a href="#l35.1851"></a><span id="l35.1851" class="difflineplus">+    const halfVisible = 1;</span>
<a href="#l35.1852"></a><span id="l35.1852" class="difflineplus">+    let last  = treeBox.getLastVisibleRow() - halfVisible;</span>
<a href="#l35.1853"></a><span id="l35.1853" class="difflineplus">+    let span = treeBox.getPageLength() - halfVisible;</span>
<a href="#l35.1854"></a><span id="l35.1854" class="difflineplus">+</span>
<a href="#l35.1855"></a><span id="l35.1855" class="difflineplus">+    let target;</span>
<a href="#l35.1856"></a><span id="l35.1856" class="difflineplus">+    // If the index is near the end, try and latch on to the bottom.</span>
<a href="#l35.1857"></a><span id="l35.1857" class="difflineplus">+    if (aViewIndex + span - this.TOP_VIEW_PADDING &gt; maxIndex)</span>
<a href="#l35.1858"></a><span id="l35.1858" class="difflineplus">+      target = maxIndex - span;</span>
<a href="#l35.1859"></a><span id="l35.1859" class="difflineplus">+    // If the index is after the last visible guy (with padding), move down</span>
<a href="#l35.1860"></a><span id="l35.1860" class="difflineplus">+    //  so that the target index is padded in 1 from the bottom.</span>
<a href="#l35.1861"></a><span id="l35.1861" class="difflineplus">+    else if (aViewIndex &gt;= last - this.BOTTOM_VIEW_PADDING)</span>
<a href="#l35.1862"></a><span id="l35.1862" class="difflineplus">+      target = Math.min(maxIndex, aViewIndex + this.BOTTOM_VIEW_PADDING) -</span>
<a href="#l35.1863"></a><span id="l35.1863" class="difflineplus">+                 span;</span>
<a href="#l35.1864"></a><span id="l35.1864" class="difflineplus">+    // If the index is before the first visible guy (with padding), move up</span>
<a href="#l35.1865"></a><span id="l35.1865" class="difflineplus">+    else if (aViewIndex &lt;= first + this.TOP_VIEW_PADDING)  // move up</span>
<a href="#l35.1866"></a><span id="l35.1866" class="difflineplus">+      target = Math.max(0, aViewIndex - this.TOP_VIEW_PADDING);</span>
<a href="#l35.1867"></a><span id="l35.1867" class="difflineplus">+    else // it is already visible</span>
<a href="#l35.1868"></a><span id="l35.1868" class="difflineplus">+      return;</span>
<a href="#l35.1869"></a><span id="l35.1869" class="difflineplus">+</span>
<a href="#l35.1870"></a><span id="l35.1870" class="difflineplus">+    // this sets the first visible row</span>
<a href="#l35.1871"></a><span id="l35.1871" class="difflineplus">+    treeBox.scrollToRow(target);</span>
<a href="#l35.1872"></a><span id="l35.1872" class="difflineplus">+  },</span>
<a href="#l35.1873"></a><span id="l35.1873" class="difflineplus">+</span>
<a href="#l35.1874"></a><span id="l35.1874" class="difflineplus">+  /**</span>
<a href="#l35.1875"></a><span id="l35.1875" class="difflineplus">+   * Ensure that the given range of rows is visible maximally visible in the</span>
<a href="#l35.1876"></a><span id="l35.1876" class="difflineplus">+   *  thread pane.  If the range is larger than the number of rows that can be</span>
<a href="#l35.1877"></a><span id="l35.1877" class="difflineplus">+   *  displayed in the thread pane, we bias towards showing the min row (with</span>
<a href="#l35.1878"></a><span id="l35.1878" class="difflineplus">+   *  padding).</span>
<a href="#l35.1879"></a><span id="l35.1879" class="difflineplus">+   *</span>
<a href="#l35.1880"></a><span id="l35.1880" class="difflineplus">+   * @param aMinRow The numerically smallest row index defining the start of</span>
<a href="#l35.1881"></a><span id="l35.1881" class="difflineplus">+   *     the inclusive range.</span>
<a href="#l35.1882"></a><span id="l35.1882" class="difflineplus">+   * @param aMaxRow The numberically largest row index defining the end of the</span>
<a href="#l35.1883"></a><span id="l35.1883" class="difflineplus">+   *     inclusive range.</span>
<a href="#l35.1884"></a><span id="l35.1884" class="difflineplus">+   */</span>
<a href="#l35.1885"></a><span id="l35.1885" class="difflineplus">+  ensureRowRangeIsVisible:</span>
<a href="#l35.1886"></a><span id="l35.1886" class="difflineplus">+      function FolderDisplayWidget_ensureRowRangeIsVisible(aMinRow, aMaxRow,</span>
<a href="#l35.1887"></a><span id="l35.1887" class="difflineplus">+                                                           aBounced) {</span>
<a href="#l35.1888"></a><span id="l35.1888" class="difflineplus">+    // Dealing with the tree view layout is a nightmare, let's just always make</span>
<a href="#l35.1889"></a><span id="l35.1889" class="difflineplus">+    //  sure we re-schedule ourselves.  The most particular rationale here is</span>
<a href="#l35.1890"></a><span id="l35.1890" class="difflineplus">+    //  that the message pane may be toggling its state and it's much simpler</span>
<a href="#l35.1891"></a><span id="l35.1891" class="difflineplus">+    //  and reliable if we ensure that all of FolderDisplayWidget's state</span>
<a href="#l35.1892"></a><span id="l35.1892" class="difflineplus">+    //  change logic gets to run to completion before we run ourselves.</span>
<a href="#l35.1893"></a><span id="l35.1893" class="difflineplus">+    if (!aBounced) {</span>
<a href="#l35.1894"></a><span id="l35.1894" class="difflineplus">+      let dis = this;</span>
<a href="#l35.1895"></a><span id="l35.1895" class="difflineplus">+      window.setTimeout(function() {</span>
<a href="#l35.1896"></a><span id="l35.1896" class="difflineplus">+          dis.ensureRowRangeIsVisible(aMinRow, aMaxRow, true);</span>
<a href="#l35.1897"></a><span id="l35.1897" class="difflineplus">+        }, 0);</span>
<a href="#l35.1898"></a><span id="l35.1898" class="difflineplus">+    }</span>
<a href="#l35.1899"></a><span id="l35.1899" class="difflineplus">+</span>
<a href="#l35.1900"></a><span id="l35.1900" class="difflineplus">+    let treeBox = this.treeBox;</span>
<a href="#l35.1901"></a><span id="l35.1901" class="difflineplus">+    if (!treeBox)</span>
<a href="#l35.1902"></a><span id="l35.1902" class="difflineplus">+      return;</span>
<a href="#l35.1903"></a><span id="l35.1903" class="difflineplus">+    let first = treeBox.getFirstVisibleRow();</span>
<a href="#l35.1904"></a><span id="l35.1904" class="difflineplus">+    const halfVisible = 1;</span>
<a href="#l35.1905"></a><span id="l35.1905" class="difflineplus">+    let last  = treeBox.getLastVisibleRow() - halfVisible;</span>
<a href="#l35.1906"></a><span id="l35.1906" class="difflineplus">+    let span = treeBox.getPageLength() - halfVisible;</span>
<a href="#l35.1907"></a><span id="l35.1907" class="difflineplus">+</span>
<a href="#l35.1908"></a><span id="l35.1908" class="difflineplus">+    // bail if the range is already visible with padding constraints handled</span>
<a href="#l35.1909"></a><span id="l35.1909" class="difflineplus">+    if ((first + this.TOP_VIEW_PADDING &lt;= aMinRow) &amp;&amp;</span>
<a href="#l35.1910"></a><span id="l35.1910" class="difflineplus">+        (last - this.BOTTOM_VIEW_PADDING &gt;= aMaxRow))</span>
<a href="#l35.1911"></a><span id="l35.1911" class="difflineplus">+      return;</span>
<a href="#l35.1912"></a><span id="l35.1912" class="difflineplus">+</span>
<a href="#l35.1913"></a><span id="l35.1913" class="difflineplus">+    let target;</span>
<a href="#l35.1914"></a><span id="l35.1914" class="difflineplus">+    // if the range is bigger than we can fit, optimize position for the min row</span>
<a href="#l35.1915"></a><span id="l35.1915" class="difflineplus">+    //  with padding to make it obvious the range doesn't extend above the row.</span>
<a href="#l35.1916"></a><span id="l35.1916" class="difflineplus">+    if (aMaxRow - aMinRow &gt; span)</span>
<a href="#l35.1917"></a><span id="l35.1917" class="difflineplus">+      target = Math.max(0, aMinRow - this.TOP_VIEW_PADDING);</span>
<a href="#l35.1918"></a><span id="l35.1918" class="difflineplus">+    // So the range must fit, and it's a question of how we want to position it.</span>
<a href="#l35.1919"></a><span id="l35.1919" class="difflineplus">+    // For now, the answer is we try and center it, why not.</span>
<a href="#l35.1920"></a><span id="l35.1920" class="difflineplus">+    else {</span>
<a href="#l35.1921"></a><span id="l35.1921" class="difflineplus">+      let rowSpan = aMaxRow - aMinRow + 1;</span>
<a href="#l35.1922"></a><span id="l35.1922" class="difflineplus">+      let halfSpare = parseInt((span - rowSpan - this.TOP_VIEW_PADDING -</span>
<a href="#l35.1923"></a><span id="l35.1923" class="difflineplus">+                                this.BOTTOM_VIEW_PADDING) / 2);</span>
<a href="#l35.1924"></a><span id="l35.1924" class="difflineplus">+      target = aMinRow - halfSpare - this.TOP_VIEW_PADDING;</span>
<a href="#l35.1925"></a><span id="l35.1925" class="difflineplus">+    }</span>
<a href="#l35.1926"></a><span id="l35.1926" class="difflineplus">+    treeBox.scrollToRow(target);</span>
<a href="#l35.1927"></a><span id="l35.1927" class="difflineplus">+  },</span>
<a href="#l35.1928"></a><span id="l35.1928" class="difflineplus">+</span>
<a href="#l35.1929"></a><span id="l35.1929" class="difflineplus">+  /**</span>
<a href="#l35.1930"></a><span id="l35.1930" class="difflineplus">+   * Ensure that the selection is visible to the extent possible.</span>
<a href="#l35.1931"></a><span id="l35.1931" class="difflineplus">+   */</span>
<a href="#l35.1932"></a><span id="l35.1932" class="difflineplus">+  ensureSelectionIsVisible:</span>
<a href="#l35.1933"></a><span id="l35.1933" class="difflineplus">+      function FolderDisplayWidget_ensureSelectionIsVisible() {</span>
<a href="#l35.1934"></a><span id="l35.1934" class="difflineplus">+    let treeSelection = this.treeSelection; // potentially magic getter</span>
<a href="#l35.1935"></a><span id="l35.1935" class="difflineplus">+    if (!treeSelection || !treeSelection.count)</span>
<a href="#l35.1936"></a><span id="l35.1936" class="difflineplus">+      return;</span>
<a href="#l35.1937"></a><span id="l35.1937" class="difflineplus">+</span>
<a href="#l35.1938"></a><span id="l35.1938" class="difflineplus">+    let minRow = null, maxRow = null;</span>
<a href="#l35.1939"></a><span id="l35.1939" class="difflineplus">+</span>
<a href="#l35.1940"></a><span id="l35.1940" class="difflineplus">+    let rangeCount = treeSelection.getRangeCount();</span>
<a href="#l35.1941"></a><span id="l35.1941" class="difflineplus">+    for (let iRange = 0; iRange &lt; rangeCount; iRange++) {</span>
<a href="#l35.1942"></a><span id="l35.1942" class="difflineplus">+      let rangeMinObj = {}, rangeMaxObj = {};</span>
<a href="#l35.1943"></a><span id="l35.1943" class="difflineplus">+      treeSelection.getRangeAt(iRange, rangeMinObj, rangeMaxObj);</span>
<a href="#l35.1944"></a><span id="l35.1944" class="difflineplus">+      let rangeMin = rangeMinObj.value, rangeMax = rangeMaxObj.value;</span>
<a href="#l35.1945"></a><span id="l35.1945" class="difflineplus">+      if (minRow == null || rangeMin &lt; minRow)</span>
<a href="#l35.1946"></a><span id="l35.1946" class="difflineplus">+        minRow = rangeMin;</span>
<a href="#l35.1947"></a><span id="l35.1947" class="difflineplus">+      if (maxRow == null || rangeMax &gt; maxRow )</span>
<a href="#l35.1948"></a><span id="l35.1948" class="difflineplus">+        maxRow = rangeMax;</span>
<a href="#l35.1949"></a><span id="l35.1949" class="difflineplus">+    }</span>
<a href="#l35.1950"></a><span id="l35.1950" class="difflineplus">+</span>
<a href="#l35.1951"></a><span id="l35.1951" class="difflineplus">+    this.ensureRowRangeIsVisible(minRow, maxRow);</span>
<a href="#l35.1952"></a><span id="l35.1952" class="difflineplus">+  }</span>
<a href="#l35.1953"></a><span id="l35.1953" class="difflineplus">+};</span>
<a href="#l35.1954"></a><span id="l35.1954" class="difflineplus">+</span>
<a href="#l35.1955"></a><span id="l35.1955" class="difflineplus">+/**</span>
<a href="#l35.1956"></a><span id="l35.1956" class="difflineplus">+ * Implement a fake nsITreeBoxObject so that we can keep the view</span>
<a href="#l35.1957"></a><span id="l35.1957" class="difflineplus">+ *  nsITreeSelection selections 'live' when they are in the background.  We need</span>
<a href="#l35.1958"></a><span id="l35.1958" class="difflineplus">+ *  to do this because nsTreeSelection changes its behaviour (and gets ornery)</span>
<a href="#l35.1959"></a><span id="l35.1959" class="difflineplus">+ *  if it does not have a box object.</span>
<a href="#l35.1960"></a><span id="l35.1960" class="difflineplus">+ * This does not need to exist once we abandon multiplexed tabbing.</span>
<a href="#l35.1961"></a><span id="l35.1961" class="difflineplus">+ *</span>
<a href="#l35.1962"></a><span id="l35.1962" class="difflineplus">+ * Sometimes, nsTreeSelection tries to turn us into an nsIBoxObject and then in</span>
<a href="#l35.1963"></a><span id="l35.1963" class="difflineplus">+ *  turn get the associated element, and then create DOM events on that.  We</span>
<a href="#l35.1964"></a><span id="l35.1964" class="difflineplus">+ *  can't really stop that, but we can use misdirection to tell it about a box</span>
<a href="#l35.1965"></a><span id="l35.1965" class="difflineplus">+ *  object that we don't care about.  That way it gets the bogus events,</span>
<a href="#l35.1966"></a><span id="l35.1966" class="difflineplus">+ *  effectively blackholing them.</span>
<a href="#l35.1967"></a><span id="l35.1967" class="difflineplus">+ */</span>
<a href="#l35.1968"></a><span id="l35.1968" class="difflineplus">+function FakeTreeBoxObject(aDummyBoxObject) {</span>
<a href="#l35.1969"></a><span id="l35.1969" class="difflineplus">+  this.dummyBoxObject = aDummyBoxObject.QueryInterface(</span>
<a href="#l35.1970"></a><span id="l35.1970" class="difflineplus">+                          Components.interfaces.nsIBoxObject);</span>
<a href="#l35.1971"></a><span id="l35.1971" class="difflineplus">+  this.view = null;</span>
<a href="#l35.1972"></a><span id="l35.1972" class="difflineplus">+}</span>
<a href="#l35.1973"></a><span id="l35.1973" class="difflineplus">+FakeTreeBoxObject.prototype = {</span>
<a href="#l35.1974"></a><span id="l35.1974" class="difflineplus">+  view: null,</span>
<a href="#l35.1975"></a><span id="l35.1975" class="difflineplus">+  /**</span>
<a href="#l35.1976"></a><span id="l35.1976" class="difflineplus">+   * No need to actually invalidate, as when we re-root the view this will</span>
<a href="#l35.1977"></a><span id="l35.1977" class="difflineplus">+   *  happen.</span>
<a href="#l35.1978"></a><span id="l35.1978" class="difflineplus">+   */</span>
<a href="#l35.1979"></a><span id="l35.1979" class="difflineplus">+  invalidate: function FakeTreeBoxObject_invalidate() {</span>
<a href="#l35.1980"></a><span id="l35.1980" class="difflineplus">+    // NOP</span>
<a href="#l35.1981"></a><span id="l35.1981" class="difflineplus">+  },</span>
<a href="#l35.1982"></a><span id="l35.1982" class="difflineplus">+  invalidateRange: function FakeTreeBoxObject_invalidateRange() {</span>
<a href="#l35.1983"></a><span id="l35.1983" class="difflineplus">+    // NOP</span>
<a href="#l35.1984"></a><span id="l35.1984" class="difflineplus">+  },</span>
<a href="#l35.1985"></a><span id="l35.1985" class="difflineplus">+  invalidateRow: function FakeTreeBoxObject_invalidateRow() {</span>
<a href="#l35.1986"></a><span id="l35.1986" class="difflineplus">+    // NOP</span>
<a href="#l35.1987"></a><span id="l35.1987" class="difflineplus">+  },</span>
<a href="#l35.1988"></a><span id="l35.1988" class="difflineplus">+  beginUpdateBatch: function FakeTreeBoxObject_beginUpdateBatch() {</span>
<a href="#l35.1989"></a><span id="l35.1989" class="difflineplus">+</span>
<a href="#l35.1990"></a><span id="l35.1990" class="difflineplus">+  },</span>
<a href="#l35.1991"></a><span id="l35.1991" class="difflineplus">+  endUpdateBatch: function FakeTreeBoxObject_endUpdateBatch() {</span>
<a href="#l35.1992"></a><span id="l35.1992" class="difflineplus">+</span>
<a href="#l35.1993"></a><span id="l35.1993" class="difflineplus">+  },</span>
<a href="#l35.1994"></a><span id="l35.1994" class="difflineplus">+  rowCountChanged: function FakeTreeBoxObject_rowCountChanged() {</span>
<a href="#l35.1995"></a><span id="l35.1995" class="difflineplus">+</span>
<a href="#l35.1996"></a><span id="l35.1996" class="difflineplus">+  },</span>
<a href="#l35.1997"></a><span id="l35.1997" class="difflineplus">+  /**</span>
<a href="#l35.1998"></a><span id="l35.1998" class="difflineplus">+   * Sleight of hand!  If someone asks us about an nsIBoxObject, we tell them</span>
<a href="#l35.1999"></a><span id="l35.1999" class="difflineplus">+   *  about a real box object that is just a dummy and is never used for</span>
<a href="#l35.2000"></a><span id="l35.2000" class="difflineplus">+   *  anything.</span>
<a href="#l35.2001"></a><span id="l35.2001" class="difflineplus">+   */</span>
<a href="#l35.2002"></a><span id="l35.2002" class="difflineplus">+  QueryInterface: function FakeTreeBoxObject_QueryInterface(aIID) {</span>
<a href="#l35.2003"></a><span id="l35.2003" class="difflineplus">+    if (aIID.equals(Components.interfaces.nsIBoxObject))</span>
<a href="#l35.2004"></a><span id="l35.2004" class="difflineplus">+      return this.dummyBoxObject;</span>
<a href="#l35.2005"></a><span id="l35.2005" class="difflineplus">+    if (!aIID.equals(Components.interfaces.nsISupports) &amp;&amp;</span>
<a href="#l35.2006"></a><span id="l35.2006" class="difflineplus">+        !aIID.equals(Components.interfaces.nsITreeBoxObject))</span>
<a href="#l35.2007"></a><span id="l35.2007" class="difflineplus">+      throw Components.results.NS_ERROR_NO_INTERFACE;</span>
<a href="#l35.2008"></a><span id="l35.2008" class="difflineplus">+    return this;</span>
<a href="#l35.2009"></a><span id="l35.2009" class="difflineplus">+  }</span>
<a href="#l35.2010"></a><span id="l35.2010" class="difflineplus">+};</span>
<a href="#l35.2011"></a><span id="l35.2011" class="difflineplus">+/*</span>
<a href="#l35.2012"></a><span id="l35.2012" class="difflineplus">+ * Provide attribute and function implementations that complain very loudly if</span>
<a href="#l35.2013"></a><span id="l35.2013" class="difflineplus">+ *  they are used.  Now, XPConnect will return an error to callers if we don't</span>
<a href="#l35.2014"></a><span id="l35.2014" class="difflineplus">+ *  implement part of the interface signature, but this is unlikely to provide</span>
<a href="#l35.2015"></a><span id="l35.2015" class="difflineplus">+ *  the visibility we desire.  In fact, since it is a simple nsresult error,</span>
<a href="#l35.2016"></a><span id="l35.2016" class="difflineplus">+ *  it may make things completely crazy.  So this way we can yell via dump,</span>
<a href="#l35.2017"></a><span id="l35.2017" class="difflineplus">+ *  throw an exception, etc.</span>
<a href="#l35.2018"></a><span id="l35.2018" class="difflineplus">+ */</span>
<a href="#l35.2019"></a><span id="l35.2019" class="difflineplus">+function FTBO_stubOutAttributes(aObj, aAttribNames) {</span>
<a href="#l35.2020"></a><span id="l35.2020" class="difflineplus">+  for (let [, attrName] in Iterator(aAttribNames)) {</span>
<a href="#l35.2021"></a><span id="l35.2021" class="difflineplus">+    let myAttrName = attrName;</span>
<a href="#l35.2022"></a><span id="l35.2022" class="difflineplus">+    aObj.__defineGetter__(attrName,</span>
<a href="#l35.2023"></a><span id="l35.2023" class="difflineplus">+      function() {</span>
<a href="#l35.2024"></a><span id="l35.2024" class="difflineplus">+        let msg = &quot;Read access to stubbed attribute &quot; + myAttrName;</span>
<a href="#l35.2025"></a><span id="l35.2025" class="difflineplus">+        dump(msg + &quot;\n&quot;);</span>
<a href="#l35.2026"></a><span id="l35.2026" class="difflineplus">+        debugger;</span>
<a href="#l35.2027"></a><span id="l35.2027" class="difflineplus">+        throw new Error(msg);</span>
<a href="#l35.2028"></a><span id="l35.2028" class="difflineplus">+      });</span>
<a href="#l35.2029"></a><span id="l35.2029" class="difflineplus">+    aObj.__defineSetter__(attrName,</span>
<a href="#l35.2030"></a><span id="l35.2030" class="difflineplus">+      function() {</span>
<a href="#l35.2031"></a><span id="l35.2031" class="difflineplus">+        let msg = &quot;Write access to stubbed attribute &quot; + myAttrName;</span>
<a href="#l35.2032"></a><span id="l35.2032" class="difflineplus">+        dump(msg + &quot;\n&quot;);</span>
<a href="#l35.2033"></a><span id="l35.2033" class="difflineplus">+        debugger;</span>
<a href="#l35.2034"></a><span id="l35.2034" class="difflineplus">+        throw new Error(msg);</span>
<a href="#l35.2035"></a><span id="l35.2035" class="difflineplus">+      });</span>
<a href="#l35.2036"></a><span id="l35.2036" class="difflineplus">+  }</span>
<a href="#l35.2037"></a><span id="l35.2037" class="difflineplus">+}</span>
<a href="#l35.2038"></a><span id="l35.2038" class="difflineplus">+function FTBO_stubOutMethods(aObj, aMethodNames) {</span>
<a href="#l35.2039"></a><span id="l35.2039" class="difflineplus">+  for (let [, methodName] in Iterator(aMethodNames)) {</span>
<a href="#l35.2040"></a><span id="l35.2040" class="difflineplus">+    let myMethodName = methodName;</span>
<a href="#l35.2041"></a><span id="l35.2041" class="difflineplus">+    aObj[myMethodName] = function() {</span>
<a href="#l35.2042"></a><span id="l35.2042" class="difflineplus">+      let msg = &quot;Call to stubbed method &quot; + myMethodName;</span>
<a href="#l35.2043"></a><span id="l35.2043" class="difflineplus">+      dump(msg + &quot;\n&quot;);</span>
<a href="#l35.2044"></a><span id="l35.2044" class="difflineplus">+      debugger;</span>
<a href="#l35.2045"></a><span id="l35.2045" class="difflineplus">+      throw new Error(msg);</span>
<a href="#l35.2046"></a><span id="l35.2046" class="difflineplus">+    };</span>
<a href="#l35.2047"></a><span id="l35.2047" class="difflineplus">+  }</span>
<a href="#l35.2048"></a><span id="l35.2048" class="difflineplus">+}</span>
<a href="#l35.2049"></a><span id="l35.2049" class="difflineplus">+FTBO_stubOutAttributes(FakeTreeBoxObject.prototype, [</span>
<a href="#l35.2050"></a><span id="l35.2050" class="difflineplus">+  &quot;columns&quot;,</span>
<a href="#l35.2051"></a><span id="l35.2051" class="difflineplus">+  &quot;focused&quot;,</span>
<a href="#l35.2052"></a><span id="l35.2052" class="difflineplus">+  &quot;treeBody&quot;,</span>
<a href="#l35.2053"></a><span id="l35.2053" class="difflineplus">+  &quot;rowHeight&quot;,</span>
<a href="#l35.2054"></a><span id="l35.2054" class="difflineplus">+  &quot;rowWidth&quot;,</span>
<a href="#l35.2055"></a><span id="l35.2055" class="difflineplus">+  &quot;horizontalPosition&quot;,</span>
<a href="#l35.2056"></a><span id="l35.2056" class="difflineplus">+  &quot;selectionRegion&quot;,</span>
<a href="#l35.2057"></a><span id="l35.2057" class="difflineplus">+  ]);</span>
<a href="#l35.2058"></a><span id="l35.2058" class="difflineplus">+FTBO_stubOutMethods(FakeTreeBoxObject.prototype, [</span>
<a href="#l35.2059"></a><span id="l35.2059" class="difflineplus">+  &quot;getFirstVisibleRow&quot;,</span>
<a href="#l35.2060"></a><span id="l35.2060" class="difflineplus">+  &quot;getLastVisibleRow&quot;,</span>
<a href="#l35.2061"></a><span id="l35.2061" class="difflineplus">+  &quot;getPageLength&quot;,</span>
<a href="#l35.2062"></a><span id="l35.2062" class="difflineplus">+  &quot;ensureRowIsVisible&quot;,</span>
<a href="#l35.2063"></a><span id="l35.2063" class="difflineplus">+  &quot;ensureCellIsVisible&quot;,</span>
<a href="#l35.2064"></a><span id="l35.2064" class="difflineplus">+  &quot;scrollToRow&quot;,</span>
<a href="#l35.2065"></a><span id="l35.2065" class="difflineplus">+  &quot;scrollByLines&quot;,</span>
<a href="#l35.2066"></a><span id="l35.2066" class="difflineplus">+  &quot;scrollByPages&quot;,</span>
<a href="#l35.2067"></a><span id="l35.2067" class="difflineplus">+  &quot;scrollToCell&quot;,</span>
<a href="#l35.2068"></a><span id="l35.2068" class="difflineplus">+  &quot;scrollToColumn&quot;,</span>
<a href="#l35.2069"></a><span id="l35.2069" class="difflineplus">+  &quot;scrollToHorizontalPosition&quot;,</span>
<a href="#l35.2070"></a><span id="l35.2070" class="difflineplus">+  &quot;invalidateColumn&quot;,</span>
<a href="#l35.2071"></a><span id="l35.2071" class="difflineplus">+  &quot;invalidateRow&quot;,</span>
<a href="#l35.2072"></a><span id="l35.2072" class="difflineplus">+  &quot;invalidateCell&quot;,</span>
<a href="#l35.2073"></a><span id="l35.2073" class="difflineplus">+  &quot;invalidateColumnRange&quot;,</span>
<a href="#l35.2074"></a><span id="l35.2074" class="difflineplus">+  &quot;getRowAt&quot;,</span>
<a href="#l35.2075"></a><span id="l35.2075" class="difflineplus">+  &quot;getCellAt&quot;,</span>
<a href="#l35.2076"></a><span id="l35.2076" class="difflineplus">+  &quot;getCoordsForCellItem&quot;,</span>
<a href="#l35.2077"></a><span id="l35.2077" class="difflineplus">+  &quot;isCellCropped&quot;,</span>
<a href="#l35.2078"></a><span id="l35.2078" class="difflineplus">+  &quot;clearStyleAndImageCaches&quot;,</span>
<a href="#l35.2079"></a><span id="l35.2079" class="difflineplus">+  ]);</span>
<a href="#l35.2080"></a><span id="l35.2080">\ No newline at end of file</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l36.1"></a><span id="l36.1" class="difflineminus">--- a/mail/base/content/folderPane.js</span>
<a href="#l36.2"></a><span id="l36.2" class="difflineplus">+++ b/mail/base/content/folderPane.js</span>
<a href="#l36.3"></a><span id="l36.3" class="difflineat">@@ -58,17 +58,17 @@ let gFolderTreeView = {</span>
<a href="#l36.4"></a><span id="l36.4">   load: function ftv_load(aTree, aJSONFile) {</span>
<a href="#l36.5"></a><span id="l36.5">     const Cc = Components.classes;</span>
<a href="#l36.6"></a><span id="l36.6">     const Ci = Components.interfaces;</span>
<a href="#l36.7"></a><span id="l36.7">     this._treeElement = aTree;</span>
<a href="#l36.8"></a><span id="l36.8"> </span>
<a href="#l36.9"></a><span id="l36.9">     let smartName = document.getElementById(&quot;bundle_messenger&quot;)</span>
<a href="#l36.10"></a><span id="l36.10">                             .getString(&quot;folderPaneHeader_smart&quot;);</span>
<a href="#l36.11"></a><span id="l36.11">     this.registerMode(&quot;smart&quot;, this._smartFoldersGenerator, smartName);</span>
<a href="#l36.12"></a><span id="l36.12" class="difflineminus">-    // the folder pane can be used for other trees which may not have these elements. </span>
<a href="#l36.13"></a><span id="l36.13" class="difflineplus">+    // the folder pane can be used for other trees which may not have these elements.</span>
<a href="#l36.14"></a><span id="l36.14">     if (document.getElementById(&quot;folderpane_splitter&quot;))</span>
<a href="#l36.15"></a><span id="l36.15">       document.getElementById(&quot;folderpane_splitter&quot;).collapsed = false;</span>
<a href="#l36.16"></a><span id="l36.16">     if (document.getElementById(&quot;folderPaneBox&quot;))</span>
<a href="#l36.17"></a><span id="l36.17">       document.getElementById(&quot;folderPaneBox&quot;).collapsed = false;</span>
<a href="#l36.18"></a><span id="l36.18"> </span>
<a href="#l36.19"></a><span id="l36.19">     try {</span>
<a href="#l36.20"></a><span id="l36.20">       // Normally our tree takes care of keeping the last selected by itself.</span>
<a href="#l36.21"></a><span id="l36.21">       // However older versions of TB stored this in a preference, which we need</span>
<a href="#l36.22"></a><span id="l36.22" class="difflineat">@@ -105,17 +105,17 @@ let gFolderTreeView = {</span>
<a href="#l36.23"></a><span id="l36.23">                          .createInstance(Ci.nsIFileInputStream);</span>
<a href="#l36.24"></a><span id="l36.24">         let sstream = Cc[&quot;@mozilla.org/scriptableinputstream;1&quot;]</span>
<a href="#l36.25"></a><span id="l36.25">                          .createInstance(Ci.nsIScriptableInputStream);</span>
<a href="#l36.26"></a><span id="l36.26">         fstream.init(file, -1, 0, 0);</span>
<a href="#l36.27"></a><span id="l36.27">         sstream.init(fstream);</span>
<a href="#l36.28"></a><span id="l36.28"> </span>
<a href="#l36.29"></a><span id="l36.29">         while (sstream.available())</span>
<a href="#l36.30"></a><span id="l36.30">           data += sstream.read(4096);</span>
<a href="#l36.31"></a><span id="l36.31" class="difflineminus">-        </span>
<a href="#l36.32"></a><span id="l36.32" class="difflineplus">+</span>
<a href="#l36.33"></a><span id="l36.33">         sstream.close();</span>
<a href="#l36.34"></a><span id="l36.34">         fstream.close();</span>
<a href="#l36.35"></a><span id="l36.35">         let JSON = Cc[&quot;@mozilla.org/dom/json;1&quot;].createInstance(Ci.nsIJSON);</span>
<a href="#l36.36"></a><span id="l36.36">         this._persistOpenMap = JSON.decode(data);</span>
<a href="#l36.37"></a><span id="l36.37">       }</span>
<a href="#l36.38"></a><span id="l36.38">     }</span>
<a href="#l36.39"></a><span id="l36.39"> </span>
<a href="#l36.40"></a><span id="l36.40">     // Load our data</span>
<a href="#l36.41"></a><span id="l36.41" class="difflineat">@@ -211,17 +211,17 @@ let gFolderTreeView = {</span>
<a href="#l36.42"></a><span id="l36.42">         aEvent.button != 0 || aEvent.originalTarget.localName == &quot;twisty&quot; ||</span>
<a href="#l36.43"></a><span id="l36.43">         aEvent.originalTarget.localName == &quot;slider&quot; ||</span>
<a href="#l36.44"></a><span id="l36.44">         aEvent.originalTarget.localName == &quot;scrollbarbutton&quot;)</span>
<a href="#l36.45"></a><span id="l36.45">       return;</span>
<a href="#l36.46"></a><span id="l36.46"> </span>
<a href="#l36.47"></a><span id="l36.47">     let row = gFolderTreeView._treeElement.treeBoxObject.getRowAt(aEvent.clientX,</span>
<a href="#l36.48"></a><span id="l36.48">                                                                   aEvent.clientY);</span>
<a href="#l36.49"></a><span id="l36.49">     let folderItem = gFolderTreeView._rowMap[row];</span>
<a href="#l36.50"></a><span id="l36.50" class="difflineminus">-    if (folderItem)                                                   </span>
<a href="#l36.51"></a><span id="l36.51" class="difflineplus">+    if (folderItem)</span>
<a href="#l36.52"></a><span id="l36.52">       folderItem.command();</span>
<a href="#l36.53"></a><span id="l36.53"> </span>
<a href="#l36.54"></a><span id="l36.54">     // Don't let the double-click toggle the open state of the folder here</span>
<a href="#l36.55"></a><span id="l36.55">     aEvent.stopPropagation();</span>
<a href="#l36.56"></a><span id="l36.56">   },</span>
<a href="#l36.57"></a><span id="l36.57"> </span>
<a href="#l36.58"></a><span id="l36.58">   getFolderAtCoords: function ftv_getFolderAtCoords(aX, aY) {</span>
<a href="#l36.59"></a><span id="l36.59">     let row = gFolderTreeView._treeElement.treeBoxObject.getRowAt(aX, aY);</span>
<a href="#l36.60"></a><span id="l36.60" class="difflineat">@@ -265,17 +265,17 @@ let gFolderTreeView = {</span>
<a href="#l36.61"></a><span id="l36.61">    * that the folder is actually being displayed (that is, that none of its</span>
<a href="#l36.62"></a><span id="l36.62">    * ancestors are collapsed.</span>
<a href="#l36.63"></a><span id="l36.63">    *</span>
<a href="#l36.64"></a><span id="l36.64">    * @param aFolder  the nsIMsgFolder to select</span>
<a href="#l36.65"></a><span id="l36.65">    */</span>
<a href="#l36.66"></a><span id="l36.66">   selectFolder: function ftv_selectFolder(aFolder) {</span>
<a href="#l36.67"></a><span id="l36.67">     // &quot;this&quot; inside the nested function refers to the function...</span>
<a href="#l36.68"></a><span id="l36.68">     // Also note that openIfNot is recursive.</span>
<a href="#l36.69"></a><span id="l36.69" class="difflineminus">-    let tree = this; </span>
<a href="#l36.70"></a><span id="l36.70" class="difflineplus">+    let tree = this;</span>
<a href="#l36.71"></a><span id="l36.71">     function openIfNot(aFolderToOpen) {</span>
<a href="#l36.72"></a><span id="l36.72">       let index = tree.getIndexOfFolder(aFolderToOpen);</span>
<a href="#l36.73"></a><span id="l36.73">       if (index) {</span>
<a href="#l36.74"></a><span id="l36.74">         if (!tree._rowMap[index].open)</span>
<a href="#l36.75"></a><span id="l36.75">           tree._toggleRow(index, false);</span>
<a href="#l36.76"></a><span id="l36.76">         return;</span>
<a href="#l36.77"></a><span id="l36.77">       }</span>
<a href="#l36.78"></a><span id="l36.78"> </span>
<a href="#l36.79"></a><span id="l36.79" class="difflineat">@@ -444,17 +444,17 @@ let gFolderTreeView = {</span>
<a href="#l36.80"></a><span id="l36.80">         let folders = new Array;</span>
<a href="#l36.81"></a><span id="l36.81">         folders.push(dt.mozGetDataAt(&quot;text/x-moz-folder&quot;, i)</span>
<a href="#l36.82"></a><span id="l36.82">                        .QueryInterface(Ci.nsIMsgFolder));</span>
<a href="#l36.83"></a><span id="l36.83">         let array = toXPCOMArray(folders, Ci.nsIMutableArray);</span>
<a href="#l36.84"></a><span id="l36.84">         cs.CopyFolders(array, targetFolder,</span>
<a href="#l36.85"></a><span id="l36.85">                       (folders[0].server == targetFolder.server), null,</span>
<a href="#l36.86"></a><span id="l36.86">                        msgWindow);</span>
<a href="#l36.87"></a><span id="l36.87">       }</span>
<a href="#l36.88"></a><span id="l36.88" class="difflineminus">-    } </span>
<a href="#l36.89"></a><span id="l36.89" class="difflineplus">+    }</span>
<a href="#l36.90"></a><span id="l36.90">     else if (Array.indexOf(types, &quot;text/x-moz-newsfolder&quot;) != -1) {</span>
<a href="#l36.91"></a><span id="l36.91">       // Start by getting folders into order.</span>
<a href="#l36.92"></a><span id="l36.92">       let folders = new Array;</span>
<a href="#l36.93"></a><span id="l36.93">       for (let i = 0; i &lt; count; i++) {</span>
<a href="#l36.94"></a><span id="l36.94">         let folder = dt.mozGetDataAt(&quot;text/x-moz-newsfolder&quot;, i)</span>
<a href="#l36.95"></a><span id="l36.95">                        .QueryInterface(Ci.nsIMsgFolder);</span>
<a href="#l36.96"></a><span id="l36.96">         folders[this.getIndexOfFolder(folder)] = folder;</span>
<a href="#l36.97"></a><span id="l36.97">       }</span>
<a href="#l36.98"></a><span id="l36.98" class="difflineat">@@ -1027,17 +1027,17 @@ let gFolderTreeView = {</span>
<a href="#l36.99"></a><span id="l36.99">           acct.incomingServer.rootFolder.subFolders;</span>
<a href="#l36.100"></a><span id="l36.100">         }</span>
<a href="#l36.101"></a><span id="l36.101">         catch (ex) {</span>
<a href="#l36.102"></a><span id="l36.102">           Components.classes[&quot;@mozilla.org/consoleservice;1&quot;]</span>
<a href="#l36.103"></a><span id="l36.103">                     .getService(Components.interfaces.nsIConsoleService)</span>
<a href="#l36.104"></a><span id="l36.104">                     .logStringMessage(&quot;Discovering folders for account failed with exception: &quot; + ex);</span>
<a href="#l36.105"></a><span id="l36.105">         }</span>
<a href="#l36.106"></a><span id="l36.106">       }</span>
<a href="#l36.107"></a><span id="l36.107" class="difflineminus">-        </span>
<a href="#l36.108"></a><span id="l36.108" class="difflineplus">+</span>
<a href="#l36.109"></a><span id="l36.109">       return [new ftvItem(acct.incomingServer.rootFolder)</span>
<a href="#l36.110"></a><span id="l36.110">               for each (acct in accounts)];</span>
<a href="#l36.111"></a><span id="l36.111">     },</span>
<a href="#l36.112"></a><span id="l36.112"> </span>
<a href="#l36.113"></a><span id="l36.113">     /**</span>
<a href="#l36.114"></a><span id="l36.114">      * The unread mode returns all folders that are not root-folders and that</span>
<a href="#l36.115"></a><span id="l36.115">      * have unread items.  Also always keep the currently selected folder</span>
<a href="#l36.116"></a><span id="l36.116">      * so it doesn't disappear under the user.</span>
<a href="#l36.117"></a><span id="l36.117" class="difflineat">@@ -1129,17 +1129,17 @@ let gFolderTreeView = {</span>
<a href="#l36.118"></a><span id="l36.118"> </span>
<a href="#l36.119"></a><span id="l36.119">       for each (let folder in ftv._enumerateFolders)</span>
<a href="#l36.120"></a><span id="l36.120">         addIfRecent(folder);</span>
<a href="#l36.121"></a><span id="l36.121"> </span>
<a href="#l36.122"></a><span id="l36.122">       recentFolders.sort(sorter);</span>
<a href="#l36.123"></a><span id="l36.123"> </span>
<a href="#l36.124"></a><span id="l36.124">       let items = [new ftvItem(f) for each (f in recentFolders)];</span>
<a href="#l36.125"></a><span id="l36.125"> </span>
<a href="#l36.126"></a><span id="l36.126" class="difflineminus">-      // There are no children in this view! </span>
<a href="#l36.127"></a><span id="l36.127" class="difflineplus">+      // There are no children in this view!</span>
<a href="#l36.128"></a><span id="l36.128">       // And we want to display the account name to distinguish folders w/</span>
<a href="#l36.129"></a><span id="l36.129">       // the same name.</span>
<a href="#l36.130"></a><span id="l36.130">       for each (let folder in items) {</span>
<a href="#l36.131"></a><span id="l36.131">         folder.__defineGetter__(&quot;children&quot;, function() []);</span>
<a href="#l36.132"></a><span id="l36.132">         folder.addServerName = true;</span>
<a href="#l36.133"></a><span id="l36.133">       }</span>
<a href="#l36.134"></a><span id="l36.134"> </span>
<a href="#l36.135"></a><span id="l36.135">       return items;</span>
<a href="#l36.136"></a><span id="l36.136" class="difflineat">@@ -1253,17 +1253,17 @@ let gFolderTreeView = {</span>
<a href="#l36.137"></a><span id="l36.137"> </span>
<a href="#l36.138"></a><span id="l36.138">   OnItemRemoved: function ftl_remove(aRDFParentItem, aItem) {</span>
<a href="#l36.139"></a><span id="l36.139">     if (!(aItem instanceof Components.interfaces.nsIMsgFolder))</span>
<a href="#l36.140"></a><span id="l36.140">       return;</span>
<a href="#l36.141"></a><span id="l36.141"> </span>
<a href="#l36.142"></a><span id="l36.142">     let persistMapIndex = this._persistOpenMap[this.mode].indexOf(aItem.URI);</span>
<a href="#l36.143"></a><span id="l36.143">     if (persistMapIndex != -1)</span>
<a href="#l36.144"></a><span id="l36.144">       this._persistOpenMap[this.mode].splice(persistMapIndex, 1);</span>
<a href="#l36.145"></a><span id="l36.145" class="difflineminus">-    </span>
<a href="#l36.146"></a><span id="l36.146" class="difflineplus">+</span>
<a href="#l36.147"></a><span id="l36.147">     let index = this.getIndexOfFolder(aItem);</span>
<a href="#l36.148"></a><span id="l36.148">     if (!index)</span>
<a href="#l36.149"></a><span id="l36.149">       return;</span>
<a href="#l36.150"></a><span id="l36.150">     // forget our parent's children; they'll get rebuilt</span>
<a href="#l36.151"></a><span id="l36.151">     if (aRDFParentItem)</span>
<a href="#l36.152"></a><span id="l36.152">       this._rowMap[index]._parent._children = null;</span>
<a href="#l36.153"></a><span id="l36.153">     let kidCount = 1;</span>
<a href="#l36.154"></a><span id="l36.154">     let walker = Number(index) + 1;</span>
<a href="#l36.155"></a><span id="l36.155" class="difflineat">@@ -1465,23 +1465,16 @@ let gFolderTreeController = {</span>
<a href="#l36.156"></a><span id="l36.156">       msgDB.summaryValid = false;</span>
<a href="#l36.157"></a><span id="l36.157">       try {</span>
<a href="#l36.158"></a><span id="l36.158">         folder.closeAndBackupFolderDB(&quot;&quot;);</span>
<a href="#l36.159"></a><span id="l36.159">       }</span>
<a href="#l36.160"></a><span id="l36.160">       catch(e) {</span>
<a href="#l36.161"></a><span id="l36.161">         // In a failure, proceed anyway since we're dealing with problems</span>
<a href="#l36.162"></a><span id="l36.162">         folder.ForceDBClosed();</span>
<a href="#l36.163"></a><span id="l36.163">       }</span>
<a href="#l36.164"></a><span id="l36.164" class="difflineminus">-      // these lines will cause the thread pane to get reloaded when the</span>
<a href="#l36.165"></a><span id="l36.165" class="difflineminus">-      // download/reparse is finished. Only do this if the selected folder is</span>
<a href="#l36.166"></a><span id="l36.166" class="difflineminus">-      // loaded (i.e., not thru the context menu on a non-loaded folder).</span>
<a href="#l36.167"></a><span id="l36.167" class="difflineminus">-      if (folder == GetLoadedMsgFolder()) {</span>
<a href="#l36.168"></a><span id="l36.168" class="difflineminus">-        gRerootOnFolderLoad = true;</span>
<a href="#l36.169"></a><span id="l36.169" class="difflineminus">-        gCurrentFolderToReroot = folder.URI;</span>
<a href="#l36.170"></a><span id="l36.170" class="difflineminus">-      }</span>
<a href="#l36.171"></a><span id="l36.171">       folder.updateFolder(msgWindow);</span>
<a href="#l36.172"></a><span id="l36.172">     }</span>
<a href="#l36.173"></a><span id="l36.173"> </span>
<a href="#l36.174"></a><span id="l36.174">     window.openDialog(&quot;chrome://messenger/content/folderProps.xul&quot;, &quot;&quot;,</span>
<a href="#l36.175"></a><span id="l36.175">                       &quot;chrome,centerscreen,titlebar,modal&quot;,</span>
<a href="#l36.176"></a><span id="l36.176">                       {folder: folder, serverType: folder.server.type,</span>
<a href="#l36.177"></a><span id="l36.177">                        msgWindow: msgWindow, title: title,</span>
<a href="#l36.178"></a><span id="l36.178">                        okCallback: editFolderCallback,</span>
<a href="#l36.179"></a><span id="l36.179" class="difflineat">@@ -1500,17 +1493,16 @@ let gFolderTreeController = {</span>
<a href="#l36.180"></a><span id="l36.180">     let folder = aFolder || gFolderTreeView.getSelectedFolders()[0];</span>
<a href="#l36.181"></a><span id="l36.181"> </span>
<a href="#l36.182"></a><span id="l36.182">     //xxx no need for uri now</span>
<a href="#l36.183"></a><span id="l36.183">     let controller = this;</span>
<a href="#l36.184"></a><span id="l36.184">     function renameCallback(aName, aUri) {</span>
<a href="#l36.185"></a><span id="l36.185">       if (aUri != folder.URI)</span>
<a href="#l36.186"></a><span id="l36.186">         Components.utils.reportError(&quot;got back a different folder to rename!&quot;);</span>
<a href="#l36.187"></a><span id="l36.187"> </span>
<a href="#l36.188"></a><span id="l36.188" class="difflineminus">-      controller._resetThreadPane();</span>
<a href="#l36.189"></a><span id="l36.189">       controller._tree.view.selection.clearSelection();</span>
<a href="#l36.190"></a><span id="l36.190"> </span>
<a href="#l36.191"></a><span id="l36.191">       // Actually do the rename</span>
<a href="#l36.192"></a><span id="l36.192">       folder.rename(aName, msgWindow);</span>
<a href="#l36.193"></a><span id="l36.193">     }</span>
<a href="#l36.194"></a><span id="l36.194">     window.openDialog(&quot;chrome://messenger/content/renameFolderDialog.xul&quot;,</span>
<a href="#l36.195"></a><span id="l36.195">                       &quot;newFolder&quot;, &quot;chrome,titlebar,modal&quot;,</span>
<a href="#l36.196"></a><span id="l36.196">                       {preselectedURI: folder.URI,</span>
<a href="#l36.197"></a><span id="l36.197" class="difflineat">@@ -1559,21 +1551,19 @@ let gFolderTreeController = {</span>
<a href="#l36.198"></a><span id="l36.198">     }</span>
<a href="#l36.199"></a><span id="l36.199"> </span>
<a href="#l36.200"></a><span id="l36.200">     if (folder.flags &amp; FLAGS.Virtual) {</span>
<a href="#l36.201"></a><span id="l36.201">       let confirmation = bundle.getString(&quot;confirmSavedSearchDeleteMessage&quot;);</span>
<a href="#l36.202"></a><span id="l36.202">       let title = bundle.getString(&quot;confirmSavedSearchTitle&quot;);</span>
<a href="#l36.203"></a><span id="l36.203">       let IPS = Components.interfaces.nsIPromptService;</span>
<a href="#l36.204"></a><span id="l36.204">       if (Components.classes[&quot;@mozilla.org/embedcomp/prompt-service;1&quot;]</span>
<a href="#l36.205"></a><span id="l36.205">             .getService(IPS)</span>
<a href="#l36.206"></a><span id="l36.206" class="difflineminus">-            .confirmEx(window, title, confirmation, IPS.STD_YES_NO_BUTTONS + IPS.BUTTON_POS_1_DEFAULT, </span>
<a href="#l36.207"></a><span id="l36.207" class="difflineplus">+            .confirmEx(window, title, confirmation, IPS.STD_YES_NO_BUTTONS + IPS.BUTTON_POS_1_DEFAULT,</span>
<a href="#l36.208"></a><span id="l36.208">                        &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, {}) != 0) /* the yes button is in position 0 */</span>
<a href="#l36.209"></a><span id="l36.209">         return;</span>
<a href="#l36.210"></a><span id="l36.210" class="difflineminus">-      if (gCurrentVirtualFolderUri == folder.URI)</span>
<a href="#l36.211"></a><span id="l36.211" class="difflineminus">-        gCurrentVirtualFolderUri = null;</span>
<a href="#l36.212"></a><span id="l36.212">     }</span>
<a href="#l36.213"></a><span id="l36.213"> </span>
<a href="#l36.214"></a><span id="l36.214">     let array = toXPCOMArray([folder], Ci.nsIMutableArray);</span>
<a href="#l36.215"></a><span id="l36.215">     folder.parent.deleteSubFolders(array, msgWindow);</span>
<a href="#l36.216"></a><span id="l36.216">   },</span>
<a href="#l36.217"></a><span id="l36.217"> </span>
<a href="#l36.218"></a><span id="l36.218">   /**</span>
<a href="#l36.219"></a><span id="l36.219">    * Prompts the user to confirm and empties the trash for the selected folder</span>
<a href="#l36.220"></a><span id="l36.220" class="difflineat">@@ -1621,20 +1611,16 @@ let gFolderTreeController = {</span>
<a href="#l36.221"></a><span id="l36.221">    */</span>
<a href="#l36.222"></a><span id="l36.222">   compactFolders: function ftc_compactFolders(aFolders) {</span>
<a href="#l36.223"></a><span id="l36.223">     let folders = aFolders || gFolderTreeView.getSelectedFolders();</span>
<a href="#l36.224"></a><span id="l36.224">     for (let i = 0; i &lt; folders.length; i++) {</span>
<a href="#l36.225"></a><span id="l36.225">       // Can't compact folders that have just been compacted.</span>
<a href="#l36.226"></a><span id="l36.226">       if (folders[i].server.type != &quot;imap&quot; &amp;&amp; !folders[i].expungedBytes)</span>
<a href="#l36.227"></a><span id="l36.227">         continue;</span>
<a href="#l36.228"></a><span id="l36.228"> </span>
<a href="#l36.229"></a><span id="l36.229" class="difflineminus">-      // Reset thread pane for non-imap folders if the folder is selected.</span>
<a href="#l36.230"></a><span id="l36.230" class="difflineminus">-      if (gDBView &amp;&amp; gDBView.msgFolder == folders[i] &amp;&amp; folders[i].server.type != &quot;imap&quot;)</span>
<a href="#l36.231"></a><span id="l36.231" class="difflineminus">-        this._resetThreadPane();</span>
<a href="#l36.232"></a><span id="l36.232" class="difflineminus">-</span>
<a href="#l36.233"></a><span id="l36.233">       folders[i].compact(null, msgWindow);</span>
<a href="#l36.234"></a><span id="l36.234">     }</span>
<a href="#l36.235"></a><span id="l36.235">   },</span>
<a href="#l36.236"></a><span id="l36.236"> </span>
<a href="#l36.237"></a><span id="l36.237">   /**</span>
<a href="#l36.238"></a><span id="l36.238">    * Compacts all folders for accounts that the given folders belong</span>
<a href="#l36.239"></a><span id="l36.239">    * to, or all folders for accounts of the currently selected folders.</span>
<a href="#l36.240"></a><span id="l36.240">    *</span>
<a href="#l36.241"></a><span id="l36.241" class="difflineat">@@ -1686,29 +1672,16 @@ let gFolderTreeController = {</span>
<a href="#l36.242"></a><span id="l36.242">     window.openDialog(&quot;chrome://messenger/content/virtualFolderProperties.xul&quot;,</span>
<a href="#l36.243"></a><span id="l36.243">                       &quot;&quot;, &quot;chrome,titlebar,modal,centerscreen&quot;,</span>
<a href="#l36.244"></a><span id="l36.244">                       {folder: folder, editExistingFolder: true,</span>
<a href="#l36.245"></a><span id="l36.245">                        onOKCallback: editVirtualCallback,</span>
<a href="#l36.246"></a><span id="l36.246">                        msgWindow: msgWindow});</span>
<a href="#l36.247"></a><span id="l36.247">   },</span>
<a href="#l36.248"></a><span id="l36.248"> </span>
<a href="#l36.249"></a><span id="l36.249">   /**</span>
<a href="#l36.250"></a><span id="l36.250" class="difflineminus">-   * For certain folder commands, the thread pane needs to be invalidated, this</span>
<a href="#l36.251"></a><span id="l36.251" class="difflineminus">-   * takes care of doing so.</span>
<a href="#l36.252"></a><span id="l36.252" class="difflineminus">-   */</span>
<a href="#l36.253"></a><span id="l36.253" class="difflineminus">-  _resetThreadPane: function ftc_resetThreadPane() {</span>
<a href="#l36.254"></a><span id="l36.254" class="difflineminus">-    if (gDBView)</span>
<a href="#l36.255"></a><span id="l36.255" class="difflineminus">-      gCurrentlyDisplayedMessage = gDBView.currentlyDisplayedMessage;</span>
<a href="#l36.256"></a><span id="l36.256" class="difflineminus">-</span>
<a href="#l36.257"></a><span id="l36.257" class="difflineminus">-    ClearThreadPaneSelection();</span>
<a href="#l36.258"></a><span id="l36.258" class="difflineminus">-    ClearThreadPane();</span>
<a href="#l36.259"></a><span id="l36.259" class="difflineminus">-    ClearMessagePane();</span>
<a href="#l36.260"></a><span id="l36.260" class="difflineminus">-  },</span>
<a href="#l36.261"></a><span id="l36.261" class="difflineminus">-</span>
<a href="#l36.262"></a><span id="l36.262" class="difflineminus">-  /**</span>
<a href="#l36.263"></a><span id="l36.263">    * Prompts for confirmation, if the user hasn't already chosen the &quot;don't ask</span>
<a href="#l36.264"></a><span id="l36.264">    * again&quot; option.</span>
<a href="#l36.265"></a><span id="l36.265">    *</span>
<a href="#l36.266"></a><span id="l36.266">    * @param aCommand - the command to prompt for</span>
<a href="#l36.267"></a><span id="l36.267">    */</span>
<a href="#l36.268"></a><span id="l36.268">   _checkConfirmationPrompt: function ftc_confirm(aCommand) {</span>
<a href="#l36.269"></a><span id="l36.269">     const Cc = Components.classes;</span>
<a href="#l36.270"></a><span id="l36.270">     const Ci = Components.interfaces;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l37.1"></a><span id="l37.1" class="difflineminus">--- a/mail/base/content/mail-offline.js</span>
<a href="#l37.2"></a><span id="l37.2" class="difflineplus">+++ b/mail/base/content/mail-offline.js</span>
<a href="#l37.3"></a><span id="l37.3" class="difflineat">@@ -259,12 +259,11 @@ var MailOfflineMgr = {</span>
<a href="#l37.4"></a><span id="l37.4">     }    </span>
<a href="#l37.5"></a><span id="l37.5">   },   </span>
<a href="#l37.6"></a><span id="l37.6"> </span>
<a href="#l37.7"></a><span id="l37.7">   /**</span>
<a href="#l37.8"></a><span id="l37.8">    * private helper method called whenever we detect a change to the offline state</span>
<a href="#l37.9"></a><span id="l37.9">    */ </span>
<a href="#l37.10"></a><span id="l37.10">   mailOfflineStateChanged: function (aGoingOffline)</span>
<a href="#l37.11"></a><span id="l37.11">   {</span>
<a href="#l37.12"></a><span id="l37.12" class="difflineminus">-    gFolderJustSwitched = true;</span>
<a href="#l37.13"></a><span id="l37.13">     this.updateOfflineUI(aGoingOffline);</span>
<a href="#l37.14"></a><span id="l37.14">   }</span>
<a href="#l37.15"></a><span id="l37.15"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l38.1"></a><span id="l38.1" class="difflineminus">--- a/mail/base/content/mail3PaneWindowCommands.js</span>
<a href="#l38.2"></a><span id="l38.2" class="difflineplus">+++ b/mail/base/content/mail3PaneWindowCommands.js</span>
<a href="#l38.3"></a><span id="l38.3" class="difflineat">@@ -1,48 +1,47 @@</span>
<a href="#l38.4"></a><span id="l38.4" class="difflineminus">-# -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l38.5"></a><span id="l38.5" class="difflineminus">-# ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l38.6"></a><span id="l38.6" class="difflineminus">-# Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l38.7"></a><span id="l38.7" class="difflineminus">-#</span>
<a href="#l38.8"></a><span id="l38.8" class="difflineminus">-# The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l38.9"></a><span id="l38.9" class="difflineminus">-# 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l38.10"></a><span id="l38.10" class="difflineminus">-# the License. You may obtain a copy of the License at</span>
<a href="#l38.11"></a><span id="l38.11" class="difflineminus">-# http://www.mozilla.org/MPL/</span>
<a href="#l38.12"></a><span id="l38.12" class="difflineminus">-#</span>
<a href="#l38.13"></a><span id="l38.13" class="difflineminus">-# Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l38.14"></a><span id="l38.14" class="difflineminus">-# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l38.15"></a><span id="l38.15" class="difflineminus">-# for the specific language governing rights and limitations under the</span>
<a href="#l38.16"></a><span id="l38.16" class="difflineminus">-# License.</span>
<a href="#l38.17"></a><span id="l38.17" class="difflineminus">-#</span>
<a href="#l38.18"></a><span id="l38.18" class="difflineminus">-# The Original Code is Mozilla Communicator client code, released</span>
<a href="#l38.19"></a><span id="l38.19" class="difflineminus">-# March 31, 1998.</span>
<a href="#l38.20"></a><span id="l38.20" class="difflineminus">-#</span>
<a href="#l38.21"></a><span id="l38.21" class="difflineminus">-# The Initial Developer of the Original Code is</span>
<a href="#l38.22"></a><span id="l38.22" class="difflineminus">-# Netscape Communications Corporation.</span>
<a href="#l38.23"></a><span id="l38.23" class="difflineminus">-# Portions created by the Initial Developer are Copyright (C) 1998-2000</span>
<a href="#l38.24"></a><span id="l38.24" class="difflineminus">-# the Initial Developer. All Rights Reserved.</span>
<a href="#l38.25"></a><span id="l38.25" class="difflineminus">-#</span>
<a href="#l38.26"></a><span id="l38.26" class="difflineminus">-# Contributor(s):</span>
<a href="#l38.27"></a><span id="l38.27" class="difflineminus">-#   Jan Varga &lt;varga@nixcorp.com&gt;</span>
<a href="#l38.28"></a><span id="l38.28" class="difflineminus">-#   HÃ¥kan Waara &lt;hwaara@gmail.com&gt;</span>
<a href="#l38.29"></a><span id="l38.29" class="difflineminus">-#   Magnus Melin &lt;mkmelin+mozilla@iki.fi&gt;</span>
<a href="#l38.30"></a><span id="l38.30" class="difflineminus">-#</span>
<a href="#l38.31"></a><span id="l38.31" class="difflineminus">-# Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l38.32"></a><span id="l38.32" class="difflineminus">-# either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l38.33"></a><span id="l38.33" class="difflineminus">-# the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l38.34"></a><span id="l38.34" class="difflineminus">-# in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l38.35"></a><span id="l38.35" class="difflineminus">-# of those above. If you wish to allow use of your version of this file only</span>
<a href="#l38.36"></a><span id="l38.36" class="difflineminus">-# under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l38.37"></a><span id="l38.37" class="difflineminus">-# use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l38.38"></a><span id="l38.38" class="difflineminus">-# decision by deleting the provisions above and replace them with the notice</span>
<a href="#l38.39"></a><span id="l38.39" class="difflineminus">-# and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l38.40"></a><span id="l38.40" class="difflineminus">-# the provisions above, a recipient may use your version of this file under</span>
<a href="#l38.41"></a><span id="l38.41" class="difflineminus">-# the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l38.42"></a><span id="l38.42" class="difflineminus">-#</span>
<a href="#l38.43"></a><span id="l38.43" class="difflineminus">-# ***** END LICENSE BLOCK *****</span>
<a href="#l38.44"></a><span id="l38.44" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l38.45"></a><span id="l38.45" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l38.46"></a><span id="l38.46" class="difflineplus">+ *</span>
<a href="#l38.47"></a><span id="l38.47" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l38.48"></a><span id="l38.48" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l38.49"></a><span id="l38.49" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l38.50"></a><span id="l38.50" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l38.51"></a><span id="l38.51" class="difflineplus">+ *</span>
<a href="#l38.52"></a><span id="l38.52" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l38.53"></a><span id="l38.53" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l38.54"></a><span id="l38.54" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l38.55"></a><span id="l38.55" class="difflineplus">+ * License.</span>
<a href="#l38.56"></a><span id="l38.56" class="difflineplus">+ *</span>
<a href="#l38.57"></a><span id="l38.57" class="difflineplus">+ * The Original Code is Mozilla Communicator client code, released</span>
<a href="#l38.58"></a><span id="l38.58" class="difflineplus">+ * March 31, 1998.</span>
<a href="#l38.59"></a><span id="l38.59" class="difflineplus">+ *</span>
<a href="#l38.60"></a><span id="l38.60" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l38.61"></a><span id="l38.61" class="difflineplus">+ * Netscape Communications Corporation.</span>
<a href="#l38.62"></a><span id="l38.62" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 1998-2000</span>
<a href="#l38.63"></a><span id="l38.63" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l38.64"></a><span id="l38.64" class="difflineplus">+ *</span>
<a href="#l38.65"></a><span id="l38.65" class="difflineplus">+ * Contributor(s):</span>
<a href="#l38.66"></a><span id="l38.66" class="difflineplus">+ *   Jan Varga &lt;varga@nixcorp.com&gt;</span>
<a href="#l38.67"></a><span id="l38.67" class="difflineplus">+ *   HÃ¥kan Waara &lt;hwaara@gmail.com&gt;</span>
<a href="#l38.68"></a><span id="l38.68" class="difflineplus">+ *   Magnus Melin &lt;mkmelin+mozilla@iki.fi&gt;</span>
<a href="#l38.69"></a><span id="l38.69" class="difflineplus">+ *</span>
<a href="#l38.70"></a><span id="l38.70" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l38.71"></a><span id="l38.71" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l38.72"></a><span id="l38.72" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l38.73"></a><span id="l38.73" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l38.74"></a><span id="l38.74" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l38.75"></a><span id="l38.75" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l38.76"></a><span id="l38.76" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l38.77"></a><span id="l38.77" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l38.78"></a><span id="l38.78" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l38.79"></a><span id="l38.79" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l38.80"></a><span id="l38.80" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l38.81"></a><span id="l38.81" class="difflineplus">+ *</span>
<a href="#l38.82"></a><span id="l38.82" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l38.83"></a><span id="l38.83"> </span>
<a href="#l38.84"></a><span id="l38.84"> var gMessengerBundle = document.getElementById(&quot;bundle_messenger&quot;);</span>
<a href="#l38.85"></a><span id="l38.85"> </span>
<a href="#l38.86"></a><span id="l38.86"> // Controller object for folder pane</span>
<a href="#l38.87"></a><span id="l38.87"> var FolderPaneController =</span>
<a href="#l38.88"></a><span id="l38.88"> {</span>
<a href="#l38.89"></a><span id="l38.89">   supportsCommand: function(command)</span>
<a href="#l38.90"></a><span id="l38.90">   {</span>
<a href="#l38.91"></a><span id="l38.91" class="difflineat">@@ -103,17 +102,17 @@ var FolderPaneController =</span>
<a href="#l38.92"></a><span id="l38.92">     if (!this.isCommandEnabled(command)) return;</span>
<a href="#l38.93"></a><span id="l38.93"> </span>
<a href="#l38.94"></a><span id="l38.94">     switch ( command )</span>
<a href="#l38.95"></a><span id="l38.95">     {</span>
<a href="#l38.96"></a><span id="l38.96">       case &quot;cmd_delete&quot;:</span>
<a href="#l38.97"></a><span id="l38.97">       case &quot;cmd_shiftDelete&quot;:</span>
<a href="#l38.98"></a><span id="l38.98">       case &quot;button_delete&quot;:</span>
<a href="#l38.99"></a><span id="l38.99">       case &quot;cmd_deleteFolder&quot;:</span>
<a href="#l38.100"></a><span id="l38.100" class="difflineminus">-        gFolderTreeController.deleteFolder(); </span>
<a href="#l38.101"></a><span id="l38.101" class="difflineplus">+        gFolderTreeController.deleteFolder();</span>
<a href="#l38.102"></a><span id="l38.102">         break;</span>
<a href="#l38.103"></a><span id="l38.103">     }</span>
<a href="#l38.104"></a><span id="l38.104">   },</span>
<a href="#l38.105"></a><span id="l38.105"> </span>
<a href="#l38.106"></a><span id="l38.106">   onEvent: function(event)</span>
<a href="#l38.107"></a><span id="l38.107">   {</span>
<a href="#l38.108"></a><span id="l38.108">   }</span>
<a href="#l38.109"></a><span id="l38.109"> };</span>
<a href="#l38.110"></a><span id="l38.110" class="difflineat">@@ -237,17 +236,17 @@ var DefaultController =</span>
<a href="#l38.111"></a><span id="l38.111">       case &quot;cmd_downloadFlagged&quot;:</span>
<a href="#l38.112"></a><span id="l38.112">       case &quot;cmd_downloadSelected&quot;:</span>
<a href="#l38.113"></a><span id="l38.113">       case &quot;cmd_synchronizeOffline&quot;:</span>
<a href="#l38.114"></a><span id="l38.114">         return MailOfflineMgr.isOnline();</span>
<a href="#l38.115"></a><span id="l38.115"> </span>
<a href="#l38.116"></a><span id="l38.116">       case &quot;cmd_watchThread&quot;:</span>
<a href="#l38.117"></a><span id="l38.117">       case &quot;cmd_killThread&quot;:</span>
<a href="#l38.118"></a><span id="l38.118">       case &quot;cmd_killSubthread&quot;:</span>
<a href="#l38.119"></a><span id="l38.119" class="difflineminus">-        return(isNewsURI(GetFirstSelectedMessage()));</span>
<a href="#l38.120"></a><span id="l38.120" class="difflineplus">+        return(gFolderDisplay.selectedMessageIsNews);</span>
<a href="#l38.121"></a><span id="l38.121"> </span>
<a href="#l38.122"></a><span id="l38.122">       default:</span>
<a href="#l38.123"></a><span id="l38.123">         return false;</span>
<a href="#l38.124"></a><span id="l38.124">     }</span>
<a href="#l38.125"></a><span id="l38.125">   },</span>
<a href="#l38.126"></a><span id="l38.126"> </span>
<a href="#l38.127"></a><span id="l38.127">   isCommandEnabled: function(command)</span>
<a href="#l38.128"></a><span id="l38.128">   {</span>
<a href="#l38.129"></a><span id="l38.129" class="difflineat">@@ -257,45 +256,37 @@ var DefaultController =</span>
<a href="#l38.130"></a><span id="l38.130"> </span>
<a href="#l38.131"></a><span id="l38.131">     switch ( command )</span>
<a href="#l38.132"></a><span id="l38.132">     {</span>
<a href="#l38.133"></a><span id="l38.133">       case &quot;cmd_delete&quot;:</span>
<a href="#l38.134"></a><span id="l38.134">         UpdateDeleteCommand();</span>
<a href="#l38.135"></a><span id="l38.135">         // fall through</span>
<a href="#l38.136"></a><span id="l38.136">       case &quot;button_delete&quot;:</span>
<a href="#l38.137"></a><span id="l38.137">         UpdateDeleteToolbarButton();</span>
<a href="#l38.138"></a><span id="l38.138" class="difflineminus">-        if (gDBView)</span>
<a href="#l38.139"></a><span id="l38.139" class="difflineminus">-          gDBView.getCommandStatus(nsMsgViewCommandType.deleteMsg, enabled, checkStatus);</span>
<a href="#l38.140"></a><span id="l38.140" class="difflineminus">-        return enabled.value;</span>
<a href="#l38.141"></a><span id="l38.141" class="difflineplus">+        return gFolderDisplay.getCommandStatus(nsMsgViewCommandType.deleteMsg);</span>
<a href="#l38.142"></a><span id="l38.142">       case &quot;cmd_shiftDelete&quot;:</span>
<a href="#l38.143"></a><span id="l38.143" class="difflineminus">-        if (gDBView)</span>
<a href="#l38.144"></a><span id="l38.144" class="difflineminus">-          gDBView.getCommandStatus(nsMsgViewCommandType.deleteNoTrash, enabled, checkStatus);</span>
<a href="#l38.145"></a><span id="l38.145" class="difflineminus">-        return enabled.value;</span>
<a href="#l38.146"></a><span id="l38.146" class="difflineplus">+        return gFolderDisplay.getCommandStatus(nsMsgViewCommandType.deleteNoTrash);</span>
<a href="#l38.147"></a><span id="l38.147">       case &quot;cmd_deleteFolder&quot;:</span>
<a href="#l38.148"></a><span id="l38.148">         var folders = gFolderTreeView.getSelectedFolders();</span>
<a href="#l38.149"></a><span id="l38.149">         if (folders.length == 1) {</span>
<a href="#l38.150"></a><span id="l38.150">           var folder = folders[0];</span>
<a href="#l38.151"></a><span id="l38.151">           if (folder.server.type == &quot;nntp&quot;)</span>
<a href="#l38.152"></a><span id="l38.152">             return false; // Just disable the command for news.</span>
<a href="#l38.153"></a><span id="l38.153">           else</span>
<a href="#l38.154"></a><span id="l38.154">             return CanDeleteFolder(folder);</span>
<a href="#l38.155"></a><span id="l38.155">         }</span>
<a href="#l38.156"></a><span id="l38.156">         return false;</span>
<a href="#l38.157"></a><span id="l38.157">       case &quot;button_junk&quot;:</span>
<a href="#l38.158"></a><span id="l38.158">         UpdateJunkToolbarButton();</span>
<a href="#l38.159"></a><span id="l38.159" class="difflineminus">-        if (gDBView)</span>
<a href="#l38.160"></a><span id="l38.160" class="difflineminus">-          gDBView.getCommandStatus(nsMsgViewCommandType.junk, enabled, checkStatus);</span>
<a href="#l38.161"></a><span id="l38.161" class="difflineminus">-        return enabled.value;</span>
<a href="#l38.162"></a><span id="l38.162" class="difflineplus">+        return gFolderDisplay.getCommandStatus(nsMsgViewCommandType.junk);</span>
<a href="#l38.163"></a><span id="l38.163">       case &quot;cmd_killThread&quot;:</span>
<a href="#l38.164"></a><span id="l38.164">       case &quot;cmd_killSubthread&quot;:</span>
<a href="#l38.165"></a><span id="l38.165">         return GetNumSelectedMessages() &gt; 0;</span>
<a href="#l38.166"></a><span id="l38.166">       case &quot;cmd_watchThread&quot;:</span>
<a href="#l38.167"></a><span id="l38.167" class="difflineminus">-        if (gDBView)</span>
<a href="#l38.168"></a><span id="l38.168" class="difflineminus">-          gDBView.getCommandStatus(nsMsgViewCommandType.toggleThreadWatched, enabled, checkStatus);</span>
<a href="#l38.169"></a><span id="l38.169" class="difflineminus">-        return enabled.value;</span>
<a href="#l38.170"></a><span id="l38.170" class="difflineplus">+        return gFolderDisplay.getCommandStatus(nsMsgViewCommandType.toggleThreadWatched);</span>
<a href="#l38.171"></a><span id="l38.171">       case &quot;cmd_createFilterFromPopup&quot;:</span>
<a href="#l38.172"></a><span id="l38.172">       case &quot;cmd_createFilterFromMenu&quot;:</span>
<a href="#l38.173"></a><span id="l38.173">         var loadedFolder = GetLoadedMsgFolder();</span>
<a href="#l38.174"></a><span id="l38.174">         if (!(loadedFolder &amp;&amp; loadedFolder.server.canHaveFilters))</span>
<a href="#l38.175"></a><span id="l38.175">           return false;   // else fall thru</span>
<a href="#l38.176"></a><span id="l38.176">       case &quot;cmd_saveAsFile&quot;:</span>
<a href="#l38.177"></a><span id="l38.177">       case &quot;cmd_saveAsTemplate&quot;:</span>
<a href="#l38.178"></a><span id="l38.178">         if (GetNumSelectedMessages() &gt; 1)</span>
<a href="#l38.179"></a><span id="l38.179" class="difflineat">@@ -324,29 +315,30 @@ var DefaultController =</span>
<a href="#l38.180"></a><span id="l38.180">           var whichText = &quot;valueMessage&quot;;</span>
<a href="#l38.181"></a><span id="l38.181">           if (GetNumSelectedMessages() &gt; 1)</span>
<a href="#l38.182"></a><span id="l38.182">             whichText = &quot;valueSelection&quot;;</span>
<a href="#l38.183"></a><span id="l38.183">           goSetMenuValue(command, whichText);</span>
<a href="#l38.184"></a><span id="l38.184">           goSetAccessKey(command, whichText + &quot;AccessKey&quot;);</span>
<a href="#l38.185"></a><span id="l38.185">         }</span>
<a href="#l38.186"></a><span id="l38.186">         if (GetNumSelectedMessages() &gt; 0)</span>
<a href="#l38.187"></a><span id="l38.187">         {</span>
<a href="#l38.188"></a><span id="l38.188" class="difflineminus">-          if (gDBView)</span>
<a href="#l38.189"></a><span id="l38.189" class="difflineminus">-          {</span>
<a href="#l38.190"></a><span id="l38.190" class="difflineminus">-            gDBView.getCommandStatus(nsMsgViewCommandType.cmdRequiringMsgBody, enabled, checkStatus);</span>
<a href="#l38.191"></a><span id="l38.191" class="difflineminus">-            return enabled.value;</span>
<a href="#l38.192"></a><span id="l38.192" class="difflineminus">-          }</span>
<a href="#l38.193"></a><span id="l38.193" class="difflineplus">+          if (!gFolderDisplay.getCommandStatus(nsMsgViewCommandType.cmdRequiringMsgBody))</span>
<a href="#l38.194"></a><span id="l38.194" class="difflineplus">+            return false;</span>
<a href="#l38.195"></a><span id="l38.195" class="difflineplus">+          if (command == &quot;cmd_reply&quot; || command == &quot;button_reply&quot;)</span>
<a href="#l38.196"></a><span id="l38.196" class="difflineplus">+            return IsReplyEnabled();</span>
<a href="#l38.197"></a><span id="l38.197" class="difflineplus">+          if (command == &quot;cmd_replyall&quot; || command == &quot;button_replyall&quot;)</span>
<a href="#l38.198"></a><span id="l38.198" class="difflineplus">+            return IsReplyAllEnabled();</span>
<a href="#l38.199"></a><span id="l38.199" class="difflineplus">+          if (command == &quot;cmd_replylist&quot; || command == &quot;button_replylist&quot;)</span>
<a href="#l38.200"></a><span id="l38.200" class="difflineplus">+            return IsReplyListEnabled();</span>
<a href="#l38.201"></a><span id="l38.201" class="difflineplus">+          return true;</span>
<a href="#l38.202"></a><span id="l38.202">         }</span>
<a href="#l38.203"></a><span id="l38.203">         return false;</span>
<a href="#l38.204"></a><span id="l38.204">       case &quot;cmd_printpreview&quot;:</span>
<a href="#l38.205"></a><span id="l38.205" class="difflineminus">-        if ( GetNumSelectedMessages() == 1 &amp;&amp; gDBView)</span>
<a href="#l38.206"></a><span id="l38.206" class="difflineminus">-        {</span>
<a href="#l38.207"></a><span id="l38.207" class="difflineminus">-           gDBView.getCommandStatus(nsMsgViewCommandType.cmdRequiringMsgBody, enabled, checkStatus);</span>
<a href="#l38.208"></a><span id="l38.208" class="difflineminus">-           return enabled.value;</span>
<a href="#l38.209"></a><span id="l38.209" class="difflineminus">-        }</span>
<a href="#l38.210"></a><span id="l38.210" class="difflineplus">+        if (GetNumSelectedMessages() == 1)</span>
<a href="#l38.211"></a><span id="l38.211" class="difflineplus">+          return gFolderDisplay.getCommandStatus(nsMsgViewCommandType.cmdRequiringMsgBody);</span>
<a href="#l38.212"></a><span id="l38.212">         return false;</span>
<a href="#l38.213"></a><span id="l38.213">       case &quot;cmd_printSetup&quot;:</span>
<a href="#l38.214"></a><span id="l38.214">         return true;</span>
<a href="#l38.215"></a><span id="l38.215">       case &quot;cmd_markAsFlagged&quot;:</span>
<a href="#l38.216"></a><span id="l38.216">       case &quot;button_file&quot;:</span>
<a href="#l38.217"></a><span id="l38.217">       case &quot;cmd_file&quot;:</span>
<a href="#l38.218"></a><span id="l38.218">       case &quot;cmd_archive&quot;:</span>
<a href="#l38.219"></a><span id="l38.219">         return (GetNumSelectedMessages() &gt; 0 );</span>
<a href="#l38.220"></a><span id="l38.220" class="difflineat">@@ -355,33 +347,27 @@ var DefaultController =</span>
<a href="#l38.221"></a><span id="l38.221">         let folder = GetLoadedMsgFolder();</span>
<a href="#l38.222"></a><span id="l38.222">         return GetNumSelectedMessages() &gt; 0 &amp;&amp; folder &amp;&amp;</span>
<a href="#l38.223"></a><span id="l38.223">           !(IsSpecialFolder(folder, Components.interfaces.nsMsgFolderFlags.Archive,</span>
<a href="#l38.224"></a><span id="l38.224">                             true));</span>
<a href="#l38.225"></a><span id="l38.225">       }</span>
<a href="#l38.226"></a><span id="l38.226">       case &quot;cmd_markAsJunk&quot;:</span>
<a href="#l38.227"></a><span id="l38.227">       case &quot;cmd_markAsNotJunk&quot;:</span>
<a href="#l38.228"></a><span id="l38.228">         // can't do news on junk yet.</span>
<a href="#l38.229"></a><span id="l38.229" class="difflineminus">-        return (GetNumSelectedMessages() &gt; 0 &amp;&amp; !isNewsURI(GetFirstSelectedMessage()));</span>
<a href="#l38.230"></a><span id="l38.230" class="difflineplus">+        return (GetNumSelectedMessages() &gt; 0 &amp;&amp; !gFolderDisplay.selectedMessageIsNews);</span>
<a href="#l38.231"></a><span id="l38.231">       case &quot;cmd_recalculateJunkScore&quot;:</span>
<a href="#l38.232"></a><span id="l38.232">         if (GetNumSelectedMessages() &gt; 0)</span>
<a href="#l38.233"></a><span id="l38.233" class="difflineminus">-          gDBView.getCommandStatus(nsMsgViewCommandType.runJunkControls, enabled, checkStatus);</span>
<a href="#l38.234"></a><span id="l38.234" class="difflineminus">-        return enabled.value;</span>
<a href="#l38.235"></a><span id="l38.235" class="difflineplus">+          return gFolderDisplay.getCommandStatus(nsMsgViewCommandType.runJunkControls);</span>
<a href="#l38.236"></a><span id="l38.236" class="difflineplus">+        return false;</span>
<a href="#l38.237"></a><span id="l38.237">       case &quot;cmd_applyFilters&quot;:</span>
<a href="#l38.238"></a><span id="l38.238" class="difflineminus">-        if (gDBView)</span>
<a href="#l38.239"></a><span id="l38.239" class="difflineminus">-          gDBView.getCommandStatus(nsMsgViewCommandType.applyFilters, enabled, checkStatus);</span>
<a href="#l38.240"></a><span id="l38.240" class="difflineminus">-        return enabled.value;</span>
<a href="#l38.241"></a><span id="l38.241" class="difflineplus">+        return gFolderDisplay.getCommandStatus(nsMsgViewCommandType.applyFilters);</span>
<a href="#l38.242"></a><span id="l38.242">       case &quot;cmd_runJunkControls&quot;:</span>
<a href="#l38.243"></a><span id="l38.243" class="difflineminus">-        if (gDBView)</span>
<a href="#l38.244"></a><span id="l38.244" class="difflineminus">-          gDBView.getCommandStatus(nsMsgViewCommandType.runJunkControls, enabled, checkStatus);</span>
<a href="#l38.245"></a><span id="l38.245" class="difflineminus">-        return enabled.value;</span>
<a href="#l38.246"></a><span id="l38.246" class="difflineplus">+        return gFolderDisplay.getCommandStatus(nsMsgViewCommandType.runJunkControls);</span>
<a href="#l38.247"></a><span id="l38.247">       case &quot;cmd_deleteJunk&quot;:</span>
<a href="#l38.248"></a><span id="l38.248" class="difflineminus">-        if (gDBView)</span>
<a href="#l38.249"></a><span id="l38.249" class="difflineminus">-          gDBView.getCommandStatus(nsMsgViewCommandType.deleteJunk, enabled, checkStatus);</span>
<a href="#l38.250"></a><span id="l38.250" class="difflineminus">-        return enabled.value;</span>
<a href="#l38.251"></a><span id="l38.251" class="difflineplus">+        return gFolderDisplay.getCommandStatus(nsMsgViewCommandType.deleteJunk);</span>
<a href="#l38.252"></a><span id="l38.252">       case &quot;button_mark&quot;:</span>
<a href="#l38.253"></a><span id="l38.253">       case &quot;cmd_tag&quot;:</span>
<a href="#l38.254"></a><span id="l38.254">       case &quot;cmd_markAsRead&quot;:</span>
<a href="#l38.255"></a><span id="l38.255">       case &quot;cmd_markThreadAsRead&quot;:</span>
<a href="#l38.256"></a><span id="l38.256">         return GetNumSelectedMessages() &gt; 0;</span>
<a href="#l38.257"></a><span id="l38.257">       case &quot;button_previous&quot;:</span>
<a href="#l38.258"></a><span id="l38.258">       case &quot;button_next&quot;:</span>
<a href="#l38.259"></a><span id="l38.259">         return IsViewNavigationItemEnabled();</span>
<a href="#l38.260"></a><span id="l38.260" class="difflineat">@@ -413,28 +399,27 @@ var DefaultController =</span>
<a href="#l38.261"></a><span id="l38.261">       case &quot;cmd_selectAll&quot;:</span>
<a href="#l38.262"></a><span id="l38.262">       case &quot;cmd_selectFlagged&quot;:</span>
<a href="#l38.263"></a><span id="l38.263">         return gDBView != null;</span>
<a href="#l38.264"></a><span id="l38.264">       // these are enabled on when we are in threaded mode</span>
<a href="#l38.265"></a><span id="l38.265">       case &quot;cmd_selectThread&quot;:</span>
<a href="#l38.266"></a><span id="l38.266">         if (GetNumSelectedMessages() &lt;= 0) return false;</span>
<a href="#l38.267"></a><span id="l38.267">       case &quot;cmd_expandAllThreads&quot;:</span>
<a href="#l38.268"></a><span id="l38.268">       case &quot;cmd_collapseAllThreads&quot;:</span>
<a href="#l38.269"></a><span id="l38.269" class="difflineminus">-        return gDBView &amp;&amp; (gDBView.viewFlags &amp; nsMsgViewFlagsType.kThreadedDisplay);</span>
<a href="#l38.270"></a><span id="l38.270" class="difflineplus">+        return gFolderDisplay.view.showThreaded;</span>
<a href="#l38.271"></a><span id="l38.271">       case &quot;cmd_nextFlaggedMsg&quot;:</span>
<a href="#l38.272"></a><span id="l38.272">       case &quot;cmd_previousFlaggedMsg&quot;:</span>
<a href="#l38.273"></a><span id="l38.273">         return IsViewNavigationItemEnabled();</span>
<a href="#l38.274"></a><span id="l38.274">       case &quot;cmd_viewAllMsgs&quot;:</span>
<a href="#l38.275"></a><span id="l38.275">       case &quot;cmd_viewUnreadMsgs&quot;:</span>
<a href="#l38.276"></a><span id="l38.276">       case &quot;cmd_viewIgnoredThreads&quot;:</span>
<a href="#l38.277"></a><span id="l38.277">         return gDBView;</span>
<a href="#l38.278"></a><span id="l38.278">       case &quot;cmd_viewThreadsWithUnread&quot;:</span>
<a href="#l38.279"></a><span id="l38.279">       case &quot;cmd_viewWatchedThreadsWithUnread&quot;:</span>
<a href="#l38.280"></a><span id="l38.280" class="difflineminus">-        return gDBView &amp;&amp; !(GetSelectedMsgFolders()[0].flags &amp; </span>
<a href="#l38.281"></a><span id="l38.281" class="difflineminus">-                            Components.interfaces.nsMsgFolderFlags.Virtual);</span>
<a href="#l38.282"></a><span id="l38.282" class="difflineplus">+        return !gFolderDisplay.view.isVirtual;</span>
<a href="#l38.283"></a><span id="l38.283">       case &quot;cmd_stop&quot;:</span>
<a href="#l38.284"></a><span id="l38.284">         return true;</span>
<a href="#l38.285"></a><span id="l38.285">       case &quot;cmd_undo&quot;:</span>
<a href="#l38.286"></a><span id="l38.286">       case &quot;cmd_redo&quot;:</span>
<a href="#l38.287"></a><span id="l38.287">           return SetupUndoRedoCommand(command);</span>
<a href="#l38.288"></a><span id="l38.288">       case &quot;cmd_renameFolder&quot;:</span>
<a href="#l38.289"></a><span id="l38.289">       {</span>
<a href="#l38.290"></a><span id="l38.290">         let folders = gFolderTreeView.getSelectedFolders();</span>
<a href="#l38.291"></a><span id="l38.291" class="difflineat">@@ -564,36 +549,41 @@ var DefaultController =</span>
<a href="#l38.292"></a><span id="l38.292">         break;</span>
<a href="#l38.293"></a><span id="l38.293">       case &quot;cmd_createFilterFromPopup&quot;:</span>
<a href="#l38.294"></a><span id="l38.294">         break;// This does nothing because the createfilter is invoked from the popupnode oncommand.</span>
<a href="#l38.295"></a><span id="l38.295">       case &quot;button_delete&quot;:</span>
<a href="#l38.296"></a><span id="l38.296">       case &quot;cmd_delete&quot;:</span>
<a href="#l38.297"></a><span id="l38.297">          // if the user deletes a message before its mark as read timer goes off, we should mark it as read</span>
<a href="#l38.298"></a><span id="l38.298">          // this ensures that we clear the biff indicator from the system tray when the user deletes the new message</span>
<a href="#l38.299"></a><span id="l38.299">         MarkSelectedMessagesRead(true);</span>
<a href="#l38.300"></a><span id="l38.300" class="difflineminus">-        SetNextMessageAfterDelete();</span>
<a href="#l38.301"></a><span id="l38.301" class="difflineminus">-        gDBView.doCommand(nsMsgViewCommandType.deleteMsg);</span>
<a href="#l38.302"></a><span id="l38.302" class="difflineplus">+        // If this is a right-click triggered delete, then do not hint about</span>
<a href="#l38.303"></a><span id="l38.303" class="difflineplus">+        //  the deletion.  Note: The code that swaps the selection back in will</span>
<a href="#l38.304"></a><span id="l38.304" class="difflineplus">+        //  take care of ensuring that this deletion does not make the saved</span>
<a href="#l38.305"></a><span id="l38.305" class="difflineplus">+        //  selection incorrect.</span>
<a href="#l38.306"></a><span id="l38.306" class="difflineplus">+        if (!gRightMouseButtonSavedSelection)</span>
<a href="#l38.307"></a><span id="l38.307" class="difflineplus">+          gFolderDisplay.hintAboutToDeleteMessages();</span>
<a href="#l38.308"></a><span id="l38.308" class="difflineplus">+        gFolderDisplay.doCommand(nsMsgViewCommandType.deleteMsg);</span>
<a href="#l38.309"></a><span id="l38.309">         break;</span>
<a href="#l38.310"></a><span id="l38.310">       case &quot;cmd_shiftDelete&quot;:</span>
<a href="#l38.311"></a><span id="l38.311">         MarkSelectedMessagesRead(true);</span>
<a href="#l38.312"></a><span id="l38.312" class="difflineminus">-        SetNextMessageAfterDelete();</span>
<a href="#l38.313"></a><span id="l38.313" class="difflineminus">-        gDBView.doCommand(nsMsgViewCommandType.deleteNoTrash);</span>
<a href="#l38.314"></a><span id="l38.314" class="difflineplus">+        gFolderDisplay.hintAboutToDeleteMessages();</span>
<a href="#l38.315"></a><span id="l38.315" class="difflineplus">+        gFolderDisplay.doCommand(nsMsgViewCommandType.deleteNoTrash);</span>
<a href="#l38.316"></a><span id="l38.316">         break;</span>
<a href="#l38.317"></a><span id="l38.317">       case &quot;cmd_deleteFolder&quot;:</span>
<a href="#l38.318"></a><span id="l38.318">         gFolderTreeController.deleteFolder();</span>
<a href="#l38.319"></a><span id="l38.319">         break;</span>
<a href="#l38.320"></a><span id="l38.320">       case &quot;cmd_killThread&quot;:</span>
<a href="#l38.321"></a><span id="l38.321">         /* kill thread kills the thread and then does a next unread */</span>
<a href="#l38.322"></a><span id="l38.322">         GoNextMessage(nsMsgNavigationType.toggleThreadKilled, true);</span>
<a href="#l38.323"></a><span id="l38.323">         break;</span>
<a href="#l38.324"></a><span id="l38.324">       case &quot;cmd_killSubthread&quot;:</span>
<a href="#l38.325"></a><span id="l38.325">         GoNextMessage(nsMsgNavigationType.toggleSubthreadKilled, true);</span>
<a href="#l38.326"></a><span id="l38.326">         break;</span>
<a href="#l38.327"></a><span id="l38.327">       case &quot;cmd_watchThread&quot;:</span>
<a href="#l38.328"></a><span id="l38.328" class="difflineminus">-        gDBView.doCommand(nsMsgViewCommandType.toggleThreadWatched);</span>
<a href="#l38.329"></a><span id="l38.329" class="difflineplus">+        gFolderDisplay.doCommand(nsMsgViewCommandType.toggleThreadWatched);</span>
<a href="#l38.330"></a><span id="l38.330">         break;</span>
<a href="#l38.331"></a><span id="l38.331">       case &quot;button_next&quot;:</span>
<a href="#l38.332"></a><span id="l38.332">       case &quot;cmd_nextUnreadMsg&quot;:</span>
<a href="#l38.333"></a><span id="l38.333">         GoNextMessage(nsMsgNavigationType.nextUnreadMessage, true);</span>
<a href="#l38.334"></a><span id="l38.334">         break;</span>
<a href="#l38.335"></a><span id="l38.335">       case &quot;cmd_nextUnreadThread&quot;:</span>
<a href="#l38.336"></a><span id="l38.336">         GoNextMessage(nsMsgNavigationType.nextUnreadThread, true);</span>
<a href="#l38.337"></a><span id="l38.337">         break;</span>
<a href="#l38.338"></a><span id="l38.338" class="difflineat">@@ -634,20 +624,23 @@ var DefaultController =</span>
<a href="#l38.339"></a><span id="l38.339">         break;</span>
<a href="#l38.340"></a><span id="l38.340">       case &quot;cmd_undo&quot;:</span>
<a href="#l38.341"></a><span id="l38.341">         messenger.undo(msgWindow);</span>
<a href="#l38.342"></a><span id="l38.342">         break;</span>
<a href="#l38.343"></a><span id="l38.343">       case &quot;cmd_redo&quot;:</span>
<a href="#l38.344"></a><span id="l38.344">         messenger.redo(msgWindow);</span>
<a href="#l38.345"></a><span id="l38.345">         break;</span>
<a href="#l38.346"></a><span id="l38.346">       case &quot;cmd_expandAllThreads&quot;:</span>
<a href="#l38.347"></a><span id="l38.347" class="difflineminus">-        gDBView.doCommand(nsMsgViewCommandType.expandAll);</span>
<a href="#l38.348"></a><span id="l38.348" class="difflineplus">+        gFolderDisplay.doCommand(nsMsgViewCommandType.expandAll);</span>
<a href="#l38.349"></a><span id="l38.349" class="difflineplus">+        gFolderDisplay.ensureSelectionIsVisible();</span>
<a href="#l38.350"></a><span id="l38.350">         break;</span>
<a href="#l38.351"></a><span id="l38.351">       case &quot;cmd_collapseAllThreads&quot;:</span>
<a href="#l38.352"></a><span id="l38.352" class="difflineminus">-        gDBView.doCommand(nsMsgViewCommandType.collapseAll);</span>
<a href="#l38.353"></a><span id="l38.353" class="difflineplus">+        gFolderDisplay.selectSelectedThreadRoots();</span>
<a href="#l38.354"></a><span id="l38.354" class="difflineplus">+        gFolderDisplay.doCommand(nsMsgViewCommandType.collapseAll);</span>
<a href="#l38.355"></a><span id="l38.355" class="difflineplus">+        gFolderDisplay.ensureSelectionIsVisible();</span>
<a href="#l38.356"></a><span id="l38.356">         break;</span>
<a href="#l38.357"></a><span id="l38.357">       case &quot;cmd_renameFolder&quot;:</span>
<a href="#l38.358"></a><span id="l38.358">         gFolderTreeController.renameFolder();</span>
<a href="#l38.359"></a><span id="l38.359">         return;</span>
<a href="#l38.360"></a><span id="l38.360">       case &quot;cmd_sendUnsentMsgs&quot;:</span>
<a href="#l38.361"></a><span id="l38.361">         // if offline, prompt for sendUnsentMessages</span>
<a href="#l38.362"></a><span id="l38.362">         if (MailOfflineMgr.isOnline())</span>
<a href="#l38.363"></a><span id="l38.363">           SendUnsentMessages();</span>
<a href="#l38.364"></a><span id="l38.364" class="difflineat">@@ -668,17 +661,17 @@ var DefaultController =</span>
<a href="#l38.365"></a><span id="l38.365">         return;</span>
<a href="#l38.366"></a><span id="l38.366">       case &quot;cmd_saveAsFile&quot;:</span>
<a href="#l38.367"></a><span id="l38.367">         MsgSaveAsFile();</span>
<a href="#l38.368"></a><span id="l38.368">         return;</span>
<a href="#l38.369"></a><span id="l38.369">       case &quot;cmd_saveAsTemplate&quot;:</span>
<a href="#l38.370"></a><span id="l38.370">         MsgSaveAsTemplate();</span>
<a href="#l38.371"></a><span id="l38.371">         return;</span>
<a href="#l38.372"></a><span id="l38.372">       case &quot;cmd_viewPageSource&quot;:</span>
<a href="#l38.373"></a><span id="l38.373" class="difflineminus">-        ViewPageSource(GetSelectedMessages());</span>
<a href="#l38.374"></a><span id="l38.374" class="difflineplus">+        ViewPageSource(gFolderDisplay.selectedMessageUris);</span>
<a href="#l38.375"></a><span id="l38.375">         return;</span>
<a href="#l38.376"></a><span id="l38.376">       case &quot;cmd_setFolderCharset&quot;:</span>
<a href="#l38.377"></a><span id="l38.377">         gFolderTreeController.editFolder();</span>
<a href="#l38.378"></a><span id="l38.378">         return;</span>
<a href="#l38.379"></a><span id="l38.379">       case &quot;cmd_reload&quot;:</span>
<a href="#l38.380"></a><span id="l38.380">         ReloadMessage();</span>
<a href="#l38.381"></a><span id="l38.381">         return;</span>
<a href="#l38.382"></a><span id="l38.382">       case &quot;cmd_find&quot;:</span>
<a href="#l38.383"></a><span id="l38.383" class="difflineat">@@ -709,20 +702,20 @@ var DefaultController =</span>
<a href="#l38.384"></a><span id="l38.384">         MsgSearchMessages();</span>
<a href="#l38.385"></a><span id="l38.385">         return;</span>
<a href="#l38.386"></a><span id="l38.386">       case &quot;button_mark&quot;:</span>
<a href="#l38.387"></a><span id="l38.387">       case &quot;cmd_markAsRead&quot;:</span>
<a href="#l38.388"></a><span id="l38.388">         MsgMarkMsgAsRead();</span>
<a href="#l38.389"></a><span id="l38.389">         return;</span>
<a href="#l38.390"></a><span id="l38.390">       case &quot;cmd_markThreadAsRead&quot;:</span>
<a href="#l38.391"></a><span id="l38.391">         ClearPendingReadTimer();</span>
<a href="#l38.392"></a><span id="l38.392" class="difflineminus">-        gDBView.doCommand(nsMsgViewCommandType.markThreadRead);</span>
<a href="#l38.393"></a><span id="l38.393" class="difflineplus">+        gFolderDisplay.doCommand(nsMsgViewCommandType.markThreadRead);</span>
<a href="#l38.394"></a><span id="l38.394">         return;</span>
<a href="#l38.395"></a><span id="l38.395">       case &quot;cmd_markAllRead&quot;:</span>
<a href="#l38.396"></a><span id="l38.396" class="difflineminus">-        gDBView.doCommand(nsMsgViewCommandType.markAllRead);</span>
<a href="#l38.397"></a><span id="l38.397" class="difflineplus">+        gFolderDisplay.doCommand(nsMsgViewCommandType.markAllRead);</span>
<a href="#l38.398"></a><span id="l38.398">         return;</span>
<a href="#l38.399"></a><span id="l38.399">       case &quot;button_junk&quot;:</span>
<a href="#l38.400"></a><span id="l38.400">         MsgJunk();</span>
<a href="#l38.401"></a><span id="l38.401">         return;</span>
<a href="#l38.402"></a><span id="l38.402">       case &quot;cmd_stop&quot;:</span>
<a href="#l38.403"></a><span id="l38.403">         msgWindow.StopUrls();</span>
<a href="#l38.404"></a><span id="l38.404">         return;</span>
<a href="#l38.405"></a><span id="l38.405">       case &quot;cmd_markAsFlagged&quot;:</span>
<a href="#l38.406"></a><span id="l38.406" class="difflineat">@@ -754,20 +747,20 @@ var DefaultController =</span>
<a href="#l38.407"></a><span id="l38.407">         return;</span>
<a href="#l38.408"></a><span id="l38.408">       case &quot;cmd_compactFolder&quot;:</span>
<a href="#l38.409"></a><span id="l38.409">         gFolderTreeController.compactAllFoldersForAccount();</span>
<a href="#l38.410"></a><span id="l38.410">         return;</span>
<a href="#l38.411"></a><span id="l38.411">       case &quot;button_compact&quot;:</span>
<a href="#l38.412"></a><span id="l38.412">         gFolderTreeController.compactFolders();</span>
<a href="#l38.413"></a><span id="l38.413">         return;</span>
<a href="#l38.414"></a><span id="l38.414">       case &quot;cmd_downloadFlagged&quot;:</span>
<a href="#l38.415"></a><span id="l38.415" class="difflineminus">-          gDBView.doCommand(nsMsgViewCommandType.downloadFlaggedForOffline);</span>
<a href="#l38.416"></a><span id="l38.416" class="difflineplus">+          gFolderDisplay.doCommand(nsMsgViewCommandType.downloadFlaggedForOffline);</span>
<a href="#l38.417"></a><span id="l38.417">           break;</span>
<a href="#l38.418"></a><span id="l38.418">       case &quot;cmd_downloadSelected&quot;:</span>
<a href="#l38.419"></a><span id="l38.419" class="difflineminus">-          gDBView.doCommand(nsMsgViewCommandType.downloadSelectedForOffline);</span>
<a href="#l38.420"></a><span id="l38.420" class="difflineplus">+          gFolderDisplay.doCommand(nsMsgViewCommandType.downloadSelectedForOffline);</span>
<a href="#l38.421"></a><span id="l38.421">           break;</span>
<a href="#l38.422"></a><span id="l38.422">       case &quot;cmd_synchronizeOffline&quot;:</span>
<a href="#l38.423"></a><span id="l38.423">           MsgSynchronizeOffline();</span>
<a href="#l38.424"></a><span id="l38.424">           break;</span>
<a href="#l38.425"></a><span id="l38.425">       case &quot;cmd_settingsOffline&quot;:</span>
<a href="#l38.426"></a><span id="l38.426">           MailOfflineMgr.openOfflineAccountSettings();</span>
<a href="#l38.427"></a><span id="l38.427">           break;</span>
<a href="#l38.428"></a><span id="l38.428">       case &quot;cmd_moveToFolderAgain&quot;:</span>
<a href="#l38.429"></a><span id="l38.429" class="difflineat">@@ -776,27 +769,23 @@ var DefaultController =</span>
<a href="#l38.430"></a><span id="l38.430">             MsgMoveMessage(GetMsgFolderFromUri(folderId));</span>
<a href="#l38.431"></a><span id="l38.431">           else</span>
<a href="#l38.432"></a><span id="l38.432">             MsgCopyMessage(GetMsgFolderFromUri(folderId));</span>
<a href="#l38.433"></a><span id="l38.433">           break;</span>
<a href="#l38.434"></a><span id="l38.434">       case &quot;cmd_selectAll&quot;:</span>
<a href="#l38.435"></a><span id="l38.435">           // move the focus so the user can delete the newly selected messages, not the folder</span>
<a href="#l38.436"></a><span id="l38.436">           SetFocusThreadPane();</span>
<a href="#l38.437"></a><span id="l38.437">           // if in threaded mode, the view will expand all before selecting all</span>
<a href="#l38.438"></a><span id="l38.438" class="difflineminus">-          gDBView.doCommand(nsMsgViewCommandType.selectAll)</span>
<a href="#l38.439"></a><span id="l38.439" class="difflineminus">-          if (gDBView.numSelected != 1) {</span>
<a href="#l38.440"></a><span id="l38.440" class="difflineminus">-              setTitleFromFolder(gDBView.msgFolder,null);</span>
<a href="#l38.441"></a><span id="l38.441" class="difflineminus">-              ClearMessagePane();</span>
<a href="#l38.442"></a><span id="l38.442" class="difflineminus">-          }</span>
<a href="#l38.443"></a><span id="l38.443" class="difflineplus">+          gFolderDisplay.doCommand(nsMsgViewCommandType.selectAll);</span>
<a href="#l38.444"></a><span id="l38.444">           break;</span>
<a href="#l38.445"></a><span id="l38.445">       case &quot;cmd_selectThread&quot;:</span>
<a href="#l38.446"></a><span id="l38.446" class="difflineminus">-          gDBView.doCommand(nsMsgViewCommandType.selectThread);</span>
<a href="#l38.447"></a><span id="l38.447" class="difflineplus">+          gFolderDisplay.doCommand(nsMsgViewCommandType.selectThread);</span>
<a href="#l38.448"></a><span id="l38.448">           break;</span>
<a href="#l38.449"></a><span id="l38.449">       case &quot;cmd_selectFlagged&quot;:</span>
<a href="#l38.450"></a><span id="l38.450" class="difflineminus">-        gDBView.doCommand(nsMsgViewCommandType.selectFlagged);</span>
<a href="#l38.451"></a><span id="l38.451" class="difflineplus">+        gFolderDisplay.doCommand(nsMsgViewCommandType.selectFlagged);</span>
<a href="#l38.452"></a><span id="l38.452">         break;</span>
<a href="#l38.453"></a><span id="l38.453">       case &quot;cmd_fullZoomReduce&quot;:</span>
<a href="#l38.454"></a><span id="l38.454">         ZoomManager.reduce();</span>
<a href="#l38.455"></a><span id="l38.455">         break;</span>
<a href="#l38.456"></a><span id="l38.456">       case &quot;cmd_fullZoomEnlarge&quot;:</span>
<a href="#l38.457"></a><span id="l38.457">         ZoomManager.enlarge();</span>
<a href="#l38.458"></a><span id="l38.458">         break;</span>
<a href="#l38.459"></a><span id="l38.459">       case &quot;cmd_fullZoomReset&quot;:</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l39.1"></a><span id="l39.1" class="difflineminus">--- a/mail/base/content/mailContextMenus.js</span>
<a href="#l39.2"></a><span id="l39.2" class="difflineplus">+++ b/mail/base/content/mailContextMenus.js</span>
<a href="#l39.3"></a><span id="l39.3" class="difflineat">@@ -1,113 +1,77 @@</span>
<a href="#l39.4"></a><span id="l39.4" class="difflineminus">-# -*- Mode: C; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l39.5"></a><span id="l39.5" class="difflineminus">-#</span>
<a href="#l39.6"></a><span id="l39.6" class="difflineminus">-# ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l39.7"></a><span id="l39.7" class="difflineminus">-# Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l39.8"></a><span id="l39.8" class="difflineminus">-#</span>
<a href="#l39.9"></a><span id="l39.9" class="difflineminus">-# The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l39.10"></a><span id="l39.10" class="difflineminus">-# 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l39.11"></a><span id="l39.11" class="difflineminus">-# the License. You may obtain a copy of the License at</span>
<a href="#l39.12"></a><span id="l39.12" class="difflineminus">-# http://www.mozilla.org/MPL/</span>
<a href="#l39.13"></a><span id="l39.13" class="difflineminus">-#</span>
<a href="#l39.14"></a><span id="l39.14" class="difflineminus">-# Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l39.15"></a><span id="l39.15" class="difflineminus">-# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l39.16"></a><span id="l39.16" class="difflineminus">-# for the specific language governing rights and limitations under the</span>
<a href="#l39.17"></a><span id="l39.17" class="difflineminus">-# License.</span>
<a href="#l39.18"></a><span id="l39.18" class="difflineminus">-#</span>
<a href="#l39.19"></a><span id="l39.19" class="difflineminus">-# The Original Code is Mozilla Communicator client code, released</span>
<a href="#l39.20"></a><span id="l39.20" class="difflineminus">-# March 31, 1998.</span>
<a href="#l39.21"></a><span id="l39.21" class="difflineminus">-#</span>
<a href="#l39.22"></a><span id="l39.22" class="difflineminus">-# The Initial Developer of the Original Code is</span>
<a href="#l39.23"></a><span id="l39.23" class="difflineminus">-# Netscape Communications Corporation.</span>
<a href="#l39.24"></a><span id="l39.24" class="difflineminus">-# Portions created by the Initial Developer are Copyright (C) 2000</span>
<a href="#l39.25"></a><span id="l39.25" class="difflineminus">-# the Initial Developer. All Rights Reserved.</span>
<a href="#l39.26"></a><span id="l39.26" class="difflineminus">-#</span>
<a href="#l39.27"></a><span id="l39.27" class="difflineminus">-# Contributor(s):</span>
<a href="#l39.28"></a><span id="l39.28" class="difflineminus">-#   Jan Varga &lt;varga@nixcorp.com&gt;</span>
<a href="#l39.29"></a><span id="l39.29" class="difflineminus">-#   Hakan Waara &lt;hwaara@chello.se&gt;</span>
<a href="#l39.30"></a><span id="l39.30" class="difflineminus">-#   Markus Hossner &lt;markushossner@gmx.de&gt;</span>
<a href="#l39.31"></a><span id="l39.31" class="difflineminus">-#   Magnus Melin &lt;mkmelin+mozilla@iki.fi&gt;</span>
<a href="#l39.32"></a><span id="l39.32" class="difflineminus">-#</span>
<a href="#l39.33"></a><span id="l39.33" class="difflineminus">-# Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l39.34"></a><span id="l39.34" class="difflineminus">-# either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l39.35"></a><span id="l39.35" class="difflineminus">-# the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l39.36"></a><span id="l39.36" class="difflineminus">-# in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l39.37"></a><span id="l39.37" class="difflineminus">-# of those above. If you wish to allow use of your version of this file only</span>
<a href="#l39.38"></a><span id="l39.38" class="difflineminus">-# under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l39.39"></a><span id="l39.39" class="difflineminus">-# use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l39.40"></a><span id="l39.40" class="difflineminus">-# decision by deleting the provisions above and replace them with the notice</span>
<a href="#l39.41"></a><span id="l39.41" class="difflineminus">-# and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l39.42"></a><span id="l39.42" class="difflineminus">-# the provisions above, a recipient may use your version of this file under</span>
<a href="#l39.43"></a><span id="l39.43" class="difflineminus">-# the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l39.44"></a><span id="l39.44" class="difflineminus">-#</span>
<a href="#l39.45"></a><span id="l39.45" class="difflineminus">-# ***** END LICENSE BLOCK *****</span>
<a href="#l39.46"></a><span id="l39.46" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l39.47"></a><span id="l39.47" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l39.48"></a><span id="l39.48" class="difflineplus">+ *</span>
<a href="#l39.49"></a><span id="l39.49" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l39.50"></a><span id="l39.50" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l39.51"></a><span id="l39.51" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l39.52"></a><span id="l39.52" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l39.53"></a><span id="l39.53" class="difflineplus">+ *</span>
<a href="#l39.54"></a><span id="l39.54" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l39.55"></a><span id="l39.55" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l39.56"></a><span id="l39.56" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l39.57"></a><span id="l39.57" class="difflineplus">+ * License.</span>
<a href="#l39.58"></a><span id="l39.58" class="difflineplus">+ *</span>
<a href="#l39.59"></a><span id="l39.59" class="difflineplus">+ * The Original Code is Mozilla Communicator client code, released</span>
<a href="#l39.60"></a><span id="l39.60" class="difflineplus">+ * March 31, 1998.</span>
<a href="#l39.61"></a><span id="l39.61" class="difflineplus">+ *</span>
<a href="#l39.62"></a><span id="l39.62" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l39.63"></a><span id="l39.63" class="difflineplus">+ * Netscape Communications Corporation.</span>
<a href="#l39.64"></a><span id="l39.64" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2000</span>
<a href="#l39.65"></a><span id="l39.65" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l39.66"></a><span id="l39.66" class="difflineplus">+ *</span>
<a href="#l39.67"></a><span id="l39.67" class="difflineplus">+ * Contributor(s):</span>
<a href="#l39.68"></a><span id="l39.68" class="difflineplus">+ *   Jan Varga &lt;varga@nixcorp.com&gt;</span>
<a href="#l39.69"></a><span id="l39.69" class="difflineplus">+ *   Hakan Waara &lt;hwaara@chello.se&gt;</span>
<a href="#l39.70"></a><span id="l39.70" class="difflineplus">+ *   Markus Hossner &lt;markushossner@gmx.de&gt;</span>
<a href="#l39.71"></a><span id="l39.71" class="difflineplus">+ *   Magnus Melin &lt;mkmelin+mozilla@iki.fi&gt;</span>
<a href="#l39.72"></a><span id="l39.72" class="difflineplus">+ *</span>
<a href="#l39.73"></a><span id="l39.73" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l39.74"></a><span id="l39.74" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l39.75"></a><span id="l39.75" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l39.76"></a><span id="l39.76" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l39.77"></a><span id="l39.77" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l39.78"></a><span id="l39.78" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l39.79"></a><span id="l39.79" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l39.80"></a><span id="l39.80" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l39.81"></a><span id="l39.81" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l39.82"></a><span id="l39.82" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l39.83"></a><span id="l39.83" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l39.84"></a><span id="l39.84" class="difflineplus">+ *</span>
<a href="#l39.85"></a><span id="l39.85" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l39.86"></a><span id="l39.86"> </span>
<a href="#l39.87"></a><span id="l39.87"> //NOTE: gMessengerBundle must be defined and set or this Overlay won't work</span>
<a href="#l39.88"></a><span id="l39.88"> </span>
<a href="#l39.89"></a><span id="l39.89"> Components.utils.import(&quot;resource://gre/modules/PluralForm.jsm&quot;);</span>
<a href="#l39.90"></a><span id="l39.90"> </span>
<a href="#l39.91"></a><span id="l39.91"> const mailtolength = 7;</span>
<a href="#l39.92"></a><span id="l39.92"> </span>
<a href="#l39.93"></a><span id="l39.93"> /**</span>
<a href="#l39.94"></a><span id="l39.94">  * Function to change the highlighted row back to the row that is currently</span>
<a href="#l39.95"></a><span id="l39.95">  * outline/dotted without loading the contents of either rows. This is</span>
<a href="#l39.96"></a><span id="l39.96">  * triggered when the context menu for a given row is hidden/closed</span>
<a href="#l39.97"></a><span id="l39.97">  * (onpopuphiding).</span>
<a href="#l39.98"></a><span id="l39.98">  * @param tree the tree element to restore selection for</span>
<a href="#l39.99"></a><span id="l39.99">  */</span>
<a href="#l39.100"></a><span id="l39.100"> function RestoreSelectionWithoutContentLoad(tree)</span>
<a href="#l39.101"></a><span id="l39.101"> {</span>
<a href="#l39.102"></a><span id="l39.102" class="difflineminus">-    if (!tree)</span>
<a href="#l39.103"></a><span id="l39.103" class="difflineminus">-      return;</span>
<a href="#l39.104"></a><span id="l39.104" class="difflineminus">-</span>
<a href="#l39.105"></a><span id="l39.105" class="difflineminus">-    // If a delete or move command had been issued, then we should</span>
<a href="#l39.106"></a><span id="l39.106" class="difflineminus">-    // reset gRightMouseButtonDown and gThreadPaneDeleteOrMoveOccurred</span>
<a href="#l39.107"></a><span id="l39.107" class="difflineminus">-    // and return (see bug 142065).</span>
<a href="#l39.108"></a><span id="l39.108" class="difflineminus">-    if(gThreadPaneDeleteOrMoveOccurred)</span>
<a href="#l39.109"></a><span id="l39.109" class="difflineminus">-    {</span>
<a href="#l39.110"></a><span id="l39.110" class="difflineminus">-      gRightMouseButtonDown = false;</span>
<a href="#l39.111"></a><span id="l39.111" class="difflineminus">-      gThreadPaneDeleteOrMoveOccurred = false;</span>
<a href="#l39.112"></a><span id="l39.112" class="difflineminus">-      return;</span>
<a href="#l39.113"></a><span id="l39.113" class="difflineminus">-    }</span>
<a href="#l39.114"></a><span id="l39.114" class="difflineminus">-</span>
<a href="#l39.115"></a><span id="l39.115" class="difflineminus">-    var treeSelection = tree.view.selection;</span>
<a href="#l39.116"></a><span id="l39.116" class="difflineminus">-</span>
<a href="#l39.117"></a><span id="l39.117" class="difflineminus">-    // make sure that currentIndex is valid so that we don't try to restore</span>
<a href="#l39.118"></a><span id="l39.118" class="difflineminus">-    // a selection of an invalid row.</span>
<a href="#l39.119"></a><span id="l39.119" class="difflineminus">-    if((!treeSelection.isSelected(treeSelection.currentIndex)) &amp;&amp;</span>
<a href="#l39.120"></a><span id="l39.120" class="difflineminus">-       (treeSelection.currentIndex &gt;= 0))</span>
<a href="#l39.121"></a><span id="l39.121" class="difflineminus">-    {</span>
<a href="#l39.122"></a><span id="l39.122" class="difflineminus">-        treeSelection.selectEventsSuppressed = true;</span>
<a href="#l39.123"></a><span id="l39.123" class="difflineminus">-        treeSelection.select(treeSelection.currentIndex);</span>
<a href="#l39.124"></a><span id="l39.124" class="difflineminus">-        treeSelection.selectEventsSuppressed = false;</span>
<a href="#l39.125"></a><span id="l39.125" class="difflineplus">+  if (gRightMouseButtonSavedSelection) {</span>
<a href="#l39.126"></a><span id="l39.126" class="difflineplus">+    let view = gRightMouseButtonSavedSelection.view;</span>
<a href="#l39.127"></a><span id="l39.127" class="difflineplus">+    // restore the selection</span>
<a href="#l39.128"></a><span id="l39.128" class="difflineplus">+    let transientSelection = gRightMouseButtonSavedSelection.transientSelection;</span>
<a href="#l39.129"></a><span id="l39.129" class="difflineplus">+    let realSelection = gRightMouseButtonSavedSelection.realSelection;</span>
<a href="#l39.130"></a><span id="l39.130" class="difflineplus">+    view.selection = realSelection;</span>
<a href="#l39.131"></a><span id="l39.131" class="difflineplus">+    // replay any calls to adjustSelection, this handles suppression.</span>
<a href="#l39.132"></a><span id="l39.132" class="difflineplus">+    transientSelection.replayAdjustSelectionLog(realSelection);</span>
<a href="#l39.133"></a><span id="l39.133" class="difflineplus">+    gRightMouseButtonSavedSelection = null;</span>
<a href="#l39.134"></a><span id="l39.134"> </span>
<a href="#l39.135"></a><span id="l39.135" class="difflineminus">-        // Keep track of which row in the thread pane is currently selected.</span>
<a href="#l39.136"></a><span id="l39.136" class="difflineminus">-        // This is currently only needed when deleting messages.  See</span>
<a href="#l39.137"></a><span id="l39.137" class="difflineminus">-        // declaration of var in msgMail3PaneWindow.js.</span>
<a href="#l39.138"></a><span id="l39.138" class="difflineminus">-        if(tree.id == &quot;threadTree&quot;)</span>
<a href="#l39.139"></a><span id="l39.139" class="difflineminus">-          gThreadPaneCurrentSelectedIndex = treeSelection.currentIndex;</span>
<a href="#l39.140"></a><span id="l39.140" class="difflineminus">-    }</span>
<a href="#l39.141"></a><span id="l39.141" class="difflineminus">-    else if(treeSelection.currentIndex &lt; 0)</span>
<a href="#l39.142"></a><span id="l39.142" class="difflineminus">-        // Clear the selection in the case of when a folder has just been</span>
<a href="#l39.143"></a><span id="l39.143" class="difflineminus">-        // loaded where the message pane does not have a message loaded yet.</span>
<a href="#l39.144"></a><span id="l39.144" class="difflineminus">-        // When right-clicking a message in this case and dismissing the</span>
<a href="#l39.145"></a><span id="l39.145" class="difflineminus">-        // popup menu (by either executing a menu command or clicking</span>
<a href="#l39.146"></a><span id="l39.146" class="difflineminus">-        // somewhere else),  the selection needs to be cleared.</span>
<a href="#l39.147"></a><span id="l39.147" class="difflineminus">-        // However, if the 'Delete Message' or 'Move To' menu item has been</span>
<a href="#l39.148"></a><span id="l39.148" class="difflineminus">-        // selected, DO NOT clear the selection, else it will prevent the</span>
<a href="#l39.149"></a><span id="l39.149" class="difflineminus">-        // tree view from refreshing.</span>
<a href="#l39.150"></a><span id="l39.150" class="difflineminus">-        treeSelection.clearSelection();</span>
<a href="#l39.151"></a><span id="l39.151" class="difflineminus">-</span>
<a href="#l39.152"></a><span id="l39.152" class="difflineminus">-    // Need to reset gRightMouseButtonDown to false here because</span>
<a href="#l39.153"></a><span id="l39.153" class="difflineminus">-    // TreeOnMouseDown() is only called on a mousedown, not on a key down.</span>
<a href="#l39.154"></a><span id="l39.154" class="difflineminus">-    // So resetting it here allows the loading of messages in the messagepane</span>
<a href="#l39.155"></a><span id="l39.155" class="difflineminus">-    // when navigating via the keyboard or the toolbar buttons *after*</span>
<a href="#l39.156"></a><span id="l39.156" class="difflineminus">-    // the context menu has been dismissed.</span>
<a href="#l39.157"></a><span id="l39.157" class="difflineminus">-    gRightMouseButtonDown = false;</span>
<a href="#l39.158"></a><span id="l39.158" class="difflineplus">+    if (tree)</span>
<a href="#l39.159"></a><span id="l39.159" class="difflineplus">+      tree.treeBoxObject.invalidate();</span>
<a href="#l39.160"></a><span id="l39.160" class="difflineplus">+  }</span>
<a href="#l39.161"></a><span id="l39.161"> }</span>
<a href="#l39.162"></a><span id="l39.162"> </span>
<a href="#l39.163"></a><span id="l39.163"> /**</span>
<a href="#l39.164"></a><span id="l39.164">  * Function to clear out the global nsContextMenu, and in the case when we</span>
<a href="#l39.165"></a><span id="l39.165">  * were a threadpane context menu, restore the selection so that a right-click</span>
<a href="#l39.166"></a><span id="l39.166">  * on a non-selected row doesn't move the selection.</span>
<a href="#l39.167"></a><span id="l39.167">  * @param event the onpopuphiding event</span>
<a href="#l39.168"></a><span id="l39.168">  */</span>
<a href="#l39.169"></a><span id="l39.169" class="difflineat">@@ -149,18 +113,18 @@ function fillMailContextMenu(event)</span>
<a href="#l39.170"></a><span id="l39.170"> </span>
<a href="#l39.171"></a><span id="l39.171">   var numSelected = GetNumSelectedMessages();</span>
<a href="#l39.172"></a><span id="l39.172">   if (numSelected == 0)</span>
<a href="#l39.173"></a><span id="l39.173">     return false; // Don't show the context menu if no items are selected.</span>
<a href="#l39.174"></a><span id="l39.174"> </span>
<a href="#l39.175"></a><span id="l39.175">   var inThreadPane = popupNodeIsInThreadPane();</span>
<a href="#l39.176"></a><span id="l39.176">   gContextMenu = new nsContextMenu(event.target);</span>
<a href="#l39.177"></a><span id="l39.177"> </span>
<a href="#l39.178"></a><span id="l39.178" class="difflineminus">-  var selectedMessage = GetFirstSelectedMessage();</span>
<a href="#l39.179"></a><span id="l39.179" class="difflineminus">-  var isNewsgroup = IsNewsMessage(selectedMessage);</span>
<a href="#l39.180"></a><span id="l39.180" class="difflineplus">+  var selectedMessage = gFolderDisplay.selectedMessage;</span>
<a href="#l39.181"></a><span id="l39.181" class="difflineplus">+  var isNewsgroup = gFolderDisplay.selectedMessageIsNews;</span>
<a href="#l39.182"></a><span id="l39.182"> </span>
<a href="#l39.183"></a><span id="l39.183">   // Clear the global var used to keep track if a 'Delete Message' or 'Move</span>
<a href="#l39.184"></a><span id="l39.184">   // To' command has been triggered via the thread pane context menu.</span>
<a href="#l39.185"></a><span id="l39.185">   gThreadPaneDeleteOrMoveOccurred = false;</span>
<a href="#l39.186"></a><span id="l39.186"> </span>
<a href="#l39.187"></a><span id="l39.187">   // Don't show mail items for links/images, just show related items.</span>
<a href="#l39.188"></a><span id="l39.188">   var hideMailItems = !inThreadPane &amp;&amp;</span>
<a href="#l39.189"></a><span id="l39.189">                       (gContextMenu.onImage || gContextMenu.onLink);</span>
<a href="#l39.190"></a><span id="l39.190" class="difflineat">@@ -227,21 +191,20 @@ function fillMailContextMenu(event)</span>
<a href="#l39.191"></a><span id="l39.191"> </span>
<a href="#l39.192"></a><span id="l39.192">   ShowMenuItem(&quot;paneContext-afterMove&quot;, !inThreadPane);</span>
<a href="#l39.193"></a><span id="l39.193"> </span>
<a href="#l39.194"></a><span id="l39.194">   ShowMenuItem(&quot;mailContext-tags&quot;, !hideMailItems &amp;&amp; msgFolder);</span>
<a href="#l39.195"></a><span id="l39.195"> </span>
<a href="#l39.196"></a><span id="l39.196">   ShowMenuItem(&quot;mailContext-mark&quot;, !hideMailItems &amp;&amp; msgFolder);</span>
<a href="#l39.197"></a><span id="l39.197"> </span>
<a href="#l39.198"></a><span id="l39.198">   setSingleSelection(&quot;mailContext-saveAs&quot;);</span>
<a href="#l39.199"></a><span id="l39.199" class="difflineminus">-#ifdef XP_MACOSX</span>
<a href="#l39.200"></a><span id="l39.200" class="difflineminus">-  ShowMenuItem(&quot;mailContext-printpreview&quot;, false);</span>
<a href="#l39.201"></a><span id="l39.201" class="difflineminus">-#else</span>
<a href="#l39.202"></a><span id="l39.202" class="difflineminus">-  setSingleSelection(&quot;mailContext-printpreview&quot;);</span>
<a href="#l39.203"></a><span id="l39.203" class="difflineminus">-#endif</span>
<a href="#l39.204"></a><span id="l39.204" class="difflineplus">+  if (gPlatformOSX)</span>
<a href="#l39.205"></a><span id="l39.205" class="difflineplus">+    ShowMenuItem(&quot;mailContext-printpreview&quot;, false);</span>
<a href="#l39.206"></a><span id="l39.206" class="difflineplus">+  else</span>
<a href="#l39.207"></a><span id="l39.207" class="difflineplus">+    setSingleSelection(&quot;mailContext-printpreview&quot;);</span>
<a href="#l39.208"></a><span id="l39.208"> </span>
<a href="#l39.209"></a><span id="l39.209">   ShowMenuItem(&quot;mailContext-print&quot;, !hideMailItems);</span>
<a href="#l39.210"></a><span id="l39.210"> </span>
<a href="#l39.211"></a><span id="l39.211">   ShowMenuItem(&quot;mailContext-delete&quot;, !hideMailItems &amp;&amp; (isNewsgroup || canMove));</span>
<a href="#l39.212"></a><span id="l39.212">   // This function is needed for the case where a folder is just loaded (while</span>
<a href="#l39.213"></a><span id="l39.213">   // there isn't a message loaded in the message pane), a right-click is done</span>
<a href="#l39.214"></a><span id="l39.214">   // in the thread pane.  This function will disable enable the 'Delete</span>
<a href="#l39.215"></a><span id="l39.215">   // Message' menu item.</span>
<a href="#l39.216"></a><span id="l39.216" class="difflineat">@@ -390,21 +353,19 @@ function OpenMessageForMessageId(message</span>
<a href="#l39.217"></a><span id="l39.217"> </span>
<a href="#l39.218"></a><span id="l39.218"> function OpenMessageByHeader(messageHeader, openInNewWindow)</span>
<a href="#l39.219"></a><span id="l39.219"> {</span>
<a href="#l39.220"></a><span id="l39.220">   var folder    = messageHeader.folder;</span>
<a href="#l39.221"></a><span id="l39.221">   var folderURI = folder.URI;</span>
<a href="#l39.222"></a><span id="l39.222"> </span>
<a href="#l39.223"></a><span id="l39.223">   if (openInNewWindow)</span>
<a href="#l39.224"></a><span id="l39.224">   {</span>
<a href="#l39.225"></a><span id="l39.225" class="difflineminus">-    var messageURI = folder.getUriForMsg(messageHeader);</span>
<a href="#l39.226"></a><span id="l39.226" class="difflineminus">-</span>
<a href="#l39.227"></a><span id="l39.227">     window.openDialog(&quot;chrome://messenger/content/messageWindow.xul&quot;,</span>
<a href="#l39.228"></a><span id="l39.228">                       &quot;_blank&quot;, &quot;all,chrome,dialog=no,status,toolbar&quot;,</span>
<a href="#l39.229"></a><span id="l39.229" class="difflineminus">-                      messageURI, folderURI, null);</span>
<a href="#l39.230"></a><span id="l39.230" class="difflineplus">+                      messageHeader);</span>
<a href="#l39.231"></a><span id="l39.231">   }</span>
<a href="#l39.232"></a><span id="l39.232">   else</span>
<a href="#l39.233"></a><span id="l39.233">   {</span>
<a href="#l39.234"></a><span id="l39.234">     if (msgWindow.openFolder != folderURI)</span>
<a href="#l39.235"></a><span id="l39.235">       gFolderTreeView.selectFolder(folder);</span>
<a href="#l39.236"></a><span id="l39.236"> </span>
<a href="#l39.237"></a><span id="l39.237">     var tree = null;</span>
<a href="#l39.238"></a><span id="l39.238">     var wintype = document.documentElement.getAttribute('windowtype');</span>
<a href="#l39.239"></a><span id="l39.239" class="difflineat">@@ -728,17 +689,17 @@ function SetMenuItemLabel(id, label)</span>
<a href="#l39.240"></a><span id="l39.240"> }</span>
<a href="#l39.241"></a><span id="l39.241"> </span>
<a href="#l39.242"></a><span id="l39.242"> // helper function used by shouldShowSeparator</span>
<a href="#l39.243"></a><span id="l39.243"> function hasAVisibleNextSibling(aNode)</span>
<a href="#l39.244"></a><span id="l39.244"> {</span>
<a href="#l39.245"></a><span id="l39.245">   var sibling = aNode.nextSibling;</span>
<a href="#l39.246"></a><span id="l39.246">   while (sibling)</span>
<a href="#l39.247"></a><span id="l39.247">   {</span>
<a href="#l39.248"></a><span id="l39.248" class="difflineminus">-    if (sibling.getAttribute(&quot;hidden&quot;) != &quot;true&quot; </span>
<a href="#l39.249"></a><span id="l39.249" class="difflineplus">+    if (sibling.getAttribute(&quot;hidden&quot;) != &quot;true&quot;</span>
<a href="#l39.250"></a><span id="l39.250">         &amp;&amp; sibling.localName != &quot;menuseparator&quot;)</span>
<a href="#l39.251"></a><span id="l39.251">       return true;</span>
<a href="#l39.252"></a><span id="l39.252">     sibling = sibling.nextSibling;</span>
<a href="#l39.253"></a><span id="l39.253">   }</span>
<a href="#l39.254"></a><span id="l39.254">   return false;</span>
<a href="#l39.255"></a><span id="l39.255"> }</span>
<a href="#l39.256"></a><span id="l39.256"> </span>
<a href="#l39.257"></a><span id="l39.257"> function IsMenuItemShowing(menuID)</span>
<a href="#l39.258"></a><span id="l39.258" class="difflineat">@@ -770,24 +731,24 @@ function composeEmailTo ()</span>
<a href="#l39.259"></a><span id="l39.259">   params.type = Components.interfaces.nsIMsgCompType.New;</span>
<a href="#l39.260"></a><span id="l39.260">   params.format = Components.interfaces.nsIMsgCompFormat.Default;</span>
<a href="#l39.261"></a><span id="l39.261">   params.identity = accountManager.getFirstIdentityForServer(GetLoadedMsgFolder().server);</span>
<a href="#l39.262"></a><span id="l39.262">   params.composeFields = fields;</span>
<a href="#l39.263"></a><span id="l39.263">   msgComposeService.OpenComposeWindowWithParams(null, params);</span>
<a href="#l39.264"></a><span id="l39.264"> }</span>
<a href="#l39.265"></a><span id="l39.265"> </span>
<a href="#l39.266"></a><span id="l39.266"> // Extracts email address from url string</span>
<a href="#l39.267"></a><span id="l39.267" class="difflineminus">-function getEmail (url) </span>
<a href="#l39.268"></a><span id="l39.268" class="difflineplus">+function getEmail (url)</span>
<a href="#l39.269"></a><span id="l39.269"> {</span>
<a href="#l39.270"></a><span id="l39.270">   var qmark = url.indexOf( &quot;?&quot; );</span>
<a href="#l39.271"></a><span id="l39.271">   var addresses;</span>
<a href="#l39.272"></a><span id="l39.272"> </span>
<a href="#l39.273"></a><span id="l39.273" class="difflineminus">-  if ( qmark &gt; mailtolength ) </span>
<a href="#l39.274"></a><span id="l39.274" class="difflineplus">+  if ( qmark &gt; mailtolength )</span>
<a href="#l39.275"></a><span id="l39.275">       addresses = url.substring( mailtolength, qmark );</span>
<a href="#l39.276"></a><span id="l39.276" class="difflineminus">-  else </span>
<a href="#l39.277"></a><span id="l39.277" class="difflineplus">+  else</span>
<a href="#l39.278"></a><span id="l39.278">      addresses = url.substr( mailtolength );</span>
<a href="#l39.279"></a><span id="l39.279">   // Let's try to unescape it using a character set</span>
<a href="#l39.280"></a><span id="l39.280">   try {</span>
<a href="#l39.281"></a><span id="l39.281">     var characterSet = gContextMenu.target.ownerDocument.characterSet;</span>
<a href="#l39.282"></a><span id="l39.282">     const textToSubURI = Components.classes[&quot;@mozilla.org/intl/texttosuburi;1&quot;]</span>
<a href="#l39.283"></a><span id="l39.283">                                  .getService(Components.interfaces.nsITextToSubURI);</span>
<a href="#l39.284"></a><span id="l39.284">     addresses = textToSubURI.unEscapeURIForUI(characterSet, addresses);</span>
<a href="#l39.285"></a><span id="l39.285">   }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l40.1"></a><span id="l40.1" class="difflineminus">--- a/mail/base/content/mailWindow.js</span>
<a href="#l40.2"></a><span id="l40.2" class="difflineplus">+++ b/mail/base/content/mailWindow.js</span>
<a href="#l40.3"></a><span id="l40.3" class="difflineat">@@ -1,47 +1,46 @@</span>
<a href="#l40.4"></a><span id="l40.4" class="difflineminus">-# -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l40.5"></a><span id="l40.5" class="difflineminus">-# ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l40.6"></a><span id="l40.6" class="difflineminus">-# Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l40.7"></a><span id="l40.7" class="difflineminus">-#</span>
<a href="#l40.8"></a><span id="l40.8" class="difflineminus">-# The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l40.9"></a><span id="l40.9" class="difflineminus">-# 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l40.10"></a><span id="l40.10" class="difflineminus">-# the License. You may obtain a copy of the License at</span>
<a href="#l40.11"></a><span id="l40.11" class="difflineminus">-# http://www.mozilla.org/MPL/</span>
<a href="#l40.12"></a><span id="l40.12" class="difflineminus">-#</span>
<a href="#l40.13"></a><span id="l40.13" class="difflineminus">-# Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l40.14"></a><span id="l40.14" class="difflineminus">-# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l40.15"></a><span id="l40.15" class="difflineminus">-# for the specific language governing rights and limitations under the</span>
<a href="#l40.16"></a><span id="l40.16" class="difflineminus">-# License.</span>
<a href="#l40.17"></a><span id="l40.17" class="difflineminus">-#</span>
<a href="#l40.18"></a><span id="l40.18" class="difflineminus">-# The Original Code is Mozilla Communicator client code, released</span>
<a href="#l40.19"></a><span id="l40.19" class="difflineminus">-# March 31, 1998.</span>
<a href="#l40.20"></a><span id="l40.20" class="difflineminus">-#</span>
<a href="#l40.21"></a><span id="l40.21" class="difflineminus">-# The Initial Developer of the Original Code is</span>
<a href="#l40.22"></a><span id="l40.22" class="difflineminus">-# Netscape Communications Corporation.</span>
<a href="#l40.23"></a><span id="l40.23" class="difflineminus">-# Portions created by the Initial Developer are Copyright (C) 1998-1999</span>
<a href="#l40.24"></a><span id="l40.24" class="difflineminus">-# the Initial Developer. All Rights Reserved.</span>
<a href="#l40.25"></a><span id="l40.25" class="difflineminus">-#</span>
<a href="#l40.26"></a><span id="l40.26" class="difflineminus">-# Contributor(s):</span>
<a href="#l40.27"></a><span id="l40.27" class="difflineminus">-#   Jan Varga &lt;varga@nixcorp.com&gt;</span>
<a href="#l40.28"></a><span id="l40.28" class="difflineminus">-#   HÃ¥kan Waara &lt;hwaara@gmail.com&gt;</span>
<a href="#l40.29"></a><span id="l40.29" class="difflineminus">-#</span>
<a href="#l40.30"></a><span id="l40.30" class="difflineminus">-# Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l40.31"></a><span id="l40.31" class="difflineminus">-# either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l40.32"></a><span id="l40.32" class="difflineminus">-# the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l40.33"></a><span id="l40.33" class="difflineminus">-# in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l40.34"></a><span id="l40.34" class="difflineminus">-# of those above. If you wish to allow use of your version of this file only</span>
<a href="#l40.35"></a><span id="l40.35" class="difflineminus">-# under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l40.36"></a><span id="l40.36" class="difflineminus">-# use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l40.37"></a><span id="l40.37" class="difflineminus">-# decision by deleting the provisions above and replace them with the notice</span>
<a href="#l40.38"></a><span id="l40.38" class="difflineminus">-# and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l40.39"></a><span id="l40.39" class="difflineminus">-# the provisions above, a recipient may use your version of this file under</span>
<a href="#l40.40"></a><span id="l40.40" class="difflineminus">-# the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l40.41"></a><span id="l40.41" class="difflineminus">-#</span>
<a href="#l40.42"></a><span id="l40.42" class="difflineminus">-# ***** END LICENSE BLOCK *****</span>
<a href="#l40.43"></a><span id="l40.43" class="difflineplus">+/** ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l40.44"></a><span id="l40.44" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l40.45"></a><span id="l40.45" class="difflineplus">+ *</span>
<a href="#l40.46"></a><span id="l40.46" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l40.47"></a><span id="l40.47" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l40.48"></a><span id="l40.48" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l40.49"></a><span id="l40.49" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l40.50"></a><span id="l40.50" class="difflineplus">+ *</span>
<a href="#l40.51"></a><span id="l40.51" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l40.52"></a><span id="l40.52" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l40.53"></a><span id="l40.53" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l40.54"></a><span id="l40.54" class="difflineplus">+ * License.</span>
<a href="#l40.55"></a><span id="l40.55" class="difflineplus">+ *</span>
<a href="#l40.56"></a><span id="l40.56" class="difflineplus">+ * The Original Code is Mozilla Communicator client code, released</span>
<a href="#l40.57"></a><span id="l40.57" class="difflineplus">+ * March 31, 1998.</span>
<a href="#l40.58"></a><span id="l40.58" class="difflineplus">+ *</span>
<a href="#l40.59"></a><span id="l40.59" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l40.60"></a><span id="l40.60" class="difflineplus">+ * Netscape Communications Corporation.</span>
<a href="#l40.61"></a><span id="l40.61" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 1998-1999</span>
<a href="#l40.62"></a><span id="l40.62" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l40.63"></a><span id="l40.63" class="difflineplus">+ *</span>
<a href="#l40.64"></a><span id="l40.64" class="difflineplus">+ * Contributor(s):</span>
<a href="#l40.65"></a><span id="l40.65" class="difflineplus">+ *   Jan Varga &lt;varga@nixcorp.com&gt;</span>
<a href="#l40.66"></a><span id="l40.66" class="difflineplus">+ *   HÃ¥kan Waara &lt;hwaara@gmail.com&gt;</span>
<a href="#l40.67"></a><span id="l40.67" class="difflineplus">+ *</span>
<a href="#l40.68"></a><span id="l40.68" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l40.69"></a><span id="l40.69" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l40.70"></a><span id="l40.70" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l40.71"></a><span id="l40.71" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l40.72"></a><span id="l40.72" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l40.73"></a><span id="l40.73" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l40.74"></a><span id="l40.74" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l40.75"></a><span id="l40.75" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l40.76"></a><span id="l40.76" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l40.77"></a><span id="l40.77" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l40.78"></a><span id="l40.78" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l40.79"></a><span id="l40.79" class="difflineplus">+ *</span>
<a href="#l40.80"></a><span id="l40.80" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l40.81"></a><span id="l40.81"> </span>
<a href="#l40.82"></a><span id="l40.82"> Components.utils.import(&quot;resource://app/modules/appIdleManager.js&quot;);</span>
<a href="#l40.83"></a><span id="l40.83"> </span>
<a href="#l40.84"></a><span id="l40.84"> //This file stores variables common to mail windows</span>
<a href="#l40.85"></a><span id="l40.85"> var messenger;</span>
<a href="#l40.86"></a><span id="l40.86"> var pref;</span>
<a href="#l40.87"></a><span id="l40.87"> var statusFeedback;</span>
<a href="#l40.88"></a><span id="l40.88"> var msgWindow;</span>
<a href="#l40.89"></a><span id="l40.89" class="difflineat">@@ -54,40 +53,45 @@ var gBrandBundle;</span>
<a href="#l40.90"></a><span id="l40.90"> </span>
<a href="#l40.91"></a><span id="l40.91"> Components.utils.import(&quot;resource://app/modules/gloda/log4moz.js&quot;);</span>
<a href="#l40.92"></a><span id="l40.92"> </span>
<a href="#l40.93"></a><span id="l40.93"> var gContextMenu;</span>
<a href="#l40.94"></a><span id="l40.94"> var gMailWindowLog = Log4Moz.getConfiguredLogger(&quot;mailWindow&quot;, Log4Moz.Level.Debug, Log4Moz.Level.Debug, Log4Moz.Level.Debug);</span>
<a href="#l40.95"></a><span id="l40.95"> var gAccountCentralLoaded = true;</span>
<a href="#l40.96"></a><span id="l40.96"> </span>
<a href="#l40.97"></a><span id="l40.97"> </span>
<a href="#l40.98"></a><span id="l40.98" class="difflineplus">+/**</span>
<a href="#l40.99"></a><span id="l40.99" class="difflineplus">+ * Indicate whether we are running on Mac OS X.  Our code is currently littered</span>
<a href="#l40.100"></a><span id="l40.100" class="difflineplus">+ *  with #ifdef/#ifndef XP_MACOSX's that do not need to exist in js code.  Use</span>
<a href="#l40.101"></a><span id="l40.101" class="difflineplus">+ *  of preprocessing makes error line numbers misleading, complicates</span>
<a href="#l40.102"></a><span id="l40.102" class="difflineplus">+ *  development because preprocessed files can't be symlinked when using</span>
<a href="#l40.103"></a><span id="l40.103" class="difflineplus">+ *  --enable-chrome-format=symlink, etc.</span>
<a href="#l40.104"></a><span id="l40.104" class="difflineplus">+ */</span>
<a href="#l40.105"></a><span id="l40.105" class="difflineplus">+var gPlatformOSX =</span>
<a href="#l40.106"></a><span id="l40.106" class="difflineplus">+  (window.navigator.oscpu.substring(0, 3).toLowerCase() == &quot;mac&quot;);</span>
<a href="#l40.107"></a><span id="l40.107" class="difflineplus">+</span>
<a href="#l40.108"></a><span id="l40.108" class="difflineplus">+/**</span>
<a href="#l40.109"></a><span id="l40.109" class="difflineplus">+ * Called by messageWindow.xul:onunload,  the 'single message display window'.</span>
<a href="#l40.110"></a><span id="l40.110" class="difflineplus">+ *</span>
<a href="#l40.111"></a><span id="l40.111" class="difflineplus">+ * Also called by messenger.xul:onunload's (the 3-pane window inside of tabs</span>
<a href="#l40.112"></a><span id="l40.112" class="difflineplus">+ *  window) unload function, OnUnloadMessenger.</span>
<a href="#l40.113"></a><span id="l40.113" class="difflineplus">+ */</span>
<a href="#l40.114"></a><span id="l40.114"> function OnMailWindowUnload()</span>
<a href="#l40.115"></a><span id="l40.115"> {</span>
<a href="#l40.116"></a><span id="l40.116">   MailOfflineMgr.uninit();</span>
<a href="#l40.117"></a><span id="l40.117">   ClearPendingReadTimer();</span>
<a href="#l40.118"></a><span id="l40.118"> </span>
<a href="#l40.119"></a><span id="l40.119" class="difflineminus">-  var searchSession = GetSearchSession();</span>
<a href="#l40.120"></a><span id="l40.120" class="difflineminus">-  if (searchSession)</span>
<a href="#l40.121"></a><span id="l40.121" class="difflineminus">-  {</span>
<a href="#l40.122"></a><span id="l40.122" class="difflineminus">-    removeGlobalListeners();</span>
<a href="#l40.123"></a><span id="l40.123" class="difflineminus">-    if (gPreQuickSearchView)     //close the cached pre quick search view</span>
<a href="#l40.124"></a><span id="l40.124" class="difflineminus">-      gPreQuickSearchView.close();</span>
<a href="#l40.125"></a><span id="l40.125" class="difflineminus">-  }</span>
<a href="#l40.126"></a><span id="l40.126" class="difflineminus">-</span>
<a href="#l40.127"></a><span id="l40.127" class="difflineminus">-  var dbview = GetDBView();</span>
<a href="#l40.128"></a><span id="l40.128" class="difflineminus">-  if (dbview) {</span>
<a href="#l40.129"></a><span id="l40.129" class="difflineminus">-    dbview.close();</span>
<a href="#l40.130"></a><span id="l40.130" class="difflineminus">-  }</span>
<a href="#l40.131"></a><span id="l40.131" class="difflineplus">+  // all dbview closing is handled by OnUnloadMessenger for the 3-pane (it closes</span>
<a href="#l40.132"></a><span id="l40.132" class="difflineplus">+  //  the tabs which close their views) and OnUnloadMessageWindow for the</span>
<a href="#l40.133"></a><span id="l40.133" class="difflineplus">+  //  standalone message window.</span>
<a href="#l40.134"></a><span id="l40.134"> </span>
<a href="#l40.135"></a><span id="l40.135">   var mailSession = Components.classes[&quot;@mozilla.org/messenger/services/session;1&quot;]</span>
<a href="#l40.136"></a><span id="l40.136">                               .getService(Components.interfaces.nsIMsgMailSession);</span>
<a href="#l40.137"></a><span id="l40.137" class="difflineminus">-  mailSession.RemoveFolderListener(folderListener);</span>
<a href="#l40.138"></a><span id="l40.138" class="difflineminus">-</span>
<a href="#l40.139"></a><span id="l40.139">   mailSession.RemoveMsgWindow(msgWindow);</span>
<a href="#l40.140"></a><span id="l40.140" class="difflineminus">-  messenger.setWindow(null, null);</span>
<a href="#l40.141"></a><span id="l40.141" class="difflineplus">+  // the tabs have the FolderDisplayWidget close their 'messenger' instances for us</span>
<a href="#l40.142"></a><span id="l40.142"> </span>
<a href="#l40.143"></a><span id="l40.143">   msgWindow.closeWindow();</span>
<a href="#l40.144"></a><span id="l40.144"> </span>
<a href="#l40.145"></a><span id="l40.145">   window.MsgStatusFeedback.unload();</span>
<a href="#l40.146"></a><span id="l40.146">   Components.classes[&quot;@mozilla.org/activity-manager;1&quot;]</span>
<a href="#l40.147"></a><span id="l40.147">             .getService(Components.interfaces.nsIActivityManager)</span>
<a href="#l40.148"></a><span id="l40.148">             .removeListener(window.MsgStatusFeedback);</span>
<a href="#l40.149"></a><span id="l40.149"> }</span>
<a href="#l40.150"></a><span id="l40.150" class="difflineat">@@ -98,17 +102,17 @@ function CreateMailWindowGlobals()</span>
<a href="#l40.151"></a><span id="l40.151">   messenger = Components.classes[&quot;@mozilla.org/messenger;1&quot;]</span>
<a href="#l40.152"></a><span id="l40.152">                         .createInstance(Components.interfaces.nsIMessenger);</span>
<a href="#l40.153"></a><span id="l40.153"> </span>
<a href="#l40.154"></a><span id="l40.154">   pref = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l40.155"></a><span id="l40.155">           .getService(Components.interfaces.nsIPrefBranch2);</span>
<a href="#l40.156"></a><span id="l40.156"> </span>
<a href="#l40.157"></a><span id="l40.157">   window.addEventListener(&quot;blur&quot;, appIdleManager.onBlur, false);</span>
<a href="#l40.158"></a><span id="l40.158">   window.addEventListener(&quot;focus&quot;, appIdleManager.onFocus, false);</span>
<a href="#l40.159"></a><span id="l40.159" class="difflineminus">-  </span>
<a href="#l40.160"></a><span id="l40.160" class="difflineplus">+</span>
<a href="#l40.161"></a><span id="l40.161">   //Create windows status feedback</span>
<a href="#l40.162"></a><span id="l40.162">   // set the JS implementation of status feedback before creating the c++ one..</span>
<a href="#l40.163"></a><span id="l40.163">   window.MsgStatusFeedback = new nsMsgStatusFeedback();</span>
<a href="#l40.164"></a><span id="l40.164">   // double register the status feedback object as the xul browser window implementation</span>
<a href="#l40.165"></a><span id="l40.165">   window.QueryInterface(Components.interfaces.nsIInterfaceRequestor)</span>
<a href="#l40.166"></a><span id="l40.166">         .getInterface(Components.interfaces.nsIWebNavigation)</span>
<a href="#l40.167"></a><span id="l40.167">         .QueryInterface(Components.interfaces.nsIDocShellTreeItem).treeOwner</span>
<a href="#l40.168"></a><span id="l40.168">         .QueryInterface(Components.interfaces.nsIInterfaceRequestor)</span>
<a href="#l40.169"></a><span id="l40.169" class="difflineat">@@ -156,17 +160,17 @@ function InitMsgWindow()</span>
<a href="#l40.170"></a><span id="l40.170"> }</span>
<a href="#l40.171"></a><span id="l40.171"> </span>
<a href="#l40.172"></a><span id="l40.172"> // We're going to implement our status feedback for the mail window in JS now.</span>
<a href="#l40.173"></a><span id="l40.173"> // the following contains the implementation of our status feedback object</span>
<a href="#l40.174"></a><span id="l40.174"> </span>
<a href="#l40.175"></a><span id="l40.175"> function nsMsgStatusFeedback()</span>
<a href="#l40.176"></a><span id="l40.176"> {</span>
<a href="#l40.177"></a><span id="l40.177">   this._statusText = document.getElementById(&quot;statusText&quot;);</span>
<a href="#l40.178"></a><span id="l40.178" class="difflineminus">-  this._progressBar = document.getElementById(&quot;statusbar-icon&quot;); </span>
<a href="#l40.179"></a><span id="l40.179" class="difflineplus">+  this._progressBar = document.getElementById(&quot;statusbar-icon&quot;);</span>
<a href="#l40.180"></a><span id="l40.180">   this._progressBarContainer = document.getElementById(&quot;statusbar-progresspanel&quot;);</span>
<a href="#l40.181"></a><span id="l40.181">   this._throbber = document.getElementById(&quot;navigator-throbber&quot;);</span>
<a href="#l40.182"></a><span id="l40.182">   this._stopCmd = document.getElementById(&quot;cmd_stop&quot;);</span>
<a href="#l40.183"></a><span id="l40.183">   this._activeProcesses = new Array();</span>
<a href="#l40.184"></a><span id="l40.184"> }</span>
<a href="#l40.185"></a><span id="l40.185"> </span>
<a href="#l40.186"></a><span id="l40.186"> nsMsgStatusFeedback.prototype =</span>
<a href="#l40.187"></a><span id="l40.187"> {</span>
<a href="#l40.188"></a><span id="l40.188" class="difflineat">@@ -351,17 +355,17 @@ nsMsgStatusFeedback.prototype =</span>
<a href="#l40.189"></a><span id="l40.189">         this._progressBarContainer.removeAttribute('collapsed');</span>
<a href="#l40.190"></a><span id="l40.190">         this._progressBarVisible = true;</span>
<a href="#l40.191"></a><span id="l40.191">       }</span>
<a href="#l40.192"></a><span id="l40.192">     }</span>
<a href="#l40.193"></a><span id="l40.193">     else {</span>
<a href="#l40.194"></a><span id="l40.194">       // Stop the bar spinning as we're not doing anything now.</span>
<a href="#l40.195"></a><span id="l40.195">       this._progressBar.setAttribute(&quot;mode&quot;, &quot;determined&quot;);</span>
<a href="#l40.196"></a><span id="l40.196">       this._progressBar.value = 0;</span>
<a href="#l40.197"></a><span id="l40.197" class="difflineminus">-      this._progressBar.label = &quot;&quot;; </span>
<a href="#l40.198"></a><span id="l40.198" class="difflineplus">+      this._progressBar.label = &quot;&quot;;</span>
<a href="#l40.199"></a><span id="l40.199"> </span>
<a href="#l40.200"></a><span id="l40.200">       if (this._progressBarVisible) {</span>
<a href="#l40.201"></a><span id="l40.201">         this._progressBarContainer.collapsed = true;</span>
<a href="#l40.202"></a><span id="l40.202">         this._progressBarVisible = false;</span>
<a href="#l40.203"></a><span id="l40.203">       }</span>
<a href="#l40.204"></a><span id="l40.204">     }</span>
<a href="#l40.205"></a><span id="l40.205">   },</span>
<a href="#l40.206"></a><span id="l40.206"> </span>
<a href="#l40.207"></a><span id="l40.207" class="difflineat">@@ -437,25 +441,26 @@ nsMsgWindowCommands.prototype =</span>
<a href="#l40.208"></a><span id="l40.208"> </span>
<a href="#l40.209"></a><span id="l40.209">   selectFolder: function(folderUri)</span>
<a href="#l40.210"></a><span id="l40.210">   {</span>
<a href="#l40.211"></a><span id="l40.211">     gFolderTreeView.selectFolder(GetMsgFolderFromUri(folderUri));</span>
<a href="#l40.212"></a><span id="l40.212">   },</span>
<a href="#l40.213"></a><span id="l40.213"> </span>
<a href="#l40.214"></a><span id="l40.214">   selectMessage: function(messageUri)</span>
<a href="#l40.215"></a><span id="l40.215">   {</span>
<a href="#l40.216"></a><span id="l40.216" class="difflineminus">-    SelectMessage(messageUri);</span>
<a href="#l40.217"></a><span id="l40.217" class="difflineplus">+    let msgHdr = messenger.msgHdrFromURI(messageUri);</span>
<a href="#l40.218"></a><span id="l40.218" class="difflineplus">+    gFolderDisplay.selectMessage(msgHdr);</span>
<a href="#l40.219"></a><span id="l40.219">   },</span>
<a href="#l40.220"></a><span id="l40.220"> </span>
<a href="#l40.221"></a><span id="l40.221">   clearMsgPane: function()</span>
<a href="#l40.222"></a><span id="l40.222">   {</span>
<a href="#l40.223"></a><span id="l40.223" class="difflineminus">-    if (gDBView)</span>
<a href="#l40.224"></a><span id="l40.224" class="difflineminus">-      setTitleFromFolder(gDBView.msgFolder,null);</span>
<a href="#l40.225"></a><span id="l40.225" class="difflineminus">-    else</span>
<a href="#l40.226"></a><span id="l40.226" class="difflineminus">-      setTitleFromFolder(null,null);</span>
<a href="#l40.227"></a><span id="l40.227" class="difflineplus">+    // This call happens as part of a display decision made by the nsMsgDBView</span>
<a href="#l40.228"></a><span id="l40.228" class="difflineplus">+    //  instance.  Strictly speaking, we don't want this.  I think davida's</span>
<a href="#l40.229"></a><span id="l40.229" class="difflineplus">+    //  patch will change this, so we can figure it out after that lands if</span>
<a href="#l40.230"></a><span id="l40.230" class="difflineplus">+    //  there are issues.</span>
<a href="#l40.231"></a><span id="l40.231">     ClearMessagePane();</span>
<a href="#l40.232"></a><span id="l40.232">   }</span>
<a href="#l40.233"></a><span id="l40.233"> }</span>
<a href="#l40.234"></a><span id="l40.234"> </span>
<a href="#l40.235"></a><span id="l40.235"> /**</span>
<a href="#l40.236"></a><span id="l40.236">  * @returns the pref name to use for fetching the start page url. Every time the application version changes,</span>
<a href="#l40.237"></a><span id="l40.237">  * return &quot;mailnews.start_page.override_url&quot;. If this is the first time the application has been</span>
<a href="#l40.238"></a><span id="l40.238">  * launched, return &quot;mailnews.start_page.welcome_url&quot;. Otherwise return &quot;mailnews.start_page.url&quot;.</span>
<a href="#l40.239"></a><span id="l40.239" class="difflineat">@@ -475,17 +480,16 @@ function startPageUrlPref()</span>
<a href="#l40.240"></a><span id="l40.240"> }</span>
<a href="#l40.241"></a><span id="l40.241"> </span>
<a href="#l40.242"></a><span id="l40.242"> /**</span>
<a href="#l40.243"></a><span id="l40.243">  * Loads the mail start page.</span>
<a href="#l40.244"></a><span id="l40.244">  */</span>
<a href="#l40.245"></a><span id="l40.245"> function loadStartPage()</span>
<a href="#l40.246"></a><span id="l40.246"> {</span>
<a href="#l40.247"></a><span id="l40.247">   gMessageNotificationBar.clearMsgNotifications();</span>
<a href="#l40.248"></a><span id="l40.248" class="difflineminus">-  ClearThreadPaneSelection();</span>
<a href="#l40.249"></a><span id="l40.249">   let startpage = Components.classes[&quot;@mozilla.org/toolkit/URLFormatterService;1&quot;]</span>
<a href="#l40.250"></a><span id="l40.250">                             .getService(Components.interfaces.nsIURLFormatter)</span>
<a href="#l40.251"></a><span id="l40.251">                             .formatURLPref(startPageUrlPref());</span>
<a href="#l40.252"></a><span id="l40.252">   if (startpage)</span>
<a href="#l40.253"></a><span id="l40.253">   {</span>
<a href="#l40.254"></a><span id="l40.254">     try {</span>
<a href="#l40.255"></a><span id="l40.255">       let urifixup = Components.classes[&quot;@mozilla.org/docshell/urifixup;1&quot;]</span>
<a href="#l40.256"></a><span id="l40.256">                                .getService(Components.interfaces.nsIURIFixup);</span>
<a href="#l40.257"></a><span id="l40.257" class="difflineat">@@ -498,67 +502,50 @@ function loadStartPage()</span>
<a href="#l40.258"></a><span id="l40.258">     }</span>
<a href="#l40.259"></a><span id="l40.259">   }</span>
<a href="#l40.260"></a><span id="l40.260">   else</span>
<a href="#l40.261"></a><span id="l40.261">   {</span>
<a href="#l40.262"></a><span id="l40.262">     GetMessagePaneFrame().location.href = &quot;about:blank&quot;;</span>
<a href="#l40.263"></a><span id="l40.263">   }</span>
<a href="#l40.264"></a><span id="l40.264"> }</span>
<a href="#l40.265"></a><span id="l40.265"> </span>
<a href="#l40.266"></a><span id="l40.266" class="difflineminus">-// When the ThreadPane is hidden via the displayDeck, we should collapse the</span>
<a href="#l40.267"></a><span id="l40.267" class="difflineminus">-// elements that are only meaningful to the thread pane. When AccountCentral is</span>
<a href="#l40.268"></a><span id="l40.268" class="difflineminus">-// shown via the displayDeck, we need to switch the displayDeck to show the</span>
<a href="#l40.269"></a><span id="l40.269" class="difflineminus">-// accountCentralBox, and load the iframe in the AccountCentral box with</span>
<a href="#l40.270"></a><span id="l40.270" class="difflineminus">-// corresponding page.</span>
<a href="#l40.271"></a><span id="l40.271" class="difflineminus">-function ShowAccountCentral()</span>
<a href="#l40.272"></a><span id="l40.272" class="difflineminus">-{</span>
<a href="#l40.273"></a><span id="l40.273" class="difflineminus">-  var accountBox = document.getElementById(&quot;accountCentralBox&quot;);</span>
<a href="#l40.274"></a><span id="l40.274" class="difflineminus">-  document.getElementById(&quot;displayDeck&quot;).selectedPanel = accountBox;</span>
<a href="#l40.275"></a><span id="l40.275" class="difflineminus">-  var prefName = &quot;mailnews.account_central_page.url&quot;;</span>
<a href="#l40.276"></a><span id="l40.276" class="difflineminus">-  var acctCentralPage = pref.getComplexValue(prefName,</span>
<a href="#l40.277"></a><span id="l40.277" class="difflineminus">-                                             Components.interfaces.nsIPrefLocalizedString).data;</span>
<a href="#l40.278"></a><span id="l40.278" class="difflineminus">-  window.frames[&quot;accountCentralPane&quot;].location.href = acctCentralPage;</span>
<a href="#l40.279"></a><span id="l40.279" class="difflineminus">-}</span>
<a href="#l40.280"></a><span id="l40.280" class="difflineminus">-</span>
<a href="#l40.281"></a><span id="l40.281" class="difflineminus">-function ShowThreadPane()</span>
<a href="#l40.282"></a><span id="l40.282" class="difflineminus">-{</span>
<a href="#l40.283"></a><span id="l40.283" class="difflineminus">-  document.getElementById(&quot;displayDeck&quot;).selectedPanel =</span>
<a href="#l40.284"></a><span id="l40.284" class="difflineminus">-    document.getElementById(&quot;threadPaneBox&quot;);</span>
<a href="#l40.285"></a><span id="l40.285" class="difflineminus">-}</span>
<a href="#l40.286"></a><span id="l40.286" class="difflineminus">-</span>
<a href="#l40.287"></a><span id="l40.287"> function ShowingThreadPane()</span>
<a href="#l40.288"></a><span id="l40.288"> {</span>
<a href="#l40.289"></a><span id="l40.289">   var threadPaneSplitter = document.getElementById(&quot;threadpane-splitter&quot;);</span>
<a href="#l40.290"></a><span id="l40.290">   threadPaneSplitter.collapsed = false;</span>
<a href="#l40.291"></a><span id="l40.291">   GetMessagePane().collapsed = (threadPaneSplitter.getAttribute(&quot;state&quot;) == &quot;collapsed&quot;);</span>
<a href="#l40.292"></a><span id="l40.292">   // XXX We need to force the tree to refresh its new height</span>
<a href="#l40.293"></a><span id="l40.293">   // so that it will correctly scroll to the newest message</span>
<a href="#l40.294"></a><span id="l40.294">   GetThreadTree().boxObject.height;</span>
<a href="#l40.295"></a><span id="l40.295">   document.getElementById(&quot;key_toggleMessagePane&quot;).removeAttribute(&quot;disabled&quot;);</span>
<a href="#l40.296"></a><span id="l40.296"> }</span>
<a href="#l40.297"></a><span id="l40.297"> </span>
<a href="#l40.298"></a><span id="l40.298"> function HidingThreadPane()</span>
<a href="#l40.299"></a><span id="l40.299"> {</span>
<a href="#l40.300"></a><span id="l40.300" class="difflineminus">-  ClearThreadPane();</span>
<a href="#l40.301"></a><span id="l40.301">   GetUnreadCountElement().hidden = true;</span>
<a href="#l40.302"></a><span id="l40.302">   GetTotalCountElement().hidden = true;</span>
<a href="#l40.303"></a><span id="l40.303">   GetMessagePane().collapsed = true;</span>
<a href="#l40.304"></a><span id="l40.304">   document.getElementById(&quot;threadpane-splitter&quot;).collapsed = true;</span>
<a href="#l40.305"></a><span id="l40.305">   document.getElementById(&quot;key_toggleMessagePane&quot;).setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l40.306"></a><span id="l40.306"> }</span>
<a href="#l40.307"></a><span id="l40.307"> </span>
<a href="#l40.308"></a><span id="l40.308"> // The zoom manager, view source and possibly some other functions still rely</span>
<a href="#l40.309"></a><span id="l40.309"> // on the getBrowser function.</span>
<a href="#l40.310"></a><span id="l40.310"> function getBrowser()</span>
<a href="#l40.311"></a><span id="l40.311"> {</span>
<a href="#l40.312"></a><span id="l40.312">   let tabmail = document.getElementById('tabmail');</span>
<a href="#l40.313"></a><span id="l40.313">   return tabmail ? tabmail.getBrowserForSelectedTab() :</span>
<a href="#l40.314"></a><span id="l40.314">                    document.getElementById(&quot;messagepane&quot;);</span>
<a href="#l40.315"></a><span id="l40.315"> }</span>
<a href="#l40.316"></a><span id="l40.316"> </span>
<a href="#l40.317"></a><span id="l40.317" class="difflineplus">+// When the ThreadPane is hidden via the displayDeck, we should collapse the</span>
<a href="#l40.318"></a><span id="l40.318" class="difflineplus">+// elements that are only meaningful to the thread pane. When AccountCentral is</span>
<a href="#l40.319"></a><span id="l40.319" class="difflineplus">+// shown via the displayDeck, we need to switch the displayDeck to show the</span>
<a href="#l40.320"></a><span id="l40.320" class="difflineplus">+// accountCentralBox, and load the iframe in the AccountCentral box with</span>
<a href="#l40.321"></a><span id="l40.321" class="difflineplus">+// corresponding page.</span>
<a href="#l40.322"></a><span id="l40.322"> var gCurrentDisplayDeckId = &quot;&quot;;</span>
<a href="#l40.323"></a><span id="l40.323"> function ObserveDisplayDeckChange(event)</span>
<a href="#l40.324"></a><span id="l40.324"> {</span>
<a href="#l40.325"></a><span id="l40.325">   var selectedPanel = document.getElementById(&quot;displayDeck&quot;).selectedPanel;</span>
<a href="#l40.326"></a><span id="l40.326">   var nowSelected = selectedPanel ? selectedPanel.id : null;</span>
<a href="#l40.327"></a><span id="l40.327">   // onselect fires for every mouse click inside the deck, so ObserveDisplayDeckChange is getting called every time we click</span>
<a href="#l40.328"></a><span id="l40.328">   // on a message in the thread pane. Only show / Hide elements if the selected deck is actually changing.</span>
<a href="#l40.329"></a><span id="l40.329">   if (nowSelected != gCurrentDisplayDeckId)</span>
<a href="#l40.330"></a><span id="l40.330" class="difflineat">@@ -579,33 +566,24 @@ function ObserveDisplayDeckChange(event)</span>
<a href="#l40.331"></a><span id="l40.331">   }</span>
<a href="#l40.332"></a><span id="l40.332"> }</span>
<a href="#l40.333"></a><span id="l40.333"> </span>
<a href="#l40.334"></a><span id="l40.334"> // Given the server, open the twisty and the set the selection</span>
<a href="#l40.335"></a><span id="l40.335"> // on inbox of that server.</span>
<a href="#l40.336"></a><span id="l40.336"> // prompt if offline.</span>
<a href="#l40.337"></a><span id="l40.337"> function OpenInboxForServer(server)</span>
<a href="#l40.338"></a><span id="l40.338"> {</span>
<a href="#l40.339"></a><span id="l40.339" class="difflineminus">-  ShowThreadPane();</span>
<a href="#l40.340"></a><span id="l40.340">   gFolderTreeView.selectFolder(GetInboxFolder(server));</span>
<a href="#l40.341"></a><span id="l40.341"> </span>
<a href="#l40.342"></a><span id="l40.342">   if (MailOfflineMgr.isOnline() || MailOfflineMgr.getNewMail()) {</span>
<a href="#l40.343"></a><span id="l40.343">     if (server.type != &quot;imap&quot;)</span>
<a href="#l40.344"></a><span id="l40.344">       GetMessagesForInboxOnServer(server);</span>
<a href="#l40.345"></a><span id="l40.345">   }</span>
<a href="#l40.346"></a><span id="l40.346"> }</span>
<a href="#l40.347"></a><span id="l40.347"> </span>
<a href="#l40.348"></a><span id="l40.348" class="difflineminus">-function GetSearchSession()</span>
<a href="#l40.349"></a><span id="l40.349" class="difflineminus">-{</span>
<a href="#l40.350"></a><span id="l40.350" class="difflineminus">-  if ((&quot;gSearchSession&quot; in top) &amp;&amp; gSearchSession)</span>
<a href="#l40.351"></a><span id="l40.351" class="difflineminus">-    return gSearchSession;</span>
<a href="#l40.352"></a><span id="l40.352" class="difflineminus">-  else</span>
<a href="#l40.353"></a><span id="l40.353" class="difflineminus">-    return null;</span>
<a href="#l40.354"></a><span id="l40.354" class="difflineminus">-}</span>
<a href="#l40.355"></a><span id="l40.355" class="difflineminus">-</span>
<a href="#l40.356"></a><span id="l40.356"> /** Update state of zoom type (text vs. full) menu item. */</span>
<a href="#l40.357"></a><span id="l40.357"> function UpdateFullZoomMenu() {</span>
<a href="#l40.358"></a><span id="l40.358">   var menuItem = document.getElementById(&quot;menu_fullZoomToggle&quot;);</span>
<a href="#l40.359"></a><span id="l40.359">   menuItem.setAttribute(&quot;checked&quot;, !ZoomManager.useFullZoom);</span>
<a href="#l40.360"></a><span id="l40.360"> }</span>
<a href="#l40.361"></a><span id="l40.361"> </span>
<a href="#l40.362"></a><span id="l40.362"> /**</span>
<a href="#l40.363"></a><span id="l40.363">  * This class implements nsIBadCertListener2.  Its job is to prevent &quot;bad cert&quot;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l41.1"></a><span id="l41.1" class="difflineminus">--- a/mail/base/content/mailWindowOverlay.js</span>
<a href="#l41.2"></a><span id="l41.2" class="difflineplus">+++ b/mail/base/content/mailWindowOverlay.js</span>
<a href="#l41.3"></a><span id="l41.3" class="difflineat">@@ -1,55 +1,55 @@</span>
<a href="#l41.4"></a><span id="l41.4" class="difflineminus">-# -*- Mode: javascript; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l41.5"></a><span id="l41.5" class="difflineminus">-# ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l41.6"></a><span id="l41.6" class="difflineminus">-# Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l41.7"></a><span id="l41.7" class="difflineminus">-#</span>
<a href="#l41.8"></a><span id="l41.8" class="difflineminus">-# The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l41.9"></a><span id="l41.9" class="difflineminus">-# 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l41.10"></a><span id="l41.10" class="difflineminus">-# the License. You may obtain a copy of the License at</span>
<a href="#l41.11"></a><span id="l41.11" class="difflineminus">-# http://www.mozilla.org/MPL/</span>
<a href="#l41.12"></a><span id="l41.12" class="difflineminus">-#</span>
<a href="#l41.13"></a><span id="l41.13" class="difflineminus">-# Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l41.14"></a><span id="l41.14" class="difflineminus">-# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l41.15"></a><span id="l41.15" class="difflineminus">-# for the specific language governing rights and limitations under the</span>
<a href="#l41.16"></a><span id="l41.16" class="difflineminus">-# License.</span>
<a href="#l41.17"></a><span id="l41.17" class="difflineminus">-#</span>
<a href="#l41.18"></a><span id="l41.18" class="difflineminus">-# The Original Code is Mozilla Communicator client code, released</span>
<a href="#l41.19"></a><span id="l41.19" class="difflineminus">-# March 31, 1998.</span>
<a href="#l41.20"></a><span id="l41.20" class="difflineminus">-#</span>
<a href="#l41.21"></a><span id="l41.21" class="difflineminus">-# The Initial Developer of the Original Code is</span>
<a href="#l41.22"></a><span id="l41.22" class="difflineminus">-# Netscape Communications Corporation.</span>
<a href="#l41.23"></a><span id="l41.23" class="difflineminus">-# Portions created by the Initial Developer are Copyright (C) 1998-1999</span>
<a href="#l41.24"></a><span id="l41.24" class="difflineminus">-# the Initial Developer. All Rights Reserved.</span>
<a href="#l41.25"></a><span id="l41.25" class="difflineminus">-#</span>
<a href="#l41.26"></a><span id="l41.26" class="difflineminus">-# Contributor(s):</span>
<a href="#l41.27"></a><span id="l41.27" class="difflineminus">-#   timeless</span>
<a href="#l41.28"></a><span id="l41.28" class="difflineminus">-#   slucy@objectivesw.co.uk</span>
<a href="#l41.29"></a><span id="l41.29" class="difflineminus">-#   HÃ¥kan Waara &lt;hwaara@chello.se&gt;</span>
<a href="#l41.30"></a><span id="l41.30" class="difflineminus">-#   Jan Varga &lt;varga@nixcorp.com&gt;</span>
<a href="#l41.31"></a><span id="l41.31" class="difflineminus">-#   Seth Spitzer &lt;sspitzer@netscape.com&gt;</span>
<a href="#l41.32"></a><span id="l41.32" class="difflineminus">-#   David Bienvenu &lt;bienvenu@nventure.com&gt;</span>
<a href="#l41.33"></a><span id="l41.33" class="difflineminus">-#   Karsten DÃ¼sterloh &lt;mnyromyr@tprac.de&gt;</span>
<a href="#l41.34"></a><span id="l41.34" class="difflineminus">-#   Christopher Thomas &lt;cst@yecc.com&gt;</span>
<a href="#l41.35"></a><span id="l41.35" class="difflineminus">-#   Jeremy Morton &lt;bugzilla@game-point.net&gt;</span>
<a href="#l41.36"></a><span id="l41.36" class="difflineminus">-#   Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a href="#l41.37"></a><span id="l41.37" class="difflineminus">-#</span>
<a href="#l41.38"></a><span id="l41.38" class="difflineminus">-# Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l41.39"></a><span id="l41.39" class="difflineminus">-# either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l41.40"></a><span id="l41.40" class="difflineminus">-# the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l41.41"></a><span id="l41.41" class="difflineminus">-# in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l41.42"></a><span id="l41.42" class="difflineminus">-# of those above. If you wish to allow use of your version of this file only</span>
<a href="#l41.43"></a><span id="l41.43" class="difflineminus">-# under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l41.44"></a><span id="l41.44" class="difflineminus">-# use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l41.45"></a><span id="l41.45" class="difflineminus">-# decision by deleting the provisions above and replace them with the notice</span>
<a href="#l41.46"></a><span id="l41.46" class="difflineminus">-# and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l41.47"></a><span id="l41.47" class="difflineminus">-# the provisions above, a recipient may use your version of this file under</span>
<a href="#l41.48"></a><span id="l41.48" class="difflineminus">-# the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l41.49"></a><span id="l41.49" class="difflineminus">-#</span>
<a href="#l41.50"></a><span id="l41.50" class="difflineminus">-# ***** END LICENSE BLOCK *****</span>
<a href="#l41.51"></a><span id="l41.51" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l41.52"></a><span id="l41.52" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l41.53"></a><span id="l41.53" class="difflineplus">+ *</span>
<a href="#l41.54"></a><span id="l41.54" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l41.55"></a><span id="l41.55" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l41.56"></a><span id="l41.56" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l41.57"></a><span id="l41.57" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l41.58"></a><span id="l41.58" class="difflineplus">+ *</span>
<a href="#l41.59"></a><span id="l41.59" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l41.60"></a><span id="l41.60" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l41.61"></a><span id="l41.61" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l41.62"></a><span id="l41.62" class="difflineplus">+ * License.</span>
<a href="#l41.63"></a><span id="l41.63" class="difflineplus">+ *</span>
<a href="#l41.64"></a><span id="l41.64" class="difflineplus">+ * The Original Code is Mozilla Communicator client code, released</span>
<a href="#l41.65"></a><span id="l41.65" class="difflineplus">+ * March 31, 1998.</span>
<a href="#l41.66"></a><span id="l41.66" class="difflineplus">+ *</span>
<a href="#l41.67"></a><span id="l41.67" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l41.68"></a><span id="l41.68" class="difflineplus">+ * Netscape Communications Corporation.</span>
<a href="#l41.69"></a><span id="l41.69" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 1998-1999</span>
<a href="#l41.70"></a><span id="l41.70" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l41.71"></a><span id="l41.71" class="difflineplus">+ *</span>
<a href="#l41.72"></a><span id="l41.72" class="difflineplus">+ * Contributor(s):</span>
<a href="#l41.73"></a><span id="l41.73" class="difflineplus">+ *   timeless</span>
<a href="#l41.74"></a><span id="l41.74" class="difflineplus">+ *   slucy@objectivesw.co.uk</span>
<a href="#l41.75"></a><span id="l41.75" class="difflineplus">+ *   HÃ¥kan Waara &lt;hwaara@chello.se&gt;</span>
<a href="#l41.76"></a><span id="l41.76" class="difflineplus">+ *   Jan Varga &lt;varga@nixcorp.com&gt;</span>
<a href="#l41.77"></a><span id="l41.77" class="difflineplus">+ *   Seth Spitzer &lt;sspitzer@netscape.com&gt;</span>
<a href="#l41.78"></a><span id="l41.78" class="difflineplus">+ *   David Bienvenu &lt;bienvenu@nventure.com&gt;</span>
<a href="#l41.79"></a><span id="l41.79" class="difflineplus">+ *   Karsten DÃ¼sterloh &lt;mnyromyr@tprac.de&gt;</span>
<a href="#l41.80"></a><span id="l41.80" class="difflineplus">+ *   Christopher Thomas &lt;cst@yecc.com&gt;</span>
<a href="#l41.81"></a><span id="l41.81" class="difflineplus">+ *   Jeremy Morton &lt;bugzilla@game-point.net&gt;</span>
<a href="#l41.82"></a><span id="l41.82" class="difflineplus">+ *   Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a href="#l41.83"></a><span id="l41.83" class="difflineplus">+ *   Dan Mosedale &lt;dmose@mozilla.org&gt;</span>
<a href="#l41.84"></a><span id="l41.84" class="difflineplus">+ *</span>
<a href="#l41.85"></a><span id="l41.85" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l41.86"></a><span id="l41.86" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l41.87"></a><span id="l41.87" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l41.88"></a><span id="l41.88" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l41.89"></a><span id="l41.89" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l41.90"></a><span id="l41.90" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l41.91"></a><span id="l41.91" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l41.92"></a><span id="l41.92" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l41.93"></a><span id="l41.93" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l41.94"></a><span id="l41.94" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l41.95"></a><span id="l41.95" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l41.96"></a><span id="l41.96" class="difflineplus">+ *</span>
<a href="#l41.97"></a><span id="l41.97" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l41.98"></a><span id="l41.98"> </span>
<a href="#l41.99"></a><span id="l41.99"> const ADDR_DB_LARGE_COMMIT       = 1;</span>
<a href="#l41.100"></a><span id="l41.100"> </span>
<a href="#l41.101"></a><span id="l41.101"> const kClassicMailLayout = 0;</span>
<a href="#l41.102"></a><span id="l41.102"> const kWideMailLayout = 1;</span>
<a href="#l41.103"></a><span id="l41.103"> const kVerticalMailLayout = 2;</span>
<a href="#l41.104"></a><span id="l41.104"> </span>
<a href="#l41.105"></a><span id="l41.105"> // Per message header flags to keep track of whether the user is allowing remote</span>
<a href="#l41.106"></a><span id="l41.106" class="difflineat">@@ -153,17 +153,17 @@ function InitEditMessagesMenu()</span>
<a href="#l41.107"></a><span id="l41.107"> </span>
<a href="#l41.108"></a><span id="l41.108"> function InitGoMessagesMenu()</span>
<a href="#l41.109"></a><span id="l41.109"> {</span>
<a href="#l41.110"></a><span id="l41.110">   document.commandDispatcher.updateCommands('create-menu-go');</span>
<a href="#l41.111"></a><span id="l41.111"> }</span>
<a href="#l41.112"></a><span id="l41.112"> </span>
<a href="#l41.113"></a><span id="l41.113"> function view_init()</span>
<a href="#l41.114"></a><span id="l41.114"> {</span>
<a href="#l41.115"></a><span id="l41.115" class="difflineminus">-  var isFeed = IsFeedItem();</span>
<a href="#l41.116"></a><span id="l41.116" class="difflineplus">+  var isFeed = gFolderDisplay.selectedMessageIsFeed;</span>
<a href="#l41.117"></a><span id="l41.117"> </span>
<a href="#l41.118"></a><span id="l41.118">   if (!gMessengerBundle)</span>
<a href="#l41.119"></a><span id="l41.119">     gMessengerBundle = document.getElementById(&quot;bundle_messenger&quot;);</span>
<a href="#l41.120"></a><span id="l41.120"> </span>
<a href="#l41.121"></a><span id="l41.121">   var messagePaneMenuItem = document.getElementById(&quot;menu_showMessage&quot;);</span>
<a href="#l41.122"></a><span id="l41.122">   if (!messagePaneMenuItem.hidden) { // Hidden in the standalone msg window.</span>
<a href="#l41.123"></a><span id="l41.123">     messagePaneMenuItem.setAttribute(&quot;checked&quot;, !IsMessagePaneCollapsed());</span>
<a href="#l41.124"></a><span id="l41.124">     messagePaneMenuItem.disabled = gAccountCentralLoaded;</span>
<a href="#l41.125"></a><span id="l41.125" class="difflineat">@@ -232,105 +232,106 @@ function InitViewFolderViewsMenu(event)</span>
<a href="#l41.126"></a><span id="l41.126"> </span>
<a href="#l41.127"></a><span id="l41.127"> function setSortByMenuItemCheckState(id, value)</span>
<a href="#l41.128"></a><span id="l41.128"> {</span>
<a href="#l41.129"></a><span id="l41.129">   var menuitem = document.getElementById(id);</span>
<a href="#l41.130"></a><span id="l41.130">   if (menuitem)</span>
<a href="#l41.131"></a><span id="l41.131">     menuitem.setAttribute(&quot;checked&quot;, value);</span>
<a href="#l41.132"></a><span id="l41.132"> }</span>
<a href="#l41.133"></a><span id="l41.133"> </span>
<a href="#l41.134"></a><span id="l41.134" class="difflineplus">+/**</span>
<a href="#l41.135"></a><span id="l41.135" class="difflineplus">+ * Called when showing the menu_viewSortPopup menupopup, so it should always</span>
<a href="#l41.136"></a><span id="l41.136" class="difflineplus">+ * be up-to-date.</span>
<a href="#l41.137"></a><span id="l41.137" class="difflineplus">+ */</span>
<a href="#l41.138"></a><span id="l41.138"> function InitViewSortByMenu()</span>
<a href="#l41.139"></a><span id="l41.139"> {</span>
<a href="#l41.140"></a><span id="l41.140" class="difflineminus">-  var sortType = gDBView.sortType;</span>
<a href="#l41.141"></a><span id="l41.141" class="difflineplus">+  var sortType = gFolderDisplay.view.primarySortType;</span>
<a href="#l41.142"></a><span id="l41.142"> </span>
<a href="#l41.143"></a><span id="l41.143">   setSortByMenuItemCheckState(&quot;sortByDateMenuitem&quot;, (sortType == nsMsgViewSortType.byDate));</span>
<a href="#l41.144"></a><span id="l41.144">   setSortByMenuItemCheckState(&quot;sortByReceivedMenuitem&quot;, (sortType == nsMsgViewSortType.byReceived));</span>
<a href="#l41.145"></a><span id="l41.145">   setSortByMenuItemCheckState(&quot;sortByFlagMenuitem&quot;, (sortType == nsMsgViewSortType.byFlagged));</span>
<a href="#l41.146"></a><span id="l41.146">   setSortByMenuItemCheckState(&quot;sortByOrderReceivedMenuitem&quot;, (sortType == nsMsgViewSortType.byId));</span>
<a href="#l41.147"></a><span id="l41.147">   setSortByMenuItemCheckState(&quot;sortByPriorityMenuitem&quot;, (sortType == nsMsgViewSortType.byPriority));</span>
<a href="#l41.148"></a><span id="l41.148">   setSortByMenuItemCheckState(&quot;sortBySizeMenuitem&quot;, (sortType == nsMsgViewSortType.bySize));</span>
<a href="#l41.149"></a><span id="l41.149">   setSortByMenuItemCheckState(&quot;sortByStatusMenuitem&quot;, (sortType == nsMsgViewSortType.byStatus));</span>
<a href="#l41.150"></a><span id="l41.150">   setSortByMenuItemCheckState(&quot;sortBySubjectMenuitem&quot;, (sortType == nsMsgViewSortType.bySubject));</span>
<a href="#l41.151"></a><span id="l41.151">   setSortByMenuItemCheckState(&quot;sortByUnreadMenuitem&quot;, (sortType == nsMsgViewSortType.byUnread));</span>
<a href="#l41.152"></a><span id="l41.152">   setSortByMenuItemCheckState(&quot;sortByTagsMenuitem&quot;, (sortType == nsMsgViewSortType.byTags));</span>
<a href="#l41.153"></a><span id="l41.153">   setSortByMenuItemCheckState(&quot;sortByJunkStatusMenuitem&quot;, (sortType == nsMsgViewSortType.byJunkStatus));</span>
<a href="#l41.154"></a><span id="l41.154">   setSortByMenuItemCheckState(&quot;sortByFromMenuitem&quot;, (sortType == nsMsgViewSortType.byAuthor));</span>
<a href="#l41.155"></a><span id="l41.155">   setSortByMenuItemCheckState(&quot;sortByRecipientMenuitem&quot;, (sortType == nsMsgViewSortType.byRecipient));</span>
<a href="#l41.156"></a><span id="l41.156">   setSortByMenuItemCheckState(&quot;sortByAttachmentsMenuitem&quot;, (sortType == nsMsgViewSortType.byAttachments));</span>
<a href="#l41.157"></a><span id="l41.157"> </span>
<a href="#l41.158"></a><span id="l41.158" class="difflineminus">-  var sortOrder = gDBView.sortOrder;</span>
<a href="#l41.159"></a><span id="l41.159" class="difflineplus">+  var sortOrder = gFolderDisplay.view.primarySortOrder;</span>
<a href="#l41.160"></a><span id="l41.160">   var sortTypeSupportsGrouping = (sortType == nsMsgViewSortType.byAuthor ||</span>
<a href="#l41.161"></a><span id="l41.161">       sortType == nsMsgViewSortType.byDate || sortType == nsMsgViewSortType.byReceived ||</span>
<a href="#l41.162"></a><span id="l41.162">       sortType == nsMsgViewSortType.byPriority ||</span>
<a href="#l41.163"></a><span id="l41.163">       sortType == nsMsgViewSortType.bySubject || sortType == nsMsgViewSortType.byTags ||</span>
<a href="#l41.164"></a><span id="l41.164">       sortType == nsMsgViewSortType.byRecipient || sortType == nsMsgViewSortType.byAccount ||</span>
<a href="#l41.165"></a><span id="l41.165">       sortType == nsMsgViewSortType.byStatus || sortType == nsMsgViewSortType.byFlagged ||</span>
<a href="#l41.166"></a><span id="l41.166">       sortType == nsMsgViewSortType.byAttachments);</span>
<a href="#l41.167"></a><span id="l41.167"> </span>
<a href="#l41.168"></a><span id="l41.168">   setSortByMenuItemCheckState(&quot;sortAscending&quot;, (sortOrder == nsMsgViewSortOrder.ascending));</span>
<a href="#l41.169"></a><span id="l41.169">   setSortByMenuItemCheckState(&quot;sortDescending&quot;, (sortOrder == nsMsgViewSortOrder.descending));</span>
<a href="#l41.170"></a><span id="l41.170"> </span>
<a href="#l41.171"></a><span id="l41.171" class="difflineminus">-  var grouped = ((gDBView.viewFlags &amp; nsMsgViewFlagsType.kGroupBySort) != 0);</span>
<a href="#l41.172"></a><span id="l41.172" class="difflineminus">-  var threaded = ((gDBView.viewFlags &amp; nsMsgViewFlagsType.kThreadedDisplay) != 0 &amp;&amp; !grouped);</span>
<a href="#l41.173"></a><span id="l41.173" class="difflineplus">+  var grouped = gFolderDisplay.view.showGroupedBySort;</span>
<a href="#l41.174"></a><span id="l41.174" class="difflineplus">+  var threaded = gFolderDisplay.view.showThreaded;</span>
<a href="#l41.175"></a><span id="l41.175">   var sortThreadedMenuItem = document.getElementById(&quot;sortThreaded&quot;);</span>
<a href="#l41.176"></a><span id="l41.176">   var sortUnthreadedMenuItem = document.getElementById(&quot;sortUnthreaded&quot;);</span>
<a href="#l41.177"></a><span id="l41.177"> </span>
<a href="#l41.178"></a><span id="l41.178">   sortThreadedMenuItem.setAttribute(&quot;checked&quot;, threaded);</span>
<a href="#l41.179"></a><span id="l41.179">   sortUnthreadedMenuItem.setAttribute(&quot;checked&quot;, !threaded &amp;&amp; !grouped);</span>
<a href="#l41.180"></a><span id="l41.180"> </span>
<a href="#l41.181"></a><span id="l41.181">   var groupBySortOrderMenuItem = document.getElementById(&quot;groupBySort&quot;);</span>
<a href="#l41.182"></a><span id="l41.182"> </span>
<a href="#l41.183"></a><span id="l41.183">   groupBySortOrderMenuItem.setAttribute(&quot;disabled&quot;, !sortTypeSupportsGrouping);</span>
<a href="#l41.184"></a><span id="l41.184">   groupBySortOrderMenuItem.setAttribute(&quot;checked&quot;, grouped);</span>
<a href="#l41.185"></a><span id="l41.185"> }</span>
<a href="#l41.186"></a><span id="l41.186"> </span>
<a href="#l41.187"></a><span id="l41.187"> function InitViewMessagesMenu()</span>
<a href="#l41.188"></a><span id="l41.188"> {</span>
<a href="#l41.189"></a><span id="l41.189" class="difflineminus">-  var viewFlags = (gDBView) ? gDBView.viewFlags : 0;</span>
<a href="#l41.190"></a><span id="l41.190" class="difflineminus">-  var viewType = (gDBView) ? gDBView.viewType : 0;</span>
<a href="#l41.191"></a><span id="l41.191" class="difflineminus">-</span>
<a href="#l41.192"></a><span id="l41.192">   document.getElementById(&quot;viewAllMessagesMenuItem&quot;).setAttribute(&quot;checked&quot;,</span>
<a href="#l41.193"></a><span id="l41.193" class="difflineminus">-    (viewFlags &amp; nsMsgViewFlagsType.kUnreadOnly) == 0 &amp;&amp;</span>
<a href="#l41.194"></a><span id="l41.194" class="difflineminus">-    (viewType == nsMsgViewType.eShowAllThreads));</span>
<a href="#l41.195"></a><span id="l41.195" class="difflineplus">+    !gFolderDisplay.view.showUnreadOnly &amp;&amp;</span>
<a href="#l41.196"></a><span id="l41.196" class="difflineplus">+    !gFolderDisplay.view.specialView);</span>
<a href="#l41.197"></a><span id="l41.197"> </span>
<a href="#l41.198"></a><span id="l41.198">   document.getElementById(&quot;viewUnreadMessagesMenuItem&quot;).setAttribute(&quot;checked&quot;,</span>
<a href="#l41.199"></a><span id="l41.199" class="difflineminus">-    (viewFlags &amp; nsMsgViewFlagsType.kUnreadOnly) != 0);</span>
<a href="#l41.200"></a><span id="l41.200" class="difflineplus">+    gFolderDisplay.view.showUnreadOnly);</span>
<a href="#l41.201"></a><span id="l41.201"> </span>
<a href="#l41.202"></a><span id="l41.202">   document.getElementById(&quot;viewThreadsWithUnreadMenuItem&quot;).setAttribute(&quot;checked&quot;,</span>
<a href="#l41.203"></a><span id="l41.203" class="difflineminus">-    viewType == nsMsgViewType.eShowThreadsWithUnread);</span>
<a href="#l41.204"></a><span id="l41.204" class="difflineplus">+    gFolderDisplay.view.specialViewThreadsWithUnread);</span>
<a href="#l41.205"></a><span id="l41.205"> </span>
<a href="#l41.206"></a><span id="l41.206">   document.getElementById(&quot;viewWatchedThreadsWithUnreadMenuItem&quot;).setAttribute(&quot;checked&quot;,</span>
<a href="#l41.207"></a><span id="l41.207" class="difflineminus">-    viewType == nsMsgViewType.eShowWatchedThreadsWithUnread);</span>
<a href="#l41.208"></a><span id="l41.208" class="difflineplus">+    gFolderDisplay.view.specialViewWatchedThreadsWithUnread);</span>
<a href="#l41.209"></a><span id="l41.209"> </span>
<a href="#l41.210"></a><span id="l41.210">   document.getElementById(&quot;viewIgnoredThreadsMenuItem&quot;).setAttribute(&quot;checked&quot;,</span>
<a href="#l41.211"></a><span id="l41.211" class="difflineminus">-    (viewFlags &amp; nsMsgViewFlagsType.kShowIgnored) != 0);</span>
<a href="#l41.212"></a><span id="l41.212" class="difflineplus">+    gFolderDisplay.view.showIgnored);</span>
<a href="#l41.213"></a><span id="l41.213"> }</span>
<a href="#l41.214"></a><span id="l41.214"> </span>
<a href="#l41.215"></a><span id="l41.215"> function InitMessageMenu()</span>
<a href="#l41.216"></a><span id="l41.216"> {</span>
<a href="#l41.217"></a><span id="l41.217" class="difflineminus">-  var selectedMsg = GetFirstSelectedMessage();</span>
<a href="#l41.218"></a><span id="l41.218" class="difflineminus">-  var isNews = IsNewsMessage(selectedMsg);</span>
<a href="#l41.219"></a><span id="l41.219" class="difflineminus">-  var isFeed = IsFeedItem();</span>
<a href="#l41.220"></a><span id="l41.220" class="difflineplus">+  var selectedMsg = gFolderDisplay.selectedMessage;</span>
<a href="#l41.221"></a><span id="l41.221" class="difflineplus">+  var isNews = gFolderDisplay.selectedMessageIsNews;</span>
<a href="#l41.222"></a><span id="l41.222" class="difflineplus">+  var isFeed = gFolderDisplay.selectedMessageIsFeed;</span>
<a href="#l41.223"></a><span id="l41.223"> </span>
<a href="#l41.224"></a><span id="l41.224">   // We show reply to Newsgroups only for news messages.</span>
<a href="#l41.225"></a><span id="l41.225">   document.getElementById(&quot;replyNewsgroupMainMenu&quot;).hidden = !isNews;</span>
<a href="#l41.226"></a><span id="l41.226"> </span>
<a href="#l41.227"></a><span id="l41.227">   // For mail messages we say reply. For news we say ReplyToSender.</span>
<a href="#l41.228"></a><span id="l41.228">   document.getElementById(&quot;replyMainMenu&quot;).hidden = isNews;</span>
<a href="#l41.229"></a><span id="l41.229">   document.getElementById(&quot;replySenderMainMenu&quot;).hidden = !isNews;</span>
<a href="#l41.230"></a><span id="l41.230"> </span>
<a href="#l41.231"></a><span id="l41.231">   // We only kill and watch threads for news.</span>
<a href="#l41.232"></a><span id="l41.232">   document.getElementById(&quot;threadItemsSeparator&quot;).hidden = !isNews;</span>
<a href="#l41.233"></a><span id="l41.233">   document.getElementById(&quot;killThread&quot;).hidden = !isNews;</span>
<a href="#l41.234"></a><span id="l41.234">   document.getElementById(&quot;killSubthread&quot;).hidden = !isNews;</span>
<a href="#l41.235"></a><span id="l41.235">   document.getElementById(&quot;watchThread&quot;).hidden = !isNews;</span>
<a href="#l41.236"></a><span id="l41.236"> </span>
<a href="#l41.237"></a><span id="l41.237">   // Disable the move and copy menus if there are no messages selected.</span>
<a href="#l41.238"></a><span id="l41.238">   // Disable the move menu if we can't delete msgs from the folder.</span>
<a href="#l41.239"></a><span id="l41.239" class="difflineminus">-  var msgFolder = GetLoadedMsgFolder();</span>
<a href="#l41.240"></a><span id="l41.240" class="difflineplus">+  var msgFolder = gFolderDisplay.displayedFolder;</span>
<a href="#l41.241"></a><span id="l41.241">   var enableMenuItem = selectedMsg &amp;&amp; msgFolder &amp;&amp; msgFolder.canDeleteMessages;</span>
<a href="#l41.242"></a><span id="l41.242">   document.getElementById(&quot;moveMenu&quot;).disabled = !enableMenuItem;</span>
<a href="#l41.243"></a><span id="l41.243"> </span>
<a href="#l41.244"></a><span id="l41.244">   // Also disable copy when no folder is loaded (like for .eml files).</span>
<a href="#l41.245"></a><span id="l41.245">   document.getElementById(&quot;copyMenu&quot;).disabled = !(selectedMsg &amp;&amp; msgFolder);</span>
<a href="#l41.246"></a><span id="l41.246"> </span>
<a href="#l41.247"></a><span id="l41.247">   initMoveToFolderAgainMenu(document.getElementById(&quot;moveToFolderAgain&quot;));</span>
<a href="#l41.248"></a><span id="l41.248"> </span>
<a href="#l41.249"></a><span id="l41.249" class="difflineat">@@ -411,17 +412,17 @@ function InitViewHeadersMenu()</span>
<a href="#l41.250"></a><span id="l41.250">     menuitem.setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l41.251"></a><span id="l41.251"> }</span>
<a href="#l41.252"></a><span id="l41.252"> </span>
<a href="#l41.253"></a><span id="l41.253"> function InitViewBodyMenu()</span>
<a href="#l41.254"></a><span id="l41.254"> {</span>
<a href="#l41.255"></a><span id="l41.255">   var html_as = 0;</span>
<a href="#l41.256"></a><span id="l41.256">   var prefer_plaintext = false;</span>
<a href="#l41.257"></a><span id="l41.257">   var disallow_classes = 0;</span>
<a href="#l41.258"></a><span id="l41.258" class="difflineminus">-  var isFeed = IsFeedItem();</span>
<a href="#l41.259"></a><span id="l41.259" class="difflineplus">+  var isFeed = gFolderDisplay.selectedMessageIsFeed;</span>
<a href="#l41.260"></a><span id="l41.260">   const defaultIDs = [&quot;bodyAllowHTML&quot;,</span>
<a href="#l41.261"></a><span id="l41.261">                       &quot;bodySanitized&quot;,</span>
<a href="#l41.262"></a><span id="l41.262">                       &quot;bodyAsPlaintext&quot;];</span>
<a href="#l41.263"></a><span id="l41.263">   const rssIDs = [&quot;bodyFeedSummaryAllowHTML&quot;,</span>
<a href="#l41.264"></a><span id="l41.264">                   &quot;bodyFeedSummarySanitized&quot;,</span>
<a href="#l41.265"></a><span id="l41.265">                   &quot;bodyFeedSummaryAsPlaintext&quot;];</span>
<a href="#l41.266"></a><span id="l41.266">   var menuIDs = isFeed ? rssIDs : defaultIDs;</span>
<a href="#l41.267"></a><span id="l41.267">   try</span>
<a href="#l41.268"></a><span id="l41.268" class="difflineat">@@ -465,45 +466,27 @@ function InitViewBodyMenu()</span>
<a href="#l41.269"></a><span id="l41.269">   if (isFeed) {</span>
<a href="#l41.270"></a><span id="l41.270">     AllowHTML_menuitem.hidden = !gShowFeedSummary;</span>
<a href="#l41.271"></a><span id="l41.271">     Sanitized_menuitem.hidden = !gShowFeedSummary;</span>
<a href="#l41.272"></a><span id="l41.272">     AsPlaintext_menuitem.hidden = !gShowFeedSummary;</span>
<a href="#l41.273"></a><span id="l41.273">     document.getElementById(&quot;viewFeedSummarySeparator&quot;).hidden = !gShowFeedSummary;</span>
<a href="#l41.274"></a><span id="l41.274">   }</span>
<a href="#l41.275"></a><span id="l41.275"> }</span>
<a href="#l41.276"></a><span id="l41.276"> </span>
<a href="#l41.277"></a><span id="l41.277" class="difflineminus">-function IsNewsMessage(messageUri)</span>
<a href="#l41.278"></a><span id="l41.278" class="difflineminus">-{</span>
<a href="#l41.279"></a><span id="l41.279" class="difflineminus">-  return (/^news-message:/.test(messageUri));</span>
<a href="#l41.280"></a><span id="l41.280" class="difflineminus">-}</span>
<a href="#l41.281"></a><span id="l41.281" class="difflineminus">-</span>
<a href="#l41.282"></a><span id="l41.282" class="difflineminus">-function IsImapMessage(messageUri)</span>
<a href="#l41.283"></a><span id="l41.283" class="difflineminus">-{</span>
<a href="#l41.284"></a><span id="l41.284" class="difflineminus">-  return (/^imap-message:/.test(messageUri));</span>
<a href="#l41.285"></a><span id="l41.285" class="difflineminus">-}</span>
<a href="#l41.286"></a><span id="l41.286" class="difflineminus">-</span>
<a href="#l41.287"></a><span id="l41.287" class="difflineminus">-function IsFeedItem()</span>
<a href="#l41.288"></a><span id="l41.288" class="difflineminus">-{</span>
<a href="#l41.289"></a><span id="l41.289" class="difflineminus">-  return (GetFirstSelectedMessage() &amp;&amp;</span>
<a href="#l41.290"></a><span id="l41.290" class="difflineminus">-          ((gMsgFolderSelected &amp;&amp;</span>
<a href="#l41.291"></a><span id="l41.291" class="difflineminus">-            gMsgFolderSelected.server.type == 'rss') ||</span>
<a href="#l41.292"></a><span id="l41.292" class="difflineminus">-           'content-base' in currentHeaderData));</span>
<a href="#l41.293"></a><span id="l41.293" class="difflineminus">-}</span>
<a href="#l41.294"></a><span id="l41.294" class="difflineminus">-</span>
<a href="#l41.295"></a><span id="l41.295"> function SetMenuItemLabel(menuItemId, customLabel)</span>
<a href="#l41.296"></a><span id="l41.296"> {</span>
<a href="#l41.297"></a><span id="l41.297">   var menuItem = document.getElementById(menuItemId);</span>
<a href="#l41.298"></a><span id="l41.298">   if (menuItem)</span>
<a href="#l41.299"></a><span id="l41.299">     menuItem.setAttribute('label', customLabel);</span>
<a href="#l41.300"></a><span id="l41.300"> }</span>
<a href="#l41.301"></a><span id="l41.301"> </span>
<a href="#l41.302"></a><span id="l41.302"> function RemoveAllMessageTags()</span>
<a href="#l41.303"></a><span id="l41.303"> {</span>
<a href="#l41.304"></a><span id="l41.304" class="difflineminus">-  var selectedMsgUris = GetSelectedMessages();</span>
<a href="#l41.305"></a><span id="l41.305" class="difflineminus">-  if (!selectedMsgUris.length)</span>
<a href="#l41.306"></a><span id="l41.306" class="difflineplus">+  var selectedMessages = gFolderDisplay.selectedMessages;</span>
<a href="#l41.307"></a><span id="l41.307" class="difflineplus">+  if (!selectedMessages.length)</span>
<a href="#l41.308"></a><span id="l41.308">     return;</span>
<a href="#l41.309"></a><span id="l41.309"> </span>
<a href="#l41.310"></a><span id="l41.310">   var messages = Components.classes[&quot;@mozilla.org/array;1&quot;]</span>
<a href="#l41.311"></a><span id="l41.311">                            .createInstance(Components.interfaces.nsIMutableArray);</span>
<a href="#l41.312"></a><span id="l41.312">   var tagService = Components.classes[&quot;@mozilla.org/messenger/tagservice;1&quot;]</span>
<a href="#l41.313"></a><span id="l41.313">                              .getService(Components.interfaces.nsIMsgTagService);</span>
<a href="#l41.314"></a><span id="l41.314">   var tagArray = tagService.getAllTags({});</span>
<a href="#l41.315"></a><span id="l41.315"> </span>
<a href="#l41.316"></a><span id="l41.316" class="difflineat">@@ -518,19 +501,19 @@ function RemoveAllMessageTags()</span>
<a href="#l41.317"></a><span id="l41.317">   var prevHdrFolder = null;</span>
<a href="#l41.318"></a><span id="l41.318">   // this crudely handles cross-folder virtual folders with selected messages</span>
<a href="#l41.319"></a><span id="l41.319">   // that spans folders, by coalescing consecutive messages in the selection</span>
<a href="#l41.320"></a><span id="l41.320">   // that happen to be in the same folder. nsMsgSearchDBView does this better,</span>
<a href="#l41.321"></a><span id="l41.321">   // but nsIMsgDBView doesn't handle commands with arguments, and untag takes a</span>
<a href="#l41.322"></a><span id="l41.322">   // key argument. Furthermore, we only delete legacy labels and known tags,</span>
<a href="#l41.323"></a><span id="l41.323">   // keeping other keywords like (non)junk intact.</span>
<a href="#l41.324"></a><span id="l41.324"> </span>
<a href="#l41.325"></a><span id="l41.325" class="difflineminus">-  for (var i = 0; i &lt; selectedMsgUris.length; ++i)</span>
<a href="#l41.326"></a><span id="l41.326" class="difflineplus">+  for (var i = 0; i &lt; selectedMessages.length; ++i)</span>
<a href="#l41.327"></a><span id="l41.327">   {</span>
<a href="#l41.328"></a><span id="l41.328" class="difflineminus">-    var msgHdr = messenger.msgHdrFromURI(selectedMsgUris[i]);</span>
<a href="#l41.329"></a><span id="l41.329" class="difflineplus">+    var msgHdr = selectedMessages[i];</span>
<a href="#l41.330"></a><span id="l41.330">     msgHdr.label = 0; // remove legacy label</span>
<a href="#l41.331"></a><span id="l41.331">     if (prevHdrFolder != msgHdr.folder)</span>
<a href="#l41.332"></a><span id="l41.332">     {</span>
<a href="#l41.333"></a><span id="l41.333">       if (prevHdrFolder)</span>
<a href="#l41.334"></a><span id="l41.334">         prevHdrFolder.removeKeywordsFromMessages(messages, allKeys);</span>
<a href="#l41.335"></a><span id="l41.335">       messages.clear();</span>
<a href="#l41.336"></a><span id="l41.336">       prevHdrFolder = msgHdr.folder;</span>
<a href="#l41.337"></a><span id="l41.337">     }</span>
<a href="#l41.338"></a><span id="l41.338" class="difflineat">@@ -542,17 +525,17 @@ function RemoveAllMessageTags()</span>
<a href="#l41.339"></a><span id="l41.339"> }</span>
<a href="#l41.340"></a><span id="l41.340"> </span>
<a href="#l41.341"></a><span id="l41.341"> function ToggleMessageTagKey(index)</span>
<a href="#l41.342"></a><span id="l41.342"> {</span>
<a href="#l41.343"></a><span id="l41.343">   if (GetNumSelectedMessages() &lt; 1)</span>
<a href="#l41.344"></a><span id="l41.344">     return;</span>
<a href="#l41.345"></a><span id="l41.345">   // set the tag state based upon that of the first selected message,</span>
<a href="#l41.346"></a><span id="l41.346">   // just like we do for markAsRead etc.</span>
<a href="#l41.347"></a><span id="l41.347" class="difflineminus">-  var msgHdr = gDBView.hdrForFirstSelectedMessage;</span>
<a href="#l41.348"></a><span id="l41.348" class="difflineplus">+  var msgHdr = gFolderDisplay.selectedMessage;</span>
<a href="#l41.349"></a><span id="l41.349">   var tagService = Components.classes[&quot;@mozilla.org/messenger/tagservice;1&quot;]</span>
<a href="#l41.350"></a><span id="l41.350">                              .getService(Components.interfaces.nsIMsgTagService);</span>
<a href="#l41.351"></a><span id="l41.351">   var tagArray = tagService.getAllTags({});</span>
<a href="#l41.352"></a><span id="l41.352">   for (var i = 0; i &lt; tagArray.length; ++i)</span>
<a href="#l41.353"></a><span id="l41.353">   {</span>
<a href="#l41.354"></a><span id="l41.354">     var key = tagArray[i].key;</span>
<a href="#l41.355"></a><span id="l41.355">     if (!--index)</span>
<a href="#l41.356"></a><span id="l41.356">     {</span>
<a href="#l41.357"></a><span id="l41.357" class="difflineat">@@ -575,27 +558,27 @@ function ToggleMessageTagMenu(target)</span>
<a href="#l41.358"></a><span id="l41.358"> }</span>
<a href="#l41.359"></a><span id="l41.359"> </span>
<a href="#l41.360"></a><span id="l41.360"> function ToggleMessageTag(key, addKey)</span>
<a href="#l41.361"></a><span id="l41.361"> {</span>
<a href="#l41.362"></a><span id="l41.362">   var messages = Components.classes[&quot;@mozilla.org/array;1&quot;]</span>
<a href="#l41.363"></a><span id="l41.363">                            .createInstance(Components.interfaces.nsIMutableArray);</span>
<a href="#l41.364"></a><span id="l41.364">   var msg = Components.classes[&quot;@mozilla.org/array;1&quot;]</span>
<a href="#l41.365"></a><span id="l41.365">                       .createInstance(Components.interfaces.nsIMutableArray);</span>
<a href="#l41.366"></a><span id="l41.366" class="difflineminus">-  var selectedMsgUris = GetSelectedMessages();</span>
<a href="#l41.367"></a><span id="l41.367" class="difflineplus">+  var selectedMessages = gFolderDisplay.selectedMessages;</span>
<a href="#l41.368"></a><span id="l41.368">   var toggler = addKey ? &quot;addKeywordsToMessages&quot; : &quot;removeKeywordsFromMessages&quot;;</span>
<a href="#l41.369"></a><span id="l41.369">   var prevHdrFolder = null;</span>
<a href="#l41.370"></a><span id="l41.370">   // this crudely handles cross-folder virtual folders with selected messages</span>
<a href="#l41.371"></a><span id="l41.371">   // that spans folders, by coalescing consecutive msgs in the selection</span>
<a href="#l41.372"></a><span id="l41.372">   // that happen to be in the same folder. nsMsgSearchDBView does this</span>
<a href="#l41.373"></a><span id="l41.373">   // better, but nsIMsgDBView doesn't handle commands with arguments,</span>
<a href="#l41.374"></a><span id="l41.374">   // and (un)tag takes a key argument.</span>
<a href="#l41.375"></a><span id="l41.375" class="difflineminus">-  for (var i = 0; i &lt; selectedMsgUris.length; ++i)</span>
<a href="#l41.376"></a><span id="l41.376" class="difflineplus">+  for (var i = 0; i &lt; selectedMessages.length; ++i)</span>
<a href="#l41.377"></a><span id="l41.377">   {</span>
<a href="#l41.378"></a><span id="l41.378" class="difflineminus">-    var msgHdr = messenger.msgHdrFromURI(selectedMsgUris[i]);</span>
<a href="#l41.379"></a><span id="l41.379" class="difflineplus">+    var msgHdr = selectedMessages[i];</span>
<a href="#l41.380"></a><span id="l41.380">     if (msgHdr.label)</span>
<a href="#l41.381"></a><span id="l41.381">     {</span>
<a href="#l41.382"></a><span id="l41.382">       // Since we touch all these messages anyway, migrate the label now.</span>
<a href="#l41.383"></a><span id="l41.383">       // If we don't, the thread tree won't always show the correct tag state,</span>
<a href="#l41.384"></a><span id="l41.384">       // because resetting a label doesn't update the tree anymore...</span>
<a href="#l41.385"></a><span id="l41.385">       msg.clear();</span>
<a href="#l41.386"></a><span id="l41.386">       msg.appendElement(msgHdr, false);</span>
<a href="#l41.387"></a><span id="l41.387">       msgHdr.folder.addKeywordsToMessages(msg, &quot;$label&quot; + msgHdr.label);</span>
<a href="#l41.388"></a><span id="l41.388" class="difflineat">@@ -643,17 +626,17 @@ function AddTagCallback(name, color)</span>
<a href="#l41.389"></a><span id="l41.389"> function SetMessageTagLabel(menuitem, index, name)</span>
<a href="#l41.390"></a><span id="l41.390"> {</span>
<a href="#l41.391"></a><span id="l41.391">   // if a &lt;key&gt; is defined for this tag, use its key as the accesskey</span>
<a href="#l41.392"></a><span id="l41.392">   // (the key for the tag at index n needs to have the id key_tag&lt;n&gt;)</span>
<a href="#l41.393"></a><span id="l41.393">   var shortcutkey = document.getElementById(&quot;key_tag&quot; + index);</span>
<a href="#l41.394"></a><span id="l41.394">   var accesskey = shortcutkey ? shortcutkey.getAttribute(&quot;key&quot;) : &quot;&quot;;</span>
<a href="#l41.395"></a><span id="l41.395">   if (accesskey)</span>
<a href="#l41.396"></a><span id="l41.396">     menuitem.setAttribute(&quot;accesskey&quot;, accesskey);</span>
<a href="#l41.397"></a><span id="l41.397" class="difflineminus">-  var label = gMessengerBundle.getFormattedString(&quot;mailnews.tags.format&quot;, </span>
<a href="#l41.398"></a><span id="l41.398" class="difflineplus">+  var label = gMessengerBundle.getFormattedString(&quot;mailnews.tags.format&quot;,</span>
<a href="#l41.399"></a><span id="l41.399">                                                   [accesskey, name]);</span>
<a href="#l41.400"></a><span id="l41.400">   menuitem.setAttribute(&quot;label&quot;, label);</span>
<a href="#l41.401"></a><span id="l41.401"> }</span>
<a href="#l41.402"></a><span id="l41.402"> </span>
<a href="#l41.403"></a><span id="l41.403"> function InitMessageTags(menuPopup)</span>
<a href="#l41.404"></a><span id="l41.404"> {</span>
<a href="#l41.405"></a><span id="l41.405">   var tagService = Components.classes[&quot;@mozilla.org/messenger/tagservice;1&quot;]</span>
<a href="#l41.406"></a><span id="l41.406">                              .getService(Components.interfaces.nsIMsgTagService);</span>
<a href="#l41.407"></a><span id="l41.407" class="difflineat">@@ -668,17 +651,17 @@ function InitMessageTags(menuPopup)</span>
<a href="#l41.408"></a><span id="l41.408">   // hide double menuseparator</span>
<a href="#l41.409"></a><span id="l41.409">   menuseparator.previousSibling.hidden = !tagCount;</span>
<a href="#l41.410"></a><span id="l41.410"> </span>
<a href="#l41.411"></a><span id="l41.411">   // create label and accesskey for the static remove item</span>
<a href="#l41.412"></a><span id="l41.412">   var tagRemoveLabel = gMessengerBundle.getString(&quot;mailnews.tags.remove&quot;);</span>
<a href="#l41.413"></a><span id="l41.413">   SetMessageTagLabel(menuPopup.firstChild, 0, tagRemoveLabel);</span>
<a href="#l41.414"></a><span id="l41.414"> </span>
<a href="#l41.415"></a><span id="l41.415">   // now rebuild the list</span>
<a href="#l41.416"></a><span id="l41.416" class="difflineminus">-  var msgHdr = gDBView.hdrForFirstSelectedMessage;</span>
<a href="#l41.417"></a><span id="l41.417" class="difflineplus">+  var msgHdr = gFolderDisplay.selectedMessage;</span>
<a href="#l41.418"></a><span id="l41.418">   var curKeys = msgHdr.getStringProperty(&quot;keywords&quot;);</span>
<a href="#l41.419"></a><span id="l41.419">   if (msgHdr.label)</span>
<a href="#l41.420"></a><span id="l41.420">     curKeys += &quot; $label&quot; + msgHdr.label;</span>
<a href="#l41.421"></a><span id="l41.421"> </span>
<a href="#l41.422"></a><span id="l41.422">   for (var i = 0; i &lt; tagCount; ++i)</span>
<a href="#l41.423"></a><span id="l41.423">   {</span>
<a href="#l41.424"></a><span id="l41.424">     var taginfo = tagArray[i];</span>
<a href="#l41.425"></a><span id="l41.425">     // TODO we want to either remove or &quot;check&quot; the tags that already exist</span>
<a href="#l41.426"></a><span id="l41.426" class="difflineat">@@ -686,17 +669,17 @@ function InitMessageTags(menuPopup)</span>
<a href="#l41.427"></a><span id="l41.427">     SetMessageTagLabel(newMenuItem, i + 1, taginfo.tag);</span>
<a href="#l41.428"></a><span id="l41.428">     newMenuItem.setAttribute(&quot;value&quot;, taginfo.key);</span>
<a href="#l41.429"></a><span id="l41.429">     newMenuItem.setAttribute(&quot;type&quot;, &quot;checkbox&quot;);</span>
<a href="#l41.430"></a><span id="l41.430">     var removeKey = (&quot; &quot; + curKeys + &quot; &quot;).indexOf(&quot; &quot; + taginfo.key + &quot; &quot;) &gt; -1;</span>
<a href="#l41.431"></a><span id="l41.431">     newMenuItem.setAttribute('checked', removeKey);</span>
<a href="#l41.432"></a><span id="l41.432">     newMenuItem.setAttribute('oncommand', 'ToggleMessageTagMenu(event.target);');</span>
<a href="#l41.433"></a><span id="l41.433">     var color = taginfo.color;</span>
<a href="#l41.434"></a><span id="l41.434">     if (color)</span>
<a href="#l41.435"></a><span id="l41.435" class="difflineminus">-      newMenuItem.setAttribute(&quot;class&quot;, &quot;lc-&quot; + color.substr(1));    </span>
<a href="#l41.436"></a><span id="l41.436" class="difflineplus">+      newMenuItem.setAttribute(&quot;class&quot;, &quot;lc-&quot; + color.substr(1));</span>
<a href="#l41.437"></a><span id="l41.437">     menuPopup.insertBefore(newMenuItem, menuseparator);</span>
<a href="#l41.438"></a><span id="l41.438">   }</span>
<a href="#l41.439"></a><span id="l41.439"> }</span>
<a href="#l41.440"></a><span id="l41.440"> </span>
<a href="#l41.441"></a><span id="l41.441"> function backToolbarMenu_init(menuPopup)</span>
<a href="#l41.442"></a><span id="l41.442"> {</span>
<a href="#l41.443"></a><span id="l41.443">   populateHistoryMenu(menuPopup, true);</span>
<a href="#l41.444"></a><span id="l41.444"> }</span>
<a href="#l41.445"></a><span id="l41.445" class="difflineat">@@ -722,38 +705,43 @@ function populateHistoryMenu(menuPopup, </span>
<a href="#l41.446"></a><span id="l41.446">   var numEntries = new Object;</span>
<a href="#l41.447"></a><span id="l41.447">   var historyEntries = new Object;</span>
<a href="#l41.448"></a><span id="l41.448">   messenger.getNavigateHistory(curPos, numEntries, historyEntries);</span>
<a href="#l41.449"></a><span id="l41.449">   curPos.value = curPos.value * 2;</span>
<a href="#l41.450"></a><span id="l41.450">   navDebug(&quot;curPos = &quot; + curPos.value + &quot; numEntries = &quot; + numEntries.value + &quot;\n&quot;);</span>
<a href="#l41.451"></a><span id="l41.451">   var historyArray = historyEntries.value;</span>
<a href="#l41.452"></a><span id="l41.452">   var folder;</span>
<a href="#l41.453"></a><span id="l41.453">   var newMenuItem;</span>
<a href="#l41.454"></a><span id="l41.454" class="difflineminus">-  if (GetLoadedMessage())</span>
<a href="#l41.455"></a><span id="l41.455" class="difflineplus">+  if (gFolderDisplay.selectedMessage)</span>
<a href="#l41.456"></a><span id="l41.456">   {</span>
<a href="#l41.457"></a><span id="l41.457">     if (!isBackMenu)</span>
<a href="#l41.458"></a><span id="l41.458">       curPos.value += 2;</span>
<a href="#l41.459"></a><span id="l41.459">     else</span>
<a href="#l41.460"></a><span id="l41.460">       curPos.value -= 2;</span>
<a href="#l41.461"></a><span id="l41.461">   }</span>
<a href="#l41.462"></a><span id="l41.462">   // For populating the back menu, we want the most recently visited</span>
<a href="#l41.463"></a><span id="l41.463">   // messages first in the menu. So we go backward from curPos to 0.</span>
<a href="#l41.464"></a><span id="l41.464">   // For the forward menu, we want to go forward from curPos to the end.</span>
<a href="#l41.465"></a><span id="l41.465">   var relPos = 0;</span>
<a href="#l41.466"></a><span id="l41.466">   for (var i = curPos.value; (isBackMenu) ? i &gt;= 0 : i &lt; historyArray.length; i += ((isBackMenu) ? -2 : 2))</span>
<a href="#l41.467"></a><span id="l41.467">   {</span>
<a href="#l41.468"></a><span id="l41.468">     navDebug(&quot;history[&quot; + i + &quot;] = &quot; + historyArray[i] + &quot;\n&quot;);</span>
<a href="#l41.469"></a><span id="l41.469">     navDebug(&quot;history[&quot; + i + &quot;] = &quot; + historyArray[i + 1] + &quot;\n&quot;);</span>
<a href="#l41.470"></a><span id="l41.470" class="difflineminus">-    folder = GetMsgFolderFromUri(historyArray[i + 1])</span>
<a href="#l41.471"></a><span id="l41.471" class="difflineplus">+    folder = GetMsgFolderFromUri(historyArray[i + 1]);</span>
<a href="#l41.472"></a><span id="l41.472">     navDebug(&quot;folder URI = &quot; + folder.URI + &quot;pretty name &quot; + folder.prettyName + &quot;\n&quot;);</span>
<a href="#l41.473"></a><span id="l41.473">     var menuText = &quot;&quot;;</span>
<a href="#l41.474"></a><span id="l41.474"> </span>
<a href="#l41.475"></a><span id="l41.475" class="difflineplus">+    // If the message was not being displayed via the current folder, prepend</span>
<a href="#l41.476"></a><span id="l41.476" class="difflineplus">+    //  the folder name.  We do not need to check underlying folders for</span>
<a href="#l41.477"></a><span id="l41.477" class="difflineplus">+    //  virtual folders because 'folder' is the display folder, not the</span>
<a href="#l41.478"></a><span id="l41.478" class="difflineplus">+    //  underlying one.</span>
<a href="#l41.479"></a><span id="l41.479" class="difflineplus">+    if (folder != gFolderDisplay.displayedFolder)</span>
<a href="#l41.480"></a><span id="l41.480" class="difflineplus">+      menuText = folder.prettyName + &quot; - &quot;;</span>
<a href="#l41.481"></a><span id="l41.481" class="difflineplus">+</span>
<a href="#l41.482"></a><span id="l41.482">     var msgHdr = messenger.msgHdrFromURI(historyArray[i]);</span>
<a href="#l41.483"></a><span id="l41.483" class="difflineminus">-    if (!IsCurrentLoadedFolder(folder))</span>
<a href="#l41.484"></a><span id="l41.484" class="difflineminus">-      menuText = folder.prettyName + &quot; - &quot;;</span>
<a href="#l41.485"></a><span id="l41.485"> </span>
<a href="#l41.486"></a><span id="l41.486">     var subject = &quot;&quot;;</span>
<a href="#l41.487"></a><span id="l41.487">     if (msgHdr.flags &amp; Components.interfaces.nsMsgMessageFlags.HasRe)</span>
<a href="#l41.488"></a><span id="l41.488">       subject = &quot;Re: &quot;;</span>
<a href="#l41.489"></a><span id="l41.489">     if (msgHdr.mime2DecodedSubject)</span>
<a href="#l41.490"></a><span id="l41.490">       subject += msgHdr.mime2DecodedSubject;</span>
<a href="#l41.491"></a><span id="l41.491">     if (subject)</span>
<a href="#l41.492"></a><span id="l41.492">       menuText += subject + &quot; - &quot;;</span>
<a href="#l41.493"></a><span id="l41.493" class="difflineat">@@ -766,27 +754,38 @@ function populateHistoryMenu(menuPopup, </span>
<a href="#l41.494"></a><span id="l41.494">     newMenuItem.folder = folder;</span>
<a href="#l41.495"></a><span id="l41.495">     newMenuItem.setAttribute('oncommand', 'NavigateToUri(event.target); event.stopPropagation();');</span>
<a href="#l41.496"></a><span id="l41.496">     menuPopup.appendChild(newMenuItem);</span>
<a href="#l41.497"></a><span id="l41.497">     if (! (relPos % 20))</span>
<a href="#l41.498"></a><span id="l41.498">       break;</span>
<a href="#l41.499"></a><span id="l41.499">   }</span>
<a href="#l41.500"></a><span id="l41.500"> }</span>
<a href="#l41.501"></a><span id="l41.501"> </span>
<a href="#l41.502"></a><span id="l41.502" class="difflineplus">+/**</span>
<a href="#l41.503"></a><span id="l41.503" class="difflineplus">+ * This is triggered by the history navigation menu options, as created by</span>
<a href="#l41.504"></a><span id="l41.504" class="difflineplus">+ *  populateHistoryMenu above.</span>
<a href="#l41.505"></a><span id="l41.505" class="difflineplus">+ */</span>
<a href="#l41.506"></a><span id="l41.506"> function NavigateToUri(target)</span>
<a href="#l41.507"></a><span id="l41.507"> {</span>
<a href="#l41.508"></a><span id="l41.508">   var historyIndex = target.getAttribute('value');</span>
<a href="#l41.509"></a><span id="l41.509">   var msgUri = messenger.getMsgUriAtNavigatePos(historyIndex);</span>
<a href="#l41.510"></a><span id="l41.510">   var folder = target.folder;</span>
<a href="#l41.511"></a><span id="l41.511">   var msgHdr = messenger.msgHdrFromURI(msgUri);</span>
<a href="#l41.512"></a><span id="l41.512">   navDebug(&quot;navigating from &quot; + messenger.navigatePos + &quot; by &quot; + historyIndex + &quot; to &quot; + msgUri + &quot;\n&quot;);</span>
<a href="#l41.513"></a><span id="l41.513"> </span>
<a href="#l41.514"></a><span id="l41.514">   // this &quot;- 0&quot; seems to ensure that historyIndex is treated as an int, not a string.</span>
<a href="#l41.515"></a><span id="l41.515">   messenger.navigatePos += (historyIndex - 0);</span>
<a href="#l41.516"></a><span id="l41.516" class="difflineminus">-  LoadNavigatedToMessage(msgHdr, folder, folder.URI);</span>
<a href="#l41.517"></a><span id="l41.517" class="difflineplus">+</span>
<a href="#l41.518"></a><span id="l41.518" class="difflineplus">+  if (gFolderDisplay.displayedFolder != folder) {</span>
<a href="#l41.519"></a><span id="l41.519" class="difflineplus">+    if (gFolderTreeView)</span>
<a href="#l41.520"></a><span id="l41.520" class="difflineplus">+      gFolderTreeView.selectFolder(folder);</span>
<a href="#l41.521"></a><span id="l41.521" class="difflineplus">+    else</span>
<a href="#l41.522"></a><span id="l41.522" class="difflineplus">+      gFolderDisplay.show(folder);</span>
<a href="#l41.523"></a><span id="l41.523" class="difflineplus">+  }</span>
<a href="#l41.524"></a><span id="l41.524" class="difflineplus">+  gFolderDisplay.selectMessage(msgHdr);</span>
<a href="#l41.525"></a><span id="l41.525"> }</span>
<a href="#l41.526"></a><span id="l41.526"> </span>
<a href="#l41.527"></a><span id="l41.527"> function forwardToolbarMenu_init(menuPopup)</span>
<a href="#l41.528"></a><span id="l41.528"> {</span>
<a href="#l41.529"></a><span id="l41.529">   populateHistoryMenu(menuPopup, false);</span>
<a href="#l41.530"></a><span id="l41.530"> }</span>
<a href="#l41.531"></a><span id="l41.531"> </span>
<a href="#l41.532"></a><span id="l41.532"> function InitMessageMark()</span>
<a href="#l41.533"></a><span id="l41.533" class="difflineat">@@ -802,107 +801,156 @@ function InitMessageMark()</span>
<a href="#l41.534"></a><span id="l41.534"> </span>
<a href="#l41.535"></a><span id="l41.535"> function UpdateJunkToolbarButton()</span>
<a href="#l41.536"></a><span id="l41.536"> {</span>
<a href="#l41.537"></a><span id="l41.537">   var junkButtonDeck = document.getElementById(&quot;junk-deck&quot;);</span>
<a href="#l41.538"></a><span id="l41.538">   if (junkButtonDeck)</span>
<a href="#l41.539"></a><span id="l41.539">     junkButtonDeck.selectedIndex = SelectedMessagesAreJunk() ? 1 : 0;</span>
<a href="#l41.540"></a><span id="l41.540"> }</span>
<a href="#l41.541"></a><span id="l41.541"> </span>
<a href="#l41.542"></a><span id="l41.542" class="difflineminus">-function UpdateReplyButtons()</span>
<a href="#l41.543"></a><span id="l41.543" class="difflineplus">+/**</span>
<a href="#l41.544"></a><span id="l41.544" class="difflineplus">+ * Should the reply command/button be enabled?</span>
<a href="#l41.545"></a><span id="l41.545" class="difflineplus">+ *</span>
<a href="#l41.546"></a><span id="l41.546" class="difflineplus">+ * @return whether the reply command/button should be enabled.</span>
<a href="#l41.547"></a><span id="l41.547" class="difflineplus">+ */</span>
<a href="#l41.548"></a><span id="l41.548" class="difflineplus">+function IsReplyEnabled()</span>
<a href="#l41.549"></a><span id="l41.549"> {</span>
<a href="#l41.550"></a><span id="l41.550" class="difflineminus">-  let msgHdr = messenger.msgHdrFromURI(GetLoadedMessage());</span>
<a href="#l41.551"></a><span id="l41.551" class="difflineplus">+  // If we're in an rss item, we never want to Reply, because there's</span>
<a href="#l41.552"></a><span id="l41.552" class="difflineplus">+  // usually no-one useful to reply to.</span>
<a href="#l41.553"></a><span id="l41.553" class="difflineplus">+  return !gFolderDisplay.selectedMessageIsFeed;</span>
<a href="#l41.554"></a><span id="l41.554" class="difflineplus">+}</span>
<a href="#l41.555"></a><span id="l41.555" class="difflineplus">+</span>
<a href="#l41.556"></a><span id="l41.556" class="difflineplus">+/**</span>
<a href="#l41.557"></a><span id="l41.557" class="difflineplus">+ * Should the reply-all command/button be enabled?</span>
<a href="#l41.558"></a><span id="l41.558" class="difflineplus">+ *</span>
<a href="#l41.559"></a><span id="l41.559" class="difflineplus">+ * @return whether the reply-all command/button should be enabled.</span>
<a href="#l41.560"></a><span id="l41.560" class="difflineplus">+ */</span>
<a href="#l41.561"></a><span id="l41.561" class="difflineplus">+function IsReplyAllEnabled()</span>
<a href="#l41.562"></a><span id="l41.562" class="difflineplus">+{</span>
<a href="#l41.563"></a><span id="l41.563" class="difflineplus">+  if (gFolderDisplay.selectedMessageIsNews)</span>
<a href="#l41.564"></a><span id="l41.564" class="difflineplus">+    // If we're in a news item, we always want ReplyAll, because we can</span>
<a href="#l41.565"></a><span id="l41.565" class="difflineplus">+    // reply to the sender and the newsgroup.</span>
<a href="#l41.566"></a><span id="l41.566" class="difflineplus">+    return true;</span>
<a href="#l41.567"></a><span id="l41.567" class="difflineplus">+  if (gFolderDisplay.selectedMessageIsFeed)</span>
<a href="#l41.568"></a><span id="l41.568" class="difflineplus">+    // If we're in an rss item, we never want to ReplyAll, because there's</span>
<a href="#l41.569"></a><span id="l41.569" class="difflineplus">+    // usually no-one useful to reply to.</span>
<a href="#l41.570"></a><span id="l41.570" class="difflineplus">+    return false;</span>
<a href="#l41.571"></a><span id="l41.571" class="difflineplus">+</span>
<a href="#l41.572"></a><span id="l41.572" class="difflineplus">+  let msgHdr = gFolderDisplay.selectedMessage;</span>
<a href="#l41.573"></a><span id="l41.573"> </span>
<a href="#l41.574"></a><span id="l41.574">   let myEmail = getIdentityForHeader(msgHdr).email;</span>
<a href="#l41.575"></a><span id="l41.575" class="difflineminus">-  let recipients = msgHdr.recipients + &quot;,&quot; + msgHdr.ccList;</span>
<a href="#l41.576"></a><span id="l41.576" class="difflineminus">-</span>
<a href="#l41.577"></a><span id="l41.577" class="difflineminus">-  // If my email address isn't in the to or cc list, then I've been bcc-ed.</span>
<a href="#l41.578"></a><span id="l41.578" class="difflineminus">-  let imBcced = recipients.indexOf(myEmail) == -1;</span>
<a href="#l41.579"></a><span id="l41.579" class="difflineminus">-</span>
<a href="#l41.580"></a><span id="l41.580" class="difflineminus">-  // Now, let's get the number of unique recipients</span>
<a href="#l41.581"></a><span id="l41.581" class="difflineplus">+  let addresses = msgHdr.author + &quot;,&quot; + msgHdr.recipients + &quot;,&quot; + msgHdr.ccList;</span>
<a href="#l41.582"></a><span id="l41.582" class="difflineplus">+</span>
<a href="#l41.583"></a><span id="l41.583" class="difflineplus">+  // If we've got any BCCed addresses (because we sent the message), add</span>
<a href="#l41.584"></a><span id="l41.584" class="difflineplus">+  // them as well.</span>
<a href="#l41.585"></a><span id="l41.585" class="difflineplus">+  if (&quot;bcc&quot; in currentHeaderData)</span>
<a href="#l41.586"></a><span id="l41.586" class="difflineplus">+    addresses += currentHeaderData.bcc.headerValue;</span>
<a href="#l41.587"></a><span id="l41.587" class="difflineplus">+</span>
<a href="#l41.588"></a><span id="l41.588" class="difflineplus">+  // Check to see if my email address is in the list of addresses.</span>
<a href="#l41.589"></a><span id="l41.589" class="difflineplus">+  let imInAddresses = addresses.indexOf(myEmail) != -1;</span>
<a href="#l41.590"></a><span id="l41.590" class="difflineplus">+</span>
<a href="#l41.591"></a><span id="l41.591" class="difflineplus">+  // Now, let's get the number of unique addresses.</span>
<a href="#l41.592"></a><span id="l41.592">   let hdrParser = Components.classes[&quot;@mozilla.org/messenger/headerparser;1&quot;]</span>
<a href="#l41.593"></a><span id="l41.593">                             .getService(Components.interfaces.nsIMsgHeaderParser);</span>
<a href="#l41.594"></a><span id="l41.594" class="difflineminus">-  let uniqueRecipients = hdrParser.removeDuplicateAddresses(recipients, {});</span>
<a href="#l41.595"></a><span id="l41.595" class="difflineminus">-  let numAddresses = hdrParser.parseHeadersWithArray(uniqueRecipients, {}, {}, {});</span>
<a href="#l41.596"></a><span id="l41.596" class="difflineminus">-</span>
<a href="#l41.597"></a><span id="l41.597" class="difflineminus">-  // If I've been bcc-ed, then add 1 to the number of addresses to compensate.</span>
<a href="#l41.598"></a><span id="l41.598" class="difflineminus">-  if (imBcced)</span>
<a href="#l41.599"></a><span id="l41.599" class="difflineminus">-    numAddresses++</span>
<a href="#l41.600"></a><span id="l41.600" class="difflineminus">-</span>
<a href="#l41.601"></a><span id="l41.601" class="difflineminus">-  // By default, ReplyAll if there is more than 1 person to reply to.</span>
<a href="#l41.602"></a><span id="l41.602" class="difflineminus">-  let showReplyAll = numAddresses &gt; 1;</span>
<a href="#l41.603"></a><span id="l41.603" class="difflineminus">-</span>
<a href="#l41.604"></a><span id="l41.604" class="difflineminus">-  // And ReplyToList if there is a List-Post header.</span>
<a href="#l41.605"></a><span id="l41.605" class="difflineminus">-  let showReplyList = currentHeaderData[&quot;list-post&quot;];</span>
<a href="#l41.606"></a><span id="l41.606" class="difflineminus">-</span>
<a href="#l41.607"></a><span id="l41.607" class="difflineminus">-  // Get the server type.</span>
<a href="#l41.608"></a><span id="l41.608" class="difflineminus">-  let serverType = null;</span>
<a href="#l41.609"></a><span id="l41.609" class="difflineminus">-  try</span>
<a href="#l41.610"></a><span id="l41.610" class="difflineplus">+  let uniqueAddresses = hdrParser.removeDuplicateAddresses(addresses, &quot;&quot;);</span>
<a href="#l41.611"></a><span id="l41.611" class="difflineplus">+  let emailAddresses = {};</span>
<a href="#l41.612"></a><span id="l41.612" class="difflineplus">+  let numAddresses = hdrParser.parseHeadersWithArray(uniqueAddresses,</span>
<a href="#l41.613"></a><span id="l41.613" class="difflineplus">+                                                     emailAddresses, {}, {});</span>
<a href="#l41.614"></a><span id="l41.614" class="difflineplus">+</span>
<a href="#l41.615"></a><span id="l41.615" class="difflineplus">+  // XXX: This should be handled by the nsIMsgHeaderParser.  See Bug 498480.</span>
<a href="#l41.616"></a><span id="l41.616" class="difflineplus">+  // Remove addresses that look like email groups, because we don't support</span>
<a href="#l41.617"></a><span id="l41.617" class="difflineplus">+  // those yet.  (Any address with a : in it will be an empty email group,</span>
<a href="#l41.618"></a><span id="l41.618" class="difflineplus">+  // or the colon and the groupname would be set as the first name, and not</span>
<a href="#l41.619"></a><span id="l41.619" class="difflineplus">+  // show up in the address at all.)</span>
<a href="#l41.620"></a><span id="l41.620" class="difflineplus">+  for (var i in emailAddresses.value)</span>
<a href="#l41.621"></a><span id="l41.621">   {</span>
<a href="#l41.622"></a><span id="l41.622" class="difflineminus">-    serverType = msgHdr.folder.server.type;</span>
<a href="#l41.623"></a><span id="l41.623" class="difflineplus">+    if (/:/.test(emailAddresses.value[i]))</span>
<a href="#l41.624"></a><span id="l41.624" class="difflineplus">+      numAddresses--;</span>
<a href="#l41.625"></a><span id="l41.625">   }</span>
<a href="#l41.626"></a><span id="l41.626" class="difflineminus">-  catch (ex)</span>
<a href="#l41.627"></a><span id="l41.627" class="difflineminus">-  {</span>
<a href="#l41.628"></a><span id="l41.628" class="difflineminus">-    // This empty catch block needs to be here because msgHdr.folder will</span>
<a href="#l41.629"></a><span id="l41.629" class="difflineminus">-    // throw an exception when you try to access it on a .eml file.</span>
<a href="#l41.630"></a><span id="l41.630" class="difflineminus">-  }</span>
<a href="#l41.631"></a><span id="l41.631" class="difflineminus">-</span>
<a href="#l41.632"></a><span id="l41.632" class="difflineminus">-  // But, if we're in a news item, we should default to Reply.</span>
<a href="#l41.633"></a><span id="l41.633" class="difflineminus">-  if (serverType == &quot;nntp&quot;)</span>
<a href="#l41.634"></a><span id="l41.634" class="difflineplus">+</span>
<a href="#l41.635"></a><span id="l41.635" class="difflineplus">+  // I don't want to count my address in the number of addresses to reply</span>
<a href="#l41.636"></a><span id="l41.636" class="difflineplus">+  // to, since I won't be emailing myself.</span>
<a href="#l41.637"></a><span id="l41.637" class="difflineplus">+  if (imInAddresses)</span>
<a href="#l41.638"></a><span id="l41.638" class="difflineplus">+    numAddresses--;</span>
<a href="#l41.639"></a><span id="l41.639" class="difflineplus">+</span>
<a href="#l41.640"></a><span id="l41.640" class="difflineplus">+  // ReplyAll is enabled if there is more than 1 person to reply to.</span>
<a href="#l41.641"></a><span id="l41.641" class="difflineplus">+  return numAddresses &gt; 1;</span>
<a href="#l41.642"></a><span id="l41.642" class="difflineplus">+}</span>
<a href="#l41.643"></a><span id="l41.643" class="difflineplus">+</span>
<a href="#l41.644"></a><span id="l41.644" class="difflineplus">+/**</span>
<a href="#l41.645"></a><span id="l41.645" class="difflineplus">+ * Should the reply-list command/button be enabled?</span>
<a href="#l41.646"></a><span id="l41.646" class="difflineplus">+ *</span>
<a href="#l41.647"></a><span id="l41.647" class="difflineplus">+ * @return whether the reply-list command/button should be enabled.</span>
<a href="#l41.648"></a><span id="l41.648" class="difflineplus">+ */</span>
<a href="#l41.649"></a><span id="l41.649" class="difflineplus">+function IsReplyListEnabled()</span>
<a href="#l41.650"></a><span id="l41.650" class="difflineplus">+{</span>
<a href="#l41.651"></a><span id="l41.651" class="difflineplus">+  // ReplyToList is enabled if there is a List-Post header.</span>
<a href="#l41.652"></a><span id="l41.652" class="difflineplus">+  return currentHeaderData[&quot;list-post&quot;] != null;</span>
<a href="#l41.653"></a><span id="l41.653" class="difflineplus">+}</span>
<a href="#l41.654"></a><span id="l41.654" class="difflineplus">+</span>
<a href="#l41.655"></a><span id="l41.655" class="difflineplus">+/**</span>
<a href="#l41.656"></a><span id="l41.656" class="difflineplus">+ * Update the enabled/disabled states of the Reply, Reply-All, and</span>
<a href="#l41.657"></a><span id="l41.657" class="difflineplus">+ * Reply-List buttons.  (After this function runs, one of the buttons</span>
<a href="#l41.658"></a><span id="l41.658" class="difflineplus">+ * should be shown, and the others should be hidden.)</span>
<a href="#l41.659"></a><span id="l41.659" class="difflineplus">+ */</span>
<a href="#l41.660"></a><span id="l41.660" class="difflineplus">+function UpdateReplyButtons()</span>
<a href="#l41.661"></a><span id="l41.661" class="difflineplus">+{</span>
<a href="#l41.662"></a><span id="l41.662" class="difflineplus">+  let showReplyAll = IsReplyAllEnabled();</span>
<a href="#l41.663"></a><span id="l41.663" class="difflineplus">+  let showReplyList = IsReplyListEnabled();</span>
<a href="#l41.664"></a><span id="l41.664" class="difflineplus">+</span>
<a href="#l41.665"></a><span id="l41.665" class="difflineplus">+  // If we're in a news item, we should default to Reply.</span>
<a href="#l41.666"></a><span id="l41.666" class="difflineplus">+  if (gFolderDisplay.selectedMessageIsNews)</span>
<a href="#l41.667"></a><span id="l41.667">   {</span>
<a href="#l41.668"></a><span id="l41.668">     showReplyAll = false;</span>
<a href="#l41.669"></a><span id="l41.669">     showReplyList = false;</span>
<a href="#l41.670"></a><span id="l41.670">   }</span>
<a href="#l41.671"></a><span id="l41.671"> </span>
<a href="#l41.672"></a><span id="l41.672">   let buttonToShow = &quot;reply&quot;;</span>
<a href="#l41.673"></a><span id="l41.673">   if (showReplyList)</span>
<a href="#l41.674"></a><span id="l41.674">     buttonToShow = &quot;replyList&quot;;</span>
<a href="#l41.675"></a><span id="l41.675">   else if (showReplyAll)</span>
<a href="#l41.676"></a><span id="l41.676">     buttonToShow = &quot;replyAll&quot;;</span>
<a href="#l41.677"></a><span id="l41.677"> </span>
<a href="#l41.678"></a><span id="l41.678" class="difflineminus">-  let buttonBox = document.getElementById(gCollapsedHeaderViewMode ?</span>
<a href="#l41.679"></a><span id="l41.679" class="difflineminus">-    &quot;collapsedButtonBox&quot; : &quot;expandedButtonBox&quot;);</span>
<a href="#l41.680"></a><span id="l41.680" class="difflineplus">+  let buttonBox = getCurrentMsgHdrButtonBox();</span>
<a href="#l41.681"></a><span id="l41.681"> </span>
<a href="#l41.682"></a><span id="l41.682">   let replyButton = buttonBox.getButton(&quot;hdrReplyButton&quot;);</span>
<a href="#l41.683"></a><span id="l41.683">   let replyAllButton = buttonBox.getButton(&quot;hdrReplyAllButton&quot;);</span>
<a href="#l41.684"></a><span id="l41.684">   let replyAllSubButton = buttonBox.getButton(&quot;hdrReplyAllSubButton&quot;);</span>
<a href="#l41.685"></a><span id="l41.685">   let replyAllSubButtonSep = buttonBox.getButton(&quot;hdrReplyAllSubButtonSep&quot;);</span>
<a href="#l41.686"></a><span id="l41.686">   let replyListButton = buttonBox.getButton(&quot;hdrReplyListButton&quot;);</span>
<a href="#l41.687"></a><span id="l41.687"> </span>
<a href="#l41.688"></a><span id="l41.688">   replyButton.hidden = (buttonToShow != &quot;reply&quot;);</span>
<a href="#l41.689"></a><span id="l41.689">   replyAllButton.hidden = (buttonToShow != &quot;replyAll&quot;);</span>
<a href="#l41.690"></a><span id="l41.690">   replyListButton.hidden = (buttonToShow != &quot;replyList&quot;);</span>
<a href="#l41.691"></a><span id="l41.691"> </span>
<a href="#l41.692"></a><span id="l41.692" class="difflineminus">-  let replyListMenu = document.getElementById(&quot;menu_replyToList&quot;);</span>
<a href="#l41.693"></a><span id="l41.693" class="difflineminus">-  replyListMenu.hidden = !showReplyList;</span>
<a href="#l41.694"></a><span id="l41.694" class="difflineminus">-</span>
<a href="#l41.695"></a><span id="l41.695" class="difflineminus">-  let replyListCommand = document.getElementById(&quot;cmd_replylist&quot;);</span>
<a href="#l41.696"></a><span id="l41.696" class="difflineminus">-  replyListCommand.disabled = !showReplyList;</span>
<a href="#l41.697"></a><span id="l41.697" class="difflineminus">-</span>
<a href="#l41.698"></a><span id="l41.698" class="difflineminus">-  if (serverType == &quot;nntp&quot;)</span>
<a href="#l41.699"></a><span id="l41.699" class="difflineplus">+  if (gFolderDisplay.selectedMessageIsNews)</span>
<a href="#l41.700"></a><span id="l41.700">   {</span>
<a href="#l41.701"></a><span id="l41.701">     // If it's a news item, show the ReplyAll sub-button and separator.</span>
<a href="#l41.702"></a><span id="l41.702">     replyAllSubButton.hidden = false;</span>
<a href="#l41.703"></a><span id="l41.703">     replyAllSubButtonSep.hidden = false;</span>
<a href="#l41.704"></a><span id="l41.704">   }</span>
<a href="#l41.705"></a><span id="l41.705" class="difflineminus">-  else if (serverType == &quot;rss&quot;)</span>
<a href="#l41.706"></a><span id="l41.706" class="difflineplus">+  else if (gFolderDisplay.selectedMessageIsFeed)</span>
<a href="#l41.707"></a><span id="l41.707">   {</span>
<a href="#l41.708"></a><span id="l41.708">     // otherwise, if it's an rss item, hide all the Reply buttons.</span>
<a href="#l41.709"></a><span id="l41.709">     replyButton.hidden = true;</span>
<a href="#l41.710"></a><span id="l41.710">     replyAllButton.hidden = true;</span>
<a href="#l41.711"></a><span id="l41.711">     replyListButton.hidden = true;</span>
<a href="#l41.712"></a><span id="l41.712">     replyAllSubButton.hidden = true;</span>
<a href="#l41.713"></a><span id="l41.713">     replyAllSubButtonSep.hidden = true;</span>
<a href="#l41.714"></a><span id="l41.714">   }</span>
<a href="#l41.715"></a><span id="l41.715">   else</span>
<a href="#l41.716"></a><span id="l41.716">   {</span>
<a href="#l41.717"></a><span id="l41.717">     // otherwise, hide the ReplyAll sub-buttons.</span>
<a href="#l41.718"></a><span id="l41.718">     replyAllSubButton.hidden = true;</span>
<a href="#l41.719"></a><span id="l41.719">     replyAllSubButtonSep.hidden = true;</span>
<a href="#l41.720"></a><span id="l41.720">   }</span>
<a href="#l41.721"></a><span id="l41.721" class="difflineplus">+</span>
<a href="#l41.722"></a><span id="l41.722" class="difflineplus">+  goUpdateCommand(&quot;button_reply&quot;);</span>
<a href="#l41.723"></a><span id="l41.723" class="difflineplus">+  goUpdateCommand(&quot;button_replyall&quot;);</span>
<a href="#l41.724"></a><span id="l41.724" class="difflineplus">+  goUpdateCommand(&quot;button_replylist&quot;);</span>
<a href="#l41.725"></a><span id="l41.725"> }</span>
<a href="#l41.726"></a><span id="l41.726"> </span>
<a href="#l41.727"></a><span id="l41.727"> function UpdateDeleteToolbarButton()</span>
<a href="#l41.728"></a><span id="l41.728"> {</span>
<a href="#l41.729"></a><span id="l41.729">   var deleteButtonDeck = document.getElementById(&quot;delete-deck&quot;);</span>
<a href="#l41.730"></a><span id="l41.730">   if (!deleteButtonDeck)</span>
<a href="#l41.731"></a><span id="l41.731">     return;</span>
<a href="#l41.732"></a><span id="l41.732"> </span>
<a href="#l41.733"></a><span id="l41.733" class="difflineat">@@ -913,57 +961,57 @@ function UpdateDeleteToolbarButton()</span>
<a href="#l41.734"></a><span id="l41.734">       GetNumSelectedMessages() == 0)</span>
<a href="#l41.735"></a><span id="l41.735">     deleteButtonDeck.selectedIndex = 0;</span>
<a href="#l41.736"></a><span id="l41.736">   else</span>
<a href="#l41.737"></a><span id="l41.737">     deleteButtonDeck.selectedIndex = SelectedMessagesAreDeleted() ? 1 : 0;</span>
<a href="#l41.738"></a><span id="l41.738"> }</span>
<a href="#l41.739"></a><span id="l41.739"> function UpdateDeleteCommand()</span>
<a href="#l41.740"></a><span id="l41.740"> {</span>
<a href="#l41.741"></a><span id="l41.741">   var value = &quot;value&quot;;</span>
<a href="#l41.742"></a><span id="l41.742" class="difflineminus">-  var uri = GetFirstSelectedMessage();</span>
<a href="#l41.743"></a><span id="l41.743" class="difflineminus">-  if (IsNewsMessage(uri))</span>
<a href="#l41.744"></a><span id="l41.744" class="difflineplus">+  if (gFolderDisplay.selectedMessageIsNews)</span>
<a href="#l41.745"></a><span id="l41.745">     value += &quot;News&quot;;</span>
<a href="#l41.746"></a><span id="l41.746">   else if (SelectedMessagesAreDeleted())</span>
<a href="#l41.747"></a><span id="l41.747">     value += &quot;IMAPDeleted&quot;;</span>
<a href="#l41.748"></a><span id="l41.748">   if (GetNumSelectedMessages() &lt; 2)</span>
<a href="#l41.749"></a><span id="l41.749">     value += &quot;Message&quot;;</span>
<a href="#l41.750"></a><span id="l41.750">   else</span>
<a href="#l41.751"></a><span id="l41.751">     value += &quot;Messages&quot;;</span>
<a href="#l41.752"></a><span id="l41.752">   goSetMenuValue(&quot;cmd_delete&quot;, value);</span>
<a href="#l41.753"></a><span id="l41.753">   goSetAccessKey(&quot;cmd_delete&quot;, value + &quot;AccessKey&quot;);</span>
<a href="#l41.754"></a><span id="l41.754"> }</span>
<a href="#l41.755"></a><span id="l41.755"> </span>
<a href="#l41.756"></a><span id="l41.756"> function SelectedMessagesAreDeleted()</span>
<a href="#l41.757"></a><span id="l41.757"> {</span>
<a href="#l41.758"></a><span id="l41.758" class="difflineminus">-  return gDBView &amp;&amp; gDBView.numSelected &amp;&amp;</span>
<a href="#l41.759"></a><span id="l41.759" class="difflineminus">-         (gDBView.hdrForFirstSelectedMessage.flags &amp;</span>
<a href="#l41.760"></a><span id="l41.760" class="difflineplus">+  let firstSelectedMessage = gFolderDisplay.selectedMessage;</span>
<a href="#l41.761"></a><span id="l41.761" class="difflineplus">+  return firstSelectedMessage &amp;&amp;</span>
<a href="#l41.762"></a><span id="l41.762" class="difflineplus">+         (firstSelectedMessage.flags &amp;</span>
<a href="#l41.763"></a><span id="l41.763">           Components.interfaces.nsMsgMessageFlags.IMAPDeleted);</span>
<a href="#l41.764"></a><span id="l41.764"> }</span>
<a href="#l41.765"></a><span id="l41.765"> </span>
<a href="#l41.766"></a><span id="l41.766"> function SelectedMessagesAreJunk()</span>
<a href="#l41.767"></a><span id="l41.767"> {</span>
<a href="#l41.768"></a><span id="l41.768">   try {</span>
<a href="#l41.769"></a><span id="l41.769" class="difflineminus">-    var junkScore = gDBView.hdrForFirstSelectedMessage.getStringProperty(&quot;junkscore&quot;);</span>
<a href="#l41.770"></a><span id="l41.770" class="difflineplus">+    var junkScore = gFolderDisplay.selectedMessage.getStringProperty(&quot;junkscore&quot;);</span>
<a href="#l41.771"></a><span id="l41.771">     return (junkScore != &quot;&quot;) &amp;&amp; (junkScore != &quot;0&quot;);</span>
<a href="#l41.772"></a><span id="l41.772">   }</span>
<a href="#l41.773"></a><span id="l41.773">   catch (ex) {</span>
<a href="#l41.774"></a><span id="l41.774">     return false;</span>
<a href="#l41.775"></a><span id="l41.775">   }</span>
<a href="#l41.776"></a><span id="l41.776"> }</span>
<a href="#l41.777"></a><span id="l41.777"> </span>
<a href="#l41.778"></a><span id="l41.778"> function SelectedMessagesAreRead()</span>
<a href="#l41.779"></a><span id="l41.779"> {</span>
<a href="#l41.780"></a><span id="l41.780" class="difflineminus">-  return gDBView &amp;&amp; gDBView.numSelected &amp;&amp;</span>
<a href="#l41.781"></a><span id="l41.781" class="difflineminus">-         gDBView.hdrForFirstSelectedMessage.isRead;</span>
<a href="#l41.782"></a><span id="l41.782" class="difflineplus">+  let firstSelectedMessage = gFolderDisplay.selectedMessage;</span>
<a href="#l41.783"></a><span id="l41.783" class="difflineplus">+  return firstSelectedMessage &amp;&amp; firstSelectedMessage.isRead;</span>
<a href="#l41.784"></a><span id="l41.784"> }</span>
<a href="#l41.785"></a><span id="l41.785"> </span>
<a href="#l41.786"></a><span id="l41.786"> function SelectedMessagesAreFlagged()</span>
<a href="#l41.787"></a><span id="l41.787"> {</span>
<a href="#l41.788"></a><span id="l41.788" class="difflineminus">-  return gDBView &amp;&amp; gDBView.numSelected &amp;&amp;</span>
<a href="#l41.789"></a><span id="l41.789" class="difflineminus">-         gDBView.hdrForFirstSelectedMessage.isFlagged;</span>
<a href="#l41.790"></a><span id="l41.790" class="difflineplus">+  let firstSelectedMessage = gFolderDisplay.selectedMessage;</span>
<a href="#l41.791"></a><span id="l41.791" class="difflineplus">+  return firstSelectedMessage &amp;&amp; firstSelectedMessage.isFlagged;</span>
<a href="#l41.792"></a><span id="l41.792"> }</span>
<a href="#l41.793"></a><span id="l41.793"> </span>
<a href="#l41.794"></a><span id="l41.794"> function GetFirstSelectedMsgFolder()</span>
<a href="#l41.795"></a><span id="l41.795"> {</span>
<a href="#l41.796"></a><span id="l41.796">   var selectedFolders = GetSelectedMsgFolders();</span>
<a href="#l41.797"></a><span id="l41.797">   return (selectedFolders.length &gt; 0) ? selectedFolders[0] : null;</span>
<a href="#l41.798"></a><span id="l41.798"> }</span>
<a href="#l41.799"></a><span id="l41.799"> </span>
<a href="#l41.800"></a><span id="l41.800" class="difflineat">@@ -1092,20 +1140,20 @@ function MsgGetNextNMessages()</span>
<a href="#l41.801"></a><span id="l41.801">   if (MailOfflineMgr.isOnline() || MailOfflineMgr.getNewMail())</span>
<a href="#l41.802"></a><span id="l41.802">     GetNextNMessages(GetFirstSelectedMsgFolder());</span>
<a href="#l41.803"></a><span id="l41.803"> }</span>
<a href="#l41.804"></a><span id="l41.804"> </span>
<a href="#l41.805"></a><span id="l41.805"> function MsgDeleteMessage(reallyDelete, fromToolbar)</span>
<a href="#l41.806"></a><span id="l41.806"> {</span>
<a href="#l41.807"></a><span id="l41.807">   // If from the toolbar, return right away if this is a news message</span>
<a href="#l41.808"></a><span id="l41.808">   // only allow cancel from the menu:  &quot;Edit | Cancel / Delete Message&quot;.</span>
<a href="#l41.809"></a><span id="l41.809" class="difflineminus">-  if (fromToolbar &amp;&amp; isNewsURI(GetLoadedMsgFolder().URI))</span>
<a href="#l41.810"></a><span id="l41.810" class="difflineplus">+  if (fromToolbar &amp;&amp; gFolderDisplay.view.isNewsFolder)</span>
<a href="#l41.811"></a><span id="l41.811">     return;</span>
<a href="#l41.812"></a><span id="l41.812"> </span>
<a href="#l41.813"></a><span id="l41.813" class="difflineminus">-  SetNextMessageAfterDelete();</span>
<a href="#l41.814"></a><span id="l41.814" class="difflineplus">+  gFolderDisplay.hintAboutToDeleteMessages();</span>
<a href="#l41.815"></a><span id="l41.815">   if (reallyDelete)</span>
<a href="#l41.816"></a><span id="l41.816">     gDBView.doCommand(nsMsgViewCommandType.deleteNoTrash);</span>
<a href="#l41.817"></a><span id="l41.817">   else</span>
<a href="#l41.818"></a><span id="l41.818">     gDBView.doCommand(nsMsgViewCommandType.deleteMsg);</span>
<a href="#l41.819"></a><span id="l41.819"> }</span>
<a href="#l41.820"></a><span id="l41.820"> </span>
<a href="#l41.821"></a><span id="l41.821"> /**</span>
<a href="#l41.822"></a><span id="l41.822">  * Copies the selected messages to the destination folder</span>
<a href="#l41.823"></a><span id="l41.823" class="difflineat">@@ -1124,17 +1172,17 @@ function MsgCopyMessage(aDestFolder)</span>
<a href="#l41.824"></a><span id="l41.824">  */</span>
<a href="#l41.825"></a><span id="l41.825"> function MsgMoveMessage(aDestFolder)</span>
<a href="#l41.826"></a><span id="l41.826"> {</span>
<a href="#l41.827"></a><span id="l41.827">   // We don't move news messages, we copy them.</span>
<a href="#l41.828"></a><span id="l41.828">   if (isNewsURI(gDBView.msgFolder.URI))</span>
<a href="#l41.829"></a><span id="l41.829">     gDBView.doCommandWithFolder(nsMsgViewCommandType.copyMessages, aDestFolder);</span>
<a href="#l41.830"></a><span id="l41.830">   else</span>
<a href="#l41.831"></a><span id="l41.831">   {</span>
<a href="#l41.832"></a><span id="l41.832" class="difflineminus">-    SetNextMessageAfterDelete();</span>
<a href="#l41.833"></a><span id="l41.833" class="difflineplus">+    gFolderDisplay.hintAboutToDeleteMessages();</span>
<a href="#l41.834"></a><span id="l41.834">     gDBView.doCommandWithFolder(nsMsgViewCommandType.moveMessages, aDestFolder);</span>
<a href="#l41.835"></a><span id="l41.835">   }</span>
<a href="#l41.836"></a><span id="l41.836">   pref.setCharPref(&quot;mail.last_msg_movecopy_target_uri&quot;, aDestFolder.URI);</span>
<a href="#l41.837"></a><span id="l41.837">   pref.setBoolPref(&quot;mail.last_msg_movecopy_was_move&quot;, true);</span>
<a href="#l41.838"></a><span id="l41.838"> }</span>
<a href="#l41.839"></a><span id="l41.839"> </span>
<a href="#l41.840"></a><span id="l41.840"> /**</span>
<a href="#l41.841"></a><span id="l41.841">  * Calls the ComposeMessage function with the desired type, and proper default</span>
<a href="#l41.842"></a><span id="l41.842" class="difflineat">@@ -1142,32 +1190,34 @@ function MsgMoveMessage(aDestFolder)</span>
<a href="#l41.843"></a><span id="l41.843">  *</span>
<a href="#l41.844"></a><span id="l41.844">  * @param aCompType  the nsIMsgCompType to pass to the function</span>
<a href="#l41.845"></a><span id="l41.845">  * @param aEvent (optional) the event that triggered the call</span>
<a href="#l41.846"></a><span id="l41.846">  */</span>
<a href="#l41.847"></a><span id="l41.847"> function composeMsgByType(aCompType, aEvent) {</span>
<a href="#l41.848"></a><span id="l41.848">   if (aEvent &amp;&amp; aEvent.shiftKey) {</span>
<a href="#l41.849"></a><span id="l41.849">     ComposeMessage(aCompType,</span>
<a href="#l41.850"></a><span id="l41.850">                    Components.interfaces.nsIMsgCompFormat.OppositeOfDefault,</span>
<a href="#l41.851"></a><span id="l41.851" class="difflineminus">-                   GetFirstSelectedMsgFolder(), GetSelectedMessages());</span>
<a href="#l41.852"></a><span id="l41.852" class="difflineplus">+                   GetFirstSelectedMsgFolder(),</span>
<a href="#l41.853"></a><span id="l41.853" class="difflineplus">+                   gFolderDisplay.selectedMessageUris);</span>
<a href="#l41.854"></a><span id="l41.854">   }</span>
<a href="#l41.855"></a><span id="l41.855">   else {</span>
<a href="#l41.856"></a><span id="l41.856">     ComposeMessage(aCompType, Components.interfaces.nsIMsgCompFormat.Default,</span>
<a href="#l41.857"></a><span id="l41.857" class="difflineminus">-                   GetFirstSelectedMsgFolder(), GetSelectedMessages());</span>
<a href="#l41.858"></a><span id="l41.858" class="difflineplus">+                   GetFirstSelectedMsgFolder(),</span>
<a href="#l41.859"></a><span id="l41.859" class="difflineplus">+                   gFolderDisplay.selectedMessageUris);</span>
<a href="#l41.860"></a><span id="l41.860">   }</span>
<a href="#l41.861"></a><span id="l41.861"> }</span>
<a href="#l41.862"></a><span id="l41.862"> </span>
<a href="#l41.863"></a><span id="l41.863"> function MsgNewMessage(event)</span>
<a href="#l41.864"></a><span id="l41.864"> {</span>
<a href="#l41.865"></a><span id="l41.865">   composeMsgByType(Components.interfaces.nsIMsgCompType.New, event);</span>
<a href="#l41.866"></a><span id="l41.866"> }</span>
<a href="#l41.867"></a><span id="l41.867"> </span>
<a href="#l41.868"></a><span id="l41.868"> function MsgReplyMessage(event)</span>
<a href="#l41.869"></a><span id="l41.869"> {</span>
<a href="#l41.870"></a><span id="l41.870" class="difflineminus">-  var loadedFolder = GetLoadedMsgFolder();</span>
<a href="#l41.871"></a><span id="l41.871" class="difflineplus">+  var loadedFolder = gFolderDisplay.displayedFolder;</span>
<a href="#l41.872"></a><span id="l41.872">   if (loadedFolder)</span>
<a href="#l41.873"></a><span id="l41.873">   {</span>
<a href="#l41.874"></a><span id="l41.874">     var server = loadedFolder.server;</span>
<a href="#l41.875"></a><span id="l41.875">     if(server &amp;&amp; server.type == &quot;nntp&quot;)</span>
<a href="#l41.876"></a><span id="l41.876">     {</span>
<a href="#l41.877"></a><span id="l41.877">       MsgReplyGroup(event);</span>
<a href="#l41.878"></a><span id="l41.878">       return;</span>
<a href="#l41.879"></a><span id="l41.879">     }</span>
<a href="#l41.880"></a><span id="l41.880" class="difflineat">@@ -1202,50 +1252,47 @@ function BatchMessageMover()</span>
<a href="#l41.881"></a><span id="l41.881">   this._batches = {};</span>
<a href="#l41.882"></a><span id="l41.882">   this._currentKey = null;</span>
<a href="#l41.883"></a><span id="l41.883"> }</span>
<a href="#l41.884"></a><span id="l41.884"> </span>
<a href="#l41.885"></a><span id="l41.885"> BatchMessageMover.prototype = {</span>
<a href="#l41.886"></a><span id="l41.886"> </span>
<a href="#l41.887"></a><span id="l41.887">   archiveSelectedMessages: function()</span>
<a href="#l41.888"></a><span id="l41.888">   {</span>
<a href="#l41.889"></a><span id="l41.889" class="difflineminus">-    // subtle:</span>
<a href="#l41.890"></a><span id="l41.890" class="difflineminus">-    SetNextMessageAfterDelete(); // we're just pretending</span>
<a href="#l41.891"></a><span id="l41.891" class="difflineminus">-    this.messageToSelectAfterWereDone = gNextMessageViewIndexAfterDelete;</span>
<a href="#l41.892"></a><span id="l41.892" class="difflineminus">-    gNextMessageViewIndexAfterDelete = -2;</span>
<a href="#l41.893"></a><span id="l41.893" class="difflineminus">-</span>
<a href="#l41.894"></a><span id="l41.894" class="difflineminus">-    let selectedMsgUris = GetSelectedMessages();</span>
<a href="#l41.895"></a><span id="l41.895" class="difflineminus">-    if (!selectedMsgUris.length)</span>
<a href="#l41.896"></a><span id="l41.896" class="difflineplus">+    gFolderDisplay.hintMassMoveStarting();</span>
<a href="#l41.897"></a><span id="l41.897" class="difflineplus">+</span>
<a href="#l41.898"></a><span id="l41.898" class="difflineplus">+    let selectedMessages = gFolderDisplay.selectedMessages;</span>
<a href="#l41.899"></a><span id="l41.899" class="difflineplus">+    if (!selectedMessages.length)</span>
<a href="#l41.900"></a><span id="l41.900">       return;</span>
<a href="#l41.901"></a><span id="l41.901" class="difflineminus">-    </span>
<a href="#l41.902"></a><span id="l41.902" class="difflineplus">+</span>
<a href="#l41.903"></a><span id="l41.903">     let messages = Components.classes[&quot;@mozilla.org/array;1&quot;]</span>
<a href="#l41.904"></a><span id="l41.904">                              .createInstance(Components.interfaces.nsIMutableArray);</span>
<a href="#l41.905"></a><span id="l41.905" class="difflineminus">-    </span>
<a href="#l41.906"></a><span id="l41.906" class="difflineminus">-    for (let i = 0; i &lt; selectedMsgUris.length; ++i)</span>
<a href="#l41.907"></a><span id="l41.907" class="difflineplus">+</span>
<a href="#l41.908"></a><span id="l41.908" class="difflineplus">+    for (let i = 0; i &lt; selectedMessages.length; ++i)</span>
<a href="#l41.909"></a><span id="l41.909">     {</span>
<a href="#l41.910"></a><span id="l41.910" class="difflineminus">-      let msgHdr = messenger.msgHdrFromURI(selectedMsgUris[i]);</span>
<a href="#l41.911"></a><span id="l41.911" class="difflineminus">-  </span>
<a href="#l41.912"></a><span id="l41.912" class="difflineplus">+      let msgHdr = selectedMessages[i];</span>
<a href="#l41.913"></a><span id="l41.913" class="difflineplus">+</span>
<a href="#l41.914"></a><span id="l41.914">       let rootFolder = msgHdr.folder.server.rootFolder;</span>
<a href="#l41.915"></a><span id="l41.915" class="difflineminus">-  </span>
<a href="#l41.916"></a><span id="l41.916" class="difflineplus">+</span>
<a href="#l41.917"></a><span id="l41.917">       let msgDate = new Date(msgHdr.date / 1000);  // convert date to JS date object</span>
<a href="#l41.918"></a><span id="l41.918">       let msgYear = msgDate.getFullYear().toString();</span>
<a href="#l41.919"></a><span id="l41.919">       let monthFolderName = msgDate.toLocaleFormat(&quot;%Y-%m&quot;)</span>
<a href="#l41.920"></a><span id="l41.920">       let dstFolderName = monthFolderName;</span>
<a href="#l41.921"></a><span id="l41.921"> </span>
<a href="#l41.922"></a><span id="l41.922">       let copyBatchKey = msgHdr.folder.URI + '\000' + dstFolderName;</span>
<a href="#l41.923"></a><span id="l41.923">       if (! (copyBatchKey in this._batches)) {</span>
<a href="#l41.924"></a><span id="l41.924">         this._batches[copyBatchKey] = [msgHdr.folder, msgYear, dstFolderName];</span>
<a href="#l41.925"></a><span id="l41.925">       }</span>
<a href="#l41.926"></a><span id="l41.926">       this._batches[copyBatchKey].push(msgHdr);</span>
<a href="#l41.927"></a><span id="l41.927">     }</span>
<a href="#l41.928"></a><span id="l41.928">     // Now we launch the code that will iterate over all of the message copies</span>
<a href="#l41.929"></a><span id="l41.929">     // one in turn</span>
<a href="#l41.930"></a><span id="l41.930">     this.processNextBatch();</span>
<a href="#l41.931"></a><span id="l41.931">   },</span>
<a href="#l41.932"></a><span id="l41.932" class="difflineminus">-  </span>
<a href="#l41.933"></a><span id="l41.933" class="difflineplus">+</span>
<a href="#l41.934"></a><span id="l41.934">   processNextBatch: function()</span>
<a href="#l41.935"></a><span id="l41.935">   {</span>
<a href="#l41.936"></a><span id="l41.936">     for (let key in this._batches)</span>
<a href="#l41.937"></a><span id="l41.937">     {</span>
<a href="#l41.938"></a><span id="l41.938">       this._currentKey = key;</span>
<a href="#l41.939"></a><span id="l41.939">       let batch = this._batches[key];</span>
<a href="#l41.940"></a><span id="l41.940">       let srcFolder = batch[0];</span>
<a href="#l41.941"></a><span id="l41.941">       let msgYear = batch[1];</span>
<a href="#l41.942"></a><span id="l41.942" class="difflineat">@@ -1256,18 +1303,18 @@ BatchMessageMover.prototype = {</span>
<a href="#l41.943"></a><span id="l41.943">       // rss servers don't have an identity so we special case the archives URI</span>
<a href="#l41.944"></a><span id="l41.944">       let archiveFolderUri = (srcFolder.server.type == 'rss')</span>
<a href="#l41.945"></a><span id="l41.945">         ? srcFolder.server.serverURI + &quot;/Archives&quot;</span>
<a href="#l41.946"></a><span id="l41.946">         : getIdentityForHeader(msgs[0], Ci.nsIMsgCompType</span>
<a href="#l41.947"></a><span id="l41.947">                                         .ReplyAll).archiveFolder;</span>
<a href="#l41.948"></a><span id="l41.948"> </span>
<a href="#l41.949"></a><span id="l41.949">       let archiveFolder = GetMsgFolderFromUri(archiveFolderUri, false);</span>
<a href="#l41.950"></a><span id="l41.950">       let granularity = archiveFolder.server.archiveGranularity;</span>
<a href="#l41.951"></a><span id="l41.951" class="difflineminus">-      // for imap folders, we need to create the sub-folders asynchronously, </span>
<a href="#l41.952"></a><span id="l41.952" class="difflineminus">-      // so we chain the urls using the listener called back from </span>
<a href="#l41.953"></a><span id="l41.953" class="difflineplus">+      // for imap folders, we need to create the sub-folders asynchronously,</span>
<a href="#l41.954"></a><span id="l41.954" class="difflineplus">+      // so we chain the urls using the listener called back from</span>
<a href="#l41.955"></a><span id="l41.955">       // createStorageIfMissing. For local, creatStorageIfMissing is</span>
<a href="#l41.956"></a><span id="l41.956">       // synchronous.</span>
<a href="#l41.957"></a><span id="l41.957">       let isImap = archiveFolder.server.type == &quot;imap&quot;;</span>
<a href="#l41.958"></a><span id="l41.958">       if (!archiveFolder.parent) {</span>
<a href="#l41.959"></a><span id="l41.959">         archiveFolder.createStorageIfMissing(this);</span>
<a href="#l41.960"></a><span id="l41.960">         if (isImap)</span>
<a href="#l41.961"></a><span id="l41.961">           return;</span>
<a href="#l41.962"></a><span id="l41.962">       }</span>
<a href="#l41.963"></a><span id="l41.963" class="difflineat">@@ -1349,28 +1396,20 @@ BatchMessageMover.prototype = {</span>
<a href="#l41.964"></a><span id="l41.964">       this._currentKey = null;</span>
<a href="#l41.965"></a><span id="l41.965"> </span>
<a href="#l41.966"></a><span id="l41.966">       // is there a safe way to test whether this._batches is empty?</span>
<a href="#l41.967"></a><span id="l41.967">       let empty = true;</span>
<a href="#l41.968"></a><span id="l41.968">       for (let key in this._batches) {</span>
<a href="#l41.969"></a><span id="l41.969">         empty = false;</span>
<a href="#l41.970"></a><span id="l41.970">       }</span>
<a href="#l41.971"></a><span id="l41.971"> </span>
<a href="#l41.972"></a><span id="l41.972" class="difflineminus">-      if (empty)</span>
<a href="#l41.973"></a><span id="l41.973" class="difflineminus">-      {</span>
<a href="#l41.974"></a><span id="l41.974" class="difflineminus">-        // we're just going to select the message now</span>
<a href="#l41.975"></a><span id="l41.975" class="difflineminus">-        var treeView = gDBView.QueryInterface(Components.interfaces.nsITreeView);</span>
<a href="#l41.976"></a><span id="l41.976" class="difflineminus">-        var treeSelection = treeView.selection;</span>
<a href="#l41.977"></a><span id="l41.977" class="difflineminus">-        treeSelection.select(this.messageToSelectAfterWereDone);</span>
<a href="#l41.978"></a><span id="l41.978" class="difflineminus">-        treeView.selectionChanged();</span>
<a href="#l41.979"></a><span id="l41.979" class="difflineminus">-      }</span>
<a href="#l41.980"></a><span id="l41.980" class="difflineminus">-      else</span>
<a href="#l41.981"></a><span id="l41.981" class="difflineminus">-      {</span>
<a href="#l41.982"></a><span id="l41.982" class="difflineplus">+      if (!empty)</span>
<a href="#l41.983"></a><span id="l41.983">         this.processNextBatch();</span>
<a href="#l41.984"></a><span id="l41.984" class="difflineminus">-      }</span>
<a href="#l41.985"></a><span id="l41.985" class="difflineplus">+      else // this will select the appropriate next message</span>
<a href="#l41.986"></a><span id="l41.986" class="difflineplus">+        gFolderDisplay.hintMassMoveCompleted();</span>
<a href="#l41.987"></a><span id="l41.987">     }</span>
<a href="#l41.988"></a><span id="l41.988">   },</span>
<a href="#l41.989"></a><span id="l41.989">   QueryInterface: function(iid) {</span>
<a href="#l41.990"></a><span id="l41.990">     if (!iid.equals(Components.interfaces.nsIUrlListener) &amp;&amp;</span>
<a href="#l41.991"></a><span id="l41.991">       !iid.equals(Components.interfaces.nsIMsgCopyServiceListener) &amp;&amp;</span>
<a href="#l41.992"></a><span id="l41.992">       !iid.equals(Components.interfaces.nsISupports))</span>
<a href="#l41.993"></a><span id="l41.993">       throw Components.results.NS_ERROR_NO_INTERFACE;</span>
<a href="#l41.994"></a><span id="l41.994">     return this;</span>
<a href="#l41.995"></a><span id="l41.995" class="difflineat">@@ -1415,28 +1454,26 @@ function MsgForwardAsInline(event)</span>
<a href="#l41.996"></a><span id="l41.996"> </span>
<a href="#l41.997"></a><span id="l41.997"> function MsgEditMessageAsNew()</span>
<a href="#l41.998"></a><span id="l41.998"> {</span>
<a href="#l41.999"></a><span id="l41.999">   composeMsgByType(Components.interfaces.nsIMsgCompType.Template);</span>
<a href="#l41.1000"></a><span id="l41.1000"> }</span>
<a href="#l41.1001"></a><span id="l41.1001"> </span>
<a href="#l41.1002"></a><span id="l41.1002"> function MsgComposeDraftMessage()</span>
<a href="#l41.1003"></a><span id="l41.1003"> {</span>
<a href="#l41.1004"></a><span id="l41.1004" class="difflineminus">-  var loadedFolder = GetLoadedMsgFolder();</span>
<a href="#l41.1005"></a><span id="l41.1005" class="difflineminus">-  var messageArray = GetSelectedMessages();</span>
<a href="#l41.1006"></a><span id="l41.1006" class="difflineminus">-</span>
<a href="#l41.1007"></a><span id="l41.1007">   ComposeMessage(Components.interfaces.nsIMsgCompType.Draft,</span>
<a href="#l41.1008"></a><span id="l41.1008">                  Components.interfaces.nsIMsgCompFormat.Default,</span>
<a href="#l41.1009"></a><span id="l41.1009" class="difflineminus">-                 loadedFolder, messageArray);</span>
<a href="#l41.1010"></a><span id="l41.1010" class="difflineplus">+                 gFolderDisplay.displayedFolder,</span>
<a href="#l41.1011"></a><span id="l41.1011" class="difflineplus">+                 gFolderDisplay.selectedMessageUris);</span>
<a href="#l41.1012"></a><span id="l41.1012"> }</span>
<a href="#l41.1013"></a><span id="l41.1013"> </span>
<a href="#l41.1014"></a><span id="l41.1014"> function MsgCreateFilter()</span>
<a href="#l41.1015"></a><span id="l41.1015"> {</span>
<a href="#l41.1016"></a><span id="l41.1016">   // retrieve Sender direct from selected message's headers</span>
<a href="#l41.1017"></a><span id="l41.1017" class="difflineminus">-  var msgHdr = gDBView.hdrForFirstSelectedMessage;</span>
<a href="#l41.1018"></a><span id="l41.1018" class="difflineplus">+  var msgHdr = gFolderDisplay.selectedMessage;</span>
<a href="#l41.1019"></a><span id="l41.1019">   var headerParser = Components.classes[&quot;@mozilla.org/messenger/headerparser;1&quot;]</span>
<a href="#l41.1020"></a><span id="l41.1020">                                .getService(Components.interfaces.nsIMsgHeaderParser);</span>
<a href="#l41.1021"></a><span id="l41.1021">   var emailAddress = headerParser.extractHeaderAddressMailboxes(msgHdr.author);</span>
<a href="#l41.1022"></a><span id="l41.1022">   if (emailAddress)</span>
<a href="#l41.1023"></a><span id="l41.1023">     top.MsgFilters(emailAddress, null);</span>
<a href="#l41.1024"></a><span id="l41.1024"> }</span>
<a href="#l41.1025"></a><span id="l41.1025"> </span>
<a href="#l41.1026"></a><span id="l41.1026"> function MsgNewFolder(callBackFunctionName)</span>
<a href="#l41.1027"></a><span id="l41.1027" class="difflineat">@@ -1552,24 +1589,24 @@ function ToggleFavoriteFolderFlag()</span>
<a href="#l41.1028"></a><span id="l41.1028"> {</span>
<a href="#l41.1029"></a><span id="l41.1029">   var folder = GetFirstSelectedMsgFolder();</span>
<a href="#l41.1030"></a><span id="l41.1030">   folder.toggleFlag(Components.interfaces.nsMsgFolderFlags.Favorite);</span>
<a href="#l41.1031"></a><span id="l41.1031"> }</span>
<a href="#l41.1032"></a><span id="l41.1032"> </span>
<a href="#l41.1033"></a><span id="l41.1033"> function MsgSaveAsFile()</span>
<a href="#l41.1034"></a><span id="l41.1034"> {</span>
<a href="#l41.1035"></a><span id="l41.1035">   if (GetNumSelectedMessages() == 1)</span>
<a href="#l41.1036"></a><span id="l41.1036" class="difflineminus">-    SaveAsFile(GetFirstSelectedMessage());</span>
<a href="#l41.1037"></a><span id="l41.1037" class="difflineplus">+    SaveAsFile(gFolderDisplay.selectedMessageUris[0]);</span>
<a href="#l41.1038"></a><span id="l41.1038"> }</span>
<a href="#l41.1039"></a><span id="l41.1039"> </span>
<a href="#l41.1040"></a><span id="l41.1040"> function MsgSaveAsTemplate()</span>
<a href="#l41.1041"></a><span id="l41.1041"> {</span>
<a href="#l41.1042"></a><span id="l41.1042" class="difflineminus">-  var folder = GetLoadedMsgFolder();</span>
<a href="#l41.1043"></a><span id="l41.1043">   if (GetNumSelectedMessages() == 1)</span>
<a href="#l41.1044"></a><span id="l41.1044" class="difflineminus">-    SaveAsTemplate(GetFirstSelectedMessage(), folder);</span>
<a href="#l41.1045"></a><span id="l41.1045" class="difflineplus">+    SaveAsTemplate(gFolderDisplay.selectedMessageUris[0],</span>
<a href="#l41.1046"></a><span id="l41.1046" class="difflineplus">+                   gFolderDisplay.displayedFolder);</span>
<a href="#l41.1047"></a><span id="l41.1047"> }</span>
<a href="#l41.1048"></a><span id="l41.1048"> </span>
<a href="#l41.1049"></a><span id="l41.1049"> function CreateToolbarTooltip(document, event)</span>
<a href="#l41.1050"></a><span id="l41.1050"> {</span>
<a href="#l41.1051"></a><span id="l41.1051">   event.stopPropagation();</span>
<a href="#l41.1052"></a><span id="l41.1052">   var tn = document.tooltipNode;</span>
<a href="#l41.1053"></a><span id="l41.1053">   if (tn.localName != &quot;tab&quot;)</span>
<a href="#l41.1054"></a><span id="l41.1054">     return false; // Not a tab, so cancel the tooltip.</span>
<a href="#l41.1055"></a><span id="l41.1055" class="difflineat">@@ -1580,315 +1617,337 @@ function CreateToolbarTooltip(document, </span>
<a href="#l41.1056"></a><span id="l41.1056">   if (tn.hasAttribute(&quot;label&quot;)) {</span>
<a href="#l41.1057"></a><span id="l41.1057">     event.target.setAttribute(&quot;label&quot;, tn.getAttribute(&quot;label&quot;));</span>
<a href="#l41.1058"></a><span id="l41.1058">     return true;</span>
<a href="#l41.1059"></a><span id="l41.1059">   }</span>
<a href="#l41.1060"></a><span id="l41.1060">   return false;</span>
<a href="#l41.1061"></a><span id="l41.1061"> }</span>
<a href="#l41.1062"></a><span id="l41.1062"> </span>
<a href="#l41.1063"></a><span id="l41.1063"> /**</span>
<a href="#l41.1064"></a><span id="l41.1064" class="difflineminus">- * mailTabType provides both &quot;folder&quot; and &quot;message&quot; tab modes. Under the</span>
<a href="#l41.1065"></a><span id="l41.1065" class="difflineminus">- * previous TabOwner framework, their logic was separated into two 'classes'</span>
<a href="#l41.1066"></a><span id="l41.1066" class="difflineminus">- * which called common helper methods and had similar boilerplate logic.</span>
<a href="#l41.1067"></a><span id="l41.1067" class="difflineplus">+ * Displays message &quot;folder&quot;s, mail &quot;message&quot;s, and &quot;glodaSearch&quot; results.  The</span>
<a href="#l41.1068"></a><span id="l41.1068" class="difflineplus">+ *  commonality is that they all use the &quot;mailContent&quot; panel's folder tree,</span>
<a href="#l41.1069"></a><span id="l41.1069" class="difflineplus">+ *  thread tree, and message pane objects.  This happens for historical reasons,</span>
<a href="#l41.1070"></a><span id="l41.1070" class="difflineplus">+ *  likely involving the fact that prior to the introduction of this</span>
<a href="#l41.1071"></a><span id="l41.1071" class="difflineplus">+ *  abstraction, everything was always stored in global objects.  For the 3.0</span>
<a href="#l41.1072"></a><span id="l41.1072" class="difflineplus">+ *  release cycle we considered avoiding this 'multiplexed' style of operation</span>
<a href="#l41.1073"></a><span id="l41.1073" class="difflineplus">+ *  but decided against moving to making each tab be indepdendent because of</span>
<a href="#l41.1074"></a><span id="l41.1074" class="difflineplus">+ *  presumed complexity.</span>
<a href="#l41.1075"></a><span id="l41.1075" class="difflineplus">+ *</span>
<a href="#l41.1076"></a><span id="l41.1076" class="difflineplus">+ * The tab info objects (as tabmail's currentTabInfo/tabInfo fields contain)</span>
<a href="#l41.1077"></a><span id="l41.1077" class="difflineplus">+ *  have the following attributes specific to our implementation:</span>
<a href="#l41.1078"></a><span id="l41.1078" class="difflineplus">+ *</span>
<a href="#l41.1079"></a><span id="l41.1079" class="difflineplus">+ *</span>
<a href="#l41.1080"></a><span id="l41.1080" class="difflineplus">+ * @property {string} uriToOpen</span>
<a href="#l41.1081"></a><span id="l41.1081" class="difflineplus">+ * @property {nsIMsgFolder} msgSelectedFolder Preserves gMsgFolderSelected</span>
<a href="#l41.1082"></a><span id="l41.1082" class="difflineplus">+ *     global.</span>
<a href="#l41.1083"></a><span id="l41.1083" class="difflineplus">+ * @property {nsIMsgDBView} dbView The database view to use with the thread tree</span>
<a href="#l41.1084"></a><span id="l41.1084" class="difflineplus">+ *     when this tab is displayed.  The value will be assigned to the global</span>
<a href="#l41.1085"></a><span id="l41.1085" class="difflineplus">+ *     gDBView in the process.</span>
<a href="#l41.1086"></a><span id="l41.1086" class="difflineplus">+ * @property {nsIMessenger} messenger Used to preserve &quot;messenger&quot; global value.</span>
<a href="#l41.1087"></a><span id="l41.1087" class="difflineplus">+ *     The messenger object is the keeper of the 'undo' state and navigation</span>
<a href="#l41.1088"></a><span id="l41.1088" class="difflineplus">+ *     history, which is why we do this.</span>
<a href="#l41.1089"></a><span id="l41.1089" class="difflineplus">+ *</span>
<a href="#l41.1090"></a><span id="l41.1090" class="difflineplus">+ * @property {boolean} folderPaneCollapsed In &quot;folder&quot; mode, has the user</span>
<a href="#l41.1091"></a><span id="l41.1091" class="difflineplus">+ *     intentionally collapsed the folder pane.</span>
<a href="#l41.1092"></a><span id="l41.1092" class="difflineplus">+ * @property {boolean} messagePaneCollapsed In &quot;folder&quot; or &quot;glodaSearch&quot; mode,</span>
<a href="#l41.1093"></a><span id="l41.1093" class="difflineplus">+ *     has the user intentionally collapsed the message pane.</span>
<a href="#l41.1094"></a><span id="l41.1094" class="difflineplus">+ *</span>
<a href="#l41.1095"></a><span id="l41.1095" class="difflineplus">+ * @property {nsIMsgDBHdr} hdr In &quot;message&quot; mode, the header of the message</span>
<a href="#l41.1096"></a><span id="l41.1096" class="difflineplus">+ *     being displayed.</span>
<a href="#l41.1097"></a><span id="l41.1097" class="difflineplus">+ * @property {nsIMsgSearchSession} searchSession Used to preserve gSearchSession</span>
<a href="#l41.1098"></a><span id="l41.1098" class="difflineplus">+ *     global value.</span>
<a href="#l41.1099"></a><span id="l41.1099" class="difflineplus">+ *</span>
<a href="#l41.1100"></a><span id="l41.1100">  */</span>
<a href="#l41.1101"></a><span id="l41.1101"> let mailTabType = {</span>
<a href="#l41.1102"></a><span id="l41.1102">   name: &quot;mail&quot;,</span>
<a href="#l41.1103"></a><span id="l41.1103">   panelId: &quot;mailContent&quot;,</span>
<a href="#l41.1104"></a><span id="l41.1104">   modes: {</span>
<a href="#l41.1105"></a><span id="l41.1105" class="difflineplus">+    /**</span>
<a href="#l41.1106"></a><span id="l41.1106" class="difflineplus">+     * The folder view displays the contents of an nsIMsgDBFolder, with the</span>
<a href="#l41.1107"></a><span id="l41.1107" class="difflineplus">+     *  folder pane (potentially), thread pane (always), and message pane</span>
<a href="#l41.1108"></a><span id="l41.1108" class="difflineplus">+     *  (potentially) displayed.</span>
<a href="#l41.1109"></a><span id="l41.1109" class="difflineplus">+     *</span>
<a href="#l41.1110"></a><span id="l41.1110" class="difflineplus">+     * The actual nsMsgDBView can be any of the following types of things:</span>
<a href="#l41.1111"></a><span id="l41.1111" class="difflineplus">+     *  - A single folder.</span>
<a href="#l41.1112"></a><span id="l41.1112" class="difflineplus">+     *    - A quicksearch on a single folder.</span>
<a href="#l41.1113"></a><span id="l41.1113" class="difflineplus">+     *  - A virtual folder potentially containing messages from multiple</span>
<a href="#l41.1114"></a><span id="l41.1114" class="difflineplus">+     *    folders. (eShowVirtualFolderResults)</span>
<a href="#l41.1115"></a><span id="l41.1115" class="difflineplus">+     */</span>
<a href="#l41.1116"></a><span id="l41.1116">     folder: {</span>
<a href="#l41.1117"></a><span id="l41.1117">       isDefault: true,</span>
<a href="#l41.1118"></a><span id="l41.1118">       type: &quot;folder&quot;,</span>
<a href="#l41.1119"></a><span id="l41.1119" class="difflineminus">-      openTab: function(aTab, aFolderUri) {</span>
<a href="#l41.1120"></a><span id="l41.1120" class="difflineminus">-        aTab.uriToOpen = aFolderUri;</span>
<a href="#l41.1121"></a><span id="l41.1121" class="difflineminus">-</span>
<a href="#l41.1122"></a><span id="l41.1122" class="difflineminus">-        this.openTab(aTab); // call superclass logic</span>
<a href="#l41.1123"></a><span id="l41.1123" class="difflineplus">+      /// The set of panes that are legal to be displayed in this mode</span>
<a href="#l41.1124"></a><span id="l41.1124" class="difflineplus">+      legalPanes: {</span>
<a href="#l41.1125"></a><span id="l41.1125" class="difflineplus">+        folder: true,</span>
<a href="#l41.1126"></a><span id="l41.1126" class="difflineplus">+        thread: true,</span>
<a href="#l41.1127"></a><span id="l41.1127" class="difflineplus">+        message: true</span>
<a href="#l41.1128"></a><span id="l41.1128" class="difflineplus">+      },</span>
<a href="#l41.1129"></a><span id="l41.1129" class="difflineplus">+      openFirstTab: function(aTab) {</span>
<a href="#l41.1130"></a><span id="l41.1130" class="difflineplus">+        this.openTab(aTab, true, new MessagePaneDisplayWidget());</span>
<a href="#l41.1131"></a><span id="l41.1131" class="difflineplus">+        aTab.folderDisplay.makeActive();</span>
<a href="#l41.1132"></a><span id="l41.1132">       },</span>
<a href="#l41.1133"></a><span id="l41.1133" class="difflineminus">-      showTab: function(aTab) {</span>
<a href="#l41.1134"></a><span id="l41.1134" class="difflineminus">-        this.folderAndThreadPaneVisible = true;</span>
<a href="#l41.1135"></a><span id="l41.1135" class="difflineminus">-        ClearMessagePane();</span>
<a href="#l41.1136"></a><span id="l41.1136" class="difflineminus">-</span>
<a href="#l41.1137"></a><span id="l41.1137" class="difflineminus">-        this.showTab(aTab);</span>
<a href="#l41.1138"></a><span id="l41.1138" class="difflineplus">+      /**</span>
<a href="#l41.1139"></a><span id="l41.1139" class="difflineplus">+       * @param aFolder The nsIMsgFolder to display.</span>
<a href="#l41.1140"></a><span id="l41.1140" class="difflineplus">+       * @param aMsgHdr Optional message header to display.</span>
<a href="#l41.1141"></a><span id="l41.1141" class="difflineplus">+       */</span>
<a href="#l41.1142"></a><span id="l41.1142" class="difflineplus">+      openTab: function(aTab, aFolder, aMsgHdr) {</span>
<a href="#l41.1143"></a><span id="l41.1143" class="difflineplus">+        // Get a tab that we can initialize our user preferences from.</span>
<a href="#l41.1144"></a><span id="l41.1144" class="difflineplus">+        // (We don't want to assume that our immediate predecessor was a</span>
<a href="#l41.1145"></a><span id="l41.1145" class="difflineplus">+        //  &quot;folder&quot; tab.)</span>
<a href="#l41.1146"></a><span id="l41.1146" class="difflineplus">+        let modelTab = document.getElementById(&quot;tabmail&quot;)</span>
<a href="#l41.1147"></a><span id="l41.1147" class="difflineplus">+                         .getTabInfoForCurrentOrFirstModeInstance(aTab.mode);</span>
<a href="#l41.1148"></a><span id="l41.1148" class="difflineplus">+        // copy its state</span>
<a href="#l41.1149"></a><span id="l41.1149" class="difflineplus">+        aTab.folderPaneCollapsed = modelTab.folderPaneCollapsed;</span>
<a href="#l41.1150"></a><span id="l41.1150" class="difflineplus">+        aTab.messagePaneCollapsed = modelTab.messagePaneCollapsed;</span>
<a href="#l41.1151"></a><span id="l41.1151" class="difflineplus">+</span>
<a href="#l41.1152"></a><span id="l41.1152" class="difflineplus">+        this.openTab(aTab, false,  new MessagePaneDisplayWidget());</span>
<a href="#l41.1153"></a><span id="l41.1153" class="difflineplus">+</span>
<a href="#l41.1154"></a><span id="l41.1154" class="difflineplus">+        // Clear selection, because context clicking on a folder and opening in a</span>
<a href="#l41.1155"></a><span id="l41.1155" class="difflineplus">+        // new tab needs to have SelectFolder think the selection has changed.</span>
<a href="#l41.1156"></a><span id="l41.1156" class="difflineplus">+        // We also need to clear these globals to subvert the code that prevents</span>
<a href="#l41.1157"></a><span id="l41.1157" class="difflineplus">+        // folder loads when things haven't changed.</span>
<a href="#l41.1158"></a><span id="l41.1158" class="difflineplus">+        var folderTree = document.getElementById(&quot;folderTree&quot;);</span>
<a href="#l41.1159"></a><span id="l41.1159" class="difflineplus">+        folderTree.view.selection.clearSelection();</span>
<a href="#l41.1160"></a><span id="l41.1160" class="difflineplus">+        folderTree.view.selection.currentIndex = -1;</span>
<a href="#l41.1161"></a><span id="l41.1161" class="difflineplus">+</span>
<a href="#l41.1162"></a><span id="l41.1162" class="difflineplus">+        aTab.folderDisplay.makeActive();</span>
<a href="#l41.1163"></a><span id="l41.1163" class="difflineplus">+</span>
<a href="#l41.1164"></a><span id="l41.1164" class="difflineplus">+        // selecting the folder effectively calls</span>
<a href="#l41.1165"></a><span id="l41.1165" class="difflineplus">+        //  aTab.folderDisplay.show(aFolder)</span>
<a href="#l41.1166"></a><span id="l41.1166" class="difflineplus">+        gFolderTreeView.selectFolder(aFolder);</span>
<a href="#l41.1167"></a><span id="l41.1167" class="difflineplus">+        if(aMsgHdr)</span>
<a href="#l41.1168"></a><span id="l41.1168" class="difflineplus">+          aTab.folderDisplay.selectMessage(aMsgHdr);</span>
<a href="#l41.1169"></a><span id="l41.1169">       },</span>
<a href="#l41.1170"></a><span id="l41.1170">       onTitleChanged: function(aTab, aTabNode) {</span>
<a href="#l41.1171"></a><span id="l41.1171" class="difflineminus">-        if (!gMsgFolderSelected) {</span>
<a href="#l41.1172"></a><span id="l41.1172" class="difflineplus">+        if (!aTab.folderDisplay || !aTab.folderDisplay.displayedFolder) {</span>
<a href="#l41.1173"></a><span id="l41.1173">           // Don't show &quot;undefined&quot; as title when there is no account.</span>
<a href="#l41.1174"></a><span id="l41.1174">           aTab.title = &quot; &quot;;</span>
<a href="#l41.1175"></a><span id="l41.1175">           return;</span>
<a href="#l41.1176"></a><span id="l41.1176">         }</span>
<a href="#l41.1177"></a><span id="l41.1177" class="difflineminus">-        aTab.title = gMsgFolderSelected.prettyName;</span>
<a href="#l41.1178"></a><span id="l41.1178" class="difflineminus">-        if (!gMsgFolderSelected.isServer &amp;&amp; this._getNumberOfRealAccounts() &gt; 1)</span>
<a href="#l41.1179"></a><span id="l41.1179" class="difflineminus">-          aTab.title += &quot; - &quot; + gMsgFolderSelected.server.prettyName;</span>
<a href="#l41.1180"></a><span id="l41.1180" class="difflineminus">-</span>
<a href="#l41.1181"></a><span id="l41.1181" class="difflineminus">-        // The user may have changed folders, triggering our onTitleChanged callback.</span>
<a href="#l41.1182"></a><span id="l41.1182" class="difflineplus">+        // The user may have changed folders, triggering our onTitleChanged</span>
<a href="#l41.1183"></a><span id="l41.1183" class="difflineplus">+        // callback.</span>
<a href="#l41.1184"></a><span id="l41.1184" class="difflineplus">+        let folder = aTab.folderDisplay.displayedFolder;</span>
<a href="#l41.1185"></a><span id="l41.1185" class="difflineplus">+        aTab.title = folder.prettyName;</span>
<a href="#l41.1186"></a><span id="l41.1186" class="difflineplus">+        if (!folder.isServer &amp;&amp; this._getNumberOfRealAccounts() &gt; 1)</span>
<a href="#l41.1187"></a><span id="l41.1187" class="difflineplus">+          aTab.title += &quot; - &quot; + folder.server.prettyName;</span>
<a href="#l41.1188"></a><span id="l41.1188" class="difflineplus">+</span>
<a href="#l41.1189"></a><span id="l41.1189">         // Update the appropriate attributes on the tab.</span>
<a href="#l41.1190"></a><span id="l41.1190" class="difflineminus">-        aTabNode.setAttribute('SpecialFolder', getSpecialFolderString(gMsgFolderSelected));</span>
<a href="#l41.1191"></a><span id="l41.1191" class="difflineminus">-        aTabNode.setAttribute('ServerType', gMsgFolderSelected.server.type);</span>
<a href="#l41.1192"></a><span id="l41.1192" class="difflineminus">-        aTabNode.setAttribute('IsServer', gMsgFolderSelected.isServer);</span>
<a href="#l41.1193"></a><span id="l41.1193" class="difflineminus">-        aTabNode.setAttribute('IsSecure', gMsgFolderSelected.server.isSecure);</span>
<a href="#l41.1194"></a><span id="l41.1194" class="difflineplus">+        aTabNode.setAttribute('SpecialFolder',</span>
<a href="#l41.1195"></a><span id="l41.1195" class="difflineplus">+                              getSpecialFolderString(folder));</span>
<a href="#l41.1196"></a><span id="l41.1196" class="difflineplus">+        aTabNode.setAttribute('ServerType', folder.server.type);</span>
<a href="#l41.1197"></a><span id="l41.1197" class="difflineplus">+        aTabNode.setAttribute('IsServer', folder.isServer);</span>
<a href="#l41.1198"></a><span id="l41.1198" class="difflineplus">+        aTabNode.setAttribute('IsSecure', folder.server.isSecure);</span>
<a href="#l41.1199"></a><span id="l41.1199">       }</span>
<a href="#l41.1200"></a><span id="l41.1200">     },</span>
<a href="#l41.1201"></a><span id="l41.1201" class="difflineplus">+    /**</span>
<a href="#l41.1202"></a><span id="l41.1202" class="difflineplus">+     * The message view displays a single message.  In this view, the folder</span>
<a href="#l41.1203"></a><span id="l41.1203" class="difflineplus">+     *  pane and thread pane are forced hidden and only the message pane is</span>
<a href="#l41.1204"></a><span id="l41.1204" class="difflineplus">+     *  displayed.</span>
<a href="#l41.1205"></a><span id="l41.1205" class="difflineplus">+     */</span>
<a href="#l41.1206"></a><span id="l41.1206">     message: {</span>
<a href="#l41.1207"></a><span id="l41.1207">       type: &quot;message&quot;,</span>
<a href="#l41.1208"></a><span id="l41.1208" class="difflineminus">-      openTab: function(aTab, aFolderUri, aMsgHdr) {</span>
<a href="#l41.1209"></a><span id="l41.1209" class="difflineminus">-        aTab.uriToOpen = aFolderUri;</span>
<a href="#l41.1210"></a><span id="l41.1210" class="difflineminus">-        aTab.hdr = aMsgHdr;</span>
<a href="#l41.1211"></a><span id="l41.1211" class="difflineminus">-</span>
<a href="#l41.1212"></a><span id="l41.1212" class="difflineplus">+      /// The set of panes that are legal to be displayed in this mode</span>
<a href="#l41.1213"></a><span id="l41.1213" class="difflineplus">+      legalPanes: {</span>
<a href="#l41.1214"></a><span id="l41.1214" class="difflineplus">+        folder: false,</span>
<a href="#l41.1215"></a><span id="l41.1215" class="difflineplus">+        thread: false,</span>
<a href="#l41.1216"></a><span id="l41.1216" class="difflineplus">+        message: true</span>
<a href="#l41.1217"></a><span id="l41.1217" class="difflineplus">+      },</span>
<a href="#l41.1218"></a><span id="l41.1218" class="difflineplus">+      openTab: function(aTab, aMsgHdr, aViewWrapperToClone) {</span>
<a href="#l41.1219"></a><span id="l41.1219" class="difflineplus">+        aTab.mode.onTitleChanged.call(this, aTab, null, aMsgHdr);</span>
<a href="#l41.1220"></a><span id="l41.1220" class="difflineplus">+</span>
<a href="#l41.1221"></a><span id="l41.1221" class="difflineplus">+        this.openTab(aTab, false, new MessageTabDisplayWidget());</span>
<a href="#l41.1222"></a><span id="l41.1222" class="difflineplus">+</span>
<a href="#l41.1223"></a><span id="l41.1223" class="difflineplus">+        if (aViewWrapperToClone)</span>
<a href="#l41.1224"></a><span id="l41.1224" class="difflineplus">+          aTab.folderDisplay.cloneView(aViewWrapperToClone);</span>
<a href="#l41.1225"></a><span id="l41.1225" class="difflineplus">+        else</span>
<a href="#l41.1226"></a><span id="l41.1226" class="difflineplus">+          aTab.folderDisplay.show(aMsgHdr.folder);</span>
<a href="#l41.1227"></a><span id="l41.1227" class="difflineplus">+</span>
<a href="#l41.1228"></a><span id="l41.1228" class="difflineplus">+        aTab.folderDisplay.selectMessage(aMsgHdr);</span>
<a href="#l41.1229"></a><span id="l41.1229" class="difflineplus">+</span>
<a href="#l41.1230"></a><span id="l41.1230" class="difflineplus">+        // we only want to make it active after setting up the view and the message</span>
<a href="#l41.1231"></a><span id="l41.1231" class="difflineplus">+        //  to avoid generating bogus summarization events.</span>
<a href="#l41.1232"></a><span id="l41.1232" class="difflineplus">+        aTab.folderDisplay.makeActive();</span>
<a href="#l41.1233"></a><span id="l41.1233" class="difflineplus">+      },</span>
<a href="#l41.1234"></a><span id="l41.1234" class="difflineplus">+      onTitleChanged: function(aTab, aTabNode, aMsgHdr) {</span>
<a href="#l41.1235"></a><span id="l41.1235" class="difflineplus">+        if (aMsgHdr == null)</span>
<a href="#l41.1236"></a><span id="l41.1236" class="difflineplus">+          aMsgHdr = aTab.folderDisplay.selectedMessage;</span>
<a href="#l41.1237"></a><span id="l41.1237">         aTab.title = &quot;&quot;;</span>
<a href="#l41.1238"></a><span id="l41.1238" class="difflineminus">-        if (aTab.hdr.flags &amp; Components.interfaces.nsMsgMessageFlags.HasRe)</span>
<a href="#l41.1239"></a><span id="l41.1239" class="difflineplus">+        if (aMsgHdr.flags &amp; Components.interfaces.nsMsgMessageFlags.HasRe)</span>
<a href="#l41.1240"></a><span id="l41.1240">           aTab.title = &quot;Re: &quot;;</span>
<a href="#l41.1241"></a><span id="l41.1241" class="difflineminus">-        if (aTab.hdr.mime2DecodedSubject)</span>
<a href="#l41.1242"></a><span id="l41.1242" class="difflineminus">-          aTab.title += aTab.hdr.mime2DecodedSubject;</span>
<a href="#l41.1243"></a><span id="l41.1243" class="difflineminus">-</span>
<a href="#l41.1244"></a><span id="l41.1244" class="difflineminus">-        aTab.title += &quot; - &quot; + aTab.hdr.folder.prettyName;</span>
<a href="#l41.1245"></a><span id="l41.1245" class="difflineplus">+        if (aMsgHdr.mime2DecodedSubject)</span>
<a href="#l41.1246"></a><span id="l41.1246" class="difflineplus">+          aTab.title += aMsgHdr.mime2DecodedSubject;</span>
<a href="#l41.1247"></a><span id="l41.1247" class="difflineplus">+</span>
<a href="#l41.1248"></a><span id="l41.1248" class="difflineplus">+        aTab.title += &quot; - &quot; + aMsgHdr.folder.prettyName;</span>
<a href="#l41.1249"></a><span id="l41.1249">         if (this._getNumberOfRealAccounts() &gt; 1)</span>
<a href="#l41.1250"></a><span id="l41.1250" class="difflineminus">-          aTab.title += &quot; - &quot; + aTab.hdr.folder.server.prettyName;</span>
<a href="#l41.1251"></a><span id="l41.1251" class="difflineminus">-</span>
<a href="#l41.1252"></a><span id="l41.1252" class="difflineminus">-        // let's try hiding the thread pane and folder pane</span>
<a href="#l41.1253"></a><span id="l41.1253" class="difflineminus">-        this.folderAndThreadPaneVisible = false;</span>
<a href="#l41.1254"></a><span id="l41.1254" class="difflineminus">-</span>
<a href="#l41.1255"></a><span id="l41.1255" class="difflineminus">-        this.openTab(aTab); // call superclass logic</span>
<a href="#l41.1256"></a><span id="l41.1256" class="difflineminus">-</span>
<a href="#l41.1257"></a><span id="l41.1257" class="difflineminus">-        gCurrentlyDisplayedMessage = nsMsgViewIndex_None;</span>
<a href="#l41.1258"></a><span id="l41.1258" class="difflineminus">-        ClearThreadPaneSelection();</span>
<a href="#l41.1259"></a><span id="l41.1259" class="difflineminus">-        setTimeout(gDBView.selectFolderMsgByKey, 0, aTab.hdr.folder,</span>
<a href="#l41.1260"></a><span id="l41.1260" class="difflineminus">-                   aTab.hdr.messageKey);</span>
<a href="#l41.1261"></a><span id="l41.1261" class="difflineminus">-      },</span>
<a href="#l41.1262"></a><span id="l41.1262" class="difflineminus">-      showTab: function(aTab) {</span>
<a href="#l41.1263"></a><span id="l41.1263" class="difflineminus">-        this.folderAndThreadPaneVisible = false;</span>
<a href="#l41.1264"></a><span id="l41.1264" class="difflineminus">-        this.showTab(aTab);</span>
<a href="#l41.1265"></a><span id="l41.1265" class="difflineplus">+          aTab.title += &quot; - &quot; + aMsgHdr.folder.server.prettyName;</span>
<a href="#l41.1266"></a><span id="l41.1266">       }</span>
<a href="#l41.1267"></a><span id="l41.1267">     }</span>
<a href="#l41.1268"></a><span id="l41.1268">   },</span>
<a href="#l41.1269"></a><span id="l41.1269"> </span>
<a href="#l41.1270"></a><span id="l41.1270">   _getNumberOfRealAccounts : function() {</span>
<a href="#l41.1271"></a><span id="l41.1271">     let mgr = Components.classes[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l41.1272"></a><span id="l41.1272">                         .getService(Components.interfaces.nsIMsgAccountManager);</span>
<a href="#l41.1273"></a><span id="l41.1273">     let accountCount = mgr.accounts.Count();</span>
<a href="#l41.1274"></a><span id="l41.1274">     // If we have an account, we also always have a &quot;Local Folders&quot; account.</span>
<a href="#l41.1275"></a><span id="l41.1275">     return accountCount &gt; 0 ? (accountCount - 1) : 0;</span>
<a href="#l41.1276"></a><span id="l41.1276">   },</span>
<a href="#l41.1277"></a><span id="l41.1277"> </span>
<a href="#l41.1278"></a><span id="l41.1278">   /**</span>
<a href="#l41.1279"></a><span id="l41.1279" class="difflineminus">-   * Create the new tab's state, which engenders some side effects.  Part of our</span>
<a href="#l41.1280"></a><span id="l41.1280" class="difflineminus">-   *  contract is that we leave the tab in the selected state.</span>
<a href="#l41.1281"></a><span id="l41.1281" class="difflineplus">+   * Common tab opening code shared by the various tab modes.</span>
<a href="#l41.1282"></a><span id="l41.1282">    */</span>
<a href="#l41.1283"></a><span id="l41.1283" class="difflineminus">-  openTab: function(aTab) {</span>
<a href="#l41.1284"></a><span id="l41.1284" class="difflineplus">+  openTab: function(aTab, aIsFirstTab, aMessageDisplay) {</span>
<a href="#l41.1285"></a><span id="l41.1285">     // Set the messagepane as the primary browser for content.</span>
<a href="#l41.1286"></a><span id="l41.1286">     document.getElementById(&quot;messagepane&quot;).setAttribute(&quot;type&quot;,</span>
<a href="#l41.1287"></a><span id="l41.1287">                                                         &quot;content-primary&quot;);</span>
<a href="#l41.1288"></a><span id="l41.1288"> </span>
<a href="#l41.1289"></a><span id="l41.1289" class="difflineminus">-    ClearThreadPaneSelection();</span>
<a href="#l41.1290"></a><span id="l41.1290" class="difflineminus">-</span>
<a href="#l41.1291"></a><span id="l41.1291" class="difflineminus">-    // Each tab gets its own messenger instance; I assume this is so each one</span>
<a href="#l41.1292"></a><span id="l41.1292" class="difflineminus">-    // gets its own undo/redo stack?</span>
<a href="#l41.1293"></a><span id="l41.1293" class="difflineminus">-    messenger = Components.classes[&quot;@mozilla.org/messenger;1&quot;]</span>
<a href="#l41.1294"></a><span id="l41.1294" class="difflineminus">-                          .createInstance(Components.interfaces.nsIMessenger);</span>
<a href="#l41.1295"></a><span id="l41.1295" class="difflineminus">-    messenger.setWindow(window, msgWindow);</span>
<a href="#l41.1296"></a><span id="l41.1296" class="difflineminus">-    aTab.messenger = messenger;</span>
<a href="#l41.1297"></a><span id="l41.1297" class="difflineminus">-</span>
<a href="#l41.1298"></a><span id="l41.1298" class="difflineminus">-    aTab.msgSelectedFolder = gMsgFolderSelected;</span>
<a href="#l41.1299"></a><span id="l41.1299" class="difflineminus">-</span>
<a href="#l41.1300"></a><span id="l41.1300" class="difflineminus">-    // Clear selection, because context clicking on a folder and opening in a</span>
<a href="#l41.1301"></a><span id="l41.1301" class="difflineminus">-    // new tab needs to have SelectFolder think the selection has changed.</span>
<a href="#l41.1302"></a><span id="l41.1302" class="difflineminus">-    // We also need to clear these globals to subvert the code that prevents</span>
<a href="#l41.1303"></a><span id="l41.1303" class="difflineminus">-    // folder loads when things haven't changed.</span>
<a href="#l41.1304"></a><span id="l41.1304" class="difflineminus">-    var folderTree = document.getElementById(&quot;folderTree&quot;);</span>
<a href="#l41.1305"></a><span id="l41.1305" class="difflineminus">-    folderTree.view.selection.clearSelection();</span>
<a href="#l41.1306"></a><span id="l41.1306" class="difflineminus">-    folderTree.view.selection.currentIndex = -1;</span>
<a href="#l41.1307"></a><span id="l41.1307" class="difflineminus">-    gMsgFolderSelected = null;</span>
<a href="#l41.1308"></a><span id="l41.1308" class="difflineminus">-    msgWindow.openFolder = null;</span>
<a href="#l41.1309"></a><span id="l41.1309" class="difflineminus">-</span>
<a href="#l41.1310"></a><span id="l41.1310" class="difflineminus">-    // Clear thread pane selection - otherwise, the tree tries to impose the</span>
<a href="#l41.1311"></a><span id="l41.1311" class="difflineminus">-    // the current selection on the new view.</span>
<a href="#l41.1312"></a><span id="l41.1312" class="difflineminus">-    gDBView = null; // clear gDBView so we won't try to close it.</span>
<a href="#l41.1313"></a><span id="l41.1313" class="difflineminus">-    gFolderTreeView.selectFolder(GetMsgFolderFromUri(aTab.uriToOpen));</span>
<a href="#l41.1314"></a><span id="l41.1314" class="difflineminus">-    aTab.dbView = gDBView;</span>
<a href="#l41.1315"></a><span id="l41.1315" class="difflineplus">+    aTab.messageDisplay = aMessageDisplay;</span>
<a href="#l41.1316"></a><span id="l41.1316" class="difflineplus">+    aTab.folderDisplay = new FolderDisplayWidget(aTab, aTab.messageDisplay);</span>
<a href="#l41.1317"></a><span id="l41.1317" class="difflineplus">+    aTab.folderDisplay.msgWindow = msgWindow;</span>
<a href="#l41.1318"></a><span id="l41.1318" class="difflineplus">+    aTab.folderDisplay.tree = document.getElementById(&quot;threadTree&quot;);</span>
<a href="#l41.1319"></a><span id="l41.1319" class="difflineplus">+    aTab.folderDisplay.treeBox = aTab.folderDisplay.tree.boxObject.QueryInterface(</span>
<a href="#l41.1320"></a><span id="l41.1320" class="difflineplus">+                                   Components.interfaces.nsITreeBoxObject);</span>
<a href="#l41.1321"></a><span id="l41.1321" class="difflineplus">+</span>
<a href="#l41.1322"></a><span id="l41.1322" class="difflineplus">+    if (aIsFirstTab) {</span>
<a href="#l41.1323"></a><span id="l41.1323" class="difflineplus">+      aTab.folderDisplay.messenger = messenger;</span>
<a href="#l41.1324"></a><span id="l41.1324" class="difflineplus">+    }</span>
<a href="#l41.1325"></a><span id="l41.1325" class="difflineplus">+    else {</span>
<a href="#l41.1326"></a><span id="l41.1326" class="difflineplus">+      // Each tab gets its own messenger instance; this provides each tab with</span>
<a href="#l41.1327"></a><span id="l41.1327" class="difflineplus">+      // its own undo/redo stack and back/forward navigation history.</span>
<a href="#l41.1328"></a><span id="l41.1328" class="difflineplus">+      messenger = Components.classes[&quot;@mozilla.org/messenger;1&quot;]</span>
<a href="#l41.1329"></a><span id="l41.1329" class="difflineplus">+                            .createInstance(Components.interfaces.nsIMessenger);</span>
<a href="#l41.1330"></a><span id="l41.1330" class="difflineplus">+      messenger.setWindow(window, msgWindow);</span>
<a href="#l41.1331"></a><span id="l41.1331" class="difflineplus">+      aTab.folderDisplay.messenger = messenger;</span>
<a href="#l41.1332"></a><span id="l41.1332" class="difflineplus">+    }</span>
<a href="#l41.1333"></a><span id="l41.1333">   },</span>
<a href="#l41.1334"></a><span id="l41.1334"> </span>
<a href="#l41.1335"></a><span id="l41.1335">   closeTab: function(aTab) {</span>
<a href="#l41.1336"></a><span id="l41.1336" class="difflineminus">-    if (aTab.dbView)</span>
<a href="#l41.1337"></a><span id="l41.1337" class="difflineminus">-      aTab.dbView.close();</span>
<a href="#l41.1338"></a><span id="l41.1338" class="difflineminus">-    if (aTab.messenger)</span>
<a href="#l41.1339"></a><span id="l41.1339" class="difflineminus">-      aTab.messenger.setWindow(null, null);</span>
<a href="#l41.1340"></a><span id="l41.1340" class="difflineplus">+    aTab.folderDisplay.close();</span>
<a href="#l41.1341"></a><span id="l41.1341">   },</span>
<a href="#l41.1342"></a><span id="l41.1342"> </span>
<a href="#l41.1343"></a><span id="l41.1343">   saveTabState: function(aTab) {</span>
<a href="#l41.1344"></a><span id="l41.1344" class="difflineminus">-    aTab.messenger = messenger;</span>
<a href="#l41.1345"></a><span id="l41.1345" class="difflineminus">-    aTab.dbView = gDBView;</span>
<a href="#l41.1346"></a><span id="l41.1346" class="difflineminus">-    aTab.searchSession = gSearchSession;</span>
<a href="#l41.1347"></a><span id="l41.1347" class="difflineminus">-    aTab.msgSelectedFolder = gMsgFolderSelected;</span>
<a href="#l41.1348"></a><span id="l41.1348" class="difflineminus">-    if (!gDBView)</span>
<a href="#l41.1349"></a><span id="l41.1349" class="difflineminus">-      return;</span>
<a href="#l41.1350"></a><span id="l41.1350" class="difflineminus">-</span>
<a href="#l41.1351"></a><span id="l41.1351" class="difflineminus">-    aTab.firstVisibleRow = document.getElementById(&quot;threadTree&quot;).treeBoxObject.getFirstVisibleRow();</span>
<a href="#l41.1352"></a><span id="l41.1352" class="difflineminus">-</span>
<a href="#l41.1353"></a><span id="l41.1353" class="difflineminus">-    if (gDBView.currentlyDisplayedMessage != nsMsgViewIndex_None)</span>
<a href="#l41.1354"></a><span id="l41.1354" class="difflineminus">-    {</span>
<a href="#l41.1355"></a><span id="l41.1355" class="difflineminus">-      try // there may not be a selected message.</span>
<a href="#l41.1356"></a><span id="l41.1356" class="difflineminus">-      {</span>
<a href="#l41.1357"></a><span id="l41.1357" class="difflineminus">-        var curMsgHdr = gDBView.hdrForFirstSelectedMessage;</span>
<a href="#l41.1358"></a><span id="l41.1358" class="difflineminus">-        aTab.selectedMsgId = curMsgHdr.messageId;</span>
<a href="#l41.1359"></a><span id="l41.1359" class="difflineminus">-      }</span>
<a href="#l41.1360"></a><span id="l41.1360" class="difflineminus">-      catch (ex) {}</span>
<a href="#l41.1361"></a><span id="l41.1361" class="difflineminus">-    }</span>
<a href="#l41.1362"></a><span id="l41.1362" class="difflineminus">-    else</span>
<a href="#l41.1363"></a><span id="l41.1363" class="difflineminus">-    {</span>
<a href="#l41.1364"></a><span id="l41.1364" class="difflineminus">-      aTab.selectedMsgId = null;</span>
<a href="#l41.1365"></a><span id="l41.1365" class="difflineminus">-      aTab.msgSelectedFolder = gDBView.msgFolder;</span>
<a href="#l41.1366"></a><span id="l41.1366" class="difflineminus">-    }</span>
<a href="#l41.1367"></a><span id="l41.1367" class="difflineminus">-    if (aTab.msgSelectedFolder)</span>
<a href="#l41.1368"></a><span id="l41.1368" class="difflineminus">-      aTab.mailView = GetMailViewForFolder(aTab.msgSelectedFolder);</span>
<a href="#l41.1369"></a><span id="l41.1369" class="difflineminus">-</span>
<a href="#l41.1370"></a><span id="l41.1370">     // Now let other tabs have a primary browser if they want.</span>
<a href="#l41.1371"></a><span id="l41.1371">     document.getElementById(&quot;messagepane&quot;).setAttribute(&quot;type&quot;,</span>
<a href="#l41.1372"></a><span id="l41.1372">                                                         &quot;content-targetable&quot;);</span>
<a href="#l41.1373"></a><span id="l41.1373" class="difflineplus">+</span>
<a href="#l41.1374"></a><span id="l41.1374" class="difflineplus">+    aTab.folderDisplay.makeInactive();</span>
<a href="#l41.1375"></a><span id="l41.1375">   },</span>
<a href="#l41.1376"></a><span id="l41.1376"> </span>
<a href="#l41.1377"></a><span id="l41.1377" class="difflineminus">-  _displayFolderAndThreadPane: function(show) {</span>
<a href="#l41.1378"></a><span id="l41.1378" class="difflineminus">-    let collapse = !show;</span>
<a href="#l41.1379"></a><span id="l41.1379" class="difflineplus">+  /**</span>
<a href="#l41.1380"></a><span id="l41.1380" class="difflineplus">+   * Some panes simply are illegal in certain views, and some panes are legal</span>
<a href="#l41.1381"></a><span id="l41.1381" class="difflineplus">+   *  but the user may have collapsed/hidden them.  If that was not enough, we</span>
<a href="#l41.1382"></a><span id="l41.1382" class="difflineplus">+   *  have three different layouts that are possible, each of which requires a</span>
<a href="#l41.1383"></a><span id="l41.1383" class="difflineplus">+   *  slightly different DOM configuration, and accordingly for us to poke at</span>
<a href="#l41.1384"></a><span id="l41.1384" class="difflineplus">+   *  different DOM nodes.  Things are made somewhat simpler by our decision</span>
<a href="#l41.1385"></a><span id="l41.1385" class="difflineplus">+   *  that all tabs share the same layout.</span>
<a href="#l41.1386"></a><span id="l41.1386" class="difflineplus">+   * This method takes the legal states and current display states and attempts</span>
<a href="#l41.1387"></a><span id="l41.1387" class="difflineplus">+   *  to apply the appropriate logic to make it all work out.  This method is</span>
<a href="#l41.1388"></a><span id="l41.1388" class="difflineplus">+   *  not in charge of figuring out or preserving display states.</span>
<a href="#l41.1389"></a><span id="l41.1389" class="difflineplus">+   *</span>
<a href="#l41.1390"></a><span id="l41.1390" class="difflineplus">+   * We take a dictionary of desired visibility booleans as our argument because</span>
<a href="#l41.1391"></a><span id="l41.1391" class="difflineplus">+   * it is both readable and scalable.</span>
<a href="#l41.1392"></a><span id="l41.1392" class="difflineplus">+   *</span>
<a href="#l41.1393"></a><span id="l41.1393" class="difflineplus">+   * @param aLegalStates A dictionary where each key and value indicates whether</span>
<a href="#l41.1394"></a><span id="l41.1394" class="difflineplus">+   *     the pane in question (key) is legal to be displayed in this mode.  If</span>
<a href="#l41.1395"></a><span id="l41.1395" class="difflineplus">+   *     the value is true, then the pane is legal.  Omitted pane keys imply</span>
<a href="#l41.1396"></a><span id="l41.1396" class="difflineplus">+   *     that the pane is illegal.  Keys are:</span>
<a href="#l41.1397"></a><span id="l41.1397" class="difflineplus">+   *     - folder: The folder (tree) pane.</span>
<a href="#l41.1398"></a><span id="l41.1398" class="difflineplus">+   *     - thread: The thread pane.</span>
<a href="#l41.1399"></a><span id="l41.1399" class="difflineplus">+   *     - message: The message pane.  Required/assumed to be true for now.</span>
<a href="#l41.1400"></a><span id="l41.1400" class="difflineplus">+   *     - glodaFacets: The gloda search facets pane.</span>
<a href="#l41.1401"></a><span id="l41.1401" class="difflineplus">+   * @param aVisibleStates A dictionary where each value indicates whether the</span>
<a href="#l41.1402"></a><span id="l41.1402" class="difflineplus">+   *     pane should be 'visible' (not collapsed).  Only panes that are governed</span>
<a href="#l41.1403"></a><span id="l41.1403" class="difflineplus">+   *     by splitters are options here.  Keys are:</span>
<a href="#l41.1404"></a><span id="l41.1404" class="difflineplus">+   *     - folder: The folder (tree) pane.</span>
<a href="#l41.1405"></a><span id="l41.1405" class="difflineplus">+   *     - message: The message pane.</span>
<a href="#l41.1406"></a><span id="l41.1406" class="difflineplus">+   */</span>
<a href="#l41.1407"></a><span id="l41.1407" class="difflineplus">+  _setPaneStates: function mailTabType_setPaneStates(aLegalStates,</span>
<a href="#l41.1408"></a><span id="l41.1408" class="difflineplus">+                                                     aVisibleStates) {</span>
<a href="#l41.1409"></a><span id="l41.1409">     let layout = pref.getIntPref(&quot;mail.pane_config.dynamic&quot;);</span>
<a href="#l41.1410"></a><span id="l41.1410">     if (layout == kWidePaneConfig)</span>
<a href="#l41.1411"></a><span id="l41.1411">     {</span>
<a href="#l41.1412"></a><span id="l41.1412" class="difflineminus">-      document.getElementById(&quot;messengerBox&quot;).collapsed = collapse;</span>
<a href="#l41.1413"></a><span id="l41.1413" class="difflineminus">-      // If opening a standalone message, need to give the messagepanebox flex.</span>
<a href="#l41.1414"></a><span id="l41.1414" class="difflineminus">-      if (collapse)</span>
<a href="#l41.1415"></a><span id="l41.1415" class="difflineplus">+      // in the &quot;wide&quot; configuration, the #messengerBox is left holding the</span>
<a href="#l41.1416"></a><span id="l41.1416" class="difflineplus">+      //  folder pane and thread pane, and the message pane has migrated to be</span>
<a href="#l41.1417"></a><span id="l41.1417" class="difflineplus">+      //  its sibling (under #mailContent).</span>
<a href="#l41.1418"></a><span id="l41.1418" class="difflineplus">+      // Accordingly, if both the folder and thread panes are illegal, we</span>
<a href="#l41.1419"></a><span id="l41.1419" class="difflineplus">+      //  want to collapse the #messengerBox and make sure the #messagepanebox</span>
<a href="#l41.1420"></a><span id="l41.1420" class="difflineplus">+      //  fills up the screen.  (For example, when in &quot;message&quot; mode.)</span>
<a href="#l41.1421"></a><span id="l41.1421" class="difflineplus">+      let collapseMessengerBox = !aLegalStates.folder &amp;&amp; !aLegalStates.thread;</span>
<a href="#l41.1422"></a><span id="l41.1422" class="difflineplus">+      document.getElementById(&quot;messengerBox&quot;).collapsed = collapseMessengerBox;</span>
<a href="#l41.1423"></a><span id="l41.1423" class="difflineplus">+      if (collapseMessengerBox)</span>
<a href="#l41.1424"></a><span id="l41.1424">         document.getElementById(&quot;messagepanebox&quot;).flex = 1;</span>
<a href="#l41.1425"></a><span id="l41.1425">     }</span>
<a href="#l41.1426"></a><span id="l41.1426"> </span>
<a href="#l41.1427"></a><span id="l41.1427" class="difflineminus">-    if (layout == kVerticalPaneConfig)</span>
<a href="#l41.1428"></a><span id="l41.1428" class="difflineminus">-      document.getElementById(&quot;threadTree&quot;).collapsed = collapse;</span>
<a href="#l41.1429"></a><span id="l41.1429" class="difflineminus">-    else</span>
<a href="#l41.1430"></a><span id="l41.1430" class="difflineminus">-      document.getElementById(&quot;displayDeck&quot;).collapsed = collapse;</span>
<a href="#l41.1431"></a><span id="l41.1431" class="difflineminus">-</span>
<a href="#l41.1432"></a><span id="l41.1432" class="difflineminus">-    let fpSplitter = document.getElementById(&quot;folderpane_splitter&quot;);</span>
<a href="#l41.1433"></a><span id="l41.1433" class="difflineminus">-    if (show &amp;&amp; fpSplitter.getAttribute(&quot;state&quot;) == &quot;collapsed&quot;)</span>
<a href="#l41.1434"></a><span id="l41.1434" class="difflineminus">-    {</span>
<a href="#l41.1435"></a><span id="l41.1435" class="difflineminus">-      // If we're showing everything but the folder pane splitter was</span>
<a href="#l41.1436"></a><span id="l41.1436" class="difflineminus">-      // previously collapsed, then keep it collapsed.</span>
<a href="#l41.1437"></a><span id="l41.1437" class="difflineminus">-      // However, in the case of it being collapsed from showing a</span>
<a href="#l41.1438"></a><span id="l41.1438" class="difflineminus">-      // a full message in a tab, then uncollapse just the splitter.</span>
<a href="#l41.1439"></a><span id="l41.1439" class="difflineminus">-      if (fpSplitter.getAttribute(&quot;substate&quot;))</span>
<a href="#l41.1440"></a><span id="l41.1440" class="difflineminus">-        fpSplitter.collapsed = false;</span>
<a href="#l41.1441"></a><span id="l41.1441" class="difflineminus">-    }</span>
<a href="#l41.1442"></a><span id="l41.1442" class="difflineplus">+    // -- folder pane</span>
<a href="#l41.1443"></a><span id="l41.1443" class="difflineplus">+    // collapse the splitter when not legal</span>
<a href="#l41.1444"></a><span id="l41.1444" class="difflineplus">+    document.getElementById(&quot;folderpane_splitter&quot;).collapsed =</span>
<a href="#l41.1445"></a><span id="l41.1445" class="difflineplus">+      !aLegalStates.folder;</span>
<a href="#l41.1446"></a><span id="l41.1446" class="difflineplus">+    // collapse the folder pane when not visible</span>
<a href="#l41.1447"></a><span id="l41.1447" class="difflineplus">+    document.getElementById(&quot;folderPaneBox&quot;).collapsed =</span>
<a href="#l41.1448"></a><span id="l41.1448" class="difflineplus">+      !aLegalStates.folder || !aVisibleStates.folder;</span>
<a href="#l41.1449"></a><span id="l41.1449" class="difflineplus">+</span>
<a href="#l41.1450"></a><span id="l41.1450" class="difflineplus">+    // -- thread pane</span>
<a href="#l41.1451"></a><span id="l41.1451" class="difflineplus">+    // in a vertical view, the threadContentArea sits in the #threadPaneBox</span>
<a href="#l41.1452"></a><span id="l41.1452" class="difflineplus">+    //  next to the message pane and its splitter.</span>
<a href="#l41.1453"></a><span id="l41.1453" class="difflineplus">+    if (layout == kVerticalMailLayout)</span>
<a href="#l41.1454"></a><span id="l41.1454" class="difflineplus">+      document.getElementById(&quot;threadContentArea&quot;).collapsed =</span>
<a href="#l41.1455"></a><span id="l41.1455" class="difflineplus">+        !aLegalStates.thread;</span>
<a href="#l41.1456"></a><span id="l41.1456" class="difflineplus">+    // whereas in the default view, the displayDeck is the one next to the</span>
<a href="#l41.1457"></a><span id="l41.1457" class="difflineplus">+    //  message pane and its splitter</span>
<a href="#l41.1458"></a><span id="l41.1458">     else</span>
<a href="#l41.1459"></a><span id="l41.1459" class="difflineminus">-    {</span>
<a href="#l41.1460"></a><span id="l41.1460" class="difflineminus">-      fpSplitter.collapsed = collapse;</span>
<a href="#l41.1461"></a><span id="l41.1461" class="difflineminus">-      document.getElementById(&quot;folderPaneBox&quot;).collapsed = collapse;</span>
<a href="#l41.1462"></a><span id="l41.1462" class="difflineminus">-    }</span>
<a href="#l41.1463"></a><span id="l41.1463" class="difflineminus">-</span>
<a href="#l41.1464"></a><span id="l41.1464" class="difflineminus">-    let tpSplitter = document.getElementById(&quot;threadpane-splitter&quot;);</span>
<a href="#l41.1465"></a><span id="l41.1465" class="difflineminus">-    if (show &amp;&amp; tpSplitter.getAttribute(&quot;state&quot;) == &quot;collapsed&quot;)</span>
<a href="#l41.1466"></a><span id="l41.1466" class="difflineminus">-    {</span>
<a href="#l41.1467"></a><span id="l41.1467" class="difflineminus">-      // If we're showing everything but the thread pane splitter was</span>
<a href="#l41.1468"></a><span id="l41.1468" class="difflineminus">-      // previously collapsed, then keep it collapsed.</span>
<a href="#l41.1469"></a><span id="l41.1469" class="difflineminus">-      // However, in the case of it being collapsed from showing a</span>
<a href="#l41.1470"></a><span id="l41.1470" class="difflineminus">-      // a full message in a tab, then uncollapse just the splitter.</span>
<a href="#l41.1471"></a><span id="l41.1471" class="difflineminus">-      tpSplitter.collapsed = tpSplitter.getAttribute(&quot;substate&quot;) ? false : true;</span>
<a href="#l41.1472"></a><span id="l41.1472" class="difflineminus">-      document.getElementById(&quot;messagepanebox&quot;).collapsed = true;</span>
<a href="#l41.1473"></a><span id="l41.1473" class="difflineminus">-    }</span>
<a href="#l41.1474"></a><span id="l41.1474" class="difflineminus">-    else</span>
<a href="#l41.1475"></a><span id="l41.1475" class="difflineminus">-    {</span>
<a href="#l41.1476"></a><span id="l41.1476" class="difflineminus">-      tpSplitter.collapsed = collapse;</span>
<a href="#l41.1477"></a><span id="l41.1477" class="difflineminus">-      document.getElementById(&quot;messagepanebox&quot;).collapsed = false;</span>
<a href="#l41.1478"></a><span id="l41.1478" class="difflineminus">-    }</span>
<a href="#l41.1479"></a><span id="l41.1479" class="difflineminus">-    // Need to call ChangeMessagePaneVisibility() a little later after the</span>
<a href="#l41.1480"></a><span id="l41.1480" class="difflineminus">-    // message was selected so that the tab state data gets the message key</span>
<a href="#l41.1481"></a><span id="l41.1481" class="difflineminus">-    // saved off, which happens below in showTab().</span>
<a href="#l41.1482"></a><span id="l41.1482" class="difflineminus">-    setTimeout(ChangeMessagePaneVisibility, 0, IsMessagePaneCollapsed());</span>
<a href="#l41.1483"></a><span id="l41.1483" class="difflineminus">-</span>
<a href="#l41.1484"></a><span id="l41.1484" class="difflineplus">+      document.getElementById(&quot;displayDeck&quot;).collapsed =</span>
<a href="#l41.1485"></a><span id="l41.1485" class="difflineplus">+        !aLegalStates.thread;</span>
<a href="#l41.1486"></a><span id="l41.1486" class="difflineplus">+</span>
<a href="#l41.1487"></a><span id="l41.1487" class="difflineplus">+    // the threadpane-splitter collapses the message pane (arguably a misnomer),</span>
<a href="#l41.1488"></a><span id="l41.1488" class="difflineplus">+    //  but it only needs to exist when the thread-pane is legal</span>
<a href="#l41.1489"></a><span id="l41.1489" class="difflineplus">+    document.getElementById(&quot;threadpane-splitter&quot;).collapsed =</span>
<a href="#l41.1490"></a><span id="l41.1490" class="difflineplus">+      !aLegalStates.thread;</span>
<a href="#l41.1491"></a><span id="l41.1491" class="difflineplus">+</span>
<a href="#l41.1492"></a><span id="l41.1492" class="difflineplus">+    // Some things do not make sense if the thread pane is not legal.</span>
<a href="#l41.1493"></a><span id="l41.1493" class="difflineplus">+    // (This is likely an example of something that should be using the command</span>
<a href="#l41.1494"></a><span id="l41.1494" class="difflineplus">+    //  mechanism to update the UI elements as to the state of what the user</span>
<a href="#l41.1495"></a><span id="l41.1495" class="difflineplus">+    //  is looking at, rather than home-brewing it in here.)</span>
<a href="#l41.1496"></a><span id="l41.1496">     try {</span>
<a href="#l41.1497"></a><span id="l41.1497" class="difflineminus">-      document.getElementById(&quot;search-container&quot;).collapsed = collapse;</span>
<a href="#l41.1498"></a><span id="l41.1498" class="difflineplus">+      // you can't quick-search if you don't have a collection of messages</span>
<a href="#l41.1499"></a><span id="l41.1499" class="difflineplus">+      document.getElementById(&quot;search-container&quot;).collapsed =</span>
<a href="#l41.1500"></a><span id="l41.1500" class="difflineplus">+        !aLegalStates.thread;</span>
<a href="#l41.1501"></a><span id="l41.1501">     } catch (ex) {}</span>
<a href="#l41.1502"></a><span id="l41.1502">     try {</span>
<a href="#l41.1503"></a><span id="l41.1503" class="difflineminus">-      document.getElementById(&quot;mailviews-container&quot;).collapsed = collapse;</span>
<a href="#l41.1504"></a><span id="l41.1504" class="difflineplus">+      // views only work on the thread pane; no thread pane, no views</span>
<a href="#l41.1505"></a><span id="l41.1505" class="difflineplus">+      document.getElementById(&quot;mailviews-container&quot;).collapsed =</span>
<a href="#l41.1506"></a><span id="l41.1506" class="difflineplus">+        !aLegalStates.thread;</span>
<a href="#l41.1507"></a><span id="l41.1507">     } catch (ex) {}</span>
<a href="#l41.1508"></a><span id="l41.1508" class="difflineminus">-  },</span>
<a href="#l41.1509"></a><span id="l41.1509" class="difflineminus">-</span>
<a href="#l41.1510"></a><span id="l41.1510" class="difflineminus">-  _folderAndThreadPaneVisible: true,</span>
<a href="#l41.1511"></a><span id="l41.1511" class="difflineminus">-  get folderAndThreadPaneVisible() { return this._folderAndThreadPaneVisible; },</span>
<a href="#l41.1512"></a><span id="l41.1512" class="difflineminus">-  set folderAndThreadPaneVisible(aDesiredVisible) {</span>
<a href="#l41.1513"></a><span id="l41.1513" class="difflineminus">-    if (aDesiredVisible != this._folderAndThreadPaneVisible) {</span>
<a href="#l41.1514"></a><span id="l41.1514" class="difflineminus">-      this._displayFolderAndThreadPane(aDesiredVisible);</span>
<a href="#l41.1515"></a><span id="l41.1515" class="difflineminus">-      this._folderAndThreadPaneVisible = aDesiredVisible;</span>
<a href="#l41.1516"></a><span id="l41.1516" class="difflineminus">-    }</span>
<a href="#l41.1517"></a><span id="l41.1517" class="difflineplus">+</span>
<a href="#l41.1518"></a><span id="l41.1518" class="difflineplus">+    // -- message pane</span>
<a href="#l41.1519"></a><span id="l41.1519" class="difflineplus">+    // the message pane can only be collapsed when the thread pane is legal</span>
<a href="#l41.1520"></a><span id="l41.1520" class="difflineplus">+    document.getElementById(&quot;messagepanebox&quot;).collapsed =</span>
<a href="#l41.1521"></a><span id="l41.1521" class="difflineplus">+      aLegalStates.thread &amp;&amp; !aVisibleStates.message;</span>
<a href="#l41.1522"></a><span id="l41.1522" class="difflineplus">+</span>
<a href="#l41.1523"></a><span id="l41.1523" class="difflineplus">+    // -- gloda facets</span>
<a href="#l41.1524"></a><span id="l41.1524" class="difflineplus">+    //document.getElementById(&quot;glodaSearchFacets&quot;).hidden =</span>
<a href="#l41.1525"></a><span id="l41.1525" class="difflineplus">+    //  !aLegalStates.glodaFacets;</span>
<a href="#l41.1526"></a><span id="l41.1526">   },</span>
<a href="#l41.1527"></a><span id="l41.1527"> </span>
<a href="#l41.1528"></a><span id="l41.1528">   showTab: function(aTab) {</span>
<a href="#l41.1529"></a><span id="l41.1529">     // Set the messagepane as the primary browser for content.</span>
<a href="#l41.1530"></a><span id="l41.1530">     document.getElementById(&quot;messagepane&quot;).setAttribute(&quot;type&quot;,</span>
<a href="#l41.1531"></a><span id="l41.1531">                                                         &quot;content-primary&quot;);</span>
<a href="#l41.1532"></a><span id="l41.1532"> </span>
<a href="#l41.1533"></a><span id="l41.1533" class="difflineminus">-    // restore globals</span>
<a href="#l41.1534"></a><span id="l41.1534" class="difflineminus">-    messenger = aTab.messenger;</span>
<a href="#l41.1535"></a><span id="l41.1535" class="difflineminus">-    gDBView = aTab.dbView;</span>
<a href="#l41.1536"></a><span id="l41.1536" class="difflineminus">-    gSearchSession = aTab.searchSession;</span>
<a href="#l41.1537"></a><span id="l41.1537" class="difflineminus">-</span>
<a href="#l41.1538"></a><span id="l41.1538" class="difflineminus">-    // restore selection in folder pane;</span>
<a href="#l41.1539"></a><span id="l41.1539" class="difflineminus">-    let folderToSelect = gDBView ? gDBView.msgFolder : aTab.msgSelectedFolder;</span>
<a href="#l41.1540"></a><span id="l41.1540" class="difflineminus">-    // restore view state if we had one</span>
<a href="#l41.1541"></a><span id="l41.1541" class="difflineminus">-    var row = gFolderTreeView.getIndexOfFolder(folderToSelect);</span>
<a href="#l41.1542"></a><span id="l41.1542" class="difflineminus">-</span>
<a href="#l41.1543"></a><span id="l41.1543" class="difflineminus">-    var treeBoxObj = document.getElementById(&quot;folderTree&quot;).treeBoxObject;</span>
<a href="#l41.1544"></a><span id="l41.1544" class="difflineminus">-    var folderTreeSelection = treeBoxObj.view.selection;</span>
<a href="#l41.1545"></a><span id="l41.1545" class="difflineminus">-    // make sure that row.value is valid so that it doesn't mess up</span>
<a href="#l41.1546"></a><span id="l41.1546" class="difflineminus">-    // the call to ensureRowIsVisible().</span>
<a href="#l41.1547"></a><span id="l41.1547" class="difflineminus">-    if ((row &gt;= 0) &amp;&amp; !folderTreeSelection.isSelected(row))</span>
<a href="#l41.1548"></a><span id="l41.1548" class="difflineminus">-    {</span>
<a href="#l41.1549"></a><span id="l41.1549" class="difflineminus">-      gMsgFolderSelected = folderToSelect;</span>
<a href="#l41.1550"></a><span id="l41.1550" class="difflineminus">-      folderTreeSelection.selectEventsSuppressed = true;</span>
<a href="#l41.1551"></a><span id="l41.1551" class="difflineminus">-      folderTreeSelection.select(row);</span>
<a href="#l41.1552"></a><span id="l41.1552" class="difflineminus">-      treeBoxObj.ensureRowIsVisible(row);</span>
<a href="#l41.1553"></a><span id="l41.1553" class="difflineminus">-      folderTreeSelection.selectEventsSuppressed = false;</span>
<a href="#l41.1554"></a><span id="l41.1554" class="difflineminus">-    }</span>
<a href="#l41.1555"></a><span id="l41.1555" class="difflineminus">-    if (gDBView)</span>
<a href="#l41.1556"></a><span id="l41.1556" class="difflineminus">-    {</span>
<a href="#l41.1557"></a><span id="l41.1557" class="difflineminus">-      UpdateColumnsForView(gMsgFolderSelected, gDBView.viewType);</span>
<a href="#l41.1558"></a><span id="l41.1558" class="difflineminus">-      UpdateSortIndicators(gDBView.sortType, gDBView.sortOrder);</span>
<a href="#l41.1559"></a><span id="l41.1559" class="difflineminus">-      // This sets the thread pane tree's view to the gDBView view.</span>
<a href="#l41.1560"></a><span id="l41.1560" class="difflineminus">-      RerootThreadPane();</span>
<a href="#l41.1561"></a><span id="l41.1561" class="difflineminus">-      // Only refresh the view picker if the views toolbar is visible.</span>
<a href="#l41.1562"></a><span id="l41.1562" class="difflineminus">-      if (document.getElementById(&quot;mailviews-container&quot;)) </span>
<a href="#l41.1563"></a><span id="l41.1563" class="difflineminus">-        UpdateViewPickerByValue(aTab.mailView);</span>
<a href="#l41.1564"></a><span id="l41.1564" class="difflineminus">-</span>
<a href="#l41.1565"></a><span id="l41.1565" class="difflineminus">-      // We need to restore the selection to what it was when we switched away</span>
<a href="#l41.1566"></a><span id="l41.1566" class="difflineminus">-      // from this tab. We need to remember the selected keys, instead of the</span>
<a href="#l41.1567"></a><span id="l41.1567" class="difflineminus">-      // selected indices, since the view might have changed. But maybe the</span>
<a href="#l41.1568"></a><span id="l41.1568" class="difflineminus">-      // selectedIndices adjust as items are added/removed from the (hidden)</span>
<a href="#l41.1569"></a><span id="l41.1569" class="difflineminus">-      // view.</span>
<a href="#l41.1570"></a><span id="l41.1570" class="difflineminus">-      try</span>
<a href="#l41.1571"></a><span id="l41.1571" class="difflineminus">-      {</span>
<a href="#l41.1572"></a><span id="l41.1572" class="difflineminus">-        if (aTab.selectedMsgId &amp;&amp; aTab.msgSelectedFolder)</span>
<a href="#l41.1573"></a><span id="l41.1573" class="difflineminus">-        {</span>
<a href="#l41.1574"></a><span id="l41.1574" class="difflineminus">-          // We clear the selection in order to generate an event when we</span>
<a href="#l41.1575"></a><span id="l41.1575" class="difflineminus">-          // re-select our message.</span>
<a href="#l41.1576"></a><span id="l41.1576" class="difflineminus">-          ClearThreadPaneSelection();</span>
<a href="#l41.1577"></a><span id="l41.1577" class="difflineminus">-</span>
<a href="#l41.1578"></a><span id="l41.1578" class="difflineminus">-          var msgDB = aTab.msgSelectedFolder.msgDatabase;</span>
<a href="#l41.1579"></a><span id="l41.1579" class="difflineminus">-          var msgHdr = msgDB.getMsgHdrForMessageID(aTab.selectedMsgId);</span>
<a href="#l41.1580"></a><span id="l41.1580" class="difflineminus">-          setTimeout(gDBView.selectFolderMsgByKey, 0, aTab.msgSelectedFolder,</span>
<a href="#l41.1581"></a><span id="l41.1581" class="difflineminus">-                     msgHdr.messageKey);</span>
<a href="#l41.1582"></a><span id="l41.1582" class="difflineminus">-        }</span>
<a href="#l41.1583"></a><span id="l41.1583" class="difflineminus">-        // We do not clear the selection if there was more than one message</span>
<a href="#l41.1584"></a><span id="l41.1584" class="difflineminus">-        // displayed.  this leaves our selection intact. there was originally</span>
<a href="#l41.1585"></a><span id="l41.1585" class="difflineminus">-        // some claim that the selection might lose synchronization with the</span>
<a href="#l41.1586"></a><span id="l41.1586" class="difflineminus">-        // view, but this is unsubstantiated.  said comment came from the</span>
<a href="#l41.1587"></a><span id="l41.1587" class="difflineminus">-        // original code that stored information on the selected rows, but</span>
<a href="#l41.1588"></a><span id="l41.1588" class="difflineminus">-        // then failed to do anything with it, probably because there is no</span>
<a href="#l41.1589"></a><span id="l41.1589" class="difflineminus">-        // existing API call that accomplishes it.</span>
<a href="#l41.1590"></a><span id="l41.1590" class="difflineplus">+    aTab.folderDisplay.makeActive();</span>
<a href="#l41.1591"></a><span id="l41.1591" class="difflineplus">+</span>
<a href="#l41.1592"></a><span id="l41.1592" class="difflineplus">+    // - restore folder pane/tree selection</span>
<a href="#l41.1593"></a><span id="l41.1593" class="difflineplus">+    if (aTab.folderDisplay.displayedFolder) {</span>
<a href="#l41.1594"></a><span id="l41.1594" class="difflineplus">+      // but don't generate any events while doing so!</span>
<a href="#l41.1595"></a><span id="l41.1595" class="difflineplus">+      gFolderTreeView.selection.selectEventsSuppressed = true;</span>
<a href="#l41.1596"></a><span id="l41.1596" class="difflineplus">+      try {</span>
<a href="#l41.1597"></a><span id="l41.1597" class="difflineplus">+        gFolderTreeView.selectFolder(aTab.folderDisplay.displayedFolder);</span>
<a href="#l41.1598"></a><span id="l41.1598">       }</span>
<a href="#l41.1599"></a><span id="l41.1599" class="difflineminus">-      catch (ex) {dump(ex);}</span>
<a href="#l41.1600"></a><span id="l41.1600" class="difflineminus">-</span>
<a href="#l41.1601"></a><span id="l41.1601" class="difflineminus">-      document.getElementById(&quot;threadTree&quot;).treeBoxObject.scrollToRow(aTab.firstVisibleRow);</span>
<a href="#l41.1602"></a><span id="l41.1602" class="difflineminus">-      ShowThreadPane();</span>
<a href="#l41.1603"></a><span id="l41.1603" class="difflineminus">-    }</span>
<a href="#l41.1604"></a><span id="l41.1604" class="difflineminus">-    else if (gMsgFolderSelected.isServer)</span>
<a href="#l41.1605"></a><span id="l41.1605" class="difflineminus">-    {</span>
<a href="#l41.1606"></a><span id="l41.1606" class="difflineminus">-      UpdateStatusQuota(null);</span>
<a href="#l41.1607"></a><span id="l41.1607" class="difflineminus">-      // Load AccountCentral page here.</span>
<a href="#l41.1608"></a><span id="l41.1608" class="difflineminus">-      ShowAccountCentral();</span>
<a href="#l41.1609"></a><span id="l41.1609" class="difflineplus">+      finally {</span>
<a href="#l41.1610"></a><span id="l41.1610" class="difflineplus">+        gIgnoreSyntheticFolderPaneSelectionChange = true;</span>
<a href="#l41.1611"></a><span id="l41.1611" class="difflineplus">+        gFolderTreeView.selection.selectEventsSuppressed = false;</span>
<a href="#l41.1612"></a><span id="l41.1612" class="difflineplus">+      }</span>
<a href="#l41.1613"></a><span id="l41.1613">     }</span>
<a href="#l41.1614"></a><span id="l41.1614">   },</span>
<a href="#l41.1615"></a><span id="l41.1615"> </span>
<a href="#l41.1616"></a><span id="l41.1616">   supportsCommand: function(aTab, aCommand) {</span>
<a href="#l41.1617"></a><span id="l41.1617">     return DefaultController.supportsCommand(aCommand);</span>
<a href="#l41.1618"></a><span id="l41.1618">   },</span>
<a href="#l41.1619"></a><span id="l41.1619"> </span>
<a href="#l41.1620"></a><span id="l41.1620">   isCommandEnabled: function(aTab, aCommand) {</span>
<a href="#l41.1621"></a><span id="l41.1621" class="difflineat">@@ -1912,90 +1971,64 @@ let mailTabType = {</span>
<a href="#l41.1622"></a><span id="l41.1622"> function MsgOpenNewWindowForFolder(folderURI, msgKeyToSelect)</span>
<a href="#l41.1623"></a><span id="l41.1623"> {</span>
<a href="#l41.1624"></a><span id="l41.1624">   if (folderURI) {</span>
<a href="#l41.1625"></a><span id="l41.1625">     window.openDialog(&quot;chrome://messenger/content/&quot;, &quot;_blank&quot;,</span>
<a href="#l41.1626"></a><span id="l41.1626">                       &quot;chrome,all,dialog=no&quot;, folderURI, msgKeyToSelect);</span>
<a href="#l41.1627"></a><span id="l41.1627">     return;</span>
<a href="#l41.1628"></a><span id="l41.1628">   }</span>
<a href="#l41.1629"></a><span id="l41.1629"> </span>
<a href="#l41.1630"></a><span id="l41.1630" class="difflineminus">-  // Use gFolderTreeView.getSelectedFolders() to find out which folder to open</span>
<a href="#l41.1631"></a><span id="l41.1631" class="difflineminus">-  // instead of GetLoadedMsgFolder().URI. This is required because on a</span>
<a href="#l41.1632"></a><span id="l41.1632" class="difflineminus">-  // right-click, the currentIndex value will be different from the actual row</span>
<a href="#l41.1633"></a><span id="l41.1633" class="difflineminus">-  // that is highlighted. gFolderTreeView.getSelectedFolders() will return the</span>
<a href="#l41.1634"></a><span id="l41.1634" class="difflineminus">-  // folder that is highlighted.</span>
<a href="#l41.1635"></a><span id="l41.1635" class="difflineplus">+  // If there is a right-click happening, gFolderTreeView.getSelectedFolders()</span>
<a href="#l41.1636"></a><span id="l41.1636" class="difflineplus">+  // will tell us about it (while the selection's currentIndex would reflect</span>
<a href="#l41.1637"></a><span id="l41.1637" class="difflineplus">+  // the node that was selected/displayed before the right-click.)</span>
<a href="#l41.1638"></a><span id="l41.1638">   let selectedFolders = gFolderTreeView.getSelectedFolders();</span>
<a href="#l41.1639"></a><span id="l41.1639">   for (let i = 0; i &lt; selectedFolders.length; i++) {</span>
<a href="#l41.1640"></a><span id="l41.1640">     window.openDialog(&quot;chrome://messenger/content/&quot;, &quot;_blank&quot;,</span>
<a href="#l41.1641"></a><span id="l41.1641">                       &quot;chrome,all,dialog=no&quot;,</span>
<a href="#l41.1642"></a><span id="l41.1642">                       selectedFolders[i].URI, msgKeyToSelect);</span>
<a href="#l41.1643"></a><span id="l41.1643">   }</span>
<a href="#l41.1644"></a><span id="l41.1644"> }</span>
<a href="#l41.1645"></a><span id="l41.1645"> </span>
<a href="#l41.1646"></a><span id="l41.1646" class="difflineminus">-function MsgOpenNewTabForFolder(folderURI, msgKeyToSelect)</span>
<a href="#l41.1647"></a><span id="l41.1647" class="difflineplus">+/**</span>
<a href="#l41.1648"></a><span id="l41.1648" class="difflineplus">+ * UI-triggered command to open the currently selected folder(s) in new tabs.</span>
<a href="#l41.1649"></a><span id="l41.1649" class="difflineplus">+ */</span>
<a href="#l41.1650"></a><span id="l41.1650" class="difflineplus">+function MsgOpenNewTabForFolder()</span>
<a href="#l41.1651"></a><span id="l41.1651"> {</span>
<a href="#l41.1652"></a><span id="l41.1652" class="difflineminus">-  // XXX implement the usage of msgKeyToSelect...</span>
<a href="#l41.1653"></a><span id="l41.1653" class="difflineminus">-  if (folderURI) {</span>
<a href="#l41.1654"></a><span id="l41.1654" class="difflineminus">-    document.getElementById(&quot;tabmail&quot;).openTab(&quot;folder&quot;, folderURI);</span>
<a href="#l41.1655"></a><span id="l41.1655" class="difflineminus">-    return;</span>
<a href="#l41.1656"></a><span id="l41.1656" class="difflineminus">-  }</span>
<a href="#l41.1657"></a><span id="l41.1657" class="difflineminus">-</span>
<a href="#l41.1658"></a><span id="l41.1658" class="difflineminus">-  // Use gFolderTreeView.getSelectedFolders() to find out which folder to open</span>
<a href="#l41.1659"></a><span id="l41.1659" class="difflineminus">-  // instead of GetLoadedMsgFolder().URI. This is required because on a</span>
<a href="#l41.1660"></a><span id="l41.1660" class="difflineminus">-  // right-click, the currentIndex value will be different from the actual row</span>
<a href="#l41.1661"></a><span id="l41.1661" class="difflineminus">-  // that is highlighted. gFolderTreeView.getSelectedFolders() will return the</span>
<a href="#l41.1662"></a><span id="l41.1662" class="difflineminus">-  // folder that is highlighted.</span>
<a href="#l41.1663"></a><span id="l41.1663" class="difflineplus">+  // If there is a right-click happening, gFolderTreeView.getSelectedFolders()</span>
<a href="#l41.1664"></a><span id="l41.1664" class="difflineplus">+  // will tell us about it (while the selection's currentIndex would reflect</span>
<a href="#l41.1665"></a><span id="l41.1665" class="difflineplus">+  // the node that was selected/displayed before the right-click.)</span>
<a href="#l41.1666"></a><span id="l41.1666">   let selectedFolders = gFolderTreeView.getSelectedFolders();</span>
<a href="#l41.1667"></a><span id="l41.1667">   for (let i = 0; i &lt; selectedFolders.length; i++) {</span>
<a href="#l41.1668"></a><span id="l41.1668" class="difflineminus">-    // Set up the first tab, which was previously invisible.</span>
<a href="#l41.1669"></a><span id="l41.1669" class="difflineminus">-    // This assumes the first tab is always a 3-pane ui, which</span>
<a href="#l41.1670"></a><span id="l41.1670" class="difflineminus">-    // may not be right, especially if we have the ability</span>
<a href="#l41.1671"></a><span id="l41.1671" class="difflineminus">-    // to persist your tab setup.</span>
<a href="#l41.1672"></a><span id="l41.1672" class="difflineminus">-    document.getElementById(&quot;tabmail&quot;).openTab(&quot;folder&quot;, selectedFolders[i].URI);</span>
<a href="#l41.1673"></a><span id="l41.1673" class="difflineplus">+    document.getElementById(&quot;tabmail&quot;).openTab(&quot;folder&quot;, selectedFolders[i]);</span>
<a href="#l41.1674"></a><span id="l41.1674">   }</span>
<a href="#l41.1675"></a><span id="l41.1675"> }</span>
<a href="#l41.1676"></a><span id="l41.1676"> </span>
<a href="#l41.1677"></a><span id="l41.1677" class="difflineminus">-function MsgOpenNewTabForMessage(messageKey, folderUri)</span>
<a href="#l41.1678"></a><span id="l41.1678" class="difflineplus">+/**</span>
<a href="#l41.1679"></a><span id="l41.1679" class="difflineplus">+ * UI-triggered command to open the currently selected message in a new tab.</span>
<a href="#l41.1680"></a><span id="l41.1680" class="difflineplus">+ */</span>
<a href="#l41.1681"></a><span id="l41.1681" class="difflineplus">+function MsgOpenNewTabForMessage()</span>
<a href="#l41.1682"></a><span id="l41.1682"> {</span>
<a href="#l41.1683"></a><span id="l41.1683" class="difflineminus">-  var hdr;</span>
<a href="#l41.1684"></a><span id="l41.1684" class="difflineminus">-</span>
<a href="#l41.1685"></a><span id="l41.1685" class="difflineminus">-  // messageKey can be 0 for an actual message (first message in the folder)  </span>
<a href="#l41.1686"></a><span id="l41.1686" class="difflineminus">-  if (folderUri)</span>
<a href="#l41.1687"></a><span id="l41.1687" class="difflineminus">-  {</span>
<a href="#l41.1688"></a><span id="l41.1688" class="difflineminus">-    hdr = GetMsgFolderFromUri(folderUri).GetMessageHeader(messageKey);</span>
<a href="#l41.1689"></a><span id="l41.1689" class="difflineminus">-  }</span>
<a href="#l41.1690"></a><span id="l41.1690" class="difflineminus">-  else</span>
<a href="#l41.1691"></a><span id="l41.1691" class="difflineminus">-  {</span>
<a href="#l41.1692"></a><span id="l41.1692" class="difflineminus">-    hdr = gDBView.hdrForFirstSelectedMessage;</span>
<a href="#l41.1693"></a><span id="l41.1693" class="difflineminus">-    // Use the header's folder - this will open a msg in a virtual folder view</span>
<a href="#l41.1694"></a><span id="l41.1694" class="difflineminus">-    // in its real folder, which is needed if the msg wouldn't be in a new</span>
<a href="#l41.1695"></a><span id="l41.1695" class="difflineminus">-    // view with the same terms - e.g., it's read and the view is unread only.</span>
<a href="#l41.1696"></a><span id="l41.1696" class="difflineminus">-    // If we cloned the view, we wouldn't have to do this.</span>
<a href="#l41.1697"></a><span id="l41.1697" class="difflineminus">-    folderUri = hdr.folder.URI;</span>
<a href="#l41.1698"></a><span id="l41.1698" class="difflineminus">-  }</span>
<a href="#l41.1699"></a><span id="l41.1699" class="difflineminus">-  </span>
<a href="#l41.1700"></a><span id="l41.1700" class="difflineminus">-  // Fix it so we won't try to load the previously loaded message.</span>
<a href="#l41.1701"></a><span id="l41.1701" class="difflineminus">-  hdr.folder.lastMessageLoaded = nsMsgKey_None;</span>
<a href="#l41.1702"></a><span id="l41.1702" class="difflineminus">-</span>
<a href="#l41.1703"></a><span id="l41.1703" class="difflineminus">-  document.getElementById('tabmail').openTab(&quot;message&quot;, folderUri, hdr);</span>
<a href="#l41.1704"></a><span id="l41.1704" class="difflineplus">+  if (!gFolderDisplay.selectedMessage)</span>
<a href="#l41.1705"></a><span id="l41.1705" class="difflineplus">+    return;</span>
<a href="#l41.1706"></a><span id="l41.1706" class="difflineplus">+  document.getElementById('tabmail').openTab(&quot;message&quot;,</span>
<a href="#l41.1707"></a><span id="l41.1707" class="difflineplus">+                                             gFolderDisplay.selectedMessage,</span>
<a href="#l41.1708"></a><span id="l41.1708" class="difflineplus">+                                             gFolderDisplay.view);</span>
<a href="#l41.1709"></a><span id="l41.1709"> }</span>
<a href="#l41.1710"></a><span id="l41.1710"> </span>
<a href="#l41.1711"></a><span id="l41.1711"> function MsgOpenSelectedMessages()</span>
<a href="#l41.1712"></a><span id="l41.1712"> {</span>
<a href="#l41.1713"></a><span id="l41.1713">   // Toggle message body (rss summary) and content-base url in message</span>
<a href="#l41.1714"></a><span id="l41.1714">   // pane per pref, otherwise open summary or web page in new window.</span>
<a href="#l41.1715"></a><span id="l41.1715" class="difflineminus">-  if (IsFeedItem() &amp;&amp; GetFeedOpenHandler() == 2) {</span>
<a href="#l41.1716"></a><span id="l41.1716" class="difflineplus">+  if (gFolderDisplay.selectedMessageIsFeed &amp;&amp; GetFeedOpenHandler() == 2) {</span>
<a href="#l41.1717"></a><span id="l41.1717">     FeedSetContentViewToggle();</span>
<a href="#l41.1718"></a><span id="l41.1718">     return;</span>
<a href="#l41.1719"></a><span id="l41.1719">   }</span>
<a href="#l41.1720"></a><span id="l41.1720"> </span>
<a href="#l41.1721"></a><span id="l41.1721" class="difflineminus">-  var dbView = GetDBView();</span>
<a href="#l41.1722"></a><span id="l41.1722" class="difflineminus">-</span>
<a href="#l41.1723"></a><span id="l41.1723" class="difflineminus">-  var indices = GetSelectedIndices(dbView);</span>
<a href="#l41.1724"></a><span id="l41.1724" class="difflineminus">-  var numMessages = indices.length;</span>
<a href="#l41.1725"></a><span id="l41.1725" class="difflineplus">+  let selectedMessages = gFolderDisplay.selectedMessages;</span>
<a href="#l41.1726"></a><span id="l41.1726" class="difflineplus">+  var numMessages = selectedMessages.length;</span>
<a href="#l41.1727"></a><span id="l41.1727"> </span>
<a href="#l41.1728"></a><span id="l41.1728">   var windowReuse = gPrefBranch.getBoolPref(&quot;mailnews.reuse_message_window&quot;);</span>
<a href="#l41.1729"></a><span id="l41.1729">   // This is a radio type button pref, currently with only 2 buttons.</span>
<a href="#l41.1730"></a><span id="l41.1730">   // We need to keep the pref type as 'bool' for backwards compatibility</span>
<a href="#l41.1731"></a><span id="l41.1731">   // with 4.x migrated prefs.  For future radio button(s), please use another</span>
<a href="#l41.1732"></a><span id="l41.1732">   // pref (either 'bool' or 'int' type) to describe it.</span>
<a href="#l41.1733"></a><span id="l41.1733">   //</span>
<a href="#l41.1734"></a><span id="l41.1734">   // windowReuse values: false, true</span>
<a href="#l41.1735"></a><span id="l41.1735" class="difflineat">@@ -2013,55 +2046,37 @@ function MsgOpenSelectedMessages()</span>
<a href="#l41.1736"></a><span id="l41.1736">     var text = gMessengerBundle.getFormattedString(&quot;openWindowWarningText&quot;, [numMessages]);</span>
<a href="#l41.1737"></a><span id="l41.1737">     var promptService = Components.classes[&quot;@mozilla.org/embedcomp/prompt-service;1&quot;]</span>
<a href="#l41.1738"></a><span id="l41.1738">                                   .getService(Components.interfaces.nsIPromptService);</span>
<a href="#l41.1739"></a><span id="l41.1739">     if (!promptService.confirm(window, title, text))</span>
<a href="#l41.1740"></a><span id="l41.1740">       return;</span>
<a href="#l41.1741"></a><span id="l41.1741">   }</span>
<a href="#l41.1742"></a><span id="l41.1742"> </span>
<a href="#l41.1743"></a><span id="l41.1743">   for (var i = 0; i &lt; numMessages; i++) {</span>
<a href="#l41.1744"></a><span id="l41.1744" class="difflineminus">-    MsgOpenNewWindowForMessage(dbView.getURIForViewIndex(indices[i]),</span>
<a href="#l41.1745"></a><span id="l41.1745" class="difflineminus">-                               dbView.getFolderForViewIndex(indices[i]).URI);</span>
<a href="#l41.1746"></a><span id="l41.1746" class="difflineplus">+    MsgOpenNewWindowForMessage(selectedMessages[i]);</span>
<a href="#l41.1747"></a><span id="l41.1747">   }</span>
<a href="#l41.1748"></a><span id="l41.1748"> }</span>
<a href="#l41.1749"></a><span id="l41.1749"> </span>
<a href="#l41.1750"></a><span id="l41.1750"> function MsgOpenSelectedMessageInExistingWindow()</span>
<a href="#l41.1751"></a><span id="l41.1751"> {</span>
<a href="#l41.1752"></a><span id="l41.1752">   var windowID = GetWindowByWindowType(&quot;mail:messageWindow&quot;);</span>
<a href="#l41.1753"></a><span id="l41.1753">   if (!windowID)</span>
<a href="#l41.1754"></a><span id="l41.1754">     return false;</span>
<a href="#l41.1755"></a><span id="l41.1755"> </span>
<a href="#l41.1756"></a><span id="l41.1756" class="difflineminus">-  try {</span>
<a href="#l41.1757"></a><span id="l41.1757" class="difflineminus">-    var messageURI = gDBView.URIForFirstSelectedMessage;</span>
<a href="#l41.1758"></a><span id="l41.1758" class="difflineminus">-    var msgHdr = gDBView.hdrForFirstSelectedMessage;</span>
<a href="#l41.1759"></a><span id="l41.1759" class="difflineminus">-</span>
<a href="#l41.1760"></a><span id="l41.1760" class="difflineminus">-    // Reset the window's message uri and folder uri vars, and</span>
<a href="#l41.1761"></a><span id="l41.1761" class="difflineminus">-    // update the command handlers to what's going to be used.</span>
<a href="#l41.1762"></a><span id="l41.1762" class="difflineminus">-    // This has to be done before the call to CreateView().</span>
<a href="#l41.1763"></a><span id="l41.1763" class="difflineminus">-    windowID.gCurrentMessageUri = messageURI;</span>
<a href="#l41.1764"></a><span id="l41.1764" class="difflineminus">-    windowID.gCurrentFolderUri = msgHdr.folder.URI;</span>
<a href="#l41.1765"></a><span id="l41.1765" class="difflineminus">-    windowID.UpdateMailToolbar('MsgOpenExistingWindowForMessage');</span>
<a href="#l41.1766"></a><span id="l41.1766" class="difflineminus">-</span>
<a href="#l41.1767"></a><span id="l41.1767" class="difflineminus">-    // Even if the folder uri's match, we can't use the existing view</span>
<a href="#l41.1768"></a><span id="l41.1768" class="difflineminus">-    // (msgHdr.folder.URI == windowID.gCurrentFolderUri)</span>
<a href="#l41.1769"></a><span id="l41.1769" class="difflineminus">-    // - the reason is quick search and mail views. See bug #187673.</span>
<a href="#l41.1770"></a><span id="l41.1770" class="difflineminus">-    //</span>
<a href="#l41.1771"></a><span id="l41.1771" class="difflineminus">-    // For the sake of simplicity, let's always call CreateView(gDBView);</span>
<a href="#l41.1772"></a><span id="l41.1772" class="difflineminus">-    // which will clone gDBView.</span>
<a href="#l41.1773"></a><span id="l41.1773" class="difflineminus">-    windowID.CreateView(gDBView);</span>
<a href="#l41.1774"></a><span id="l41.1774" class="difflineminus">-    windowID.LoadMessageByMsgKey(msgHdr.messageKey);</span>
<a href="#l41.1775"></a><span id="l41.1775" class="difflineminus">-</span>
<a href="#l41.1776"></a><span id="l41.1776" class="difflineminus">-    // bring existing window to front</span>
<a href="#l41.1777"></a><span id="l41.1777" class="difflineminus">-    windowID.focus();</span>
<a href="#l41.1778"></a><span id="l41.1778" class="difflineminus">-    return true;</span>
<a href="#l41.1779"></a><span id="l41.1779" class="difflineminus">-  }</span>
<a href="#l41.1780"></a><span id="l41.1780" class="difflineminus">-  catch (ex) {</span>
<a href="#l41.1781"></a><span id="l41.1781" class="difflineminus">-    dump(&quot;reusing existing standalone message window failed: &quot; + ex + &quot;\n&quot;);</span>
<a href="#l41.1782"></a><span id="l41.1782" class="difflineminus">-  }</span>
<a href="#l41.1783"></a><span id="l41.1783" class="difflineminus">-  return false;</span>
<a href="#l41.1784"></a><span id="l41.1784" class="difflineplus">+  var msgHdr = gFolderDisplay.selectedMessage;</span>
<a href="#l41.1785"></a><span id="l41.1785" class="difflineplus">+</span>
<a href="#l41.1786"></a><span id="l41.1786" class="difflineplus">+  // (future work: perhaps make the window have a method we can call to do this)</span>
<a href="#l41.1787"></a><span id="l41.1787" class="difflineplus">+  // make the window's folder clone our view</span>
<a href="#l41.1788"></a><span id="l41.1788" class="difflineplus">+  windowID.gFolderDisplay.cloneView(gFolderDisplay.view);</span>
<a href="#l41.1789"></a><span id="l41.1789" class="difflineplus">+  // boss the window into showing our message</span>
<a href="#l41.1790"></a><span id="l41.1790" class="difflineplus">+  windowID.gFolderDisplay.selectMessage(msgHdr);</span>
<a href="#l41.1791"></a><span id="l41.1791" class="difflineplus">+</span>
<a href="#l41.1792"></a><span id="l41.1792" class="difflineplus">+  // bring existing window to front</span>
<a href="#l41.1793"></a><span id="l41.1793" class="difflineplus">+  windowID.focus();</span>
<a href="#l41.1794"></a><span id="l41.1794" class="difflineplus">+  return true;</span>
<a href="#l41.1795"></a><span id="l41.1795"> }</span>
<a href="#l41.1796"></a><span id="l41.1796"> </span>
<a href="#l41.1797"></a><span id="l41.1797"> function MsgOpenFromFile()</span>
<a href="#l41.1798"></a><span id="l41.1798"> {</span>
<a href="#l41.1799"></a><span id="l41.1799">   const nsIFilePicker = Components.interfaces.nsIFilePicker;</span>
<a href="#l41.1800"></a><span id="l41.1800">   var fp = Components.classes[&quot;@mozilla.org/filepicker;1&quot;]</span>
<a href="#l41.1801"></a><span id="l41.1801">                      .createInstance(nsIFilePicker);</span>
<a href="#l41.1802"></a><span id="l41.1802"> </span>
<a href="#l41.1803"></a><span id="l41.1803" class="difflineat">@@ -2086,106 +2101,92 @@ function MsgOpenFromFile()</span>
<a href="#l41.1804"></a><span id="l41.1804">     dump(&quot;filePicker.chooseInputFile threw an exception\n&quot;);</span>
<a href="#l41.1805"></a><span id="l41.1805">     return;</span>
<a href="#l41.1806"></a><span id="l41.1806">   }</span>
<a href="#l41.1807"></a><span id="l41.1807"> </span>
<a href="#l41.1808"></a><span id="l41.1808">   var uri = fp.fileURL.QueryInterface(Components.interfaces.nsIURL);</span>
<a href="#l41.1809"></a><span id="l41.1809">   uri.query = &quot;type=application/x-message-display&quot;;</span>
<a href="#l41.1810"></a><span id="l41.1810"> </span>
<a href="#l41.1811"></a><span id="l41.1811">   window.openDialog(&quot;chrome://messenger/content/messageWindow.xul&quot;, &quot;_blank&quot;,</span>
<a href="#l41.1812"></a><span id="l41.1812" class="difflineminus">-                    &quot;all,chrome,dialog=no,status,toolbar&quot;, uri, null, null);</span>
<a href="#l41.1813"></a><span id="l41.1813" class="difflineplus">+                    &quot;all,chrome,dialog=no,status,toolbar&quot;, uri);</span>
<a href="#l41.1814"></a><span id="l41.1814"> }</span>
<a href="#l41.1815"></a><span id="l41.1815"> </span>
<a href="#l41.1816"></a><span id="l41.1816" class="difflineminus">-function MsgOpenNewWindowForMessage(messageUri, folderUri)</span>
<a href="#l41.1817"></a><span id="l41.1817" class="difflineplus">+function MsgOpenNewWindowForMessage(aMsgHdr)</span>
<a href="#l41.1818"></a><span id="l41.1818"> {</span>
<a href="#l41.1819"></a><span id="l41.1819" class="difflineminus">-  if (!messageUri)</span>
<a href="#l41.1820"></a><span id="l41.1820" class="difflineminus">-    // Use GetFirstSelectedMessage() to find out which message to open</span>
<a href="#l41.1821"></a><span id="l41.1821" class="difflineminus">-    // instead of gDBView.getURIForViewIndex(currentIndex). This is</span>
<a href="#l41.1822"></a><span id="l41.1822" class="difflineminus">-    // required because on a right-click, the currentIndex value will be</span>
<a href="#l41.1823"></a><span id="l41.1823" class="difflineminus">-    // different from the actual row that is highlighted.</span>
<a href="#l41.1824"></a><span id="l41.1824" class="difflineminus">-    // GetFirstSelectedMessage() will return the message that is</span>
<a href="#l41.1825"></a><span id="l41.1825" class="difflineminus">-    // highlighted.</span>
<a href="#l41.1826"></a><span id="l41.1826" class="difflineminus">-    messageUri = GetFirstSelectedMessage();</span>
<a href="#l41.1827"></a><span id="l41.1827" class="difflineminus">-</span>
<a href="#l41.1828"></a><span id="l41.1828" class="difflineminus">-    if (!folderUri)</span>
<a href="#l41.1829"></a><span id="l41.1829" class="difflineminus">-      // Use GetSelectedMsgFolders() to find out which message to open</span>
<a href="#l41.1830"></a><span id="l41.1830" class="difflineminus">-      // instead of gDBView.getURIForViewIndex(currentIndex).  This is</span>
<a href="#l41.1831"></a><span id="l41.1831" class="difflineminus">-      // required because on a right-click, the currentIndex value will be</span>
<a href="#l41.1832"></a><span id="l41.1832" class="difflineminus">-      // different from the actual row that is highlighted.</span>
<a href="#l41.1833"></a><span id="l41.1833" class="difflineminus">-      // GetSelectedMsgFolders() will return the message that is</span>
<a href="#l41.1834"></a><span id="l41.1834" class="difflineminus">-      // highlighted.</span>
<a href="#l41.1835"></a><span id="l41.1835" class="difflineminus">-      folderUri = GetSelectedMsgFolders()[0].URI;</span>
<a href="#l41.1836"></a><span id="l41.1836" class="difflineminus">-</span>
<a href="#l41.1837"></a><span id="l41.1837" class="difflineminus">-  // be sure to pass in the current view....</span>
<a href="#l41.1838"></a><span id="l41.1838" class="difflineminus">-  if (messageUri &amp;&amp; folderUri) {</span>
<a href="#l41.1839"></a><span id="l41.1839" class="difflineplus">+  // no message header provided?  get the selected message (this will give us</span>
<a href="#l41.1840"></a><span id="l41.1840" class="difflineplus">+  //  the right-click selected message if that's what is going down.)</span>
<a href="#l41.1841"></a><span id="l41.1841" class="difflineplus">+  if (!aMsgHdr)</span>
<a href="#l41.1842"></a><span id="l41.1842" class="difflineplus">+    aMsgHdr = gFolderDisplay.selectedMessage;</span>
<a href="#l41.1843"></a><span id="l41.1843" class="difflineplus">+</span>
<a href="#l41.1844"></a><span id="l41.1844" class="difflineplus">+  // (there might not have been a selected message, so check...)</span>
<a href="#l41.1845"></a><span id="l41.1845" class="difflineplus">+  if (aMsgHdr)</span>
<a href="#l41.1846"></a><span id="l41.1846" class="difflineplus">+    // we also need to tell the window about our current view so that it can</span>
<a href="#l41.1847"></a><span id="l41.1847" class="difflineplus">+    //  clone it.  This enables advancing through the messages, etc.</span>
<a href="#l41.1848"></a><span id="l41.1848">     window.openDialog(&quot;chrome://messenger/content/messageWindow.xul&quot;, &quot;_blank&quot;,</span>
<a href="#l41.1849"></a><span id="l41.1849">                       &quot;all,chrome,dialog=no,status,toolbar&quot;,</span>
<a href="#l41.1850"></a><span id="l41.1850" class="difflineminus">-                      messageUri, folderUri, gDBView);</span>
<a href="#l41.1851"></a><span id="l41.1851" class="difflineminus">-  }</span>
<a href="#l41.1852"></a><span id="l41.1852" class="difflineplus">+                      aMsgHdr, gFolderDisplay.view);</span>
<a href="#l41.1853"></a><span id="l41.1853"> }</span>
<a href="#l41.1854"></a><span id="l41.1854"> </span>
<a href="#l41.1855"></a><span id="l41.1855"> function MsgJunk()</span>
<a href="#l41.1856"></a><span id="l41.1856"> {</span>
<a href="#l41.1857"></a><span id="l41.1857">   MsgJunkMailInfo(true);</span>
<a href="#l41.1858"></a><span id="l41.1858">   JunkSelectedMessages(!SelectedMessagesAreJunk());</span>
<a href="#l41.1859"></a><span id="l41.1859"> }</span>
<a href="#l41.1860"></a><span id="l41.1860"> </span>
<a href="#l41.1861"></a><span id="l41.1861"> </span>
<a href="#l41.1862"></a><span id="l41.1862"> function UpdateJunkButton()</span>
<a href="#l41.1863"></a><span id="l41.1863"> {</span>
<a href="#l41.1864"></a><span id="l41.1864" class="difflineminus">-  let hdr = msgHdrForCurrentMessage();</span>
<a href="#l41.1865"></a><span id="l41.1865" class="difflineminus">-  if (!hdr) // .eml file</span>
<a href="#l41.1866"></a><span id="l41.1866" class="difflineplus">+  // The junk message should slave off the selected message, as the preview pane</span>
<a href="#l41.1867"></a><span id="l41.1867" class="difflineplus">+  //  may not be visible</span>
<a href="#l41.1868"></a><span id="l41.1868" class="difflineplus">+  let hdr = gFolderDisplay.selectedMessage;</span>
<a href="#l41.1869"></a><span id="l41.1869" class="difflineplus">+  // But only the message display knows if we are dealing with a dummy.</span>
<a href="#l41.1870"></a><span id="l41.1870" class="difflineplus">+  if (gMessageDisplay.isDummy) // .eml file</span>
<a href="#l41.1871"></a><span id="l41.1871">     return;</span>
<a href="#l41.1872"></a><span id="l41.1872">   let junkScore = hdr.getStringProperty(&quot;junkscore&quot;);</span>
<a href="#l41.1873"></a><span id="l41.1873">   let hideJunk = (junkScore != &quot;&quot;) &amp;&amp; (junkScore != &quot;0&quot;);</span>
<a href="#l41.1874"></a><span id="l41.1874" class="difflineminus">-  if (isNewsURI(hdr.folder.URI))</span>
<a href="#l41.1875"></a><span id="l41.1875" class="difflineplus">+  if (gFolderDisplay.selectedMessageIsNews)</span>
<a href="#l41.1876"></a><span id="l41.1876">     hideJunk = true;</span>
<a href="#l41.1877"></a><span id="l41.1877" class="difflineminus">-  // which DOM node is the current junk button in the</span>
<a href="#l41.1878"></a><span id="l41.1878" class="difflineminus">-  // message reader depends on whether it's the collapsed or</span>
<a href="#l41.1879"></a><span id="l41.1879" class="difflineminus">-  // expanded header</span>
<a href="#l41.1880"></a><span id="l41.1880" class="difflineminus">-  let buttonBox = document.getElementById(gCollapsedHeaderViewMode ?</span>
<a href="#l41.1881"></a><span id="l41.1881" class="difflineminus">-                     &quot;collapsedButtonBox&quot; : &quot;expandedButtonBox&quot;);</span>
<a href="#l41.1882"></a><span id="l41.1882" class="difflineminus">-  buttonBox.getButton('hdrJunkButton').disabled = hideJunk;</span>
<a href="#l41.1883"></a><span id="l41.1883" class="difflineplus">+</span>
<a href="#l41.1884"></a><span id="l41.1884" class="difflineplus">+  getCurrentMsgHdrButtonBox().getButton('hdrJunkButton').disabled = hideJunk;</span>
<a href="#l41.1885"></a><span id="l41.1885"> }</span>
<a href="#l41.1886"></a><span id="l41.1886"> </span>
<a href="#l41.1887"></a><span id="l41.1887"> function MsgMarkMsgAsRead()</span>
<a href="#l41.1888"></a><span id="l41.1888"> {</span>
<a href="#l41.1889"></a><span id="l41.1889">   MarkSelectedMessagesRead(!SelectedMessagesAreRead());</span>
<a href="#l41.1890"></a><span id="l41.1890"> }</span>
<a href="#l41.1891"></a><span id="l41.1891"> </span>
<a href="#l41.1892"></a><span id="l41.1892"> function MsgMarkAsFlagged()</span>
<a href="#l41.1893"></a><span id="l41.1893"> {</span>
<a href="#l41.1894"></a><span id="l41.1894">   MarkSelectedMessagesFlagged(!SelectedMessagesAreFlagged());</span>
<a href="#l41.1895"></a><span id="l41.1895"> }</span>
<a href="#l41.1896"></a><span id="l41.1896"> </span>
<a href="#l41.1897"></a><span id="l41.1897"> function MsgMarkReadByDate()</span>
<a href="#l41.1898"></a><span id="l41.1898"> {</span>
<a href="#l41.1899"></a><span id="l41.1899">   window.openDialog(&quot;chrome://messenger/content/markByDate.xul&quot;,&quot;&quot;,</span>
<a href="#l41.1900"></a><span id="l41.1900">                     &quot;chrome,modal,titlebar,centerscreen&quot;,</span>
<a href="#l41.1901"></a><span id="l41.1901" class="difflineminus">-                    GetLoadedMsgFolder());</span>
<a href="#l41.1902"></a><span id="l41.1902" class="difflineplus">+                    gFolderDisplay.displayedFolder);</span>
<a href="#l41.1903"></a><span id="l41.1903"> }</span>
<a href="#l41.1904"></a><span id="l41.1904"> </span>
<a href="#l41.1905"></a><span id="l41.1905"> function MsgMarkAllRead()</span>
<a href="#l41.1906"></a><span id="l41.1906"> {</span>
<a href="#l41.1907"></a><span id="l41.1907" class="difflineminus">-  var folder = GetSelectedMsgFolders()[0];</span>
<a href="#l41.1908"></a><span id="l41.1908" class="difflineminus">-</span>
<a href="#l41.1909"></a><span id="l41.1909" class="difflineminus">-  if (folder)</span>
<a href="#l41.1910"></a><span id="l41.1910" class="difflineminus">-    folder.markAllMessagesRead(msgWindow);</span>
<a href="#l41.1911"></a><span id="l41.1911" class="difflineplus">+  let folders = gFolderTreeView.getSelectedFolders();</span>
<a href="#l41.1912"></a><span id="l41.1912" class="difflineplus">+  for (let i = 0; i &lt; folders.length; i++)</span>
<a href="#l41.1913"></a><span id="l41.1913" class="difflineplus">+    folders[i].markAllMessagesRead(msgWindow);</span>
<a href="#l41.1914"></a><span id="l41.1914"> }</span>
<a href="#l41.1915"></a><span id="l41.1915"> </span>
<a href="#l41.1916"></a><span id="l41.1916"> function MsgFilters(emailAddress, folder)</span>
<a href="#l41.1917"></a><span id="l41.1917"> {</span>
<a href="#l41.1918"></a><span id="l41.1918">   if (!folder)</span>
<a href="#l41.1919"></a><span id="l41.1919">   {</span>
<a href="#l41.1920"></a><span id="l41.1920">     // Try to determine the folder from the selected message.</span>
<a href="#l41.1921"></a><span id="l41.1921">     if (gDBView)</span>
<a href="#l41.1922"></a><span id="l41.1922">     {</span>
<a href="#l41.1923"></a><span id="l41.1923">       try</span>
<a href="#l41.1924"></a><span id="l41.1924">       {</span>
<a href="#l41.1925"></a><span id="l41.1925" class="difflineminus">-        var msgHdr = gDBView.hdrForFirstSelectedMessage;</span>
<a href="#l41.1926"></a><span id="l41.1926" class="difflineplus">+        var msgHdr = gFolderDisplay.selectedMessage;</span>
<a href="#l41.1927"></a><span id="l41.1927">         var accountKey = msgHdr.accountKey;</span>
<a href="#l41.1928"></a><span id="l41.1928">         if (accountKey.length &gt; 0)</span>
<a href="#l41.1929"></a><span id="l41.1929">         {</span>
<a href="#l41.1930"></a><span id="l41.1930">           var account = accountManager.getAccount(accountKey);</span>
<a href="#l41.1931"></a><span id="l41.1931">           if (account)</span>
<a href="#l41.1932"></a><span id="l41.1932">           {</span>
<a href="#l41.1933"></a><span id="l41.1933">             var server = account.incomingServer;</span>
<a href="#l41.1934"></a><span id="l41.1934">             if (server)</span>
<a href="#l41.1935"></a><span id="l41.1935" class="difflineat">@@ -2209,17 +2210,17 @@ function MsgFilters(emailAddress, folder</span>
<a href="#l41.1936"></a><span id="l41.1936">       }</span>
<a href="#l41.1937"></a><span id="l41.1937">     }</span>
<a href="#l41.1938"></a><span id="l41.1938">   }</span>
<a href="#l41.1939"></a><span id="l41.1939">   var args;</span>
<a href="#l41.1940"></a><span id="l41.1940">   if (emailAddress)</span>
<a href="#l41.1941"></a><span id="l41.1941">   {</span>
<a href="#l41.1942"></a><span id="l41.1942">     // We have to do prefill filter so we are going to launch the</span>
<a href="#l41.1943"></a><span id="l41.1943">     // filterEditor dialog and prefill that with the emailAddress.</span>
<a href="#l41.1944"></a><span id="l41.1944" class="difflineminus">-    args = { filterList: folder.getFilterList(msgWindow) };</span>
<a href="#l41.1945"></a><span id="l41.1945" class="difflineplus">+    args = { filterList: folder.getEditableFilterList(msgWindow) };</span>
<a href="#l41.1946"></a><span id="l41.1946">     args.filterName = emailAddress;</span>
<a href="#l41.1947"></a><span id="l41.1947">     window.openDialog(&quot;chrome://messenger/content/FilterEditor.xul&quot;, &quot;&quot;,</span>
<a href="#l41.1948"></a><span id="l41.1948">                       &quot;chrome, modal, resizable,centerscreen,dialog=yes&quot;, args);</span>
<a href="#l41.1949"></a><span id="l41.1949"> </span>
<a href="#l41.1950"></a><span id="l41.1950">     // If the user hits ok in the filterEditor dialog we set args.refresh=true</span>
<a href="#l41.1951"></a><span id="l41.1951">     // there we check this here in args to show filterList dialog.</span>
<a href="#l41.1952"></a><span id="l41.1952">     if (&quot;refresh&quot; in args &amp;&amp; args.refresh)</span>
<a href="#l41.1953"></a><span id="l41.1953">     {</span>
<a href="#l41.1954"></a><span id="l41.1954" class="difflineat">@@ -2267,43 +2268,30 @@ function MsgApplyFilters()</span>
<a href="#l41.1955"></a><span id="l41.1955">       newFilterIndex++;</span>
<a href="#l41.1956"></a><span id="l41.1956">     }</span>
<a href="#l41.1957"></a><span id="l41.1957">   }</span>
<a href="#l41.1958"></a><span id="l41.1958">   filterService.applyFiltersToFolders(tempFilterList, selectedFolders, msgWindow);</span>
<a href="#l41.1959"></a><span id="l41.1959"> }</span>
<a href="#l41.1960"></a><span id="l41.1960"> </span>
<a href="#l41.1961"></a><span id="l41.1961"> function MsgApplyFiltersToSelection()</span>
<a href="#l41.1962"></a><span id="l41.1962"> {</span>
<a href="#l41.1963"></a><span id="l41.1963" class="difflineminus">-  var filterService = Components.classes[&quot;@mozilla.org/messenger/services/filters;1&quot;]</span>
<a href="#l41.1964"></a><span id="l41.1964" class="difflineminus">-                                .getService(Components.interfaces.nsIMsgFilterService);</span>
<a href="#l41.1965"></a><span id="l41.1965" class="difflineminus">-</span>
<a href="#l41.1966"></a><span id="l41.1966" class="difflineminus">-  var folder = gDBView.msgFolder;</span>
<a href="#l41.1967"></a><span id="l41.1967" class="difflineminus">-  var indices = GetSelectedIndices(gDBView);</span>
<a href="#l41.1968"></a><span id="l41.1968" class="difflineminus">-  if (indices &amp;&amp; indices.length)</span>
<a href="#l41.1969"></a><span id="l41.1969" class="difflineminus">-  {</span>
<a href="#l41.1970"></a><span id="l41.1970" class="difflineminus">-    var selectedMsgs = Components.classes[&quot;@mozilla.org/array;1&quot;]</span>
<a href="#l41.1971"></a><span id="l41.1971" class="difflineminus">-                                 .createInstance(Components.interfaces.nsIMutableArray);</span>
<a href="#l41.1972"></a><span id="l41.1972" class="difflineminus">-    for (var i = 0; i &lt; indices.length; i++)</span>
<a href="#l41.1973"></a><span id="l41.1973" class="difflineminus">-    {</span>
<a href="#l41.1974"></a><span id="l41.1974" class="difflineminus">-      try</span>
<a href="#l41.1975"></a><span id="l41.1975" class="difflineminus">-      {</span>
<a href="#l41.1976"></a><span id="l41.1976" class="difflineminus">-        // Getting the URI will tell us if the item is real or a dummy header</span>
<a href="#l41.1977"></a><span id="l41.1977" class="difflineminus">-        var uri = gDBView.getURIForViewIndex(indices[i]);</span>
<a href="#l41.1978"></a><span id="l41.1978" class="difflineminus">-        if (uri)</span>
<a href="#l41.1979"></a><span id="l41.1979" class="difflineminus">-        {</span>
<a href="#l41.1980"></a><span id="l41.1980" class="difflineminus">-          var msgHdr = folder.GetMessageHeader(gDBView.getKeyAt(indices[i]));</span>
<a href="#l41.1981"></a><span id="l41.1981" class="difflineminus">-          if (msgHdr)</span>
<a href="#l41.1982"></a><span id="l41.1982" class="difflineminus">-            selectedMsgs.appendElement(msgHdr, false);</span>
<a href="#l41.1983"></a><span id="l41.1983" class="difflineminus">-        }</span>
<a href="#l41.1984"></a><span id="l41.1984" class="difflineminus">-      } catch (ex) {}</span>
<a href="#l41.1985"></a><span id="l41.1985" class="difflineminus">-    }</span>
<a href="#l41.1986"></a><span id="l41.1986" class="difflineplus">+  // bail if we're dealing with a dummy header</span>
<a href="#l41.1987"></a><span id="l41.1987" class="difflineplus">+  if (gMessageDisplay.isDummy)</span>
<a href="#l41.1988"></a><span id="l41.1988" class="difflineplus">+    return;</span>
<a href="#l41.1989"></a><span id="l41.1989" class="difflineplus">+</span>
<a href="#l41.1990"></a><span id="l41.1990" class="difflineplus">+  var selectedMessages = gFolderDisplay.selectedMessages;</span>
<a href="#l41.1991"></a><span id="l41.1991" class="difflineplus">+  if (selectedMessages.length) {</span>
<a href="#l41.1992"></a><span id="l41.1992" class="difflineplus">+    var filterService =</span>
<a href="#l41.1993"></a><span id="l41.1993" class="difflineplus">+      Components.classes[&quot;@mozilla.org/messenger/services/filters;1&quot;]</span>
<a href="#l41.1994"></a><span id="l41.1994" class="difflineplus">+                .getService(Components.interfaces.nsIMsgFilterService);</span>
<a href="#l41.1995"></a><span id="l41.1995"> </span>
<a href="#l41.1996"></a><span id="l41.1996">     filterService.applyFilters(Components.interfaces.nsMsgFilterType.Manual,</span>
<a href="#l41.1997"></a><span id="l41.1997" class="difflineminus">-                               selectedMsgs,</span>
<a href="#l41.1998"></a><span id="l41.1998" class="difflineminus">-                               folder,</span>
<a href="#l41.1999"></a><span id="l41.1999" class="difflineplus">+                               toXPCOMArray(selectedMessages,</span>
<a href="#l41.2000"></a><span id="l41.2000" class="difflineplus">+                                            Components.interfaces.nsIMutableArray),</span>
<a href="#l41.2001"></a><span id="l41.2001" class="difflineplus">+                               gFolderDisplay.displayedFolder,</span>
<a href="#l41.2002"></a><span id="l41.2002">                                msgWindow);</span>
<a href="#l41.2003"></a><span id="l41.2003">   }</span>
<a href="#l41.2004"></a><span id="l41.2004"> }</span>
<a href="#l41.2005"></a><span id="l41.2005"> </span>
<a href="#l41.2006"></a><span id="l41.2006"> function ChangeMailLayout(newLayout)</span>
<a href="#l41.2007"></a><span id="l41.2007"> {</span>
<a href="#l41.2008"></a><span id="l41.2008">   gPrefBranch.setIntPref(&quot;mail.pane_config.dynamic&quot;, newLayout);</span>
<a href="#l41.2009"></a><span id="l41.2009"> }</span>
<a href="#l41.2010"></a><span id="l41.2010" class="difflineat">@@ -2381,18 +2369,18 @@ function ToggleInlineAttachment(target)</span>
<a href="#l41.2011"></a><span id="l41.2011">   var viewAttachmentInline = !pref.getBoolPref(&quot;mail.inline_attachments&quot;);</span>
<a href="#l41.2012"></a><span id="l41.2012">   pref.setBoolPref(&quot;mail.inline_attachments&quot;, viewAttachmentInline)</span>
<a href="#l41.2013"></a><span id="l41.2013">   target.setAttribute(&quot;checked&quot;, viewAttachmentInline ? &quot;true&quot; : &quot;false&quot;);</span>
<a href="#l41.2014"></a><span id="l41.2014">   ReloadMessage();</span>
<a href="#l41.2015"></a><span id="l41.2015"> }</span>
<a href="#l41.2016"></a><span id="l41.2016"> </span>
<a href="#l41.2017"></a><span id="l41.2017"> function PrintEnginePrintInternal(doPrintPreview, msgType)</span>
<a href="#l41.2018"></a><span id="l41.2018"> {</span>
<a href="#l41.2019"></a><span id="l41.2019" class="difflineminus">-  var messageList = GetSelectedMessages();</span>
<a href="#l41.2020"></a><span id="l41.2020" class="difflineminus">-  if (messageList.length == 0) {</span>
<a href="#l41.2021"></a><span id="l41.2021" class="difflineplus">+  var messageList = gFolderDisplay.selectedMessageUris;</span>
<a href="#l41.2022"></a><span id="l41.2022" class="difflineplus">+  if (!messageList) {</span>
<a href="#l41.2023"></a><span id="l41.2023">     dump(&quot;PrintEnginePrintInternal(): No messages selected.\n&quot;);</span>
<a href="#l41.2024"></a><span id="l41.2024">     return;</span>
<a href="#l41.2025"></a><span id="l41.2025">   }</span>
<a href="#l41.2026"></a><span id="l41.2026"> </span>
<a href="#l41.2027"></a><span id="l41.2027">   window.openDialog(&quot;chrome://messenger/content/msgPrintEngine.xul&quot;, &quot;&quot;,</span>
<a href="#l41.2028"></a><span id="l41.2028">                     &quot;chrome,dialog=no,all,centerscreen&quot;,</span>
<a href="#l41.2029"></a><span id="l41.2029">                     messageList.length, messageList, statusFeedback,</span>
<a href="#l41.2030"></a><span id="l41.2030">                     doPrintPreview, msgType, window);</span>
<a href="#l41.2031"></a><span id="l41.2031" class="difflineat">@@ -2670,17 +2658,17 @@ function CommandUpdate_UndoRedo()</span>
<a href="#l41.2032"></a><span id="l41.2032">   EnableMenuItem(&quot;menu_undo&quot;, SetupUndoRedoCommand(&quot;cmd_undo&quot;));</span>
<a href="#l41.2033"></a><span id="l41.2033">   EnableMenuItem(&quot;menu_redo&quot;, SetupUndoRedoCommand(&quot;cmd_redo&quot;));</span>
<a href="#l41.2034"></a><span id="l41.2034"> }</span>
<a href="#l41.2035"></a><span id="l41.2035"> </span>
<a href="#l41.2036"></a><span id="l41.2036"> function SetupUndoRedoCommand(command)</span>
<a href="#l41.2037"></a><span id="l41.2037"> {</span>
<a href="#l41.2038"></a><span id="l41.2038">   // If we have selected a server, and are viewing account central</span>
<a href="#l41.2039"></a><span id="l41.2039">   // there is no loaded folder.</span>
<a href="#l41.2040"></a><span id="l41.2040" class="difflineminus">-  var loadedFolder = GetLoadedMsgFolder();</span>
<a href="#l41.2041"></a><span id="l41.2041" class="difflineplus">+  var loadedFolder = gFolderDisplay.displayedFolder;</span>
<a href="#l41.2042"></a><span id="l41.2042">   if (!loadedFolder || !loadedFolder.server.canUndoDeleteOnServer)</span>
<a href="#l41.2043"></a><span id="l41.2043">     return false;</span>
<a href="#l41.2044"></a><span id="l41.2044"> </span>
<a href="#l41.2045"></a><span id="l41.2045">   var canUndoOrRedo;</span>
<a href="#l41.2046"></a><span id="l41.2046">   var txnType;</span>
<a href="#l41.2047"></a><span id="l41.2047">   if (command == &quot;cmd_undo&quot;)</span>
<a href="#l41.2048"></a><span id="l41.2048">   {</span>
<a href="#l41.2049"></a><span id="l41.2049">     canUndoOrRedo = messenger.canUndo();</span>
<a href="#l41.2050"></a><span id="l41.2050" class="difflineat">@@ -2689,41 +2677,57 @@ function SetupUndoRedoCommand(command)</span>
<a href="#l41.2051"></a><span id="l41.2051">   else</span>
<a href="#l41.2052"></a><span id="l41.2052">   {</span>
<a href="#l41.2053"></a><span id="l41.2053">     canUndoOrRedo = messenger.canRedo();</span>
<a href="#l41.2054"></a><span id="l41.2054">     txnType = messenger.getRedoTransactionType();</span>
<a href="#l41.2055"></a><span id="l41.2055">   }</span>
<a href="#l41.2056"></a><span id="l41.2056"> </span>
<a href="#l41.2057"></a><span id="l41.2057">   if (canUndoOrRedo)</span>
<a href="#l41.2058"></a><span id="l41.2058">   {</span>
<a href="#l41.2059"></a><span id="l41.2059" class="difflineminus">-    var commands = </span>
<a href="#l41.2060"></a><span id="l41.2060" class="difflineplus">+    var commands =</span>
<a href="#l41.2061"></a><span id="l41.2061">       ['valueDefault', 'valueDeleteMsg', 'valueMoveMsg', 'valueCopyMsg', 'valueUnmarkAllMsgs'];</span>
<a href="#l41.2062"></a><span id="l41.2062">     goSetMenuValue(command, commands[txnType]);</span>
<a href="#l41.2063"></a><span id="l41.2063">   }</span>
<a href="#l41.2064"></a><span id="l41.2064">   else</span>
<a href="#l41.2065"></a><span id="l41.2065">   {</span>
<a href="#l41.2066"></a><span id="l41.2066">     goSetMenuValue(command, 'valueDefault');</span>
<a href="#l41.2067"></a><span id="l41.2067">   }</span>
<a href="#l41.2068"></a><span id="l41.2068">   return canUndoOrRedo;</span>
<a href="#l41.2069"></a><span id="l41.2069"> }</span>
<a href="#l41.2070"></a><span id="l41.2070"> </span>
<a href="#l41.2071"></a><span id="l41.2071" class="difflineplus">+/**</span>
<a href="#l41.2072"></a><span id="l41.2072" class="difflineplus">+ * Triggered by the global JunkStatusChanged notification, we handle updating</span>
<a href="#l41.2073"></a><span id="l41.2073" class="difflineplus">+ *  the message display if our displayed message might have had its junk status</span>
<a href="#l41.2074"></a><span id="l41.2074" class="difflineplus">+ *  change.  This primarily entails updating the notification bar (that thing</span>
<a href="#l41.2075"></a><span id="l41.2075" class="difflineplus">+ *  that appears above the message and says &quot;this message might be junk&quot;) and</span>
<a href="#l41.2076"></a><span id="l41.2076" class="difflineplus">+ *  (potentially) reloading the message because junk status affects the form of</span>
<a href="#l41.2077"></a><span id="l41.2077" class="difflineplus">+ *  HTML display used (sanitized vs not).</span>
<a href="#l41.2078"></a><span id="l41.2078" class="difflineplus">+ * When our tab implementation is no longer multiplexed (reusing the same</span>
<a href="#l41.2079"></a><span id="l41.2079" class="difflineplus">+ *  display widget), this must be moved into the MessageDisplayWidget or</span>
<a href="#l41.2080"></a><span id="l41.2080" class="difflineplus">+ *  otherwise be scoped to the tab.</span>
<a href="#l41.2081"></a><span id="l41.2081" class="difflineplus">+ */</span>
<a href="#l41.2082"></a><span id="l41.2082"> function HandleJunkStatusChanged(folder)</span>
<a href="#l41.2083"></a><span id="l41.2083"> {</span>
<a href="#l41.2084"></a><span id="l41.2084" class="difflineplus">+  // We have nothing to do (and should bail) if:</span>
<a href="#l41.2085"></a><span id="l41.2085" class="difflineplus">+  // - There is no currently displayed message.</span>
<a href="#l41.2086"></a><span id="l41.2086" class="difflineplus">+  // - The displayed message is an .eml file from disk or an attachment.</span>
<a href="#l41.2087"></a><span id="l41.2087" class="difflineplus">+  // - The folder that has had a junk change is not backing the display folder.</span>
<a href="#l41.2088"></a><span id="l41.2088" class="difflineplus">+</span>
<a href="#l41.2089"></a><span id="l41.2089">   // This might be the stand alone window, open to a message that was</span>
<a href="#l41.2090"></a><span id="l41.2090">   // and attachment (or on disk), in which case, we want to ignore it.</span>
<a href="#l41.2091"></a><span id="l41.2091" class="difflineminus">-  var loadedMessage = GetLoadedMessage();</span>
<a href="#l41.2092"></a><span id="l41.2092" class="difflineminus">-  if (!loadedMessage || (/type=application\/x-message-display/.test(loadedMessage)) ||</span>
<a href="#l41.2093"></a><span id="l41.2093" class="difflineminus">-      !IsCurrentLoadedFolder(folder))</span>
<a href="#l41.2094"></a><span id="l41.2094" class="difflineplus">+  if (!gMessageDisplay.displayedMessage ||</span>
<a href="#l41.2095"></a><span id="l41.2095" class="difflineplus">+      gMessageDisplay.isDummy ||</span>
<a href="#l41.2096"></a><span id="l41.2096" class="difflineplus">+      gFolderDisplay.displayedFolder != folder)</span>
<a href="#l41.2097"></a><span id="l41.2097">     return;</span>
<a href="#l41.2098"></a><span id="l41.2098"> </span>
<a href="#l41.2099"></a><span id="l41.2099">   // If multiple message are selected and we change the junk status</span>
<a href="#l41.2100"></a><span id="l41.2100">   // we don't want to show the junk bar (since the message pane is blank).</span>
<a href="#l41.2101"></a><span id="l41.2101">   var msgHdr = null;</span>
<a href="#l41.2102"></a><span id="l41.2102">   if (GetNumSelectedMessages() == 1)</span>
<a href="#l41.2103"></a><span id="l41.2103" class="difflineminus">-    msgHdr = messenger.msgHdrFromURI(loadedMessage);</span>
<a href="#l41.2104"></a><span id="l41.2104" class="difflineplus">+    msgHdr = gMessageDisplay.displayedMessage;</span>
<a href="#l41.2105"></a><span id="l41.2105">   var junkBarWasDisplayed = gMessageNotificationBar.isFlagSet(kMsgNotificationJunkBar);</span>
<a href="#l41.2106"></a><span id="l41.2106">   gMessageNotificationBar.setJunkMsg(msgHdr);</span>
<a href="#l41.2107"></a><span id="l41.2107"> </span>
<a href="#l41.2108"></a><span id="l41.2108">   // Only reload message if junk bar display state has changed.</span>
<a href="#l41.2109"></a><span id="l41.2109">   if (msgHdr &amp;&amp; junkBarWasDisplayed != gMessageNotificationBar.isFlagSet(kMsgNotificationJunkBar))</span>
<a href="#l41.2110"></a><span id="l41.2110">   {</span>
<a href="#l41.2111"></a><span id="l41.2111">     // We may be forcing junk mail to be rendered with sanitized html.</span>
<a href="#l41.2112"></a><span id="l41.2112">     // In that scenario, we want to reload the message if the status has just</span>
<a href="#l41.2113"></a><span id="l41.2113" class="difflineat">@@ -2764,17 +2768,17 @@ var gMessageNotificationBar =</span>
<a href="#l41.2114"></a><span id="l41.2114">   mMsgNotificationBar: document.getElementById('msgNotificationBar'),</span>
<a href="#l41.2115"></a><span id="l41.2115"> </span>
<a href="#l41.2116"></a><span id="l41.2116">   setJunkMsg: function(aMsgHdr)</span>
<a href="#l41.2117"></a><span id="l41.2117">   {</span>
<a href="#l41.2118"></a><span id="l41.2118">     var isJunk = false;</span>
<a href="#l41.2119"></a><span id="l41.2119"> </span>
<a href="#l41.2120"></a><span id="l41.2120">     if (aMsgHdr)</span>
<a href="#l41.2121"></a><span id="l41.2121">     {</span>
<a href="#l41.2122"></a><span id="l41.2122" class="difflineminus">-      var junkScore = aMsgHdr.getStringProperty(&quot;junkscore&quot;); </span>
<a href="#l41.2123"></a><span id="l41.2123" class="difflineplus">+      var junkScore = aMsgHdr.getStringProperty(&quot;junkscore&quot;);</span>
<a href="#l41.2124"></a><span id="l41.2124">       isJunk = ((junkScore != &quot;&quot;) &amp;&amp; (junkScore != &quot;0&quot;));</span>
<a href="#l41.2125"></a><span id="l41.2125">     }</span>
<a href="#l41.2126"></a><span id="l41.2126"> </span>
<a href="#l41.2127"></a><span id="l41.2127">     this.updateMsgNotificationBar(kMsgNotificationJunkBar, isJunk);</span>
<a href="#l41.2128"></a><span id="l41.2128"> </span>
<a href="#l41.2129"></a><span id="l41.2129">     goUpdateCommand('button_junk');</span>
<a href="#l41.2130"></a><span id="l41.2130">   },</span>
<a href="#l41.2131"></a><span id="l41.2131"> </span>
<a href="#l41.2132"></a><span id="l41.2132" class="difflineat">@@ -2834,34 +2838,25 @@ function LoadMsgWithRemoteContent()</span>
<a href="#l41.2133"></a><span id="l41.2133">   // we want to get the msg hdr for the currently selected message</span>
<a href="#l41.2134"></a><span id="l41.2134">   // change the &quot;remoteContentBar&quot; property on it</span>
<a href="#l41.2135"></a><span id="l41.2135">   // then reload the message</span>
<a href="#l41.2136"></a><span id="l41.2136"> </span>
<a href="#l41.2137"></a><span id="l41.2137">   setMsgHdrPropertyAndReload(&quot;remoteContentPolicy&quot;, kAllowRemoteContent);</span>
<a href="#l41.2138"></a><span id="l41.2138"> }</span>
<a href="#l41.2139"></a><span id="l41.2139"> </span>
<a href="#l41.2140"></a><span id="l41.2140"> /**</span>
<a href="#l41.2141"></a><span id="l41.2141" class="difflineminus">- * Returns the msg hdr associated with the current loaded message.</span>
<a href="#l41.2142"></a><span id="l41.2142" class="difflineminus">- */</span>
<a href="#l41.2143"></a><span id="l41.2143" class="difflineminus">-function msgHdrForCurrentMessage()</span>
<a href="#l41.2144"></a><span id="l41.2144" class="difflineminus">-{</span>
<a href="#l41.2145"></a><span id="l41.2145" class="difflineminus">-  var msgURI = GetLoadedMessage();</span>
<a href="#l41.2146"></a><span id="l41.2146" class="difflineminus">-  return (msgURI &amp;&amp; !(/type=application\/x-message-display/.test(msgURI))) ? messenger.msgHdrFromURI(msgURI) : null;</span>
<a href="#l41.2147"></a><span id="l41.2147" class="difflineminus">-}</span>
<a href="#l41.2148"></a><span id="l41.2148" class="difflineminus">-</span>
<a href="#l41.2149"></a><span id="l41.2149" class="difflineminus">-/**</span>
<a href="#l41.2150"></a><span id="l41.2150">  *  Reloads the message after adjusting the remote content policy for the sender.</span>
<a href="#l41.2151"></a><span id="l41.2151" class="difflineminus">- *  Iterate through the local address books looking for a card with the same e-mail address as the </span>
<a href="#l41.2152"></a><span id="l41.2152" class="difflineplus">+ *  Iterate through the local address books looking for a card with the same e-mail address as the</span>
<a href="#l41.2153"></a><span id="l41.2153">  *  sender of the current loaded message. If we find a card, update the allow remote content field.</span>
<a href="#l41.2154"></a><span id="l41.2154">  *  If we can't find a card, prompt the user with a new AB card dialog, pre-selecting the remote content field.</span>
<a href="#l41.2155"></a><span id="l41.2155">  */</span>
<a href="#l41.2156"></a><span id="l41.2156"> function allowRemoteContentForSender()</span>
<a href="#l41.2157"></a><span id="l41.2157"> {</span>
<a href="#l41.2158"></a><span id="l41.2158">   // get the sender of the msg hdr</span>
<a href="#l41.2159"></a><span id="l41.2159" class="difflineminus">-  var msgHdr = msgHdrForCurrentMessage();</span>
<a href="#l41.2160"></a><span id="l41.2160" class="difflineplus">+  var msgHdr = gMessageDisplay.displayedMessage;</span>
<a href="#l41.2161"></a><span id="l41.2161">   if (!msgHdr)</span>
<a href="#l41.2162"></a><span id="l41.2162">     return;</span>
<a href="#l41.2163"></a><span id="l41.2163"> </span>
<a href="#l41.2164"></a><span id="l41.2164">   var headerParser = Components.classes[&quot;@mozilla.org/messenger/headerparser;1&quot;]</span>
<a href="#l41.2165"></a><span id="l41.2165">                                .getService(Components.interfaces.nsIMsgHeaderParser);</span>
<a href="#l41.2166"></a><span id="l41.2166">   var names = {};</span>
<a href="#l41.2167"></a><span id="l41.2167">   var addresses = {};</span>
<a href="#l41.2168"></a><span id="l41.2168">   var fullNames = {};</span>
<a href="#l41.2169"></a><span id="l41.2169" class="difflineat">@@ -2925,17 +2920,17 @@ function IgnorePhishingWarning()</span>
<a href="#l41.2170"></a><span id="l41.2170">   // This property is used to supress the phishing bar for the message.</span>
<a href="#l41.2171"></a><span id="l41.2171">   setMsgHdrPropertyAndReload(&quot;notAPhishMessage&quot;, 1);</span>
<a href="#l41.2172"></a><span id="l41.2172"> }</span>
<a href="#l41.2173"></a><span id="l41.2173"> </span>
<a href="#l41.2174"></a><span id="l41.2174"> function setMsgHdrPropertyAndReload(aProperty, aValue)</span>
<a href="#l41.2175"></a><span id="l41.2175"> {</span>
<a href="#l41.2176"></a><span id="l41.2176">   // we want to get the msg hdr for the currently selected message</span>
<a href="#l41.2177"></a><span id="l41.2177">   // change the appropiate property on it then reload the message</span>
<a href="#l41.2178"></a><span id="l41.2178" class="difflineminus">-  var msgHdr = msgHdrForCurrentMessage();</span>
<a href="#l41.2179"></a><span id="l41.2179" class="difflineplus">+  var msgHdr = gMessageDisplay.displayedMessage;</span>
<a href="#l41.2180"></a><span id="l41.2180">   if (msgHdr)</span>
<a href="#l41.2181"></a><span id="l41.2181">   {</span>
<a href="#l41.2182"></a><span id="l41.2182">     msgHdr.setUint32Property(aProperty, aValue);</span>
<a href="#l41.2183"></a><span id="l41.2183">     ReloadMessage();</span>
<a href="#l41.2184"></a><span id="l41.2184">   }</span>
<a href="#l41.2185"></a><span id="l41.2185"> }</span>
<a href="#l41.2186"></a><span id="l41.2186"> </span>
<a href="#l41.2187"></a><span id="l41.2187"> /**</span>
<a href="#l41.2188"></a><span id="l41.2188" class="difflineat">@@ -2955,40 +2950,40 @@ function ClearPendingReadTimer()</span>
<a href="#l41.2189"></a><span id="l41.2189"> {</span>
<a href="#l41.2190"></a><span id="l41.2190">   if (gMarkViewedMessageAsReadTimer)</span>
<a href="#l41.2191"></a><span id="l41.2191">   {</span>
<a href="#l41.2192"></a><span id="l41.2192">     clearTimeout(gMarkViewedMessageAsReadTimer);</span>
<a href="#l41.2193"></a><span id="l41.2193">     gMarkViewedMessageAsReadTimer = null;</span>
<a href="#l41.2194"></a><span id="l41.2194">   }</span>
<a href="#l41.2195"></a><span id="l41.2195"> }</span>
<a href="#l41.2196"></a><span id="l41.2196"> </span>
<a href="#l41.2197"></a><span id="l41.2197" class="difflineminus">-// this is called when layout is actually finished rendering a </span>
<a href="#l41.2198"></a><span id="l41.2198" class="difflineplus">+// this is called when layout is actually finished rendering a</span>
<a href="#l41.2199"></a><span id="l41.2199"> // mail message. OnMsgLoaded is called when libmime is done parsing the message</span>
<a href="#l41.2200"></a><span id="l41.2200"> function OnMsgParsed(aUrl)</span>
<a href="#l41.2201"></a><span id="l41.2201"> {</span>
<a href="#l41.2202"></a><span id="l41.2202">   // If rss feed (has 'content-base' header), show summary or load web</span>
<a href="#l41.2203"></a><span id="l41.2203">   // page per pref; earliest we have content DOM is here (onMsgParsed).</span>
<a href="#l41.2204"></a><span id="l41.2204">   FeedSetContentView();</span>
<a href="#l41.2205"></a><span id="l41.2205"> </span>
<a href="#l41.2206"></a><span id="l41.2206">   // browser doesn't do this, but I thought it could be a useful thing to test out...</span>
<a href="#l41.2207"></a><span id="l41.2207" class="difflineminus">-  // If the find bar is visible and we just loaded a new message, re-run </span>
<a href="#l41.2208"></a><span id="l41.2208" class="difflineplus">+  // If the find bar is visible and we just loaded a new message, re-run</span>
<a href="#l41.2209"></a><span id="l41.2209">   // the find command. This means the new message will get highlighted and</span>
<a href="#l41.2210"></a><span id="l41.2210">   // we'll scroll to the first word in the message that matches the find text.</span>
<a href="#l41.2211"></a><span id="l41.2211">   var findBar = document.getElementById(&quot;FindToolbar&quot;);</span>
<a href="#l41.2212"></a><span id="l41.2212">   if (!findBar.hidden)</span>
<a href="#l41.2213"></a><span id="l41.2213">     findBar.onFindAgainCommand(false);</span>
<a href="#l41.2214"></a><span id="l41.2214"> </span>
<a href="#l41.2215"></a><span id="l41.2215">   // Run the phishing detector on the message if it hasn't been marked as not</span>
<a href="#l41.2216"></a><span id="l41.2216">   // a scam already.</span>
<a href="#l41.2217"></a><span id="l41.2217" class="difflineminus">-  var msgHdr = msgHdrForCurrentMessage();</span>
<a href="#l41.2218"></a><span id="l41.2218" class="difflineplus">+  var msgHdr = gMessageDisplay.displayedMessage;</span>
<a href="#l41.2219"></a><span id="l41.2219">   if (msgHdr &amp;&amp; !msgHdr.getUint32Property(&quot;notAPhishMessage&quot;))</span>
<a href="#l41.2220"></a><span id="l41.2220">     gPhishingDetector.analyzeMsgForPhishingURLs(aUrl);</span>
<a href="#l41.2221"></a><span id="l41.2221"> </span>
<a href="#l41.2222"></a><span id="l41.2222">   // notify anyone (e.g., extensions) who's interested in when a message is loaded.</span>
<a href="#l41.2223"></a><span id="l41.2223" class="difflineminus">-  var msgURI = GetLoadedMessage();</span>
<a href="#l41.2224"></a><span id="l41.2224" class="difflineplus">+  var msgURI = gFolderDisplay.selectedMessageUris[0];</span>
<a href="#l41.2225"></a><span id="l41.2225">   var observerService = Components.classes[&quot;@mozilla.org/observer-service;1&quot;]</span>
<a href="#l41.2226"></a><span id="l41.2226">                                   .getService(Components.interfaces.nsIObserverService);</span>
<a href="#l41.2227"></a><span id="l41.2227">   observerService.notifyObservers(msgWindow.msgHeaderSink, &quot;MsgMsgDisplayed&quot;, msgURI);</span>
<a href="#l41.2228"></a><span id="l41.2228"> </span>
<a href="#l41.2229"></a><span id="l41.2229">   // scale any overflowing images</span>
<a href="#l41.2230"></a><span id="l41.2230">   var doc = document.getElementById(&quot;messagepane&quot;).contentDocument;</span>
<a href="#l41.2231"></a><span id="l41.2231">   var imgs = doc.getElementsByTagName(&quot;img&quot;);</span>
<a href="#l41.2232"></a><span id="l41.2232">   for each (var img in imgs)</span>
<a href="#l41.2233"></a><span id="l41.2233" class="difflineat">@@ -3010,33 +3005,22 @@ function OnMsgLoaded(aUrl)</span>
<a href="#l41.2234"></a><span id="l41.2234"> </span>
<a href="#l41.2235"></a><span id="l41.2235">   // nsIMsgMailNewsUrl.folder throws an error when opening .eml files.</span>
<a href="#l41.2236"></a><span id="l41.2236">   var folder;</span>
<a href="#l41.2237"></a><span id="l41.2237">   try {</span>
<a href="#l41.2238"></a><span id="l41.2238">     folder = aUrl.folder;</span>
<a href="#l41.2239"></a><span id="l41.2239">   }</span>
<a href="#l41.2240"></a><span id="l41.2240">   catch (ex) {}</span>
<a href="#l41.2241"></a><span id="l41.2241"> </span>
<a href="#l41.2242"></a><span id="l41.2242" class="difflineminus">-  var msgURI = GetLoadedMessage();</span>
<a href="#l41.2243"></a><span id="l41.2243" class="difflineminus">-</span>
<a href="#l41.2244"></a><span id="l41.2244" class="difflineminus">-  if (!folder || !msgURI)</span>
<a href="#l41.2245"></a><span id="l41.2245" class="difflineplus">+  var msgHdr = gMessageDisplay.displayedMessage;</span>
<a href="#l41.2246"></a><span id="l41.2246" class="difflineplus">+  if (!folder || !msgHdr)</span>
<a href="#l41.2247"></a><span id="l41.2247">     return;</span>
<a href="#l41.2248"></a><span id="l41.2248"> </span>
<a href="#l41.2249"></a><span id="l41.2249" class="difflineminus">-  // If we are in the middle of a delete or move operation, make sure that</span>
<a href="#l41.2250"></a><span id="l41.2250" class="difflineminus">-  // if the user clicks on another message then that message stays selected</span>
<a href="#l41.2251"></a><span id="l41.2251" class="difflineminus">-  // and the selection does not &quot;snap back&quot; to the message chosen by</span>
<a href="#l41.2252"></a><span id="l41.2252" class="difflineminus">-  // SetNextMessageAfterDelete() when the operation completes (bug 243532).</span>
<a href="#l41.2253"></a><span id="l41.2253" class="difflineminus">-  // But the just loaded message might be getting deleted, if the user</span>
<a href="#l41.2254"></a><span id="l41.2254" class="difflineminus">-  // deletes it before the message is loaded (bug 183394).</span>
<a href="#l41.2255"></a><span id="l41.2255">   var wintype = document.documentElement.getAttribute('windowtype');</span>
<a href="#l41.2256"></a><span id="l41.2256" class="difflineminus">-  if (wintype == &quot;mail:messageWindow&quot; ||</span>
<a href="#l41.2257"></a><span id="l41.2257" class="difflineminus">-      GetThreadTree().view.selection.currentIndex != gSelectedIndexWhenDeleting)</span>
<a href="#l41.2258"></a><span id="l41.2258" class="difflineminus">-    gNextMessageViewIndexAfterDelete = -2;</span>
<a href="#l41.2259"></a><span id="l41.2259" class="difflineminus">-</span>
<a href="#l41.2260"></a><span id="l41.2260" class="difflineminus">-  var msgHdr = msgHdrForCurrentMessage();</span>
<a href="#l41.2261"></a><span id="l41.2261" class="difflineplus">+</span>
<a href="#l41.2262"></a><span id="l41.2262">   gMessageNotificationBar.setJunkMsg(msgHdr);</span>
<a href="#l41.2263"></a><span id="l41.2263"> </span>
<a href="#l41.2264"></a><span id="l41.2264">   goUpdateCommand('button_delete');</span>
<a href="#l41.2265"></a><span id="l41.2265"> </span>
<a href="#l41.2266"></a><span id="l41.2266">   var markReadAutoMode = gPrefBranch.getBoolPref(&quot;mailnews.mark_message_read.auto&quot;);</span>
<a href="#l41.2267"></a><span id="l41.2267"> </span>
<a href="#l41.2268"></a><span id="l41.2268">   // We just finished loading a message. If messages are to be marked as read</span>
<a href="#l41.2269"></a><span id="l41.2269">   // automatically, set a timer to mark the message is read after n seconds</span>
<a href="#l41.2270"></a><span id="l41.2270" class="difflineat">@@ -3062,17 +3046,17 @@ function OnMsgLoaded(aUrl)</span>
<a href="#l41.2271"></a><span id="l41.2271">     {</span>
<a href="#l41.2272"></a><span id="l41.2272">       MarkMessageAsRead(msgHdr);</span>
<a href="#l41.2273"></a><span id="l41.2273">     }</span>
<a href="#l41.2274"></a><span id="l41.2274">   }</span>
<a href="#l41.2275"></a><span id="l41.2275"> </span>
<a href="#l41.2276"></a><span id="l41.2276">   // See if MDN was requested but has not been sent.</span>
<a href="#l41.2277"></a><span id="l41.2277">   HandleMDNResponse(aUrl);</span>
<a href="#l41.2278"></a><span id="l41.2278"> </span>
<a href="#l41.2279"></a><span id="l41.2279" class="difflineminus">-  if (!IsImapMessage(msgURI))</span>
<a href="#l41.2280"></a><span id="l41.2280" class="difflineplus">+  if (!gFolderDisplay.selectedMessageIsImap)</span>
<a href="#l41.2281"></a><span id="l41.2281">     return;</span>
<a href="#l41.2282"></a><span id="l41.2282"> </span>
<a href="#l41.2283"></a><span id="l41.2283">   var imapServer = folder.server.QueryInterface(Components.interfaces.nsIImapIncomingServer);</span>
<a href="#l41.2284"></a><span id="l41.2284">   if (imapServer.storeReadMailInPFC)</span>
<a href="#l41.2285"></a><span id="l41.2285">   {</span>
<a href="#l41.2286"></a><span id="l41.2286">     // Look in read mail PFC for msg with same msg id - if we find one,</span>
<a href="#l41.2287"></a><span id="l41.2287">     // don't put this message in the read mail pfc.</span>
<a href="#l41.2288"></a><span id="l41.2288">     var outputPFC = imapServer.GetReadMailPFC(true);</span>
<a href="#l41.2289"></a><span id="l41.2289" class="difflineat">@@ -3100,26 +3084,25 @@ function OnMsgLoaded(aUrl)</span>
<a href="#l41.2290"></a><span id="l41.2290">  * no need to check it either.</span>
<a href="#l41.2291"></a><span id="l41.2291">  */</span>
<a href="#l41.2292"></a><span id="l41.2292"> function HandleMDNResponse(aUrl)</span>
<a href="#l41.2293"></a><span id="l41.2293"> {</span>
<a href="#l41.2294"></a><span id="l41.2294">   if (!aUrl)</span>
<a href="#l41.2295"></a><span id="l41.2295">     return;</span>
<a href="#l41.2296"></a><span id="l41.2296"> </span>
<a href="#l41.2297"></a><span id="l41.2297">   var msgFolder = aUrl.folder;</span>
<a href="#l41.2298"></a><span id="l41.2298" class="difflineminus">-  var msgURI = GetLoadedMessage();</span>
<a href="#l41.2299"></a><span id="l41.2299" class="difflineminus">-  if (!msgFolder || !msgURI || IsNewsMessage(msgURI))</span>
<a href="#l41.2300"></a><span id="l41.2300" class="difflineplus">+  var msgHdr = gFolderDisplay.selectedMessage;</span>
<a href="#l41.2301"></a><span id="l41.2301" class="difflineplus">+  if (!msgFolder || !msgHdr || gFolderDisplay.selectedMessageIsNews)</span>
<a href="#l41.2302"></a><span id="l41.2302">     return;</span>
<a href="#l41.2303"></a><span id="l41.2303"> </span>
<a href="#l41.2304"></a><span id="l41.2304">   // if the message is marked as junk, do NOT attempt to process a return receipt</span>
<a href="#l41.2305"></a><span id="l41.2305">   // in order to better protect the user</span>
<a href="#l41.2306"></a><span id="l41.2306">   if (SelectedMessagesAreJunk())</span>
<a href="#l41.2307"></a><span id="l41.2307">     return;</span>
<a href="#l41.2308"></a><span id="l41.2308"> </span>
<a href="#l41.2309"></a><span id="l41.2309" class="difflineminus">-  var msgHdr = messenger.msgHdrFromURI(msgURI);</span>
<a href="#l41.2310"></a><span id="l41.2310">   var mimeHdr;</span>
<a href="#l41.2311"></a><span id="l41.2311"> </span>
<a href="#l41.2312"></a><span id="l41.2312">   try {</span>
<a href="#l41.2313"></a><span id="l41.2313">     mimeHdr = aUrl.mimeHeaders;</span>
<a href="#l41.2314"></a><span id="l41.2314">   } catch (ex) {</span>
<a href="#l41.2315"></a><span id="l41.2315">     return;</span>
<a href="#l41.2316"></a><span id="l41.2316">   }</span>
<a href="#l41.2317"></a><span id="l41.2317"> </span>
<a href="#l41.2318"></a><span id="l41.2318" class="difflineat">@@ -3159,30 +3142,26 @@ function HandleMDNResponse(aUrl)</span>
<a href="#l41.2319"></a><span id="l41.2319">   msgHdr.OrFlags(Components.interfaces.nsMsgMessageFlags.MDNReportSent);</span>
<a href="#l41.2320"></a><span id="l41.2320"> </span>
<a href="#l41.2321"></a><span id="l41.2321">   // Commit db changes.</span>
<a href="#l41.2322"></a><span id="l41.2322">   var msgdb = msgFolder.msgDatabase;</span>
<a href="#l41.2323"></a><span id="l41.2323">   if (msgdb)</span>
<a href="#l41.2324"></a><span id="l41.2324">     msgdb.Commit(ADDR_DB_LARGE_COMMIT);</span>
<a href="#l41.2325"></a><span id="l41.2325"> }</span>
<a href="#l41.2326"></a><span id="l41.2326"> </span>
<a href="#l41.2327"></a><span id="l41.2327" class="difflineminus">-function QuickSearchFocus() </span>
<a href="#l41.2328"></a><span id="l41.2328" class="difflineplus">+function QuickSearchFocus()</span>
<a href="#l41.2329"></a><span id="l41.2329"> {</span>
<a href="#l41.2330"></a><span id="l41.2330">   var quickSearchTextBox = document.getElementById('searchInput');</span>
<a href="#l41.2331"></a><span id="l41.2331">   if (quickSearchTextBox)</span>
<a href="#l41.2332"></a><span id="l41.2332">     quickSearchTextBox.focus();</span>
<a href="#l41.2333"></a><span id="l41.2333"> }</span>
<a href="#l41.2334"></a><span id="l41.2334"> </span>
<a href="#l41.2335"></a><span id="l41.2335"> function MsgSearchMessages()</span>
<a href="#l41.2336"></a><span id="l41.2336"> {</span>
<a href="#l41.2337"></a><span id="l41.2337" class="difflineminus">-  var preselectedFolder = null;</span>
<a href="#l41.2338"></a><span id="l41.2338" class="difflineminus">-  if (&quot;GetFirstSelectedMsgFolder&quot; in window)</span>
<a href="#l41.2339"></a><span id="l41.2339" class="difflineminus">-    preselectedFolder = GetFirstSelectedMsgFolder();</span>
<a href="#l41.2340"></a><span id="l41.2340" class="difflineminus">-</span>
<a href="#l41.2341"></a><span id="l41.2341" class="difflineminus">-  var args = { folder: preselectedFolder };</span>
<a href="#l41.2342"></a><span id="l41.2342" class="difflineplus">+  var args = { folder: gFolderDisplay.displayedFolder };</span>
<a href="#l41.2343"></a><span id="l41.2343">   OpenOrFocusWindow(args, &quot;mailnews:search&quot;, &quot;chrome://messenger/content/SearchDialog.xul&quot;);</span>
<a href="#l41.2344"></a><span id="l41.2344"> }</span>
<a href="#l41.2345"></a><span id="l41.2345"> </span>
<a href="#l41.2346"></a><span id="l41.2346"> function MsgJunkMailInfo(aCheckFirstUse)</span>
<a href="#l41.2347"></a><span id="l41.2347"> {</span>
<a href="#l41.2348"></a><span id="l41.2348">   if (aCheckFirstUse) {</span>
<a href="#l41.2349"></a><span id="l41.2349">     if (!pref.getBoolPref(&quot;mailnews.ui.junk.firstuse&quot;))</span>
<a href="#l41.2350"></a><span id="l41.2350">       return;</span>
<a href="#l41.2351"></a><span id="l41.2351" class="difflineat">@@ -3206,17 +3185,17 @@ function MsgJunkMailInfo(aCheckFirstUse)</span>
<a href="#l41.2352"></a><span id="l41.2352">                       &quot;centerscreen,resizeable=no,titlebar,chrome,modal&quot;, null);</span>
<a href="#l41.2353"></a><span id="l41.2353"> }</span>
<a href="#l41.2354"></a><span id="l41.2354"> </span>
<a href="#l41.2355"></a><span id="l41.2355"> function MsgSearchAddresses()</span>
<a href="#l41.2356"></a><span id="l41.2356"> {</span>
<a href="#l41.2357"></a><span id="l41.2357">   var args = { directory: null };</span>
<a href="#l41.2358"></a><span id="l41.2358">   OpenOrFocusWindow(args, &quot;mailnews:absearch&quot;, &quot;chrome://messenger/content/ABSearchDialog.xul&quot;);</span>
<a href="#l41.2359"></a><span id="l41.2359"> }</span>
<a href="#l41.2360"></a><span id="l41.2360" class="difflineminus">- </span>
<a href="#l41.2361"></a><span id="l41.2361" class="difflineplus">+</span>
<a href="#l41.2362"></a><span id="l41.2362"> function MsgFilterList(args)</span>
<a href="#l41.2363"></a><span id="l41.2363"> {</span>
<a href="#l41.2364"></a><span id="l41.2364">   OpenOrFocusWindow(args, &quot;mailnews:filterlist&quot;, &quot;chrome://messenger/content/FilterListDialog.xul&quot;);</span>
<a href="#l41.2365"></a><span id="l41.2365"> }</span>
<a href="#l41.2366"></a><span id="l41.2366"> </span>
<a href="#l41.2367"></a><span id="l41.2367"> function GetWindowByWindowType(windowType)</span>
<a href="#l41.2368"></a><span id="l41.2368"> {</span>
<a href="#l41.2369"></a><span id="l41.2369">   var windowManager = Components.classes['@mozilla.org/appshell/window-mediator;1']</span>
<a href="#l41.2370"></a><span id="l41.2370" class="difflineat">@@ -3244,17 +3223,17 @@ function FeedSetContentViewToggle()</span>
<a href="#l41.2371"></a><span id="l41.2371">   gShowFeedSummaryToggle = true;</span>
<a href="#l41.2372"></a><span id="l41.2372">   FeedSetContentView(gShowFeedSummary ? 0 : 1);</span>
<a href="#l41.2373"></a><span id="l41.2373"> }</span>
<a href="#l41.2374"></a><span id="l41.2374"> </span>
<a href="#l41.2375"></a><span id="l41.2375"> // Check message format</span>
<a href="#l41.2376"></a><span id="l41.2376"> function FeedCheckContentFormat()</span>
<a href="#l41.2377"></a><span id="l41.2377"> {</span>
<a href="#l41.2378"></a><span id="l41.2378">   // Not an rss message</span>
<a href="#l41.2379"></a><span id="l41.2379" class="difflineminus">-  if (!IsFeedItem())</span>
<a href="#l41.2380"></a><span id="l41.2380" class="difflineplus">+  if (!gFolderDisplay.selectedMessageIsFeed)</span>
<a href="#l41.2381"></a><span id="l41.2381">     return false;</span>
<a href="#l41.2382"></a><span id="l41.2382"> </span>
<a href="#l41.2383"></a><span id="l41.2383">   var contentWindowDoc = window.top.content.document;</span>
<a href="#l41.2384"></a><span id="l41.2384"> </span>
<a href="#l41.2385"></a><span id="l41.2385">   // Thunderbird 2 rss messages with 'Show article summary' not selected,</span>
<a href="#l41.2386"></a><span id="l41.2386">   // ie message body constructed to show web page in an iframe, can't show</span>
<a href="#l41.2387"></a><span id="l41.2387">   // a summary - notify user.</span>
<a href="#l41.2388"></a><span id="l41.2388">   var rssIframe = contentWindowDoc.getElementById('_mailrssiframe');</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l42.1"></a><span id="l42.1" class="difflineminus">--- a/mail/base/content/mailWindowOverlay.xul</span>
<a href="#l42.2"></a><span id="l42.2" class="difflineplus">+++ b/mail/base/content/mailWindowOverlay.xul</span>
<a href="#l42.3"></a><span id="l42.3" class="difflineat">@@ -57,16 +57,18 @@</span>
<a href="#l42.4"></a><span id="l42.4">   %brandDTD;</span>
<a href="#l42.5"></a><span id="l42.5"> ]&gt;</span>
<a href="#l42.6"></a><span id="l42.6"> </span>
<a href="#l42.7"></a><span id="l42.7"> &lt;overlay xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;&gt;</span>
<a href="#l42.8"></a><span id="l42.8"> </span>
<a href="#l42.9"></a><span id="l42.9"> &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://messenger/content/mailCommands.js&quot;/&gt;</span>
<a href="#l42.10"></a><span id="l42.10"> &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://messenger/content/junkCommands.js&quot;/&gt;</span>
<a href="#l42.11"></a><span id="l42.11"> &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://messenger/content/mailWindowOverlay.js&quot;/&gt;</span>
<a href="#l42.12"></a><span id="l42.12" class="difflineplus">+&lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://messenger/content/messageDisplay.js&quot;/&gt;</span>
<a href="#l42.13"></a><span id="l42.13" class="difflineplus">+&lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://messenger/content/folderDisplay.js&quot;/&gt;</span>
<a href="#l42.14"></a><span id="l42.14"> &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://messenger-newsblog/content/newsblogOverlay.js&quot;/&gt;</span>
<a href="#l42.15"></a><span id="l42.15"> &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://messenger/content/mail-offline.js&quot;/&gt;</span>
<a href="#l42.16"></a><span id="l42.16"> &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://global/content/printUtils.js&quot;/&gt;</span>
<a href="#l42.17"></a><span id="l42.17"> &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://messenger/content/msgViewPickerOverlay.js&quot;/&gt;</span>
<a href="#l42.18"></a><span id="l42.18"> &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://global/content/viewZoomOverlay.js&quot;/&gt;</span>
<a href="#l42.19"></a><span id="l42.19"> </span>
<a href="#l42.20"></a><span id="l42.20"> &lt;stringbundleset id=&quot;stringbundleset&quot;&gt;</span>
<a href="#l42.21"></a><span id="l42.21">   &lt;stringbundle id=&quot;bundle_messenger&quot; src=&quot;chrome://messenger/locale/messenger.properties&quot;/&gt;</span>
<a href="#l42.22"></a><span id="l42.22" class="difflineat">@@ -722,17 +724,17 @@</span>
<a href="#l42.23"></a><span id="l42.23">               oncommand=&quot;MsgGetMessage();&quot;/&gt;</span>
<a href="#l42.24"></a><span id="l42.24">     &lt;menuitem id=&quot;folderPaneContext-openNewWindow&quot;</span>
<a href="#l42.25"></a><span id="l42.25">               label=&quot;&amp;folderContextOpenNewWindow.label;&quot;</span>
<a href="#l42.26"></a><span id="l42.26">               accesskey=&quot;&amp;folderContextOpenNewWindow.accesskey;&quot;</span>
<a href="#l42.27"></a><span id="l42.27">               oncommand=&quot;MsgOpenNewWindowForFolder(null,-1);&quot;/&gt;</span>
<a href="#l42.28"></a><span id="l42.28">     &lt;menuitem id=&quot;folderPaneContext-openNewTab&quot;</span>
<a href="#l42.29"></a><span id="l42.29">               label=&quot;&amp;folderContextOpenNewTab.label;&quot;</span>
<a href="#l42.30"></a><span id="l42.30">               accesskey=&quot;&amp;folderContextOpenNewTab.accesskey;&quot;</span>
<a href="#l42.31"></a><span id="l42.31" class="difflineminus">-              oncommand=&quot;MsgOpenNewTabForFolder(null,-1);&quot;/&gt;</span>
<a href="#l42.32"></a><span id="l42.32" class="difflineplus">+              oncommand=&quot;MsgOpenNewTabForFolder();&quot;/&gt;</span>
<a href="#l42.33"></a><span id="l42.33">     &lt;menuitem id=&quot;folderPaneContext-searchMessages&quot;</span>
<a href="#l42.34"></a><span id="l42.34">               label=&quot;&amp;folderContextSearchMessages.label;&quot;</span>
<a href="#l42.35"></a><span id="l42.35">               accesskey=&quot;&amp;folderContextSearchMessages.accesskey;&quot;</span>
<a href="#l42.36"></a><span id="l42.36">               command=&quot;cmd_search&quot;/&gt;</span>
<a href="#l42.37"></a><span id="l42.37">     &lt;menuitem id=&quot;folderPaneContext-subscribe&quot;</span>
<a href="#l42.38"></a><span id="l42.38">               label=&quot;&amp;folderContextSubscribe.label;&quot;</span>
<a href="#l42.39"></a><span id="l42.39">               accesskey=&quot;&amp;folderContextSubscribe.accesskey;&quot;</span>
<a href="#l42.40"></a><span id="l42.40">               oncommand=&quot;MsgSubscribe();&quot;/&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l43.1"></a><span id="l43.1">new file mode 100644</span>
<a href="#l43.2"></a><span id="l43.2" class="difflineminus">--- /dev/null</span>
<a href="#l43.3"></a><span id="l43.3" class="difflineplus">+++ b/mail/base/content/messageDisplay.js</span>
<a href="#l43.4"></a><span id="l43.4" class="difflineat">@@ -0,0 +1,468 @@</span>
<a href="#l43.5"></a><span id="l43.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l43.6"></a><span id="l43.6" class="difflineplus">+ *   Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l43.7"></a><span id="l43.7" class="difflineplus">+ *</span>
<a href="#l43.8"></a><span id="l43.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l43.9"></a><span id="l43.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l43.10"></a><span id="l43.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l43.11"></a><span id="l43.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l43.12"></a><span id="l43.12" class="difflineplus">+ *</span>
<a href="#l43.13"></a><span id="l43.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l43.14"></a><span id="l43.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l43.15"></a><span id="l43.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l43.16"></a><span id="l43.16" class="difflineplus">+ * License.</span>
<a href="#l43.17"></a><span id="l43.17" class="difflineplus">+ *</span>
<a href="#l43.18"></a><span id="l43.18" class="difflineplus">+ * The Original Code is Thunderbird Mail Client.</span>
<a href="#l43.19"></a><span id="l43.19" class="difflineplus">+ *</span>
<a href="#l43.20"></a><span id="l43.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l43.21"></a><span id="l43.21" class="difflineplus">+ * Mozilla Messaging, Inc.</span>
<a href="#l43.22"></a><span id="l43.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l43.23"></a><span id="l43.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l43.24"></a><span id="l43.24" class="difflineplus">+ *</span>
<a href="#l43.25"></a><span id="l43.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l43.26"></a><span id="l43.26" class="difflineplus">+ *   Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a href="#l43.27"></a><span id="l43.27" class="difflineplus">+ *   David Bienvenu &lt;bienvenu@nventure.com&gt;</span>
<a href="#l43.28"></a><span id="l43.28" class="difflineplus">+ *   Siddharth Agarwal &lt;sid.bugzilla@gmail.com&gt;</span>
<a href="#l43.29"></a><span id="l43.29" class="difflineplus">+ *</span>
<a href="#l43.30"></a><span id="l43.30" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l43.31"></a><span id="l43.31" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l43.32"></a><span id="l43.32" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l43.33"></a><span id="l43.33" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l43.34"></a><span id="l43.34" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l43.35"></a><span id="l43.35" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l43.36"></a><span id="l43.36" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l43.37"></a><span id="l43.37" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l43.38"></a><span id="l43.38" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l43.39"></a><span id="l43.39" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l43.40"></a><span id="l43.40" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l43.41"></a><span id="l43.41" class="difflineplus">+ *</span>
<a href="#l43.42"></a><span id="l43.42" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l43.43"></a><span id="l43.43" class="difflineplus">+</span>
<a href="#l43.44"></a><span id="l43.44" class="difflineplus">+/**</span>
<a href="#l43.45"></a><span id="l43.45" class="difflineplus">+ * Base abstraction for message display along the line of FolderDisplayWidget,</span>
<a href="#l43.46"></a><span id="l43.46" class="difflineplus">+ *  but for message display.  This really only exists to keep</span>
<a href="#l43.47"></a><span id="l43.47" class="difflineplus">+ *  FolderDisplayWidget manageable and free from taking on responsibility for</span>
<a href="#l43.48"></a><span id="l43.48" class="difflineplus">+ *  the (different) horrors of message display.  The reality of the situation</span>
<a href="#l43.49"></a><span id="l43.49" class="difflineplus">+ *  is that FolderDisplayWidget still has a lot to do with message display,</span>
<a href="#l43.50"></a><span id="l43.50" class="difflineplus">+ *  and so we are just where helper logic gets to live, but the FDW still</span>
<a href="#l43.51"></a><span id="l43.51" class="difflineplus">+ *  may deal with some things internally.</span>
<a href="#l43.52"></a><span id="l43.52" class="difflineplus">+ * You should not use this class directly, but rather its friendly subclasses</span>
<a href="#l43.53"></a><span id="l43.53" class="difflineplus">+ *  that live later in this file.</span>
<a href="#l43.54"></a><span id="l43.54" class="difflineplus">+ */</span>
<a href="#l43.55"></a><span id="l43.55" class="difflineplus">+function MessageDisplayWidget() {</span>
<a href="#l43.56"></a><span id="l43.56" class="difflineplus">+}</span>
<a href="#l43.57"></a><span id="l43.57" class="difflineplus">+MessageDisplayWidget.prototype = {</span>
<a href="#l43.58"></a><span id="l43.58" class="difflineplus">+  _active: false,</span>
<a href="#l43.59"></a><span id="l43.59" class="difflineplus">+  get active MessageDisplayWidget_get_active() {</span>
<a href="#l43.60"></a><span id="l43.60" class="difflineplus">+    return this._active;</span>
<a href="#l43.61"></a><span id="l43.61" class="difflineplus">+  },</span>
<a href="#l43.62"></a><span id="l43.62" class="difflineplus">+</span>
<a href="#l43.63"></a><span id="l43.63" class="difflineplus">+  /**</span>
<a href="#l43.64"></a><span id="l43.64" class="difflineplus">+   * Track whether the single message display pane is desired to be displayed</span>
<a href="#l43.65"></a><span id="l43.65" class="difflineplus">+   *  (it is actually displayed when active, does't matter when not), or</span>
<a href="#l43.66"></a><span id="l43.66" class="difflineplus">+   *  otherwise the multiple message display pane is desired to be displayed.</span>
<a href="#l43.67"></a><span id="l43.67" class="difflineplus">+   */</span>
<a href="#l43.68"></a><span id="l43.68" class="difflineplus">+  _singleMessageDisplay: null,</span>
<a href="#l43.69"></a><span id="l43.69" class="difflineplus">+  get singleMessageDisplay MessageDisplayWidget_get_singleMessageDisplay() {</span>
<a href="#l43.70"></a><span id="l43.70" class="difflineplus">+    // when null, assume single message display</span>
<a href="#l43.71"></a><span id="l43.71" class="difflineplus">+    return this._singleMessageDisplay != false;</span>
<a href="#l43.72"></a><span id="l43.72" class="difflineplus">+  },</span>
<a href="#l43.73"></a><span id="l43.73" class="difflineplus">+  set singleMessageDisplay MessageDisplayWidget_set_singleMessageDisplay(</span>
<a href="#l43.74"></a><span id="l43.74" class="difflineplus">+      aSingleDisplay) {</span>
<a href="#l43.75"></a><span id="l43.75" class="difflineplus">+    if (this._singleMessageDisplay != aSingleDisplay) {</span>
<a href="#l43.76"></a><span id="l43.76" class="difflineplus">+      this._singleMessageDisplay = aSingleDisplay;</span>
<a href="#l43.77"></a><span id="l43.77" class="difflineplus">+      if (this._active)</span>
<a href="#l43.78"></a><span id="l43.78" class="difflineplus">+        this._updateActiveMessagePane();</span>
<a href="#l43.79"></a><span id="l43.79" class="difflineplus">+    }</span>
<a href="#l43.80"></a><span id="l43.80" class="difflineplus">+  },</span>
<a href="#l43.81"></a><span id="l43.81" class="difflineplus">+</span>
<a href="#l43.82"></a><span id="l43.82" class="difflineplus">+  /**</span>
<a href="#l43.83"></a><span id="l43.83" class="difflineplus">+   * Set pane visibility based on this.singleMessageDisplay.</span>
<a href="#l43.84"></a><span id="l43.84" class="difflineplus">+   */</span>
<a href="#l43.85"></a><span id="l43.85" class="difflineplus">+  _updateActiveMessagePane: function MessageDisplayWidget_updateMessagePane() {</span>
<a href="#l43.86"></a><span id="l43.86" class="difflineplus">+    // _singleMessageDisplay can be null, so use the property (getter)</span>
<a href="#l43.87"></a><span id="l43.87" class="difflineplus">+    document.getElementById(&quot;singlemessage&quot;).hidden =</span>
<a href="#l43.88"></a><span id="l43.88" class="difflineplus">+      !this.singleMessageDisplay;</span>
<a href="#l43.89"></a><span id="l43.89" class="difflineplus">+    document.getElementById(&quot;multimessage&quot;).hidden =</span>
<a href="#l43.90"></a><span id="l43.90" class="difflineplus">+      this.singleMessageDisplay;</span>
<a href="#l43.91"></a><span id="l43.91" class="difflineplus">+  },</span>
<a href="#l43.92"></a><span id="l43.92" class="difflineplus">+</span>
<a href="#l43.93"></a><span id="l43.93" class="difflineplus">+  /**</span>
<a href="#l43.94"></a><span id="l43.94" class="difflineplus">+   * Cleanup the MessageDisplayWidget in preparation for going away.  Called by</span>
<a href="#l43.95"></a><span id="l43.95" class="difflineplus">+   *  FolderDisplayWidget's close method.</span>
<a href="#l43.96"></a><span id="l43.96" class="difflineplus">+   */</span>
<a href="#l43.97"></a><span id="l43.97" class="difflineplus">+  _close: function MessageDisplayWidget_close() {</span>
<a href="#l43.98"></a><span id="l43.98" class="difflineplus">+    // mark ourselves inactive without doing any work.</span>
<a href="#l43.99"></a><span id="l43.99" class="difflineplus">+    this._active = false;</span>
<a href="#l43.100"></a><span id="l43.100" class="difflineplus">+  },</span>
<a href="#l43.101"></a><span id="l43.101" class="difflineplus">+</span>
<a href="#l43.102"></a><span id="l43.102" class="difflineplus">+  /**</span>
<a href="#l43.103"></a><span id="l43.103" class="difflineplus">+   * The FolderDisplayWidget that owns us.</span>
<a href="#l43.104"></a><span id="l43.104" class="difflineplus">+   */</span>
<a href="#l43.105"></a><span id="l43.105" class="difflineplus">+  folderDisplay: null,</span>
<a href="#l43.106"></a><span id="l43.106" class="difflineplus">+  /**</span>
<a href="#l43.107"></a><span id="l43.107" class="difflineplus">+   * The currently displayed message's nsIMsgDBHdr.  null if there's no message.</span>
<a href="#l43.108"></a><span id="l43.108" class="difflineplus">+   */</span>
<a href="#l43.109"></a><span id="l43.109" class="difflineplus">+  displayedMessage: null,</span>
<a href="#l43.110"></a><span id="l43.110" class="difflineplus">+</span>
<a href="#l43.111"></a><span id="l43.111" class="difflineplus">+  clearDisplay: function MessageDisplayWidget_clearDisplay() {</span>
<a href="#l43.112"></a><span id="l43.112" class="difflineplus">+    this.displayedMessage = null;</span>
<a href="#l43.113"></a><span id="l43.113" class="difflineplus">+    this.messageLoading = false;</span>
<a href="#l43.114"></a><span id="l43.114" class="difflineplus">+    this.messageLoaded = false;</span>
<a href="#l43.115"></a><span id="l43.115" class="difflineplus">+    ClearPendingReadTimer();</span>
<a href="#l43.116"></a><span id="l43.116" class="difflineplus">+    ClearMessagePane();</span>
<a href="#l43.117"></a><span id="l43.117" class="difflineplus">+  },</span>
<a href="#l43.118"></a><span id="l43.118" class="difflineplus">+</span>
<a href="#l43.119"></a><span id="l43.119" class="difflineplus">+  onCreatedView: function MessageDisplayWidget_onCreatedView() {</span>
<a href="#l43.120"></a><span id="l43.120" class="difflineplus">+    // we need to compel setting this because nsMsgSearchDBView defaults it on</span>
<a href="#l43.121"></a><span id="l43.121" class="difflineplus">+    this.folderDisplay.view.dbView.suppressMsgDisplay = !this.visible;</span>
<a href="#l43.122"></a><span id="l43.122" class="difflineplus">+  },</span>
<a href="#l43.123"></a><span id="l43.123" class="difflineplus">+</span>
<a href="#l43.124"></a><span id="l43.124" class="difflineplus">+  /**</span>
<a href="#l43.125"></a><span id="l43.125" class="difflineplus">+   * FolderDisplayWidget tells us when it is killing the view, which means our</span>
<a href="#l43.126"></a><span id="l43.126" class="difflineplus">+   *  displayed message is no longer valid.</span>
<a href="#l43.127"></a><span id="l43.127" class="difflineplus">+   */</span>
<a href="#l43.128"></a><span id="l43.128" class="difflineplus">+  onDestroyingView: function MessageDisplayWidget_onDestroyingView(</span>
<a href="#l43.129"></a><span id="l43.129" class="difflineplus">+      aFolderIsComingBack) {</span>
<a href="#l43.130"></a><span id="l43.130" class="difflineplus">+    this.displayedMessage = null;</span>
<a href="#l43.131"></a><span id="l43.131" class="difflineplus">+    // The only time we want to do anything is when the folder is not coming</span>
<a href="#l43.132"></a><span id="l43.132" class="difflineplus">+    //  back.  If it is coming back, we can handle things when it shows up.</span>
<a href="#l43.133"></a><span id="l43.133" class="difflineplus">+    if (!aFolderIsComingBack &amp;&amp; this._active) {</span>
<a href="#l43.134"></a><span id="l43.134" class="difflineplus">+      // and in this case, we just want to clear things.</span>
<a href="#l43.135"></a><span id="l43.135" class="difflineplus">+      this.clearDisplay();</span>
<a href="#l43.136"></a><span id="l43.136" class="difflineplus">+      this.singleMessageDisplay = true;</span>
<a href="#l43.137"></a><span id="l43.137" class="difflineplus">+    }</span>
<a href="#l43.138"></a><span id="l43.138" class="difflineplus">+  },</span>
<a href="#l43.139"></a><span id="l43.139" class="difflineplus">+</span>
<a href="#l43.140"></a><span id="l43.140" class="difflineplus">+  /**</span>
<a href="#l43.141"></a><span id="l43.141" class="difflineplus">+   * FolderDisplayWidget tells us when a message is being displayed.</span>
<a href="#l43.142"></a><span id="l43.142" class="difflineplus">+   */</span>
<a href="#l43.143"></a><span id="l43.143" class="difflineplus">+  onDisplayingMessage: function MessageDisplayWidget_onDisplayingMessage(</span>
<a href="#l43.144"></a><span id="l43.144" class="difflineplus">+      aMsgHdr) {</span>
<a href="#l43.145"></a><span id="l43.145" class="difflineplus">+    this.displayedMessage = aMsgHdr;</span>
<a href="#l43.146"></a><span id="l43.146" class="difflineplus">+    this.messageLoading = true;</span>
<a href="#l43.147"></a><span id="l43.147" class="difflineplus">+    this.messageLoaded = false;</span>
<a href="#l43.148"></a><span id="l43.148" class="difflineplus">+  },</span>
<a href="#l43.149"></a><span id="l43.149" class="difflineplus">+</span>
<a href="#l43.150"></a><span id="l43.150" class="difflineplus">+  /**</span>
<a href="#l43.151"></a><span id="l43.151" class="difflineplus">+   * The maximum number of messages to summarize at any given time.  If there</span>
<a href="#l43.152"></a><span id="l43.152" class="difflineplus">+   *  are more messages than this, we don't summarize, and instead give a blank</span>
<a href="#l43.153"></a><span id="l43.153" class="difflineplus">+   *  window pane.  Arguably something that says &quot;there are two many messages&quot;</span>
<a href="#l43.154"></a><span id="l43.154" class="difflineplus">+   *  would be a better idea.</span>
<a href="#l43.155"></a><span id="l43.155" class="difflineplus">+   */</span>
<a href="#l43.156"></a><span id="l43.156" class="difflineplus">+  MAX_MESSAGES_TO_SUMMARIZE: 100,</span>
<a href="#l43.157"></a><span id="l43.157" class="difflineplus">+</span>
<a href="#l43.158"></a><span id="l43.158" class="difflineplus">+  /**</span>
<a href="#l43.159"></a><span id="l43.159" class="difflineplus">+   * FolderDisplayWidget tells us when the set of selected messages has changed.</span>
<a href="#l43.160"></a><span id="l43.160" class="difflineplus">+   *  FDW is doing this because an nsMsgDBView/subclass called</span>
<a href="#l43.161"></a><span id="l43.161" class="difflineplus">+   *  summarizeSelection.  Although the call is purely an outgrowth of the</span>
<a href="#l43.162"></a><span id="l43.162" class="difflineplus">+   *  introduction of folder summaries, it also provides a means for us to</span>
<a href="#l43.163"></a><span id="l43.163" class="difflineplus">+   *  completely replace the nsMsgDBView logic.  Namely, we get first bat at</span>
<a href="#l43.164"></a><span id="l43.164" class="difflineplus">+   *  taking an action as a result of the selection change, and we can cause the</span>
<a href="#l43.165"></a><span id="l43.165" class="difflineplus">+   *  nsMsgDBView to not do anything (by returning true).</span>
<a href="#l43.166"></a><span id="l43.166" class="difflineplus">+   * This notification will come prior to an onDisplayingMessage notification,</span>
<a href="#l43.167"></a><span id="l43.167" class="difflineplus">+   *  and we will only get that notification if we return false and the</span>
<a href="#l43.168"></a><span id="l43.168" class="difflineplus">+   *  nsMsgDBView logic wanted to display a message (read: there is exactly</span>
<a href="#l43.169"></a><span id="l43.169" class="difflineplus">+   *  one message displayed and it wasn't already displayed.)</span>
<a href="#l43.170"></a><span id="l43.170" class="difflineplus">+   *</span>
<a href="#l43.171"></a><span id="l43.171" class="difflineplus">+   * The prime responsibilities of this function are:</span>
<a href="#l43.172"></a><span id="l43.172" class="difflineplus">+   * - To make sure the right message pane (single or multi) is displayed.</span>
<a href="#l43.173"></a><span id="l43.173" class="difflineplus">+   * - To kick off a multi-message or thread summarization if multiple messages</span>
<a href="#l43.174"></a><span id="l43.174" class="difflineplus">+   *   are selected.</span>
<a href="#l43.175"></a><span id="l43.175" class="difflineplus">+   * - To throttle the rate at which we perform summarizations in case the</span>
<a href="#l43.176"></a><span id="l43.176" class="difflineplus">+   *   selection is being updated frequently.  This could be as a result of the</span>
<a href="#l43.177"></a><span id="l43.177" class="difflineplus">+   *   user holding down shift and using their keyboard to expand the selection,</span>
<a href="#l43.178"></a><span id="l43.178" class="difflineplus">+   *   use of the archive mechanism, or other.</span>
<a href="#l43.179"></a><span id="l43.179" class="difflineplus">+   * - To clear the message pane if no messages are selected.  This used to be</span>
<a href="#l43.180"></a><span id="l43.180" class="difflineplus">+   *   triggered by nsMsgDBView::SelectionChanged but is now our responsibility.</span>
<a href="#l43.181"></a><span id="l43.181" class="difflineplus">+   *</span>
<a href="#l43.182"></a><span id="l43.182" class="difflineplus">+   * In the event that the controlling preference for message summarization is</span>
<a href="#l43.183"></a><span id="l43.183" class="difflineplus">+   *  not enabled (mail.operate_on_msgs_in_collapsed_threads), and there is a</span>
<a href="#l43.184"></a><span id="l43.184" class="difflineplus">+   *  multi-selection, we just clear the display.</span>
<a href="#l43.185"></a><span id="l43.185" class="difflineplus">+   *</span>
<a href="#l43.186"></a><span id="l43.186" class="difflineplus">+   * @return true if we handled the selection notification and the nsMsgDBView</span>
<a href="#l43.187"></a><span id="l43.187" class="difflineplus">+   *  should do nothing, false if we did not and the nsMsgDBView should use its</span>
<a href="#l43.188"></a><span id="l43.188" class="difflineplus">+   *  logic to display a message.</span>
<a href="#l43.189"></a><span id="l43.189" class="difflineplus">+   */</span>
<a href="#l43.190"></a><span id="l43.190" class="difflineplus">+  onSelectedMessagesChanged:</span>
<a href="#l43.191"></a><span id="l43.191" class="difflineplus">+      function MessageDisplayWidget_onSelectedMessagesChanged() {</span>
<a href="#l43.192"></a><span id="l43.192" class="difflineplus">+    // If we are not active, we should not be touching things.  pretend we are</span>
<a href="#l43.193"></a><span id="l43.193" class="difflineplus">+    //  handling whatever is happening so the nsMsgDBView doesn't try and do</span>
<a href="#l43.194"></a><span id="l43.194" class="difflineplus">+    //  anything.  makeActive will trigger a fake SelectionChanged notification</span>
<a href="#l43.195"></a><span id="l43.195" class="difflineplus">+    //  when we switch, which should put everything in its right place.</span>
<a href="#l43.196"></a><span id="l43.196" class="difflineplus">+    if (!this.active)</span>
<a href="#l43.197"></a><span id="l43.197" class="difflineplus">+      return true;</span>
<a href="#l43.198"></a><span id="l43.198" class="difflineplus">+</span>
<a href="#l43.199"></a><span id="l43.199" class="difflineplus">+    let selectedCount = this.folderDisplay.selectedCount;</span>
<a href="#l43.200"></a><span id="l43.200" class="difflineplus">+</span>
<a href="#l43.201"></a><span id="l43.201" class="difflineplus">+    if (selectedCount == 0) {</span>
<a href="#l43.202"></a><span id="l43.202" class="difflineplus">+      // davida, put your folder summary stuff here.</span>
<a href="#l43.203"></a><span id="l43.203" class="difflineplus">+      this.clearDisplay();</span>
<a href="#l43.204"></a><span id="l43.204" class="difflineplus">+      this.singleMessageDisplay = true;</span>
<a href="#l43.205"></a><span id="l43.205" class="difflineplus">+    }</span>
<a href="#l43.206"></a><span id="l43.206" class="difflineplus">+    else if (selectedCount == 1) {</span>
<a href="#l43.207"></a><span id="l43.207" class="difflineplus">+      // the display of the message is happening without us</span>
<a href="#l43.208"></a><span id="l43.208" class="difflineplus">+      this.singleMessageDisplay = true;</span>
<a href="#l43.209"></a><span id="l43.209" class="difflineplus">+</span>
<a href="#l43.210"></a><span id="l43.210" class="difflineplus">+      // This is the only case we don't handle and want the nsMsgDBView to</span>
<a href="#l43.211"></a><span id="l43.211" class="difflineplus">+      //  take care of.</span>
<a href="#l43.212"></a><span id="l43.212" class="difflineplus">+      return false;</span>
<a href="#l43.213"></a><span id="l43.213" class="difflineplus">+    }</span>
<a href="#l43.214"></a><span id="l43.214" class="difflineplus">+    // we have a limit on the number of messages and if the pref is enabled</span>
<a href="#l43.215"></a><span id="l43.215" class="difflineplus">+    else if ((selectedCount &lt; this.MAX_MESSAGES_TO_SUMMARIZE) &amp;&amp;</span>
<a href="#l43.216"></a><span id="l43.216" class="difflineplus">+        gPrefBranch.getBoolPref(&quot;mail.operate_on_msgs_in_collapsed_threads&quot;)) {</span>
<a href="#l43.217"></a><span id="l43.217" class="difflineplus">+      // _showSummary is responsible for handling the &quot;don't resummarize too</span>
<a href="#l43.218"></a><span id="l43.218" class="difflineplus">+      //  often&quot; logic, as well as updating singleMessageDisplay.</span>
<a href="#l43.219"></a><span id="l43.219" class="difflineplus">+      this._showSummary();</span>
<a href="#l43.220"></a><span id="l43.220" class="difflineplus">+    }</span>
<a href="#l43.221"></a><span id="l43.221" class="difflineplus">+    // and so we clear things</span>
<a href="#l43.222"></a><span id="l43.222" class="difflineplus">+    else {</span>
<a href="#l43.223"></a><span id="l43.223" class="difflineplus">+      this.clearDisplay();</span>
<a href="#l43.224"></a><span id="l43.224" class="difflineplus">+      this.singleMessageDisplay = true;</span>
<a href="#l43.225"></a><span id="l43.225" class="difflineplus">+    }</span>
<a href="#l43.226"></a><span id="l43.226" class="difflineplus">+</span>
<a href="#l43.227"></a><span id="l43.227" class="difflineplus">+    return true;</span>
<a href="#l43.228"></a><span id="l43.228" class="difflineplus">+  },</span>
<a href="#l43.229"></a><span id="l43.229" class="difflineplus">+</span>
<a href="#l43.230"></a><span id="l43.230" class="difflineplus">+  /**</span>
<a href="#l43.231"></a><span id="l43.231" class="difflineplus">+   * If we are already summarized and we get a new request to summarize, require</span>
<a href="#l43.232"></a><span id="l43.232" class="difflineplus">+   *  that the selection has been stable for at least this many milliseconds</span>
<a href="#l43.233"></a><span id="l43.233" class="difflineplus">+   *  before resummarizing.</span>
<a href="#l43.234"></a><span id="l43.234" class="difflineplus">+   * Unit tests know about this variable and poke at it, so don't change the name</span>
<a href="#l43.235"></a><span id="l43.235" class="difflineplus">+   *  without making sure you update the unit tests.  (Not that you would commit</span>
<a href="#l43.236"></a><span id="l43.236" class="difflineplus">+   *  code without first running all tests yourself...)</span>
<a href="#l43.237"></a><span id="l43.237" class="difflineplus">+   */</span>
<a href="#l43.238"></a><span id="l43.238" class="difflineplus">+  SUMMARIZATION_SELECTION_STABILITY_INTERVAL_MS: 100,</span>
<a href="#l43.239"></a><span id="l43.239" class="difflineplus">+  /**</span>
<a href="#l43.240"></a><span id="l43.240" class="difflineplus">+   * The timeout ID resulting from the call to window.setTimeout that we are</span>
<a href="#l43.241"></a><span id="l43.241" class="difflineplus">+   *  using to require the selection be 'stabilized' before re-summarizing.</span>
<a href="#l43.242"></a><span id="l43.242" class="difflineplus">+   */</span>
<a href="#l43.243"></a><span id="l43.243" class="difflineplus">+  _summaryStabilityTimeout: null,</span>
<a href="#l43.244"></a><span id="l43.244" class="difflineplus">+</span>
<a href="#l43.245"></a><span id="l43.245" class="difflineplus">+  /**</span>
<a href="#l43.246"></a><span id="l43.246" class="difflineplus">+   * Updates message summaries with care to throttle the summarization when the</span>
<a href="#l43.247"></a><span id="l43.247" class="difflineplus">+   *  selection is rapidly changing.  We require that either we have not</span>
<a href="#l43.248"></a><span id="l43.248" class="difflineplus">+   *  summarized anything 'recently', or that the selection has been stable for</span>
<a href="#l43.249"></a><span id="l43.249" class="difflineplus">+   *  SUMMARIZATION_SELECTION_STABILITY_INTERVAL_MS ms before we update the</span>
<a href="#l43.250"></a><span id="l43.250" class="difflineplus">+   *  summary.  'Recently' for our purposes means that it has been at least</span>
<a href="#l43.251"></a><span id="l43.251" class="difflineplus">+   *  SUMMARIZATION_SELECTION_STABILITY_INTERVAL_MS ms since our last summary.</span>
<a href="#l43.252"></a><span id="l43.252" class="difflineplus">+   *</span>
<a href="#l43.253"></a><span id="l43.253" class="difflineplus">+   * Example event sequences (assuming a 100ms stability interval):</span>
<a href="#l43.254"></a><span id="l43.254" class="difflineplus">+   * - User selects a collapsed thread =&gt; we summarize the selection and set a</span>
<a href="#l43.255"></a><span id="l43.255" class="difflineplus">+   *    100ms timer set to call _clearSummaryTimer.</span>
<a href="#l43.256"></a><span id="l43.256" class="difflineplus">+   * - User extends the selection 50ms later =&gt; the timer has not elapsed so we</span>
<a href="#l43.257"></a><span id="l43.257" class="difflineplus">+   *    reset it to 100ms to call _showSummary.</span>
<a href="#l43.258"></a><span id="l43.258" class="difflineplus">+   * - User extends the selection yet again 50ms later =&gt; timer has not elapsed</span>
<a href="#l43.259"></a><span id="l43.259" class="difflineplus">+   *    so we reset it to 100ms to call _showSummary.</span>
<a href="#l43.260"></a><span id="l43.260" class="difflineplus">+   * - 100ms later, the timer elapses =&gt; we call _showSummary which updates the</span>
<a href="#l43.261"></a><span id="l43.261" class="difflineplus">+   *    summary.</span>
<a href="#l43.262"></a><span id="l43.262" class="difflineplus">+   * - 2 seconds later, the user selects some other messages =&gt; we summarize the</span>
<a href="#l43.263"></a><span id="l43.263" class="difflineplus">+   *    select and set a 100ms timer set to call _clearSummaryTimer.</span>
<a href="#l43.264"></a><span id="l43.264" class="difflineplus">+   * - 100ms later, _clearSummaryTimer clears _summaryStabilityTimeout so that</span>
<a href="#l43.265"></a><span id="l43.265" class="difflineplus">+   *    the next selection change will immediately summarize.</span>
<a href="#l43.266"></a><span id="l43.266" class="difflineplus">+   *</span>
<a href="#l43.267"></a><span id="l43.267" class="difflineplus">+   * @param aIsCallback Is this a callback to ourselves?  Callers should not set</span>
<a href="#l43.268"></a><span id="l43.268" class="difflineplus">+   *     this, leaving it undefined.</span>
<a href="#l43.269"></a><span id="l43.269" class="difflineplus">+   */</span>
<a href="#l43.270"></a><span id="l43.270" class="difflineplus">+  _showSummary: function MessageDisplayWidget_showSummary(aIsCallback) {</span>
<a href="#l43.271"></a><span id="l43.271" class="difflineplus">+    // note: if we are in this function, we already know that summaries are</span>
<a href="#l43.272"></a><span id="l43.272" class="difflineplus">+    //  enabled.</span>
<a href="#l43.273"></a><span id="l43.273" class="difflineplus">+</span>
<a href="#l43.274"></a><span id="l43.274" class="difflineplus">+    // If this is not a callback from the timeout and we currently have a</span>
<a href="#l43.275"></a><span id="l43.275" class="difflineplus">+    //  timeout, that means that we need to wait for the selection to stabilize.</span>
<a href="#l43.276"></a><span id="l43.276" class="difflineplus">+    //  The fact that we are getting called means the selection has just changed</span>
<a href="#l43.277"></a><span id="l43.277" class="difflineplus">+    //  yet again and is not stable, so reset the timer for the full duration.</span>
<a href="#l43.278"></a><span id="l43.278" class="difflineplus">+    if (!aIsCallback &amp;&amp; this._summaryStabilityTimeout != null) {</span>
<a href="#l43.279"></a><span id="l43.279" class="difflineplus">+      clearTimeout(this._summaryStabilityTimeout);</span>
<a href="#l43.280"></a><span id="l43.280" class="difflineplus">+      this._summaryStabilityTimeout =</span>
<a href="#l43.281"></a><span id="l43.281" class="difflineplus">+        setTimeout(this._wrapShowSummary,</span>
<a href="#l43.282"></a><span id="l43.282" class="difflineplus">+                   this.SUMMARIZATION_SELECTION_STABILITY_INTERVAL_MS,</span>
<a href="#l43.283"></a><span id="l43.283" class="difflineplus">+                   this);</span>
<a href="#l43.284"></a><span id="l43.284" class="difflineplus">+      return;</span>
<a href="#l43.285"></a><span id="l43.285" class="difflineplus">+    }</span>
<a href="#l43.286"></a><span id="l43.286" class="difflineplus">+</span>
<a href="#l43.287"></a><span id="l43.287" class="difflineplus">+    // Bail if our selection count has stabilized outside an acceptable range.</span>
<a href="#l43.288"></a><span id="l43.288" class="difflineplus">+    let selectedCount = this.folderDisplay.selectedCount;</span>
<a href="#l43.289"></a><span id="l43.289" class="difflineplus">+    if (selectedCount &lt; 2 || selectedCount &gt; this.MAX_MESSAGES_TO_SUMMARIZE)</span>
<a href="#l43.290"></a><span id="l43.290" class="difflineplus">+      return;</span>
<a href="#l43.291"></a><span id="l43.291" class="difflineplus">+</span>
<a href="#l43.292"></a><span id="l43.292" class="difflineplus">+    // Setup a timeout call to _clearSummaryTimer so that we don't try and</span>
<a href="#l43.293"></a><span id="l43.293" class="difflineplus">+    //  summarize again within 100ms of now.  Do this before calling</span>
<a href="#l43.294"></a><span id="l43.294" class="difflineplus">+    //  the summarization logic in case it throws an exception.</span>
<a href="#l43.295"></a><span id="l43.295" class="difflineplus">+    this._summaryStabilityTimeout =</span>
<a href="#l43.296"></a><span id="l43.296" class="difflineplus">+      setTimeout(this._clearSummaryTimer,</span>
<a href="#l43.297"></a><span id="l43.297" class="difflineplus">+                 this.SUMMARIZATION_SELECTION_STABILITY_INTERVAL_MS,</span>
<a href="#l43.298"></a><span id="l43.298" class="difflineplus">+                 this);</span>
<a href="#l43.299"></a><span id="l43.299" class="difflineplus">+</span>
<a href="#l43.300"></a><span id="l43.300" class="difflineplus">+    // figure out if we're looking at one thread or more than one thread</span>
<a href="#l43.301"></a><span id="l43.301" class="difflineplus">+    let selectedMessages = this.folderDisplay.selectedMessages;</span>
<a href="#l43.302"></a><span id="l43.302" class="difflineplus">+    let firstThreadId = selectedMessages[0].threadId;</span>
<a href="#l43.303"></a><span id="l43.303" class="difflineplus">+    let oneThread = true;</span>
<a href="#l43.304"></a><span id="l43.304" class="difflineplus">+    for (i = 0; i &lt; selectedMessages.length; i++) {</span>
<a href="#l43.305"></a><span id="l43.305" class="difflineplus">+      if (selectedMessages[i].threadId != firstThreadId) {</span>
<a href="#l43.306"></a><span id="l43.306" class="difflineplus">+        oneThread = false;</span>
<a href="#l43.307"></a><span id="l43.307" class="difflineplus">+        break;</span>
<a href="#l43.308"></a><span id="l43.308" class="difflineplus">+      }</span>
<a href="#l43.309"></a><span id="l43.309" class="difflineplus">+    }</span>
<a href="#l43.310"></a><span id="l43.310" class="difflineplus">+    if (oneThread)</span>
<a href="#l43.311"></a><span id="l43.311" class="difflineplus">+      summarizeThread(selectedMessages);</span>
<a href="#l43.312"></a><span id="l43.312" class="difflineplus">+    else</span>
<a href="#l43.313"></a><span id="l43.313" class="difflineplus">+      summarizeMultipleSelection(selectedMessages);</span>
<a href="#l43.314"></a><span id="l43.314" class="difflineplus">+    this.singleMessageDisplay = false;</span>
<a href="#l43.315"></a><span id="l43.315" class="difflineplus">+  },</span>
<a href="#l43.316"></a><span id="l43.316" class="difflineplus">+  _wrapShowSummary: function MessageDisplayWidget__wrapShowSummary(aThis) {</span>
<a href="#l43.317"></a><span id="l43.317" class="difflineplus">+    aThis._showSummary(true);</span>
<a href="#l43.318"></a><span id="l43.318" class="difflineplus">+  },</span>
<a href="#l43.319"></a><span id="l43.319" class="difflineplus">+  /**</span>
<a href="#l43.320"></a><span id="l43.320" class="difflineplus">+   * Just clears the _summaryStabilityTimeout attribute so we can use it as a</span>
<a href="#l43.321"></a><span id="l43.321" class="difflineplus">+   *  means of checking if we are allowed to display the summary immediately.</span>
<a href="#l43.322"></a><span id="l43.322" class="difflineplus">+   */</span>
<a href="#l43.323"></a><span id="l43.323" class="difflineplus">+  _clearSummaryTimer: function MessageDisplayWidget__clearSummaryTimer(aThis) {</span>
<a href="#l43.324"></a><span id="l43.324" class="difflineplus">+    aThis._summaryStabilityTimeout = null;</span>
<a href="#l43.325"></a><span id="l43.325" class="difflineplus">+  },</span>
<a href="#l43.326"></a><span id="l43.326" class="difflineplus">+</span>
<a href="#l43.327"></a><span id="l43.327" class="difflineplus">+  /**</span>
<a href="#l43.328"></a><span id="l43.328" class="difflineplus">+   * Called by the FolderDisplayWidget when it is being made active again and</span>
<a href="#l43.329"></a><span id="l43.329" class="difflineplus">+   *  it's time for us to step up and re-display or clear the message as</span>
<a href="#l43.330"></a><span id="l43.330" class="difflineplus">+   *  demanded by our multiplexed tab implementation.</span>
<a href="#l43.331"></a><span id="l43.331" class="difflineplus">+   */</span>
<a href="#l43.332"></a><span id="l43.332" class="difflineplus">+  makeActive: function MessageDisplayWidget_makeActive() {</span>
<a href="#l43.333"></a><span id="l43.333" class="difflineplus">+    let wasInactive = !this._active;</span>
<a href="#l43.334"></a><span id="l43.334" class="difflineplus">+    this._active = true;</span>
<a href="#l43.335"></a><span id="l43.335" class="difflineplus">+</span>
<a href="#l43.336"></a><span id="l43.336" class="difflineplus">+    if (wasInactive) {</span>
<a href="#l43.337"></a><span id="l43.337" class="difflineplus">+      // (see our usage below)</span>
<a href="#l43.338"></a><span id="l43.338" class="difflineplus">+      let preDisplayedMessage = this.displayedMessage;</span>
<a href="#l43.339"></a><span id="l43.339" class="difflineplus">+      // Force a synthetic selection changed event.  This will propagate through</span>
<a href="#l43.340"></a><span id="l43.340" class="difflineplus">+      //  to a call to onSelectedMessagesChanged who will handle making sure the</span>
<a href="#l43.341"></a><span id="l43.341" class="difflineplus">+      //  right message pane is in use, etc.</span>
<a href="#l43.342"></a><span id="l43.342" class="difflineplus">+      this.folderDisplay.view.dbView.selectionChanged();</span>
<a href="#l43.343"></a><span id="l43.343" class="difflineplus">+      // The one potential problem is that the message view only triggers message</span>
<a href="#l43.344"></a><span id="l43.344" class="difflineplus">+      //  streaming if it doesn't think the message is already displayed.  In that</span>
<a href="#l43.345"></a><span id="l43.345" class="difflineplus">+      //  case we need to force a re-display by calling reloadMessage.  We can</span>
<a href="#l43.346"></a><span id="l43.346" class="difflineplus">+      //  detect that case by seeing if our displayedMessage value changes its</span>
<a href="#l43.347"></a><span id="l43.347" class="difflineplus">+      //  value during this call (because we will receive a onDisplayingMessage</span>
<a href="#l43.348"></a><span id="l43.348" class="difflineplus">+      //  notification).  If we should be displaying a single message but the</span>
<a href="#l43.349"></a><span id="l43.349" class="difflineplus">+      //  value does not change, we need to force a re-display.</span>
<a href="#l43.350"></a><span id="l43.350" class="difflineplus">+      if (this.singleMessageDisplay &amp;&amp; this.displayedMessage &amp;&amp;</span>
<a href="#l43.351"></a><span id="l43.351" class="difflineplus">+          (this.displayedMessage == preDisplayedMessage))</span>
<a href="#l43.352"></a><span id="l43.352" class="difflineplus">+        this.folderDisplay.view.dbView.reloadMessage();</span>
<a href="#l43.353"></a><span id="l43.353" class="difflineplus">+    }</span>
<a href="#l43.354"></a><span id="l43.354" class="difflineplus">+</span>
<a href="#l43.355"></a><span id="l43.355" class="difflineplus">+    this._updateActiveMessagePane();</span>
<a href="#l43.356"></a><span id="l43.356" class="difflineplus">+  },</span>
<a href="#l43.357"></a><span id="l43.357" class="difflineplus">+</span>
<a href="#l43.358"></a><span id="l43.358" class="difflineplus">+  /**</span>
<a href="#l43.359"></a><span id="l43.359" class="difflineplus">+   * Called by the FolderDisplayWidget when it is being made inactive or no</span>
<a href="#l43.360"></a><span id="l43.360" class="difflineplus">+   *  longer requires messages to be displayed.</span>
<a href="#l43.361"></a><span id="l43.361" class="difflineplus">+   */</span>
<a href="#l43.362"></a><span id="l43.362" class="difflineplus">+  makeInactive: function MessageDisplayWidget_makeInactive() {</span>
<a href="#l43.363"></a><span id="l43.363" class="difflineplus">+    this._active = false;</span>
<a href="#l43.364"></a><span id="l43.364" class="difflineplus">+  }</span>
<a href="#l43.365"></a><span id="l43.365" class="difflineplus">+};</span>
<a href="#l43.366"></a><span id="l43.366" class="difflineplus">+</span>
<a href="#l43.367"></a><span id="l43.367" class="difflineplus">+/**</span>
<a href="#l43.368"></a><span id="l43.368" class="difflineplus">+ * Display widget abstraction for the 3-pane message view's preview pane/message</span>
<a href="#l43.369"></a><span id="l43.369" class="difflineplus">+ *  pane. Like the DisplayWidget, it is multiplexed.</span>
<a href="#l43.370"></a><span id="l43.370" class="difflineplus">+ */</span>
<a href="#l43.371"></a><span id="l43.371" class="difflineplus">+function MessagePaneDisplayWidget() {</span>
<a href="#l43.372"></a><span id="l43.372" class="difflineplus">+  MessageDisplayWidget.call(this);</span>
<a href="#l43.373"></a><span id="l43.373" class="difflineplus">+  this._visible = true;</span>
<a href="#l43.374"></a><span id="l43.374" class="difflineplus">+}</span>
<a href="#l43.375"></a><span id="l43.375" class="difflineplus">+MessagePaneDisplayWidget.prototype = {</span>
<a href="#l43.376"></a><span id="l43.376" class="difflineplus">+  __proto__: MessageDisplayWidget.prototype,</span>
<a href="#l43.377"></a><span id="l43.377" class="difflineplus">+</span>
<a href="#l43.378"></a><span id="l43.378" class="difflineplus">+  get visible MessageDisplayWidget_get_visible() {</span>
<a href="#l43.379"></a><span id="l43.379" class="difflineplus">+    return this._visible;</span>
<a href="#l43.380"></a><span id="l43.380" class="difflineplus">+  },</span>
<a href="#l43.381"></a><span id="l43.381" class="difflineplus">+  /**</span>
<a href="#l43.382"></a><span id="l43.382" class="difflineplus">+   * Tell us whether the message pane is visible or not; this should reflect</span>
<a href="#l43.383"></a><span id="l43.383" class="difflineplus">+   *  reality and does not define reality.  (Setting this to false does not</span>
<a href="#l43.384"></a><span id="l43.384" class="difflineplus">+   *  hide the message pane, it merely makes us think it is hidden.)</span>
<a href="#l43.385"></a><span id="l43.385" class="difflineplus">+   */</span>
<a href="#l43.386"></a><span id="l43.386" class="difflineplus">+  set visible MessageDisplayWidget_set_visible(aVisible) {</span>
<a href="#l43.387"></a><span id="l43.387" class="difflineplus">+    // Ignore this if we are inactive.  We don't want to get faked out by things</span>
<a href="#l43.388"></a><span id="l43.388" class="difflineplus">+    //  happening after our tab has closed up shop.</span>
<a href="#l43.389"></a><span id="l43.389" class="difflineplus">+    if (!this._active)</span>
<a href="#l43.390"></a><span id="l43.390" class="difflineplus">+      return;</span>
<a href="#l43.391"></a><span id="l43.391" class="difflineplus">+</span>
<a href="#l43.392"></a><span id="l43.392" class="difflineplus">+    // no-op if it's the same</span>
<a href="#l43.393"></a><span id="l43.393" class="difflineplus">+    if (aVisible == this._visible)</span>
<a href="#l43.394"></a><span id="l43.394" class="difflineplus">+      return;</span>
<a href="#l43.395"></a><span id="l43.395" class="difflineplus">+</span>
<a href="#l43.396"></a><span id="l43.396" class="difflineplus">+    this._visible = aVisible;</span>
<a href="#l43.397"></a><span id="l43.397" class="difflineplus">+    // Update suppression.  If we were not visible and now are visible, the db</span>
<a href="#l43.398"></a><span id="l43.398" class="difflineplus">+    //  view itself will handle triggering the message display for us if the</span>
<a href="#l43.399"></a><span id="l43.399" class="difflineplus">+    //  message was not currently being displayed...</span>
<a href="#l43.400"></a><span id="l43.400" class="difflineplus">+    let dbView = this.folderDisplay.view.dbView;</span>
<a href="#l43.401"></a><span id="l43.401" class="difflineplus">+    if (dbView) {</span>
<a href="#l43.402"></a><span id="l43.402" class="difflineplus">+      let treeSelection = this.folderDisplay.treeSelection;</span>
<a href="#l43.403"></a><span id="l43.403" class="difflineplus">+      // flag if we need to force the redisplay manually...</span>
<a href="#l43.404"></a><span id="l43.404" class="difflineplus">+      let needToReloadMessage = treeSelection.count &amp;&amp;</span>
<a href="#l43.405"></a><span id="l43.405" class="difflineplus">+        dbView.currentlyDisplayedMessage == treeSelection.currentIndex;</span>
<a href="#l43.406"></a><span id="l43.406" class="difflineplus">+      dbView.suppressMsgDisplay = !this._visible;</span>
<a href="#l43.407"></a><span id="l43.407" class="difflineplus">+      if (needToReloadMessage)</span>
<a href="#l43.408"></a><span id="l43.408" class="difflineplus">+        dbView.reloadMessage();</span>
<a href="#l43.409"></a><span id="l43.409" class="difflineplus">+    }</span>
<a href="#l43.410"></a><span id="l43.410" class="difflineplus">+    // But if we are no longer visible, it's on us to clear the display.</span>
<a href="#l43.411"></a><span id="l43.411" class="difflineplus">+    if (!aVisible)</span>
<a href="#l43.412"></a><span id="l43.412" class="difflineplus">+      this.clearDisplay();</span>
<a href="#l43.413"></a><span id="l43.413" class="difflineplus">+  },</span>
<a href="#l43.414"></a><span id="l43.414" class="difflineplus">+};</span>
<a href="#l43.415"></a><span id="l43.415" class="difflineplus">+</span>
<a href="#l43.416"></a><span id="l43.416" class="difflineplus">+/**</span>
<a href="#l43.417"></a><span id="l43.417" class="difflineplus">+ * Message display widget for the &quot;message&quot; tab that is the tab-based equivalent</span>
<a href="#l43.418"></a><span id="l43.418" class="difflineplus">+ *  of the standalone message window.</span>
<a href="#l43.419"></a><span id="l43.419" class="difflineplus">+ */</span>
<a href="#l43.420"></a><span id="l43.420" class="difflineplus">+function MessageTabDisplayWidget() {</span>
<a href="#l43.421"></a><span id="l43.421" class="difflineplus">+  MessageDisplayWidget.call(this);</span>
<a href="#l43.422"></a><span id="l43.422" class="difflineplus">+}</span>
<a href="#l43.423"></a><span id="l43.423" class="difflineplus">+MessageTabDisplayWidget.prototype = {</span>
<a href="#l43.424"></a><span id="l43.424" class="difflineplus">+  __proto__: MessageDisplayWidget.prototype,</span>
<a href="#l43.425"></a><span id="l43.425" class="difflineplus">+</span>
<a href="#l43.426"></a><span id="l43.426" class="difflineplus">+  /**</span>
<a href="#l43.427"></a><span id="l43.427" class="difflineplus">+   * The message tab always has a visible message pane.</span>
<a href="#l43.428"></a><span id="l43.428" class="difflineplus">+   */</span>
<a href="#l43.429"></a><span id="l43.429" class="difflineplus">+  get visible() {</span>
<a href="#l43.430"></a><span id="l43.430" class="difflineplus">+    return true;</span>
<a href="#l43.431"></a><span id="l43.431" class="difflineplus">+  },</span>
<a href="#l43.432"></a><span id="l43.432" class="difflineplus">+  set visible(aIgnored) {</span>
<a href="#l43.433"></a><span id="l43.433" class="difflineplus">+  },</span>
<a href="#l43.434"></a><span id="l43.434" class="difflineplus">+</span>
<a href="#l43.435"></a><span id="l43.435" class="difflineplus">+  onSelectedMessagesChanged:</span>
<a href="#l43.436"></a><span id="l43.436" class="difflineplus">+      function MessageTabDisplayWidget_onSelectedMessagesChanged() {</span>
<a href="#l43.437"></a><span id="l43.437" class="difflineplus">+    this.__proto__.__proto__.onSelectedMessagesChanged.apply(this, arguments);</span>
<a href="#l43.438"></a><span id="l43.438" class="difflineplus">+    if (!this.closing)</span>
<a href="#l43.439"></a><span id="l43.439" class="difflineplus">+      document.getElementById('tabmail').setTabTitle(this.folderDisplay._tabInfo);</span>
<a href="#l43.440"></a><span id="l43.440" class="difflineplus">+  },</span>
<a href="#l43.441"></a><span id="l43.441" class="difflineplus">+</span>
<a href="#l43.442"></a><span id="l43.442" class="difflineplus">+  /**</span>
<a href="#l43.443"></a><span id="l43.443" class="difflineplus">+   * A message tab should never ever be blank.  Close the tab if we become</span>
<a href="#l43.444"></a><span id="l43.444" class="difflineplus">+   *  blank.</span>
<a href="#l43.445"></a><span id="l43.445" class="difflineplus">+   */</span>
<a href="#l43.446"></a><span id="l43.446" class="difflineplus">+  clearDisplay: function MessageTabDisplayWidget_clearDisplay() {</span>
<a href="#l43.447"></a><span id="l43.447" class="difflineplus">+    if (!this.closing) {</span>
<a href="#l43.448"></a><span id="l43.448" class="difflineplus">+      this.closing = true;</span>
<a href="#l43.449"></a><span id="l43.449" class="difflineplus">+      document.getElementById('tabmail').closeTab(this.folderDisplay._tabInfo);</span>
<a href="#l43.450"></a><span id="l43.450" class="difflineplus">+    }</span>
<a href="#l43.451"></a><span id="l43.451" class="difflineplus">+  }</span>
<a href="#l43.452"></a><span id="l43.452" class="difflineplus">+};</span>
<a href="#l43.453"></a><span id="l43.453" class="difflineplus">+</span>
<a href="#l43.454"></a><span id="l43.454" class="difflineplus">+/**</span>
<a href="#l43.455"></a><span id="l43.455" class="difflineplus">+ * The search dialog has no message preview pane, and so wants a message</span>
<a href="#l43.456"></a><span id="l43.456" class="difflineplus">+ *  display widget that is never visible.  No one other than the search</span>
<a href="#l43.457"></a><span id="l43.457" class="difflineplus">+ *  dialog should use this because the search dialog is bad UI.</span>
<a href="#l43.458"></a><span id="l43.458" class="difflineplus">+ */</span>
<a href="#l43.459"></a><span id="l43.459" class="difflineplus">+function NeverVisisbleMessageDisplayWidget() {</span>
<a href="#l43.460"></a><span id="l43.460" class="difflineplus">+  MessageDisplayWidget.call(this);</span>
<a href="#l43.461"></a><span id="l43.461" class="difflineplus">+}</span>
<a href="#l43.462"></a><span id="l43.462" class="difflineplus">+NeverVisisbleMessageDisplayWidget.prototype = {</span>
<a href="#l43.463"></a><span id="l43.463" class="difflineplus">+  __proto__: MessageDisplayWidget.prototype,</span>
<a href="#l43.464"></a><span id="l43.464" class="difflineplus">+  get visible() {</span>
<a href="#l43.465"></a><span id="l43.465" class="difflineplus">+    return false;</span>
<a href="#l43.466"></a><span id="l43.466" class="difflineplus">+  },</span>
<a href="#l43.467"></a><span id="l43.467" class="difflineplus">+  onSelectedMessagesChanged: function() {</span>
<a href="#l43.468"></a><span id="l43.468" class="difflineplus">+    return false;</span>
<a href="#l43.469"></a><span id="l43.469" class="difflineplus">+  },</span>
<a href="#l43.470"></a><span id="l43.470" class="difflineplus">+  _updateActiveMessagePane: function() {</span>
<a href="#l43.471"></a><span id="l43.471" class="difflineplus">+  },</span>
<a href="#l43.472"></a><span id="l43.472" class="difflineplus">+};</span>
<a href="#l43.473"></a><span id="l43.473">\ No newline at end of file</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l44.1"></a><span id="l44.1" class="difflineminus">--- a/mail/base/content/messageWindow.js</span>
<a href="#l44.2"></a><span id="l44.2" class="difflineplus">+++ b/mail/base/content/messageWindow.js</span>
<a href="#l44.3"></a><span id="l44.3" class="difflineat">@@ -1,129 +1,244 @@</span>
<a href="#l44.4"></a><span id="l44.4" class="difflineminus">-# -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l44.5"></a><span id="l44.5" class="difflineminus">-# ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l44.6"></a><span id="l44.6" class="difflineminus">-# Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l44.7"></a><span id="l44.7" class="difflineminus">-#</span>
<a href="#l44.8"></a><span id="l44.8" class="difflineminus">-# The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l44.9"></a><span id="l44.9" class="difflineminus">-# 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l44.10"></a><span id="l44.10" class="difflineminus">-# the License. You may obtain a copy of the License at</span>
<a href="#l44.11"></a><span id="l44.11" class="difflineminus">-# http://www.mozilla.org/MPL/</span>
<a href="#l44.12"></a><span id="l44.12" class="difflineminus">-#</span>
<a href="#l44.13"></a><span id="l44.13" class="difflineminus">-# Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l44.14"></a><span id="l44.14" class="difflineminus">-# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l44.15"></a><span id="l44.15" class="difflineminus">-# for the specific language governing rights and limitations under the</span>
<a href="#l44.16"></a><span id="l44.16" class="difflineminus">-# License.</span>
<a href="#l44.17"></a><span id="l44.17" class="difflineminus">-#</span>
<a href="#l44.18"></a><span id="l44.18" class="difflineminus">-# The Original Code is Mozilla Communicator client code, released</span>
<a href="#l44.19"></a><span id="l44.19" class="difflineminus">-# March 31, 1998.</span>
<a href="#l44.20"></a><span id="l44.20" class="difflineminus">-#</span>
<a href="#l44.21"></a><span id="l44.21" class="difflineminus">-# The Initial Developer of the Original Code is</span>
<a href="#l44.22"></a><span id="l44.22" class="difflineminus">-# Netscape Communications Corporation.</span>
<a href="#l44.23"></a><span id="l44.23" class="difflineminus">-# Portions created by the Initial Developer are Copyright (C) 1998-1999</span>
<a href="#l44.24"></a><span id="l44.24" class="difflineminus">-# the Initial Developer. All Rights Reserved.</span>
<a href="#l44.25"></a><span id="l44.25" class="difflineminus">-#</span>
<a href="#l44.26"></a><span id="l44.26" class="difflineminus">-# Contributor(s):</span>
<a href="#l44.27"></a><span id="l44.27" class="difflineminus">-#</span>
<a href="#l44.28"></a><span id="l44.28" class="difflineminus">-# Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l44.29"></a><span id="l44.29" class="difflineminus">-# either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l44.30"></a><span id="l44.30" class="difflineminus">-# the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l44.31"></a><span id="l44.31" class="difflineminus">-# in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l44.32"></a><span id="l44.32" class="difflineminus">-# of those above. If you wish to allow use of your version of this file only</span>
<a href="#l44.33"></a><span id="l44.33" class="difflineminus">-# under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l44.34"></a><span id="l44.34" class="difflineminus">-# use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l44.35"></a><span id="l44.35" class="difflineminus">-# decision by deleting the provisions above and replace them with the notice</span>
<a href="#l44.36"></a><span id="l44.36" class="difflineminus">-# and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l44.37"></a><span id="l44.37" class="difflineminus">-# the provisions above, a recipient may use your version of this file under</span>
<a href="#l44.38"></a><span id="l44.38" class="difflineminus">-# the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l44.39"></a><span id="l44.39" class="difflineminus">-#</span>
<a href="#l44.40"></a><span id="l44.40" class="difflineminus">-# ***** END LICENSE BLOCK *****</span>
<a href="#l44.41"></a><span id="l44.41" class="difflineplus">+/** ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l44.42"></a><span id="l44.42" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l44.43"></a><span id="l44.43" class="difflineplus">+ *</span>
<a href="#l44.44"></a><span id="l44.44" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l44.45"></a><span id="l44.45" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l44.46"></a><span id="l44.46" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l44.47"></a><span id="l44.47" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l44.48"></a><span id="l44.48" class="difflineplus">+ *</span>
<a href="#l44.49"></a><span id="l44.49" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l44.50"></a><span id="l44.50" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l44.51"></a><span id="l44.51" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l44.52"></a><span id="l44.52" class="difflineplus">+ * License.</span>
<a href="#l44.53"></a><span id="l44.53" class="difflineplus">+ *</span>
<a href="#l44.54"></a><span id="l44.54" class="difflineplus">+ * The Original Code is Mozilla Communicator client code, released</span>
<a href="#l44.55"></a><span id="l44.55" class="difflineplus">+ * March 31, 1998.</span>
<a href="#l44.56"></a><span id="l44.56" class="difflineplus">+ *</span>
<a href="#l44.57"></a><span id="l44.57" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l44.58"></a><span id="l44.58" class="difflineplus">+ * Netscape Communications Corporation.</span>
<a href="#l44.59"></a><span id="l44.59" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 1998-1999</span>
<a href="#l44.60"></a><span id="l44.60" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l44.61"></a><span id="l44.61" class="difflineplus">+ *</span>
<a href="#l44.62"></a><span id="l44.62" class="difflineplus">+ * Contributor(s):</span>
<a href="#l44.63"></a><span id="l44.63" class="difflineplus">+ *</span>
<a href="#l44.64"></a><span id="l44.64" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l44.65"></a><span id="l44.65" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l44.66"></a><span id="l44.66" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l44.67"></a><span id="l44.67" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l44.68"></a><span id="l44.68" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l44.69"></a><span id="l44.69" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l44.70"></a><span id="l44.70" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l44.71"></a><span id="l44.71" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l44.72"></a><span id="l44.72" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l44.73"></a><span id="l44.73" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l44.74"></a><span id="l44.74" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l44.75"></a><span id="l44.75" class="difflineplus">+ *</span>
<a href="#l44.76"></a><span id="l44.76" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l44.77"></a><span id="l44.77"> </span>
<a href="#l44.78"></a><span id="l44.78"> /* This is where functions related to the standalone message window are kept */</span>
<a href="#l44.79"></a><span id="l44.79"> </span>
<a href="#l44.80"></a><span id="l44.80" class="difflineplus">+Components.utils.import(&quot;resource://app/modules/jsTreeSelection.js&quot;);</span>
<a href="#l44.81"></a><span id="l44.81" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l44.82"></a><span id="l44.82" class="difflineplus">+</span>
<a href="#l44.83"></a><span id="l44.83"> // from MailNewsTypes.h</span>
<a href="#l44.84"></a><span id="l44.84"> const nsMsgKey_None = 0xFFFFFFFF;</span>
<a href="#l44.85"></a><span id="l44.85"> const nsMsgViewIndex_None = 0xFFFFFFFF;</span>
<a href="#l44.86"></a><span id="l44.86"> </span>
<a href="#l44.87"></a><span id="l44.87"> /* globals for a particular window */</span>
<a href="#l44.88"></a><span id="l44.88"> </span>
<a href="#l44.89"></a><span id="l44.89" class="difflineminus">-var gCurrentMessageUri;</span>
<a href="#l44.90"></a><span id="l44.90" class="difflineminus">-var gCurrentFolderUri;</span>
<a href="#l44.91"></a><span id="l44.91" class="difflineminus">-var gThreadPaneCommandUpdater = null;</span>
<a href="#l44.92"></a><span id="l44.92" class="difflineminus">-var gNextMessageViewIndexAfterDelete = -2;</span>
<a href="#l44.93"></a><span id="l44.93" class="difflineminus">-var gCurrentFolderToRerootForStandAlone;</span>
<a href="#l44.94"></a><span id="l44.94" class="difflineminus">-var gRerootOnFolderLoadForStandAlone = false;</span>
<a href="#l44.95"></a><span id="l44.95" class="difflineminus">-var gNextMessageAfterLoad = null;</span>
<a href="#l44.96"></a><span id="l44.96" class="difflineminus">-var gMessageToLoad = nsMsgKey_None;</span>
<a href="#l44.97"></a><span id="l44.97" class="difflineplus">+/// we have no tree view; let people know that.</span>
<a href="#l44.98"></a><span id="l44.98" class="difflineplus">+var gFolderTreeView = null;</span>
<a href="#l44.99"></a><span id="l44.99" class="difflineplus">+</span>
<a href="#l44.100"></a><span id="l44.100" class="difflineplus">+var gFolderDisplay;</span>
<a href="#l44.101"></a><span id="l44.101" class="difflineplus">+var gMessageDisplay;</span>
<a href="#l44.102"></a><span id="l44.102" class="difflineplus">+</span>
<a href="#l44.103"></a><span id="l44.103" class="difflineplus">+/**</span>
<a href="#l44.104"></a><span id="l44.104" class="difflineplus">+ * We subclass FolderDisplayWidget:</span>
<a href="#l44.105"></a><span id="l44.105" class="difflineplus">+ * - Because it assumes some thread-pane things that do not apply to us and we</span>
<a href="#l44.106"></a><span id="l44.106" class="difflineplus">+ *    want to no-op those things out.</span>
<a href="#l44.107"></a><span id="l44.107" class="difflineplus">+ * - To intercept queries about the selected message so that we can do the</span>
<a href="#l44.108"></a><span id="l44.108" class="difflineplus">+ *    .eml file thing.  We were originally trying to avoid involving the</span>
<a href="#l44.109"></a><span id="l44.109" class="difflineplus">+ *    nsMsgDBView, but that might not be important anymore. (future work)</span>
<a href="#l44.110"></a><span id="l44.110" class="difflineplus">+ */</span>
<a href="#l44.111"></a><span id="l44.111" class="difflineplus">+function StandaloneFolderDisplayWidget(aMessageDisplayWidget) {</span>
<a href="#l44.112"></a><span id="l44.112" class="difflineplus">+  FolderDisplayWidget.call(this, null, aMessageDisplayWidget);</span>
<a href="#l44.113"></a><span id="l44.113" class="difflineplus">+  // do not set the actual treeBox variable or our superclass might try and do</span>
<a href="#l44.114"></a><span id="l44.114" class="difflineplus">+  //  weird rooting things we don't want to have to think about right now.</span>
<a href="#l44.115"></a><span id="l44.115" class="difflineplus">+  this._magicTreeSelection = new JSTreeSelection(this.treeBox);</span>
<a href="#l44.116"></a><span id="l44.116" class="difflineplus">+}</span>
<a href="#l44.117"></a><span id="l44.117" class="difflineplus">+StandaloneFolderDisplayWidget.prototype = {</span>
<a href="#l44.118"></a><span id="l44.118" class="difflineplus">+  __proto__: FolderDisplayWidget.prototype,</span>
<a href="#l44.119"></a><span id="l44.119" class="difflineplus">+</span>
<a href="#l44.120"></a><span id="l44.120" class="difflineplus">+  /**</span>
<a href="#l44.121"></a><span id="l44.121" class="difflineplus">+   * If we have a displayed message, then we've got 1 message, otherwise 0.</span>
<a href="#l44.122"></a><span id="l44.122" class="difflineplus">+   */</span>
<a href="#l44.123"></a><span id="l44.123" class="difflineplus">+  get selectedCount() {</span>
<a href="#l44.124"></a><span id="l44.124" class="difflineplus">+    return this.messageDisplay.displayedMessage ? 1 : 0;</span>
<a href="#l44.125"></a><span id="l44.125" class="difflineplus">+  },</span>
<a href="#l44.126"></a><span id="l44.126" class="difflineplus">+</span>
<a href="#l44.127"></a><span id="l44.127" class="difflineplus">+  /**</span>
<a href="#l44.128"></a><span id="l44.128" class="difflineplus">+   * If we have a selected message, it's the one displayed!  This is more</span>
<a href="#l44.129"></a><span id="l44.129" class="difflineplus">+   *  straight-forward than having you trace through the tree selection and</span>
<a href="#l44.130"></a><span id="l44.130" class="difflineplus">+   *  db view logic.</span>
<a href="#l44.131"></a><span id="l44.131" class="difflineplus">+   */</span>
<a href="#l44.132"></a><span id="l44.132" class="difflineplus">+  get selectedMessage() {</span>
<a href="#l44.133"></a><span id="l44.133" class="difflineplus">+    return this.messageDisplay.displayedMessage;</span>
<a href="#l44.134"></a><span id="l44.134" class="difflineplus">+  },</span>
<a href="#l44.135"></a><span id="l44.135"> </span>
<a href="#l44.136"></a><span id="l44.136" class="difflineminus">-// the folderListener object</span>
<a href="#l44.137"></a><span id="l44.137" class="difflineminus">-var folderListener = {</span>
<a href="#l44.138"></a><span id="l44.138" class="difflineminus">-  OnItemAdded: function(parentItem, item) {},</span>
<a href="#l44.139"></a><span id="l44.139" class="difflineplus">+  /**</span>
<a href="#l44.140"></a><span id="l44.140" class="difflineplus">+   * If we have a selected message, it's the one displayed!  This is more</span>
<a href="#l44.141"></a><span id="l44.141" class="difflineplus">+   *  straight-forward than having you trace through the tree selection and</span>
<a href="#l44.142"></a><span id="l44.142" class="difflineplus">+   *  db view logic.</span>
<a href="#l44.143"></a><span id="l44.143" class="difflineplus">+   */</span>
<a href="#l44.144"></a><span id="l44.144" class="difflineplus">+  get selectedMessages() {</span>
<a href="#l44.145"></a><span id="l44.145" class="difflineplus">+    return this.messageDisplay.displayedMessage ?</span>
<a href="#l44.146"></a><span id="l44.146" class="difflineplus">+             [this.messageDisplay.displayedMessage] : [];</span>
<a href="#l44.147"></a><span id="l44.147" class="difflineplus">+  },</span>
<a href="#l44.148"></a><span id="l44.148"> </span>
<a href="#l44.149"></a><span id="l44.149" class="difflineminus">-  OnItemRemoved: function(parentItem, item) {},</span>
<a href="#l44.150"></a><span id="l44.150" class="difflineminus">-  OnItemPropertyChanged: function(item, property, oldValue, newValue) {},</span>
<a href="#l44.151"></a><span id="l44.151" class="difflineminus">-  OnItemIntPropertyChanged: function(item, property, oldValue, newValue) {</span>
<a href="#l44.152"></a><span id="l44.152" class="difflineminus">-    if (item.URI == gCurrentFolderUri) {</span>
<a href="#l44.153"></a><span id="l44.153" class="difflineminus">-      if (property.toString() == &quot;TotalMessages&quot; || property.toString() == &quot;TotalUnreadMessages&quot;) {</span>
<a href="#l44.154"></a><span id="l44.154" class="difflineminus">-        UpdateStandAloneMessageCounts();</span>
<a href="#l44.155"></a><span id="l44.155" class="difflineminus">-      }</span>
<a href="#l44.156"></a><span id="l44.156" class="difflineplus">+  /**</span>
<a href="#l44.157"></a><span id="l44.157" class="difflineplus">+   * We never have a real treeview, so we always want to tell the view about</span>
<a href="#l44.158"></a><span id="l44.158" class="difflineplus">+   *  the fake tree box so it will actually do something in NoteChange.</span>
<a href="#l44.159"></a><span id="l44.159" class="difflineplus">+   */</span>
<a href="#l44.160"></a><span id="l44.160" class="difflineplus">+  onCreatedView:</span>
<a href="#l44.161"></a><span id="l44.161" class="difflineplus">+      function StandaloneMessageDisplayWidget_onCreatedView() {</span>
<a href="#l44.162"></a><span id="l44.162" class="difflineplus">+    this._fakeTreeBox.view = this.view.dbView;</span>
<a href="#l44.163"></a><span id="l44.163" class="difflineplus">+    // only if we're not dealing with a dummy message (from .eml file /</span>
<a href="#l44.164"></a><span id="l44.164" class="difflineplus">+    //  attachment should we try and hook up the selection object.)  Otherwise</span>
<a href="#l44.165"></a><span id="l44.165" class="difflineplus">+    //  the view will not operate in stand alone message mode.</span>
<a href="#l44.166"></a><span id="l44.166" class="difflineplus">+    // XXX the sequencing here may break re-using a message window that is</span>
<a href="#l44.167"></a><span id="l44.167" class="difflineplus">+    //  showing an .eml file to go to a real message, at least in terms of</span>
<a href="#l44.168"></a><span id="l44.168" class="difflineplus">+    //  having the selection object properly associated with the tree.</span>
<a href="#l44.169"></a><span id="l44.169" class="difflineplus">+    if (!this.messageDisplay.isDummy) {</span>
<a href="#l44.170"></a><span id="l44.170" class="difflineplus">+      this.view.dbView.setTree(this._fakeTreeBox);</span>
<a href="#l44.171"></a><span id="l44.171" class="difflineplus">+      this.view.dbView.selection = this._magicTreeSelection;</span>
<a href="#l44.172"></a><span id="l44.172">     }</span>
<a href="#l44.173"></a><span id="l44.173" class="difflineplus">+    this.__proto__.__proto__.onCreatedView.call(this);</span>
<a href="#l44.174"></a><span id="l44.174" class="difflineplus">+  },</span>
<a href="#l44.175"></a><span id="l44.175" class="difflineplus">+</span>
<a href="#l44.176"></a><span id="l44.176" class="difflineplus">+  _superSelectedMessageUrisGetter:</span>
<a href="#l44.177"></a><span id="l44.177" class="difflineplus">+    FolderDisplayWidget.prototype.__lookupGetter__('selectedMessageUris'),</span>
<a href="#l44.178"></a><span id="l44.178" class="difflineplus">+  /**</span>
<a href="#l44.179"></a><span id="l44.179" class="difflineplus">+   * Check with the message display widget to see if it has a dummy; if so, just</span>
<a href="#l44.180"></a><span id="l44.180" class="difflineplus">+   *  return the dummy's URI, as the nsMsgDBView logic that our superclass uses</span>
<a href="#l44.181"></a><span id="l44.181" class="difflineplus">+   *  falls down in that case.</span>
<a href="#l44.182"></a><span id="l44.182" class="difflineplus">+   */</span>
<a href="#l44.183"></a><span id="l44.183" class="difflineplus">+  get selectedMessageUris() {</span>
<a href="#l44.184"></a><span id="l44.184" class="difflineplus">+    if (this.messageDisplay.displayedUri)</span>
<a href="#l44.185"></a><span id="l44.185" class="difflineplus">+      return [this.messageDisplay.displayedUri];</span>
<a href="#l44.186"></a><span id="l44.186" class="difflineplus">+    return this._superSelectedMessageUrisGetter.call(this);</span>
<a href="#l44.187"></a><span id="l44.187">   },</span>
<a href="#l44.188"></a><span id="l44.188" class="difflineminus">-  OnItemBoolPropertyChanged: function(item, property, oldValue, newValue) {},</span>
<a href="#l44.189"></a><span id="l44.189" class="difflineminus">-  OnItemUnicharPropertyChanged: function(item, property, oldValue, newValue){},</span>
<a href="#l44.190"></a><span id="l44.190" class="difflineminus">-  OnItemPropertyFlagChanged: function(item, property, oldFlag, newFlag) {},</span>
<a href="#l44.191"></a><span id="l44.191" class="difflineplus">+</span>
<a href="#l44.192"></a><span id="l44.192" class="difflineplus">+  /// folder display will want to show the thread pane; we need do nothing</span>
<a href="#l44.193"></a><span id="l44.193" class="difflineplus">+  _showThreadPane: function () {},</span>
<a href="#l44.194"></a><span id="l44.194" class="difflineplus">+  _showAccountCentral: function () {},</span>
<a href="#l44.195"></a><span id="l44.195" class="difflineplus">+</span>
<a href="#l44.196"></a><span id="l44.196" class="difflineplus">+  _updateThreadDisplay: function () {},</span>
<a href="#l44.197"></a><span id="l44.197" class="difflineplus">+</span>
<a href="#l44.198"></a><span id="l44.198" class="difflineplus">+  onMessageCountsChanged:</span>
<a href="#l44.199"></a><span id="l44.199" class="difflineplus">+      function StandaloneFolderDisplayWidget_onMessageCountsChaned() {</span>
<a href="#l44.200"></a><span id="l44.200" class="difflineplus">+    UpdateStatusMessageCounts();</span>
<a href="#l44.201"></a><span id="l44.201" class="difflineplus">+  },</span>
<a href="#l44.202"></a><span id="l44.202" class="difflineplus">+};</span>
<a href="#l44.203"></a><span id="l44.203" class="difflineplus">+</span>
<a href="#l44.204"></a><span id="l44.204"> </span>
<a href="#l44.205"></a><span id="l44.205" class="difflineminus">-  OnItemEvent: function(folder, event) {</span>
<a href="#l44.206"></a><span id="l44.206" class="difflineminus">-    var eventType = event.toString();</span>
<a href="#l44.207"></a><span id="l44.207" class="difflineplus">+/**</span>
<a href="#l44.208"></a><span id="l44.208" class="difflineplus">+ * Display widget abstraction for a standalone message display.  Right now</span>
<a href="#l44.209"></a><span id="l44.209" class="difflineplus">+ *  I think this means the standalone message window, and not the 'message in a</span>
<a href="#l44.210"></a><span id="l44.210" class="difflineplus">+ *  tab' thing, which is really just a perverted configuration of the 3-pane</span>
<a href="#l44.211"></a><span id="l44.211" class="difflineplus">+ *  format.</span>
<a href="#l44.212"></a><span id="l44.212" class="difflineplus">+ */</span>
<a href="#l44.213"></a><span id="l44.213" class="difflineplus">+function StandaloneMessageDisplayWidget() {</span>
<a href="#l44.214"></a><span id="l44.214" class="difflineplus">+  MessageDisplayWidget.call(this);</span>
<a href="#l44.215"></a><span id="l44.215" class="difflineplus">+  /**</span>
<a href="#l44.216"></a><span id="l44.216" class="difflineplus">+   * Indicate whether the message being displayed is a 'dummy' because it is</span>
<a href="#l44.217"></a><span id="l44.217" class="difflineplus">+   *  backed not by an nsIMsgDBHdr but instead by a file on disk or an</span>
<a href="#l44.218"></a><span id="l44.218" class="difflineplus">+   *  attachment on some mail message.</span>
<a href="#l44.219"></a><span id="l44.219" class="difflineplus">+   */</span>
<a href="#l44.220"></a><span id="l44.220" class="difflineplus">+  this.isDummy = false;</span>
<a href="#l44.221"></a><span id="l44.221" class="difflineplus">+  /**</span>
<a href="#l44.222"></a><span id="l44.222" class="difflineplus">+   * When displaying a dummy message, this is the URI of the message that we are</span>
<a href="#l44.223"></a><span id="l44.223" class="difflineplus">+   *  displaying.  If we are not displaying a dummy message, this is null.</span>
<a href="#l44.224"></a><span id="l44.224" class="difflineplus">+   */</span>
<a href="#l44.225"></a><span id="l44.225" class="difflineplus">+  this.displayedUri = null;</span>
<a href="#l44.226"></a><span id="l44.226" class="difflineplus">+}</span>
<a href="#l44.227"></a><span id="l44.227" class="difflineplus">+StandaloneMessageDisplayWidget.prototype = {</span>
<a href="#l44.228"></a><span id="l44.228" class="difflineplus">+  __proto__: MessageDisplayWidget.prototype,</span>
<a href="#l44.229"></a><span id="l44.229" class="difflineplus">+</span>
<a href="#l44.230"></a><span id="l44.230" class="difflineplus">+  /**</span>
<a href="#l44.231"></a><span id="l44.231" class="difflineplus">+   * The message pane is a standalone display widget is always visible.</span>
<a href="#l44.232"></a><span id="l44.232" class="difflineplus">+   */</span>
<a href="#l44.233"></a><span id="l44.233" class="difflineplus">+  get visible() {</span>
<a href="#l44.234"></a><span id="l44.234" class="difflineplus">+    return true;</span>
<a href="#l44.235"></a><span id="l44.235" class="difflineplus">+  },</span>
<a href="#l44.236"></a><span id="l44.236" class="difflineplus">+  set visible(aIgnored) {</span>
<a href="#l44.237"></a><span id="l44.237" class="difflineplus">+  },</span>
<a href="#l44.238"></a><span id="l44.238"> </span>
<a href="#l44.239"></a><span id="l44.239" class="difflineminus">-    if (eventType == &quot;DeleteOrMoveMsgCompleted&quot;)</span>
<a href="#l44.240"></a><span id="l44.240" class="difflineminus">-      HandleDeleteOrMoveMsgCompleted(folder);</span>
<a href="#l44.241"></a><span id="l44.241" class="difflineminus">-    else if (eventType == &quot;DeleteOrMoveMsgFailed&quot;)</span>
<a href="#l44.242"></a><span id="l44.242" class="difflineminus">-      HandleDeleteOrMoveMsgFailed(folder);</span>
<a href="#l44.243"></a><span id="l44.243" class="difflineminus">-    else if (eventType == &quot;FolderLoaded&quot;) {</span>
<a href="#l44.244"></a><span id="l44.244" class="difflineminus">-      if (folder) {</span>
<a href="#l44.245"></a><span id="l44.245" class="difflineminus">-        var uri = folder.URI;</span>
<a href="#l44.246"></a><span id="l44.246" class="difflineminus">-        if (uri == gCurrentFolderToRerootForStandAlone) {</span>
<a href="#l44.247"></a><span id="l44.247" class="difflineminus">-          gCurrentFolderToRerootForStandAlone = null;</span>
<a href="#l44.248"></a><span id="l44.248" class="difflineminus">-          folder.endFolderLoading();</span>
<a href="#l44.249"></a><span id="l44.249" class="difflineminus">-          if (gRerootOnFolderLoadForStandAlone) {</span>
<a href="#l44.250"></a><span id="l44.250" class="difflineminus">-            RerootFolderForStandAlone(uri);</span>
<a href="#l44.251"></a><span id="l44.251" class="difflineminus">-          }</span>
<a href="#l44.252"></a><span id="l44.252" class="difflineminus">-        }</span>
<a href="#l44.253"></a><span id="l44.253" class="difflineminus">-      }</span>
<a href="#l44.254"></a><span id="l44.254" class="difflineplus">+  /**</span>
<a href="#l44.255"></a><span id="l44.255" class="difflineplus">+   * Display the external message (from disk or attachment) named by the URI.</span>
<a href="#l44.256"></a><span id="l44.256" class="difflineplus">+   */</span>
<a href="#l44.257"></a><span id="l44.257" class="difflineplus">+  displayExternalMessage:</span>
<a href="#l44.258"></a><span id="l44.258" class="difflineplus">+      function StandaloneMessageDisplayWidget_displayExternalMessage(aUri) {</span>
<a href="#l44.259"></a><span id="l44.259" class="difflineplus">+    this.isDummy = true;</span>
<a href="#l44.260"></a><span id="l44.260" class="difflineplus">+    this.displayedUri = aUri;</span>
<a href="#l44.261"></a><span id="l44.261" class="difflineplus">+    this.onDisplayingMessage(messageHeaderSink.dummyMsgHeader);</span>
<a href="#l44.262"></a><span id="l44.262" class="difflineplus">+    UpdateMailToolbar(&quot;external message display&quot;);</span>
<a href="#l44.263"></a><span id="l44.263" class="difflineplus">+    // null out the selection on the view so it operates in stand alone mode</span>
<a href="#l44.264"></a><span id="l44.264" class="difflineplus">+    this.folderDisplay.view.dbView.selection = null;</span>
<a href="#l44.265"></a><span id="l44.265" class="difflineplus">+    this.folderDisplay.view.dbView.loadMessageByUrl(aUri);</span>
<a href="#l44.266"></a><span id="l44.266" class="difflineplus">+  },</span>
<a href="#l44.267"></a><span id="l44.267" class="difflineplus">+</span>
<a href="#l44.268"></a><span id="l44.268" class="difflineplus">+  clearDisplay: function () {</span>
<a href="#l44.269"></a><span id="l44.269" class="difflineplus">+    this.messageLoading = false;</span>
<a href="#l44.270"></a><span id="l44.270" class="difflineplus">+    this.messageLoaded = false;</span>
<a href="#l44.271"></a><span id="l44.271" class="difflineplus">+    window.close();</span>
<a href="#l44.272"></a><span id="l44.272" class="difflineplus">+  },</span>
<a href="#l44.273"></a><span id="l44.273" class="difflineplus">+  _updateActiveMessagePane: function() {</span>
<a href="#l44.274"></a><span id="l44.274" class="difflineplus">+    // no-op.  the message pane is always visible.</span>
<a href="#l44.275"></a><span id="l44.275" class="difflineplus">+  },</span>
<a href="#l44.276"></a><span id="l44.276" class="difflineplus">+</span>
<a href="#l44.277"></a><span id="l44.277" class="difflineplus">+  onDisplayingMessage:</span>
<a href="#l44.278"></a><span id="l44.278" class="difflineplus">+      function StandaloneMessageDisplayWidget_onDisplayingMessage(aMsgHdr) {</span>
<a href="#l44.279"></a><span id="l44.279" class="difflineplus">+    this.__proto__.__proto__.onDisplayingMessage.call(this, aMsgHdr);</span>
<a href="#l44.280"></a><span id="l44.280" class="difflineplus">+</span>
<a href="#l44.281"></a><span id="l44.281" class="difflineplus">+    // - set the window title to the message subject (and maybe the app name)</span>
<a href="#l44.282"></a><span id="l44.282" class="difflineplus">+    let title = aMsgHdr.mime2DecodedSubject;</span>
<a href="#l44.283"></a><span id="l44.283" class="difflineplus">+    if (!gPlatformOSX)</span>
<a href="#l44.284"></a><span id="l44.284" class="difflineplus">+      title += &quot; - &quot; + gBrandBundle.getString(&quot;brandFullName&quot;);</span>
<a href="#l44.285"></a><span id="l44.285" class="difflineplus">+    document.title = title;</span>
<a href="#l44.286"></a><span id="l44.286" class="difflineplus">+</span>
<a href="#l44.287"></a><span id="l44.287" class="difflineplus">+    this.isDummy = aMsgHdr.folder == null;</span>
<a href="#l44.288"></a><span id="l44.288" class="difflineplus">+    if (!this.isDummy)</span>
<a href="#l44.289"></a><span id="l44.289" class="difflineplus">+      this.displayedUri = null;</span>
<a href="#l44.290"></a><span id="l44.290" class="difflineplus">+  },</span>
<a href="#l44.291"></a><span id="l44.291" class="difflineplus">+</span>
<a href="#l44.292"></a><span id="l44.292" class="difflineplus">+  onSelectedMessagesChanged: function () {</span>
<a href="#l44.293"></a><span id="l44.293" class="difflineplus">+    if (this.folderDisplay.treeSelection.count == 0) {</span>
<a href="#l44.294"></a><span id="l44.294" class="difflineplus">+      window.close();</span>
<a href="#l44.295"></a><span id="l44.295" class="difflineplus">+      return true;</span>
<a href="#l44.296"></a><span id="l44.296">     }</span>
<a href="#l44.297"></a><span id="l44.297" class="difflineminus">-    else if (eventType == &quot;JunkStatusChanged&quot;) {</span>
<a href="#l44.298"></a><span id="l44.298" class="difflineminus">-      HandleJunkStatusChanged(folder);</span>
<a href="#l44.299"></a><span id="l44.299" class="difflineminus">-    }</span>
<a href="#l44.300"></a><span id="l44.300" class="difflineminus">-  }</span>
<a href="#l44.301"></a><span id="l44.301" class="difflineminus">-}</span>
<a href="#l44.302"></a><span id="l44.302" class="difflineplus">+    return false;</span>
<a href="#l44.303"></a><span id="l44.303" class="difflineplus">+  },</span>
<a href="#l44.304"></a><span id="l44.304" class="difflineplus">+};</span>
<a href="#l44.305"></a><span id="l44.305"> </span>
<a href="#l44.306"></a><span id="l44.306"> var messagepaneObserver = {</span>
<a href="#l44.307"></a><span id="l44.307"> </span>
<a href="#l44.308"></a><span id="l44.308">   canHandleMultipleItems: false,</span>
<a href="#l44.309"></a><span id="l44.309"> </span>
<a href="#l44.310"></a><span id="l44.310">   onDrop: function (aEvent, aData, aDragSession)</span>
<a href="#l44.311"></a><span id="l44.311">   {</span>
<a href="#l44.312"></a><span id="l44.312">     var sourceUri = aData.data;</span>
<a href="#l44.313"></a><span id="l44.313" class="difflineminus">-    if (sourceUri != gCurrentMessageUri)</span>
<a href="#l44.314"></a><span id="l44.314" class="difflineplus">+    if (!gFolderDisplay.selectedMessage ||</span>
<a href="#l44.315"></a><span id="l44.315" class="difflineplus">+        sourceUri != gFolderDisplay.selectedMessageUris[0])</span>
<a href="#l44.316"></a><span id="l44.316">     {</span>
<a href="#l44.317"></a><span id="l44.317" class="difflineminus">-      var msgHdr = GetMsgHdrFromUri(sourceUri);</span>
<a href="#l44.318"></a><span id="l44.318" class="difflineminus">-</span>
<a href="#l44.319"></a><span id="l44.319" class="difflineminus">-      // Reset the window's message uri and folder uri vars, and</span>
<a href="#l44.320"></a><span id="l44.320" class="difflineminus">-      // update the command handlers to what's going to be used.</span>
<a href="#l44.321"></a><span id="l44.321" class="difflineminus">-      // This has to be done before the call to CreateView().</span>
<a href="#l44.322"></a><span id="l44.322" class="difflineminus">-      gCurrentMessageUri = sourceUri;</span>
<a href="#l44.323"></a><span id="l44.323" class="difflineminus">-      gCurrentFolderUri = msgHdr.folder.URI;</span>
<a href="#l44.324"></a><span id="l44.324" class="difflineminus">-      UpdateMailToolbar('onDrop');</span>
<a href="#l44.325"></a><span id="l44.325" class="difflineminus">-</span>
<a href="#l44.326"></a><span id="l44.326" class="difflineminus">-      // even if the folder uri's match, we can't use the existing view</span>
<a href="#l44.327"></a><span id="l44.327" class="difflineminus">-      // (msgHdr.folder.URI == windowID.gCurrentFolderUri)</span>
<a href="#l44.328"></a><span id="l44.328" class="difflineminus">-      // the reason is quick search and mail views.</span>
<a href="#l44.329"></a><span id="l44.329" class="difflineminus">-      // see bug #187673</span>
<a href="#l44.330"></a><span id="l44.330" class="difflineminus">-      CreateView(aDragSession.sourceNode.ownerDocument.defaultView.gDBView);</span>
<a href="#l44.331"></a><span id="l44.331" class="difflineminus">-      LoadMessageByMsgKey(msgHdr.messageKey);</span>
<a href="#l44.332"></a><span id="l44.332" class="difflineplus">+      var msgHdr = messenger.msgHdrFromURI(sourceUri);</span>
<a href="#l44.333"></a><span id="l44.333" class="difflineplus">+      let originGlobal = aDragSession.sourceNode.ownerDocument.defaultValue;</span>
<a href="#l44.334"></a><span id="l44.334" class="difflineplus">+      gFolderDisplay.cloneView(originGlobal.gFolderDisplay.view);</span>
<a href="#l44.335"></a><span id="l44.335" class="difflineplus">+      gFolderDisplay.selectMessage(msgHdr);</span>
<a href="#l44.336"></a><span id="l44.336">     }</span>
<a href="#l44.337"></a><span id="l44.337">   },</span>
<a href="#l44.338"></a><span id="l44.338"> </span>
<a href="#l44.339"></a><span id="l44.339">   onDragOver: function (aEvent, aFlavour, aDragSession)</span>
<a href="#l44.340"></a><span id="l44.340">   {</span>
<a href="#l44.341"></a><span id="l44.341">     var messagepanebox = document.getElementById(&quot;messagepanebox&quot;);</span>
<a href="#l44.342"></a><span id="l44.342">     messagepanebox.setAttribute(&quot;dragover&quot;, &quot;true&quot;);</span>
<a href="#l44.343"></a><span id="l44.343">   },</span>
<a href="#l44.344"></a><span id="l44.344" class="difflineat">@@ -144,295 +259,144 @@ var messagepaneObserver = {</span>
<a href="#l44.345"></a><span id="l44.345">   getSupportedFlavours: function ()</span>
<a href="#l44.346"></a><span id="l44.346">   {</span>
<a href="#l44.347"></a><span id="l44.347">     var flavourSet = new FlavourSet();</span>
<a href="#l44.348"></a><span id="l44.348">     flavourSet.appendFlavour(&quot;text/x-moz-message&quot;);</span>
<a href="#l44.349"></a><span id="l44.349">     return flavourSet;</span>
<a href="#l44.350"></a><span id="l44.350">   }</span>
<a href="#l44.351"></a><span id="l44.351"> };</span>
<a href="#l44.352"></a><span id="l44.352"> </span>
<a href="#l44.353"></a><span id="l44.353" class="difflineminus">-function nsMsgDBViewCommandUpdater()</span>
<a href="#l44.354"></a><span id="l44.354" class="difflineminus">-{}</span>
<a href="#l44.355"></a><span id="l44.355" class="difflineminus">-</span>
<a href="#l44.356"></a><span id="l44.356" class="difflineminus">-function UpdateStandAloneMessageCounts()</span>
<a href="#l44.357"></a><span id="l44.357" class="difflineplus">+function UpdateStatusMessageCounts()</span>
<a href="#l44.358"></a><span id="l44.358"> {</span>
<a href="#l44.359"></a><span id="l44.359">   // hook for extra toolbar items</span>
<a href="#l44.360"></a><span id="l44.360">   var observerService = Components.classes[&quot;@mozilla.org/observer-service;1&quot;].getService(Components.interfaces.nsIObserverService);</span>
<a href="#l44.361"></a><span id="l44.361">   observerService.notifyObservers(window, &quot;mail:updateStandAloneMessageCounts&quot;, &quot;&quot;);</span>
<a href="#l44.362"></a><span id="l44.362"> }</span>
<a href="#l44.363"></a><span id="l44.363"> </span>
<a href="#l44.364"></a><span id="l44.364" class="difflineminus">-nsMsgDBViewCommandUpdater.prototype =</span>
<a href="#l44.365"></a><span id="l44.365" class="difflineminus">-{</span>
<a href="#l44.366"></a><span id="l44.366" class="difflineminus">-  updateCommandStatus : function()</span>
<a href="#l44.367"></a><span id="l44.367" class="difflineminus">-    {</span>
<a href="#l44.368"></a><span id="l44.368" class="difflineminus">-      // the back end is smart and is only telling us to update command status</span>
<a href="#l44.369"></a><span id="l44.369" class="difflineminus">-      // when the # of items in the selection has actually changed.</span>
<a href="#l44.370"></a><span id="l44.370" class="difflineminus">-      UpdateMailToolbar(&quot;dbview, std alone window&quot;);</span>
<a href="#l44.371"></a><span id="l44.371" class="difflineminus">-    },</span>
<a href="#l44.372"></a><span id="l44.372" class="difflineminus">-</span>
<a href="#l44.373"></a><span id="l44.373" class="difflineminus">-  displayMessageChanged : function(aFolder, aSubject, aKeywords)</span>
<a href="#l44.374"></a><span id="l44.374" class="difflineminus">-  {</span>
<a href="#l44.375"></a><span id="l44.375" class="difflineminus">-    setTitleFromFolder(aFolder, aSubject);</span>
<a href="#l44.376"></a><span id="l44.376" class="difflineminus">-    ClearPendingReadTimer(); // we are loading / selecting a new message so kill the mark as read timer for the currently viewed message</span>
<a href="#l44.377"></a><span id="l44.377" class="difflineminus">-    gCurrentMessageUri = gDBView.URIForFirstSelectedMessage;</span>
<a href="#l44.378"></a><span id="l44.378" class="difflineminus">-    UpdateStandAloneMessageCounts();</span>
<a href="#l44.379"></a><span id="l44.379" class="difflineminus">-    goUpdateCommand(&quot;button_delete&quot;);</span>
<a href="#l44.380"></a><span id="l44.380" class="difflineminus">-    goUpdateCommand(&quot;button_junk&quot;);</span>
<a href="#l44.381"></a><span id="l44.381" class="difflineminus">-    goUpdateCommand(&quot;button_goBack&quot;);</span>
<a href="#l44.382"></a><span id="l44.382" class="difflineminus">-    goUpdateCommand(&quot;button_goForward&quot;);</span>
<a href="#l44.383"></a><span id="l44.383" class="difflineminus">-    goUpdateCommand(&quot;button_reply&quot;);</span>
<a href="#l44.384"></a><span id="l44.384" class="difflineminus">-    goUpdateCommand(&quot;button_replyall&quot;);</span>
<a href="#l44.385"></a><span id="l44.385" class="difflineminus">-    goUpdateCommand(&quot;button_replylist&quot;);</span>
<a href="#l44.386"></a><span id="l44.386" class="difflineminus">-  },</span>
<a href="#l44.387"></a><span id="l44.387" class="difflineminus">-</span>
<a href="#l44.388"></a><span id="l44.388" class="difflineminus">-  updateNextMessageAfterDelete : function()</span>
<a href="#l44.389"></a><span id="l44.389" class="difflineminus">-  {</span>
<a href="#l44.390"></a><span id="l44.390" class="difflineminus">-    SetNextMessageAfterDelete();</span>
<a href="#l44.391"></a><span id="l44.391" class="difflineminus">-  },</span>
<a href="#l44.392"></a><span id="l44.392" class="difflineminus">-</span>
<a href="#l44.393"></a><span id="l44.393" class="difflineminus">-  summarizeSelection : function() {return false},</span>
<a href="#l44.394"></a><span id="l44.394" class="difflineminus">-</span>
<a href="#l44.395"></a><span id="l44.395" class="difflineminus">-  QueryInterface : function(iid)</span>
<a href="#l44.396"></a><span id="l44.396" class="difflineminus">-  {</span>
<a href="#l44.397"></a><span id="l44.397" class="difflineminus">-    if (iid.equals(Components.interfaces.nsIMsgDBViewCommandUpdater) ||</span>
<a href="#l44.398"></a><span id="l44.398" class="difflineminus">-        iid.equals(Components.interfaces.nsISupports))</span>
<a href="#l44.399"></a><span id="l44.399" class="difflineminus">-      return this;</span>
<a href="#l44.400"></a><span id="l44.400" class="difflineminus">-</span>
<a href="#l44.401"></a><span id="l44.401" class="difflineminus">-    throw Components.results.NS_NOINTERFACE;</span>
<a href="#l44.402"></a><span id="l44.402" class="difflineminus">-  }</span>
<a href="#l44.403"></a><span id="l44.403" class="difflineminus">-}</span>
<a href="#l44.404"></a><span id="l44.404" class="difflineminus">-</span>
<a href="#l44.405"></a><span id="l44.405" class="difflineminus">-function HandleDeleteOrMoveMsgCompleted(folder)</span>
<a href="#l44.406"></a><span id="l44.406" class="difflineminus">-{</span>
<a href="#l44.407"></a><span id="l44.407" class="difflineminus">-  if ((folder.URI == gCurrentFolderUri))</span>
<a href="#l44.408"></a><span id="l44.408" class="difflineminus">-  {</span>
<a href="#l44.409"></a><span id="l44.409" class="difflineminus">-    gDBView.onDeleteCompleted(true);</span>
<a href="#l44.410"></a><span id="l44.410" class="difflineminus">-    if (gNextMessageViewIndexAfterDelete != nsMsgViewIndex_None)</span>
<a href="#l44.411"></a><span id="l44.411" class="difflineminus">-    {</span>
<a href="#l44.412"></a><span id="l44.412" class="difflineminus">-      var nextMstKey = gDBView.getKeyAt(gNextMessageViewIndexAfterDelete);</span>
<a href="#l44.413"></a><span id="l44.413" class="difflineminus">-</span>
<a href="#l44.414"></a><span id="l44.414" class="difflineminus">-      if (pref.getBoolPref(&quot;mail.close_message_window.on_delete&quot;)) {</span>
<a href="#l44.415"></a><span id="l44.415" class="difflineminus">-        // Tell the main window to select the next message since we</span>
<a href="#l44.416"></a><span id="l44.416" class="difflineminus">-        // won't be viewing it automatically in the standalone window.</span>
<a href="#l44.417"></a><span id="l44.417" class="difflineminus">-        var treeView = window.opener.document.getElementById(&quot;threadTree&quot;).view;</span>
<a href="#l44.418"></a><span id="l44.418" class="difflineminus">-        if (gDBView.removeRowOnMoveOrDelete &amp;&amp; gNextMessageViewIndexAfterDelete &gt;= 0) {</span>
<a href="#l44.419"></a><span id="l44.419" class="difflineminus">-          gDBView.suppressCommandUpdating = true;</span>
<a href="#l44.420"></a><span id="l44.420" class="difflineminus">-          treeView.selection.select(gNextMessageViewIndexAfterDelete);</span>
<a href="#l44.421"></a><span id="l44.421" class="difflineminus">-          treeView.selectionChanged();</span>
<a href="#l44.422"></a><span id="l44.422" class="difflineminus">-</span>
<a href="#l44.423"></a><span id="l44.423" class="difflineminus">-          window.opener.EnsureRowInThreadTreeIsVisible(gNextMessageViewIndexAfterDelete);</span>
<a href="#l44.424"></a><span id="l44.424" class="difflineminus">-          gDBView.suppressCommandUpdating = false;</span>
<a href="#l44.425"></a><span id="l44.425" class="difflineminus">-        }</span>
<a href="#l44.426"></a><span id="l44.426" class="difflineminus">-</span>
<a href="#l44.427"></a><span id="l44.427" class="difflineminus">-        window.close();</span>
<a href="#l44.428"></a><span id="l44.428" class="difflineminus">-      }</span>
<a href="#l44.429"></a><span id="l44.429" class="difflineminus">-      else if (nextMstKey != nsMsgKey_None) {</span>
<a href="#l44.430"></a><span id="l44.430" class="difflineminus">-        LoadMessageByViewIndex(gNextMessageViewIndexAfterDelete);</span>
<a href="#l44.431"></a><span id="l44.431" class="difflineminus">-      }</span>
<a href="#l44.432"></a><span id="l44.432" class="difflineminus">-      else {</span>
<a href="#l44.433"></a><span id="l44.433" class="difflineminus">-        window.close();</span>
<a href="#l44.434"></a><span id="l44.434" class="difflineminus">-      }</span>
<a href="#l44.435"></a><span id="l44.435" class="difflineminus">-    }</span>
<a href="#l44.436"></a><span id="l44.436" class="difflineminus">-    else</span>
<a href="#l44.437"></a><span id="l44.437" class="difflineminus">-    {</span>
<a href="#l44.438"></a><span id="l44.438" class="difflineminus">-      // close the stand alone window because there are no more messages in the folder</span>
<a href="#l44.439"></a><span id="l44.439" class="difflineminus">-      window.close();</span>
<a href="#l44.440"></a><span id="l44.440" class="difflineminus">-    }</span>
<a href="#l44.441"></a><span id="l44.441" class="difflineminus">-  }</span>
<a href="#l44.442"></a><span id="l44.442" class="difflineminus">-}</span>
<a href="#l44.443"></a><span id="l44.443" class="difflineminus">-</span>
<a href="#l44.444"></a><span id="l44.444" class="difflineminus">-function HandleDeleteOrMoveMsgFailed(folder)</span>
<a href="#l44.445"></a><span id="l44.445" class="difflineminus">-{</span>
<a href="#l44.446"></a><span id="l44.446" class="difflineminus">-  gDBView.onDeleteCompleted(false);</span>
<a href="#l44.447"></a><span id="l44.447" class="difflineminus">-}</span>
<a href="#l44.448"></a><span id="l44.448" class="difflineminus">-</span>
<a href="#l44.449"></a><span id="l44.449" class="difflineminus">-function IsCurrentLoadedFolder(folder)</span>
<a href="#l44.450"></a><span id="l44.450" class="difflineminus">-{</span>
<a href="#l44.451"></a><span id="l44.451" class="difflineminus">-  return (folder.URI == gCurrentFolderUri);</span>
<a href="#l44.452"></a><span id="l44.452" class="difflineminus">-}</span>
<a href="#l44.453"></a><span id="l44.453" class="difflineminus">-</span>
<a href="#l44.454"></a><span id="l44.454" class="difflineminus">-</span>
<a href="#l44.455"></a><span id="l44.455"> // we won't show the window until the onload() handler is finished</span>
<a href="#l44.456"></a><span id="l44.456"> // so we do this trick (suggested by hyatt / blaker)</span>
<a href="#l44.457"></a><span id="l44.457"> function OnLoadMessageWindow()</span>
<a href="#l44.458"></a><span id="l44.458"> {</span>
<a href="#l44.459"></a><span id="l44.459">   setTimeout(delayedOnLoadMessageWindow, 0); // when debugging, set this to 5000, so you can see what happens after the window comes up.</span>
<a href="#l44.460"></a><span id="l44.460"> }</span>
<a href="#l44.461"></a><span id="l44.461"> </span>
<a href="#l44.462"></a><span id="l44.462"> function delayedOnLoadMessageWindow()</span>
<a href="#l44.463"></a><span id="l44.463"> {</span>
<a href="#l44.464"></a><span id="l44.464">   HideMenus();</span>
<a href="#l44.465"></a><span id="l44.465">   ShowMenus();</span>
<a href="#l44.466"></a><span id="l44.466">   MailOfflineMgr.init();</span>
<a href="#l44.467"></a><span id="l44.467">   CreateMailWindowGlobals();</span>
<a href="#l44.468"></a><span id="l44.468">   verifyAccounts(null);</span>
<a href="#l44.469"></a><span id="l44.469"> </span>
<a href="#l44.470"></a><span id="l44.470" class="difflineplus">+  /**</span>
<a href="#l44.471"></a><span id="l44.471" class="difflineplus">+   * Create a message listener so that we can update the title once the message</span>
<a href="#l44.472"></a><span id="l44.472" class="difflineplus">+   *  finishes streaming when it's a dummy.</span>
<a href="#l44.473"></a><span id="l44.473" class="difflineplus">+   */</span>
<a href="#l44.474"></a><span id="l44.474" class="difflineplus">+  gMessageListeners.push({</span>
<a href="#l44.475"></a><span id="l44.475" class="difflineplus">+    onStartHeaders: function () {},</span>
<a href="#l44.476"></a><span id="l44.476" class="difflineplus">+    onEndHeaders: function() {</span>
<a href="#l44.477"></a><span id="l44.477" class="difflineplus">+      if (gMessageDisplay.isDummy)</span>
<a href="#l44.478"></a><span id="l44.478" class="difflineplus">+        gMessageDisplay.onDisplayingMessage(messageHeaderSink.dummyMsgHeader);</span>
<a href="#l44.479"></a><span id="l44.479" class="difflineplus">+      UpdateMailToolbar(&quot;.eml/message from attachment finished loading&quot;);</span>
<a href="#l44.480"></a><span id="l44.480" class="difflineplus">+    },</span>
<a href="#l44.481"></a><span id="l44.481" class="difflineplus">+    onEndAttachments: function () {},</span>
<a href="#l44.482"></a><span id="l44.482" class="difflineplus">+  });</span>
<a href="#l44.483"></a><span id="l44.483" class="difflineplus">+</span>
<a href="#l44.484"></a><span id="l44.484">   InitMsgWindow();</span>
<a href="#l44.485"></a><span id="l44.485"> </span>
<a href="#l44.486"></a><span id="l44.486">   messenger.setWindow(window, msgWindow);</span>
<a href="#l44.487"></a><span id="l44.487">   // FIX ME - later we will be able to use onload from the overlay</span>
<a href="#l44.488"></a><span id="l44.488">   OnLoadMsgHeaderPane();</span>
<a href="#l44.489"></a><span id="l44.489"> </span>
<a href="#l44.490"></a><span id="l44.490" class="difflineminus">-  var nsIFolderListener = Components.interfaces.nsIFolderListener;</span>
<a href="#l44.491"></a><span id="l44.491" class="difflineminus">-  var notifyFlags = nsIFolderListener.removed | nsIFolderListener.event | nsIFolderListener.intPropertyChanged;</span>
<a href="#l44.492"></a><span id="l44.492" class="difflineminus">-  Components.classes[&quot;@mozilla.org/messenger/services/session;1&quot;]</span>
<a href="#l44.493"></a><span id="l44.493" class="difflineminus">-            .getService(Components.interfaces.nsIMsgMailSession)</span>
<a href="#l44.494"></a><span id="l44.494" class="difflineminus">-            .AddFolderListener(folderListener, notifyFlags);</span>
<a href="#l44.495"></a><span id="l44.495" class="difflineminus">-</span>
<a href="#l44.496"></a><span id="l44.496" class="difflineminus">-  var originalView = null;</span>
<a href="#l44.497"></a><span id="l44.497" class="difflineminus">-  var folder = null;</span>
<a href="#l44.498"></a><span id="l44.498" class="difflineminus">-  var messageUri;</span>
<a href="#l44.499"></a><span id="l44.499" class="difflineminus">-  var loadCustomMessage = false;       //set to true when either loading a message/rfc822 attachment or a .eml file</span>
<a href="#l44.500"></a><span id="l44.500" class="difflineminus">-  if (window.arguments)</span>
<a href="#l44.501"></a><span id="l44.501" class="difflineminus">-  {</span>
<a href="#l44.502"></a><span id="l44.502" class="difflineminus">-    if (window.arguments[0])</span>
<a href="#l44.503"></a><span id="l44.503" class="difflineminus">-    {</span>
<a href="#l44.504"></a><span id="l44.504" class="difflineminus">-      try</span>
<a href="#l44.505"></a><span id="l44.505" class="difflineminus">-      {</span>
<a href="#l44.506"></a><span id="l44.506" class="difflineminus">-        messageUri = window.arguments[0];</span>
<a href="#l44.507"></a><span id="l44.507" class="difflineminus">-        if (messageUri instanceof Components.interfaces.nsIURI)</span>
<a href="#l44.508"></a><span id="l44.508" class="difflineminus">-        {</span>
<a href="#l44.509"></a><span id="l44.509" class="difflineminus">-          loadCustomMessage = /type=application\/x-message-display/.test(messageUri.spec);</span>
<a href="#l44.510"></a><span id="l44.510" class="difflineminus">-          gCurrentMessageUri = messageUri.spec;</span>
<a href="#l44.511"></a><span id="l44.511" class="difflineminus">-          if (messageUri.folder &amp;&amp; messageUri instanceof Components.interfaces.nsIMsgMailNewsUrl)</span>
<a href="#l44.512"></a><span id="l44.512" class="difflineminus">-            folder = messageUri.folder;</span>
<a href="#l44.513"></a><span id="l44.513" class="difflineminus">-        }</span>
<a href="#l44.514"></a><span id="l44.514" class="difflineminus">-      }</span>
<a href="#l44.515"></a><span id="l44.515" class="difflineminus">-      catch(ex)</span>
<a href="#l44.516"></a><span id="l44.516" class="difflineminus">-      {</span>
<a href="#l44.517"></a><span id="l44.517" class="difflineminus">-        folder = null;</span>
<a href="#l44.518"></a><span id="l44.518" class="difflineminus">-        dump(&quot;## ex=&quot; + ex + &quot;\n&quot;);</span>
<a href="#l44.519"></a><span id="l44.519" class="difflineminus">-      }</span>
<a href="#l44.520"></a><span id="l44.520" class="difflineminus">-</span>
<a href="#l44.521"></a><span id="l44.521" class="difflineminus">-      if (!gCurrentMessageUri)</span>
<a href="#l44.522"></a><span id="l44.522" class="difflineminus">-        gCurrentMessageUri = window.arguments[0];</span>
<a href="#l44.523"></a><span id="l44.523" class="difflineminus">-    }</span>
<a href="#l44.524"></a><span id="l44.524" class="difflineminus">-    else</span>
<a href="#l44.525"></a><span id="l44.525" class="difflineminus">-      gCurrentMessageUri = null;</span>
<a href="#l44.526"></a><span id="l44.526" class="difflineminus">-</span>
<a href="#l44.527"></a><span id="l44.527" class="difflineminus">-    if (window.arguments[1])</span>
<a href="#l44.528"></a><span id="l44.528" class="difflineminus">-      gCurrentFolderUri = window.arguments[1];</span>
<a href="#l44.529"></a><span id="l44.529" class="difflineminus">-    else</span>
<a href="#l44.530"></a><span id="l44.530" class="difflineminus">-      gCurrentFolderUri = folder ? folder.URI : null;</span>
<a href="#l44.531"></a><span id="l44.531" class="difflineminus">-</span>
<a href="#l44.532"></a><span id="l44.532" class="difflineminus">-    if (window.arguments[2])</span>
<a href="#l44.533"></a><span id="l44.533" class="difflineminus">-      originalView = window.arguments[2];</span>
<a href="#l44.534"></a><span id="l44.534" class="difflineminus">-</span>
<a href="#l44.535"></a><span id="l44.535" class="difflineminus">-  }</span>
<a href="#l44.536"></a><span id="l44.536" class="difflineminus">-</span>
<a href="#l44.537"></a><span id="l44.537" class="difflineminus">-  CreateView(originalView);</span>
<a href="#l44.538"></a><span id="l44.538" class="difflineminus">-</span>
<a href="#l44.539"></a><span id="l44.539">   gPhishingDetector.init();</span>
<a href="#l44.540"></a><span id="l44.540"> </span>
<a href="#l44.541"></a><span id="l44.541">   // initialize the customizeDone method on the customizeable toolbar</span>
<a href="#l44.542"></a><span id="l44.542">   var toolbox = document.getElementById(&quot;mail-toolbox&quot;);</span>
<a href="#l44.543"></a><span id="l44.543">   toolbox.customizeDone = function(aEvent) { MailToolboxCustomizeDone(aEvent, &quot;CustomizeMailToolbar&quot;); };</span>
<a href="#l44.544"></a><span id="l44.544"> </span>
<a href="#l44.545"></a><span id="l44.545">   var toolbarset = document.getElementById('customToolbars');</span>
<a href="#l44.546"></a><span id="l44.546">   toolbox.toolbarset = toolbarset;</span>
<a href="#l44.547"></a><span id="l44.547"> </span>
<a href="#l44.548"></a><span id="l44.548" class="difflineminus">-  setTimeout(OnLoadMessageWindowDelayed, 0, loadCustomMessage);</span>
<a href="#l44.549"></a><span id="l44.549" class="difflineplus">+  SetupCommandUpdateHandlers();</span>
<a href="#l44.550"></a><span id="l44.550"> </span>
<a href="#l44.551"></a><span id="l44.551" class="difflineminus">-  SetupCommandUpdateHandlers();</span>
<a href="#l44.552"></a><span id="l44.552" class="difflineplus">+  gMessageDisplay = new StandaloneMessageDisplayWidget();</span>
<a href="#l44.553"></a><span id="l44.553" class="difflineplus">+  gFolderDisplay = new StandaloneFolderDisplayWidget(gMessageDisplay);</span>
<a href="#l44.554"></a><span id="l44.554" class="difflineplus">+  gFolderDisplay.msgWindow = msgWindow;</span>
<a href="#l44.555"></a><span id="l44.555" class="difflineplus">+  gFolderDisplay.messenger = messenger;</span>
<a href="#l44.556"></a><span id="l44.556" class="difflineplus">+</span>
<a href="#l44.557"></a><span id="l44.557" class="difflineplus">+  setTimeout(actuallyLoadMessage, 0);</span>
<a href="#l44.558"></a><span id="l44.558"> }</span>
<a href="#l44.559"></a><span id="l44.559"> </span>
<a href="#l44.560"></a><span id="l44.560" class="difflineminus">-function OnLoadMessageWindowDelayed(loadCustomMessage)</span>
<a href="#l44.561"></a><span id="l44.561" class="difflineminus">-{</span>
<a href="#l44.562"></a><span id="l44.562" class="difflineminus">-  if (loadCustomMessage)</span>
<a href="#l44.563"></a><span id="l44.563" class="difflineminus">-  {</span>
<a href="#l44.564"></a><span id="l44.564" class="difflineminus">-    gDBView.suppressMsgDisplay = false;</span>
<a href="#l44.565"></a><span id="l44.565" class="difflineminus">-    gDBView.loadMessageByUrl(gCurrentMessageUri);</span>
<a href="#l44.566"></a><span id="l44.566" class="difflineminus">-  }</span>
<a href="#l44.567"></a><span id="l44.567" class="difflineminus">-  else</span>
<a href="#l44.568"></a><span id="l44.568" class="difflineplus">+function actuallyLoadMessage() {</span>
<a href="#l44.569"></a><span id="l44.569" class="difflineplus">+  /*</span>
<a href="#l44.570"></a><span id="l44.570" class="difflineplus">+   * Our actual use cases that drive the arguments we take are:</span>
<a href="#l44.571"></a><span id="l44.571" class="difflineplus">+   * 1) Displaying a message from disk or that was an attachment on a message.</span>
<a href="#l44.572"></a><span id="l44.572" class="difflineplus">+   *    Such messages have no (real) message header and must come in the form of</span>
<a href="#l44.573"></a><span id="l44.573" class="difflineplus">+   *    a URI.  (The message display code creates a 'dummy' header.)</span>
<a href="#l44.574"></a><span id="l44.574" class="difflineplus">+   * 2) Displaying a message that has a header available, either as a result of</span>
<a href="#l44.575"></a><span id="l44.575" class="difflineplus">+   *    the user selecting a message in another window to spawn us or through</span>
<a href="#l44.576"></a><span id="l44.576" class="difflineplus">+   *    some indirection like displaying a message by message-id.  (The</span>
<a href="#l44.577"></a><span id="l44.577" class="difflineplus">+   *    newsgroup UI exposes this, as well as the spotlight/vista indexers.)</span>
<a href="#l44.578"></a><span id="l44.578" class="difflineplus">+   *</span>
<a href="#l44.579"></a><span id="l44.579" class="difflineplus">+   * We clone views when possible for:</span>
<a href="#l44.580"></a><span id="l44.580" class="difflineplus">+   * - Consistency of navigation within the message display.  Users would find</span>
<a href="#l44.581"></a><span id="l44.581" class="difflineplus">+   *   it odd if they showed a message from a cross-folder view but ended up</span>
<a href="#l44.582"></a><span id="l44.582" class="difflineplus">+   *   navigating around the message's actual folder.</span>
<a href="#l44.583"></a><span id="l44.583" class="difflineplus">+   * - Efficiency.  It's faster to clone a view than open a new one.</span>
<a href="#l44.584"></a><span id="l44.584" class="difflineplus">+   *</span>
<a href="#l44.585"></a><span id="l44.585" class="difflineplus">+   * Our argument idioms for the use cases are thus:</span>
<a href="#l44.586"></a><span id="l44.586" class="difflineplus">+   * 1) [A Message URI] where the URI is an nsIURL corresponding to a message</span>
<a href="#l44.587"></a><span id="l44.587" class="difflineplus">+   *     on disk or that is an attachment part on another message.</span>
<a href="#l44.588"></a><span id="l44.588" class="difflineplus">+   * 2) [A Message header, (optional) the origin DBViewWraper]</span>
<a href="#l44.589"></a><span id="l44.589" class="difflineplus">+   *</span>
<a href="#l44.590"></a><span id="l44.590" class="difflineplus">+   * Our original set of arguments, in case these get passed in and you're</span>
<a href="#l44.591"></a><span id="l44.591" class="difflineplus">+   *  wondering why we explode, was:</span>
<a href="#l44.592"></a><span id="l44.592" class="difflineplus">+   *   0: A message URI, string or nsIURI.</span>
<a href="#l44.593"></a><span id="l44.593" class="difflineplus">+   *   1: A folder URI.  If arg 0 was an nsIURI, it may have had a folder attribute.</span>
<a href="#l44.594"></a><span id="l44.594" class="difflineplus">+   *   2: The nsIMsgDBView used to open us.</span>
<a href="#l44.595"></a><span id="l44.595" class="difflineplus">+   */</span>
<a href="#l44.596"></a><span id="l44.596" class="difflineplus">+  if (window.arguments &amp;&amp; window.arguments.length)</span>
<a href="#l44.597"></a><span id="l44.597">   {</span>
<a href="#l44.598"></a><span id="l44.598" class="difflineminus">-    var msgKey = extractMsgKeyFromURI(gCurrentMessageUri);</span>
<a href="#l44.599"></a><span id="l44.599" class="difflineminus">-    var viewIndex = gDBView.findIndexFromKey(msgKey, true);</span>
<a href="#l44.600"></a><span id="l44.600" class="difflineminus">-    // the message may not appear in the view if loaded from a search dialog</span>
<a href="#l44.601"></a><span id="l44.601" class="difflineminus">-    if (viewIndex != nsMsgViewIndex_None)</span>
<a href="#l44.602"></a><span id="l44.602" class="difflineminus">-      LoadMessageByViewIndex(viewIndex);</span>
<a href="#l44.603"></a><span id="l44.603" class="difflineminus">-    else</span>
<a href="#l44.604"></a><span id="l44.604" class="difflineminus">-      messenger.openURL(gCurrentMessageUri);</span>
<a href="#l44.605"></a><span id="l44.605" class="difflineplus">+    // message header?</span>
<a href="#l44.606"></a><span id="l44.606" class="difflineplus">+    if (window.arguments[0] instanceof Components.interfaces.nsIMsgDBHdr) {</span>
<a href="#l44.607"></a><span id="l44.607" class="difflineplus">+      let msgHdr = window.arguments[0];</span>
<a href="#l44.608"></a><span id="l44.608" class="difflineplus">+      let originViewWrapper = window.arguments.length &gt; 1 ?</span>
<a href="#l44.609"></a><span id="l44.609" class="difflineplus">+        window.arguments[1] : null;</span>
<a href="#l44.610"></a><span id="l44.610" class="difflineplus">+      if (originViewWrapper)</span>
<a href="#l44.611"></a><span id="l44.611" class="difflineplus">+        gFolderDisplay.cloneView(originViewWrapper);</span>
<a href="#l44.612"></a><span id="l44.612" class="difflineplus">+      else</span>
<a href="#l44.613"></a><span id="l44.613" class="difflineplus">+        gFolderDisplay.show(msgHdr.folder);</span>
<a href="#l44.614"></a><span id="l44.614" class="difflineplus">+      gFolderDisplay.selectMessage(msgHdr);</span>
<a href="#l44.615"></a><span id="l44.615" class="difflineplus">+    }</span>
<a href="#l44.616"></a><span id="l44.616" class="difflineplus">+    // it must be a URI for a message lacking a backing header</span>
<a href="#l44.617"></a><span id="l44.617" class="difflineplus">+    else {</span>
<a href="#l44.618"></a><span id="l44.618" class="difflineplus">+      // Here's how this goes.  nsMessenger::LoadURL checks out the URL we</span>
<a href="#l44.619"></a><span id="l44.619" class="difflineplus">+      //  pass it, and if it sees that the URI starts with &quot;file:&quot; or contains</span>
<a href="#l44.620"></a><span id="l44.620" class="difflineplus">+      //  &quot;type=application/x-message-display&quot; then it knows it needs to</span>
<a href="#l44.621"></a><span id="l44.621" class="difflineplus">+      //  create a dummy header.  It gets the 'dummyMsgHeader' property from</span>
<a href="#l44.622"></a><span id="l44.622" class="difflineplus">+      //  the js message header sink.</span>
<a href="#l44.623"></a><span id="l44.623" class="difflineplus">+      // Additionally, nsMessenger::MsgHdrFromURI checks the URI we pass it</span>
<a href="#l44.624"></a><span id="l44.624" class="difflineplus">+      //  and if it meets either of those same constraints (assuming it has a</span>
<a href="#l44.625"></a><span id="l44.625" class="difflineplus">+      //  msgWindow), it will retrieve the header sink off the msgWindow, get</span>
<a href="#l44.626"></a><span id="l44.626" class="difflineplus">+      //  the dummy header, and return that.</span>
<a href="#l44.627"></a><span id="l44.627" class="difflineplus">+      // so...</span>
<a href="#l44.628"></a><span id="l44.628" class="difflineplus">+      // - create a search view for the standalone dude</span>
<a href="#l44.629"></a><span id="l44.629" class="difflineplus">+      gFolderDisplay.view.openSearchView();</span>
<a href="#l44.630"></a><span id="l44.630" class="difflineplus">+      // - load the message</span>
<a href="#l44.631"></a><span id="l44.631" class="difflineplus">+      let messageURI = window.arguments[0];</span>
<a href="#l44.632"></a><span id="l44.632" class="difflineplus">+      if (messageURI instanceof Components.interfaces.nsIURI)</span>
<a href="#l44.633"></a><span id="l44.633" class="difflineplus">+        messageURI = messageURI.spec;</span>
<a href="#l44.634"></a><span id="l44.634" class="difflineplus">+      gMessageDisplay.displayExternalMessage(messageURI);</span>
<a href="#l44.635"></a><span id="l44.635" class="difflineplus">+    }</span>
<a href="#l44.636"></a><span id="l44.636">   }</span>
<a href="#l44.637"></a><span id="l44.637" class="difflineminus">-  gNextMessageViewIndexAfterDelete = gDBView.msgToSelectAfterDelete;</span>
<a href="#l44.638"></a><span id="l44.638" class="difflineminus">-  UpdateStandAloneMessageCounts();</span>
<a href="#l44.639"></a><span id="l44.639" class="difflineplus">+</span>
<a href="#l44.640"></a><span id="l44.640" class="difflineplus">+  gFolderDisplay.makeActive();</span>
<a href="#l44.641"></a><span id="l44.641"> </span>
<a href="#l44.642"></a><span id="l44.642">   // set focus to the message pane</span>
<a href="#l44.643"></a><span id="l44.643">   window.content.focus();</span>
<a href="#l44.644"></a><span id="l44.644" class="difflineminus">-</span>
<a href="#l44.645"></a><span id="l44.645" class="difflineminus">-  // since we just changed the pane with focus we need to update the toolbar to reflect this</span>
<a href="#l44.646"></a><span id="l44.646" class="difflineminus">-  // XXX TODO</span>
<a href="#l44.647"></a><span id="l44.647" class="difflineminus">-  // can we optimize</span>
<a href="#l44.648"></a><span id="l44.648" class="difflineminus">-  // and just update cmd_delete and button_delete?</span>
<a href="#l44.649"></a><span id="l44.649" class="difflineminus">-  UpdateMailToolbar(&quot;focus&quot;);</span>
<a href="#l44.650"></a><span id="l44.650" class="difflineminus">-}</span>
<a href="#l44.651"></a><span id="l44.651" class="difflineminus">-</span>
<a href="#l44.652"></a><span id="l44.652" class="difflineminus">-function CreateView(originalView)</span>
<a href="#l44.653"></a><span id="l44.653" class="difflineminus">-{</span>
<a href="#l44.654"></a><span id="l44.654" class="difflineminus">-  var msgFolder = GetLoadedMsgFolder();</span>
<a href="#l44.655"></a><span id="l44.655" class="difflineminus">-</span>
<a href="#l44.656"></a><span id="l44.656" class="difflineminus">-  // extract the sort type, the sort order,</span>
<a href="#l44.657"></a><span id="l44.657" class="difflineminus">-  var sortType;</span>
<a href="#l44.658"></a><span id="l44.658" class="difflineminus">-  var sortOrder;</span>
<a href="#l44.659"></a><span id="l44.659" class="difflineminus">-  var viewFlags;</span>
<a href="#l44.660"></a><span id="l44.660" class="difflineminus">-  var viewType;</span>
<a href="#l44.661"></a><span id="l44.661" class="difflineminus">-</span>
<a href="#l44.662"></a><span id="l44.662" class="difflineminus">-  if (originalView)</span>
<a href="#l44.663"></a><span id="l44.663" class="difflineminus">-  {</span>
<a href="#l44.664"></a><span id="l44.664" class="difflineminus">-    viewType = originalView.viewType;</span>
<a href="#l44.665"></a><span id="l44.665" class="difflineminus">-    viewFlags = originalView.viewFlags;</span>
<a href="#l44.666"></a><span id="l44.666" class="difflineminus">-    sortType = originalView.sortType;</span>
<a href="#l44.667"></a><span id="l44.667" class="difflineminus">-    sortOrder = originalView.sortOrder;</span>
<a href="#l44.668"></a><span id="l44.668" class="difflineminus">-  }</span>
<a href="#l44.669"></a><span id="l44.669" class="difflineminus">-  else if (msgFolder)</span>
<a href="#l44.670"></a><span id="l44.670" class="difflineminus">-  {</span>
<a href="#l44.671"></a><span id="l44.671" class="difflineminus">-    var msgDatabase = msgFolder.msgDatabase;</span>
<a href="#l44.672"></a><span id="l44.672" class="difflineminus">-    if (msgDatabase)</span>
<a href="#l44.673"></a><span id="l44.673" class="difflineminus">-    {</span>
<a href="#l44.674"></a><span id="l44.674" class="difflineminus">-      var dbFolderInfo = msgDatabase.dBFolderInfo;</span>
<a href="#l44.675"></a><span id="l44.675" class="difflineminus">-      sortType = dbFolderInfo.sortType;</span>
<a href="#l44.676"></a><span id="l44.676" class="difflineminus">-      sortOrder = dbFolderInfo.sortOrder;</span>
<a href="#l44.677"></a><span id="l44.677" class="difflineminus">-      viewFlags = dbFolderInfo.viewFlags;</span>
<a href="#l44.678"></a><span id="l44.678" class="difflineminus">-      viewType = dbFolderInfo.viewType;</span>
<a href="#l44.679"></a><span id="l44.679" class="difflineminus">-      msgDatabase = null;</span>
<a href="#l44.680"></a><span id="l44.680" class="difflineminus">-      dbFolderInfo = null;</span>
<a href="#l44.681"></a><span id="l44.681" class="difflineminus">-   }</span>
<a href="#l44.682"></a><span id="l44.682" class="difflineminus">-  }</span>
<a href="#l44.683"></a><span id="l44.683" class="difflineminus">-  else</span>
<a href="#l44.684"></a><span id="l44.684" class="difflineminus">-  {</span>
<a href="#l44.685"></a><span id="l44.685" class="difflineminus">-    // this is a hack to make opening a stand-alone msg window on a</span>
<a href="#l44.686"></a><span id="l44.686" class="difflineminus">-    // .eml file work. We use a search view since its much more tolerant</span>
<a href="#l44.687"></a><span id="l44.687" class="difflineminus">-    // of not having a folder.</span>
<a href="#l44.688"></a><span id="l44.688" class="difflineminus">-    viewType = nsMsgViewType.eShowSearch;</span>
<a href="#l44.689"></a><span id="l44.689" class="difflineminus">-  }</span>
<a href="#l44.690"></a><span id="l44.690" class="difflineminus">-</span>
<a href="#l44.691"></a><span id="l44.691" class="difflineminus">-  // create a db view</span>
<a href="#l44.692"></a><span id="l44.692" class="difflineminus">-  CreateBareDBView(originalView, msgFolder, viewType, viewFlags, sortType, sortOrder);</span>
<a href="#l44.693"></a><span id="l44.693" class="difflineminus">-</span>
<a href="#l44.694"></a><span id="l44.694" class="difflineminus">-  var uri;</span>
<a href="#l44.695"></a><span id="l44.695" class="difflineminus">-  if (gCurrentMessageUri)</span>
<a href="#l44.696"></a><span id="l44.696" class="difflineminus">-    uri = gCurrentMessageUri;</span>
<a href="#l44.697"></a><span id="l44.697" class="difflineminus">-  else if (gCurrentFolderUri)</span>
<a href="#l44.698"></a><span id="l44.698" class="difflineminus">-    uri = gCurrentFolderUri;</span>
<a href="#l44.699"></a><span id="l44.699" class="difflineminus">-  else</span>
<a href="#l44.700"></a><span id="l44.700" class="difflineminus">-    uri = null;</span>
<a href="#l44.701"></a><span id="l44.701" class="difflineminus">-</span>
<a href="#l44.702"></a><span id="l44.702" class="difflineminus">-  SetUpToolbarButtons(uri);</span>
<a href="#l44.703"></a><span id="l44.703" class="difflineminus">-</span>
<a href="#l44.704"></a><span id="l44.704" class="difflineminus">-  // hook for extra toolbar items</span>
<a href="#l44.705"></a><span id="l44.705" class="difflineminus">-  var observerService = Components.classes[&quot;@mozilla.org/observer-service;1&quot;].getService(Components.interfaces.nsIObserverService);</span>
<a href="#l44.706"></a><span id="l44.706" class="difflineminus">-  observerService.notifyObservers(window, &quot;mail:setupToolbarItems&quot;, uri);</span>
<a href="#l44.707"></a><span id="l44.707" class="difflineminus">-}</span>
<a href="#l44.708"></a><span id="l44.708" class="difflineminus">-</span>
<a href="#l44.709"></a><span id="l44.709" class="difflineminus">-function extractMsgKeyFromURI()</span>
<a href="#l44.710"></a><span id="l44.710" class="difflineminus">-{</span>
<a href="#l44.711"></a><span id="l44.711" class="difflineminus">-  var msgKey = -1;</span>
<a href="#l44.712"></a><span id="l44.712" class="difflineminus">-  var msgHdr =   messenger.msgHdrFromURI(gCurrentMessageUri);</span>
<a href="#l44.713"></a><span id="l44.713" class="difflineminus">-  if (msgHdr)</span>
<a href="#l44.714"></a><span id="l44.714" class="difflineminus">-    msgKey = msgHdr.messageKey;</span>
<a href="#l44.715"></a><span id="l44.715" class="difflineminus">-  return msgKey;</span>
<a href="#l44.716"></a><span id="l44.716"> }</span>
<a href="#l44.717"></a><span id="l44.717"> </span>
<a href="#l44.718"></a><span id="l44.718"> function ShowMenus()</span>
<a href="#l44.719"></a><span id="l44.719"> {</span>
<a href="#l44.720"></a><span id="l44.720">   var openMail3Pane_menuitem = document.getElementById('tasksMenuMail');</span>
<a href="#l44.721"></a><span id="l44.721">   if (openMail3Pane_menuitem)</span>
<a href="#l44.722"></a><span id="l44.722">     openMail3Pane_menuitem.removeAttribute(&quot;hidden&quot;);</span>
<a href="#l44.723"></a><span id="l44.723"> }</span>
<a href="#l44.724"></a><span id="l44.724" class="difflineat">@@ -529,256 +493,108 @@ function HideMenus()</span>
<a href="#l44.725"></a><span id="l44.725">   var menuFileClose = document.getElementById('menu_close');</span>
<a href="#l44.726"></a><span id="l44.726">   var menuFileQuit = document.getElementById('menu_FileQuitItem');</span>
<a href="#l44.727"></a><span id="l44.727">   if (menuFileClose &amp;&amp; menuFileQuit)</span>
<a href="#l44.728"></a><span id="l44.728">     menuFileQuit.parentNode.replaceChild(menuFileClose, menuFileQuit);</span>
<a href="#l44.729"></a><span id="l44.729"> }</span>
<a href="#l44.730"></a><span id="l44.730"> </span>
<a href="#l44.731"></a><span id="l44.731"> function OnUnloadMessageWindow()</span>
<a href="#l44.732"></a><span id="l44.732"> {</span>
<a href="#l44.733"></a><span id="l44.733" class="difflineplus">+  gFolderDisplay.close();</span>
<a href="#l44.734"></a><span id="l44.734">   UnloadCommandUpdateHandlers();</span>
<a href="#l44.735"></a><span id="l44.735">   // FIX ME - later we will be able to use onunload from the overlay</span>
<a href="#l44.736"></a><span id="l44.736">   OnUnloadMsgHeaderPane();</span>
<a href="#l44.737"></a><span id="l44.737">   gPhishingDetector.shutdown();</span>
<a href="#l44.738"></a><span id="l44.738">   OnMailWindowUnload();</span>
<a href="#l44.739"></a><span id="l44.739"> }</span>
<a href="#l44.740"></a><span id="l44.740"> </span>
<a href="#l44.741"></a><span id="l44.741"> function GetSelectedMsgFolders()</span>
<a href="#l44.742"></a><span id="l44.742"> {</span>
<a href="#l44.743"></a><span id="l44.743" class="difflineminus">-  var folderArray = [];</span>
<a href="#l44.744"></a><span id="l44.744" class="difflineminus">-  var msgFolder = GetLoadedMsgFolder();</span>
<a href="#l44.745"></a><span id="l44.745" class="difflineminus">-  if (msgFolder)</span>
<a href="#l44.746"></a><span id="l44.746" class="difflineminus">-    folderArray[0] = msgFolder;</span>
<a href="#l44.747"></a><span id="l44.747" class="difflineminus">-</span>
<a href="#l44.748"></a><span id="l44.748" class="difflineminus">-  return folderArray;</span>
<a href="#l44.749"></a><span id="l44.749" class="difflineminus">-}</span>
<a href="#l44.750"></a><span id="l44.750" class="difflineminus">-</span>
<a href="#l44.751"></a><span id="l44.751" class="difflineminus">-function GetFirstSelectedMessage()</span>
<a href="#l44.752"></a><span id="l44.752" class="difflineminus">-{</span>
<a href="#l44.753"></a><span id="l44.753" class="difflineminus">-  return GetLoadedMessage();</span>
<a href="#l44.754"></a><span id="l44.754" class="difflineplus">+  if (gFolderDisplay.displayedFolder)</span>
<a href="#l44.755"></a><span id="l44.755" class="difflineplus">+    return [gFolderDisplay.displayedFolder];</span>
<a href="#l44.756"></a><span id="l44.756" class="difflineplus">+  return [];</span>
<a href="#l44.757"></a><span id="l44.757"> }</span>
<a href="#l44.758"></a><span id="l44.758"> </span>
<a href="#l44.759"></a><span id="l44.759"> function GetNumSelectedMessages()</span>
<a href="#l44.760"></a><span id="l44.760"> {</span>
<a href="#l44.761"></a><span id="l44.761" class="difflineminus">-  if (gCurrentMessageUri)</span>
<a href="#l44.762"></a><span id="l44.762" class="difflineminus">-    return 1;</span>
<a href="#l44.763"></a><span id="l44.763" class="difflineminus">-  else</span>
<a href="#l44.764"></a><span id="l44.764" class="difflineminus">-    return 0;</span>
<a href="#l44.765"></a><span id="l44.765" class="difflineminus">-}</span>
<a href="#l44.766"></a><span id="l44.766" class="difflineminus">-</span>
<a href="#l44.767"></a><span id="l44.767" class="difflineminus">-function GetSelectedMessages()</span>
<a href="#l44.768"></a><span id="l44.768" class="difflineminus">-{</span>
<a href="#l44.769"></a><span id="l44.769" class="difflineminus">-  var messageArray = new Array(1);</span>
<a href="#l44.770"></a><span id="l44.770" class="difflineminus">-  var message = GetLoadedMessage();</span>
<a href="#l44.771"></a><span id="l44.771" class="difflineminus">-  if (message)</span>
<a href="#l44.772"></a><span id="l44.772" class="difflineminus">-    messageArray[0] = message;</span>
<a href="#l44.773"></a><span id="l44.773" class="difflineminus">-</span>
<a href="#l44.774"></a><span id="l44.774" class="difflineminus">-  return messageArray;</span>
<a href="#l44.775"></a><span id="l44.775" class="difflineminus">-}</span>
<a href="#l44.776"></a><span id="l44.776" class="difflineminus">-</span>
<a href="#l44.777"></a><span id="l44.777" class="difflineminus">-function GetSelectedIndices(dbView)</span>
<a href="#l44.778"></a><span id="l44.778" class="difflineminus">-{</span>
<a href="#l44.779"></a><span id="l44.779" class="difflineminus">-  try {</span>
<a href="#l44.780"></a><span id="l44.780" class="difflineminus">-    return dbView.getIndicesForSelection({});</span>
<a href="#l44.781"></a><span id="l44.781" class="difflineminus">-  }</span>
<a href="#l44.782"></a><span id="l44.782" class="difflineminus">-  catch (ex) {</span>
<a href="#l44.783"></a><span id="l44.783" class="difflineminus">-    dump(&quot;ex = &quot; + ex + &quot;\n&quot;);</span>
<a href="#l44.784"></a><span id="l44.784" class="difflineminus">-    return null;</span>
<a href="#l44.785"></a><span id="l44.785" class="difflineminus">-  }</span>
<a href="#l44.786"></a><span id="l44.786" class="difflineminus">-}</span>
<a href="#l44.787"></a><span id="l44.787" class="difflineminus">-</span>
<a href="#l44.788"></a><span id="l44.788" class="difflineminus">-function GetLoadedMsgFolder()</span>
<a href="#l44.789"></a><span id="l44.789" class="difflineminus">-{</span>
<a href="#l44.790"></a><span id="l44.790" class="difflineminus">-  return (gCurrentFolderUri) ? GetMsgFolderFromUri(gCurrentFolderUri) : null;</span>
<a href="#l44.791"></a><span id="l44.791" class="difflineminus">-}</span>
<a href="#l44.792"></a><span id="l44.792" class="difflineminus">-</span>
<a href="#l44.793"></a><span id="l44.793" class="difflineminus">-function GetSelectedFolderURI()</span>
<a href="#l44.794"></a><span id="l44.794" class="difflineminus">-{</span>
<a href="#l44.795"></a><span id="l44.795" class="difflineminus">-  return gCurrentFolderUri;</span>
<a href="#l44.796"></a><span id="l44.796" class="difflineminus">-}</span>
<a href="#l44.797"></a><span id="l44.797" class="difflineminus">-</span>
<a href="#l44.798"></a><span id="l44.798" class="difflineminus">-function GetLoadedMessage()</span>
<a href="#l44.799"></a><span id="l44.799" class="difflineminus">-{</span>
<a href="#l44.800"></a><span id="l44.800" class="difflineminus">-  return gCurrentMessageUri;</span>
<a href="#l44.801"></a><span id="l44.801" class="difflineminus">-}</span>
<a href="#l44.802"></a><span id="l44.802" class="difflineminus">-</span>
<a href="#l44.803"></a><span id="l44.803" class="difflineminus">-//Clear everything related to the current message. called after load start page.</span>
<a href="#l44.804"></a><span id="l44.804" class="difflineminus">-function ClearMessageSelection()</span>
<a href="#l44.805"></a><span id="l44.805" class="difflineminus">-{</span>
<a href="#l44.806"></a><span id="l44.806" class="difflineminus">-  gCurrentMessageUri = null;</span>
<a href="#l44.807"></a><span id="l44.807" class="difflineminus">-  gCurrentFolderUri = null;</span>
<a href="#l44.808"></a><span id="l44.808" class="difflineminus">-  UpdateMailToolbar(&quot;clear msg, std alone window&quot;);</span>
<a href="#l44.809"></a><span id="l44.809" class="difflineminus">-}</span>
<a href="#l44.810"></a><span id="l44.810" class="difflineminus">-</span>
<a href="#l44.811"></a><span id="l44.811" class="difflineminus">-function SetNextMessageAfterDelete()</span>
<a href="#l44.812"></a><span id="l44.812" class="difflineminus">-{</span>
<a href="#l44.813"></a><span id="l44.813" class="difflineminus">-  gNextMessageViewIndexAfterDelete = gDBView.msgToSelectAfterDelete;</span>
<a href="#l44.814"></a><span id="l44.814" class="difflineminus">-}</span>
<a href="#l44.815"></a><span id="l44.815" class="difflineminus">-</span>
<a href="#l44.816"></a><span id="l44.816" class="difflineminus">-function SelectFolder(folderUri)</span>
<a href="#l44.817"></a><span id="l44.817" class="difflineminus">-{</span>
<a href="#l44.818"></a><span id="l44.818" class="difflineminus">-  if (folderUri == gCurrentFolderUri)</span>
<a href="#l44.819"></a><span id="l44.819" class="difflineminus">-    return;</span>
<a href="#l44.820"></a><span id="l44.820" class="difflineminus">-</span>
<a href="#l44.821"></a><span id="l44.821" class="difflineminus">-  var msgfolder = GetMsgFolderFromUri(folderUri)</span>
<a href="#l44.822"></a><span id="l44.822" class="difflineminus">-  if (!msgfolder || msgfolder.isServer)</span>
<a href="#l44.823"></a><span id="l44.823" class="difflineminus">-    return;</span>
<a href="#l44.824"></a><span id="l44.824" class="difflineminus">-</span>
<a href="#l44.825"></a><span id="l44.825" class="difflineminus">-  // close old folder view</span>
<a href="#l44.826"></a><span id="l44.826" class="difflineminus">-  var dbview = GetDBView();</span>
<a href="#l44.827"></a><span id="l44.827" class="difflineminus">-  if (dbview)</span>
<a href="#l44.828"></a><span id="l44.828" class="difflineminus">-    dbview.close();</span>
<a href="#l44.829"></a><span id="l44.829" class="difflineminus">-</span>
<a href="#l44.830"></a><span id="l44.830" class="difflineminus">-  gCurrentFolderToRerootForStandAlone = folderUri;</span>
<a href="#l44.831"></a><span id="l44.831" class="difflineminus">-  msgWindow.openFolder = msgfolder;</span>
<a href="#l44.832"></a><span id="l44.832" class="difflineminus">-</span>
<a href="#l44.833"></a><span id="l44.833" class="difflineminus">-  if (msgfolder.manyHeadersToDownload)</span>
<a href="#l44.834"></a><span id="l44.834" class="difflineminus">-  {</span>
<a href="#l44.835"></a><span id="l44.835" class="difflineminus">-    gRerootOnFolderLoadForStandAlone = true;</span>
<a href="#l44.836"></a><span id="l44.836" class="difflineminus">-    try</span>
<a href="#l44.837"></a><span id="l44.837" class="difflineminus">-    {</span>
<a href="#l44.838"></a><span id="l44.838" class="difflineminus">-      // accessing the db causes the folder loaded notification to get sent</span>
<a href="#l44.839"></a><span id="l44.839" class="difflineminus">-      // for local folders.</span>
<a href="#l44.840"></a><span id="l44.840" class="difflineminus">-      var db = msgfolder.msgDatabase;</span>
<a href="#l44.841"></a><span id="l44.841" class="difflineminus">-      msgfolder.startFolderLoading();</span>
<a href="#l44.842"></a><span id="l44.842" class="difflineminus">-      msgfolder.updateFolder(msgWindow);</span>
<a href="#l44.843"></a><span id="l44.843" class="difflineminus">-    }</span>
<a href="#l44.844"></a><span id="l44.844" class="difflineminus">-    catch(ex)</span>
<a href="#l44.845"></a><span id="l44.845" class="difflineminus">-    {</span>
<a href="#l44.846"></a><span id="l44.846" class="difflineminus">-      dump(&quot;Error loading with many headers to download: &quot; + ex + &quot;\n&quot;);</span>
<a href="#l44.847"></a><span id="l44.847" class="difflineminus">-    }</span>
<a href="#l44.848"></a><span id="l44.848" class="difflineminus">-  }</span>
<a href="#l44.849"></a><span id="l44.849" class="difflineminus">-  else</span>
<a href="#l44.850"></a><span id="l44.850" class="difflineminus">-  {</span>
<a href="#l44.851"></a><span id="l44.851" class="difflineminus">-    RerootFolderForStandAlone(folderUri);</span>
<a href="#l44.852"></a><span id="l44.852" class="difflineminus">-    gRerootOnFolderLoadForStandAlone = false;</span>
<a href="#l44.853"></a><span id="l44.853" class="difflineminus">-    msgfolder.startFolderLoading();</span>
<a href="#l44.854"></a><span id="l44.854" class="difflineminus">-</span>
<a href="#l44.855"></a><span id="l44.855" class="difflineminus">-    //Need to do this after rerooting folder.  Otherwise possibility of receiving folder loaded</span>
<a href="#l44.856"></a><span id="l44.856" class="difflineminus">-    //notification before folder has actually changed.</span>
<a href="#l44.857"></a><span id="l44.857" class="difflineminus">-    msgfolder.updateFolder(msgWindow);</span>
<a href="#l44.858"></a><span id="l44.858" class="difflineminus">-  }</span>
<a href="#l44.859"></a><span id="l44.859" class="difflineminus">-}</span>
<a href="#l44.860"></a><span id="l44.860" class="difflineminus">-</span>
<a href="#l44.861"></a><span id="l44.861" class="difflineminus">-function RerootFolderForStandAlone(uri)</span>
<a href="#l44.862"></a><span id="l44.862" class="difflineminus">-{</span>
<a href="#l44.863"></a><span id="l44.863" class="difflineminus">-  gCurrentFolderUri = uri;</span>
<a href="#l44.864"></a><span id="l44.864" class="difflineminus">-</span>
<a href="#l44.865"></a><span id="l44.865" class="difflineminus">-  // create new folder view</span>
<a href="#l44.866"></a><span id="l44.866" class="difflineminus">-  CreateView(null);</span>
<a href="#l44.867"></a><span id="l44.867" class="difflineminus">-</span>
<a href="#l44.868"></a><span id="l44.868" class="difflineminus">-  if (gMessageToLoad != nsMsgKey_None)</span>
<a href="#l44.869"></a><span id="l44.869" class="difflineminus">-  {</span>
<a href="#l44.870"></a><span id="l44.870" class="difflineminus">-    LoadMessageByMsgKey(gMessageToLoad);</span>
<a href="#l44.871"></a><span id="l44.871" class="difflineminus">-    gMessageToLoad = nsMsgKey_None;</span>
<a href="#l44.872"></a><span id="l44.872" class="difflineminus">-  }</span>
<a href="#l44.873"></a><span id="l44.873" class="difflineminus">-  // now do the work to load the appropriate message</span>
<a href="#l44.874"></a><span id="l44.874" class="difflineminus">-  else if (gNextMessageAfterLoad) {</span>
<a href="#l44.875"></a><span id="l44.875" class="difflineminus">-    var type = gNextMessageAfterLoad;</span>
<a href="#l44.876"></a><span id="l44.876" class="difflineminus">-    gNextMessageAfterLoad = null;</span>
<a href="#l44.877"></a><span id="l44.877" class="difflineminus">-    LoadMessageByNavigationType(type);</span>
<a href="#l44.878"></a><span id="l44.878" class="difflineminus">-  }</span>
<a href="#l44.879"></a><span id="l44.879" class="difflineminus">-</span>
<a href="#l44.880"></a><span id="l44.880" class="difflineminus">-  SetUpToolbarButtons(gCurrentFolderUri);</span>
<a href="#l44.881"></a><span id="l44.881" class="difflineminus">-</span>
<a href="#l44.882"></a><span id="l44.882" class="difflineminus">-  UpdateMailToolbar(&quot;reroot folder in stand alone window&quot;);</span>
<a href="#l44.883"></a><span id="l44.883" class="difflineminus">-</span>
<a href="#l44.884"></a><span id="l44.884" class="difflineminus">-  // hook for extra toolbar items</span>
<a href="#l44.885"></a><span id="l44.885" class="difflineminus">-  var observerService = Components.classes[&quot;@mozilla.org/observer-service;1&quot;].getService(Components.interfaces.nsIObserverService);</span>
<a href="#l44.886"></a><span id="l44.886" class="difflineminus">-  observerService.notifyObservers(window, &quot;mail:setupToolbarItems&quot;, uri);</span>
<a href="#l44.887"></a><span id="l44.887" class="difflineminus">-}</span>
<a href="#l44.888"></a><span id="l44.888" class="difflineminus">-</span>
<a href="#l44.889"></a><span id="l44.889" class="difflineminus">-function GetMsgHdrFromUri(messageUri)</span>
<a href="#l44.890"></a><span id="l44.890" class="difflineminus">-{</span>
<a href="#l44.891"></a><span id="l44.891" class="difflineminus">-  return messenger.msgHdrFromURI(messageUri);</span>
<a href="#l44.892"></a><span id="l44.892" class="difflineminus">-}</span>
<a href="#l44.893"></a><span id="l44.893" class="difflineminus">-</span>
<a href="#l44.894"></a><span id="l44.894" class="difflineminus">-function SelectMessage(messageUri)</span>
<a href="#l44.895"></a><span id="l44.895" class="difflineminus">-{</span>
<a href="#l44.896"></a><span id="l44.896" class="difflineminus">-  var msgHdr = GetMsgHdrFromUri(messageUri);</span>
<a href="#l44.897"></a><span id="l44.897" class="difflineminus">-  LoadMessageByMsgKey(msgHdr.messageKey);</span>
<a href="#l44.898"></a><span id="l44.898" class="difflineplus">+  return gFolderDisplay.treeSelection.count;</span>
<a href="#l44.899"></a><span id="l44.899"> }</span>
<a href="#l44.900"></a><span id="l44.900"> </span>
<a href="#l44.901"></a><span id="l44.901"> function ReloadMessage()</span>
<a href="#l44.902"></a><span id="l44.902"> {</span>
<a href="#l44.903"></a><span id="l44.903" class="difflineminus">-  gDBView.reloadMessage();</span>
<a href="#l44.904"></a><span id="l44.904" class="difflineplus">+  gFolderDisplay.view.dbView.reloadMessage();</span>
<a href="#l44.905"></a><span id="l44.905"> }</span>
<a href="#l44.906"></a><span id="l44.906"> </span>
<a href="#l44.907"></a><span id="l44.907"> function MsgDeleteMessageFromMessageWindow(reallyDelete, fromToolbar)</span>
<a href="#l44.908"></a><span id="l44.908"> {</span>
<a href="#l44.909"></a><span id="l44.909">   // if from the toolbar, return right away if this is a news message</span>
<a href="#l44.910"></a><span id="l44.910">   // only allow cancel from the menu:  &quot;Edit | Cancel / Delete Message&quot;</span>
<a href="#l44.911"></a><span id="l44.911" class="difflineminus">-  if (fromToolbar)</span>
<a href="#l44.912"></a><span id="l44.912" class="difflineminus">-  {</span>
<a href="#l44.913"></a><span id="l44.913" class="difflineminus">-    if (isNewsURI(gCurrentFolderUri))</span>
<a href="#l44.914"></a><span id="l44.914" class="difflineminus">-    {</span>
<a href="#l44.915"></a><span id="l44.915" class="difflineminus">-        // if news, don't delete</span>
<a href="#l44.916"></a><span id="l44.916" class="difflineminus">-        return;</span>
<a href="#l44.917"></a><span id="l44.917" class="difflineminus">-    }</span>
<a href="#l44.918"></a><span id="l44.918" class="difflineminus">-  }</span>
<a href="#l44.919"></a><span id="l44.919" class="difflineplus">+  if (fromToolbar &amp;&amp; gDisplayFolder.view.isNewsFolder)</span>
<a href="#l44.920"></a><span id="l44.920" class="difflineplus">+      return;</span>
<a href="#l44.921"></a><span id="l44.921"> </span>
<a href="#l44.922"></a><span id="l44.922" class="difflineminus">-  // before we delete</span>
<a href="#l44.923"></a><span id="l44.923" class="difflineminus">-  SetNextMessageAfterDelete();</span>
<a href="#l44.924"></a><span id="l44.924" class="difflineplus">+  gFolderDisplay.hintAboutToDeleteMessages();</span>
<a href="#l44.925"></a><span id="l44.925"> </span>
<a href="#l44.926"></a><span id="l44.926">   if (reallyDelete)</span>
<a href="#l44.927"></a><span id="l44.927" class="difflineminus">-      gDBView.doCommand(nsMsgViewCommandType.deleteNoTrash);</span>
<a href="#l44.928"></a><span id="l44.928" class="difflineplus">+    gFolderDisplay.doCommand(nsMsgViewCommandType.deleteNoTrash);</span>
<a href="#l44.929"></a><span id="l44.929">   else</span>
<a href="#l44.930"></a><span id="l44.930" class="difflineminus">-      gDBView.doCommand(nsMsgViewCommandType.deleteMsg);</span>
<a href="#l44.931"></a><span id="l44.931" class="difflineplus">+    gFolderDisplay.doCommand(nsMsgViewCommandType.deleteMsg);</span>
<a href="#l44.932"></a><span id="l44.932"> }</span>
<a href="#l44.933"></a><span id="l44.933"> </span>
<a href="#l44.934"></a><span id="l44.934"> // MessageWindowController object (handles commands when one of the trees does not have focus)</span>
<a href="#l44.935"></a><span id="l44.935"> var MessageWindowController =</span>
<a href="#l44.936"></a><span id="l44.936"> {</span>
<a href="#l44.937"></a><span id="l44.937">    supportsCommand: function(command)</span>
<a href="#l44.938"></a><span id="l44.938">   {</span>
<a href="#l44.939"></a><span id="l44.939">     switch ( command )</span>
<a href="#l44.940"></a><span id="l44.940">     {</span>
<a href="#l44.941"></a><span id="l44.941" class="difflineplus">+      // external messages cannot be deleted, mutated, or subjected to filtering</span>
<a href="#l44.942"></a><span id="l44.942">       case &quot;cmd_delete&quot;:</span>
<a href="#l44.943"></a><span id="l44.943" class="difflineminus">-      case &quot;cmd_undo&quot;:</span>
<a href="#l44.944"></a><span id="l44.944" class="difflineminus">-      case &quot;cmd_redo&quot;:</span>
<a href="#l44.945"></a><span id="l44.945">       case &quot;cmd_killThread&quot;:</span>
<a href="#l44.946"></a><span id="l44.946">       case &quot;cmd_killSubthread&quot;:</span>
<a href="#l44.947"></a><span id="l44.947">       case &quot;cmd_watchThread&quot;:</span>
<a href="#l44.948"></a><span id="l44.948">       case &quot;button_delete&quot;:</span>
<a href="#l44.949"></a><span id="l44.949">       case &quot;button_junk&quot;:</span>
<a href="#l44.950"></a><span id="l44.950">       case &quot;cmd_shiftDelete&quot;:</span>
<a href="#l44.951"></a><span id="l44.951" class="difflineminus">-      case &quot;cmd_saveAsFile&quot;:</span>
<a href="#l44.952"></a><span id="l44.952" class="difflineminus">-      case &quot;cmd_saveAsTemplate&quot;:</span>
<a href="#l44.953"></a><span id="l44.953" class="difflineminus">-      case &quot;cmd_viewPageSource&quot;:</span>
<a href="#l44.954"></a><span id="l44.954" class="difflineminus">-      case &quot;cmd_getMsgsForAuthAccounts&quot;:</span>
<a href="#l44.955"></a><span id="l44.955">       case &quot;cmd_tag&quot;:</span>
<a href="#l44.956"></a><span id="l44.956">       case &quot;button_mark&quot;:</span>
<a href="#l44.957"></a><span id="l44.957">       case &quot;cmd_markAsRead&quot;:</span>
<a href="#l44.958"></a><span id="l44.958">       case &quot;cmd_markAllRead&quot;:</span>
<a href="#l44.959"></a><span id="l44.959">       case &quot;cmd_markThreadAsRead&quot;:</span>
<a href="#l44.960"></a><span id="l44.960">       case &quot;cmd_markReadByDate&quot;:</span>
<a href="#l44.961"></a><span id="l44.961">       case &quot;cmd_markAsFlagged&quot;:</span>
<a href="#l44.962"></a><span id="l44.962" class="difflineminus">-      case &quot;button_file&quot;:</span>
<a href="#l44.963"></a><span id="l44.963" class="difflineminus">-      case &quot;cmd_file&quot;:</span>
<a href="#l44.964"></a><span id="l44.964">       case &quot;cmd_markAsJunk&quot;:</span>
<a href="#l44.965"></a><span id="l44.965">       case &quot;cmd_markAsNotJunk&quot;:</span>
<a href="#l44.966"></a><span id="l44.966">       case &quot;cmd_recalculateJunkScore&quot;:</span>
<a href="#l44.967"></a><span id="l44.967">       case &quot;cmd_applyFiltersToSelection&quot;:</span>
<a href="#l44.968"></a><span id="l44.968">       case &quot;cmd_applyFilters&quot;:</span>
<a href="#l44.969"></a><span id="l44.969">       case &quot;cmd_runJunkControls&quot;:</span>
<a href="#l44.970"></a><span id="l44.970">       case &quot;cmd_deleteJunk&quot;:</span>
<a href="#l44.971"></a><span id="l44.971" class="difflineplus">+        return !gMessageDisplay.isDummy;</span>
<a href="#l44.972"></a><span id="l44.972" class="difflineplus">+      case &quot;cmd_undo&quot;:</span>
<a href="#l44.973"></a><span id="l44.973" class="difflineplus">+      case &quot;cmd_redo&quot;:</span>
<a href="#l44.974"></a><span id="l44.974" class="difflineplus">+      case &quot;cmd_saveAsFile&quot;:</span>
<a href="#l44.975"></a><span id="l44.975" class="difflineplus">+      case &quot;cmd_saveAsTemplate&quot;:</span>
<a href="#l44.976"></a><span id="l44.976" class="difflineplus">+      case &quot;cmd_viewPageSource&quot;:</span>
<a href="#l44.977"></a><span id="l44.977" class="difflineplus">+      case &quot;cmd_getMsgsForAuthAccounts&quot;:</span>
<a href="#l44.978"></a><span id="l44.978" class="difflineplus">+      case &quot;button_file&quot;:</span>
<a href="#l44.979"></a><span id="l44.979" class="difflineplus">+      case &quot;cmd_file&quot;:</span>
<a href="#l44.980"></a><span id="l44.980">       case &quot;cmd_nextMsg&quot;:</span>
<a href="#l44.981"></a><span id="l44.981">       case &quot;button_next&quot;:</span>
<a href="#l44.982"></a><span id="l44.982">       case &quot;button_previous&quot;:</span>
<a href="#l44.983"></a><span id="l44.983">       case &quot;cmd_nextUnreadMsg&quot;:</span>
<a href="#l44.984"></a><span id="l44.984">       case &quot;cmd_nextFlaggedMsg&quot;:</span>
<a href="#l44.985"></a><span id="l44.985">       case &quot;cmd_nextUnreadThread&quot;:</span>
<a href="#l44.986"></a><span id="l44.986">       case &quot;cmd_previousMsg&quot;:</span>
<a href="#l44.987"></a><span id="l44.987">       case &quot;cmd_previousUnreadMsg&quot;:</span>
<a href="#l44.988"></a><span id="l44.988">       case &quot;cmd_previousFlaggedMsg&quot;:</span>
<a href="#l44.989"></a><span id="l44.989">       case &quot;cmd_goForward&quot;:</span>
<a href="#l44.990"></a><span id="l44.990">       case &quot;cmd_goBack&quot;:</span>
<a href="#l44.991"></a><span id="l44.991">       case &quot;button_goForward&quot;:</span>
<a href="#l44.992"></a><span id="l44.992">       case &quot;button_goBack&quot;:</span>
<a href="#l44.993"></a><span id="l44.993" class="difflineminus">-        return !(gDBView.keyForFirstSelectedMessage == nsMsgKey_None);</span>
<a href="#l44.994"></a><span id="l44.994" class="difflineplus">+        return gFolderDisplay.selectedMessage != null;</span>
<a href="#l44.995"></a><span id="l44.995"> </span>
<a href="#l44.996"></a><span id="l44.996">       case &quot;cmd_reply&quot;:</span>
<a href="#l44.997"></a><span id="l44.997">       case &quot;button_reply&quot;:</span>
<a href="#l44.998"></a><span id="l44.998">       case &quot;cmd_replySender&quot;:</span>
<a href="#l44.999"></a><span id="l44.999">       case &quot;cmd_replyGroup&quot;:</span>
<a href="#l44.1000"></a><span id="l44.1000">       case &quot;cmd_replyall&quot;:</span>
<a href="#l44.1001"></a><span id="l44.1001">       case &quot;button_replyall&quot;:</span>
<a href="#l44.1002"></a><span id="l44.1002">       case &quot;cmd_replylist&quot;:</span>
<a href="#l44.1003"></a><span id="l44.1003" class="difflineat">@@ -817,54 +633,60 @@ var MessageWindowController =</span>
<a href="#l44.1004"></a><span id="l44.1004">         return MailOfflineMgr.isOnline();</span>
<a href="#l44.1005"></a><span id="l44.1005">       default:</span>
<a href="#l44.1006"></a><span id="l44.1006">         return false;</span>
<a href="#l44.1007"></a><span id="l44.1007">     }</span>
<a href="#l44.1008"></a><span id="l44.1008">   },</span>
<a href="#l44.1009"></a><span id="l44.1009"> </span>
<a href="#l44.1010"></a><span id="l44.1010">   isCommandEnabled: function(command)</span>
<a href="#l44.1011"></a><span id="l44.1011">   {</span>
<a href="#l44.1012"></a><span id="l44.1012" class="difflineplus">+    let loadedFolder;</span>
<a href="#l44.1013"></a><span id="l44.1013">     switch ( command )</span>
<a href="#l44.1014"></a><span id="l44.1014">     {</span>
<a href="#l44.1015"></a><span id="l44.1015">       case &quot;cmd_createFilterFromPopup&quot;:</span>
<a href="#l44.1016"></a><span id="l44.1016">       case &quot;cmd_createFilterFromMenu&quot;:</span>
<a href="#l44.1017"></a><span id="l44.1017" class="difflineminus">-        var loadedFolder = GetLoadedMsgFolder();</span>
<a href="#l44.1018"></a><span id="l44.1018" class="difflineplus">+        loadedFolder = gFolderDisplay.displayedFolder;</span>
<a href="#l44.1019"></a><span id="l44.1019">         if (!(loadedFolder &amp;&amp; loadedFolder.server.canHaveFilters))</span>
<a href="#l44.1020"></a><span id="l44.1020">           return false;</span>
<a href="#l44.1021"></a><span id="l44.1021">       case &quot;cmd_delete&quot;:</span>
<a href="#l44.1022"></a><span id="l44.1022">         UpdateDeleteCommand();</span>
<a href="#l44.1023"></a><span id="l44.1023">         // fall through</span>
<a href="#l44.1024"></a><span id="l44.1024">       case &quot;button_delete&quot;:</span>
<a href="#l44.1025"></a><span id="l44.1025">         UpdateDeleteToolbarButton();</span>
<a href="#l44.1026"></a><span id="l44.1026">         // fall through</span>
<a href="#l44.1027"></a><span id="l44.1027">       case &quot;cmd_shiftDelete&quot;:</span>
<a href="#l44.1028"></a><span id="l44.1028" class="difflineminus">-        var loadedFolder = GetLoadedMsgFolder();</span>
<a href="#l44.1029"></a><span id="l44.1029" class="difflineminus">-        return gCurrentMessageUri &amp;&amp; loadedFolder &amp;&amp; (loadedFolder.canDeleteMessages || isNewsURI(gCurrentFolderUri));</span>
<a href="#l44.1030"></a><span id="l44.1030" class="difflineplus">+        return gFolderDisplay.selectedMessage &amp;&amp;</span>
<a href="#l44.1031"></a><span id="l44.1031" class="difflineplus">+               gFolderDisplay.displayedFolder &amp;&amp;</span>
<a href="#l44.1032"></a><span id="l44.1032" class="difflineplus">+               (gFolderDisplay.displayedFolder.canDeleteMessages ||</span>
<a href="#l44.1033"></a><span id="l44.1033" class="difflineplus">+                gFolderDisplay.view.isNewsFolder);</span>
<a href="#l44.1034"></a><span id="l44.1034">       case &quot;button_junk&quot;:</span>
<a href="#l44.1035"></a><span id="l44.1035">         UpdateJunkToolbarButton();</span>
<a href="#l44.1036"></a><span id="l44.1036">         // fall through</span>
<a href="#l44.1037"></a><span id="l44.1037">       case &quot;cmd_markAsJunk&quot;:</span>
<a href="#l44.1038"></a><span id="l44.1038">       case &quot;cmd_markAsNotJunk&quot;:</span>
<a href="#l44.1039"></a><span id="l44.1039">       case &quot;cmd_recalculateJunkScore&quot;:</span>
<a href="#l44.1040"></a><span id="l44.1040">         // can't do junk on news yet</span>
<a href="#l44.1041"></a><span id="l44.1041" class="difflineminus">-        return (!isNewsURI(gCurrentFolderUri));</span>
<a href="#l44.1042"></a><span id="l44.1042" class="difflineplus">+        return (!gFolderDisplay.view.isNewsFolder);</span>
<a href="#l44.1043"></a><span id="l44.1043">       case &quot;button_archive&quot;:</span>
<a href="#l44.1044"></a><span id="l44.1044" class="difflineminus">-        var folder = GetLoadedMsgFolder();</span>
<a href="#l44.1045"></a><span id="l44.1045" class="difflineplus">+        var folder = gFolderDisplay.displayedFolder;</span>
<a href="#l44.1046"></a><span id="l44.1046">         return folder &amp;&amp;</span>
<a href="#l44.1047"></a><span id="l44.1047">           !(IsSpecialFolder(folder, Components.interfaces.nsMsgFolderFlags.Archive,</span>
<a href="#l44.1048"></a><span id="l44.1048">                             true));</span>
<a href="#l44.1049"></a><span id="l44.1049" class="difflineminus">-      case &quot;cmd_archive&quot;:</span>
<a href="#l44.1050"></a><span id="l44.1050">       case &quot;cmd_reply&quot;:</span>
<a href="#l44.1051"></a><span id="l44.1051">       case &quot;button_reply&quot;:</span>
<a href="#l44.1052"></a><span id="l44.1052" class="difflineplus">+        return gFolderDisplay.selectedMessage &amp;&amp; IsReplyEnabled();</span>
<a href="#l44.1053"></a><span id="l44.1053" class="difflineplus">+      case &quot;cmd_replyall&quot;:</span>
<a href="#l44.1054"></a><span id="l44.1054" class="difflineplus">+      case &quot;button_replyall&quot;:</span>
<a href="#l44.1055"></a><span id="l44.1055" class="difflineplus">+        return gFolderDisplay.selectedMessage &amp;&amp; IsReplyAllEnabled();</span>
<a href="#l44.1056"></a><span id="l44.1056" class="difflineplus">+      case &quot;cmd_replylist&quot;:</span>
<a href="#l44.1057"></a><span id="l44.1057" class="difflineplus">+      case &quot;button_replylist&quot;:</span>
<a href="#l44.1058"></a><span id="l44.1058" class="difflineplus">+        return gFolderDisplay.selectedMessage &amp;&amp; IsReplyListEnabled();</span>
<a href="#l44.1059"></a><span id="l44.1059" class="difflineplus">+      case &quot;cmd_archive&quot;:</span>
<a href="#l44.1060"></a><span id="l44.1060">       case &quot;cmd_replySender&quot;:</span>
<a href="#l44.1061"></a><span id="l44.1061">       case &quot;cmd_replyGroup&quot;:</span>
<a href="#l44.1062"></a><span id="l44.1062" class="difflineminus">-      case &quot;cmd_replyall&quot;:</span>
<a href="#l44.1063"></a><span id="l44.1063" class="difflineminus">-      case &quot;button_replyall&quot;:</span>
<a href="#l44.1064"></a><span id="l44.1064" class="difflineminus">-      case &quot;cmd_replylist&quot;:</span>
<a href="#l44.1065"></a><span id="l44.1065" class="difflineminus">-      case &quot;button_replylist&quot;:</span>
<a href="#l44.1066"></a><span id="l44.1066">       case &quot;cmd_forward&quot;:</span>
<a href="#l44.1067"></a><span id="l44.1067">       case &quot;button_forward&quot;:</span>
<a href="#l44.1068"></a><span id="l44.1068">       case &quot;cmd_forwardInline&quot;:</span>
<a href="#l44.1069"></a><span id="l44.1069">       case &quot;cmd_forwardAttachment&quot;:</span>
<a href="#l44.1070"></a><span id="l44.1070">       case &quot;cmd_editAsNew&quot;:</span>
<a href="#l44.1071"></a><span id="l44.1071">       case &quot;cmd_print&quot;:</span>
<a href="#l44.1072"></a><span id="l44.1072">       case &quot;cmd_printpreview&quot;:</span>
<a href="#l44.1073"></a><span id="l44.1073">       case &quot;button_print&quot;:</span>
<a href="#l44.1074"></a><span id="l44.1074" class="difflineat">@@ -878,17 +700,17 @@ var MessageWindowController =</span>
<a href="#l44.1075"></a><span id="l44.1075">       case &quot;cmd_markAsRead&quot;:</span>
<a href="#l44.1076"></a><span id="l44.1076">       case &quot;cmd_markAllRead&quot;:</span>
<a href="#l44.1077"></a><span id="l44.1077">       case &quot;cmd_markThreadAsRead&quot;:</span>
<a href="#l44.1078"></a><span id="l44.1078">       case &quot;cmd_markReadByDate&quot;:</span>
<a href="#l44.1079"></a><span id="l44.1079">         return(true);</span>
<a href="#l44.1080"></a><span id="l44.1080">       case &quot;cmd_markAsFlagged&quot;:</span>
<a href="#l44.1081"></a><span id="l44.1081">       case &quot;button_file&quot;:</span>
<a href="#l44.1082"></a><span id="l44.1082">       case &quot;cmd_file&quot;:</span>
<a href="#l44.1083"></a><span id="l44.1083" class="difflineminus">-        return ( gCurrentMessageUri != null);</span>
<a href="#l44.1084"></a><span id="l44.1084" class="difflineplus">+        return ( gFolderDisplay.selectedMessage != null);</span>
<a href="#l44.1085"></a><span id="l44.1085">       case &quot;cmd_printSetup&quot;:</span>
<a href="#l44.1086"></a><span id="l44.1086">         return true;</span>
<a href="#l44.1087"></a><span id="l44.1087">       case &quot;cmd_getNewMessages&quot;:</span>
<a href="#l44.1088"></a><span id="l44.1088">       case &quot;button_getNewMessages&quot;:</span>
<a href="#l44.1089"></a><span id="l44.1089">       case &quot;cmd_getMsgsForAuthAccounts&quot;:</span>
<a href="#l44.1090"></a><span id="l44.1090">         // GetMsgs should always be enabled, see bugs 89404 and 111102.</span>
<a href="#l44.1091"></a><span id="l44.1091">         return true;</span>
<a href="#l44.1092"></a><span id="l44.1092">       case &quot;cmd_getNextNMessages&quot;:</span>
<a href="#l44.1093"></a><span id="l44.1093" class="difflineat">@@ -917,30 +739,29 @@ var MessageWindowController =</span>
<a href="#l44.1094"></a><span id="l44.1094">       case &quot;cmd_fullZoomEnlarge&quot;:</span>
<a href="#l44.1095"></a><span id="l44.1095">       case &quot;cmd_fullZoomReset&quot;:</span>
<a href="#l44.1096"></a><span id="l44.1096">       case &quot;cmd_fullZoomToggle&quot;:</span>
<a href="#l44.1097"></a><span id="l44.1097">         return true;</span>
<a href="#l44.1098"></a><span id="l44.1098">       case &quot;button_goForward&quot;:</span>
<a href="#l44.1099"></a><span id="l44.1099">       case &quot;button_goBack&quot;:</span>
<a href="#l44.1100"></a><span id="l44.1100">       case &quot;cmd_goForward&quot;:</span>
<a href="#l44.1101"></a><span id="l44.1101">       case &quot;cmd_goBack&quot;:</span>
<a href="#l44.1102"></a><span id="l44.1102" class="difflineminus">-        return gDBView &amp;&amp;</span>
<a href="#l44.1103"></a><span id="l44.1103" class="difflineminus">-            gDBView.navigateStatus((command == &quot;cmd_goBack&quot; ||</span>
<a href="#l44.1104"></a><span id="l44.1104" class="difflineminus">-                                    command == &quot;button_goBack&quot;)</span>
<a href="#l44.1105"></a><span id="l44.1105" class="difflineminus">-                                    ? nsMsgNavigationType.back : nsMsgNavigationType.forward);</span>
<a href="#l44.1106"></a><span id="l44.1106" class="difflineplus">+        return gFolderDisplay.navigateStatus(</span>
<a href="#l44.1107"></a><span id="l44.1107" class="difflineplus">+          (command == &quot;cmd_goBack&quot; || command == &quot;button_goBack&quot;) ?</span>
<a href="#l44.1108"></a><span id="l44.1108" class="difflineplus">+            nsMsgNavigationType.back : nsMsgNavigationType.forward);</span>
<a href="#l44.1109"></a><span id="l44.1109">       case &quot;cmd_search&quot;:</span>
<a href="#l44.1110"></a><span id="l44.1110" class="difflineminus">-        var loadedFolder = GetLoadedMsgFolder();</span>
<a href="#l44.1111"></a><span id="l44.1111" class="difflineplus">+        loadedFolder = gFolderDisplay.displayedFolder;</span>
<a href="#l44.1112"></a><span id="l44.1112">         if (!loadedFolder)</span>
<a href="#l44.1113"></a><span id="l44.1113">           return false;</span>
<a href="#l44.1114"></a><span id="l44.1114">         return loadedFolder.server.canSearchMessages;</span>
<a href="#l44.1115"></a><span id="l44.1115">       case &quot;cmd_undo&quot;:</span>
<a href="#l44.1116"></a><span id="l44.1116">       case &quot;cmd_redo&quot;:</span>
<a href="#l44.1117"></a><span id="l44.1117">         return SetupUndoRedoCommand(command);</span>
<a href="#l44.1118"></a><span id="l44.1118">       case &quot;cmd_moveToFolderAgain&quot;:</span>
<a href="#l44.1119"></a><span id="l44.1119" class="difflineminus">-        var loadedFolder = GetLoadedMsgFolder();</span>
<a href="#l44.1120"></a><span id="l44.1120" class="difflineplus">+        loadedFolder = gFolderDisplay.displayedFolder;</span>
<a href="#l44.1121"></a><span id="l44.1121">         if (!loadedFolder || (pref.getBoolPref(&quot;mail.last_msg_movecopy_was_move&quot;) &amp;&amp;</span>
<a href="#l44.1122"></a><span id="l44.1122">             !loadedFolder.canDeleteMessages))</span>
<a href="#l44.1123"></a><span id="l44.1123">           return false;</span>
<a href="#l44.1124"></a><span id="l44.1124">         return pref.getCharPref(&quot;mail.last_msg_movecopy_target_uri&quot;);</span>
<a href="#l44.1125"></a><span id="l44.1125">       case &quot;cmd_applyFilters&quot;:</span>
<a href="#l44.1126"></a><span id="l44.1126">       case &quot;cmd_runJunkControls&quot;:</span>
<a href="#l44.1127"></a><span id="l44.1127">       case &quot;cmd_deleteJunk&quot;:</span>
<a href="#l44.1128"></a><span id="l44.1128">         return false;</span>
<a href="#l44.1129"></a><span id="l44.1129" class="difflineat">@@ -1039,17 +860,17 @@ var MessageWindowController =</span>
<a href="#l44.1130"></a><span id="l44.1130">         break;</span>
<a href="#l44.1131"></a><span id="l44.1131">       case &quot;cmd_saveAsFile&quot;:</span>
<a href="#l44.1132"></a><span id="l44.1132">         MsgSaveAsFile();</span>
<a href="#l44.1133"></a><span id="l44.1133">         break;</span>
<a href="#l44.1134"></a><span id="l44.1134">       case &quot;cmd_saveAsTemplate&quot;:</span>
<a href="#l44.1135"></a><span id="l44.1135">         MsgSaveAsTemplate();</span>
<a href="#l44.1136"></a><span id="l44.1136">         break;</span>
<a href="#l44.1137"></a><span id="l44.1137">       case &quot;cmd_viewPageSource&quot;:</span>
<a href="#l44.1138"></a><span id="l44.1138" class="difflineminus">-        ViewPageSource(GetSelectedMessages());</span>
<a href="#l44.1139"></a><span id="l44.1139" class="difflineplus">+        ViewPageSource(gFolderDisplay.selectedMessageUris);</span>
<a href="#l44.1140"></a><span id="l44.1140">         break;</span>
<a href="#l44.1141"></a><span id="l44.1141">       case &quot;cmd_reload&quot;:</span>
<a href="#l44.1142"></a><span id="l44.1142">         ReloadMessage();</span>
<a href="#l44.1143"></a><span id="l44.1143">         break;</span>
<a href="#l44.1144"></a><span id="l44.1144">       case &quot;cmd_find&quot;:</span>
<a href="#l44.1145"></a><span id="l44.1145">         document.getElementById(&quot;FindToolbar&quot;).onFindCommand();</span>
<a href="#l44.1146"></a><span id="l44.1146">         break;</span>
<a href="#l44.1147"></a><span id="l44.1147">       case &quot;cmd_findAgain&quot;:</span>
<a href="#l44.1148"></a><span id="l44.1148" class="difflineat">@@ -1062,17 +883,17 @@ var MessageWindowController =</span>
<a href="#l44.1149"></a><span id="l44.1149">         MsgSearchMessages();</span>
<a href="#l44.1150"></a><span id="l44.1150">         break;</span>
<a href="#l44.1151"></a><span id="l44.1151">       case &quot;button_mark&quot;:</span>
<a href="#l44.1152"></a><span id="l44.1152">       case &quot;cmd_markAsRead&quot;:</span>
<a href="#l44.1153"></a><span id="l44.1153">         MsgMarkMsgAsRead();</span>
<a href="#l44.1154"></a><span id="l44.1154">         return;</span>
<a href="#l44.1155"></a><span id="l44.1155">       case &quot;cmd_markThreadAsRead&quot;:</span>
<a href="#l44.1156"></a><span id="l44.1156">         ClearPendingReadTimer();</span>
<a href="#l44.1157"></a><span id="l44.1157" class="difflineminus">-        gDBView.doCommand(nsMsgViewCommandType.markThreadRead);</span>
<a href="#l44.1158"></a><span id="l44.1158" class="difflineplus">+        gFolderDisplay.doCommand(nsMsgViewCommandType.markThreadRead);</span>
<a href="#l44.1159"></a><span id="l44.1159">         return;</span>
<a href="#l44.1160"></a><span id="l44.1160">       case &quot;cmd_markAllRead&quot;:</span>
<a href="#l44.1161"></a><span id="l44.1161">         MsgMarkAllRead();</span>
<a href="#l44.1162"></a><span id="l44.1162">         return;</span>
<a href="#l44.1163"></a><span id="l44.1163">       case &quot;cmd_markReadByDate&quot;:</span>
<a href="#l44.1164"></a><span id="l44.1164">         MsgMarkReadByDate();</span>
<a href="#l44.1165"></a><span id="l44.1165">         return;</span>
<a href="#l44.1166"></a><span id="l44.1166">       case &quot;cmd_markAsFlagged&quot;:</span>
<a href="#l44.1167"></a><span id="l44.1167" class="difflineat">@@ -1083,20 +904,22 @@ var MessageWindowController =</span>
<a href="#l44.1168"></a><span id="l44.1168">         return;</span>
<a href="#l44.1169"></a><span id="l44.1169">       case &quot;cmd_markAsNotJunk&quot;:</span>
<a href="#l44.1170"></a><span id="l44.1170">         JunkSelectedMessages(false);</span>
<a href="#l44.1171"></a><span id="l44.1171">         return;</span>
<a href="#l44.1172"></a><span id="l44.1172">       case &quot;cmd_recalculateJunkScore&quot;:</span>
<a href="#l44.1173"></a><span id="l44.1173">         analyzeMessagesForJunk();</span>
<a href="#l44.1174"></a><span id="l44.1174">         return;</span>
<a href="#l44.1175"></a><span id="l44.1175">       case &quot;cmd_downloadFlagged&quot;:</span>
<a href="#l44.1176"></a><span id="l44.1176" class="difflineminus">-        gDBView.doCommand(nsMsgViewCommandType.downloadFlaggedForOffline);</span>
<a href="#l44.1177"></a><span id="l44.1177" class="difflineplus">+        gFolderDisplay.doCommand(</span>
<a href="#l44.1178"></a><span id="l44.1178" class="difflineplus">+          nsMsgViewCommandType.downloadFlaggedForOffline);</span>
<a href="#l44.1179"></a><span id="l44.1179">         return;</span>
<a href="#l44.1180"></a><span id="l44.1180">       case &quot;cmd_downloadSelected&quot;:</span>
<a href="#l44.1181"></a><span id="l44.1181" class="difflineminus">-        gDBView.doCommand(nsMsgViewCommandType.downloadSelectedForOffline);</span>
<a href="#l44.1182"></a><span id="l44.1182" class="difflineplus">+        gFolderDisplay.doCommand(</span>
<a href="#l44.1183"></a><span id="l44.1183" class="difflineplus">+          nsMsgViewCommandType.downloadSelectedForOffline);</span>
<a href="#l44.1184"></a><span id="l44.1184">         return;</span>
<a href="#l44.1185"></a><span id="l44.1185">       case &quot;cmd_synchronizeOffline&quot;:</span>
<a href="#l44.1186"></a><span id="l44.1186">         MsgSynchronizeOffline();</span>
<a href="#l44.1187"></a><span id="l44.1187">         return;</span>
<a href="#l44.1188"></a><span id="l44.1188">       case &quot;cmd_settingsOffline&quot;:</span>
<a href="#l44.1189"></a><span id="l44.1189">         MailOfflineMgr.openOfflineAccountSettings();</span>
<a href="#l44.1190"></a><span id="l44.1190">         return;</span>
<a href="#l44.1191"></a><span id="l44.1191">       case &quot;cmd_nextUnreadMsg&quot;:</span>
<a href="#l44.1192"></a><span id="l44.1192" class="difflineat">@@ -1146,91 +969,36 @@ var MessageWindowController =</span>
<a href="#l44.1193"></a><span id="l44.1193">       }</span>
<a href="#l44.1194"></a><span id="l44.1194">   },</span>
<a href="#l44.1195"></a><span id="l44.1195"> </span>
<a href="#l44.1196"></a><span id="l44.1196">   onEvent: function(event)</span>
<a href="#l44.1197"></a><span id="l44.1197">   {</span>
<a href="#l44.1198"></a><span id="l44.1198">   }</span>
<a href="#l44.1199"></a><span id="l44.1199"> };</span>
<a href="#l44.1200"></a><span id="l44.1200"> </span>
<a href="#l44.1201"></a><span id="l44.1201" class="difflineminus">-function LoadMessageByNavigationType(type)</span>
<a href="#l44.1202"></a><span id="l44.1202" class="difflineminus">-{</span>
<a href="#l44.1203"></a><span id="l44.1203" class="difflineminus">-  var resultId = new Object;</span>
<a href="#l44.1204"></a><span id="l44.1204" class="difflineminus">-  var resultIndex = new Object;</span>
<a href="#l44.1205"></a><span id="l44.1205" class="difflineminus">-  var threadIndex = new Object;</span>
<a href="#l44.1206"></a><span id="l44.1206" class="difflineminus">-</span>
<a href="#l44.1207"></a><span id="l44.1207" class="difflineminus">-  gDBView.viewNavigate(type, resultId, resultIndex, threadIndex, true /* wrap */);</span>
<a href="#l44.1208"></a><span id="l44.1208" class="difflineminus">-</span>
<a href="#l44.1209"></a><span id="l44.1209" class="difflineminus">-  // if we found something....display it.</span>
<a href="#l44.1210"></a><span id="l44.1210" class="difflineminus">-  if ((resultId.value != nsMsgKey_None) &amp;&amp; (resultIndex.value != nsMsgKey_None))</span>
<a href="#l44.1211"></a><span id="l44.1211" class="difflineminus">-  {</span>
<a href="#l44.1212"></a><span id="l44.1212" class="difflineminus">-    // load the message key</span>
<a href="#l44.1213"></a><span id="l44.1213" class="difflineminus">-    LoadMessageByMsgKey(resultId.value);</span>
<a href="#l44.1214"></a><span id="l44.1214" class="difflineminus">-    // if we changed folders, the message counts changed.</span>
<a href="#l44.1215"></a><span id="l44.1215" class="difflineminus">-    UpdateStandAloneMessageCounts();</span>
<a href="#l44.1216"></a><span id="l44.1216" class="difflineminus">-</span>
<a href="#l44.1217"></a><span id="l44.1217" class="difflineminus">-    // new message has been loaded</span>
<a href="#l44.1218"></a><span id="l44.1218" class="difflineminus">-    return true;</span>
<a href="#l44.1219"></a><span id="l44.1219" class="difflineminus">-  }</span>
<a href="#l44.1220"></a><span id="l44.1220" class="difflineminus">-</span>
<a href="#l44.1221"></a><span id="l44.1221" class="difflineminus">-  // no message found to load</span>
<a href="#l44.1222"></a><span id="l44.1222" class="difflineminus">-  return false;</span>
<a href="#l44.1223"></a><span id="l44.1223" class="difflineminus">-}</span>
<a href="#l44.1224"></a><span id="l44.1224" class="difflineminus">-</span>
<a href="#l44.1225"></a><span id="l44.1225"> function performNavigation(type)</span>
<a href="#l44.1226"></a><span id="l44.1226"> {</span>
<a href="#l44.1227"></a><span id="l44.1227">   // Try to load a message by navigation type if we can find</span>
<a href="#l44.1228"></a><span id="l44.1228">   // the message in the same folder.</span>
<a href="#l44.1229"></a><span id="l44.1229" class="difflineminus">-  if (LoadMessageByNavigationType(type))</span>
<a href="#l44.1230"></a><span id="l44.1230" class="difflineplus">+  if (gFolderDisplay.navigate(type))</span>
<a href="#l44.1231"></a><span id="l44.1231">     return;</span>
<a href="#l44.1232"></a><span id="l44.1232"> </span>
<a href="#l44.1233"></a><span id="l44.1233">   CrossFolderNavigation(type);</span>
<a href="#l44.1234"></a><span id="l44.1234"> }</span>
<a href="#l44.1235"></a><span id="l44.1235"> </span>
<a href="#l44.1236"></a><span id="l44.1236"> function SetupCommandUpdateHandlers()</span>
<a href="#l44.1237"></a><span id="l44.1237"> {</span>
<a href="#l44.1238"></a><span id="l44.1238">   top.controllers.insertControllerAt(0, MessageWindowController);</span>
<a href="#l44.1239"></a><span id="l44.1239"> }</span>
<a href="#l44.1240"></a><span id="l44.1240"> </span>
<a href="#l44.1241"></a><span id="l44.1241"> function UnloadCommandUpdateHandlers()</span>
<a href="#l44.1242"></a><span id="l44.1242"> {</span>
<a href="#l44.1243"></a><span id="l44.1243">   top.controllers.removeController(MessageWindowController);</span>
<a href="#l44.1244"></a><span id="l44.1244"> }</span>
<a href="#l44.1245"></a><span id="l44.1245"> </span>
<a href="#l44.1246"></a><span id="l44.1246" class="difflineminus">-function GetDBView()</span>
<a href="#l44.1247"></a><span id="l44.1247" class="difflineminus">-{</span>
<a href="#l44.1248"></a><span id="l44.1248" class="difflineminus">-  return gDBView;</span>
<a href="#l44.1249"></a><span id="l44.1249" class="difflineminus">-}</span>
<a href="#l44.1250"></a><span id="l44.1250" class="difflineminus">-</span>
<a href="#l44.1251"></a><span id="l44.1251" class="difflineminus">-function LoadMessageByMsgKey(messageKey)</span>
<a href="#l44.1252"></a><span id="l44.1252" class="difflineminus">-{</span>
<a href="#l44.1253"></a><span id="l44.1253" class="difflineminus">-  LoadMessageByViewIndex(gDBView.findIndexFromKey(messageKey, true));</span>
<a href="#l44.1254"></a><span id="l44.1254" class="difflineminus">-}</span>
<a href="#l44.1255"></a><span id="l44.1255" class="difflineminus">-</span>
<a href="#l44.1256"></a><span id="l44.1256" class="difflineminus">-function LoadMessageByViewIndex(viewIndex)</span>
<a href="#l44.1257"></a><span id="l44.1257" class="difflineminus">-{</span>
<a href="#l44.1258"></a><span id="l44.1258" class="difflineminus">-  gDBView.loadMessageByViewIndex(viewIndex);</span>
<a href="#l44.1259"></a><span id="l44.1259" class="difflineminus">-  // we only want to update the toolbar if there was no previous selected message.</span>
<a href="#l44.1260"></a><span id="l44.1260" class="difflineminus">-  if (nsMsgKey_None == gDBView.keyForFirstSelectedMessage)</span>
<a href="#l44.1261"></a><span id="l44.1261" class="difflineminus">-    UpdateMailToolbar(&quot;update toolbar for message Window&quot;);</span>
<a href="#l44.1262"></a><span id="l44.1262" class="difflineminus">-}</span>
<a href="#l44.1263"></a><span id="l44.1263" class="difflineminus">-</span>
<a href="#l44.1264"></a><span id="l44.1264" class="difflineminus">-function LoadNavigatedToMessage(msgHdr, folder, folderUri)</span>
<a href="#l44.1265"></a><span id="l44.1265" class="difflineminus">-{</span>
<a href="#l44.1266"></a><span id="l44.1266" class="difflineminus">-  if (IsCurrentLoadedFolder(folder))</span>
<a href="#l44.1267"></a><span id="l44.1267" class="difflineminus">-  {</span>
<a href="#l44.1268"></a><span id="l44.1268" class="difflineminus">-    LoadMessageByMsgKey(msgHdr.messageKey);</span>
<a href="#l44.1269"></a><span id="l44.1269" class="difflineminus">-  }</span>
<a href="#l44.1270"></a><span id="l44.1270" class="difflineminus">-  else</span>
<a href="#l44.1271"></a><span id="l44.1271" class="difflineminus">-  {</span>
<a href="#l44.1272"></a><span id="l44.1272" class="difflineminus">-    gMessageToLoad = msgHdr.messageKey;</span>
<a href="#l44.1273"></a><span id="l44.1273" class="difflineminus">-    SelectFolder(folderUri);</span>
<a href="#l44.1274"></a><span id="l44.1274" class="difflineminus">-  }</span>
<a href="#l44.1275"></a><span id="l44.1275" class="difflineminus">-}</span>
<a href="#l44.1276"></a><span id="l44.1276" class="difflineminus">-</span>
<a href="#l44.1277"></a><span id="l44.1277"> function getMailToolbox ()</span>
<a href="#l44.1278"></a><span id="l44.1278"> {</span>
<a href="#l44.1279"></a><span id="l44.1279">   return document.getElementById(&quot;mail-toolbox&quot;);</span>
<a href="#l44.1280"></a><span id="l44.1280"> }</span>
<a href="#l44.1281"></a><span id="l44.1281"> </span>
<a href="#l44.1282"></a><span id="l44.1282"> function RestoreFocusAfterHdrButton()</span>
<a href="#l44.1283"></a><span id="l44.1283"> {</span>
<a href="#l44.1284"></a><span id="l44.1284">   // set focus to the message pane</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l45.1"></a><span id="l45.1" class="difflineminus">--- a/mail/base/content/messageWindow.xul</span>
<a href="#l45.2"></a><span id="l45.2" class="difflineplus">+++ b/mail/base/content/messageWindow.xul</span>
<a href="#l45.3"></a><span id="l45.3" class="difflineat">@@ -53,16 +53,19 @@</span>
<a href="#l45.4"></a><span id="l45.4"> &lt;!ENTITY % customizeToolbarDTD SYSTEM &quot;chrome://global/locale/customizeToolbar.dtd&quot;&gt;</span>
<a href="#l45.5"></a><span id="l45.5"> %customizeToolbarDTD;</span>
<a href="#l45.6"></a><span id="l45.6"> #ifdef MOZILLA_1_9_1_BRANCH</span>
<a href="#l45.7"></a><span id="l45.7"> &lt;!ENTITY % globalDTD SYSTEM &quot;chrome://global/locale/global.dtd&quot;&gt;</span>
<a href="#l45.8"></a><span id="l45.8"> %globalDTD;</span>
<a href="#l45.9"></a><span id="l45.9"> #endif</span>
<a href="#l45.10"></a><span id="l45.10"> ]&gt;</span>
<a href="#l45.11"></a><span id="l45.11"> </span>
<a href="#l45.12"></a><span id="l45.12" class="difflineplus">+&lt;!--</span>
<a href="#l45.13"></a><span id="l45.13" class="difflineplus">+  - This window displays a single message.</span>
<a href="#l45.14"></a><span id="l45.14" class="difflineplus">+  --&gt;</span>
<a href="#l45.15"></a><span id="l45.15"> &lt;window id=&quot;messengerWindow&quot;</span>
<a href="#l45.16"></a><span id="l45.16">         xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;</span>
<a href="#l45.17"></a><span id="l45.17">         title=&quot;&amp;titledefault.label;&quot;</span>
<a href="#l45.18"></a><span id="l45.18">         titlemodifier=&quot;&amp;titledefault.label;&quot;</span>
<a href="#l45.19"></a><span id="l45.19">         titlemenuseparator=&quot;&amp;titleSeparator.label;&quot;</span>
<a href="#l45.20"></a><span id="l45.20">         onload=&quot;OnLoadMessageWindow()&quot;</span>
<a href="#l45.21"></a><span id="l45.21">         onunload=&quot;OnUnloadMessageWindow()&quot;</span>
<a href="#l45.22"></a><span id="l45.22">         width=&quot;750&quot;</span>
<a href="#l45.23"></a><span id="l45.23" class="difflineat">@@ -73,16 +76,18 @@</span>
<a href="#l45.24"></a><span id="l45.24">   &lt;stringbundleset id=&quot;stringbundleset&quot;&gt;</span>
<a href="#l45.25"></a><span id="l45.25">     &lt;stringbundle id=&quot;bundle_brand&quot; src=&quot;chrome://branding/locale/brand.properties&quot;/&gt;</span>
<a href="#l45.26"></a><span id="l45.26">     &lt;stringbundle id=&quot;bundle_offlinePrompts&quot; src=&quot;chrome://messenger/locale/offline.properties&quot;/&gt;</span>
<a href="#l45.27"></a><span id="l45.27">   &lt;/stringbundleset&gt;</span>
<a href="#l45.28"></a><span id="l45.28"> </span>
<a href="#l45.29"></a><span id="l45.29">   &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://global/content/globalOverlay.js&quot;/&gt;</span>
<a href="#l45.30"></a><span id="l45.30">   &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://messenger/content/shareglue.js&quot;/&gt;</span>
<a href="#l45.31"></a><span id="l45.31">   &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://messenger/content/commandglue.js&quot;/&gt;</span>
<a href="#l45.32"></a><span id="l45.32" class="difflineplus">+  &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://messenger/content/folderDisplay.js&quot;/&gt;</span>
<a href="#l45.33"></a><span id="l45.33" class="difflineplus">+  &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://messenger/content/messageDisplay.js&quot;/&gt;</span>
<a href="#l45.34"></a><span id="l45.34">   &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://messenger/content/mailWindow.js&quot;/&gt;</span>
<a href="#l45.35"></a><span id="l45.35">   &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://messenger/content/messageWindow.js&quot;/&gt;</span>
<a href="#l45.36"></a><span id="l45.36">   &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://messenger/content/accountUtils.js&quot;/&gt;</span>
<a href="#l45.37"></a><span id="l45.37">   &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://global/content/contentAreaUtils.js&quot;/&gt;</span>
<a href="#l45.38"></a><span id="l45.38">   &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://communicator/content/nsContextMenu.js&quot;/&gt;</span>
<a href="#l45.39"></a><span id="l45.39">   &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://messenger/content/mailContextMenus.js&quot;/&gt;</span>
<a href="#l45.40"></a><span id="l45.40">   &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://messenger/content/phishingDetector.js&quot;/&gt;</span>
<a href="#l45.41"></a><span id="l45.41">   &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://communicator/content/contentAreaClick.js&quot;/&gt;</span>
<a href="#l45.42"></a><span id="l45.42" class="difflineat">@@ -172,22 +177,16 @@</span>
<a href="#l45.43"></a><span id="l45.43">     &lt;deck id=&quot;msgNotificationBar&quot;/&gt;</span>
<a href="#l45.44"></a><span id="l45.44"> </span>
<a href="#l45.45"></a><span id="l45.45">     &lt;!-- message view --&gt;</span>
<a href="#l45.46"></a><span id="l45.46">     &lt;browser id=&quot;messagepane&quot; context=&quot;mailContext&quot; tooltip=&quot;aHTMLTooltip&quot;</span>
<a href="#l45.47"></a><span id="l45.47">              style=&quot;height: 0px; min-height: 1px&quot; flex=&quot;1&quot; name=&quot;messagepane&quot;</span>
<a href="#l45.48"></a><span id="l45.48">              disablesecurity=&quot;true&quot; disablehistory=&quot;true&quot; type=&quot;content-primary&quot;</span>
<a href="#l45.49"></a><span id="l45.49">              onresize=&quot;return messagePaneOnResize(event);&quot; autofind=&quot;false&quot;</span>
<a href="#l45.50"></a><span id="l45.50">              src=&quot;about:blank&quot; onclick=&quot;return contentAreaClick(event);&quot; /&gt;</span>
<a href="#l45.51"></a><span id="l45.51" class="difflineminus">-    &lt;iframe id=&quot;htmlpane&quot;</span>
<a href="#l45.52"></a><span id="l45.52" class="difflineminus">-             style=&quot;height: 0px; min-height: 1px&quot; flex=&quot;1&quot; name=&quot;htmlpane&quot;</span>
<a href="#l45.53"></a><span id="l45.53" class="difflineminus">-             hidden=&quot;true&quot;</span>
<a href="#l45.54"></a><span id="l45.54" class="difflineminus">-             disablesecurity=&quot;true&quot; disablehistory=&quot;true&quot;</span>
<a href="#l45.55"></a><span id="l45.55" class="difflineminus">-             onresize=&quot;return htmlPaneOnResize(event);&quot; autofind=&quot;false&quot;</span>
<a href="#l45.56"></a><span id="l45.56" class="difflineminus">-             src=&quot;about:blank&quot;/&gt;</span>
<a href="#l45.57"></a><span id="l45.57">     &lt;splitter id=&quot;attachment-splitter&quot; collapse=&quot;after&quot; resizebefore=&quot;closest&quot; resizeafter=&quot;closest&quot; collapsed=&quot;true&quot;/&gt;</span>
<a href="#l45.58"></a><span id="l45.58">     &lt;hbox id=&quot;attachmentView&quot;/&gt;</span>
<a href="#l45.59"></a><span id="l45.59">     &lt;findbar id=&quot;FindToolbar&quot; browserid=&quot;messagepane&quot;/&gt;</span>
<a href="#l45.60"></a><span id="l45.60">   &lt;/vbox&gt;</span>
<a href="#l45.61"></a><span id="l45.61">   &lt;panel id=&quot;customizeToolbarSheetPopup&quot; noautohide=&quot;true&quot;&gt;</span>
<a href="#l45.62"></a><span id="l45.62">     &lt;iframe id=&quot;customizeToolbarSheetIFrame&quot;</span>
<a href="#l45.63"></a><span id="l45.63">             style=&quot;&amp;dialog.style;&quot;</span>
<a href="#l45.64"></a><span id="l45.64"> #ifdef MOZILLA_1_9_1_BRANCH</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l46.1"></a><span id="l46.1" class="difflineminus">--- a/mail/base/content/messenger.xul</span>
<a href="#l46.2"></a><span id="l46.2" class="difflineplus">+++ b/mail/base/content/messenger.xul</span>
<a href="#l46.3"></a><span id="l46.3" class="difflineat">@@ -200,17 +200,17 @@</span>
<a href="#l46.4"></a><span id="l46.4">                                onclick=&quot;gFolderTreeView.cycleMode(false);&quot;/&gt;</span>
<a href="#l46.5"></a><span id="l46.5">                 &lt;toolbarbutton id=&quot;folderview-cycler-next&quot;</span>
<a href="#l46.6"></a><span id="l46.6">                                chromedir=&quot;&amp;locale.dir;&quot;</span>
<a href="#l46.7"></a><span id="l46.7">                                dir=&quot;next&quot;</span>
<a href="#l46.8"></a><span id="l46.8">                                class=&quot;folderview-cycler&quot;</span>
<a href="#l46.9"></a><span id="l46.9">                                onclick=&quot;gFolderTreeView.cycleMode(true);&quot;/&gt;</span>
<a href="#l46.10"></a><span id="l46.10">               &lt;/sidebarheader&gt;</span>
<a href="#l46.11"></a><span id="l46.11"> </span>
<a href="#l46.12"></a><span id="l46.12" class="difflineminus">-              &lt;tree id=&quot;folderTree&quot; class=&quot;plain focusring&quot; flex=&quot;1&quot;</span>
<a href="#l46.13"></a><span id="l46.13" class="difflineplus">+              &lt;tree id=&quot;folderTree&quot; class=&quot;plain&quot; flex=&quot;1&quot;</span>
<a href="#l46.14"></a><span id="l46.14">                     hidecolumnpicker=&quot;true&quot; persist=&quot;mode&quot; mode=&quot;all&quot;</span>
<a href="#l46.15"></a><span id="l46.15">                     keepcurrentinview=&quot;true&quot;</span>
<a href="#l46.16"></a><span id="l46.16">                     context=&quot;folderPaneContext&quot;</span>
<a href="#l46.17"></a><span id="l46.17">                     disableKeyNavigation=&quot;true&quot;</span>
<a href="#l46.18"></a><span id="l46.18">                     ondraggesture=&quot;gFolderTreeView._onDragStart(event);&quot;</span>
<a href="#l46.19"></a><span id="l46.19">                     ondragover=&quot;gFolderTreeView._onDragOver(event);&quot;</span>
<a href="#l46.20"></a><span id="l46.20">                     ondblclick=&quot;gFolderTreeView.onDoubleClick(event);&quot;</span>
<a href="#l46.21"></a><span id="l46.21">                     onselect=&quot;FolderPaneSelectionChange();&quot;&gt;</span>
<a href="#l46.22"></a><span id="l46.22" class="difflineat">@@ -237,29 +237,34 @@</span>
<a href="#l46.23"></a><span id="l46.23">                       minheight=&quot;100&quot; height=&quot;100&quot; persist=&quot;height&quot;</span>
<a href="#l46.24"></a><span id="l46.24">                       onselect=&quot;ObserveDisplayDeckChange(event)&quot;&gt;</span>
<a href="#l46.25"></a><span id="l46.25">                   &lt;!-- first panel in displayDeck is Account Central --&gt;</span>
<a href="#l46.26"></a><span id="l46.26">                   &lt;vbox id=&quot;accountCentralBox&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l46.27"></a><span id="l46.27">                     &lt;iframe name=&quot;accountCentralPane&quot; width=&quot;150&quot; flex=&quot;1&quot; src=&quot;about:blank&quot;/&gt;</span>
<a href="#l46.28"></a><span id="l46.28">                   &lt;/vbox&gt;</span>
<a href="#l46.29"></a><span id="l46.29">                   &lt;!-- second panel is the threadPane --&gt;</span>
<a href="#l46.30"></a><span id="l46.30">                   &lt;hbox id=&quot;threadPaneBox&quot;&gt;</span>
<a href="#l46.31"></a><span id="l46.31" class="difflineplus">+                   &lt;!-- The threadContentArea was specially created to be a place for</span>
<a href="#l46.32"></a><span id="l46.32" class="difflineplus">+                        things that want to be above/below the thread pane, regardless</span>
<a href="#l46.33"></a><span id="l46.33" class="difflineplus">+                        of where the message reader (&quot;messagepane&quot;) gets off to. --&gt;</span>
<a href="#l46.34"></a><span id="l46.34" class="difflineplus">+                   &lt;vbox id=&quot;threadContentArea&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l46.35"></a><span id="l46.35">                     &lt;tree id=&quot;threadTree&quot;</span>
<a href="#l46.36"></a><span id="l46.36">                           persist=&quot;lastfoldersent width&quot;</span>
<a href="#l46.37"></a><span id="l46.37">                           treelines=&quot;true&quot;</span>
<a href="#l46.38"></a><span id="l46.38">                           flex=&quot;2&quot;</span>
<a href="#l46.39"></a><span id="l46.39">                           enableColumnDrag=&quot;true&quot;</span>
<a href="#l46.40"></a><span id="l46.40">                           _selectDelay=&quot;250&quot;</span>
<a href="#l46.41"></a><span id="l46.41" class="difflineminus">-                          class=&quot;plain focusring&quot;</span>
<a href="#l46.42"></a><span id="l46.42" class="difflineplus">+                          class=&quot;plain&quot;</span>
<a href="#l46.43"></a><span id="l46.43">                           lastfoldersent=&quot;false&quot;</span>
<a href="#l46.44"></a><span id="l46.44">                           keepcurrentinview=&quot;true&quot;</span>
<a href="#l46.45"></a><span id="l46.45">                           disableKeyNavigation=&quot;true&quot;</span>
<a href="#l46.46"></a><span id="l46.46">                           context=&quot;mailContext&quot;</span>
<a href="#l46.47"></a><span id="l46.47">                           onkeypress=&quot;ThreadPaneKeyPress(event);&quot;</span>
<a href="#l46.48"></a><span id="l46.48" class="difflineminus">-                          onselect=&quot;ThreadPaneSelectionChanged();&quot;&gt;</span>
<a href="#l46.49"></a><span id="l46.49" class="difflineplus">+                          onselect=&quot;ThreadPaneSelectionChanged();&quot;</span>
<a href="#l46.50"></a><span id="l46.50" class="difflineplus">+                          &gt;</span>
<a href="#l46.51"></a><span id="l46.51">                       &lt;treecols id=&quot;threadCols&quot; pickertooltiptext=&quot;&amp;columnChooser.tooltip;&quot;&gt;</span>
<a href="#l46.52"></a><span id="l46.52">                         &lt;treecol id=&quot;threadCol&quot; persist=&quot;hidden ordinal&quot; fixed=&quot;true&quot; cycler=&quot;true&quot;</span>
<a href="#l46.53"></a><span id="l46.53">                                  class=&quot;treecol-image threadColumnHeader&quot; currentView=&quot;unthreaded&quot;</span>
<a href="#l46.54"></a><span id="l46.54">                                  label=&quot;&amp;threadColumn.label;&quot; tooltiptext=&quot;&amp;threadColumn.tooltip;&quot;/&gt;</span>
<a href="#l46.55"></a><span id="l46.55">                         &lt;splitter class=&quot;tree-splitter&quot;/&gt;</span>
<a href="#l46.56"></a><span id="l46.56">                         &lt;treecol id=&quot;attachmentCol&quot; persist=&quot;hidden ordinal&quot; fixed=&quot;true&quot;</span>
<a href="#l46.57"></a><span id="l46.57">                                  class=&quot;treecol-image attachmentColumnHeader&quot;</span>
<a href="#l46.58"></a><span id="l46.58">                                  label=&quot;&amp;attachmentColumn.label;&quot; tooltiptext=&quot;&amp;attachmentColumn.tooltip;&quot;/&gt;</span>
<a href="#l46.59"></a><span id="l46.59" class="difflineat">@@ -317,17 +322,18 @@</span>
<a href="#l46.60"></a><span id="l46.60">                         &lt;treecol id=&quot;locationCol&quot; persist=&quot;width&quot; flex=&quot;1&quot; hidden=&quot;true&quot; ignoreincolumnpicker=&quot;true&quot;</span>
<a href="#l46.61"></a><span id="l46.61">                                  label=&quot;&amp;locationColumn.label;&quot; tooltiptext=&quot;&amp;locationColumn.tooltip;&quot;/&gt;</span>
<a href="#l46.62"></a><span id="l46.62">                         &lt;splitter class=&quot;tree-splitter&quot;/&gt;</span>
<a href="#l46.63"></a><span id="l46.63">                         &lt;treecol id=&quot;idCol&quot; persist=&quot;hidden ordinal width&quot; flex=&quot;1&quot; hidden=&quot;true&quot;</span>
<a href="#l46.64"></a><span id="l46.64">                                  label=&quot;&amp;idColumn.label;&quot; tooltiptext=&quot;&amp;idColumn.tooltip;&quot;/&gt;</span>
<a href="#l46.65"></a><span id="l46.65">                       &lt;/treecols&gt;</span>
<a href="#l46.66"></a><span id="l46.66">                     &lt;treechildren ondraggesture=&quot;threadPaneOnDragStart(event);&quot;/&gt;</span>
<a href="#l46.67"></a><span id="l46.67">                   &lt;/tree&gt;</span>
<a href="#l46.68"></a><span id="l46.68" class="difflineminus">-                  &lt;/hbox&gt;</span>
<a href="#l46.69"></a><span id="l46.69" class="difflineplus">+                 &lt;/vbox&gt;</span>
<a href="#l46.70"></a><span id="l46.70" class="difflineplus">+                &lt;/hbox&gt;</span>
<a href="#l46.71"></a><span id="l46.71">                 &lt;!-- extensions may overlay in additional panels; don't assume that there are only 2! --&gt;</span>
<a href="#l46.72"></a><span id="l46.72">                 &lt;/deck&gt; &lt;!-- displayDeck --&gt;</span>
<a href="#l46.73"></a><span id="l46.73"> </span>
<a href="#l46.74"></a><span id="l46.74">                 &lt;!-- if you change this id, please change GetThreadAndMessagePaneSplitter() and MsgToggleMessagePane() --&gt;</span>
<a href="#l46.75"></a><span id="l46.75">                 &lt;splitter id=&quot;threadpane-splitter&quot; collapse=&quot;after&quot; persist=&quot;state&quot; collapsed=&quot;true&quot;</span>
<a href="#l46.76"></a><span id="l46.76">                           onmouseup=&quot;OnMouseUpThreadAndMessagePaneSplitter()&quot;/&gt;</span>
<a href="#l46.77"></a><span id="l46.77"> </span>
<a href="#l46.78"></a><span id="l46.78">                 &lt;vbox id=&quot;messagepanebox&quot; flex=&quot;2&quot; minheight=&quot;100&quot; height=&quot;200&quot;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l47.1"></a><span id="l47.1" class="difflineminus">--- a/mail/base/content/msgHdrViewOverlay.js</span>
<a href="#l47.2"></a><span id="l47.2" class="difflineplus">+++ b/mail/base/content/msgHdrViewOverlay.js</span>
<a href="#l47.3"></a><span id="l47.3" class="difflineat">@@ -1,48 +1,48 @@</span>
<a href="#l47.4"></a><span id="l47.4" class="difflineminus">-# -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l47.5"></a><span id="l47.5" class="difflineminus">-# ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l47.6"></a><span id="l47.6" class="difflineminus">-# Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l47.7"></a><span id="l47.7" class="difflineminus">-#</span>
<a href="#l47.8"></a><span id="l47.8" class="difflineminus">-# The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l47.9"></a><span id="l47.9" class="difflineminus">-# 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l47.10"></a><span id="l47.10" class="difflineminus">-# the License. You may obtain a copy of the License at</span>
<a href="#l47.11"></a><span id="l47.11" class="difflineminus">-# http://www.mozilla.org/MPL/</span>
<a href="#l47.12"></a><span id="l47.12" class="difflineminus">-#</span>
<a href="#l47.13"></a><span id="l47.13" class="difflineminus">-# Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l47.14"></a><span id="l47.14" class="difflineminus">-# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l47.15"></a><span id="l47.15" class="difflineminus">-# for the specific language governing rights and limitations under the</span>
<a href="#l47.16"></a><span id="l47.16" class="difflineminus">-# License.</span>
<a href="#l47.17"></a><span id="l47.17" class="difflineminus">-#</span>
<a href="#l47.18"></a><span id="l47.18" class="difflineminus">-# The Original Code is Mozilla Communicator client code, released</span>
<a href="#l47.19"></a><span id="l47.19" class="difflineminus">-# March 31, 1998.</span>
<a href="#l47.20"></a><span id="l47.20" class="difflineminus">-#</span>
<a href="#l47.21"></a><span id="l47.21" class="difflineminus">-# The Initial Developer of the Original Code is</span>
<a href="#l47.22"></a><span id="l47.22" class="difflineminus">-# Netscape Communications Corporation.</span>
<a href="#l47.23"></a><span id="l47.23" class="difflineminus">-# Portions created by the Initial Developer are Copyright (C) 1998-1999</span>
<a href="#l47.24"></a><span id="l47.24" class="difflineminus">-# the Initial Developer. All Rights Reserved.</span>
<a href="#l47.25"></a><span id="l47.25" class="difflineminus">-#</span>
<a href="#l47.26"></a><span id="l47.26" class="difflineminus">-# Contributor(s):</span>
<a href="#l47.27"></a><span id="l47.27" class="difflineminus">-#   Markus Hossner &lt;markushossner@gmx.de&gt;</span>
<a href="#l47.28"></a><span id="l47.28" class="difflineminus">-#   Mark Banner &lt;bugzilla@standard8.plus.com&gt;</span>
<a href="#l47.29"></a><span id="l47.29" class="difflineminus">-#   David Ascher &lt;dascher@mozillamessaging.com&gt;</span>
<a href="#l47.30"></a><span id="l47.30" class="difflineminus">-#</span>
<a href="#l47.31"></a><span id="l47.31" class="difflineminus">-# Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l47.32"></a><span id="l47.32" class="difflineminus">-# either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l47.33"></a><span id="l47.33" class="difflineminus">-# the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l47.34"></a><span id="l47.34" class="difflineminus">-# in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l47.35"></a><span id="l47.35" class="difflineminus">-# of those above. If you wish to allow use of your version of this file only</span>
<a href="#l47.36"></a><span id="l47.36" class="difflineminus">-# under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l47.37"></a><span id="l47.37" class="difflineminus">-# use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l47.38"></a><span id="l47.38" class="difflineminus">-# decision by deleting the provisions above and replace them with the notice</span>
<a href="#l47.39"></a><span id="l47.39" class="difflineminus">-# and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l47.40"></a><span id="l47.40" class="difflineminus">-# the provisions above, a recipient may use your version of this file under</span>
<a href="#l47.41"></a><span id="l47.41" class="difflineminus">-# the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l47.42"></a><span id="l47.42" class="difflineminus">-#</span>
<a href="#l47.43"></a><span id="l47.43" class="difflineminus">-# ***** END LICENSE BLOCK *****</span>
<a href="#l47.44"></a><span id="l47.44" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l47.45"></a><span id="l47.45" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l47.46"></a><span id="l47.46" class="difflineplus">+ *</span>
<a href="#l47.47"></a><span id="l47.47" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l47.48"></a><span id="l47.48" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l47.49"></a><span id="l47.49" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l47.50"></a><span id="l47.50" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l47.51"></a><span id="l47.51" class="difflineplus">+ *</span>
<a href="#l47.52"></a><span id="l47.52" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l47.53"></a><span id="l47.53" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l47.54"></a><span id="l47.54" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l47.55"></a><span id="l47.55" class="difflineplus">+ * License.</span>
<a href="#l47.56"></a><span id="l47.56" class="difflineplus">+ *</span>
<a href="#l47.57"></a><span id="l47.57" class="difflineplus">+ * The Original Code is Mozilla Communicator client code, released</span>
<a href="#l47.58"></a><span id="l47.58" class="difflineplus">+ * March 31, 1998.</span>
<a href="#l47.59"></a><span id="l47.59" class="difflineplus">+ *</span>
<a href="#l47.60"></a><span id="l47.60" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l47.61"></a><span id="l47.61" class="difflineplus">+ * Netscape Communications Corporation.</span>
<a href="#l47.62"></a><span id="l47.62" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 1998-1999</span>
<a href="#l47.63"></a><span id="l47.63" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l47.64"></a><span id="l47.64" class="difflineplus">+ *</span>
<a href="#l47.65"></a><span id="l47.65" class="difflineplus">+ * Contributor(s):</span>
<a href="#l47.66"></a><span id="l47.66" class="difflineplus">+ *   Markus Hossner &lt;markushossner@gmx.de&gt;</span>
<a href="#l47.67"></a><span id="l47.67" class="difflineplus">+ *   Mark Banner &lt;bugzilla@standard8.plus.com&gt;</span>
<a href="#l47.68"></a><span id="l47.68" class="difflineplus">+ *   David Ascher &lt;dascher@mozillamessaging.com&gt;</span>
<a href="#l47.69"></a><span id="l47.69" class="difflineplus">+ *   Dan Mosedale &lt;dmose@mozillamessagin.com&gt;</span>
<a href="#l47.70"></a><span id="l47.70" class="difflineplus">+ *</span>
<a href="#l47.71"></a><span id="l47.71" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l47.72"></a><span id="l47.72" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l47.73"></a><span id="l47.73" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l47.74"></a><span id="l47.74" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l47.75"></a><span id="l47.75" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l47.76"></a><span id="l47.76" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l47.77"></a><span id="l47.77" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l47.78"></a><span id="l47.78" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l47.79"></a><span id="l47.79" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l47.80"></a><span id="l47.80" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l47.81"></a><span id="l47.81" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l47.82"></a><span id="l47.82" class="difflineplus">+ *</span>
<a href="#l47.83"></a><span id="l47.83" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l47.84"></a><span id="l47.84"> </span>
<a href="#l47.85"></a><span id="l47.85"> </span>
<a href="#l47.86"></a><span id="l47.86"> /* This is where functions related to displaying the headers for a selected message in the</span>
<a href="#l47.87"></a><span id="l47.87">    message pane live. */</span>
<a href="#l47.88"></a><span id="l47.88"> </span>
<a href="#l47.89"></a><span id="l47.89"> ////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l47.90"></a><span id="l47.90"> // Warning: if you go to modify any of these JS routines please get a code review from</span>
<a href="#l47.91"></a><span id="l47.91"> // scott@scott-macgregor.org. It's critical that the code in here for displaying</span>
<a href="#l47.92"></a><span id="l47.92" class="difflineat">@@ -51,23 +51,20 @@</span>
<a href="#l47.93"></a><span id="l47.93"> // pane, we batch up all the changes for displaying the header pane (to, cc, attachements button, etc.)</span>
<a href="#l47.94"></a><span id="l47.94"> // and we make a single pass to display them. It's critical that we maintain this one reflow per message</span>
<a href="#l47.95"></a><span id="l47.95"> // view in the message header pane.</span>
<a href="#l47.96"></a><span id="l47.96"> ////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l47.97"></a><span id="l47.97"> </span>
<a href="#l47.98"></a><span id="l47.98"> var gViewAllHeaders = false;</span>
<a href="#l47.99"></a><span id="l47.99"> var gMinNumberOfHeaders = 0;</span>
<a href="#l47.100"></a><span id="l47.100"> var gDummyHeaderIdIndex = 0;</span>
<a href="#l47.101"></a><span id="l47.101" class="difflineminus">-var gCollapsedHeaderViewMode = false;</span>
<a href="#l47.102"></a><span id="l47.102"> var gBuildAttachmentsForCurrentMsg = false;</span>
<a href="#l47.103"></a><span id="l47.103"> var gBuildAttachmentPopupForCurrentMsg = true;</span>
<a href="#l47.104"></a><span id="l47.104"> var gBuiltExpandedView = false;</span>
<a href="#l47.105"></a><span id="l47.105" class="difflineminus">-var gBuiltCollapsedView = false;</span>
<a href="#l47.106"></a><span id="l47.106"> var gMessengerBundle;</span>
<a href="#l47.107"></a><span id="l47.107" class="difflineminus">-var gProfileDirURL;</span>
<a href="#l47.108"></a><span id="l47.108"> var gHeadersShowReferences = false;</span>
<a href="#l47.109"></a><span id="l47.109"> var gShowCondensedEmailAddresses = true; // show the friendly display names for people I know instead of the name + email address</span>
<a href="#l47.110"></a><span id="l47.110"> </span>
<a href="#l47.111"></a><span id="l47.111"> // other components may listen to on start header &amp; on end header notifications for each message we display</span>
<a href="#l47.112"></a><span id="l47.112"> // to do that you need to add yourself to our gMessageListeners array with an object that supports the three properties:</span>
<a href="#l47.113"></a><span id="l47.113"> // onStartHeaders, onEndHeaders and onEndAttachments.</span>
<a href="#l47.114"></a><span id="l47.114"> var gMessageListeners = new Array();</span>
<a href="#l47.115"></a><span id="l47.115"> </span>
<a href="#l47.116"></a><span id="l47.116" class="difflineat">@@ -85,26 +82,17 @@ var gMessageListeners = new Array();</span>
<a href="#l47.117"></a><span id="l47.117"> //                 short presentation we'll use the short one. i.e. if you are showing the From field and you</span>
<a href="#l47.118"></a><span id="l47.118"> //                 set this to true, we can show just &quot;John Doe&quot; instead of &quot;John Doe &lt;jdoe@netscape.net&gt;&quot;.</span>
<a href="#l47.119"></a><span id="l47.119"> //                 (DEFAULT: false)</span>
<a href="#l47.120"></a><span id="l47.120"> //</span>
<a href="#l47.121"></a><span id="l47.121"> // outputFunction: this is a method which takes a headerEntry (see the definition below) and a header value</span>
<a href="#l47.122"></a><span id="l47.122"> //                 This allows you to provide your own methods for actually determining how the header value</span>
<a href="#l47.123"></a><span id="l47.123"> //                 is displayed. (DEFAULT: updateHeaderValue which just sets the header value on the text node)</span>
<a href="#l47.124"></a><span id="l47.124"> </span>
<a href="#l47.125"></a><span id="l47.125" class="difflineminus">-// Our first view is the collapsed view. This is very light weight view of the data. We only show a couple</span>
<a href="#l47.126"></a><span id="l47.126" class="difflineminus">-// fields.</span>
<a href="#l47.127"></a><span id="l47.127" class="difflineminus">-var gCollapsedHeaderList = [ {name:&quot;subject&quot;, outputFunction:updateHeaderValueInTextNode},</span>
<a href="#l47.128"></a><span id="l47.128" class="difflineminus">-                             {name:&quot;from&quot;, useToggle:true, useShortView:true, outputFunction:OutputEmailAddresses},</span>
<a href="#l47.129"></a><span id="l47.129" class="difflineminus">-                             {name:&quot;toCcBcc&quot;, useToggle:true,</span>
<a href="#l47.130"></a><span id="l47.130" class="difflineminus">-                              useShortView:true,</span>
<a href="#l47.131"></a><span id="l47.131" class="difflineminus">-                              outputFunction: OutputEmailAddresses},</span>
<a href="#l47.132"></a><span id="l47.132" class="difflineminus">-                             {name:&quot;date&quot;, outputFunction:OutputDate}];</span>
<a href="#l47.133"></a><span id="l47.133" class="difflineminus">-</span>
<a href="#l47.134"></a><span id="l47.134" class="difflineminus">-// We also have an expanded header view. This shows many of your more common (and useful) headers.</span>
<a href="#l47.135"></a><span id="l47.135" class="difflineplus">+// This expanded header view shows many of the more common (and useful) headers.</span>
<a href="#l47.136"></a><span id="l47.136"> var gExpandedHeaderList = [ {name:&quot;subject&quot;},</span>
<a href="#l47.137"></a><span id="l47.137">                             {name:&quot;from&quot;, useToggle:true, outputFunction:OutputEmailAddresses},</span>
<a href="#l47.138"></a><span id="l47.138">                             {name:&quot;reply-to&quot;, useToggle:true, outputFunction:OutputEmailAddresses},</span>
<a href="#l47.139"></a><span id="l47.139">                             {name:&quot;date&quot;},</span>
<a href="#l47.140"></a><span id="l47.140">                             {name:&quot;to&quot;, useToggle:true, outputFunction:OutputEmailAddresses},</span>
<a href="#l47.141"></a><span id="l47.141">                             {name:&quot;cc&quot;, useToggle:true, outputFunction:OutputEmailAddresses},</span>
<a href="#l47.142"></a><span id="l47.142">                             {name:&quot;bcc&quot;, useToggle:true, outputFunction:OutputEmailAddresses},</span>
<a href="#l47.143"></a><span id="l47.143">                             {name:&quot;newsgroups&quot;, outputFunction:OutputNewsgroups},</span>
<a href="#l47.144"></a><span id="l47.144" class="difflineat">@@ -116,17 +104,16 @@ var gExpandedHeaderList = [ {name:&quot;subje</span>
<a href="#l47.145"></a><span id="l47.145"> // These are all the items that use a mail-multi-emailHeaderField widget and</span>
<a href="#l47.146"></a><span id="l47.146"> // therefore may require updating if the address book changes.</span>
<a href="#l47.147"></a><span id="l47.147"> const gEmailAddressHeaderNames = [&quot;from&quot;, &quot;reply-to&quot;,</span>
<a href="#l47.148"></a><span id="l47.148">                                   &quot;to&quot;, &quot;cc&quot;, &quot;bcc&quot;, &quot;toCcBcc&quot;];</span>
<a href="#l47.149"></a><span id="l47.149"> </span>
<a href="#l47.150"></a><span id="l47.150"> // Now, for each view the message pane can generate, we need a global table of headerEntries. These</span>
<a href="#l47.151"></a><span id="l47.151"> // header entry objects are generated dynamically based on the static data in the header lists (see above)</span>
<a href="#l47.152"></a><span id="l47.152"> // and elements we find in the DOM based on properties in the header lists.</span>
<a href="#l47.153"></a><span id="l47.153" class="difflineminus">-var gCollapsedHeaderView = {};</span>
<a href="#l47.154"></a><span id="l47.154"> var gExpandedHeaderView  = {};</span>
<a href="#l47.155"></a><span id="l47.155"> </span>
<a href="#l47.156"></a><span id="l47.156"> // currentHeaderData --&gt; this is an array of header name and value pairs for the currently displayed message.</span>
<a href="#l47.157"></a><span id="l47.157"> //                       it's purely a data object and has no view information. View information is contained in the view objects.</span>
<a href="#l47.158"></a><span id="l47.158"> //                       for a given entry in this array you can ask for:</span>
<a href="#l47.159"></a><span id="l47.159"> // .headerName ---&gt; name of the header (i.e. 'to'). Always stored in lower case</span>
<a href="#l47.160"></a><span id="l47.160"> // .headerValue --&gt; value of the header &quot;johndoe@netscape.net&quot;</span>
<a href="#l47.161"></a><span id="l47.161"> var currentHeaderData = {};</span>
<a href="#l47.162"></a><span id="l47.162" class="difflineat">@@ -142,17 +129,17 @@ var currentAttachments = new Array();</span>
<a href="#l47.163"></a><span id="l47.163"> </span>
<a href="#l47.164"></a><span id="l47.164"> const nsIAbListener = Components.interfaces.nsIAbListener;</span>
<a href="#l47.165"></a><span id="l47.165"> const nsIAbCard = Components.interfaces.nsIAbCard;</span>
<a href="#l47.166"></a><span id="l47.166"> </span>
<a href="#l47.167"></a><span id="l47.167"> // createHeaderEntry --&gt; our constructor method which creates a header Entry</span>
<a href="#l47.168"></a><span id="l47.168"> // based on an entry in one of the header lists. A header entry is different from a header list.</span>
<a href="#l47.169"></a><span id="l47.169"> // a header list just describes how you want a particular header to be presented. The header entry</span>
<a href="#l47.170"></a><span id="l47.170"> // actually has knowledge about the DOM and the actual DOM elements associated with the header.</span>
<a href="#l47.171"></a><span id="l47.171" class="difflineminus">-// prefix --&gt; the name of the view (i.e. &quot;collapsed&quot;, &quot;expanded&quot;)</span>
<a href="#l47.172"></a><span id="l47.172" class="difflineplus">+// prefix --&gt; the name of the view (e.g. &quot;expanded&quot;)</span>
<a href="#l47.173"></a><span id="l47.173"> // headerListInfo --&gt; entry from a header list.</span>
<a href="#l47.174"></a><span id="l47.174"> function createHeaderEntry(prefix, headerListInfo)</span>
<a href="#l47.175"></a><span id="l47.175"> {</span>
<a href="#l47.176"></a><span id="l47.176">   var useShortView = false;</span>
<a href="#l47.177"></a><span id="l47.177">   var partialIDName = prefix + headerListInfo.name;</span>
<a href="#l47.178"></a><span id="l47.178">   this.enclosingBox = document.getElementById(partialIDName + 'Box');</span>
<a href="#l47.179"></a><span id="l47.179">   this.textNode = document.getElementById(partialIDName + 'Value');</span>
<a href="#l47.180"></a><span id="l47.180">   this.isNewHeader = false;</span>
<a href="#l47.181"></a><span id="l47.181" class="difflineat">@@ -191,22 +178,16 @@ function createHeaderEntry(prefix, heade</span>
<a href="#l47.182"></a><span id="l47.182"> </span>
<a href="#l47.183"></a><span id="l47.183"> function initializeHeaderViewTables()</span>
<a href="#l47.184"></a><span id="l47.184"> {</span>
<a href="#l47.185"></a><span id="l47.185">   var prefBranch = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l47.186"></a><span id="l47.186">                              .getService(Components.interfaces.nsIPrefBranch2);</span>
<a href="#l47.187"></a><span id="l47.187">   // iterate over each header in our header list arrays and create header entries</span>
<a href="#l47.188"></a><span id="l47.188">   // for each one. These header entries are then stored in the appropriate header table</span>
<a href="#l47.189"></a><span id="l47.189">   var index;</span>
<a href="#l47.190"></a><span id="l47.190" class="difflineminus">-  for (index = 0; index &lt; gCollapsedHeaderList.length; index++)</span>
<a href="#l47.191"></a><span id="l47.191" class="difflineminus">-    {</span>
<a href="#l47.192"></a><span id="l47.192" class="difflineminus">-      gCollapsedHeaderView[gCollapsedHeaderList[index].name] =</span>
<a href="#l47.193"></a><span id="l47.193" class="difflineminus">-        new createHeaderEntry('collapsed', gCollapsedHeaderList[index]);</span>
<a href="#l47.194"></a><span id="l47.194" class="difflineminus">-    }</span>
<a href="#l47.195"></a><span id="l47.195" class="difflineminus">-</span>
<a href="#l47.196"></a><span id="l47.196">     for (index = 0; index &lt; gExpandedHeaderList.length; index++)</span>
<a href="#l47.197"></a><span id="l47.197">     {</span>
<a href="#l47.198"></a><span id="l47.198">       var headerName = gExpandedHeaderList[index].name;</span>
<a href="#l47.199"></a><span id="l47.199">       gExpandedHeaderView[headerName] = new createHeaderEntry('expanded', gExpandedHeaderList[index]);</span>
<a href="#l47.200"></a><span id="l47.200">     }</span>
<a href="#l47.201"></a><span id="l47.201"> </span>
<a href="#l47.202"></a><span id="l47.202">     var extraHeaders = prefBranch.getCharPref(&quot;mailnews.headers.extraExpandedHeaders&quot;).split(' ');</span>
<a href="#l47.203"></a><span id="l47.203">     for (index = 0; index &lt; extraHeaders.length; index++)</span>
<a href="#l47.204"></a><span id="l47.204" class="difflineat">@@ -259,26 +240,25 @@ function OnLoadMsgHeaderPane()</span>
<a href="#l47.205"></a><span id="l47.205"> </span>
<a href="#l47.206"></a><span id="l47.206">   // Add an address book listener so we can update the header view when things</span>
<a href="#l47.207"></a><span id="l47.207">   // change.</span>
<a href="#l47.208"></a><span id="l47.208">   Components.classes[&quot;@mozilla.org/abmanager;1&quot;]</span>
<a href="#l47.209"></a><span id="l47.209">             .getService(Components.interfaces.nsIAbManager)</span>
<a href="#l47.210"></a><span id="l47.210">             .addAddressBookListener(AddressBookListener,</span>
<a href="#l47.211"></a><span id="l47.211">                                     Components.interfaces.nsIAbListener.all);</span>
<a href="#l47.212"></a><span id="l47.212"> </span>
<a href="#l47.213"></a><span id="l47.213" class="difflineminus">-  var deckHeaderView = document.getElementById(&quot;msgHeaderViewDeck&quot;);</span>
<a href="#l47.214"></a><span id="l47.214" class="difflineminus">-  gCollapsedHeaderViewMode = deckHeaderView.selectedIndex == 0;</span>
<a href="#l47.215"></a><span id="l47.215" class="difflineminus">-  </span>
<a href="#l47.216"></a><span id="l47.216" class="difflineminus">-  // work around XUL deck bug where collapsed header view, if it's the persisted</span>
<a href="#l47.217"></a><span id="l47.217" class="difflineminus">-  // default, wouldn't be sized properly because of the larger expanded</span>
<a href="#l47.218"></a><span id="l47.218" class="difflineminus">-  // view &quot;stretches&quot; the deck.</span>
<a href="#l47.219"></a><span id="l47.219" class="difflineminus">-  if (gCollapsedHeaderViewMode)</span>
<a href="#l47.220"></a><span id="l47.220" class="difflineminus">-    document.getElementById('expandedHeaderView').collapsed = true;</span>
<a href="#l47.221"></a><span id="l47.221" class="difflineminus">-  else</span>
<a href="#l47.222"></a><span id="l47.222" class="difflineminus">-    document.getElementById('collapsedHeaderView').collapsed = true;</span>
<a href="#l47.223"></a><span id="l47.223" class="difflineplus">+  // if an invalid index is selected; reset to 0.  One way this can happen</span>
<a href="#l47.224"></a><span id="l47.224" class="difflineplus">+  // is if a value of 1 was persisted to localStore.rdf by Tb2 (when there were</span>
<a href="#l47.225"></a><span id="l47.225" class="difflineplus">+  // two panels), and then the user upgraded to Tb3, which only has one.</span>
<a href="#l47.226"></a><span id="l47.226" class="difflineplus">+  // Presumably this can also catch cases of extension uninstalls as well.</span>
<a href="#l47.227"></a><span id="l47.227" class="difflineplus">+  let deckElement = document.getElementById('msgHeaderViewDeck')</span>
<a href="#l47.228"></a><span id="l47.228" class="difflineplus">+  if (deckElement.selectedIndex &lt; 0 ||</span>
<a href="#l47.229"></a><span id="l47.229" class="difflineplus">+      deckElement.selectedIndex &gt;= deckElement.childElementCount) {</span>
<a href="#l47.230"></a><span id="l47.230" class="difflineplus">+    deckElement.selectedIndex = 0;</span>
<a href="#l47.231"></a><span id="l47.231" class="difflineplus">+  }</span>
<a href="#l47.232"></a><span id="l47.232"> </span>
<a href="#l47.233"></a><span id="l47.233">   // dispatch an event letting any listeners know that we have loaded the message pane</span>
<a href="#l47.234"></a><span id="l47.234">   var event = document.createEvent('Events');</span>
<a href="#l47.235"></a><span id="l47.235">   event.initEvent('messagepane-loaded', false, true);</span>
<a href="#l47.236"></a><span id="l47.236">   var headerViewElement = document.getElementById(&quot;msgHeaderView&quot;);</span>
<a href="#l47.237"></a><span id="l47.237">   headerViewElement.dispatchEvent(event);</span>
<a href="#l47.238"></a><span id="l47.238"> }</span>
<a href="#l47.239"></a><span id="l47.239"> </span>
<a href="#l47.240"></a><span id="l47.240" class="difflineat">@@ -338,25 +318,16 @@ var AddressBookListener =</span>
<a href="#l47.241"></a><span id="l47.241">       OnAddressBookDataChanged(nsIAbListener.itemChanged, null, aItem);</span>
<a href="#l47.242"></a><span id="l47.242">   }</span>
<a href="#l47.243"></a><span id="l47.243"> };</span>
<a href="#l47.244"></a><span id="l47.244"> </span>
<a href="#l47.245"></a><span id="l47.245"> function OnAddressBookDataChanged(aAction, aParentDir, aItem) {</span>
<a href="#l47.246"></a><span id="l47.246">   gEmailAddressHeaderNames.forEach(function (headerName) {</span>
<a href="#l47.247"></a><span id="l47.247">       var headerEntry = null;</span>
<a href="#l47.248"></a><span id="l47.248"> </span>
<a href="#l47.249"></a><span id="l47.249" class="difflineminus">-      // Ensure both collapsed and expanded are updated in case we toggle</span>
<a href="#l47.250"></a><span id="l47.250" class="difflineminus">-      // between the two.</span>
<a href="#l47.251"></a><span id="l47.251" class="difflineminus">-      if (headerName in gCollapsedHeaderView) {</span>
<a href="#l47.252"></a><span id="l47.252" class="difflineminus">-        headerEntry = gCollapsedHeaderView[headerName];</span>
<a href="#l47.253"></a><span id="l47.253" class="difflineminus">-        if (headerEntry)</span>
<a href="#l47.254"></a><span id="l47.254" class="difflineminus">-          headerEntry.enclosingBox.updateExtraAddressProcessing(aAction,</span>
<a href="#l47.255"></a><span id="l47.255" class="difflineminus">-                                                                aParentDir,</span>
<a href="#l47.256"></a><span id="l47.256" class="difflineminus">-                                                                aItem);</span>
<a href="#l47.257"></a><span id="l47.257" class="difflineminus">-      }</span>
<a href="#l47.258"></a><span id="l47.258">       if (headerName in gExpandedHeaderView) {</span>
<a href="#l47.259"></a><span id="l47.259">         headerEntry = gExpandedHeaderView[headerName];</span>
<a href="#l47.260"></a><span id="l47.260">         if (headerEntry)</span>
<a href="#l47.261"></a><span id="l47.261">           headerEntry.enclosingBox.updateExtraAddressProcessing(aAction,</span>
<a href="#l47.262"></a><span id="l47.262">                                                                 aParentDir,</span>
<a href="#l47.263"></a><span id="l47.263">                                                                 aItem);</span>
<a href="#l47.264"></a><span id="l47.264">       }</span>
<a href="#l47.265"></a><span id="l47.265">     });</span>
<a href="#l47.266"></a><span id="l47.266" class="difflineat">@@ -386,41 +357,44 @@ var messageHeaderSink = {</span>
<a href="#l47.267"></a><span id="l47.267">           initializeHeaderViewTables();</span>
<a href="#l47.268"></a><span id="l47.268">         }</span>
<a href="#l47.269"></a><span id="l47.269"> </span>
<a href="#l47.270"></a><span id="l47.270">         gViewAllHeaders = false;</span>
<a href="#l47.271"></a><span id="l47.271">       }</span>
<a href="#l47.272"></a><span id="l47.272"> </span>
<a href="#l47.273"></a><span id="l47.273">       ClearCurrentHeaders();</span>
<a href="#l47.274"></a><span id="l47.274">       gBuiltExpandedView = false;</span>
<a href="#l47.275"></a><span id="l47.275" class="difflineminus">-      gBuiltCollapsedView = false;</span>
<a href="#l47.276"></a><span id="l47.276">       gBuildAttachmentsForCurrentMsg = false;</span>
<a href="#l47.277"></a><span id="l47.277">       gBuildAttachmentPopupForCurrentMsg = true;</span>
<a href="#l47.278"></a><span id="l47.278">       ClearAttachmentList();</span>
<a href="#l47.279"></a><span id="l47.279">       ClearEditMessageBox();</span>
<a href="#l47.280"></a><span id="l47.280">       gMessageNotificationBar.clearMsgNotifications();</span>
<a href="#l47.281"></a><span id="l47.281"> </span>
<a href="#l47.282"></a><span id="l47.282" class="difflineminus">-      for (index in gMessageListeners)</span>
<a href="#l47.283"></a><span id="l47.283" class="difflineplus">+      for (let index in gMessageListeners)</span>
<a href="#l47.284"></a><span id="l47.284">         gMessageListeners[index].onStartHeaders();</span>
<a href="#l47.285"></a><span id="l47.285">     },</span>
<a href="#l47.286"></a><span id="l47.286"> </span>
<a href="#l47.287"></a><span id="l47.287">     onEndHeaders: function()</span>
<a href="#l47.288"></a><span id="l47.288">     {</span>
<a href="#l47.289"></a><span id="l47.289">       ShowMessageHeaderPane();</span>
<a href="#l47.290"></a><span id="l47.290">       // WARNING: This is the ONLY routine inside of the message Header Sink that should</span>
<a href="#l47.291"></a><span id="l47.291">       // trigger a reflow!</span>
<a href="#l47.292"></a><span id="l47.292" class="difflineminus">-      ClearHeaderView(gCollapsedHeaderView);</span>
<a href="#l47.293"></a><span id="l47.293">       ClearHeaderView(gExpandedHeaderView);</span>
<a href="#l47.294"></a><span id="l47.294"> </span>
<a href="#l47.295"></a><span id="l47.295">       EnsureSubjectValue(); // make sure there is a subject even if it's empty so we'll show the subject and the twisty</span>
<a href="#l47.296"></a><span id="l47.296"> </span>
<a href="#l47.297"></a><span id="l47.297" class="difflineminus">-      UpdateMessageHeaders();</span>
<a href="#l47.298"></a><span id="l47.298" class="difflineplus">+      // Only update the expanded view if it's actually selected (an</span>
<a href="#l47.299"></a><span id="l47.299" class="difflineplus">+      // extension-provided panel could be visible instead) and needs updating.</span>
<a href="#l47.300"></a><span id="l47.300" class="difflineplus">+      if (document.getElementById('msgHeaderViewDeck').selectedIndex == 0 &amp;&amp;</span>
<a href="#l47.301"></a><span id="l47.301" class="difflineplus">+          !gBuiltExpandedView) {</span>
<a href="#l47.302"></a><span id="l47.302" class="difflineplus">+        UpdateExpandedMessageHeaders();</span>
<a href="#l47.303"></a><span id="l47.303" class="difflineplus">+      }</span>
<a href="#l47.304"></a><span id="l47.304" class="difflineplus">+</span>
<a href="#l47.305"></a><span id="l47.305">       ShowEditMessageBox();</span>
<a href="#l47.306"></a><span id="l47.306">       UpdateJunkButton();</span>
<a href="#l47.307"></a><span id="l47.307" class="difflineminus">-      UpdateReplyButtons();</span>
<a href="#l47.308"></a><span id="l47.308"> </span>
<a href="#l47.309"></a><span id="l47.309">       for (index in gMessageListeners)</span>
<a href="#l47.310"></a><span id="l47.310">         gMessageListeners[index].onEndHeaders();</span>
<a href="#l47.311"></a><span id="l47.311">     },</span>
<a href="#l47.312"></a><span id="l47.312"> </span>
<a href="#l47.313"></a><span id="l47.313">     processHeaders: function(headerNameEnumerator, headerValueEnumerator, dontCollectAddress)</span>
<a href="#l47.314"></a><span id="l47.314">     {</span>
<a href="#l47.315"></a><span id="l47.315">       this.onStartHeaders();</span>
<a href="#l47.316"></a><span id="l47.316" class="difflineat">@@ -498,22 +472,18 @@ var messageHeaderSink = {</span>
<a href="#l47.317"></a><span id="l47.317">       this.onEndHeaders();</span>
<a href="#l47.318"></a><span id="l47.318">     },</span>
<a href="#l47.319"></a><span id="l47.319"> </span>
<a href="#l47.320"></a><span id="l47.320">     handleAttachment: function(contentType, url, displayName, uri, isExternalAttachment)</span>
<a href="#l47.321"></a><span id="l47.321">     {</span>
<a href="#l47.322"></a><span id="l47.322">       // presentation level change....don't show vcards as external attachments in the UI.</span>
<a href="#l47.323"></a><span id="l47.323">       // libmime already renders them inline.</span>
<a href="#l47.324"></a><span id="l47.324"> </span>
<a href="#l47.325"></a><span id="l47.325" class="difflineminus">-      try</span>
<a href="#l47.326"></a><span id="l47.326" class="difflineminus">-      {</span>
<a href="#l47.327"></a><span id="l47.327" class="difflineminus">-        if (!this.mSaveHdr)</span>
<a href="#l47.328"></a><span id="l47.328" class="difflineminus">-          this.mSaveHdr = messenger.messageServiceFromURI(uri).messageURIToMsgHdr(uri);</span>
<a href="#l47.329"></a><span id="l47.329" class="difflineminus">-      }</span>
<a href="#l47.330"></a><span id="l47.330" class="difflineminus">-      catch (ex) {}</span>
<a href="#l47.331"></a><span id="l47.331" class="difflineplus">+      if (!this.mSaveHdr)</span>
<a href="#l47.332"></a><span id="l47.332" class="difflineplus">+        this.mSaveHdr = messenger.messageServiceFromURI(uri).messageURIToMsgHdr(uri);</span>
<a href="#l47.333"></a><span id="l47.333">       if (contentType == &quot;text/x-vcard&quot;)</span>
<a href="#l47.334"></a><span id="l47.334">       {</span>
<a href="#l47.335"></a><span id="l47.335">         var inlineAttachments = pref.getBoolPref(&quot;mail.inline_attachments&quot;);</span>
<a href="#l47.336"></a><span id="l47.336">         var displayHtmlAs = pref.getIntPref(&quot;mailnews.display.html_as&quot;);</span>
<a href="#l47.337"></a><span id="l47.337">         if (inlineAttachments &amp;&amp; !displayHtmlAs)</span>
<a href="#l47.338"></a><span id="l47.338">         {</span>
<a href="#l47.339"></a><span id="l47.339">           return;</span>
<a href="#l47.340"></a><span id="l47.340">         }</span>
<a href="#l47.341"></a><span id="l47.341" class="difflineat">@@ -526,48 +496,41 @@ var messageHeaderSink = {</span>
<a href="#l47.342"></a><span id="l47.342">       // We only need to do this on the first attachment.</span>
<a href="#l47.343"></a><span id="l47.343">       var numAttachments = currentAttachments.length;</span>
<a href="#l47.344"></a><span id="l47.344">       if (numAttachments == 1) {</span>
<a href="#l47.345"></a><span id="l47.345">         // we also have to enable the File/Attachments menuitem</span>
<a href="#l47.346"></a><span id="l47.346">         var node = document.getElementById(&quot;fileAttachmentMenu&quot;);</span>
<a href="#l47.347"></a><span id="l47.347">         if (node)</span>
<a href="#l47.348"></a><span id="l47.348">           node.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l47.349"></a><span id="l47.349"> </span>
<a href="#l47.350"></a><span id="l47.350" class="difflineminus">-        try {</span>
<a href="#l47.351"></a><span id="l47.351" class="difflineminus">-          // convert the uri into a hdr</span>
<a href="#l47.352"></a><span id="l47.352" class="difflineminus">-          this.mSaveHdr.markHasAttachments(true);</span>
<a href="#l47.353"></a><span id="l47.353" class="difflineminus">-        }</span>
<a href="#l47.354"></a><span id="l47.354" class="difflineminus">-        catch (ex) {</span>
<a href="#l47.355"></a><span id="l47.355" class="difflineminus">-          dump(&quot;ex = &quot; + ex + &quot;\n&quot;);</span>
<a href="#l47.356"></a><span id="l47.356" class="difflineminus">-        }</span>
<a href="#l47.357"></a><span id="l47.357" class="difflineplus">+        // convert the uri into a hdr</span>
<a href="#l47.358"></a><span id="l47.358" class="difflineplus">+        this.mSaveHdr.markHasAttachments(true);</span>
<a href="#l47.359"></a><span id="l47.359">       }</span>
<a href="#l47.360"></a><span id="l47.360">     },</span>
<a href="#l47.361"></a><span id="l47.361"> </span>
<a href="#l47.362"></a><span id="l47.362">     onEndAllAttachments: function()</span>
<a href="#l47.363"></a><span id="l47.363">     {</span>
<a href="#l47.364"></a><span id="l47.364">       displayAttachmentsForExpandedView();</span>
<a href="#l47.365"></a><span id="l47.365"> </span>
<a href="#l47.366"></a><span id="l47.366" class="difflineplus">+      gMessageDisplay.messageLoading = false;</span>
<a href="#l47.367"></a><span id="l47.367" class="difflineplus">+      gMessageDisplay.messageLoaded = true;</span>
<a href="#l47.368"></a><span id="l47.368" class="difflineplus">+</span>
<a href="#l47.369"></a><span id="l47.369">       for (index in gMessageListeners) {</span>
<a href="#l47.370"></a><span id="l47.370">         if (&quot;onEndAttachments&quot; in gMessageListeners[index])</span>
<a href="#l47.371"></a><span id="l47.371">           gMessageListeners[index].onEndAttachments();</span>
<a href="#l47.372"></a><span id="l47.372">       }</span>
<a href="#l47.373"></a><span id="l47.373">     },</span>
<a href="#l47.374"></a><span id="l47.374"> </span>
<a href="#l47.375"></a><span id="l47.375">     onEndMsgDownload: function(url)</span>
<a href="#l47.376"></a><span id="l47.376">     {</span>
<a href="#l47.377"></a><span id="l47.377">       // if we don't have any attachments, turn off the attachments flag</span>
<a href="#l47.378"></a><span id="l47.378">       if (!this.mSaveHdr)</span>
<a href="#l47.379"></a><span id="l47.379">       {</span>
<a href="#l47.380"></a><span id="l47.380">         var messageUrl = url.QueryInterface(Components.interfaces.nsIMsgMessageUrl);</span>
<a href="#l47.381"></a><span id="l47.381" class="difflineminus">-        try</span>
<a href="#l47.382"></a><span id="l47.382" class="difflineminus">-        {</span>
<a href="#l47.383"></a><span id="l47.383" class="difflineminus">-          this.mSaveHdr = messenger.msgHdrFromURI(messageUrl.uri);</span>
<a href="#l47.384"></a><span id="l47.384" class="difflineminus">-        }</span>
<a href="#l47.385"></a><span id="l47.385" class="difflineminus">-        catch (ex) {}</span>
<a href="#l47.386"></a><span id="l47.386" class="difflineminus">-</span>
<a href="#l47.387"></a><span id="l47.387" class="difflineplus">+        this.mSaveHdr = messenger.msgHdrFromURI(messageUrl.uri);</span>
<a href="#l47.388"></a><span id="l47.388">       }</span>
<a href="#l47.389"></a><span id="l47.389">       if (!currentAttachments.length &amp;&amp; this.mSaveHdr)</span>
<a href="#l47.390"></a><span id="l47.390">         this.mSaveHdr.markHasAttachments(false);</span>
<a href="#l47.391"></a><span id="l47.391">       OnMsgParsed(url);</span>
<a href="#l47.392"></a><span id="l47.392">     },</span>
<a href="#l47.393"></a><span id="l47.393"> </span>
<a href="#l47.394"></a><span id="l47.394">     onEndMsgHeaders: function(url)</span>
<a href="#l47.395"></a><span id="l47.395">     {</span>
<a href="#l47.396"></a><span id="l47.396" class="difflineat">@@ -591,40 +554,39 @@ var messageHeaderSink = {</span>
<a href="#l47.397"></a><span id="l47.397">     },</span>
<a href="#l47.398"></a><span id="l47.398"> </span>
<a href="#l47.399"></a><span id="l47.399">     mDummyMsgHeader: null,</span>
<a href="#l47.400"></a><span id="l47.400"> </span>
<a href="#l47.401"></a><span id="l47.401">     get dummyMsgHeader()</span>
<a href="#l47.402"></a><span id="l47.402">     {</span>
<a href="#l47.403"></a><span id="l47.403">       if (!this.mDummyMsgHeader)</span>
<a href="#l47.404"></a><span id="l47.404">         this.mDummyMsgHeader = new nsDummyMsgHeader();</span>
<a href="#l47.405"></a><span id="l47.405" class="difflineplus">+      // The URI resolution will never work on the dummy header;</span>
<a href="#l47.406"></a><span id="l47.406" class="difflineplus">+      // save it now... we know it will be needed eventually.</span>
<a href="#l47.407"></a><span id="l47.407" class="difflineplus">+      // (And save it every time we come through here, not just when</span>
<a href="#l47.408"></a><span id="l47.408" class="difflineplus">+      // we create it; the onStartHeaders might come after creation!)</span>
<a href="#l47.409"></a><span id="l47.409" class="difflineplus">+      this.mSaveHdr = this.mDummyMsgHeader;</span>
<a href="#l47.410"></a><span id="l47.410">       return this.mDummyMsgHeader;</span>
<a href="#l47.411"></a><span id="l47.411">     },</span>
<a href="#l47.412"></a><span id="l47.412">     mProperties: null,</span>
<a href="#l47.413"></a><span id="l47.413">     get properties()</span>
<a href="#l47.414"></a><span id="l47.414">     {</span>
<a href="#l47.415"></a><span id="l47.415">       if (!this.mProperties)</span>
<a href="#l47.416"></a><span id="l47.416">         this.mProperties = Components.classes[&quot;@mozilla.org/hash-property-bag;1&quot;].</span>
<a href="#l47.417"></a><span id="l47.417">           createInstance(Components.interfaces.nsIWritablePropertyBag2);</span>
<a href="#l47.418"></a><span id="l47.418">       return this.mProperties;</span>
<a href="#l47.419"></a><span id="l47.419">     }</span>
<a href="#l47.420"></a><span id="l47.420"> };</span>
<a href="#l47.421"></a><span id="l47.421"> </span>
<a href="#l47.422"></a><span id="l47.422"> function SetTagHeader()</span>
<a href="#l47.423"></a><span id="l47.423"> {</span>
<a href="#l47.424"></a><span id="l47.424">   // it would be nice if we passed in the msgHdr from the back end</span>
<a href="#l47.425"></a><span id="l47.425" class="difflineminus">-  var msgHdr;</span>
<a href="#l47.426"></a><span id="l47.426" class="difflineminus">-  try</span>
<a href="#l47.427"></a><span id="l47.427" class="difflineminus">-  {</span>
<a href="#l47.428"></a><span id="l47.428" class="difflineminus">-    msgHdr = gDBView.hdrForFirstSelectedMessage;</span>
<a href="#l47.429"></a><span id="l47.429" class="difflineminus">-  }</span>
<a href="#l47.430"></a><span id="l47.430" class="difflineminus">-  catch (ex)</span>
<a href="#l47.431"></a><span id="l47.431" class="difflineminus">-  {</span>
<a href="#l47.432"></a><span id="l47.432" class="difflineplus">+  var msgHdr = gFolderDisplay.selectedMessage;</span>
<a href="#l47.433"></a><span id="l47.433" class="difflineplus">+  if (!msgHdr)</span>
<a href="#l47.434"></a><span id="l47.434">     return; // no msgHdr to add our tags to</span>
<a href="#l47.435"></a><span id="l47.435" class="difflineminus">-  }</span>
<a href="#l47.436"></a><span id="l47.436"> </span>
<a href="#l47.437"></a><span id="l47.437">   // get the list of known tags</span>
<a href="#l47.438"></a><span id="l47.438">   var tagService = Components.classes[&quot;@mozilla.org/messenger/tagservice;1&quot;]</span>
<a href="#l47.439"></a><span id="l47.439">                    .getService(Components.interfaces.nsIMsgTagService);</span>
<a href="#l47.440"></a><span id="l47.440">   var tagArray = tagService.getAllTags({});</span>
<a href="#l47.441"></a><span id="l47.441">   var tagKeys = {};</span>
<a href="#l47.442"></a><span id="l47.442">   for each (var tagInfo in tagArray)</span>
<a href="#l47.443"></a><span id="l47.443">     if (tagInfo.tag)</span>
<a href="#l47.444"></a><span id="l47.444" class="difflineat">@@ -678,20 +640,18 @@ function OnTagsChange()</span>
<a href="#l47.445"></a><span id="l47.445">   {</span>
<a href="#l47.446"></a><span id="l47.446">     var headerEntry = gExpandedHeaderView.tags;</span>
<a href="#l47.447"></a><span id="l47.447">     if (headerEntry)</span>
<a href="#l47.448"></a><span id="l47.448">     {</span>
<a href="#l47.449"></a><span id="l47.449">       headerEntry.valid = (&quot;tags&quot; in currentHeaderData);</span>
<a href="#l47.450"></a><span id="l47.450">       if (headerEntry.valid)</span>
<a href="#l47.451"></a><span id="l47.451">         headerEntry.outputFunction(headerEntry, currentHeaderData.tags.headerValue);</span>
<a href="#l47.452"></a><span id="l47.452"> </span>
<a href="#l47.453"></a><span id="l47.453" class="difflineminus">-      // if we are showing the expanded header view then we may need to collapse or</span>
<a href="#l47.454"></a><span id="l47.454" class="difflineminus">-      // show the tag header box...</span>
<a href="#l47.455"></a><span id="l47.455" class="difflineminus">-      if (!gCollapsedHeaderViewMode)</span>
<a href="#l47.456"></a><span id="l47.456" class="difflineminus">-        headerEntry.enclosingBox.collapsed = !headerEntry.valid;</span>
<a href="#l47.457"></a><span id="l47.457" class="difflineplus">+      // we may need to collapse or show the tag header box...</span>
<a href="#l47.458"></a><span id="l47.458" class="difflineplus">+      headerEntry.enclosingBox.collapsed = !headerEntry.valid;</span>
<a href="#l47.459"></a><span id="l47.459">     }</span>
<a href="#l47.460"></a><span id="l47.460">   }</span>
<a href="#l47.461"></a><span id="l47.461"> }</span>
<a href="#l47.462"></a><span id="l47.462"> </span>
<a href="#l47.463"></a><span id="l47.463"> // flush out any local state being held by a header entry for a given</span>
<a href="#l47.464"></a><span id="l47.464"> // table</span>
<a href="#l47.465"></a><span id="l47.465"> function ClearHeaderView(headerTable)</span>
<a href="#l47.466"></a><span id="l47.466"> {</span>
<a href="#l47.467"></a><span id="l47.467" class="difflineat">@@ -771,60 +731,39 @@ function EnsureMinimumNumberOfHeaders (h</span>
<a href="#l47.468"></a><span id="l47.468"> </span>
<a href="#l47.469"></a><span id="l47.469">       gDummyHeaderIdIndex++;</span>
<a href="#l47.470"></a><span id="l47.470">       numEmptyHeaders--;</span>
<a href="#l47.471"></a><span id="l47.471">     }</span>
<a href="#l47.472"></a><span id="l47.472"> </span>
<a href="#l47.473"></a><span id="l47.473">   }</span>
<a href="#l47.474"></a><span id="l47.474"> }</span>
<a href="#l47.475"></a><span id="l47.475"> </span>
<a href="#l47.476"></a><span id="l47.476" class="difflineminus">-// make sure the appropriate fields within the currently displayed view header mode</span>
<a href="#l47.477"></a><span id="l47.477" class="difflineminus">-// are collapsed or visible...</span>
<a href="#l47.478"></a><span id="l47.478" class="difflineminus">-function updateHeaderViews()</span>
<a href="#l47.479"></a><span id="l47.479" class="difflineplus">+// make sure the appropriate fields in the expanded header view are collapsed</span>
<a href="#l47.480"></a><span id="l47.480" class="difflineplus">+// or visible...</span>
<a href="#l47.481"></a><span id="l47.481" class="difflineplus">+function updateExpandedView()</span>
<a href="#l47.482"></a><span id="l47.482"> {</span>
<a href="#l47.483"></a><span id="l47.483" class="difflineminus">-  if (gCollapsedHeaderViewMode)</span>
<a href="#l47.484"></a><span id="l47.484" class="difflineminus">-    showHeaderView(gCollapsedHeaderView);</span>
<a href="#l47.485"></a><span id="l47.485" class="difflineminus">-  else</span>
<a href="#l47.486"></a><span id="l47.486" class="difflineminus">-  {</span>
<a href="#l47.487"></a><span id="l47.487" class="difflineminus">-    if (gMinNumberOfHeaders)</span>
<a href="#l47.488"></a><span id="l47.488" class="difflineplus">+  // if the expanded view isn't selected, don't bother updating it</span>
<a href="#l47.489"></a><span id="l47.489" class="difflineplus">+  if (document.getElementById('msgHeaderViewDeck').selectedIndex != 0)</span>
<a href="#l47.490"></a><span id="l47.490" class="difflineplus">+    return;</span>
<a href="#l47.491"></a><span id="l47.491" class="difflineplus">+</span>
<a href="#l47.492"></a><span id="l47.492" class="difflineplus">+  if (gMinNumberOfHeaders)</span>
<a href="#l47.493"></a><span id="l47.493">       EnsureMinimumNumberOfHeaders(gExpandedHeaderView);</span>
<a href="#l47.494"></a><span id="l47.494" class="difflineminus">-    showHeaderView(gExpandedHeaderView);</span>
<a href="#l47.495"></a><span id="l47.495" class="difflineminus">-  }</span>
<a href="#l47.496"></a><span id="l47.496" class="difflineplus">+  showHeaderView(gExpandedHeaderView);</span>
<a href="#l47.497"></a><span id="l47.497" class="difflineplus">+</span>
<a href="#l47.498"></a><span id="l47.498">   UpdateJunkButton();</span>
<a href="#l47.499"></a><span id="l47.499">   UpdateReplyButtons();</span>
<a href="#l47.500"></a><span id="l47.500">   displayAttachmentsForExpandedView();</span>
<a href="#l47.501"></a><span id="l47.501"> }</span>
<a href="#l47.502"></a><span id="l47.502"> </span>
<a href="#l47.503"></a><span id="l47.503" class="difflineminus">-function ToggleHeaderView ()</span>
<a href="#l47.504"></a><span id="l47.504" class="difflineminus">-{</span>
<a href="#l47.505"></a><span id="l47.505" class="difflineminus">-  gCollapsedHeaderViewMode = !gCollapsedHeaderViewMode;</span>
<a href="#l47.506"></a><span id="l47.506" class="difflineminus">-  // Work around a xul deck bug where the height of the deck is determined by the tallest panel in the deck</span>
<a href="#l47.507"></a><span id="l47.507" class="difflineminus">-  // even if that panel is not selected...</span>
<a href="#l47.508"></a><span id="l47.508" class="difflineminus">-  document.getElementById('msgHeaderViewDeck').selectedPanel.collapsed = true;</span>
<a href="#l47.509"></a><span id="l47.509" class="difflineminus">-  UpdateMessageHeaders();</span>
<a href="#l47.510"></a><span id="l47.510" class="difflineminus">-</span>
<a href="#l47.511"></a><span id="l47.511" class="difflineminus">-  // select the new panel.</span>
<a href="#l47.512"></a><span id="l47.512" class="difflineminus">-  document.getElementById('msgHeaderViewDeck').selectedIndex = gCollapsedHeaderViewMode ? 0 : 1;</span>
<a href="#l47.513"></a><span id="l47.513" class="difflineminus">-</span>
<a href="#l47.514"></a><span id="l47.514" class="difflineminus">-  // Work around a xul deck bug where the height of the deck is determined by the tallest panel in the deck</span>
<a href="#l47.515"></a><span id="l47.515" class="difflineminus">-  // even if that panel is not selected...</span>
<a href="#l47.516"></a><span id="l47.516" class="difflineminus">-  document.getElementById('msgHeaderViewDeck').selectedPanel.collapsed = false;</span>
<a href="#l47.517"></a><span id="l47.517" class="difflineminus">-}</span>
<a href="#l47.518"></a><span id="l47.518" class="difflineminus">-</span>
<a href="#l47.519"></a><span id="l47.519"> // default method for updating a header value into a header entry</span>
<a href="#l47.520"></a><span id="l47.520"> function updateHeaderValue(headerEntry, headerValue)</span>
<a href="#l47.521"></a><span id="l47.521"> {</span>
<a href="#l47.522"></a><span id="l47.522">   headerEntry.enclosingBox.headerValue = headerValue;</span>
<a href="#l47.523"></a><span id="l47.523"> }</span>
<a href="#l47.524"></a><span id="l47.524"> </span>
<a href="#l47.525"></a><span id="l47.525" class="difflineminus">-function updateHeaderValueInTextNode(headerEntry, headerValue)</span>
<a href="#l47.526"></a><span id="l47.526" class="difflineminus">-{</span>
<a href="#l47.527"></a><span id="l47.527" class="difflineminus">-  headerEntry.textNode.value = headerValue;</span>
<a href="#l47.528"></a><span id="l47.528" class="difflineminus">-}</span>
<a href="#l47.529"></a><span id="l47.529" class="difflineminus">-</span>
<a href="#l47.530"></a><span id="l47.530"> function createNewHeaderView(headerName, label)</span>
<a href="#l47.531"></a><span id="l47.531"> {</span>
<a href="#l47.532"></a><span id="l47.532">   var idName = 'expanded' + headerName + 'Box';</span>
<a href="#l47.533"></a><span id="l47.533">   var newHeader = document.createElement(&quot;mail-headerfield&quot;);</span>
<a href="#l47.534"></a><span id="l47.534"> </span>
<a href="#l47.535"></a><span id="l47.535">   newHeader.setAttribute('id', idName);</span>
<a href="#l47.536"></a><span id="l47.536">   newHeader.setAttribute('label', label);</span>
<a href="#l47.537"></a><span id="l47.537">   newHeader.setAttribute('flex', '1');</span>
<a href="#l47.538"></a><span id="l47.538" class="difflineat">@@ -853,136 +792,114 @@ function removeNewHeaderViews(aHeaderTab</span>
<a href="#l47.539"></a><span id="l47.539">   {</span>
<a href="#l47.540"></a><span id="l47.540">     var headerEntry = aHeaderTable[index];</span>
<a href="#l47.541"></a><span id="l47.541">     if (headerEntry.isNewHeader)</span>
<a href="#l47.542"></a><span id="l47.542">       headerEntry.enclosingBox.parentNode</span>
<a href="#l47.543"></a><span id="l47.543">                  .removeChild(headerEntry.enclosingBox);</span>
<a href="#l47.544"></a><span id="l47.544">   }</span>
<a href="#l47.545"></a><span id="l47.545"> }</span>
<a href="#l47.546"></a><span id="l47.546"> </span>
<a href="#l47.547"></a><span id="l47.547" class="difflineminus">-// UpdateMessageHeaders: Iterate through all the current header data we received from mime for this message</span>
<a href="#l47.548"></a><span id="l47.548" class="difflineminus">-// for each header entry table, see if we have a corresponding entry for that header. i.e. does the particular</span>
<a href="#l47.549"></a><span id="l47.549" class="difflineminus">-// view care about this header value. if it does then call updateHeaderEntry</span>
<a href="#l47.550"></a><span id="l47.550" class="difflineminus">-function UpdateMessageHeaders()</span>
<a href="#l47.551"></a><span id="l47.551" class="difflineminus">-{</span>
<a href="#l47.552"></a><span id="l47.552" class="difflineplus">+// UpdateExpandedMessageHeaders: Iterate through all the current header data</span>
<a href="#l47.553"></a><span id="l47.553" class="difflineplus">+// we received from mime for this message for the expanded header entry table,</span>
<a href="#l47.554"></a><span id="l47.554" class="difflineplus">+// and see if we have a corresponding entry for that header (i.e.</span>
<a href="#l47.555"></a><span id="l47.555" class="difflineplus">+// whether the expanded header view cares about this header value)</span>
<a href="#l47.556"></a><span id="l47.556" class="difflineplus">+// If so, then call updateHeaderEntry</span>
<a href="#l47.557"></a><span id="l47.557" class="difflineplus">+function UpdateExpandedMessageHeaders() {</span>
<a href="#l47.558"></a><span id="l47.558">   // iterate over each header we received and see if we have a matching entry in each</span>
<a href="#l47.559"></a><span id="l47.559">   // header view table...</span>
<a href="#l47.560"></a><span id="l47.560" class="difflineminus">-</span>
<a href="#l47.561"></a><span id="l47.561">   var headerName;</span>
<a href="#l47.562"></a><span id="l47.562"> </span>
<a href="#l47.563"></a><span id="l47.563">   // Remove the height attr so that it redraws correctly. Works around a problem that</span>
<a href="#l47.564"></a><span id="l47.564">   // attachment-splitter causes if it's moved high enough to affect the header box:</span>
<a href="#l47.565"></a><span id="l47.565">   document.getElementById('msgHeaderView').removeAttribute('height');</span>
<a href="#l47.566"></a><span id="l47.566"> </span>
<a href="#l47.567"></a><span id="l47.567" class="difflineminus">-  for (headerName in currentHeaderData)</span>
<a href="#l47.568"></a><span id="l47.568" class="difflineminus">-  {</span>
<a href="#l47.569"></a><span id="l47.569" class="difflineplus">+  for (headerName in currentHeaderData) {</span>
<a href="#l47.570"></a><span id="l47.570">     var headerField = currentHeaderData[headerName];</span>
<a href="#l47.571"></a><span id="l47.571">     var headerEntry = null;</span>
<a href="#l47.572"></a><span id="l47.572"> </span>
<a href="#l47.573"></a><span id="l47.573" class="difflineminus">-    if (headerName == &quot;subject&quot;)</span>
<a href="#l47.574"></a><span id="l47.574" class="difflineminus">-    {</span>
<a href="#l47.575"></a><span id="l47.575" class="difflineminus">-      try {</span>
<a href="#l47.576"></a><span id="l47.576" class="difflineminus">-        if (gDBView.keyForFirstSelectedMessage == nsMsgKey_None)</span>
<a href="#l47.577"></a><span id="l47.577" class="difflineminus">-        {</span>
<a href="#l47.578"></a><span id="l47.578" class="difflineminus">-          var folder = null;</span>
<a href="#l47.579"></a><span id="l47.579" class="difflineminus">-          if (gCurrentFolderUri)</span>
<a href="#l47.580"></a><span id="l47.580" class="difflineminus">-            folder = GetMsgFolderFromUri(gCurrentFolderUri);</span>
<a href="#l47.581"></a><span id="l47.581" class="difflineminus">-          setTitleFromFolder(folder, headerField.headerValue);</span>
<a href="#l47.582"></a><span id="l47.582" class="difflineminus">-        }</span>
<a href="#l47.583"></a><span id="l47.583" class="difflineminus">-      } catch (ex) {}</span>
<a href="#l47.584"></a><span id="l47.584" class="difflineplus">+    if (headerName in gExpandedHeaderView)</span>
<a href="#l47.585"></a><span id="l47.585" class="difflineplus">+        headerEntry = gExpandedHeaderView[headerName];</span>
<a href="#l47.586"></a><span id="l47.586" class="difflineplus">+</span>
<a href="#l47.587"></a><span id="l47.587" class="difflineplus">+    if (!headerEntry &amp;&amp; gViewAllHeaders) {</span>
<a href="#l47.588"></a><span id="l47.588" class="difflineplus">+      // for view all headers, if we don't have a header field for this</span>
<a href="#l47.589"></a><span id="l47.589" class="difflineplus">+      // value....cheat and create one....then fill in a headerEntry</span>
<a href="#l47.590"></a><span id="l47.590" class="difflineplus">+      if (headerName == &quot;message-id&quot; || headerName == &quot;in-reply-to&quot;) {</span>
<a href="#l47.591"></a><span id="l47.591" class="difflineplus">+        var messageIdEntry = {</span>
<a href="#l47.592"></a><span id="l47.592" class="difflineplus">+          name: headerName,</span>
<a href="#l47.593"></a><span id="l47.593" class="difflineplus">+          outputFunction: OutputMessageIds</span>
<a href="#l47.594"></a><span id="l47.594" class="difflineplus">+        };</span>
<a href="#l47.595"></a><span id="l47.595" class="difflineplus">+        gExpandedHeaderView[headerName] = new createHeaderEntry('expanded',</span>
<a href="#l47.596"></a><span id="l47.596" class="difflineplus">+                                                                messageIdEntry);</span>
<a href="#l47.597"></a><span id="l47.597" class="difflineplus">+      }</span>
<a href="#l47.598"></a><span id="l47.598" class="difflineplus">+      else {</span>
<a href="#l47.599"></a><span id="l47.599" class="difflineplus">+        gExpandedHeaderView[headerName] =</span>
<a href="#l47.600"></a><span id="l47.600" class="difflineplus">+          new createNewHeaderView(headerName,</span>
<a href="#l47.601"></a><span id="l47.601" class="difflineplus">+                                  currentHeaderData[headerName].headerName);</span>
<a href="#l47.602"></a><span id="l47.602" class="difflineplus">+      }</span>
<a href="#l47.603"></a><span id="l47.603" class="difflineplus">+</span>
<a href="#l47.604"></a><span id="l47.604" class="difflineplus">+      headerEntry = gExpandedHeaderView[headerName];</span>
<a href="#l47.605"></a><span id="l47.605">     }</span>
<a href="#l47.606"></a><span id="l47.606"> </span>
<a href="#l47.607"></a><span id="l47.607" class="difflineminus">-    if (gCollapsedHeaderViewMode &amp;&amp; !gBuiltCollapsedView)</span>
<a href="#l47.608"></a><span id="l47.608" class="difflineminus">-    {</span>
<a href="#l47.609"></a><span id="l47.609" class="difflineminus">-      if (headerName == &quot;cc&quot; || headerName == &quot;to&quot; || headerName == &quot;bcc&quot;)</span>
<a href="#l47.610"></a><span id="l47.610" class="difflineminus">-        headerEntry = gCollapsedHeaderView[&quot;toCcBcc&quot;];</span>
<a href="#l47.611"></a><span id="l47.611" class="difflineminus">-      else if (headerName in gCollapsedHeaderView)</span>
<a href="#l47.612"></a><span id="l47.612" class="difflineminus">-        headerEntry = gCollapsedHeaderView[headerName];</span>
<a href="#l47.613"></a><span id="l47.613" class="difflineminus">-    }</span>
<a href="#l47.614"></a><span id="l47.614" class="difflineminus">-    else if (!gCollapsedHeaderViewMode &amp;&amp; !gBuiltExpandedView)</span>
<a href="#l47.615"></a><span id="l47.615" class="difflineminus">-    {</span>
<a href="#l47.616"></a><span id="l47.616" class="difflineminus">-      if (headerName in gExpandedHeaderView)</span>
<a href="#l47.617"></a><span id="l47.617" class="difflineminus">-       headerEntry = gExpandedHeaderView[headerName];</span>
<a href="#l47.618"></a><span id="l47.618" class="difflineminus">-</span>
<a href="#l47.619"></a><span id="l47.619" class="difflineminus">-      if (!headerEntry &amp;&amp; gViewAllHeaders)</span>
<a href="#l47.620"></a><span id="l47.620" class="difflineminus">-      {</span>
<a href="#l47.621"></a><span id="l47.621" class="difflineminus">-        // for view all headers, if we don't have a header field for this value....cheat and create one....then</span>
<a href="#l47.622"></a><span id="l47.622" class="difflineminus">-        // fill in a headerEntry</span>
<a href="#l47.623"></a><span id="l47.623" class="difflineminus">-        if (headerName == &quot;message-id&quot; || headerName == &quot;in-reply-to&quot;)</span>
<a href="#l47.624"></a><span id="l47.624" class="difflineminus">-        {</span>
<a href="#l47.625"></a><span id="l47.625" class="difflineminus">-          var messageIdEntry = {name:headerName, outputFunction:OutputMessageIds};</span>
<a href="#l47.626"></a><span id="l47.626" class="difflineminus">-          gExpandedHeaderView[headerName] = new createHeaderEntry('expanded', messageIdEntry);</span>
<a href="#l47.627"></a><span id="l47.627" class="difflineminus">-        }</span>
<a href="#l47.628"></a><span id="l47.628" class="difflineminus">-        else</span>
<a href="#l47.629"></a><span id="l47.629" class="difflineminus">-        {</span>
<a href="#l47.630"></a><span id="l47.630" class="difflineminus">-          gExpandedHeaderView[headerName] = </span>
<a href="#l47.631"></a><span id="l47.631" class="difflineminus">-            new createNewHeaderView(headerName, </span>
<a href="#l47.632"></a><span id="l47.632" class="difflineminus">-                                    currentHeaderData[headerName].headerName);</span>
<a href="#l47.633"></a><span id="l47.633" class="difflineminus">-        }</span>
<a href="#l47.634"></a><span id="l47.634" class="difflineminus">-</span>
<a href="#l47.635"></a><span id="l47.635" class="difflineminus">-        headerEntry = gExpandedHeaderView[headerName];</span>
<a href="#l47.636"></a><span id="l47.636" class="difflineminus">-      }</span>
<a href="#l47.637"></a><span id="l47.637" class="difflineminus">-    } // if we are in expanded view....</span>
<a href="#l47.638"></a><span id="l47.638" class="difflineminus">-</span>
<a href="#l47.639"></a><span id="l47.639" class="difflineminus">-    if (headerEntry)</span>
<a href="#l47.640"></a><span id="l47.640" class="difflineminus">-    {</span>
<a href="#l47.641"></a><span id="l47.641" class="difflineplus">+    if (headerEntry) {</span>
<a href="#l47.642"></a><span id="l47.642">       if (headerName == &quot;references&quot; &amp;&amp;</span>
<a href="#l47.643"></a><span id="l47.643">           !(gViewAllHeaders || gHeadersShowReferences ||</span>
<a href="#l47.644"></a><span id="l47.644" class="difflineminus">-            (gDBView.msgFolder &amp;&amp; gDBView.msgFolder.server.type == &quot;nntp&quot;)))</span>
<a href="#l47.645"></a><span id="l47.645" class="difflineminus">-      {</span>
<a href="#l47.646"></a><span id="l47.646" class="difflineminus">-        // hide references header if view all headers mode isn't selected, the pref show references is</span>
<a href="#l47.647"></a><span id="l47.647" class="difflineminus">-        // deactivated and the currently displayed message isn't a newsgroup posting</span>
<a href="#l47.648"></a><span id="l47.648" class="difflineplus">+            gFolderDisplay.view.isNewsFolder)) {</span>
<a href="#l47.649"></a><span id="l47.649" class="difflineplus">+        // hide references header if view all headers mode isn't selected, the</span>
<a href="#l47.650"></a><span id="l47.650" class="difflineplus">+        // pref show references is deactivated and the currently displayed</span>
<a href="#l47.651"></a><span id="l47.651" class="difflineplus">+        // message isn't a newsgroup posting</span>
<a href="#l47.652"></a><span id="l47.652">         headerEntry.valid = false;</span>
<a href="#l47.653"></a><span id="l47.653">       }</span>
<a href="#l47.654"></a><span id="l47.654">       else</span>
<a href="#l47.655"></a><span id="l47.655">       {</span>
<a href="#l47.656"></a><span id="l47.656">         headerEntry.outputFunction(headerEntry, headerField.headerValue);</span>
<a href="#l47.657"></a><span id="l47.657">         headerEntry.valid = true;</span>
<a href="#l47.658"></a><span id="l47.658">       }</span>
<a href="#l47.659"></a><span id="l47.659">     }</span>
<a href="#l47.660"></a><span id="l47.660">   }</span>
<a href="#l47.661"></a><span id="l47.661"> </span>
<a href="#l47.662"></a><span id="l47.662" class="difflineminus">-  if (gCollapsedHeaderViewMode)</span>
<a href="#l47.663"></a><span id="l47.663" class="difflineminus">-   gBuiltCollapsedView = true;</span>
<a href="#l47.664"></a><span id="l47.664" class="difflineminus">-  else</span>
<a href="#l47.665"></a><span id="l47.665" class="difflineminus">-   gBuiltExpandedView = true;</span>
<a href="#l47.666"></a><span id="l47.666" class="difflineplus">+  gBuiltExpandedView = true;</span>
<a href="#l47.667"></a><span id="l47.667"> </span>
<a href="#l47.668"></a><span id="l47.668">   // now update the view to make sure the right elements are visible</span>
<a href="#l47.669"></a><span id="l47.669" class="difflineminus">-  updateHeaderViews();</span>
<a href="#l47.670"></a><span id="l47.670" class="difflineplus">+  updateExpandedView();</span>
<a href="#l47.671"></a><span id="l47.671"> }</span>
<a href="#l47.672"></a><span id="l47.672"> </span>
<a href="#l47.673"></a><span id="l47.673"> function ClearCurrentHeaders()</span>
<a href="#l47.674"></a><span id="l47.674"> {</span>
<a href="#l47.675"></a><span id="l47.675">   currentHeaderData = {};</span>
<a href="#l47.676"></a><span id="l47.676">   currentAttachments = new Array();</span>
<a href="#l47.677"></a><span id="l47.677"> }</span>
<a href="#l47.678"></a><span id="l47.678"> </span>
<a href="#l47.679"></a><span id="l47.679"> function ShowMessageHeaderPane()</span>
<a href="#l47.680"></a><span id="l47.680"> {</span>
<a href="#l47.681"></a><span id="l47.681">   document.getElementById('msgHeaderView').collapsed = false;</span>
<a href="#l47.682"></a><span id="l47.682"> </span>
<a href="#l47.683"></a><span id="l47.683" class="difflineminus">-  /* workaround for 39655 */</span>
<a href="#l47.684"></a><span id="l47.684" class="difflineminus">-  if (gFolderJustSwitched)</span>
<a href="#l47.685"></a><span id="l47.685" class="difflineminus">-  {</span>
<a href="#l47.686"></a><span id="l47.686" class="difflineminus">-    var el = document.getElementById(&quot;msgHeaderView&quot;);</span>
<a href="#l47.687"></a><span id="l47.687" class="difflineminus">-    el.setAttribute(&quot;style&quot;, el.getAttribute(&quot;style&quot;));</span>
<a href="#l47.688"></a><span id="l47.688" class="difflineminus">-    gFolderJustSwitched = false;</span>
<a href="#l47.689"></a><span id="l47.689" class="difflineminus">-  }</span>
<a href="#l47.690"></a><span id="l47.690" class="difflineplus">+  // We used to do this as a work-around for long-ago bug 39655</span>
<a href="#l47.691"></a><span id="l47.691" class="difflineplus">+  // there apparently was a layout bug where the message pane</span>
<a href="#l47.692"></a><span id="l47.692" class="difflineplus">+  // 'toolbar' was being hidden as a result of the folder change,</span>
<a href="#l47.693"></a><span id="l47.693" class="difflineplus">+  // then re-shown, but the layout would glitch and not show it.</span>
<a href="#l47.694"></a><span id="l47.694" class="difflineplus">+  // As much as I love cargo-culting, I am commenting this out</span>
<a href="#l47.695"></a><span id="l47.695" class="difflineplus">+  // because I have great respect for our layout ninjas and little</span>
<a href="#l47.696"></a><span id="l47.696" class="difflineplus">+  // respect for random global variables such as the one that</span>
<a href="#l47.697"></a><span id="l47.697" class="difflineplus">+  // controlled this.</span>
<a href="#l47.698"></a><span id="l47.698" class="difflineplus">+  //</span>
<a href="#l47.699"></a><span id="l47.699" class="difflineplus">+  //var el = document.getElementById(&quot;msgHeaderView&quot;);</span>
<a href="#l47.700"></a><span id="l47.700" class="difflineplus">+  //el.setAttribute(&quot;style&quot;, el.getAttribute(&quot;style&quot;));</span>
<a href="#l47.701"></a><span id="l47.701" class="difflineplus">+  //</span>
<a href="#l47.702"></a><span id="l47.702"> }</span>
<a href="#l47.703"></a><span id="l47.703"> </span>
<a href="#l47.704"></a><span id="l47.704"> function HideMessageHeaderPane()</span>
<a href="#l47.705"></a><span id="l47.705"> {</span>
<a href="#l47.706"></a><span id="l47.706">   document.getElementById('msgHeaderView').collapsed = true;</span>
<a href="#l47.707"></a><span id="l47.707"> </span>
<a href="#l47.708"></a><span id="l47.708">   // disable the File/Attachments menuitem</span>
<a href="#l47.709"></a><span id="l47.709">   document.getElementById(&quot;fileAttachmentMenu&quot;).setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l47.710"></a><span id="l47.710">   // disable the attachment box</span>
<a href="#l47.711"></a><span id="l47.711">   document.getElementById(&quot;attachmentView&quot;).collapsed = true;</span>
<a href="#l47.712"></a><span id="l47.712">   document.getElementById(&quot;attachment-splitter&quot;).collapsed = true;</span>
<a href="#l47.713"></a><span id="l47.713" class="difflineminus">-  </span>
<a href="#l47.714"></a><span id="l47.714" class="difflineplus">+</span>
<a href="#l47.715"></a><span id="l47.715">   ClearEditMessageBox();</span>
<a href="#l47.716"></a><span id="l47.716"> }</span>
<a href="#l47.717"></a><span id="l47.717"> </span>
<a href="#l47.718"></a><span id="l47.718"> function OutputNewsgroups(headerEntry, headerValue)</span>
<a href="#l47.719"></a><span id="l47.719"> {</span>
<a href="#l47.720"></a><span id="l47.720">   headerValue = headerValue.replace(/,/g,&quot;, &quot;);</span>
<a href="#l47.721"></a><span id="l47.721">   updateHeaderValue(headerEntry, headerValue);</span>
<a href="#l47.722"></a><span id="l47.722"> }</span>
<a href="#l47.723"></a><span id="l47.723" class="difflineat">@@ -1108,22 +1025,22 @@ function UpdateEmailNodeDetails(aEmailAd</span>
<a href="#l47.724"></a><span id="l47.724">                                    getCardForEmail(aEmailAddress);</span>
<a href="#l47.725"></a><span id="l47.725">   var displayName = null;</span>
<a href="#l47.726"></a><span id="l47.726"> </span>
<a href="#l47.727"></a><span id="l47.727">   aDocumentNode.cardDetails = cardDetails;</span>
<a href="#l47.728"></a><span id="l47.728"> </span>
<a href="#l47.729"></a><span id="l47.729">   if (cardDetails.card) {</span>
<a href="#l47.730"></a><span id="l47.730">     displayName = cardDetails.card.displayName;</span>
<a href="#l47.731"></a><span id="l47.731">     aDocumentNode.setAttribute(&quot;hascard&quot;, &quot;true&quot;);</span>
<a href="#l47.732"></a><span id="l47.732" class="difflineminus">-    aDocumentNode.setAttribute(&quot;tooltipstar&quot;, </span>
<a href="#l47.733"></a><span id="l47.733" class="difflineplus">+    aDocumentNode.setAttribute(&quot;tooltipstar&quot;,</span>
<a href="#l47.734"></a><span id="l47.734">                                document.getElementById(&quot;editContactItem&quot;).label);</span>
<a href="#l47.735"></a><span id="l47.735">   }</span>
<a href="#l47.736"></a><span id="l47.736">   else {</span>
<a href="#l47.737"></a><span id="l47.737">     aDocumentNode.setAttribute(&quot;hascard&quot;, &quot;false&quot;);</span>
<a href="#l47.738"></a><span id="l47.738" class="difflineminus">-    aDocumentNode.setAttribute(&quot;tooltipstar&quot;, </span>
<a href="#l47.739"></a><span id="l47.739" class="difflineplus">+    aDocumentNode.setAttribute(&quot;tooltipstar&quot;,</span>
<a href="#l47.740"></a><span id="l47.740">                                document.getElementById(&quot;addToAddressBookItem&quot;).label);</span>
<a href="#l47.741"></a><span id="l47.741">   }</span>
<a href="#l47.742"></a><span id="l47.742"> </span>
<a href="#l47.743"></a><span id="l47.743">   // When we are adding cards, we don't want to move the display around if the</span>
<a href="#l47.744"></a><span id="l47.744">   // user has clicked on the star, therefore if it is locked, just exit and</span>
<a href="#l47.745"></a><span id="l47.745">   // leave the display updates until later.</span>
<a href="#l47.746"></a><span id="l47.746">   if (aDocumentNode.hasAttribute(&quot;updatingUI&quot;))</span>
<a href="#l47.747"></a><span id="l47.747">     return;</span>
<a href="#l47.748"></a><span id="l47.748" class="difflineat">@@ -1205,17 +1122,17 @@ function UpdateExtraAddressProcessing(aA</span>
<a href="#l47.749"></a><span id="l47.749"> </span>
<a href="#l47.750"></a><span id="l47.750"> function findEmailNodeFromPopupNode(elt, popup)</span>
<a href="#l47.751"></a><span id="l47.751"> {</span>
<a href="#l47.752"></a><span id="l47.752">   // This annoying little function is needed because in the binding for</span>
<a href="#l47.753"></a><span id="l47.753">   // mail-emailaddress, we set the context on the &lt;description&gt;, but that if</span>
<a href="#l47.754"></a><span id="l47.754">   // the user clicks on the label, then popupNode is set to it, rather than</span>
<a href="#l47.755"></a><span id="l47.755">   // the description.  So we have walk up the parent until we find the</span>
<a href="#l47.756"></a><span id="l47.756">   // element with the popup set, and then return its parent.</span>
<a href="#l47.757"></a><span id="l47.757" class="difflineminus">-  </span>
<a href="#l47.758"></a><span id="l47.758" class="difflineplus">+</span>
<a href="#l47.759"></a><span id="l47.759">   while (elt.getAttribute(&quot;popup&quot;) != popup)</span>
<a href="#l47.760"></a><span id="l47.760">   {</span>
<a href="#l47.761"></a><span id="l47.761">     elt = elt.parentNode;</span>
<a href="#l47.762"></a><span id="l47.762">     if (elt == null)</span>
<a href="#l47.763"></a><span id="l47.763">       return null;</span>
<a href="#l47.764"></a><span id="l47.764">   }</span>
<a href="#l47.765"></a><span id="l47.765">   return elt.parentNode;</span>
<a href="#l47.766"></a><span id="l47.766"> }</span>
<a href="#l47.767"></a><span id="l47.767" class="difflineat">@@ -1292,16 +1209,29 @@ function onClickEmailStar(event, emailAd</span>
<a href="#l47.768"></a><span id="l47.768"> </span>
<a href="#l47.769"></a><span id="l47.769">   if (emailAddressNode &amp;&amp; emailAddressNode.cardDetails &amp;&amp;</span>
<a href="#l47.770"></a><span id="l47.770">       emailAddressNode.cardDetails.card)</span>
<a href="#l47.771"></a><span id="l47.771">     EditContact(emailAddressNode);</span>
<a href="#l47.772"></a><span id="l47.772">   else</span>
<a href="#l47.773"></a><span id="l47.773">     AddContact(emailAddressNode);</span>
<a href="#l47.774"></a><span id="l47.774"> }</span>
<a href="#l47.775"></a><span id="l47.775"> </span>
<a href="#l47.776"></a><span id="l47.776" class="difflineplus">+/**</span>
<a href="#l47.777"></a><span id="l47.777" class="difflineplus">+ * @return the DOM node for the header-view-button-box in the currently</span>
<a href="#l47.778"></a><span id="l47.778" class="difflineplus">+ * selected panel of the message header</span>
<a href="#l47.779"></a><span id="l47.779" class="difflineplus">+ *</span>
<a href="#l47.780"></a><span id="l47.780" class="difflineplus">+ * @note that this assumes that the first such button box is the only one</span>
<a href="#l47.781"></a><span id="l47.781" class="difflineplus">+ * worth caring about (having more than one per panel is not supported).</span>
<a href="#l47.782"></a><span id="l47.782" class="difflineplus">+ */</span>
<a href="#l47.783"></a><span id="l47.783" class="difflineplus">+function getCurrentMsgHdrButtonBox() {</span>
<a href="#l47.784"></a><span id="l47.784" class="difflineplus">+</span>
<a href="#l47.785"></a><span id="l47.785" class="difflineplus">+  return document.getElementById('msgHeaderViewDeck').selectedPanel</span>
<a href="#l47.786"></a><span id="l47.786" class="difflineplus">+                 .getElementsByTagName(&quot;header-view-button-box&quot;).item(0);</span>
<a href="#l47.787"></a><span id="l47.787" class="difflineplus">+}</span>
<a href="#l47.788"></a><span id="l47.788" class="difflineplus">+</span>
<a href="#l47.789"></a><span id="l47.789"> function AddContact(emailAddressNode)</span>
<a href="#l47.790"></a><span id="l47.790"> {</span>
<a href="#l47.791"></a><span id="l47.791">   if (emailAddressNode) {</span>
<a href="#l47.792"></a><span id="l47.792">     // When we collect an address, it updates the AB which sends out</span>
<a href="#l47.793"></a><span id="l47.793">     // notifications to update the UI. In the add case we don't want to update</span>
<a href="#l47.794"></a><span id="l47.794">     // the UI so that accidentally double-clicking on the star doesn't lead</span>
<a href="#l47.795"></a><span id="l47.795">     // to something strange (i.e star would be moved out from underneath,</span>
<a href="#l47.796"></a><span id="l47.796">     // leaving something else there).</span>
<a href="#l47.797"></a><span id="l47.797" class="difflineat">@@ -1412,18 +1342,18 @@ function detachAttachment(aAttachment, a</span>
<a href="#l47.798"></a><span id="l47.798"> }</span>
<a href="#l47.799"></a><span id="l47.799"> </span>
<a href="#l47.800"></a><span id="l47.800"> /**</span>
<a href="#l47.801"></a><span id="l47.801">  * Return true if possible attachments in the currently loaded message can be</span>
<a href="#l47.802"></a><span id="l47.802">  * deleted/detached.</span>
<a href="#l47.803"></a><span id="l47.803">  */</span>
<a href="#l47.804"></a><span id="l47.804"> function CanDetachAttachments()</span>
<a href="#l47.805"></a><span id="l47.805"> {</span>
<a href="#l47.806"></a><span id="l47.806" class="difflineminus">-  var uri = GetLoadedMessage();</span>
<a href="#l47.807"></a><span id="l47.807" class="difflineminus">-  var canDetach = !IsNewsMessage(uri) &amp;&amp; (!IsImapMessage(uri) || MailOfflineMgr.isOnline());</span>
<a href="#l47.808"></a><span id="l47.808" class="difflineplus">+  var canDetach = !gFolderDisplay.selectedMessageIsNews &amp;&amp;</span>
<a href="#l47.809"></a><span id="l47.809" class="difflineplus">+                  (!gFolderDisplay.selectedMessageIsImap || MailOfflineMgr.isOnline());</span>
<a href="#l47.810"></a><span id="l47.810">   if (canDetach &amp;&amp; (&quot;content-type&quot; in currentHeaderData))</span>
<a href="#l47.811"></a><span id="l47.811">     canDetach = !ContentTypeIsSMIME(currentHeaderData[&quot;content-type&quot;].headerValue);</span>
<a href="#l47.812"></a><span id="l47.812">   return canDetach;</span>
<a href="#l47.813"></a><span id="l47.813"> }</span>
<a href="#l47.814"></a><span id="l47.814"> </span>
<a href="#l47.815"></a><span id="l47.815"> /** Return true if the content type is an S/MIME one. */</span>
<a href="#l47.816"></a><span id="l47.816"> function ContentTypeIsSMIME(contentType)</span>
<a href="#l47.817"></a><span id="l47.817"> {</span>
<a href="#l47.818"></a><span id="l47.818" class="difflineat">@@ -1860,25 +1790,19 @@ function ClearAttachmentList()</span>
<a href="#l47.819"></a><span id="l47.819"> </span>
<a href="#l47.820"></a><span id="l47.820">   while (list.hasChildNodes())</span>
<a href="#l47.821"></a><span id="l47.821">     list.removeChild(list.lastChild);</span>
<a href="#l47.822"></a><span id="l47.822"> }</span>
<a href="#l47.823"></a><span id="l47.823"> </span>
<a href="#l47.824"></a><span id="l47.824"> function ShowEditMessageBox()</span>
<a href="#l47.825"></a><span id="l47.825"> {</span>
<a href="#l47.826"></a><span id="l47.826">   // it would be nice if we passed in the msgHdr from the back end</span>
<a href="#l47.827"></a><span id="l47.827" class="difflineminus">-  var msgHdr;</span>
<a href="#l47.828"></a><span id="l47.828" class="difflineminus">-  try</span>
<a href="#l47.829"></a><span id="l47.829" class="difflineminus">-  {</span>
<a href="#l47.830"></a><span id="l47.830" class="difflineminus">-    msgHdr = gDBView.hdrForFirstSelectedMessage;</span>
<a href="#l47.831"></a><span id="l47.831" class="difflineminus">-  }</span>
<a href="#l47.832"></a><span id="l47.832" class="difflineminus">-  catch (ex)</span>
<a href="#l47.833"></a><span id="l47.833" class="difflineminus">-  {</span>
<a href="#l47.834"></a><span id="l47.834" class="difflineplus">+  var msgHdr = gFolderDisplay.selectedMessage;</span>
<a href="#l47.835"></a><span id="l47.835" class="difflineplus">+  if (!msgHdr &amp;&amp; !msgHdr.folder)</span>
<a href="#l47.836"></a><span id="l47.836">     return;</span>
<a href="#l47.837"></a><span id="l47.837" class="difflineminus">-  }</span>
<a href="#l47.838"></a><span id="l47.838">   const nsMsgFolderFlags = Components.interfaces.nsMsgFolderFlags;</span>
<a href="#l47.839"></a><span id="l47.839">   if (IsSpecialFolder(msgHdr.folder, nsMsgFolderFlags.Drafts, true))</span>
<a href="#l47.840"></a><span id="l47.840">     document.getElementById(&quot;editMessageBox&quot;).collapsed = false;</span>
<a href="#l47.841"></a><span id="l47.841"> }</span>
<a href="#l47.842"></a><span id="l47.842"> </span>
<a href="#l47.843"></a><span id="l47.843"> function ClearEditMessageBox()</span>
<a href="#l47.844"></a><span id="l47.844"> {</span>
<a href="#l47.845"></a><span id="l47.845">   var editBox = document.getElementById(&quot;editMessageBox&quot;);</span>
<a href="#l47.846"></a><span id="l47.846" class="difflineat">@@ -1987,22 +1911,39 @@ nsFlavorDataProvider.prototype =</span>
<a href="#l47.847"></a><span id="l47.847"> </span>
<a href="#l47.848"></a><span id="l47.848"> function nsDummyMsgHeader()</span>
<a href="#l47.849"></a><span id="l47.849"> {</span>
<a href="#l47.850"></a><span id="l47.850"> }</span>
<a href="#l47.851"></a><span id="l47.851"> </span>
<a href="#l47.852"></a><span id="l47.852"> nsDummyMsgHeader.prototype =</span>
<a href="#l47.853"></a><span id="l47.853"> {</span>
<a href="#l47.854"></a><span id="l47.854">   mProperties : new Array,</span>
<a href="#l47.855"></a><span id="l47.855" class="difflineminus">-  getStringProperty : function(property) {return this.mProperties[property];},</span>
<a href="#l47.856"></a><span id="l47.856" class="difflineminus">-  setStringProperty : function(property, val) {this.mProperties[property] = val;},</span>
<a href="#l47.857"></a><span id="l47.857" class="difflineplus">+  getStringProperty : function(aProperty) {</span>
<a href="#l47.858"></a><span id="l47.858" class="difflineplus">+    if (aProperty in this.mProperties)</span>
<a href="#l47.859"></a><span id="l47.859" class="difflineplus">+      return this.mProperties[property];</span>
<a href="#l47.860"></a><span id="l47.860" class="difflineplus">+    return &quot;&quot;;</span>
<a href="#l47.861"></a><span id="l47.861" class="difflineplus">+  },</span>
<a href="#l47.862"></a><span id="l47.862" class="difflineplus">+  setStringProperty : function(aProperty, aVal) {</span>
<a href="#l47.863"></a><span id="l47.863" class="difflineplus">+    this.mProperties[aProperty] = aVal;</span>
<a href="#l47.864"></a><span id="l47.864" class="difflineplus">+  },</span>
<a href="#l47.865"></a><span id="l47.865" class="difflineplus">+  getUint32Property : function(aProperty) {</span>
<a href="#l47.866"></a><span id="l47.866" class="difflineplus">+    if (aProperty in this.mProperties)</span>
<a href="#l47.867"></a><span id="l47.867" class="difflineplus">+      return parseInt(this.mProperties[aProperty]);</span>
<a href="#l47.868"></a><span id="l47.868" class="difflineplus">+    return 0;</span>
<a href="#l47.869"></a><span id="l47.869" class="difflineplus">+  },</span>
<a href="#l47.870"></a><span id="l47.870" class="difflineplus">+  setUint32Property: function(aProperty, aVal) {</span>
<a href="#l47.871"></a><span id="l47.871" class="difflineplus">+    this.mProperties[aProperty] = aVal.toString();</span>
<a href="#l47.872"></a><span id="l47.872" class="difflineplus">+  },</span>
<a href="#l47.873"></a><span id="l47.873">   markHasAttachments : function(hasAttachments) {},</span>
<a href="#l47.874"></a><span id="l47.874">   messageSize : 0,</span>
<a href="#l47.875"></a><span id="l47.875">   recipients : null,</span>
<a href="#l47.876"></a><span id="l47.876">   from : null,</span>
<a href="#l47.877"></a><span id="l47.877">   subject : null,</span>
<a href="#l47.878"></a><span id="l47.878" class="difflineplus">+  get mime2DecodedSubject() { return this.subject; },</span>
<a href="#l47.879"></a><span id="l47.879">   ccList : null,</span>
<a href="#l47.880"></a><span id="l47.880">   listPost : null,</span>
<a href="#l47.881"></a><span id="l47.881">   messageId : null,</span>
<a href="#l47.882"></a><span id="l47.882">   accountKey : &quot;&quot;,</span>
<a href="#l47.883"></a><span id="l47.883" class="difflineplus">+  // if you change us to return a fake folder, please update</span>
<a href="#l47.884"></a><span id="l47.884" class="difflineplus">+  // folderDisplay.js's FolderDisplayWidget's selectedMessageIsExternal getter.</span>
<a href="#l47.885"></a><span id="l47.885">   folder : null</span>
<a href="#l47.886"></a><span id="l47.886"> };</span>
<a href="#l47.887"></a><span id="l47.887"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l48.1"></a><span id="l48.1" class="difflineminus">--- a/mail/base/content/msgHdrViewOverlay.xul</span>
<a href="#l48.2"></a><span id="l48.2" class="difflineplus">+++ b/mail/base/content/msgHdrViewOverlay.xul</span>
<a href="#l48.3"></a><span id="l48.3" class="difflineat">@@ -92,54 +92,19 @@</span>
<a href="#l48.4"></a><span id="l48.4">     accesskey=&quot;&amp;deleteAllAttachmentsCmd.accesskey;&quot; oncommand=&quot;HandleAllAttachments('delete');&quot; /&gt;</span>
<a href="#l48.5"></a><span id="l48.5"> &lt;/popup&gt;</span>
<a href="#l48.6"></a><span id="l48.6"> </span>
<a href="#l48.7"></a><span id="l48.7"> &lt;popup id=&quot;copyUrlPopup&quot; popupanchor=&quot;bottomleft&quot;&gt;</span>
<a href="#l48.8"></a><span id="l48.8">   &lt;menuitem label=&quot;&amp;copyLinkCmd.label;&quot; accesskey=&quot;&amp;copyLinkCmd.accesskey;&quot; oncommand=&quot;CopyWebsiteAddress(document.popupNode)&quot;/&gt;</span>
<a href="#l48.9"></a><span id="l48.9"> &lt;/popup&gt;</span>
<a href="#l48.10"></a><span id="l48.10"> </span>
<a href="#l48.11"></a><span id="l48.11"> &lt;hbox id=&quot;msgHeaderView&quot; collapsed=&quot;true&quot; class=&quot;main-header-area&quot;&gt;</span>
<a href="#l48.12"></a><span id="l48.12" class="difflineminus">-  &lt;deck id=&quot;msgHeaderViewDeck&quot; persist=&quot;selectedIndex&quot; selectedIndex=&quot;1&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l48.13"></a><span id="l48.13" class="difflineminus">-    &lt;!-- the message pane consists of 4 'boxes'. Box #1 is a grid, showing a brief view of the headers --&gt;</span>
<a href="#l48.14"></a><span id="l48.14" class="difflineminus">-    &lt;vbox id=&quot;collapsedHeaderView&quot; class=&quot;header-part1 headerContainer&quot; flex=&quot;1&quot; pack=&quot;start&quot;&gt;</span>
<a href="#l48.15"></a><span id="l48.15" class="difflineminus">-      &lt;hbox align=&quot;start&quot;&gt;</span>
<a href="#l48.16"></a><span id="l48.16" class="difflineminus">-        &lt;hbox id=&quot;collapsedfromBox&quot; align=&quot;center&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l48.17"></a><span id="l48.17" class="difflineminus">-            &lt;mail-multi-emailHeaderField id=&quot;collapsedfromValue&quot;</span>
<a href="#l48.18"></a><span id="l48.18" class="difflineminus">-                                         class=&quot;collapsedHeaderDisplayName&quot;</span>
<a href="#l48.19"></a><span id="l48.19" class="difflineminus">-                                         label=&quot;&amp;fromField2.label;&quot;/&gt;</span>
<a href="#l48.20"></a><span id="l48.20" class="difflineminus">-        &lt;/hbox&gt;</span>
<a href="#l48.21"></a><span id="l48.21" class="difflineminus">-        &lt;header-view-button-box id=&quot;collapsedButtonBox&quot;/&gt;</span>
<a href="#l48.22"></a><span id="l48.22" class="difflineminus">-      &lt;/hbox&gt;</span>
<a href="#l48.23"></a><span id="l48.23" class="difflineminus">-</span>
<a href="#l48.24"></a><span id="l48.24" class="difflineminus">-      &lt;hbox align=&quot;baseline&quot;&gt;</span>
<a href="#l48.25"></a><span id="l48.25" class="difflineminus">-        &lt;hbox id=&quot;collapsedsubjectBox&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l48.26"></a><span id="l48.26" class="difflineminus">-          &lt;textbox id=&quot;collapsedsubjectValue&quot; flex=&quot;1&quot; readonly=&quot;true&quot;</span>
<a href="#l48.27"></a><span id="l48.27" class="difflineminus">-                   class=&quot;collapsedHeaderValue plain&quot;/&gt;</span>
<a href="#l48.28"></a><span id="l48.28" class="difflineminus">-        &lt;/hbox&gt;</span>
<a href="#l48.29"></a><span id="l48.29" class="difflineminus">-        &lt;hbox id=&quot;collapseddateBox&quot; flex=&quot;0&quot;&gt;</span>
<a href="#l48.30"></a><span id="l48.30" class="difflineminus">-          &lt;textbox id=&quot;collapseddateValue&quot; class=&quot;plain collapsedHeaderValue&quot;</span>
<a href="#l48.31"></a><span id="l48.31" class="difflineminus">-                   flex=&quot;0&quot; readonly=&quot;true&quot;/&gt;</span>
<a href="#l48.32"></a><span id="l48.32" class="difflineminus">-        &lt;/hbox&gt;</span>
<a href="#l48.33"></a><span id="l48.33" class="difflineminus">-      &lt;/hbox&gt;</span>
<a href="#l48.34"></a><span id="l48.34" class="difflineminus">-</span>
<a href="#l48.35"></a><span id="l48.35" class="difflineminus">-      &lt;hbox flex=&quot;1&quot; align=&quot;center&quot;&gt;</span>
<a href="#l48.36"></a><span id="l48.36" class="difflineminus">-        &lt;hbox id=&quot;collapsedtoCcBccBox&quot;</span>
<a href="#l48.37"></a><span id="l48.37" class="difflineminus">-              align=&quot;center&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l48.38"></a><span id="l48.38" class="difflineminus">-          &lt;mail-multi-emailHeaderField id=&quot;collapsedtoCcBccValue&quot;</span>
<a href="#l48.39"></a><span id="l48.39" class="difflineminus">-                                       flex=&quot;1&quot;</span>
<a href="#l48.40"></a><span id="l48.40" class="difflineminus">-                                       align=&quot;baseline&quot;</span>
<a href="#l48.41"></a><span id="l48.41" class="difflineminus">-                                       class=&quot;collapsedHeaderDisplayName&quot;/&gt;</span>
<a href="#l48.42"></a><span id="l48.42" class="difflineminus">-        &lt;/hbox&gt;</span>
<a href="#l48.43"></a><span id="l48.43" class="difflineminus">-        &lt;button id=&quot;showDetailsButton&quot;</span>
<a href="#l48.44"></a><span id="l48.44" class="difflineminus">-                tooltiptext=&quot;&amp;showDetailsButton.label;&quot;</span>
<a href="#l48.45"></a><span id="l48.45" class="difflineminus">-                onclick=&quot;ToggleHeaderView();&quot;</span>
<a href="#l48.46"></a><span id="l48.46" class="difflineminus">-                class=&quot;msgHeaderView-button msgHeaderView-flat-button&quot;/&gt;</span>
<a href="#l48.47"></a><span id="l48.47" class="difflineminus">-      &lt;/hbox&gt;</span>
<a href="#l48.48"></a><span id="l48.48" class="difflineminus">-    &lt;/vbox&gt;</span>
<a href="#l48.49"></a><span id="l48.49" class="difflineminus">-</span>
<a href="#l48.50"></a><span id="l48.50" class="difflineplus">+  &lt;deck id=&quot;msgHeaderViewDeck&quot; selectedIndex=&quot;0&quot; </span>
<a href="#l48.51"></a><span id="l48.51" class="difflineplus">+	      persist=&quot;selectedIndex&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l48.52"></a><span id="l48.52" class="difflineplus">+  </span>
<a href="#l48.53"></a><span id="l48.53">     &lt;!-- the message pane consists of 3 'boxes'. Box #2 is the expanded headers view (the default view) --&gt;</span>
<a href="#l48.54"></a><span id="l48.54">     &lt;hbox id=&quot;expandedHeaderView&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l48.55"></a><span id="l48.55"> </span>
<a href="#l48.56"></a><span id="l48.56">       &lt;!--  XXX this should switch to using &lt;grid&gt; for expandedHeaders to get</span>
<a href="#l48.57"></a><span id="l48.57">             away from gross historical CSS pseudo-boxery used for header</span>
<a href="#l48.58"></a><span id="l48.58">             name positioning --&gt;</span>
<a href="#l48.59"></a><span id="l48.59">       &lt;vbox id=&quot;expandedHeaders&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l48.60"></a><span id="l48.60"> </span>
<a href="#l48.61"></a><span id="l48.61" class="difflineat">@@ -212,29 +177,26 @@</span>
<a href="#l48.62"></a><span id="l48.62">             &lt;mail-urlfield id=&quot;expandedcontent-baseBox&quot;</span>
<a href="#l48.63"></a><span id="l48.63">                            label=&quot;&amp;originalWebsite2.label;&quot; collapsed=&quot;true&quot;/&gt;</span>
<a href="#l48.64"></a><span id="l48.64">             &lt;mail-headerfield id=&quot;expandeduser-agentBox&quot;</span>
<a href="#l48.65"></a><span id="l48.65">                               label=&quot;&amp;userAgentField2.label;&quot;</span>
<a href="#l48.66"></a><span id="l48.66">                               collapsed=&quot;true&quot;/&gt;</span>
<a href="#l48.67"></a><span id="l48.67">           &lt;/vbox&gt;</span>
<a href="#l48.68"></a><span id="l48.68"> </span>
<a href="#l48.69"></a><span id="l48.69">           &lt;!-- perhaps this should be a customizable toolbar too --&gt;</span>
<a href="#l48.70"></a><span id="l48.70" class="difflineminus">-          &lt;vbox id=&quot;hideDetailsBox&quot; align=&quot;end&quot;&gt;</span>
<a href="#l48.71"></a><span id="l48.71" class="difflineminus">-            &lt;spacer flex=&quot;1&quot;/&gt;</span>
<a href="#l48.72"></a><span id="l48.72" class="difflineminus">-            &lt;button id=&quot;hideDetailsButton&quot; label=&quot;&amp;hideDetailsButton.label;&quot;</span>
<a href="#l48.73"></a><span id="l48.73" class="difflineminus">-                    onclick=&quot;ToggleHeaderView();&quot;</span>
<a href="#l48.74"></a><span id="l48.74" class="difflineminus">-                    class=&quot;msgHeaderView-button msgHeaderView-flat-button&quot;/&gt;</span>
<a href="#l48.75"></a><span id="l48.75" class="difflineplus">+          &lt;vbox id=&quot;otherActionsBox&quot; align=&quot;end&quot;&gt;</span>
<a href="#l48.76"></a><span id="l48.76" class="difflineplus">+            &lt;spacer id=&quot;otherActionsTopSpacer&quot; flex=&quot;1&quot;/&gt;</span>
<a href="#l48.77"></a><span id="l48.77">             &lt;button type=&quot;menu&quot; id=&quot;otherActionsButton&quot;</span>
<a href="#l48.78"></a><span id="l48.78">                     label=&quot;&amp;otherActionsButton.label;&quot;</span>
<a href="#l48.79"></a><span id="l48.79">                     class=&quot;msgHeaderView-button msgHeaderView-flat-button&quot;&gt;</span>
<a href="#l48.80"></a><span id="l48.80">               &lt;menupopup id=&quot;otherActionsPopup&quot;&gt;</span>
<a href="#l48.81"></a><span id="l48.81">                 &lt;menuitem id=&quot;viewSourceMenuItem&quot;</span>
<a href="#l48.82"></a><span id="l48.82">                           label=&quot;&amp;viewSourceMenuItem.label;&quot;</span>
<a href="#l48.83"></a><span id="l48.83">                           accesskey=&quot;&amp;viewSourceMenuItem.accesskey;&quot;</span>
<a href="#l48.84"></a><span id="l48.84" class="difflineminus">-                          oncommand=&quot;ViewPageSource(GetSelectedMessages());&quot; /&gt;</span>
<a href="#l48.85"></a><span id="l48.85" class="difflineplus">+                          oncommand=&quot;ViewPageSource(gFolderDisplay.selectedMessageUris);&quot; /&gt;</span>
<a href="#l48.86"></a><span id="l48.86">                 &lt;menuitem id=&quot;saveAsMenuItem&quot; label=&quot;&amp;saveAsMenuItem.label;&quot;</span>
<a href="#l48.87"></a><span id="l48.87">                           accesskey=&quot;&amp;saveAsMenuItem.accesskey;&quot;</span>
<a href="#l48.88"></a><span id="l48.88">                           oncommand=&quot;MsgSaveAsFile();&quot; /&gt;</span>
<a href="#l48.89"></a><span id="l48.89">               &lt;/menupopup&gt;</span>
<a href="#l48.90"></a><span id="l48.90">             &lt;/button&gt;</span>
<a href="#l48.91"></a><span id="l48.91">           &lt;/vbox&gt;</span>
<a href="#l48.92"></a><span id="l48.92">         &lt;/hbox&gt;</span>
<a href="#l48.93"></a><span id="l48.93">       &lt;/vbox&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l49.1"></a><span id="l49.1" class="difflineminus">--- a/mail/base/content/msgMail3PaneWindow.js</span>
<a href="#l49.2"></a><span id="l49.2" class="difflineplus">+++ b/mail/base/content/msgMail3PaneWindow.js</span>
<a href="#l49.3"></a><span id="l49.3" class="difflineat">@@ -1,167 +1,102 @@</span>
<a href="#l49.4"></a><span id="l49.4" class="difflineminus">-# -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l49.5"></a><span id="l49.5" class="difflineminus">-# ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l49.6"></a><span id="l49.6" class="difflineminus">-# Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l49.7"></a><span id="l49.7" class="difflineminus">-#</span>
<a href="#l49.8"></a><span id="l49.8" class="difflineminus">-# The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l49.9"></a><span id="l49.9" class="difflineminus">-# 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l49.10"></a><span id="l49.10" class="difflineminus">-# the License. You may obtain a copy of the License at</span>
<a href="#l49.11"></a><span id="l49.11" class="difflineminus">-# http://www.mozilla.org/MPL/</span>
<a href="#l49.12"></a><span id="l49.12" class="difflineminus">-#</span>
<a href="#l49.13"></a><span id="l49.13" class="difflineminus">-# Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l49.14"></a><span id="l49.14" class="difflineminus">-# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l49.15"></a><span id="l49.15" class="difflineminus">-# for the specific language governing rights and limitations under the</span>
<a href="#l49.16"></a><span id="l49.16" class="difflineminus">-# License.</span>
<a href="#l49.17"></a><span id="l49.17" class="difflineminus">-#</span>
<a href="#l49.18"></a><span id="l49.18" class="difflineminus">-# The Original Code is Mozilla Communicator client code, released</span>
<a href="#l49.19"></a><span id="l49.19" class="difflineminus">-# March 31, 1998.</span>
<a href="#l49.20"></a><span id="l49.20" class="difflineminus">-#</span>
<a href="#l49.21"></a><span id="l49.21" class="difflineminus">-# The Initial Developer of the Original Code is</span>
<a href="#l49.22"></a><span id="l49.22" class="difflineminus">-# Netscape Communications Corporation.</span>
<a href="#l49.23"></a><span id="l49.23" class="difflineminus">-# Portions created by the Initial Developer are Copyright (C) 1998-1999</span>
<a href="#l49.24"></a><span id="l49.24" class="difflineminus">-# the Initial Developer. All Rights Reserved.</span>
<a href="#l49.25"></a><span id="l49.25" class="difflineminus">-#</span>
<a href="#l49.26"></a><span id="l49.26" class="difflineminus">-# Contributor(s):</span>
<a href="#l49.27"></a><span id="l49.27" class="difflineminus">-#   Jan Varga (varga@nixcorp.com)</span>
<a href="#l49.28"></a><span id="l49.28" class="difflineminus">-#   HÃ¥kan Waara (hwaara@chello.se)</span>
<a href="#l49.29"></a><span id="l49.29" class="difflineminus">-#   Neil Rashbrook (neil@parkwaycc.co.uk)</span>
<a href="#l49.30"></a><span id="l49.30" class="difflineminus">-#   Seth Spitzer &lt;sspitzer@netscape.com&gt;</span>
<a href="#l49.31"></a><span id="l49.31" class="difflineminus">-#   David Bienvenu &lt;bienvenu@nventure.com&gt;</span>
<a href="#l49.32"></a><span id="l49.32" class="difflineminus">-#   Jeremy Morton &lt;bugzilla@game-point.net&gt;</span>
<a href="#l49.33"></a><span id="l49.33" class="difflineminus">-#   Steffen Wilberg &lt;steffen.wilberg@web.de&gt;</span>
<a href="#l49.34"></a><span id="l49.34" class="difflineminus">-#</span>
<a href="#l49.35"></a><span id="l49.35" class="difflineminus">-# Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l49.36"></a><span id="l49.36" class="difflineminus">-# either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l49.37"></a><span id="l49.37" class="difflineminus">-# the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l49.38"></a><span id="l49.38" class="difflineminus">-# in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l49.39"></a><span id="l49.39" class="difflineminus">-# of those above. If you wish to allow use of your version of this file only</span>
<a href="#l49.40"></a><span id="l49.40" class="difflineminus">-# under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l49.41"></a><span id="l49.41" class="difflineminus">-# use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l49.42"></a><span id="l49.42" class="difflineminus">-# decision by deleting the provisions above and replace them with the notice</span>
<a href="#l49.43"></a><span id="l49.43" class="difflineminus">-# and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l49.44"></a><span id="l49.44" class="difflineminus">-# the provisions above, a recipient may use your version of this file under</span>
<a href="#l49.45"></a><span id="l49.45" class="difflineminus">-# the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l49.46"></a><span id="l49.46" class="difflineminus">-#</span>
<a href="#l49.47"></a><span id="l49.47" class="difflineminus">-# ***** END LICENSE BLOCK *****</span>
<a href="#l49.48"></a><span id="l49.48" class="difflineplus">+/** ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l49.49"></a><span id="l49.49" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l49.50"></a><span id="l49.50" class="difflineplus">+ *</span>
<a href="#l49.51"></a><span id="l49.51" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l49.52"></a><span id="l49.52" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l49.53"></a><span id="l49.53" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l49.54"></a><span id="l49.54" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l49.55"></a><span id="l49.55" class="difflineplus">+ *</span>
<a href="#l49.56"></a><span id="l49.56" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l49.57"></a><span id="l49.57" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l49.58"></a><span id="l49.58" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l49.59"></a><span id="l49.59" class="difflineplus">+ * License.</span>
<a href="#l49.60"></a><span id="l49.60" class="difflineplus">+ *</span>
<a href="#l49.61"></a><span id="l49.61" class="difflineplus">+ * The Original Code is Mozilla Communicator client code, released</span>
<a href="#l49.62"></a><span id="l49.62" class="difflineplus">+ * March 31, 1998.</span>
<a href="#l49.63"></a><span id="l49.63" class="difflineplus">+ *</span>
<a href="#l49.64"></a><span id="l49.64" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l49.65"></a><span id="l49.65" class="difflineplus">+ * Netscape Communications Corporation.</span>
<a href="#l49.66"></a><span id="l49.66" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 1998-1999</span>
<a href="#l49.67"></a><span id="l49.67" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l49.68"></a><span id="l49.68" class="difflineplus">+ *</span>
<a href="#l49.69"></a><span id="l49.69" class="difflineplus">+ * Contributor(s):</span>
<a href="#l49.70"></a><span id="l49.70" class="difflineplus">+ *   Jan Varga (varga@nixcorp.com)</span>
<a href="#l49.71"></a><span id="l49.71" class="difflineplus">+ *   HÃ¥kan Waara (hwaara@chello.se)</span>
<a href="#l49.72"></a><span id="l49.72" class="difflineplus">+ *   Neil Rashbrook (neil@parkwaycc.co.uk)</span>
<a href="#l49.73"></a><span id="l49.73" class="difflineplus">+ *   Seth Spitzer &lt;sspitzer@netscape.com&gt;</span>
<a href="#l49.74"></a><span id="l49.74" class="difflineplus">+ *   David Bienvenu &lt;bienvenu@nventure.com&gt;</span>
<a href="#l49.75"></a><span id="l49.75" class="difflineplus">+ *   Jeremy Morton &lt;bugzilla@game-point.net&gt;</span>
<a href="#l49.76"></a><span id="l49.76" class="difflineplus">+ *   Steffen Wilberg &lt;steffen.wilberg@web.de&gt;</span>
<a href="#l49.77"></a><span id="l49.77" class="difflineplus">+ *</span>
<a href="#l49.78"></a><span id="l49.78" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l49.79"></a><span id="l49.79" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l49.80"></a><span id="l49.80" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l49.81"></a><span id="l49.81" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l49.82"></a><span id="l49.82" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l49.83"></a><span id="l49.83" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l49.84"></a><span id="l49.84" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l49.85"></a><span id="l49.85" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l49.86"></a><span id="l49.86" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l49.87"></a><span id="l49.87" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l49.88"></a><span id="l49.88" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l49.89"></a><span id="l49.89" class="difflineplus">+ *</span>
<a href="#l49.90"></a><span id="l49.90" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l49.91"></a><span id="l49.91"> </span>
<a href="#l49.92"></a><span id="l49.92"> Components.utils.import(&quot;resource://gre/modules/folderUtils.jsm&quot;);</span>
<a href="#l49.93"></a><span id="l49.93"> Components.utils.import(&quot;resource://app/modules/activity/activityModules.js&quot;);</span>
<a href="#l49.94"></a><span id="l49.94" class="difflineplus">+Components.utils.import(&quot;resource://app/modules/jsTreeSelection.js&quot;);</span>
<a href="#l49.95"></a><span id="l49.95"> </span>
<a href="#l49.96"></a><span id="l49.96"> /* This is where functions related to the 3 pane window are kept */</span>
<a href="#l49.97"></a><span id="l49.97"> </span>
<a href="#l49.98"></a><span id="l49.98"> // from MailNewsTypes.h</span>
<a href="#l49.99"></a><span id="l49.99"> const nsMsgKey_None = 0xFFFFFFFF;</span>
<a href="#l49.100"></a><span id="l49.100"> const nsMsgViewIndex_None = 0xFFFFFFFF;</span>
<a href="#l49.101"></a><span id="l49.101"> const kMailCheckOncePrefName = &quot;mail.startup.enabledMailCheckOnce&quot;;</span>
<a href="#l49.102"></a><span id="l49.102"> </span>
<a href="#l49.103"></a><span id="l49.103"> const kStandardPaneConfig = 0;</span>
<a href="#l49.104"></a><span id="l49.104"> const kWidePaneConfig = 1;</span>
<a href="#l49.105"></a><span id="l49.105"> const kVerticalPaneConfig = 2;</span>
<a href="#l49.106"></a><span id="l49.106"> </span>
<a href="#l49.107"></a><span id="l49.107"> const kNumFolderViews = 4; // total number of folder views</span>
<a href="#l49.108"></a><span id="l49.108"> </span>
<a href="#l49.109"></a><span id="l49.109" class="difflineplus">+/** widget with id=messagepanebox, initialized by GetMessagePane() */</span>
<a href="#l49.110"></a><span id="l49.110"> var gMessagePane;</span>
<a href="#l49.111"></a><span id="l49.111" class="difflineplus">+/** widget with id=searchInput, initialized by GetSearchInput() */</span>
<a href="#l49.112"></a><span id="l49.112"> var gSearchInput;</span>
<a href="#l49.113"></a><span id="l49.113"> </span>
<a href="#l49.114"></a><span id="l49.114"> var gThreadAndMessagePaneSplitter = null;</span>
<a href="#l49.115"></a><span id="l49.115" class="difflineplus">+/** widget with id=unreadMessageCount, initialized by GetUnreadCountElement() */</span>
<a href="#l49.116"></a><span id="l49.116"> var gUnreadCount = null;</span>
<a href="#l49.117"></a><span id="l49.117" class="difflineplus">+/** widget with id=totalMessageCount, initialized by GetTotalCountElement() */</span>
<a href="#l49.118"></a><span id="l49.118"> var gTotalCount = null;</span>
<a href="#l49.119"></a><span id="l49.119"> var gCurrentFolderView;</span>
<a href="#l49.120"></a><span id="l49.120" class="difflineminus">-var gCurrentLoadingFolderURI;</span>
<a href="#l49.121"></a><span id="l49.121" class="difflineminus">-var gCurrentFolderToReroot;</span>
<a href="#l49.122"></a><span id="l49.122" class="difflineminus">-var gCurrentLoadingFolderSortType = 0;</span>
<a href="#l49.123"></a><span id="l49.123" class="difflineminus">-var gCurrentLoadingFolderSortOrder = 0;</span>
<a href="#l49.124"></a><span id="l49.124" class="difflineminus">-var gCurrentLoadingFolderViewType = 0;</span>
<a href="#l49.125"></a><span id="l49.125" class="difflineminus">-var gCurrentLoadingFolderViewFlags = 0;</span>
<a href="#l49.126"></a><span id="l49.126" class="difflineminus">-var gRerootOnFolderLoad = false;</span>
<a href="#l49.127"></a><span id="l49.127" class="difflineminus">-var gNextMessageAfterDelete = null;</span>
<a href="#l49.128"></a><span id="l49.128" class="difflineminus">-var gNextMessageAfterLoad = null;</span>
<a href="#l49.129"></a><span id="l49.129" class="difflineminus">-var gNextMessageViewIndexAfterDelete = -2;</span>
<a href="#l49.130"></a><span id="l49.130" class="difflineminus">-var gSelectedIndexWhenDeleting = -1;</span>
<a href="#l49.131"></a><span id="l49.131" class="difflineminus">-var gCurrentlyDisplayedMessage=nsMsgViewIndex_None;</span>
<a href="#l49.132"></a><span id="l49.132"> var gStartFolderUri = null;</span>
<a href="#l49.133"></a><span id="l49.133" class="difflineminus">-var gStartMsgKey = nsMsgKey_None;</span>
<a href="#l49.134"></a><span id="l49.134" class="difflineminus">-var gSearchEmailAddress = null;</span>
<a href="#l49.135"></a><span id="l49.135" class="difflineminus">-var gRightMouseButtonDown = false;</span>
<a href="#l49.136"></a><span id="l49.136" class="difflineminus">-// Global var to keep track of which row in the thread pane has been selected</span>
<a href="#l49.137"></a><span id="l49.137" class="difflineminus">-// This is used to make sure that the row with the currentIndex has the selection</span>
<a href="#l49.138"></a><span id="l49.138" class="difflineminus">-// after a Delete or Move of a message that has a row index less than currentIndex.</span>
<a href="#l49.139"></a><span id="l49.139" class="difflineminus">-var gThreadPaneCurrentSelectedIndex = -1;</span>
<a href="#l49.140"></a><span id="l49.140" class="difflineplus">+/**</span>
<a href="#l49.141"></a><span id="l49.141" class="difflineplus">+ * Tracks whether the right mouse button changed the selection or not.  If the</span>
<a href="#l49.142"></a><span id="l49.142" class="difflineplus">+ * user right clicks on the selection, it stays the same.  If they click outside</span>
<a href="#l49.143"></a><span id="l49.143" class="difflineplus">+ * of it, we alter the selection (but not the current index) to be the row they</span>
<a href="#l49.144"></a><span id="l49.144" class="difflineplus">+ * clicked on.</span>
<a href="#l49.145"></a><span id="l49.145" class="difflineplus">+ *</span>
<a href="#l49.146"></a><span id="l49.146" class="difflineplus">+ * The value of this variable is an object with &quot;view&quot; and &quot;selection&quot; keys</span>
<a href="#l49.147"></a><span id="l49.147" class="difflineplus">+ * and values.  The view value is the view whose selection we saved off, and</span>
<a href="#l49.148"></a><span id="l49.148" class="difflineplus">+ * the selection value is the selection object we saved off.</span>
<a href="#l49.149"></a><span id="l49.149" class="difflineplus">+ */</span>
<a href="#l49.150"></a><span id="l49.150" class="difflineplus">+var gRightMouseButtonSavedSelection = null;</span>
<a href="#l49.151"></a><span id="l49.151"> var gLoadStartFolder = true;</span>
<a href="#l49.152"></a><span id="l49.152"> var gNewAccountToLoad = null;</span>
<a href="#l49.153"></a><span id="l49.153"> </span>
<a href="#l49.154"></a><span id="l49.154"> // Global var to keep track of if the 'Delete Message' or 'Move To' thread pane</span>
<a href="#l49.155"></a><span id="l49.155"> // context menu item was triggered.  This helps prevent the tree view from</span>
<a href="#l49.156"></a><span id="l49.156"> // not updating on one of those menu item commands.</span>
<a href="#l49.157"></a><span id="l49.157"> var gThreadPaneDeleteOrMoveOccurred = false;</span>
<a href="#l49.158"></a><span id="l49.158"> </span>
<a href="#l49.159"></a><span id="l49.159" class="difflineminus">-//If we've loaded a message, set to true.  Helps us keep the start page around.</span>
<a href="#l49.160"></a><span id="l49.160" class="difflineminus">-var gHaveLoadedMessage;</span>
<a href="#l49.161"></a><span id="l49.161" class="difflineminus">-</span>
<a href="#l49.162"></a><span id="l49.162"> var gDisplayStartupPage = false;</span>
<a href="#l49.163"></a><span id="l49.163"> </span>
<a href="#l49.164"></a><span id="l49.164" class="difflineminus">-function SelectAndScrollToKey(aMsgKey)</span>
<a href="#l49.165"></a><span id="l49.165" class="difflineminus">-{</span>
<a href="#l49.166"></a><span id="l49.166" class="difflineminus">-  // select the desired message</span>
<a href="#l49.167"></a><span id="l49.167" class="difflineminus">-  // if the key isn't found, we won't select anything</span>
<a href="#l49.168"></a><span id="l49.168" class="difflineminus">-  gDBView.selectMsgByKey(aMsgKey);</span>
<a href="#l49.169"></a><span id="l49.169" class="difflineminus">-</span>
<a href="#l49.170"></a><span id="l49.170" class="difflineminus">-  // is there a selection?</span>
<a href="#l49.171"></a><span id="l49.171" class="difflineminus">-  // if not, bail out.</span>
<a href="#l49.172"></a><span id="l49.172" class="difflineminus">-  var indicies = GetSelectedIndices(gDBView);</span>
<a href="#l49.173"></a><span id="l49.173" class="difflineminus">-  if (!indicies || !indicies.length)</span>
<a href="#l49.174"></a><span id="l49.174" class="difflineminus">-    return false;</span>
<a href="#l49.175"></a><span id="l49.175" class="difflineminus">-</span>
<a href="#l49.176"></a><span id="l49.176" class="difflineminus">-  // now scroll to it</span>
<a href="#l49.177"></a><span id="l49.177" class="difflineminus">-  EnsureRowInThreadTreeIsVisible(indicies[0]);</span>
<a href="#l49.178"></a><span id="l49.178" class="difflineminus">-  return true;</span>
<a href="#l49.179"></a><span id="l49.179" class="difflineminus">-}</span>
<a href="#l49.180"></a><span id="l49.180" class="difflineminus">-</span>
<a href="#l49.181"></a><span id="l49.181" class="difflineminus">-// A helper routine called after a folder is loaded to make sure</span>
<a href="#l49.182"></a><span id="l49.182" class="difflineminus">-// we select and scroll to the correct message (could be the first new message,</span>
<a href="#l49.183"></a><span id="l49.183" class="difflineminus">-// could be the last displayed message, etc.)</span>
<a href="#l49.184"></a><span id="l49.184" class="difflineminus">-function ScrollToMessageAfterFolderLoad(folder)</span>
<a href="#l49.185"></a><span id="l49.185" class="difflineminus">-{</span>
<a href="#l49.186"></a><span id="l49.186" class="difflineminus">-  var scrolled = gPrefBranch.getBoolPref(&quot;mailnews.scroll_to_new_message&quot;) &amp;&amp;</span>
<a href="#l49.187"></a><span id="l49.187" class="difflineminus">-      ScrollToMessage(nsMsgNavigationType.firstNew, true, false /* selectMessage */);</span>
<a href="#l49.188"></a><span id="l49.188" class="difflineminus">-  if (!scrolled &amp;&amp; folder &amp;&amp; gPrefBranch.getBoolPref(&quot;mailnews.remember_selected_message&quot;))</span>
<a href="#l49.189"></a><span id="l49.189" class="difflineminus">-  {</span>
<a href="#l49.190"></a><span id="l49.190" class="difflineminus">-    // If we failed to scroll to a new message,</span>
<a href="#l49.191"></a><span id="l49.191" class="difflineminus">-    // reselect the last selected message</span>
<a href="#l49.192"></a><span id="l49.192" class="difflineminus">-    var lastMessageLoaded = folder.lastMessageLoaded;</span>
<a href="#l49.193"></a><span id="l49.193" class="difflineminus">-    if (lastMessageLoaded != nsMsgKey_None)</span>
<a href="#l49.194"></a><span id="l49.194" class="difflineminus">-      scrolled = SelectAndScrollToKey(lastMessageLoaded);</span>
<a href="#l49.195"></a><span id="l49.195" class="difflineminus">-  }</span>
<a href="#l49.196"></a><span id="l49.196" class="difflineminus">-</span>
<a href="#l49.197"></a><span id="l49.197" class="difflineminus">-  if (!scrolled)</span>
<a href="#l49.198"></a><span id="l49.198" class="difflineminus">-  {</span>
<a href="#l49.199"></a><span id="l49.199" class="difflineminus">-    // if we still haven't scrolled,</span>
<a href="#l49.200"></a><span id="l49.200" class="difflineminus">-    // scroll to the newest, which might be the top or the bottom</span>
<a href="#l49.201"></a><span id="l49.201" class="difflineminus">-    // depending on our sort order and sort type</span>
<a href="#l49.202"></a><span id="l49.202" class="difflineminus">-    if (gDBView.sortOrder == nsMsgViewSortOrder.ascending)</span>
<a href="#l49.203"></a><span id="l49.203" class="difflineminus">-    {</span>
<a href="#l49.204"></a><span id="l49.204" class="difflineminus">-      switch (gDBView.sortType)</span>
<a href="#l49.205"></a><span id="l49.205" class="difflineminus">-      {</span>
<a href="#l49.206"></a><span id="l49.206" class="difflineminus">-        case nsMsgViewSortType.byDate:</span>
<a href="#l49.207"></a><span id="l49.207" class="difflineminus">-        case nsMsgViewSortType.byReceived:</span>
<a href="#l49.208"></a><span id="l49.208" class="difflineminus">-        case nsMsgViewSortType.byId:</span>
<a href="#l49.209"></a><span id="l49.209" class="difflineminus">-        case nsMsgViewSortType.byThread:</span>
<a href="#l49.210"></a><span id="l49.210" class="difflineminus">-         scrolled = ScrollToMessage(nsMsgNavigationType.lastMessage, true, false /* selectMessage */);</span>
<a href="#l49.211"></a><span id="l49.211" class="difflineminus">-         break;</span>
<a href="#l49.212"></a><span id="l49.212" class="difflineminus">-      }</span>
<a href="#l49.213"></a><span id="l49.213" class="difflineminus">-    }</span>
<a href="#l49.214"></a><span id="l49.214" class="difflineminus">-</span>
<a href="#l49.215"></a><span id="l49.215" class="difflineminus">-    // if still we haven't scrolled,</span>
<a href="#l49.216"></a><span id="l49.216" class="difflineminus">-    // scroll to the top.</span>
<a href="#l49.217"></a><span id="l49.217" class="difflineminus">-    if (!scrolled)</span>
<a href="#l49.218"></a><span id="l49.218" class="difflineminus">-      EnsureRowInThreadTreeIsVisible(0);</span>
<a href="#l49.219"></a><span id="l49.219" class="difflineminus">-  }</span>
<a href="#l49.220"></a><span id="l49.220" class="difflineminus">-}</span>
<a href="#l49.221"></a><span id="l49.221" class="difflineminus">-</span>
<a href="#l49.222"></a><span id="l49.222"> // the folderListener object</span>
<a href="#l49.223"></a><span id="l49.223"> var folderListener = {</span>
<a href="#l49.224"></a><span id="l49.224">     OnItemAdded: function(parentItem, item) { },</span>
<a href="#l49.225"></a><span id="l49.225"> </span>
<a href="#l49.226"></a><span id="l49.226">     OnItemRemoved: function(parentItem, item) { },</span>
<a href="#l49.227"></a><span id="l49.227"> </span>
<a href="#l49.228"></a><span id="l49.228">     OnItemPropertyChanged: function(item, property, oldValue, newValue) { },</span>
<a href="#l49.229"></a><span id="l49.229"> </span>
<a href="#l49.230"></a><span id="l49.230" class="difflineat">@@ -175,131 +110,17 @@ var folderListener = {</span>
<a href="#l49.231"></a><span id="l49.231"> </span>
<a href="#l49.232"></a><span id="l49.232">     OnItemBoolPropertyChanged: function(item, property, oldValue, newValue) { },</span>
<a href="#l49.233"></a><span id="l49.233"> </span>
<a href="#l49.234"></a><span id="l49.234">     OnItemUnicharPropertyChanged: function(item, property, oldValue, newValue) { },</span>
<a href="#l49.235"></a><span id="l49.235">     OnItemPropertyFlagChanged: function(item, property, oldFlag, newFlag) { },</span>
<a href="#l49.236"></a><span id="l49.236"> </span>
<a href="#l49.237"></a><span id="l49.237">     OnItemEvent: function(folder, event) {</span>
<a href="#l49.238"></a><span id="l49.238">       var eventType = event.toString();</span>
<a href="#l49.239"></a><span id="l49.239" class="difflineminus">-      if (eventType == &quot;FolderLoaded&quot;) {</span>
<a href="#l49.240"></a><span id="l49.240" class="difflineminus">-        if (folder) {</span>
<a href="#l49.241"></a><span id="l49.241" class="difflineminus">-          var scrolled = false;</span>
<a href="#l49.242"></a><span id="l49.242" class="difflineminus">-          var msgFolder = folder.QueryInterface(Components.interfaces.nsIMsgFolder);</span>
<a href="#l49.243"></a><span id="l49.243" class="difflineminus">-          var uri = folder.URI;</span>
<a href="#l49.244"></a><span id="l49.244" class="difflineminus">-          var rerootingFolder = (uri == gCurrentFolderToReroot);</span>
<a href="#l49.245"></a><span id="l49.245" class="difflineminus">-          if (rerootingFolder) {</span>
<a href="#l49.246"></a><span id="l49.246" class="difflineminus">-            viewDebug(&quot;uri = gCurrentFolderToReroot, setting gQSViewIsDirty\n&quot;);</span>
<a href="#l49.247"></a><span id="l49.247" class="difflineminus">-            gQSViewIsDirty = true;</span>
<a href="#l49.248"></a><span id="l49.248" class="difflineminus">-            gCurrentFolderToReroot = null;</span>
<a href="#l49.249"></a><span id="l49.249" class="difflineminus">-            if (msgFolder) {</span>
<a href="#l49.250"></a><span id="l49.250" class="difflineminus">-              msgFolder.endFolderLoading();</span>
<a href="#l49.251"></a><span id="l49.251" class="difflineminus">-              UpdateStatusQuota(msgFolder);</span>
<a href="#l49.252"></a><span id="l49.252" class="difflineminus">-              // Suppress command updating when rerooting the folder.</span>
<a href="#l49.253"></a><span id="l49.253" class="difflineminus">-              // When rerooting, we'll be clearing the selection</span>
<a href="#l49.254"></a><span id="l49.254" class="difflineminus">-              // which will cause us to update commands.</span>
<a href="#l49.255"></a><span id="l49.255" class="difflineminus">-              if (gDBView) {</span>
<a href="#l49.256"></a><span id="l49.256" class="difflineminus">-                gDBView.suppressCommandUpdating = true;</span>
<a href="#l49.257"></a><span id="l49.257" class="difflineminus">-                // If the db's view isn't set, something went wrong and we</span>
<a href="#l49.258"></a><span id="l49.258" class="difflineminus">-                // should reroot the folder, which will re-open the view.</span>
<a href="#l49.259"></a><span id="l49.259" class="difflineminus">-                if (!gDBView.db)</span>
<a href="#l49.260"></a><span id="l49.260" class="difflineminus">-                  gRerootOnFolderLoad = true;</span>
<a href="#l49.261"></a><span id="l49.261" class="difflineminus">-              }</span>
<a href="#l49.262"></a><span id="l49.262" class="difflineminus">-              if (gRerootOnFolderLoad)</span>
<a href="#l49.263"></a><span id="l49.263" class="difflineminus">-                RerootFolder(uri, msgFolder, gCurrentLoadingFolderViewType, gCurrentLoadingFolderViewFlags, gCurrentLoadingFolderSortType, gCurrentLoadingFolderSortOrder);</span>
<a href="#l49.264"></a><span id="l49.264" class="difflineminus">-</span>
<a href="#l49.265"></a><span id="l49.265" class="difflineminus">-              var db = msgFolder.msgDatabase;</span>
<a href="#l49.266"></a><span id="l49.266" class="difflineminus">-              if (db)</span>
<a href="#l49.267"></a><span id="l49.267" class="difflineminus">-                db.resetHdrCacheSize(100);</span>
<a href="#l49.268"></a><span id="l49.268" class="difflineminus">-</span>
<a href="#l49.269"></a><span id="l49.269" class="difflineminus">-              if (gDBView) {</span>
<a href="#l49.270"></a><span id="l49.270" class="difflineminus">-                gDBView.suppressCommandUpdating = false;</span>
<a href="#l49.271"></a><span id="l49.271" class="difflineminus">-              }</span>
<a href="#l49.272"></a><span id="l49.272" class="difflineminus">-</span>
<a href="#l49.273"></a><span id="l49.273" class="difflineminus">-              gCurrentLoadingFolderSortType = 0;</span>
<a href="#l49.274"></a><span id="l49.274" class="difflineminus">-              gCurrentLoadingFolderSortOrder = 0;</span>
<a href="#l49.275"></a><span id="l49.275" class="difflineminus">-              gCurrentLoadingFolderViewType = 0;</span>
<a href="#l49.276"></a><span id="l49.276" class="difflineminus">-              gCurrentLoadingFolderViewFlags = 0;</span>
<a href="#l49.277"></a><span id="l49.277" class="difflineminus">-</span>
<a href="#l49.278"></a><span id="l49.278" class="difflineminus">-              // Used for rename folder msg loading after folder is loaded.</span>
<a href="#l49.279"></a><span id="l49.279" class="difflineminus">-              scrolled = LoadCurrentlyDisplayedMessage();</span>
<a href="#l49.280"></a><span id="l49.280" class="difflineminus">-</span>
<a href="#l49.281"></a><span id="l49.281" class="difflineminus">-              if (gStartMsgKey != nsMsgKey_None) {</span>
<a href="#l49.282"></a><span id="l49.282" class="difflineminus">-                scrolled = SelectAndScrollToKey(gStartMsgKey);</span>
<a href="#l49.283"></a><span id="l49.283" class="difflineminus">-                gStartMsgKey = nsMsgKey_None;</span>
<a href="#l49.284"></a><span id="l49.284" class="difflineminus">-              }</span>
<a href="#l49.285"></a><span id="l49.285" class="difflineminus">-</span>
<a href="#l49.286"></a><span id="l49.286" class="difflineminus">-              if (gNextMessageAfterLoad) {</span>
<a href="#l49.287"></a><span id="l49.287" class="difflineminus">-                var type = gNextMessageAfterLoad;</span>
<a href="#l49.288"></a><span id="l49.288" class="difflineminus">-                gNextMessageAfterLoad = null;</span>
<a href="#l49.289"></a><span id="l49.289" class="difflineminus">-</span>
<a href="#l49.290"></a><span id="l49.290" class="difflineminus">-                // Scroll to and select the proper message.</span>
<a href="#l49.291"></a><span id="l49.291" class="difflineminus">-                scrolled = ScrollToMessage(type, true, true /* selectMessage */);</span>
<a href="#l49.292"></a><span id="l49.292" class="difflineminus">-              }</span>
<a href="#l49.293"></a><span id="l49.293" class="difflineminus">-            }</span>
<a href="#l49.294"></a><span id="l49.294" class="difflineminus">-          }</span>
<a href="#l49.295"></a><span id="l49.295" class="difflineminus">-          const nsMsgFolderFlags = Components.interfaces.nsMsgFolderFlags;</span>
<a href="#l49.296"></a><span id="l49.296" class="difflineminus">-          if (uri == gCurrentLoadingFolderURI) {</span>
<a href="#l49.297"></a><span id="l49.297" class="difflineminus">-            viewDebug(&quot;uri == current loading folder uri\n&quot;);</span>
<a href="#l49.298"></a><span id="l49.298" class="difflineminus">-            gCurrentLoadingFolderURI = &quot;&quot;;</span>
<a href="#l49.299"></a><span id="l49.299" class="difflineminus">-            // Scroll to message for virtual folders is done in</span>
<a href="#l49.300"></a><span id="l49.300" class="difflineminus">-            // gSearchNotificationListener.OnSearchDone (see searchBar.js).</span>
<a href="#l49.301"></a><span id="l49.301" class="difflineminus">-            if (!scrolled &amp;&amp; gMsgFolderSelected &amp;&amp;</span>
<a href="#l49.302"></a><span id="l49.302" class="difflineminus">-                !(gMsgFolderSelected.flags &amp; nsMsgFolderFlags.Virtual))</span>
<a href="#l49.303"></a><span id="l49.303" class="difflineminus">-              ScrollToMessageAfterFolderLoad(msgFolder);</span>
<a href="#l49.304"></a><span id="l49.304" class="difflineminus">-            SetBusyCursor(window, false);</span>
<a href="#l49.305"></a><span id="l49.305" class="difflineminus">-          }</span>
<a href="#l49.306"></a><span id="l49.306" class="difflineminus">-          // Folder loading is over,</span>
<a href="#l49.307"></a><span id="l49.307" class="difflineminus">-          // now issue quick search if there is an email address.</span>
<a href="#l49.308"></a><span id="l49.308" class="difflineminus">-          viewDebug(&quot;in folder loaded gVirtualFolderTerms = &quot; + gVirtualFolderTerms + &quot;\n&quot;);</span>
<a href="#l49.309"></a><span id="l49.309" class="difflineminus">-          viewDebug(&quot;in folder loaded gMsgFolderSelected = &quot; + gMsgFolderSelected.URI + &quot;\n&quot;);</span>
<a href="#l49.310"></a><span id="l49.310" class="difflineminus">-          if (rerootingFolder)</span>
<a href="#l49.311"></a><span id="l49.311" class="difflineminus">-          {</span>
<a href="#l49.312"></a><span id="l49.312" class="difflineminus">-            if (gSearchEmailAddress)</span>
<a href="#l49.313"></a><span id="l49.313" class="difflineminus">-            {</span>
<a href="#l49.314"></a><span id="l49.314" class="difflineminus">-              Search(gSearchEmailAddress);</span>
<a href="#l49.315"></a><span id="l49.315" class="difflineminus">-              gSearchEmailAddress = null;</span>
<a href="#l49.316"></a><span id="l49.316" class="difflineminus">-            }</span>
<a href="#l49.317"></a><span id="l49.317" class="difflineminus">-            else if (gVirtualFolderTerms)</span>
<a href="#l49.318"></a><span id="l49.318" class="difflineminus">-            {</span>
<a href="#l49.319"></a><span id="l49.319" class="difflineminus">-              gDefaultSearchViewTerms = null;</span>
<a href="#l49.320"></a><span id="l49.320" class="difflineminus">-              viewDebug(&quot;searching gVirtualFolderTerms\n&quot;);</span>
<a href="#l49.321"></a><span id="l49.321" class="difflineminus">-              gDBView.viewFolder = gMsgFolderSelected;</span>
<a href="#l49.322"></a><span id="l49.322" class="difflineminus">-              ViewChangeByFolder(gMsgFolderSelected);</span>
<a href="#l49.323"></a><span id="l49.323" class="difflineminus">-            }</span>
<a href="#l49.324"></a><span id="l49.324" class="difflineminus">-            else if (gMsgFolderSelected.flags &amp; nsMsgFolderFlags.Virtual)</span>
<a href="#l49.325"></a><span id="l49.325" class="difflineminus">-            {</span>
<a href="#l49.326"></a><span id="l49.326" class="difflineminus">-              viewDebug(&quot;selected folder is virtual\n&quot;);</span>
<a href="#l49.327"></a><span id="l49.327" class="difflineminus">-              gDefaultSearchViewTerms = null;</span>
<a href="#l49.328"></a><span id="l49.328" class="difflineminus">-            }</span>
<a href="#l49.329"></a><span id="l49.329" class="difflineminus">-            else</span>
<a href="#l49.330"></a><span id="l49.330" class="difflineminus">-            {</span>
<a href="#l49.331"></a><span id="l49.331" class="difflineminus">-              // Get the view value from the folder.</span>
<a href="#l49.332"></a><span id="l49.332" class="difflineminus">-              if (msgFolder)</span>
<a href="#l49.333"></a><span id="l49.333" class="difflineminus">-              {</span>
<a href="#l49.334"></a><span id="l49.334" class="difflineminus">-                // If our new view is the same as the old view and we already</span>
<a href="#l49.335"></a><span id="l49.335" class="difflineminus">-                // have the list of search terms built up for the old view,</span>
<a href="#l49.336"></a><span id="l49.336" class="difflineminus">-                // just re-use it.</span>
<a href="#l49.337"></a><span id="l49.337" class="difflineminus">-                var result = GetMailViewForFolder(msgFolder);</span>
<a href="#l49.338"></a><span id="l49.338" class="difflineminus">-                if (GetSearchInput() &amp;&amp; gCurrentViewValue == result &amp;&amp; gDefaultSearchViewTerms)</span>
<a href="#l49.339"></a><span id="l49.339" class="difflineminus">-                {</span>
<a href="#l49.340"></a><span id="l49.340" class="difflineminus">-                  viewDebug(&quot;searching gDefaultSearchViewTerms and rerootingFolder\n&quot;);</span>
<a href="#l49.341"></a><span id="l49.341" class="difflineminus">-                  Search(&quot;&quot;);</span>
<a href="#l49.342"></a><span id="l49.342" class="difflineminus">-                }</span>
<a href="#l49.343"></a><span id="l49.343" class="difflineminus">-                else if (document.getElementById(&quot;mailviews-container&quot;)) // Only load the folder view if the views toolbar is visible.</span>
<a href="#l49.344"></a><span id="l49.344" class="difflineminus">-                {</span>
<a href="#l49.345"></a><span id="l49.345" class="difflineminus">-                  viewDebug(&quot;changing view by value\n&quot;);</span>
<a href="#l49.346"></a><span id="l49.346" class="difflineminus">-                  ViewChangeByValue(result);</span>
<a href="#l49.347"></a><span id="l49.347" class="difflineminus">-                }</span>
<a href="#l49.348"></a><span id="l49.348" class="difflineminus">-              }</span>
<a href="#l49.349"></a><span id="l49.349" class="difflineminus">-            }</span>
<a href="#l49.350"></a><span id="l49.350" class="difflineminus">-          }</span>
<a href="#l49.351"></a><span id="l49.351" class="difflineminus">-        }</span>
<a href="#l49.352"></a><span id="l49.352" class="difflineminus">-      }</span>
<a href="#l49.353"></a><span id="l49.353" class="difflineminus">-      else if (eventType == &quot;ImapHdrDownloaded&quot;) {</span>
<a href="#l49.354"></a><span id="l49.354" class="difflineplus">+      if (eventType == &quot;ImapHdrDownloaded&quot;) {</span>
<a href="#l49.355"></a><span id="l49.355">         if (folder) {</span>
<a href="#l49.356"></a><span id="l49.356">           var imapFolder = folder.QueryInterface(Components.interfaces.nsIMsgImapMailFolder);</span>
<a href="#l49.357"></a><span id="l49.357">           if (imapFolder) {</span>
<a href="#l49.358"></a><span id="l49.358">             var hdrParser = imapFolder.hdrParser;</span>
<a href="#l49.359"></a><span id="l49.359">             if (hdrParser) {</span>
<a href="#l49.360"></a><span id="l49.360">               var msgHdr = hdrParser.GetNewMsgHdr();</span>
<a href="#l49.361"></a><span id="l49.361">               if (msgHdr)</span>
<a href="#l49.362"></a><span id="l49.362">               {</span>
<a href="#l49.363"></a><span id="l49.363" class="difflineat">@@ -311,232 +132,22 @@ var folderListener = {</span>
<a href="#l49.364"></a><span id="l49.364">                 if (hdrs &amp;&amp; hdrs.indexOf(&quot;X-image-size:&quot;) &gt; 0) {</span>
<a href="#l49.365"></a><span id="l49.365">                   msgHdr.setStringProperty(&quot;imageSize&quot;, &quot;1&quot;);</span>
<a href="#l49.366"></a><span id="l49.366">                 }</span>
<a href="#l49.367"></a><span id="l49.367">               }</span>
<a href="#l49.368"></a><span id="l49.368">             }</span>
<a href="#l49.369"></a><span id="l49.369">           }</span>
<a href="#l49.370"></a><span id="l49.370">         }</span>
<a href="#l49.371"></a><span id="l49.371">       }</span>
<a href="#l49.372"></a><span id="l49.372" class="difflineminus">-      else if (eventType == &quot;DeleteOrMoveMsgCompleted&quot;) {</span>
<a href="#l49.373"></a><span id="l49.373" class="difflineminus">-        HandleDeleteOrMoveMsgCompleted(folder);</span>
<a href="#l49.374"></a><span id="l49.374" class="difflineminus">-      }</span>
<a href="#l49.375"></a><span id="l49.375" class="difflineminus">-      else if (eventType == &quot;DeleteOrMoveMsgFailed&quot;) {</span>
<a href="#l49.376"></a><span id="l49.376" class="difflineminus">-        HandleDeleteOrMoveMsgFailed(folder);</span>
<a href="#l49.377"></a><span id="l49.377" class="difflineminus">-      }</span>
<a href="#l49.378"></a><span id="l49.378" class="difflineminus">-      else if (eventType == &quot;AboutToCompact&quot;) {</span>
<a href="#l49.379"></a><span id="l49.379" class="difflineminus">-        if (gDBView)</span>
<a href="#l49.380"></a><span id="l49.380" class="difflineminus">-          gCurrentlyDisplayedMessage = gDBView.currentlyDisplayedMessage;</span>
<a href="#l49.381"></a><span id="l49.381" class="difflineminus">-      }</span>
<a href="#l49.382"></a><span id="l49.382" class="difflineminus">-      else if (eventType == &quot;CompactCompleted&quot;) {</span>
<a href="#l49.383"></a><span id="l49.383" class="difflineminus">-        HandleCompactCompleted(folder);</span>
<a href="#l49.384"></a><span id="l49.384" class="difflineminus">-      }</span>
<a href="#l49.385"></a><span id="l49.385" class="difflineminus">-      else if (eventType == &quot;RenameCompleted&quot;) {</span>
<a href="#l49.386"></a><span id="l49.386" class="difflineminus">-        gFolderTreeView.selectFolder(folder);</span>
<a href="#l49.387"></a><span id="l49.387" class="difflineminus">-      }</span>
<a href="#l49.388"></a><span id="l49.388">       else if (eventType == &quot;JunkStatusChanged&quot;) {</span>
<a href="#l49.389"></a><span id="l49.389">         HandleJunkStatusChanged(folder);</span>
<a href="#l49.390"></a><span id="l49.390">       }</span>
<a href="#l49.391"></a><span id="l49.391">     }</span>
<a href="#l49.392"></a><span id="l49.392"> }</span>
<a href="#l49.393"></a><span id="l49.393"> </span>
<a href="#l49.394"></a><span id="l49.394" class="difflineminus">-function HandleDeleteOrMoveMsgFailed(folder)</span>
<a href="#l49.395"></a><span id="l49.395" class="difflineminus">-{</span>
<a href="#l49.396"></a><span id="l49.396" class="difflineminus">-  gDBView.onDeleteCompleted(false);</span>
<a href="#l49.397"></a><span id="l49.397" class="difflineminus">-  if(IsCurrentLoadedFolder(folder)) {</span>
<a href="#l49.398"></a><span id="l49.398" class="difflineminus">-    if(gNextMessageAfterDelete) {</span>
<a href="#l49.399"></a><span id="l49.399" class="difflineminus">-      gNextMessageAfterDelete = null;</span>
<a href="#l49.400"></a><span id="l49.400" class="difflineminus">-      gNextMessageViewIndexAfterDelete = -2;</span>
<a href="#l49.401"></a><span id="l49.401" class="difflineminus">-    }</span>
<a href="#l49.402"></a><span id="l49.402" class="difflineminus">-  }</span>
<a href="#l49.403"></a><span id="l49.403" class="difflineminus">-</span>
<a href="#l49.404"></a><span id="l49.404" class="difflineminus">-  // fix me???</span>
<a href="#l49.405"></a><span id="l49.405" class="difflineminus">-  // ThreadPaneSelectionChange(true);</span>
<a href="#l49.406"></a><span id="l49.406" class="difflineminus">-}</span>
<a href="#l49.407"></a><span id="l49.407" class="difflineminus">-</span>
<a href="#l49.408"></a><span id="l49.408" class="difflineminus">-// WARNING</span>
<a href="#l49.409"></a><span id="l49.409" class="difflineminus">-// this is a fragile and complicated function.</span>
<a href="#l49.410"></a><span id="l49.410" class="difflineminus">-// be careful when hacking on it.</span>
<a href="#l49.411"></a><span id="l49.411" class="difflineminus">-// Don't forget about things like different imap</span>
<a href="#l49.412"></a><span id="l49.412" class="difflineminus">-// delete models, multiple views (from multiple thread panes,</span>
<a href="#l49.413"></a><span id="l49.413" class="difflineminus">-// search windows, stand alone message windows)</span>
<a href="#l49.414"></a><span id="l49.414" class="difflineminus">-function HandleDeleteOrMoveMsgCompleted(folder)</span>
<a href="#l49.415"></a><span id="l49.415" class="difflineminus">-{</span>
<a href="#l49.416"></a><span id="l49.416" class="difflineminus">-  // you might not have a db view.  this can happen if</span>
<a href="#l49.417"></a><span id="l49.417" class="difflineminus">-  // biff fires when the 3 pane is set to account central.</span>
<a href="#l49.418"></a><span id="l49.418" class="difflineminus">-  if (!gDBView)</span>
<a href="#l49.419"></a><span id="l49.419" class="difflineminus">-    return;</span>
<a href="#l49.420"></a><span id="l49.420" class="difflineminus">-</span>
<a href="#l49.421"></a><span id="l49.421" class="difflineminus">-  gDBView.onDeleteCompleted(true);</span>
<a href="#l49.422"></a><span id="l49.422" class="difflineminus">-</span>
<a href="#l49.423"></a><span id="l49.423" class="difflineminus">-  if (!IsCurrentLoadedFolder(folder)) {</span>
<a href="#l49.424"></a><span id="l49.424" class="difflineminus">-    // default value after delete/move/copy is over</span>
<a href="#l49.425"></a><span id="l49.425" class="difflineminus">-    gNextMessageViewIndexAfterDelete = -2;</span>
<a href="#l49.426"></a><span id="l49.426" class="difflineminus">-    return;</span>
<a href="#l49.427"></a><span id="l49.427" class="difflineminus">-  }</span>
<a href="#l49.428"></a><span id="l49.428" class="difflineminus">-</span>
<a href="#l49.429"></a><span id="l49.429" class="difflineminus">-  var treeView = gDBView.QueryInterface(Components.interfaces.nsITreeView);</span>
<a href="#l49.430"></a><span id="l49.430" class="difflineminus">-  var treeSelection = treeView.selection;</span>
<a href="#l49.431"></a><span id="l49.431" class="difflineminus">-</span>
<a href="#l49.432"></a><span id="l49.432" class="difflineminus">-  if (gNextMessageViewIndexAfterDelete == -2) {</span>
<a href="#l49.433"></a><span id="l49.433" class="difflineminus">-    // a move or delete can cause our selection can change underneath us.</span>
<a href="#l49.434"></a><span id="l49.434" class="difflineminus">-    // this can happen when the user</span>
<a href="#l49.435"></a><span id="l49.435" class="difflineminus">-    // deletes message from the stand alone msg window</span>
<a href="#l49.436"></a><span id="l49.436" class="difflineminus">-    // or the search view, or another 3 pane</span>
<a href="#l49.437"></a><span id="l49.437" class="difflineminus">-    if (treeSelection.count == 0) {</span>
<a href="#l49.438"></a><span id="l49.438" class="difflineminus">-      // this can happen if you double clicked a message</span>
<a href="#l49.439"></a><span id="l49.439" class="difflineminus">-      // in the thread pane, and deleted it from the stand alone msg window</span>
<a href="#l49.440"></a><span id="l49.440" class="difflineminus">-      // see bug #172392</span>
<a href="#l49.441"></a><span id="l49.441" class="difflineminus">-      treeSelection.clearSelection();</span>
<a href="#l49.442"></a><span id="l49.442" class="difflineminus">-      setTitleFromFolder(folder, null);</span>
<a href="#l49.443"></a><span id="l49.443" class="difflineminus">-      ClearMessagePane();</span>
<a href="#l49.444"></a><span id="l49.444" class="difflineminus">-      UpdateMailToolbar(&quot;delete from another view, 0 rows now selected&quot;);</span>
<a href="#l49.445"></a><span id="l49.445" class="difflineminus">-    }</span>
<a href="#l49.446"></a><span id="l49.446" class="difflineminus">-    else if (treeSelection.count == 1) {</span>
<a href="#l49.447"></a><span id="l49.447" class="difflineminus">-      // this can happen if you had two messages selected</span>
<a href="#l49.448"></a><span id="l49.448" class="difflineminus">-      // in the thread pane, and you deleted one of them from another view</span>
<a href="#l49.449"></a><span id="l49.449" class="difflineminus">-      // (like the view in the stand alone msg window)</span>
<a href="#l49.450"></a><span id="l49.450" class="difflineminus">-      // since one item is selected, we should load it.</span>
<a href="#l49.451"></a><span id="l49.451" class="difflineminus">-      var startIndex = {};</span>
<a href="#l49.452"></a><span id="l49.452" class="difflineminus">-      var endIndex = {};</span>
<a href="#l49.453"></a><span id="l49.453" class="difflineminus">-      treeSelection.getRangeAt(0, startIndex, endIndex);</span>
<a href="#l49.454"></a><span id="l49.454" class="difflineminus">-</span>
<a href="#l49.455"></a><span id="l49.455" class="difflineminus">-      // select the selected item, so we'll load it</span>
<a href="#l49.456"></a><span id="l49.456" class="difflineminus">-      treeSelection.select(startIndex.value);</span>
<a href="#l49.457"></a><span id="l49.457" class="difflineminus">-      treeView.selectionChanged();</span>
<a href="#l49.458"></a><span id="l49.458" class="difflineminus">-</span>
<a href="#l49.459"></a><span id="l49.459" class="difflineminus">-      EnsureRowInThreadTreeIsVisible(startIndex.value);</span>
<a href="#l49.460"></a><span id="l49.460" class="difflineminus">-</span>
<a href="#l49.461"></a><span id="l49.461" class="difflineminus">-      UpdateMailToolbar(&quot;delete from another view, 1 row now selected&quot;);</span>
<a href="#l49.462"></a><span id="l49.462" class="difflineminus">-    }</span>
<a href="#l49.463"></a><span id="l49.463" class="difflineminus">-    else {</span>
<a href="#l49.464"></a><span id="l49.464" class="difflineminus">-      // this can happen if you have more than 2 messages selected</span>
<a href="#l49.465"></a><span id="l49.465" class="difflineminus">-      // in the thread pane, and you deleted one of them from another view</span>
<a href="#l49.466"></a><span id="l49.466" class="difflineminus">-      // (like the view in the stand alone msg window)</span>
<a href="#l49.467"></a><span id="l49.467" class="difflineminus">-      // since multiple messages are still selected, do nothing.</span>
<a href="#l49.468"></a><span id="l49.468" class="difflineminus">-    }</span>
<a href="#l49.469"></a><span id="l49.469" class="difflineminus">-  }</span>
<a href="#l49.470"></a><span id="l49.470" class="difflineminus">-  else {</span>
<a href="#l49.471"></a><span id="l49.471" class="difflineminus">-    if (gNextMessageViewIndexAfterDelete != nsMsgViewIndex_None)</span>
<a href="#l49.472"></a><span id="l49.472" class="difflineminus">-    {</span>
<a href="#l49.473"></a><span id="l49.473" class="difflineminus">-      var viewSize = treeView.rowCount;</span>
<a href="#l49.474"></a><span id="l49.474" class="difflineminus">-      if (gNextMessageViewIndexAfterDelete &gt;= viewSize)</span>
<a href="#l49.475"></a><span id="l49.475" class="difflineminus">-      {</span>
<a href="#l49.476"></a><span id="l49.476" class="difflineminus">-        if (viewSize &gt; 0)</span>
<a href="#l49.477"></a><span id="l49.477" class="difflineminus">-          gNextMessageViewIndexAfterDelete = viewSize - 1;</span>
<a href="#l49.478"></a><span id="l49.478" class="difflineminus">-        else</span>
<a href="#l49.479"></a><span id="l49.479" class="difflineminus">-        {</span>
<a href="#l49.480"></a><span id="l49.480" class="difflineminus">-          gNextMessageViewIndexAfterDelete = nsMsgViewIndex_None;</span>
<a href="#l49.481"></a><span id="l49.481" class="difflineminus">-</span>
<a href="#l49.482"></a><span id="l49.482" class="difflineminus">-          // there is nothing to select since viewSize is 0</span>
<a href="#l49.483"></a><span id="l49.483" class="difflineminus">-          treeSelection.clearSelection();</span>
<a href="#l49.484"></a><span id="l49.484" class="difflineminus">-          setTitleFromFolder(folder, null);</span>
<a href="#l49.485"></a><span id="l49.485" class="difflineminus">-          ClearMessagePane();</span>
<a href="#l49.486"></a><span id="l49.486" class="difflineminus">-          UpdateMailToolbar(&quot;delete from current view, 0 rows left&quot;);</span>
<a href="#l49.487"></a><span id="l49.487" class="difflineminus">-        }</span>
<a href="#l49.488"></a><span id="l49.488" class="difflineminus">-      }</span>
<a href="#l49.489"></a><span id="l49.489" class="difflineminus">-    }</span>
<a href="#l49.490"></a><span id="l49.490" class="difflineminus">-</span>
<a href="#l49.491"></a><span id="l49.491" class="difflineminus">-    // if we are about to set the selection with a new element then DON'T clear</span>
<a href="#l49.492"></a><span id="l49.492" class="difflineminus">-    // the selection then add the next message to select. This just generates</span>
<a href="#l49.493"></a><span id="l49.493" class="difflineminus">-    // an extra round of command updating notifications that we are trying to</span>
<a href="#l49.494"></a><span id="l49.494" class="difflineminus">-    // optimize away.</span>
<a href="#l49.495"></a><span id="l49.495" class="difflineminus">-    if (gNextMessageViewIndexAfterDelete != nsMsgViewIndex_None)</span>
<a href="#l49.496"></a><span id="l49.496" class="difflineminus">-    {</span>
<a href="#l49.497"></a><span id="l49.497" class="difflineminus">-      // When deleting a message we don't update the commands</span>
<a href="#l49.498"></a><span id="l49.498" class="difflineminus">-      // when the selection goes to 0</span>
<a href="#l49.499"></a><span id="l49.499" class="difflineminus">-      // (we have a hack in nsMsgDBView which prevents that update)</span>
<a href="#l49.500"></a><span id="l49.500" class="difflineminus">-      // so there is no need to</span>
<a href="#l49.501"></a><span id="l49.501" class="difflineminus">-      // update commands when we select the next message after the delete;</span>
<a href="#l49.502"></a><span id="l49.502" class="difflineminus">-      // the commands already</span>
<a href="#l49.503"></a><span id="l49.503" class="difflineminus">-      // have the right update state...</span>
<a href="#l49.504"></a><span id="l49.504" class="difflineminus">-      gDBView.suppressCommandUpdating = true;</span>
<a href="#l49.505"></a><span id="l49.505" class="difflineminus">-</span>
<a href="#l49.506"></a><span id="l49.506" class="difflineminus">-      // This check makes sure that the tree does not perform a</span>
<a href="#l49.507"></a><span id="l49.507" class="difflineminus">-      // selection on a non selected row (row &lt; 0), else assertions will</span>
<a href="#l49.508"></a><span id="l49.508" class="difflineminus">-      // be thrown.</span>
<a href="#l49.509"></a><span id="l49.509" class="difflineminus">-      if (gNextMessageViewIndexAfterDelete &gt;= 0)</span>
<a href="#l49.510"></a><span id="l49.510" class="difflineminus">-        treeSelection.select(gNextMessageViewIndexAfterDelete);</span>
<a href="#l49.511"></a><span id="l49.511" class="difflineminus">-</span>
<a href="#l49.512"></a><span id="l49.512" class="difflineminus">-      // If gNextMessageViewIndexAfterDelete has the same value</span>
<a href="#l49.513"></a><span id="l49.513" class="difflineminus">-      // as the last index we had selected, the tree won't generate a</span>
<a href="#l49.514"></a><span id="l49.514" class="difflineminus">-      // selectionChanged notification for the tree view. So force a manual</span>
<a href="#l49.515"></a><span id="l49.515" class="difflineminus">-      // selection changed call.</span>
<a href="#l49.516"></a><span id="l49.516" class="difflineminus">-      // (don't worry it's cheap if we end up calling it twice).</span>
<a href="#l49.517"></a><span id="l49.517" class="difflineminus">-      if (treeView)</span>
<a href="#l49.518"></a><span id="l49.518" class="difflineminus">-        treeView.selectionChanged();</span>
<a href="#l49.519"></a><span id="l49.519" class="difflineminus">-</span>
<a href="#l49.520"></a><span id="l49.520" class="difflineminus">-      EnsureRowInThreadTreeIsVisible(gNextMessageViewIndexAfterDelete);</span>
<a href="#l49.521"></a><span id="l49.521" class="difflineminus">-      gDBView.suppressCommandUpdating = false;</span>
<a href="#l49.522"></a><span id="l49.522" class="difflineminus">-</span>
<a href="#l49.523"></a><span id="l49.523" class="difflineminus">-      // hook for extra toolbar items</span>
<a href="#l49.524"></a><span id="l49.524" class="difflineminus">-      // XXX TODO</span>
<a href="#l49.525"></a><span id="l49.525" class="difflineminus">-      // I think there is a bug in the suppression code above.</span>
<a href="#l49.526"></a><span id="l49.526" class="difflineminus">-      // What if I have two rows selected, and I hit delete,</span>
<a href="#l49.527"></a><span id="l49.527" class="difflineminus">-      // and so we load the next row.</span>
<a href="#l49.528"></a><span id="l49.528" class="difflineminus">-      // What if I have commands that only enable where</span>
<a href="#l49.529"></a><span id="l49.529" class="difflineminus">-      // exactly one row is selected?</span>
<a href="#l49.530"></a><span id="l49.530" class="difflineminus">-      UpdateMailToolbar(&quot;delete from current view, at least one row selected&quot;);</span>
<a href="#l49.531"></a><span id="l49.531" class="difflineminus">-    }</span>
<a href="#l49.532"></a><span id="l49.532" class="difflineminus">-  }</span>
<a href="#l49.533"></a><span id="l49.533" class="difflineminus">-</span>
<a href="#l49.534"></a><span id="l49.534" class="difflineminus">-  // default value after delete/move/copy is over</span>
<a href="#l49.535"></a><span id="l49.535" class="difflineminus">-  gNextMessageViewIndexAfterDelete = -2;</span>
<a href="#l49.536"></a><span id="l49.536" class="difflineminus">-}</span>
<a href="#l49.537"></a><span id="l49.537" class="difflineminus">-</span>
<a href="#l49.538"></a><span id="l49.538" class="difflineminus">-function HandleCompactCompleted(folder)</span>
<a href="#l49.539"></a><span id="l49.539" class="difflineminus">-{</span>
<a href="#l49.540"></a><span id="l49.540" class="difflineminus">-  if (folder &amp;&amp; folder.server.type != &quot;imap&quot;)</span>
<a href="#l49.541"></a><span id="l49.541" class="difflineminus">-  {</span>
<a href="#l49.542"></a><span id="l49.542" class="difflineminus">-    var msgFolder = msgWindow.openFolder;</span>
<a href="#l49.543"></a><span id="l49.543" class="difflineminus">-    if (msgFolder &amp;&amp; folder.URI == msgFolder.URI)</span>
<a href="#l49.544"></a><span id="l49.544" class="difflineminus">-    {</span>
<a href="#l49.545"></a><span id="l49.545" class="difflineminus">-      // pretend the selection changed, to reselect the current folder+view.</span>
<a href="#l49.546"></a><span id="l49.546" class="difflineminus">-      gMsgFolderSelected = null;</span>
<a href="#l49.547"></a><span id="l49.547" class="difflineminus">-      msgWindow.openFolder = null;</span>
<a href="#l49.548"></a><span id="l49.548" class="difflineminus">-      FolderPaneSelectionChange();</span>
<a href="#l49.549"></a><span id="l49.549" class="difflineminus">-      LoadCurrentlyDisplayedMessage();</span>
<a href="#l49.550"></a><span id="l49.550" class="difflineminus">-    }</span>
<a href="#l49.551"></a><span id="l49.551" class="difflineminus">-  }</span>
<a href="#l49.552"></a><span id="l49.552" class="difflineminus">-}</span>
<a href="#l49.553"></a><span id="l49.553" class="difflineminus">-</span>
<a href="#l49.554"></a><span id="l49.554" class="difflineminus">-function LoadCurrentlyDisplayedMessage()</span>
<a href="#l49.555"></a><span id="l49.555" class="difflineminus">-{</span>
<a href="#l49.556"></a><span id="l49.556" class="difflineminus">-  var scrolled = (gCurrentlyDisplayedMessage != nsMsgViewIndex_None);</span>
<a href="#l49.557"></a><span id="l49.557" class="difflineminus">-  if (scrolled)</span>
<a href="#l49.558"></a><span id="l49.558" class="difflineminus">-  {</span>
<a href="#l49.559"></a><span id="l49.559" class="difflineminus">-    var treeView = gDBView.QueryInterface(Components.interfaces.nsITreeView);</span>
<a href="#l49.560"></a><span id="l49.560" class="difflineminus">-    var treeSelection = treeView.selection;</span>
<a href="#l49.561"></a><span id="l49.561" class="difflineminus">-    treeSelection.select(gCurrentlyDisplayedMessage);</span>
<a href="#l49.562"></a><span id="l49.562" class="difflineminus">-    if (treeView)</span>
<a href="#l49.563"></a><span id="l49.563" class="difflineminus">-      treeView.selectionChanged();</span>
<a href="#l49.564"></a><span id="l49.564" class="difflineminus">-    EnsureRowInThreadTreeIsVisible(gCurrentlyDisplayedMessage);</span>
<a href="#l49.565"></a><span id="l49.565" class="difflineminus">-    SetFocusThreadPane();</span>
<a href="#l49.566"></a><span id="l49.566" class="difflineminus">-    gCurrentlyDisplayedMessage = nsMsgViewIndex_None; //reset</span>
<a href="#l49.567"></a><span id="l49.567" class="difflineminus">-  }</span>
<a href="#l49.568"></a><span id="l49.568" class="difflineminus">-  return scrolled;</span>
<a href="#l49.569"></a><span id="l49.569" class="difflineminus">-}</span>
<a href="#l49.570"></a><span id="l49.570" class="difflineminus">-</span>
<a href="#l49.571"></a><span id="l49.571" class="difflineminus">-function IsCurrentLoadedFolder(folder)</span>
<a href="#l49.572"></a><span id="l49.572" class="difflineminus">-{</span>
<a href="#l49.573"></a><span id="l49.573" class="difflineminus">-  var msgfolder = folder.QueryInterface(Components.interfaces.nsIMsgFolder);</span>
<a href="#l49.574"></a><span id="l49.574" class="difflineminus">-  var currentLoadedFolder = GetThreadPaneFolder();</span>
<a href="#l49.575"></a><span id="l49.575" class="difflineminus">-  if (currentLoadedFolder.flags &amp; Components.interfaces.nsMsgFolderFlags.Virtual)</span>
<a href="#l49.576"></a><span id="l49.576" class="difflineminus">-  {</span>
<a href="#l49.577"></a><span id="l49.577" class="difflineminus">-    var dbFolderInfo = currentLoadedFolder.msgDatabase.dBFolderInfo;</span>
<a href="#l49.578"></a><span id="l49.578" class="difflineminus">-    var srchFolderUri = dbFolderInfo.getCharProperty(&quot;searchFolderUri&quot;);</span>
<a href="#l49.579"></a><span id="l49.579" class="difflineminus">-    var re = new RegExp(&quot;^&quot; + msgfolder.URI + &quot;$|^&quot; + msgfolder.URI + &quot;\||\|&quot; +</span>
<a href="#l49.580"></a><span id="l49.580" class="difflineminus">-                        msgfolder.URI + &quot;$|\|&quot; + msgfolder.URI +&quot;\|&quot;);</span>
<a href="#l49.581"></a><span id="l49.581" class="difflineminus">-</span>
<a href="#l49.582"></a><span id="l49.582" class="difflineminus">-    return currentLoadedFolder.URI.match(re);</span>
<a href="#l49.583"></a><span id="l49.583" class="difflineminus">-  }</span>
<a href="#l49.584"></a><span id="l49.584" class="difflineminus">-</span>
<a href="#l49.585"></a><span id="l49.585" class="difflineminus">-  return (currentLoadedFolder.URI == folder.URI);</span>
<a href="#l49.586"></a><span id="l49.586" class="difflineminus">-}</span>
<a href="#l49.587"></a><span id="l49.587" class="difflineminus">-</span>
<a href="#l49.588"></a><span id="l49.588"> function ServerContainsFolder(server, folder)</span>
<a href="#l49.589"></a><span id="l49.589"> {</span>
<a href="#l49.590"></a><span id="l49.590">   if (!folder || !server)</span>
<a href="#l49.591"></a><span id="l49.591">     return false;</span>
<a href="#l49.592"></a><span id="l49.592"> </span>
<a href="#l49.593"></a><span id="l49.593">   return server.equals(folder.server);</span>
<a href="#l49.594"></a><span id="l49.594"> }</span>
<a href="#l49.595"></a><span id="l49.595"> </span>
<a href="#l49.596"></a><span id="l49.596" class="difflineat">@@ -663,29 +274,37 @@ function OnLoadMessenger()</span>
<a href="#l49.597"></a><span id="l49.597">   }</span>
<a href="#l49.598"></a><span id="l49.598"> </span>
<a href="#l49.599"></a><span id="l49.599">   gPrefBranch.QueryInterface(Components.interfaces.nsIPrefBranch2);</span>
<a href="#l49.600"></a><span id="l49.600">   gPrefBranch.addObserver(&quot;mail.pane_config.dynamic&quot;, MailPrefObserver, false);</span>
<a href="#l49.601"></a><span id="l49.601"> </span>
<a href="#l49.602"></a><span id="l49.602">   MailOfflineMgr.init();</span>
<a href="#l49.603"></a><span id="l49.603">   CreateMailWindowGlobals();</span>
<a href="#l49.604"></a><span id="l49.604">   GetMessagePane().collapsed = true;</span>
<a href="#l49.605"></a><span id="l49.605" class="difflineplus">+</span>
<a href="#l49.606"></a><span id="l49.606" class="difflineplus">+  // - initialize tabmail system</span>
<a href="#l49.607"></a><span id="l49.607" class="difflineplus">+  // Do this before LoadPostAccountWizard since that code selects the first</span>
<a href="#l49.608"></a><span id="l49.608" class="difflineplus">+  //  folder for display, and we want gFolderDisplay setup and ready to handle</span>
<a href="#l49.609"></a><span id="l49.609" class="difflineplus">+  //  that event chain.</span>
<a href="#l49.610"></a><span id="l49.610" class="difflineplus">+  // Also, we definitely need to register the tab type prior to the call to</span>
<a href="#l49.611"></a><span id="l49.611" class="difflineplus">+  //  specialTabs.openSpecialTabsOnStartup below.</span>
<a href="#l49.612"></a><span id="l49.612" class="difflineplus">+  let tabmail = document.getElementById('tabmail');</span>
<a href="#l49.613"></a><span id="l49.613" class="difflineplus">+  if (tabmail)</span>
<a href="#l49.614"></a><span id="l49.614" class="difflineplus">+  {</span>
<a href="#l49.615"></a><span id="l49.615" class="difflineplus">+    tabmail.registerTabType(mailTabType);</span>
<a href="#l49.616"></a><span id="l49.616" class="difflineplus">+    tabmail.registerTabMonitor(QuickSearchTabMonitor);</span>
<a href="#l49.617"></a><span id="l49.617" class="difflineplus">+    tabmail.openFirstTab();</span>
<a href="#l49.618"></a><span id="l49.618" class="difflineplus">+  }</span>
<a href="#l49.619"></a><span id="l49.619" class="difflineplus">+</span>
<a href="#l49.620"></a><span id="l49.620">   // verifyAccounts returns true if the callback won't be called</span>
<a href="#l49.621"></a><span id="l49.621">   // We also don't want the account wizard to open if any sort of account exists</span>
<a href="#l49.622"></a><span id="l49.622">   if (verifyAccounts(LoadPostAccountWizard, false))</span>
<a href="#l49.623"></a><span id="l49.623">     LoadPostAccountWizard();</span>
<a href="#l49.624"></a><span id="l49.624"> </span>
<a href="#l49.625"></a><span id="l49.625" class="difflineminus">-  // initialize tabmail system</span>
<a href="#l49.626"></a><span id="l49.626" class="difflineminus">-  let tabmail = document.getElementById('tabmail');</span>
<a href="#l49.627"></a><span id="l49.627" class="difflineminus">-  if (tabmail)</span>
<a href="#l49.628"></a><span id="l49.628" class="difflineminus">-  {</span>
<a href="#l49.629"></a><span id="l49.629" class="difflineminus">-    tabmail.registerTabType(mailTabType);</span>
<a href="#l49.630"></a><span id="l49.630" class="difflineminus">-    tabmail.openFirstTab();</span>
<a href="#l49.631"></a><span id="l49.631" class="difflineminus">-  }</span>
<a href="#l49.632"></a><span id="l49.632" class="difflineminus">-</span>
<a href="#l49.633"></a><span id="l49.633" class="difflineplus">+  // This also registers the contentTabType (&quot;contentTab&quot;)</span>
<a href="#l49.634"></a><span id="l49.634">   specialTabs.openSpecialTabsOnStartup();</span>
<a href="#l49.635"></a><span id="l49.635"> </span>
<a href="#l49.636"></a><span id="l49.636">   window.addEventListener(&quot;AppCommand&quot;, HandleAppCommandEvent, true);</span>
<a href="#l49.637"></a><span id="l49.637"> }</span>
<a href="#l49.638"></a><span id="l49.638"> </span>
<a href="#l49.639"></a><span id="l49.639"> function LoadPostAccountWizard()</span>
<a href="#l49.640"></a><span id="l49.640"> {</span>
<a href="#l49.641"></a><span id="l49.641">   InitMsgWindow();</span>
<a href="#l49.642"></a><span id="l49.642" class="difflineat">@@ -702,89 +321,88 @@ function LoadPostAccountWizard()</span>
<a href="#l49.643"></a><span id="l49.643"> </span>
<a href="#l49.644"></a><span id="l49.644">   gPhishingDetector.init();</span>
<a href="#l49.645"></a><span id="l49.645"> </span>
<a href="#l49.646"></a><span id="l49.646">   AddToSession();</span>
<a href="#l49.647"></a><span id="l49.647"> </span>
<a href="#l49.648"></a><span id="l49.648">   //need to add to session before trying to load start folder otherwise listeners aren't</span>
<a href="#l49.649"></a><span id="l49.649">   //set up correctly.</span>
<a href="#l49.650"></a><span id="l49.650">   // argument[0] --&gt; folder uri</span>
<a href="#l49.651"></a><span id="l49.651" class="difflineminus">-  // argument[1] --&gt; optional message key</span>
<a href="#l49.652"></a><span id="l49.652" class="difflineminus">-  // argument[2] --&gt; optional email address; // Will come from aim; needs to show msgs from buddy's email address.</span>
<a href="#l49.653"></a><span id="l49.653">   if (&quot;arguments&quot; in window)</span>
<a href="#l49.654"></a><span id="l49.654">   {</span>
<a href="#l49.655"></a><span id="l49.655">     // filter our any feed urls that came in as arguments to the new window...</span>
<a href="#l49.656"></a><span id="l49.656">     if (window.arguments.length &amp;&amp; /^feed:/i.test(window.arguments[0] ))</span>
<a href="#l49.657"></a><span id="l49.657">     {</span>
<a href="#l49.658"></a><span id="l49.658">       var feedHandler = Components.classes[&quot;@mozilla.org/newsblog-feed-downloader;1&quot;].getService(Components.interfaces.nsINewsBlogFeedDownloader);</span>
<a href="#l49.659"></a><span id="l49.659">       if (feedHandler)</span>
<a href="#l49.660"></a><span id="l49.660">         feedHandler.subscribeToFeed(window.arguments[0], null, msgWindow);</span>
<a href="#l49.661"></a><span id="l49.661">       gStartFolderUri = null;</span>
<a href="#l49.662"></a><span id="l49.662">     }</span>
<a href="#l49.663"></a><span id="l49.663">     else</span>
<a href="#l49.664"></a><span id="l49.664">       gStartFolderUri = (window.arguments.length &gt; 0) ? window.arguments[0] : null;</span>
<a href="#l49.665"></a><span id="l49.665" class="difflineminus">-    gStartMsgKey = (window.arguments.length &gt; 1) ? window.arguments[1]: nsMsgKey_None;</span>
<a href="#l49.666"></a><span id="l49.666" class="difflineminus">-    gSearchEmailAddress = (window.arguments.length &gt; 2) ? window.arguments[2] : null;</span>
<a href="#l49.667"></a><span id="l49.667">   }</span>
<a href="#l49.668"></a><span id="l49.668"> </span>
<a href="#l49.669"></a><span id="l49.669">   function completeStartup() {</span>
<a href="#l49.670"></a><span id="l49.670" class="difflineminus">-#ifdef HAVE_SHELL_SERVICE</span>
<a href="#l49.671"></a><span id="l49.671">     // Check whether we need to show the default client dialog</span>
<a href="#l49.672"></a><span id="l49.672">     // First, check the shell service</span>
<a href="#l49.673"></a><span id="l49.673">     var nsIShellService = Components.interfaces.nsIShellService;</span>
<a href="#l49.674"></a><span id="l49.674" class="difflineminus">-    var shellService;</span>
<a href="#l49.675"></a><span id="l49.675" class="difflineminus">-    var defaultAccount;</span>
<a href="#l49.676"></a><span id="l49.676" class="difflineminus">-    try {</span>
<a href="#l49.677"></a><span id="l49.677" class="difflineminus">-      shellService = Components.classes[&quot;@mozilla.org/mail/shell-service;1&quot;].getService(nsIShellService);</span>
<a href="#l49.678"></a><span id="l49.678" class="difflineminus">-      defaultAccount = accountManager.defaultAccount;</span>
<a href="#l49.679"></a><span id="l49.679" class="difflineminus">-    } catch (ex) {}</span>
<a href="#l49.680"></a><span id="l49.680" class="difflineplus">+    if (nsIShellService) {</span>
<a href="#l49.681"></a><span id="l49.681" class="difflineplus">+      var shellService;</span>
<a href="#l49.682"></a><span id="l49.682" class="difflineplus">+      var defaultAccount;</span>
<a href="#l49.683"></a><span id="l49.683" class="difflineplus">+      try {</span>
<a href="#l49.684"></a><span id="l49.684" class="difflineplus">+        shellService = Components.classes[&quot;@mozilla.org/mail/shell-service;1&quot;].getService(nsIShellService);</span>
<a href="#l49.685"></a><span id="l49.685" class="difflineplus">+        defaultAccount = accountManager.defaultAccount;</span>
<a href="#l49.686"></a><span id="l49.686" class="difflineplus">+      } catch (ex) {}</span>
<a href="#l49.687"></a><span id="l49.687"> </span>
<a href="#l49.688"></a><span id="l49.688" class="difflineminus">-    // Next, try loading the search integration module</span>
<a href="#l49.689"></a><span id="l49.689" class="difflineminus">-    // We'll get a null SearchIntegration if we don't have one</span>
<a href="#l49.690"></a><span id="l49.690" class="difflineminus">-    Components.utils.import(&quot;resource://app/modules/SearchIntegration.js&quot;);</span>
<a href="#l49.691"></a><span id="l49.691" class="difflineplus">+      // Next, try loading the search integration module</span>
<a href="#l49.692"></a><span id="l49.692" class="difflineplus">+      // We'll get a null SearchIntegration if we don't have one</span>
<a href="#l49.693"></a><span id="l49.693" class="difflineplus">+      Components.utils.import(&quot;resource://app/modules/SearchIntegration.js&quot;);</span>
<a href="#l49.694"></a><span id="l49.694"> </span>
<a href="#l49.695"></a><span id="l49.695" class="difflineminus">-    // Show the default client dialog only if</span>
<a href="#l49.696"></a><span id="l49.696" class="difflineminus">-    // EITHER: we have at least one account, and we aren't already the default</span>
<a href="#l49.697"></a><span id="l49.697" class="difflineminus">-    // for mail,</span>
<a href="#l49.698"></a><span id="l49.698" class="difflineminus">-    // OR: we have the search integration module, the OS version is suitable,</span>
<a href="#l49.699"></a><span id="l49.699" class="difflineminus">-    // and the first run hasn't already been completed.</span>
<a href="#l49.700"></a><span id="l49.700" class="difflineminus">-    // Needs to be shown outside the he normal load sequence so it doesn't appear</span>
<a href="#l49.701"></a><span id="l49.701" class="difflineminus">-    // before any other displays, in the wrong place of the screen.</span>
<a href="#l49.702"></a><span id="l49.702" class="difflineminus">-    if ((shellService &amp;&amp; defaultAccount &amp;&amp; shellService.shouldCheckDefaultClient</span>
<a href="#l49.703"></a><span id="l49.703" class="difflineminus">-         &amp;&amp; !shellService.isDefaultClient(true, nsIShellService.MAIL)) ||</span>
<a href="#l49.704"></a><span id="l49.704" class="difflineplus">+      // Show the default client dialog only if</span>
<a href="#l49.705"></a><span id="l49.705" class="difflineplus">+      // EITHER: we have at least one account, and we aren't already the default</span>
<a href="#l49.706"></a><span id="l49.706" class="difflineplus">+      // for mail,</span>
<a href="#l49.707"></a><span id="l49.707" class="difflineplus">+      // OR: we have the search integration module, the OS version is suitable,</span>
<a href="#l49.708"></a><span id="l49.708" class="difflineplus">+      // and the first run hasn't already been completed.</span>
<a href="#l49.709"></a><span id="l49.709" class="difflineplus">+      // Needs to be shown outside the he normal load sequence so it doesn't appear</span>
<a href="#l49.710"></a><span id="l49.710" class="difflineplus">+      // before any other displays, in the wrong place of the screen.</span>
<a href="#l49.711"></a><span id="l49.711" class="difflineplus">+      if ((shellService &amp;&amp; defaultAccount &amp;&amp; shellService.shouldCheckDefaultClient</span>
<a href="#l49.712"></a><span id="l49.712" class="difflineplus">+           &amp;&amp; !shellService.isDefaultClient(true, nsIShellService.MAIL)) ||</span>
<a href="#l49.713"></a><span id="l49.713">         (SearchIntegration &amp;&amp; !SearchIntegration.osVersionTooLow &amp;&amp;</span>
<a href="#l49.714"></a><span id="l49.714">          !SearchIntegration.osComponentsNotRunning &amp;&amp; !SearchIntegration.firstRunDone))</span>
<a href="#l49.715"></a><span id="l49.715" class="difflineminus">-      window.openDialog(&quot;chrome://messenger/content/systemIntegrationDialog.xul&quot;,</span>
<a href="#l49.716"></a><span id="l49.716" class="difflineminus">-                        &quot;SystemIntegration&quot;, &quot;modal,centerscreen,chrome,resizable=no&quot;);</span>
<a href="#l49.717"></a><span id="l49.717" class="difflineminus">-#endif</span>
<a href="#l49.718"></a><span id="l49.718" class="difflineplus">+        window.openDialog(&quot;chrome://messenger/content/systemIntegrationDialog.xul&quot;,</span>
<a href="#l49.719"></a><span id="l49.719" class="difflineplus">+                          &quot;SystemIntegration&quot;, &quot;modal,centerscreen,chrome,resizable=no&quot;);</span>
<a href="#l49.720"></a><span id="l49.720" class="difflineplus">+    }</span>
<a href="#l49.721"></a><span id="l49.721"> </span>
<a href="#l49.722"></a><span id="l49.722">     // All core modal dialogs are done, the user can now interact with the 3-pane window</span>
<a href="#l49.723"></a><span id="l49.723">     var obs = Components.classes[&quot;@mozilla.org/observer-service;1&quot;]</span>
<a href="#l49.724"></a><span id="l49.724">                         .getService(Components.interfaces.nsIObserverService);</span>
<a href="#l49.725"></a><span id="l49.725">     obs.notifyObservers(window, &quot;mail-startup-done&quot;, null);</span>
<a href="#l49.726"></a><span id="l49.726">   }</span>
<a href="#l49.727"></a><span id="l49.727"> </span>
<a href="#l49.728"></a><span id="l49.728">   setTimeout(completeStartup, 0);</span>
<a href="#l49.729"></a><span id="l49.729"> </span>
<a href="#l49.730"></a><span id="l49.730">   // FIX ME - later we will be able to use onload from the overlay</span>
<a href="#l49.731"></a><span id="l49.731">   OnLoadMsgHeaderPane();</span>
<a href="#l49.732"></a><span id="l49.732"> </span>
<a href="#l49.733"></a><span id="l49.733" class="difflineminus">-  gHaveLoadedMessage = false;</span>
<a href="#l49.734"></a><span id="l49.734" class="difflineminus">-</span>
<a href="#l49.735"></a><span id="l49.735">   //Set focus to the Thread Pane the first time the window is opened.</span>
<a href="#l49.736"></a><span id="l49.736">   SetFocusThreadPane();</span>
<a href="#l49.737"></a><span id="l49.737"> </span>
<a href="#l49.738"></a><span id="l49.738">   // initialize the customizeDone method on the customizeable toolbar</span>
<a href="#l49.739"></a><span id="l49.739">   var toolbox = document.getElementById(&quot;mail-toolbox&quot;);</span>
<a href="#l49.740"></a><span id="l49.740">   toolbox.customizeDone = function(aEvent) { MailToolboxCustomizeDone(aEvent, &quot;CustomizeMailToolbar&quot;); };</span>
<a href="#l49.741"></a><span id="l49.741"> </span>
<a href="#l49.742"></a><span id="l49.742">   var toolbarset = document.getElementById('customToolbars');</span>
<a href="#l49.743"></a><span id="l49.743">   toolbox.toolbarset = toolbarset;</span>
<a href="#l49.744"></a><span id="l49.744"> </span>
<a href="#l49.745"></a><span id="l49.745" class="difflineminus">-  loadStartFolder(gStartFolderUri);</span>
<a href="#l49.746"></a><span id="l49.746" class="difflineplus">+  // XXX Do not select the folder until the window displays or the threadpane</span>
<a href="#l49.747"></a><span id="l49.747" class="difflineplus">+  //  will be at minimum size.  We used to have</span>
<a href="#l49.748"></a><span id="l49.748" class="difflineplus">+  //  gFolderDisplay.ensureRowIsVisible use settimeout itself to defer that</span>
<a href="#l49.749"></a><span id="l49.749" class="difflineplus">+  //  calculation, but that was ugly.  Also, in theory we will open the window</span>
<a href="#l49.750"></a><span id="l49.750" class="difflineplus">+  //  faster if we let the event loop start doing things sooner.</span>
<a href="#l49.751"></a><span id="l49.751" class="difflineplus">+  window.setTimeout(loadStartFolder, 0, gStartFolderUri);</span>
<a href="#l49.752"></a><span id="l49.752"> }</span>
<a href="#l49.753"></a><span id="l49.753"> </span>
<a href="#l49.754"></a><span id="l49.754"> function HandleAppCommandEvent(evt)</span>
<a href="#l49.755"></a><span id="l49.755"> {</span>
<a href="#l49.756"></a><span id="l49.756">   evt.stopPropagation();</span>
<a href="#l49.757"></a><span id="l49.757">   switch (evt.command) {</span>
<a href="#l49.758"></a><span id="l49.758">     case &quot;Back&quot;:</span>
<a href="#l49.759"></a><span id="l49.759">       goDoCommand('cmd_goBack');</span>
<a href="#l49.760"></a><span id="l49.760" class="difflineat">@@ -803,24 +421,31 @@ function HandleAppCommandEvent(evt)</span>
<a href="#l49.761"></a><span id="l49.761">       break;</span>
<a href="#l49.762"></a><span id="l49.762">     case &quot;Home&quot;:</span>
<a href="#l49.763"></a><span id="l49.763">     case &quot;Reload&quot;:</span>
<a href="#l49.764"></a><span id="l49.764">     default:</span>
<a href="#l49.765"></a><span id="l49.765">       break;</span>
<a href="#l49.766"></a><span id="l49.766">   }</span>
<a href="#l49.767"></a><span id="l49.767"> }</span>
<a href="#l49.768"></a><span id="l49.768"> </span>
<a href="#l49.769"></a><span id="l49.769" class="difflineplus">+/**</span>
<a href="#l49.770"></a><span id="l49.770" class="difflineplus">+ * Called by messenger.xul:onunload, the 3-pane window inside of tabs window.</span>
<a href="#l49.771"></a><span id="l49.771" class="difflineplus">+ *  It's being unloaded!  Right now!</span>
<a href="#l49.772"></a><span id="l49.772" class="difflineplus">+ */</span>
<a href="#l49.773"></a><span id="l49.773"> function OnUnloadMessenger()</span>
<a href="#l49.774"></a><span id="l49.774"> {</span>
<a href="#l49.775"></a><span id="l49.775" class="difflineminus">-  OnLeavingFolder(gMsgFolderSelected);  // mark all read in current folder</span>
<a href="#l49.776"></a><span id="l49.776">   accountManager.removeIncomingServerListener(gThreePaneIncomingServerListener);</span>
<a href="#l49.777"></a><span id="l49.777">   gPrefBranch.QueryInterface(Components.interfaces.nsIPrefBranch2);</span>
<a href="#l49.778"></a><span id="l49.778">   gPrefBranch.removeObserver(&quot;mail.pane_config.dynamic&quot;, MailPrefObserver);</span>
<a href="#l49.779"></a><span id="l49.779">   document.getElementById('tabmail').closeTabs();</span>
<a href="#l49.780"></a><span id="l49.780"> </span>
<a href="#l49.781"></a><span id="l49.781" class="difflineplus">+  var mailSession = Components.classes[&quot;@mozilla.org/messenger/services/session;1&quot;]</span>
<a href="#l49.782"></a><span id="l49.782" class="difflineplus">+                              .getService(Components.interfaces.nsIMsgMailSession);</span>
<a href="#l49.783"></a><span id="l49.783" class="difflineplus">+  mailSession.RemoveFolderListener(folderListener);</span>
<a href="#l49.784"></a><span id="l49.784" class="difflineplus">+</span>
<a href="#l49.785"></a><span id="l49.785">   gPhishingDetector.shutdown();</span>
<a href="#l49.786"></a><span id="l49.786"> </span>
<a href="#l49.787"></a><span id="l49.787">   // FIX ME - later we will be able to use onload from the overlay</span>
<a href="#l49.788"></a><span id="l49.788">   OnUnloadMsgHeaderPane();</span>
<a href="#l49.789"></a><span id="l49.789"> </span>
<a href="#l49.790"></a><span id="l49.790">   UnloadPanes();</span>
<a href="#l49.791"></a><span id="l49.791"> </span>
<a href="#l49.792"></a><span id="l49.792">   OnMailWindowUnload();</span>
<a href="#l49.793"></a><span id="l49.793" class="difflineat">@@ -968,17 +593,17 @@ function InitPanes()</span>
<a href="#l49.794"></a><span id="l49.794"> {</span>
<a href="#l49.795"></a><span id="l49.795">   gFolderTreeView.load(document.getElementById(&quot;folderTree&quot;),</span>
<a href="#l49.796"></a><span id="l49.796">                        &quot;folderTree.json&quot;);</span>
<a href="#l49.797"></a><span id="l49.797">   var folderTree = document.getElementById(&quot;folderTree&quot;);</span>
<a href="#l49.798"></a><span id="l49.798">   folderTree.addEventListener(&quot;click&quot;,FolderPaneOnClick,true);</span>
<a href="#l49.799"></a><span id="l49.799">   folderTree.addEventListener(&quot;mousedown&quot;,TreeOnMouseDown,true);</span>
<a href="#l49.800"></a><span id="l49.800">   var threadTree = document.getElementById(&quot;threadTree&quot;);</span>
<a href="#l49.801"></a><span id="l49.801">   threadTree.addEventListener(&quot;click&quot;,ThreadTreeOnClick,true);</span>
<a href="#l49.802"></a><span id="l49.802" class="difflineminus">-                       </span>
<a href="#l49.803"></a><span id="l49.803" class="difflineplus">+</span>
<a href="#l49.804"></a><span id="l49.804">   OnLoadThreadPane();</span>
<a href="#l49.805"></a><span id="l49.805">   SetupCommandUpdateHandlers();</span>
<a href="#l49.806"></a><span id="l49.806"> }</span>
<a href="#l49.807"></a><span id="l49.807"> </span>
<a href="#l49.808"></a><span id="l49.808"> function UnloadPanes()</span>
<a href="#l49.809"></a><span id="l49.809"> {</span>
<a href="#l49.810"></a><span id="l49.810">   var threadTree = document.getElementById(&quot;threadTree&quot;);</span>
<a href="#l49.811"></a><span id="l49.811">   threadTree.removeEventListener(&quot;click&quot;,ThreadTreeOnClick,true);</span>
<a href="#l49.812"></a><span id="l49.812" class="difflineat">@@ -1004,73 +629,73 @@ function UpgradeThreadPaneUI()</span>
<a href="#l49.813"></a><span id="l49.813">     threadPaneUIVersion = gPrefBranch.getIntPref(&quot;mailnews.ui.threadpane.version&quot;);</span>
<a href="#l49.814"></a><span id="l49.814"> </span>
<a href="#l49.815"></a><span id="l49.815">     if (threadPaneUIVersion &lt; 7)</span>
<a href="#l49.816"></a><span id="l49.816">     {</span>
<a href="#l49.817"></a><span id="l49.817">       // Mark all imap folders as offline at the very first run of TB v3</span>
<a href="#l49.818"></a><span id="l49.818">       // We use the threadpane ui version to determine TB profile version</span>
<a href="#l49.819"></a><span id="l49.819">       let servers = Components.classes[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l49.820"></a><span id="l49.820">                       .getService(Components.interfaces.nsIMsgAccountManager).allServers;</span>
<a href="#l49.821"></a><span id="l49.821" class="difflineminus">-      </span>
<a href="#l49.822"></a><span id="l49.822" class="difflineplus">+</span>
<a href="#l49.823"></a><span id="l49.823">       for each (let server in fixIterator(servers, Components.interfaces.nsIMsgIncomingServer))</span>
<a href="#l49.824"></a><span id="l49.824">       {</span>
<a href="#l49.825"></a><span id="l49.825">         if (server.type != &quot;imap&quot;)</span>
<a href="#l49.826"></a><span id="l49.826">           continue;</span>
<a href="#l49.827"></a><span id="l49.827" class="difflineminus">-        </span>
<a href="#l49.828"></a><span id="l49.828" class="difflineplus">+</span>
<a href="#l49.829"></a><span id="l49.829">         let allFolders = Components.classes[&quot;@mozilla.org/supports-array;1&quot;]</span>
<a href="#l49.830"></a><span id="l49.830">                           .createInstance(Components.interfaces.nsISupportsArray);</span>
<a href="#l49.831"></a><span id="l49.831">         server.rootFolder.ListDescendents(allFolders);</span>
<a href="#l49.832"></a><span id="l49.832">         for each (let folder in fixIterator(allFolders, Components.interfaces.nsIMsgFolder))</span>
<a href="#l49.833"></a><span id="l49.833">           folder.setFlag(Components.interfaces.nsMsgFolderFlags.Offline);</span>
<a href="#l49.834"></a><span id="l49.834">       }</span>
<a href="#l49.835"></a><span id="l49.835" class="difflineminus">-      </span>
<a href="#l49.836"></a><span id="l49.836" class="difflineplus">+</span>
<a href="#l49.837"></a><span id="l49.837">       // Note: threadTree._reorderColumn will throw an ERROR if the columns specified are already in the same order!</span>
<a href="#l49.838"></a><span id="l49.838">       if (threadPaneUIVersion &lt; 6)</span>
<a href="#l49.839"></a><span id="l49.839">       {</span>
<a href="#l49.840"></a><span id="l49.840">         var threadTree = document.getElementById(&quot;threadTree&quot;);</span>
<a href="#l49.841"></a><span id="l49.841">         var dateCol = document.getElementById(&quot;dateCol&quot;);</span>
<a href="#l49.842"></a><span id="l49.842">         var receivedCol = document.getElementById(&quot;receivedCol&quot;);</span>
<a href="#l49.843"></a><span id="l49.843">         var junkCol = document.getElementById(&quot;junkStatusCol&quot;);</span>
<a href="#l49.844"></a><span id="l49.844" class="difflineminus">-  </span>
<a href="#l49.845"></a><span id="l49.845" class="difflineplus">+</span>
<a href="#l49.846"></a><span id="l49.846">         if (threadPaneUIVersion &lt; 5)</span>
<a href="#l49.847"></a><span id="l49.847">         {</span>
<a href="#l49.848"></a><span id="l49.848">           if (threadPaneUIVersion &lt; 4)</span>
<a href="#l49.849"></a><span id="l49.849">           {</span>
<a href="#l49.850"></a><span id="l49.850">             if (threadPaneUIVersion &lt; 3)</span>
<a href="#l49.851"></a><span id="l49.851">             {</span>
<a href="#l49.852"></a><span id="l49.852" class="difflineminus">-  </span>
<a href="#l49.853"></a><span id="l49.853" class="difflineplus">+</span>
<a href="#l49.854"></a><span id="l49.854">               // in thunderbird, we are inserting the junk column just before the</span>
<a href="#l49.855"></a><span id="l49.855">               // date column.</span>
<a href="#l49.856"></a><span id="l49.856">               threadTree._reorderColumn(junkCol, dateCol, true);</span>
<a href="#l49.857"></a><span id="l49.857">             }</span>
<a href="#l49.858"></a><span id="l49.858" class="difflineminus">-  </span>
<a href="#l49.859"></a><span id="l49.859" class="difflineplus">+</span>
<a href="#l49.860"></a><span id="l49.860">             var senderCol = document.getElementById(&quot;senderCol&quot;);</span>
<a href="#l49.861"></a><span id="l49.861">             var recipientCol = document.getElementById(&quot;recipientCol&quot;);</span>
<a href="#l49.862"></a><span id="l49.862">             threadTree._reorderColumn(recipientCol, junkCol, true);</span>
<a href="#l49.863"></a><span id="l49.863">             threadTree._reorderColumn(senderCol, recipientCol, true);</span>
<a href="#l49.864"></a><span id="l49.864" class="difflineminus">-  </span>
<a href="#l49.865"></a><span id="l49.865" class="difflineplus">+</span>
<a href="#l49.866"></a><span id="l49.866">           } // version 4 upgrades</span>
<a href="#l49.867"></a><span id="l49.867" class="difflineminus">-  </span>
<a href="#l49.868"></a><span id="l49.868" class="difflineplus">+</span>
<a href="#l49.869"></a><span id="l49.869">           // version 5 adds a new column called attachments</span>
<a href="#l49.870"></a><span id="l49.870">           var attachmentCol = document.getElementById(&quot;attachmentCol&quot;);</span>
<a href="#l49.871"></a><span id="l49.871">           var subjectCol = document.getElementById(&quot;subjectCol&quot;);</span>
<a href="#l49.872"></a><span id="l49.872" class="difflineminus">-  </span>
<a href="#l49.873"></a><span id="l49.873" class="difflineplus">+</span>
<a href="#l49.874"></a><span id="l49.874">           threadTree._reorderColumn(attachmentCol, subjectCol, true);</span>
<a href="#l49.875"></a><span id="l49.875" class="difflineminus">-  </span>
<a href="#l49.876"></a><span id="l49.876" class="difflineplus">+</span>
<a href="#l49.877"></a><span id="l49.877">         } // version 5 upgrades</span>
<a href="#l49.878"></a><span id="l49.878" class="difflineminus">-  </span>
<a href="#l49.879"></a><span id="l49.879" class="difflineplus">+</span>
<a href="#l49.880"></a><span id="l49.880">         if (dateCol)</span>
<a href="#l49.881"></a><span id="l49.881">           threadTree._reorderColumn(receivedCol, dateCol, true);</span>
<a href="#l49.882"></a><span id="l49.882">         else</span>
<a href="#l49.883"></a><span id="l49.883">           threadTree._reorderColumn(receivedCol, junkCol, false);</span>
<a href="#l49.884"></a><span id="l49.884" class="difflineminus">-   </span>
<a href="#l49.885"></a><span id="l49.885" class="difflineplus">+</span>
<a href="#l49.886"></a><span id="l49.886">       } // version 6 upgrades</span>
<a href="#l49.887"></a><span id="l49.887" class="difflineminus">-      </span>
<a href="#l49.888"></a><span id="l49.888" class="difflineplus">+</span>
<a href="#l49.889"></a><span id="l49.889">       gPrefBranch.setIntPref(&quot;mailnews.ui.threadpane.version&quot;, 7);</span>
<a href="#l49.890"></a><span id="l49.890" class="difflineminus">- </span>
<a href="#l49.891"></a><span id="l49.891" class="difflineplus">+</span>
<a href="#l49.892"></a><span id="l49.892">     } // version 7 upgrades</span>
<a href="#l49.893"></a><span id="l49.893">   }</span>
<a href="#l49.894"></a><span id="l49.894">   catch (ex) {</span>
<a href="#l49.895"></a><span id="l49.895">     dump(&quot;UpgradeThreadPane: ex = &quot; + ex + &quot;\n&quot;);</span>
<a href="#l49.896"></a><span id="l49.896">   }</span>
<a href="#l49.897"></a><span id="l49.897"> }</span>
<a href="#l49.898"></a><span id="l49.898"> </span>
<a href="#l49.899"></a><span id="l49.899"> function OnLoadThreadPane()</span>
<a href="#l49.900"></a><span id="l49.900" class="difflineat">@@ -1145,95 +770,114 @@ function GetTotalCountElement()</span>
<a href="#l49.901"></a><span id="l49.901"> </span>
<a href="#l49.902"></a><span id="l49.902"> function IsMessagePaneCollapsed()</span>
<a href="#l49.903"></a><span id="l49.903"> {</span>
<a href="#l49.904"></a><span id="l49.904">   return GetMessagePane().collapsed;</span>
<a href="#l49.905"></a><span id="l49.905"> }</span>
<a href="#l49.906"></a><span id="l49.906"> </span>
<a href="#l49.907"></a><span id="l49.907"> function ClearThreadPaneSelection()</span>
<a href="#l49.908"></a><span id="l49.908"> {</span>
<a href="#l49.909"></a><span id="l49.909" class="difflineminus">-  try {</span>
<a href="#l49.910"></a><span id="l49.910" class="difflineminus">-    if (gDBView) {</span>
<a href="#l49.911"></a><span id="l49.911" class="difflineminus">-      var treeView = gDBView.QueryInterface(Components.interfaces.nsITreeView);</span>
<a href="#l49.912"></a><span id="l49.912" class="difflineminus">-      var treeSelection = treeView.selection;</span>
<a href="#l49.913"></a><span id="l49.913" class="difflineminus">-      if (treeSelection)</span>
<a href="#l49.914"></a><span id="l49.914" class="difflineminus">-        treeSelection.clearSelection();</span>
<a href="#l49.915"></a><span id="l49.915" class="difflineminus">-    }</span>
<a href="#l49.916"></a><span id="l49.916" class="difflineminus">-  }</span>
<a href="#l49.917"></a><span id="l49.917" class="difflineminus">-  catch (ex) {</span>
<a href="#l49.918"></a><span id="l49.918" class="difflineminus">-    dump(&quot;ClearThreadPaneSelection: ex = &quot; + ex + &quot;\n&quot;);</span>
<a href="#l49.919"></a><span id="l49.919" class="difflineminus">-  }</span>
<a href="#l49.920"></a><span id="l49.920" class="difflineplus">+  gFolderDisplay.clearSelection();</span>
<a href="#l49.921"></a><span id="l49.921"> }</span>
<a href="#l49.922"></a><span id="l49.922"> </span>
<a href="#l49.923"></a><span id="l49.923"> function ClearMessagePane()</span>
<a href="#l49.924"></a><span id="l49.924"> {</span>
<a href="#l49.925"></a><span id="l49.925" class="difflineminus">-  if(gHaveLoadedMessage)</span>
<a href="#l49.926"></a><span id="l49.926" class="difflineminus">-  {</span>
<a href="#l49.927"></a><span id="l49.927" class="difflineminus">-    gHaveLoadedMessage = false;</span>
<a href="#l49.928"></a><span id="l49.928" class="difflineminus">-    if (GetMessagePaneFrame().location.href != &quot;about:blank&quot;)</span>
<a href="#l49.929"></a><span id="l49.929" class="difflineminus">-        GetMessagePaneFrame().location.href = &quot;about:blank&quot;;</span>
<a href="#l49.930"></a><span id="l49.930" class="difflineminus">-</span>
<a href="#l49.931"></a><span id="l49.931" class="difflineminus">-    // hide the message header view AND the message pane...</span>
<a href="#l49.932"></a><span id="l49.932" class="difflineminus">-    HideMessageHeaderPane();</span>
<a href="#l49.933"></a><span id="l49.933" class="difflineminus">-    gMessageNotificationBar.clearMsgNotifications();</span>
<a href="#l49.934"></a><span id="l49.934" class="difflineminus">-    ClearPendingReadTimer();</span>
<a href="#l49.935"></a><span id="l49.935" class="difflineminus">-  }</span>
<a href="#l49.936"></a><span id="l49.936" class="difflineplus">+  // hide the message header view AND the message pane...</span>
<a href="#l49.937"></a><span id="l49.937" class="difflineplus">+  HideMessageHeaderPane();</span>
<a href="#l49.938"></a><span id="l49.938" class="difflineplus">+  gMessageNotificationBar.clearMsgNotifications();</span>
<a href="#l49.939"></a><span id="l49.939" class="difflineplus">+  ClearPendingReadTimer();</span>
<a href="#l49.940"></a><span id="l49.940" class="difflineplus">+  GetMessagePaneFrame().location.href = &quot;about:blank&quot;;</span>
<a href="#l49.941"></a><span id="l49.941"> }</span>
<a href="#l49.942"></a><span id="l49.942"> </span>
<a href="#l49.943"></a><span id="l49.943" class="difflineminus">-// Function to change the highlighted row to where the mouse was clicked</span>
<a href="#l49.944"></a><span id="l49.944" class="difflineminus">-// without loading the contents of the selected row.</span>
<a href="#l49.945"></a><span id="l49.945" class="difflineminus">-// It will also keep the outline/dotted line in the original row.</span>
<a href="#l49.946"></a><span id="l49.946" class="difflineminus">-function ChangeSelectionWithoutContentLoad(event, tree)</span>
<a href="#l49.947"></a><span id="l49.947" class="difflineplus">+/**</span>
<a href="#l49.948"></a><span id="l49.948" class="difflineplus">+ * When right-clicks happen, we do not want to corrupt the underlying</span>
<a href="#l49.949"></a><span id="l49.949" class="difflineplus">+ * selection.  The right-click is a transient selection.  So, unless the</span>
<a href="#l49.950"></a><span id="l49.950" class="difflineplus">+ * user is right-clicking on the current selection, we create a new</span>
<a href="#l49.951"></a><span id="l49.951" class="difflineplus">+ * selection object (thanks to JSTreeSelection) and set that as the</span>
<a href="#l49.952"></a><span id="l49.952" class="difflineplus">+ * current/transient selection.</span>
<a href="#l49.953"></a><span id="l49.953" class="difflineplus">+ *</span>
<a href="#l49.954"></a><span id="l49.954" class="difflineplus">+ * It is up you to call RestoreSelectionWithoutContentLoad to clean up when we</span>
<a href="#l49.955"></a><span id="l49.955" class="difflineplus">+ * are done.</span>
<a href="#l49.956"></a><span id="l49.956" class="difflineplus">+ *</span>
<a href="#l49.957"></a><span id="l49.957" class="difflineplus">+ * @param aSingleSelect Should the selection we create be a single selection?</span>
<a href="#l49.958"></a><span id="l49.958" class="difflineplus">+ *     This is relevant if the row being clicked on is already part of the</span>
<a href="#l49.959"></a><span id="l49.959" class="difflineplus">+ *     selection.  If it is part of the selection and !aSingleSelect, then we</span>
<a href="#l49.960"></a><span id="l49.960" class="difflineplus">+ *     leave the selection as is.  If it is part of the selection and</span>
<a href="#l49.961"></a><span id="l49.961" class="difflineplus">+ *     aSingleSelect then we create a transient single-row selection.</span>
<a href="#l49.962"></a><span id="l49.962" class="difflineplus">+ */</span>
<a href="#l49.963"></a><span id="l49.963" class="difflineplus">+function ChangeSelectionWithoutContentLoad(event, tree, aSingleSelect)</span>
<a href="#l49.964"></a><span id="l49.964"> {</span>
<a href="#l49.965"></a><span id="l49.965" class="difflineminus">-    var treeBoxObj = tree.treeBoxObject;</span>
<a href="#l49.966"></a><span id="l49.966" class="difflineminus">-    if (!treeBoxObj)</span>
<a href="#l49.967"></a><span id="l49.967" class="difflineminus">-    {</span>
<a href="#l49.968"></a><span id="l49.968" class="difflineminus">-      event.stopPropagation();</span>
<a href="#l49.969"></a><span id="l49.969" class="difflineminus">-      return;</span>
<a href="#l49.970"></a><span id="l49.970" class="difflineminus">-    }</span>
<a href="#l49.971"></a><span id="l49.971" class="difflineminus">-    var treeSelection = treeBoxObj.view.selection;</span>
<a href="#l49.972"></a><span id="l49.972" class="difflineplus">+  var treeBoxObj = tree.treeBoxObject;</span>
<a href="#l49.973"></a><span id="l49.973" class="difflineplus">+  if (!treeBoxObj) {</span>
<a href="#l49.974"></a><span id="l49.974" class="difflineplus">+    event.stopPropagation();</span>
<a href="#l49.975"></a><span id="l49.975" class="difflineplus">+    return;</span>
<a href="#l49.976"></a><span id="l49.976" class="difflineplus">+  }</span>
<a href="#l49.977"></a><span id="l49.977" class="difflineplus">+</span>
<a href="#l49.978"></a><span id="l49.978" class="difflineplus">+  var treeSelection = treeBoxObj.view.selection;</span>
<a href="#l49.979"></a><span id="l49.979"> </span>
<a href="#l49.980"></a><span id="l49.980" class="difflineminus">-    var row = treeBoxObj.getRowAt(event.clientX, event.clientY);</span>
<a href="#l49.981"></a><span id="l49.981" class="difflineminus">-    // make sure that row.value is valid so that it doesn't mess up</span>
<a href="#l49.982"></a><span id="l49.982" class="difflineminus">-    // the call to ensureRowIsVisible().</span>
<a href="#l49.983"></a><span id="l49.983" class="difflineminus">-    if((row &gt;= 0) &amp;&amp; !treeSelection.isSelected(row))</span>
<a href="#l49.984"></a><span id="l49.984" class="difflineminus">-    {</span>
<a href="#l49.985"></a><span id="l49.985" class="difflineminus">-        var saveCurrentIndex = treeSelection.currentIndex;</span>
<a href="#l49.986"></a><span id="l49.986" class="difflineminus">-        treeSelection.selectEventsSuppressed = true;</span>
<a href="#l49.987"></a><span id="l49.987" class="difflineminus">-        treeSelection.select(row);</span>
<a href="#l49.988"></a><span id="l49.988" class="difflineminus">-        treeSelection.currentIndex = saveCurrentIndex;</span>
<a href="#l49.989"></a><span id="l49.989" class="difflineminus">-        treeBoxObj.ensureRowIsVisible(row);</span>
<a href="#l49.990"></a><span id="l49.990" class="difflineminus">-        treeSelection.selectEventsSuppressed = false;</span>
<a href="#l49.991"></a><span id="l49.991" class="difflineplus">+  var row = treeBoxObj.getRowAt(event.clientX, event.clientY);</span>
<a href="#l49.992"></a><span id="l49.992" class="difflineplus">+  // Only do something if:</span>
<a href="#l49.993"></a><span id="l49.993" class="difflineplus">+  // - the row is valid</span>
<a href="#l49.994"></a><span id="l49.994" class="difflineplus">+  // - it's not already selected (or we want a single selection)</span>
<a href="#l49.995"></a><span id="l49.995" class="difflineplus">+  if (row &gt;= 0 &amp;&amp;</span>
<a href="#l49.996"></a><span id="l49.996" class="difflineplus">+      (aSingleSelect || !treeSelection.isSelected(row))) {</span>
<a href="#l49.997"></a><span id="l49.997" class="difflineplus">+    // Check if the row is exactly the existing selection.  In that case</span>
<a href="#l49.998"></a><span id="l49.998" class="difflineplus">+    //  there is no need to create a bogus selection.</span>
<a href="#l49.999"></a><span id="l49.999" class="difflineplus">+    if (treeSelection.count == 1) {</span>
<a href="#l49.1000"></a><span id="l49.1000" class="difflineplus">+      let minObj = {};</span>
<a href="#l49.1001"></a><span id="l49.1001" class="difflineplus">+      treeSelection.getRangeAt(0, minObj, {});</span>
<a href="#l49.1002"></a><span id="l49.1002" class="difflineplus">+      if (minObj.value == row) {</span>
<a href="#l49.1003"></a><span id="l49.1003" class="difflineplus">+        event.stopPropagation();</span>
<a href="#l49.1004"></a><span id="l49.1004" class="difflineplus">+        return;</span>
<a href="#l49.1005"></a><span id="l49.1005" class="difflineplus">+      }</span>
<a href="#l49.1006"></a><span id="l49.1006" class="difflineplus">+    }</span>
<a href="#l49.1007"></a><span id="l49.1007" class="difflineplus">+</span>
<a href="#l49.1008"></a><span id="l49.1008" class="difflineplus">+    let transientSelection = new JSTreeSelection(treeBoxObj);</span>
<a href="#l49.1009"></a><span id="l49.1009" class="difflineplus">+    transientSelection.logAdjustSelectionForReplay();</span>
<a href="#l49.1010"></a><span id="l49.1010"> </span>
<a href="#l49.1011"></a><span id="l49.1011" class="difflineminus">-        // Keep track of which row in the thread pane is currently selected.</span>
<a href="#l49.1012"></a><span id="l49.1012" class="difflineminus">-        if(tree.id == &quot;threadTree&quot;)</span>
<a href="#l49.1013"></a><span id="l49.1013" class="difflineminus">-          gThreadPaneCurrentSelectedIndex = row;</span>
<a href="#l49.1014"></a><span id="l49.1014" class="difflineminus">-    }</span>
<a href="#l49.1015"></a><span id="l49.1015" class="difflineminus">-    event.stopPropagation();</span>
<a href="#l49.1016"></a><span id="l49.1016" class="difflineplus">+    gRightMouseButtonSavedSelection = {</span>
<a href="#l49.1017"></a><span id="l49.1017" class="difflineplus">+      view: treeBoxObj.view,</span>
<a href="#l49.1018"></a><span id="l49.1018" class="difflineplus">+      realSelection: treeSelection,</span>
<a href="#l49.1019"></a><span id="l49.1019" class="difflineplus">+      transientSelection: transientSelection</span>
<a href="#l49.1020"></a><span id="l49.1020" class="difflineplus">+    };</span>
<a href="#l49.1021"></a><span id="l49.1021" class="difflineplus">+</span>
<a href="#l49.1022"></a><span id="l49.1022" class="difflineplus">+    var saveCurrentIndex = treeSelection.currentIndex;</span>
<a href="#l49.1023"></a><span id="l49.1023" class="difflineplus">+</span>
<a href="#l49.1024"></a><span id="l49.1024" class="difflineplus">+    // tell it to log calls to adjustSelection</span>
<a href="#l49.1025"></a><span id="l49.1025" class="difflineplus">+    // attach it to the view</span>
<a href="#l49.1026"></a><span id="l49.1026" class="difflineplus">+    treeBoxObj.view.selection = transientSelection;</span>
<a href="#l49.1027"></a><span id="l49.1027" class="difflineplus">+    // Don't generate any selection events! (we never set this to false, because</span>
<a href="#l49.1028"></a><span id="l49.1028" class="difflineplus">+    //  that would generate an event, and we never need one of those from this</span>
<a href="#l49.1029"></a><span id="l49.1029" class="difflineplus">+    //  selection object.</span>
<a href="#l49.1030"></a><span id="l49.1030" class="difflineplus">+    transientSelection.selectEventsSuppressed = true;</span>
<a href="#l49.1031"></a><span id="l49.1031" class="difflineplus">+    transientSelection.select(row);</span>
<a href="#l49.1032"></a><span id="l49.1032" class="difflineplus">+    transientSelection.currentIndex = saveCurrentIndex;</span>
<a href="#l49.1033"></a><span id="l49.1033" class="difflineplus">+    treeBoxObj.ensureRowIsVisible(row);</span>
<a href="#l49.1034"></a><span id="l49.1034" class="difflineplus">+  }</span>
<a href="#l49.1035"></a><span id="l49.1035" class="difflineplus">+  event.stopPropagation();</span>
<a href="#l49.1036"></a><span id="l49.1036"> }</span>
<a href="#l49.1037"></a><span id="l49.1037"> </span>
<a href="#l49.1038"></a><span id="l49.1038"> function TreeOnMouseDown(event)</span>
<a href="#l49.1039"></a><span id="l49.1039"> {</span>
<a href="#l49.1040"></a><span id="l49.1040">     // Detect right mouse click and change the highlight to the row</span>
<a href="#l49.1041"></a><span id="l49.1041">     // where the click happened without loading the message headers in</span>
<a href="#l49.1042"></a><span id="l49.1042">     // the Folder or Thread Pane.</span>
<a href="#l49.1043"></a><span id="l49.1043">     // Same for middle click, which will open the folder/message in a tab.</span>
<a href="#l49.1044"></a><span id="l49.1044">     if (event.button == 2 || event.button == 1)</span>
<a href="#l49.1045"></a><span id="l49.1045">     {</span>
<a href="#l49.1046"></a><span id="l49.1046" class="difflineminus">-      gRightMouseButtonDown = true;</span>
<a href="#l49.1047"></a><span id="l49.1047" class="difflineminus">-      ChangeSelectionWithoutContentLoad(event, event.target.parentNode);</span>
<a href="#l49.1048"></a><span id="l49.1048" class="difflineplus">+      // We want a single selection if this is a middle-click (button 1)</span>
<a href="#l49.1049"></a><span id="l49.1049" class="difflineplus">+      ChangeSelectionWithoutContentLoad(event, event.target.parentNode,</span>
<a href="#l49.1050"></a><span id="l49.1050" class="difflineplus">+                                        event.button == 1);</span>
<a href="#l49.1051"></a><span id="l49.1051">     }</span>
<a href="#l49.1052"></a><span id="l49.1052" class="difflineminus">-    else</span>
<a href="#l49.1053"></a><span id="l49.1053" class="difflineminus">-      gRightMouseButtonDown = false;</span>
<a href="#l49.1054"></a><span id="l49.1054"> }</span>
<a href="#l49.1055"></a><span id="l49.1055"> </span>
<a href="#l49.1056"></a><span id="l49.1056"> function FolderPaneOnClick(event)</span>
<a href="#l49.1057"></a><span id="l49.1057"> {</span>
<a href="#l49.1058"></a><span id="l49.1058">   var folderTree = document.getElementById(&quot;folderTree&quot;);</span>
<a href="#l49.1059"></a><span id="l49.1059" class="difflineminus">-  </span>
<a href="#l49.1060"></a><span id="l49.1060" class="difflineplus">+</span>
<a href="#l49.1061"></a><span id="l49.1061">   // Middle click on a folder opens the folder in a tab</span>
<a href="#l49.1062"></a><span id="l49.1062">   if (event.button == 1)</span>
<a href="#l49.1063"></a><span id="l49.1063">   {</span>
<a href="#l49.1064"></a><span id="l49.1064">     MsgOpenNewTabForFolder();</span>
<a href="#l49.1065"></a><span id="l49.1065">     RestoreSelectionWithoutContentLoad(folderTree);</span>
<a href="#l49.1066"></a><span id="l49.1066">   }</span>
<a href="#l49.1067"></a><span id="l49.1067">   else if (event.button == 0)</span>
<a href="#l49.1068"></a><span id="l49.1068">   {</span>
<a href="#l49.1069"></a><span id="l49.1069" class="difflineat">@@ -1253,160 +897,43 @@ function FolderPaneOnClick(event)</span>
<a href="#l49.1070"></a><span id="l49.1070">       event.stopPropagation();</span>
<a href="#l49.1071"></a><span id="l49.1071">     }</span>
<a href="#l49.1072"></a><span id="l49.1072">   }</span>
<a href="#l49.1073"></a><span id="l49.1073"> }</span>
<a href="#l49.1074"></a><span id="l49.1074"> </span>
<a href="#l49.1075"></a><span id="l49.1075"> function ThreadTreeOnClick(event)</span>
<a href="#l49.1076"></a><span id="l49.1076"> {</span>
<a href="#l49.1077"></a><span id="l49.1077">   var threadTree = document.getElementById(&quot;threadTree&quot;);</span>
<a href="#l49.1078"></a><span id="l49.1078" class="difflineminus">-  </span>
<a href="#l49.1079"></a><span id="l49.1079" class="difflineplus">+</span>
<a href="#l49.1080"></a><span id="l49.1080">   // Middle click on a message opens the message in a tab</span>
<a href="#l49.1081"></a><span id="l49.1081">   if (event.button == 1)</span>
<a href="#l49.1082"></a><span id="l49.1082">   {</span>
<a href="#l49.1083"></a><span id="l49.1083">     MsgOpenNewTabForMessage();</span>
<a href="#l49.1084"></a><span id="l49.1084">     RestoreSelectionWithoutContentLoad(threadTree);</span>
<a href="#l49.1085"></a><span id="l49.1085">   }</span>
<a href="#l49.1086"></a><span id="l49.1086"> }</span>
<a href="#l49.1087"></a><span id="l49.1087"> </span>
<a href="#l49.1088"></a><span id="l49.1088"> function GetSelectedMsgFolders()</span>
<a href="#l49.1089"></a><span id="l49.1089"> {</span>
<a href="#l49.1090"></a><span id="l49.1090">   return gFolderTreeView.getSelectedFolders();</span>
<a href="#l49.1091"></a><span id="l49.1091"> }</span>
<a href="#l49.1092"></a><span id="l49.1092"> </span>
<a href="#l49.1093"></a><span id="l49.1093" class="difflineminus">-function GetFirstSelectedMessage()</span>
<a href="#l49.1094"></a><span id="l49.1094" class="difflineminus">-{</span>
<a href="#l49.1095"></a><span id="l49.1095" class="difflineminus">-    try {</span>
<a href="#l49.1096"></a><span id="l49.1096" class="difflineminus">-        return gDBView.URIForFirstSelectedMessage;</span>
<a href="#l49.1097"></a><span id="l49.1097" class="difflineminus">-    }</span>
<a href="#l49.1098"></a><span id="l49.1098" class="difflineminus">-    catch (ex) {</span>
<a href="#l49.1099"></a><span id="l49.1099" class="difflineminus">-        return null;</span>
<a href="#l49.1100"></a><span id="l49.1100" class="difflineminus">-    }</span>
<a href="#l49.1101"></a><span id="l49.1101" class="difflineminus">-}</span>
<a href="#l49.1102"></a><span id="l49.1102" class="difflineminus">-</span>
<a href="#l49.1103"></a><span id="l49.1103" class="difflineminus">-function GetSelectedIndices(dbView)</span>
<a href="#l49.1104"></a><span id="l49.1104" class="difflineminus">-{</span>
<a href="#l49.1105"></a><span id="l49.1105" class="difflineminus">-  try {</span>
<a href="#l49.1106"></a><span id="l49.1106" class="difflineminus">-    return dbView.getIndicesForSelection({});</span>
<a href="#l49.1107"></a><span id="l49.1107" class="difflineminus">-  }</span>
<a href="#l49.1108"></a><span id="l49.1108" class="difflineminus">-  catch (ex) {</span>
<a href="#l49.1109"></a><span id="l49.1109" class="difflineminus">-    dump(&quot;ex = &quot; + ex + &quot;\n&quot;);</span>
<a href="#l49.1110"></a><span id="l49.1110" class="difflineminus">-    return null;</span>
<a href="#l49.1111"></a><span id="l49.1111" class="difflineminus">-  }</span>
<a href="#l49.1112"></a><span id="l49.1112" class="difflineminus">-}</span>
<a href="#l49.1113"></a><span id="l49.1113" class="difflineminus">-</span>
<a href="#l49.1114"></a><span id="l49.1114" class="difflineminus">-function GetSelectedMessages()</span>
<a href="#l49.1115"></a><span id="l49.1115" class="difflineminus">-{</span>
<a href="#l49.1116"></a><span id="l49.1116" class="difflineminus">-  if (!GetDBView())</span>
<a href="#l49.1117"></a><span id="l49.1117" class="difflineminus">-    return null;</span>
<a href="#l49.1118"></a><span id="l49.1118" class="difflineminus">-</span>
<a href="#l49.1119"></a><span id="l49.1119" class="difflineminus">-  var messageArray = GetDBView().getURIsForSelection({});</span>
<a href="#l49.1120"></a><span id="l49.1120" class="difflineminus">-  return messageArray.length ? messageArray : null;</span>
<a href="#l49.1121"></a><span id="l49.1121" class="difflineminus">-}</span>
<a href="#l49.1122"></a><span id="l49.1122" class="difflineminus">-</span>
<a href="#l49.1123"></a><span id="l49.1123"> function GetLoadedMsgFolder()</span>
<a href="#l49.1124"></a><span id="l49.1124"> {</span>
<a href="#l49.1125"></a><span id="l49.1125" class="difflineminus">-    if (!gDBView) return null;</span>
<a href="#l49.1126"></a><span id="l49.1126" class="difflineminus">-    return gDBView.msgFolder;</span>
<a href="#l49.1127"></a><span id="l49.1127" class="difflineminus">-}</span>
<a href="#l49.1128"></a><span id="l49.1128" class="difflineminus">-</span>
<a href="#l49.1129"></a><span id="l49.1129" class="difflineminus">-function GetLoadedMessage()</span>
<a href="#l49.1130"></a><span id="l49.1130" class="difflineminus">-{</span>
<a href="#l49.1131"></a><span id="l49.1131" class="difflineminus">-    try {</span>
<a href="#l49.1132"></a><span id="l49.1132" class="difflineminus">-        return gDBView.URIForFirstSelectedMessage;</span>
<a href="#l49.1133"></a><span id="l49.1133" class="difflineminus">-    }</span>
<a href="#l49.1134"></a><span id="l49.1134" class="difflineminus">-    catch (ex) {</span>
<a href="#l49.1135"></a><span id="l49.1135" class="difflineminus">-        return null;</span>
<a href="#l49.1136"></a><span id="l49.1136" class="difflineminus">-    }</span>
<a href="#l49.1137"></a><span id="l49.1137" class="difflineminus">-}</span>
<a href="#l49.1138"></a><span id="l49.1138" class="difflineminus">-</span>
<a href="#l49.1139"></a><span id="l49.1139" class="difflineminus">-//Clear everything related to the current message. called after load start page.</span>
<a href="#l49.1140"></a><span id="l49.1140" class="difflineminus">-function ClearMessageSelection()</span>
<a href="#l49.1141"></a><span id="l49.1141" class="difflineminus">-{</span>
<a href="#l49.1142"></a><span id="l49.1142" class="difflineminus">-  ClearThreadPaneSelection();</span>
<a href="#l49.1143"></a><span id="l49.1143" class="difflineminus">-}</span>
<a href="#l49.1144"></a><span id="l49.1144" class="difflineminus">-</span>
<a href="#l49.1145"></a><span id="l49.1145" class="difflineminus">-// Figures out how many messages are selected (hilighted - does not necessarily</span>
<a href="#l49.1146"></a><span id="l49.1146" class="difflineminus">-// have the dotted outline) above a given index row value in the thread pane.</span>
<a href="#l49.1147"></a><span id="l49.1147" class="difflineminus">-function NumberOfSelectedMessagesAboveCurrentIndex(index)</span>
<a href="#l49.1148"></a><span id="l49.1148" class="difflineminus">-{</span>
<a href="#l49.1149"></a><span id="l49.1149" class="difflineminus">-  var numberOfMessages = 0;</span>
<a href="#l49.1150"></a><span id="l49.1150" class="difflineminus">-  var indicies = GetSelectedIndices(gDBView);</span>
<a href="#l49.1151"></a><span id="l49.1151" class="difflineminus">-</span>
<a href="#l49.1152"></a><span id="l49.1152" class="difflineminus">-  if (indicies &amp;&amp; indicies.length)</span>
<a href="#l49.1153"></a><span id="l49.1153" class="difflineminus">-  {</span>
<a href="#l49.1154"></a><span id="l49.1154" class="difflineminus">-    for (var i = 0; i &lt; indicies.length; i++)</span>
<a href="#l49.1155"></a><span id="l49.1155" class="difflineminus">-    {</span>
<a href="#l49.1156"></a><span id="l49.1156" class="difflineminus">-      if (indicies[i] &lt; index)</span>
<a href="#l49.1157"></a><span id="l49.1157" class="difflineminus">-        ++numberOfMessages;</span>
<a href="#l49.1158"></a><span id="l49.1158" class="difflineminus">-      else</span>
<a href="#l49.1159"></a><span id="l49.1159" class="difflineminus">-        break;</span>
<a href="#l49.1160"></a><span id="l49.1160" class="difflineminus">-    }</span>
<a href="#l49.1161"></a><span id="l49.1161" class="difflineminus">-  }</span>
<a href="#l49.1162"></a><span id="l49.1162" class="difflineminus">-  return numberOfMessages;</span>
<a href="#l49.1163"></a><span id="l49.1163" class="difflineminus">-}</span>
<a href="#l49.1164"></a><span id="l49.1164" class="difflineminus">-</span>
<a href="#l49.1165"></a><span id="l49.1165" class="difflineminus">-function SetNextMessageAfterDelete()</span>
<a href="#l49.1166"></a><span id="l49.1166" class="difflineminus">-{</span>
<a href="#l49.1167"></a><span id="l49.1167" class="difflineminus">-  var treeSelection = GetThreadTree().view.selection;</span>
<a href="#l49.1168"></a><span id="l49.1168" class="difflineminus">-</span>
<a href="#l49.1169"></a><span id="l49.1169" class="difflineminus">-  if (treeSelection.isSelected(treeSelection.currentIndex))</span>
<a href="#l49.1170"></a><span id="l49.1170" class="difflineminus">-  {</span>
<a href="#l49.1171"></a><span id="l49.1171" class="difflineminus">-    gNextMessageViewIndexAfterDelete = gDBView.msgToSelectAfterDelete;</span>
<a href="#l49.1172"></a><span id="l49.1172" class="difflineminus">-    gSelectedIndexWhenDeleting = treeSelection.currentIndex;</span>
<a href="#l49.1173"></a><span id="l49.1173" class="difflineminus">-  }</span>
<a href="#l49.1174"></a><span id="l49.1174" class="difflineminus">-  else if(gDBView.removeRowOnMoveOrDelete)</span>
<a href="#l49.1175"></a><span id="l49.1175" class="difflineminus">-  {</span>
<a href="#l49.1176"></a><span id="l49.1176" class="difflineminus">-    // Only set gThreadPaneDeleteOrMoveOccurred to true if the message was</span>
<a href="#l49.1177"></a><span id="l49.1177" class="difflineminus">-    // truly moved to the trash or deleted, as opposed to an IMAP delete</span>
<a href="#l49.1178"></a><span id="l49.1178" class="difflineminus">-    // (where it is only &quot;marked as deleted&quot;.  This will prevent bug 142065.</span>
<a href="#l49.1179"></a><span id="l49.1179" class="difflineminus">-    //</span>
<a href="#l49.1180"></a><span id="l49.1180" class="difflineminus">-    // If it's an IMAP delete, then just set gNextMessageViewIndexAfterDelete</span>
<a href="#l49.1181"></a><span id="l49.1181" class="difflineminus">-    // to treeSelection.currentIndex (where the outline is at) because nothing</span>
<a href="#l49.1182"></a><span id="l49.1182" class="difflineminus">-    // was moved or deleted from the folder.</span>
<a href="#l49.1183"></a><span id="l49.1183" class="difflineminus">-    gThreadPaneDeleteOrMoveOccurred = true;</span>
<a href="#l49.1184"></a><span id="l49.1184" class="difflineminus">-    gNextMessageViewIndexAfterDelete = treeSelection.currentIndex - NumberOfSelectedMessagesAboveCurrentIndex(treeSelection.currentIndex);</span>
<a href="#l49.1185"></a><span id="l49.1185" class="difflineminus">-  }</span>
<a href="#l49.1186"></a><span id="l49.1186" class="difflineminus">-  else</span>
<a href="#l49.1187"></a><span id="l49.1187" class="difflineminus">-    gNextMessageViewIndexAfterDelete = treeSelection.currentIndex;</span>
<a href="#l49.1188"></a><span id="l49.1188" class="difflineplus">+  return gFolderDisplay.displayedFolder;</span>
<a href="#l49.1189"></a><span id="l49.1189"> }</span>
<a href="#l49.1190"></a><span id="l49.1190"> </span>
<a href="#l49.1191"></a><span id="l49.1191"> function SelectFolder(folderUri)</span>
<a href="#l49.1192"></a><span id="l49.1192"> {</span>
<a href="#l49.1193"></a><span id="l49.1193">   gFolderTreeView.selectFolder(GetMsgFolderFromUri(folderUri));</span>
<a href="#l49.1194"></a><span id="l49.1194"> }</span>
<a href="#l49.1195"></a><span id="l49.1195"> </span>
<a href="#l49.1196"></a><span id="l49.1196" class="difflineminus">-function SelectMessage(messageUri)</span>
<a href="#l49.1197"></a><span id="l49.1197" class="difflineminus">-{</span>
<a href="#l49.1198"></a><span id="l49.1198" class="difflineminus">-  var msgHdr = messenger.messageServiceFromURI(messageUri).messageURIToMsgHdr(messageUri);</span>
<a href="#l49.1199"></a><span id="l49.1199" class="difflineminus">-  if (msgHdr)</span>
<a href="#l49.1200"></a><span id="l49.1200" class="difflineminus">-    gDBView.selectMsgByKey(msgHdr.messageKey);</span>
<a href="#l49.1201"></a><span id="l49.1201" class="difflineminus">-}</span>
<a href="#l49.1202"></a><span id="l49.1202" class="difflineminus">-</span>
<a href="#l49.1203"></a><span id="l49.1203"> function ReloadMessage()</span>
<a href="#l49.1204"></a><span id="l49.1204"> {</span>
<a href="#l49.1205"></a><span id="l49.1205" class="difflineminus">-  gDBView.reloadMessage();</span>
<a href="#l49.1206"></a><span id="l49.1206" class="difflineminus">-}</span>
<a href="#l49.1207"></a><span id="l49.1207" class="difflineminus">-</span>
<a href="#l49.1208"></a><span id="l49.1208" class="difflineminus">-function GetDBView()</span>
<a href="#l49.1209"></a><span id="l49.1209" class="difflineminus">-{</span>
<a href="#l49.1210"></a><span id="l49.1210" class="difflineminus">-  return gDBView;</span>
<a href="#l49.1211"></a><span id="l49.1211" class="difflineminus">-}</span>
<a href="#l49.1212"></a><span id="l49.1212" class="difflineminus">-</span>
<a href="#l49.1213"></a><span id="l49.1213" class="difflineminus">-function LoadNavigatedToMessage(msgHdr, folder, folderUri)</span>
<a href="#l49.1214"></a><span id="l49.1214" class="difflineminus">-{</span>
<a href="#l49.1215"></a><span id="l49.1215" class="difflineminus">-  if (IsCurrentLoadedFolder(folder))</span>
<a href="#l49.1216"></a><span id="l49.1216" class="difflineminus">-  {</span>
<a href="#l49.1217"></a><span id="l49.1217" class="difflineminus">-    gDBView.selectMsgByKey(msgHdr.messageKey);</span>
<a href="#l49.1218"></a><span id="l49.1218" class="difflineminus">-  }</span>
<a href="#l49.1219"></a><span id="l49.1219" class="difflineminus">-  else</span>
<a href="#l49.1220"></a><span id="l49.1220" class="difflineminus">-  {</span>
<a href="#l49.1221"></a><span id="l49.1221" class="difflineminus">-    gStartMsgKey = msgHdr.messageKey;</span>
<a href="#l49.1222"></a><span id="l49.1222" class="difflineminus">-    SelectFolder(folderUri);</span>
<a href="#l49.1223"></a><span id="l49.1223" class="difflineminus">-  }</span>
<a href="#l49.1224"></a><span id="l49.1224" class="difflineplus">+  gFolderDisplay.view.dbView.reloadMessage();</span>
<a href="#l49.1225"></a><span id="l49.1225"> }</span>
<a href="#l49.1226"></a><span id="l49.1226"> </span>
<a href="#l49.1227"></a><span id="l49.1227"> // Some of the per account junk mail settings have been</span>
<a href="#l49.1228"></a><span id="l49.1228"> // converted to global prefs. Let's try to migrate some</span>
<a href="#l49.1229"></a><span id="l49.1229"> // of those settings from the default account.</span>
<a href="#l49.1230"></a><span id="l49.1230"> function MigrateJunkMailSettings()</span>
<a href="#l49.1231"></a><span id="l49.1231"> {</span>
<a href="#l49.1232"></a><span id="l49.1232">   var junkMailSettingsVersion = gPrefBranch.getIntPref(&quot;mail.spam.version&quot;);</span>
<a href="#l49.1233"></a><span id="l49.1233" class="difflineat">@@ -1479,18 +1006,18 @@ function MigrateAttachmentDownloadStore(</span>
<a href="#l49.1234"></a><span id="l49.1234">     gPrefBranch.setIntPref(&quot;mail.attachment.store.version&quot;, 1);</span>
<a href="#l49.1235"></a><span id="l49.1235">   }</span>
<a href="#l49.1236"></a><span id="l49.1236"> }</span>
<a href="#l49.1237"></a><span id="l49.1237"> </span>
<a href="#l49.1238"></a><span id="l49.1238"> function threadPaneOnDragStart(aEvent) {</span>
<a href="#l49.1239"></a><span id="l49.1239">   if (aEvent.originalTarget.localName != &quot;treechildren&quot;)</span>
<a href="#l49.1240"></a><span id="l49.1240">     return;</span>
<a href="#l49.1241"></a><span id="l49.1241"> </span>
<a href="#l49.1242"></a><span id="l49.1242" class="difflineminus">-  var messages = GetSelectedMessages();</span>
<a href="#l49.1243"></a><span id="l49.1243" class="difflineplus">+  var messages = gFolderDisplay.selectedMessageUris;</span>
<a href="#l49.1244"></a><span id="l49.1244">   if (!messages)</span>
<a href="#l49.1245"></a><span id="l49.1245">     return;</span>
<a href="#l49.1246"></a><span id="l49.1246"> </span>
<a href="#l49.1247"></a><span id="l49.1247" class="difflineminus">-  SetNextMessageAfterDelete()</span>
<a href="#l49.1248"></a><span id="l49.1248" class="difflineplus">+  gFolderDisplay.hintAboutToDeleteMessages();</span>
<a href="#l49.1249"></a><span id="l49.1249">   for (let i in messages)</span>
<a href="#l49.1250"></a><span id="l49.1250">     aEvent.dataTransfer.mozSetDataAt(&quot;text/x-moz-message&quot;, messages[i], i);</span>
<a href="#l49.1251"></a><span id="l49.1251">   aEvent.dataTransfer.effectAllowed = &quot;copyMove&quot;;</span>
<a href="#l49.1252"></a><span id="l49.1252">   aEvent.dataTransfer.addElement(aEvent.originalTarget);</span>
<a href="#l49.1253"></a><span id="l49.1253"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l50.1"></a><span id="l50.1">rename from mailnews/base/resources/content/msgViewNavigation.js</span>
<a href="#l50.2"></a><span id="l50.2">rename to mail/base/content/msgViewNavigation.js</span>
<a href="#l50.3"></a><span id="l50.3" class="difflineminus">--- a/mailnews/base/resources/content/msgViewNavigation.js</span>
<a href="#l50.4"></a><span id="l50.4" class="difflineplus">+++ b/mail/base/content/msgViewNavigation.js</span>
<a href="#l50.5"></a><span id="l50.5" class="difflineat">@@ -224,103 +224,50 @@ function CrossFolderNavigation(type)</span>
<a href="#l50.6"></a><span id="l50.6"> </span>
<a href="#l50.7"></a><span id="l50.7">     var folder = FindNextFolder();</span>
<a href="#l50.8"></a><span id="l50.8">     if (folder &amp;&amp; (gDBView.msgFolder.URI != folder.URI)) </span>
<a href="#l50.9"></a><span id="l50.9">     {</span>
<a href="#l50.10"></a><span id="l50.10">       switch (nextMode) </span>
<a href="#l50.11"></a><span id="l50.11">       {</span>
<a href="#l50.12"></a><span id="l50.12">         case 0:</span>
<a href="#l50.13"></a><span id="l50.13">           // do this unconditionally</span>
<a href="#l50.14"></a><span id="l50.14" class="difflineminus">-          gNextMessageAfterLoad = type;</span>
<a href="#l50.15"></a><span id="l50.15">           SelectFolder(folder.URI);</span>
<a href="#l50.16"></a><span id="l50.16">           break;</span>
<a href="#l50.17"></a><span id="l50.17">         case 1:</span>
<a href="#l50.18"></a><span id="l50.18">         default:</span>
<a href="#l50.19"></a><span id="l50.19">           var promptText = gMessengerBundle.getFormattedString(&quot;advanceNextPrompt&quot;, [ folder.name ], 1); </span>
<a href="#l50.20"></a><span id="l50.20">           var promptService = Components.classes[&quot;@mozilla.org/embedcomp/prompt-service;1&quot;]</span>
<a href="#l50.21"></a><span id="l50.21">                                         .getService(Components.interfaces.nsIPromptService);</span>
<a href="#l50.22"></a><span id="l50.22">           if (!promptService.confirmEx(window, null, promptText, </span>
<a href="#l50.23"></a><span id="l50.23">                                        promptService.STD_YES_NO_BUTTONS, </span>
<a href="#l50.24"></a><span id="l50.24">                                        null, null, null, null, {}))</span>
<a href="#l50.25"></a><span id="l50.25">           {</span>
<a href="#l50.26"></a><span id="l50.26" class="difflineminus">-            gNextMessageAfterLoad = type;</span>
<a href="#l50.27"></a><span id="l50.27" class="difflineplus">+            gFolderDisplay.pushNavigation(type, true);</span>
<a href="#l50.28"></a><span id="l50.28">             SelectFolder(folder.URI);</span>
<a href="#l50.29"></a><span id="l50.29">           }</span>
<a href="#l50.30"></a><span id="l50.30">           break;</span>
<a href="#l50.31"></a><span id="l50.31">       }</span>
<a href="#l50.32"></a><span id="l50.32">     }</span>
<a href="#l50.33"></a><span id="l50.33">   }</span>
<a href="#l50.34"></a><span id="l50.34">   else</span>
<a href="#l50.35"></a><span id="l50.35">   {</span>
<a href="#l50.36"></a><span id="l50.36">     // if no message is loaded, relPos should be 0, to</span>
<a href="#l50.37"></a><span id="l50.37">     // go back to the previously loaded message</span>
<a href="#l50.38"></a><span id="l50.38">     var relPos = (type == nsMsgNavigationType.forward)</span>
<a href="#l50.39"></a><span id="l50.39" class="difflineminus">-      ? 1 : ((GetLoadedMessage()) ? -1 : 0);</span>
<a href="#l50.40"></a><span id="l50.40" class="difflineplus">+      ? 1 : ((gMessageDisplay.displayedMessage) ? -1 : 0);</span>
<a href="#l50.41"></a><span id="l50.41">     var folderUri = messenger.getFolderUriAtNavigatePos(relPos);</span>
<a href="#l50.42"></a><span id="l50.42">     var msgHdr = messenger.msgHdrFromURI(messenger.getMsgUriAtNavigatePos(relPos));</span>
<a href="#l50.43"></a><span id="l50.43">     gStartMsgKey = msgHdr.messageKey;</span>
<a href="#l50.44"></a><span id="l50.44">     var curPos = messenger.navigatePos;</span>
<a href="#l50.45"></a><span id="l50.45">     curPos += relPos;</span>
<a href="#l50.46"></a><span id="l50.46">     messenger.navigatePos = curPos;</span>
<a href="#l50.47"></a><span id="l50.47">     SelectFolder(folderUri);</span>
<a href="#l50.48"></a><span id="l50.48">   }</span>
<a href="#l50.49"></a><span id="l50.49"> }</span>
<a href="#l50.50"></a><span id="l50.50"> </span>
<a href="#l50.51"></a><span id="l50.51" class="difflineminus">-</span>
<a href="#l50.52"></a><span id="l50.52" class="difflineminus">-function ScrollToMessage(type, wrap, selectMessage)</span>
<a href="#l50.53"></a><span id="l50.53" class="difflineminus">-{</span>
<a href="#l50.54"></a><span id="l50.54" class="difflineminus">-  try {</span>
<a href="#l50.55"></a><span id="l50.55" class="difflineminus">-    var treeView = gDBView.QueryInterface(Components.interfaces.nsITreeView);</span>
<a href="#l50.56"></a><span id="l50.56" class="difflineminus">-    var treeSelection = treeView.selection;</span>
<a href="#l50.57"></a><span id="l50.57" class="difflineminus">-    var currentIndex = treeSelection.currentIndex;</span>
<a href="#l50.58"></a><span id="l50.58" class="difflineminus">-</span>
<a href="#l50.59"></a><span id="l50.59" class="difflineminus">-    var resultId = new Object;</span>
<a href="#l50.60"></a><span id="l50.60" class="difflineminus">-    var resultIndex = new Object;</span>
<a href="#l50.61"></a><span id="l50.61" class="difflineminus">-    var threadIndex = new Object;</span>
<a href="#l50.62"></a><span id="l50.62" class="difflineminus">-</span>
<a href="#l50.63"></a><span id="l50.63" class="difflineminus">-    let elidedFlag = Components.interfaces.nsMsgMessageFlags.Elided;</span>
<a href="#l50.64"></a><span id="l50.64" class="difflineminus">-    let summarizeSelection =</span>
<a href="#l50.65"></a><span id="l50.65" class="difflineminus">-      gPrefBranch.getBoolPref(&quot;mail.operate_on_msgs_in_collapsed_threads&quot;);</span>
<a href="#l50.66"></a><span id="l50.66" class="difflineminus">-</span>
<a href="#l50.67"></a><span id="l50.67" class="difflineminus">-    // if we're doing next unread, and a collapsed thread is selected, and</span>
<a href="#l50.68"></a><span id="l50.68" class="difflineminus">-    // the top level message is unread, just set the result manually to</span>
<a href="#l50.69"></a><span id="l50.69" class="difflineminus">-    // the top level message, without using gDBView.viewNavigate.</span>
<a href="#l50.70"></a><span id="l50.70" class="difflineminus">-    if (summarizeSelection &amp;&amp; type == nsMsgNavigationType.nextUnreadMessage &amp;&amp;</span>
<a href="#l50.71"></a><span id="l50.71" class="difflineminus">-        currentIndex != -1 &amp;&amp;</span>
<a href="#l50.72"></a><span id="l50.72" class="difflineminus">-        gDBView.getFlagsAt(currentIndex) &amp; elidedFlag &amp;&amp;</span>
<a href="#l50.73"></a><span id="l50.73" class="difflineminus">-        gDBView.isContainer(currentIndex) &amp;&amp;</span>
<a href="#l50.74"></a><span id="l50.74" class="difflineminus">-        ! (gDBView.getFlagsAt(currentIndex) &amp;</span>
<a href="#l50.75"></a><span id="l50.75" class="difflineminus">-           Components.interfaces.nsMsgMessageFlags.Read)) {</span>
<a href="#l50.76"></a><span id="l50.76" class="difflineminus">-      resultIndex.value = currentIndex;</span>
<a href="#l50.77"></a><span id="l50.77" class="difflineminus">-      resultId.value = gDBView.getKeyAt(currentIndex);</span>
<a href="#l50.78"></a><span id="l50.78" class="difflineminus">-    } else {</span>
<a href="#l50.79"></a><span id="l50.79" class="difflineminus">-      gDBView.viewNavigate(type, resultId, resultIndex, threadIndex, true /* wrap */);</span>
<a href="#l50.80"></a><span id="l50.80" class="difflineminus">-    }</span>
<a href="#l50.81"></a><span id="l50.81" class="difflineminus">-</span>
<a href="#l50.82"></a><span id="l50.82" class="difflineminus">-    // only scroll and select if we found something</span>
<a href="#l50.83"></a><span id="l50.83" class="difflineminus">-    if ((resultId.value != nsMsgViewIndex_None) &amp;&amp; (resultIndex.value != nsMsgViewIndex_None)) {</span>
<a href="#l50.84"></a><span id="l50.84" class="difflineminus">-      if (gDBView.getFlagsAt(resultIndex.value) &amp; elidedFlag &amp;&amp;</span>
<a href="#l50.85"></a><span id="l50.85" class="difflineminus">-          summarizeSelection)</span>
<a href="#l50.86"></a><span id="l50.86" class="difflineminus">-        gDBView.toggleOpenState(resultIndex.value);</span>
<a href="#l50.87"></a><span id="l50.87" class="difflineminus">-</span>
<a href="#l50.88"></a><span id="l50.88" class="difflineminus">-        if (selectMessage){</span>
<a href="#l50.89"></a><span id="l50.89" class="difflineminus">-            treeSelection.select(resultIndex.value);</span>
<a href="#l50.90"></a><span id="l50.90" class="difflineminus">-        }</span>
<a href="#l50.91"></a><span id="l50.91" class="difflineminus">-        EnsureRowInThreadTreeIsVisible(resultIndex.value);</span>
<a href="#l50.92"></a><span id="l50.92" class="difflineminus">-        return true;</span>
<a href="#l50.93"></a><span id="l50.93" class="difflineminus">-    }</span>
<a href="#l50.94"></a><span id="l50.94" class="difflineminus">-    else {</span>
<a href="#l50.95"></a><span id="l50.95" class="difflineminus">-        return false;</span>
<a href="#l50.96"></a><span id="l50.96" class="difflineminus">-    }</span>
<a href="#l50.97"></a><span id="l50.97" class="difflineminus">-  }</span>
<a href="#l50.98"></a><span id="l50.98" class="difflineminus">-  catch (ex) {</span>
<a href="#l50.99"></a><span id="l50.99" class="difflineminus">-    return false;</span>
<a href="#l50.100"></a><span id="l50.100" class="difflineminus">-  }</span>
<a href="#l50.101"></a><span id="l50.101" class="difflineminus">-}</span>
<a href="#l50.102"></a><span id="l50.102" class="difflineminus">-</span>
<a href="#l50.103"></a><span id="l50.103"> function GoNextMessage(type, startFromBeginning)</span>
<a href="#l50.104"></a><span id="l50.104"> {</span>
<a href="#l50.105"></a><span id="l50.105" class="difflineminus">-  if (!ScrollToMessage(type, startFromBeginning, true))</span>
<a href="#l50.106"></a><span id="l50.106" class="difflineplus">+  if (!gFolderDisplay.navigate(type))</span>
<a href="#l50.107"></a><span id="l50.107">     CrossFolderNavigation(type);</span>
<a href="#l50.108"></a><span id="l50.108"> </span>
<a href="#l50.109"></a><span id="l50.109">   SetFocusThreadPaneIfNotOnMessagePane();</span>
<a href="#l50.110"></a><span id="l50.110"> }</span>
<a href="#l50.111"></a><span id="l50.111"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l51.1"></a><span id="l51.1" class="difflineminus">--- a/mail/base/content/phishingDetector.js</span>
<a href="#l51.2"></a><span id="l51.2" class="difflineplus">+++ b/mail/base/content/phishingDetector.js</span>
<a href="#l51.3"></a><span id="l51.3" class="difflineat">@@ -1,45 +1,44 @@</span>
<a href="#l51.4"></a><span id="l51.4" class="difflineminus">-# -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l51.5"></a><span id="l51.5" class="difflineminus">-# ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l51.6"></a><span id="l51.6" class="difflineminus">-# Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l51.7"></a><span id="l51.7" class="difflineminus">-#</span>
<a href="#l51.8"></a><span id="l51.8" class="difflineminus">-# The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l51.9"></a><span id="l51.9" class="difflineminus">-# 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l51.10"></a><span id="l51.10" class="difflineminus">-# the License. You may obtain a copy of the License at</span>
<a href="#l51.11"></a><span id="l51.11" class="difflineminus">-# http://www.mozilla.org/MPL/</span>
<a href="#l51.12"></a><span id="l51.12" class="difflineminus">-#</span>
<a href="#l51.13"></a><span id="l51.13" class="difflineminus">-# Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l51.14"></a><span id="l51.14" class="difflineminus">-# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l51.15"></a><span id="l51.15" class="difflineminus">-# for the specific language governing rights and limitations under the</span>
<a href="#l51.16"></a><span id="l51.16" class="difflineminus">-# License.</span>
<a href="#l51.17"></a><span id="l51.17" class="difflineminus">-#</span>
<a href="#l51.18"></a><span id="l51.18" class="difflineminus">-# The Original Code is Thunderbird Phishing Dectector</span>
<a href="#l51.19"></a><span id="l51.19" class="difflineminus">-#</span>
<a href="#l51.20"></a><span id="l51.20" class="difflineminus">-# The Initial Developer of the Original Code is</span>
<a href="#l51.21"></a><span id="l51.21" class="difflineminus">-# The Mozilla Foundation.</span>
<a href="#l51.22"></a><span id="l51.22" class="difflineminus">-# Portions created by the Initial Developer are Copyright (C) 2005</span>
<a href="#l51.23"></a><span id="l51.23" class="difflineminus">-# the Initial Developer. All Rights Reserved.</span>
<a href="#l51.24"></a><span id="l51.24" class="difflineminus">-#</span>
<a href="#l51.25"></a><span id="l51.25" class="difflineminus">-# Contributor(s):</span>
<a href="#l51.26"></a><span id="l51.26" class="difflineminus">-#  Scott MacGregor &lt;mscott@mozilla.org&gt;</span>
<a href="#l51.27"></a><span id="l51.27" class="difflineminus">-#</span>
<a href="#l51.28"></a><span id="l51.28" class="difflineminus">-# Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l51.29"></a><span id="l51.29" class="difflineminus">-# either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l51.30"></a><span id="l51.30" class="difflineminus">-# the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l51.31"></a><span id="l51.31" class="difflineminus">-# in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l51.32"></a><span id="l51.32" class="difflineminus">-# of those above. If you wish to allow use of your version of this file only</span>
<a href="#l51.33"></a><span id="l51.33" class="difflineminus">-# under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l51.34"></a><span id="l51.34" class="difflineminus">-# use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l51.35"></a><span id="l51.35" class="difflineminus">-# decision by deleting the provisions above and replace them with the notice</span>
<a href="#l51.36"></a><span id="l51.36" class="difflineminus">-# and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l51.37"></a><span id="l51.37" class="difflineminus">-# the provisions above, a recipient may use your version of this file under</span>
<a href="#l51.38"></a><span id="l51.38" class="difflineminus">-# the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l51.39"></a><span id="l51.39" class="difflineminus">-#</span>
<a href="#l51.40"></a><span id="l51.40" class="difflineminus">-# ***** END LICENSE BLOCK ******</span>
<a href="#l51.41"></a><span id="l51.41" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l51.42"></a><span id="l51.42" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l51.43"></a><span id="l51.43" class="difflineplus">+ *</span>
<a href="#l51.44"></a><span id="l51.44" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l51.45"></a><span id="l51.45" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l51.46"></a><span id="l51.46" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l51.47"></a><span id="l51.47" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l51.48"></a><span id="l51.48" class="difflineplus">+ *</span>
<a href="#l51.49"></a><span id="l51.49" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l51.50"></a><span id="l51.50" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l51.51"></a><span id="l51.51" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l51.52"></a><span id="l51.52" class="difflineplus">+ * License.</span>
<a href="#l51.53"></a><span id="l51.53" class="difflineplus">+ *</span>
<a href="#l51.54"></a><span id="l51.54" class="difflineplus">+ * The Original Code is Thunderbird Phishing Dectector</span>
<a href="#l51.55"></a><span id="l51.55" class="difflineplus">+ *</span>
<a href="#l51.56"></a><span id="l51.56" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l51.57"></a><span id="l51.57" class="difflineplus">+ * The Mozilla Foundation.</span>
<a href="#l51.58"></a><span id="l51.58" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2005</span>
<a href="#l51.59"></a><span id="l51.59" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l51.60"></a><span id="l51.60" class="difflineplus">+ *</span>
<a href="#l51.61"></a><span id="l51.61" class="difflineplus">+ * Contributor(s):</span>
<a href="#l51.62"></a><span id="l51.62" class="difflineplus">+ *  Scott MacGregor &lt;mscott@mozilla.org&gt;</span>
<a href="#l51.63"></a><span id="l51.63" class="difflineplus">+ *</span>
<a href="#l51.64"></a><span id="l51.64" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l51.65"></a><span id="l51.65" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l51.66"></a><span id="l51.66" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l51.67"></a><span id="l51.67" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l51.68"></a><span id="l51.68" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l51.69"></a><span id="l51.69" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l51.70"></a><span id="l51.70" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l51.71"></a><span id="l51.71" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l51.72"></a><span id="l51.72" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l51.73"></a><span id="l51.73" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l51.74"></a><span id="l51.74" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l51.75"></a><span id="l51.75" class="difflineplus">+ *</span>
<a href="#l51.76"></a><span id="l51.76" class="difflineplus">+ * ***** END LICENSE BLOCK ****** */</span>
<a href="#l51.77"></a><span id="l51.77"> </span>
<a href="#l51.78"></a><span id="l51.78"> // Dependencies:</span>
<a href="#l51.79"></a><span id="l51.79"> // gPrefBranch, gBrandBundle, gMessengerBundle should already be defined</span>
<a href="#l51.80"></a><span id="l51.80"> // gatherTextUnder from utilityOverlay.js</span>
<a href="#l51.81"></a><span id="l51.81"> </span>
<a href="#l51.82"></a><span id="l51.82"> const kPhishingNotSuspicious = 0;</span>
<a href="#l51.83"></a><span id="l51.83"> const kPhishingWithIPAddress = 1;</span>
<a href="#l51.84"></a><span id="l51.84"> const kPhishingWithMismatchedHosts = 2;</span>
<a href="#l51.85"></a><span id="l51.85" class="difflineat">@@ -182,36 +181,39 @@ var gPhishingDetector = {</span>
<a href="#l51.86"></a><span id="l51.86">           failsStaticTests = (aLinkText &amp;&amp;</span>
<a href="#l51.87"></a><span id="l51.87">             this.misMatchedHostWithLinkText(hrefURL, aLinkText, linkTextURL))</span>
<a href="#l51.88"></a><span id="l51.88">         }</span>
<a href="#l51.89"></a><span id="l51.89">       }</span>
<a href="#l51.90"></a><span id="l51.90"> </span>
<a href="#l51.91"></a><span id="l51.91">       // Lookup the url against our local list. We want to do this even if the url fails our static</span>
<a href="#l51.92"></a><span id="l51.92">       // test checks because the url might be in the white list.</span>
<a href="#l51.93"></a><span id="l51.93">       if (this.mPhishingWarden)</span>
<a href="#l51.94"></a><span id="l51.94" class="difflineminus">-        this.mPhishingWarden.isEvilURL(GetLoadedMessage(), failsStaticTests, aUrl, this.localListCallback);</span>
<a href="#l51.95"></a><span id="l51.95" class="difflineplus">+        this.mPhishingWarden.isEvilURL(gFolderDisplay.selectedMessage,</span>
<a href="#l51.96"></a><span id="l51.96" class="difflineplus">+                                       failsStaticTests, aUrl,</span>
<a href="#l51.97"></a><span id="l51.97" class="difflineplus">+                                       this.localListCallback);</span>
<a href="#l51.98"></a><span id="l51.98">       else</span>
<a href="#l51.99"></a><span id="l51.99" class="difflineminus">-        this.localListCallback(GetLoadedMessage(), failsStaticTests, aUrl, 2 /* not found */);</span>
<a href="#l51.100"></a><span id="l51.100" class="difflineplus">+        this.localListCallback(gFolderDisplay.selectedMessage,</span>
<a href="#l51.101"></a><span id="l51.101" class="difflineplus">+                               failsStaticTests, aUrl, 2 /* not found */);</span>
<a href="#l51.102"></a><span id="l51.102">     }</span>
<a href="#l51.103"></a><span id="l51.103">   },</span>
<a href="#l51.104"></a><span id="l51.104"> </span>
<a href="#l51.105"></a><span id="l51.105">   /**</span>
<a href="#l51.106"></a><span id="l51.106">     * </span>
<a href="#l51.107"></a><span id="l51.107" class="difflineminus">-    * @param aMsgURI the uri for the loaded message when the look up was initiated.</span>
<a href="#l51.108"></a><span id="l51.108" class="difflineplus">+    * @param aMsgHdr the header for the loaded message when the look up was initiated.</span>
<a href="#l51.109"></a><span id="l51.109">     * @param aFailsStaticTests true if our static tests think the url is a phishing scam</span>
<a href="#l51.110"></a><span id="l51.110">     * @param aUrl the url we looked up in the phishing tables</span>
<a href="#l51.111"></a><span id="l51.111">     * @param aLocalListStatus the result of the local lookup (PROT_ListWarden.IN_BLACKLIST,</span>
<a href="#l51.112"></a><span id="l51.112">     *        PROT_ListWarden.IN_WHITELIST or PROT_ListWarden.NOT_FOUND.</span>
<a href="#l51.113"></a><span id="l51.113">     */</span>
<a href="#l51.114"></a><span id="l51.114" class="difflineminus">-  localListCallback: function (aMsgURI, aFailsStaticTests, aUrl, aLocalListStatus)</span>
<a href="#l51.115"></a><span id="l51.115" class="difflineplus">+  localListCallback: function (aMsgHdr, aFailsStaticTests, aUrl, aLocalListStatus)</span>
<a href="#l51.116"></a><span id="l51.116">   {  </span>
<a href="#l51.117"></a><span id="l51.117">     // for urls in the blacklist, notify the phishing bar.</span>
<a href="#l51.118"></a><span id="l51.118">     // for urls in the whitelist, do nothing</span>
<a href="#l51.119"></a><span id="l51.119">     // for all other urls, fall back to the static tests</span>
<a href="#l51.120"></a><span id="l51.120" class="difflineminus">-    if (aMsgURI == GetLoadedMessage())</span>
<a href="#l51.121"></a><span id="l51.121" class="difflineplus">+    if (aMsgHdr == gFolderDisplay.selectedMessage)</span>
<a href="#l51.122"></a><span id="l51.122">     {</span>
<a href="#l51.123"></a><span id="l51.123">       if (aLocalListStatus == 0 /* PROT_ListWarden.IN_BLACKLIST */ ||</span>
<a href="#l51.124"></a><span id="l51.124">           (aLocalListStatus == 2 /* PROT_ListWarden.PROT_ListWarden.NOT_FOUND */ &amp;&amp; aFailsStaticTests))</span>
<a href="#l51.125"></a><span id="l51.125">         gMessageNotificationBar.setPhishingMsg();</span>
<a href="#l51.126"></a><span id="l51.126">     }</span>
<a href="#l51.127"></a><span id="l51.127">   },</span>
<a href="#l51.128"></a><span id="l51.128"> </span>
<a href="#l51.129"></a><span id="l51.129">   /**</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l52.1"></a><span id="l52.1" class="difflineminus">--- a/mail/base/content/search.xml</span>
<a href="#l52.2"></a><span id="l52.2" class="difflineplus">+++ b/mail/base/content/search.xml</span>
<a href="#l52.3"></a><span id="l52.3" class="difflineat">@@ -69,31 +69,34 @@</span>
<a href="#l52.4"></a><span id="l52.4">       &lt;constructor&gt;</span>
<a href="#l52.5"></a><span id="l52.5">         &lt;![CDATA[</span>
<a href="#l52.6"></a><span id="l52.6">           // initialize the quick search mode based on the checked menu item</span>
<a href="#l52.7"></a><span id="l52.7">           var desiredQuickSearchMode = document.getElementById('quick-search-menupopup').getAttribute('value');             </span>
<a href="#l52.8"></a><span id="l52.8">           </span>
<a href="#l52.9"></a><span id="l52.9">           var menuItems = document.getElementById('quick-search-menupopup').getElementsByAttribute('value', '*');</span>
<a href="#l52.10"></a><span id="l52.10">           var selectedMenuItem;</span>
<a href="#l52.11"></a><span id="l52.11">           for (var index = 0; index &lt; menuItems.length; index++) </span>
<a href="#l52.12"></a><span id="l52.12" class="difflineminus">-            if (menuItems[index].value == desiredQuickSearchMode)</span>
<a href="#l52.13"></a><span id="l52.13" class="difflineplus">+            if (menuItems[index].getAttribute(&quot;value&quot;) == desiredQuickSearchMode)</span>
<a href="#l52.14"></a><span id="l52.14">             {</span>
<a href="#l52.15"></a><span id="l52.15">               selectedMenuItem = menuItems[index];</span>
<a href="#l52.16"></a><span id="l52.16">               break;</span>
<a href="#l52.17"></a><span id="l52.17">             }</span>
<a href="#l52.18"></a><span id="l52.18">           </span>
<a href="#l52.19"></a><span id="l52.19">           // if we failed to find selectedMenuItemVal in our array of menuitems</span>
<a href="#l52.20"></a><span id="l52.20">           // then just use the first menu item in the array (surely we have at least one menu item!)</span>
<a href="#l52.21"></a><span id="l52.21">           // This scenario happens when we decide to obsolete/delete search modes from </span>
<a href="#l52.22"></a><span id="l52.22">           // the quick search drop down.</span>
<a href="#l52.23"></a><span id="l52.23" class="difflineminus">-          if (!selectedMenuItem)</span>
<a href="#l52.24"></a><span id="l52.24" class="difflineplus">+          if (!selectedMenuItem &amp;&amp; menuItems.length) {</span>
<a href="#l52.25"></a><span id="l52.25">             selectedMenuItem = menuItems[0];</span>
<a href="#l52.26"></a><span id="l52.26" class="difflineminus">-            </span>
<a href="#l52.27"></a><span id="l52.27" class="difflineminus">-          selectedMenuItem.setAttribute('checked', 'true');</span>
<a href="#l52.28"></a><span id="l52.28" class="difflineminus">-          this.mQuickSearchMode = selectedMenuItem.value; // the checked menu item                </span>
<a href="#l52.29"></a><span id="l52.29" class="difflineplus">+</span>
<a href="#l52.30"></a><span id="l52.30" class="difflineplus">+            selectedMenuItem.setAttribute('checked', 'true');</span>
<a href="#l52.31"></a><span id="l52.31" class="difflineplus">+            this.mQuickSearchMode =</span>
<a href="#l52.32"></a><span id="l52.32" class="difflineplus">+              selectedMenuItem.getAttribute(&quot;value&quot;);</span>
<a href="#l52.33"></a><span id="l52.33" class="difflineplus">+          }</span>
<a href="#l52.34"></a><span id="l52.34" class="difflineplus">+</span>
<a href="#l52.35"></a><span id="l52.35">           this.setSearchCriteriaText();</span>
<a href="#l52.36"></a><span id="l52.36">         ]]&gt;</span>
<a href="#l52.37"></a><span id="l52.37">       &lt;/constructor&gt;</span>
<a href="#l52.38"></a><span id="l52.38"> </span>
<a href="#l52.39"></a><span id="l52.39">       &lt;property name=&quot;showingSearchCriteria&quot; onget=&quot;return this.getAttribute('searchCriteria') == 'true';&quot;</span>
<a href="#l52.40"></a><span id="l52.40">                 onset=&quot;this.setAttribute('searchCriteria', val); return val;&quot;/&gt;</span>
<a href="#l52.41"></a><span id="l52.41"> </span>
<a href="#l52.42"></a><span id="l52.42">       &lt;property name=&quot;clearButtonHidden&quot; onget=&quot;return document.getElementById('quick-search-clearbutton').getAttribute('clearButtonHidden') == 'true';&quot;</span>
<a href="#l52.43"></a><span id="l52.43" class="difflineat">@@ -127,17 +130,17 @@</span>
<a href="#l52.44"></a><span id="l52.44"> </span>
<a href="#l52.45"></a><span id="l52.45">       &lt;property name=&quot;searchMode&quot; onget=&quot;return this.mQuickSearchMode;&quot;</span>
<a href="#l52.46"></a><span id="l52.46">                 onset=&quot;this.mQuickSearchMode = val; document.getElementById('quick-search-menupopup').setAttribute('value', val);&quot;/&gt;</span>
<a href="#l52.47"></a><span id="l52.47"> </span>
<a href="#l52.48"></a><span id="l52.48">       &lt;method name=&quot;setSearchCriteriaText&quot;&gt;</span>
<a href="#l52.49"></a><span id="l52.49">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l52.50"></a><span id="l52.50">           this.showingSearchCriteria = true;</span>
<a href="#l52.51"></a><span id="l52.51">          // extract the label value from the menu item</span>
<a href="#l52.52"></a><span id="l52.52" class="difflineminus">-         var menuItems = document.getElementById('quick-search-menupopup').getElementsByAttribute('value', this.searchMode);          </span>
<a href="#l52.53"></a><span id="l52.53" class="difflineplus">+         var menuItems = document.getElementById('quick-search-menupopup').getElementsByAttribute('value', this.searchMode);</span>
<a href="#l52.54"></a><span id="l52.54">          this.inputField.value = menuItems[0].getAttribute('label');</span>
<a href="#l52.55"></a><span id="l52.55">          this.clearButtonHidden = true;</span>
<a href="#l52.56"></a><span id="l52.56">         ]]&gt;&lt;/body&gt;</span>
<a href="#l52.57"></a><span id="l52.57">       &lt;/method&gt;</span>
<a href="#l52.58"></a><span id="l52.58"> </span>
<a href="#l52.59"></a><span id="l52.59">       &lt;method name=&quot;openmenupopup&quot;&gt;</span>
<a href="#l52.60"></a><span id="l52.60">         &lt;body&gt;</span>
<a href="#l52.61"></a><span id="l52.61">           &lt;![CDATA[</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l53.1"></a><span id="l53.1" class="difflineminus">--- a/mail/base/content/searchBar.js</span>
<a href="#l53.2"></a><span id="l53.2" class="difflineplus">+++ b/mail/base/content/searchBar.js</span>
<a href="#l53.3"></a><span id="l53.3" class="difflineat">@@ -1,551 +1,159 @@</span>
<a href="#l53.4"></a><span id="l53.4" class="difflineminus">-# ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l53.5"></a><span id="l53.5" class="difflineminus">-# Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l53.6"></a><span id="l53.6" class="difflineminus">-#</span>
<a href="#l53.7"></a><span id="l53.7" class="difflineminus">-# The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l53.8"></a><span id="l53.8" class="difflineminus">-# 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l53.9"></a><span id="l53.9" class="difflineminus">-# the License. You may obtain a copy of the License at</span>
<a href="#l53.10"></a><span id="l53.10" class="difflineminus">-# http://www.mozilla.org/MPL/</span>
<a href="#l53.11"></a><span id="l53.11" class="difflineminus">-#</span>
<a href="#l53.12"></a><span id="l53.12" class="difflineminus">-# Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l53.13"></a><span id="l53.13" class="difflineminus">-# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l53.14"></a><span id="l53.14" class="difflineminus">-# for the specific language governing rights and limitations under the</span>
<a href="#l53.15"></a><span id="l53.15" class="difflineminus">-# License.</span>
<a href="#l53.16"></a><span id="l53.16" class="difflineminus">-#</span>
<a href="#l53.17"></a><span id="l53.17" class="difflineminus">-# The Original Code is Mozilla Communicator client code, released</span>
<a href="#l53.18"></a><span id="l53.18" class="difflineminus">-# March 31, 1998.</span>
<a href="#l53.19"></a><span id="l53.19" class="difflineminus">-#</span>
<a href="#l53.20"></a><span id="l53.20" class="difflineminus">-# The Initial Developer of the Original Code is</span>
<a href="#l53.21"></a><span id="l53.21" class="difflineminus">-# Netscape Communications Corporation.</span>
<a href="#l53.22"></a><span id="l53.22" class="difflineminus">-# Portions created by the Initial Developer are Copyright (C) 1998-1999</span>
<a href="#l53.23"></a><span id="l53.23" class="difflineminus">-# the Initial Developer. All Rights Reserved.</span>
<a href="#l53.24"></a><span id="l53.24" class="difflineminus">-#</span>
<a href="#l53.25"></a><span id="l53.25" class="difflineminus">-# Contributor(s):</span>
<a href="#l53.26"></a><span id="l53.26" class="difflineminus">-#   Seth Spitzer &lt;sspitzer@netscape.com&gt;</span>
<a href="#l53.27"></a><span id="l53.27" class="difflineminus">-#   Scott MacGregor &lt;mscott@mozilla.org&gt;</span>
<a href="#l53.28"></a><span id="l53.28" class="difflineminus">-#   David Bienvenu &lt;bienvenu@nventure.com&gt;</span>
<a href="#l53.29"></a><span id="l53.29" class="difflineminus">-#</span>
<a href="#l53.30"></a><span id="l53.30" class="difflineminus">-# Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l53.31"></a><span id="l53.31" class="difflineminus">-# either of the GNU General Public License Version 2 or later (the &quot;GPL&quot;),</span>
<a href="#l53.32"></a><span id="l53.32" class="difflineminus">-# or the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l53.33"></a><span id="l53.33" class="difflineminus">-# in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l53.34"></a><span id="l53.34" class="difflineminus">-# of those above. If you wish to allow use of your version of this file only</span>
<a href="#l53.35"></a><span id="l53.35" class="difflineminus">-# under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l53.36"></a><span id="l53.36" class="difflineminus">-# use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l53.37"></a><span id="l53.37" class="difflineminus">-# decision by deleting the provisions above and replace them with the notice</span>
<a href="#l53.38"></a><span id="l53.38" class="difflineminus">-# and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l53.39"></a><span id="l53.39" class="difflineminus">-# the provisions above, a recipient may use your version of this file under</span>
<a href="#l53.40"></a><span id="l53.40" class="difflineminus">-# the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l53.41"></a><span id="l53.41" class="difflineminus">-#</span>
<a href="#l53.42"></a><span id="l53.42" class="difflineminus">-# ***** END LICENSE BLOCK ***** </span>
<a href="#l53.43"></a><span id="l53.43" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l53.44"></a><span id="l53.44" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l53.45"></a><span id="l53.45" class="difflineplus">+ *</span>
<a href="#l53.46"></a><span id="l53.46" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l53.47"></a><span id="l53.47" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l53.48"></a><span id="l53.48" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l53.49"></a><span id="l53.49" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l53.50"></a><span id="l53.50" class="difflineplus">+ *</span>
<a href="#l53.51"></a><span id="l53.51" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l53.52"></a><span id="l53.52" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l53.53"></a><span id="l53.53" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l53.54"></a><span id="l53.54" class="difflineplus">+ * License.</span>
<a href="#l53.55"></a><span id="l53.55" class="difflineplus">+ *</span>
<a href="#l53.56"></a><span id="l53.56" class="difflineplus">+ * The Original Code is Mozilla Communicator client code, released</span>
<a href="#l53.57"></a><span id="l53.57" class="difflineplus">+ * March 31, 1998.</span>
<a href="#l53.58"></a><span id="l53.58" class="difflineplus">+ *</span>
<a href="#l53.59"></a><span id="l53.59" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l53.60"></a><span id="l53.60" class="difflineplus">+ * Netscape Communications Corporation.</span>
<a href="#l53.61"></a><span id="l53.61" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 1998-1999</span>
<a href="#l53.62"></a><span id="l53.62" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l53.63"></a><span id="l53.63" class="difflineplus">+ *</span>
<a href="#l53.64"></a><span id="l53.64" class="difflineplus">+ * Contributor(s):</span>
<a href="#l53.65"></a><span id="l53.65" class="difflineplus">+ *   Seth Spitzer &lt;sspitzer@netscape.com&gt;</span>
<a href="#l53.66"></a><span id="l53.66" class="difflineplus">+ *   Scott MacGregor &lt;mscott@mozilla.org&gt;</span>
<a href="#l53.67"></a><span id="l53.67" class="difflineplus">+ *   David Bienvenu &lt;bienvenu@nventure.com&gt;</span>
<a href="#l53.68"></a><span id="l53.68" class="difflineplus">+ *</span>
<a href="#l53.69"></a><span id="l53.69" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l53.70"></a><span id="l53.70" class="difflineplus">+ * either of the GNU General Public License Version 2 or later (the &quot;GPL&quot;),</span>
<a href="#l53.71"></a><span id="l53.71" class="difflineplus">+ * or the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l53.72"></a><span id="l53.72" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l53.73"></a><span id="l53.73" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l53.74"></a><span id="l53.74" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l53.75"></a><span id="l53.75" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l53.76"></a><span id="l53.76" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l53.77"></a><span id="l53.77" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l53.78"></a><span id="l53.78" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l53.79"></a><span id="l53.79" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l53.80"></a><span id="l53.80" class="difflineplus">+ *</span>
<a href="#l53.81"></a><span id="l53.81" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l53.82"></a><span id="l53.82"> </span>
<a href="#l53.83"></a><span id="l53.83" class="difflineminus">-var gSearchSession = null;</span>
<a href="#l53.84"></a><span id="l53.84" class="difflineminus">-var gPreQuickSearchView = null;</span>
<a href="#l53.85"></a><span id="l53.85" class="difflineminus">-var gSearchTimer = null;</span>
<a href="#l53.86"></a><span id="l53.86" class="difflineminus">-var gViewSearchListener;</span>
<a href="#l53.87"></a><span id="l53.87" class="difflineplus">+Components.utils.import(&quot;resource://app/modules/quickSearchManager.js&quot;);</span>
<a href="#l53.88"></a><span id="l53.88" class="difflineplus">+</span>
<a href="#l53.89"></a><span id="l53.89"> var gSearchBundle;</span>
<a href="#l53.90"></a><span id="l53.90"> var gStatusBar = null;</span>
<a href="#l53.91"></a><span id="l53.91" class="difflineminus">-var gSearchInProgress = false;</span>
<a href="#l53.92"></a><span id="l53.92" class="difflineminus">-var gDefaultSearchViewTerms = null;</span>
<a href="#l53.93"></a><span id="l53.93" class="difflineminus">-var gQSViewIsDirty = false;</span>
<a href="#l53.94"></a><span id="l53.94"> var gIgnoreFocus = false;</span>
<a href="#l53.95"></a><span id="l53.95"> var gIgnoreClick = false;</span>
<a href="#l53.96"></a><span id="l53.96" class="difflineminus">-var gNumTotalMessages;</span>
<a href="#l53.97"></a><span id="l53.97" class="difflineminus">-var gNumUnreadMessages;</span>
<a href="#l53.98"></a><span id="l53.98" class="difflineplus">+</span>
<a href="#l53.99"></a><span id="l53.99" class="difflineplus">+// change/add constants in QuickSearchConstants in quickSearchManager.js first</span>
<a href="#l53.100"></a><span id="l53.100" class="difflineplus">+// ideally these should go away in favor of everyone using QuickSearchConstants</span>
<a href="#l53.101"></a><span id="l53.101" class="difflineplus">+const kQuickSearchSubject = QuickSearchConstants.kQuickSearchSubject;</span>
<a href="#l53.102"></a><span id="l53.102" class="difflineplus">+const kQuickSearchFrom = QuickSearchConstants.kQuickSearchFrom;</span>
<a href="#l53.103"></a><span id="l53.103" class="difflineplus">+const kQuickSearchFromOrSubject =</span>
<a href="#l53.104"></a><span id="l53.104" class="difflineplus">+  QuickSearchConstants.kQuickSearchFromOrSubject;</span>
<a href="#l53.105"></a><span id="l53.105" class="difflineplus">+const kQuickSearchBody = QuickSearchConstants.kQuickSearchBody;</span>
<a href="#l53.106"></a><span id="l53.106" class="difflineplus">+const kQuickSearchRecipient = QuickSearchConstants.kQuickSearchRecipient;</span>
<a href="#l53.107"></a><span id="l53.107" class="difflineplus">+const kQuickSearchRecipientOrSubject =</span>
<a href="#l53.108"></a><span id="l53.108" class="difflineplus">+  QuickSearchConstants.kQuickSearchRecipientOrSubject;</span>
<a href="#l53.109"></a><span id="l53.109" class="difflineplus">+</span>
<a href="#l53.110"></a><span id="l53.110"> </span>
<a href="#l53.111"></a><span id="l53.111" class="difflineminus">-// search criteria mode values </span>
<a href="#l53.112"></a><span id="l53.112" class="difflineminus">-// Note: If you change these constants, please update the menuitem values in</span>
<a href="#l53.113"></a><span id="l53.113" class="difflineminus">-// quick-search-menupopup. Note: These values are stored in localstore.rdf so we </span>
<a href="#l53.114"></a><span id="l53.114" class="difflineminus">-// can remember the users last quick search state. If you add values here, you must add</span>
<a href="#l53.115"></a><span id="l53.115" class="difflineminus">-// them to the end of the list!</span>
<a href="#l53.116"></a><span id="l53.116" class="difflineminus">-const kQuickSearchSubject = 0;</span>
<a href="#l53.117"></a><span id="l53.117" class="difflineminus">-const kQuickSearchFrom = 1;</span>
<a href="#l53.118"></a><span id="l53.118" class="difflineminus">-const kQuickSearchFromOrSubject = 2;</span>
<a href="#l53.119"></a><span id="l53.119" class="difflineminus">-const kQuickSearchBody = 3;</span>
<a href="#l53.120"></a><span id="l53.120" class="difflineminus">-// const kQuickSearchHighlight = 4; // * We no longer support this quick search mode..*</span>
<a href="#l53.121"></a><span id="l53.121" class="difflineminus">-const kQuickSearchRecipient = 5;</span>
<a href="#l53.122"></a><span id="l53.122" class="difflineminus">-const kQuickSearchRecipientOrSubject = 6;</span>
<a href="#l53.123"></a><span id="l53.123" class="difflineplus">+/**</span>
<a href="#l53.124"></a><span id="l53.124" class="difflineplus">+ * We are exclusively concerned with disabling the quick-search box when a</span>
<a href="#l53.125"></a><span id="l53.125" class="difflineplus">+ *  tab is being displayed that lacks quick search abilities.</span>
<a href="#l53.126"></a><span id="l53.126" class="difflineplus">+ */</span>
<a href="#l53.127"></a><span id="l53.127" class="difflineplus">+var QuickSearchTabMonitor = {</span>
<a href="#l53.128"></a><span id="l53.128" class="difflineplus">+  onTabTitleChanged: function() {</span>
<a href="#l53.129"></a><span id="l53.129" class="difflineplus">+  },</span>
<a href="#l53.130"></a><span id="l53.130" class="difflineplus">+</span>
<a href="#l53.131"></a><span id="l53.131" class="difflineplus">+  onTabSwitched: function (aTab, aOldTab) {</span>
<a href="#l53.132"></a><span id="l53.132" class="difflineplus">+    let searchInput = document.getElementById(&quot;searchInput&quot;);</span>
<a href="#l53.133"></a><span id="l53.133" class="difflineplus">+</span>
<a href="#l53.134"></a><span id="l53.134" class="difflineplus">+    if (searchInput) {</span>
<a href="#l53.135"></a><span id="l53.135" class="difflineplus">+      let newTabEligible = aTab.mode.tabType == mailTabType;</span>
<a href="#l53.136"></a><span id="l53.136" class="difflineplus">+      searchInput.disabled = !newTabEligible;</span>
<a href="#l53.137"></a><span id="l53.137" class="difflineplus">+      if (!newTabEligible)</span>
<a href="#l53.138"></a><span id="l53.138" class="difflineplus">+        searchInput.value = &quot;&quot;;</span>
<a href="#l53.139"></a><span id="l53.139" class="difflineplus">+    }</span>
<a href="#l53.140"></a><span id="l53.140" class="difflineplus">+  },</span>
<a href="#l53.141"></a><span id="l53.141" class="difflineplus">+};</span>
<a href="#l53.142"></a><span id="l53.142"> </span>
<a href="#l53.143"></a><span id="l53.143"> </span>
<a href="#l53.144"></a><span id="l53.144"> function SetQSStatusText(aNumHits)</span>
<a href="#l53.145"></a><span id="l53.145"> {</span>
<a href="#l53.146"></a><span id="l53.146">   var statusMsg;</span>
<a href="#l53.147"></a><span id="l53.147">   // if there are no hits, it means no matches were found in the search.</span>
<a href="#l53.148"></a><span id="l53.148">   if (aNumHits == 0)</span>
<a href="#l53.149"></a><span id="l53.149">     statusMsg = gSearchBundle.getString(&quot;searchFailureMessage&quot;);</span>
<a href="#l53.150"></a><span id="l53.150" class="difflineminus">-  else </span>
<a href="#l53.151"></a><span id="l53.151" class="difflineplus">+  else</span>
<a href="#l53.152"></a><span id="l53.152">   {</span>
<a href="#l53.153"></a><span id="l53.153" class="difflineminus">-    if (aNumHits == 1) </span>
<a href="#l53.154"></a><span id="l53.154" class="difflineplus">+    if (aNumHits == 1)</span>
<a href="#l53.155"></a><span id="l53.155">       statusMsg = gSearchBundle.getString(&quot;searchSuccessMessage&quot;);</span>
<a href="#l53.156"></a><span id="l53.156">     else</span>
<a href="#l53.157"></a><span id="l53.157">       statusMsg = gSearchBundle.getFormattedString(&quot;searchSuccessMessages&quot;, [aNumHits]);</span>
<a href="#l53.158"></a><span id="l53.158">   }</span>
<a href="#l53.159"></a><span id="l53.159"> </span>
<a href="#l53.160"></a><span id="l53.160">   statusFeedback.showStatusString(statusMsg);</span>
<a href="#l53.161"></a><span id="l53.161"> }</span>
<a href="#l53.162"></a><span id="l53.162"> </span>
<a href="#l53.163"></a><span id="l53.163" class="difflineminus">-// nsIMsgSearchNotify object</span>
<a href="#l53.164"></a><span id="l53.164" class="difflineminus">-var gSearchNotificationListener =</span>
<a href="#l53.165"></a><span id="l53.165" class="difflineminus">-{</span>
<a href="#l53.166"></a><span id="l53.166" class="difflineminus">-    onSearchHit: function(header, folder)</span>
<a href="#l53.167"></a><span id="l53.167" class="difflineminus">-    {</span>
<a href="#l53.168"></a><span id="l53.168" class="difflineminus">-      gNumTotalMessages++;</span>
<a href="#l53.169"></a><span id="l53.169" class="difflineminus">-      if (!header.isRead)</span>
<a href="#l53.170"></a><span id="l53.170" class="difflineminus">-        gNumUnreadMessages++;</span>
<a href="#l53.171"></a><span id="l53.171" class="difflineminus">-        // XXX todo</span>
<a href="#l53.172"></a><span id="l53.172" class="difflineminus">-        // update status text?</span>
<a href="#l53.173"></a><span id="l53.173" class="difflineminus">-    },</span>
<a href="#l53.174"></a><span id="l53.174" class="difflineminus">-</span>
<a href="#l53.175"></a><span id="l53.175" class="difflineminus">-    onSearchDone: function(status)</span>
<a href="#l53.176"></a><span id="l53.176" class="difflineminus">-    {</span>
<a href="#l53.177"></a><span id="l53.177" class="difflineminus">-        SetQSStatusText(gDBView.QueryInterface(Components.interfaces.nsITreeView).rowCount)</span>
<a href="#l53.178"></a><span id="l53.178" class="difflineminus">-        statusFeedback.showProgress(0);</span>
<a href="#l53.179"></a><span id="l53.179" class="difflineminus">-        gStatusBar.setAttribute(&quot;mode&quot;,&quot;normal&quot;);</span>
<a href="#l53.180"></a><span id="l53.180" class="difflineminus">-        gSearchInProgress = false;</span>
<a href="#l53.181"></a><span id="l53.181" class="difflineminus">-</span>
<a href="#l53.182"></a><span id="l53.182" class="difflineminus">-        // ### TODO need to find out if there's quick search within a virtual folder.</span>
<a href="#l53.183"></a><span id="l53.183" class="difflineminus">-        if (gCurrentVirtualFolderUri &amp;&amp;</span>
<a href="#l53.184"></a><span id="l53.184" class="difflineminus">-         (!gSearchInput || gSearchInput.value == &quot;&quot; || gSearchInput.showingSearchCriteria))</span>
<a href="#l53.185"></a><span id="l53.185" class="difflineminus">-        {</span>
<a href="#l53.186"></a><span id="l53.186" class="difflineminus">-          var vFolder = GetMsgFolderFromUri(gCurrentVirtualFolderUri, false);</span>
<a href="#l53.187"></a><span id="l53.187" class="difflineminus">-          var dbFolderInfo = vFolder.msgDatabase.dBFolderInfo;</span>
<a href="#l53.188"></a><span id="l53.188" class="difflineminus">-          dbFolderInfo.numUnreadMessages = gNumUnreadMessages;</span>
<a href="#l53.189"></a><span id="l53.189" class="difflineminus">-          dbFolderInfo.numMessages = gNumTotalMessages;</span>
<a href="#l53.190"></a><span id="l53.190" class="difflineminus">-          vFolder.updateSummaryTotals(true); // force update from db.</span>
<a href="#l53.191"></a><span id="l53.191" class="difflineminus">-          const MSG_DB_LARGE_COMMIT = 1;</span>
<a href="#l53.192"></a><span id="l53.192" class="difflineminus">-          vFolder.msgDatabase.Commit(MSG_DB_LARGE_COMMIT);</span>
<a href="#l53.193"></a><span id="l53.193" class="difflineminus">-          // now that we have finished loading a virtual folder,</span>
<a href="#l53.194"></a><span id="l53.194" class="difflineminus">-          // scroll to the correct message if there is at least one.</span>
<a href="#l53.195"></a><span id="l53.195" class="difflineminus">-          if (vFolder.getTotalMessages(false) &gt; 0)</span>
<a href="#l53.196"></a><span id="l53.196" class="difflineminus">-            ScrollToMessageAfterFolderLoad(vFolder);</span>
<a href="#l53.197"></a><span id="l53.197" class="difflineminus">-        }</span>
<a href="#l53.198"></a><span id="l53.198" class="difflineminus">-    },</span>
<a href="#l53.199"></a><span id="l53.199" class="difflineminus">-</span>
<a href="#l53.200"></a><span id="l53.200" class="difflineminus">-    onNewSearch: function()</span>
<a href="#l53.201"></a><span id="l53.201" class="difflineminus">-    {</span>
<a href="#l53.202"></a><span id="l53.202" class="difflineminus">-      statusFeedback.showProgress(0);</span>
<a href="#l53.203"></a><span id="l53.203" class="difflineminus">-      statusFeedback.showStatusString(gSearchBundle.getString(&quot;searchingMessage&quot;));</span>
<a href="#l53.204"></a><span id="l53.204" class="difflineminus">-      gStatusBar.setAttribute(&quot;mode&quot;,&quot;undetermined&quot;);</span>
<a href="#l53.205"></a><span id="l53.205" class="difflineminus">-      gSearchInProgress = true;</span>
<a href="#l53.206"></a><span id="l53.206" class="difflineminus">-      gNumTotalMessages = 0; </span>
<a href="#l53.207"></a><span id="l53.207" class="difflineminus">-      gNumUnreadMessages = 0;</span>
<a href="#l53.208"></a><span id="l53.208" class="difflineminus">-    }</span>
<a href="#l53.209"></a><span id="l53.209" class="difflineminus">-}</span>
<a href="#l53.210"></a><span id="l53.210" class="difflineminus">-</span>
<a href="#l53.211"></a><span id="l53.211"> function getDocumentElements()</span>
<a href="#l53.212"></a><span id="l53.212"> {</span>
<a href="#l53.213"></a><span id="l53.213" class="difflineminus">-  gSearchBundle = document.getElementById(&quot;bundle_search&quot;);  </span>
<a href="#l53.214"></a><span id="l53.214" class="difflineplus">+  gSearchBundle = document.getElementById(&quot;bundle_search&quot;);</span>
<a href="#l53.215"></a><span id="l53.215">   gStatusBar = document.getElementById('statusbar-icon');</span>
<a href="#l53.216"></a><span id="l53.216">   GetSearchInput();</span>
<a href="#l53.217"></a><span id="l53.217"> }</span>
<a href="#l53.218"></a><span id="l53.218"> </span>
<a href="#l53.219"></a><span id="l53.219" class="difflineminus">-function addListeners()</span>
<a href="#l53.220"></a><span id="l53.220" class="difflineminus">-{</span>
<a href="#l53.221"></a><span id="l53.221" class="difflineminus">-  gViewSearchListener = gDBView.QueryInterface(Components.interfaces.nsIMsgSearchNotify);</span>
<a href="#l53.222"></a><span id="l53.222" class="difflineminus">-  gSearchSession.registerListener(gViewSearchListener);</span>
<a href="#l53.223"></a><span id="l53.223" class="difflineminus">-}</span>
<a href="#l53.224"></a><span id="l53.224" class="difflineminus">-</span>
<a href="#l53.225"></a><span id="l53.225" class="difflineminus">-function removeListeners()</span>
<a href="#l53.226"></a><span id="l53.226" class="difflineminus">-{</span>
<a href="#l53.227"></a><span id="l53.227" class="difflineminus">-  gSearchSession.unregisterListener(gViewSearchListener);</span>
<a href="#l53.228"></a><span id="l53.228" class="difflineminus">-}</span>
<a href="#l53.229"></a><span id="l53.229" class="difflineminus">-</span>
<a href="#l53.230"></a><span id="l53.230" class="difflineminus">-function removeGlobalListeners()</span>
<a href="#l53.231"></a><span id="l53.231" class="difflineminus">-{</span>
<a href="#l53.232"></a><span id="l53.232" class="difflineminus">-  removeListeners();</span>
<a href="#l53.233"></a><span id="l53.233" class="difflineminus">-  gSearchSession.unregisterListener(gSearchNotificationListener); </span>
<a href="#l53.234"></a><span id="l53.234" class="difflineminus">-}</span>
<a href="#l53.235"></a><span id="l53.235" class="difflineminus">-</span>
<a href="#l53.236"></a><span id="l53.236" class="difflineminus">-function initializeGlobalListeners()</span>
<a href="#l53.237"></a><span id="l53.237" class="difflineminus">-{</span>
<a href="#l53.238"></a><span id="l53.238" class="difflineminus">-  // Setup the javascript object as a listener on the search results</span>
<a href="#l53.239"></a><span id="l53.239" class="difflineminus">-  gSearchSession.registerListener(gSearchNotificationListener);</span>
<a href="#l53.240"></a><span id="l53.240" class="difflineminus">-}</span>
<a href="#l53.241"></a><span id="l53.241" class="difflineminus">-</span>
<a href="#l53.242"></a><span id="l53.242" class="difflineminus">-function createQuickSearchView()</span>
<a href="#l53.243"></a><span id="l53.243" class="difflineminus">-{</span>
<a href="#l53.244"></a><span id="l53.244" class="difflineminus">-  //if not already in quick search view </span>
<a href="#l53.245"></a><span id="l53.245" class="difflineminus">-  if (gDBView.viewType != nsMsgViewType.eShowQuickSearchResults)  </span>
<a href="#l53.246"></a><span id="l53.246" class="difflineminus">-  {</span>
<a href="#l53.247"></a><span id="l53.247" class="difflineminus">-    var treeView = gDBView.QueryInterface(Components.interfaces.nsITreeView);  //clear selection</span>
<a href="#l53.248"></a><span id="l53.248" class="difflineminus">-    if (treeView &amp;&amp; treeView.selection)</span>
<a href="#l53.249"></a><span id="l53.249" class="difflineminus">-      treeView.selection.clearSelection();</span>
<a href="#l53.250"></a><span id="l53.250" class="difflineminus">-    gPreQuickSearchView = gDBView;</span>
<a href="#l53.251"></a><span id="l53.251" class="difflineminus">-    if (gDBView.viewType == nsMsgViewType.eShowVirtualFolderResults)</span>
<a href="#l53.252"></a><span id="l53.252" class="difflineminus">-    {</span>
<a href="#l53.253"></a><span id="l53.253" class="difflineminus">-      // remove the view as a listener on the search results</span>
<a href="#l53.254"></a><span id="l53.254" class="difflineminus">-      var saveViewSearchListener = gDBView.QueryInterface(Components.interfaces.nsIMsgSearchNotify);</span>
<a href="#l53.255"></a><span id="l53.255" class="difflineminus">-      gSearchSession.unregisterListener(saveViewSearchListener);</span>
<a href="#l53.256"></a><span id="l53.256" class="difflineminus">-    }</span>
<a href="#l53.257"></a><span id="l53.257" class="difflineminus">-    var viewFlags = gDBView.viewFlags;</span>
<a href="#l53.258"></a><span id="l53.258" class="difflineminus">-    CreateDBView(gDBView.msgFolder, (gXFVirtualFolderTerms) ? nsMsgViewType.eShowVirtualFolderResults : nsMsgViewType.eShowQuickSearchResults, viewFlags, gDBView.sortType, gDBView.sortOrder);</span>
<a href="#l53.259"></a><span id="l53.259" class="difflineminus">-  }</span>
<a href="#l53.260"></a><span id="l53.260" class="difflineminus">-}</span>
<a href="#l53.261"></a><span id="l53.261" class="difflineminus">-</span>
<a href="#l53.262"></a><span id="l53.262" class="difflineminus">-function initializeSearchBar()</span>
<a href="#l53.263"></a><span id="l53.263" class="difflineminus">-{</span>
<a href="#l53.264"></a><span id="l53.264" class="difflineminus">-   createQuickSearchView();</span>
<a href="#l53.265"></a><span id="l53.265" class="difflineminus">-   if (!gSearchSession)</span>
<a href="#l53.266"></a><span id="l53.266" class="difflineminus">-   {</span>
<a href="#l53.267"></a><span id="l53.267" class="difflineminus">-     getDocumentElements();</span>
<a href="#l53.268"></a><span id="l53.268" class="difflineminus">-     var searchSessionContractID = &quot;@mozilla.org/messenger/searchSession;1&quot;;</span>
<a href="#l53.269"></a><span id="l53.269" class="difflineminus">-     gSearchSession = Components.classes[searchSessionContractID].createInstance(Components.interfaces.nsIMsgSearchSession);</span>
<a href="#l53.270"></a><span id="l53.270" class="difflineminus">-     initializeGlobalListeners();</span>
<a href="#l53.271"></a><span id="l53.271" class="difflineminus">-   }</span>
<a href="#l53.272"></a><span id="l53.272" class="difflineminus">-   else</span>
<a href="#l53.273"></a><span id="l53.273" class="difflineminus">-   {</span>
<a href="#l53.274"></a><span id="l53.274" class="difflineminus">-     if (gSearchInProgress)</span>
<a href="#l53.275"></a><span id="l53.275" class="difflineminus">-     {</span>
<a href="#l53.276"></a><span id="l53.276" class="difflineminus">-       onSearchStop();</span>
<a href="#l53.277"></a><span id="l53.277" class="difflineminus">-       gSearchInProgress = false;</span>
<a href="#l53.278"></a><span id="l53.278" class="difflineminus">-     }</span>
<a href="#l53.279"></a><span id="l53.279" class="difflineminus">-     removeListeners();</span>
<a href="#l53.280"></a><span id="l53.280" class="difflineminus">-   }</span>
<a href="#l53.281"></a><span id="l53.281" class="difflineminus">-   addListeners();</span>
<a href="#l53.282"></a><span id="l53.282" class="difflineminus">-}</span>
<a href="#l53.283"></a><span id="l53.283" class="difflineminus">-</span>
<a href="#l53.284"></a><span id="l53.284"> function onEnterInSearchBar()</span>
<a href="#l53.285"></a><span id="l53.285"> {</span>
<a href="#l53.286"></a><span id="l53.286" class="difflineminus">-   if (!gSearchInput || gSearchInput.value == &quot;&quot; || gSearchInput.showingSearchCriteria) </span>
<a href="#l53.287"></a><span id="l53.287" class="difflineminus">-   { </span>
<a href="#l53.288"></a><span id="l53.288" class="difflineminus">-     if (gDBView.viewType == nsMsgViewType.eShowQuickSearchResults </span>
<a href="#l53.289"></a><span id="l53.289" class="difflineminus">-        || gDBView.viewType == nsMsgViewType.eShowVirtualFolderResults)</span>
<a href="#l53.290"></a><span id="l53.290" class="difflineminus">-     {</span>
<a href="#l53.291"></a><span id="l53.291" class="difflineminus">-       statusFeedback.showStatusString(&quot;&quot;);</span>
<a href="#l53.292"></a><span id="l53.292" class="difflineminus">-</span>
<a href="#l53.293"></a><span id="l53.293" class="difflineminus">-       viewDebug (&quot;onEnterInSearchBar gDefaultSearchViewTerms = &quot; + gDefaultSearchViewTerms + &quot;gVirtualFolderTerms = &quot; </span>
<a href="#l53.294"></a><span id="l53.294" class="difflineminus">-        + gVirtualFolderTerms + &quot;gXFVirtualFolderTerms = &quot; + gXFVirtualFolderTerms + &quot;\n&quot;);</span>
<a href="#l53.295"></a><span id="l53.295" class="difflineminus">-       var addTerms = gDefaultSearchViewTerms || gVirtualFolderTerms || gXFVirtualFolderTerms;</span>
<a href="#l53.296"></a><span id="l53.296" class="difflineminus">-       if (addTerms)</span>
<a href="#l53.297"></a><span id="l53.297" class="difflineminus">-       {</span>
<a href="#l53.298"></a><span id="l53.298" class="difflineminus">-           viewDebug (&quot;addTerms = &quot; + addTerms + &quot; count = &quot; + addTerms.Count() + &quot;\n&quot;);</span>
<a href="#l53.299"></a><span id="l53.299" class="difflineminus">-           initializeSearchBar();</span>
<a href="#l53.300"></a><span id="l53.300" class="difflineminus">-           onSearch(addTerms);</span>
<a href="#l53.301"></a><span id="l53.301" class="difflineminus">-       }</span>
<a href="#l53.302"></a><span id="l53.302" class="difflineminus">-       else</span>
<a href="#l53.303"></a><span id="l53.303" class="difflineminus">-        restorePreSearchView();</span>
<a href="#l53.304"></a><span id="l53.304" class="difflineminus">-     }</span>
<a href="#l53.305"></a><span id="l53.305" class="difflineminus">-     else if (gPreQuickSearchView &amp;&amp; !gDefaultSearchViewTerms)// may be a quick search from a cross-folder virtual folder</span>
<a href="#l53.306"></a><span id="l53.306" class="difflineminus">-      restorePreSearchView();</span>
<a href="#l53.307"></a><span id="l53.307" class="difflineminus">-     </span>
<a href="#l53.308"></a><span id="l53.308" class="difflineminus">-     if (gSearchInput)</span>
<a href="#l53.309"></a><span id="l53.309" class="difflineminus">-       gSearchInput.showingSearchCriteria = true;</span>
<a href="#l53.310"></a><span id="l53.310" class="difflineminus">-   </span>
<a href="#l53.311"></a><span id="l53.311" class="difflineminus">-     gQSViewIsDirty = false;</span>
<a href="#l53.312"></a><span id="l53.312" class="difflineminus">-     return;</span>
<a href="#l53.313"></a><span id="l53.313" class="difflineminus">-   }</span>
<a href="#l53.314"></a><span id="l53.314" class="difflineminus">-</span>
<a href="#l53.315"></a><span id="l53.315" class="difflineminus">-   initializeSearchBar();</span>
<a href="#l53.316"></a><span id="l53.316" class="difflineminus">-</span>
<a href="#l53.317"></a><span id="l53.317" class="difflineminus">-   ClearThreadPaneSelection();</span>
<a href="#l53.318"></a><span id="l53.318" class="difflineminus">-   ClearMessagePane();</span>
<a href="#l53.319"></a><span id="l53.319" class="difflineminus">-</span>
<a href="#l53.320"></a><span id="l53.320" class="difflineminus">-   onSearch(null);</span>
<a href="#l53.321"></a><span id="l53.321" class="difflineminus">-   gQSViewIsDirty = false;</span>
<a href="#l53.322"></a><span id="l53.322" class="difflineminus">-}</span>
<a href="#l53.323"></a><span id="l53.323" class="difflineminus">-</span>
<a href="#l53.324"></a><span id="l53.324" class="difflineminus">-function restorePreSearchView()</span>
<a href="#l53.325"></a><span id="l53.325" class="difflineminus">-{</span>
<a href="#l53.326"></a><span id="l53.326" class="difflineminus">-  var selectedHdr = null;</span>
<a href="#l53.327"></a><span id="l53.327" class="difflineminus">-  //save selection</span>
<a href="#l53.328"></a><span id="l53.328" class="difflineminus">-  try </span>
<a href="#l53.329"></a><span id="l53.329" class="difflineminus">-  {</span>
<a href="#l53.330"></a><span id="l53.330" class="difflineminus">-    selectedHdr = gDBView.hdrForFirstSelectedMessage;</span>
<a href="#l53.331"></a><span id="l53.331" class="difflineminus">-  }</span>
<a href="#l53.332"></a><span id="l53.332" class="difflineminus">-  catch (ex)</span>
<a href="#l53.333"></a><span id="l53.333" class="difflineminus">-  {}</span>
<a href="#l53.334"></a><span id="l53.334" class="difflineminus">-</span>
<a href="#l53.335"></a><span id="l53.335" class="difflineminus">-  //we might have to sort the view coming out of quick search</span>
<a href="#l53.336"></a><span id="l53.336" class="difflineminus">-  var sortType = gDBView.sortType;</span>
<a href="#l53.337"></a><span id="l53.337" class="difflineminus">-  var sortOrder = gDBView.sortOrder;</span>
<a href="#l53.338"></a><span id="l53.338" class="difflineminus">-  var viewFlags = gDBView.viewFlags;</span>
<a href="#l53.339"></a><span id="l53.339" class="difflineminus">-  var folder = gDBView.msgFolder;</span>
<a href="#l53.340"></a><span id="l53.340" class="difflineminus">-</span>
<a href="#l53.341"></a><span id="l53.341" class="difflineminus">-  gDBView.close();</span>
<a href="#l53.342"></a><span id="l53.342" class="difflineminus">-  gDBView = null; </span>
<a href="#l53.343"></a><span id="l53.343" class="difflineplus">+  if (!gSearchInput)</span>
<a href="#l53.344"></a><span id="l53.344" class="difflineplus">+    return;</span>
<a href="#l53.345"></a><span id="l53.345"> </span>
<a href="#l53.346"></a><span id="l53.346" class="difflineminus">-  if (gPreQuickSearchView)</span>
<a href="#l53.347"></a><span id="l53.347" class="difflineminus">-  {</span>
<a href="#l53.348"></a><span id="l53.348" class="difflineminus">-    gDBView = gPreQuickSearchView;</span>
<a href="#l53.349"></a><span id="l53.349" class="difflineminus">-    if (gDBView.viewType == nsMsgViewType.eShowVirtualFolderResults)</span>
<a href="#l53.350"></a><span id="l53.350" class="difflineminus">-    {</span>
<a href="#l53.351"></a><span id="l53.351" class="difflineminus">-      // read the view as a listener on the search results</span>
<a href="#l53.352"></a><span id="l53.352" class="difflineminus">-      var saveViewSearchListener = gDBView.QueryInterface(Components.interfaces.nsIMsgSearchNotify);</span>
<a href="#l53.353"></a><span id="l53.353" class="difflineminus">-      if (gSearchSession)</span>
<a href="#l53.354"></a><span id="l53.354" class="difflineminus">-        gSearchSession.registerListener(saveViewSearchListener);</span>
<a href="#l53.355"></a><span id="l53.355" class="difflineminus">-    }</span>
<a href="#l53.356"></a><span id="l53.356" class="difflineminus">-//    dump (&quot;view type = &quot; + gDBView.viewType + &quot;\n&quot;);</span>
<a href="#l53.357"></a><span id="l53.357" class="difflineminus">-</span>
<a href="#l53.358"></a><span id="l53.358" class="difflineminus">-    if (sortType != gDBView.sortType || sortOrder != gDBView.sortOrder)</span>
<a href="#l53.359"></a><span id="l53.359" class="difflineminus">-    {</span>
<a href="#l53.360"></a><span id="l53.360" class="difflineminus">-      gDBView.sort(sortType, sortOrder);</span>
<a href="#l53.361"></a><span id="l53.361" class="difflineminus">-    }</span>
<a href="#l53.362"></a><span id="l53.362" class="difflineminus">-    UpdateSortIndicators(sortType, sortOrder);</span>
<a href="#l53.363"></a><span id="l53.363" class="difflineminus">-</span>
<a href="#l53.364"></a><span id="l53.364" class="difflineminus">-    gPreQuickSearchView = null;    </span>
<a href="#l53.365"></a><span id="l53.365" class="difflineminus">-  }</span>
<a href="#l53.366"></a><span id="l53.366" class="difflineminus">-  else //create default view type</span>
<a href="#l53.367"></a><span id="l53.367" class="difflineminus">-  {</span>
<a href="#l53.368"></a><span id="l53.368" class="difflineminus">-    CreateDBView(folder, nsMsgViewType.eShowAllThreads, viewFlags, sortType, sortOrder);</span>
<a href="#l53.369"></a><span id="l53.369" class="difflineminus">-  }</span>
<a href="#l53.370"></a><span id="l53.370" class="difflineplus">+  // nothing changes while showing the criteria</span>
<a href="#l53.371"></a><span id="l53.371" class="difflineplus">+  if (gSearchInput.showingSearchCriteria)</span>
<a href="#l53.372"></a><span id="l53.372" class="difflineplus">+    return;</span>
<a href="#l53.373"></a><span id="l53.373"> </span>
<a href="#l53.374"></a><span id="l53.374" class="difflineminus">-  RerootThreadPane();</span>
<a href="#l53.375"></a><span id="l53.375" class="difflineminus">-   </span>
<a href="#l53.376"></a><span id="l53.376" class="difflineminus">-  var scrolled = false;</span>
<a href="#l53.377"></a><span id="l53.377" class="difflineminus">-  </span>
<a href="#l53.378"></a><span id="l53.378" class="difflineminus">-  // now restore selection</span>
<a href="#l53.379"></a><span id="l53.379" class="difflineminus">-  if (selectedHdr)</span>
<a href="#l53.380"></a><span id="l53.380" class="difflineminus">-  {</span>
<a href="#l53.381"></a><span id="l53.381" class="difflineminus">-    gDBView.selectMsgByKey(selectedHdr.messageKey);</span>
<a href="#l53.382"></a><span id="l53.382" class="difflineminus">-    var treeView = gDBView.QueryInterface(Components.interfaces.nsITreeView);</span>
<a href="#l53.383"></a><span id="l53.383" class="difflineminus">-    var selectedIndex = treeView.selection.currentIndex;</span>
<a href="#l53.384"></a><span id="l53.384" class="difflineminus">-    if (selectedIndex &gt;= 0) </span>
<a href="#l53.385"></a><span id="l53.385" class="difflineminus">-    {</span>
<a href="#l53.386"></a><span id="l53.386" class="difflineminus">-      // scroll</span>
<a href="#l53.387"></a><span id="l53.387" class="difflineminus">-      EnsureRowInThreadTreeIsVisible(selectedIndex);</span>
<a href="#l53.388"></a><span id="l53.388" class="difflineminus">-      scrolled = true;</span>
<a href="#l53.389"></a><span id="l53.389" class="difflineminus">-    }</span>
<a href="#l53.390"></a><span id="l53.390" class="difflineminus">-    else</span>
<a href="#l53.391"></a><span id="l53.391" class="difflineminus">-      ClearMessagePane();</span>
<a href="#l53.392"></a><span id="l53.392" class="difflineminus">-  }</span>
<a href="#l53.393"></a><span id="l53.393" class="difflineminus">-</span>
<a href="#l53.394"></a><span id="l53.394" class="difflineminus">-  if (!scrolled)</span>
<a href="#l53.395"></a><span id="l53.395" class="difflineminus">-    ScrollToMessageAfterFolderLoad(null);</span>
<a href="#l53.396"></a><span id="l53.396" class="difflineminus">-}</span>
<a href="#l53.397"></a><span id="l53.397" class="difflineminus">-</span>
<a href="#l53.398"></a><span id="l53.398" class="difflineminus">-function onSearch(aSearchTerms)</span>
<a href="#l53.399"></a><span id="l53.399" class="difflineminus">-{</span>
<a href="#l53.400"></a><span id="l53.400" class="difflineminus">-    viewDebug(&quot;in OnSearch, searchTerms = &quot; + aSearchTerms + &quot;\n&quot;);</span>
<a href="#l53.401"></a><span id="l53.401" class="difflineminus">-    RerootThreadPane();</span>
<a href="#l53.402"></a><span id="l53.402" class="difflineminus">-</span>
<a href="#l53.403"></a><span id="l53.403" class="difflineminus">-    if (aSearchTerms)</span>
<a href="#l53.404"></a><span id="l53.404" class="difflineminus">-      createSearchTermsWithList(aSearchTerms);</span>
<a href="#l53.405"></a><span id="l53.405" class="difflineminus">-    else</span>
<a href="#l53.406"></a><span id="l53.406" class="difflineminus">-      createSearchTerms();</span>
<a href="#l53.407"></a><span id="l53.407" class="difflineminus">-</span>
<a href="#l53.408"></a><span id="l53.408" class="difflineminus">-    gDBView.searchSession = gSearchSession;</span>
<a href="#l53.409"></a><span id="l53.409" class="difflineminus">-    try</span>
<a href="#l53.410"></a><span id="l53.410" class="difflineminus">-    {</span>
<a href="#l53.411"></a><span id="l53.411" class="difflineminus">-      gSearchSession.search(msgWindow);</span>
<a href="#l53.412"></a><span id="l53.412" class="difflineminus">-    }</span>
<a href="#l53.413"></a><span id="l53.413" class="difflineminus">-    catch(ex)</span>
<a href="#l53.414"></a><span id="l53.414" class="difflineminus">-    {</span>
<a href="#l53.415"></a><span id="l53.415" class="difflineminus">-      dump(&quot;Search Exception\n&quot;);</span>
<a href="#l53.416"></a><span id="l53.416" class="difflineminus">-    }</span>
<a href="#l53.417"></a><span id="l53.417" class="difflineplus">+  if (!gSearchInput || gSearchInput.value == &quot;&quot;)</span>
<a href="#l53.418"></a><span id="l53.418" class="difflineplus">+     gFolderDisplay.view.search.userTerms = null;</span>
<a href="#l53.419"></a><span id="l53.419" class="difflineplus">+  else</span>
<a href="#l53.420"></a><span id="l53.420" class="difflineplus">+     gFolderDisplay.view.search.quickSearch(gSearchInput.searchMode,</span>
<a href="#l53.421"></a><span id="l53.421" class="difflineplus">+                                            gSearchInput.value);</span>
<a href="#l53.422"></a><span id="l53.422"> }</span>
<a href="#l53.423"></a><span id="l53.423"> </span>
<a href="#l53.424"></a><span id="l53.424" class="difflineminus">-function createSearchTermsWithList(aTermsArray)</span>
<a href="#l53.425"></a><span id="l53.425" class="difflineminus">-{</span>
<a href="#l53.426"></a><span id="l53.426" class="difflineminus">-  var nsMsgSearchScope = Components.interfaces.nsMsgSearchScope;</span>
<a href="#l53.427"></a><span id="l53.427" class="difflineminus">-  var nsMsgSearchAttrib = Components.interfaces.nsMsgSearchAttrib;</span>
<a href="#l53.428"></a><span id="l53.428" class="difflineminus">-  var nsMsgSearchOp = Components.interfaces.nsMsgSearchOp;</span>
<a href="#l53.429"></a><span id="l53.429" class="difflineminus">-</span>
<a href="#l53.430"></a><span id="l53.430" class="difflineminus">-  gSearchSession.clearScopes();</span>
<a href="#l53.431"></a><span id="l53.431" class="difflineminus">-  var searchTerms = gSearchSession.searchTerms;</span>
<a href="#l53.432"></a><span id="l53.432" class="difflineminus">-  var searchTermsArray = searchTerms.QueryInterface(Components.interfaces.nsISupportsArray);</span>
<a href="#l53.433"></a><span id="l53.433" class="difflineminus">-  searchTermsArray.Clear();</span>
<a href="#l53.434"></a><span id="l53.434" class="difflineminus">-</span>
<a href="#l53.435"></a><span id="l53.435" class="difflineminus">-  var i;</span>
<a href="#l53.436"></a><span id="l53.436" class="difflineminus">-  var selectedFolder = GetThreadPaneFolder();</span>
<a href="#l53.437"></a><span id="l53.437" class="difflineminus">-  var ioService = Components.classes[&quot;@mozilla.org/network/io-service;1&quot;]</span>
<a href="#l53.438"></a><span id="l53.438" class="difflineminus">-                  .getService(Components.interfaces.nsIIOService);</span>
<a href="#l53.439"></a><span id="l53.439" class="difflineminus">-  </span>
<a href="#l53.440"></a><span id="l53.440" class="difflineminus">-  var termsArray = aTermsArray.QueryInterface(Components.interfaces.nsISupportsArray);</span>
<a href="#l53.441"></a><span id="l53.441" class="difflineminus">-</span>
<a href="#l53.442"></a><span id="l53.442" class="difflineminus">-  if (gXFVirtualFolderTerms)</span>
<a href="#l53.443"></a><span id="l53.443" class="difflineminus">-  {</span>
<a href="#l53.444"></a><span id="l53.444" class="difflineminus">-    var msgDatabase = selectedFolder.msgDatabase;</span>
<a href="#l53.445"></a><span id="l53.445" class="difflineminus">-    if (msgDatabase)</span>
<a href="#l53.446"></a><span id="l53.446" class="difflineminus">-    {</span>
<a href="#l53.447"></a><span id="l53.447" class="difflineminus">-      var dbFolderInfo = msgDatabase.dBFolderInfo;</span>
<a href="#l53.448"></a><span id="l53.448" class="difflineminus">-      var srchFolderUri = dbFolderInfo.getCharProperty(&quot;searchFolderUri&quot;);</span>
<a href="#l53.449"></a><span id="l53.449" class="difflineminus">-      viewDebug(&quot;createSearchTermsWithList xf vf scope = &quot; + srchFolderUri + &quot;\n&quot;);</span>
<a href="#l53.450"></a><span id="l53.450" class="difflineminus">-      var srchFolderUriArray = srchFolderUri.split('|');</span>
<a href="#l53.451"></a><span id="l53.451" class="difflineminus">-      for (i in srchFolderUriArray) </span>
<a href="#l53.452"></a><span id="l53.452" class="difflineminus">-      {</span>
<a href="#l53.453"></a><span id="l53.453" class="difflineminus">-        var realFolder = GetMsgFolderFromUri(srchFolderUriArray[i]);</span>
<a href="#l53.454"></a><span id="l53.454" class="difflineminus">-        if (!realFolder.isServer)</span>
<a href="#l53.455"></a><span id="l53.455" class="difflineminus">-          gSearchSession.addScopeTerm(getScopeToUse(termsArray, realFolder, ioService.offline), realFolder);</span>
<a href="#l53.456"></a><span id="l53.456" class="difflineminus">-      }</span>
<a href="#l53.457"></a><span id="l53.457" class="difflineminus">-    }</span>
<a href="#l53.458"></a><span id="l53.458" class="difflineminus">-  }</span>
<a href="#l53.459"></a><span id="l53.459" class="difflineminus">-  else</span>
<a href="#l53.460"></a><span id="l53.460" class="difflineminus">-  {</span>
<a href="#l53.461"></a><span id="l53.461" class="difflineminus">-    viewDebug (&quot;in createSearchTermsWithList, adding scope term for selected folder\n&quot;);</span>
<a href="#l53.462"></a><span id="l53.462" class="difflineminus">-    gSearchSession.addScopeTerm(getScopeToUse(termsArray, selectedFolder, ioService.offline), selectedFolder);</span>
<a href="#l53.463"></a><span id="l53.463" class="difflineminus">-  }</span>
<a href="#l53.464"></a><span id="l53.464" class="difflineminus">-</span>
<a href="#l53.465"></a><span id="l53.465" class="difflineminus">-  // add each item in termsArray to the search session</span>
<a href="#l53.466"></a><span id="l53.466" class="difflineminus">-  for (i = 0; i &lt; termsArray.Count(); ++i)</span>
<a href="#l53.467"></a><span id="l53.467" class="difflineminus">-    gSearchSession.appendTerm(termsArray.GetElementAt(i).QueryInterface(Components.interfaces.nsIMsgSearchTerm));</span>
<a href="#l53.468"></a><span id="l53.468" class="difflineminus">-}</span>
<a href="#l53.469"></a><span id="l53.469" class="difflineminus">-</span>
<a href="#l53.470"></a><span id="l53.470" class="difflineminus">-function getScopeToUse(aTermsArray, aFolderToSearch, aIsOffline)</span>
<a href="#l53.471"></a><span id="l53.471" class="difflineminus">-{</span>
<a href="#l53.472"></a><span id="l53.472" class="difflineminus">-  if (aIsOffline || aFolderToSearch.server.type != 'imap')</span>
<a href="#l53.473"></a><span id="l53.473" class="difflineminus">-    return nsMsgSearchScope.offlineMail;</span>
<a href="#l53.474"></a><span id="l53.474" class="difflineminus">-</span>
<a href="#l53.475"></a><span id="l53.475" class="difflineminus">-  var scopeToUse = gSearchInput &amp;&amp; gSearchInput.searchMode == kQuickSearchBody &amp;&amp; !gSearchInput.showingSearchCriteria</span>
<a href="#l53.476"></a><span id="l53.476" class="difflineminus">-                   ? nsMsgSearchScope.onlineMail : nsMsgSearchScope.offlineMail;</span>
<a href="#l53.477"></a><span id="l53.477" class="difflineminus">-</span>
<a href="#l53.478"></a><span id="l53.478" class="difflineminus">-  // it's possible one of our search terms may require us to use an online mail scope (such as imap body searches)</span>
<a href="#l53.479"></a><span id="l53.479" class="difflineminus">-  for (var i = 0; scopeToUse != nsMsgSearchScope.onlineMail &amp;&amp; i &lt; aTermsArray.Count(); i++)</span>
<a href="#l53.480"></a><span id="l53.480" class="difflineminus">-    if (aTermsArray.GetElementAt(i).QueryInterface(Components.interfaces.nsIMsgSearchTerm).attrib == nsMsgSearchAttrib.Body)</span>
<a href="#l53.481"></a><span id="l53.481" class="difflineminus">-      scopeToUse = nsMsgSearchScope.onlineMail;</span>
<a href="#l53.482"></a><span id="l53.482" class="difflineminus">-  </span>
<a href="#l53.483"></a><span id="l53.483" class="difflineminus">-  return scopeToUse;</span>
<a href="#l53.484"></a><span id="l53.484" class="difflineminus">-}</span>
<a href="#l53.485"></a><span id="l53.485" class="difflineminus">-</span>
<a href="#l53.486"></a><span id="l53.486" class="difflineminus">-function createSearchTerms()</span>
<a href="#l53.487"></a><span id="l53.487" class="difflineminus">-{</span>
<a href="#l53.488"></a><span id="l53.488" class="difflineminus">-  var nsMsgSearchScope = Components.interfaces.nsMsgSearchScope;</span>
<a href="#l53.489"></a><span id="l53.489" class="difflineminus">-  var nsMsgSearchAttrib = Components.interfaces.nsMsgSearchAttrib;</span>
<a href="#l53.490"></a><span id="l53.490" class="difflineminus">-  var nsMsgSearchOp = Components.interfaces.nsMsgSearchOp;</span>
<a href="#l53.491"></a><span id="l53.491" class="difflineminus">-</span>
<a href="#l53.492"></a><span id="l53.492" class="difflineminus">-  // create an i supports array to store our search terms </span>
<a href="#l53.493"></a><span id="l53.493" class="difflineminus">-  var searchTermsArray = Components.classes[&quot;@mozilla.org/supports-array;1&quot;].createInstance(Components.interfaces.nsISupportsArray);</span>
<a href="#l53.494"></a><span id="l53.494" class="difflineminus">-  var selectedFolder = GetThreadPaneFolder();</span>
<a href="#l53.495"></a><span id="l53.495" class="difflineminus">-</span>
<a href="#l53.496"></a><span id="l53.496" class="difflineminus">-  // implement | for QS</span>
<a href="#l53.497"></a><span id="l53.497" class="difflineminus">-  // does this break if the user types &quot;foo|bar&quot; expecting to see subjects with that string?</span>
<a href="#l53.498"></a><span id="l53.498" class="difflineminus">-  // I claim no, since &quot;foo|bar&quot; will be a hit for &quot;foo&quot; || &quot;bar&quot;</span>
<a href="#l53.499"></a><span id="l53.499" class="difflineminus">-  // they just might get more false positives</span>
<a href="#l53.500"></a><span id="l53.500" class="difflineminus">-  if (!gSearchInput.showingSearchCriteria) // ignore the text box value if it's just showing the search criteria string</span>
<a href="#l53.501"></a><span id="l53.501" class="difflineminus">-  {</span>
<a href="#l53.502"></a><span id="l53.502" class="difflineminus">-    var termList = gSearchInput.value.split(&quot;|&quot;);</span>
<a href="#l53.503"></a><span id="l53.503" class="difflineminus">-    for (var i = 0; i &lt; termList.length; i ++)</span>
<a href="#l53.504"></a><span id="l53.504" class="difflineminus">-    {</span>
<a href="#l53.505"></a><span id="l53.505" class="difflineminus">-      // if the term is empty, skip it</span>
<a href="#l53.506"></a><span id="l53.506" class="difflineminus">-      if (termList[i] == &quot;&quot;)</span>
<a href="#l53.507"></a><span id="l53.507" class="difflineminus">-        continue;</span>
<a href="#l53.508"></a><span id="l53.508" class="difflineminus">-</span>
<a href="#l53.509"></a><span id="l53.509" class="difflineminus">-      // create, fill, and append the subject term</span>
<a href="#l53.510"></a><span id="l53.510" class="difflineminus">-      var term;</span>
<a href="#l53.511"></a><span id="l53.511" class="difflineminus">-      var value;</span>
<a href="#l53.512"></a><span id="l53.512" class="difflineminus">-</span>
<a href="#l53.513"></a><span id="l53.513" class="difflineminus">-      // if our search criteria is subject or subject|from then add a term for the subject</span>
<a href="#l53.514"></a><span id="l53.514" class="difflineminus">-      if (gSearchInput.searchMode == kQuickSearchSubject ||</span>
<a href="#l53.515"></a><span id="l53.515" class="difflineminus">-          gSearchInput.searchMode == kQuickSearchFromOrSubject ||</span>
<a href="#l53.516"></a><span id="l53.516" class="difflineminus">-          gSearchInput.searchMode == kQuickSearchRecipientOrSubject)</span>
<a href="#l53.517"></a><span id="l53.517" class="difflineminus">-      {</span>
<a href="#l53.518"></a><span id="l53.518" class="difflineminus">-        term = gSearchSession.createTerm();</span>
<a href="#l53.519"></a><span id="l53.519" class="difflineminus">-        value = term.value;</span>
<a href="#l53.520"></a><span id="l53.520" class="difflineminus">-        value.str = termList[i];</span>
<a href="#l53.521"></a><span id="l53.521" class="difflineminus">-        term.value = value;</span>
<a href="#l53.522"></a><span id="l53.522" class="difflineminus">-        term.attrib = nsMsgSearchAttrib.Subject;</span>
<a href="#l53.523"></a><span id="l53.523" class="difflineminus">-        term.op = nsMsgSearchOp.Contains;</span>
<a href="#l53.524"></a><span id="l53.524" class="difflineminus">-        term.booleanAnd = false;</span>
<a href="#l53.525"></a><span id="l53.525" class="difflineminus">-        searchTermsArray.AppendElement(term);</span>
<a href="#l53.526"></a><span id="l53.526" class="difflineminus">-      }</span>
<a href="#l53.527"></a><span id="l53.527" class="difflineminus">-</span>
<a href="#l53.528"></a><span id="l53.528" class="difflineminus">-      if (gSearchInput.searchMode == kQuickSearchBody)</span>
<a href="#l53.529"></a><span id="l53.529" class="difflineminus">-      {</span>
<a href="#l53.530"></a><span id="l53.530" class="difflineminus">-        // what do we do for news and imap users that aren't configured for offline use?</span>
<a href="#l53.531"></a><span id="l53.531" class="difflineminus">-        // in these cases the body search will never return any matches. Should we try to </span>
<a href="#l53.532"></a><span id="l53.532" class="difflineminus">-        // see if body is a valid search scope in this particular case before doing the search?</span>
<a href="#l53.533"></a><span id="l53.533" class="difflineminus">-        // should we switch back to a subject/from search behind the scenes?</span>
<a href="#l53.534"></a><span id="l53.534" class="difflineminus">-        term = gSearchSession.createTerm();</span>
<a href="#l53.535"></a><span id="l53.535" class="difflineminus">-        value = term.value;</span>
<a href="#l53.536"></a><span id="l53.536" class="difflineminus">-        value.str = termList[i];</span>
<a href="#l53.537"></a><span id="l53.537" class="difflineminus">-        term.value = value;</span>
<a href="#l53.538"></a><span id="l53.538" class="difflineminus">-        term.attrib = nsMsgSearchAttrib.Body;</span>
<a href="#l53.539"></a><span id="l53.539" class="difflineminus">-        term.op = nsMsgSearchOp.Contains; </span>
<a href="#l53.540"></a><span id="l53.540" class="difflineminus">-        term.booleanAnd = false;</span>
<a href="#l53.541"></a><span id="l53.541" class="difflineminus">-        searchTermsArray.AppendElement(term);       </span>
<a href="#l53.542"></a><span id="l53.542" class="difflineminus">-      }</span>
<a href="#l53.543"></a><span id="l53.543" class="difflineminus">-</span>
<a href="#l53.544"></a><span id="l53.544" class="difflineminus">-      // create, fill, and append the from (or recipient) term</span>
<a href="#l53.545"></a><span id="l53.545" class="difflineminus">-      if (gSearchInput.searchMode == kQuickSearchFrom || gSearchInput.searchMode == kQuickSearchFromOrSubject)</span>
<a href="#l53.546"></a><span id="l53.546" class="difflineminus">-      {</span>
<a href="#l53.547"></a><span id="l53.547" class="difflineminus">-        term = gSearchSession.createTerm();</span>
<a href="#l53.548"></a><span id="l53.548" class="difflineminus">-        value = term.value;</span>
<a href="#l53.549"></a><span id="l53.549" class="difflineminus">-        value.str = termList[i];</span>
<a href="#l53.550"></a><span id="l53.550" class="difflineminus">-        term.value = value;</span>
<a href="#l53.551"></a><span id="l53.551" class="difflineminus">-        term.attrib = nsMsgSearchAttrib.Sender;</span>
<a href="#l53.552"></a><span id="l53.552" class="difflineminus">-        term.op = nsMsgSearchOp.Contains; </span>
<a href="#l53.553"></a><span id="l53.553" class="difflineminus">-        term.booleanAnd = false;</span>
<a href="#l53.554"></a><span id="l53.554" class="difflineminus">-        searchTermsArray.AppendElement(term);</span>
<a href="#l53.555"></a><span id="l53.555" class="difflineminus">-      }</span>
<a href="#l53.556"></a><span id="l53.556" class="difflineminus">-</span>
<a href="#l53.557"></a><span id="l53.557" class="difflineminus">-      // create, fill, and append the recipient</span>
<a href="#l53.558"></a><span id="l53.558" class="difflineminus">-      if (gSearchInput.searchMode == kQuickSearchRecipient ||</span>
<a href="#l53.559"></a><span id="l53.559" class="difflineminus">-          gSearchInput.searchMode == kQuickSearchRecipientOrSubject)</span>
<a href="#l53.560"></a><span id="l53.560" class="difflineminus">-      {</span>
<a href="#l53.561"></a><span id="l53.561" class="difflineminus">-        term = gSearchSession.createTerm();</span>
<a href="#l53.562"></a><span id="l53.562" class="difflineminus">-        value = term.value;</span>
<a href="#l53.563"></a><span id="l53.563" class="difflineminus">-        value.str = termList[i];</span>
<a href="#l53.564"></a><span id="l53.564" class="difflineminus">-        term.value = value;</span>
<a href="#l53.565"></a><span id="l53.565" class="difflineminus">-        term.attrib = nsMsgSearchAttrib.ToOrCC;</span>
<a href="#l53.566"></a><span id="l53.566" class="difflineminus">-        term.op = nsMsgSearchOp.Contains; </span>
<a href="#l53.567"></a><span id="l53.567" class="difflineminus">-        term.booleanAnd = false;</span>
<a href="#l53.568"></a><span id="l53.568" class="difflineminus">-        searchTermsArray.AppendElement(term);</span>
<a href="#l53.569"></a><span id="l53.569" class="difflineminus">-      }</span>
<a href="#l53.570"></a><span id="l53.570" class="difflineminus">-    }</span>
<a href="#l53.571"></a><span id="l53.571" class="difflineminus">-  }</span>
<a href="#l53.572"></a><span id="l53.572" class="difflineminus">-</span>
<a href="#l53.573"></a><span id="l53.573" class="difflineminus">-  // now append the default view or virtual folder criteria to the quick search   </span>
<a href="#l53.574"></a><span id="l53.574" class="difflineminus">-  // so we don't lose any default view information</span>
<a href="#l53.575"></a><span id="l53.575" class="difflineminus">-  viewDebug(&quot;gDefaultSearchViewTerms = &quot; + gDefaultSearchViewTerms + &quot;gVirtualFolderTerms = &quot; + gVirtualFolderTerms + </span>
<a href="#l53.576"></a><span id="l53.576" class="difflineminus">-    &quot;gXFVirtualFolderTerms = &quot; + gXFVirtualFolderTerms + &quot;\n&quot;);</span>
<a href="#l53.577"></a><span id="l53.577" class="difflineminus">-  var defaultSearchTerms = (gDefaultSearchViewTerms || gVirtualFolderTerms || gXFVirtualFolderTerms);</span>
<a href="#l53.578"></a><span id="l53.578" class="difflineminus">-  if (defaultSearchTerms)</span>
<a href="#l53.579"></a><span id="l53.579" class="difflineminus">-  {</span>
<a href="#l53.580"></a><span id="l53.580" class="difflineminus">-    var isupports = null;</span>
<a href="#l53.581"></a><span id="l53.581" class="difflineminus">-    var searchTerm; </span>
<a href="#l53.582"></a><span id="l53.582" class="difflineminus">-    var termsArray = defaultSearchTerms.QueryInterface(Components.interfaces.nsISupportsArray);</span>
<a href="#l53.583"></a><span id="l53.583" class="difflineminus">-    for (i = 0; i &lt; termsArray.Count(); i++)</span>
<a href="#l53.584"></a><span id="l53.584" class="difflineminus">-    {</span>
<a href="#l53.585"></a><span id="l53.585" class="difflineminus">-      isupports = termsArray.GetElementAt(i);</span>
<a href="#l53.586"></a><span id="l53.586" class="difflineminus">-      searchTerm = isupports.QueryInterface(Components.interfaces.nsIMsgSearchTerm);</span>
<a href="#l53.587"></a><span id="l53.587" class="difflineminus">-      searchTermsArray.AppendElement(searchTerm);</span>
<a href="#l53.588"></a><span id="l53.588" class="difflineminus">-    }</span>
<a href="#l53.589"></a><span id="l53.589" class="difflineminus">-  }</span>
<a href="#l53.590"></a><span id="l53.590" class="difflineminus">-  </span>
<a href="#l53.591"></a><span id="l53.591" class="difflineminus">-  createSearchTermsWithList(searchTermsArray);</span>
<a href="#l53.592"></a><span id="l53.592" class="difflineminus">-  </span>
<a href="#l53.593"></a><span id="l53.593" class="difflineminus">-  // now that we've added the terms, clear out our input array</span>
<a href="#l53.594"></a><span id="l53.594" class="difflineminus">-  searchTermsArray.Clear();</span>
<a href="#l53.595"></a><span id="l53.595" class="difflineminus">-}</span>
<a href="#l53.596"></a><span id="l53.596" class="difflineminus">-</span>
<a href="#l53.597"></a><span id="l53.597" class="difflineminus">-function onSearchStop() </span>
<a href="#l53.598"></a><span id="l53.598" class="difflineminus">-{</span>
<a href="#l53.599"></a><span id="l53.599" class="difflineminus">-  gSearchSession.interruptSearch();</span>
<a href="#l53.600"></a><span id="l53.600" class="difflineminus">-}</span>
<a href="#l53.601"></a><span id="l53.601"> </span>
<a href="#l53.602"></a><span id="l53.602"> function onSearchKeyPress()</span>
<a href="#l53.603"></a><span id="l53.603"> {</span>
<a href="#l53.604"></a><span id="l53.604">   if (gSearchInput.showingSearchCriteria)</span>
<a href="#l53.605"></a><span id="l53.605">     gSearchInput.showingSearchCriteria = false;</span>
<a href="#l53.606"></a><span id="l53.606"> }</span>
<a href="#l53.607"></a><span id="l53.607"> </span>
<a href="#l53.608"></a><span id="l53.608"> function onSearchInputFocus(event)</span>
<a href="#l53.609"></a><span id="l53.609"> {</span>
<a href="#l53.610"></a><span id="l53.610">   GetSearchInput();</span>
<a href="#l53.611"></a><span id="l53.611">   // search bar has focus, ...clear the showing search criteria flag</span>
<a href="#l53.612"></a><span id="l53.612">   if (gSearchInput.showingSearchCriteria)</span>
<a href="#l53.613"></a><span id="l53.613">   {</span>
<a href="#l53.614"></a><span id="l53.614">     gSearchInput.value = &quot;&quot;;</span>
<a href="#l53.615"></a><span id="l53.615">     gSearchInput.showingSearchCriteria = false;</span>
<a href="#l53.616"></a><span id="l53.616">   }</span>
<a href="#l53.617"></a><span id="l53.617" class="difflineminus">-  </span>
<a href="#l53.618"></a><span id="l53.618" class="difflineplus">+</span>
<a href="#l53.619"></a><span id="l53.619">   if (gIgnoreFocus) // got focus via mouse click, don't need to anything else</span>
<a href="#l53.620"></a><span id="l53.620">     gIgnoreFocus = false;</span>
<a href="#l53.621"></a><span id="l53.621">   else</span>
<a href="#l53.622"></a><span id="l53.622">     gSearchInput.select();</span>
<a href="#l53.623"></a><span id="l53.623"> }</span>
<a href="#l53.624"></a><span id="l53.624"> </span>
<a href="#l53.625"></a><span id="l53.625"> function onSearchInputMousedown(event)</span>
<a href="#l53.626"></a><span id="l53.626"> {</span>
<a href="#l53.627"></a><span id="l53.627">   GetSearchInput();</span>
<a href="#l53.628"></a><span id="l53.628" class="difflineminus">-  if (gSearchInput.hasAttribute(&quot;focused&quot;)) </span>
<a href="#l53.629"></a><span id="l53.629" class="difflineplus">+  if (gSearchInput.hasAttribute(&quot;focused&quot;))</span>
<a href="#l53.630"></a><span id="l53.630">     // If the search input is focused already, ignore the click so that</span>
<a href="#l53.631"></a><span id="l53.631">     // onSearchInputBlur does nothing.</span>
<a href="#l53.632"></a><span id="l53.632">     gIgnoreClick = true;</span>
<a href="#l53.633"></a><span id="l53.633" class="difflineminus">-  else </span>
<a href="#l53.634"></a><span id="l53.634" class="difflineplus">+  else</span>
<a href="#l53.635"></a><span id="l53.635">   {</span>
<a href="#l53.636"></a><span id="l53.636">     gIgnoreFocus = true;</span>
<a href="#l53.637"></a><span id="l53.637">     gIgnoreClick = false;</span>
<a href="#l53.638"></a><span id="l53.638">   }</span>
<a href="#l53.639"></a><span id="l53.639"> }</span>
<a href="#l53.640"></a><span id="l53.640"> </span>
<a href="#l53.641"></a><span id="l53.641"> function onSearchInputClick(event)</span>
<a href="#l53.642"></a><span id="l53.642"> {</span>
<a href="#l53.643"></a><span id="l53.643" class="difflineat">@@ -587,67 +195,59 @@ function ClearQSIfNecessary()</span>
<a href="#l53.644"></a><span id="l53.644"> {</span>
<a href="#l53.645"></a><span id="l53.645">   if (!gSearchInput || gSearchInput.showingSearchCriteria)</span>
<a href="#l53.646"></a><span id="l53.646">     return;</span>
<a href="#l53.647"></a><span id="l53.647">   gSearchInput.setSearchCriteriaText();</span>
<a href="#l53.648"></a><span id="l53.648"> }</span>
<a href="#l53.649"></a><span id="l53.649"> </span>
<a href="#l53.650"></a><span id="l53.650"> function Search(str)</span>
<a href="#l53.651"></a><span id="l53.651"> {</span>
<a href="#l53.652"></a><span id="l53.652" class="difflineminus">-  viewDebug(&quot;in Search str = &quot; + str + &quot;gSearchInput.showingSearchCriteria = &quot; + gSearchInput.showingSearchCriteria + &quot;\n&quot;);</span>
<a href="#l53.653"></a><span id="l53.653">   if (gSearchInput.showingSearchCriteria &amp;&amp; str != &quot;&quot;)</span>
<a href="#l53.654"></a><span id="l53.654">     return;</span>
<a href="#l53.655"></a><span id="l53.655"> </span>
<a href="#l53.656"></a><span id="l53.656" class="difflineminus">-  if (str != gSearchInput.value)</span>
<a href="#l53.657"></a><span id="l53.657" class="difflineminus">-  {</span>
<a href="#l53.658"></a><span id="l53.658" class="difflineminus">-    gQSViewIsDirty = true; </span>
<a href="#l53.659"></a><span id="l53.659" class="difflineminus">-    viewDebug(&quot;in Search(), setting gQSViewIsDirty true\n&quot;);</span>
<a href="#l53.660"></a><span id="l53.660" class="difflineminus">-  }</span>
<a href="#l53.661"></a><span id="l53.661" class="difflineminus">-</span>
<a href="#l53.662"></a><span id="l53.662">   gSearchInput.value = str;  //on input does not get fired for some reason</span>
<a href="#l53.663"></a><span id="l53.663">   onEnterInSearchBar();</span>
<a href="#l53.664"></a><span id="l53.664"> }</span>
<a href="#l53.665"></a><span id="l53.665"> </span>
<a href="#l53.666"></a><span id="l53.666"> // helper methods for the quick search drop down menu</span>
<a href="#l53.667"></a><span id="l53.667"> function changeQuickSearchMode(aMenuItem)</span>
<a href="#l53.668"></a><span id="l53.668"> {</span>
<a href="#l53.669"></a><span id="l53.669" class="difflineminus">-  viewDebug(&quot;changing quick search mode\n&quot;);</span>
<a href="#l53.670"></a><span id="l53.670">   // extract the label and set the search input to match it</span>
<a href="#l53.671"></a><span id="l53.671">   var oldSearchMode = gSearchInput.searchMode;</span>
<a href="#l53.672"></a><span id="l53.672">   gSearchInput.searchMode = aMenuItem.value;</span>
<a href="#l53.673"></a><span id="l53.673"> </span>
<a href="#l53.674"></a><span id="l53.674">   if (gSearchInput.value == &quot;&quot; || gSearchInput.showingSearchCriteria)</span>
<a href="#l53.675"></a><span id="l53.675">   {</span>
<a href="#l53.676"></a><span id="l53.676">     gSearchInput.showingSearchCriteria = true;</span>
<a href="#l53.677"></a><span id="l53.677" class="difflineminus">-    if (gSearchInput.value) // </span>
<a href="#l53.678"></a><span id="l53.678" class="difflineplus">+    if (gSearchInput.value) //</span>
<a href="#l53.679"></a><span id="l53.679">       gSearchInput.setSearchCriteriaText();</span>
<a href="#l53.680"></a><span id="l53.680">   }</span>
<a href="#l53.681"></a><span id="l53.681" class="difflineminus">-  </span>
<a href="#l53.682"></a><span id="l53.682" class="difflineplus">+</span>
<a href="#l53.683"></a><span id="l53.683">   // if the search box is empty, set showing search criteria to true so it shows up when focus moves out of the box</span>
<a href="#l53.684"></a><span id="l53.684" class="difflineminus">-  if (!gSearchInput.value)   </span>
<a href="#l53.685"></a><span id="l53.685" class="difflineplus">+  if (!gSearchInput.value)</span>
<a href="#l53.686"></a><span id="l53.686">     gSearchInput.showingSearchCriteria = true;</span>
<a href="#l53.687"></a><span id="l53.687">   else if (gSearchInput.showingSearchCriteria) // if we are showing criteria text and the box isn't empty, change the criteria text</span>
<a href="#l53.688"></a><span id="l53.688" class="difflineminus">-    gSearchInput.setSearchCriteriaText();     </span>
<a href="#l53.689"></a><span id="l53.689" class="difflineplus">+    gSearchInput.setSearchCriteriaText();</span>
<a href="#l53.690"></a><span id="l53.690">   else if (oldSearchMode != gSearchInput.searchMode) // the search mode just changed so we need to redo the quick search</span>
<a href="#l53.691"></a><span id="l53.691">     onEnterInSearchBar();</span>
<a href="#l53.692"></a><span id="l53.692"> }</span>
<a href="#l53.693"></a><span id="l53.693"> </span>
<a href="#l53.694"></a><span id="l53.694"> function saveViewAsVirtualFolder()</span>
<a href="#l53.695"></a><span id="l53.695"> {</span>
<a href="#l53.696"></a><span id="l53.696">   gFolderTreeController.newVirtualFolder(gSearchInput.value,</span>
<a href="#l53.697"></a><span id="l53.697">                                          gSearchSession.searchTerms);</span>
<a href="#l53.698"></a><span id="l53.698"> }</span>
<a href="#l53.699"></a><span id="l53.699"> </span>
<a href="#l53.700"></a><span id="l53.700"> function InitQuickSearchPopup()</span>
<a href="#l53.701"></a><span id="l53.701"> {</span>
<a href="#l53.702"></a><span id="l53.702">   // disable the create virtual folder menu item if the current radio</span>
<a href="#l53.703"></a><span id="l53.703">   // value is set to Find in message since you can't really  create a VF from find</span>
<a href="#l53.704"></a><span id="l53.704">   // in message</span>
<a href="#l53.705"></a><span id="l53.705" class="difflineminus">-  </span>
<a href="#l53.706"></a><span id="l53.706" class="difflineminus">-  GetSearchInput();  </span>
<a href="#l53.707"></a><span id="l53.707" class="difflineplus">+</span>
<a href="#l53.708"></a><span id="l53.708" class="difflineplus">+  GetSearchInput();</span>
<a href="#l53.709"></a><span id="l53.709">   if (!gSearchInput ||gSearchInput.value == &quot;&quot; || gSearchInput.showingSearchCriteria)</span>
<a href="#l53.710"></a><span id="l53.710">     document.getElementById('quickSearchSaveAsVirtualFolder').setAttribute('disabled', 'true');</span>
<a href="#l53.711"></a><span id="l53.711">   else</span>
<a href="#l53.712"></a><span id="l53.712">     document.getElementById('quickSearchSaveAsVirtualFolder').removeAttribute('disabled');</span>
<a href="#l53.713"></a><span id="l53.713"> }</span>
<a href="#l53.714"></a><span id="l53.714"> </span>
<a href="#l53.715"></a><span id="l53.715"> /**</span>
<a href="#l53.716"></a><span id="l53.716">  * If switching from an &quot;incoming&quot; (Inbox, etc.) type of mail folder,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l54.1"></a><span id="l54.1" class="difflineminus">--- a/mail/base/content/selectionsummaries.js</span>
<a href="#l54.2"></a><span id="l54.2" class="difflineplus">+++ b/mail/base/content/selectionsummaries.js</span>
<a href="#l54.3"></a><span id="l54.3" class="difflineat">@@ -64,37 +64,16 @@ function loadSelectionSummaryStrings() {</span>
<a href="#l54.4"></a><span id="l54.4">   strBundleService = strBundleService.QueryInterface(Components.interfaces.nsIStringBundleService);</span>
<a href="#l54.5"></a><span id="l54.5">     for (let [name, value] in Iterator(gSelectionSummaryStrings))</span>
<a href="#l54.6"></a><span id="l54.6">       gSelectionSummaryStrings[name] = typeof value == &quot;string&quot; ?</span>
<a href="#l54.7"></a><span id="l54.7">         getStr(value) : value.map(gSelectionSummaryStrings);</span>
<a href="#l54.8"></a><span id="l54.8"> }</span>
<a href="#l54.9"></a><span id="l54.9"> </span>
<a href="#l54.10"></a><span id="l54.10"> loadSelectionSummaryStrings();</span>
<a href="#l54.11"></a><span id="l54.11"> </span>
<a href="#l54.12"></a><span id="l54.12" class="difflineminus">-/**</span>
<a href="#l54.13"></a><span id="l54.13" class="difflineminus">- * pickMessagePane is the toggle to figure out whether to use the standard</span>
<a href="#l54.14"></a><span id="l54.14" class="difflineminus">- * message pane used to display message bodies (&amp; headers), or whether to</span>
<a href="#l54.15"></a><span id="l54.15" class="difflineminus">- * display an HTML iframe used for the multiple message summaries.</span>
<a href="#l54.16"></a><span id="l54.16" class="difflineminus">- *</span>
<a href="#l54.17"></a><span id="l54.17" class="difflineminus">- * @param visiblePaneId</span>
<a href="#l54.18"></a><span id="l54.18" class="difflineminus">- *        the ID of the pane that we want to make be the visible one.</span>
<a href="#l54.19"></a><span id="l54.19" class="difflineminus">- * @return the DOM element corresponding to the selected pane.</span>
<a href="#l54.20"></a><span id="l54.20" class="difflineminus">- *</span>
<a href="#l54.21"></a><span id="l54.21" class="difflineminus">- */</span>
<a href="#l54.22"></a><span id="l54.22" class="difflineminus">-function pickMessagePane(visiblePaneId) {</span>
<a href="#l54.23"></a><span id="l54.23" class="difflineminus">-  var paneIds = ['singlemessage', 'multimessage'];</span>
<a href="#l54.24"></a><span id="l54.24" class="difflineminus">-  // when we want to do folder and account summaries, we just need to add</span>
<a href="#l54.25"></a><span id="l54.25" class="difflineminus">-  // XUL elements for them, and add them to this list.</span>
<a href="#l54.26"></a><span id="l54.26" class="difflineminus">-  //               'foldersummary', 'accountsummary'];</span>
<a href="#l54.27"></a><span id="l54.27" class="difflineminus">-  for (let [,paneId] in Iterator(paneIds))</span>
<a href="#l54.28"></a><span id="l54.28" class="difflineminus">-    document.getElementById(paneId).hidden = paneId != visiblePaneId;</span>
<a href="#l54.29"></a><span id="l54.29" class="difflineminus">-</span>
<a href="#l54.30"></a><span id="l54.30" class="difflineminus">-  return document.getElementById(visiblePaneId);</span>
<a href="#l54.31"></a><span id="l54.31" class="difflineminus">-}</span>
<a href="#l54.32"></a><span id="l54.32" class="difflineminus">-</span>
<a href="#l54.33"></a><span id="l54.33"> // Ah, wouldn't it be nice if there was platform code to do the following...</span>
<a href="#l54.34"></a><span id="l54.34"> </span>
<a href="#l54.35"></a><span id="l54.35"> /**</span>
<a href="#l54.36"></a><span id="l54.36">  * the equivalent of jQuery's addClass.  Avoids duplicates, nothing fancy.</span>
<a href="#l54.37"></a><span id="l54.37">  *</span>
<a href="#l54.38"></a><span id="l54.38">  * @param node</span>
<a href="#l54.39"></a><span id="l54.39">  *        any old DOM node</span>
<a href="#l54.40"></a><span id="l54.40">  * @param classname</span>
<a href="#l54.41"></a><span id="l54.41" class="difflineat">@@ -143,33 +122,30 @@ function _mm_removeClass(node, classname</span>
<a href="#l54.42"></a><span id="l54.42">  * It uses the same multimessage iframe as ThreadSummary, so both it</span>
<a href="#l54.43"></a><span id="l54.43">  * and ThreadSummary should be careful to clean up the other's work</span>
<a href="#l54.44"></a><span id="l54.44">  * before inserting their DOM nodes into the frame.</span>
<a href="#l54.45"></a><span id="l54.45">  *</span>
<a href="#l54.46"></a><span id="l54.46">  * There's a two phase process: build the framework based on what's available</span>
<a href="#l54.47"></a><span id="l54.47">  * from the msgHdr itself, and then spawn an aysnc Gloda query which will</span>
<a href="#l54.48"></a><span id="l54.48">  * fetch the snippets, tags, etc.</span>
<a href="#l54.49"></a><span id="l54.49">  *</span>
<a href="#l54.50"></a><span id="l54.50" class="difflineminus">- * @param msgURIs</span>
<a href="#l54.51"></a><span id="l54.51" class="difflineminus">- *        array of message URIs</span>
<a href="#l54.52"></a><span id="l54.52" class="difflineplus">+ * @param aMessages</span>
<a href="#l54.53"></a><span id="l54.53" class="difflineplus">+ *        Array of message headers.</span>
<a href="#l54.54"></a><span id="l54.54">  */</span>
<a href="#l54.55"></a><span id="l54.55"> </span>
<a href="#l54.56"></a><span id="l54.56" class="difflineminus">-function MultiMessageSummary(msgURIs) {</span>
<a href="#l54.57"></a><span id="l54.57" class="difflineminus">-  this._msgURIs = msgURIs;</span>
<a href="#l54.58"></a><span id="l54.58" class="difflineplus">+function MultiMessageSummary(aMessages) {</span>
<a href="#l54.59"></a><span id="l54.59" class="difflineplus">+  this._msgHdrs = aMessages;</span>
<a href="#l54.60"></a><span id="l54.60"> }</span>
<a href="#l54.61"></a><span id="l54.61"> </span>
<a href="#l54.62"></a><span id="l54.62"> MultiMessageSummary.prototype = {</span>
<a href="#l54.63"></a><span id="l54.63">   init: function() {</span>
<a href="#l54.64"></a><span id="l54.64">     this._msgTagService = Components.classes[&quot;@mozilla.org/messenger/tagservice;1&quot;].</span>
<a href="#l54.65"></a><span id="l54.65">                           getService(Components.interfaces.nsIMsgTagService);</span>
<a href="#l54.66"></a><span id="l54.66" class="difflineminus">-    this._msgHdrs = new Array();</span>
<a href="#l54.67"></a><span id="l54.67">     this._glodaQueries = [];</span>
<a href="#l54.68"></a><span id="l54.68">     this._msgNodes = {};</span>
<a href="#l54.69"></a><span id="l54.69" class="difflineminus">-    for (var i = 0; i &lt; this._msgURIs.length; ++i)</span>
<a href="#l54.70"></a><span id="l54.70" class="difflineminus">-      this._msgHdrs.push(messenger.msgHdrFromURI(this._msgURIs[i]));</span>
<a href="#l54.71"></a><span id="l54.71"> </span>
<a href="#l54.72"></a><span id="l54.72">     this.summarize();</span>
<a href="#l54.73"></a><span id="l54.73">   },</span>
<a href="#l54.74"></a><span id="l54.74"> </span>
<a href="#l54.75"></a><span id="l54.75">   /**</span>
<a href="#l54.76"></a><span id="l54.76">    * Given a msgHdr, return a list of tag objects. This function</span>
<a href="#l54.77"></a><span id="l54.77">    * just does the messy work of understanding how tags are</span>
<a href="#l54.78"></a><span id="l54.78">    * stored in nsIMsgDBHdrs.  It would be a good candidate for</span>
<a href="#l54.79"></a><span id="l54.79" class="difflineat">@@ -212,17 +188,17 @@ MultiMessageSummary.prototype = {</span>
<a href="#l54.80"></a><span id="l54.80">       senderName = senderName.slice(1, -1);</span>
<a href="#l54.81"></a><span id="l54.81">     return senderName;</span>
<a href="#l54.82"></a><span id="l54.82">   },</span>
<a href="#l54.83"></a><span id="l54.83"> </span>
<a href="#l54.84"></a><span id="l54.84">   /**</span>
<a href="#l54.85"></a><span id="l54.85">    * Fill in the summary pane describing the selected messages</span>
<a href="#l54.86"></a><span id="l54.86">    **/</span>
<a href="#l54.87"></a><span id="l54.87">   summarize: function() {</span>
<a href="#l54.88"></a><span id="l54.88" class="difflineminus">-    let htmlpane = pickMessagePane('multimessage');</span>
<a href="#l54.89"></a><span id="l54.89" class="difflineplus">+    let htmlpane = document.getElementById('multimessage');</span>
<a href="#l54.90"></a><span id="l54.90">     // First, we group the messages in threads.</span>
<a href="#l54.91"></a><span id="l54.91">     // count threads</span>
<a href="#l54.92"></a><span id="l54.92">     let threads = {};</span>
<a href="#l54.93"></a><span id="l54.93">     let numThreads = 0;</span>
<a href="#l54.94"></a><span id="l54.94">     let headerParser = Components.classes[&quot;@mozilla.org/messenger/headerparser;1&quot;].</span>
<a href="#l54.95"></a><span id="l54.95">                          getService(Components.interfaces.nsIMsgHeaderParser);</span>
<a href="#l54.96"></a><span id="l54.96">     for (let [,msgHdr] in Iterator(this._msgHdrs))</span>
<a href="#l54.97"></a><span id="l54.97">     {</span>
<a href="#l54.98"></a><span id="l54.98" class="difflineat">@@ -235,18 +211,19 @@ MultiMessageSummary.prototype = {</span>
<a href="#l54.99"></a><span id="l54.99">       }</span>
<a href="#l54.100"></a><span id="l54.100">     }</span>
<a href="#l54.101"></a><span id="l54.101"> </span>
<a href="#l54.102"></a><span id="l54.102">     // set the heading based on the number of messages &amp; threads</span>
<a href="#l54.103"></a><span id="l54.103">     let heading = htmlpane.contentDocument.getElementById('heading');</span>
<a href="#l54.104"></a><span id="l54.104">     _mm_addClass(heading, &quot;heading&quot;);</span>
<a href="#l54.105"></a><span id="l54.105">     _mm_addClass(heading, &quot;info&quot;);</span>
<a href="#l54.106"></a><span id="l54.106"> </span>
<a href="#l54.107"></a><span id="l54.107" class="difflineminus">-    let numMessages = this._msgURIs.length;</span>
<a href="#l54.108"></a><span id="l54.108" class="difflineminus">-    let messagesTitle = PluralForm.get(numMessages, gSelectionSummaryStrings[&quot;NConversations&quot;]).replace('#1', numThreads);</span>
<a href="#l54.109"></a><span id="l54.109" class="difflineplus">+    let messagesTitle =</span>
<a href="#l54.110"></a><span id="l54.110" class="difflineplus">+      PluralForm.get(numThreads, gSelectionSummaryStrings[&quot;NConversations&quot;])</span>
<a href="#l54.111"></a><span id="l54.111" class="difflineplus">+                .replace(&quot;#1&quot;, numThreads);</span>
<a href="#l54.112"></a><span id="l54.112"> </span>
<a href="#l54.113"></a><span id="l54.113">     heading.innerHTML = messagesTitle;</span>
<a href="#l54.114"></a><span id="l54.114"> </span>
<a href="#l54.115"></a><span id="l54.115">     // clear the messages list</span>
<a href="#l54.116"></a><span id="l54.116">     let messagesElt = htmlpane.contentDocument.getElementById('messagelist');</span>
<a href="#l54.117"></a><span id="l54.117">     while (messagesElt.firstChild)</span>
<a href="#l54.118"></a><span id="l54.118">       messagesElt.removeChild(messagesElt.firstChild);</span>
<a href="#l54.119"></a><span id="l54.119"> </span>
<a href="#l54.120"></a><span id="l54.120" class="difflineat">@@ -259,17 +236,17 @@ MultiMessageSummary.prototype = {</span>
<a href="#l54.121"></a><span id="l54.121">       count += 1;</span>
<a href="#l54.122"></a><span id="l54.122">       if (count &gt; MAXCOUNT) {</span>
<a href="#l54.123"></a><span id="l54.123">         maxCountExceeded = true;</span>
<a href="#l54.124"></a><span id="l54.124">         break;</span>
<a href="#l54.125"></a><span id="l54.125">       }</span>
<a href="#l54.126"></a><span id="l54.126">       let countUnread = 0;</span>
<a href="#l54.127"></a><span id="l54.127">       let countStarred = 0;</span>
<a href="#l54.128"></a><span id="l54.128">       let header, countNode;</span>
<a href="#l54.129"></a><span id="l54.129" class="difflineminus">-      </span>
<a href="#l54.130"></a><span id="l54.130" class="difflineplus">+</span>
<a href="#l54.131"></a><span id="l54.131">       // we'll mark the thread unread if any messages in it are unread</span>
<a href="#l54.132"></a><span id="l54.132">       for (let [, msgHdr] in Iterator(msgs)) {</span>
<a href="#l54.133"></a><span id="l54.133">         if (! msgHdr.isRead)</span>
<a href="#l54.134"></a><span id="l54.134">           countUnread += 1;</span>
<a href="#l54.135"></a><span id="l54.135">         if (msgHdr.isFlagged)</span>
<a href="#l54.136"></a><span id="l54.136">           countStarred += 1;</span>
<a href="#l54.137"></a><span id="l54.137">       }</span>
<a href="#l54.138"></a><span id="l54.138"> </span>
<a href="#l54.139"></a><span id="l54.139" class="difflineat">@@ -324,30 +301,30 @@ MultiMessageSummary.prototype = {</span>
<a href="#l54.140"></a><span id="l54.140">         if (meta.author)</span>
<a href="#l54.141"></a><span id="l54.141">           authorNode.innerHTML = escapeXMLchars(meta.author);</span>
<a href="#l54.142"></a><span id="l54.142">       });</span>
<a href="#l54.143"></a><span id="l54.143"> </span>
<a href="#l54.144"></a><span id="l54.144">       // get the subject node.</span>
<a href="#l54.145"></a><span id="l54.145">       let subjectNode = msgNode.getElementsByClassName(&quot;subject&quot;)[0];</span>
<a href="#l54.146"></a><span id="l54.146">       subjectNode.msgs = msgs;</span>
<a href="#l54.147"></a><span id="l54.147">       subjectNode.addEventListener(&quot;click&quot;, function() {</span>
<a href="#l54.148"></a><span id="l54.148" class="difflineminus">-        selectMultipleMessagesByMsgHdr(this.msgs);</span>
<a href="#l54.149"></a><span id="l54.149" class="difflineplus">+        gFolderDisplay.selectMessages(this.msgs);</span>
<a href="#l54.150"></a><span id="l54.150">       }, true);</span>
<a href="#l54.151"></a><span id="l54.151"> </span>
<a href="#l54.152"></a><span id="l54.152">       let tagsNode = msgNode.getElementsByClassName(&quot;tags&quot;)[0];</span>
<a href="#l54.153"></a><span id="l54.153">       while (tagsNode.firstChild)</span>
<a href="#l54.154"></a><span id="l54.154">         tagsNode.removeChild(tagsNode.firstChild);</span>
<a href="#l54.155"></a><span id="l54.155">       this._addTagNodes(msgs, tagsNode);</span>
<a href="#l54.156"></a><span id="l54.156">       for each (msgHdr in msgs) {</span>
<a href="#l54.157"></a><span id="l54.157">         this._msgNodes[msgHdr.messageKey + msgHdr.folder.URI] = msgNode;</span>
<a href="#l54.158"></a><span id="l54.158">       }</span>
<a href="#l54.159"></a><span id="l54.159">       messagesElt.appendChild(msgNode);</span>
<a href="#l54.160"></a><span id="l54.160">     }</span>
<a href="#l54.161"></a><span id="l54.161">     this.computeSize(htmlpane);</span>
<a href="#l54.162"></a><span id="l54.162" class="difflineminus">-    this.notifyMaxCountExceeded(numMessages, MAXCOUNT);</span>
<a href="#l54.163"></a><span id="l54.163" class="difflineplus">+    this.notifyMaxCountExceeded(this._msgHdrs.length, MAXCOUNT);</span>
<a href="#l54.164"></a><span id="l54.164"> </span>
<a href="#l54.165"></a><span id="l54.165">     this._glodaQueries.push(Gloda.getMessageCollectionForHeaders(this._msgHdrs, this));</span>
<a href="#l54.166"></a><span id="l54.166">   },</span>
<a href="#l54.167"></a><span id="l54.167"> </span>
<a href="#l54.168"></a><span id="l54.168">   /**</span>
<a href="#l54.169"></a><span id="l54.169">    * clear out the tagsnode, and fill in appropriately for the union of</span>
<a href="#l54.170"></a><span id="l54.170">    * tags in the specified messags</span>
<a href="#l54.171"></a><span id="l54.171">    */</span>
<a href="#l54.172"></a><span id="l54.172" class="difflineat">@@ -388,17 +365,17 @@ MultiMessageSummary.prototype = {</span>
<a href="#l54.173"></a><span id="l54.173">     sizeText = replaceInsert(sizeText, 2, unit);</span>
<a href="#l54.174"></a><span id="l54.174">     htmlpane.contentDocument.getElementById('size').innerHTML = sizeText;</span>
<a href="#l54.175"></a><span id="l54.175">   },</span>
<a href="#l54.176"></a><span id="l54.176"> </span>
<a href="#l54.177"></a><span id="l54.177">   /** compute the size of the messages in the selection and display it</span>
<a href="#l54.178"></a><span id="l54.178">    * in the element of id &quot;size&quot;</span>
<a href="#l54.179"></a><span id="l54.179">   **/</span>
<a href="#l54.180"></a><span id="l54.180">   notifyMaxCountExceeded: function(numMessages, maxCount) {</span>
<a href="#l54.181"></a><span id="l54.181" class="difflineminus">-    let htmlpane = pickMessagePane('multimessage');</span>
<a href="#l54.182"></a><span id="l54.182" class="difflineplus">+    let htmlpane = document.getElementById('multimessage');</span>
<a href="#l54.183"></a><span id="l54.183">     let notice = htmlpane.contentDocument.getElementById('notice');</span>
<a href="#l54.184"></a><span id="l54.184">     if (numMessages &gt; maxCount)</span>
<a href="#l54.185"></a><span id="l54.185">     {</span>
<a href="#l54.186"></a><span id="l54.186">       let noticeText = gSelectionSummaryStrings.noticeText;</span>
<a href="#l54.187"></a><span id="l54.187">       noticeText = replaceInsert(noticeText, 1, numMessages);</span>
<a href="#l54.188"></a><span id="l54.188">       noticeText = replaceInsert(noticeText, 2, maxCount);</span>
<a href="#l54.189"></a><span id="l54.189">       notice.innerHTML = noticeText;</span>
<a href="#l54.190"></a><span id="l54.190">       _mm_removeClass(notice, 'hidden');</span>
<a href="#l54.191"></a><span id="l54.191" class="difflineat">@@ -436,24 +413,24 @@ MultiMessageSummary.prototype = {</span>
<a href="#l54.192"></a><span id="l54.192">       // thread (and hence DOM node), so we need to detect when we get the first</span>
<a href="#l54.193"></a><span id="l54.193">       // item for a particular DOM node, stash the preexisting status of that DOM</span>
<a href="#l54.194"></a><span id="l54.194">       // node, an only do transitions if the items warrant it.</span>
<a href="#l54.195"></a><span id="l54.195">       let headerNode = this._msgNodes[domkey];</span>
<a href="#l54.196"></a><span id="l54.196">       if (! headerNode.flags) {</span>
<a href="#l54.197"></a><span id="l54.197">         headerNode.flags = {};</span>
<a href="#l54.198"></a><span id="l54.198">         knownMessageNodes.push(headerNode);</span>
<a href="#l54.199"></a><span id="l54.199">       }</span>
<a href="#l54.200"></a><span id="l54.200" class="difflineminus">-      </span>
<a href="#l54.201"></a><span id="l54.201" class="difflineplus">+</span>
<a href="#l54.202"></a><span id="l54.202">       if (! glodaMsg.read)</span>
<a href="#l54.203"></a><span id="l54.203">         headerNode.flags['unread'] = true;</span>
<a href="#l54.204"></a><span id="l54.204">       if (glodaMsg.starred)</span>
<a href="#l54.205"></a><span id="l54.205">         headerNode.flags['starred'] = true;</span>
<a href="#l54.206"></a><span id="l54.206"> </span>
<a href="#l54.207"></a><span id="l54.207">       // for tags, there's a minor problem in that if _some_ of the items in a</span>
<a href="#l54.208"></a><span id="l54.208" class="difflineminus">-      // thread got modified </span>
<a href="#l54.209"></a><span id="l54.209" class="difflineplus">+      // thread got modified</span>
<a href="#l54.210"></a><span id="l54.210">       let key = messageKey + glodaMsg.folder.uri;</span>
<a href="#l54.211"></a><span id="l54.211">       let tagsNode = headerNode.getElementsByClassName('tags')[0];</span>
<a href="#l54.212"></a><span id="l54.212">       while (tagsNode.firstChild)</span>
<a href="#l54.213"></a><span id="l54.213">         tagsNode.removeChild(tagsNode.firstChild);</span>
<a href="#l54.214"></a><span id="l54.214">       this._addTagNodes([msg.folderMessage for each ([i,msg] in Iterator(aItems))],</span>
<a href="#l54.215"></a><span id="l54.215">                         tagsNode);</span>
<a href="#l54.216"></a><span id="l54.216">     }</span>
<a href="#l54.217"></a><span id="l54.217"> </span>
<a href="#l54.218"></a><span id="l54.218" class="difflineat">@@ -468,17 +445,17 @@ MultiMessageSummary.prototype = {</span>
<a href="#l54.219"></a><span id="l54.219">         _mm_removeClass(headerNode, &quot;starred&quot;);</span>
<a href="#l54.220"></a><span id="l54.220">       headerNode.flags = null;</span>
<a href="#l54.221"></a><span id="l54.221">     }</span>
<a href="#l54.222"></a><span id="l54.222">   },</span>
<a href="#l54.223"></a><span id="l54.223"> </span>
<a href="#l54.224"></a><span id="l54.224">   onQueryCompleted: function(aCollection) {</span>
<a href="#l54.225"></a><span id="l54.225">     /* if we need something that's just available from GlodaMessages,</span>
<a href="#l54.226"></a><span id="l54.226">       this is where we'll get it initially */</span>
<a href="#l54.227"></a><span id="l54.227" class="difflineminus">-    return; </span>
<a href="#l54.228"></a><span id="l54.228" class="difflineplus">+    return;</span>
<a href="#l54.229"></a><span id="l54.229">   }</span>
<a href="#l54.230"></a><span id="l54.230"> }</span>
<a href="#l54.231"></a><span id="l54.231"> </span>
<a href="#l54.232"></a><span id="l54.232"> </span>
<a href="#l54.233"></a><span id="l54.233"> /**</span>
<a href="#l54.234"></a><span id="l54.234">  * the ThreadSummary class is responsible for populating the message pane</span>
<a href="#l54.235"></a><span id="l54.235">  * with a reasonable summary of a set of messages that are are in a single</span>
<a href="#l54.236"></a><span id="l54.236">  * thread.</span>
<a href="#l54.237"></a><span id="l54.237" class="difflineat">@@ -486,60 +463,58 @@ MultiMessageSummary.prototype = {</span>
<a href="#l54.238"></a><span id="l54.238">  * It uses the same multimessage iframe as MultiMessageSummary, so both it</span>
<a href="#l54.239"></a><span id="l54.239">  * and MultiMessageSummary should be careful to clean up the other's work</span>
<a href="#l54.240"></a><span id="l54.240">  * before inserting their DOM nodes into the frame.</span>
<a href="#l54.241"></a><span id="l54.241">  *</span>
<a href="#l54.242"></a><span id="l54.242">  * There's a two phase process: build the framework based on what's available</span>
<a href="#l54.243"></a><span id="l54.243">  * from the msgHdr itself, and then spawn an aysnc Gloda query which will</span>
<a href="#l54.244"></a><span id="l54.244">  * fetch the snippets, tags, etc.</span>
<a href="#l54.245"></a><span id="l54.245">  *</span>
<a href="#l54.246"></a><span id="l54.246" class="difflineminus">- * @param msgURIs</span>
<a href="#l54.247"></a><span id="l54.247" class="difflineminus">- *        array of message URIs</span>
<a href="#l54.248"></a><span id="l54.248" class="difflineplus">+ * @param messages</span>
<a href="#l54.249"></a><span id="l54.249" class="difflineplus">+ *        array of message headers</span>
<a href="#l54.250"></a><span id="l54.250">  */</span>
<a href="#l54.251"></a><span id="l54.251"> </span>
<a href="#l54.252"></a><span id="l54.252" class="difflineminus">-function ThreadSummary(msgURIs)</span>
<a href="#l54.253"></a><span id="l54.253" class="difflineplus">+function ThreadSummary(messages)</span>
<a href="#l54.254"></a><span id="l54.254"> {</span>
<a href="#l54.255"></a><span id="l54.255" class="difflineminus">-  this._msgURIs = msgURIs;</span>
<a href="#l54.256"></a><span id="l54.256" class="difflineplus">+  this._msgHdrs = messages;</span>
<a href="#l54.257"></a><span id="l54.257"> }</span>
<a href="#l54.258"></a><span id="l54.258"> </span>
<a href="#l54.259"></a><span id="l54.259"> ThreadSummary.prototype = {</span>
<a href="#l54.260"></a><span id="l54.260">   __proto__: MultiMessageSummary.prototype,</span>
<a href="#l54.261"></a><span id="l54.261"> </span>
<a href="#l54.262"></a><span id="l54.262">   summarize: function() {</span>
<a href="#l54.263"></a><span id="l54.263">     this._msgNodes = {};</span>
<a href="#l54.264"></a><span id="l54.264"> </span>
<a href="#l54.265"></a><span id="l54.265" class="difflineminus">-    let htmlpane = pickMessagePane('multimessage');</span>
<a href="#l54.266"></a><span id="l54.266" class="difflineplus">+    let htmlpane = document.getElementById('multimessage');</span>
<a href="#l54.267"></a><span id="l54.267"> </span>
<a href="#l54.268"></a><span id="l54.268" class="difflineminus">-    let firstMsgHdr = messenger.msgHdrFromURI(this._msgURIs[0]);</span>
<a href="#l54.269"></a><span id="l54.269" class="difflineminus">-    let numMessages = this._msgURIs.length;</span>
<a href="#l54.270"></a><span id="l54.270" class="difflineplus">+    let firstMsgHdr = this._msgHdrs[0];</span>
<a href="#l54.271"></a><span id="l54.271" class="difflineplus">+    let numMessages = this._msgHdrs.length;</span>
<a href="#l54.272"></a><span id="l54.272">     let subject = (firstMsgHdr.mime2DecodedSubject || gSelectionSummaryStrings[&quot;noSubject&quot;])</span>
<a href="#l54.273"></a><span id="l54.273">        + &quot; &quot;</span>
<a href="#l54.274"></a><span id="l54.274">        + PluralForm.get(numMessages, gSelectionSummaryStrings[&quot;Nmessages&quot;]).replace('#1', numMessages);</span>
<a href="#l54.275"></a><span id="l54.275">     let heading = htmlpane.contentDocument.getElementById('heading');</span>
<a href="#l54.276"></a><span id="l54.276">     heading.setAttribute(&quot;class&quot;, &quot;heading&quot;);</span>
<a href="#l54.277"></a><span id="l54.277">     heading.innerHTML = escapeXMLchars(subject);</span>
<a href="#l54.278"></a><span id="l54.278"> </span>
<a href="#l54.279"></a><span id="l54.279">     let messagesElt = htmlpane.contentDocument.getElementById('messagelist');</span>
<a href="#l54.280"></a><span id="l54.280">     while (messagesElt.firstChild)</span>
<a href="#l54.281"></a><span id="l54.281">       messagesElt.removeChild(messagesElt.firstChild);</span>
<a href="#l54.282"></a><span id="l54.282"> </span>
<a href="#l54.283"></a><span id="l54.283">     let headerParser = Components.classes[&quot;@mozilla.org/messenger/headerparser;1&quot;]</span>
<a href="#l54.284"></a><span id="l54.284">                                     .getService(Components.interfaces.nsIMsgHeaderParser);</span>
<a href="#l54.285"></a><span id="l54.285" class="difflineminus">-    let msgHdrs = new Array();</span>
<a href="#l54.286"></a><span id="l54.286">     let count = 0;</span>
<a href="#l54.287"></a><span id="l54.287">     const MAXCOUNT = 100;</span>
<a href="#l54.288"></a><span id="l54.288">     let maxCountExceeded = false;</span>
<a href="#l54.289"></a><span id="l54.289" class="difflineminus">-    for (let i = 0; i &lt; this._msgURIs.length; ++i) {</span>
<a href="#l54.290"></a><span id="l54.290" class="difflineplus">+    for (let i = 0; i &lt; numMessages; ++i) {</span>
<a href="#l54.291"></a><span id="l54.291">       count += 1;</span>
<a href="#l54.292"></a><span id="l54.292">       if (count &gt; MAXCOUNT) {</span>
<a href="#l54.293"></a><span id="l54.293">         maxCountExceeded = true;</span>
<a href="#l54.294"></a><span id="l54.294">         break;</span>
<a href="#l54.295"></a><span id="l54.295">       }</span>
<a href="#l54.296"></a><span id="l54.296" class="difflineminus">-      let msgHdr = messenger.msgHdrFromURI(this._msgURIs[i]);</span>
<a href="#l54.297"></a><span id="l54.297" class="difflineminus">-      msgHdrs.push(msgHdr);</span>
<a href="#l54.298"></a><span id="l54.298" class="difflineplus">+      let msgHdr = this._msgHdrs[i];</span>
<a href="#l54.299"></a><span id="l54.299"> </span>
<a href="#l54.300"></a><span id="l54.300">       let msg_classes = &quot;message &quot;;</span>
<a href="#l54.301"></a><span id="l54.301">       if (! msgHdr.isRead)</span>
<a href="#l54.302"></a><span id="l54.302">         msg_classes += &quot; unread&quot;;</span>
<a href="#l54.303"></a><span id="l54.303">       if (msgHdr.isFlagged)</span>
<a href="#l54.304"></a><span id="l54.304">         msg_classes += &quot; starred&quot;;</span>
<a href="#l54.305"></a><span id="l54.305"> </span>
<a href="#l54.306"></a><span id="l54.306">       let senderName = headerParser.extractHeaderAddressName(msgHdr.mime2DecodedAuthor);</span>
<a href="#l54.307"></a><span id="l54.307" class="difflineat">@@ -580,17 +555,17 @@ ThreadSummary.prototype = {</span>
<a href="#l54.308"></a><span id="l54.308">       for each (let [,tag] in Iterator(tags)) {</span>
<a href="#l54.309"></a><span id="l54.309">         let tagNode = tagsNode.ownerDocument.createElement('span');</span>
<a href="#l54.310"></a><span id="l54.310">         // see tagColors.css</span>
<a href="#l54.311"></a><span id="l54.311">         let colorClass = &quot;blc-&quot; + this._msgTagService.getColorForKey(tag.key).substr(1);</span>
<a href="#l54.312"></a><span id="l54.312">         _mm_addClass(tagNode, &quot;tag &quot; + tag.tag + &quot; &quot; + colorClass);</span>
<a href="#l54.313"></a><span id="l54.313">         tagNode.innerHTML = tag.tag;</span>
<a href="#l54.314"></a><span id="l54.314">         tagsNode.appendChild(tagNode);</span>
<a href="#l54.315"></a><span id="l54.315">       }</span>
<a href="#l54.316"></a><span id="l54.316" class="difflineminus">-      </span>
<a href="#l54.317"></a><span id="l54.317" class="difflineplus">+</span>
<a href="#l54.318"></a><span id="l54.318">       let sender = msgNode.getElementsByClassName(&quot;sender&quot;)[0];</span>
<a href="#l54.319"></a><span id="l54.319">       sender.msgHdr = msgHdr;</span>
<a href="#l54.320"></a><span id="l54.320">       sender.addEventListener(&quot;click&quot;, function(e) {</span>
<a href="#l54.321"></a><span id="l54.321">         // if the msg is the first message in a collapsed thread, we need to</span>
<a href="#l54.322"></a><span id="l54.322">         // uncollapse it.</span>
<a href="#l54.323"></a><span id="l54.323">         let origRowCount = gDBView.rowCount;</span>
<a href="#l54.324"></a><span id="l54.324">         let viewIndex = gDBView.findIndexOfMsgHdr(e.target.msgHdr, true);</span>
<a href="#l54.325"></a><span id="l54.325">         gDBView.selectFolderMsgByKey(this.folder, this.msgKey);</span>
<a href="#l54.326"></a><span id="l54.326" class="difflineat">@@ -599,93 +574,64 @@ ThreadSummary.prototype = {</span>
<a href="#l54.327"></a><span id="l54.327">       }, true);</span>
<a href="#l54.328"></a><span id="l54.328">       sender.folder = msgHdr.folder;</span>
<a href="#l54.329"></a><span id="l54.329">       sender.msgKey = msgHdr.messageKey;</span>
<a href="#l54.330"></a><span id="l54.330"> </span>
<a href="#l54.331"></a><span id="l54.331">       this._msgNodes[key] = msgNode;</span>
<a href="#l54.332"></a><span id="l54.332"> </span>
<a href="#l54.333"></a><span id="l54.333">       messagesElt.appendChild(msgNode);</span>
<a href="#l54.334"></a><span id="l54.334">     }</span>
<a href="#l54.335"></a><span id="l54.335" class="difflineminus">-    </span>
<a href="#l54.336"></a><span id="l54.336" class="difflineplus">+</span>
<a href="#l54.337"></a><span id="l54.337">     // stash somewhere so it doesn't get GC'ed</span>
<a href="#l54.338"></a><span id="l54.338" class="difflineminus">-    this._glodaQueries.push(Gloda.getMessageCollectionForHeaders(msgHdrs, this));</span>
<a href="#l54.339"></a><span id="l54.339" class="difflineplus">+    this._glodaQueries.push(Gloda.getMessageCollectionForHeaders(this._msgHdrs, this));</span>
<a href="#l54.340"></a><span id="l54.340">     this.notifyMaxCountExceeded(numMessages, MAXCOUNT);</span>
<a href="#l54.341"></a><span id="l54.341"> </span>
<a href="#l54.342"></a><span id="l54.342">     this.computeSize(htmlpane);</span>
<a href="#l54.343"></a><span id="l54.343">   }</span>
<a href="#l54.344"></a><span id="l54.344" class="difflineminus">-}</span>
<a href="#l54.345"></a><span id="l54.345" class="difflineplus">+};</span>
<a href="#l54.346"></a><span id="l54.346"> </span>
<a href="#l54.347"></a><span id="l54.347"> // We use a global to prevent GC of gloda collection (and we reuse it to prevent</span>
<a href="#l54.348"></a><span id="l54.348"> // leaks).  Without a global, the GC is aggressive enough that the gloda query</span>
<a href="#l54.349"></a><span id="l54.349"> // is gone before it returns.</span>
<a href="#l54.350"></a><span id="l54.350"> var gSummary;</span>
<a href="#l54.351"></a><span id="l54.351"> </span>
<a href="#l54.352"></a><span id="l54.352"> </span>
<a href="#l54.353"></a><span id="l54.353"> /**</span>
<a href="#l54.354"></a><span id="l54.354" class="difflineminus">- * Given an array of message URIs which are all in the</span>
<a href="#l54.355"></a><span id="l54.355" class="difflineplus">+ * Given an array of messages which are all in the</span>
<a href="#l54.356"></a><span id="l54.356">  * same thread, summarize them.</span>
<a href="#l54.357"></a><span id="l54.357">  *</span>
<a href="#l54.358"></a><span id="l54.358" class="difflineminus">- * @param selectedMsgUris</span>
<a href="#l54.359"></a><span id="l54.359" class="difflineminus">- *        array of message URIs</span>
<a href="#l54.360"></a><span id="l54.360" class="difflineplus">+ * @param aSelectedMessages</span>
<a href="#l54.361"></a><span id="l54.361" class="difflineplus">+ *        array of message headers</span>
<a href="#l54.362"></a><span id="l54.362">  */</span>
<a href="#l54.363"></a><span id="l54.363" class="difflineminus">-function summarizeThread(selectedMsgUris)</span>
<a href="#l54.364"></a><span id="l54.364" class="difflineplus">+function summarizeThread(aSelectedMessages)</span>
<a href="#l54.365"></a><span id="l54.365"> {</span>
<a href="#l54.366"></a><span id="l54.366" class="difflineminus">-  if (selectedMsgUris.length == 0)</span>
<a href="#l54.367"></a><span id="l54.367" class="difflineplus">+  if (aSelectedMessages.length == 0)</span>
<a href="#l54.368"></a><span id="l54.368">     return;</span>
<a href="#l54.369"></a><span id="l54.369"> </span>
<a href="#l54.370"></a><span id="l54.370" class="difflineminus">-  gSummary = new ThreadSummary(selectedMsgUris);</span>
<a href="#l54.371"></a><span id="l54.371" class="difflineplus">+  gSummary = new ThreadSummary(aSelectedMessages);</span>
<a href="#l54.372"></a><span id="l54.372">   gSummary.init();</span>
<a href="#l54.373"></a><span id="l54.373"> }</span>
<a href="#l54.374"></a><span id="l54.374"> </span>
<a href="#l54.375"></a><span id="l54.375"> /**</span>
<a href="#l54.376"></a><span id="l54.376">  * Given an array of message URIs, cause the message pane</span>
<a href="#l54.377"></a><span id="l54.377">  * to display a summary of them.</span>
<a href="#l54.378"></a><span id="l54.378">  *</span>
<a href="#l54.379"></a><span id="l54.379" class="difflineminus">- * @param selectedMsgUris</span>
<a href="#l54.380"></a><span id="l54.380" class="difflineminus">- *        array of message URIs</span>
<a href="#l54.381"></a><span id="l54.381" class="difflineplus">+ * @param aSelectedMessages</span>
<a href="#l54.382"></a><span id="l54.382" class="difflineplus">+ *        array of message headers</span>
<a href="#l54.383"></a><span id="l54.383">  */</span>
<a href="#l54.384"></a><span id="l54.384" class="difflineminus">-function summarizeMultipleSelection(selectedMsgUris)</span>
<a href="#l54.385"></a><span id="l54.385" class="difflineplus">+function summarizeMultipleSelection(aSelectedMessages)</span>
<a href="#l54.386"></a><span id="l54.386"> {</span>
<a href="#l54.387"></a><span id="l54.387" class="difflineminus">-  if (selectedMsgUris.length == 0)</span>
<a href="#l54.388"></a><span id="l54.388" class="difflineplus">+  if (aSelectedMessages.length == 0)</span>
<a href="#l54.389"></a><span id="l54.389">     return;</span>
<a href="#l54.390"></a><span id="l54.390"> </span>
<a href="#l54.391"></a><span id="l54.391" class="difflineminus">-  gSummary = new MultiMessageSummary(selectedMsgUris);</span>
<a href="#l54.392"></a><span id="l54.392" class="difflineplus">+  gSummary = new MultiMessageSummary(aSelectedMessages);</span>
<a href="#l54.393"></a><span id="l54.393">   gSummary.init();</span>
<a href="#l54.394"></a><span id="l54.394"> }</span>
<a href="#l54.395"></a><span id="l54.395"> </span>
<a href="#l54.396"></a><span id="l54.396"> /**</span>
<a href="#l54.397"></a><span id="l54.397" class="difflineminus">- * Given an array of nsMsgHdrs, select all of them.  This will uncollapse</span>
<a href="#l54.398"></a><span id="l54.398" class="difflineminus">- * threads that are collapsed as necessary.</span>
<a href="#l54.399"></a><span id="l54.399" class="difflineminus">- *</span>
<a href="#l54.400"></a><span id="l54.400" class="difflineminus">- * @param msgHdrs</span>
<a href="#l54.401"></a><span id="l54.401" class="difflineminus">- *        array of msgHdr's</span>
<a href="#l54.402"></a><span id="l54.402" class="difflineminus">- */</span>
<a href="#l54.403"></a><span id="l54.403" class="difflineminus">-function selectMultipleMessagesByMsgHdr(msgHdrs)</span>
<a href="#l54.404"></a><span id="l54.404" class="difflineminus">-{</span>
<a href="#l54.405"></a><span id="l54.405" class="difflineminus">-  let treeView = gDBView.QueryInterface(Components.interfaces.nsITreeView);</span>
<a href="#l54.406"></a><span id="l54.406" class="difflineminus">-  if (msgHdrs.length == 1) {</span>
<a href="#l54.407"></a><span id="l54.407" class="difflineminus">-    gDBView.selectFolderMsgByKey(msgHdrs[0].folder, msgHdrs[0].messageKey);</span>
<a href="#l54.408"></a><span id="l54.408" class="difflineminus">-  } else {</span>
<a href="#l54.409"></a><span id="l54.409" class="difflineminus">-    let treeSelection = treeView.selection;</span>
<a href="#l54.410"></a><span id="l54.410" class="difflineminus">-    treeSelection.clearSelection();</span>
<a href="#l54.411"></a><span id="l54.411" class="difflineminus">-    for (let [, msgHdr] in Iterator(msgHdrs))</span>
<a href="#l54.412"></a><span id="l54.412" class="difflineminus">-    {</span>
<a href="#l54.413"></a><span id="l54.413" class="difflineminus">-      let viewIndex = gDBView.findIndexOfMsgHdr(msgHdr, false);</span>
<a href="#l54.414"></a><span id="l54.414" class="difflineminus">-      let thread = gDBView.getThreadContainingIndex(viewIndex);</span>
<a href="#l54.415"></a><span id="l54.415" class="difflineminus">-      let flags = gDBView.getFlagsAt(viewIndex);</span>
<a href="#l54.416"></a><span id="l54.416" class="difflineminus">-</span>
<a href="#l54.417"></a><span id="l54.417" class="difflineminus">-      if (flags &amp; Components.interfaces.nsMsgMessageFlags.Elided)</span>
<a href="#l54.418"></a><span id="l54.418" class="difflineminus">-        treeView.toggleOpenState(viewIndex);</span>
<a href="#l54.419"></a><span id="l54.419" class="difflineminus">-</span>
<a href="#l54.420"></a><span id="l54.420" class="difflineminus">-      treeSelection.rangedSelect(viewIndex, viewIndex, true);</span>
<a href="#l54.421"></a><span id="l54.421" class="difflineminus">-    }</span>
<a href="#l54.422"></a><span id="l54.422" class="difflineminus">-  }</span>
<a href="#l54.423"></a><span id="l54.423" class="difflineminus">-}</span>
<a href="#l54.424"></a><span id="l54.424" class="difflineminus">-</span>
<a href="#l54.425"></a><span id="l54.425" class="difflineminus">-/**</span>
<a href="#l54.426"></a><span id="l54.426">  * Helper function to generate a localized &quot;friendly&quot; representation of</span>
<a href="#l54.427"></a><span id="l54.427">  * time relative to the present.  If the time input is &quot;today&quot;, it returns</span>
<a href="#l54.428"></a><span id="l54.428">  * a string corresponding to just the time.  If it's yesterday, it returns</span>
<a href="#l54.429"></a><span id="l54.429">  * &quot;yesterday&quot; (localized).  If it's in the last week, it returns the day</span>
<a href="#l54.430"></a><span id="l54.430">  * of the week. If it's before that, it returns the date.</span>
<a href="#l54.431"></a><span id="l54.431">  *</span>
<a href="#l54.432"></a><span id="l54.432">  * @param time</span>
<a href="#l54.433"></a><span id="l54.433">  *        the time (better be in the past!)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l55.1"></a><span id="l55.1" class="difflineminus">--- a/mail/base/content/tabmail.xml</span>
<a href="#l55.2"></a><span id="l55.2" class="difflineplus">+++ b/mail/base/content/tabmail.xml</span>
<a href="#l55.3"></a><span id="l55.3" class="difflineat">@@ -1,46 +1,46 @@</span>
<a href="#l55.4"></a><span id="l55.4"> &lt;?xml version=&quot;1.0&quot;?&gt;</span>
<a href="#l55.5"></a><span id="l55.5" class="difflineminus">-# ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l55.6"></a><span id="l55.6" class="difflineminus">-# Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l55.7"></a><span id="l55.7" class="difflineminus">-#</span>
<a href="#l55.8"></a><span id="l55.8" class="difflineminus">-# The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l55.9"></a><span id="l55.9" class="difflineminus">-# 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l55.10"></a><span id="l55.10" class="difflineminus">-# the License. You may obtain a copy of the License at</span>
<a href="#l55.11"></a><span id="l55.11" class="difflineminus">-# http://www.mozilla.org/MPL/</span>
<a href="#l55.12"></a><span id="l55.12" class="difflineminus">-#</span>
<a href="#l55.13"></a><span id="l55.13" class="difflineminus">-# Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l55.14"></a><span id="l55.14" class="difflineminus">-# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l55.15"></a><span id="l55.15" class="difflineminus">-# for the specific language governing rights and limitations under the</span>
<a href="#l55.16"></a><span id="l55.16" class="difflineminus">-# License.</span>
<a href="#l55.17"></a><span id="l55.17" class="difflineminus">-#</span>
<a href="#l55.18"></a><span id="l55.18" class="difflineminus">-# The Original Code is tab email</span>
<a href="#l55.19"></a><span id="l55.19" class="difflineminus">-#</span>
<a href="#l55.20"></a><span id="l55.20" class="difflineminus">-# The Initial Developer of the Original Code is</span>
<a href="#l55.21"></a><span id="l55.21" class="difflineminus">-#   David Bienvenu &lt;bienvenu@nventure.com&gt;.</span>
<a href="#l55.22"></a><span id="l55.22" class="difflineminus">-# Portions created by the Initial Developer are Copyright (C) 2007</span>
<a href="#l55.23"></a><span id="l55.23" class="difflineminus">-# the Initial Developer. All Rights Reserved.</span>
<a href="#l55.24"></a><span id="l55.24" class="difflineminus">-#</span>
<a href="#l55.25"></a><span id="l55.25" class="difflineminus">-# Contributor(s):</span>
<a href="#l55.26"></a><span id="l55.26" class="difflineminus">-#  Scott MacGregor &lt;mscott@mozilla.org&gt;</span>
<a href="#l55.27"></a><span id="l55.27" class="difflineminus">-#  Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a href="#l55.28"></a><span id="l55.28" class="difflineminus">-#</span>
<a href="#l55.29"></a><span id="l55.29" class="difflineminus">-# Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l55.30"></a><span id="l55.30" class="difflineminus">-# either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l55.31"></a><span id="l55.31" class="difflineminus">-# the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l55.32"></a><span id="l55.32" class="difflineminus">-# in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l55.33"></a><span id="l55.33" class="difflineminus">-# of those above. If you wish to allow use of your version of this file only</span>
<a href="#l55.34"></a><span id="l55.34" class="difflineminus">-# under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l55.35"></a><span id="l55.35" class="difflineminus">-# use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l55.36"></a><span id="l55.36" class="difflineminus">-# decision by deleting the provisions above and replace them with the notice</span>
<a href="#l55.37"></a><span id="l55.37" class="difflineminus">-# and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l55.38"></a><span id="l55.38" class="difflineminus">-# the provisions above, a recipient may use your version of this file under</span>
<a href="#l55.39"></a><span id="l55.39" class="difflineminus">-# the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l55.40"></a><span id="l55.40" class="difflineminus">-#</span>
<a href="#l55.41"></a><span id="l55.41" class="difflineminus">-# ***** END LICENSE BLOCK *****</span>
<a href="#l55.42"></a><span id="l55.42" class="difflineplus">+&lt;!-- ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l55.43"></a><span id="l55.43" class="difflineplus">+  - Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l55.44"></a><span id="l55.44" class="difflineplus">+  -</span>
<a href="#l55.45"></a><span id="l55.45" class="difflineplus">+  - The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l55.46"></a><span id="l55.46" class="difflineplus">+  - 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l55.47"></a><span id="l55.47" class="difflineplus">+  - the License. You may obtain a copy of the License at</span>
<a href="#l55.48"></a><span id="l55.48" class="difflineplus">+  - http://www.mozilla.org/MPL/</span>
<a href="#l55.49"></a><span id="l55.49" class="difflineplus">+  -</span>
<a href="#l55.50"></a><span id="l55.50" class="difflineplus">+  - Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l55.51"></a><span id="l55.51" class="difflineplus">+  - WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l55.52"></a><span id="l55.52" class="difflineplus">+  - for the specific language governing rights and limitations under the</span>
<a href="#l55.53"></a><span id="l55.53" class="difflineplus">+  - License.</span>
<a href="#l55.54"></a><span id="l55.54" class="difflineplus">+  -</span>
<a href="#l55.55"></a><span id="l55.55" class="difflineplus">+  - The Original Code is tab email</span>
<a href="#l55.56"></a><span id="l55.56" class="difflineplus">+  -</span>
<a href="#l55.57"></a><span id="l55.57" class="difflineplus">+  - The Initial Developer of the Original Code is</span>
<a href="#l55.58"></a><span id="l55.58" class="difflineplus">+  -   David Bienvenu &lt;bienvenu@nventure.com&gt;.</span>
<a href="#l55.59"></a><span id="l55.59" class="difflineplus">+  - Portions created by the Initial Developer are Copyright (C) 2007</span>
<a href="#l55.60"></a><span id="l55.60" class="difflineplus">+  - the Initial Developer. All Rights Reserved.</span>
<a href="#l55.61"></a><span id="l55.61" class="difflineplus">+  -</span>
<a href="#l55.62"></a><span id="l55.62" class="difflineplus">+  - Contributor(s):</span>
<a href="#l55.63"></a><span id="l55.63" class="difflineplus">+  -  Scott MacGregor &lt;mscott@mozilla.org&gt;</span>
<a href="#l55.64"></a><span id="l55.64" class="difflineplus">+  -  Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a href="#l55.65"></a><span id="l55.65" class="difflineplus">+  -</span>
<a href="#l55.66"></a><span id="l55.66" class="difflineplus">+  - Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l55.67"></a><span id="l55.67" class="difflineplus">+  - either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l55.68"></a><span id="l55.68" class="difflineplus">+  - the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l55.69"></a><span id="l55.69" class="difflineplus">+  - in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l55.70"></a><span id="l55.70" class="difflineplus">+  - of those above. If you wish to allow use of your version of this file only</span>
<a href="#l55.71"></a><span id="l55.71" class="difflineplus">+  - under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l55.72"></a><span id="l55.72" class="difflineplus">+  - use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l55.73"></a><span id="l55.73" class="difflineplus">+  - decision by deleting the provisions above and replace them with the notice</span>
<a href="#l55.74"></a><span id="l55.74" class="difflineplus">+  - and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l55.75"></a><span id="l55.75" class="difflineplus">+  - the provisions above, a recipient may use your version of this file under</span>
<a href="#l55.76"></a><span id="l55.76" class="difflineplus">+  - the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l55.77"></a><span id="l55.77" class="difflineplus">+  -</span>
<a href="#l55.78"></a><span id="l55.78" class="difflineplus">+  - ***** END LICENSE BLOCK ***** --&gt;</span>
<a href="#l55.79"></a><span id="l55.79"> </span>
<a href="#l55.80"></a><span id="l55.80"> &lt;!DOCTYPE bindings [</span>
<a href="#l55.81"></a><span id="l55.81"> &lt;!ENTITY % messengerDTD SYSTEM &quot;chrome://messenger/locale/messenger.dtd&quot; &gt;</span>
<a href="#l55.82"></a><span id="l55.82"> %messengerDTD;</span>
<a href="#l55.83"></a><span id="l55.83"> &lt;!ENTITY % tabMailDTD SYSTEM &quot;chrome://messenger/locale/tabmail.dtd&quot; &gt;</span>
<a href="#l55.84"></a><span id="l55.84">  %tabMailDTD;</span>
<a href="#l55.85"></a><span id="l55.85">  &lt;!ENTITY % globalDTD SYSTEM &quot;chrome://global/locale/global.dtd&quot;&gt;</span>
<a href="#l55.86"></a><span id="l55.86">  %globalDTD;</span>
<a href="#l55.87"></a><span id="l55.87" class="difflineat">@@ -71,28 +71,52 @@</span>
<a href="#l55.88"></a><span id="l55.88">     - 1) Code that wants to open new tabs.</span>
<a href="#l55.89"></a><span id="l55.89">     - 2) Code that wants to contribute one or more varieties of tabs.</span>
<a href="#l55.90"></a><span id="l55.90">     - 3) Code that wants to monitor to know when the active tab changes.</span>
<a href="#l55.91"></a><span id="l55.91">     -</span>
<a href="#l55.92"></a><span id="l55.92">     - Consumer code should use the following methods:</span>
<a href="#l55.93"></a><span id="l55.93">     - * openTab(aTabModeName, arguments...): Open a tab of the given &quot;mode&quot;,</span>
<a href="#l55.94"></a><span id="l55.94">     -   passing the provided arguments.  The tab type author should tell you</span>
<a href="#l55.95"></a><span id="l55.95">     -   the modes they implement and the required/optional arguments.</span>
<a href="#l55.96"></a><span id="l55.96" class="difflineplus">+    - * closeTab(aOptionalTabIndexInfoOrTabNode): If no argument is provided,</span>
<a href="#l55.97"></a><span id="l55.97" class="difflineplus">+    -   the current tab is closed.  If an argument is provided, it can be</span>
<a href="#l55.98"></a><span id="l55.98" class="difflineplus">+    -   a tab index, a tab info object, or the tabmail-tab bound element</span>
<a href="#l55.99"></a><span id="l55.99" class="difflineplus">+    -   that _is_ the tab.  Some tabs cannot be closed, in which case this</span>
<a href="#l55.100"></a><span id="l55.100" class="difflineplus">+    -   will do nothing.</span>
<a href="#l55.101"></a><span id="l55.101" class="difflineplus">+    - * switchToTab(aTabIndexInfoOrTabNode): Switch to the tab by providing</span>
<a href="#l55.102"></a><span id="l55.102" class="difflineplus">+    -   a tab index, tab info object, or tab node (tabmail-tab bound</span>
<a href="#l55.103"></a><span id="l55.103" class="difflineplus">+    -   element.)  You can also just poke at tabmail.tabContainer and its</span>
<a href="#l55.104"></a><span id="l55.104" class="difflineplus">+    -   selectedIndex and selectedItem properties.</span>
<a href="#l55.105"></a><span id="l55.105" class="difflineplus">+    - Less-friendly consumer methods:</span>
<a href="#l55.106"></a><span id="l55.106" class="difflineplus">+    - * removeCurrentTab(): Close the current tab.</span>
<a href="#l55.107"></a><span id="l55.107" class="difflineplus">+    - * removeTabByNode(aTabElement): Close the tab whose tabmail-tab bound</span>
<a href="#l55.108"></a><span id="l55.108" class="difflineplus">+    -   element is passed in.</span>
<a href="#l55.109"></a><span id="l55.109" class="difflineplus">+    - Changing the currently displayed tab is accomplished by changing</span>
<a href="#l55.110"></a><span id="l55.110" class="difflineplus">+    -  tabmail.tabContainer's selectedIndex or selectedItem property.</span>
<a href="#l55.111"></a><span id="l55.111" class="difflineplus">+    -</span>
<a href="#l55.112"></a><span id="l55.112" class="difflineplus">+    - Code that lives in a tab should use the following methods:</span>
<a href="#l55.113"></a><span id="l55.113">     - * setTabTitle([aOptionalTabInfo]): Tells us that the title of the current</span>
<a href="#l55.114"></a><span id="l55.114">     -   tab (if no argument is provided) or provided tab needs to be updated.</span>
<a href="#l55.115"></a><span id="l55.115">     -   This will result in a call to the tab mode's logic to update the title.</span>
<a href="#l55.116"></a><span id="l55.116">     -   In the event this is not for the current tab, the caller is responsible</span>
<a href="#l55.117"></a><span id="l55.117">     -   for ensuring that the underlying tab mode is capable of providing a tab</span>
<a href="#l55.118"></a><span id="l55.118">     -   title when it is in the background.  (The is currently not the case for</span>
<a href="#l55.119"></a><span id="l55.119">     -   &quot;folder&quot; and &quot;mail&quot; modes because of their implementation.)</span>
<a href="#l55.120"></a><span id="l55.120" class="difflineminus">-    - * removeCurrentTab(): Close the current tab.</span>
<a href="#l55.121"></a><span id="l55.121" class="difflineminus">-    - * removeTabByNode(aTabElement): Close the tab whose tabmail-tab bound</span>
<a href="#l55.122"></a><span id="l55.122" class="difflineminus">-    -   element is passed in.</span>
<a href="#l55.123"></a><span id="l55.123" class="difflineminus">-    - Changing the currently displayed tab is accomplished by changing</span>
<a href="#l55.124"></a><span id="l55.124" class="difflineminus">-    -  tabmail.tabContainer's selectedIndex or selectedItem property.</span>
<a href="#l55.125"></a><span id="l55.125" class="difflineplus">+    - * setTabBusy(aTabNode, aBusyState): Tells us that the tab in question</span>
<a href="#l55.126"></a><span id="l55.126" class="difflineplus">+    -   is now busy or not busy.  &quot;Busy&quot; means that it is occupied and</span>
<a href="#l55.127"></a><span id="l55.127" class="difflineplus">+    -   will not be able to respond to you until it is no longer busy.</span>
<a href="#l55.128"></a><span id="l55.128" class="difflineplus">+    -   This impacts the cursor display, as well as potentially</span>
<a href="#l55.129"></a><span id="l55.129" class="difflineplus">+    -   providing tab display hints.</span>
<a href="#l55.130"></a><span id="l55.130" class="difflineplus">+    - * setTabThinking(aTabNode, aThinkingState): Tells us that the</span>
<a href="#l55.131"></a><span id="l55.131" class="difflineplus">+    -   tab in question is now thinking or not thinking.  &quot;Thinking&quot; means</span>
<a href="#l55.132"></a><span id="l55.132" class="difflineplus">+    -   that the tab is involved in some ongoing process but you can still</span>
<a href="#l55.133"></a><span id="l55.133" class="difflineplus">+    -   interact with the tab while it is thinking.  A search would be an</span>
<a href="#l55.134"></a><span id="l55.134" class="difflineplus">+    -   example of thinking.  This impacts spinny-thing feedback as well as</span>
<a href="#l55.135"></a><span id="l55.135" class="difflineplus">+    -   potential providing tab display hints.  aThinkingState may be a</span>
<a href="#l55.136"></a><span id="l55.136" class="difflineplus">+    -   boolean or a localized string explaining what you are thinking about.</span>
<a href="#l55.137"></a><span id="l55.137">     -</span>
<a href="#l55.138"></a><span id="l55.138">     - Tab contributing code should define a tab type object and register it</span>
<a href="#l55.139"></a><span id="l55.139">     -  with us by calling registerTabType.  Each tab type can provide multiple</span>
<a href="#l55.140"></a><span id="l55.140">     -  tab modes.  The rationale behind this organization is that Thunderbird</span>
<a href="#l55.141"></a><span id="l55.141">     -  historically/currently uses a single 3-pane view to display both</span>
<a href="#l55.142"></a><span id="l55.142">     -  three-pane folder browsing and single message browsing across multiple</span>
<a href="#l55.143"></a><span id="l55.143">     -  tabs.  Each tab type has the ability to use a single tab panel for all</span>
<a href="#l55.144"></a><span id="l55.144">     -  of its display needs.  So Thunderbird's &quot;mail&quot; tab type covers both the</span>
<a href="#l55.145"></a><span id="l55.145" class="difflineat">@@ -232,16 +256,22 @@</span>
<a href="#l55.146"></a><span id="l55.146">         window.controllers.insertControllerAt(0, this);</span>
<a href="#l55.147"></a><span id="l55.147">       &lt;/constructor&gt;</span>
<a href="#l55.148"></a><span id="l55.148">       &lt;destructor&gt;</span>
<a href="#l55.149"></a><span id="l55.149">         window.controllers.removeController(this);</span>
<a href="#l55.150"></a><span id="l55.150">       &lt;/destructor&gt;</span>
<a href="#l55.151"></a><span id="l55.151">       &lt;field name=&quot;currentTabInfo&quot;&gt;</span>
<a href="#l55.152"></a><span id="l55.152">         null</span>
<a href="#l55.153"></a><span id="l55.153">       &lt;/field&gt;</span>
<a href="#l55.154"></a><span id="l55.154" class="difflineplus">+      &lt;!-- Temporary field that only has a non-null value during a call to</span>
<a href="#l55.155"></a><span id="l55.155" class="difflineplus">+           openTab, and whose value is the currentTabInfo of the tab that was</span>
<a href="#l55.156"></a><span id="l55.156" class="difflineplus">+           open when we received the call to openTab. --&gt;</span>
<a href="#l55.157"></a><span id="l55.157" class="difflineplus">+      &lt;field name=&quot;_mostRecentTabInfo&quot;&gt;</span>
<a href="#l55.158"></a><span id="l55.158" class="difflineplus">+        null</span>
<a href="#l55.159"></a><span id="l55.159" class="difflineplus">+      &lt;/field&gt;</span>
<a href="#l55.160"></a><span id="l55.160">       &lt;field name=&quot;tabTypes&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l55.161"></a><span id="l55.161">         new Object()</span>
<a href="#l55.162"></a><span id="l55.162">       &lt;/field&gt;</span>
<a href="#l55.163"></a><span id="l55.163">       &lt;field name=&quot;tabModes&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l55.164"></a><span id="l55.164">         new Object()</span>
<a href="#l55.165"></a><span id="l55.165">       &lt;/field&gt;</span>
<a href="#l55.166"></a><span id="l55.166">       &lt;field name=&quot;defaultTabMode&quot;&gt;</span>
<a href="#l55.167"></a><span id="l55.167">         null</span>
<a href="#l55.168"></a><span id="l55.168" class="difflineat">@@ -289,33 +319,76 @@</span>
<a href="#l55.169"></a><span id="l55.169">       &lt;/method&gt;</span>
<a href="#l55.170"></a><span id="l55.170">       &lt;method name=&quot;unregisterTabMonitor&quot;&gt;</span>
<a href="#l55.171"></a><span id="l55.171">         &lt;parameter name=&quot;aTabMonitor&quot;/&gt;</span>
<a href="#l55.172"></a><span id="l55.172">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l55.173"></a><span id="l55.173">           if (this.tabMonitors.indexOf(aTabMonitor) &gt;= 0)</span>
<a href="#l55.174"></a><span id="l55.174">             this.tabMonitors.splice(this.tabMonitors.indexOf(aTabMonitor), 1);</span>
<a href="#l55.175"></a><span id="l55.175">         ]]&gt;&lt;/body&gt;</span>
<a href="#l55.176"></a><span id="l55.176">       &lt;/method&gt;</span>
<a href="#l55.177"></a><span id="l55.177" class="difflineplus">+      &lt;!-- Given an index, tab node or tab info object, return a tuple of</span>
<a href="#l55.178"></a><span id="l55.178" class="difflineplus">+           [iTab, tab info dictionary, tab DOM node].  If</span>
<a href="#l55.179"></a><span id="l55.179" class="difflineplus">+           aTabIndexNodeOrInfo is not specified and aDefaultToCurrent is</span>
<a href="#l55.180"></a><span id="l55.180" class="difflineplus">+           true, the current tab will be returned.  Otherwise, an</span>
<a href="#l55.181"></a><span id="l55.181" class="difflineplus">+           exception will be thrown.</span>
<a href="#l55.182"></a><span id="l55.182" class="difflineplus">+        --&gt;</span>
<a href="#l55.183"></a><span id="l55.183" class="difflineplus">+      &lt;method name=&quot;_getTabContextForTabbyThing&quot;&gt;</span>
<a href="#l55.184"></a><span id="l55.184" class="difflineplus">+        &lt;parameter name=&quot;aTabIndexNodeOrInfo&quot;/&gt;</span>
<a href="#l55.185"></a><span id="l55.185" class="difflineplus">+        &lt;parameter name=&quot;aDefaultToCurrent&quot;/&gt;</span>
<a href="#l55.186"></a><span id="l55.186" class="difflineplus">+        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l55.187"></a><span id="l55.187" class="difflineplus">+          let iTab, tab, tabNode;</span>
<a href="#l55.188"></a><span id="l55.188" class="difflineplus">+          if (!aTabIndexNodeOrInfo) {</span>
<a href="#l55.189"></a><span id="l55.189" class="difflineplus">+            if (!aDefaultToCurrent)</span>
<a href="#l55.190"></a><span id="l55.190" class="difflineplus">+              throw Exception(&quot;You need to specify a tab!&quot;);</span>
<a href="#l55.191"></a><span id="l55.191" class="difflineplus">+            iTab = this.tabContainer.selectedIndex;</span>
<a href="#l55.192"></a><span id="l55.192" class="difflineplus">+            return [iTab, this.tabInfo[iTab],</span>
<a href="#l55.193"></a><span id="l55.193" class="difflineplus">+                    this.tabContainer.childNodes[iTab]];</span>
<a href="#l55.194"></a><span id="l55.194" class="difflineplus">+          }</span>
<a href="#l55.195"></a><span id="l55.195" class="difflineplus">+</span>
<a href="#l55.196"></a><span id="l55.196" class="difflineplus">+          if (typeof(aTabIndexNodeOrInfo) == &quot;number&quot;) {</span>
<a href="#l55.197"></a><span id="l55.197" class="difflineplus">+            iTab = aTabIndexNodeOrInfo;</span>
<a href="#l55.198"></a><span id="l55.198" class="difflineplus">+            tabNode = this.tabContainer.childNodes[iTab];</span>
<a href="#l55.199"></a><span id="l55.199" class="difflineplus">+            tab = this.tabInfo[iTab];</span>
<a href="#l55.200"></a><span id="l55.200" class="difflineplus">+          }</span>
<a href="#l55.201"></a><span id="l55.201" class="difflineplus">+          else if (aTabIndexNodeOrInfo.tagName == &quot;tab&quot;) {</span>
<a href="#l55.202"></a><span id="l55.202" class="difflineplus">+            tabNode = aTabIndexNodeOrInfo;</span>
<a href="#l55.203"></a><span id="l55.203" class="difflineplus">+            iTab = this.tabContainer.getIndexOfItem(tabNode);</span>
<a href="#l55.204"></a><span id="l55.204" class="difflineplus">+            tab = this.tabInfo[iTab];</span>
<a href="#l55.205"></a><span id="l55.205" class="difflineplus">+          }</span>
<a href="#l55.206"></a><span id="l55.206" class="difflineplus">+          else {</span>
<a href="#l55.207"></a><span id="l55.207" class="difflineplus">+            tab = aTabIndexNodeOrInfo;</span>
<a href="#l55.208"></a><span id="l55.208" class="difflineplus">+            iTab = this.tabInfo.indexOf(tab);</span>
<a href="#l55.209"></a><span id="l55.209" class="difflineplus">+            tabNode = (iTab &gt;= 0) ? this.tabContainer.childNodes[iTab] : null;</span>
<a href="#l55.210"></a><span id="l55.210" class="difflineplus">+          }</span>
<a href="#l55.211"></a><span id="l55.211" class="difflineplus">+</span>
<a href="#l55.212"></a><span id="l55.212" class="difflineplus">+          return [iTab, tab, tabNode];</span>
<a href="#l55.213"></a><span id="l55.213" class="difflineplus">+        ]]&gt;&lt;/body&gt;</span>
<a href="#l55.214"></a><span id="l55.214" class="difflineplus">+      &lt;/method&gt;</span>
<a href="#l55.215"></a><span id="l55.215">       &lt;method name=&quot;openFirstTab&quot;&gt;</span>
<a href="#l55.216"></a><span id="l55.216">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l55.217"></a><span id="l55.217">           // From the moment of creation, our XBL binding already has a visible</span>
<a href="#l55.218"></a><span id="l55.218">           //  tab.  We need to create a tab information structure for this tab.</span>
<a href="#l55.219"></a><span id="l55.219">           //  In the process we also generate a synthetic tab title changed</span>
<a href="#l55.220"></a><span id="l55.220">           //  event to ensure we have an accurate title.  We assume the tab</span>
<a href="#l55.221"></a><span id="l55.221">           //  contents will set themselves up correctly.</span>
<a href="#l55.222"></a><span id="l55.222">           if (this.tabInfo.length == 0) {</span>
<a href="#l55.223"></a><span id="l55.223" class="difflineminus">-            let firstTab = {mode: this.defaultTabMode, canClose: false};</span>
<a href="#l55.224"></a><span id="l55.224" class="difflineplus">+            let firstTab = {mode: this.defaultTabMode, busy: false,</span>
<a href="#l55.225"></a><span id="l55.225" class="difflineplus">+                            canClose: false};</span>
<a href="#l55.226"></a><span id="l55.226">             firstTab.mode.tabs.push(firstTab);</span>
<a href="#l55.227"></a><span id="l55.227" class="difflineminus">-           </span>
<a href="#l55.228"></a><span id="l55.228" class="difflineplus">+</span>
<a href="#l55.229"></a><span id="l55.229">             this.tabInfo[0] = this.currentTabInfo = firstTab;</span>
<a href="#l55.230"></a><span id="l55.230" class="difflineminus">-            this.setTabTitle(firstTab);</span>
<a href="#l55.231"></a><span id="l55.231" class="difflineplus">+</span>
<a href="#l55.232"></a><span id="l55.232" class="difflineplus">+            let tabOpenFirstFunc = firstTab.mode.openFirstTab ||</span>
<a href="#l55.233"></a><span id="l55.233" class="difflineplus">+                                   firstTab.mode.tabType.openFirstTab;</span>
<a href="#l55.234"></a><span id="l55.234" class="difflineplus">+            tabOpenFirstFunc.call(firstTab.mode.tabType, firstTab);</span>
<a href="#l55.235"></a><span id="l55.235" class="difflineplus">+            this.setTabTitle(null);</span>
<a href="#l55.236"></a><span id="l55.236"> </span>
<a href="#l55.237"></a><span id="l55.237">             if (this.tabMonitors.length) {</span>
<a href="#l55.238"></a><span id="l55.238">               for each (let [i, tabMonitor] in Iterator(this.tabMonitors))</span>
<a href="#l55.239"></a><span id="l55.239" class="difflineminus">-                tabMonitor.onTabSwitched(tab, null);</span>
<a href="#l55.240"></a><span id="l55.240" class="difflineplus">+                tabMonitor.onTabSwitched(firstTab, null);</span>
<a href="#l55.241"></a><span id="l55.241">             }</span>
<a href="#l55.242"></a><span id="l55.242">           }</span>
<a href="#l55.243"></a><span id="l55.243">         ]]&gt;&lt;/body&gt;</span>
<a href="#l55.244"></a><span id="l55.244">       &lt;/method&gt;</span>
<a href="#l55.245"></a><span id="l55.245">       &lt;method name=&quot;openTab&quot;&gt;</span>
<a href="#l55.246"></a><span id="l55.246">         &lt;parameter name=&quot;aTabModeName&quot;/&gt;</span>
<a href="#l55.247"></a><span id="l55.247">         &lt;body&gt;</span>
<a href="#l55.248"></a><span id="l55.248">             &lt;![CDATA[</span>
<a href="#l55.249"></a><span id="l55.249" class="difflineat">@@ -339,37 +412,36 @@</span>
<a href="#l55.250"></a><span id="l55.250">               this.selectTabByIndex(null, tabIndex);</span>
<a href="#l55.251"></a><span id="l55.251">               return;</span>
<a href="#l55.252"></a><span id="l55.252">             }</span>
<a href="#l55.253"></a><span id="l55.253">           }</span>
<a href="#l55.254"></a><span id="l55.254"> </span>
<a href="#l55.255"></a><span id="l55.255">           // we need to save the state before it gets corrupted</span>
<a href="#l55.256"></a><span id="l55.256">           this.saveCurrentTabState();</span>
<a href="#l55.257"></a><span id="l55.257"> </span>
<a href="#l55.258"></a><span id="l55.258" class="difflineminus">-          let tab = {mode: tabMode, canClose: true};</span>
<a href="#l55.259"></a><span id="l55.259" class="difflineplus">+          let tab = {mode: tabMode, busy: false, canClose: true};</span>
<a href="#l55.260"></a><span id="l55.260">           tabMode.tabs.push(tab);</span>
<a href="#l55.261"></a><span id="l55.261"> </span>
<a href="#l55.262"></a><span id="l55.262">           var t = document.createElementNS(</span>
<a href="#l55.263"></a><span id="l55.263">             &quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;,</span>
<a href="#l55.264"></a><span id="l55.264">             &quot;tab&quot;);</span>
<a href="#l55.265"></a><span id="l55.265">           t.setAttribute(&quot;crop&quot;, &quot;end&quot;);</span>
<a href="#l55.266"></a><span id="l55.266">           t.maxWidth = this.tabContainer.mTabMaxWidth;</span>
<a href="#l55.267"></a><span id="l55.267">           t.minWidth = this.tabContainer.mTabMinWidth;</span>
<a href="#l55.268"></a><span id="l55.268">           t.width = 0;</span>
<a href="#l55.269"></a><span id="l55.269">           t.setAttribute(&quot;flex&quot;, &quot;100&quot;);</span>
<a href="#l55.270"></a><span id="l55.270">           t.setAttribute(&quot;validate&quot;, &quot;never&quot;);</span>
<a href="#l55.271"></a><span id="l55.271">           t.className = &quot;tabmail-tab&quot;;</span>
<a href="#l55.272"></a><span id="l55.272">           this.tabContainer.appendChild(t);</span>
<a href="#l55.273"></a><span id="l55.273" class="difflineminus">-          this.tabContainer.appendChild(t);</span>
<a href="#l55.274"></a><span id="l55.274">           if (this.tabContainer.collapsed) {</span>
<a href="#l55.275"></a><span id="l55.275">             this.tabContainer.collapsed = false;</span>
<a href="#l55.276"></a><span id="l55.276">             this.tabContainer.adjustTabstrip();</span>
<a href="#l55.277"></a><span id="l55.277">           }</span>
<a href="#l55.278"></a><span id="l55.278"> </span>
<a href="#l55.279"></a><span id="l55.279" class="difflineminus">-          let oldTab = this.currentTabInfo;</span>
<a href="#l55.280"></a><span id="l55.280" class="difflineplus">+          let oldTab = this._mostRecentTabInfo = this.currentTabInfo;</span>
<a href="#l55.281"></a><span id="l55.281"> </span>
<a href="#l55.282"></a><span id="l55.282">           // the order of the following statements is important</span>
<a href="#l55.283"></a><span id="l55.283">           this.currentTabInfo = tab;</span>
<a href="#l55.284"></a><span id="l55.284">           this.tabInfo[this.tabContainer.childNodes.length - 1] = tab;</span>
<a href="#l55.285"></a><span id="l55.285">           // this has a side effect of calling updateCurrentTab, but our</span>
<a href="#l55.286"></a><span id="l55.286">           //  setting currentTabInfo above will cause it to take no action.</span>
<a href="#l55.287"></a><span id="l55.287">           this.tabContainer.selectedIndex =</span>
<a href="#l55.288"></a><span id="l55.288">             this.tabContainer.childNodes.length - 1;</span>
<a href="#l55.289"></a><span id="l55.289" class="difflineat">@@ -395,22 +467,25 @@</span>
<a href="#l55.290"></a><span id="l55.290">           let args = [tab].concat(Array.prototype.slice.call(arguments, 1));</span>
<a href="#l55.291"></a><span id="l55.291">           tabOpenFunc.apply(tab.mode.tabType, args);</span>
<a href="#l55.292"></a><span id="l55.292">           </span>
<a href="#l55.293"></a><span id="l55.293">           if (this.tabMonitors.length) {</span>
<a href="#l55.294"></a><span id="l55.294">             for each (let [i, tabMonitor] in Iterator(this.tabMonitors))</span>
<a href="#l55.295"></a><span id="l55.295">               tabMonitor.onTabSwitched(tab, oldTab);</span>
<a href="#l55.296"></a><span id="l55.296">           }</span>
<a href="#l55.297"></a><span id="l55.297">           </span>
<a href="#l55.298"></a><span id="l55.298" class="difflineplus">+          // clear _mostRecentTabInfo; we only needed it during the call to</span>
<a href="#l55.299"></a><span id="l55.299" class="difflineplus">+          //  openTab.</span>
<a href="#l55.300"></a><span id="l55.300" class="difflineplus">+          this._mostRecentTabInfo = null;</span>
<a href="#l55.301"></a><span id="l55.301" class="difflineplus">+          </span>
<a href="#l55.302"></a><span id="l55.302">           t.setAttribute(&quot;label&quot;, tab.title);</span>
<a href="#l55.303"></a><span id="l55.303">           </span>
<a href="#l55.304"></a><span id="l55.304">           let docTitle = tab.title;</span>
<a href="#l55.305"></a><span id="l55.305" class="difflineminus">-#ifndef XP_MACOSX</span>
<a href="#l55.306"></a><span id="l55.306" class="difflineminus">-          docTitle += &quot; - &quot; + gBrandBundle.getString(&quot;brandFullName&quot;);</span>
<a href="#l55.307"></a><span id="l55.307" class="difflineminus">-#endif</span>
<a href="#l55.308"></a><span id="l55.308" class="difflineplus">+          if (!gPlatformOSX)</span>
<a href="#l55.309"></a><span id="l55.309" class="difflineplus">+            docTitle += &quot; - &quot; + gBrandBundle.getString(&quot;brandFullName&quot;);</span>
<a href="#l55.310"></a><span id="l55.310">           document.title = docTitle;</span>
<a href="#l55.311"></a><span id="l55.311">           </span>
<a href="#l55.312"></a><span id="l55.312">           // for styling purposes, apply the type to the tab...</span>
<a href="#l55.313"></a><span id="l55.313">           t.setAttribute('type', tab.mode.type);</span>
<a href="#l55.314"></a><span id="l55.314">         ]]&gt;&lt;/body&gt;</span>
<a href="#l55.315"></a><span id="l55.315">       &lt;/method&gt;</span>
<a href="#l55.316"></a><span id="l55.316">       &lt;method name=&quot;selectTabByMode&quot;&gt;</span>
<a href="#l55.317"></a><span id="l55.317">         &lt;parameter name=&quot;aTabModeName&quot;/&gt;</span>
<a href="#l55.318"></a><span id="l55.318" class="difflineat">@@ -437,60 +512,93 @@</span>
<a href="#l55.319"></a><span id="l55.319">           }</span>
<a href="#l55.320"></a><span id="l55.320"> </span>
<a href="#l55.321"></a><span id="l55.321">           if (aEvent) {</span>
<a href="#l55.322"></a><span id="l55.322">             aEvent.preventDefault();</span>
<a href="#l55.323"></a><span id="l55.323">             aEvent.stopPropagation();</span>
<a href="#l55.324"></a><span id="l55.324">           }</span>
<a href="#l55.325"></a><span id="l55.325">         ]]&gt;&lt;/body&gt;</span>
<a href="#l55.326"></a><span id="l55.326">       &lt;/method&gt;</span>
<a href="#l55.327"></a><span id="l55.327" class="difflineplus">+      &lt;method name=&quot;getTabInfoForCurrentOrFirstModeInstance&quot;&gt;</span>
<a href="#l55.328"></a><span id="l55.328" class="difflineplus">+        &lt;parameter name=&quot;aTabMode&quot;/&gt;</span>
<a href="#l55.329"></a><span id="l55.329" class="difflineplus">+        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l55.330"></a><span id="l55.330" class="difflineplus">+        /**</span>
<a href="#l55.331"></a><span id="l55.331" class="difflineplus">+         * If the current/most recent tab is of mode aTabModeName, return its</span>
<a href="#l55.332"></a><span id="l55.332" class="difflineplus">+         *  tab info, otherwise return the tab info for the first tab of the</span>
<a href="#l55.333"></a><span id="l55.333" class="difflineplus">+         *  given mode.</span>
<a href="#l55.334"></a><span id="l55.334" class="difflineplus">+         * You would want to use this method when you would like to mimic the</span>
<a href="#l55.335"></a><span id="l55.335" class="difflineplus">+         *  settings of an existing instance of your mode.  In such a case,</span>
<a href="#l55.336"></a><span id="l55.336" class="difflineplus">+         *  it is reasonable to assume that if the 'current' tab was of the</span>
<a href="#l55.337"></a><span id="l55.337" class="difflineplus">+         *  same mode that its settings should be used.  Otherwise, we must</span>
<a href="#l55.338"></a><span id="l55.338" class="difflineplus">+         *  fall back to another tab.  We currently choose the first tab of</span>
<a href="#l55.339"></a><span id="l55.339" class="difflineplus">+         *  the instance, because for the &quot;folder&quot; tab, it is the canonical tab.</span>
<a href="#l55.340"></a><span id="l55.340" class="difflineplus">+         *  In other cases, having an MRU order and choosing the MRU tab might</span>
<a href="#l55.341"></a><span id="l55.341" class="difflineplus">+         *  be more appropriate.</span>
<a href="#l55.342"></a><span id="l55.342" class="difflineplus">+         *</span>
<a href="#l55.343"></a><span id="l55.343" class="difflineplus">+         * @return the tab info object for the tab meeting the above criteria,</span>
<a href="#l55.344"></a><span id="l55.344" class="difflineplus">+         *     or null if no such tab exists.</span>
<a href="#l55.345"></a><span id="l55.345" class="difflineplus">+         */</span>
<a href="#l55.346"></a><span id="l55.346" class="difflineplus">+          if (this._mostRecentTabInfo &amp;&amp;</span>
<a href="#l55.347"></a><span id="l55.347" class="difflineplus">+              this._mostRecentTabInfo.mode == aTabMode)</span>
<a href="#l55.348"></a><span id="l55.348" class="difflineplus">+            return this._mostRecentTabInfo;</span>
<a href="#l55.349"></a><span id="l55.349" class="difflineplus">+          else if (aTabMode.tabs.length)</span>
<a href="#l55.350"></a><span id="l55.350" class="difflineplus">+            return aTabMode.tabs[0];</span>
<a href="#l55.351"></a><span id="l55.351" class="difflineplus">+          else</span>
<a href="#l55.352"></a><span id="l55.352" class="difflineplus">+            return null;</span>
<a href="#l55.353"></a><span id="l55.353" class="difflineplus">+        ]]&gt;&lt;/body&gt;</span>
<a href="#l55.354"></a><span id="l55.354" class="difflineplus">+      &lt;/method&gt;</span>
<a href="#l55.355"></a><span id="l55.355" class="difflineplus">+      &lt;method name=&quot;closeTab&quot;&gt;</span>
<a href="#l55.356"></a><span id="l55.356" class="difflineplus">+        &lt;parameter name=&quot;aOptTabIndexNodeOrInfo&quot;/&gt;</span>
<a href="#l55.357"></a><span id="l55.357" class="difflineplus">+        &lt;body&gt;</span>
<a href="#l55.358"></a><span id="l55.358" class="difflineplus">+          &lt;![CDATA[</span>
<a href="#l55.359"></a><span id="l55.359" class="difflineplus">+            let [iTab, tab, tabNode] =</span>
<a href="#l55.360"></a><span id="l55.360" class="difflineplus">+              this._getTabContextForTabbyThing(aOptTabIndexNodeOrInfo, true);</span>
<a href="#l55.361"></a><span id="l55.361" class="difflineplus">+</span>
<a href="#l55.362"></a><span id="l55.362" class="difflineplus">+            if (!tab.canClose)</span>
<a href="#l55.363"></a><span id="l55.363" class="difflineplus">+              return;</span>
<a href="#l55.364"></a><span id="l55.364" class="difflineplus">+            </span>
<a href="#l55.365"></a><span id="l55.365" class="difflineplus">+            let closeFunc = tab.mode.closeTab || tab.mode.tabType.closeTab;</span>
<a href="#l55.366"></a><span id="l55.366" class="difflineplus">+            closeFunc.call(tab.mode.tabType, tab);</span>
<a href="#l55.367"></a><span id="l55.367" class="difflineplus">+             </span>
<a href="#l55.368"></a><span id="l55.368" class="difflineplus">+            this.tabInfo.splice(iTab, 1);</span>
<a href="#l55.369"></a><span id="l55.369" class="difflineplus">+            tab.mode.tabs.splice(tab.mode.tabs.indexOf(tab), 1);</span>
<a href="#l55.370"></a><span id="l55.370" class="difflineplus">+            this.tabContainer.removeChild(tabNode);</span>
<a href="#l55.371"></a><span id="l55.371" class="difflineplus">+            if (this.tabContainer.selectedIndex == -1)</span>
<a href="#l55.372"></a><span id="l55.372" class="difflineplus">+              this.tabContainer.selectedIndex =</span>
<a href="#l55.373"></a><span id="l55.373" class="difflineplus">+                (iTab == this.tabContainer.childNodes.length) ? iTab - 1 : iTab;</span>
<a href="#l55.374"></a><span id="l55.374" class="difflineplus">+            if (this.currentTabInfo == tab)</span>
<a href="#l55.375"></a><span id="l55.375" class="difflineplus">+              this.updateCurrentTab();</span>
<a href="#l55.376"></a><span id="l55.376" class="difflineplus">+              </span>
<a href="#l55.377"></a><span id="l55.377" class="difflineplus">+            if (tab.panel) {</span>
<a href="#l55.378"></a><span id="l55.378" class="difflineplus">+              this.panelContainer.removeChild(tab.panel);</span>
<a href="#l55.379"></a><span id="l55.379" class="difflineplus">+              delete tab.panel;</span>
<a href="#l55.380"></a><span id="l55.380" class="difflineplus">+            }</span>
<a href="#l55.381"></a><span id="l55.381" class="difflineplus">+            if (this.tabContainer.childNodes.length == 1 &amp;&amp;</span>
<a href="#l55.382"></a><span id="l55.382" class="difflineplus">+                this.tabContainer.mAutoHide)</span>
<a href="#l55.383"></a><span id="l55.383" class="difflineplus">+              this.tabContainer.collapsed = true;</span>
<a href="#l55.384"></a><span id="l55.384" class="difflineplus">+          ]]&gt;</span>
<a href="#l55.385"></a><span id="l55.385" class="difflineplus">+        &lt;/body&gt;</span>
<a href="#l55.386"></a><span id="l55.386" class="difflineplus">+      &lt;/method&gt;</span>
<a href="#l55.387"></a><span id="l55.387">       &lt;method name=&quot;closeTabs&quot;&gt;</span>
<a href="#l55.388"></a><span id="l55.388">         &lt;body&gt;</span>
<a href="#l55.389"></a><span id="l55.389">           &lt;![CDATA[</span>
<a href="#l55.390"></a><span id="l55.390">             for (var i = 0; i &lt; this.tabInfo.length; i++) {</span>
<a href="#l55.391"></a><span id="l55.391">               let tab = this.tabInfo[i];</span>
<a href="#l55.392"></a><span id="l55.392">               </span>
<a href="#l55.393"></a><span id="l55.393">               let tabCloseFunc = tab.mode.closeTab || tab.mode.tabType.closeTab;</span>
<a href="#l55.394"></a><span id="l55.394">               tabCloseFunc.call(tab.mode.tabType, tab);</span>
<a href="#l55.395"></a><span id="l55.395">             }</span>
<a href="#l55.396"></a><span id="l55.396">           ]]&gt;</span>
<a href="#l55.397"></a><span id="l55.397">         &lt;/body&gt;</span>
<a href="#l55.398"></a><span id="l55.398">       &lt;/method&gt;</span>
<a href="#l55.399"></a><span id="l55.399">       &lt;method name=&quot;removeTabByNode&quot;&gt;</span>
<a href="#l55.400"></a><span id="l55.400">         &lt;parameter name=&quot;aTabNode&quot;/&gt;</span>
<a href="#l55.401"></a><span id="l55.401">         &lt;body&gt;</span>
<a href="#l55.402"></a><span id="l55.402">           &lt;![CDATA[</span>
<a href="#l55.403"></a><span id="l55.403" class="difflineminus">-            // Find and locate the tab in our list.</span>
<a href="#l55.404"></a><span id="l55.404" class="difflineminus">-            let iTab, numTabs = this.tabContainer.childNodes.length;</span>
<a href="#l55.405"></a><span id="l55.405" class="difflineminus">-            for (iTab = 0; iTab &lt; numTabs; iTab++)</span>
<a href="#l55.406"></a><span id="l55.406" class="difflineminus">-              if (this.tabContainer.childNodes[iTab] == aTabNode)</span>
<a href="#l55.407"></a><span id="l55.407" class="difflineminus">-                break;</span>
<a href="#l55.408"></a><span id="l55.408" class="difflineminus">-            let tab = this.tabInfo[iTab];</span>
<a href="#l55.409"></a><span id="l55.409" class="difflineminus">-</span>
<a href="#l55.410"></a><span id="l55.410" class="difflineminus">-            if (!tab.canClose)</span>
<a href="#l55.411"></a><span id="l55.411" class="difflineminus">-              return;</span>
<a href="#l55.412"></a><span id="l55.412" class="difflineminus">-            </span>
<a href="#l55.413"></a><span id="l55.413" class="difflineminus">-            let closeFunc = tab.mode.closeTab || tab.mode.tabType.closeTab;</span>
<a href="#l55.414"></a><span id="l55.414" class="difflineminus">-            closeFunc.call(tab.mode.tabType, tab);</span>
<a href="#l55.415"></a><span id="l55.415" class="difflineminus">-             </span>
<a href="#l55.416"></a><span id="l55.416" class="difflineminus">-            this.tabInfo.splice(iTab, 1);</span>
<a href="#l55.417"></a><span id="l55.417" class="difflineminus">-            tab.mode.tabs.splice(tab.mode.tabs.indexOf(tab), 1);</span>
<a href="#l55.418"></a><span id="l55.418" class="difflineminus">-            this.tabContainer.removeChild(aTabNode);</span>
<a href="#l55.419"></a><span id="l55.419" class="difflineminus">-            if (this.tabContainer.selectedIndex == -1)</span>
<a href="#l55.420"></a><span id="l55.420" class="difflineminus">-              this.tabContainer.selectedIndex = (iTab == --numTabs) ?</span>
<a href="#l55.421"></a><span id="l55.421" class="difflineminus">-                iTab - 1 : iTab;</span>
<a href="#l55.422"></a><span id="l55.422" class="difflineminus">-            if (this.currentTabInfo == tab)</span>
<a href="#l55.423"></a><span id="l55.423" class="difflineminus">-              this.updateCurrentTab();</span>
<a href="#l55.424"></a><span id="l55.424" class="difflineminus">-              </span>
<a href="#l55.425"></a><span id="l55.425" class="difflineminus">-            if (tab.panel) {</span>
<a href="#l55.426"></a><span id="l55.426" class="difflineminus">-              this.panelContainer.removeChild(tab.panel);</span>
<a href="#l55.427"></a><span id="l55.427" class="difflineminus">-              delete tab.panel;</span>
<a href="#l55.428"></a><span id="l55.428" class="difflineminus">-            }</span>
<a href="#l55.429"></a><span id="l55.429" class="difflineminus">-            if (numTabs == 1 &amp;&amp; this.tabContainer.mAutoHide)</span>
<a href="#l55.430"></a><span id="l55.430" class="difflineminus">-              this.tabContainer.collapsed = true;</span>
<a href="#l55.431"></a><span id="l55.431" class="difflineplus">+            this.closeTab(aTabNode);</span>
<a href="#l55.432"></a><span id="l55.432">           ]]&gt;</span>
<a href="#l55.433"></a><span id="l55.433">         &lt;/body&gt;</span>
<a href="#l55.434"></a><span id="l55.434">       &lt;/method&gt;</span>
<a href="#l55.435"></a><span id="l55.435">       &lt;!-- getBrowserForSelectedTab is required as some toolkit functions</span>
<a href="#l55.436"></a><span id="l55.436">            require a getBrowser() function. --&gt;</span>
<a href="#l55.437"></a><span id="l55.437">       &lt;method name=&quot;getBrowserForSelectedTab&quot;&gt;</span>
<a href="#l55.438"></a><span id="l55.438">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l55.439"></a><span id="l55.439">           if (!this.currentTabInfo)</span>
<a href="#l55.440"></a><span id="l55.440" class="difflineat">@@ -506,16 +614,27 @@</span>
<a href="#l55.441"></a><span id="l55.441">         ]]&gt;&lt;/body&gt;</span>
<a href="#l55.442"></a><span id="l55.442">       &lt;/method&gt;</span>
<a href="#l55.443"></a><span id="l55.443">       &lt;method name=&quot;removeCurrentTab&quot;&gt;</span>
<a href="#l55.444"></a><span id="l55.444">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l55.445"></a><span id="l55.445">           this.removeTabByNode(</span>
<a href="#l55.446"></a><span id="l55.446">             this.tabContainer.childNodes[this.tabContainer.selectedIndex]);</span>
<a href="#l55.447"></a><span id="l55.447">         ]]&gt;&lt;/body&gt;</span>
<a href="#l55.448"></a><span id="l55.448">       &lt;/method&gt;</span>
<a href="#l55.449"></a><span id="l55.449" class="difflineplus">+      &lt;method name=&quot;switchToTab&quot;&gt;</span>
<a href="#l55.450"></a><span id="l55.450" class="difflineplus">+        &lt;parameter name=&quot;aTabIndexNodeOrInfo&quot;/&gt;</span>
<a href="#l55.451"></a><span id="l55.451" class="difflineplus">+        &lt;body&gt;</span>
<a href="#l55.452"></a><span id="l55.452" class="difflineplus">+          &lt;![CDATA[</span>
<a href="#l55.453"></a><span id="l55.453" class="difflineplus">+            let [iTab, tab, tabNode] =</span>
<a href="#l55.454"></a><span id="l55.454" class="difflineplus">+              this._getTabContextForTabbyThing(aTabIndexNodeOrInfo, false);</span>
<a href="#l55.455"></a><span id="l55.455" class="difflineplus">+</span>
<a href="#l55.456"></a><span id="l55.456" class="difflineplus">+            this.tabContainer.selectedIndex = iTab;</span>
<a href="#l55.457"></a><span id="l55.457" class="difflineplus">+          ]]&gt;</span>
<a href="#l55.458"></a><span id="l55.458" class="difflineplus">+        &lt;/body&gt;</span>
<a href="#l55.459"></a><span id="l55.459" class="difflineplus">+      &lt;/method&gt;</span>
<a href="#l55.460"></a><span id="l55.460">       &lt;!--  UpdateCurrentTab - called in response to changing the current tab --&gt;</span>
<a href="#l55.461"></a><span id="l55.461">       &lt;method name=&quot;updateCurrentTab&quot;&gt;</span>
<a href="#l55.462"></a><span id="l55.462">         &lt;body&gt;</span>
<a href="#l55.463"></a><span id="l55.463">           &lt;![CDATA[</span>
<a href="#l55.464"></a><span id="l55.464">             if (this.currentTabInfo != this.tabInfo[this.tabContainer.selectedIndex])</span>
<a href="#l55.465"></a><span id="l55.465">             {</span>
<a href="#l55.466"></a><span id="l55.466">               if (this.currentTabInfo)</span>
<a href="#l55.467"></a><span id="l55.467">                 this.saveCurrentTabState();</span>
<a href="#l55.468"></a><span id="l55.468" class="difflineat">@@ -530,21 +649,29 @@</span>
<a href="#l55.469"></a><span id="l55.469">               let showTabFunc = tab.mode.showTab || tab.mode.tabType.showTab;</span>
<a href="#l55.470"></a><span id="l55.470">               showTabFunc.call(tab.mode.tabType, tab);</span>
<a href="#l55.471"></a><span id="l55.471"> </span>
<a href="#l55.472"></a><span id="l55.472">               if (this.tabMonitors.length) {</span>
<a href="#l55.473"></a><span id="l55.473">                 for each (let [i, tabMonitor] in Iterator(this.tabMonitors))</span>
<a href="#l55.474"></a><span id="l55.474">                   tabMonitor.onTabSwitched(tab, oldTab);</span>
<a href="#l55.475"></a><span id="l55.475">               }</span>
<a href="#l55.476"></a><span id="l55.476"> </span>
<a href="#l55.477"></a><span id="l55.477" class="difflineplus">+              // always update the cursor status when we switch tabs</span>
<a href="#l55.478"></a><span id="l55.478" class="difflineplus">+              SetBusyCursor(window, tab.busy);</span>
<a href="#l55.479"></a><span id="l55.479" class="difflineplus">+              // active tabs should not have the wasBusy attribute</span>
<a href="#l55.480"></a><span id="l55.480" class="difflineplus">+              this.tabContainer.selectedItem.removeAttribute(&quot;wasBusy&quot;);</span>
<a href="#l55.481"></a><span id="l55.481" class="difflineplus">+</span>
<a href="#l55.482"></a><span id="l55.482" class="difflineplus">+              // update the thinking status when we switch tabs</span>
<a href="#l55.483"></a><span id="l55.483" class="difflineplus">+              this._setActiveThinkingState(tab.thinking);</span>
<a href="#l55.484"></a><span id="l55.484" class="difflineplus">+              // active tabs should not have the wasThinking attribute</span>
<a href="#l55.485"></a><span id="l55.485" class="difflineplus">+              this.tabContainer.selectedItem.removeAttribute(&quot;wasThinking&quot;);</span>
<a href="#l55.486"></a><span id="l55.486"> </span>
<a href="#l55.487"></a><span id="l55.487">               let docTitle = tab.title;</span>
<a href="#l55.488"></a><span id="l55.488" class="difflineminus">-#ifndef XP_MACOSX</span>
<a href="#l55.489"></a><span id="l55.489" class="difflineminus">-              docTitle += &quot; - &quot; + gBrandBundle.getString(&quot;brandFullName&quot;);</span>
<a href="#l55.490"></a><span id="l55.490" class="difflineminus">-#endif</span>
<a href="#l55.491"></a><span id="l55.491" class="difflineplus">+              if (!gPlatformOSX)</span>
<a href="#l55.492"></a><span id="l55.492" class="difflineplus">+                docTitle += &quot; - &quot; + gBrandBundle.getString(&quot;brandFullName&quot;);</span>
<a href="#l55.493"></a><span id="l55.493">               document.title = docTitle;</span>
<a href="#l55.494"></a><span id="l55.494"> </span>
<a href="#l55.495"></a><span id="l55.495">               // Update the toolbar status - we don't need to do menus as they</span>
<a href="#l55.496"></a><span id="l55.496">               // do themselves when we open them.</span>
<a href="#l55.497"></a><span id="l55.497">               UpdateMailToolbar(&quot;tabmail&quot;);</span>
<a href="#l55.498"></a><span id="l55.498">             }</span>
<a href="#l55.499"></a><span id="l55.499">           ]]&gt;</span>
<a href="#l55.500"></a><span id="l55.500">         &lt;/body&gt;</span>
<a href="#l55.501"></a><span id="l55.501" class="difflineat">@@ -571,64 +698,129 @@</span>
<a href="#l55.502"></a><span id="l55.502">             if (event.button != 1 || event.target.localName != 'tab')</span>
<a href="#l55.503"></a><span id="l55.503">               return;</span>
<a href="#l55.504"></a><span id="l55.504">             this.removeTabByNode(event.target);</span>
<a href="#l55.505"></a><span id="l55.505">             event.stopPropagation();</span>
<a href="#l55.506"></a><span id="l55.506">           ]]&gt;</span>
<a href="#l55.507"></a><span id="l55.507">         &lt;/body&gt;</span>
<a href="#l55.508"></a><span id="l55.508">       &lt;/method&gt;</span>
<a href="#l55.509"></a><span id="l55.509">       &lt;method name=&quot;setTabTitle&quot;&gt;</span>
<a href="#l55.510"></a><span id="l55.510" class="difflineminus">-        &lt;parameter name=&quot;aTab&quot;/&gt;</span>
<a href="#l55.511"></a><span id="l55.511" class="difflineplus">+        &lt;parameter name=&quot;aTabNodeOrInfo&quot;/&gt;</span>
<a href="#l55.512"></a><span id="l55.512">         &lt;body&gt;</span>
<a href="#l55.513"></a><span id="l55.513">           &lt;![CDATA[</span>
<a href="#l55.514"></a><span id="l55.514" class="difflineminus">-            // First find the tab and its index.</span>
<a href="#l55.515"></a><span id="l55.515" class="difflineminus">-            let tab;</span>
<a href="#l55.516"></a><span id="l55.516" class="difflineminus">-            let index;</span>
<a href="#l55.517"></a><span id="l55.517" class="difflineminus">-            if (aTab) {</span>
<a href="#l55.518"></a><span id="l55.518" class="difflineminus">-              tab = aTab;</span>
<a href="#l55.519"></a><span id="l55.519" class="difflineminus">-              for (index = 0; index &lt; this.tabInfo.length; ++index) {</span>
<a href="#l55.520"></a><span id="l55.520" class="difflineminus">-                if (tab == this.tabInfo[index])</span>
<a href="#l55.521"></a><span id="l55.521" class="difflineminus">-                  break;</span>
<a href="#l55.522"></a><span id="l55.522" class="difflineminus">-              }</span>
<a href="#l55.523"></a><span id="l55.523" class="difflineminus">-            }</span>
<a href="#l55.524"></a><span id="l55.524" class="difflineminus">-            else {</span>
<a href="#l55.525"></a><span id="l55.525" class="difflineminus">-              index = this.tabContainer.selectedIndex;</span>
<a href="#l55.526"></a><span id="l55.526" class="difflineminus">-              tab = this.tabInfo[index];</span>
<a href="#l55.527"></a><span id="l55.527" class="difflineminus">-            }</span>
<a href="#l55.528"></a><span id="l55.528" class="difflineplus">+            let [iTab, tab, tabNode] =</span>
<a href="#l55.529"></a><span id="l55.529" class="difflineplus">+              this._getTabContextForTabbyThing(aTabNodeOrInfo, true);</span>
<a href="#l55.530"></a><span id="l55.530"> </span>
<a href="#l55.531"></a><span id="l55.531" class="difflineminus">-            // on startup, we may not have a tab...</span>
<a href="#l55.532"></a><span id="l55.532">             if (tab)</span>
<a href="#l55.533"></a><span id="l55.533">             {</span>
<a href="#l55.534"></a><span id="l55.534">               let tabNode =</span>
<a href="#l55.535"></a><span id="l55.535" class="difflineminus">-                this.tabContainer.childNodes[index];</span>
<a href="#l55.536"></a><span id="l55.536" class="difflineplus">+                this.tabContainer.childNodes[iTab];</span>
<a href="#l55.537"></a><span id="l55.537"> </span>
<a href="#l55.538"></a><span id="l55.538">               let titleChangeFunc = tab.mode.onTitleChanged ||</span>
<a href="#l55.539"></a><span id="l55.539">                                     tab.mode.tabType.onTitleChanged;</span>
<a href="#l55.540"></a><span id="l55.540">               if (titleChangeFunc)</span>
<a href="#l55.541"></a><span id="l55.541">                 titleChangeFunc.call(tab.mode.tabType, tab, tabNode);</span>
<a href="#l55.542"></a><span id="l55.542"> </span>
<a href="#l55.543"></a><span id="l55.543">               if (this.tabMonitors.length) {</span>
<a href="#l55.544"></a><span id="l55.544" class="difflineminus">-                for each (let [index, tabMonitor] in Iterator(this.tabMonitors))</span>
<a href="#l55.545"></a><span id="l55.545" class="difflineplus">+                for each (let [, tabMonitor] in Iterator(this.tabMonitors))</span>
<a href="#l55.546"></a><span id="l55.546">                   tabMonitor.onTabTitleChanged(tab);</span>
<a href="#l55.547"></a><span id="l55.547">               }</span>
<a href="#l55.548"></a><span id="l55.548"> </span>
<a href="#l55.549"></a><span id="l55.549">               tabNode.setAttribute(&quot;label&quot;, tab.title);</span>
<a href="#l55.550"></a><span id="l55.550"> </span>
<a href="#l55.551"></a><span id="l55.551">               // Update the window title if we're the displayed tab.</span>
<a href="#l55.552"></a><span id="l55.552" class="difflineminus">-              if (index == this.tabContainer.selectedIndex) {</span>
<a href="#l55.553"></a><span id="l55.553" class="difflineplus">+              if (iTab == this.tabContainer.selectedIndex) {</span>
<a href="#l55.554"></a><span id="l55.554">                 let docTitle = tab.title;</span>
<a href="#l55.555"></a><span id="l55.555" class="difflineminus">-#ifndef XP_MACOSX</span>
<a href="#l55.556"></a><span id="l55.556" class="difflineminus">-                docTitle += &quot; - &quot; + gBrandBundle.getString(&quot;brandFullName&quot;);</span>
<a href="#l55.557"></a><span id="l55.557" class="difflineminus">-#endif</span>
<a href="#l55.558"></a><span id="l55.558" class="difflineplus">+                if (!gPlatformOSX)</span>
<a href="#l55.559"></a><span id="l55.559" class="difflineplus">+                  docTitle += &quot; - &quot; + gBrandBundle.getString(&quot;brandFullName&quot;);</span>
<a href="#l55.560"></a><span id="l55.560">                 document.title = docTitle;</span>
<a href="#l55.561"></a><span id="l55.561">               }</span>
<a href="#l55.562"></a><span id="l55.562">             }</span>
<a href="#l55.563"></a><span id="l55.563">           ]]&gt;</span>
<a href="#l55.564"></a><span id="l55.564">         &lt;/body&gt;</span>
<a href="#l55.565"></a><span id="l55.565">       &lt;/method&gt;</span>
<a href="#l55.566"></a><span id="l55.566" class="difflineplus">+      &lt;!--</span>
<a href="#l55.567"></a><span id="l55.567" class="difflineplus">+        - Updates the global state to reflect the active tab's thinking</span>
<a href="#l55.568"></a><span id="l55.568" class="difflineplus">+        -   state (which the caller provides).</span>
<a href="#l55.569"></a><span id="l55.569" class="difflineplus">+        --&gt;</span>
<a href="#l55.570"></a><span id="l55.570" class="difflineplus">+      &lt;method name=&quot;_setActiveThinkingState&quot;&gt;</span>
<a href="#l55.571"></a><span id="l55.571" class="difflineplus">+        &lt;parameter name=&quot;aThinkingState&quot;/&gt;</span>
<a href="#l55.572"></a><span id="l55.572" class="difflineplus">+        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l55.573"></a><span id="l55.573" class="difflineplus">+          if (aThinkingState) {</span>
<a href="#l55.574"></a><span id="l55.574" class="difflineplus">+            statusFeedback.showProgress(0);</span>
<a href="#l55.575"></a><span id="l55.575" class="difflineplus">+            if (typeof(aThinkingState) == &quot;string&quot;)</span>
<a href="#l55.576"></a><span id="l55.576" class="difflineplus">+              statusFeedback.showStatusString(aThinkingState);</span>
<a href="#l55.577"></a><span id="l55.577" class="difflineplus">+            gStatusBar.setAttribute(&quot;mode&quot;,&quot;undetermined&quot;);</span>
<a href="#l55.578"></a><span id="l55.578" class="difflineplus">+          }</span>
<a href="#l55.579"></a><span id="l55.579" class="difflineplus">+          else {</span>
<a href="#l55.580"></a><span id="l55.580" class="difflineplus">+            statusFeedback.showProgress(0);</span>
<a href="#l55.581"></a><span id="l55.581" class="difflineplus">+            gStatusBar.setAttribute(&quot;mode&quot;, &quot;normal&quot;);</span>
<a href="#l55.582"></a><span id="l55.582" class="difflineplus">+          }</span>
<a href="#l55.583"></a><span id="l55.583" class="difflineplus">+        ]]&gt;&lt;/body&gt;</span>
<a href="#l55.584"></a><span id="l55.584" class="difflineplus">+      &lt;/method&gt;</span>
<a href="#l55.585"></a><span id="l55.585" class="difflineplus">+      &lt;method name=&quot;setTabThinking&quot;&gt;</span>
<a href="#l55.586"></a><span id="l55.586" class="difflineplus">+        &lt;parameter name=&quot;aTabNodeOrInfo&quot;/&gt;</span>
<a href="#l55.587"></a><span id="l55.587" class="difflineplus">+        &lt;parameter name=&quot;aThinking&quot;/&gt;</span>
<a href="#l55.588"></a><span id="l55.588" class="difflineplus">+        &lt;body&gt;</span>
<a href="#l55.589"></a><span id="l55.589" class="difflineplus">+          &lt;![CDATA[</span>
<a href="#l55.590"></a><span id="l55.590" class="difflineplus">+            let [iTab, tab, tabNode] = this._getTabContextForTabbyThing(</span>
<a href="#l55.591"></a><span id="l55.591" class="difflineplus">+                                         aTabNodeOrInfo, false);</span>
<a href="#l55.592"></a><span id="l55.592" class="difflineplus">+            let isSelected = (iTab == this.tabContainer.selectedIndex);</span>
<a href="#l55.593"></a><span id="l55.593" class="difflineplus">+</span>
<a href="#l55.594"></a><span id="l55.594" class="difflineplus">+            // if we are the current tab, update the cursor</span>
<a href="#l55.595"></a><span id="l55.595" class="difflineplus">+            if (isSelected)</span>
<a href="#l55.596"></a><span id="l55.596" class="difflineplus">+              this._setActiveThinkingState(aThinking);</span>
<a href="#l55.597"></a><span id="l55.597" class="difflineplus">+</span>
<a href="#l55.598"></a><span id="l55.598" class="difflineplus">+            // if we are busy, hint our tab</span>
<a href="#l55.599"></a><span id="l55.599" class="difflineplus">+            if (aThinking) {</span>
<a href="#l55.600"></a><span id="l55.600" class="difflineplus">+              tabNode.setAttribute(&quot;thinking&quot;, &quot;true&quot;);</span>
<a href="#l55.601"></a><span id="l55.601" class="difflineplus">+            }</span>
<a href="#l55.602"></a><span id="l55.602" class="difflineplus">+            else {</span>
<a href="#l55.603"></a><span id="l55.603" class="difflineplus">+              // if we were thinking and are not selected, set the</span>
<a href="#l55.604"></a><span id="l55.604" class="difflineplus">+              //  &quot;wasThinking&quot; attribute.</span>
<a href="#l55.605"></a><span id="l55.605" class="difflineplus">+              if (tab.thinking &amp;&amp; !isSelected)</span>
<a href="#l55.606"></a><span id="l55.606" class="difflineplus">+                tabNode.setAttribute(&quot;wasThinking&quot;, &quot;true&quot;);</span>
<a href="#l55.607"></a><span id="l55.607" class="difflineplus">+              tabNode.removeAttribute(&quot;thinking&quot;);</span>
<a href="#l55.608"></a><span id="l55.608" class="difflineplus">+            }</span>
<a href="#l55.609"></a><span id="l55.609" class="difflineplus">+</span>
<a href="#l55.610"></a><span id="l55.610" class="difflineplus">+            // update the tab info to store the busy state.</span>
<a href="#l55.611"></a><span id="l55.611" class="difflineplus">+            tab.thinking = aThinking;</span>
<a href="#l55.612"></a><span id="l55.612" class="difflineplus">+          ]]&gt;</span>
<a href="#l55.613"></a><span id="l55.613" class="difflineplus">+        &lt;/body&gt;</span>
<a href="#l55.614"></a><span id="l55.614" class="difflineplus">+      &lt;/method&gt;</span>
<a href="#l55.615"></a><span id="l55.615" class="difflineplus">+      &lt;method name=&quot;setTabBusy&quot;&gt;</span>
<a href="#l55.616"></a><span id="l55.616" class="difflineplus">+        &lt;parameter name=&quot;aTabNodeOrInfo&quot;/&gt;</span>
<a href="#l55.617"></a><span id="l55.617" class="difflineplus">+        &lt;parameter name=&quot;aBusy&quot;/&gt;</span>
<a href="#l55.618"></a><span id="l55.618" class="difflineplus">+        &lt;body&gt;</span>
<a href="#l55.619"></a><span id="l55.619" class="difflineplus">+          &lt;![CDATA[</span>
<a href="#l55.620"></a><span id="l55.620" class="difflineplus">+            let [iTab, tab, tabNode] = this._getTabContextForTabbyThing(</span>
<a href="#l55.621"></a><span id="l55.621" class="difflineplus">+                                         aTabNodeOrInfo, false);</span>
<a href="#l55.622"></a><span id="l55.622" class="difflineplus">+            let isSelected = (iTab == this.tabContainer.selectedIndex);</span>
<a href="#l55.623"></a><span id="l55.623" class="difflineplus">+</span>
<a href="#l55.624"></a><span id="l55.624" class="difflineplus">+            // if we are the current tab, update the cursor</span>
<a href="#l55.625"></a><span id="l55.625" class="difflineplus">+            if (isSelected)</span>
<a href="#l55.626"></a><span id="l55.626" class="difflineplus">+              SetBusyCursor(window, aBusy);</span>
<a href="#l55.627"></a><span id="l55.627" class="difflineplus">+</span>
<a href="#l55.628"></a><span id="l55.628" class="difflineplus">+            // if we are busy, hint our tab</span>
<a href="#l55.629"></a><span id="l55.629" class="difflineplus">+            if (aBusy) {</span>
<a href="#l55.630"></a><span id="l55.630" class="difflineplus">+              tabNode.setAttribute(&quot;busy&quot;, &quot;true&quot;);</span>
<a href="#l55.631"></a><span id="l55.631" class="difflineplus">+            }</span>
<a href="#l55.632"></a><span id="l55.632" class="difflineplus">+            else {</span>
<a href="#l55.633"></a><span id="l55.633" class="difflineplus">+              // if we were busy and are not selected, set the</span>
<a href="#l55.634"></a><span id="l55.634" class="difflineplus">+              //  &quot;wasBusy&quot; attribute.</span>
<a href="#l55.635"></a><span id="l55.635" class="difflineplus">+              if (tab.busy &amp;&amp; !isSelected)</span>
<a href="#l55.636"></a><span id="l55.636" class="difflineplus">+                tabNode.setAttribute(&quot;wasBusy&quot;, &quot;true&quot;);</span>
<a href="#l55.637"></a><span id="l55.637" class="difflineplus">+              tabNode.removeAttribute(&quot;busy&quot;);</span>
<a href="#l55.638"></a><span id="l55.638" class="difflineplus">+            }</span>
<a href="#l55.639"></a><span id="l55.639" class="difflineplus">+</span>
<a href="#l55.640"></a><span id="l55.640" class="difflineplus">+            // update the tab info to store the busy state.</span>
<a href="#l55.641"></a><span id="l55.641" class="difflineplus">+            tab.busy = aBusy;</span>
<a href="#l55.642"></a><span id="l55.642" class="difflineplus">+          ]]&gt;</span>
<a href="#l55.643"></a><span id="l55.643" class="difflineplus">+        &lt;/body&gt;</span>
<a href="#l55.644"></a><span id="l55.644" class="difflineplus">+      &lt;/method&gt;</span>
<a href="#l55.645"></a><span id="l55.645">       &lt;method name=&quot;onTabContextMenuShowing&quot;&gt;</span>
<a href="#l55.646"></a><span id="l55.646">         &lt;parameter name=&quot;aTabNode&quot;/&gt;</span>
<a href="#l55.647"></a><span id="l55.647">         &lt;body&gt;</span>
<a href="#l55.648"></a><span id="l55.648">           &lt;![CDATA[</span>
<a href="#l55.649"></a><span id="l55.649">             // To determine whether the 'Close Tab' context menu should be</span>
<a href="#l55.650"></a><span id="l55.650">             // visible according to the tab node that was being clicked on.</span>
<a href="#l55.651"></a><span id="l55.651">             // If the tab node is not closable, the context menu should not</span>
<a href="#l55.652"></a><span id="l55.652">             // be shown.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l56.1"></a><span id="l56.1" class="difflineminus">--- a/mail/base/content/threadPane.js</span>
<a href="#l56.2"></a><span id="l56.2" class="difflineplus">+++ b/mail/base/content/threadPane.js</span>
<a href="#l56.3"></a><span id="l56.3" class="difflineat">@@ -85,114 +85,16 @@ function ThreadPaneOnClick(event)</span>
<a href="#l56.4"></a><span id="l56.4">       else if (col.value.id == &quot;threadCol&quot; &amp;&amp; !event.shiftKey &amp;&amp;</span>
<a href="#l56.5"></a><span id="l56.5">           (event.ctrlKey || event.metaKey)) {</span>
<a href="#l56.6"></a><span id="l56.6">         gDBView.ExpandAndSelectThreadByIndex(row.value, true);</span>
<a href="#l56.7"></a><span id="l56.7">         event.stopPropagation();</span>
<a href="#l56.8"></a><span id="l56.8">       }</span>
<a href="#l56.9"></a><span id="l56.9">     }</span>
<a href="#l56.10"></a><span id="l56.10"> }</span>
<a href="#l56.11"></a><span id="l56.11"> </span>
<a href="#l56.12"></a><span id="l56.12" class="difflineminus">-function nsMsgDBViewCommandUpdater()</span>
<a href="#l56.13"></a><span id="l56.13" class="difflineminus">-{</span>
<a href="#l56.14"></a><span id="l56.14" class="difflineminus">-  _selectionSummarized: false;</span>
<a href="#l56.15"></a><span id="l56.15" class="difflineminus">-  _selectionTimeout: null;</span>
<a href="#l56.16"></a><span id="l56.16" class="difflineminus">-}</span>
<a href="#l56.17"></a><span id="l56.17" class="difflineminus">-</span>
<a href="#l56.18"></a><span id="l56.18" class="difflineminus">-nsMsgDBViewCommandUpdater.prototype = </span>
<a href="#l56.19"></a><span id="l56.19" class="difflineminus">-{</span>
<a href="#l56.20"></a><span id="l56.20" class="difflineminus">-  updateCommandStatus : function()</span>
<a href="#l56.21"></a><span id="l56.21" class="difflineminus">-    {</span>
<a href="#l56.22"></a><span id="l56.22" class="difflineminus">-      // the back end is smart and is only telling us to update command status</span>
<a href="#l56.23"></a><span id="l56.23" class="difflineminus">-      // when the # of items in the selection has actually changed.</span>
<a href="#l56.24"></a><span id="l56.24" class="difflineminus">-      UpdateMailToolbar(&quot;dbview driven, thread pane&quot;);</span>
<a href="#l56.25"></a><span id="l56.25" class="difflineminus">-    },</span>
<a href="#l56.26"></a><span id="l56.26" class="difflineminus">-</span>
<a href="#l56.27"></a><span id="l56.27" class="difflineminus">-  displayMessageChanged : function(aFolder, aSubject, aKeywords)</span>
<a href="#l56.28"></a><span id="l56.28" class="difflineminus">-  {</span>
<a href="#l56.29"></a><span id="l56.29" class="difflineminus">-    if (!gDBView.suppressMsgDisplay)</span>
<a href="#l56.30"></a><span id="l56.30" class="difflineminus">-      setTitleFromFolder(aFolder, aSubject);</span>
<a href="#l56.31"></a><span id="l56.31" class="difflineminus">-    ClearPendingReadTimer(); // we are loading / selecting a new message so kill the mark as read timer for the currently viewed message</span>
<a href="#l56.32"></a><span id="l56.32" class="difflineminus">-    gHaveLoadedMessage = true;</span>
<a href="#l56.33"></a><span id="l56.33" class="difflineminus">-    goUpdateCommand(&quot;button_junk&quot;);</span>
<a href="#l56.34"></a><span id="l56.34" class="difflineminus">-  },</span>
<a href="#l56.35"></a><span id="l56.35" class="difflineminus">-</span>
<a href="#l56.36"></a><span id="l56.36" class="difflineminus">-  updateNextMessageAfterDelete : function()</span>
<a href="#l56.37"></a><span id="l56.37" class="difflineminus">-  {</span>
<a href="#l56.38"></a><span id="l56.38" class="difflineminus">-    SetNextMessageAfterDelete();</span>
<a href="#l56.39"></a><span id="l56.39" class="difflineminus">-  },</span>
<a href="#l56.40"></a><span id="l56.40" class="difflineminus">-</span>
<a href="#l56.41"></a><span id="l56.41" class="difflineminus">- /**</span>
<a href="#l56.42"></a><span id="l56.42" class="difflineminus">-  * This method either handles the selection, or sets a timer to handle</span>
<a href="#l56.43"></a><span id="l56.43" class="difflineminus">-  * it once it stops changing.</span>
<a href="#l56.44"></a><span id="l56.44" class="difflineminus">-  */</span>
<a href="#l56.45"></a><span id="l56.45" class="difflineminus">-  showSummary: function(aThis, aSelCount)</span>
<a href="#l56.46"></a><span id="l56.46" class="difflineminus">-  {</span>
<a href="#l56.47"></a><span id="l56.47" class="difflineminus">-    aThis._selectionSummarized = true;</span>
<a href="#l56.48"></a><span id="l56.48" class="difflineminus">-    let selectedMsgUris = GetSelectedMessages();</span>
<a href="#l56.49"></a><span id="l56.49" class="difflineminus">-    let selCount = selectedMsgUris ? selectedMsgUris.length : 0;</span>
<a href="#l56.50"></a><span id="l56.50" class="difflineminus">-    if (selCount &lt; 2) {</span>
<a href="#l56.51"></a><span id="l56.51" class="difflineminus">-      aThis.summarizeSelection();</span>
<a href="#l56.52"></a><span id="l56.52" class="difflineminus">-      return;</span>
<a href="#l56.53"></a><span id="l56.53" class="difflineminus">-    }</span>
<a href="#l56.54"></a><span id="l56.54" class="difflineminus">-    if (selCount != aSelCount) {</span>
<a href="#l56.55"></a><span id="l56.55" class="difflineminus">-      clearTimeout(aThis._selectionTimeout);</span>
<a href="#l56.56"></a><span id="l56.56" class="difflineminus">-      aThis._selectionTimeout = setTimeout(aThis.showSummary, 100, aThis, selCount);</span>
<a href="#l56.57"></a><span id="l56.57" class="difflineminus">-      return;</span>
<a href="#l56.58"></a><span id="l56.58" class="difflineminus">-    }</span>
<a href="#l56.59"></a><span id="l56.59" class="difflineminus">-</span>
<a href="#l56.60"></a><span id="l56.60" class="difflineminus">-    let firstThreadId = messenger.msgHdrFromURI(selectedMsgUris[0]).threadId;</span>
<a href="#l56.61"></a><span id="l56.61" class="difflineminus">-    for (let i = 1; i &lt; selectedMsgUris.length; ++i)</span>
<a href="#l56.62"></a><span id="l56.62" class="difflineminus">-    {</span>
<a href="#l56.63"></a><span id="l56.63" class="difflineminus">-      let msgHdr = messenger.msgHdrFromURI(selectedMsgUris[i]);</span>
<a href="#l56.64"></a><span id="l56.64" class="difflineminus">-      if (msgHdr.threadId != firstThreadId) { // at least more than one thread</span>
<a href="#l56.65"></a><span id="l56.65" class="difflineminus">-        summarizeMultipleSelection(selectedMsgUris);</span>
<a href="#l56.66"></a><span id="l56.66" class="difflineminus">-        return;</span>
<a href="#l56.67"></a><span id="l56.67" class="difflineminus">-      }</span>
<a href="#l56.68"></a><span id="l56.68" class="difflineminus">-    }</span>
<a href="#l56.69"></a><span id="l56.69" class="difflineminus">-    // must be just one thread.</span>
<a href="#l56.70"></a><span id="l56.70" class="difflineminus">-    summarizeThread(selectedMsgUris);</span>
<a href="#l56.71"></a><span id="l56.71" class="difflineminus">-  },</span>
<a href="#l56.72"></a><span id="l56.72" class="difflineminus">-</span>
<a href="#l56.73"></a><span id="l56.73" class="difflineminus">-  summarizeSelection: function()</span>
<a href="#l56.74"></a><span id="l56.74" class="difflineminus">-  {</span>
<a href="#l56.75"></a><span id="l56.75" class="difflineminus">-    // First handle immediately the cases where we're not going to summarize.</span>
<a href="#l56.76"></a><span id="l56.76" class="difflineminus">-    let selectedMsgUris = GetSelectedMessages();</span>
<a href="#l56.77"></a><span id="l56.77" class="difflineminus">-    if (!selectedMsgUris || (selectedMsgUris.length == 1)) {</span>
<a href="#l56.78"></a><span id="l56.78" class="difflineminus">-      pickMessagePane(&quot;singlemessage&quot;);</span>
<a href="#l56.79"></a><span id="l56.79" class="difflineminus">-      this._selectionSummarized = false;</span>
<a href="#l56.80"></a><span id="l56.80" class="difflineminus">-      return false;</span>
<a href="#l56.81"></a><span id="l56.81" class="difflineminus">-    }</span>
<a href="#l56.82"></a><span id="l56.82" class="difflineminus">-</span>
<a href="#l56.83"></a><span id="l56.83" class="difflineminus">-    if (! gPrefBranch.getBoolPref(&quot;mail.operate_on_msgs_in_collapsed_threads&quot;)) {</span>
<a href="#l56.84"></a><span id="l56.84" class="difflineminus">-      ClearMessagePane();</span>
<a href="#l56.85"></a><span id="l56.85" class="difflineminus">-      this._selectionSummarized = false;</span>
<a href="#l56.86"></a><span id="l56.86" class="difflineminus">-      return false;</span>
<a href="#l56.87"></a><span id="l56.87" class="difflineminus">-    }</span>
<a href="#l56.88"></a><span id="l56.88" class="difflineminus">-</span>
<a href="#l56.89"></a><span id="l56.89" class="difflineminus">-    // If we are already summarized, let's make sure the selection count</span>
<a href="#l56.90"></a><span id="l56.90" class="difflineminus">-    // isn't changing rapidly, by checking again in 100 msec.</span>
<a href="#l56.91"></a><span id="l56.91" class="difflineminus">-    if (this._selectionSummarized) {</span>
<a href="#l56.92"></a><span id="l56.92" class="difflineminus">-      clearTimeout(this._selectionTimeout);</span>
<a href="#l56.93"></a><span id="l56.93" class="difflineminus">-      this._selectionTimeout = setTimeout(this.showSummary, 100, this, selectedMsgUris.length);</span>
<a href="#l56.94"></a><span id="l56.94" class="difflineminus">-      return true;</span>
<a href="#l56.95"></a><span id="l56.95" class="difflineminus">-    }</span>
<a href="#l56.96"></a><span id="l56.96" class="difflineminus">-    this.showSummary(this, selectedMsgUris.length);</span>
<a href="#l56.97"></a><span id="l56.97" class="difflineminus">-    return true;</span>
<a href="#l56.98"></a><span id="l56.98" class="difflineminus">-  },</span>
<a href="#l56.99"></a><span id="l56.99" class="difflineminus">-</span>
<a href="#l56.100"></a><span id="l56.100" class="difflineminus">-  QueryInterface : function(iid)</span>
<a href="#l56.101"></a><span id="l56.101" class="difflineminus">-   {</span>
<a href="#l56.102"></a><span id="l56.102" class="difflineminus">-     if (iid.equals(Components.interfaces.nsIMsgDBViewCommandUpdater) ||</span>
<a href="#l56.103"></a><span id="l56.103" class="difflineminus">-         iid.equals(Components.interfaces.nsISupports))</span>
<a href="#l56.104"></a><span id="l56.104" class="difflineminus">-       return this;</span>
<a href="#l56.105"></a><span id="l56.105" class="difflineminus">-</span>
<a href="#l56.106"></a><span id="l56.106" class="difflineminus">-     throw Components.results.NS_NOINTERFACE;</span>
<a href="#l56.107"></a><span id="l56.107" class="difflineminus">-    }</span>
<a href="#l56.108"></a><span id="l56.108" class="difflineminus">-}</span>
<a href="#l56.109"></a><span id="l56.109" class="difflineminus">-</span>
<a href="#l56.110"></a><span id="l56.110"> function HandleColumnClick(columnID)</span>
<a href="#l56.111"></a><span id="l56.111"> {</span>
<a href="#l56.112"></a><span id="l56.112">   const columnMap = {dateCol: 'byDate',</span>
<a href="#l56.113"></a><span id="l56.113">                      receivedCol: 'byReceived',</span>
<a href="#l56.114"></a><span id="l56.114">                      senderCol: 'byAuthor',</span>
<a href="#l56.115"></a><span id="l56.115">                      recipientCol: 'byRecipient',</span>
<a href="#l56.116"></a><span id="l56.116">                      subjectCol: 'bySubject',</span>
<a href="#l56.117"></a><span id="l56.117">                      locationCol: 'byLocation',</span>
<a href="#l56.118"></a><span id="l56.118" class="difflineat">@@ -213,270 +115,172 @@ function HandleColumnClick(columnID)</span>
<a href="#l56.119"></a><span id="l56.119">   if (columnID in columnMap) {</span>
<a href="#l56.120"></a><span id="l56.120">     sortType = columnMap[columnID];</span>
<a href="#l56.121"></a><span id="l56.121">   } else {</span>
<a href="#l56.122"></a><span id="l56.122">     // If the column isn't in the map, check and see if it's a custom column</span>
<a href="#l56.123"></a><span id="l56.123">     try {</span>
<a href="#l56.124"></a><span id="l56.124">       // try to grab the columnHandler (an error is thrown if it does not exist)</span>
<a href="#l56.125"></a><span id="l56.125">       columnHandler = gDBView.getColumnHandler(columnID);</span>
<a href="#l56.126"></a><span id="l56.126"> </span>
<a href="#l56.127"></a><span id="l56.127" class="difflineminus">-      // it exists - save this column ID in the customSortCol property of</span>
<a href="#l56.128"></a><span id="l56.128" class="difflineminus">-      // dbFolderInfo for later use (see nsIMsgDBView.cpp)</span>
<a href="#l56.129"></a><span id="l56.129" class="difflineminus">-      gDBView.db.dBFolderInfo.setProperty('customSortCol', columnID);</span>
<a href="#l56.130"></a><span id="l56.130" class="difflineplus">+      // it exists - set it to be the current custom column</span>
<a href="#l56.131"></a><span id="l56.131" class="difflineplus">+      gDBView.curCustomColumn = columnID;</span>
<a href="#l56.132"></a><span id="l56.132">         </span>
<a href="#l56.133"></a><span id="l56.133">       sortType = &quot;byCustom&quot;;</span>
<a href="#l56.134"></a><span id="l56.134">     } catch(err) {</span>
<a href="#l56.135"></a><span id="l56.135">         dump(&quot;unsupported sort column: &quot; + columnID + &quot; - no custom handler installed. (Error was: &quot; + err + &quot;)\n&quot;);</span>
<a href="#l56.136"></a><span id="l56.136">         return; // bail out</span>
<a href="#l56.137"></a><span id="l56.137">     }</span>
<a href="#l56.138"></a><span id="l56.138">   }</span>
<a href="#l56.139"></a><span id="l56.139"> </span>
<a href="#l56.140"></a><span id="l56.140" class="difflineminus">-  var dbview = GetDBView();</span>
<a href="#l56.141"></a><span id="l56.141" class="difflineplus">+  let viewWrapper = gFolderDisplay.view;</span>
<a href="#l56.142"></a><span id="l56.142">   var simpleColumns = false;</span>
<a href="#l56.143"></a><span id="l56.143">   try {</span>
<a href="#l56.144"></a><span id="l56.144">     simpleColumns = !pref.getBoolPref(&quot;mailnews.thread_pane_column_unthreads&quot;);</span>
<a href="#l56.145"></a><span id="l56.145">   }</span>
<a href="#l56.146"></a><span id="l56.146">   catch (ex) {</span>
<a href="#l56.147"></a><span id="l56.147">   }</span>
<a href="#l56.148"></a><span id="l56.148">   if (sortType == &quot;byThread&quot;) {</span>
<a href="#l56.149"></a><span id="l56.149">     if (simpleColumns)</span>
<a href="#l56.150"></a><span id="l56.150">       MsgToggleThreaded();</span>
<a href="#l56.151"></a><span id="l56.151" class="difflineminus">-    else if (dbview.viewFlags &amp; nsMsgViewFlagsType.kThreadedDisplay)</span>
<a href="#l56.152"></a><span id="l56.152" class="difflineplus">+    else if (viewWrapper.showThreaded)</span>
<a href="#l56.153"></a><span id="l56.153">       MsgReverseSortThreadPane();</span>
<a href="#l56.154"></a><span id="l56.154">     else</span>
<a href="#l56.155"></a><span id="l56.155">       MsgSortByThread();</span>
<a href="#l56.156"></a><span id="l56.156">   }</span>
<a href="#l56.157"></a><span id="l56.157">   else {</span>
<a href="#l56.158"></a><span id="l56.158" class="difflineminus">-    if (!simpleColumns &amp;&amp; (dbview.viewFlags &amp; nsMsgViewFlagsType.kThreadedDisplay)) {</span>
<a href="#l56.159"></a><span id="l56.159" class="difflineminus">-      dbview.viewFlags &amp;= ~nsMsgViewFlagsType.kThreadedDisplay;</span>
<a href="#l56.160"></a><span id="l56.160" class="difflineplus">+    if (!simpleColumns &amp;&amp; viewWrapper.showThreaded) {</span>
<a href="#l56.161"></a><span id="l56.161" class="difflineplus">+      viewWrapper.showUnthreaded = true;</span>
<a href="#l56.162"></a><span id="l56.162">       MsgSortThreadPane(sortType);</span>
<a href="#l56.163"></a><span id="l56.163">     }</span>
<a href="#l56.164"></a><span id="l56.164" class="difflineminus">-    else if (dbview.sortType == nsMsgViewSortType[sortType]) {</span>
<a href="#l56.165"></a><span id="l56.165" class="difflineplus">+    else if (viewWrapper.primarySortType == nsMsgViewSortType[sortType]) {</span>
<a href="#l56.166"></a><span id="l56.166">       MsgReverseSortThreadPane();</span>
<a href="#l56.167"></a><span id="l56.167">     }</span>
<a href="#l56.168"></a><span id="l56.168">     else {</span>
<a href="#l56.169"></a><span id="l56.169">       MsgSortThreadPane(sortType);</span>
<a href="#l56.170"></a><span id="l56.170">     }</span>
<a href="#l56.171"></a><span id="l56.171">   }</span>
<a href="#l56.172"></a><span id="l56.172"> }</span>
<a href="#l56.173"></a><span id="l56.173"> </span>
<a href="#l56.174"></a><span id="l56.174"> function ThreadPaneDoubleClick()</span>
<a href="#l56.175"></a><span id="l56.175"> {</span>
<a href="#l56.176"></a><span id="l56.176">   const nsMsgFolderFlags = Components.interfaces.nsMsgFolderFlags;</span>
<a href="#l56.177"></a><span id="l56.177">   if (IsSpecialFolderSelected(nsMsgFolderFlags.Drafts, true)) {</span>
<a href="#l56.178"></a><span id="l56.178">     MsgComposeDraftMessage();</span>
<a href="#l56.179"></a><span id="l56.179">   }</span>
<a href="#l56.180"></a><span id="l56.180">   else if(IsSpecialFolderSelected(nsMsgFolderFlags.Templates, true)) {</span>
<a href="#l56.181"></a><span id="l56.181" class="difflineminus">-    var loadedFolder = GetLoadedMsgFolder();</span>
<a href="#l56.182"></a><span id="l56.182" class="difflineminus">-    var messageArray = GetSelectedMessages();</span>
<a href="#l56.183"></a><span id="l56.183" class="difflineminus">-</span>
<a href="#l56.184"></a><span id="l56.184">     ComposeMessage(Components.interfaces.nsIMsgCompType.Template,</span>
<a href="#l56.185"></a><span id="l56.185">                    Components.interfaces.nsIMsgCompFormat.Default,</span>
<a href="#l56.186"></a><span id="l56.186" class="difflineminus">-                   loadedFolder, messageArray);</span>
<a href="#l56.187"></a><span id="l56.187" class="difflineplus">+                   gFolderDisplay.displayedFolder,</span>
<a href="#l56.188"></a><span id="l56.188" class="difflineplus">+                   gFolderDisplay.selectedMessageUris);</span>
<a href="#l56.189"></a><span id="l56.189">   }</span>
<a href="#l56.190"></a><span id="l56.190">   else {</span>
<a href="#l56.191"></a><span id="l56.191">     MsgOpenSelectedMessages();</span>
<a href="#l56.192"></a><span id="l56.192">   }</span>
<a href="#l56.193"></a><span id="l56.193"> }</span>
<a href="#l56.194"></a><span id="l56.194"> </span>
<a href="#l56.195"></a><span id="l56.195"> function ThreadPaneKeyPress(event)</span>
<a href="#l56.196"></a><span id="l56.196"> {</span>
<a href="#l56.197"></a><span id="l56.197">   if (event.keyCode == KeyEvent.DOM_VK_RETURN)</span>
<a href="#l56.198"></a><span id="l56.198">     ThreadPaneDoubleClick();</span>
<a href="#l56.199"></a><span id="l56.199"> }</span>
<a href="#l56.200"></a><span id="l56.200"> </span>
<a href="#l56.201"></a><span id="l56.201"> function MsgSortByThread()</span>
<a href="#l56.202"></a><span id="l56.202"> {</span>
<a href="#l56.203"></a><span id="l56.203" class="difflineminus">-  var dbview = GetDBView();</span>
<a href="#l56.204"></a><span id="l56.204" class="difflineminus">-  dbview.viewFlags |= nsMsgViewFlagsType.kThreadedDisplay;</span>
<a href="#l56.205"></a><span id="l56.205" class="difflineminus">-  dbview.viewFlags &amp;= ~nsMsgViewFlagsType.kGroupBySort;</span>
<a href="#l56.206"></a><span id="l56.206" class="difflineplus">+  gFolderDisplay.view.showThreaded = true;</span>
<a href="#l56.207"></a><span id="l56.207">   MsgSortThreadPane('byDate');</span>
<a href="#l56.208"></a><span id="l56.208"> }</span>
<a href="#l56.209"></a><span id="l56.209"> </span>
<a href="#l56.210"></a><span id="l56.210"> function MsgSortThreadPane(sortName)</span>
<a href="#l56.211"></a><span id="l56.211"> {</span>
<a href="#l56.212"></a><span id="l56.212">   var sortType = nsMsgViewSortType[sortName];</span>
<a href="#l56.213"></a><span id="l56.213" class="difflineminus">-  var dbview = GetDBView();</span>
<a href="#l56.214"></a><span id="l56.214" class="difflineminus">-</span>
<a href="#l56.215"></a><span id="l56.215" class="difflineminus">-  // turn off grouping</span>
<a href="#l56.216"></a><span id="l56.216" class="difflineminus">-  dbview.viewFlags &amp;= ~nsMsgViewFlagsType.kGroupBySort;</span>
<a href="#l56.217"></a><span id="l56.217" class="difflineminus">-</span>
<a href="#l56.218"></a><span id="l56.218" class="difflineminus">-  dbview.sort(sortType, nsMsgViewSortOrder.ascending);</span>
<a href="#l56.219"></a><span id="l56.219" class="difflineminus">-  UpdateSortIndicators(sortType, nsMsgViewSortOrder.ascending);</span>
<a href="#l56.220"></a><span id="l56.220" class="difflineplus">+  // legacy behavior dictates we un-group-by-sort if we were.  this probably</span>
<a href="#l56.221"></a><span id="l56.221" class="difflineplus">+  //  deserves a UX call...</span>
<a href="#l56.222"></a><span id="l56.222" class="difflineplus">+  gFolderDisplay.view.showGroupedBySort = false;</span>
<a href="#l56.223"></a><span id="l56.223" class="difflineplus">+  gFolderDisplay.view.sort(sortType, nsMsgViewSortOrder.ascending)</span>
<a href="#l56.224"></a><span id="l56.224"> }</span>
<a href="#l56.225"></a><span id="l56.225"> </span>
<a href="#l56.226"></a><span id="l56.226"> function MsgReverseSortThreadPane()</span>
<a href="#l56.227"></a><span id="l56.227"> {</span>
<a href="#l56.228"></a><span id="l56.228" class="difflineminus">-  var dbview = GetDBView();</span>
<a href="#l56.229"></a><span id="l56.229" class="difflineminus">-  if (dbview.sortOrder == nsMsgViewSortOrder.ascending) {</span>
<a href="#l56.230"></a><span id="l56.230" class="difflineminus">-    MsgSortDescending();</span>
<a href="#l56.231"></a><span id="l56.231" class="difflineminus">-  }</span>
<a href="#l56.232"></a><span id="l56.232" class="difflineminus">-  else {</span>
<a href="#l56.233"></a><span id="l56.233" class="difflineminus">-    MsgSortAscending();</span>
<a href="#l56.234"></a><span id="l56.234" class="difflineminus">-  }</span>
<a href="#l56.235"></a><span id="l56.235" class="difflineplus">+  if (gFolderDisplay.view.isSortedAscending)</span>
<a href="#l56.236"></a><span id="l56.236" class="difflineplus">+    gFolderDisplay.view.sortDescending();</span>
<a href="#l56.237"></a><span id="l56.237" class="difflineplus">+  else</span>
<a href="#l56.238"></a><span id="l56.238" class="difflineplus">+    gFolderDisplay.view.sortAscending();</span>
<a href="#l56.239"></a><span id="l56.239"> }</span>
<a href="#l56.240"></a><span id="l56.240"> </span>
<a href="#l56.241"></a><span id="l56.241"> function MsgToggleThreaded()</span>
<a href="#l56.242"></a><span id="l56.242"> {</span>
<a href="#l56.243"></a><span id="l56.243" class="difflineminus">-    var dbview = GetDBView();</span>
<a href="#l56.244"></a><span id="l56.244" class="difflineminus">-    var newViewFlags = dbview.viewFlags ^ nsMsgViewFlagsType.kThreadedDisplay;</span>
<a href="#l56.245"></a><span id="l56.245" class="difflineminus">-    newViewFlags &amp;= ~nsMsgViewFlagsType.kGroupBySort;</span>
<a href="#l56.246"></a><span id="l56.246" class="difflineminus">-    dbview.viewFlags = newViewFlags;</span>
<a href="#l56.247"></a><span id="l56.247" class="difflineminus">-</span>
<a href="#l56.248"></a><span id="l56.248" class="difflineminus">-    dbview.sort(dbview.sortType, dbview.sortOrder);</span>
<a href="#l56.249"></a><span id="l56.249" class="difflineminus">-    UpdateSortIndicators(dbview.sortType, dbview.sortOrder);</span>
<a href="#l56.250"></a><span id="l56.250" class="difflineplus">+  if (gFolderDisplay.view.showThreaded)</span>
<a href="#l56.251"></a><span id="l56.251" class="difflineplus">+    gFolderDisplay.view.showUnthreaded = true;</span>
<a href="#l56.252"></a><span id="l56.252" class="difflineplus">+  else</span>
<a href="#l56.253"></a><span id="l56.253" class="difflineplus">+    gFolderDisplay.view.showThreaded = true;</span>
<a href="#l56.254"></a><span id="l56.254"> }</span>
<a href="#l56.255"></a><span id="l56.255"> </span>
<a href="#l56.256"></a><span id="l56.256"> function MsgSortThreaded()</span>
<a href="#l56.257"></a><span id="l56.257"> {</span>
<a href="#l56.258"></a><span id="l56.258" class="difflineminus">-    var dbview = GetDBView();</span>
<a href="#l56.259"></a><span id="l56.259" class="difflineminus">-    var viewFlags = dbview.viewFlags;</span>
<a href="#l56.260"></a><span id="l56.260" class="difflineminus">-    let wasGrouped = viewFlags &amp; nsMsgViewFlagsType.kGroupBySort;</span>
<a href="#l56.261"></a><span id="l56.261" class="difflineminus">-    dbview.viewFlags &amp;= ~nsMsgViewFlagsType.kGroupBySort;</span>
<a href="#l56.262"></a><span id="l56.262" class="difflineminus">-    // if we were grouped, and not a saved search, just rebuild the view</span>
<a href="#l56.263"></a><span id="l56.263" class="difflineminus">-    if (wasGrouped &amp;&amp; !(gMsgFolderSelected.flags &amp; </span>
<a href="#l56.264"></a><span id="l56.264" class="difflineminus">-                       Components.interfaces.nsMsgFolderFlags.Virtual))</span>
<a href="#l56.265"></a><span id="l56.265" class="difflineminus">-      SwitchView(&quot;cmd_viewAllMsgs&quot;);</span>
<a href="#l56.266"></a><span id="l56.266" class="difflineminus">-    // Toggle if not already threaded.</span>
<a href="#l56.267"></a><span id="l56.267" class="difflineminus">-    else if ((viewFlags &amp; nsMsgViewFlagsType.kThreadedDisplay) == 0)</span>
<a href="#l56.268"></a><span id="l56.268" class="difflineminus">-        MsgToggleThreaded();</span>
<a href="#l56.269"></a><span id="l56.269" class="difflineplus">+  gFolderDisplay.view.showThreaded = true;</span>
<a href="#l56.270"></a><span id="l56.270"> }</span>
<a href="#l56.271"></a><span id="l56.271"> </span>
<a href="#l56.272"></a><span id="l56.272"> function MsgGroupBySort()</span>
<a href="#l56.273"></a><span id="l56.273"> {</span>
<a href="#l56.274"></a><span id="l56.274" class="difflineminus">-  var dbview = GetDBView();</span>
<a href="#l56.275"></a><span id="l56.275" class="difflineminus">-  var viewFlags = dbview.viewFlags;</span>
<a href="#l56.276"></a><span id="l56.276" class="difflineminus">-  var sortOrder = dbview.sortOrder;</span>
<a href="#l56.277"></a><span id="l56.277" class="difflineminus">-  var sortType = dbview.sortType;</span>
<a href="#l56.278"></a><span id="l56.278" class="difflineminus">-  var count = new Object;</span>
<a href="#l56.279"></a><span id="l56.279" class="difflineminus">-  var msgFolder = dbview.msgFolder;</span>
<a href="#l56.280"></a><span id="l56.280" class="difflineminus">-</span>
<a href="#l56.281"></a><span id="l56.281" class="difflineminus">-  var sortTypeSupportsGrouping = (sortType == nsMsgViewSortType.byAuthor </span>
<a href="#l56.282"></a><span id="l56.282" class="difflineminus">-         || sortType == nsMsgViewSortType.byDate || sortType == nsMsgViewSortType.byReceived || sortType == nsMsgViewSortType.byPriority</span>
<a href="#l56.283"></a><span id="l56.283" class="difflineminus">-         || sortType == nsMsgViewSortType.bySubject || sortType == nsMsgViewSortType.byTags</span>
<a href="#l56.284"></a><span id="l56.284" class="difflineminus">-         || sortType == nsMsgViewSortType.byStatus  || sortType == nsMsgViewSortType.byRecipient</span>
<a href="#l56.285"></a><span id="l56.285" class="difflineminus">-         || sortType == nsMsgViewSortType.byAccount || sortType == nsMsgViewSortType.byFlagged</span>
<a href="#l56.286"></a><span id="l56.286" class="difflineminus">-         || sortType == nsMsgViewSortType.byAttachments);</span>
<a href="#l56.287"></a><span id="l56.287" class="difflineminus">-</span>
<a href="#l56.288"></a><span id="l56.288" class="difflineminus">-  if (!sortTypeSupportsGrouping)</span>
<a href="#l56.289"></a><span id="l56.289" class="difflineminus">-    return; // we shouldn't be trying to group something we don't support grouping for...</span>
<a href="#l56.290"></a><span id="l56.290" class="difflineminus">-</span>
<a href="#l56.291"></a><span id="l56.291" class="difflineminus">-  viewFlags |= nsMsgViewFlagsType.kThreadedDisplay | nsMsgViewFlagsType.kGroupBySort;</span>
<a href="#l56.292"></a><span id="l56.292" class="difflineminus">-  if (gDBView &amp;&amp;</span>
<a href="#l56.293"></a><span id="l56.293" class="difflineminus">-      gMsgFolderSelected.flags &amp; Components.interfaces.nsMsgFolderFlags.Virtual)</span>
<a href="#l56.294"></a><span id="l56.294" class="difflineminus">-  {</span>
<a href="#l56.295"></a><span id="l56.295" class="difflineminus">-    gDBView.viewFlags = viewFlags;</span>
<a href="#l56.296"></a><span id="l56.296" class="difflineminus">-    UpdateSortIndicators(sortType, nsMsgViewSortOrder.ascending);</span>
<a href="#l56.297"></a><span id="l56.297" class="difflineminus">-    return;</span>
<a href="#l56.298"></a><span id="l56.298" class="difflineminus">-  }</span>
<a href="#l56.299"></a><span id="l56.299" class="difflineminus">-  // null this out, so we don't try sort.</span>
<a href="#l56.300"></a><span id="l56.300" class="difflineminus">-  if (gDBView) {</span>
<a href="#l56.301"></a><span id="l56.301" class="difflineminus">-    gDBView.close();</span>
<a href="#l56.302"></a><span id="l56.302" class="difflineminus">-    gDBView = null;</span>
<a href="#l56.303"></a><span id="l56.303" class="difflineminus">-  }</span>
<a href="#l56.304"></a><span id="l56.304" class="difflineminus">-  gDBView = Components.classes[&quot;@mozilla.org/messenger/msgdbview;1?type=group&quot;]</span>
<a href="#l56.305"></a><span id="l56.305" class="difflineminus">-                                .createInstance(Components.interfaces.nsIMsgDBView);</span>
<a href="#l56.306"></a><span id="l56.306" class="difflineminus">-</span>
<a href="#l56.307"></a><span id="l56.307" class="difflineminus">-  if (!gThreadPaneCommandUpdater)</span>
<a href="#l56.308"></a><span id="l56.308" class="difflineminus">-    gThreadPaneCommandUpdater = new nsMsgDBViewCommandUpdater();</span>
<a href="#l56.309"></a><span id="l56.309" class="difflineminus">-</span>
<a href="#l56.310"></a><span id="l56.310" class="difflineminus">-</span>
<a href="#l56.311"></a><span id="l56.311" class="difflineminus">-  gDBView.init(messenger, msgWindow, gThreadPaneCommandUpdater);</span>
<a href="#l56.312"></a><span id="l56.312" class="difflineminus">-  gDBView.open(msgFolder, sortType, sortOrder, viewFlags, count);</span>
<a href="#l56.313"></a><span id="l56.313" class="difflineminus">-  RerootThreadPane();</span>
<a href="#l56.314"></a><span id="l56.314" class="difflineminus">-  UpdateSortIndicators(sortType, nsMsgViewSortOrder.ascending);</span>
<a href="#l56.315"></a><span id="l56.315" class="difflineminus">-  Components.classes[&quot;@mozilla.org/observer-service;1&quot;]</span>
<a href="#l56.316"></a><span id="l56.316" class="difflineminus">-            .getService(Components.interfaces.nsIObserverService)</span>
<a href="#l56.317"></a><span id="l56.317" class="difflineminus">-            .notifyObservers(msgFolder, &quot;MsgCreateDBView&quot;,</span>
<a href="#l56.318"></a><span id="l56.318" class="difflineminus">-             Components.interfaces.nsMsgViewType.eShowAllThreads + &quot;:&quot; + viewFlags);</span>
<a href="#l56.319"></a><span id="l56.319" class="difflineplus">+  gFolderDisplay.view.showGroupedBySort = true;</span>
<a href="#l56.320"></a><span id="l56.320"> }</span>
<a href="#l56.321"></a><span id="l56.321"> </span>
<a href="#l56.322"></a><span id="l56.322"> function MsgSortUnthreaded()</span>
<a href="#l56.323"></a><span id="l56.323"> {</span>
<a href="#l56.324"></a><span id="l56.324" class="difflineminus">-    // Toggle if not already unthreaded.</span>
<a href="#l56.325"></a><span id="l56.325" class="difflineminus">-    if ((GetDBView().viewFlags &amp; nsMsgViewFlagsType.kThreadedDisplay) != 0)</span>
<a href="#l56.326"></a><span id="l56.326" class="difflineminus">-        MsgToggleThreaded();</span>
<a href="#l56.327"></a><span id="l56.327" class="difflineplus">+  gFolderDisplay.view.showUnthreaded = true;</span>
<a href="#l56.328"></a><span id="l56.328"> }</span>
<a href="#l56.329"></a><span id="l56.329"> </span>
<a href="#l56.330"></a><span id="l56.330"> function MsgSortAscending()</span>
<a href="#l56.331"></a><span id="l56.331"> {</span>
<a href="#l56.332"></a><span id="l56.332" class="difflineminus">-  var dbview = GetDBView();</span>
<a href="#l56.333"></a><span id="l56.333" class="difflineminus">-  dbview.sort(dbview.sortType, nsMsgViewSortOrder.ascending);</span>
<a href="#l56.334"></a><span id="l56.334" class="difflineminus">-  UpdateSortIndicators(dbview.sortType, nsMsgViewSortOrder.ascending);</span>
<a href="#l56.335"></a><span id="l56.335" class="difflineplus">+  gFolderDisplay.view.sortAscending();</span>
<a href="#l56.336"></a><span id="l56.336"> }</span>
<a href="#l56.337"></a><span id="l56.337"> </span>
<a href="#l56.338"></a><span id="l56.338"> function MsgSortDescending()</span>
<a href="#l56.339"></a><span id="l56.339"> {</span>
<a href="#l56.340"></a><span id="l56.340" class="difflineminus">-  var dbview = GetDBView();</span>
<a href="#l56.341"></a><span id="l56.341" class="difflineminus">-  dbview.sort(dbview.sortType, nsMsgViewSortOrder.descending);</span>
<a href="#l56.342"></a><span id="l56.342" class="difflineminus">-  UpdateSortIndicators(dbview.sortType, nsMsgViewSortOrder.descending);</span>
<a href="#l56.343"></a><span id="l56.343" class="difflineplus">+  gFolderDisplay.view.sortDescending();</span>
<a href="#l56.344"></a><span id="l56.344"> }</span>
<a href="#l56.345"></a><span id="l56.345"> </span>
<a href="#l56.346"></a><span id="l56.346" class="difflineminus">-function groupedBySortUsingDummyRow()</span>
<a href="#l56.347"></a><span id="l56.347" class="difflineminus">-{</span>
<a href="#l56.348"></a><span id="l56.348" class="difflineminus">-  return (gDBView.viewFlags &amp; nsMsgViewFlagsType.kGroupBySort) &amp;&amp; </span>
<a href="#l56.349"></a><span id="l56.349" class="difflineminus">-         (gDBView.sortType != nsMsgViewSortType.bySubject);</span>
<a href="#l56.350"></a><span id="l56.350" class="difflineminus">-}</span>
<a href="#l56.351"></a><span id="l56.351" class="difflineminus">-</span>
<a href="#l56.352"></a><span id="l56.352" class="difflineplus">+// XXX this should probably migrate into FolderDisplayWidget, or whatever</span>
<a href="#l56.353"></a><span id="l56.353" class="difflineplus">+//  FolderDisplayWidget ends up using if it refactors column management out.</span>
<a href="#l56.354"></a><span id="l56.354"> function UpdateSortIndicators(sortType, sortOrder)</span>
<a href="#l56.355"></a><span id="l56.355"> {</span>
<a href="#l56.356"></a><span id="l56.356">   // Remove the sort indicator from all the columns</span>
<a href="#l56.357"></a><span id="l56.357">   var treeColumns = document.getElementById('threadCols').childNodes;</span>
<a href="#l56.358"></a><span id="l56.358">   for (var i = 0; i &lt; treeColumns.length; i++)</span>
<a href="#l56.359"></a><span id="l56.359" class="difflineminus">-    treeColumns[i].removeAttribute('sortDirection');</span>
<a href="#l56.360"></a><span id="l56.360" class="difflineplus">+    treeColumns[i].removeAttribute(&quot;sortDirection&quot;);</span>
<a href="#l56.361"></a><span id="l56.361"> </span>
<a href="#l56.362"></a><span id="l56.362">   // show the twisties if the view is threaded</span>
<a href="#l56.363"></a><span id="l56.363">   var threadCol = document.getElementById(&quot;threadCol&quot;);</span>
<a href="#l56.364"></a><span id="l56.364" class="difflineplus">+  var subjectCol = document.getElementById(&quot;subjectCol&quot;);</span>
<a href="#l56.365"></a><span id="l56.365">   var sortedColumn;</span>
<a href="#l56.366"></a><span id="l56.366">   // set the sort indicator on the column we are sorted by</span>
<a href="#l56.367"></a><span id="l56.367">   var colID = ConvertSortTypeToColumnID(sortType);</span>
<a href="#l56.368"></a><span id="l56.368">   if (colID)</span>
<a href="#l56.369"></a><span id="l56.369">     sortedColumn = document.getElementById(colID);</span>
<a href="#l56.370"></a><span id="l56.370"> </span>
<a href="#l56.371"></a><span id="l56.371" class="difflineminus">-  var dbview = GetDBView();</span>
<a href="#l56.372"></a><span id="l56.372" class="difflineminus">-  var currCol = dbview.viewFlags &amp; nsMsgViewFlagsType.kGroupBySort </span>
<a href="#l56.373"></a><span id="l56.373" class="difflineminus">-    ? sortedColumn : document.getElementById(&quot;subjectCol&quot;);</span>
<a href="#l56.374"></a><span id="l56.374" class="difflineminus">-</span>
<a href="#l56.375"></a><span id="l56.375" class="difflineminus">-  if (dbview.viewFlags &amp; nsMsgViewFlagsType.kGroupBySort)</span>
<a href="#l56.376"></a><span id="l56.376" class="difflineminus">-  {</span>
<a href="#l56.377"></a><span id="l56.377" class="difflineminus">-    var threadTree = document.getElementById(&quot;threadTree&quot;);  </span>
<a href="#l56.378"></a><span id="l56.378" class="difflineminus">-    var subjectCol = document.getElementById(&quot;subjectCol&quot;);</span>
<a href="#l56.379"></a><span id="l56.379" class="difflineplus">+  var viewWrapper = gFolderDisplay.view;</span>
<a href="#l56.380"></a><span id="l56.380"> </span>
<a href="#l56.381"></a><span id="l56.381" class="difflineminus">-    if (groupedBySortUsingDummyRow())</span>
<a href="#l56.382"></a><span id="l56.382" class="difflineminus">-    {</span>
<a href="#l56.383"></a><span id="l56.383" class="difflineminus">-      currCol.removeAttribute(&quot;primary&quot;);</span>
<a href="#l56.384"></a><span id="l56.384" class="difflineminus">-      subjectCol.setAttribute(&quot;primary&quot;, &quot;true&quot;);</span>
<a href="#l56.385"></a><span id="l56.385" class="difflineminus">-    }</span>
<a href="#l56.386"></a><span id="l56.386" class="difflineminus">-</span>
<a href="#l56.387"></a><span id="l56.387" class="difflineminus">-    // hide the threaded column when in grouped view since you can't do </span>
<a href="#l56.388"></a><span id="l56.388" class="difflineminus">-    // threads inside of a group.</span>
<a href="#l56.389"></a><span id="l56.389" class="difflineminus">-    document.getElementById(&quot;threadCol&quot;).collapsed = true;</span>
<a href="#l56.390"></a><span id="l56.390" class="difflineminus">-  }</span>
<a href="#l56.391"></a><span id="l56.391" class="difflineplus">+  // the thread column is not visible when we are grouped by sort</span>
<a href="#l56.392"></a><span id="l56.392" class="difflineplus">+  document.getElementById(&quot;threadCol&quot;).collapsed = viewWrapper.showGroupedBySort;</span>
<a href="#l56.393"></a><span id="l56.393"> </span>
<a href="#l56.394"></a><span id="l56.394" class="difflineminus">-  // clear primary attribute from group column if going to a non-grouped view.</span>
<a href="#l56.395"></a><span id="l56.395" class="difflineminus">-  if (!(dbview.viewFlags &amp; nsMsgViewFlagsType.kGroupBySort))</span>
<a href="#l56.396"></a><span id="l56.396" class="difflineminus">-    document.getElementById(&quot;threadCol&quot;).collapsed = false;</span>
<a href="#l56.397"></a><span id="l56.397" class="difflineplus">+  // show twisties only when grouping or threading</span>
<a href="#l56.398"></a><span id="l56.398" class="difflineplus">+  if (viewWrapper.showGroupedBySort || viewWrapper.showThreaded)</span>
<a href="#l56.399"></a><span id="l56.399" class="difflineplus">+    subjectCol.setAttribute(&quot;primary&quot;, &quot;true&quot;);</span>
<a href="#l56.400"></a><span id="l56.400" class="difflineplus">+  else</span>
<a href="#l56.401"></a><span id="l56.401" class="difflineplus">+    subjectCol.removeAttribute(&quot;primary&quot;);</span>
<a href="#l56.402"></a><span id="l56.402"> </span>
<a href="#l56.403"></a><span id="l56.403" class="difflineminus">-  if ((dbview.viewFlags &amp; nsMsgViewFlagsType.kThreadedDisplay) &amp;&amp; !groupedBySortUsingDummyRow()) {</span>
<a href="#l56.404"></a><span id="l56.404" class="difflineplus">+  // If threading, set the sort direction on the thread column which causes it</span>
<a href="#l56.405"></a><span id="l56.405" class="difflineplus">+  //  to be able to 'light up' or otherwise indicate threading is active.</span>
<a href="#l56.406"></a><span id="l56.406" class="difflineplus">+  if (viewWrapper.showThreaded)</span>
<a href="#l56.407"></a><span id="l56.407">     threadCol.setAttribute(&quot;sortDirection&quot;, &quot;ascending&quot;);</span>
<a href="#l56.408"></a><span id="l56.408" class="difflineminus">-    currCol.setAttribute(&quot;primary&quot;, &quot;true&quot;);</span>
<a href="#l56.409"></a><span id="l56.409" class="difflineminus">-  }</span>
<a href="#l56.410"></a><span id="l56.410" class="difflineminus">-  else {</span>
<a href="#l56.411"></a><span id="l56.411" class="difflineminus">-    threadCol.removeAttribute(&quot;sortDirection&quot;);</span>
<a href="#l56.412"></a><span id="l56.412" class="difflineminus">-    currCol.removeAttribute(&quot;primary&quot;);</span>
<a href="#l56.413"></a><span id="l56.413" class="difflineminus">-  }</span>
<a href="#l56.414"></a><span id="l56.414"> </span>
<a href="#l56.415"></a><span id="l56.415" class="difflineminus">-  if (sortedColumn) {</span>
<a href="#l56.416"></a><span id="l56.416" class="difflineminus">-    if (sortOrder == nsMsgViewSortOrder.ascending) {</span>
<a href="#l56.417"></a><span id="l56.417" class="difflineminus">-      sortedColumn.setAttribute(&quot;sortDirection&quot;,&quot;ascending&quot;);</span>
<a href="#l56.418"></a><span id="l56.418" class="difflineminus">-    }</span>
<a href="#l56.419"></a><span id="l56.419" class="difflineminus">-    else {</span>
<a href="#l56.420"></a><span id="l56.420" class="difflineminus">-      sortedColumn.setAttribute(&quot;sortDirection&quot;,&quot;descending&quot;);</span>
<a href="#l56.421"></a><span id="l56.421" class="difflineminus">-    }</span>
<a href="#l56.422"></a><span id="l56.422" class="difflineminus">-  }</span>
<a href="#l56.423"></a><span id="l56.423" class="difflineplus">+  if (sortedColumn)</span>
<a href="#l56.424"></a><span id="l56.424" class="difflineplus">+    sortedColumn.setAttribute(&quot;sortDirection&quot;,</span>
<a href="#l56.425"></a><span id="l56.425" class="difflineplus">+                              sortOrder == nsMsgViewSortOrder.ascending ?</span>
<a href="#l56.426"></a><span id="l56.426" class="difflineplus">+                                &quot;ascending&quot; : &quot;descending&quot;);</span>
<a href="#l56.427"></a><span id="l56.427"> }</span>
<a href="#l56.428"></a><span id="l56.428"> </span>
<a href="#l56.429"></a><span id="l56.429"> function IsSpecialFolderSelected(flags, checkAncestors)</span>
<a href="#l56.430"></a><span id="l56.430"> {</span>
<a href="#l56.431"></a><span id="l56.431">   var selectedFolder = GetThreadPaneFolder();</span>
<a href="#l56.432"></a><span id="l56.432">   return IsSpecialFolder(selectedFolder, flags, checkAncestors);</span>
<a href="#l56.433"></a><span id="l56.433"> }</span>
<a href="#l56.434"></a><span id="l56.434"> </span>
<a href="#l56.435"></a><span id="l56.435" class="difflineat">@@ -490,37 +294,16 @@ function GetThreadPaneFolder()</span>
<a href="#l56.436"></a><span id="l56.436">   try {</span>
<a href="#l56.437"></a><span id="l56.437">     return gDBView.msgFolder;</span>
<a href="#l56.438"></a><span id="l56.438">   }</span>
<a href="#l56.439"></a><span id="l56.439">   catch (ex) {</span>
<a href="#l56.440"></a><span id="l56.440">     return null;</span>
<a href="#l56.441"></a><span id="l56.441">   }</span>
<a href="#l56.442"></a><span id="l56.442"> }</span>
<a href="#l56.443"></a><span id="l56.443"> </span>
<a href="#l56.444"></a><span id="l56.444" class="difflineminus">-function EnsureRowInThreadTreeIsVisible(index)</span>
<a href="#l56.445"></a><span id="l56.445" class="difflineminus">-{</span>
<a href="#l56.446"></a><span id="l56.446" class="difflineminus">-  if (index &lt; 0)</span>
<a href="#l56.447"></a><span id="l56.447" class="difflineminus">-    return;</span>
<a href="#l56.448"></a><span id="l56.448" class="difflineminus">-</span>
<a href="#l56.449"></a><span id="l56.449" class="difflineminus">-  var tree = GetThreadTree();</span>
<a href="#l56.450"></a><span id="l56.450" class="difflineminus">-  tree.treeBoxObject.ensureRowIsVisible(index); </span>
<a href="#l56.451"></a><span id="l56.451" class="difflineminus">-}</span>
<a href="#l56.452"></a><span id="l56.452" class="difflineminus">-</span>
<a href="#l56.453"></a><span id="l56.453" class="difflineminus">-function RerootThreadPane()</span>
<a href="#l56.454"></a><span id="l56.454" class="difflineminus">-{</span>
<a href="#l56.455"></a><span id="l56.455" class="difflineminus">-  SetNewsFolderColumns();</span>
<a href="#l56.456"></a><span id="l56.456" class="difflineminus">-</span>
<a href="#l56.457"></a><span id="l56.457" class="difflineminus">-  var treeView = gDBView.QueryInterface(Components.interfaces.nsITreeView);</span>
<a href="#l56.458"></a><span id="l56.458" class="difflineminus">-  if (treeView)</span>
<a href="#l56.459"></a><span id="l56.459" class="difflineminus">-  {</span>
<a href="#l56.460"></a><span id="l56.460" class="difflineminus">-    var tree = GetThreadTree();</span>
<a href="#l56.461"></a><span id="l56.461" class="difflineminus">-    tree.boxObject.QueryInterface(Components.interfaces.nsITreeBoxObject).view = treeView;</span>
<a href="#l56.462"></a><span id="l56.462" class="difflineminus">-  }</span>
<a href="#l56.463"></a><span id="l56.463" class="difflineminus">-}</span>
<a href="#l56.464"></a><span id="l56.464" class="difflineminus">-</span>
<a href="#l56.465"></a><span id="l56.465"> function ThreadPaneOnLoad()</span>
<a href="#l56.466"></a><span id="l56.466"> {</span>
<a href="#l56.467"></a><span id="l56.467">   var tree = GetThreadTree();</span>
<a href="#l56.468"></a><span id="l56.468">   // We won't have the tree if we're in a message window, so exit silently</span>
<a href="#l56.469"></a><span id="l56.469">   if (!tree)</span>
<a href="#l56.470"></a><span id="l56.470">     return;</span>
<a href="#l56.471"></a><span id="l56.471"> </span>
<a href="#l56.472"></a><span id="l56.472">   tree.addEventListener(&quot;click&quot;,ThreadPaneOnClick,true);</span>
<a href="#l56.473"></a><span id="l56.473" class="difflineat">@@ -533,13 +316,12 @@ function ThreadPaneOnLoad()</span>
<a href="#l56.474"></a><span id="l56.474">   tree.addEventListener(&quot;mousedown&quot;,TreeOnMouseDown,true);</span>
<a href="#l56.475"></a><span id="l56.475">   let delay = pref.getIntPref(&quot;mailnews.threadpane_select_delay&quot;);</span>
<a href="#l56.476"></a><span id="l56.476">   document.getElementById(&quot;threadTree&quot;)._selectDelay = delay;</span>
<a href="#l56.477"></a><span id="l56.477"> }</span>
<a href="#l56.478"></a><span id="l56.478"> </span>
<a href="#l56.479"></a><span id="l56.479"> function ThreadPaneSelectionChanged()</span>
<a href="#l56.480"></a><span id="l56.480"> {</span>
<a href="#l56.481"></a><span id="l56.481">   UpdateStatusMessageCounts(gMsgFolderSelected);</span>
<a href="#l56.482"></a><span id="l56.482" class="difflineminus">-  if (!gRightMouseButtonDown)</span>
<a href="#l56.483"></a><span id="l56.483" class="difflineminus">-    GetThreadTree().view.selectionChanged();</span>
<a href="#l56.484"></a><span id="l56.484" class="difflineplus">+  GetThreadTree().view.selectionChanged();</span>
<a href="#l56.485"></a><span id="l56.485"> }</span>
<a href="#l56.486"></a><span id="l56.486"> </span>
<a href="#l56.487"></a><span id="l56.487"> addEventListener(&quot;load&quot;,ThreadPaneOnLoad,true);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l57.1"></a><span id="l57.1" class="difflineminus">--- a/mail/base/content/widgetglue.js</span>
<a href="#l57.2"></a><span id="l57.2" class="difflineplus">+++ b/mail/base/content/widgetglue.js</span>
<a href="#l57.3"></a><span id="l57.3" class="difflineat">@@ -44,16 +44,21 @@</span>
<a href="#l57.4"></a><span id="l57.4">  * and then calls a function/command in commandglue</span>
<a href="#l57.5"></a><span id="l57.5">  */</span>
<a href="#l57.6"></a><span id="l57.6"> </span>
<a href="#l57.7"></a><span id="l57.7"> //The eventual goal is for this file to go away and its contents to be brought into</span>
<a href="#l57.8"></a><span id="l57.8"> //mailWindowOverlay.js.  This is currently being done.</span>
<a href="#l57.9"></a><span id="l57.9"> </span>
<a href="#l57.10"></a><span id="l57.10"> function MsgToggleMessagePane()</span>
<a href="#l57.11"></a><span id="l57.11"> {</span>
<a href="#l57.12"></a><span id="l57.12" class="difflineplus">+  // Bail without doing anything if we are not a folder tab.</span>
<a href="#l57.13"></a><span id="l57.13" class="difflineplus">+  let currentTabInfo = document.getElementById(&quot;tabmail&quot;).currentTabInfo;</span>
<a href="#l57.14"></a><span id="l57.14" class="difflineplus">+  if (currentTabInfo.mode.name != &quot;folder&quot;)</span>
<a href="#l57.15"></a><span id="l57.15" class="difflineplus">+    return;</span>
<a href="#l57.16"></a><span id="l57.16" class="difflineplus">+</span>
<a href="#l57.17"></a><span id="l57.17">   var splitter = document.getElementById(&quot;threadpane-splitter&quot;);</span>
<a href="#l57.18"></a><span id="l57.18">   var state = splitter.getAttribute(&quot;state&quot;);</span>
<a href="#l57.19"></a><span id="l57.19">   if (state == &quot;collapsed&quot;)</span>
<a href="#l57.20"></a><span id="l57.20">     splitter.setAttribute(&quot;state&quot;, null);</span>
<a href="#l57.21"></a><span id="l57.21">   else</span>
<a href="#l57.22"></a><span id="l57.22">     splitter.setAttribute(&quot;state&quot;, &quot;collapsed&quot;)</span>
<a href="#l57.23"></a><span id="l57.23"> </span>
<a href="#l57.24"></a><span id="l57.24">    ChangeMessagePaneVisibility(IsMessagePaneCollapsed());</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l58.1"></a><span id="l58.1" class="difflineminus">--- a/mail/base/jar.mn</span>
<a href="#l58.2"></a><span id="l58.2" class="difflineplus">+++ b/mail/base/jar.mn</span>
<a href="#l58.3"></a><span id="l58.3" class="difflineat">@@ -9,37 +9,40 @@ messenger.jar:</span>
<a href="#l58.4"></a><span id="l58.4"> % style chrome://global/content/customizeToolbar.xul chrome://messenger/skin/addressbook/addressbook.css</span>
<a href="#l58.5"></a><span id="l58.5"> % style chrome://global/content/customizeToolbar.xul chrome://messenger/skin/messengercompose/messengercompose.css</span>
<a href="#l58.6"></a><span id="l58.6"> % style chrome://global/content/customizeToolbar.xul chrome://messenger/skin/smime/msgCompSMIMEOverlay.css</span>
<a href="#l58.7"></a><span id="l58.7"> % style chrome://global/content/customizeToolbar.xul chrome://messenger/skin/primaryToolbar.css</span>
<a href="#l58.8"></a><span id="l58.8">     content/messenger/accountCreation.dtd           (content/accountCreation.dtd)</span>
<a href="#l58.9"></a><span id="l58.9">     content/messenger/accountCreation.properties    (content/accountCreation.properties)</span>
<a href="#l58.10"></a><span id="l58.10">     content/messenger/accountCreationModel.properties (content/accountCreationModel.properties)</span>
<a href="#l58.11"></a><span id="l58.11">     content/messenger/accountCreationUtil.properties  (content/accountCreationUtil.properties)</span>
<a href="#l58.12"></a><span id="l58.12" class="difflineminus">-*   content/messenger/mailWindow.js                 (content/mailWindow.js)</span>
<a href="#l58.13"></a><span id="l58.13" class="difflineminus">-*   content/messenger/mailWindowOverlay.js          (content/mailWindowOverlay.js)</span>
<a href="#l58.14"></a><span id="l58.14" class="difflineplus">+    content/messenger/mailWindow.js                 (content/mailWindow.js)</span>
<a href="#l58.15"></a><span id="l58.15" class="difflineplus">+    content/messenger/messageDisplay.js             (content/messageDisplay.js)</span>
<a href="#l58.16"></a><span id="l58.16" class="difflineplus">+    content/messenger/folderDisplay.js              (content/folderDisplay.js)</span>
<a href="#l58.17"></a><span id="l58.17" class="difflineplus">+    content/messenger/mailWindowOverlay.js          (content/mailWindowOverlay.js)</span>
<a href="#l58.18"></a><span id="l58.18"> *   content/messenger/mailWindowOverlay.xul         (content/mailWindowOverlay.xul)</span>
<a href="#l58.19"></a><span id="l58.19" class="difflineminus">-*   content/messenger/extraCustomizeItems.xul       (content/extraCustomizeItems.xul)</span>
<a href="#l58.20"></a><span id="l58.20" class="difflineplus">+    content/messenger/extraCustomizeItems.xul       (content/extraCustomizeItems.xul)</span>
<a href="#l58.21"></a><span id="l58.21"> *   content/messenger/mailOverlay.xul               (content/mailOverlay.xul)</span>
<a href="#l58.22"></a><span id="l58.22"> *   content/messenger/messageWindow.xul             (content/messageWindow.xul)</span>
<a href="#l58.23"></a><span id="l58.23" class="difflineminus">-*   content/messenger/messageWindow.js              (content/messageWindow.js)</span>
<a href="#l58.24"></a><span id="l58.24" class="difflineminus">-*   content/messenger/mailContextMenus.js           (content/mailContextMenus.js)</span>
<a href="#l58.25"></a><span id="l58.25" class="difflineplus">+    content/messenger/messageWindow.js              (content/messageWindow.js)</span>
<a href="#l58.26"></a><span id="l58.26" class="difflineplus">+    content/messenger/mailContextMenus.js           (content/mailContextMenus.js)</span>
<a href="#l58.27"></a><span id="l58.27"> *   content/messenger/messenger.xul                 (content/messenger.xul)</span>
<a href="#l58.28"></a><span id="l58.28"> *   content/messenger/hiddenWindow.xul              (content/hiddenWindow.xul)</span>
<a href="#l58.29"></a><span id="l58.29"> *   content/messenger/hiddenWindow.js               (content/hiddenWindow.js)</span>
<a href="#l58.30"></a><span id="l58.30" class="difflineminus">-*   content/messenger/msgHdrViewOverlay.js          (content/msgHdrViewOverlay.js)</span>
<a href="#l58.31"></a><span id="l58.31" class="difflineplus">+    content/messenger/msgHdrViewOverlay.js          (content/msgHdrViewOverlay.js)</span>
<a href="#l58.32"></a><span id="l58.32">     content/messenger/msgHdrViewOverlay.xul         (content/msgHdrViewOverlay.xul)</span>
<a href="#l58.33"></a><span id="l58.33" class="difflineplus">+    content/messenger/msgViewNavigation.js          (content/msgViewNavigation.js)</span>
<a href="#l58.34"></a><span id="l58.34">     content/messenger/mailWidgets.xml               (content/mailWidgets.xml)</span>
<a href="#l58.35"></a><span id="l58.35">     content/messenger/editContactOverlay.js         (content/editContactOverlay.js)</span>
<a href="#l58.36"></a><span id="l58.36"> *   content/messenger/editContactOverlay.xul        (content/editContactOverlay.xul)</span>
<a href="#l58.37"></a><span id="l58.37" class="difflineminus">-*   content/messenger/msgMail3PaneWindow.js         (content/msgMail3PaneWindow.js)</span>
<a href="#l58.38"></a><span id="l58.38" class="difflineminus">-*   content/messenger/mail3PaneWindowCommands.js    (content/mail3PaneWindowCommands.js)</span>
<a href="#l58.39"></a><span id="l58.39" class="difflineplus">+    content/messenger/msgMail3PaneWindow.js         (content/msgMail3PaneWindow.js)</span>
<a href="#l58.40"></a><span id="l58.40" class="difflineplus">+    content/messenger/mail3PaneWindowCommands.js    (content/mail3PaneWindowCommands.js)</span>
<a href="#l58.41"></a><span id="l58.41"> *   content/messenger/mailCommands.js               (content/mailCommands.js)</span>
<a href="#l58.42"></a><span id="l58.42"> *   content/messenger/mailCore.js                   (content/mailCore.js)</span>
<a href="#l58.43"></a><span id="l58.43" class="difflineminus">-*   content/messenger/commandglue.js                (content/commandglue.js)</span>
<a href="#l58.44"></a><span id="l58.44" class="difflineplus">+    content/messenger/commandglue.js                (content/commandglue.js)</span>
<a href="#l58.45"></a><span id="l58.45"> *   content/messenger/widgetglue.js                 (content/widgetglue.js)</span>
<a href="#l58.46"></a><span id="l58.46"> *   content/messenger/SearchDialog.xul              (content/SearchDialog.xul)</span>
<a href="#l58.47"></a><span id="l58.47">     content/messenger/SearchDialog.js               (content/SearchDialog.js)</span>
<a href="#l58.48"></a><span id="l58.48"> *   content/messenger/ABSearchDialog.xul            (content/ABSearchDialog.xul)</span>
<a href="#l58.49"></a><span id="l58.49"> *   content/messenger/ABSearchDialog.js             (content/ABSearchDialog.js)</span>
<a href="#l58.50"></a><span id="l58.50"> *   content/messenger/FilterListDialog.xul          (content/FilterListDialog.xul)</span>
<a href="#l58.51"></a><span id="l58.51"> *   content/messenger/FilterListDialog.js           (content/FilterListDialog.js)</span>
<a href="#l58.52"></a><span id="l58.52">     content/messenger/specialTabs.js                (content/specialTabs.js)</span>
<a href="#l58.53"></a><span id="l58.53" class="difflineat">@@ -48,25 +51,25 @@ messenger.jar:</span>
<a href="#l58.54"></a><span id="l58.54"> *   content/messenger/aboutDialog.xul               (content/aboutDialog.xul)</span>
<a href="#l58.55"></a><span id="l58.55"> *   content/messenger/aboutDialog.js                (content/aboutDialog.js)</span>
<a href="#l58.56"></a><span id="l58.56"> *   content/messenger/aboutRights.xhtml             (content/aboutRights.xhtml)</span>
<a href="#l58.57"></a><span id="l58.57"> *   content/messenger/systemIntegrationDialog.xul   (content/systemIntegrationDialog.xul)</span>
<a href="#l58.58"></a><span id="l58.58"> *   content/messenger/systemIntegrationDialog.js    (content/systemIntegrationDialog.js)</span>
<a href="#l58.59"></a><span id="l58.59">     content/messenger/folderPane.js                 (content/folderPane.js)</span>
<a href="#l58.60"></a><span id="l58.60"> *   content/messenger/msgSelectOffline.xul          (content/msgSelectOffline.xul)</span>
<a href="#l58.61"></a><span id="l58.61"> *   content/messenger/msgPrintEngine.xul            (content/msgPrintEngine.xul)</span>
<a href="#l58.62"></a><span id="l58.62" class="difflineminus">-*   content/messenger/searchBar.js                  (content/searchBar.js)</span>
<a href="#l58.63"></a><span id="l58.63" class="difflineminus">-*   content/messenger/phishingDetector.js           (content/phishingDetector.js)</span>
<a href="#l58.64"></a><span id="l58.64" class="difflineplus">+    content/messenger/searchBar.js                  (content/searchBar.js)</span>
<a href="#l58.65"></a><span id="l58.65" class="difflineplus">+    content/messenger/phishingDetector.js           (content/phishingDetector.js)</span>
<a href="#l58.66"></a><span id="l58.66"> *   content/messenger/mail-offline.js               (content/mail-offline.js)</span>
<a href="#l58.67"></a><span id="l58.67">     content/messenger/about-footer.png              (content/about-footer.png)</span>
<a href="#l58.68"></a><span id="l58.68">     content/messenger/aboutDialog.css               (content/aboutDialog.css)</span>
<a href="#l58.69"></a><span id="l58.69"> *   content/messenger/credits.xhtml                 (content/credits.xhtml)</span>
<a href="#l58.70"></a><span id="l58.70">     content/messenger/messenger.css                 (content/messenger.css)</span>
<a href="#l58.71"></a><span id="l58.71"> *   content/messenger/search.xml                    (content/search.xml)</span>
<a href="#l58.72"></a><span id="l58.72" class="difflineminus">-*   content/messenger/tabmail.xml                   (content/tabmail.xml)</span>
<a href="#l58.73"></a><span id="l58.73" class="difflineplus">+    content/messenger/tabmail.xml                   (content/tabmail.xml)</span>
<a href="#l58.74"></a><span id="l58.74"> *   content/messenger/newmailalert.xul              (content/newmailalert.xul)</span>
<a href="#l58.75"></a><span id="l58.75">     content/messenger/newmailalert.js               (content/newmailalert.js)</span>
<a href="#l58.76"></a><span id="l58.76">     content/messenger/newTagDialog.xul              (content/newTagDialog.xul)</span>
<a href="#l58.77"></a><span id="l58.77">     content/messenger/newTagDialog.js               (content/newTagDialog.js)</span>
<a href="#l58.78"></a><span id="l58.78"> *   content/messenger/viewSourceOverlay.xul         (content/viewSourceOverlay.xul)</span>
<a href="#l58.79"></a><span id="l58.79"> *   content/messenger/configEditorOverlay.xul       (content/configEditorOverlay.xul)</span>
<a href="#l58.80"></a><span id="l58.80">     content/messenger/composerOverlay.css           (content/composerOverlay.css)</span>
<a href="#l58.81"></a><span id="l58.81">     content/messenger/threadPane.js                 (content/threadPane.js)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l59.1"></a><span id="l59.1" class="difflineminus">--- a/mail/components/compose/content/MsgComposeCommands.js</span>
<a href="#l59.2"></a><span id="l59.2" class="difflineplus">+++ b/mail/components/compose/content/MsgComposeCommands.js</span>
<a href="#l59.3"></a><span id="l59.3" class="difflineat">@@ -1,48 +1,48 @@</span>
<a href="#l59.4"></a><span id="l59.4" class="difflineminus">-# -*- Mode: JavaScript; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 4 -*-</span>
<a href="#l59.5"></a><span id="l59.5" class="difflineminus">-# ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l59.6"></a><span id="l59.6" class="difflineminus">-# Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l59.7"></a><span id="l59.7" class="difflineminus">-#</span>
<a href="#l59.8"></a><span id="l59.8" class="difflineminus">-# The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l59.9"></a><span id="l59.9" class="difflineminus">-# 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l59.10"></a><span id="l59.10" class="difflineminus">-# the License. You may obtain a copy of the License at</span>
<a href="#l59.11"></a><span id="l59.11" class="difflineminus">-# http://www.mozilla.org/MPL/</span>
<a href="#l59.12"></a><span id="l59.12" class="difflineminus">-#</span>
<a href="#l59.13"></a><span id="l59.13" class="difflineminus">-# Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l59.14"></a><span id="l59.14" class="difflineminus">-# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l59.15"></a><span id="l59.15" class="difflineminus">-# for the specific language governing rights and limitations under the</span>
<a href="#l59.16"></a><span id="l59.16" class="difflineminus">-# License.</span>
<a href="#l59.17"></a><span id="l59.17" class="difflineminus">-#</span>
<a href="#l59.18"></a><span id="l59.18" class="difflineminus">-# The Original Code is Mozilla Communicator client code, released</span>
<a href="#l59.19"></a><span id="l59.19" class="difflineminus">-# March 31, 1998.</span>
<a href="#l59.20"></a><span id="l59.20" class="difflineminus">-#</span>
<a href="#l59.21"></a><span id="l59.21" class="difflineminus">-# The Initial Developer of the Original Code is</span>
<a href="#l59.22"></a><span id="l59.22" class="difflineminus">-# Netscape Communications Corporation.</span>
<a href="#l59.23"></a><span id="l59.23" class="difflineminus">-# Portions created by the Initial Developer are Copyright (C) 1998-1999</span>
<a href="#l59.24"></a><span id="l59.24" class="difflineminus">-# the Initial Developer. All Rights Reserved.</span>
<a href="#l59.25"></a><span id="l59.25" class="difflineminus">-#</span>
<a href="#l59.26"></a><span id="l59.26" class="difflineminus">-# Contributor(s):</span>
<a href="#l59.27"></a><span id="l59.27" class="difflineminus">-#   David Bienvenu &lt;bienvenu@nventure.com&gt;</span>
<a href="#l59.28"></a><span id="l59.28" class="difflineminus">-#   Olivier Parniere BT Global Services / Etat francais Ministere de la Defense</span>
<a href="#l59.29"></a><span id="l59.29" class="difflineminus">-#   Simon Wilkinson &lt;simon@sxw.org.uk&gt;</span>
<a href="#l59.30"></a><span id="l59.30" class="difflineminus">-#</span>
<a href="#l59.31"></a><span id="l59.31" class="difflineminus">-# Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l59.32"></a><span id="l59.32" class="difflineminus">-# either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l59.33"></a><span id="l59.33" class="difflineminus">-# the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l59.34"></a><span id="l59.34" class="difflineminus">-# in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l59.35"></a><span id="l59.35" class="difflineminus">-# of those above. If you wish to allow use of your version of this file only</span>
<a href="#l59.36"></a><span id="l59.36" class="difflineminus">-# under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l59.37"></a><span id="l59.37" class="difflineminus">-# use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l59.38"></a><span id="l59.38" class="difflineminus">-# decision by deleting the provisions above and replace them with the notice</span>
<a href="#l59.39"></a><span id="l59.39" class="difflineminus">-# and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l59.40"></a><span id="l59.40" class="difflineminus">-# the provisions above, a recipient may use your version of this file under</span>
<a href="#l59.41"></a><span id="l59.41" class="difflineminus">-# the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l59.42"></a><span id="l59.42" class="difflineminus">-#</span>
<a href="#l59.43"></a><span id="l59.43" class="difflineminus">-# ***** END LICENSE BLOCK *****</span>
<a href="#l59.44"></a><span id="l59.44" class="difflineplus">+/* -*- Mode: JavaScript; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 4 -*-</span>
<a href="#l59.45"></a><span id="l59.45" class="difflineplus">+ * ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l59.46"></a><span id="l59.46" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l59.47"></a><span id="l59.47" class="difflineplus">+ *</span>
<a href="#l59.48"></a><span id="l59.48" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l59.49"></a><span id="l59.49" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l59.50"></a><span id="l59.50" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l59.51"></a><span id="l59.51" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l59.52"></a><span id="l59.52" class="difflineplus">+ *</span>
<a href="#l59.53"></a><span id="l59.53" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l59.54"></a><span id="l59.54" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l59.55"></a><span id="l59.55" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l59.56"></a><span id="l59.56" class="difflineplus">+ * License.</span>
<a href="#l59.57"></a><span id="l59.57" class="difflineplus">+ *</span>
<a href="#l59.58"></a><span id="l59.58" class="difflineplus">+ * The Original Code is Mozilla Communicator client code, released</span>
<a href="#l59.59"></a><span id="l59.59" class="difflineplus">+ * March 31, 1998.</span>
<a href="#l59.60"></a><span id="l59.60" class="difflineplus">+ *</span>
<a href="#l59.61"></a><span id="l59.61" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l59.62"></a><span id="l59.62" class="difflineplus">+ * Netscape Communications Corporation.</span>
<a href="#l59.63"></a><span id="l59.63" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 1998-1999</span>
<a href="#l59.64"></a><span id="l59.64" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l59.65"></a><span id="l59.65" class="difflineplus">+ *</span>
<a href="#l59.66"></a><span id="l59.66" class="difflineplus">+ * Contributor(s):</span>
<a href="#l59.67"></a><span id="l59.67" class="difflineplus">+ *   David Bienvenu &lt;bienvenu@nventure.com&gt;</span>
<a href="#l59.68"></a><span id="l59.68" class="difflineplus">+ *   Olivier Parniere BT Global Services / Etat francais Ministere de la Defense</span>
<a href="#l59.69"></a><span id="l59.69" class="difflineplus">+ *   Simon Wilkinson &lt;simon@sxw.org.uk&gt;</span>
<a href="#l59.70"></a><span id="l59.70" class="difflineplus">+ *</span>
<a href="#l59.71"></a><span id="l59.71" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l59.72"></a><span id="l59.72" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l59.73"></a><span id="l59.73" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l59.74"></a><span id="l59.74" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l59.75"></a><span id="l59.75" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l59.76"></a><span id="l59.76" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l59.77"></a><span id="l59.77" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l59.78"></a><span id="l59.78" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l59.79"></a><span id="l59.79" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l59.80"></a><span id="l59.80" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l59.81"></a><span id="l59.81" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l59.82"></a><span id="l59.82" class="difflineplus">+ *</span>
<a href="#l59.83"></a><span id="l59.83" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l59.84"></a><span id="l59.84"> </span>
<a href="#l59.85"></a><span id="l59.85"> // Ensure the activity modules are loaded for this window.</span>
<a href="#l59.86"></a><span id="l59.86"> Components.utils.import(&quot;resource://app/modules/activity/activityModules.js&quot;);</span>
<a href="#l59.87"></a><span id="l59.87"> </span>
<a href="#l59.88"></a><span id="l59.88"> /**</span>
<a href="#l59.89"></a><span id="l59.89">  * interfaces</span>
<a href="#l59.90"></a><span id="l59.90">  */</span>
<a href="#l59.91"></a><span id="l59.91"> const nsIMsgCompDeliverMode = Components.interfaces.nsIMsgCompDeliverMode;</span>
<a href="#l59.92"></a><span id="l59.92" class="difflineat">@@ -52,17 +52,17 @@ const nsIMsgCompType = Components.interf</span>
<a href="#l59.93"></a><span id="l59.93"> const nsIMsgCompFormat = Components.interfaces.nsIMsgCompFormat;</span>
<a href="#l59.94"></a><span id="l59.94"> const nsIAbPreferMailFormat = Components.interfaces.nsIAbPreferMailFormat;</span>
<a href="#l59.95"></a><span id="l59.95"> const nsIPlaintextEditorMail = Components.interfaces.nsIPlaintextEditor;</span>
<a href="#l59.96"></a><span id="l59.96"> const nsISupportsString = Components.interfaces.nsISupportsString;</span>
<a href="#l59.97"></a><span id="l59.97"> const mozISpellCheckingEngine = Components.interfaces.mozISpellCheckingEngine;</span>
<a href="#l59.98"></a><span id="l59.98"> </span>
<a href="#l59.99"></a><span id="l59.99"> var sDictCount = 0;</span>
<a href="#l59.100"></a><span id="l59.100"> </span>
<a href="#l59.101"></a><span id="l59.101" class="difflineminus">-/* Create message window object. This is use by mail-offline.js and therefore should not be renamed. We need to avoid doing </span>
<a href="#l59.102"></a><span id="l59.102" class="difflineplus">+/* Create message window object. This is use by mail-offline.js and therefore should not be renamed. We need to avoid doing</span>
<a href="#l59.103"></a><span id="l59.103">    this kind of cross file global stuff in the future and instead pass this object as parameter when needed by function</span>
<a href="#l59.104"></a><span id="l59.104">    in the other js file.</span>
<a href="#l59.105"></a><span id="l59.105"> */</span>
<a href="#l59.106"></a><span id="l59.106"> var msgWindow = Components.classes[&quot;@mozilla.org/messenger/msgwindow;1&quot;]</span>
<a href="#l59.107"></a><span id="l59.107">                           .createInstance(Components.interfaces.nsIMsgWindow);</span>
<a href="#l59.108"></a><span id="l59.108"> </span>
<a href="#l59.109"></a><span id="l59.109"> /**</span>
<a href="#l59.110"></a><span id="l59.110">  * Global variables, need to be re-initialized every time mostly because we need to release them when the window close</span>
<a href="#l59.111"></a><span id="l59.111" class="difflineat">@@ -111,17 +111,17 @@ var gEditingDraft;</span>
<a href="#l59.112"></a><span id="l59.112"> </span>
<a href="#l59.113"></a><span id="l59.113"> const kComposeAttachDirPrefName = &quot;mail.compose.attach.dir&quot;;</span>
<a href="#l59.114"></a><span id="l59.114"> </span>
<a href="#l59.115"></a><span id="l59.115"> function InitializeGlobalVariables()</span>
<a href="#l59.116"></a><span id="l59.116"> {</span>
<a href="#l59.117"></a><span id="l59.117">   gAccountManager = Components.classes[&quot;@mozilla.org/messenger/account-manager;1&quot;].getService(Components.interfaces.nsIMsgAccountManager);</span>
<a href="#l59.118"></a><span id="l59.118">   gIOService = Components.classes[&quot;@mozilla.org/network/io-service;1&quot;].getService(Components.interfaces.nsIIOService);</span>
<a href="#l59.119"></a><span id="l59.119">   gPromptService = Components.classes[&quot;@mozilla.org/embedcomp/prompt-service;1&quot;].getService(Components.interfaces.nsIPromptService);</span>
<a href="#l59.120"></a><span id="l59.120" class="difflineminus">-  </span>
<a href="#l59.121"></a><span id="l59.121" class="difflineplus">+</span>
<a href="#l59.122"></a><span id="l59.122">   gMsgCompose = null;</span>
<a href="#l59.123"></a><span id="l59.123">   gWindowLocked = false;</span>
<a href="#l59.124"></a><span id="l59.124">   gContentChanged = false;</span>
<a href="#l59.125"></a><span id="l59.125">   gCurrentIdentity = null;</span>
<a href="#l59.126"></a><span id="l59.126">   defaultSaveOperation = &quot;draft&quot;;</span>
<a href="#l59.127"></a><span id="l59.127">   gSendOrSaveOperationInProgress = false;</span>
<a href="#l59.128"></a><span id="l59.128">   gAutoSaving = false;</span>
<a href="#l59.129"></a><span id="l59.129">   gCloseWindowAfterSave = false;</span>
<a href="#l59.130"></a><span id="l59.130" class="difflineat">@@ -178,34 +178,34 @@ function enableEditableFields()</span>
<a href="#l59.131"></a><span id="l59.131"> </span>
<a href="#l59.132"></a><span id="l59.132"> var gComposeRecyclingListener = {</span>
<a href="#l59.133"></a><span id="l59.133">   onClose: function() {</span>
<a href="#l59.134"></a><span id="l59.134">     //Reset recipients and attachments</span>
<a href="#l59.135"></a><span id="l59.135">     ReleaseAutoCompleteState();</span>
<a href="#l59.136"></a><span id="l59.136">     awResetAllRows();</span>
<a href="#l59.137"></a><span id="l59.137">     RemoveAllAttachments();</span>
<a href="#l59.138"></a><span id="l59.138"> </span>
<a href="#l59.139"></a><span id="l59.139" class="difflineminus">-    // We need to clear the identity popup menu in case the user will change them. </span>
<a href="#l59.140"></a><span id="l59.140" class="difflineplus">+    // We need to clear the identity popup menu in case the user will change them.</span>
<a href="#l59.141"></a><span id="l59.141">     // It will be rebuilt later in ComposeStartup</span>
<a href="#l59.142"></a><span id="l59.142">     ClearIdentityListPopup(document.getElementById(&quot;msgIdentityPopup&quot;));</span>
<a href="#l59.143"></a><span id="l59.143" class="difflineminus">- </span>
<a href="#l59.144"></a><span id="l59.144" class="difflineplus">+</span>
<a href="#l59.145"></a><span id="l59.145">     //Clear the subject</span>
<a href="#l59.146"></a><span id="l59.146">     GetMsgSubjectElement().value = &quot;&quot;;</span>
<a href="#l59.147"></a><span id="l59.147">     // be sure to clear the transaction manager for the subject</span>
<a href="#l59.148"></a><span id="l59.148">     GetMsgSubjectElement().editor.transactionManager.clear();</span>
<a href="#l59.149"></a><span id="l59.149">     SetComposeWindowTitle();</span>
<a href="#l59.150"></a><span id="l59.150"> </span>
<a href="#l59.151"></a><span id="l59.151">     SetContentAndBodyAsUnmodified();</span>
<a href="#l59.152"></a><span id="l59.152">     disableEditableFields();</span>
<a href="#l59.153"></a><span id="l59.153">     ReleaseGlobalVariables();</span>
<a href="#l59.154"></a><span id="l59.154"> </span>
<a href="#l59.155"></a><span id="l59.155">     // Clear the focus</span>
<a href="#l59.156"></a><span id="l59.156">     awGetInputElement(1).removeAttribute('focused');</span>
<a href="#l59.157"></a><span id="l59.157"> </span>
<a href="#l59.158"></a><span id="l59.158" class="difflineminus">-    //Reset Boxes size    </span>
<a href="#l59.159"></a><span id="l59.159" class="difflineplus">+    //Reset Boxes size</span>
<a href="#l59.160"></a><span id="l59.160">     document.getElementById(&quot;headers-box&quot;).removeAttribute(&quot;height&quot;);</span>
<a href="#l59.161"></a><span id="l59.161">     document.getElementById(&quot;appcontent&quot;).removeAttribute(&quot;height&quot;);</span>
<a href="#l59.162"></a><span id="l59.162">     document.getElementById(&quot;addresses-box&quot;).removeAttribute(&quot;width&quot;);</span>
<a href="#l59.163"></a><span id="l59.163">     document.getElementById(&quot;attachments-box&quot;).removeAttribute(&quot;width&quot;);</span>
<a href="#l59.164"></a><span id="l59.164"> </span>
<a href="#l59.165"></a><span id="l59.165">     //Reset menu options</span>
<a href="#l59.166"></a><span id="l59.166">     document.getElementById(&quot;format_auto&quot;).setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l59.167"></a><span id="l59.167">     document.getElementById(&quot;priority_normal&quot;).setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l59.168"></a><span id="l59.168" class="difflineat">@@ -219,17 +219,17 @@ var gComposeRecyclingListener = {</span>
<a href="#l59.169"></a><span id="l59.169">       if (showFormat.getAttribute(&quot;checked&quot;) == &quot;true&quot;)</span>
<a href="#l59.170"></a><span id="l59.170">         document.getElementById(&quot;FormatToolbar&quot;).hidden = false;</span>
<a href="#l59.171"></a><span id="l59.171">     }</span>
<a href="#l59.172"></a><span id="l59.172"> </span>
<a href="#l59.173"></a><span id="l59.173">     // Stop InlineSpellCheckerUI so personal dictionary is saved</span>
<a href="#l59.174"></a><span id="l59.174">     enableInlineSpellCheck(false);</span>
<a href="#l59.175"></a><span id="l59.175">     // clear any suggestions in the context menu</span>
<a href="#l59.176"></a><span id="l59.176">     InlineSpellCheckerUI.clearSuggestionsFromMenu();</span>
<a href="#l59.177"></a><span id="l59.177" class="difflineminus">-           </span>
<a href="#l59.178"></a><span id="l59.178" class="difflineplus">+</span>
<a href="#l59.179"></a><span id="l59.179">     //Reset editor</span>
<a href="#l59.180"></a><span id="l59.180">     EditorResetFontAndColorAttributes();</span>
<a href="#l59.181"></a><span id="l59.181">     EditorCleanup();</span>
<a href="#l59.182"></a><span id="l59.182"> </span>
<a href="#l59.183"></a><span id="l59.183">     //Release the nsIMsgComposeParams object</span>
<a href="#l59.184"></a><span id="l59.184">     if (window.arguments &amp;&amp; window.arguments[0])</span>
<a href="#l59.185"></a><span id="l59.185">       window.arguments[0] = null;</span>
<a href="#l59.186"></a><span id="l59.186"> </span>
<a href="#l59.187"></a><span id="l59.187" class="difflineat">@@ -265,31 +265,31 @@ var stateListener = {</span>
<a href="#l59.188"></a><span id="l59.188">     gWindowLocked = false;</span>
<a href="#l59.189"></a><span id="l59.189">     enableEditableFields();</span>
<a href="#l59.190"></a><span id="l59.190">     updateComposeItems();</span>
<a href="#l59.191"></a><span id="l59.191"> </span>
<a href="#l59.192"></a><span id="l59.192">     if (aResult== Components.results.NS_OK)</span>
<a href="#l59.193"></a><span id="l59.193">     {</span>
<a href="#l59.194"></a><span id="l59.194">       if (!gAutoSaving)</span>
<a href="#l59.195"></a><span id="l59.195">         SetContentAndBodyAsUnmodified();</span>
<a href="#l59.196"></a><span id="l59.196" class="difflineminus">-     </span>
<a href="#l59.197"></a><span id="l59.197" class="difflineplus">+</span>
<a href="#l59.198"></a><span id="l59.198">       if (gCloseWindowAfterSave)</span>
<a href="#l59.199"></a><span id="l59.199">       {</span>
<a href="#l59.200"></a><span id="l59.200">         // Notify the SendListener that Send has been aborted and Stopped</span>
<a href="#l59.201"></a><span id="l59.201">         if (gMsgCompose)</span>
<a href="#l59.202"></a><span id="l59.202">           gMsgCompose.onSendNotPerformed(null, Components.results.NS_ERROR_ABORT);</span>
<a href="#l59.203"></a><span id="l59.203"> </span>
<a href="#l59.204"></a><span id="l59.204">         MsgComposeCloseWindow(true);</span>
<a href="#l59.205"></a><span id="l59.205">       }</span>
<a href="#l59.206"></a><span id="l59.206">     }</span>
<a href="#l59.207"></a><span id="l59.207">     // else if we failed to save, and we're autosaving, need to re-mark the editor</span>
<a href="#l59.208"></a><span id="l59.208">     // as changed, so that we won't lose the changes.</span>
<a href="#l59.209"></a><span id="l59.209">     else if (gAutoSaving)</span>
<a href="#l59.210"></a><span id="l59.210">     {</span>
<a href="#l59.211"></a><span id="l59.211" class="difflineminus">-      gMsgCompose.bodyModified = true; </span>
<a href="#l59.212"></a><span id="l59.212" class="difflineplus">+      gMsgCompose.bodyModified = true;</span>
<a href="#l59.213"></a><span id="l59.213">       gContentChanged = true;</span>
<a href="#l59.214"></a><span id="l59.214">     }</span>
<a href="#l59.215"></a><span id="l59.215">     gAutoSaving = false;</span>
<a href="#l59.216"></a><span id="l59.216">     gCloseWindowAfterSave = false;</span>
<a href="#l59.217"></a><span id="l59.217">   },</span>
<a href="#l59.218"></a><span id="l59.218"> </span>
<a href="#l59.219"></a><span id="l59.219">   SaveInFolderDone: function(folderURI) {</span>
<a href="#l59.220"></a><span id="l59.220">     DisplaySaveFolderDlg(folderURI);</span>
<a href="#l59.221"></a><span id="l59.221" class="difflineat">@@ -299,42 +299,42 @@ var stateListener = {</span>
<a href="#l59.222"></a><span id="l59.222"> // all progress notifications are done through the nsIWebProgressListener implementation...</span>
<a href="#l59.223"></a><span id="l59.223"> var progressListener = {</span>
<a href="#l59.224"></a><span id="l59.224">     onStateChange: function(aWebProgress, aRequest, aStateFlags, aStatus)</span>
<a href="#l59.225"></a><span id="l59.225">     {</span>
<a href="#l59.226"></a><span id="l59.226">       if (aStateFlags &amp; Components.interfaces.nsIWebProgressListener.STATE_START)</span>
<a href="#l59.227"></a><span id="l59.227">       {</span>
<a href="#l59.228"></a><span id="l59.228">         document.getElementById('compose-progressmeter').setAttribute( &quot;mode&quot;, &quot;undetermined&quot; );</span>
<a href="#l59.229"></a><span id="l59.229">       }</span>
<a href="#l59.230"></a><span id="l59.230" class="difflineminus">-      </span>
<a href="#l59.231"></a><span id="l59.231" class="difflineplus">+</span>
<a href="#l59.232"></a><span id="l59.232">       if (aStateFlags &amp; Components.interfaces.nsIWebProgressListener.STATE_STOP)</span>
<a href="#l59.233"></a><span id="l59.233">       {</span>
<a href="#l59.234"></a><span id="l59.234">         gSendOrSaveOperationInProgress = false;</span>
<a href="#l59.235"></a><span id="l59.235">         document.getElementById('compose-progressmeter').setAttribute( &quot;mode&quot;, &quot;normal&quot; );</span>
<a href="#l59.236"></a><span id="l59.236">         document.getElementById('compose-progressmeter').setAttribute( &quot;value&quot;, 0 );</span>
<a href="#l59.237"></a><span id="l59.237">         document.getElementById('statusText').setAttribute('label', '');</span>
<a href="#l59.238"></a><span id="l59.238">       }</span>
<a href="#l59.239"></a><span id="l59.239">     },</span>
<a href="#l59.240"></a><span id="l59.240" class="difflineminus">-    </span>
<a href="#l59.241"></a><span id="l59.241" class="difflineplus">+</span>
<a href="#l59.242"></a><span id="l59.242">     onProgressChange: function(aWebProgress, aRequest, aCurSelfProgress, aMaxSelfProgress, aCurTotalProgress, aMaxTotalProgress)</span>
<a href="#l59.243"></a><span id="l59.243">     {</span>
<a href="#l59.244"></a><span id="l59.244">       // Calculate percentage.</span>
<a href="#l59.245"></a><span id="l59.245">       var percent;</span>
<a href="#l59.246"></a><span id="l59.246" class="difflineminus">-      if ( aMaxTotalProgress &gt; 0 ) </span>
<a href="#l59.247"></a><span id="l59.247" class="difflineplus">+      if ( aMaxTotalProgress &gt; 0 )</span>
<a href="#l59.248"></a><span id="l59.248">       {</span>
<a href="#l59.249"></a><span id="l59.249">         percent = Math.round( (aCurTotalProgress*100)/aMaxTotalProgress );</span>
<a href="#l59.250"></a><span id="l59.250">         if ( percent &gt; 100 )</span>
<a href="#l59.251"></a><span id="l59.251">           percent = 100;</span>
<a href="#l59.252"></a><span id="l59.252" class="difflineminus">-        </span>
<a href="#l59.253"></a><span id="l59.253" class="difflineplus">+</span>
<a href="#l59.254"></a><span id="l59.254">         document.getElementById('compose-progressmeter').removeAttribute(&quot;mode&quot;);</span>
<a href="#l59.255"></a><span id="l59.255" class="difflineminus">-        </span>
<a href="#l59.256"></a><span id="l59.256" class="difflineplus">+</span>
<a href="#l59.257"></a><span id="l59.257">         // Advance progress meter.</span>
<a href="#l59.258"></a><span id="l59.258">         document.getElementById('compose-progressmeter').setAttribute( &quot;value&quot;, percent );</span>
<a href="#l59.259"></a><span id="l59.259" class="difflineminus">-      } </span>
<a href="#l59.260"></a><span id="l59.260" class="difflineminus">-      else </span>
<a href="#l59.261"></a><span id="l59.261" class="difflineplus">+      }</span>
<a href="#l59.262"></a><span id="l59.262" class="difflineplus">+      else</span>
<a href="#l59.263"></a><span id="l59.263">       {</span>
<a href="#l59.264"></a><span id="l59.264">         // Progress meter should be barber-pole in this case.</span>
<a href="#l59.265"></a><span id="l59.265">         document.getElementById('compose-progressmeter').setAttribute( &quot;mode&quot;, &quot;undetermined&quot; );</span>
<a href="#l59.266"></a><span id="l59.266">       }</span>
<a href="#l59.267"></a><span id="l59.267">     },</span>
<a href="#l59.268"></a><span id="l59.268"> </span>
<a href="#l59.269"></a><span id="l59.269">     onLocationChange: function(aWebProgress, aRequest, aLocation)</span>
<a href="#l59.270"></a><span id="l59.270">     {</span>
<a href="#l59.271"></a><span id="l59.271" class="difflineat">@@ -358,17 +358,17 @@ var progressListener = {</span>
<a href="#l59.272"></a><span id="l59.272">     },</span>
<a href="#l59.273"></a><span id="l59.273"> </span>
<a href="#l59.274"></a><span id="l59.274">     QueryInterface : function(iid)</span>
<a href="#l59.275"></a><span id="l59.275">     {</span>
<a href="#l59.276"></a><span id="l59.276">       if (iid.equals(Components.interfaces.nsIWebProgressListener) ||</span>
<a href="#l59.277"></a><span id="l59.277">           iid.equals(Components.interfaces.nsISupportsWeakReference) ||</span>
<a href="#l59.278"></a><span id="l59.278">           iid.equals(Components.interfaces.nsISupports))</span>
<a href="#l59.279"></a><span id="l59.279">         return this;</span>
<a href="#l59.280"></a><span id="l59.280" class="difflineminus">-     </span>
<a href="#l59.281"></a><span id="l59.281" class="difflineplus">+</span>
<a href="#l59.282"></a><span id="l59.282">       throw Components.results.NS_NOINTERFACE;</span>
<a href="#l59.283"></a><span id="l59.283">     }</span>
<a href="#l59.284"></a><span id="l59.284"> };</span>
<a href="#l59.285"></a><span id="l59.285"> </span>
<a href="#l59.286"></a><span id="l59.286"> var defaultController =</span>
<a href="#l59.287"></a><span id="l59.287"> {</span>
<a href="#l59.288"></a><span id="l59.288">   supportsCommand: function(command)</span>
<a href="#l59.289"></a><span id="l59.289">   {</span>
<a href="#l59.290"></a><span id="l59.290" class="difflineat">@@ -464,17 +464,17 @@ var defaultController =</span>
<a href="#l59.291"></a><span id="l59.291"> </span>
<a href="#l59.292"></a><span id="l59.292">       default:</span>
<a href="#l59.293"></a><span id="l59.293"> //        dump(&quot;##MsgCompose: command &quot; + command + &quot; disabled!\n&quot;);</span>
<a href="#l59.294"></a><span id="l59.294">         return false;</span>
<a href="#l59.295"></a><span id="l59.295">     }</span>
<a href="#l59.296"></a><span id="l59.296">   },</span>
<a href="#l59.297"></a><span id="l59.297"> </span>
<a href="#l59.298"></a><span id="l59.298">   doCommand: function(command)</span>
<a href="#l59.299"></a><span id="l59.299" class="difflineminus">-  { </span>
<a href="#l59.300"></a><span id="l59.300" class="difflineplus">+  {</span>
<a href="#l59.301"></a><span id="l59.301">     switch (command)</span>
<a href="#l59.302"></a><span id="l59.302">     {</span>
<a href="#l59.303"></a><span id="l59.303">       //File Menu</span>
<a href="#l59.304"></a><span id="l59.304">       case &quot;cmd_attachFile&quot;         : if (defaultController.isCommandEnabled(command)) AttachFile();           break;</span>
<a href="#l59.305"></a><span id="l59.305">       case &quot;cmd_attachPage&quot;         : AttachPage();           break;</span>
<a href="#l59.306"></a><span id="l59.306">       case &quot;cmd_close&quot;              : DoCommandClose();       break;</span>
<a href="#l59.307"></a><span id="l59.307">       case &quot;cmd_saveDefault&quot;        : Save();                 break;</span>
<a href="#l59.308"></a><span id="l59.308">       case &quot;cmd_saveAsFile&quot;         : SaveAsFile(true);       break;</span>
<a href="#l59.309"></a><span id="l59.309" class="difflineat">@@ -549,17 +549,17 @@ function QuoteSelectedMessage()</span>
<a href="#l59.310"></a><span id="l59.310"> </span>
<a href="#l59.311"></a><span id="l59.311"> function GetSelectedMessages()</span>
<a href="#l59.312"></a><span id="l59.312"> {</span>
<a href="#l59.313"></a><span id="l59.313">   if (gMsgCompose) {</span>
<a href="#l59.314"></a><span id="l59.314">     var mailWindow = Components.classes[&quot;@mozilla.org/appshell/window-mediator;1&quot;].getService()</span>
<a href="#l59.315"></a><span id="l59.315">                      .QueryInterface(Components.interfaces.nsIWindowMediator)</span>
<a href="#l59.316"></a><span id="l59.316">                      .getMostRecentWindow(&quot;mail:3pane&quot;);</span>
<a href="#l59.317"></a><span id="l59.317">     if (mailWindow) {</span>
<a href="#l59.318"></a><span id="l59.318" class="difflineminus">-      return mailWindow.GetSelectedMessages();</span>
<a href="#l59.319"></a><span id="l59.319" class="difflineplus">+      return mailWindow.gFolderDisplay.selectedMessageUris;</span>
<a href="#l59.320"></a><span id="l59.320">     }</span>
<a href="#l59.321"></a><span id="l59.321">   }</span>
<a href="#l59.322"></a><span id="l59.322"> </span>
<a href="#l59.323"></a><span id="l59.323">   return null;</span>
<a href="#l59.324"></a><span id="l59.324"> }</span>
<a href="#l59.325"></a><span id="l59.325"> </span>
<a href="#l59.326"></a><span id="l59.326"> function SetupCommandUpdateHandlers()</span>
<a href="#l59.327"></a><span id="l59.327"> {</span>
<a href="#l59.328"></a><span id="l59.328" class="difflineat">@@ -579,17 +579,17 @@ function CommandUpdate_MsgCompose()</span>
<a href="#l59.329"></a><span id="l59.329">   if (focusedWindow == gLastWindowToHaveFocus) {</span>
<a href="#l59.330"></a><span id="l59.330">     //dump(&quot;XXX skip\n&quot;);</span>
<a href="#l59.331"></a><span id="l59.331">     return;</span>
<a href="#l59.332"></a><span id="l59.332">   }</span>
<a href="#l59.333"></a><span id="l59.333"> </span>
<a href="#l59.334"></a><span id="l59.334">   gLastWindowToHaveFocus = focusedWindow;</span>
<a href="#l59.335"></a><span id="l59.335"> </span>
<a href="#l59.336"></a><span id="l59.336">   //dump(&quot;XXX update, focus on &quot; + focusedWindow + &quot;\n&quot;);</span>
<a href="#l59.337"></a><span id="l59.337" class="difflineminus">-  </span>
<a href="#l59.338"></a><span id="l59.338" class="difflineplus">+</span>
<a href="#l59.339"></a><span id="l59.339">   updateComposeItems();</span>
<a href="#l59.340"></a><span id="l59.340"> }</span>
<a href="#l59.341"></a><span id="l59.341"> </span>
<a href="#l59.342"></a><span id="l59.342"> function updateComposeItems()</span>
<a href="#l59.343"></a><span id="l59.343"> {</span>
<a href="#l59.344"></a><span id="l59.344">   try {</span>
<a href="#l59.345"></a><span id="l59.345">     // Edit Menu</span>
<a href="#l59.346"></a><span id="l59.346">     goUpdateCommand(&quot;cmd_rewrap&quot;);</span>
<a href="#l59.347"></a><span id="l59.347" class="difflineat">@@ -641,40 +641,40 @@ function updateEditItems()</span>
<a href="#l59.348"></a><span id="l59.348">   goUpdateCommand(&quot;cmd_renameAttachment&quot;);</span>
<a href="#l59.349"></a><span id="l59.349">   goUpdateCommand(&quot;cmd_selectAll&quot;);</span>
<a href="#l59.350"></a><span id="l59.350">   goUpdateCommand(&quot;cmd_openAttachment&quot;);</span>
<a href="#l59.351"></a><span id="l59.351">   goUpdateCommand(&quot;cmd_find&quot;);</span>
<a href="#l59.352"></a><span id="l59.352">   goUpdateCommand(&quot;cmd_findNext&quot;);</span>
<a href="#l59.353"></a><span id="l59.353">   goUpdateCommand(&quot;cmd_findPrev&quot;);</span>
<a href="#l59.354"></a><span id="l59.354"> }</span>
<a href="#l59.355"></a><span id="l59.355"> </span>
<a href="#l59.356"></a><span id="l59.356" class="difflineminus">-var messageComposeOfflineObserver = </span>
<a href="#l59.357"></a><span id="l59.357" class="difflineplus">+var messageComposeOfflineObserver =</span>
<a href="#l59.358"></a><span id="l59.358"> {</span>
<a href="#l59.359"></a><span id="l59.359" class="difflineminus">-  observe: function(subject, topic, state) </span>
<a href="#l59.360"></a><span id="l59.360" class="difflineplus">+  observe: function(subject, topic, state)</span>
<a href="#l59.361"></a><span id="l59.361">   {</span>
<a href="#l59.362"></a><span id="l59.362">     // sanity checks</span>
<a href="#l59.363"></a><span id="l59.363" class="difflineminus">-    if (topic != &quot;network:offline-status-changed&quot;) </span>
<a href="#l59.364"></a><span id="l59.364" class="difflineplus">+    if (topic != &quot;network:offline-status-changed&quot;)</span>
<a href="#l59.365"></a><span id="l59.365">       return;</span>
<a href="#l59.366"></a><span id="l59.366">     gIsOffline = state == &quot;offline&quot;;</span>
<a href="#l59.367"></a><span id="l59.367">     MessageComposeOfflineStateChanged(gIsOffline);</span>
<a href="#l59.368"></a><span id="l59.368"> </span>
<a href="#l59.369"></a><span id="l59.369">     try {</span>
<a href="#l59.370"></a><span id="l59.370">       setupLdapAutocompleteSession();</span>
<a href="#l59.371"></a><span id="l59.371">     } catch (ex) {</span>
<a href="#l59.372"></a><span id="l59.372" class="difflineminus">-      // catch the exception and ignore it, so that if LDAP setup </span>
<a href="#l59.373"></a><span id="l59.373" class="difflineplus">+      // catch the exception and ignore it, so that if LDAP setup</span>
<a href="#l59.374"></a><span id="l59.374">       // fails, the entire compose window stuff doesn't get aborted</span>
<a href="#l59.375"></a><span id="l59.375">     }</span>
<a href="#l59.376"></a><span id="l59.376">   }</span>
<a href="#l59.377"></a><span id="l59.377"> }</span>
<a href="#l59.378"></a><span id="l59.378"> </span>
<a href="#l59.379"></a><span id="l59.379"> function AddMessageComposeOfflineObserver()</span>
<a href="#l59.380"></a><span id="l59.380"> {</span>
<a href="#l59.381"></a><span id="l59.381">   var observerService = Components.classes[&quot;@mozilla.org/observer-service;1&quot;].getService(Components.interfaces.nsIObserverService);</span>
<a href="#l59.382"></a><span id="l59.382">   observerService.addObserver(messageComposeOfflineObserver, &quot;network:offline-status-changed&quot;, false);</span>
<a href="#l59.383"></a><span id="l59.383" class="difflineminus">-  </span>
<a href="#l59.384"></a><span id="l59.384" class="difflineplus">+</span>
<a href="#l59.385"></a><span id="l59.385">   gIsOffline = gIOService.offline;</span>
<a href="#l59.386"></a><span id="l59.386">   // set the initial state of the send button</span>
<a href="#l59.387"></a><span id="l59.387">   MessageComposeOfflineStateChanged(gIsOffline);</span>
<a href="#l59.388"></a><span id="l59.388"> }</span>
<a href="#l59.389"></a><span id="l59.389"> </span>
<a href="#l59.390"></a><span id="l59.390"> function RemoveMessageComposeOfflineObserver()</span>
<a href="#l59.391"></a><span id="l59.391"> {</span>
<a href="#l59.392"></a><span id="l59.392">   var observerService = Components.classes[&quot;@mozilla.org/observer-service;1&quot;].getService(Components.interfaces.nsIObserverService);</span>
<a href="#l59.393"></a><span id="l59.393" class="difflineat">@@ -712,17 +712,17 @@ function MessageComposeOfflineStateChang</span>
<a href="#l59.394"></a><span id="l59.394">   } catch(e) {}</span>
<a href="#l59.395"></a><span id="l59.395"> }</span>
<a href="#l59.396"></a><span id="l59.396"> </span>
<a href="#l59.397"></a><span id="l59.397"> var directoryServerObserver = {</span>
<a href="#l59.398"></a><span id="l59.398">   observe: function(subject, topic, value) {</span>
<a href="#l59.399"></a><span id="l59.399">       try {</span>
<a href="#l59.400"></a><span id="l59.400">           setupLdapAutocompleteSession();</span>
<a href="#l59.401"></a><span id="l59.401">       } catch (ex) {</span>
<a href="#l59.402"></a><span id="l59.402" class="difflineminus">-          // catch the exception and ignore it, so that if LDAP setup </span>
<a href="#l59.403"></a><span id="l59.403" class="difflineplus">+          // catch the exception and ignore it, so that if LDAP setup</span>
<a href="#l59.404"></a><span id="l59.404">           // fails, the entire compose window doesn't get horked</span>
<a href="#l59.405"></a><span id="l59.405">       }</span>
<a href="#l59.406"></a><span id="l59.406">   }</span>
<a href="#l59.407"></a><span id="l59.407"> }</span>
<a href="#l59.408"></a><span id="l59.408"> </span>
<a href="#l59.409"></a><span id="l59.409"> function AddDirectoryServerObserver(flag) {</span>
<a href="#l59.410"></a><span id="l59.410">   var branch = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l59.411"></a><span id="l59.411">                          .getService(Components.interfaces.nsIPrefBranch2);</span>
<a href="#l59.412"></a><span id="l59.412" class="difflineat">@@ -802,31 +802,31 @@ function setupLdapAutocompleteSession()</span>
<a href="#l59.413"></a><span id="l59.413">             .classes[&quot;@mozilla.org/autocompleteSession;1?type=ldap&quot;];</span>
<a href="#l59.414"></a><span id="l59.414">         if (LDAPSession) {</span>
<a href="#l59.415"></a><span id="l59.415">           try {</span>
<a href="#l59.416"></a><span id="l59.416">             LDAPSession = LDAPSession.createInstance()</span>
<a href="#l59.417"></a><span id="l59.417">                 .QueryInterface(Components.interfaces.nsILDAPAutoCompleteSession);</span>
<a href="#l59.418"></a><span id="l59.418">           } catch (ex) {dump (&quot;ERROR: Cannot get the LDAP autocomplete session\n&quot; + ex + &quot;\n&quot;);}</span>
<a href="#l59.419"></a><span id="l59.419">         }</span>
<a href="#l59.420"></a><span id="l59.420">     }</span>
<a href="#l59.421"></a><span id="l59.421" class="difflineminus">-            </span>
<a href="#l59.422"></a><span id="l59.422" class="difflineminus">-    if (autocompleteDirectory &amp;&amp; !gIsOffline) { </span>
<a href="#l59.423"></a><span id="l59.423" class="difflineplus">+</span>
<a href="#l59.424"></a><span id="l59.424" class="difflineplus">+    if (autocompleteDirectory &amp;&amp; !gIsOffline) {</span>
<a href="#l59.425"></a><span id="l59.425">         // Add observer on the directory server we are autocompleting against</span>
<a href="#l59.426"></a><span id="l59.426">         // only if current server is different from previous.</span>
<a href="#l59.427"></a><span id="l59.427" class="difflineminus">-        // Remove observer if current server is different from previous       </span>
<a href="#l59.428"></a><span id="l59.428" class="difflineplus">+        // Remove observer if current server is different from previous</span>
<a href="#l59.429"></a><span id="l59.429">         gCurrentAutocompleteDirectory = autocompleteDirectory;</span>
<a href="#l59.430"></a><span id="l59.430">         if (prevAutocompleteDirectory) {</span>
<a href="#l59.431"></a><span id="l59.431" class="difflineminus">-          if (prevAutocompleteDirectory != gCurrentAutocompleteDirectory) { </span>
<a href="#l59.432"></a><span id="l59.432" class="difflineplus">+          if (prevAutocompleteDirectory != gCurrentAutocompleteDirectory) {</span>
<a href="#l59.433"></a><span id="l59.433">             RemoveDirectorySettingsObserver(prevAutocompleteDirectory);</span>
<a href="#l59.434"></a><span id="l59.434">             AddDirectorySettingsObserver();</span>
<a href="#l59.435"></a><span id="l59.435">           }</span>
<a href="#l59.436"></a><span id="l59.436">         }</span>
<a href="#l59.437"></a><span id="l59.437">         else</span>
<a href="#l59.438"></a><span id="l59.438">           AddDirectorySettingsObserver();</span>
<a href="#l59.439"></a><span id="l59.439" class="difflineminus">-        </span>
<a href="#l59.440"></a><span id="l59.440" class="difflineplus">+</span>
<a href="#l59.441"></a><span id="l59.441">         // fill in the session params if there is a session</span>
<a href="#l59.442"></a><span id="l59.442">         //</span>
<a href="#l59.443"></a><span id="l59.443">         if (LDAPSession) {</span>
<a href="#l59.444"></a><span id="l59.444">             let url = getPref(autocompleteDirectory + &quot;.uri&quot;, true);</span>
<a href="#l59.445"></a><span id="l59.445"> </span>
<a href="#l59.446"></a><span id="l59.446">             LDAPSession.serverURL =</span>
<a href="#l59.447"></a><span id="l59.447">               Components.classes[&quot;@mozilla.org/network/io-service;1&quot;]</span>
<a href="#l59.448"></a><span id="l59.448">                         .getService(Components.interfaces.nsIIOService)</span>
<a href="#l59.449"></a><span id="l59.449" class="difflineat">@@ -837,48 +837,48 @@ function setupLdapAutocompleteSession()</span>
<a href="#l59.450"></a><span id="l59.450">             //</span>
<a href="#l59.451"></a><span id="l59.451">             try {</span>
<a href="#l59.452"></a><span id="l59.452">                 LDAPSession.login = getPref(autocompleteDirectory + &quot;.auth.dn&quot;, true);</span>
<a href="#l59.453"></a><span id="l59.453">             } catch (ex) {</span>
<a href="#l59.454"></a><span id="l59.454">                 // if we don't have this pref, no big deal</span>
<a href="#l59.455"></a><span id="l59.455">             }</span>
<a href="#l59.456"></a><span id="l59.456"> </span>
<a href="#l59.457"></a><span id="l59.457">             try {</span>
<a href="#l59.458"></a><span id="l59.458" class="difflineminus">-                 LDAPSession.saslMechanism = getPref(autocompleteDirectory + </span>
<a href="#l59.459"></a><span id="l59.459" class="difflineplus">+                 LDAPSession.saslMechanism = getPref(autocompleteDirectory +</span>
<a href="#l59.460"></a><span id="l59.460"> 		    &quot;.auth.saslmech&quot;, true);</span>
<a href="#l59.461"></a><span id="l59.461">             } catch (ex) {</span>
<a href="#l59.462"></a><span id="l59.462">                 // don't care if we don't have this pref</span>
<a href="#l59.463"></a><span id="l59.463">             }</span>
<a href="#l59.464"></a><span id="l59.464" class="difflineminus">-            </span>
<a href="#l59.465"></a><span id="l59.465" class="difflineplus">+</span>
<a href="#l59.466"></a><span id="l59.466">             // set the LDAP protocol version correctly</span>
<a href="#l59.467"></a><span id="l59.467">             var protocolVersion;</span>
<a href="#l59.468"></a><span id="l59.468" class="difflineminus">-            try { </span>
<a href="#l59.469"></a><span id="l59.469" class="difflineplus">+            try {</span>
<a href="#l59.470"></a><span id="l59.470">                 protocolVersion = getPref(autocompleteDirectory +</span>
<a href="#l59.471"></a><span id="l59.471">                                           &quot;.protocolVersion&quot;);</span>
<a href="#l59.472"></a><span id="l59.472">             } catch (ex) {</span>
<a href="#l59.473"></a><span id="l59.473">                 // if we don't have this pref, no big deal</span>
<a href="#l59.474"></a><span id="l59.474">             }</span>
<a href="#l59.475"></a><span id="l59.475">             if (protocolVersion == &quot;2&quot;) {</span>
<a href="#l59.476"></a><span id="l59.476" class="difflineminus">-                LDAPSession.version = </span>
<a href="#l59.477"></a><span id="l59.477" class="difflineplus">+                LDAPSession.version =</span>
<a href="#l59.478"></a><span id="l59.478">                     Components.interfaces.nsILDAPConnection.VERSION2;</span>
<a href="#l59.479"></a><span id="l59.479">             }</span>
<a href="#l59.480"></a><span id="l59.480"> </span>
<a href="#l59.481"></a><span id="l59.481">             // don't search on non-CJK strings shorter than this</span>
<a href="#l59.482"></a><span id="l59.482">             //</span>
<a href="#l59.483"></a><span id="l59.483" class="difflineminus">-            try { </span>
<a href="#l59.484"></a><span id="l59.484" class="difflineplus">+            try {</span>
<a href="#l59.485"></a><span id="l59.485">                 LDAPSession.minStringLength = getPref(</span>
<a href="#l59.486"></a><span id="l59.486">                     autocompleteDirectory + &quot;.autoComplete.minStringLength&quot;);</span>
<a href="#l59.487"></a><span id="l59.487">             } catch (ex) {</span>
<a href="#l59.488"></a><span id="l59.488">                 // if this pref isn't there, no big deal.  just let</span>
<a href="#l59.489"></a><span id="l59.489">                 // nsLDAPAutoCompleteSession use its default.</span>
<a href="#l59.490"></a><span id="l59.490">             }</span>
<a href="#l59.491"></a><span id="l59.491"> </span>
<a href="#l59.492"></a><span id="l59.492">             // don't search on CJK strings shorter than this</span>
<a href="#l59.493"></a><span id="l59.493">             //</span>
<a href="#l59.494"></a><span id="l59.494" class="difflineminus">-            try { </span>
<a href="#l59.495"></a><span id="l59.495" class="difflineplus">+            try {</span>
<a href="#l59.496"></a><span id="l59.496">                 LDAPSession.cjkMinStringLength = getPref(</span>
<a href="#l59.497"></a><span id="l59.497">                   autocompleteDirectory + &quot;.autoComplete.cjkMinStringLength&quot;);</span>
<a href="#l59.498"></a><span id="l59.498">             } catch (ex) {</span>
<a href="#l59.499"></a><span id="l59.499">                 // if this pref isn't there, no big deal.  just let</span>
<a href="#l59.500"></a><span id="l59.500">                 // nsLDAPAutoCompleteSession use its default.</span>
<a href="#l59.501"></a><span id="l59.501">             }</span>
<a href="#l59.502"></a><span id="l59.502"> </span>
<a href="#l59.503"></a><span id="l59.503">             // we don't try/catch here, because if this fails, we're outta luck</span>
<a href="#l59.504"></a><span id="l59.504" class="difflineat">@@ -927,17 +927,17 @@ function setupLdapAutocompleteSession()</span>
<a href="#l59.505"></a><span id="l59.505">                     ldapFormatter.commentFormat = getPref(</span>
<a href="#l59.506"></a><span id="l59.506">                         autocompleteDirectory + &quot;.description&quot;, true);</span>
<a href="#l59.507"></a><span id="l59.507">                     break;</span>
<a href="#l59.508"></a><span id="l59.508"> </span>
<a href="#l59.509"></a><span id="l59.509">                 case 2:</span>
<a href="#l59.510"></a><span id="l59.510">                     // override ldap-specific autocomplete entry?</span>
<a href="#l59.511"></a><span id="l59.511">                     //</span>
<a href="#l59.512"></a><span id="l59.512">                     try {</span>
<a href="#l59.513"></a><span id="l59.513" class="difflineminus">-                        ldapFormatter.commentFormat = </span>
<a href="#l59.514"></a><span id="l59.514" class="difflineplus">+                        ldapFormatter.commentFormat =</span>
<a href="#l59.515"></a><span id="l59.515">                             getPref(autocompleteDirectory +</span>
<a href="#l59.516"></a><span id="l59.516">                                     &quot;.autoComplete.commentFormat&quot;, true);</span>
<a href="#l59.517"></a><span id="l59.517">                     } catch (innerException) {</span>
<a href="#l59.518"></a><span id="l59.518">                         // if nothing has been specified, use the ldap</span>
<a href="#l59.519"></a><span id="l59.519">                         // organization field</span>
<a href="#l59.520"></a><span id="l59.520">                         ldapFormatter.commentFormat = &quot;[o]&quot;;</span>
<a href="#l59.521"></a><span id="l59.521">                     }</span>
<a href="#l59.522"></a><span id="l59.522">                     break;</span>
<a href="#l59.523"></a><span id="l59.523" class="difflineat">@@ -967,51 +967,51 @@ function setupLdapAutocompleteSession()</span>
<a href="#l59.524"></a><span id="l59.524"> </span>
<a href="#l59.525"></a><span id="l59.525">             } catch (ex) {</span>
<a href="#l59.526"></a><span id="l59.526">                 // if this pref isn't there, no big deal.  just let</span>
<a href="#l59.527"></a><span id="l59.527">                 // nsLDAPAutoCompleteSession use its default.</span>
<a href="#l59.528"></a><span id="l59.528">             }</span>
<a href="#l59.529"></a><span id="l59.529"> </span>
<a href="#l59.530"></a><span id="l59.530">             // override default search filter template?</span>
<a href="#l59.531"></a><span id="l59.531">             //</span>
<a href="#l59.532"></a><span id="l59.532" class="difflineminus">-            try { </span>
<a href="#l59.533"></a><span id="l59.533" class="difflineplus">+            try {</span>
<a href="#l59.534"></a><span id="l59.534">                 LDAPSession.filterTemplate = getPref(</span>
<a href="#l59.535"></a><span id="l59.535">                     autocompleteDirectory + &quot;.autoComplete.filterTemplate&quot;,</span>
<a href="#l59.536"></a><span id="l59.536">                     true);</span>
<a href="#l59.537"></a><span id="l59.537"> </span>
<a href="#l59.538"></a><span id="l59.538">             } catch (ex) {</span>
<a href="#l59.539"></a><span id="l59.539">                 // if this pref isn't there, no big deal.  just let</span>
<a href="#l59.540"></a><span id="l59.540">                 // nsLDAPAutoCompleteSession use its default</span>
<a href="#l59.541"></a><span id="l59.541">             }</span>
<a href="#l59.542"></a><span id="l59.542"> </span>
<a href="#l59.543"></a><span id="l59.543">             // override default maxHits (currently 100)</span>
<a href="#l59.544"></a><span id="l59.544">             //</span>
<a href="#l59.545"></a><span id="l59.545" class="difflineminus">-            try { </span>
<a href="#l59.546"></a><span id="l59.546" class="difflineplus">+            try {</span>
<a href="#l59.547"></a><span id="l59.547">                 // XXXdmose should really use .autocomplete.maxHits,</span>
<a href="#l59.548"></a><span id="l59.548">                 // but there's no UI for that yet</span>
<a href="#l59.549"></a><span id="l59.549" class="difflineminus">-                // </span>
<a href="#l59.550"></a><span id="l59.550" class="difflineplus">+                //</span>
<a href="#l59.551"></a><span id="l59.551">                 LDAPSession.maxHits = getPref(autocompleteDirectory + &quot;.maxHits&quot;);</span>
<a href="#l59.552"></a><span id="l59.552">             } catch (ex) {</span>
<a href="#l59.553"></a><span id="l59.553" class="difflineminus">-                // if this pref isn't there, or is out of range, no big deal. </span>
<a href="#l59.554"></a><span id="l59.554" class="difflineplus">+                // if this pref isn't there, or is out of range, no big deal.</span>
<a href="#l59.555"></a><span id="l59.555">                 // just let nsLDAPAutoCompleteSession use its default.</span>
<a href="#l59.556"></a><span id="l59.556">             }</span>
<a href="#l59.557"></a><span id="l59.557"> </span>
<a href="#l59.558"></a><span id="l59.558">             if (!gSessionAdded) {</span>
<a href="#l59.559"></a><span id="l59.559">                 // if we make it here, we know that session initialization has</span>
<a href="#l59.560"></a><span id="l59.560" class="difflineminus">-                // succeeded; add the session for all recipients, and </span>
<a href="#l59.561"></a><span id="l59.561" class="difflineplus">+                // succeeded; add the session for all recipients, and</span>
<a href="#l59.562"></a><span id="l59.562">                 // remember that we've done so</span>
<a href="#l59.563"></a><span id="l59.563">                 let maxRecipients = awGetMaxRecipients();</span>
<a href="#l59.564"></a><span id="l59.564">                 for (let i = 1; i &lt;= maxRecipients; i++)</span>
<a href="#l59.565"></a><span id="l59.565">                 {</span>
<a href="#l59.566"></a><span id="l59.566">                     let autoCompleteWidget = document.getElementById(&quot;addressCol2#&quot; + i);</span>
<a href="#l59.567"></a><span id="l59.567">                     if (autoCompleteWidget)</span>
<a href="#l59.568"></a><span id="l59.568">                     {</span>
<a href="#l59.569"></a><span id="l59.569">                       autoCompleteWidget.addSession(LDAPSession);</span>
<a href="#l59.570"></a><span id="l59.570">                       // ldap searches don't insert a default entry with the default domain appended to it</span>
<a href="#l59.571"></a><span id="l59.571" class="difflineminus">-                      // so reduce the minimum results for a popup to 2 in this case. </span>
<a href="#l59.572"></a><span id="l59.572" class="difflineplus">+                      // so reduce the minimum results for a popup to 2 in this case.</span>
<a href="#l59.573"></a><span id="l59.573">                       autoCompleteWidget.minResultsForPopup = 2;</span>
<a href="#l59.574"></a><span id="l59.574"> </span>
<a href="#l59.575"></a><span id="l59.575">                     }</span>
<a href="#l59.576"></a><span id="l59.576">                  }</span>
<a href="#l59.577"></a><span id="l59.577">                 gSessionAdded = true;</span>
<a href="#l59.578"></a><span id="l59.578">             }</span>
<a href="#l59.579"></a><span id="l59.579">         }</span>
<a href="#l59.580"></a><span id="l59.580">     } else {</span>
<a href="#l59.581"></a><span id="l59.581" class="difflineat">@@ -1165,17 +1165,17 @@ function handleMailtoArgs(mailtoUrl)</span>
<a href="#l59.582"></a><span id="l59.582"> </span>
<a href="#l59.583"></a><span id="l59.583">   return null;</span>
<a href="#l59.584"></a><span id="l59.584"> }</span>
<a href="#l59.585"></a><span id="l59.585"> </span>
<a href="#l59.586"></a><span id="l59.586"> function ComposeStartup(recycled, aParams)</span>
<a href="#l59.587"></a><span id="l59.587"> {</span>
<a href="#l59.588"></a><span id="l59.588">   var params = null; // New way to pass parameters to the compose window as a nsIMsgComposeParameters object</span>
<a href="#l59.589"></a><span id="l59.589">   var args = null;   // old way, parameters are passed as a string</span>
<a href="#l59.590"></a><span id="l59.590" class="difflineminus">-  </span>
<a href="#l59.591"></a><span id="l59.591" class="difflineplus">+</span>
<a href="#l59.592"></a><span id="l59.592">   if (aParams)</span>
<a href="#l59.593"></a><span id="l59.593">     params = aParams;</span>
<a href="#l59.594"></a><span id="l59.594">   else if (window.arguments &amp;&amp; window.arguments[0]) {</span>
<a href="#l59.595"></a><span id="l59.595">     try {</span>
<a href="#l59.596"></a><span id="l59.596">       if (window.arguments[0] instanceof Components.interfaces.nsIMsgComposeParams)</span>
<a href="#l59.597"></a><span id="l59.597">         params = window.arguments[0];</span>
<a href="#l59.598"></a><span id="l59.598">       else</span>
<a href="#l59.599"></a><span id="l59.599">         params = handleMailtoArgs(window.arguments[0]);</span>
<a href="#l59.600"></a><span id="l59.600" class="difflineat">@@ -1382,17 +1382,17 @@ function ComposeStartup(recycled, aParam</span>
<a href="#l59.601"></a><span id="l59.601">       } catch (e) {</span>
<a href="#l59.602"></a><span id="l59.602">         dump(&quot; Failed to startup editor: &quot;+e+&quot;\n&quot;);</span>
<a href="#l59.603"></a><span id="l59.603">       }</span>
<a href="#l59.604"></a><span id="l59.604">     }</span>
<a href="#l59.605"></a><span id="l59.605">   }</span>
<a href="#l59.606"></a><span id="l59.606"> </span>
<a href="#l59.607"></a><span id="l59.607">   gEditingDraft = gMsgCompose.compFields.draftId;</span>
<a href="#l59.608"></a><span id="l59.608"> </span>
<a href="#l59.609"></a><span id="l59.609" class="difflineminus">-  // finally, see if we need to auto open the address sidebar. </span>
<a href="#l59.610"></a><span id="l59.610" class="difflineplus">+  // finally, see if we need to auto open the address sidebar.</span>
<a href="#l59.611"></a><span id="l59.611">   var sideBarBox = document.getElementById('sidebar-box');</span>
<a href="#l59.612"></a><span id="l59.612">   if (sideBarBox.getAttribute(&quot;sidebarVisible&quot;) == &quot;true&quot;)</span>
<a href="#l59.613"></a><span id="l59.613">   {</span>
<a href="#l59.614"></a><span id="l59.614">     // if we aren't supposed to have the side bar hidden, make sure it is visible</span>
<a href="#l59.615"></a><span id="l59.615">     if (document.getElementById(&quot;sidebar&quot;).getAttribute(&quot;src&quot;) == &quot;&quot;)</span>
<a href="#l59.616"></a><span id="l59.616">       setTimeout(toggleAddressPicker, 0);   // do this on a delay so we don't hurt perf. on bringing up a new compose window</span>
<a href="#l59.617"></a><span id="l59.617">   }</span>
<a href="#l59.618"></a><span id="l59.618">   gAutoSaveInterval = getPref(&quot;mail.compose.autosave&quot;) ?</span>
<a href="#l59.619"></a><span id="l59.619" class="difflineat">@@ -1401,17 +1401,17 @@ function ComposeStartup(recycled, aParam</span>
<a href="#l59.620"></a><span id="l59.620">   if (gAutoSaveInterval)</span>
<a href="#l59.621"></a><span id="l59.621">     gAutoSaveTimeout = setTimeout(AutoSave, gAutoSaveInterval);</span>
<a href="#l59.622"></a><span id="l59.622"> </span>
<a href="#l59.623"></a><span id="l59.623">   gAutoSaveKickedIn = false;</span>
<a href="#l59.624"></a><span id="l59.624"> }</span>
<a href="#l59.625"></a><span id="l59.625"> </span>
<a href="#l59.626"></a><span id="l59.626"> // The new, nice, simple way of getting notified when a new editor has been created</span>
<a href="#l59.627"></a><span id="l59.627"> var gMsgEditorCreationObserver =</span>
<a href="#l59.628"></a><span id="l59.628" class="difflineminus">-{ </span>
<a href="#l59.629"></a><span id="l59.629" class="difflineplus">+{</span>
<a href="#l59.630"></a><span id="l59.630">   observe: function(aSubject, aTopic, aData)</span>
<a href="#l59.631"></a><span id="l59.631">   {</span>
<a href="#l59.632"></a><span id="l59.632">     if (aTopic == &quot;obs_documentCreated&quot;)</span>
<a href="#l59.633"></a><span id="l59.633">     {</span>
<a href="#l59.634"></a><span id="l59.634">       var editor = GetCurrentEditor();</span>
<a href="#l59.635"></a><span id="l59.635">       if (editor &amp;&amp; GetCurrentCommandManager() == aSubject)</span>
<a href="#l59.636"></a><span id="l59.636">       {</span>
<a href="#l59.637"></a><span id="l59.637">         var editorStyle = editor.QueryInterface(Components.interfaces.nsIEditorStyleSheets);</span>
<a href="#l59.638"></a><span id="l59.638" class="difflineat">@@ -1449,23 +1449,23 @@ function ComposeLoad()</span>
<a href="#l59.639"></a><span id="l59.639">   catch (ex) {</span>
<a href="#l59.640"></a><span id="l59.640">     dump(&quot;failed to get the mail.compose.other.header pref\n&quot;);</span>
<a href="#l59.641"></a><span id="l59.641">   }</span>
<a href="#l59.642"></a><span id="l59.642"> </span>
<a href="#l59.643"></a><span id="l59.643">   AddMessageComposeOfflineObserver();</span>
<a href="#l59.644"></a><span id="l59.644">   AddDirectoryServerObserver(true);</span>
<a href="#l59.645"></a><span id="l59.645"> </span>
<a href="#l59.646"></a><span id="l59.646">   try {</span>
<a href="#l59.647"></a><span id="l59.647" class="difflineminus">-    // XXX: We used to set commentColumn on the initial auto complete column after the document has loaded </span>
<a href="#l59.648"></a><span id="l59.648" class="difflineplus">+    // XXX: We used to set commentColumn on the initial auto complete column after the document has loaded</span>
<a href="#l59.649"></a><span id="l59.649">     // inside of setupAutocomplete. But this happens too late for the first widget and it was never showing</span>
<a href="#l59.650"></a><span id="l59.650">     // the comment field. Try to set it before the document finishes loading:</span>
<a href="#l59.651"></a><span id="l59.651">     if (getPref(&quot;mail.autoComplete.commentColumn&quot;))</span>
<a href="#l59.652"></a><span id="l59.652">       document.getElementById('addressCol2#1').showCommentColumn = true;</span>
<a href="#l59.653"></a><span id="l59.653" class="difflineminus">-  } </span>
<a href="#l59.654"></a><span id="l59.654" class="difflineminus">-  catch (ex) { </span>
<a href="#l59.655"></a><span id="l59.655" class="difflineplus">+  }</span>
<a href="#l59.656"></a><span id="l59.656" class="difflineplus">+  catch (ex) {</span>
<a href="#l59.657"></a><span id="l59.657">     // do nothing...</span>
<a href="#l59.658"></a><span id="l59.658">   }</span>
<a href="#l59.659"></a><span id="l59.659"> </span>
<a href="#l59.660"></a><span id="l59.660">   try {</span>
<a href="#l59.661"></a><span id="l59.661">     SetupCommandUpdateHandlers();</span>
<a href="#l59.662"></a><span id="l59.662">     // This will do migration, or create a new account if we need to.</span>
<a href="#l59.663"></a><span id="l59.663">     // We also want to open the account wizard if no identities are found</span>
<a href="#l59.664"></a><span id="l59.664">     var state = verifyAccounts(WizCallback, true);</span>
<a href="#l59.665"></a><span id="l59.665" class="difflineat">@@ -1547,17 +1547,17 @@ function UpdateMailEditCharset()</span>
<a href="#l59.666"></a><span id="l59.666">   if (gCharsetConvertManager) {</span>
<a href="#l59.667"></a><span id="l59.667">     var charsetAlias = gCharsetConvertManager.getCharsetAlias(compFieldsCharset);</span>
<a href="#l59.668"></a><span id="l59.668">     if (charsetAlias == &quot;us-ascii&quot;)</span>
<a href="#l59.669"></a><span id="l59.669">       compFieldsCharset = &quot;ISO-8859-1&quot;;   // no menu item for &quot;us-ascii&quot;</span>
<a href="#l59.670"></a><span id="l59.670">   }</span>
<a href="#l59.671"></a><span id="l59.671"> </span>
<a href="#l59.672"></a><span id="l59.672">   // charset may have been set implicitly in case of reply/forward</span>
<a href="#l59.673"></a><span id="l59.673">   // or use pref default otherwise</span>
<a href="#l59.674"></a><span id="l59.674" class="difflineminus">-  var menuitem = document.getElementById(send_default_charset == compFieldsCharset ? </span>
<a href="#l59.675"></a><span id="l59.675" class="difflineplus">+  var menuitem = document.getElementById(send_default_charset == compFieldsCharset ?</span>
<a href="#l59.676"></a><span id="l59.676">                                          send_default_charset : compFieldsCharset);</span>
<a href="#l59.677"></a><span id="l59.677">   if (menuitem)</span>
<a href="#l59.678"></a><span id="l59.678">     menuitem.setAttribute('checked', 'true');</span>
<a href="#l59.679"></a><span id="l59.679"> </span>
<a href="#l59.680"></a><span id="l59.680">   // Set a document charset to a default mail send charset.</span>
<a href="#l59.681"></a><span id="l59.681">   if (send_default_charset == compFieldsCharset)</span>
<a href="#l59.682"></a><span id="l59.682">     SetDocumentCharacterSet(send_default_charset);</span>
<a href="#l59.683"></a><span id="l59.683"> }</span>
<a href="#l59.684"></a><span id="l59.684" class="difflineat">@@ -1692,29 +1692,40 @@ function GenericSendMessage( msgType )</span>
<a href="#l59.685"></a><span id="l59.685"> </span>
<a href="#l59.686"></a><span id="l59.686">           // Don't check quoted text from reply.</span>
<a href="#l59.687"></a><span id="l59.687">           var blockquotes = mailBodyNode.getElementsByTagName(&quot;blockquote&quot;);</span>
<a href="#l59.688"></a><span id="l59.688">           for (let i = 0; i &lt; blockquotes.length; i++)</span>
<a href="#l59.689"></a><span id="l59.689">           {</span>
<a href="#l59.690"></a><span id="l59.690">             blockquotes[i].parentNode.removeChild(blockquotes[i]);</span>
<a href="#l59.691"></a><span id="l59.691">           }</span>
<a href="#l59.692"></a><span id="l59.692">           var mailData = mailBodyNode.textContent;</span>
<a href="#l59.693"></a><span id="l59.693" class="difflineplus">+</span>
<a href="#l59.694"></a><span id="l59.694" class="difflineplus">+          function escapeRegxpSpecials(inputString) {</span>
<a href="#l59.695"></a><span id="l59.695" class="difflineplus">+            const specials = [ &quot;.&quot;, &quot;\\&quot;, &quot;^&quot;, &quot;$&quot;, &quot;*&quot;, &quot;+&quot;, &quot;?&quot;, , &quot;|&quot;,</span>
<a href="#l59.696"></a><span id="l59.696" class="difflineplus">+                               &quot;(&quot;, &quot;)&quot; , &quot;[&quot;, &quot;]&quot;, &quot;{&quot;, &quot;}&quot; ];</span>
<a href="#l59.697"></a><span id="l59.697" class="difflineplus">+            var re = new RegExp(&quot;(\\&quot;+specials.join(&quot;|\\&quot;)+&quot;)&quot;, &quot;g&quot;);</span>
<a href="#l59.698"></a><span id="l59.698" class="difflineplus">+            return inputString.replace(re, &quot;\\$1&quot;);</span>
<a href="#l59.699"></a><span id="l59.699" class="difflineplus">+          }</span>
<a href="#l59.700"></a><span id="l59.700" class="difflineplus">+</span>
<a href="#l59.701"></a><span id="l59.701">           var keywordFound;</span>
<a href="#l59.702"></a><span id="l59.702">           for (let i = 0; i &lt; keywordsArray.length &amp;&amp; !keywordFound; i++)</span>
<a href="#l59.703"></a><span id="l59.703">           {</span>
<a href="#l59.704"></a><span id="l59.704" class="difflineminus">-            var re = new RegExp(keywordsArray[i], &quot;i&quot;);</span>
<a href="#l59.705"></a><span id="l59.705" class="difflineminus">-            keywordFound = re.test(mailData);</span>
<a href="#l59.706"></a><span id="l59.706" class="difflineplus">+            let kw = escapeRegxpSpecials(keywordsArray[i]);</span>
<a href="#l59.707"></a><span id="l59.707" class="difflineplus">+            let re = new RegExp(&quot;(([^\\s]*)\\b|\\s*)&quot; + kw + &quot;\\b&quot;, &quot;i&quot;);</span>
<a href="#l59.708"></a><span id="l59.708" class="difflineplus">+            let matching = re.exec(mailData);</span>
<a href="#l59.709"></a><span id="l59.709" class="difflineplus">+            // Ignore the match if it was a URL.</span>
<a href="#l59.710"></a><span id="l59.710" class="difflineplus">+            keywordFound = matching &amp;&amp; !(/^http|^ftp/i.test(matching[0]));</span>
<a href="#l59.711"></a><span id="l59.711">           }</span>
<a href="#l59.712"></a><span id="l59.712"> </span>
<a href="#l59.713"></a><span id="l59.713">           if (keywordFound)</span>
<a href="#l59.714"></a><span id="l59.714">           {</span>
<a href="#l59.715"></a><span id="l59.715">             var bundle = document.getElementById(&quot;bundle_composeMsgs&quot;);</span>
<a href="#l59.716"></a><span id="l59.716">             var flags = gPromptService.BUTTON_POS_0 * gPromptService.BUTTON_TITLE_IS_STRING +</span>
<a href="#l59.717"></a><span id="l59.717">                         gPromptService.BUTTON_POS_1 * gPromptService.BUTTON_TITLE_IS_STRING;</span>
<a href="#l59.718"></a><span id="l59.718" class="difflineminus">-            var hadForgotten = gPromptService.confirmEx(null,</span>
<a href="#l59.719"></a><span id="l59.719" class="difflineplus">+            var hadForgotten = gPromptService.confirmEx(window,</span>
<a href="#l59.720"></a><span id="l59.720">                                  bundle.getString(&quot;attachmentReminderTitle&quot;),</span>
<a href="#l59.721"></a><span id="l59.721">                                  bundle.getString(&quot;attachmentReminderMsg&quot;),</span>
<a href="#l59.722"></a><span id="l59.722">                                  flags,</span>
<a href="#l59.723"></a><span id="l59.723">                                  bundle.getString(&quot;attachmentReminderFalseAlarm&quot;),</span>
<a href="#l59.724"></a><span id="l59.724">                                  bundle.getString(&quot;attachmentReminderYesIForgot&quot;),</span>
<a href="#l59.725"></a><span id="l59.725">                                  null, null, {value:0});</span>
<a href="#l59.726"></a><span id="l59.726">             if (hadForgotten)</span>
<a href="#l59.727"></a><span id="l59.727">               return;</span>
<a href="#l59.728"></a><span id="l59.728" class="difflineat">@@ -1811,23 +1822,23 @@ function GenericSendMessage( msgType )</span>
<a href="#l59.729"></a><span id="l59.729">       }</span>
<a href="#l59.730"></a><span id="l59.730"> </span>
<a href="#l59.731"></a><span id="l59.731">       // hook for extra compose pre-processing</span>
<a href="#l59.732"></a><span id="l59.732">       var observerService = Components.classes[&quot;@mozilla.org/observer-service;1&quot;].getService(Components.interfaces.nsIObserverService);</span>
<a href="#l59.733"></a><span id="l59.733">       observerService.notifyObservers(window, &quot;mail:composeOnSend&quot;, null);</span>
<a href="#l59.734"></a><span id="l59.734"> </span>
<a href="#l59.735"></a><span id="l59.735">       var originalCharset = gMsgCompose.compFields.characterSet;</span>
<a href="#l59.736"></a><span id="l59.736">       // Check if the headers of composing mail can be converted to a mail charset.</span>
<a href="#l59.737"></a><span id="l59.737" class="difflineminus">-      if (msgType == nsIMsgCompDeliverMode.Now || </span>
<a href="#l59.738"></a><span id="l59.738" class="difflineplus">+      if (msgType == nsIMsgCompDeliverMode.Now ||</span>
<a href="#l59.739"></a><span id="l59.739">         msgType == nsIMsgCompDeliverMode.Later ||</span>
<a href="#l59.740"></a><span id="l59.740">         msgType == nsIMsgCompDeliverMode.Background ||</span>
<a href="#l59.741"></a><span id="l59.741" class="difflineminus">-        msgType == nsIMsgCompDeliverMode.Save || </span>
<a href="#l59.742"></a><span id="l59.742" class="difflineminus">-        msgType == nsIMsgCompDeliverMode.SaveAsDraft || </span>
<a href="#l59.743"></a><span id="l59.743" class="difflineminus">-        msgType == nsIMsgCompDeliverMode.AutoSaveAsDraft || </span>
<a href="#l59.744"></a><span id="l59.744" class="difflineminus">-        msgType == nsIMsgCompDeliverMode.SaveAsTemplate) </span>
<a href="#l59.745"></a><span id="l59.745" class="difflineplus">+        msgType == nsIMsgCompDeliverMode.Save ||</span>
<a href="#l59.746"></a><span id="l59.746" class="difflineplus">+        msgType == nsIMsgCompDeliverMode.SaveAsDraft ||</span>
<a href="#l59.747"></a><span id="l59.747" class="difflineplus">+        msgType == nsIMsgCompDeliverMode.AutoSaveAsDraft ||</span>
<a href="#l59.748"></a><span id="l59.748" class="difflineplus">+        msgType == nsIMsgCompDeliverMode.SaveAsTemplate)</span>
<a href="#l59.749"></a><span id="l59.749">       {</span>
<a href="#l59.750"></a><span id="l59.750">         var fallbackCharset = new Object;</span>
<a href="#l59.751"></a><span id="l59.751">         // Check encoding, switch to UTF-8 if the default encoding doesn't fit</span>
<a href="#l59.752"></a><span id="l59.752">         // and disable_fallback_to_utf8 isn't set for this encoding.</span>
<a href="#l59.753"></a><span id="l59.753">         if (!gMsgCompose.checkCharsetConversion(getCurrentIdentity(), fallbackCharset))</span>
<a href="#l59.754"></a><span id="l59.754">         {</span>
<a href="#l59.755"></a><span id="l59.755">           var disableFallback = false;</span>
<a href="#l59.756"></a><span id="l59.756">           try</span>
<a href="#l59.757"></a><span id="l59.757" class="difflineat">@@ -1836,17 +1847,17 @@ function GenericSendMessage( msgType )</span>
<a href="#l59.758"></a><span id="l59.758">           }</span>
<a href="#l59.759"></a><span id="l59.759">           catch (e) {}</span>
<a href="#l59.760"></a><span id="l59.760">           if (disableFallback)</span>
<a href="#l59.761"></a><span id="l59.761">             msgCompFields.needToCheckCharset = false;</span>
<a href="#l59.762"></a><span id="l59.762">           else</span>
<a href="#l59.763"></a><span id="l59.763">             fallbackCharset.value = &quot;UTF-8&quot;;</span>
<a href="#l59.764"></a><span id="l59.764">         }</span>
<a href="#l59.765"></a><span id="l59.765"> </span>
<a href="#l59.766"></a><span id="l59.766" class="difflineminus">-        if (fallbackCharset &amp;&amp; </span>
<a href="#l59.767"></a><span id="l59.767" class="difflineplus">+        if (fallbackCharset &amp;&amp;</span>
<a href="#l59.768"></a><span id="l59.768">             fallbackCharset.value &amp;&amp; fallbackCharset.value != &quot;&quot;)</span>
<a href="#l59.769"></a><span id="l59.769">           gMsgCompose.SetDocumentCharset(fallbackCharset.value);</span>
<a href="#l59.770"></a><span id="l59.770">       }</span>
<a href="#l59.771"></a><span id="l59.771">       try {</span>
<a href="#l59.772"></a><span id="l59.772"> </span>
<a href="#l59.773"></a><span id="l59.773">         // just before we try to send the message, fire off the compose-send-message event for listeners</span>
<a href="#l59.774"></a><span id="l59.774">         // such as smime so they can do any pre-security work such as fetching certificates before sending</span>
<a href="#l59.775"></a><span id="l59.775">         var event = document.createEvent('UIEvents');</span>
<a href="#l59.776"></a><span id="l59.776" class="difflineat">@@ -1863,17 +1874,17 @@ function GenericSendMessage( msgType )</span>
<a href="#l59.777"></a><span id="l59.777">         {</span>
<a href="#l59.778"></a><span id="l59.778">           gWindowLocked = true;</span>
<a href="#l59.779"></a><span id="l59.779">           disableEditableFields();</span>
<a href="#l59.780"></a><span id="l59.780">           updateComposeItems();</span>
<a href="#l59.781"></a><span id="l59.781">         }</span>
<a href="#l59.782"></a><span id="l59.782">         // if we're auto saving, mark the body as not changed here, and not</span>
<a href="#l59.783"></a><span id="l59.783">         // when the save is done, because the user might change it between now</span>
<a href="#l59.784"></a><span id="l59.784">         // and when the save is done.</span>
<a href="#l59.785"></a><span id="l59.785" class="difflineminus">-        else </span>
<a href="#l59.786"></a><span id="l59.786" class="difflineplus">+        else</span>
<a href="#l59.787"></a><span id="l59.787">           SetContentAndBodyAsUnmodified();</span>
<a href="#l59.788"></a><span id="l59.788"> </span>
<a href="#l59.789"></a><span id="l59.789">         var progress = Components.classes[&quot;@mozilla.org/messenger/progress;1&quot;].createInstance(Components.interfaces.nsIMsgProgress);</span>
<a href="#l59.790"></a><span id="l59.790">         if (progress)</span>
<a href="#l59.791"></a><span id="l59.791">         {</span>
<a href="#l59.792"></a><span id="l59.792">           progress.registerListener(progressListener);</span>
<a href="#l59.793"></a><span id="l59.793">           gSendOrSaveOperationInProgress = true;</span>
<a href="#l59.794"></a><span id="l59.794">         }</span>
<a href="#l59.795"></a><span id="l59.795" class="difflineat">@@ -1909,17 +1920,17 @@ function CheckValidEmailAddress(to, cc, </span>
<a href="#l59.796"></a><span id="l59.796">   if (invalidStr)</span>
<a href="#l59.797"></a><span id="l59.797">   {</span>
<a href="#l59.798"></a><span id="l59.798">     var bundle = document.getElementById(&quot;bundle_composeMsgs&quot;);</span>
<a href="#l59.799"></a><span id="l59.799">     var errorTitle = bundle.getString(&quot;sendMsgTitle&quot;);</span>
<a href="#l59.800"></a><span id="l59.800">     var errorMsg = bundle.getFormattedString(&quot;addressInvalid&quot;, [invalidStr], 1);</span>
<a href="#l59.801"></a><span id="l59.801">     if (gPromptService)</span>
<a href="#l59.802"></a><span id="l59.802">       gPromptService.alert(window, errorTitle, errorMsg);</span>
<a href="#l59.803"></a><span id="l59.803">     return false;</span>
<a href="#l59.804"></a><span id="l59.804" class="difflineminus">-  } </span>
<a href="#l59.805"></a><span id="l59.805" class="difflineplus">+  }</span>
<a href="#l59.806"></a><span id="l59.806">   return true;</span>
<a href="#l59.807"></a><span id="l59.807"> }</span>
<a href="#l59.808"></a><span id="l59.808"> </span>
<a href="#l59.809"></a><span id="l59.809"> function SendMessage()</span>
<a href="#l59.810"></a><span id="l59.810"> {</span>
<a href="#l59.811"></a><span id="l59.811">   let sendInBackground =</span>
<a href="#l59.812"></a><span id="l59.812">     Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l59.813"></a><span id="l59.813">               .getService(Components.interfaces.nsIPrefBranch)</span>
<a href="#l59.814"></a><span id="l59.814" class="difflineat">@@ -1932,17 +1943,17 @@ function SendMessage()</span>
<a href="#l59.815"></a><span id="l59.815"> </span>
<a href="#l59.816"></a><span id="l59.816"> function SendMessageWithCheck()</span>
<a href="#l59.817"></a><span id="l59.817"> {</span>
<a href="#l59.818"></a><span id="l59.818">     var warn = getPref(&quot;mail.warn_on_send_accel_key&quot;);</span>
<a href="#l59.819"></a><span id="l59.819"> </span>
<a href="#l59.820"></a><span id="l59.820">     if (warn) {</span>
<a href="#l59.821"></a><span id="l59.821">         var checkValue = {value:false};</span>
<a href="#l59.822"></a><span id="l59.822">         var bundle = document.getElementById(&quot;bundle_composeMsgs&quot;);</span>
<a href="#l59.823"></a><span id="l59.823" class="difflineminus">-        var buttonPressed = gPromptService.confirmEx(window, </span>
<a href="#l59.824"></a><span id="l59.824" class="difflineplus">+        var buttonPressed = gPromptService.confirmEx(window,</span>
<a href="#l59.825"></a><span id="l59.825">               bundle.getString('sendMessageCheckWindowTitle'),</span>
<a href="#l59.826"></a><span id="l59.826">               bundle.getString('sendMessageCheckLabel'),</span>
<a href="#l59.827"></a><span id="l59.827">               (gPromptService.BUTTON_TITLE_IS_STRING * gPromptService.BUTTON_POS_0) +</span>
<a href="#l59.828"></a><span id="l59.828">               (gPromptService.BUTTON_TITLE_CANCEL * gPromptService.BUTTON_POS_1),</span>
<a href="#l59.829"></a><span id="l59.829">               bundle.getString('sendMessageCheckSendButtonLabel'),</span>
<a href="#l59.830"></a><span id="l59.830">               null, null,</span>
<a href="#l59.831"></a><span id="l59.831">               bundle.getString('CheckMsg'),</span>
<a href="#l59.832"></a><span id="l59.832">               checkValue);</span>
<a href="#l59.833"></a><span id="l59.833" class="difflineat">@@ -2030,17 +2041,17 @@ function MessageFcc(aFolder)</span>
<a href="#l59.834"></a><span id="l59.834"> </span>
<a href="#l59.835"></a><span id="l59.835"> function updatePriorityMenu()</span>
<a href="#l59.836"></a><span id="l59.836"> {</span>
<a href="#l59.837"></a><span id="l59.837">   if (gMsgCompose)</span>
<a href="#l59.838"></a><span id="l59.838">   {</span>
<a href="#l59.839"></a><span id="l59.839">     var msgCompFields = gMsgCompose.compFields;</span>
<a href="#l59.840"></a><span id="l59.840">     if (msgCompFields &amp;&amp; msgCompFields.priority)</span>
<a href="#l59.841"></a><span id="l59.841">     {</span>
<a href="#l59.842"></a><span id="l59.842" class="difflineminus">-      var priorityMenu = document.getElementById('priorityMenu' ); </span>
<a href="#l59.843"></a><span id="l59.843" class="difflineplus">+      var priorityMenu = document.getElementById('priorityMenu' );</span>
<a href="#l59.844"></a><span id="l59.844">       priorityMenu.getElementsByAttribute( &quot;checked&quot;, 'true' )[0].removeAttribute('checked');</span>
<a href="#l59.845"></a><span id="l59.845">       priorityMenu.getElementsByAttribute( &quot;value&quot;, msgCompFields.priority )[0].setAttribute('checked', 'true');</span>
<a href="#l59.846"></a><span id="l59.846">     }</span>
<a href="#l59.847"></a><span id="l59.847">   }</span>
<a href="#l59.848"></a><span id="l59.848"> }</span>
<a href="#l59.849"></a><span id="l59.849"> </span>
<a href="#l59.850"></a><span id="l59.850"> function updatePriorityToolbarButton(newPriorityValue)</span>
<a href="#l59.851"></a><span id="l59.851"> {</span>
<a href="#l59.852"></a><span id="l59.852" class="difflineat">@@ -2189,29 +2200,29 @@ function InitLanguageMenu()</span>
<a href="#l59.853"></a><span id="l59.853"> </span>
<a href="#l59.854"></a><span id="l59.854">   // sort by locale-aware collation</span>
<a href="#l59.855"></a><span id="l59.855">   dictList.sort(</span>
<a href="#l59.856"></a><span id="l59.856">     function compareFn(a, b)</span>
<a href="#l59.857"></a><span id="l59.857">     {</span>
<a href="#l59.858"></a><span id="l59.858">       return a[0].localeCompare(b[0]);</span>
<a href="#l59.859"></a><span id="l59.859">     }</span>
<a href="#l59.860"></a><span id="l59.860">   );</span>
<a href="#l59.861"></a><span id="l59.861" class="difflineminus">- </span>
<a href="#l59.862"></a><span id="l59.862" class="difflineplus">+</span>
<a href="#l59.863"></a><span id="l59.863">   // Remove any languages from the list.</span>
<a href="#l59.864"></a><span id="l59.864">   while (languageMenuList.hasChildNodes())</span>
<a href="#l59.865"></a><span id="l59.865">     languageMenuList.removeChild(languageMenuList.firstChild);</span>
<a href="#l59.866"></a><span id="l59.866"> </span>
<a href="#l59.867"></a><span id="l59.867">   for (let i = 0; i &lt; count; i++)</span>
<a href="#l59.868"></a><span id="l59.868">   {</span>
<a href="#l59.869"></a><span id="l59.869">     var item = document.createElement(&quot;menuitem&quot;);</span>
<a href="#l59.870"></a><span id="l59.870">     item.setAttribute(&quot;label&quot;, dictList[i][0]);</span>
<a href="#l59.871"></a><span id="l59.871">     item.setAttribute(&quot;value&quot;, dictList[i][1]);</span>
<a href="#l59.872"></a><span id="l59.872">     item.setAttribute('type', 'radio');</span>
<a href="#l59.873"></a><span id="l59.873">     languageMenuList.appendChild(item);</span>
<a href="#l59.874"></a><span id="l59.874" class="difflineminus">-  }      </span>
<a href="#l59.875"></a><span id="l59.875" class="difflineplus">+  }</span>
<a href="#l59.876"></a><span id="l59.876"> }</span>
<a href="#l59.877"></a><span id="l59.877"> </span>
<a href="#l59.878"></a><span id="l59.878"> function OnShowDictionaryMenu(aTarget)</span>
<a href="#l59.879"></a><span id="l59.879"> {</span>
<a href="#l59.880"></a><span id="l59.880">   InitLanguageMenu();</span>
<a href="#l59.881"></a><span id="l59.881">   var curLang = getPref(&quot;spellchecker.dictionary&quot;, true);</span>
<a href="#l59.882"></a><span id="l59.882">   var languages = aTarget.getElementsByAttribute(&quot;value&quot;, curLang);</span>
<a href="#l59.883"></a><span id="l59.883">   if (languages.length &gt; 0)</span>
<a href="#l59.884"></a><span id="l59.884" class="difflineat">@@ -2493,28 +2504,28 @@ function RemoveDraft()</span>
<a href="#l59.885"></a><span id="l59.885">       keyArray[0] = msgKey;</span>
<a href="#l59.886"></a><span id="l59.886">       imapFolder.storeImapFlags(8, true, keyArray, 1, null);</span>
<a href="#l59.887"></a><span id="l59.887">     }</span>
<a href="#l59.888"></a><span id="l59.888">   } catch (ex) {}</span>
<a href="#l59.889"></a><span id="l59.889"> }</span>
<a href="#l59.890"></a><span id="l59.890"> </span>
<a href="#l59.891"></a><span id="l59.891"> function SetContentAndBodyAsUnmodified()</span>
<a href="#l59.892"></a><span id="l59.892"> {</span>
<a href="#l59.893"></a><span id="l59.893" class="difflineminus">-  gMsgCompose.bodyModified = false; </span>
<a href="#l59.894"></a><span id="l59.894" class="difflineplus">+  gMsgCompose.bodyModified = false;</span>
<a href="#l59.895"></a><span id="l59.895">   gContentChanged = false;</span>
<a href="#l59.896"></a><span id="l59.896"> }</span>
<a href="#l59.897"></a><span id="l59.897"> </span>
<a href="#l59.898"></a><span id="l59.898"> function ReleaseAutoCompleteState()</span>
<a href="#l59.899"></a><span id="l59.899"> {</span>
<a href="#l59.900"></a><span id="l59.900">   let maxRecipients = awGetMaxRecipients();</span>
<a href="#l59.901"></a><span id="l59.901">   for (let i = 1; i &lt;= maxRecipients; i++)</span>
<a href="#l59.902"></a><span id="l59.902">     document.getElementById(&quot;addressCol2#&quot; + i).removeSession(gLDAPSession);</span>
<a href="#l59.903"></a><span id="l59.903"> </span>
<a href="#l59.904"></a><span id="l59.904">   gSessionAdded = false;</span>
<a href="#l59.905"></a><span id="l59.905" class="difflineminus">-  gLDAPSession = null;  </span>
<a href="#l59.906"></a><span id="l59.906" class="difflineplus">+  gLDAPSession = null;</span>
<a href="#l59.907"></a><span id="l59.907"> }</span>
<a href="#l59.908"></a><span id="l59.908"> </span>
<a href="#l59.909"></a><span id="l59.909"> function MsgComposeCloseWindow(recycleIt)</span>
<a href="#l59.910"></a><span id="l59.910"> {</span>
<a href="#l59.911"></a><span id="l59.911">   if (gMsgCompose)</span>
<a href="#l59.912"></a><span id="l59.912">     gMsgCompose.CloseWindow(recycleIt);</span>
<a href="#l59.913"></a><span id="l59.913">   else</span>
<a href="#l59.914"></a><span id="l59.914">     window.close();</span>
<a href="#l59.915"></a><span id="l59.915" class="difflineat">@@ -2733,24 +2744,24 @@ function RemoveAllAttachments()</span>
<a href="#l59.916"></a><span id="l59.916">   var child;</span>
<a href="#l59.917"></a><span id="l59.917">   var bucket = document.getElementById(&quot;attachmentBucket&quot;);</span>
<a href="#l59.918"></a><span id="l59.918">   while (bucket.getRowCount())</span>
<a href="#l59.919"></a><span id="l59.919">   {</span>
<a href="#l59.920"></a><span id="l59.920">     child = bucket.removeItemAt(bucket.getRowCount() - 1);</span>
<a href="#l59.921"></a><span id="l59.921">     // Let's release the attachment object hold by the node else it won't go away until the window is destroyed</span>
<a href="#l59.922"></a><span id="l59.922">     child.attachment = null;</span>
<a href="#l59.923"></a><span id="l59.923">   }</span>
<a href="#l59.924"></a><span id="l59.924" class="difflineminus">-  </span>
<a href="#l59.925"></a><span id="l59.925" class="difflineplus">+</span>
<a href="#l59.926"></a><span id="l59.926">   ChangeAttachmentBucketVisibility(true);</span>
<a href="#l59.927"></a><span id="l59.927"> }</span>
<a href="#l59.928"></a><span id="l59.928"> </span>
<a href="#l59.929"></a><span id="l59.929"> function ChangeAttachmentBucketVisibility(aHideBucket)</span>
<a href="#l59.930"></a><span id="l59.930"> {</span>
<a href="#l59.931"></a><span id="l59.931">   document.getElementById(&quot;attachments-box&quot;).collapsed = aHideBucket;</span>
<a href="#l59.932"></a><span id="l59.932" class="difflineminus">-  document.getElementById(&quot;attachmentbucket-sizer&quot;).collapsed = aHideBucket;   </span>
<a href="#l59.933"></a><span id="l59.933" class="difflineplus">+  document.getElementById(&quot;attachmentbucket-sizer&quot;).collapsed = aHideBucket;</span>
<a href="#l59.934"></a><span id="l59.934"> }</span>
<a href="#l59.935"></a><span id="l59.935"> </span>
<a href="#l59.936"></a><span id="l59.936"> function RemoveSelectedAttachment()</span>
<a href="#l59.937"></a><span id="l59.937"> {</span>
<a href="#l59.938"></a><span id="l59.938">   var child;</span>
<a href="#l59.939"></a><span id="l59.939">   var bucket = document.getElementById(&quot;attachmentBucket&quot;);</span>
<a href="#l59.940"></a><span id="l59.940">   if (bucket.selectedItems.length &gt; 0) {</span>
<a href="#l59.941"></a><span id="l59.941">     for (let i = bucket.selectedCount - 1; i &gt;= 0; i--)</span>
<a href="#l59.942"></a><span id="l59.942" class="difflineat">@@ -2797,37 +2808,37 @@ function FocusOnFirstAttachment()</span>
<a href="#l59.943"></a><span id="l59.943">   if (bucketList &amp;&amp; bucketList.getRowCount())</span>
<a href="#l59.944"></a><span id="l59.944">     bucketList.selectedIndex = 0;</span>
<a href="#l59.945"></a><span id="l59.945"> }</span>
<a href="#l59.946"></a><span id="l59.946"> </span>
<a href="#l59.947"></a><span id="l59.947"> function AttachmentElementHasItems()</span>
<a href="#l59.948"></a><span id="l59.948"> {</span>
<a href="#l59.949"></a><span id="l59.949">   var element = document.getElementById(&quot;attachmentBucket&quot;);</span>
<a href="#l59.950"></a><span id="l59.950">   return element ? element.getRowCount() : 0;</span>
<a href="#l59.951"></a><span id="l59.951" class="difflineminus">-}  </span>
<a href="#l59.952"></a><span id="l59.952" class="difflineplus">+}</span>
<a href="#l59.953"></a><span id="l59.953"> </span>
<a href="#l59.954"></a><span id="l59.954"> function OpenSelectedAttachment()</span>
<a href="#l59.955"></a><span id="l59.955"> {</span>
<a href="#l59.956"></a><span id="l59.956">   var child;</span>
<a href="#l59.957"></a><span id="l59.957">   var bucket = document.getElementById(&quot;attachmentBucket&quot;);</span>
<a href="#l59.958"></a><span id="l59.958" class="difflineminus">-  if (bucket.selectedItems.length == 1) </span>
<a href="#l59.959"></a><span id="l59.959" class="difflineplus">+  if (bucket.selectedItems.length == 1)</span>
<a href="#l59.960"></a><span id="l59.960">   {</span>
<a href="#l59.961"></a><span id="l59.961">     var attachmentUrl = bucket.getSelectedItem(0).attachment.url;</span>
<a href="#l59.962"></a><span id="l59.962"> </span>
<a href="#l59.963"></a><span id="l59.963">     var messagePrefix = /^mailbox-message:|^imap-message:|^news-message:/i;</span>
<a href="#l59.964"></a><span id="l59.964">     if (messagePrefix.test(attachmentUrl))</span>
<a href="#l59.965"></a><span id="l59.965">     {</span>
<a href="#l59.966"></a><span id="l59.966">       // we must be dealing with a forwarded attachment, treat this special</span>
<a href="#l59.967"></a><span id="l59.967">       var messenger = Components.classes[&quot;@mozilla.org/messenger;1&quot;].createInstance();</span>
<a href="#l59.968"></a><span id="l59.968">       messenger = messenger.QueryInterface(Components.interfaces.nsIMessenger);</span>
<a href="#l59.969"></a><span id="l59.969">       var msgHdr = messenger.messageServiceFromURI(attachmentUrl).messageURIToMsgHdr(attachmentUrl);</span>
<a href="#l59.970"></a><span id="l59.970">       if (msgHdr)</span>
<a href="#l59.971"></a><span id="l59.971">       {</span>
<a href="#l59.972"></a><span id="l59.972">         var folderUri = msgHdr.folder.folderURL;</span>
<a href="#l59.973"></a><span id="l59.973" class="difflineminus">-        window.openDialog(&quot;chrome://messenger/content/messageWindow.xul&quot;, &quot;_blank&quot;, &quot;all,chrome,dialog=no,status,toolbar&quot;, </span>
<a href="#l59.974"></a><span id="l59.974" class="difflineplus">+        window.openDialog(&quot;chrome://messenger/content/messageWindow.xul&quot;, &quot;_blank&quot;, &quot;all,chrome,dialog=no,status,toolbar&quot;,</span>
<a href="#l59.975"></a><span id="l59.975">                           attachmentUrl, folderUri, null );</span>
<a href="#l59.976"></a><span id="l59.976">       }</span>
<a href="#l59.977"></a><span id="l59.977">     }</span>
<a href="#l59.978"></a><span id="l59.978">     else</span>
<a href="#l59.979"></a><span id="l59.979">     {</span>
<a href="#l59.980"></a><span id="l59.980">       // turn the url into a nsIURL object then open it</span>
<a href="#l59.981"></a><span id="l59.981"> </span>
<a href="#l59.982"></a><span id="l59.982">       var url = gIOService.newURI(attachmentUrl, null, null);</span>
<a href="#l59.983"></a><span id="l59.983" class="difflineat">@@ -2836,17 +2847,17 @@ function OpenSelectedAttachment()</span>
<a href="#l59.984"></a><span id="l59.984">       if (url)</span>
<a href="#l59.985"></a><span id="l59.985">       {</span>
<a href="#l59.986"></a><span id="l59.986">         var channel = gIOService.newChannelFromURI(url);</span>
<a href="#l59.987"></a><span id="l59.987">         if (channel)</span>
<a href="#l59.988"></a><span id="l59.988">         {</span>
<a href="#l59.989"></a><span id="l59.989">           var uriLoader = Components.classes[&quot;@mozilla.org/uriloader;1&quot;].getService(Components.interfaces.nsIURILoader);</span>
<a href="#l59.990"></a><span id="l59.990">           uriLoader.openURI(channel, true, new nsAttachmentOpener());</span>
<a href="#l59.991"></a><span id="l59.991">         } // if channel</span>
<a href="#l59.992"></a><span id="l59.992" class="difflineminus">-      } // if url </span>
<a href="#l59.993"></a><span id="l59.993" class="difflineplus">+      } // if url</span>
<a href="#l59.994"></a><span id="l59.994">     }</span>
<a href="#l59.995"></a><span id="l59.995">   } // if one attachment selected</span>
<a href="#l59.996"></a><span id="l59.996"> }</span>
<a href="#l59.997"></a><span id="l59.997"> </span>
<a href="#l59.998"></a><span id="l59.998"> function nsAttachmentOpener()</span>
<a href="#l59.999"></a><span id="l59.999"> {</span>
<a href="#l59.1000"></a><span id="l59.1000"> }</span>
<a href="#l59.1001"></a><span id="l59.1001"> </span>
<a href="#l59.1002"></a><span id="l59.1002" class="difflineat">@@ -2984,17 +2995,17 @@ function DetermineConvertibility()</span>
<a href="#l59.1003"></a><span id="l59.1003">     } catch(ex) {}</span>
<a href="#l59.1004"></a><span id="l59.1004">     return nsIMsgCompConvertible.No;</span>
<a href="#l59.1005"></a><span id="l59.1005"> }</span>
<a href="#l59.1006"></a><span id="l59.1006"> </span>
<a href="#l59.1007"></a><span id="l59.1007"> function LoadIdentity(startup)</span>
<a href="#l59.1008"></a><span id="l59.1008"> {</span>
<a href="#l59.1009"></a><span id="l59.1009">     var identityElement = document.getElementById(&quot;msgIdentity&quot;);</span>
<a href="#l59.1010"></a><span id="l59.1010">     var prevIdentity = gCurrentIdentity;</span>
<a href="#l59.1011"></a><span id="l59.1011" class="difflineminus">-    </span>
<a href="#l59.1012"></a><span id="l59.1012" class="difflineplus">+</span>
<a href="#l59.1013"></a><span id="l59.1013">     if (identityElement) {</span>
<a href="#l59.1014"></a><span id="l59.1014">         var idKey = identityElement.value;</span>
<a href="#l59.1015"></a><span id="l59.1015">         gCurrentIdentity = gAccountManager.getIdentity(idKey);</span>
<a href="#l59.1016"></a><span id="l59.1016"> </span>
<a href="#l59.1017"></a><span id="l59.1017">         // set the  account name on the menu list value.</span>
<a href="#l59.1018"></a><span id="l59.1018">         if (identityElement.selectedItem)</span>
<a href="#l59.1019"></a><span id="l59.1019">           identityElement.setAttribute('accountname', identityElement.selectedItem.getAttribute('accountname'));</span>
<a href="#l59.1020"></a><span id="l59.1020"> </span>
<a href="#l59.1021"></a><span id="l59.1021" class="difflineat">@@ -3017,17 +3028,17 @@ function LoadIdentity(startup)</span>
<a href="#l59.1022"></a><span id="l59.1022"> </span>
<a href="#l59.1023"></a><span id="l59.1023">           var newReplyTo = gCurrentIdentity.replyTo;</span>
<a href="#l59.1024"></a><span id="l59.1024">           var newBcc = &quot;&quot;;</span>
<a href="#l59.1025"></a><span id="l59.1025">           var newReceipt = gCurrentIdentity.requestReturnReceipt;</span>
<a href="#l59.1026"></a><span id="l59.1026">           var newDSN = gCurrentIdentity.DSN;</span>
<a href="#l59.1027"></a><span id="l59.1027">           var newAttachVCard = gCurrentIdentity.attachVCard;</span>
<a href="#l59.1028"></a><span id="l59.1028"> </span>
<a href="#l59.1029"></a><span id="l59.1029">           if (gCurrentIdentity.doBcc)</span>
<a href="#l59.1030"></a><span id="l59.1030" class="difflineminus">-            newBcc += gCurrentIdentity.doBccList;          </span>
<a href="#l59.1031"></a><span id="l59.1031" class="difflineplus">+            newBcc += gCurrentIdentity.doBccList;</span>
<a href="#l59.1032"></a><span id="l59.1032"> </span>
<a href="#l59.1033"></a><span id="l59.1033">           var needToCleanUp = false;</span>
<a href="#l59.1034"></a><span id="l59.1034">           var msgCompFields = gMsgCompose.compFields;</span>
<a href="#l59.1035"></a><span id="l59.1035"> </span>
<a href="#l59.1036"></a><span id="l59.1036">           if (!gReceiptOptionChanged &amp;&amp;</span>
<a href="#l59.1037"></a><span id="l59.1037">               prevReceipt == msgCompFields.returnReceipt &amp;&amp;</span>
<a href="#l59.1038"></a><span id="l59.1038">               prevReceipt != newReceipt)</span>
<a href="#l59.1039"></a><span id="l59.1039">           {</span>
<a href="#l59.1040"></a><span id="l59.1040" class="difflineat">@@ -3084,17 +3095,17 @@ function LoadIdentity(startup)</span>
<a href="#l59.1041"></a><span id="l59.1041">       AddDirectoryServerObserver(false);</span>
<a href="#l59.1042"></a><span id="l59.1042">       if (!startup) {</span>
<a href="#l59.1043"></a><span id="l59.1043">           if (getPref(&quot;mail.autoComplete.highlightNonMatches&quot;))</span>
<a href="#l59.1044"></a><span id="l59.1044">             document.getElementById('addressCol2#1').highlightNonMatches = true;</span>
<a href="#l59.1045"></a><span id="l59.1045"> </span>
<a href="#l59.1046"></a><span id="l59.1046">           try {</span>
<a href="#l59.1047"></a><span id="l59.1047">               setupLdapAutocompleteSession();</span>
<a href="#l59.1048"></a><span id="l59.1048">           } catch (ex) {</span>
<a href="#l59.1049"></a><span id="l59.1049" class="difflineminus">-              // catch the exception and ignore it, so that if LDAP setup </span>
<a href="#l59.1050"></a><span id="l59.1050" class="difflineplus">+              // catch the exception and ignore it, so that if LDAP setup</span>
<a href="#l59.1051"></a><span id="l59.1051">               // fails, the entire compose window doesn't end up horked</span>
<a href="#l59.1052"></a><span id="l59.1052">           }</span>
<a href="#l59.1053"></a><span id="l59.1053"> </span>
<a href="#l59.1054"></a><span id="l59.1054">           addRecipientsToIgnoreList(gCurrentIdentity.identityName);  // only do this if we aren't starting up....it gets done as part of startup already</span>
<a href="#l59.1055"></a><span id="l59.1055">       }</span>
<a href="#l59.1056"></a><span id="l59.1056">     }</span>
<a href="#l59.1057"></a><span id="l59.1057"> }</span>
<a href="#l59.1058"></a><span id="l59.1058"> </span>
<a href="#l59.1059"></a><span id="l59.1059" class="difflineat">@@ -3102,47 +3113,47 @@ function setupAutocomplete()</span>
<a href="#l59.1060"></a><span id="l59.1060"> {</span>
<a href="#l59.1061"></a><span id="l59.1061">   var autoCompleteWidget = document.getElementById(&quot;addressCol2#1&quot;);</span>
<a href="#l59.1062"></a><span id="l59.1062">   // When autocompleteToMyDomain is off there is no default entry with the domain</span>
<a href="#l59.1063"></a><span id="l59.1063">   // appended so reduce the minimum results for a popup to 2 in this case.</span>
<a href="#l59.1064"></a><span id="l59.1064">   if (!gCurrentIdentity.autocompleteToMyDomain)</span>
<a href="#l59.1065"></a><span id="l59.1065">     autoCompleteWidget.minResultsForPopup = 2;</span>
<a href="#l59.1066"></a><span id="l59.1066"> </span>
<a href="#l59.1067"></a><span id="l59.1067">   // if the pref is set to turn on the comment column, honor it here.</span>
<a href="#l59.1068"></a><span id="l59.1068" class="difflineminus">-  // this element then gets cloned for subsequent rows, so they should </span>
<a href="#l59.1069"></a><span id="l59.1069" class="difflineplus">+  // this element then gets cloned for subsequent rows, so they should</span>
<a href="#l59.1070"></a><span id="l59.1070">   // honor it as well</span>
<a href="#l59.1071"></a><span id="l59.1071">   //</span>
<a href="#l59.1072"></a><span id="l59.1072" class="difflineminus">-  try </span>
<a href="#l59.1073"></a><span id="l59.1073" class="difflineplus">+  try</span>
<a href="#l59.1074"></a><span id="l59.1074">   {</span>
<a href="#l59.1075"></a><span id="l59.1075">     if (getPref(&quot;mail.autoComplete.highlightNonMatches&quot;))</span>
<a href="#l59.1076"></a><span id="l59.1076">       autoCompleteWidget.highlightNonMatches = true;</span>
<a href="#l59.1077"></a><span id="l59.1077"> </span>
<a href="#l59.1078"></a><span id="l59.1078">     if (getPref(&quot;mail.autoComplete.commentColumn&quot;))</span>
<a href="#l59.1079"></a><span id="l59.1079">       autoCompleteWidget.showCommentColumn = true;</span>
<a href="#l59.1080"></a><span id="l59.1080" class="difflineminus">-  } catch (ex) </span>
<a href="#l59.1081"></a><span id="l59.1081" class="difflineplus">+  } catch (ex)</span>
<a href="#l59.1082"></a><span id="l59.1082">   {</span>
<a href="#l59.1083"></a><span id="l59.1083">       // if we can't get this pref, then don't show the columns (which is</span>
<a href="#l59.1084"></a><span id="l59.1084">       // what the XUL defaults to)</span>
<a href="#l59.1085"></a><span id="l59.1085">   }</span>
<a href="#l59.1086"></a><span id="l59.1086" class="difflineminus">-  </span>
<a href="#l59.1087"></a><span id="l59.1087" class="difflineminus">-  if (!gSetupLdapAutocomplete) </span>
<a href="#l59.1088"></a><span id="l59.1088" class="difflineplus">+</span>
<a href="#l59.1089"></a><span id="l59.1089" class="difflineplus">+  if (!gSetupLdapAutocomplete)</span>
<a href="#l59.1090"></a><span id="l59.1090">   {</span>
<a href="#l59.1091"></a><span id="l59.1091" class="difflineminus">-    try </span>
<a href="#l59.1092"></a><span id="l59.1092" class="difflineplus">+    try</span>
<a href="#l59.1093"></a><span id="l59.1093">     {</span>
<a href="#l59.1094"></a><span id="l59.1094">           setupLdapAutocompleteSession();</span>
<a href="#l59.1095"></a><span id="l59.1095" class="difflineminus">-    } catch (ex) </span>
<a href="#l59.1096"></a><span id="l59.1096" class="difflineplus">+    } catch (ex)</span>
<a href="#l59.1097"></a><span id="l59.1097">     {</span>
<a href="#l59.1098"></a><span id="l59.1098" class="difflineminus">-          // catch the exception and ignore it, so that if LDAP setup </span>
<a href="#l59.1099"></a><span id="l59.1099" class="difflineplus">+          // catch the exception and ignore it, so that if LDAP setup</span>
<a href="#l59.1100"></a><span id="l59.1100">           // fails, the entire compose window doesn't end up horked</span>
<a href="#l59.1101"></a><span id="l59.1101">       }</span>
<a href="#l59.1102"></a><span id="l59.1102">   }</span>
<a href="#l59.1103"></a><span id="l59.1103"> }</span>
<a href="#l59.1104"></a><span id="l59.1104"> </span>
<a href="#l59.1105"></a><span id="l59.1105"> function subjectKeyPress(event)</span>
<a href="#l59.1106"></a><span id="l59.1106" class="difflineminus">-{  </span>
<a href="#l59.1107"></a><span id="l59.1107" class="difflineplus">+{</span>
<a href="#l59.1108"></a><span id="l59.1108">   switch(event.keyCode) {</span>
<a href="#l59.1109"></a><span id="l59.1109">   case KeyEvent.DOM_VK_TAB:</span>
<a href="#l59.1110"></a><span id="l59.1110">     if (!event.shiftKey) {</span>
<a href="#l59.1111"></a><span id="l59.1111">       SetMsgBodyFrameFocus();</span>
<a href="#l59.1112"></a><span id="l59.1112">       event.preventDefault();</span>
<a href="#l59.1113"></a><span id="l59.1113">     }</span>
<a href="#l59.1114"></a><span id="l59.1114">     break;</span>
<a href="#l59.1115"></a><span id="l59.1115">   case KeyEvent.DOM_VK_RETURN:</span>
<a href="#l59.1116"></a><span id="l59.1116" class="difflineat">@@ -3156,17 +3167,17 @@ function AttachmentBucketClicked(event)</span>
<a href="#l59.1117"></a><span id="l59.1117">   event.currentTarget.focus();</span>
<a href="#l59.1118"></a><span id="l59.1118"> </span>
<a href="#l59.1119"></a><span id="l59.1119">   if (event.button != 0)</span>
<a href="#l59.1120"></a><span id="l59.1120">     return;</span>
<a href="#l59.1121"></a><span id="l59.1121"> </span>
<a href="#l59.1122"></a><span id="l59.1122">   if (event.originalTarget.localName == &quot;listboxbody&quot;)</span>
<a href="#l59.1123"></a><span id="l59.1123">     goDoCommand('cmd_attachFile');</span>
<a href="#l59.1124"></a><span id="l59.1124">   else if (event.originalTarget.localName == &quot;listitem&quot; &amp;&amp; event.detail == 2)</span>
<a href="#l59.1125"></a><span id="l59.1125" class="difflineminus">-    OpenSelectedAttachment();    </span>
<a href="#l59.1126"></a><span id="l59.1126" class="difflineplus">+    OpenSelectedAttachment();</span>
<a href="#l59.1127"></a><span id="l59.1127"> }</span>
<a href="#l59.1128"></a><span id="l59.1128"> </span>
<a href="#l59.1129"></a><span id="l59.1129"> // we can drag and drop addresses, files, messages and urls into the compose envelope</span>
<a href="#l59.1130"></a><span id="l59.1130"> var envelopeDragObserver = {</span>
<a href="#l59.1131"></a><span id="l59.1131"> </span>
<a href="#l59.1132"></a><span id="l59.1132">   canHandleMultipleItems: true,</span>
<a href="#l59.1133"></a><span id="l59.1133"> </span>
<a href="#l59.1134"></a><span id="l59.1134">   onDrop: function (aEvent, aData, aDragSession)</span>
<a href="#l59.1135"></a><span id="l59.1135" class="difflineat">@@ -3195,33 +3206,33 @@ var envelopeDragObserver = {</span>
<a href="#l59.1136"></a><span id="l59.1136">                                         .getService(Components.interfaces.nsIIOService)</span>
<a href="#l59.1137"></a><span id="l59.1137">                                         .getProtocolHandler(&quot;file&quot;)</span>
<a href="#l59.1138"></a><span id="l59.1138">                                         .QueryInterface(Components.interfaces.nsIFileProtocolHandler);</span>
<a href="#l59.1139"></a><span id="l59.1139">             rawData = fileHandler.getURLSpecFromFile(rawData);</span>
<a href="#l59.1140"></a><span id="l59.1140">           }</span>
<a href="#l59.1141"></a><span id="l59.1141">           else</span>
<a href="#l59.1142"></a><span id="l59.1142">           {</span>
<a href="#l59.1143"></a><span id="l59.1143">             var separator = rawData.indexOf(&quot;\n&quot;);</span>
<a href="#l59.1144"></a><span id="l59.1144" class="difflineminus">-            if (separator != -1) </span>
<a href="#l59.1145"></a><span id="l59.1145" class="difflineplus">+            if (separator != -1)</span>
<a href="#l59.1146"></a><span id="l59.1146">             {</span>
<a href="#l59.1147"></a><span id="l59.1147">               prettyName = rawData.substr(separator+1);</span>
<a href="#l59.1148"></a><span id="l59.1148">               rawData = rawData.substr(0,separator);</span>
<a href="#l59.1149"></a><span id="l59.1149">             }</span>
<a href="#l59.1150"></a><span id="l59.1150">           }</span>
<a href="#l59.1151"></a><span id="l59.1151"> </span>
<a href="#l59.1152"></a><span id="l59.1152">           if (DuplicateFileAlreadyAttached(rawData))</span>
<a href="#l59.1153"></a><span id="l59.1153">           {</span>
<a href="#l59.1154"></a><span id="l59.1154">             dump(&quot;Skipping file &quot;+rawData+&quot;; already attached!\n&quot;);</span>
<a href="#l59.1155"></a><span id="l59.1155">           }</span>
<a href="#l59.1156"></a><span id="l59.1156">           else</span>
<a href="#l59.1157"></a><span id="l59.1157">           {</span>
<a href="#l59.1158"></a><span id="l59.1158">             var isValid = true;</span>
<a href="#l59.1159"></a><span id="l59.1159">             if (item.flavour.contentType == &quot;text/x-moz-url&quot;) {</span>
<a href="#l59.1160"></a><span id="l59.1160">               // if this is a url (or selected text)</span>
<a href="#l59.1161"></a><span id="l59.1161" class="difflineminus">-              // see if it's a valid url by checking </span>
<a href="#l59.1162"></a><span id="l59.1162" class="difflineplus">+              // see if it's a valid url by checking</span>
<a href="#l59.1163"></a><span id="l59.1163">               // if we can extract a scheme</span>
<a href="#l59.1164"></a><span id="l59.1164">               // using the ioservice</span>
<a href="#l59.1165"></a><span id="l59.1165">               //</span>
<a href="#l59.1166"></a><span id="l59.1166">               // also skip mailto:, since it doesn't make sense</span>
<a href="#l59.1167"></a><span id="l59.1167">               // to attach and send mailto urls</span>
<a href="#l59.1168"></a><span id="l59.1168">               try {</span>
<a href="#l59.1169"></a><span id="l59.1169">                 var scheme = gIOService.extractScheme(rawData);</span>
<a href="#l59.1170"></a><span id="l59.1170">                 // don't attach mailto: urls</span>
<a href="#l59.1171"></a><span id="l59.1171" class="difflineat">@@ -3271,17 +3282,17 @@ var envelopeDragObserver = {</span>
<a href="#l59.1172"></a><span id="l59.1172">     },</span>
<a href="#l59.1173"></a><span id="l59.1173"> </span>
<a href="#l59.1174"></a><span id="l59.1174">   getSupportedFlavours: function ()</span>
<a href="#l59.1175"></a><span id="l59.1175">     {</span>
<a href="#l59.1176"></a><span id="l59.1176">       var flavourSet = new FlavourSet();</span>
<a href="#l59.1177"></a><span id="l59.1177">       flavourSet.appendFlavour(&quot;text/x-moz-url&quot;);</span>
<a href="#l59.1178"></a><span id="l59.1178">       flavourSet.appendFlavour(&quot;text/x-moz-message&quot;);</span>
<a href="#l59.1179"></a><span id="l59.1179">       flavourSet.appendFlavour(&quot;application/x-moz-file&quot;, &quot;nsIFile&quot;);</span>
<a href="#l59.1180"></a><span id="l59.1180" class="difflineminus">-      flavourSet.appendFlavour(&quot;text/x-moz-address&quot;);      </span>
<a href="#l59.1181"></a><span id="l59.1181" class="difflineplus">+      flavourSet.appendFlavour(&quot;text/x-moz-address&quot;);</span>
<a href="#l59.1182"></a><span id="l59.1182">       return flavourSet;</span>
<a href="#l59.1183"></a><span id="l59.1183">     }</span>
<a href="#l59.1184"></a><span id="l59.1184"> };</span>
<a href="#l59.1185"></a><span id="l59.1185"> </span>
<a href="#l59.1186"></a><span id="l59.1186"> function DisplaySaveFolderDlg(folderURI)</span>
<a href="#l59.1187"></a><span id="l59.1187"> {</span>
<a href="#l59.1188"></a><span id="l59.1188">   try</span>
<a href="#l59.1189"></a><span id="l59.1189">   {</span>
<a href="#l59.1190"></a><span id="l59.1190" class="difflineat">@@ -3406,17 +3417,17 @@ function WhichElementHasFocus()</span>
<a href="#l59.1191"></a><span id="l59.1191">       return currentNode;</span>
<a href="#l59.1192"></a><span id="l59.1192"> </span>
<a href="#l59.1193"></a><span id="l59.1193">     currentNode = currentNode.parentNode;</span>
<a href="#l59.1194"></a><span id="l59.1194">   }</span>
<a href="#l59.1195"></a><span id="l59.1195"> </span>
<a href="#l59.1196"></a><span id="l59.1196">   return null;</span>
<a href="#l59.1197"></a><span id="l59.1197"> }</span>
<a href="#l59.1198"></a><span id="l59.1198"> </span>
<a href="#l59.1199"></a><span id="l59.1199" class="difflineminus">-// Function that performs the logic of switching focus from </span>
<a href="#l59.1200"></a><span id="l59.1200" class="difflineplus">+// Function that performs the logic of switching focus from</span>
<a href="#l59.1201"></a><span id="l59.1201"> // one element to another in the mail compose window.</span>
<a href="#l59.1202"></a><span id="l59.1202"> // The default element to switch to when going in either</span>
<a href="#l59.1203"></a><span id="l59.1203"> // direction (shift or no shift key pressed), is the</span>
<a href="#l59.1204"></a><span id="l59.1204"> // AddressingWidgetTreeElement.</span>
<a href="#l59.1205"></a><span id="l59.1205"> //</span>
<a href="#l59.1206"></a><span id="l59.1206"> // The only exception is when the MsgHeadersToolbar is</span>
<a href="#l59.1207"></a><span id="l59.1207"> // collapsed, then the focus will always be on the body of</span>
<a href="#l59.1208"></a><span id="l59.1208"> // the message.</span>
<a href="#l59.1209"></a><span id="l59.1209" class="difflineat">@@ -3466,17 +3477,17 @@ function SwitchElementFocus(event)</span>
<a href="#l59.1210"></a><span id="l59.1210">   }</span>
<a href="#l59.1211"></a><span id="l59.1211"> }</span>
<a href="#l59.1212"></a><span id="l59.1212"> </span>
<a href="#l59.1213"></a><span id="l59.1213"> function toggleAddressPicker()</span>
<a href="#l59.1214"></a><span id="l59.1214"> {</span>
<a href="#l59.1215"></a><span id="l59.1215">   var sidebarBox = document.getElementById(&quot;sidebar-box&quot;);</span>
<a href="#l59.1216"></a><span id="l59.1216">   var sidebarSplitter = document.getElementById(&quot;sidebar-splitter&quot;);</span>
<a href="#l59.1217"></a><span id="l59.1217">   var elt = document.getElementById(&quot;viewAddressPicker&quot;);</span>
<a href="#l59.1218"></a><span id="l59.1218" class="difflineminus">-  if (sidebarBox.hidden) </span>
<a href="#l59.1219"></a><span id="l59.1219" class="difflineplus">+  if (sidebarBox.hidden)</span>
<a href="#l59.1220"></a><span id="l59.1220">   {</span>
<a href="#l59.1221"></a><span id="l59.1221">     sidebarBox.hidden = false;</span>
<a href="#l59.1222"></a><span id="l59.1222">     sidebarSplitter.hidden = false;</span>
<a href="#l59.1223"></a><span id="l59.1223">     elt.setAttribute(&quot;checked&quot;,&quot;true&quot;);</span>
<a href="#l59.1224"></a><span id="l59.1224"> </span>
<a href="#l59.1225"></a><span id="l59.1225">     var sidebar = document.getElementById(&quot;sidebar&quot;);</span>
<a href="#l59.1226"></a><span id="l59.1226">     var sidebarUrl = sidebar.getAttribute(&quot;src&quot;);</span>
<a href="#l59.1227"></a><span id="l59.1227">     // if we have yet to initialize the src url on the sidebar than go ahead and do so now...</span>
<a href="#l59.1228"></a><span id="l59.1228" class="difflineat">@@ -3503,71 +3514,71 @@ function AddRecipient(recipientType, add</span>
<a href="#l59.1229"></a><span id="l59.1229"> }</span>
<a href="#l59.1230"></a><span id="l59.1230"> </span>
<a href="#l59.1231"></a><span id="l59.1231"> function loadHTMLMsgPrefs()</span>
<a href="#l59.1232"></a><span id="l59.1232"> {</span>
<a href="#l59.1233"></a><span id="l59.1233">   var fontFace;</span>
<a href="#l59.1234"></a><span id="l59.1234">   var fontSize;</span>
<a href="#l59.1235"></a><span id="l59.1235">   var textColor;</span>
<a href="#l59.1236"></a><span id="l59.1236">   var bgColor;</span>
<a href="#l59.1237"></a><span id="l59.1237" class="difflineminus">-  </span>
<a href="#l59.1238"></a><span id="l59.1238" class="difflineminus">-  try { </span>
<a href="#l59.1239"></a><span id="l59.1239" class="difflineplus">+</span>
<a href="#l59.1240"></a><span id="l59.1240" class="difflineplus">+  try {</span>
<a href="#l59.1241"></a><span id="l59.1241">     fontFace = getPref(&quot;msgcompose.font_face&quot;, true);</span>
<a href="#l59.1242"></a><span id="l59.1242">     doStatefulCommand('cmd_fontFace', fontFace);</span>
<a href="#l59.1243"></a><span id="l59.1243">   } catch (e) {}</span>
<a href="#l59.1244"></a><span id="l59.1244"> </span>
<a href="#l59.1245"></a><span id="l59.1245" class="difflineminus">-  try { </span>
<a href="#l59.1246"></a><span id="l59.1246" class="difflineplus">+  try {</span>
<a href="#l59.1247"></a><span id="l59.1247">     fontSize = getPref(&quot;msgcompose.font_size&quot;);</span>
<a href="#l59.1248"></a><span id="l59.1248">     EditorSetFontSize(fontSize);</span>
<a href="#l59.1249"></a><span id="l59.1249">   } catch (e) {}</span>
<a href="#l59.1250"></a><span id="l59.1250"> </span>
<a href="#l59.1251"></a><span id="l59.1251">   var bodyElement = GetBodyElement();</span>
<a href="#l59.1252"></a><span id="l59.1252"> </span>
<a href="#l59.1253"></a><span id="l59.1253" class="difflineminus">-  try { </span>
<a href="#l59.1254"></a><span id="l59.1254" class="difflineplus">+  try {</span>
<a href="#l59.1255"></a><span id="l59.1255">     textColor = getPref(&quot;msgcompose.text_color&quot;);</span>
<a href="#l59.1256"></a><span id="l59.1256">     if (!bodyElement.getAttribute(&quot;text&quot;))</span>
<a href="#l59.1257"></a><span id="l59.1257">     {</span>
<a href="#l59.1258"></a><span id="l59.1258">     bodyElement.setAttribute(&quot;text&quot;, textColor);</span>
<a href="#l59.1259"></a><span id="l59.1259">     gDefaultTextColor = textColor;</span>
<a href="#l59.1260"></a><span id="l59.1260" class="difflineminus">-    document.getElementById(&quot;cmd_fontColor&quot;).setAttribute(&quot;state&quot;, textColor);    </span>
<a href="#l59.1261"></a><span id="l59.1261" class="difflineplus">+    document.getElementById(&quot;cmd_fontColor&quot;).setAttribute(&quot;state&quot;, textColor);</span>
<a href="#l59.1262"></a><span id="l59.1262">     onFontColorChange();</span>
<a href="#l59.1263"></a><span id="l59.1263">     }</span>
<a href="#l59.1264"></a><span id="l59.1264">   } catch (e) {}</span>
<a href="#l59.1265"></a><span id="l59.1265"> </span>
<a href="#l59.1266"></a><span id="l59.1266" class="difflineminus">-  try { </span>
<a href="#l59.1267"></a><span id="l59.1267" class="difflineplus">+  try {</span>
<a href="#l59.1268"></a><span id="l59.1268">     bgColor = getPref(&quot;msgcompose.background_color&quot;);</span>
<a href="#l59.1269"></a><span id="l59.1269">     if (!bodyElement.getAttribute(&quot;bgcolor&quot;))</span>
<a href="#l59.1270"></a><span id="l59.1270">     {</span>
<a href="#l59.1271"></a><span id="l59.1271">     bodyElement.setAttribute(&quot;bgcolor&quot;, bgColor);</span>
<a href="#l59.1272"></a><span id="l59.1272">     gDefaultBackgroundColor = bgColor;</span>
<a href="#l59.1273"></a><span id="l59.1273">     document.getElementById(&quot;cmd_backgroundColor&quot;).setAttribute(&quot;state&quot;, bgColor);</span>
<a href="#l59.1274"></a><span id="l59.1274">     onBackgroundColorChange();</span>
<a href="#l59.1275"></a><span id="l59.1275">     }</span>
<a href="#l59.1276"></a><span id="l59.1276">   } catch (e) {}</span>
<a href="#l59.1277"></a><span id="l59.1277"> }</span>
<a href="#l59.1278"></a><span id="l59.1278"> </span>
<a href="#l59.1279"></a><span id="l59.1279"> function AutoSave()</span>
<a href="#l59.1280"></a><span id="l59.1280"> {</span>
<a href="#l59.1281"></a><span id="l59.1281" class="difflineminus">-  if (gMsgCompose.editor &amp;&amp; (gContentChanged || gMsgCompose.bodyModified) </span>
<a href="#l59.1282"></a><span id="l59.1282" class="difflineplus">+  if (gMsgCompose.editor &amp;&amp; (gContentChanged || gMsgCompose.bodyModified)</span>
<a href="#l59.1283"></a><span id="l59.1283">       &amp;&amp; !gSendOrSaveOperationInProgress)</span>
<a href="#l59.1284"></a><span id="l59.1284">   {</span>
<a href="#l59.1285"></a><span id="l59.1285">     GenericSendMessage(nsIMsgCompDeliverMode.AutoSaveAsDraft);</span>
<a href="#l59.1286"></a><span id="l59.1286">     gAutoSaveKickedIn = true;</span>
<a href="#l59.1287"></a><span id="l59.1287">   }</span>
<a href="#l59.1288"></a><span id="l59.1288"> </span>
<a href="#l59.1289"></a><span id="l59.1289">   gAutoSaveTimeout = setTimeout(AutoSave, gAutoSaveInterval);</span>
<a href="#l59.1290"></a><span id="l59.1290"> }</span>
<a href="#l59.1291"></a><span id="l59.1291"> </span>
<a href="#l59.1292"></a><span id="l59.1292"> function InitEditor()</span>
<a href="#l59.1293"></a><span id="l59.1293"> {</span>
<a href="#l59.1294"></a><span id="l59.1294">   var editor = GetCurrentEditor();</span>
<a href="#l59.1295"></a><span id="l59.1295">   editor.QueryInterface(nsIEditorStyleSheets);</span>
<a href="#l59.1296"></a><span id="l59.1296">   editor.addOverrideStyleSheet(&quot;chrome://messenger/content/composerOverlay.css&quot;);</span>
<a href="#l59.1297"></a><span id="l59.1297">   gMsgCompose.initEditor(editor, window.content);</span>
<a href="#l59.1298"></a><span id="l59.1298" class="difflineminus">-  </span>
<a href="#l59.1299"></a><span id="l59.1299" class="difflineplus">+</span>
<a href="#l59.1300"></a><span id="l59.1300">   InlineSpellCheckerUI.init(editor);</span>
<a href="#l59.1301"></a><span id="l59.1301">   enableInlineSpellCheck(getPref(&quot;mail.spellcheck.inline&quot;));</span>
<a href="#l59.1302"></a><span id="l59.1302">   document.getElementById('menu_inlineSpellCheck').setAttribute('disabled', !InlineSpellCheckerUI.canSpellCheck);</span>
<a href="#l59.1303"></a><span id="l59.1303"> }</span>
<a href="#l59.1304"></a><span id="l59.1304"> </span>
<a href="#l59.1305"></a><span id="l59.1305"> function enableInlineSpellCheck(aEnableInlineSpellCheck)</span>
<a href="#l59.1306"></a><span id="l59.1306"> {</span>
<a href="#l59.1307"></a><span id="l59.1307">   InlineSpellCheckerUI.enabled = aEnableInlineSpellCheck;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l60.1"></a><span id="l60.1" class="difflineminus">--- a/mail/components/compose/jar.mn</span>
<a href="#l60.2"></a><span id="l60.2" class="difflineplus">+++ b/mail/components/compose/jar.mn</span>
<a href="#l60.3"></a><span id="l60.3" class="difflineat">@@ -1,9 +1,9 @@</span>
<a href="#l60.4"></a><span id="l60.4"> messenger.jar:</span>
<a href="#l60.5"></a><span id="l60.5"> % overlay chrome://editor/content/EdImageOverlay.xul chrome://messenger/content/messengercompose/mailComposeEditorOverlay.xul</span>
<a href="#l60.6"></a><span id="l60.6"> % overlay chrome://editor/content/EdLinkProps.xul chrome://messenger/content/messengercompose/mailComposeEditorOverlay.xul</span>
<a href="#l60.7"></a><span id="l60.7"> *   content/messenger/messengercompose/messengercompose.xul        (content/messengercompose.xul)</span>
<a href="#l60.8"></a><span id="l60.8" class="difflineminus">-*   content/messenger/messengercompose/MsgComposeCommands.js       (content/MsgComposeCommands.js)</span>
<a href="#l60.9"></a><span id="l60.9" class="difflineplus">+    content/messenger/messengercompose/MsgComposeCommands.js       (content/MsgComposeCommands.js)</span>
<a href="#l60.10"></a><span id="l60.10"> *   content/messenger/messengercompose/addressingWidgetOverlay.js  (content/addressingWidgetOverlay.js)</span>
<a href="#l60.11"></a><span id="l60.11"> </span>
<a href="#l60.12"></a><span id="l60.12"> comm.jar:</span>
<a href="#l60.13"></a><span id="l60.13"> *+  content/editor/editorOverlay.xul                               (content/editorOverlay.xul) </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l61.1"></a><span id="l61.1" class="difflineminus">--- a/mail/extensions/mailviews/content/msgViewPickerOverlay.js</span>
<a href="#l61.2"></a><span id="l61.2" class="difflineplus">+++ b/mail/extensions/mailviews/content/msgViewPickerOverlay.js</span>
<a href="#l61.3"></a><span id="l61.3" class="difflineat">@@ -1,10 +1,9 @@</span>
<a href="#l61.4"></a><span id="l61.4" class="difflineminus">-/* -*- Mode: Java; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*-</span>
<a href="#l61.5"></a><span id="l61.5" class="difflineminus">- * ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l61.6"></a><span id="l61.6" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l61.7"></a><span id="l61.7">  * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l61.8"></a><span id="l61.8">  *</span>
<a href="#l61.9"></a><span id="l61.9">  * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l61.10"></a><span id="l61.10">  * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l61.11"></a><span id="l61.11">  * the License. You may obtain a copy of the License at</span>
<a href="#l61.12"></a><span id="l61.12">  * http://www.mozilla.org/MPL/</span>
<a href="#l61.13"></a><span id="l61.13">  *</span>
<a href="#l61.14"></a><span id="l61.14">  * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l61.15"></a><span id="l61.15" class="difflineat">@@ -33,428 +32,267 @@</span>
<a href="#l61.16"></a><span id="l61.16">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l61.17"></a><span id="l61.17">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l61.18"></a><span id="l61.18">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l61.19"></a><span id="l61.19">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l61.20"></a><span id="l61.20">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l61.21"></a><span id="l61.21">  *</span>
<a href="#l61.22"></a><span id="l61.22">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l61.23"></a><span id="l61.23"> </span>
<a href="#l61.24"></a><span id="l61.24" class="difflineminus">-// menuitem value constants</span>
<a href="#l61.25"></a><span id="l61.25" class="difflineplus">+Components.utils.import(&quot;resource://app/modules/mailViewManager.js&quot;);</span>
<a href="#l61.26"></a><span id="l61.26" class="difflineplus">+</span>
<a href="#l61.27"></a><span id="l61.27" class="difflineplus">+// these constants are now authoritatively defined in mailViewManager.js (above)</span>
<a href="#l61.28"></a><span id="l61.28"> // tag views have kViewTagMarker + their key as value</span>
<a href="#l61.29"></a><span id="l61.29" class="difflineminus">-const kViewItemAll         = 0;</span>
<a href="#l61.30"></a><span id="l61.30" class="difflineminus">-const kViewItemUnread      = 1;</span>
<a href="#l61.31"></a><span id="l61.31" class="difflineminus">-const kViewItemTags        = 2; // former labels used values 2-6</span>
<a href="#l61.32"></a><span id="l61.32" class="difflineminus">-const kViewItemNotDeleted  = 3;</span>
<a href="#l61.33"></a><span id="l61.33" class="difflineminus">-const kViewItemVirtual     = 7;</span>
<a href="#l61.34"></a><span id="l61.34" class="difflineminus">-const kViewItemCustomize   = 8;</span>
<a href="#l61.35"></a><span id="l61.35" class="difflineminus">-const kViewItemFirstCustom = 9;</span>
<a href="#l61.36"></a><span id="l61.36" class="difflineplus">+const kViewItemAll         = MailViewConstants.kViewItemAll;</span>
<a href="#l61.37"></a><span id="l61.37" class="difflineplus">+const kViewItemUnread      = MailViewConstants.kViewItemUnread;</span>
<a href="#l61.38"></a><span id="l61.38" class="difflineplus">+const kViewItemTags        = MailViewConstants.kViewItemTags; // former labels used values 2-6</span>
<a href="#l61.39"></a><span id="l61.39" class="difflineplus">+const kViewItemNotDeleted  = MailViewConstants.kViewItemNotDeleted;</span>
<a href="#l61.40"></a><span id="l61.40" class="difflineplus">+// not a real view! a sentinel value to pop up a dialog</span>
<a href="#l61.41"></a><span id="l61.41" class="difflineplus">+const kViewItemVirtual     = MailViewConstants.kViewItemVirtual;</span>
<a href="#l61.42"></a><span id="l61.42" class="difflineplus">+// not a real view! a sentinel value to pop up a dialog</span>
<a href="#l61.43"></a><span id="l61.43" class="difflineplus">+const kViewItemCustomize   = MailViewConstants.kViewItemCustomize;</span>
<a href="#l61.44"></a><span id="l61.44" class="difflineplus">+const kViewItemFirstCustom = MailViewConstants.kViewItemFirstCustom;</span>
<a href="#l61.45"></a><span id="l61.45"> </span>
<a href="#l61.46"></a><span id="l61.46" class="difflineminus">-const kViewCurrent    = &quot;current-view&quot;;</span>
<a href="#l61.47"></a><span id="l61.47" class="difflineminus">-const kViewCurrentTag = &quot;current-view-tag&quot;;</span>
<a href="#l61.48"></a><span id="l61.48" class="difflineminus">-const kViewTagMarker  = &quot;:&quot;;</span>
<a href="#l61.49"></a><span id="l61.49" class="difflineplus">+const kViewCurrent    = MailViewConstants.kViewCurrent;</span>
<a href="#l61.50"></a><span id="l61.50" class="difflineplus">+const kViewCurrentTag = MailViewConstants.kViewCurrentTag;</span>
<a href="#l61.51"></a><span id="l61.51" class="difflineplus">+const kViewTagMarker  = MailViewConstants.kViewTagMarker;</span>
<a href="#l61.52"></a><span id="l61.52"> </span>
<a href="#l61.53"></a><span id="l61.53" class="difflineplus">+/**</span>
<a href="#l61.54"></a><span id="l61.54" class="difflineplus">+ * A reference to the nsIMsgMailViewList service that tracks custom mail views.</span>
<a href="#l61.55"></a><span id="l61.55" class="difflineplus">+ */</span>
<a href="#l61.56"></a><span id="l61.56"> var gMailViewList = null;</span>
<a href="#l61.57"></a><span id="l61.57" class="difflineminus">-var gCurrentViewValue = kViewItemAll;</span>
<a href="#l61.58"></a><span id="l61.58" class="difflineminus">-var gCurrentViewLabel = &quot;&quot;;</span>
<a href="#l61.59"></a><span id="l61.59" class="difflineminus">-var gSaveDefaultSVTerms;</span>
<a href="#l61.60"></a><span id="l61.60"> </span>
<a href="#l61.61"></a><span id="l61.61"> var nsMsgSearchScope  = Components.interfaces.nsMsgSearchScope;</span>
<a href="#l61.62"></a><span id="l61.62"> var nsMsgSearchAttrib = Components.interfaces.nsMsgSearchAttrib;</span>
<a href="#l61.63"></a><span id="l61.63"> var nsMsgSearchOp     = Components.interfaces.nsMsgSearchOp;</span>
<a href="#l61.64"></a><span id="l61.64"> </span>
<a href="#l61.65"></a><span id="l61.65" class="difflineplus">+var nsMsgMessageFlags = Components.interfaces.nsMsgMessageFlags;</span>
<a href="#l61.66"></a><span id="l61.66"> </span>
<a href="#l61.67"></a><span id="l61.67"> // perform the view/action requested by the aValue string</span>
<a href="#l61.68"></a><span id="l61.68"> // and set the view picker label to the aLabel string</span>
<a href="#l61.69"></a><span id="l61.69" class="difflineminus">-function ViewChange(aValue, aLabel)</span>
<a href="#l61.70"></a><span id="l61.70" class="difflineplus">+function ViewChange(aValue)</span>
<a href="#l61.71"></a><span id="l61.71"> {</span>
<a href="#l61.72"></a><span id="l61.72">   if (aValue == kViewItemCustomize || aValue == kViewItemVirtual)</span>
<a href="#l61.73"></a><span id="l61.73">   {</span>
<a href="#l61.74"></a><span id="l61.74">     // restore to the previous view value, in case they cancel</span>
<a href="#l61.75"></a><span id="l61.75" class="difflineminus">-    UpdateViewPicker(gCurrentViewValue, gCurrentViewLabel);</span>
<a href="#l61.76"></a><span id="l61.76" class="difflineplus">+    ViewPickerBinding.updateDisplay();</span>
<a href="#l61.77"></a><span id="l61.77">     if (aValue == kViewItemCustomize)</span>
<a href="#l61.78"></a><span id="l61.78">       LaunchCustomizeDialog();</span>
<a href="#l61.79"></a><span id="l61.79">     else</span>
<a href="#l61.80"></a><span id="l61.80" class="difflineminus">-    {</span>
<a href="#l61.81"></a><span id="l61.81" class="difflineminus">-      // Thunderbird uses the folder pane for this.</span>
<a href="#l61.82"></a><span id="l61.82" class="difflineminus">-      if (&quot;gFolderTreeController&quot; in window)</span>
<a href="#l61.83"></a><span id="l61.83" class="difflineminus">-        gFolderTreeController.newVirtualFolder(gCurrentViewLabel,</span>
<a href="#l61.84"></a><span id="l61.84" class="difflineminus">-                                               gSaveDefaultSVTerms);</span>
<a href="#l61.85"></a><span id="l61.85" class="difflineminus">-      else</span>
<a href="#l61.86"></a><span id="l61.86" class="difflineminus">-        openNewVirtualFolderDialogWithArgs(gCurrentViewLabel, gSaveDefaultSVTerms);</span>
<a href="#l61.87"></a><span id="l61.87" class="difflineminus">-    }</span>
<a href="#l61.88"></a><span id="l61.88" class="difflineplus">+      gFolderTreeController.newVirtualFolder(</span>
<a href="#l61.89"></a><span id="l61.89" class="difflineplus">+        ViewPickerBinding.currentViewLabel,</span>
<a href="#l61.90"></a><span id="l61.90" class="difflineplus">+        gFolderDisplay.view.search.viewTerms);</span>
<a href="#l61.91"></a><span id="l61.91">     return;</span>
<a href="#l61.92"></a><span id="l61.92">   }</span>
<a href="#l61.93"></a><span id="l61.93"> </span>
<a href="#l61.94"></a><span id="l61.94" class="difflineminus">-  // persist the view</span>
<a href="#l61.95"></a><span id="l61.95" class="difflineminus">-  gCurrentViewValue = aValue;</span>
<a href="#l61.96"></a><span id="l61.96" class="difflineminus">-  gCurrentViewLabel = aLabel;</span>
<a href="#l61.97"></a><span id="l61.97" class="difflineminus">-  SetMailViewForFolder(GetFirstSelectedMsgFolder(), gCurrentViewValue)</span>
<a href="#l61.98"></a><span id="l61.98" class="difflineminus">-  UpdateViewPicker(gCurrentViewValue, gCurrentViewLabel);</span>
<a href="#l61.99"></a><span id="l61.99" class="difflineminus">-</span>
<a href="#l61.100"></a><span id="l61.100">   // tag menuitem values are of the form :&lt;keyword&gt;</span>
<a href="#l61.101"></a><span id="l61.101">   if (isNaN(aValue))</span>
<a href="#l61.102"></a><span id="l61.102">   {</span>
<a href="#l61.103"></a><span id="l61.103">     // split off the tag key</span>
<a href="#l61.104"></a><span id="l61.104">     var tagkey = aValue.substr(kViewTagMarker.length);</span>
<a href="#l61.105"></a><span id="l61.105" class="difflineminus">-    ViewTagKeyword(tagkey);</span>
<a href="#l61.106"></a><span id="l61.106" class="difflineplus">+    gFolderDisplay.view.setMailView(kViewItemTags, tagkey);</span>
<a href="#l61.107"></a><span id="l61.107">   }</span>
<a href="#l61.108"></a><span id="l61.108">   else</span>
<a href="#l61.109"></a><span id="l61.109">   {</span>
<a href="#l61.110"></a><span id="l61.110">     var numval = Number(aValue);</span>
<a href="#l61.111"></a><span id="l61.111" class="difflineminus">-    switch (numval)</span>
<a href="#l61.112"></a><span id="l61.112" class="difflineminus">-    {</span>
<a href="#l61.113"></a><span id="l61.113" class="difflineminus">-      case kViewItemAll: // View All</span>
<a href="#l61.114"></a><span id="l61.114" class="difflineminus">-        gDefaultSearchViewTerms = null;</span>
<a href="#l61.115"></a><span id="l61.115" class="difflineminus">-        break;</span>
<a href="#l61.116"></a><span id="l61.116" class="difflineminus">-      case kViewItemUnread: // Unread</span>
<a href="#l61.117"></a><span id="l61.117" class="difflineminus">-        ViewNewMail();</span>
<a href="#l61.118"></a><span id="l61.118" class="difflineminus">-        break;</span>
<a href="#l61.119"></a><span id="l61.119" class="difflineminus">-      case kViewItemNotDeleted: // Not deleted</span>
<a href="#l61.120"></a><span id="l61.120" class="difflineminus">-        ViewNotDeletedMail();</span>
<a href="#l61.121"></a><span id="l61.121" class="difflineminus">-        break;</span>
<a href="#l61.122"></a><span id="l61.122" class="difflineminus">-      default:</span>
<a href="#l61.123"></a><span id="l61.123" class="difflineminus">-        // for legacy reasons, custom views start at index 9</span>
<a href="#l61.124"></a><span id="l61.124" class="difflineminus">-        LoadCustomMailView(numval - kViewItemFirstCustom);</span>
<a href="#l61.125"></a><span id="l61.125" class="difflineminus">-        break;</span>
<a href="#l61.126"></a><span id="l61.126" class="difflineminus">-    }</span>
<a href="#l61.127"></a><span id="l61.127" class="difflineplus">+    gFolderDisplay.view.setMailView(numval, null);</span>
<a href="#l61.128"></a><span id="l61.128">   }</span>
<a href="#l61.129"></a><span id="l61.129" class="difflineminus">-  gSaveDefaultSVTerms = gDefaultSearchViewTerms;</span>
<a href="#l61.130"></a><span id="l61.130" class="difflineminus">-  onEnterInSearchBar();</span>
<a href="#l61.131"></a><span id="l61.131" class="difflineminus">-  gQSViewIsDirty = true;</span>
<a href="#l61.132"></a><span id="l61.132" class="difflineplus">+  ViewPickerBinding.updateDisplay();</span>
<a href="#l61.133"></a><span id="l61.133"> }</span>
<a href="#l61.134"></a><span id="l61.134"> </span>
<a href="#l61.135"></a><span id="l61.135"> </span>
<a href="#l61.136"></a><span id="l61.136"> function ViewChangeByMenuitem(aMenuitem)</span>
<a href="#l61.137"></a><span id="l61.137"> {</span>
<a href="#l61.138"></a><span id="l61.138">   // Mac View menu menuitems don't have XBL bindings</span>
<a href="#l61.139"></a><span id="l61.139" class="difflineminus">-  ViewChange(aMenuitem.getAttribute(&quot;value&quot;), aMenuitem.getAttribute(&quot;label&quot;));</span>
<a href="#l61.140"></a><span id="l61.140" class="difflineminus">-}</span>
<a href="#l61.141"></a><span id="l61.141" class="difflineminus">-</span>
<a href="#l61.142"></a><span id="l61.142" class="difflineminus">-</span>
<a href="#l61.143"></a><span id="l61.143" class="difflineminus">-function ViewChangeByValue(aValue)</span>
<a href="#l61.144"></a><span id="l61.144" class="difflineminus">-{</span>
<a href="#l61.145"></a><span id="l61.145" class="difflineminus">-  ViewChange(aValue, GetLabelForValue(aValue));</span>
<a href="#l61.146"></a><span id="l61.146" class="difflineminus">-}</span>
<a href="#l61.147"></a><span id="l61.147" class="difflineminus">-</span>
<a href="#l61.148"></a><span id="l61.148" class="difflineminus">-function ViewChangeByFolder(aFolder)</span>
<a href="#l61.149"></a><span id="l61.149" class="difflineminus">-{</span>
<a href="#l61.150"></a><span id="l61.150" class="difflineminus">-  var result = GetMailViewForFolder(aFolder);</span>
<a href="#l61.151"></a><span id="l61.151" class="difflineminus">-  ViewChangeByValue(result);</span>
<a href="#l61.152"></a><span id="l61.152" class="difflineminus">-}</span>
<a href="#l61.153"></a><span id="l61.153" class="difflineminus">-</span>
<a href="#l61.154"></a><span id="l61.154" class="difflineminus">-function GetLabelForValue(aValue)</span>
<a href="#l61.155"></a><span id="l61.155" class="difflineminus">-{</span>
<a href="#l61.156"></a><span id="l61.156" class="difflineminus">-  var label = &quot;&quot;;</span>
<a href="#l61.157"></a><span id="l61.157" class="difflineminus">-  let viewPickerPopup = document.getElementById(&quot;viewPickerPopup&quot;);</span>
<a href="#l61.158"></a><span id="l61.158" class="difflineminus">-  if (viewPickerPopup)</span>
<a href="#l61.159"></a><span id="l61.159" class="difflineminus">-  {</span>
<a href="#l61.160"></a><span id="l61.160" class="difflineminus">-    // grab the label for the menulist from one of its menuitems</span>
<a href="#l61.161"></a><span id="l61.161" class="difflineminus">-    var selectedItems = viewPickerPopup.getElementsByAttribute(&quot;value&quot;, aValue);</span>
<a href="#l61.162"></a><span id="l61.162" class="difflineminus">-    if (!selectedItems || !selectedItems.length)</span>
<a href="#l61.163"></a><span id="l61.163" class="difflineminus">-    {</span>
<a href="#l61.164"></a><span id="l61.164" class="difflineminus">-      // we may have a new item</span>
<a href="#l61.165"></a><span id="l61.165" class="difflineminus">-      RefreshAllViewPopups(viewPickerPopup, true);</span>
<a href="#l61.166"></a><span id="l61.166" class="difflineminus">-      selectedItems = viewPickerPopup.getElementsByAttribute(&quot;value&quot;, aValue);</span>
<a href="#l61.167"></a><span id="l61.167" class="difflineminus">-    }</span>
<a href="#l61.168"></a><span id="l61.168" class="difflineminus">-    label = selectedItems &amp;&amp; selectedItems.length &amp;&amp; selectedItems.item(0).label;</span>
<a href="#l61.169"></a><span id="l61.169" class="difflineminus">-  }</span>
<a href="#l61.170"></a><span id="l61.170" class="difflineminus">-  return label;</span>
<a href="#l61.171"></a><span id="l61.171" class="difflineminus">-}</span>
<a href="#l61.172"></a><span id="l61.172" class="difflineminus">-</span>
<a href="#l61.173"></a><span id="l61.173" class="difflineminus">-function UpdateViewPickerByValue(aValue)</span>
<a href="#l61.174"></a><span id="l61.174" class="difflineminus">-{</span>
<a href="#l61.175"></a><span id="l61.175" class="difflineminus">-  UpdateViewPicker(aValue, GetLabelForValue(aValue));</span>
<a href="#l61.176"></a><span id="l61.176" class="difflineplus">+  ViewChange(aMenuitem.getAttribute(&quot;value&quot;));</span>
<a href="#l61.177"></a><span id="l61.177"> }</span>
<a href="#l61.178"></a><span id="l61.178"> </span>
<a href="#l61.179"></a><span id="l61.179" class="difflineminus">-function UpdateViewPicker(aValue, aLabel)</span>
<a href="#l61.180"></a><span id="l61.180" class="difflineminus">-{</span>
<a href="#l61.181"></a><span id="l61.181" class="difflineminus">-  var viewPicker = document.getElementById(&quot;viewPicker&quot;);</span>
<a href="#l61.182"></a><span id="l61.182" class="difflineminus">-  if (viewPicker)</span>
<a href="#l61.183"></a><span id="l61.183" class="difflineminus">-  {</span>
<a href="#l61.184"></a><span id="l61.184" class="difflineminus">-    viewPicker.value = aValue;</span>
<a href="#l61.185"></a><span id="l61.185" class="difflineminus">-    viewPicker.setAttribute(&quot;label&quot;, aLabel);</span>
<a href="#l61.186"></a><span id="l61.186" class="difflineminus">-  }</span>
<a href="#l61.187"></a><span id="l61.187" class="difflineminus">-}</span>
<a href="#l61.188"></a><span id="l61.188" class="difflineplus">+/**</span>
<a href="#l61.189"></a><span id="l61.189" class="difflineplus">+ * Mediates interaction with the #viewPickerPopup.  In theory this should be</span>
<a href="#l61.190"></a><span id="l61.190" class="difflineplus">+ *  an XBL binding, but for the insanity where the view picker may not be</span>
<a href="#l61.191"></a><span id="l61.191" class="difflineplus">+ *  visible at all times (or ever).  No view picker widget, no binding.</span>
<a href="#l61.192"></a><span id="l61.192" class="difflineplus">+ */</span>
<a href="#l61.193"></a><span id="l61.193" class="difflineplus">+var ViewPickerBinding = {</span>
<a href="#l61.194"></a><span id="l61.194" class="difflineplus">+  _init: function ViewPickerBinding_init() {</span>
<a href="#l61.195"></a><span id="l61.195" class="difflineplus">+    window.addEventListener(</span>
<a href="#l61.196"></a><span id="l61.196" class="difflineplus">+      &quot;MailViewChanged&quot;,</span>
<a href="#l61.197"></a><span id="l61.197" class="difflineplus">+      function(aEvent) { ViewPickerBinding.updateDisplay(aEvent); },</span>
<a href="#l61.198"></a><span id="l61.198" class="difflineplus">+      false);</span>
<a href="#l61.199"></a><span id="l61.199" class="difflineplus">+  },</span>
<a href="#l61.200"></a><span id="l61.200"> </span>
<a href="#l61.201"></a><span id="l61.201" class="difflineminus">-function GetFolderInfo(aFolder)</span>
<a href="#l61.202"></a><span id="l61.202" class="difflineminus">-{</span>
<a href="#l61.203"></a><span id="l61.203" class="difflineminus">-  if (aFolder)</span>
<a href="#l61.204"></a><span id="l61.204" class="difflineminus">-  {</span>
<a href="#l61.205"></a><span id="l61.205" class="difflineminus">-    var db = aFolder.msgDatabase;</span>
<a href="#l61.206"></a><span id="l61.206" class="difflineminus">-    if (db)</span>
<a href="#l61.207"></a><span id="l61.207" class="difflineminus">-      return db.dBFolderInfo;</span>
<a href="#l61.208"></a><span id="l61.208" class="difflineminus">-  }</span>
<a href="#l61.209"></a><span id="l61.209" class="difflineminus">-  return null;</span>
<a href="#l61.210"></a><span id="l61.210" class="difflineminus">-}</span>
<a href="#l61.211"></a><span id="l61.211" class="difflineminus">-</span>
<a href="#l61.212"></a><span id="l61.212" class="difflineplus">+  /**</span>
<a href="#l61.213"></a><span id="l61.213" class="difflineplus">+   * Return true if the view picker is visible.  This is used by the</span>
<a href="#l61.214"></a><span id="l61.214" class="difflineplus">+   *  FolderDisplayWidget to know whether or not to actually use mailviews. (The</span>
<a href="#l61.215"></a><span id="l61.215" class="difflineplus">+   *  idea is that if we are not visible, then it would be confusing to the user</span>
<a href="#l61.216"></a><span id="l61.216" class="difflineplus">+   *  if we filtered their mail since they would have no feedback about this and</span>
<a href="#l61.217"></a><span id="l61.217" class="difflineplus">+   *  no way to change it.)</span>
<a href="#l61.218"></a><span id="l61.218" class="difflineplus">+   */</span>
<a href="#l61.219"></a><span id="l61.219" class="difflineplus">+  get isVisible() {</span>
<a href="#l61.220"></a><span id="l61.220" class="difflineplus">+    return document.getElementById(&quot;viewPicker&quot;) != null;</span>
<a href="#l61.221"></a><span id="l61.221" class="difflineplus">+  },</span>
<a href="#l61.222"></a><span id="l61.222"> </span>
<a href="#l61.223"></a><span id="l61.223" class="difflineminus">-function GetMailViewForFolder(aFolder)</span>
<a href="#l61.224"></a><span id="l61.224" class="difflineminus">-{</span>
<a href="#l61.225"></a><span id="l61.225" class="difflineminus">-  var val = &quot;&quot;;</span>
<a href="#l61.226"></a><span id="l61.226" class="difflineminus">-  var folderInfo = GetFolderInfo(aFolder);</span>
<a href="#l61.227"></a><span id="l61.227" class="difflineminus">-  if (folderInfo)</span>
<a href="#l61.228"></a><span id="l61.228" class="difflineminus">-  {</span>
<a href="#l61.229"></a><span id="l61.229" class="difflineminus">-    val = folderInfo.getCharProperty(kViewCurrentTag);</span>
<a href="#l61.230"></a><span id="l61.230" class="difflineminus">-    if (!val)</span>
<a href="#l61.231"></a><span id="l61.231" class="difflineminus">-    {</span>
<a href="#l61.232"></a><span id="l61.232" class="difflineminus">-      // no new view value, thus using the old</span>
<a href="#l61.233"></a><span id="l61.233" class="difflineminus">-      var numval = folderInfo.getUint32Property(kViewCurrent, kViewItemAll);</span>
<a href="#l61.234"></a><span id="l61.234" class="difflineminus">-      // and migrate it, if it's a former label view (label views used values 2-6)</span>
<a href="#l61.235"></a><span id="l61.235" class="difflineminus">-      if ((kViewItemTags &lt;= numval) &amp;&amp; (numval &lt; kViewItemVirtual))</span>
<a href="#l61.236"></a><span id="l61.236" class="difflineminus">-        val = kViewTagMarker + &quot;$label&quot; + (val - 1);</span>
<a href="#l61.237"></a><span id="l61.237" class="difflineminus">-      else</span>
<a href="#l61.238"></a><span id="l61.238" class="difflineminus">-        val = numval;</span>
<a href="#l61.239"></a><span id="l61.239" class="difflineplus">+  /**</span>
<a href="#l61.240"></a><span id="l61.240" class="difflineplus">+   * Return the string value representing the current mail view value as</span>
<a href="#l61.241"></a><span id="l61.241" class="difflineplus">+   *  understood by the view picker widgets.  The value is the index for</span>
<a href="#l61.242"></a><span id="l61.242" class="difflineplus">+   *  everything but tags.  for tags it's the &quot;:&quot;-prefixed tagname.</span>
<a href="#l61.243"></a><span id="l61.243" class="difflineplus">+   */</span>
<a href="#l61.244"></a><span id="l61.244" class="difflineplus">+  get currentViewValue() {</span>
<a href="#l61.245"></a><span id="l61.245" class="difflineplus">+    if (gFolderDisplay.view.mailViewIndex == kViewItemTags)</span>
<a href="#l61.246"></a><span id="l61.246" class="difflineplus">+      return kViewTagMarker + gFolderDisplay.view.mailViewData;</span>
<a href="#l61.247"></a><span id="l61.247" class="difflineplus">+    else</span>
<a href="#l61.248"></a><span id="l61.248" class="difflineplus">+      return gFolderDisplay.view.mailViewIndex + &quot;&quot;;</span>
<a href="#l61.249"></a><span id="l61.249" class="difflineplus">+  },</span>
<a href="#l61.250"></a><span id="l61.250" class="difflineplus">+</span>
<a href="#l61.251"></a><span id="l61.251" class="difflineplus">+  /**</span>
<a href="#l61.252"></a><span id="l61.252" class="difflineplus">+   * @return The label for the current mail view value.</span>
<a href="#l61.253"></a><span id="l61.253" class="difflineplus">+   */</span>
<a href="#l61.254"></a><span id="l61.254" class="difflineplus">+  get currentViewLabel() {</span>
<a href="#l61.255"></a><span id="l61.255" class="difflineplus">+    let viewPicker = document.getElementById(&quot;viewPicker&quot;);</span>
<a href="#l61.256"></a><span id="l61.256" class="difflineplus">+    return viewPicker.getAttribute(&quot;label&quot;);</span>
<a href="#l61.257"></a><span id="l61.257" class="difflineplus">+  },</span>
<a href="#l61.258"></a><span id="l61.258" class="difflineplus">+</span>
<a href="#l61.259"></a><span id="l61.259" class="difflineplus">+  /**</span>
<a href="#l61.260"></a><span id="l61.260" class="difflineplus">+   * The effective view has changed, update the widget.</span>
<a href="#l61.261"></a><span id="l61.261" class="difflineplus">+   */</span>
<a href="#l61.262"></a><span id="l61.262" class="difflineplus">+  updateDisplay: function ViewPickerBinding_updateDisplay(aEvent, aGiveUpIfNotFound) {</span>
<a href="#l61.263"></a><span id="l61.263" class="difflineplus">+    let viewPicker = document.getElementById(&quot;viewPicker&quot;);</span>
<a href="#l61.264"></a><span id="l61.264" class="difflineplus">+    if (viewPicker) {</span>
<a href="#l61.265"></a><span id="l61.265" class="difflineplus">+      let value = this.currentViewValue;</span>
<a href="#l61.266"></a><span id="l61.266" class="difflineplus">+</span>
<a href="#l61.267"></a><span id="l61.267" class="difflineplus">+      let viewPickerPopup = document.getElementById(&quot;viewPickerPopup&quot;);</span>
<a href="#l61.268"></a><span id="l61.268" class="difflineplus">+      let selectedItems =</span>
<a href="#l61.269"></a><span id="l61.269" class="difflineplus">+        viewPickerPopup.getElementsByAttribute(&quot;value&quot;, value);</span>
<a href="#l61.270"></a><span id="l61.270" class="difflineplus">+      if (!selectedItems || !selectedItems.length)</span>
<a href="#l61.271"></a><span id="l61.271" class="difflineplus">+      {</span>
<a href="#l61.272"></a><span id="l61.272" class="difflineplus">+        // we may have a new item, so refresh to make it show up</span>
<a href="#l61.273"></a><span id="l61.273" class="difflineplus">+        RefreshAllViewPopups(viewPickerPopup, true);</span>
<a href="#l61.274"></a><span id="l61.274" class="difflineplus">+        selectedItems = viewPickerPopup.getElementsByAttribute(&quot;value&quot;, value);</span>
<a href="#l61.275"></a><span id="l61.275" class="difflineplus">+      }</span>
<a href="#l61.276"></a><span id="l61.276" class="difflineplus">+      viewPicker.setAttribute(&quot;label&quot;,</span>
<a href="#l61.277"></a><span id="l61.277" class="difflineplus">+                              selectedItems &amp;&amp; selectedItems.length &amp;&amp;</span>
<a href="#l61.278"></a><span id="l61.278" class="difflineplus">+                              selectedItems.item(0).getAttribute(&quot;label&quot;));</span>
<a href="#l61.279"></a><span id="l61.279">     }</span>
<a href="#l61.280"></a><span id="l61.280" class="difflineminus">-  }</span>
<a href="#l61.281"></a><span id="l61.281" class="difflineminus">-  return val;</span>
<a href="#l61.282"></a><span id="l61.282" class="difflineminus">-}</span>
<a href="#l61.283"></a><span id="l61.283" class="difflineminus">-</span>
<a href="#l61.284"></a><span id="l61.284" class="difflineminus">-</span>
<a href="#l61.285"></a><span id="l61.285" class="difflineminus">-function SetMailViewForFolder(aFolder, aValue)</span>
<a href="#l61.286"></a><span id="l61.286" class="difflineminus">-{</span>
<a href="#l61.287"></a><span id="l61.287" class="difflineminus">-  var folderInfo = GetFolderInfo(aFolder);</span>
<a href="#l61.288"></a><span id="l61.288" class="difflineminus">-  if (folderInfo)</span>
<a href="#l61.289"></a><span id="l61.289" class="difflineminus">-  {</span>
<a href="#l61.290"></a><span id="l61.290" class="difflineminus">-    // we can't map tags back to labels in general,</span>
<a href="#l61.291"></a><span id="l61.291" class="difflineminus">-    // so set view to all for backwards compatibility in this case</span>
<a href="#l61.292"></a><span id="l61.292" class="difflineminus">-    folderInfo.setUint32Property (kViewCurrent, isNaN(aValue) ? kViewItemAll : aValue);</span>
<a href="#l61.293"></a><span id="l61.293" class="difflineminus">-    folderInfo.setCharProperty(kViewCurrentTag, aValue);</span>
<a href="#l61.294"></a><span id="l61.294" class="difflineminus">-  }</span>
<a href="#l61.295"></a><span id="l61.295" class="difflineminus">-}</span>
<a href="#l61.296"></a><span id="l61.296" class="difflineminus">-</span>
<a href="#l61.297"></a><span id="l61.297" class="difflineplus">+  },</span>
<a href="#l61.298"></a><span id="l61.298" class="difflineplus">+};</span>
<a href="#l61.299"></a><span id="l61.299" class="difflineplus">+ViewPickerBinding._init();</span>
<a href="#l61.300"></a><span id="l61.300"> </span>
<a href="#l61.301"></a><span id="l61.301"> function LaunchCustomizeDialog()</span>
<a href="#l61.302"></a><span id="l61.302"> {</span>
<a href="#l61.303"></a><span id="l61.303">   OpenOrFocusWindow({}, &quot;mailnews:mailviewlist&quot;, &quot;chrome://messenger/content/mailViewList.xul&quot;);</span>
<a href="#l61.304"></a><span id="l61.304"> }</span>
<a href="#l61.305"></a><span id="l61.305"> </span>
<a href="#l61.306"></a><span id="l61.306" class="difflineminus">-</span>
<a href="#l61.307"></a><span id="l61.307" class="difflineminus">-function LoadCustomMailView(index)</span>
<a href="#l61.308"></a><span id="l61.308" class="difflineminus">-{</span>
<a href="#l61.309"></a><span id="l61.309" class="difflineminus">-  PrepareForViewChange();</span>
<a href="#l61.310"></a><span id="l61.310" class="difflineminus">-  var searchTermsArrayForQS = CreateGroupedSearchTerms(gMailViewList.getMailViewAt(index).searchTerms);</span>
<a href="#l61.311"></a><span id="l61.311" class="difflineminus">-  createSearchTermsWithList(searchTermsArrayForQS);</span>
<a href="#l61.312"></a><span id="l61.312" class="difflineminus">-  AddVirtualFolderTerms(searchTermsArrayForQS);</span>
<a href="#l61.313"></a><span id="l61.313" class="difflineminus">-  gDefaultSearchViewTerms = searchTermsArrayForQS;</span>
<a href="#l61.314"></a><span id="l61.314" class="difflineminus">-}</span>
<a href="#l61.315"></a><span id="l61.315" class="difflineminus">-</span>
<a href="#l61.316"></a><span id="l61.316" class="difflineminus">-</span>
<a href="#l61.317"></a><span id="l61.317" class="difflineminus">-function ViewTagKeyword(keyword)</span>
<a href="#l61.318"></a><span id="l61.318" class="difflineplus">+/**</span>
<a href="#l61.319"></a><span id="l61.319" class="difflineplus">+ * All of these Refresh*ViewPopup* methods have to deal with two menu</span>
<a href="#l61.320"></a><span id="l61.320" class="difflineplus">+ *  variations.  They are accessible from the &quot;View... Messages&quot; menu as well as</span>
<a href="#l61.321"></a><span id="l61.321" class="difflineplus">+ *  the view picker menu list in the toolbar.  aIsMenulist will be false in the</span>
<a href="#l61.322"></a><span id="l61.322" class="difflineplus">+ *  former case and true in the latter case.</span>
<a href="#l61.323"></a><span id="l61.323" class="difflineplus">+ */</span>
<a href="#l61.324"></a><span id="l61.324" class="difflineplus">+function RefreshAllViewPopups(aViewPopup)</span>
<a href="#l61.325"></a><span id="l61.325"> {</span>
<a href="#l61.326"></a><span id="l61.326" class="difflineminus">-  PrepareForViewChange();</span>
<a href="#l61.327"></a><span id="l61.327" class="difflineminus">-</span>
<a href="#l61.328"></a><span id="l61.328" class="difflineminus">-  // create an i supports array to store our search terms</span>
<a href="#l61.329"></a><span id="l61.329" class="difflineminus">-  var searchTermsArray = Components.classes[&quot;@mozilla.org/supports-array;1&quot;]</span>
<a href="#l61.330"></a><span id="l61.330" class="difflineminus">-                                   .createInstance(Components.interfaces.nsISupportsArray);</span>
<a href="#l61.331"></a><span id="l61.331" class="difflineminus">-  var term = gSearchSession.createTerm();</span>
<a href="#l61.332"></a><span id="l61.332" class="difflineminus">-  var value = term.value;</span>
<a href="#l61.333"></a><span id="l61.333" class="difflineminus">-</span>
<a href="#l61.334"></a><span id="l61.334" class="difflineminus">-  value.str = keyword;</span>
<a href="#l61.335"></a><span id="l61.335" class="difflineminus">-  value.attrib = nsMsgSearchAttrib.Keywords;</span>
<a href="#l61.336"></a><span id="l61.336" class="difflineminus">-  term.value = value;</span>
<a href="#l61.337"></a><span id="l61.337" class="difflineminus">-  term.attrib = nsMsgSearchAttrib.Keywords;</span>
<a href="#l61.338"></a><span id="l61.338" class="difflineminus">-  term.op = nsMsgSearchOp.Contains;</span>
<a href="#l61.339"></a><span id="l61.339" class="difflineminus">-  term.booleanAnd = true;</span>
<a href="#l61.340"></a><span id="l61.340" class="difflineminus">-</span>
<a href="#l61.341"></a><span id="l61.341" class="difflineminus">-  searchTermsArray.AppendElement(term);</span>
<a href="#l61.342"></a><span id="l61.342" class="difflineminus">-  AddVirtualFolderTerms(searchTermsArray);</span>
<a href="#l61.343"></a><span id="l61.343" class="difflineminus">-  createSearchTermsWithList(searchTermsArray);</span>
<a href="#l61.344"></a><span id="l61.344" class="difflineminus">-  gDefaultSearchViewTerms = searchTermsArray;</span>
<a href="#l61.345"></a><span id="l61.345" class="difflineplus">+  RefreshViewPopup(aViewPopup);</span>
<a href="#l61.346"></a><span id="l61.346" class="difflineplus">+  var menupopups = aViewPopup.getElementsByTagName(&quot;menupopup&quot;);</span>
<a href="#l61.347"></a><span id="l61.347" class="difflineplus">+  if (menupopups.length &gt; 1)</span>
<a href="#l61.348"></a><span id="l61.348" class="difflineplus">+  {</span>
<a href="#l61.349"></a><span id="l61.349" class="difflineplus">+    // when we have menupopups, we assume both tags and custom views are there</span>
<a href="#l61.350"></a><span id="l61.350" class="difflineplus">+    RefreshTagsPopup(menupopups[0]);</span>
<a href="#l61.351"></a><span id="l61.351" class="difflineplus">+    RefreshCustomViewsPopup(menupopups[1]);</span>
<a href="#l61.352"></a><span id="l61.352" class="difflineplus">+  }</span>
<a href="#l61.353"></a><span id="l61.353"> }</span>
<a href="#l61.354"></a><span id="l61.354"> </span>
<a href="#l61.355"></a><span id="l61.355"> </span>
<a href="#l61.356"></a><span id="l61.356" class="difflineminus">-function ViewNewMail()</span>
<a href="#l61.357"></a><span id="l61.357" class="difflineplus">+function RefreshViewPopup(aViewPopup)</span>
<a href="#l61.358"></a><span id="l61.358"> {</span>
<a href="#l61.359"></a><span id="l61.359" class="difflineminus">-  PrepareForViewChange();</span>
<a href="#l61.360"></a><span id="l61.360" class="difflineminus">-</span>
<a href="#l61.361"></a><span id="l61.361" class="difflineminus">-  // create an i supports array to store our search terms</span>
<a href="#l61.362"></a><span id="l61.362" class="difflineminus">-  var searchTermsArray = Components.classes[&quot;@mozilla.org/supports-array;1&quot;]</span>
<a href="#l61.363"></a><span id="l61.363" class="difflineminus">-                                   .createInstance(Components.interfaces.nsISupportsArray);</span>
<a href="#l61.364"></a><span id="l61.364" class="difflineminus">-  var term = gSearchSession.createTerm();</span>
<a href="#l61.365"></a><span id="l61.365" class="difflineminus">-  var value = term.value;</span>
<a href="#l61.366"></a><span id="l61.366" class="difflineplus">+  // mark default views if selected</span>
<a href="#l61.367"></a><span id="l61.367" class="difflineplus">+  let currentViewValue = ViewPickerBinding.currentViewValue;</span>
<a href="#l61.368"></a><span id="l61.368"> </span>
<a href="#l61.369"></a><span id="l61.369" class="difflineminus">-  value.status = 1;</span>
<a href="#l61.370"></a><span id="l61.370" class="difflineminus">-  value.attrib = nsMsgSearchAttrib.MsgStatus;</span>
<a href="#l61.371"></a><span id="l61.371" class="difflineminus">-  term.value = value;</span>
<a href="#l61.372"></a><span id="l61.372" class="difflineminus">-  term.attrib = nsMsgSearchAttrib.MsgStatus;</span>
<a href="#l61.373"></a><span id="l61.373" class="difflineminus">-  term.op = nsMsgSearchOp.Isnt;</span>
<a href="#l61.374"></a><span id="l61.374" class="difflineminus">-  term.booleanAnd = true;</span>
<a href="#l61.375"></a><span id="l61.375" class="difflineminus">-  searchTermsArray.AppendElement(term);</span>
<a href="#l61.376"></a><span id="l61.376" class="difflineminus">-</span>
<a href="#l61.377"></a><span id="l61.377" class="difflineminus">-  AddVirtualFolderTerms(searchTermsArray);</span>
<a href="#l61.378"></a><span id="l61.378" class="difflineminus">-</span>
<a href="#l61.379"></a><span id="l61.379" class="difflineminus">-  createSearchTermsWithList(searchTermsArray);</span>
<a href="#l61.380"></a><span id="l61.380" class="difflineminus">-  // not quite right - these want to be just the view terms...but it might not matter.</span>
<a href="#l61.381"></a><span id="l61.381" class="difflineminus">-  gDefaultSearchViewTerms = searchTermsArray;</span>
<a href="#l61.382"></a><span id="l61.382" class="difflineminus">-}</span>
<a href="#l61.383"></a><span id="l61.383" class="difflineminus">-</span>
<a href="#l61.384"></a><span id="l61.384" class="difflineminus">-</span>
<a href="#l61.385"></a><span id="l61.385" class="difflineminus">-function ViewNotDeletedMail()</span>
<a href="#l61.386"></a><span id="l61.386" class="difflineminus">-{</span>
<a href="#l61.387"></a><span id="l61.387" class="difflineminus">-  PrepareForViewChange();</span>
<a href="#l61.388"></a><span id="l61.388" class="difflineplus">+  var viewAll = aViewPopup.getElementsByAttribute(&quot;value&quot;, kViewItemAll)[0];</span>
<a href="#l61.389"></a><span id="l61.389" class="difflineplus">+  viewAll.setAttribute(&quot;checked&quot;, currentViewValue == kViewItemAll);</span>
<a href="#l61.390"></a><span id="l61.390" class="difflineplus">+  let viewUnread =</span>
<a href="#l61.391"></a><span id="l61.391" class="difflineplus">+    aViewPopup.getElementsByAttribute(&quot;value&quot;, kViewItemUnread)[0];</span>
<a href="#l61.392"></a><span id="l61.392" class="difflineplus">+  viewUnread.setAttribute(&quot;checked&quot;, currentViewValue == kViewItemUnread);</span>
<a href="#l61.393"></a><span id="l61.393"> </span>
<a href="#l61.394"></a><span id="l61.394" class="difflineminus">-  // create an i supports array to store our search terms</span>
<a href="#l61.395"></a><span id="l61.395" class="difflineminus">-  var searchTermsArray = Components.classes[&quot;@mozilla.org/supports-array;1&quot;]</span>
<a href="#l61.396"></a><span id="l61.396" class="difflineminus">-                                   .createInstance(Components.interfaces.nsISupportsArray);</span>
<a href="#l61.397"></a><span id="l61.397" class="difflineminus">-  var term = gSearchSession.createTerm();</span>
<a href="#l61.398"></a><span id="l61.398" class="difflineminus">-  var value = term.value;</span>
<a href="#l61.399"></a><span id="l61.399" class="difflineminus">-</span>
<a href="#l61.400"></a><span id="l61.400" class="difflineminus">-  value.status = 0x00200000;</span>
<a href="#l61.401"></a><span id="l61.401" class="difflineminus">-  value.attrib = nsMsgSearchAttrib.MsgStatus;</span>
<a href="#l61.402"></a><span id="l61.402" class="difflineminus">-  term.value = value;</span>
<a href="#l61.403"></a><span id="l61.403" class="difflineminus">-  term.attrib = nsMsgSearchAttrib.MsgStatus;</span>
<a href="#l61.404"></a><span id="l61.404" class="difflineminus">-  term.op = nsMsgSearchOp.Isnt;</span>
<a href="#l61.405"></a><span id="l61.405" class="difflineminus">-  term.booleanAnd = true;</span>
<a href="#l61.406"></a><span id="l61.406" class="difflineminus">-  searchTermsArray.AppendElement(term);</span>
<a href="#l61.407"></a><span id="l61.407" class="difflineminus">-</span>
<a href="#l61.408"></a><span id="l61.408" class="difflineminus">-  AddVirtualFolderTerms(searchTermsArray);</span>
<a href="#l61.409"></a><span id="l61.409" class="difflineplus">+  let viewNotDeleted =</span>
<a href="#l61.410"></a><span id="l61.410" class="difflineplus">+    aViewPopup.getElementsByAttribute(&quot;value&quot;, kViewItemNotDeleted)[0];</span>
<a href="#l61.411"></a><span id="l61.411" class="difflineplus">+  var folderArray = GetSelectedMsgFolders();</span>
<a href="#l61.412"></a><span id="l61.412" class="difflineplus">+  if (folderArray.length == 0)</span>
<a href="#l61.413"></a><span id="l61.413" class="difflineplus">+    return;</span>
<a href="#l61.414"></a><span id="l61.414"> </span>
<a href="#l61.415"></a><span id="l61.415" class="difflineminus">-  createSearchTermsWithList(searchTermsArray);</span>
<a href="#l61.416"></a><span id="l61.416" class="difflineminus">-  // not quite right - these want to be just the view terms...but it might not matter.</span>
<a href="#l61.417"></a><span id="l61.417" class="difflineminus">-  gDefaultSearchViewTerms = searchTermsArray;</span>
<a href="#l61.418"></a><span id="l61.418" class="difflineminus">-}</span>
<a href="#l61.419"></a><span id="l61.419" class="difflineminus">-</span>
<a href="#l61.420"></a><span id="l61.420" class="difflineminus">-</span>
<a href="#l61.421"></a><span id="l61.421" class="difflineminus">-function AddVirtualFolderTerms(searchTermsArray)</span>
<a href="#l61.422"></a><span id="l61.422" class="difflineminus">-{</span>
<a href="#l61.423"></a><span id="l61.423" class="difflineminus">-  // add in any virtual folder terms</span>
<a href="#l61.424"></a><span id="l61.424" class="difflineminus">-  var virtualFolderSearchTerms = (gVirtualFolderTerms || gXFVirtualFolderTerms);</span>
<a href="#l61.425"></a><span id="l61.425" class="difflineminus">-  if (virtualFolderSearchTerms)</span>
<a href="#l61.426"></a><span id="l61.426" class="difflineplus">+  // only show the &quot;Not Deleted&quot; item for IMAP servers that are using the IMAP</span>
<a href="#l61.427"></a><span id="l61.427" class="difflineplus">+  // delete model</span>
<a href="#l61.428"></a><span id="l61.428" class="difflineplus">+  viewNotDeleted.setAttribute(&quot;hidden&quot;, true);</span>
<a href="#l61.429"></a><span id="l61.429" class="difflineplus">+  var msgFolder = folderArray[0];</span>
<a href="#l61.430"></a><span id="l61.430" class="difflineplus">+  var server = msgFolder.server;</span>
<a href="#l61.431"></a><span id="l61.431" class="difflineplus">+  if (server.type == &quot;imap&quot;)</span>
<a href="#l61.432"></a><span id="l61.432">   {</span>
<a href="#l61.433"></a><span id="l61.433" class="difflineminus">-    var isupports = null;</span>
<a href="#l61.434"></a><span id="l61.434" class="difflineminus">-    var searchTerm;</span>
<a href="#l61.435"></a><span id="l61.435" class="difflineminus">-    var termsArray = virtualFolderSearchTerms.QueryInterface(Components.interfaces.nsISupportsArray);</span>
<a href="#l61.436"></a><span id="l61.436" class="difflineminus">-    for (var i = 0; i &lt; termsArray.Count(); i++)</span>
<a href="#l61.437"></a><span id="l61.437" class="difflineminus">-    {</span>
<a href="#l61.438"></a><span id="l61.438" class="difflineminus">-      isupports = termsArray.GetElementAt(i);</span>
<a href="#l61.439"></a><span id="l61.439" class="difflineminus">-      searchTerm = isupports.QueryInterface(Components.interfaces.nsIMsgSearchTerm);</span>
<a href="#l61.440"></a><span id="l61.440" class="difflineminus">-      searchTermsArray.AppendElement(searchTerm);</span>
<a href="#l61.441"></a><span id="l61.441" class="difflineplus">+    let imapServer =</span>
<a href="#l61.442"></a><span id="l61.442" class="difflineplus">+      server.QueryInterface(Components.interfaces.nsIImapIncomingServer);</span>
<a href="#l61.443"></a><span id="l61.443" class="difflineplus">+    if (imapServer.deleteModel == 0) { // nsMsgImapDeleteModels.IMAPDelete</span>
<a href="#l61.444"></a><span id="l61.444" class="difflineplus">+      viewNotDeleted.setAttribute(&quot;hidden&quot;, false);</span>
<a href="#l61.445"></a><span id="l61.445" class="difflineplus">+      viewNotDeleted.setAttribute(&quot;checked&quot;,</span>
<a href="#l61.446"></a><span id="l61.446" class="difflineplus">+                                  currentViewValue == kViewItemNotDeleted);</span>
<a href="#l61.447"></a><span id="l61.447">     }</span>
<a href="#l61.448"></a><span id="l61.448">   }</span>
<a href="#l61.449"></a><span id="l61.449"> }</span>
<a href="#l61.450"></a><span id="l61.450"> </span>
<a href="#l61.451"></a><span id="l61.451"> </span>
<a href="#l61.452"></a><span id="l61.452" class="difflineminus">-function PrepareForViewChange()</span>
<a href="#l61.453"></a><span id="l61.453" class="difflineminus">-{</span>
<a href="#l61.454"></a><span id="l61.454" class="difflineminus">-  // this is a problem - it saves the current view in gPreQuickSearchView</span>
<a href="#l61.455"></a><span id="l61.455" class="difflineminus">-  // then we eventually call onEnterInSearchBar, and we think we need to restore the pre search view!</span>
<a href="#l61.456"></a><span id="l61.456" class="difflineminus">-  initializeSearchBar();</span>
<a href="#l61.457"></a><span id="l61.457" class="difflineminus">-  ClearThreadPaneSelection();</span>
<a href="#l61.458"></a><span id="l61.458" class="difflineminus">-  ClearMessagePane();</span>
<a href="#l61.459"></a><span id="l61.459" class="difflineminus">-}</span>
<a href="#l61.460"></a><span id="l61.460" class="difflineminus">-</span>
<a href="#l61.461"></a><span id="l61.461" class="difflineminus">-</span>
<a href="#l61.462"></a><span id="l61.462" class="difflineminus">-// refresh view popup and its subpopups</span>
<a href="#l61.463"></a><span id="l61.463" class="difflineminus">-function RefreshAllViewPopups(aViewPopup, aIsMenulist)</span>
<a href="#l61.464"></a><span id="l61.464" class="difflineminus">-{</span>
<a href="#l61.465"></a><span id="l61.465" class="difflineminus">-  RefreshViewPopup(aViewPopup, aIsMenulist);</span>
<a href="#l61.466"></a><span id="l61.466" class="difflineminus">-  var menupopups = aViewPopup.getElementsByTagName(&quot;menupopup&quot;);</span>
<a href="#l61.467"></a><span id="l61.467" class="difflineminus">-  if (menupopups.length &gt; 1)</span>
<a href="#l61.468"></a><span id="l61.468" class="difflineminus">-  {</span>
<a href="#l61.469"></a><span id="l61.469" class="difflineminus">-    // when we have menupopups, we assume both tags and custom views are there</span>
<a href="#l61.470"></a><span id="l61.470" class="difflineminus">-    RefreshTagsPopup(menupopups[0], aIsMenulist);</span>
<a href="#l61.471"></a><span id="l61.471" class="difflineminus">-    RefreshCustomViewsPopup(menupopups[1], aIsMenulist);</span>
<a href="#l61.472"></a><span id="l61.472" class="difflineminus">-  }</span>
<a href="#l61.473"></a><span id="l61.473" class="difflineminus">-}</span>
<a href="#l61.474"></a><span id="l61.474" class="difflineminus">-</span>
<a href="#l61.475"></a><span id="l61.475" class="difflineminus">-</span>
<a href="#l61.476"></a><span id="l61.476" class="difflineminus">-function RefreshViewPopup(aViewPopup, aIsMenulist)</span>
<a href="#l61.477"></a><span id="l61.477" class="difflineminus">-{</span>
<a href="#l61.478"></a><span id="l61.478" class="difflineminus">-  // mark default views if selected</span>
<a href="#l61.479"></a><span id="l61.479" class="difflineminus">-  if (!aIsMenulist)</span>
<a href="#l61.480"></a><span id="l61.480" class="difflineminus">-  {</span>
<a href="#l61.481"></a><span id="l61.481" class="difflineminus">-    var viewAll = aViewPopup.getElementsByAttribute(&quot;value&quot;, kViewItemAll)[0];</span>
<a href="#l61.482"></a><span id="l61.482" class="difflineminus">-    viewAll.setAttribute(&quot;checked&quot;, gCurrentViewValue == kViewItemAll);</span>
<a href="#l61.483"></a><span id="l61.483" class="difflineminus">-    var viewUnread = aViewPopup.getElementsByAttribute(&quot;value&quot;, kViewItemUnread)[0];</span>
<a href="#l61.484"></a><span id="l61.484" class="difflineminus">-    viewUnread.setAttribute(&quot;checked&quot;, gCurrentViewValue == kViewItemUnread);</span>
<a href="#l61.485"></a><span id="l61.485" class="difflineminus">-</span>
<a href="#l61.486"></a><span id="l61.486" class="difflineminus">-    var viewNotDeleted = aViewPopup.getElementsByAttribute(&quot;value&quot;, kViewItemNotDeleted)[0];</span>
<a href="#l61.487"></a><span id="l61.487" class="difflineminus">-    var folderArray = GetSelectedMsgFolders();</span>
<a href="#l61.488"></a><span id="l61.488" class="difflineminus">-    if (folderArray.length == 0)</span>
<a href="#l61.489"></a><span id="l61.489" class="difflineminus">-      return;</span>
<a href="#l61.490"></a><span id="l61.490" class="difflineminus">-</span>
<a href="#l61.491"></a><span id="l61.491" class="difflineminus">-    // only show the &quot;Not Deleted&quot; item for IMAP servers that are using the IMAP delete model</span>
<a href="#l61.492"></a><span id="l61.492" class="difflineminus">-    viewNotDeleted.setAttribute(&quot;hidden&quot;, true);</span>
<a href="#l61.493"></a><span id="l61.493" class="difflineminus">-    var msgFolder = folderArray[0];</span>
<a href="#l61.494"></a><span id="l61.494" class="difflineminus">-    var server = msgFolder.server;</span>
<a href="#l61.495"></a><span id="l61.495" class="difflineminus">-    if (server.type == &quot;imap&quot;)</span>
<a href="#l61.496"></a><span id="l61.496" class="difflineminus">-    {</span>
<a href="#l61.497"></a><span id="l61.497" class="difflineminus">-      var imapServer = server.QueryInterface(Components.interfaces.nsIImapIncomingServer);</span>
<a href="#l61.498"></a><span id="l61.498" class="difflineminus">-      if (imapServer.deleteModel == 0)   // nsMsgImapDeleteModels.IMAPDelete == 0</span>
<a href="#l61.499"></a><span id="l61.499" class="difflineminus">-      {</span>
<a href="#l61.500"></a><span id="l61.500" class="difflineminus">-        viewNotDeleted.setAttribute(&quot;hidden&quot;, false);</span>
<a href="#l61.501"></a><span id="l61.501" class="difflineminus">-        viewNotDeleted.setAttribute(&quot;checked&quot;, gCurrentViewValue == kViewItemNotDeleted);</span>
<a href="#l61.502"></a><span id="l61.502" class="difflineminus">-      }</span>
<a href="#l61.503"></a><span id="l61.503" class="difflineminus">-    }</span>
<a href="#l61.504"></a><span id="l61.504" class="difflineminus">-  }</span>
<a href="#l61.505"></a><span id="l61.505" class="difflineminus">-}</span>
<a href="#l61.506"></a><span id="l61.506" class="difflineminus">-</span>
<a href="#l61.507"></a><span id="l61.507" class="difflineminus">-</span>
<a href="#l61.508"></a><span id="l61.508" class="difflineminus">-function RefreshCustomViewsPopup(aMenupopup, aIsMenulist)</span>
<a href="#l61.509"></a><span id="l61.509" class="difflineplus">+function RefreshCustomViewsPopup(aMenupopup)</span>
<a href="#l61.510"></a><span id="l61.510"> {</span>
<a href="#l61.511"></a><span id="l61.511">   // for each mail view in the msg view list, add an entry in our combo box</span>
<a href="#l61.512"></a><span id="l61.512">   if (!gMailViewList)</span>
<a href="#l61.513"></a><span id="l61.513">     gMailViewList = Components.classes[&quot;@mozilla.org/messenger/mailviewlist;1&quot;]</span>
<a href="#l61.514"></a><span id="l61.514">                               .getService(Components.interfaces.nsIMsgMailViewList);</span>
<a href="#l61.515"></a><span id="l61.515">   // remove all menuitems</span>
<a href="#l61.516"></a><span id="l61.516">   while (aMenupopup.hasChildNodes())</span>
<a href="#l61.517"></a><span id="l61.517">     aMenupopup.removeChild(aMenupopup.lastChild);</span>
<a href="#l61.518"></a><span id="l61.518"> </span>
<a href="#l61.519"></a><span id="l61.519">   // now rebuild the list</span>
<a href="#l61.520"></a><span id="l61.520" class="difflineminus">-  var currentView = isNaN(gCurrentViewValue) ? kViewItemAll : Number(gCurrentViewValue);</span>
<a href="#l61.521"></a><span id="l61.521" class="difflineplus">+  var currentView = ViewPickerBinding.currentViewValue;</span>
<a href="#l61.522"></a><span id="l61.522">   var numItems = gMailViewList.mailViewCount;</span>
<a href="#l61.523"></a><span id="l61.523">   for (var i = 0; i &lt; numItems; ++i)</span>
<a href="#l61.524"></a><span id="l61.524">   {</span>
<a href="#l61.525"></a><span id="l61.525">     var viewInfo = gMailViewList.getMailViewAt(i);</span>
<a href="#l61.526"></a><span id="l61.526">     var menuitem = document.createElement(&quot;menuitem&quot;);</span>
<a href="#l61.527"></a><span id="l61.527">     menuitem.setAttribute(&quot;label&quot;, viewInfo.prettyName);</span>
<a href="#l61.528"></a><span id="l61.528">     menuitem.setAttribute(&quot;value&quot;, kViewItemFirstCustom + i);</span>
<a href="#l61.529"></a><span id="l61.529" class="difflineminus">-    if (!aIsMenulist)</span>
<a href="#l61.530"></a><span id="l61.530" class="difflineminus">-    {</span>
<a href="#l61.531"></a><span id="l61.531" class="difflineminus">-      menuitem.setAttribute(&quot;type&quot;, &quot;radio&quot;);</span>
<a href="#l61.532"></a><span id="l61.532" class="difflineminus">-      if (kViewItemFirstCustom + i == currentView)</span>
<a href="#l61.533"></a><span id="l61.533" class="difflineminus">-        menuitem.setAttribute(&quot;checked&quot;, true);</span>
<a href="#l61.534"></a><span id="l61.534" class="difflineminus">-    }</span>
<a href="#l61.535"></a><span id="l61.535" class="difflineplus">+    menuitem.setAttribute(&quot;type&quot;, &quot;radio&quot;);</span>
<a href="#l61.536"></a><span id="l61.536" class="difflineplus">+    if (kViewItemFirstCustom + i == currentView)</span>
<a href="#l61.537"></a><span id="l61.537" class="difflineplus">+      menuitem.setAttribute(&quot;checked&quot;, true);</span>
<a href="#l61.538"></a><span id="l61.538">     aMenupopup.appendChild(menuitem);</span>
<a href="#l61.539"></a><span id="l61.539">   }</span>
<a href="#l61.540"></a><span id="l61.540"> }</span>
<a href="#l61.541"></a><span id="l61.541"> </span>
<a href="#l61.542"></a><span id="l61.542"> </span>
<a href="#l61.543"></a><span id="l61.543" class="difflineminus">-function RefreshTagsPopup(aMenupopup, aIsMenulist)</span>
<a href="#l61.544"></a><span id="l61.544" class="difflineplus">+function RefreshTagsPopup(aMenupopup)</span>
<a href="#l61.545"></a><span id="l61.545"> {</span>
<a href="#l61.546"></a><span id="l61.546">   // remove all menuitems</span>
<a href="#l61.547"></a><span id="l61.547">   while (aMenupopup.hasChildNodes())</span>
<a href="#l61.548"></a><span id="l61.548">     aMenupopup.removeChild(aMenupopup.lastChild);</span>
<a href="#l61.549"></a><span id="l61.549"> </span>
<a href="#l61.550"></a><span id="l61.550">   // create tag menuitems</span>
<a href="#l61.551"></a><span id="l61.551" class="difflineminus">-  var currentTagKey = isNaN(gCurrentViewValue) ? gCurrentViewValue.substr(kViewTagMarker.length) : &quot;&quot;;</span>
<a href="#l61.552"></a><span id="l61.552" class="difflineplus">+  var currentTagKey = gFolderDisplay.view.mailViewIndex == kViewItemTags ?</span>
<a href="#l61.553"></a><span id="l61.553" class="difflineplus">+                        gFolderDisplay.view.mailViewData : &quot;&quot;;</span>
<a href="#l61.554"></a><span id="l61.554">   var tagService = Components.classes[&quot;@mozilla.org/messenger/tagservice;1&quot;]</span>
<a href="#l61.555"></a><span id="l61.555">                              .getService(Components.interfaces.nsIMsgTagService);</span>
<a href="#l61.556"></a><span id="l61.556">   var tagArray = tagService.getAllTags({});</span>
<a href="#l61.557"></a><span id="l61.557">   for (var i = 0; i &lt; tagArray.length; ++i)</span>
<a href="#l61.558"></a><span id="l61.558">   {</span>
<a href="#l61.559"></a><span id="l61.559">     var tagInfo = tagArray[i];</span>
<a href="#l61.560"></a><span id="l61.560">     var menuitem = document.createElement(&quot;menuitem&quot;);</span>
<a href="#l61.561"></a><span id="l61.561">     menuitem.setAttribute(&quot;label&quot;, tagInfo.tag);</span>
<a href="#l61.562"></a><span id="l61.562">     menuitem.setAttribute(&quot;value&quot;, kViewTagMarker + tagInfo.key);</span>
<a href="#l61.563"></a><span id="l61.563" class="difflineminus">-    if (!aIsMenulist)</span>
<a href="#l61.564"></a><span id="l61.564" class="difflineminus">-    {</span>
<a href="#l61.565"></a><span id="l61.565" class="difflineminus">-      menuitem.setAttribute(&quot;type&quot;, &quot;radio&quot;);</span>
<a href="#l61.566"></a><span id="l61.566" class="difflineminus">-      if (tagInfo.key == currentTagKey)</span>
<a href="#l61.567"></a><span id="l61.567" class="difflineminus">-        menuitem.setAttribute(&quot;checked&quot;, true);</span>
<a href="#l61.568"></a><span id="l61.568" class="difflineminus">-    }</span>
<a href="#l61.569"></a><span id="l61.569" class="difflineplus">+    menuitem.setAttribute(&quot;type&quot;, &quot;radio&quot;);</span>
<a href="#l61.570"></a><span id="l61.570" class="difflineplus">+    if (tagInfo.key == currentTagKey)</span>
<a href="#l61.571"></a><span id="l61.571" class="difflineplus">+      menuitem.setAttribute(&quot;checked&quot;, true);</span>
<a href="#l61.572"></a><span id="l61.572">     var color = tagInfo.color;</span>
<a href="#l61.573"></a><span id="l61.573">     if (color)</span>
<a href="#l61.574"></a><span id="l61.574">       menuitem.setAttribute(&quot;class&quot;, &quot;lc-&quot; + color.substr(1));</span>
<a href="#l61.575"></a><span id="l61.575">     aMenupopup.appendChild(menuitem);</span>
<a href="#l61.576"></a><span id="l61.576">   }</span>
<a href="#l61.577"></a><span id="l61.577"> }</span>
<a href="#l61.578"></a><span id="l61.578"> </span>
<a href="#l61.579"></a><span id="l61.579" class="difflineminus">-</span>
<a href="#l61.580"></a><span id="l61.580"> function ViewPickerOnLoad()</span>
<a href="#l61.581"></a><span id="l61.581"> {</span>
<a href="#l61.582"></a><span id="l61.582">   var viewPickerPopup = document.getElementById(&quot;viewPickerPopup&quot;);</span>
<a href="#l61.583"></a><span id="l61.583">   if (viewPickerPopup)</span>
<a href="#l61.584"></a><span id="l61.584">     RefreshAllViewPopups(viewPickerPopup, true);</span>
<a href="#l61.585"></a><span id="l61.585"> }</span>
<a href="#l61.586"></a><span id="l61.586"> </span>
<a href="#l61.587"></a><span id="l61.587"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l62.1"></a><span id="l62.1" class="difflineminus">--- a/mail/installer/removed-files.in</span>
<a href="#l62.2"></a><span id="l62.2" class="difflineplus">+++ b/mail/installer/removed-files.in</span>
<a href="#l62.3"></a><span id="l62.3" class="difflineat">@@ -1,10 +1,319 @@</span>
<a href="#l62.4"></a><span id="l62.4" class="difflineplus">+# ****************************************************************************</span>
<a href="#l62.5"></a><span id="l62.5" class="difflineplus">+# * Generic removals section: this is almost certainly where you want to add *</span>
<a href="#l62.6"></a><span id="l62.6" class="difflineplus">+# * anything that isn't a connected chunk of files with related and shared   *</span>
<a href="#l62.7"></a><span id="l62.7" class="difflineplus">+# * ifdef conditions.                                                        *</span>
<a href="#l62.8"></a><span id="l62.8" class="difflineplus">+# ****************************************************************************</span>
<a href="#l62.9"></a><span id="l62.9" class="difflineplus">+chrome/app-chrome.manifest</span>
<a href="#l62.10"></a><span id="l62.10" class="difflineplus">+chrome/chrome.rdf</span>
<a href="#l62.11"></a><span id="l62.11" class="difflineplus">+chrome/en-US-mail.jar</span>
<a href="#l62.12"></a><span id="l62.12" class="difflineplus">+#ifdef XP_WIN</span>
<a href="#l62.13"></a><span id="l62.13" class="difflineplus">+chrome/en-win.jar</span>
<a href="#l62.14"></a><span id="l62.14" class="difflineplus">+#endif</span>
<a href="#l62.15"></a><span id="l62.15" class="difflineplus">+chrome/installed-chrome.txt</span>
<a href="#l62.16"></a><span id="l62.16" class="difflineplus">+chrome/mail.jar</span>
<a href="#l62.17"></a><span id="l62.17" class="difflineplus">+chrome/offline.jar</span>
<a href="#l62.18"></a><span id="l62.18" class="difflineplus">+chrome/offline.manifest</span>
<a href="#l62.19"></a><span id="l62.19" class="difflineplus">+chrome/overlayinfo/</span>
<a href="#l62.20"></a><span id="l62.20" class="difflineplus">+chrome/qute.jar</span>
<a href="#l62.21"></a><span id="l62.21" class="difflineplus">+chrome/US.jar</span>
<a href="#l62.22"></a><span id="l62.22" class="difflineplus">+#ifdef MOZ_WIDGET_GTK2</span>
<a href="#l62.23"></a><span id="l62.23" class="difflineplus">+chrome/icons/default/abcardWindow.xpm</span>
<a href="#l62.24"></a><span id="l62.24" class="difflineplus">+chrome/icons/default/abcardWindow16.xpm</span>
<a href="#l62.25"></a><span id="l62.25" class="difflineplus">+chrome/icons/default/addressbookWindow.xpm</span>
<a href="#l62.26"></a><span id="l62.26" class="difflineplus">+chrome/icons/default/addressbookWindow16.xpm</span>
<a href="#l62.27"></a><span id="l62.27" class="difflineplus">+chrome/icons/default/default.xpm</span>
<a href="#l62.28"></a><span id="l62.28" class="difflineplus">+chrome/icons/default/messengerWindow.xpm</span>
<a href="#l62.29"></a><span id="l62.29" class="difflineplus">+chrome/icons/default/messengerWindow16.xpm</span>
<a href="#l62.30"></a><span id="l62.30" class="difflineplus">+chrome/icons/default/msgcomposeWindow.xpm</span>
<a href="#l62.31"></a><span id="l62.31" class="difflineplus">+chrome/icons/default/msgcomposeWindow16.xpm</span>
<a href="#l62.32"></a><span id="l62.32" class="difflineplus">+#endif</span>
<a href="#l62.33"></a><span id="l62.33" class="difflineplus">+#ifdef XP_MACOSX</span>
<a href="#l62.34"></a><span id="l62.34" class="difflineplus">+#ifndef ACCESSIBILITY</span>
<a href="#l62.35"></a><span id="l62.35" class="difflineplus">+components/accessibility.xpt</span>
<a href="#l62.36"></a><span id="l62.36" class="difflineplus">+#endif</span>
<a href="#l62.37"></a><span id="l62.37" class="difflineplus">+#endif</span>
<a href="#l62.38"></a><span id="l62.38" class="difflineplus">+components/accessibility-atk.xpt</span>
<a href="#l62.39"></a><span id="l62.39" class="difflineplus">+components/airbag.xpt</span>
<a href="#l62.40"></a><span id="l62.40" class="difflineplus">+components/bookmarks.xpt</span>
<a href="#l62.41"></a><span id="l62.41" class="difflineplus">+components/downloadmanager.xpt</span>
<a href="#l62.42"></a><span id="l62.42" class="difflineplus">+components/compreg.dat</span>
<a href="#l62.43"></a><span id="l62.43" class="difflineplus">+components/history.xpt</span>
<a href="#l62.44"></a><span id="l62.44" class="difflineplus">+components/jsconsole.xpt</span>
<a href="#l62.45"></a><span id="l62.45" class="difflineplus">+components/mailnews.xpt</span>
<a href="#l62.46"></a><span id="l62.46" class="difflineplus">+components/mozgnome.xpt</span>
<a href="#l62.47"></a><span id="l62.47" class="difflineplus">+components/@DLL_PREFIX@myspell@DLL_SUFFIX@</span>
<a href="#l62.48"></a><span id="l62.48" class="difflineplus">+components/necko_data.xpt</span>
<a href="#l62.49"></a><span id="l62.49" class="difflineplus">+components/nsBackgroundUpdateService.js</span>
<a href="#l62.50"></a><span id="l62.50" class="difflineplus">+components/nsCloseAllWindows.js</span>
<a href="#l62.51"></a><span id="l62.51" class="difflineplus">+components/nsComposerCmdLineHandler.js</span>
<a href="#l62.52"></a><span id="l62.52" class="difflineplus">+components/nsDownloadProgressListener.js</span>
<a href="#l62.53"></a><span id="l62.53" class="difflineplus">+components/nsInterfaceInfoToIDL.js</span>
<a href="#l62.54"></a><span id="l62.54" class="difflineplus">+components/nsLDAPPrefsService.js</span>
<a href="#l62.55"></a><span id="l62.55" class="difflineplus">+#ifdef XP_WIN</span>
<a href="#l62.56"></a><span id="l62.56" class="difflineplus">+#ifndef MOZILLA_1_9_1_BRANCH</span>
<a href="#l62.57"></a><span id="l62.57" class="difflineplus">+components/nsPostUpdateWin.js</span>
<a href="#l62.58"></a><span id="l62.58" class="difflineplus">+#endif</span>
<a href="#l62.59"></a><span id="l62.59" class="difflineplus">+#endif</span>
<a href="#l62.60"></a><span id="l62.60" class="difflineplus">+components/nsScriptableIO.js</span>
<a href="#l62.61"></a><span id="l62.61" class="difflineplus">+#ifdef XP_MACOSX</span>
<a href="#l62.62"></a><span id="l62.62" class="difflineplus">+components/nsSpotlightIntegration.js</span>
<a href="#l62.63"></a><span id="l62.63" class="difflineplus">+#endif</span>
<a href="#l62.64"></a><span id="l62.64" class="difflineplus">+components/nsUnsetDefaultMail.js</span>
<a href="#l62.65"></a><span id="l62.65" class="difflineplus">+components/nsUrlClassifierTable.js</span>
<a href="#l62.66"></a><span id="l62.66" class="difflineplus">+#ifdef XP_WIN</span>
<a href="#l62.67"></a><span id="l62.67" class="difflineplus">+components/nsWinSearchIntegration.js</span>
<a href="#l62.68"></a><span id="l62.68" class="difflineplus">+#endif</span>
<a href="#l62.69"></a><span id="l62.69" class="difflineplus">+components/progressDlg.xpt</span>
<a href="#l62.70"></a><span id="l62.70" class="difflineplus">+components/sidebar.xpt</span>
<a href="#l62.71"></a><span id="l62.71" class="difflineplus">+components/signonviewer.xpt</span>
<a href="#l62.72"></a><span id="l62.72" class="difflineplus">+components/@DLL_PREFIX@spellchecker@DLL_SUFFIX@</span>
<a href="#l62.73"></a><span id="l62.73" class="difflineplus">+components/spellchk.dll</span>
<a href="#l62.74"></a><span id="l62.74" class="difflineplus">+components/@DLL_PREFIX@wallet@DLL_SUFFIX@</span>
<a href="#l62.75"></a><span id="l62.75" class="difflineplus">+components/wallet.xpt</span>
<a href="#l62.76"></a><span id="l62.76" class="difflineplus">+components/walleteditor.xpt</span>
<a href="#l62.77"></a><span id="l62.77" class="difflineplus">+components/walletpreview.xpt</span>
<a href="#l62.78"></a><span id="l62.78" class="difflineplus">+components/@DLL_PREFIX@walletviewers@DLL_SUFFIX@</span>
<a href="#l62.79"></a><span id="l62.79" class="difflineplus">+#ifndef MOZ_WEBSERVICES</span>
<a href="#l62.80"></a><span id="l62.80" class="difflineplus">+components/websrvcs.xpt</span>
<a href="#l62.81"></a><span id="l62.81" class="difflineplus">+#endif</span>
<a href="#l62.82"></a><span id="l62.82" class="difflineplus">+#ifdef XP_MACOSX</span>
<a href="#l62.83"></a><span id="l62.83" class="difflineplus">+components/widget_mac.xpt</span>
<a href="#l62.84"></a><span id="l62.84" class="difflineplus">+#endif</span>
<a href="#l62.85"></a><span id="l62.85" class="difflineplus">+components/@DLL_PREFIX@xpcom_compat_c@DLL_SUFFIX@</span>
<a href="#l62.86"></a><span id="l62.86" class="difflineplus">+components/xpcom_obsolete.xpt</span>
<a href="#l62.87"></a><span id="l62.87"> components/xpti.dat</span>
<a href="#l62.88"></a><span id="l62.88" class="difflineminus">-components/compreg.dat</span>
<a href="#l62.89"></a><span id="l62.89" class="difflineplus">+components/xptitemp.dat</span>
<a href="#l62.90"></a><span id="l62.90" class="difflineplus">+components/myspell/en-US.dic</span>
<a href="#l62.91"></a><span id="l62.91" class="difflineplus">+components/myspell/en-US.aff</span>
<a href="#l62.92"></a><span id="l62.92" class="difflineplus">+components/myspell/</span>
<a href="#l62.93"></a><span id="l62.93" class="difflineplus">+defaults/isp/dotmac.rdf</span>
<a href="#l62.94"></a><span id="l62.94" class="difflineplus">+defaults/isp/movemail.rdf</span>
<a href="#l62.95"></a><span id="l62.95" class="difflineplus">+defaults/isp/rss.rdf</span>
<a href="#l62.96"></a><span id="l62.96" class="difflineplus">+defaults/isp/en-US/dotmac.rdf</span>
<a href="#l62.97"></a><span id="l62.97" class="difflineplus">+defaults/isp/en-US/movemail.rdf</span>
<a href="#l62.98"></a><span id="l62.98" class="difflineplus">+defaults/isp/en-US/rss.rdf</span>
<a href="#l62.99"></a><span id="l62.99" class="difflineplus">+defaults/isp/en-US/</span>
<a href="#l62.100"></a><span id="l62.100" class="difflineplus">+defaults/isp/US/movemail.rdf</span>
<a href="#l62.101"></a><span id="l62.101" class="difflineplus">+defaults/isp/US/rss.rdf</span>
<a href="#l62.102"></a><span id="l62.102" class="difflineplus">+defaults/isp/US/</span>
<a href="#l62.103"></a><span id="l62.103" class="difflineplus">+defaults/isp/</span>
<a href="#l62.104"></a><span id="l62.104" class="difflineplus">+defaults/messenger/SpamAssassin.sfd</span>
<a href="#l62.105"></a><span id="l62.105" class="difflineplus">+defaults/messenger/SpamPal.sfd</span>
<a href="#l62.106"></a><span id="l62.106" class="difflineplus">+defaults/messenger/en-US/mailViews.dat</span>
<a href="#l62.107"></a><span id="l62.107" class="difflineplus">+defaults/messenger/US/mailViews.dat</span>
<a href="#l62.108"></a><span id="l62.108" class="difflineplus">+defaults/pref/all.js</span>
<a href="#l62.109"></a><span id="l62.109" class="difflineplus">+defaults/pref/editor.js</span>
<a href="#l62.110"></a><span id="l62.110" class="difflineplus">+defaults/pref/inspector.js</span>
<a href="#l62.111"></a><span id="l62.111" class="difflineplus">+defaults/pref/non-shared.txt</span>
<a href="#l62.112"></a><span id="l62.112" class="difflineplus">+defaults/pref/security-prefs.js</span>
<a href="#l62.113"></a><span id="l62.113" class="difflineplus">+defaults/pref/thunderbird.js</span>
<a href="#l62.114"></a><span id="l62.114" class="difflineplus">+defaults/pref/winpref.js</span>
<a href="#l62.115"></a><span id="l62.115" class="difflineplus">+defaults/pref/xpinstall.js</span>
<a href="#l62.116"></a><span id="l62.116" class="difflineplus">+defaults/profile/extensions/{972ce4c6-7e08-4474-a285-3208198ce6fd}/install.rdf</span>
<a href="#l62.117"></a><span id="l62.117" class="difflineplus">+defaults/profile/extensions/{972ce4c6-7e08-4474-a285-3208198ce6fd}/</span>
<a href="#l62.118"></a><span id="l62.118" class="difflineplus">+defaults/profile/extensions/Extensions.rdf</span>
<a href="#l62.119"></a><span id="l62.119" class="difflineplus">+defaults/profile/extensions/installed-extensions.txt</span>
<a href="#l62.120"></a><span id="l62.120" class="difflineplus">+defaults/profile/extensions/</span>
<a href="#l62.121"></a><span id="l62.121" class="difflineplus">+defaults/profile/US/localstore.rdf</span>
<a href="#l62.122"></a><span id="l62.122" class="difflineplus">+defaults/profile/US/mimeTypes.rdf</span>
<a href="#l62.123"></a><span id="l62.123" class="difflineplus">+defaults/profile/US/</span>
<a href="#l62.124"></a><span id="l62.124" class="difflineplus">+#ifdef XP_WIN</span>
<a href="#l62.125"></a><span id="l62.125" class="difflineplus">+defaults/shortcuts/Mozilla Thunderbird.lnk</span>
<a href="#l62.126"></a><span id="l62.126" class="difflineplus">+defaults/shortcuts/Mozilla Thunderbird (No Extensions).lnk</span>
<a href="#l62.127"></a><span id="l62.127" class="difflineplus">+defaults/shortcuts/</span>
<a href="#l62.128"></a><span id="l62.128" class="difflineplus">+#endif</span>
<a href="#l62.129"></a><span id="l62.129" class="difflineplus">+defaults/wallet/VcardSchema.tbl</span>
<a href="#l62.130"></a><span id="l62.130" class="difflineplus">+defaults/wallet/FieldSchema.tbl</span>
<a href="#l62.131"></a><span id="l62.131" class="difflineplus">+defaults/wallet/SchemaConcat.tbl</span>
<a href="#l62.132"></a><span id="l62.132" class="difflineplus">+defaults/wallet/DistinguishedSchema.tbl</span>
<a href="#l62.133"></a><span id="l62.133" class="difflineplus">+defaults/wallet/SchemaStrings.tbl</span>
<a href="#l62.134"></a><span id="l62.134" class="difflineplus">+defaults/wallet/PositionalSchema.tbl</span>
<a href="#l62.135"></a><span id="l62.135" class="difflineplus">+defaults/wallet/StateSchema.tbl</span>
<a href="#l62.136"></a><span id="l62.136" class="difflineplus">+#ifdef MOZ_WIDGET_GTK2</span>
<a href="#l62.137"></a><span id="l62.137" class="difflineplus">+icons/mozicon128.png</span>
<a href="#l62.138"></a><span id="l62.138" class="difflineplus">+icons/mozicon16.xpm</span>
<a href="#l62.139"></a><span id="l62.139" class="difflineplus">+icons/mozicon50.xpm</span>
<a href="#l62.140"></a><span id="l62.140" class="difflineplus">+#endif</span>
<a href="#l62.141"></a><span id="l62.141" class="difflineplus">+init.d/README</span>
<a href="#l62.142"></a><span id="l62.142" class="difflineplus">+isp/gmail.rdf</span>
<a href="#l62.143"></a><span id="l62.143" class="difflineplus">+modules/JSON.jsm</span>
<a href="#l62.144"></a><span id="l62.144" class="difflineplus">+plugins/</span>
<a href="#l62.145"></a><span id="l62.145" class="difflineplus">+res/bloatcycle.html</span>
<a href="#l62.146"></a><span id="l62.146" class="difflineplus">+res/cmessage.txt</span>
<a href="#l62.147"></a><span id="l62.147" class="difflineplus">+#ifndef MOZILLA_1_9_1_BRANCH</span>
<a href="#l62.148"></a><span id="l62.148" class="difflineplus">+res/broken-image.gif</span>
<a href="#l62.149"></a><span id="l62.149" class="difflineplus">+res/loading-image.gif</span>
<a href="#l62.150"></a><span id="l62.150" class="difflineplus">+#endif</span>
<a href="#l62.151"></a><span id="l62.151" class="difflineplus">+res/platform-forms.css</span>
<a href="#l62.152"></a><span id="l62.152" class="difflineplus">+res/sample.unixpsfonts.properties</span>
<a href="#l62.153"></a><span id="l62.153" class="difflineplus">+res/builtin/htmlBindings.xml</span>
<a href="#l62.154"></a><span id="l62.154" class="difflineplus">+res/builtin/platformHTMLBindings.xml</span>
<a href="#l62.155"></a><span id="l62.155" class="difflineplus">+res/builtin/</span>
<a href="#l62.156"></a><span id="l62.156" class="difflineplus">+#ifdef XP_MACOSX</span>
<a href="#l62.157"></a><span id="l62.157" class="difflineplus">+res/cursors/CVS/Entries</span>
<a href="#l62.158"></a><span id="l62.158" class="difflineplus">+res/cursors/CVS/Repository</span>
<a href="#l62.159"></a><span id="l62.159" class="difflineplus">+res/cursors/CVS/Root</span>
<a href="#l62.160"></a><span id="l62.160" class="difflineplus">+res/cursors/CVS/Tag</span>
<a href="#l62.161"></a><span id="l62.161" class="difflineplus">+#endif</span>
<a href="#l62.162"></a><span id="l62.162" class="difflineplus">+res/fonts/fontEncoding.properties</span>
<a href="#l62.163"></a><span id="l62.163" class="difflineplus">+res/fonts/pangoFontEncoding.properties</span>
<a href="#l62.164"></a><span id="l62.164" class="difflineplus">+res/html/gopher-audio.gif</span>
<a href="#l62.165"></a><span id="l62.165" class="difflineplus">+res/html/gopher-binary.gif</span>
<a href="#l62.166"></a><span id="l62.166" class="difflineplus">+res/html/gopher-find.gif</span>
<a href="#l62.167"></a><span id="l62.167" class="difflineplus">+res/html/gopher-image.gif</span>
<a href="#l62.168"></a><span id="l62.168" class="difflineplus">+res/html/gopher-menu.gif</span>
<a href="#l62.169"></a><span id="l62.169" class="difflineplus">+res/html/gopher-movie.gif</span>
<a href="#l62.170"></a><span id="l62.170" class="difflineplus">+res/html/gopher-sound.gif</span>
<a href="#l62.171"></a><span id="l62.171" class="difflineplus">+res/html/gopher-telnet.gif</span>
<a href="#l62.172"></a><span id="l62.172" class="difflineplus">+res/html/gopher-text.gif</span>
<a href="#l62.173"></a><span id="l62.173" class="difflineplus">+res/html/gopher-unknown.gif</span>
<a href="#l62.174"></a><span id="l62.174" class="difflineplus">+#ifdef XP_MACOSX</span>
<a href="#l62.175"></a><span id="l62.175" class="difflineplus">+Thunderbird.app/Contents/Library/Spotlight/Thunderbird.mdimporter/Contents/Info.plist</span>
<a href="#l62.176"></a><span id="l62.176" class="difflineplus">+Thunderbird.app/Contents/Library/Spotlight/Thunderbird.mdimporter/Contents/MacOS/Thunderbird</span>
<a href="#l62.177"></a><span id="l62.177" class="difflineplus">+Thunderbird.app/Contents/Library/Spotlight/Thunderbird.mdimporter/Contents/Resources/schema.xml</span>
<a href="#l62.178"></a><span id="l62.178" class="difflineplus">+Thunderbird.app/Contents/Library/Spotlight/Thunderbird.mdimporter/Contents/Resources/English.lproj/InfoPlist.strings</span>
<a href="#l62.179"></a><span id="l62.179" class="difflineplus">+Thunderbird.app/Contents/Library/Spotlight/Thunderbird.mdimporter/Contents/Resources/English.lproj/schema.strings</span>
<a href="#l62.180"></a><span id="l62.180" class="difflineplus">+#endif</span>
<a href="#l62.181"></a><span id="l62.181" class="difflineplus">+uninstall/UninstallThunderbird.exe</span>
<a href="#l62.182"></a><span id="l62.182" class="difflineplus">+uninstall/uninst.exe</span>
<a href="#l62.183"></a><span id="l62.183" class="difflineplus">+uninstall/uninstall.exe</span>
<a href="#l62.184"></a><span id="l62.184" class="difflineplus">+#ifdef XP_MACOSX</span>
<a href="#l62.185"></a><span id="l62.185" class="difflineplus">+updater.app/Contents/MacOS/updater.ini</span>
<a href="#l62.186"></a><span id="l62.186" class="difflineplus">+#endif</span>
<a href="#l62.187"></a><span id="l62.187" class="difflineplus">+.autoreg</span>
<a href="#l62.188"></a><span id="l62.188" class="difflineplus">+component.reg</span>
<a href="#l62.189"></a><span id="l62.189" class="difflineplus">+@DLL_PREFIX@jemalloc@DLL_SUFFIX@</span>
<a href="#l62.190"></a><span id="l62.190" class="difflineplus">+#ifdef XP_WIN</span>
<a href="#l62.191"></a><span id="l62.191" class="difflineplus">+#ifdef MOZ_MEMORY</span>
<a href="#l62.192"></a><span id="l62.192" class="difflineplus">+Microsoft.VC80.CRT.manifest</span>
<a href="#l62.193"></a><span id="l62.193" class="difflineplus">+msvcm80.dll</span>
<a href="#l62.194"></a><span id="l62.194" class="difflineplus">+msvcp80.dll</span>
<a href="#l62.195"></a><span id="l62.195" class="difflineplus">+msvcr80.dll</span>
<a href="#l62.196"></a><span id="l62.196" class="difflineplus">+#else</span>
<a href="#l62.197"></a><span id="l62.197" class="difflineplus">+mozcrt19.dll</span>
<a href="#l62.198"></a><span id="l62.198" class="difflineplus">+#endif</span>
<a href="#l62.199"></a><span id="l62.199" class="difflineplus">+#endif</span>
<a href="#l62.200"></a><span id="l62.200" class="difflineplus">+mozilla-installer-bin</span>
<a href="#l62.201"></a><span id="l62.201" class="difflineplus">+nsldap32v50.dll</span>
<a href="#l62.202"></a><span id="l62.202" class="difflineplus">+@DLL_PREFIX@ldap50@DLL_SUFFIX@</span>
<a href="#l62.203"></a><span id="l62.203" class="difflineplus">+nsldappr32v50.dll</span>
<a href="#l62.204"></a><span id="l62.204" class="difflineplus">+@DLL_PREFIX@prldap50@DLL_SUFFIX@</span>
<a href="#l62.205"></a><span id="l62.205" class="difflineplus">+redo-prebinding.sh</span>
<a href="#l62.206"></a><span id="l62.206" class="difflineplus">+regxpcom.exe</span>
<a href="#l62.207"></a><span id="l62.207" class="difflineplus">+#ifdef XP_WIN</span>
<a href="#l62.208"></a><span id="l62.208" class="difflineplus">+xpicleanup.exe</span>
<a href="#l62.209"></a><span id="l62.209" class="difflineplus">+#else</span>
<a href="#l62.210"></a><span id="l62.210" class="difflineplus">+xpicleanup</span>
<a href="#l62.211"></a><span id="l62.211" class="difflineplus">+#endif</span>
<a href="#l62.212"></a><span id="l62.212" class="difflineplus">+@DLL_PREFIX@xpcom_compat@DLL_SUFFIX@</span>
<a href="#l62.213"></a><span id="l62.213" class="difflineplus">+@DLL_PREFIX@xpistub@DLL_SUFFIX@</span>
<a href="#l62.214"></a><span id="l62.214" class="difflineplus">+@DLL_PREFIX@zlib@DLL_SUFFIX@</span>
<a href="#l62.215"></a><span id="l62.215" class="difflineplus">+# ****************************************************************************</span>
<a href="#l62.216"></a><span id="l62.216" class="difflineplus">+# * End generic removals section.                                            *</span>
<a href="#l62.217"></a><span id="l62.217" class="difflineplus">+# ****************************************************************************</span>
<a href="#l62.218"></a><span id="l62.218" class="difflineplus">+</span>
<a href="#l62.219"></a><span id="l62.219" class="difflineplus">+# ****************************************************************************</span>
<a href="#l62.220"></a><span id="l62.220" class="difflineplus">+# * Remove Talkback files from old location, where they were in 1.0.x        *</span>
<a href="#l62.221"></a><span id="l62.221" class="difflineplus">+# ****************************************************************************</span>
<a href="#l62.222"></a><span id="l62.222" class="difflineplus">+components/BrandRes.dll</span>
<a href="#l62.223"></a><span id="l62.223" class="difflineplus">+components/fullsoft.dll</span>
<a href="#l62.224"></a><span id="l62.224" class="difflineplus">+components/master.ini</span>
<a href="#l62.225"></a><span id="l62.225" class="difflineplus">+components/qfaservices.dll</span>
<a href="#l62.226"></a><span id="l62.226" class="difflineplus">+components/qfaservices.xpt</span>
<a href="#l62.227"></a><span id="l62.227" class="difflineplus">+components/talkback-l10n.ini</span>
<a href="#l62.228"></a><span id="l62.228" class="difflineplus">+components/talkback.cnt</span>
<a href="#l62.229"></a><span id="l62.229" class="difflineplus">+components/talkback.exe</span>
<a href="#l62.230"></a><span id="l62.230" class="difflineplus">+components/talkback.hlp</span>
<a href="#l62.231"></a><span id="l62.231" class="difflineplus">+components/libqfaservices.so</span>
<a href="#l62.232"></a><span id="l62.232" class="difflineplus">+components/talkback/master.ini</span>
<a href="#l62.233"></a><span id="l62.233" class="difflineplus">+components/talkback/talkback</span>
<a href="#l62.234"></a><span id="l62.234" class="difflineplus">+components/talkback/talkback.so</span>
<a href="#l62.235"></a><span id="l62.235" class="difflineplus">+components/talkback/XTalkback.ad</span>
<a href="#l62.236"></a><span id="l62.236" class="difflineplus">+# **************************************************************************##</span>
<a href="#l62.237"></a><span id="l62.237" class="difflineplus">+# * Remove Talkback files from new location, where they were in 1.5.x and    *</span>
<a href="#l62.238"></a><span id="l62.238" class="difflineplus">+# * 2.0.x.                                                                   *</span>
<a href="#l62.239"></a><span id="l62.239" class="difflineplus">+# ****************************************************************************</span>
<a href="#l62.240"></a><span id="l62.240" class="difflineplus">+extensions/talkback@mozilla.org/</span>
<a href="#l62.241"></a><span id="l62.241" class="difflineplus">+extensions/talkback@mozilla.org/install.rdf</span>
<a href="#l62.242"></a><span id="l62.242" class="difflineplus">+extensions/talkback@mozilla.org/chrome.manifest</span>
<a href="#l62.243"></a><span id="l62.243" class="difflineplus">+extensions/talkback@mozilla.org/components/qfaservices.xpt</span>
<a href="#l62.244"></a><span id="l62.244" class="difflineplus">+extensions/talkback@mozilla.org/components/@DLL_PREFIX@qfaservices@DLL_SUFFIX@</span>
<a href="#l62.245"></a><span id="l62.245" class="difflineplus">+#ifdef XP_WIN</span>
<a href="#l62.246"></a><span id="l62.246" class="difflineplus">+extensions/talkback@mozilla.org/components/BrandRes.dll</span>
<a href="#l62.247"></a><span id="l62.247" class="difflineplus">+extensions/talkback@mozilla.org/components/fullsoft.dll</span>
<a href="#l62.248"></a><span id="l62.248" class="difflineplus">+extensions/talkback@mozilla.org/components/master.ini</span>
<a href="#l62.249"></a><span id="l62.249" class="difflineplus">+extensions/talkback@mozilla.org/components/talkback-l10n.ini</span>
<a href="#l62.250"></a><span id="l62.250" class="difflineplus">+extensions/talkback@mozilla.org/components/talkback.cnt</span>
<a href="#l62.251"></a><span id="l62.251" class="difflineplus">+extensions/talkback@mozilla.org/components/talkback.exe</span>
<a href="#l62.252"></a><span id="l62.252" class="difflineplus">+extensions/talkback@mozilla.org/components/talkback.hlp</span>
<a href="#l62.253"></a><span id="l62.253" class="difflineplus">+extensions/talkback@mozilla.org/InstallDisabled</span>
<a href="#l62.254"></a><span id="l62.254" class="difflineplus">+#else</span>
<a href="#l62.255"></a><span id="l62.255" class="difflineplus">+#ifdef XP_MACOSX</span>
<a href="#l62.256"></a><span id="l62.256" class="difflineplus">+extensions/talkback@mozilla.org/components/talkback/master.ini</span>
<a href="#l62.257"></a><span id="l62.257" class="difflineplus">+extensions/talkback@mozilla.org/components/talkback/talkback@DLL_SUFFIX@</span>
<a href="#l62.258"></a><span id="l62.258" class="difflineplus">+extensions/talkback@mozilla.org/components/talkback/Talkback.app/Contents/Info.plist</span>
<a href="#l62.259"></a><span id="l62.259" class="difflineplus">+extensions/talkback@mozilla.org/components/talkback/Talkback.app/Contents/MacOS/Talkback</span>
<a href="#l62.260"></a><span id="l62.260" class="difflineplus">+extensions/talkback@mozilla.org/components/talkback/Talkback.app/Contents/pbdevelopment.plist</span>
<a href="#l62.261"></a><span id="l62.261" class="difflineplus">+extensions/talkback@mozilla.org/components/talkback/Talkback.app/Contents/PkgInfo</span>
<a href="#l62.262"></a><span id="l62.262" class="difflineplus">+extensions/talkback@mozilla.org/components/talkback/Talkback.app/Contents/Resources/delete.tiff</span>
<a href="#l62.263"></a><span id="l62.263" class="difflineplus">+extensions/talkback@mozilla.org/components/talkback/Talkback.app/Contents/Resources/disable.tiff</span>
<a href="#l62.264"></a><span id="l62.264" class="difflineplus">+extensions/talkback@mozilla.org/components/talkback/Talkback.app/Contents/Resources/enable.tiff</span>
<a href="#l62.265"></a><span id="l62.265" class="difflineplus">+extensions/talkback@mozilla.org/components/talkback/Talkback.app/Contents/Resources/English.lproj/ArchivingSettings.nib/classes.nib</span>
<a href="#l62.266"></a><span id="l62.266" class="difflineplus">+extensions/talkback@mozilla.org/components/talkback/Talkback.app/Contents/Resources/English.lproj/ArchivingSettings.nib/info.nib</span>
<a href="#l62.267"></a><span id="l62.267" class="difflineplus">+extensions/talkback@mozilla.org/components/talkback/Talkback.app/Contents/Resources/English.lproj/ArchivingSettings.nib/objects.nib</span>
<a href="#l62.268"></a><span id="l62.268" class="difflineplus">+extensions/talkback@mozilla.org/components/talkback/Talkback.app/Contents/Resources/English.lproj/InfoPlist.strings</span>
<a href="#l62.269"></a><span id="l62.269" class="difflineplus">+extensions/talkback@mozilla.org/components/talkback/Talkback.app/Contents/Resources/English.lproj/IntroWizard.nib/classes.nib</span>
<a href="#l62.270"></a><span id="l62.270" class="difflineplus">+extensions/talkback@mozilla.org/components/talkback/Talkback.app/Contents/Resources/English.lproj/IntroWizard.nib/info.nib</span>
<a href="#l62.271"></a><span id="l62.271" class="difflineplus">+extensions/talkback@mozilla.org/components/talkback/Talkback.app/Contents/Resources/English.lproj/IntroWizard.nib/objects.nib</span>
<a href="#l62.272"></a><span id="l62.272" class="difflineplus">+extensions/talkback@mozilla.org/components/talkback/Talkback.app/Contents/Resources/English.lproj/Localizable.strings</span>
<a href="#l62.273"></a><span id="l62.273" class="difflineplus">+extensions/talkback@mozilla.org/components/talkback/Talkback.app/Contents/Resources/English.lproj/MainMenu.nib/classes.nib</span>
<a href="#l62.274"></a><span id="l62.274" class="difflineplus">+extensions/talkback@mozilla.org/components/talkback/Talkback.app/Contents/Resources/English.lproj/MainMenu.nib/info.nib</span>
<a href="#l62.275"></a><span id="l62.275" class="difflineplus">+extensions/talkback@mozilla.org/components/talkback/Talkback.app/Contents/Resources/English.lproj/MainMenu.nib/objects.nib</span>
<a href="#l62.276"></a><span id="l62.276" class="difflineplus">+extensions/talkback@mozilla.org/components/talkback/Talkback.app/Contents/Resources/English.lproj/ProxySettings.nib/classes.nib</span>
<a href="#l62.277"></a><span id="l62.277" class="difflineplus">+extensions/talkback@mozilla.org/components/talkback/Talkback.app/Contents/Resources/English.lproj/ProxySettings.nib/info.nib</span>
<a href="#l62.278"></a><span id="l62.278" class="difflineplus">+extensions/talkback@mozilla.org/components/talkback/Talkback.app/Contents/Resources/English.lproj/ProxySettings.nib/objects.nib</span>
<a href="#l62.279"></a><span id="l62.279" class="difflineplus">+extensions/talkback@mozilla.org/components/talkback/Talkback.app/Contents/Resources/English.lproj/SendingSettings.nib/classes.nib</span>
<a href="#l62.280"></a><span id="l62.280" class="difflineplus">+extensions/talkback@mozilla.org/components/talkback/Talkback.app/Contents/Resources/English.lproj/SendingSettings.nib/info.nib</span>
<a href="#l62.281"></a><span id="l62.281" class="difflineplus">+extensions/talkback@mozilla.org/components/talkback/Talkback.app/Contents/Resources/English.lproj/SendingSettings.nib/objects.nib</span>
<a href="#l62.282"></a><span id="l62.282" class="difflineplus">+extensions/talkback@mozilla.org/components/talkback/Talkback.app/Contents/Resources/KeyInfoKeys.plist</span>
<a href="#l62.283"></a><span id="l62.283" class="difflineplus">+extensions/talkback@mozilla.org/components/talkback/Talkback.app/Contents/Resources/KeyInfoSections.plist</span>
<a href="#l62.284"></a><span id="l62.284" class="difflineplus">+extensions/talkback@mozilla.org/components/talkback/Talkback.app/Contents/Resources/send.tiff</span>
<a href="#l62.285"></a><span id="l62.285" class="difflineplus">+extensions/talkback@mozilla.org/components/talkback/Talkback.app/Contents/Resources/sort_ascending.tiff</span>
<a href="#l62.286"></a><span id="l62.286" class="difflineplus">+extensions/talkback@mozilla.org/components/talkback/Talkback.app/Contents/Resources/sort_descending.tiff</span>
<a href="#l62.287"></a><span id="l62.287" class="difflineplus">+extensions/talkback@mozilla.org/components/talkback/Talkback.app/Contents/Resources/Talkback.icns</span>
<a href="#l62.288"></a><span id="l62.288" class="difflineplus">+#else</span>
<a href="#l62.289"></a><span id="l62.289" class="difflineplus">+extensions/talkback@mozilla.org/components/talkback/talkback</span>
<a href="#l62.290"></a><span id="l62.290" class="difflineplus">+extensions/talkback@mozilla.org/components/talkback/XTalkback.ad</span>
<a href="#l62.291"></a><span id="l62.291" class="difflineplus">+extensions/talkback@mozilla.org/components/talkback/master.ini</span>
<a href="#l62.292"></a><span id="l62.292" class="difflineplus">+extensions/talkback@mozilla.org/components/talkback/talkback.so</span>
<a href="#l62.293"></a><span id="l62.293" class="difflineplus">+#endif</span>
<a href="#l62.294"></a><span id="l62.294" class="difflineplus">+#endif</span>
<a href="#l62.295"></a><span id="l62.295" class="difflineplus">+# ****************************************************************************</span>
<a href="#l62.296"></a><span id="l62.296" class="difflineplus">+# * End removing Talkback.                                                   *</span>
<a href="#l62.297"></a><span id="l62.297" class="difflineplus">+# ****************************************************************************</span>
<a href="#l62.298"></a><span id="l62.298" class="difflineplus">+</span>
<a href="#l62.299"></a><span id="l62.299" class="difflineplus">+# ****************************************************************************</span>
<a href="#l62.300"></a><span id="l62.300" class="difflineplus">+# * Remove pre-extension PalmSync files.                                     *</span>
<a href="#l62.301"></a><span id="l62.301" class="difflineplus">+# ****************************************************************************</span>
<a href="#l62.302"></a><span id="l62.302" class="difflineplus">+HSAPI.dll</span>
<a href="#l62.303"></a><span id="l62.303" class="difflineplus">+CondMgr.dll</span>
<a href="#l62.304"></a><span id="l62.304" class="difflineplus">+mozABConduit.dll</span>
<a href="#l62.305"></a><span id="l62.305" class="difflineplus">+components/palmsync.dll</span>
<a href="#l62.306"></a><span id="l62.306" class="difflineplus">+components/palmSync.xpt</span>
<a href="#l62.307"></a><span id="l62.307" class="difflineplus">+# ****************************************************************************</span>
<a href="#l62.308"></a><span id="l62.308" class="difflineplus">+# * End pre-extensions PalmSync files.                                       *</span>
<a href="#l62.309"></a><span id="l62.309" class="difflineplus">+# ****************************************************************************</span>
<a href="#l62.310"></a><span id="l62.310" class="difflineplus">+</span>
<a href="#l62.311"></a><span id="l62.311" class="difflineplus">+# ****************************************************************************</span>
<a href="#l62.312"></a><span id="l62.312" class="difflineplus">+# * Remove the DLLs that were present at the time (2004-05) when we started  *</span>
<a href="#l62.313"></a><span id="l62.313" class="difflineplus">+# * shipping static builds on Windows. You almost certainly don't want to    *</span>
<a href="#l62.314"></a><span id="l62.314" class="difflineplus">+# * add anything to this section.                                            *</span>
<a href="#l62.315"></a><span id="l62.315" class="difflineplus">+# ****************************************************************************</span>
<a href="#l62.316"></a><span id="l62.316"> components/accessibility.dll</span>
<a href="#l62.317"></a><span id="l62.317"> components/appcomps.dll</span>
<a href="#l62.318"></a><span id="l62.318"> components/appshell.dll</span>
<a href="#l62.319"></a><span id="l62.319"> components/caps.dll</span>
<a href="#l62.320"></a><span id="l62.320"> components/chrome.dll</span>
<a href="#l62.321"></a><span id="l62.321"> components/composer.dll</span>
<a href="#l62.322"></a><span id="l62.322"> components/docshell.dll</span>
<a href="#l62.323"></a><span id="l62.323"> components/editor.dll</span>
<a href="#l62.324"></a><span id="l62.324" class="difflineat">@@ -12,55 +321,62 @@ components/embedcomponents.dll</span>
<a href="#l62.325"></a><span id="l62.325"> components/gkgfxwin.dll</span>
<a href="#l62.326"></a><span id="l62.326"> components/gklayout.dll</span>
<a href="#l62.327"></a><span id="l62.327"> components/gkparser.dll</span>
<a href="#l62.328"></a><span id="l62.328"> components/gkwidget.dll</span>
<a href="#l62.329"></a><span id="l62.329"> components/i18n.dll</span>
<a href="#l62.330"></a><span id="l62.330"> components/imgicon.dll</span>
<a href="#l62.331"></a><span id="l62.331"> components/imglib2.dll</span>
<a href="#l62.332"></a><span id="l62.332"> components/import.dll</span>
<a href="#l62.333"></a><span id="l62.333" class="difflineplus">+components/jsdom.dll</span>
<a href="#l62.334"></a><span id="l62.334"> components/mail.dll</span>
<a href="#l62.335"></a><span id="l62.335"> components/mork.dll</span>
<a href="#l62.336"></a><span id="l62.336"> components/mozfind.dll</span>
<a href="#l62.337"></a><span id="l62.337"> components/mozldap.dll</span>
<a href="#l62.338"></a><span id="l62.338"> components/msgMapi.dll</span>
<a href="#l62.339"></a><span id="l62.339"> components/msgsmime.dll</span>
<a href="#l62.340"></a><span id="l62.340" class="difflineminus">-components/myspell.dll</span>
<a href="#l62.341"></a><span id="l62.341"> components/necko.dll</span>
<a href="#l62.342"></a><span id="l62.342"> components/necko2.dll</span>
<a href="#l62.343"></a><span id="l62.343"> components/nsprefm.dll</span>
<a href="#l62.344"></a><span id="l62.344"> components/pipboot.dll</span>
<a href="#l62.345"></a><span id="l62.345"> components/pipnss.dll</span>
<a href="#l62.346"></a><span id="l62.346"> components/pippki.dll</span>
<a href="#l62.347"></a><span id="l62.347"> components/profile.dll</span>
<a href="#l62.348"></a><span id="l62.348"> components/profilemigration.dll</span>
<a href="#l62.349"></a><span id="l62.349"> components/rdf.dll</span>
<a href="#l62.350"></a><span id="l62.350" class="difflineminus">-components/spellchk.dll</span>
<a href="#l62.351"></a><span id="l62.351"> components/txmgr.dll</span>
<a href="#l62.352"></a><span id="l62.352"> components/uconv.dll</span>
<a href="#l62.353"></a><span id="l62.353" class="difflineminus">-components/@DLL_PREFIX@wallet@DLL_SUFFIX@</span>
<a href="#l62.354"></a><span id="l62.354" class="difflineminus">-components/@DLL_PREFIX@walletviewers@DLL_SUFFIX@</span>
<a href="#l62.355"></a><span id="l62.355"> components/webbrwsr.dll</span>
<a href="#l62.356"></a><span id="l62.356"> components/wlltvwrs.dll</span>
<a href="#l62.357"></a><span id="l62.357"> components/xmlextras.dll</span>
<a href="#l62.358"></a><span id="l62.358" class="difflineplus">+components/xmlextras.xpt</span>
<a href="#l62.359"></a><span id="l62.359"> components/xpc3250.dll</span>
<a href="#l62.360"></a><span id="l62.360"> components/xppref32.dll</span>
<a href="#l62.361"></a><span id="l62.361" class="difflineminus">-nsldap32v50.dll</span>
<a href="#l62.362"></a><span id="l62.362" class="difflineminus">-nsldappr32v50.dll</span>
<a href="#l62.363"></a><span id="l62.363" class="difflineminus">-components/wallet.xpt</span>
<a href="#l62.364"></a><span id="l62.364" class="difflineminus">-components/walleteditor.xpt</span>
<a href="#l62.365"></a><span id="l62.365" class="difflineminus">-components/walletpreview.xpt</span>
<a href="#l62.366"></a><span id="l62.366" class="difflineplus">+gkgfx.dll</span>
<a href="#l62.367"></a><span id="l62.367" class="difflineplus">+mozz.dll</span>
<a href="#l62.368"></a><span id="l62.368" class="difflineplus">+# ****************************************************************************</span>
<a href="#l62.369"></a><span id="l62.369" class="difflineplus">+# * End removing old shared dlls.                                            *</span>
<a href="#l62.370"></a><span id="l62.370" class="difflineplus">+# ****************************************************************************</span>
<a href="#l62.371"></a><span id="l62.371" class="difflineplus">+</span>
<a href="#l62.372"></a><span id="l62.372" class="difflineplus">+</span>
<a href="#l62.373"></a><span id="l62.373" class="difflineplus">+# ****************************************************************************</span>
<a href="#l62.374"></a><span id="l62.374" class="difflineplus">+# * Remove the XPTs that were present at the time (2004-09) when we started  *</span>
<a href="#l62.375"></a><span id="l62.375" class="difflineplus">+# * linking XPTs on Windows. You almost certainly don't want to add anything *</span>
<a href="#l62.376"></a><span id="l62.376" class="difflineplus">+# * to this section.                                                         *</span>
<a href="#l62.377"></a><span id="l62.377" class="difflineplus">+# ****************************************************************************</span>
<a href="#l62.378"></a><span id="l62.378"> #ifdef XP_WIN</span>
<a href="#l62.379"></a><span id="l62.379"> components/accessibility-msaa.xpt</span>
<a href="#l62.380"></a><span id="l62.380"> components/accessibility.xpt</span>
<a href="#l62.381"></a><span id="l62.381"> components/addrbook.xpt</span>
<a href="#l62.382"></a><span id="l62.382"> components/alerts.xpt</span>
<a href="#l62.383"></a><span id="l62.383"> components/appshell.xpt</span>
<a href="#l62.384"></a><span id="l62.384" class="difflineplus">+components/autocomplete.xpt</span>
<a href="#l62.385"></a><span id="l62.385"> components/caps.xpt</span>
<a href="#l62.386"></a><span id="l62.386"> components/chardet.xpt</span>
<a href="#l62.387"></a><span id="l62.387" class="difflineplus">+components/chrome.xpt</span>
<a href="#l62.388"></a><span id="l62.388"> components/commandhandler.xpt</span>
<a href="#l62.389"></a><span id="l62.389"> components/composer.xpt</span>
<a href="#l62.390"></a><span id="l62.390"> components/content_base.xpt</span>
<a href="#l62.391"></a><span id="l62.391"> components/content_html.xpt</span>
<a href="#l62.392"></a><span id="l62.392"> components/content_htmldoc.xpt</span>
<a href="#l62.393"></a><span id="l62.393"> components/content_xmldoc.xpt</span>
<a href="#l62.394"></a><span id="l62.394"> components/content_xslt.xpt</span>
<a href="#l62.395"></a><span id="l62.395"> components/crashreporter.xpt</span>
<a href="#l62.396"></a><span id="l62.396" class="difflineat">@@ -68,28 +384,25 @@ components/docshell_base.xpt</span>
<a href="#l62.397"></a><span id="l62.397"> components/dom.xpt</span>
<a href="#l62.398"></a><span id="l62.398"> components/dom_base.xpt</span>
<a href="#l62.399"></a><span id="l62.399"> components/dom_core.xpt</span>
<a href="#l62.400"></a><span id="l62.400"> components/dom_css.xpt</span>
<a href="#l62.401"></a><span id="l62.401"> components/dom_events.xpt</span>
<a href="#l62.402"></a><span id="l62.402"> components/dom_html.xpt</span>
<a href="#l62.403"></a><span id="l62.403"> components/dom_offline.xpt</span>
<a href="#l62.404"></a><span id="l62.404"> components/dom_range.xpt</span>
<a href="#l62.405"></a><span id="l62.405" class="difflineminus">-#ifdef MOZILLA_1_9_1_BRANCH</span>
<a href="#l62.406"></a><span id="l62.406" class="difflineminus">-components/dom_smil.xpt</span>
<a href="#l62.407"></a><span id="l62.407" class="difflineminus">-#endif</span>
<a href="#l62.408"></a><span id="l62.408"> components/dom_stylesheets.xpt</span>
<a href="#l62.409"></a><span id="l62.409"> components/dom_traversal.xpt</span>
<a href="#l62.410"></a><span id="l62.410"> components/dom_views.xpt</span>
<a href="#l62.411"></a><span id="l62.411"> components/dom_xbl.xpt</span>
<a href="#l62.412"></a><span id="l62.412"> components/dom_xpath.xpt</span>
<a href="#l62.413"></a><span id="l62.413"> components/dom_xul.xpt</span>
<a href="#l62.414"></a><span id="l62.414" class="difflineminus">-components/downloadmanager.xpt</span>
<a href="#l62.415"></a><span id="l62.415"> components/editor.xpt</span>
<a href="#l62.416"></a><span id="l62.416"> components/embed_base.xpt</span>
<a href="#l62.417"></a><span id="l62.417" class="difflineplus">+components/extensions.xpt</span>
<a href="#l62.418"></a><span id="l62.418"> components/exthandler.xpt</span>
<a href="#l62.419"></a><span id="l62.419"> components/find.xpt</span>
<a href="#l62.420"></a><span id="l62.420"> components/gfx.xpt</span>
<a href="#l62.421"></a><span id="l62.421"> components/helperAppDlg.xpt</span>
<a href="#l62.422"></a><span id="l62.422"> components/htmlparser.xpt</span>
<a href="#l62.423"></a><span id="l62.423"> components/imgicon.xpt</span>
<a href="#l62.424"></a><span id="l62.424"> components/imglib2.xpt</span>
<a href="#l62.425"></a><span id="l62.425"> components/impComm4xMail.xpt</span>
<a href="#l62.426"></a><span id="l62.426" class="difflineat">@@ -99,96 +412,100 @@ components/jar.xpt</span>
<a href="#l62.427"></a><span id="l62.427"> components/jsdservice.xpt</span>
<a href="#l62.428"></a><span id="l62.428"> components/jsurl.xpt</span>
<a href="#l62.429"></a><span id="l62.429"> components/layout_base.xpt</span>
<a href="#l62.430"></a><span id="l62.430"> components/layout_printing.xpt</span>
<a href="#l62.431"></a><span id="l62.431"> components/layout_xul.xpt</span>
<a href="#l62.432"></a><span id="l62.432"> components/layout_xul_tree.xpt</span>
<a href="#l62.433"></a><span id="l62.433"> components/locale.xpt</span>
<a href="#l62.434"></a><span id="l62.434"> components/lwbrk.xpt</span>
<a href="#l62.435"></a><span id="l62.435" class="difflineminus">-components/mailnews.xpt</span>
<a href="#l62.436"></a><span id="l62.436"> components/mailview.xpt</span>
<a href="#l62.437"></a><span id="l62.437"> components/mapihook.xpt</span>
<a href="#l62.438"></a><span id="l62.438"> components/mime.xpt</span>
<a href="#l62.439"></a><span id="l62.439"> components/mimetype.xpt</span>
<a href="#l62.440"></a><span id="l62.440"> components/mozbrwsr.xpt</span>
<a href="#l62.441"></a><span id="l62.441"> components/mozfind.xpt</span>
<a href="#l62.442"></a><span id="l62.442"> components/mozldap.xpt</span>
<a href="#l62.443"></a><span id="l62.443"> components/msgbase.xpt</span>
<a href="#l62.444"></a><span id="l62.444"> components/msgcompo.xpt</span>
<a href="#l62.445"></a><span id="l62.445"> components/msgdb.xpt</span>
<a href="#l62.446"></a><span id="l62.446"> components/msgimap.xpt</span>
<a href="#l62.447"></a><span id="l62.447"> components/msglocal.xpt</span>
<a href="#l62.448"></a><span id="l62.448"> components/msgnews.xpt</span>
<a href="#l62.449"></a><span id="l62.449"> components/msgsearch.xpt</span>
<a href="#l62.450"></a><span id="l62.450"> components/msgsmime.xpt</span>
<a href="#l62.451"></a><span id="l62.451"> components/necko.xpt</span>
<a href="#l62.452"></a><span id="l62.452" class="difflineplus">+components/necko_about.xpt</span>
<a href="#l62.453"></a><span id="l62.453"> components/necko_cache.xpt</span>
<a href="#l62.454"></a><span id="l62.454"> components/necko_cookie.xpt</span>
<a href="#l62.455"></a><span id="l62.455" class="difflineminus">-components/necko_data.xpt</span>
<a href="#l62.456"></a><span id="l62.456"> components/necko_dns.xpt</span>
<a href="#l62.457"></a><span id="l62.457"> components/necko_file.xpt</span>
<a href="#l62.458"></a><span id="l62.458" class="difflineplus">+components/necko_ftp.xpt</span>
<a href="#l62.459"></a><span id="l62.459"> components/necko_http.xpt</span>
<a href="#l62.460"></a><span id="l62.460"> components/necko_jar.xpt</span>
<a href="#l62.461"></a><span id="l62.461"> components/necko_res.xpt</span>
<a href="#l62.462"></a><span id="l62.462"> components/necko_strconv.xpt</span>
<a href="#l62.463"></a><span id="l62.463"> components/pipboot.xpt</span>
<a href="#l62.464"></a><span id="l62.464"> components/pipnss.xpt</span>
<a href="#l62.465"></a><span id="l62.465"> components/pippki.xpt</span>
<a href="#l62.466"></a><span id="l62.466"> components/pref.xpt</span>
<a href="#l62.467"></a><span id="l62.467"> components/prefmigr.xpt</span>
<a href="#l62.468"></a><span id="l62.468"> components/profile.xpt</span>
<a href="#l62.469"></a><span id="l62.469" class="difflineminus">-components/progressDlg.xpt</span>
<a href="#l62.470"></a><span id="l62.470"> components/proxyObject.xpt</span>
<a href="#l62.471"></a><span id="l62.471"> components/rdf.xpt</span>
<a href="#l62.472"></a><span id="l62.472" class="difflineminus">-components/signonviewer.xpt</span>
<a href="#l62.473"></a><span id="l62.473"> components/spellchecker.xpt</span>
<a href="#l62.474"></a><span id="l62.474" class="difflineplus">+components/toolkitprofile.xpt</span>
<a href="#l62.475"></a><span id="l62.475"> components/txmgr.xpt</span>
<a href="#l62.476"></a><span id="l62.476"> components/txtsvc.xpt</span>
<a href="#l62.477"></a><span id="l62.477"> components/uconv.xpt</span>
<a href="#l62.478"></a><span id="l62.478" class="difflineplus">+components/ucnative.xpt</span>
<a href="#l62.479"></a><span id="l62.479"> components/unicharutil.xpt</span>
<a href="#l62.480"></a><span id="l62.480" class="difflineplus">+components/update.xpt</span>
<a href="#l62.481"></a><span id="l62.481"> components/uriloader.xpt</span>
<a href="#l62.482"></a><span id="l62.482" class="difflineplus">+components/util.xpt</span>
<a href="#l62.483"></a><span id="l62.483"> components/webbrowserpersist.xpt</span>
<a href="#l62.484"></a><span id="l62.484"> components/webBrowser_core.xpt</span>
<a href="#l62.485"></a><span id="l62.485"> components/webshell_idls.xpt</span>
<a href="#l62.486"></a><span id="l62.486"> components/widget.xpt</span>
<a href="#l62.487"></a><span id="l62.487"> components/windowds.xpt</span>
<a href="#l62.488"></a><span id="l62.488"> components/windowwatcher.xpt</span>
<a href="#l62.489"></a><span id="l62.489"> components/winhooks.xpt</span>
<a href="#l62.490"></a><span id="l62.490"> components/xmlextras.xpt</span>
<a href="#l62.491"></a><span id="l62.491"> components/xpcom_base.xpt</span>
<a href="#l62.492"></a><span id="l62.492"> components/xpcom_components.xpt</span>
<a href="#l62.493"></a><span id="l62.493"> components/xpcom_ds.xpt</span>
<a href="#l62.494"></a><span id="l62.494"> components/xpcom_io.xpt</span>
<a href="#l62.495"></a><span id="l62.495" class="difflineminus">-components/xpcom_obsolete.xpt</span>
<a href="#l62.496"></a><span id="l62.496"> components/xpcom_thread.xpt</span>
<a href="#l62.497"></a><span id="l62.497"> components/xpcom_xpti.xpt</span>
<a href="#l62.498"></a><span id="l62.498"> components/xpcom.xpt</span>
<a href="#l62.499"></a><span id="l62.499"> components/xpconnect.xpt</span>
<a href="#l62.500"></a><span id="l62.500"> components/xpinstall.xpt</span>
<a href="#l62.501"></a><span id="l62.501"> components/xuldoc.xpt</span>
<a href="#l62.502"></a><span id="l62.502"> components/xultmpl.xpt</span>
<a href="#l62.503"></a><span id="l62.503" class="difflineminus">-components/downloadmanager.xpt</span>
<a href="#l62.504"></a><span id="l62.504" class="difflineminus">-#ifndef MOZILLA_1_9_1_BRANCH</span>
<a href="#l62.505"></a><span id="l62.505" class="difflineminus">-components/nsPostUpdateWin.js</span>
<a href="#l62.506"></a><span id="l62.506"> #endif</span>
<a href="#l62.507"></a><span id="l62.507" class="difflineminus">-#endif</span>
<a href="#l62.508"></a><span id="l62.508" class="difflineplus">+# ****************************************************************************</span>
<a href="#l62.509"></a><span id="l62.509" class="difflineplus">+# * End of XPTs at the time we started linking them on Windows.              *</span>
<a href="#l62.510"></a><span id="l62.510" class="difflineplus">+# ****************************************************************************</span>
<a href="#l62.511"></a><span id="l62.511" class="difflineplus">+</span>
<a href="#l62.512"></a><span id="l62.512" class="difflineplus">+# ****************************************************************************</span>
<a href="#l62.513"></a><span id="l62.513" class="difflineplus">+# * Remove the XPTs that were present at the time (2009-04) when we started  *</span>
<a href="#l62.514"></a><span id="l62.514" class="difflineplus">+# * linking XPTs on Linux. You almost certainly don't want to add anything   *</span>
<a href="#l62.515"></a><span id="l62.515" class="difflineplus">+# * to this section.                                                         *</span>
<a href="#l62.516"></a><span id="l62.516" class="difflineplus">+# ****************************************************************************</span>
<a href="#l62.517"></a><span id="l62.517"> #ifndef MOZILLA_1_9_1_BRANCH</span>
<a href="#l62.518"></a><span id="l62.518"> #ifdef XP_UNIX</span>
<a href="#l62.519"></a><span id="l62.519"> #ifndef XP_MACOSX</span>
<a href="#l62.520"></a><span id="l62.520" class="difflineminus">-components/accessibility-atk.xpt</span>
<a href="#l62.521"></a><span id="l62.521"> components/accessibility.xpt</span>
<a href="#l62.522"></a><span id="l62.522"> components/activity.xpt</span>
<a href="#l62.523"></a><span id="l62.523"> components/addrbook.xpt</span>
<a href="#l62.524"></a><span id="l62.524"> components/alerts.xpt</span>
<a href="#l62.525"></a><span id="l62.525"> components/appshell.xpt</span>
<a href="#l62.526"></a><span id="l62.526"> components/appstartup.xpt</span>
<a href="#l62.527"></a><span id="l62.527"> components/autocomplete.xpt</span>
<a href="#l62.528"></a><span id="l62.528"> components/autoconfig.xpt</span>
<a href="#l62.529"></a><span id="l62.529" class="difflineminus">-components/bookmarks.xpt</span>
<a href="#l62.530"></a><span id="l62.530"> components/caps.xpt</span>
<a href="#l62.531"></a><span id="l62.531"> components/chardet.xpt</span>
<a href="#l62.532"></a><span id="l62.532"> components/chrome.xpt</span>
<a href="#l62.533"></a><span id="l62.533"> components/commandhandler.xpt</span>
<a href="#l62.534"></a><span id="l62.534"> components/commandlines.xpt</span>
<a href="#l62.535"></a><span id="l62.535"> components/composer.xpt</span>
<a href="#l62.536"></a><span id="l62.536"> components/content_base.xpt</span>
<a href="#l62.537"></a><span id="l62.537"> components/content_htmldoc.xpt</span>
<a href="#l62.538"></a><span id="l62.538" class="difflineat">@@ -228,55 +545,50 @@ components/embed_base.xpt</span>
<a href="#l62.539"></a><span id="l62.539"> components/extensions.xpt</span>
<a href="#l62.540"></a><span id="l62.540"> components/exthandler.xpt</span>
<a href="#l62.541"></a><span id="l62.541"> components/exthelper.xpt</span>
<a href="#l62.542"></a><span id="l62.542"> components/fastfind.xpt</span>
<a href="#l62.543"></a><span id="l62.543"> components/feeds.xpt</span>
<a href="#l62.544"></a><span id="l62.544"> components/filepicker.xpt</span>
<a href="#l62.545"></a><span id="l62.545"> components/find.xpt</span>
<a href="#l62.546"></a><span id="l62.546"> components/gfx.xpt</span>
<a href="#l62.547"></a><span id="l62.547" class="difflineminus">-components/history.xpt</span>
<a href="#l62.548"></a><span id="l62.548"> components/htmlparser.xpt</span>
<a href="#l62.549"></a><span id="l62.549"> components/imgicon.xpt</span>
<a href="#l62.550"></a><span id="l62.550"> components/imglib2.xpt</span>
<a href="#l62.551"></a><span id="l62.551"> components/impComm4xMail.xpt</span>
<a href="#l62.552"></a><span id="l62.552"> components/import.xpt</span>
<a href="#l62.553"></a><span id="l62.553"> components/inspector.xpt</span>
<a href="#l62.554"></a><span id="l62.554"> components/intl.xpt</span>
<a href="#l62.555"></a><span id="l62.555"> components/jar.xpt</span>
<a href="#l62.556"></a><span id="l62.556" class="difflineminus">-components/jsconsole.xpt</span>
<a href="#l62.557"></a><span id="l62.557"> components/jsdservice.xpt</span>
<a href="#l62.558"></a><span id="l62.558"> components/layout_base.xpt</span>
<a href="#l62.559"></a><span id="l62.559"> components/layout_printing.xpt</span>
<a href="#l62.560"></a><span id="l62.560"> components/layout_xul_tree.xpt</span>
<a href="#l62.561"></a><span id="l62.561"> components/layout_xul.xpt</span>
<a href="#l62.562"></a><span id="l62.562"> components/locale.xpt</span>
<a href="#l62.563"></a><span id="l62.563"> components/loginmgr.xpt</span>
<a href="#l62.564"></a><span id="l62.564"> components/lwbrk.xpt</span>
<a href="#l62.565"></a><span id="l62.565" class="difflineminus">-components/mailnews.xpt</span>
<a href="#l62.566"></a><span id="l62.566"> components/mailprofilemigration.xpt</span>
<a href="#l62.567"></a><span id="l62.567"> components/mailview.xpt</span>
<a href="#l62.568"></a><span id="l62.568"> components/mimetype.xpt</span>
<a href="#l62.569"></a><span id="l62.569"> components/mime.xpt</span>
<a href="#l62.570"></a><span id="l62.570"> components/mozbrwsr.xpt</span>
<a href="#l62.571"></a><span id="l62.571"> components/mozfind.xpt</span>
<a href="#l62.572"></a><span id="l62.572" class="difflineminus">-components/mozgnome.xpt</span>
<a href="#l62.573"></a><span id="l62.573"> components/mozldap.xpt</span>
<a href="#l62.574"></a><span id="l62.574"> components/msgbase.xpt</span>
<a href="#l62.575"></a><span id="l62.575"> components/msgcompose.xpt</span>
<a href="#l62.576"></a><span id="l62.576"> components/msgdb.xpt</span>
<a href="#l62.577"></a><span id="l62.577"> components/msgimap.xpt</span>
<a href="#l62.578"></a><span id="l62.578"> components/msglocal.xpt</span>
<a href="#l62.579"></a><span id="l62.579"> components/msgnews.xpt</span>
<a href="#l62.580"></a><span id="l62.580"> components/msgsearch.xpt</span>
<a href="#l62.581"></a><span id="l62.581"> components/msgsmime.xpt</span>
<a href="#l62.582"></a><span id="l62.582"> components/necko_about.xpt</span>
<a href="#l62.583"></a><span id="l62.583"> components/necko_cache.xpt</span>
<a href="#l62.584"></a><span id="l62.584"> components/necko_cookie.xpt</span>
<a href="#l62.585"></a><span id="l62.585" class="difflineminus">-components/necko_data.xpt</span>
<a href="#l62.586"></a><span id="l62.586"> components/necko_dns.xpt</span>
<a href="#l62.587"></a><span id="l62.587"> components/necko_file.xpt</span>
<a href="#l62.588"></a><span id="l62.588"> components/necko_ftp.xpt</span>
<a href="#l62.589"></a><span id="l62.589"> components/necko_http.xpt</span>
<a href="#l62.590"></a><span id="l62.590"> components/necko_res.xpt</span>
<a href="#l62.591"></a><span id="l62.591"> components/necko_socket.xpt</span>
<a href="#l62.592"></a><span id="l62.592"> components/necko_strconv.xpt</span>
<a href="#l62.593"></a><span id="l62.593"> components/necko_viewsource.xpt</span>
<a href="#l62.594"></a><span id="l62.594" class="difflineat">@@ -285,23 +597,21 @@ components/parentalcontrols.xpt</span>
<a href="#l62.595"></a><span id="l62.595"> components/pipboot.xpt</span>
<a href="#l62.596"></a><span id="l62.596"> components/pipnss.xpt</span>
<a href="#l62.597"></a><span id="l62.597"> components/pippki.xpt</span>
<a href="#l62.598"></a><span id="l62.598"> components/places.xpt</span>
<a href="#l62.599"></a><span id="l62.599"> components/plugin.xpt</span>
<a href="#l62.600"></a><span id="l62.600"> components/prefetch.xpt</span>
<a href="#l62.601"></a><span id="l62.601"> components/pref.xpt</span>
<a href="#l62.602"></a><span id="l62.602"> components/profile.xpt</span>
<a href="#l62.603"></a><span id="l62.603" class="difflineminus">-components/progressDlg.xpt</span>
<a href="#l62.604"></a><span id="l62.604"> components/proxyObjInst.xpt</span>
<a href="#l62.605"></a><span id="l62.605"> components/rdf.xpt</span>
<a href="#l62.606"></a><span id="l62.606"> components/saxparser.xpt</span>
<a href="#l62.607"></a><span id="l62.607"> components/shellservice.xpt</span>
<a href="#l62.608"></a><span id="l62.608"> components/shistory.xpt</span>
<a href="#l62.609"></a><span id="l62.609" class="difflineminus">-components/signonviewer.xpt</span>
<a href="#l62.610"></a><span id="l62.610"> components/spellchecker.xpt</span>
<a href="#l62.611"></a><span id="l62.611"> components/storage.xpt</span>
<a href="#l62.612"></a><span id="l62.612"> components/toolkitprofile.xpt</span>
<a href="#l62.613"></a><span id="l62.613"> components/toolkitremote.xpt</span>
<a href="#l62.614"></a><span id="l62.614"> components/txmgr.xpt</span>
<a href="#l62.615"></a><span id="l62.615"> components/txtsvc.xpt</span>
<a href="#l62.616"></a><span id="l62.616"> components/uconv.xpt</span>
<a href="#l62.617"></a><span id="l62.617"> components/unicharutil.xpt</span>
<a href="#l62.618"></a><span id="l62.618" class="difflineat">@@ -316,210 +626,23 @@ components/websrvcs.xpt</span>
<a href="#l62.619"></a><span id="l62.619"> components/widget.xpt</span>
<a href="#l62.620"></a><span id="l62.620"> components/windowds.xpt</span>
<a href="#l62.621"></a><span id="l62.621"> components/windowwatcher.xpt</span>
<a href="#l62.622"></a><span id="l62.622"> components/xpautocomplete.xpt</span>
<a href="#l62.623"></a><span id="l62.623"> components/xpcom_base.xpt</span>
<a href="#l62.624"></a><span id="l62.624"> components/xpcom_components.xpt</span>
<a href="#l62.625"></a><span id="l62.625"> components/xpcom_ds.xpt</span>
<a href="#l62.626"></a><span id="l62.626"> components/xpcom_io.xpt</span>
<a href="#l62.627"></a><span id="l62.627" class="difflineminus">-components/xpcom_obsolete.xpt</span>
<a href="#l62.628"></a><span id="l62.628"> components/xpcom_system.xpt</span>
<a href="#l62.629"></a><span id="l62.629"> components/xpcom_threads.xpt</span>
<a href="#l62.630"></a><span id="l62.630"> components/xpcom_xpti.xpt</span>
<a href="#l62.631"></a><span id="l62.631"> components/xpconnect.xpt</span>
<a href="#l62.632"></a><span id="l62.632"> components/xpinstall.xpt</span>
<a href="#l62.633"></a><span id="l62.633"> components/xulapp.xpt</span>
<a href="#l62.634"></a><span id="l62.634"> components/xuldoc.xpt</span>
<a href="#l62.635"></a><span id="l62.635"> components/xultmpl.xpt</span>
<a href="#l62.636"></a><span id="l62.636"> components/zipwriter.xpt</span>
<a href="#l62.637"></a><span id="l62.637"> #endif</span>
<a href="#l62.638"></a><span id="l62.638"> #endif</span>
<a href="#l62.639"></a><span id="l62.639"> #endif</span>
<a href="#l62.640"></a><span id="l62.640" class="difflineminus">-components/nsUnsetDefaultMail.js</span>
<a href="#l62.641"></a><span id="l62.641" class="difflineminus">-components/nsBackgroundUpdateService.js</span>
<a href="#l62.642"></a><span id="l62.642" class="difflineminus">-components/nsCloseAllWindows.js</span>
<a href="#l62.643"></a><span id="l62.643" class="difflineminus">-components/nsDownloadProgressListener.js</span>
<a href="#l62.644"></a><span id="l62.644" class="difflineminus">-components/nsLDAPPrefsService.js</span>
<a href="#l62.645"></a><span id="l62.645" class="difflineminus">-components/xptitemp.dat</span>
<a href="#l62.646"></a><span id="l62.646" class="difflineminus">-component.reg</span>
<a href="#l62.647"></a><span id="l62.647" class="difflineminus">-chrome/installed-chrome.txt</span>
<a href="#l62.648"></a><span id="l62.648" class="difflineminus">-chrome/chrome.rdf</span>
<a href="#l62.649"></a><span id="l62.649" class="difflineminus">-chrome/app-chrome.manifest</span>
<a href="#l62.650"></a><span id="l62.650" class="difflineminus">-chrome/mail.jar</span>
<a href="#l62.651"></a><span id="l62.651" class="difflineminus">-chrome/qute.jar</span>
<a href="#l62.652"></a><span id="l62.652" class="difflineminus">-chrome/offline.jar</span>
<a href="#l62.653"></a><span id="l62.653" class="difflineminus">-chrome/offline.manifest</span>
<a href="#l62.654"></a><span id="l62.654" class="difflineminus">-chrome/en-US-mail.jar</span>
<a href="#l62.655"></a><span id="l62.655" class="difflineminus">-chrome/overlayinfo/</span>
<a href="#l62.656"></a><span id="l62.656" class="difflineminus">-#ifdef MOZ_WIDGET_GTK2</span>
<a href="#l62.657"></a><span id="l62.657" class="difflineminus">-chrome/icons/default/abcardWindow.xpm</span>
<a href="#l62.658"></a><span id="l62.658" class="difflineminus">-chrome/icons/default/abcardWindow16.xpm</span>
<a href="#l62.659"></a><span id="l62.659" class="difflineminus">-chrome/icons/default/addressbookWindow.xpm</span>
<a href="#l62.660"></a><span id="l62.660" class="difflineminus">-chrome/icons/default/addressbookWindow16.xpm</span>
<a href="#l62.661"></a><span id="l62.661" class="difflineminus">-chrome/icons/default/msgcomposeWindow.xpm</span>
<a href="#l62.662"></a><span id="l62.662" class="difflineminus">-chrome/icons/default/msgcomposeWindow16.xpm</span>
<a href="#l62.663"></a><span id="l62.663" class="difflineminus">-chrome/icons/default/messengerWindow.xpm</span>
<a href="#l62.664"></a><span id="l62.664" class="difflineminus">-chrome/icons/default/messengerWindow16.xpm</span>
<a href="#l62.665"></a><span id="l62.665" class="difflineminus">-chrome/icons/default/default.xpm</span>
<a href="#l62.666"></a><span id="l62.666" class="difflineminus">-icons/mozicon128.png</span>
<a href="#l62.667"></a><span id="l62.667" class="difflineminus">-icons/mozicon16.xpm</span>
<a href="#l62.668"></a><span id="l62.668" class="difflineminus">-icons/mozicon50.xpm</span>
<a href="#l62.669"></a><span id="l62.669" class="difflineminus">-#endif</span>
<a href="#l62.670"></a><span id="l62.670" class="difflineminus">-defaults/pref/all.js</span>
<a href="#l62.671"></a><span id="l62.671" class="difflineminus">-defaults/pref/security-prefs.js</span>
<a href="#l62.672"></a><span id="l62.672" class="difflineminus">-defaults/pref/winpref.js</span>
<a href="#l62.673"></a><span id="l62.673" class="difflineminus">-defaults/pref/xpinstall.js</span>
<a href="#l62.674"></a><span id="l62.674" class="difflineminus">-defaults/pref/thunderbird.js</span>
<a href="#l62.675"></a><span id="l62.675" class="difflineminus">-defaults/profile/extensions/{972ce4c6-7e08-4474-a285-3208198ce6fd}/install.rdf</span>
<a href="#l62.676"></a><span id="l62.676" class="difflineminus">-defaults/profile/extensions/{972ce4c6-7e08-4474-a285-3208198ce6fd}/</span>
<a href="#l62.677"></a><span id="l62.677" class="difflineminus">-defaults/profile/extensions/Extensions.rdf</span>
<a href="#l62.678"></a><span id="l62.678" class="difflineminus">-defaults/profile/extensions/installed-extensions.txt</span>
<a href="#l62.679"></a><span id="l62.679" class="difflineminus">-defaults/profile/extensions/</span>
<a href="#l62.680"></a><span id="l62.680" class="difflineminus">-defaults/profile/US/localstore.rdf</span>
<a href="#l62.681"></a><span id="l62.681" class="difflineminus">-defaults/profile/US/mimeTypes.rdf</span>
<a href="#l62.682"></a><span id="l62.682" class="difflineminus">-defaults/profile/US/</span>
<a href="#l62.683"></a><span id="l62.683" class="difflineminus">-defaults/messenger/SpamAssassin.sfd</span>
<a href="#l62.684"></a><span id="l62.684" class="difflineminus">-defaults/messenger/SpamPal.sfd</span>
<a href="#l62.685"></a><span id="l62.685" class="difflineminus">-defaults/isp/rss.rdf</span>
<a href="#l62.686"></a><span id="l62.686" class="difflineminus">-defaults/isp/movemail.rdf</span>
<a href="#l62.687"></a><span id="l62.687" class="difflineminus">-defaults/isp/dotmac.rdf</span>
<a href="#l62.688"></a><span id="l62.688" class="difflineminus">-defaults/isp/en-US/rss.rdf</span>
<a href="#l62.689"></a><span id="l62.689" class="difflineminus">-defaults/isp/en-US/movemail.rdf</span>
<a href="#l62.690"></a><span id="l62.690" class="difflineminus">-defaults/isp/en-US/dotmac.rdf</span>
<a href="#l62.691"></a><span id="l62.691" class="difflineminus">-defaults/isp/en-US/</span>
<a href="#l62.692"></a><span id="l62.692" class="difflineminus">-defaults/isp/</span>
<a href="#l62.693"></a><span id="l62.693" class="difflineminus">-defaults/wallet/VcardSchema.tbl</span>
<a href="#l62.694"></a><span id="l62.694" class="difflineminus">-defaults/wallet/FieldSchema.tbl</span>
<a href="#l62.695"></a><span id="l62.695" class="difflineminus">-defaults/wallet/SchemaConcat.tbl</span>
<a href="#l62.696"></a><span id="l62.696" class="difflineminus">-defaults/wallet/DistinguishedSchema.tbl</span>
<a href="#l62.697"></a><span id="l62.697" class="difflineminus">-defaults/wallet/SchemaStrings.tbl</span>
<a href="#l62.698"></a><span id="l62.698" class="difflineminus">-defaults/wallet/PositionalSchema.tbl</span>
<a href="#l62.699"></a><span id="l62.699" class="difflineminus">-defaults/wallet/StateSchema.tbl</span>
<a href="#l62.700"></a><span id="l62.700" class="difflineminus">-isp/gmail.rdf</span>
<a href="#l62.701"></a><span id="l62.701" class="difflineminus">-</span>
<a href="#l62.702"></a><span id="l62.702" class="difflineminus">-components/@DLL_PREFIX@xpcom_compat_c@DLL_SUFFIX@</span>
<a href="#l62.703"></a><span id="l62.703" class="difflineminus">-@DLL_PREFIX@xpcom_compat@DLL_SUFFIX@</span>
<a href="#l62.704"></a><span id="l62.704" class="difflineminus">-@DLL_PREFIX@zlib@DLL_SUFFIX@</span>
<a href="#l62.705"></a><span id="l62.705" class="difflineminus">-@DLL_PREFIX@xpistub@DLL_SUFFIX@</span>
<a href="#l62.706"></a><span id="l62.706" class="difflineminus">-#Remove Talkback files from old location (in case user updates from 1.0.x)</span>
<a href="#l62.707"></a><span id="l62.707" class="difflineminus">-components/BrandRes.dll</span>
<a href="#l62.708"></a><span id="l62.708" class="difflineminus">-components/fullsoft.dll</span>
<a href="#l62.709"></a><span id="l62.709" class="difflineminus">-components/master.ini</span>
<a href="#l62.710"></a><span id="l62.710" class="difflineminus">-components/qfaservices.dll</span>
<a href="#l62.711"></a><span id="l62.711" class="difflineminus">-components/qfaservices.xpt</span>
<a href="#l62.712"></a><span id="l62.712" class="difflineminus">-components/talkback-l10n.ini</span>
<a href="#l62.713"></a><span id="l62.713" class="difflineminus">-components/talkback.cnt</span>
<a href="#l62.714"></a><span id="l62.714" class="difflineminus">-components/talkback.exe</span>
<a href="#l62.715"></a><span id="l62.715" class="difflineminus">-components/talkback.hlp</span>
<a href="#l62.716"></a><span id="l62.716" class="difflineminus">-components/libqfaservices.so</span>
<a href="#l62.717"></a><span id="l62.717" class="difflineminus">-components/talkback/master.ini</span>
<a href="#l62.718"></a><span id="l62.718" class="difflineminus">-components/talkback/talkback</span>
<a href="#l62.719"></a><span id="l62.719" class="difflineminus">-components/talkback/talkback.so</span>
<a href="#l62.720"></a><span id="l62.720" class="difflineminus">-components/talkback/XTalkback.ad</span>
<a href="#l62.721"></a><span id="l62.721" class="difflineminus">-HSAPI.dll</span>
<a href="#l62.722"></a><span id="l62.722" class="difflineminus">-CondMgr.dll</span>
<a href="#l62.723"></a><span id="l62.723" class="difflineminus">-mozABConduit.dll</span>
<a href="#l62.724"></a><span id="l62.724" class="difflineminus">-components/palmsync.dll</span>
<a href="#l62.725"></a><span id="l62.725" class="difflineminus">-components/palmSync.xpt</span>
<a href="#l62.726"></a><span id="l62.726" class="difflineminus">-uninstall/UninstallThunderbird.exe</span>
<a href="#l62.727"></a><span id="l62.727" class="difflineminus">-uninstall/uninst.exe</span>
<a href="#l62.728"></a><span id="l62.728" class="difflineminus">-uninstall/uninstall.exe</span>
<a href="#l62.729"></a><span id="l62.729" class="difflineminus">-components/myspell/en-US.dic</span>
<a href="#l62.730"></a><span id="l62.730" class="difflineminus">-components/myspell/en-US.aff</span>
<a href="#l62.731"></a><span id="l62.731" class="difflineminus">-regxpcom.exe</span>
<a href="#l62.732"></a><span id="l62.732" class="difflineminus">-components/xmlextras.xpt</span>
<a href="#l62.733"></a><span id="l62.733" class="difflineminus">-res/cmessage.txt</span>
<a href="#l62.734"></a><span id="l62.734" class="difflineminus">-#ifndef MOZILLA_1_9_1_BRANCH</span>
<a href="#l62.735"></a><span id="l62.735" class="difflineminus">-res/broken-image.gif</span>
<a href="#l62.736"></a><span id="l62.736" class="difflineminus">-res/loading-image.gif</span>
<a href="#l62.737"></a><span id="l62.737" class="difflineminus">-#endif</span>
<a href="#l62.738"></a><span id="l62.738" class="difflineminus">-res/html/gopher-audio.gif</span>
<a href="#l62.739"></a><span id="l62.739" class="difflineminus">-res/html/gopher-binary.gif</span>
<a href="#l62.740"></a><span id="l62.740" class="difflineminus">-res/html/gopher-find.gif</span>
<a href="#l62.741"></a><span id="l62.741" class="difflineminus">-res/html/gopher-image.gif</span>
<a href="#l62.742"></a><span id="l62.742" class="difflineminus">-res/html/gopher-menu.gif</span>
<a href="#l62.743"></a><span id="l62.743" class="difflineminus">-res/html/gopher-movie.gif</span>
<a href="#l62.744"></a><span id="l62.744" class="difflineminus">-res/html/gopher-sound.gif</span>
<a href="#l62.745"></a><span id="l62.745" class="difflineminus">-res/html/gopher-telnet.gif</span>
<a href="#l62.746"></a><span id="l62.746" class="difflineminus">-res/html/gopher-text.gif</span>
<a href="#l62.747"></a><span id="l62.747" class="difflineminus">-res/html/gopher-unknown.gif</span>
<a href="#l62.748"></a><span id="l62.748" class="difflineminus">-extensions/talkback@mozilla.org/</span>
<a href="#l62.749"></a><span id="l62.749" class="difflineminus">-extensions/talkback@mozilla.org/install.rdf</span>
<a href="#l62.750"></a><span id="l62.750" class="difflineminus">-extensions/talkback@mozilla.org/chrome.manifest</span>
<a href="#l62.751"></a><span id="l62.751" class="difflineminus">-extensions/talkback@mozilla.org/components/qfaservices.xpt</span>
<a href="#l62.752"></a><span id="l62.752" class="difflineminus">-extensions/talkback@mozilla.org/components/@DLL_PREFIX@qfaservices@DLL_SUFFIX@</span>
<a href="#l62.753"></a><span id="l62.753" class="difflineminus">-#ifdef XP_WIN</span>
<a href="#l62.754"></a><span id="l62.754" class="difflineminus">-extensions/talkback@mozilla.org/components/BrandRes.dll</span>
<a href="#l62.755"></a><span id="l62.755" class="difflineminus">-extensions/talkback@mozilla.org/components/fullsoft.dll</span>
<a href="#l62.756"></a><span id="l62.756" class="difflineminus">-extensions/talkback@mozilla.org/components/master.ini</span>
<a href="#l62.757"></a><span id="l62.757" class="difflineminus">-extensions/talkback@mozilla.org/components/talkback-l10n.ini</span>
<a href="#l62.758"></a><span id="l62.758" class="difflineminus">-extensions/talkback@mozilla.org/components/talkback.cnt</span>
<a href="#l62.759"></a><span id="l62.759" class="difflineminus">-extensions/talkback@mozilla.org/components/talkback.exe</span>
<a href="#l62.760"></a><span id="l62.760" class="difflineminus">-extensions/talkback@mozilla.org/components/talkback.hlp</span>
<a href="#l62.761"></a><span id="l62.761" class="difflineminus">-extensions/talkback@mozilla.org/InstallDisabled</span>
<a href="#l62.762"></a><span id="l62.762" class="difflineminus">-#else</span>
<a href="#l62.763"></a><span id="l62.763" class="difflineminus">-#ifdef XP_MACOSX</span>
<a href="#l62.764"></a><span id="l62.764" class="difflineminus">-extensions/talkback@mozilla.org/components/talkback/master.ini</span>
<a href="#l62.765"></a><span id="l62.765" class="difflineminus">-extensions/talkback@mozilla.org/components/talkback/talkback@DLL_SUFFIX@</span>
<a href="#l62.766"></a><span id="l62.766" class="difflineminus">-extensions/talkback@mozilla.org/components/talkback/Talkback.app/Contents/Info.plist</span>
<a href="#l62.767"></a><span id="l62.767" class="difflineminus">-extensions/talkback@mozilla.org/components/talkback/Talkback.app/Contents/MacOS/Talkback</span>
<a href="#l62.768"></a><span id="l62.768" class="difflineminus">-extensions/talkback@mozilla.org/components/talkback/Talkback.app/Contents/pbdevelopment.plist</span>
<a href="#l62.769"></a><span id="l62.769" class="difflineminus">-extensions/talkback@mozilla.org/components/talkback/Talkback.app/Contents/PkgInfo</span>
<a href="#l62.770"></a><span id="l62.770" class="difflineminus">-extensions/talkback@mozilla.org/components/talkback/Talkback.app/Contents/Resources/delete.tiff</span>
<a href="#l62.771"></a><span id="l62.771" class="difflineminus">-extensions/talkback@mozilla.org/components/talkback/Talkback.app/Contents/Resources/disable.tiff</span>
<a href="#l62.772"></a><span id="l62.772" class="difflineminus">-extensions/talkback@mozilla.org/components/talkback/Talkback.app/Contents/Resources/enable.tiff</span>
<a href="#l62.773"></a><span id="l62.773" class="difflineminus">-extensions/talkback@mozilla.org/components/talkback/Talkback.app/Contents/Resources/English.lproj/ArchivingSettings.nib/classes.nib</span>
<a href="#l62.774"></a><span id="l62.774" class="difflineminus">-extensions/talkback@mozilla.org/components/talkback/Talkback.app/Contents/Resources/English.lproj/ArchivingSettings.nib/info.nib</span>
<a href="#l62.775"></a><span id="l62.775" class="difflineminus">-extensions/talkback@mozilla.org/components/talkback/Talkback.app/Contents/Resources/English.lproj/ArchivingSettings.nib/objects.nib</span>
<a href="#l62.776"></a><span id="l62.776" class="difflineminus">-extensions/talkback@mozilla.org/components/talkback/Talkback.app/Contents/Resources/English.lproj/InfoPlist.strings</span>
<a href="#l62.777"></a><span id="l62.777" class="difflineminus">-extensions/talkback@mozilla.org/components/talkback/Talkback.app/Contents/Resources/English.lproj/IntroWizard.nib/classes.nib</span>
<a href="#l62.778"></a><span id="l62.778" class="difflineminus">-extensions/talkback@mozilla.org/components/talkback/Talkback.app/Contents/Resources/English.lproj/IntroWizard.nib/info.nib</span>
<a href="#l62.779"></a><span id="l62.779" class="difflineminus">-extensions/talkback@mozilla.org/components/talkback/Talkback.app/Contents/Resources/English.lproj/IntroWizard.nib/objects.nib</span>
<a href="#l62.780"></a><span id="l62.780" class="difflineminus">-extensions/talkback@mozilla.org/components/talkback/Talkback.app/Contents/Resources/English.lproj/Localizable.strings</span>
<a href="#l62.781"></a><span id="l62.781" class="difflineminus">-extensions/talkback@mozilla.org/components/talkback/Talkback.app/Contents/Resources/English.lproj/MainMenu.nib/classes.nib</span>
<a href="#l62.782"></a><span id="l62.782" class="difflineminus">-extensions/talkback@mozilla.org/components/talkback/Talkback.app/Contents/Resources/English.lproj/MainMenu.nib/info.nib</span>
<a href="#l62.783"></a><span id="l62.783" class="difflineminus">-extensions/talkback@mozilla.org/components/talkback/Talkback.app/Contents/Resources/English.lproj/MainMenu.nib/objects.nib</span>
<a href="#l62.784"></a><span id="l62.784" class="difflineminus">-extensions/talkback@mozilla.org/components/talkback/Talkback.app/Contents/Resources/English.lproj/ProxySettings.nib/classes.nib</span>
<a href="#l62.785"></a><span id="l62.785" class="difflineminus">-extensions/talkback@mozilla.org/components/talkback/Talkback.app/Contents/Resources/English.lproj/ProxySettings.nib/info.nib</span>
<a href="#l62.786"></a><span id="l62.786" class="difflineminus">-extensions/talkback@mozilla.org/components/talkback/Talkback.app/Contents/Resources/English.lproj/ProxySettings.nib/objects.nib</span>
<a href="#l62.787"></a><span id="l62.787" class="difflineminus">-extensions/talkback@mozilla.org/components/talkback/Talkback.app/Contents/Resources/English.lproj/SendingSettings.nib/classes.nib</span>
<a href="#l62.788"></a><span id="l62.788" class="difflineminus">-extensions/talkback@mozilla.org/components/talkback/Talkback.app/Contents/Resources/English.lproj/SendingSettings.nib/info.nib</span>
<a href="#l62.789"></a><span id="l62.789" class="difflineminus">-extensions/talkback@mozilla.org/components/talkback/Talkback.app/Contents/Resources/English.lproj/SendingSettings.nib/objects.nib</span>
<a href="#l62.790"></a><span id="l62.790" class="difflineminus">-extensions/talkback@mozilla.org/components/talkback/Talkback.app/Contents/Resources/KeyInfoKeys.plist</span>
<a href="#l62.791"></a><span id="l62.791" class="difflineminus">-extensions/talkback@mozilla.org/components/talkback/Talkback.app/Contents/Resources/KeyInfoSections.plist</span>
<a href="#l62.792"></a><span id="l62.792" class="difflineminus">-extensions/talkback@mozilla.org/components/talkback/Talkback.app/Contents/Resources/send.tiff</span>
<a href="#l62.793"></a><span id="l62.793" class="difflineminus">-extensions/talkback@mozilla.org/components/talkback/Talkback.app/Contents/Resources/sort_ascending.tiff</span>
<a href="#l62.794"></a><span id="l62.794" class="difflineminus">-extensions/talkback@mozilla.org/components/talkback/Talkback.app/Contents/Resources/sort_descending.tiff</span>
<a href="#l62.795"></a><span id="l62.795" class="difflineminus">-extensions/talkback@mozilla.org/components/talkback/Talkback.app/Contents/Resources/Talkback.icns</span>
<a href="#l62.796"></a><span id="l62.796" class="difflineminus">-updater.app/Contents/MacOS/updater.ini</span>
<a href="#l62.797"></a><span id="l62.797" class="difflineminus">-#else</span>
<a href="#l62.798"></a><span id="l62.798" class="difflineminus">-extensions/talkback@mozilla.org/components/talkback/talkback</span>
<a href="#l62.799"></a><span id="l62.799" class="difflineminus">-extensions/talkback@mozilla.org/components/talkback/XTalkback.ad</span>
<a href="#l62.800"></a><span id="l62.800" class="difflineminus">-extensions/talkback@mozilla.org/components/master.ini</span>
<a href="#l62.801"></a><span id="l62.801" class="difflineminus">-extensions/talkback@mozilla.org/components/talkback.so</span>
<a href="#l62.802"></a><span id="l62.802" class="difflineminus">-#endif</span>
<a href="#l62.803"></a><span id="l62.803" class="difflineminus">-#endif</span>
<a href="#l62.804"></a><span id="l62.804" class="difflineminus">-components/airbag.xpt</span>
<a href="#l62.805"></a><span id="l62.805" class="difflineminus">-components/nsUrlClassifierTable.js</span>
<a href="#l62.806"></a><span id="l62.806" class="difflineminus">-components/nsScriptableIO.js</span>
<a href="#l62.807"></a><span id="l62.807" class="difflineminus">-#ifdef XP_WIN</span>
<a href="#l62.808"></a><span id="l62.808" class="difflineminus">-#ifdef MOZ_MEMORY</span>
<a href="#l62.809"></a><span id="l62.809" class="difflineminus">-Microsoft.VC80.CRT.manifest</span>
<a href="#l62.810"></a><span id="l62.810" class="difflineminus">-msvcm80.dll</span>
<a href="#l62.811"></a><span id="l62.811" class="difflineminus">-msvcp80.dll</span>
<a href="#l62.812"></a><span id="l62.812" class="difflineminus">-msvcr80.dll</span>
<a href="#l62.813"></a><span id="l62.813" class="difflineminus">-#else</span>
<a href="#l62.814"></a><span id="l62.814" class="difflineminus">-mozcrt19.dll</span>
<a href="#l62.815"></a><span id="l62.815" class="difflineminus">-#endif</span>
<a href="#l62.816"></a><span id="l62.816" class="difflineminus">-#endif</span>
<a href="#l62.817"></a><span id="l62.817" class="difflineminus">-#ifdef XP_WIN</span>
<a href="#l62.818"></a><span id="l62.818" class="difflineminus">-xpicleanup.exe</span>
<a href="#l62.819"></a><span id="l62.819" class="difflineminus">-#else</span>
<a href="#l62.820"></a><span id="l62.820" class="difflineminus">-xpicleanup</span>
<a href="#l62.821"></a><span id="l62.821" class="difflineminus">-#endif</span>
<a href="#l62.822"></a><span id="l62.822" class="difflineminus">-#ifdef XP_WIN</span>
<a href="#l62.823"></a><span id="l62.823" class="difflineminus">-components/nsWinSearchIntegration.js</span>
<a href="#l62.824"></a><span id="l62.824" class="difflineminus">-#else</span>
<a href="#l62.825"></a><span id="l62.825" class="difflineminus">-#ifdef XP_MACOSX</span>
<a href="#l62.826"></a><span id="l62.826" class="difflineminus">-components/nsSpotlightIntegration.js</span>
<a href="#l62.827"></a><span id="l62.827" class="difflineminus">-#endif</span>
<a href="#l62.828"></a><span id="l62.828" class="difflineminus">-#endif</span>
<a href="#l62.829"></a><span id="l62.829" class="difflineplus">+# ****************************************************************************</span>
<a href="#l62.830"></a><span id="l62.830" class="difflineplus">+# * End of XPTs at the time we started linking them on Linux.                *</span>
<a href="#l62.831"></a><span id="l62.831" class="difflineplus">+# ****************************************************************************</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l63.1"></a><span id="l63.1" class="difflineminus">--- a/mail/installer/windows/packages-static</span>
<a href="#l63.2"></a><span id="l63.2" class="difflineplus">+++ b/mail/installer/windows/packages-static</span>
<a href="#l63.3"></a><span id="l63.3" class="difflineat">@@ -63,16 +63,17 @@ bin\defaults\profile\prefs.js</span>
<a href="#l63.4"></a><span id="l63.4"> bin\defaults\profile\mimeTypes.rdf</span>
<a href="#l63.5"></a><span id="l63.5"> </span>
<a href="#l63.6"></a><span id="l63.6"> bin\isp\*</span>
<a href="#l63.7"></a><span id="l63.7"> </span>
<a href="#l63.8"></a><span id="l63.8"> bin\components\aboutRights.js</span>
<a href="#l63.9"></a><span id="l63.9"> bin\components\activity.xpt</span>
<a href="#l63.10"></a><span id="l63.10"> bin\components\addrbook.xpt</span>
<a href="#l63.11"></a><span id="l63.11"> bin\components\mime.xpt</span>
<a href="#l63.12"></a><span id="l63.12" class="difflineplus">+bin\components\steel.xpt</span>
<a href="#l63.13"></a><span id="l63.13"> bin\components\msgbase.xpt</span>
<a href="#l63.14"></a><span id="l63.14"> bin\components\msgcompo.xpt</span>
<a href="#l63.15"></a><span id="l63.15"> bin\components\msgdb.xpt</span>
<a href="#l63.16"></a><span id="l63.16"> bin\components\msgimap.xpt</span>
<a href="#l63.17"></a><span id="l63.17"> bin\components\msglocal.xpt</span>
<a href="#l63.18"></a><span id="l63.18"> bin\components\msgnews.xpt</span>
<a href="#l63.19"></a><span id="l63.19"> bin\components\msgsearch.xpt</span>
<a href="#l63.20"></a><span id="l63.20"> bin\components\import.xpt</span>
<a href="#l63.21"></a><span id="l63.21" class="difflineat">@@ -114,16 +115,17 @@ bin\components\jsmimeemitter.js</span>
<a href="#l63.22"></a><span id="l63.22"> ; Mail Extensions (smime, etc.)</span>
<a href="#l63.23"></a><span id="l63.23"> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>
<a href="#l63.24"></a><span id="l63.24"> bin\MapiProxy.dll</span>
<a href="#l63.25"></a><span id="l63.25"> bin\mozMapi32.dll</span>
<a href="#l63.26"></a><span id="l63.26"> bin\components\mapihook.xpt</span>
<a href="#l63.27"></a><span id="l63.27"> bin\components\nsSetDefaultMail.js</span>
<a href="#l63.28"></a><span id="l63.28"> bin\components\offlineStartup.js</span>
<a href="#l63.29"></a><span id="l63.29"> bin\components\nsMailDefaultHandler.js</span>
<a href="#l63.30"></a><span id="l63.30" class="difflineplus">+bin\components\steelApplication.js</span>
<a href="#l63.31"></a><span id="l63.31"> </span>
<a href="#l63.32"></a><span id="l63.32"> </span>
<a href="#l63.33"></a><span id="l63.33"> bin\components\mdn-service.js</span>
<a href="#l63.34"></a><span id="l63.34"> </span>
<a href="#l63.35"></a><span id="l63.35"> bin\components\smime-service.js</span>
<a href="#l63.36"></a><span id="l63.36"> bin\components\msgsmime.xpt</span>
<a href="#l63.37"></a><span id="l63.37"> </span>
<a href="#l63.38"></a><span id="l63.38"> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l64.1"></a><span id="l64.1" class="difflineminus">--- a/mail/locales/en-US/chrome/messenger/aboutRights.dtd</span>
<a href="#l64.2"></a><span id="l64.2" class="difflineplus">+++ b/mail/locales/en-US/chrome/messenger/aboutRights.dtd</span>
<a href="#l64.3"></a><span id="l64.3" class="difflineat">@@ -1,12 +1,12 @@</span>
<a href="#l64.4"></a><span id="l64.4"> &lt;!-- rights.locale-direction instead of the usual local.dir entity, so RTL can skip translating page. --&gt;</span>
<a href="#l64.5"></a><span id="l64.5"> &lt;!ENTITY rights.locale-direction &quot;ltr&quot;&gt;</span>
<a href="#l64.6"></a><span id="l64.6" class="difflineminus">-&lt;!ENTITY rights.pagetitle       &quot;about:rights&quot;&gt;</span>
<a href="#l64.7"></a><span id="l64.7" class="difflineminus">-&lt;!ENTITY rights.intro-header    &quot;About Your Rights&quot;&gt;</span>
<a href="#l64.8"></a><span id="l64.8" class="difflineplus">+&lt;!ENTITY rights.title            &quot;About Your Rights&quot;&gt;</span>
<a href="#l64.9"></a><span id="l64.9" class="difflineplus">+&lt;!ENTITY rights.intro-header     &quot;About Your Rights&quot;&gt;</span>
<a href="#l64.10"></a><span id="l64.10"> &lt;!ENTITY rights.intro &quot;&amp;brandFullName; is free and open source software, built by a community of thousands from all over the world. There are a few things you should know:&quot;&gt;</span>
<a href="#l64.11"></a><span id="l64.11"> </span>
<a href="#l64.12"></a><span id="l64.12"> &lt;!-- Note on pointa / pointb / pointc form:</span>
<a href="#l64.13"></a><span id="l64.13">      These points each have an embedded link in the HTML, so each point is</span>
<a href="#l64.14"></a><span id="l64.14">      split into chunks for text before the link, the link text, and the text</span>
<a href="#l64.15"></a><span id="l64.15">      after the link. If a localized grammar doesn't need the before or after</span>
<a href="#l64.16"></a><span id="l64.16">      chunk, it can be left blank.</span>
<a href="#l64.17"></a><span id="l64.17"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l65.1"></a><span id="l65.1" class="difflineminus">--- a/mail/locales/en-US/chrome/messenger/am-offline.dtd</span>
<a href="#l65.2"></a><span id="l65.2" class="difflineplus">+++ b/mail/locales/en-US/chrome/messenger/am-offline.dtd</span>
<a href="#l65.3"></a><span id="l65.3" class="difflineat">@@ -13,22 +13,22 @@</span>
<a href="#l65.4"></a><span id="l65.4"> &lt;!ENTITY nntpDownloadMsg.accesskey &quot;e&quot;&gt;</span>
<a href="#l65.5"></a><span id="l65.5"> &lt;!ENTITY retentionCleanup.label &quot;To recover disk space, old messages can be permanently deleted.&quot;&gt;</span>
<a href="#l65.6"></a><span id="l65.6"> &lt;!ENTITY retentionCleanupImap.label &quot;To recover disk space, old messages can be permanently deleted, both local copies and originals on the remote server.&quot;&gt;</span>
<a href="#l65.7"></a><span id="l65.7"> &lt;!ENTITY retentionCleanupPop.label &quot;To recover disk space, old messages can be permanently deleted, including originals on the remote server.&quot;&gt;</span>
<a href="#l65.8"></a><span id="l65.8"> &lt;!ENTITY retentionKeepMsg.label &quot;Delete messages more than&quot;&gt;</span>
<a href="#l65.9"></a><span id="l65.9"> &lt;!ENTITY retentionKeepMsg.accesskey &quot;t&quot;&gt;</span>
<a href="#l65.10"></a><span id="l65.10"> &lt;!ENTITY retentionKeepAll.label &quot;Don't delete any messages&quot;&gt;</span>
<a href="#l65.11"></a><span id="l65.11"> &lt;!ENTITY retentionKeepAll.accesskey &quot;n&quot;&gt;</span>
<a href="#l65.12"></a><span id="l65.12" class="difflineminus">-&lt;!ENTITY retentionKeepNew.label &quot;Delete all but the last&quot;&gt;</span>
<a href="#l65.13"></a><span id="l65.13" class="difflineminus">-&lt;!ENTITY retentionKeepNew.accesskey &quot;b&quot;&gt;</span>
<a href="#l65.14"></a><span id="l65.14" class="difflineminus">-&lt;!ENTITY retentionKeepUnread.label &quot;Always delete read messages&quot;&gt;</span>
<a href="#l65.15"></a><span id="l65.15" class="difflineminus">-&lt;!ENTITY retentionKeepUnread.accesskey &quot;w&quot;&gt;</span>
<a href="#l65.16"></a><span id="l65.16" class="difflineplus">+&lt;!ENTITY retentionKeepRecent.label &quot;Delete all but the most recent&quot;&gt;</span>
<a href="#l65.17"></a><span id="l65.17" class="difflineplus">+&lt;!ENTITY retentionKeepRecent.accesskey &quot;b&quot;&gt;</span>
<a href="#l65.18"></a><span id="l65.18" class="difflineplus">+&lt;!-- LOCALIZATION NOTE: Unhide with .keepUnreadOnly { display: -moz-box; } --&gt;</span>
<a href="#l65.19"></a><span id="l65.19" class="difflineplus">+&lt;!ENTITY retentionKeepUnreadHidden.label &quot;Always delete read messages (overrides age settings)&quot;&gt;</span>
<a href="#l65.20"></a><span id="l65.20"> &lt;!ENTITY retentionApplyToFlagged.label &quot;Always keep starred messages&quot;&gt;</span>
<a href="#l65.21"></a><span id="l65.21"> &lt;!ENTITY retentionApplyToFlagged.accesskey &quot;k&quot;&gt;</span>
<a href="#l65.22"></a><span id="l65.22" class="difflineminus">-&lt;!ENTITY nntpRemoveBody.label &quot;Only message bodies less than&quot;&gt;</span>
<a href="#l65.23"></a><span id="l65.23" class="difflineminus">-&lt;!ENTITY nntpRemoveBody.accesskey &quot;O&quot;&gt;</span>
<a href="#l65.24"></a><span id="l65.24" class="difflineplus">+&lt;!ENTITY nntpRemoveMsgBody.label &quot;Remove bodies from messages more than&quot;&gt;</span>
<a href="#l65.25"></a><span id="l65.25" class="difflineplus">+&lt;!ENTITY nntpRemoveMsgBody.accesskey &quot;o&quot;&gt;</span>
<a href="#l65.26"></a><span id="l65.26"> &lt;!ENTITY offlineSelectNntp.label &quot;Select newsgroups for offline useâ¦&quot;&gt;</span>
<a href="#l65.27"></a><span id="l65.27"> &lt;!ENTITY offlineSelectNntp.accesskey &quot;S&quot;&gt;</span>
<a href="#l65.28"></a><span id="l65.28"> &lt;!ENTITY offlineImapAdvancedOffline.label &quot;Advancedâ¦&quot;&gt;</span>
<a href="#l65.29"></a><span id="l65.29"> &lt;!ENTITY offlineImapAdvancedOffline.accesskey &quot;v&quot;&gt;</span>
<a href="#l65.30"></a><span id="l65.30"> &lt;!ENTITY syncGroupTitle.label &quot;Message Synchronizing&quot;&gt;</span>
<a href="#l65.31"></a><span id="l65.31"> &lt;!ENTITY diskspaceGroupTitle.label &quot;Disk Space&quot;&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l66.1"></a><span id="l66.1" class="difflineminus">--- a/mail/locales/en-US/chrome/messenger/folderProps.dtd</span>
<a href="#l66.2"></a><span id="l66.2" class="difflineplus">+++ b/mail/locales/en-US/chrome/messenger/folderProps.dtd</span>
<a href="#l66.3"></a><span id="l66.3" class="difflineat">@@ -56,20 +56,20 @@</span>
<a href="#l66.4"></a><span id="l66.4"> &lt;!ENTITY message.label &quot;messages&quot;&gt;</span>
<a href="#l66.5"></a><span id="l66.5"> &lt;!ENTITY retentionCleanup.label &quot;To recover disk space, old messages can be permanently deleted.&quot;&gt;</span>
<a href="#l66.6"></a><span id="l66.6"> &lt;!ENTITY retentionCleanupImap.label &quot;To recover disk space, old messages can be permanently deleted, both local copies and originals on the remote server.&quot;&gt;</span>
<a href="#l66.7"></a><span id="l66.7"> &lt;!ENTITY retentionCleanupPop.label &quot;To recover disk space, old messages can be permanently deleted, including originals on the remote server.&quot;&gt;</span>
<a href="#l66.8"></a><span id="l66.8"> &lt;!ENTITY retentionDeleteMsg.label &quot;Delete messages more than&quot;&gt;</span>
<a href="#l66.9"></a><span id="l66.9"> &lt;!ENTITY retentionDeleteMsg.accesskey &quot;m&quot;&gt;</span>
<a href="#l66.10"></a><span id="l66.10"> &lt;!ENTITY retentionKeepAll.label &quot;Don't delete any messages&quot;&gt;</span>
<a href="#l66.11"></a><span id="l66.11"> &lt;!ENTITY retentionKeepAll.accesskey &quot;A&quot;&gt;</span>
<a href="#l66.12"></a><span id="l66.12" class="difflineminus">-&lt;!ENTITY retentionKeepNew.label &quot;Delete all but the last&quot;&gt;</span>
<a href="#l66.13"></a><span id="l66.13" class="difflineminus">-&lt;!ENTITY retentionKeepNew.accesskey &quot;l&quot;&gt;</span>
<a href="#l66.14"></a><span id="l66.14" class="difflineminus">-&lt;!ENTITY retentionKeepUnread.label &quot;Always delete read messages&quot;&gt;</span>
<a href="#l66.15"></a><span id="l66.15" class="difflineminus">-&lt;!ENTITY retentionKeepUnread.accesskey &quot;r&quot;&gt;</span>
<a href="#l66.16"></a><span id="l66.16" class="difflineplus">+&lt;!ENTITY retentionKeepRecent.label &quot;Delete all but the most recent&quot;&gt;</span>
<a href="#l66.17"></a><span id="l66.17" class="difflineplus">+&lt;!ENTITY retentionKeepRecent.accesskey &quot;l&quot;&gt;</span>
<a href="#l66.18"></a><span id="l66.18" class="difflineplus">+&lt;!-- LOCALIZATION NOTE: Unhide with .keepUnreadOnly { display: -moz-box; } --&gt;</span>
<a href="#l66.19"></a><span id="l66.19" class="difflineplus">+&lt;!ENTITY retentionKeepUnreadHidden.label &quot;Always delete read messages (overrides age settings)&quot;&gt;</span>
<a href="#l66.20"></a><span id="l66.20"> &lt;!ENTITY retentionApplyToFlagged.label &quot;Always keep starred messages&quot;&gt;</span>
<a href="#l66.21"></a><span id="l66.21"> &lt;!ENTITY retentionApplyToFlagged.accesskey &quot;e&quot;&gt;</span>
<a href="#l66.22"></a><span id="l66.22"> </span>
<a href="#l66.23"></a><span id="l66.23"> &lt;!ENTITY folderSynchronizationTab.label          &quot;Synchronization&quot;&gt;</span>
<a href="#l66.24"></a><span id="l66.24"> &lt;!ENTITY folderCheckForNewMessages.label         &quot;Check this folder for new messages&quot;&gt;</span>
<a href="#l66.25"></a><span id="l66.25"> &lt;!ENTITY folderCheckForNewMessages.accesskey     &quot;C&quot;&gt;</span>
<a href="#l66.26"></a><span id="l66.26"> </span>
<a href="#l66.27"></a><span id="l66.27"> &lt;!ENTITY offlineFolder.check.label               &quot;Select this folder for offline use&quot;&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l67.1"></a><span id="l67.1" class="difflineminus">--- a/mail/locales/en-US/chrome/messenger/messengercompose/composeMsgs.properties</span>
<a href="#l67.2"></a><span id="l67.2" class="difflineplus">+++ b/mail/locales/en-US/chrome/messenger/messengercompose/composeMsgs.properties</span>
<a href="#l67.3"></a><span id="l67.3" class="difflineat">@@ -328,14 +328,14 @@ mailnews.reply_header_originalmessage=--</span>
<a href="#l67.4"></a><span id="l67.4"> </span>
<a href="#l67.5"></a><span id="l67.5"> ## Strings used by the rename attachment dialog</span>
<a href="#l67.6"></a><span id="l67.6"> renameAttachmentTitle=Rename Attachment</span>
<a href="#l67.7"></a><span id="l67.7"> renameAttachmentMessage=New attachment name:</span>
<a href="#l67.8"></a><span id="l67.8"> </span>
<a href="#l67.9"></a><span id="l67.9"> ## Attachment Reminder</span>
<a href="#l67.10"></a><span id="l67.10"> ## LOCALIZATION NOTE (mail.compose.attachment_reminder_keywords): comma separated</span>
<a href="#l67.11"></a><span id="l67.11"> ##   words that that should trigger an attachment reminder.</span>
<a href="#l67.12"></a><span id="l67.12" class="difflineminus">-mail.compose.attachment_reminder_keywords=attachment,attached,.doc,.pdf,resume,cover letter</span>
<a href="#l67.13"></a><span id="l67.13" class="difflineplus">+mail.compose.attachment_reminder_keywords=.doc,.pdf,attachment,attach,attached,attaching,enclosed,CV,cover letter</span>
<a href="#l67.14"></a><span id="l67.14"> attachmentReminderTitle=Attachment Reminder</span>
<a href="#l67.15"></a><span id="l67.15"> attachmentReminderMsg=Did you forget to add an attachment?</span>
<a href="#l67.16"></a><span id="l67.16"> attachmentReminderYesIForgot=Oh, I did!</span>
<a href="#l67.17"></a><span id="l67.17"> attachmentReminderFalseAlarm=No, Send Now</span>
<a href="#l67.18"></a><span id="l67.18"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l68.1"></a><span id="l68.1" class="difflineminus">--- a/mail/locales/en-US/chrome/messenger/msgHdrViewOverlay.dtd</span>
<a href="#l68.2"></a><span id="l68.2" class="difflineplus">+++ b/mail/locales/en-US/chrome/messenger/msgHdrViewOverlay.dtd</span>
<a href="#l68.3"></a><span id="l68.3" class="difflineat">@@ -66,19 +66,16 @@</span>
<a href="#l68.4"></a><span id="l68.4"> &lt;!ENTITY trashButton.tooltiptext &quot;delete&quot;&gt;</span>
<a href="#l68.5"></a><span id="l68.5"> </span>
<a href="#l68.6"></a><span id="l68.6"> &lt;!ENTITY otherActionsButton.label &quot;other actions&quot;&gt;</span>
<a href="#l68.7"></a><span id="l68.7"> &lt;!ENTITY saveAsMenuItem.label &quot;save asâ¦&quot;&gt;</span>
<a href="#l68.8"></a><span id="l68.8"> &lt;!ENTITY saveAsMenuItem.accesskey &quot;S&quot;&gt;</span>
<a href="#l68.9"></a><span id="l68.9"> &lt;!ENTITY viewSourceMenuItem.label &quot;view sourceâ¦&quot;&gt;</span>
<a href="#l68.10"></a><span id="l68.10"> &lt;!ENTITY viewSourceMenuItem.accesskey &quot;V&quot;&gt;</span>
<a href="#l68.11"></a><span id="l68.11"> </span>
<a href="#l68.12"></a><span id="l68.12" class="difflineminus">-&lt;!ENTITY hideDetailsButton.label &quot;hide details&quot;&gt;</span>
<a href="#l68.13"></a><span id="l68.13" class="difflineminus">-&lt;!ENTITY showDetailsButton.label &quot;show details&quot;&gt;</span>
<a href="#l68.14"></a><span id="l68.14" class="difflineminus">-</span>
<a href="#l68.15"></a><span id="l68.15"> &lt;!ENTITY openAttachmentCmd.label    &quot;Open&quot;&gt;</span>
<a href="#l68.16"></a><span id="l68.16"> &lt;!ENTITY openAttachmentCmd.accesskey    &quot;O&quot;&gt;</span>
<a href="#l68.17"></a><span id="l68.17"> &lt;!ENTITY saveAsAttachmentCmd.label    &quot;Save Asâ¦&quot;&gt;</span>
<a href="#l68.18"></a><span id="l68.18"> &lt;!ENTITY saveAsAttachmentCmd.accesskey    &quot;A&quot;&gt;</span>
<a href="#l68.19"></a><span id="l68.19"> &lt;!ENTITY detachAttachmentCmd.label    &quot;Detachâ¦&quot;&gt;</span>
<a href="#l68.20"></a><span id="l68.20"> &lt;!ENTITY deleteAttachmentCmd.label    &quot;Delete&quot;&gt;</span>
<a href="#l68.21"></a><span id="l68.21"> &lt;!ENTITY saveAllAttachmentsCmd.label    &quot;Save Allâ¦&quot;&gt;</span>
<a href="#l68.22"></a><span id="l68.22"> &lt;!ENTITY saveAllAttachmentsCmd.accesskey    &quot;S&quot;&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l69.1"></a><span id="l69.1">new file mode 100644</span>
<a href="#l69.2"></a><span id="l69.2" class="difflineminus">--- /dev/null</span>
<a href="#l69.3"></a><span id="l69.3" class="difflineplus">+++ b/mail/steel/Makefile.in</span>
<a href="#l69.4"></a><span id="l69.4" class="difflineat">@@ -0,0 +1,52 @@</span>
<a href="#l69.5"></a><span id="l69.5" class="difflineplus">+# ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l69.6"></a><span id="l69.6" class="difflineplus">+# Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l69.7"></a><span id="l69.7" class="difflineplus">+#</span>
<a href="#l69.8"></a><span id="l69.8" class="difflineplus">+# The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l69.9"></a><span id="l69.9" class="difflineplus">+# 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l69.10"></a><span id="l69.10" class="difflineplus">+# the License. You may obtain a copy of the License at</span>
<a href="#l69.11"></a><span id="l69.11" class="difflineplus">+# http://www.mozilla.org/MPL/</span>
<a href="#l69.12"></a><span id="l69.12" class="difflineplus">+#</span>
<a href="#l69.13"></a><span id="l69.13" class="difflineplus">+# Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l69.14"></a><span id="l69.14" class="difflineplus">+# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l69.15"></a><span id="l69.15" class="difflineplus">+# for the specific language governing rights and limitations under the</span>
<a href="#l69.16"></a><span id="l69.16" class="difflineplus">+# License.</span>
<a href="#l69.17"></a><span id="l69.17" class="difflineplus">+#</span>
<a href="#l69.18"></a><span id="l69.18" class="difflineplus">+# The Original Code is FUEL.</span>
<a href="#l69.19"></a><span id="l69.19" class="difflineplus">+#</span>
<a href="#l69.20"></a><span id="l69.20" class="difflineplus">+# The Initial Developer of the Original Code is Mozilla Corporation.</span>
<a href="#l69.21"></a><span id="l69.21" class="difflineplus">+# Portions created by the Initial Developer are Copyright (C) 2006</span>
<a href="#l69.22"></a><span id="l69.22" class="difflineplus">+# the Initial Developer. All Rights Reserved.</span>
<a href="#l69.23"></a><span id="l69.23" class="difflineplus">+#</span>
<a href="#l69.24"></a><span id="l69.24" class="difflineplus">+# Contributor(s):</span>
<a href="#l69.25"></a><span id="l69.25" class="difflineplus">+#   Mark Finkle &lt;mfinkle@mozilla.com&gt;</span>
<a href="#l69.26"></a><span id="l69.26" class="difflineplus">+#   John Resig  &lt;jresig@mozilla.com&gt;</span>
<a href="#l69.27"></a><span id="l69.27" class="difflineplus">+#</span>
<a href="#l69.28"></a><span id="l69.28" class="difflineplus">+# Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l69.29"></a><span id="l69.29" class="difflineplus">+# either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l69.30"></a><span id="l69.30" class="difflineplus">+# the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l69.31"></a><span id="l69.31" class="difflineplus">+# in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l69.32"></a><span id="l69.32" class="difflineplus">+# of those above. If you wish to allow use of your version of this file only</span>
<a href="#l69.33"></a><span id="l69.33" class="difflineplus">+# under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l69.34"></a><span id="l69.34" class="difflineplus">+# use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l69.35"></a><span id="l69.35" class="difflineplus">+# decision by deleting the provisions above and replace them with the notice</span>
<a href="#l69.36"></a><span id="l69.36" class="difflineplus">+# and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l69.37"></a><span id="l69.37" class="difflineplus">+# the provisions above, a recipient may use your version of this file under</span>
<a href="#l69.38"></a><span id="l69.38" class="difflineplus">+# the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l69.39"></a><span id="l69.39" class="difflineplus">+#</span>
<a href="#l69.40"></a><span id="l69.40" class="difflineplus">+# ***** END LICENSE BLOCK *****</span>
<a href="#l69.41"></a><span id="l69.41" class="difflineplus">+</span>
<a href="#l69.42"></a><span id="l69.42" class="difflineplus">+DEPTH     = ../..</span>
<a href="#l69.43"></a><span id="l69.43" class="difflineplus">+topsrcdir = @top_srcdir@</span>
<a href="#l69.44"></a><span id="l69.44" class="difflineplus">+srcdir    = @srcdir@</span>
<a href="#l69.45"></a><span id="l69.45" class="difflineplus">+VPATH     = @srcdir@</span>
<a href="#l69.46"></a><span id="l69.46" class="difflineplus">+</span>
<a href="#l69.47"></a><span id="l69.47" class="difflineplus">+include $(DEPTH)/config/autoconf.mk</span>
<a href="#l69.48"></a><span id="l69.48" class="difflineplus">+</span>
<a href="#l69.49"></a><span id="l69.49" class="difflineplus">+MODULE        = steel</span>
<a href="#l69.50"></a><span id="l69.50" class="difflineplus">+XPIDL_MODULE  = steel</span>
<a href="#l69.51"></a><span id="l69.51" class="difflineplus">+</span>
<a href="#l69.52"></a><span id="l69.52" class="difflineplus">+XPIDLSRCS = steelIApplication.idl</span>
<a href="#l69.53"></a><span id="l69.53" class="difflineplus">+</span>
<a href="#l69.54"></a><span id="l69.54" class="difflineplus">+EXTRA_PP_COMPONENTS = steelApplication.js</span>
<a href="#l69.55"></a><span id="l69.55" class="difflineplus">+</span>
<a href="#l69.56"></a><span id="l69.56" class="difflineplus">+include $(topsrcdir)/config/rules.mk</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l70.1"></a><span id="l70.1">new file mode 100644</span>
<a href="#l70.2"></a><span id="l70.2" class="difflineminus">--- /dev/null</span>
<a href="#l70.3"></a><span id="l70.3" class="difflineplus">+++ b/mail/steel/steelApplication.js</span>
<a href="#l70.4"></a><span id="l70.4" class="difflineat">@@ -0,0 +1,93 @@</span>
<a href="#l70.5"></a><span id="l70.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l70.6"></a><span id="l70.6" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l70.7"></a><span id="l70.7" class="difflineplus">+ *</span>
<a href="#l70.8"></a><span id="l70.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l70.9"></a><span id="l70.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l70.10"></a><span id="l70.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l70.11"></a><span id="l70.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l70.12"></a><span id="l70.12" class="difflineplus">+ *</span>
<a href="#l70.13"></a><span id="l70.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l70.14"></a><span id="l70.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l70.15"></a><span id="l70.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l70.16"></a><span id="l70.16" class="difflineplus">+ * License.</span>
<a href="#l70.17"></a><span id="l70.17" class="difflineplus">+ *</span>
<a href="#l70.18"></a><span id="l70.18" class="difflineplus">+ * The Original Code is STEEL code.</span>
<a href="#l70.19"></a><span id="l70.19" class="difflineplus">+ *</span>
<a href="#l70.20"></a><span id="l70.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l70.21"></a><span id="l70.21" class="difflineplus">+ *   Joey Minta &lt;jminta@gmail.com&gt;</span>
<a href="#l70.22"></a><span id="l70.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l70.23"></a><span id="l70.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l70.24"></a><span id="l70.24" class="difflineplus">+ *</span>
<a href="#l70.25"></a><span id="l70.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l70.26"></a><span id="l70.26" class="difflineplus">+ *</span>
<a href="#l70.27"></a><span id="l70.27" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l70.28"></a><span id="l70.28" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l70.29"></a><span id="l70.29" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l70.30"></a><span id="l70.30" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l70.31"></a><span id="l70.31" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l70.32"></a><span id="l70.32" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l70.33"></a><span id="l70.33" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l70.34"></a><span id="l70.34" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l70.35"></a><span id="l70.35" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l70.36"></a><span id="l70.36" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l70.37"></a><span id="l70.37" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l70.38"></a><span id="l70.38" class="difflineplus">+ *</span>
<a href="#l70.39"></a><span id="l70.39" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l70.40"></a><span id="l70.40" class="difflineplus">+</span>
<a href="#l70.41"></a><span id="l70.41" class="difflineplus">+const Cc = Components.classes;</span>
<a href="#l70.42"></a><span id="l70.42" class="difflineplus">+const Ci = Components.interfaces;</span>
<a href="#l70.43"></a><span id="l70.43" class="difflineplus">+</span>
<a href="#l70.44"></a><span id="l70.44" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l70.45"></a><span id="l70.45" class="difflineplus">+</span>
<a href="#l70.46"></a><span id="l70.46" class="difflineplus">+//=================================================</span>
<a href="#l70.47"></a><span id="l70.47" class="difflineplus">+// Factory - Treat Application as a singleton</span>
<a href="#l70.48"></a><span id="l70.48" class="difflineplus">+// XXX This is required, because we're registered for the 'JavaScript global</span>
<a href="#l70.49"></a><span id="l70.49" class="difflineplus">+// privileged property' category, whose handler always calls createInstance.</span>
<a href="#l70.50"></a><span id="l70.50" class="difflineplus">+// See bug 386535.</span>
<a href="#l70.51"></a><span id="l70.51" class="difflineplus">+var gSingleton = null;</span>
<a href="#l70.52"></a><span id="l70.52" class="difflineplus">+var ApplicationFactory = {</span>
<a href="#l70.53"></a><span id="l70.53" class="difflineplus">+  createInstance: function af_ci(aOuter, aIID) {</span>
<a href="#l70.54"></a><span id="l70.54" class="difflineplus">+    if (aOuter != null)</span>
<a href="#l70.55"></a><span id="l70.55" class="difflineplus">+      throw Components.results.NS_ERROR_NO_AGGREGATION;</span>
<a href="#l70.56"></a><span id="l70.56" class="difflineplus">+</span>
<a href="#l70.57"></a><span id="l70.57" class="difflineplus">+    if (gSingleton == null) {</span>
<a href="#l70.58"></a><span id="l70.58" class="difflineplus">+      gSingleton = new Application();</span>
<a href="#l70.59"></a><span id="l70.59" class="difflineplus">+    }</span>
<a href="#l70.60"></a><span id="l70.60" class="difflineplus">+</span>
<a href="#l70.61"></a><span id="l70.61" class="difflineplus">+    return gSingleton.QueryInterface(aIID);</span>
<a href="#l70.62"></a><span id="l70.62" class="difflineplus">+  }</span>
<a href="#l70.63"></a><span id="l70.63" class="difflineplus">+};</span>
<a href="#l70.64"></a><span id="l70.64" class="difflineplus">+</span>
<a href="#l70.65"></a><span id="l70.65" class="difflineplus">+function Application() {</span>
<a href="#l70.66"></a><span id="l70.66" class="difflineplus">+  this.initToolkitHelpers();</span>
<a href="#l70.67"></a><span id="l70.67" class="difflineplus">+}</span>
<a href="#l70.68"></a><span id="l70.68" class="difflineplus">+</span>
<a href="#l70.69"></a><span id="l70.69" class="difflineplus">+Application.prototype = {</span>
<a href="#l70.70"></a><span id="l70.70" class="difflineplus">+  classDescription: &quot;Application&quot;,</span>
<a href="#l70.71"></a><span id="l70.71" class="difflineplus">+  classID:          Components.ID(&quot;f265021a-7f1d-4b4b-bdc6-9aedca4d8f13&quot;),</span>
<a href="#l70.72"></a><span id="l70.72" class="difflineplus">+  contractID:       &quot;@mozilla.org/steel/application;1&quot;,</span>
<a href="#l70.73"></a><span id="l70.73" class="difflineplus">+</span>
<a href="#l70.74"></a><span id="l70.74" class="difflineplus">+  // redefine the default factory for XPCOMUtils</span>
<a href="#l70.75"></a><span id="l70.75" class="difflineplus">+  _xpcom_factory: ApplicationFactory,</span>
<a href="#l70.76"></a><span id="l70.76" class="difflineplus">+</span>
<a href="#l70.77"></a><span id="l70.77" class="difflineplus">+  // for nsISupports</span>
<a href="#l70.78"></a><span id="l70.78" class="difflineplus">+  QueryInterface : XPCOMUtils.generateQI([Ci.steelIApplication, Ci.extIApplication, Ci.nsIObserver, Ci.nsIClassInfo]),</span>
<a href="#l70.79"></a><span id="l70.79" class="difflineplus">+</span>
<a href="#l70.80"></a><span id="l70.80" class="difflineplus">+  getInterfaces : function app_gi(aCount) {</span>
<a href="#l70.81"></a><span id="l70.81" class="difflineplus">+    let interfaces = [Ci.steelIApplication, Ci.extIApplication, Ci.nsIObserver, Ci.nsIClassInfo];</span>
<a href="#l70.82"></a><span id="l70.82" class="difflineplus">+    aCount.value = interfaces.length;</span>
<a href="#l70.83"></a><span id="l70.83" class="difflineplus">+    return interfaces;</span>
<a href="#l70.84"></a><span id="l70.84" class="difflineplus">+  }</span>
<a href="#l70.85"></a><span id="l70.85" class="difflineplus">+</span>
<a href="#l70.86"></a><span id="l70.86" class="difflineplus">+};</span>
<a href="#l70.87"></a><span id="l70.87" class="difflineplus">+</span>
<a href="#l70.88"></a><span id="l70.88" class="difflineplus">+//module initialization</span>
<a href="#l70.89"></a><span id="l70.89" class="difflineplus">+function NSGetModule(aCompMgr, aFileSpec) {</span>
<a href="#l70.90"></a><span id="l70.90" class="difflineplus">+  // set the proto</span>
<a href="#l70.91"></a><span id="l70.91" class="difflineplus">+  Application.prototype.__proto__ = extApplication.prototype;</span>
<a href="#l70.92"></a><span id="l70.92" class="difflineplus">+</span>
<a href="#l70.93"></a><span id="l70.93" class="difflineplus">+  // now we can finally return our module</span>
<a href="#l70.94"></a><span id="l70.94" class="difflineplus">+  return XPCOMUtils.generateModule([Application]);</span>
<a href="#l70.95"></a><span id="l70.95" class="difflineplus">+}</span>
<a href="#l70.96"></a><span id="l70.96" class="difflineplus">+</span>
<a href="#l70.97"></a><span id="l70.97" class="difflineplus">+#include ../../mozilla/toolkit/components/exthelper/extApplication.js</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l71.1"></a><span id="l71.1">new file mode 100644</span>
<a href="#l71.2"></a><span id="l71.2" class="difflineminus">--- /dev/null</span>
<a href="#l71.3"></a><span id="l71.3" class="difflineplus">+++ b/mail/steel/steelIApplication.idl</span>
<a href="#l71.4"></a><span id="l71.4" class="difflineat">@@ -0,0 +1,45 @@</span>
<a href="#l71.5"></a><span id="l71.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l71.6"></a><span id="l71.6" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l71.7"></a><span id="l71.7" class="difflineplus">+ *</span>
<a href="#l71.8"></a><span id="l71.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l71.9"></a><span id="l71.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l71.10"></a><span id="l71.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l71.11"></a><span id="l71.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l71.12"></a><span id="l71.12" class="difflineplus">+ *</span>
<a href="#l71.13"></a><span id="l71.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l71.14"></a><span id="l71.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l71.15"></a><span id="l71.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l71.16"></a><span id="l71.16" class="difflineplus">+ * License.</span>
<a href="#l71.17"></a><span id="l71.17" class="difflineplus">+ *</span>
<a href="#l71.18"></a><span id="l71.18" class="difflineplus">+ * The Original Code is STEEL code.</span>
<a href="#l71.19"></a><span id="l71.19" class="difflineplus">+ *</span>
<a href="#l71.20"></a><span id="l71.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l71.21"></a><span id="l71.21" class="difflineplus">+ *   Joey Minta &lt;jminta@gmail.com&gt;</span>
<a href="#l71.22"></a><span id="l71.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l71.23"></a><span id="l71.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l71.24"></a><span id="l71.24" class="difflineplus">+ *</span>
<a href="#l71.25"></a><span id="l71.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l71.26"></a><span id="l71.26" class="difflineplus">+ *</span>
<a href="#l71.27"></a><span id="l71.27" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l71.28"></a><span id="l71.28" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l71.29"></a><span id="l71.29" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l71.30"></a><span id="l71.30" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l71.31"></a><span id="l71.31" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l71.32"></a><span id="l71.32" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l71.33"></a><span id="l71.33" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l71.34"></a><span id="l71.34" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l71.35"></a><span id="l71.35" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l71.36"></a><span id="l71.36" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l71.37"></a><span id="l71.37" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l71.38"></a><span id="l71.38" class="difflineplus">+ *</span>
<a href="#l71.39"></a><span id="l71.39" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l71.40"></a><span id="l71.40" class="difflineplus">+</span>
<a href="#l71.41"></a><span id="l71.41" class="difflineplus">+#include &quot;extIApplication.idl&quot;</span>
<a href="#l71.42"></a><span id="l71.42" class="difflineplus">+</span>
<a href="#l71.43"></a><span id="l71.43" class="difflineplus">+/**</span>
<a href="#l71.44"></a><span id="l71.44" class="difflineplus">+ * The core STEEL object, available in the global scope</span>
<a href="#l71.45"></a><span id="l71.45" class="difflineplus">+ */</span>
<a href="#l71.46"></a><span id="l71.46" class="difflineplus">+[scriptable, uuid(f265021a-7f1d-4b4b-bdc6-9aedca4d8f13)]</span>
<a href="#l71.47"></a><span id="l71.47" class="difflineplus">+interface steelIApplication : extIApplication {</span>
<a href="#l71.48"></a><span id="l71.48" class="difflineplus">+  //xxx place-holder for now</span>
<a href="#l71.49"></a><span id="l71.49" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l72.1"></a><span id="l72.1" class="difflineminus">--- a/mail/test/mozmill/content-policy/test-msg-content-policy.js</span>
<a href="#l72.2"></a><span id="l72.2" class="difflineplus">+++ b/mail/test/mozmill/content-policy/test-msg-content-policy.js</span>
<a href="#l72.3"></a><span id="l72.3" class="difflineat">@@ -107,18 +107,18 @@ const jsMsgBody = '&lt;!DOCTYPE HTML PUBLIC</span>
<a href="#l72.4"></a><span id="l72.4"> '&lt;/big&gt;&lt;/big&gt;&lt;/big&gt;\n' +</span>
<a href="#l72.5"></a><span id="l72.5"> '&lt;script language=&quot;javascript&quot;/&gt;\n'+</span>
<a href="#l72.6"></a><span id="l72.6"> 'var jsIsTurnedOn = true;\n' +</span>
<a href="#l72.7"></a><span id="l72.7"> '&lt;/script&gt;\n' +</span>
<a href="#l72.8"></a><span id="l72.8"> '\n' +</span>
<a href="#l72.9"></a><span id="l72.9"> '&lt;/body&gt;\n' +</span>
<a href="#l72.10"></a><span id="l72.10"> '&lt;/html&gt;\n';</span>
<a href="#l72.11"></a><span id="l72.11"> </span>
<a href="#l72.12"></a><span id="l72.12" class="difflineminus">-const Cc = Components.classes;</span>
<a href="#l72.13"></a><span id="l72.13" class="difflineminus">-const Ci = Components.interfaces;</span>
<a href="#l72.14"></a><span id="l72.14" class="difflineplus">+var Cc = Components.classes;</span>
<a href="#l72.15"></a><span id="l72.15" class="difflineplus">+var Ci = Components.interfaces;</span>
<a href="#l72.16"></a><span id="l72.16"> </span>
<a href="#l72.17"></a><span id="l72.17"> const kTestFolderName = &quot;testFolder&quot;;</span>
<a href="#l72.18"></a><span id="l72.18"> </span>
<a href="#l72.19"></a><span id="l72.19"> let am = Cc[&quot;@mozilla.org/messenger/account-manager;1&quot;].</span>
<a href="#l72.20"></a><span id="l72.20">     getService(Ci.nsIMsgAccountManager);</span>
<a href="#l72.21"></a><span id="l72.21"> </span>
<a href="#l72.22"></a><span id="l72.22"> let localRootFolder = am.localFoldersServer.rootFolder;</span>
<a href="#l72.23"></a><span id="l72.23"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l73.1"></a><span id="l73.1">new file mode 100644</span>
<a href="#l73.2"></a><span id="l73.2" class="difflineminus">--- /dev/null</span>
<a href="#l73.3"></a><span id="l73.3" class="difflineplus">+++ b/mail/test/mozmill/folder-display/test-deletion-with-multiple-displays.js</span>
<a href="#l73.4"></a><span id="l73.4" class="difflineat">@@ -0,0 +1,196 @@</span>
<a href="#l73.5"></a><span id="l73.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l73.6"></a><span id="l73.6" class="difflineplus">+ *   Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l73.7"></a><span id="l73.7" class="difflineplus">+ *</span>
<a href="#l73.8"></a><span id="l73.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l73.9"></a><span id="l73.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l73.10"></a><span id="l73.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l73.11"></a><span id="l73.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l73.12"></a><span id="l73.12" class="difflineplus">+ *</span>
<a href="#l73.13"></a><span id="l73.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l73.14"></a><span id="l73.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l73.15"></a><span id="l73.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l73.16"></a><span id="l73.16" class="difflineplus">+ * License.</span>
<a href="#l73.17"></a><span id="l73.17" class="difflineplus">+ *</span>
<a href="#l73.18"></a><span id="l73.18" class="difflineplus">+ * The Original Code is Thunderbird Mail Client.</span>
<a href="#l73.19"></a><span id="l73.19" class="difflineplus">+ *</span>
<a href="#l73.20"></a><span id="l73.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l73.21"></a><span id="l73.21" class="difflineplus">+ * Mozilla Messaging, Inc.</span>
<a href="#l73.22"></a><span id="l73.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l73.23"></a><span id="l73.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l73.24"></a><span id="l73.24" class="difflineplus">+ *</span>
<a href="#l73.25"></a><span id="l73.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l73.26"></a><span id="l73.26" class="difflineplus">+ *   Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a href="#l73.27"></a><span id="l73.27" class="difflineplus">+ *</span>
<a href="#l73.28"></a><span id="l73.28" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l73.29"></a><span id="l73.29" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l73.30"></a><span id="l73.30" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l73.31"></a><span id="l73.31" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l73.32"></a><span id="l73.32" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l73.33"></a><span id="l73.33" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l73.34"></a><span id="l73.34" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l73.35"></a><span id="l73.35" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l73.36"></a><span id="l73.36" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l73.37"></a><span id="l73.37" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l73.38"></a><span id="l73.38" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l73.39"></a><span id="l73.39" class="difflineplus">+ *</span>
<a href="#l73.40"></a><span id="l73.40" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l73.41"></a><span id="l73.41" class="difflineplus">+</span>
<a href="#l73.42"></a><span id="l73.42" class="difflineplus">+/*</span>
<a href="#l73.43"></a><span id="l73.43" class="difflineplus">+ * Test that deleting a message in a given tab or window properly updates both</span>
<a href="#l73.44"></a><span id="l73.44" class="difflineplus">+ *  that tab/window as well as all other tabs/windows.  We also test that the</span>
<a href="#l73.45"></a><span id="l73.45" class="difflineplus">+ *  message tab title updates appropriately through all of this.</span>
<a href="#l73.46"></a><span id="l73.46" class="difflineplus">+ */</span>
<a href="#l73.47"></a><span id="l73.47" class="difflineplus">+var MODULE_NAME = 'test-deletion-with-multiple-displays';</span>
<a href="#l73.48"></a><span id="l73.48" class="difflineplus">+</span>
<a href="#l73.49"></a><span id="l73.49" class="difflineplus">+var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l73.50"></a><span id="l73.50" class="difflineplus">+var MODULE_REQUIRES = ['folder-display-helpers', 'window-helpers'];</span>
<a href="#l73.51"></a><span id="l73.51" class="difflineplus">+</span>
<a href="#l73.52"></a><span id="l73.52" class="difflineplus">+var folder;</span>
<a href="#l73.53"></a><span id="l73.53" class="difflineplus">+</span>
<a href="#l73.54"></a><span id="l73.54" class="difflineplus">+function setupModule(module) {</span>
<a href="#l73.55"></a><span id="l73.55" class="difflineplus">+  let fdh = collector.getModule('folder-display-helpers');</span>
<a href="#l73.56"></a><span id="l73.56" class="difflineplus">+  fdh.installInto(module);</span>
<a href="#l73.57"></a><span id="l73.57" class="difflineplus">+  let wh = collector.getModule('window-helpers');</span>
<a href="#l73.58"></a><span id="l73.58" class="difflineplus">+  wh.installInto(module);</span>
<a href="#l73.59"></a><span id="l73.59" class="difflineplus">+</span>
<a href="#l73.60"></a><span id="l73.60" class="difflineplus">+  folder = create_folder(&quot;DeletionA&quot;);</span>
<a href="#l73.61"></a><span id="l73.61" class="difflineplus">+  // we want exactly as many messages as we plan to delete, so that we can test</span>
<a href="#l73.62"></a><span id="l73.62" class="difflineplus">+  //  that the message window and tabs close when they run out of things to</span>
<a href="#l73.63"></a><span id="l73.63" class="difflineplus">+  //  to display.</span>
<a href="#l73.64"></a><span id="l73.64" class="difflineplus">+  make_new_sets_in_folder(folder, [{count: 4}]);</span>
<a href="#l73.65"></a><span id="l73.65" class="difflineplus">+}</span>
<a href="#l73.66"></a><span id="l73.66" class="difflineplus">+</span>
<a href="#l73.67"></a><span id="l73.67" class="difflineplus">+</span>
<a href="#l73.68"></a><span id="l73.68" class="difflineplus">+var tabFolder, tabMessage, curMessage, nextMessage;</span>
<a href="#l73.69"></a><span id="l73.69" class="difflineplus">+</span>
<a href="#l73.70"></a><span id="l73.70" class="difflineplus">+/**</span>
<a href="#l73.71"></a><span id="l73.71" class="difflineplus">+ * The message window controller.  Short names because controllers get used a</span>
<a href="#l73.72"></a><span id="l73.72" class="difflineplus">+ *  lot.</span>
<a href="#l73.73"></a><span id="l73.73" class="difflineplus">+ */</span>
<a href="#l73.74"></a><span id="l73.74" class="difflineplus">+var msgc;</span>
<a href="#l73.75"></a><span id="l73.75" class="difflineplus">+</span>
<a href="#l73.76"></a><span id="l73.76" class="difflineplus">+/**</span>
<a href="#l73.77"></a><span id="l73.77" class="difflineplus">+ * Have a message displayed in a folder tab, message tab, and message window.</span>
<a href="#l73.78"></a><span id="l73.78" class="difflineplus">+ *  The idea is that as we delete from the various sources, they should all</span>
<a href="#l73.79"></a><span id="l73.79" class="difflineplus">+ *  advance in lock-step through their messages, simplifying our lives (but</span>
<a href="#l73.80"></a><span id="l73.80" class="difflineplus">+ *  making us explode forevermore the first time any of the tests fail.)</span>
<a href="#l73.81"></a><span id="l73.81" class="difflineplus">+ */</span>
<a href="#l73.82"></a><span id="l73.82" class="difflineplus">+function test_open_message_in_all_three_display_mechanisms() {</span>
<a href="#l73.83"></a><span id="l73.83" class="difflineplus">+  // - Select the message in this tab.</span>
<a href="#l73.84"></a><span id="l73.84" class="difflineplus">+  tabFolder = be_in_folder(folder);</span>
<a href="#l73.85"></a><span id="l73.85" class="difflineplus">+  curMessage = select_click_row(0);</span>
<a href="#l73.86"></a><span id="l73.86" class="difflineplus">+  assert_selected_and_displayed(curMessage);</span>
<a href="#l73.87"></a><span id="l73.87" class="difflineplus">+</span>
<a href="#l73.88"></a><span id="l73.88" class="difflineplus">+  // - Open the tab with the message</span>
<a href="#l73.89"></a><span id="l73.89" class="difflineplus">+  tabMessage = open_selected_message_in_new_tab();</span>
<a href="#l73.90"></a><span id="l73.90" class="difflineplus">+  assert_selected_and_displayed(curMessage);</span>
<a href="#l73.91"></a><span id="l73.91" class="difflineplus">+  assert_tab_titled_from(tabMessage, curMessage);</span>
<a href="#l73.92"></a><span id="l73.92" class="difflineplus">+</span>
<a href="#l73.93"></a><span id="l73.93" class="difflineplus">+  // - Open the window with the message</span>
<a href="#l73.94"></a><span id="l73.94" class="difflineplus">+  // need to go back to the folder tab.  (well, should.)</span>
<a href="#l73.95"></a><span id="l73.95" class="difflineplus">+  switch_tab(tabFolder);</span>
<a href="#l73.96"></a><span id="l73.96" class="difflineplus">+  msgc = open_selected_message_in_new_window();</span>
<a href="#l73.97"></a><span id="l73.97" class="difflineplus">+  assert_selected_and_displayed(msgc, curMessage);</span>
<a href="#l73.98"></a><span id="l73.98" class="difflineplus">+}</span>
<a href="#l73.99"></a><span id="l73.99" class="difflineplus">+</span>
<a href="#l73.100"></a><span id="l73.100" class="difflineplus">+/**</span>
<a href="#l73.101"></a><span id="l73.101" class="difflineplus">+ * Perform a deletion from the folder tab, verify the others update correctly</span>
<a href="#l73.102"></a><span id="l73.102" class="difflineplus">+ *  (advancing to the next message).</span>
<a href="#l73.103"></a><span id="l73.103" class="difflineplus">+ */</span>
<a href="#l73.104"></a><span id="l73.104" class="difflineplus">+function test_delete_in_folder_tab() {</span>
<a href="#l73.105"></a><span id="l73.105" class="difflineplus">+  // - plan to end up on the guy who is currently at index 1</span>
<a href="#l73.106"></a><span id="l73.106" class="difflineplus">+  curMessage = mc.dbView.getMsgHdrAt(1);</span>
<a href="#l73.107"></a><span id="l73.107" class="difflineplus">+  // while we're at it, figure out who is at 2 for the next step</span>
<a href="#l73.108"></a><span id="l73.108" class="difflineplus">+  nextMessage = mc.dbView.getMsgHdrAt(2);</span>
<a href="#l73.109"></a><span id="l73.109" class="difflineplus">+  // - delete the message</span>
<a href="#l73.110"></a><span id="l73.110" class="difflineplus">+  press_delete();</span>
<a href="#l73.111"></a><span id="l73.111" class="difflineplus">+  // - make sure the right guy is selected, and that he is at index 0</span>
<a href="#l73.112"></a><span id="l73.112" class="difflineplus">+  assert_selected_and_displayed(curMessage);</span>
<a href="#l73.113"></a><span id="l73.113" class="difflineplus">+  assert_selected_and_displayed(0);</span>
<a href="#l73.114"></a><span id="l73.114" class="difflineplus">+</span>
<a href="#l73.115"></a><span id="l73.115" class="difflineplus">+  // - make sure the message tab updated its title even without us switching</span>
<a href="#l73.116"></a><span id="l73.116" class="difflineplus">+  assert_tab_titled_from(tabMessage, curMessage);</span>
<a href="#l73.117"></a><span id="l73.117" class="difflineplus">+</span>
<a href="#l73.118"></a><span id="l73.118" class="difflineplus">+  // - switch to the message tab, make sure he is now on the right guy</span>
<a href="#l73.119"></a><span id="l73.119" class="difflineplus">+  switch_tab(tabMessage);</span>
<a href="#l73.120"></a><span id="l73.120" class="difflineplus">+  assert_selected_and_displayed(curMessage);</span>
<a href="#l73.121"></a><span id="l73.121" class="difflineplus">+</span>
<a href="#l73.122"></a><span id="l73.122" class="difflineplus">+  // - check the window</span>
<a href="#l73.123"></a><span id="l73.123" class="difflineplus">+  assert_selected_and_displayed(msgc, curMessage);</span>
<a href="#l73.124"></a><span id="l73.124" class="difflineplus">+}</span>
<a href="#l73.125"></a><span id="l73.125" class="difflineplus">+</span>
<a href="#l73.126"></a><span id="l73.126" class="difflineplus">+/**</span>
<a href="#l73.127"></a><span id="l73.127" class="difflineplus">+ * Perform a deletion from the message tab, verify the others update correctly</span>
<a href="#l73.128"></a><span id="l73.128" class="difflineplus">+ *  (advancing to the next message).</span>
<a href="#l73.129"></a><span id="l73.129" class="difflineplus">+ */</span>
<a href="#l73.130"></a><span id="l73.130" class="difflineplus">+function test_delete_in_message_tab() {</span>
<a href="#l73.131"></a><span id="l73.131" class="difflineplus">+  // (we're still on the message tab, and nextMessage is the guy we want to see</span>
<a href="#l73.132"></a><span id="l73.132" class="difflineplus">+  //  once the delete completes.)</span>
<a href="#l73.133"></a><span id="l73.133" class="difflineplus">+  press_delete();</span>
<a href="#l73.134"></a><span id="l73.134" class="difflineplus">+  curMessage = nextMessage;</span>
<a href="#l73.135"></a><span id="l73.135" class="difflineplus">+  assert_selected_and_displayed(curMessage);</span>
<a href="#l73.136"></a><span id="l73.136" class="difflineplus">+  assert_tab_titled_from(tabMessage, curMessage);</span>
<a href="#l73.137"></a><span id="l73.137" class="difflineplus">+</span>
<a href="#l73.138"></a><span id="l73.138" class="difflineplus">+  // - switch to the folder tab and make sure he is on the right guy and at 0</span>
<a href="#l73.139"></a><span id="l73.139" class="difflineplus">+  switch_tab(tabFolder);</span>
<a href="#l73.140"></a><span id="l73.140" class="difflineplus">+  assert_selected_and_displayed(curMessage);</span>
<a href="#l73.141"></a><span id="l73.141" class="difflineplus">+  assert_selected_and_displayed(0);</span>
<a href="#l73.142"></a><span id="l73.142" class="difflineplus">+  // figure out the next guy...</span>
<a href="#l73.143"></a><span id="l73.143" class="difflineplus">+  nextMessage = mc.dbView.getMsgHdrAt(1);</span>
<a href="#l73.144"></a><span id="l73.144" class="difflineplus">+  if (!nextMessage)</span>
<a href="#l73.145"></a><span id="l73.145" class="difflineplus">+    throw new Error(&quot;We ran out of messages early?&quot;);</span>
<a href="#l73.146"></a><span id="l73.146" class="difflineplus">+</span>
<a href="#l73.147"></a><span id="l73.147" class="difflineplus">+  // - check the message window</span>
<a href="#l73.148"></a><span id="l73.148" class="difflineplus">+  assert_selected_and_displayed(msgc, curMessage);</span>
<a href="#l73.149"></a><span id="l73.149" class="difflineplus">+}</span>
<a href="#l73.150"></a><span id="l73.150" class="difflineplus">+</span>
<a href="#l73.151"></a><span id="l73.151" class="difflineplus">+/**</span>
<a href="#l73.152"></a><span id="l73.152" class="difflineplus">+ * Perform a deletion from the message window, verify the others update</span>
<a href="#l73.153"></a><span id="l73.153" class="difflineplus">+ *  correctly (advancing to the next message).</span>
<a href="#l73.154"></a><span id="l73.154" class="difflineplus">+ */</span>
<a href="#l73.155"></a><span id="l73.155" class="difflineplus">+function test_delete_in_message_window() {</span>
<a href="#l73.156"></a><span id="l73.156" class="difflineplus">+  // - delete, verify in the message window</span>
<a href="#l73.157"></a><span id="l73.157" class="difflineplus">+  press_delete(msgc);</span>
<a href="#l73.158"></a><span id="l73.158" class="difflineplus">+  curMessage = nextMessage;</span>
<a href="#l73.159"></a><span id="l73.159" class="difflineplus">+  assert_selected_and_displayed(msgc, curMessage);</span>
<a href="#l73.160"></a><span id="l73.160" class="difflineplus">+</span>
<a href="#l73.161"></a><span id="l73.161" class="difflineplus">+  // - verify in the folder tab (we're still on this tab)</span>
<a href="#l73.162"></a><span id="l73.162" class="difflineplus">+  assert_selected_and_displayed(curMessage);</span>
<a href="#l73.163"></a><span id="l73.163" class="difflineplus">+  assert_selected_and_displayed(0);</span>
<a href="#l73.164"></a><span id="l73.164" class="difflineplus">+</span>
<a href="#l73.165"></a><span id="l73.165" class="difflineplus">+  // - verify in the message tab</span>
<a href="#l73.166"></a><span id="l73.166" class="difflineplus">+  switch_tab(tabMessage);</span>
<a href="#l73.167"></a><span id="l73.167" class="difflineplus">+  assert_selected_and_displayed(curMessage);</span>
<a href="#l73.168"></a><span id="l73.168" class="difflineplus">+  assert_tab_titled_from(tabMessage, curMessage);</span>
<a href="#l73.169"></a><span id="l73.169" class="difflineplus">+}</span>
<a href="#l73.170"></a><span id="l73.170" class="difflineplus">+</span>
<a href="#l73.171"></a><span id="l73.171" class="difflineplus">+/**</span>
<a href="#l73.172"></a><span id="l73.172" class="difflineplus">+ * Delete the last message in that folder, which should close all message</span>
<a href="#l73.173"></a><span id="l73.173" class="difflineplus">+ *  displays.  For comprehensiveness, first open an additional message tab</span>
<a href="#l73.174"></a><span id="l73.174" class="difflineplus">+ *  of the message so that we can test foreground and background closing at the</span>
<a href="#l73.175"></a><span id="l73.175" class="difflineplus">+ *  same time.</span>
<a href="#l73.176"></a><span id="l73.176" class="difflineplus">+ */</span>
<a href="#l73.177"></a><span id="l73.177" class="difflineplus">+function test_delete_last_message_closes_message_displays() {</span>
<a href="#l73.178"></a><span id="l73.178" class="difflineplus">+  // - open the additional message tab</span>
<a href="#l73.179"></a><span id="l73.179" class="difflineplus">+  switch_tab(tabFolder);</span>
<a href="#l73.180"></a><span id="l73.180" class="difflineplus">+  let tabMessage2 = open_selected_message_in_new_tab();</span>
<a href="#l73.181"></a><span id="l73.181" class="difflineplus">+</span>
<a href="#l73.182"></a><span id="l73.182" class="difflineplus">+  // - prep for the message window disappearing</span>
<a href="#l73.183"></a><span id="l73.183" class="difflineplus">+  plan_for_window_close(msgc);</span>
<a href="#l73.184"></a><span id="l73.184" class="difflineplus">+</span>
<a href="#l73.185"></a><span id="l73.185" class="difflineplus">+  // - let's arbitrarily perform the deletion on this message tab</span>
<a href="#l73.186"></a><span id="l73.186" class="difflineplus">+  press_delete();</span>
<a href="#l73.187"></a><span id="l73.187" class="difflineplus">+</span>
<a href="#l73.188"></a><span id="l73.188" class="difflineplus">+  // - the message window should have gone away...</span>
<a href="#l73.189"></a><span id="l73.189" class="difflineplus">+  // (this also helps ensure that the 3pane gets enough event loop time to do</span>
<a href="#l73.190"></a><span id="l73.190" class="difflineplus">+  //  all that it needs to accomplish)</span>
<a href="#l73.191"></a><span id="l73.191" class="difflineplus">+  wait_for_window_close(msgc);</span>
<a href="#l73.192"></a><span id="l73.192" class="difflineplus">+  msgc = null;</span>
<a href="#l73.193"></a><span id="l73.193" class="difflineplus">+</span>
<a href="#l73.194"></a><span id="l73.194" class="difflineplus">+  // - and we should now be on the folder tab and there should be no other tabs</span>
<a href="#l73.195"></a><span id="l73.195" class="difflineplus">+  if (mc.tabmail.tabInfo.length != 1)</span>
<a href="#l73.196"></a><span id="l73.196" class="difflineplus">+    throw new Error(&quot;There should only be one tab left!&quot;);</span>
<a href="#l73.197"></a><span id="l73.197" class="difflineplus">+  // the below check is implied by the previous check if things are sane-ish</span>
<a href="#l73.198"></a><span id="l73.198" class="difflineplus">+  if (mc.tabmail.currentTabInfo != tabFolder)</span>
<a href="#l73.199"></a><span id="l73.199" class="difflineplus">+    throw new Error(&quot;We should be on the folder tab!&quot;);</span>
<a href="#l73.200"></a><span id="l73.200" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l74.1"></a><span id="l74.1">new file mode 100644</span>
<a href="#l74.2"></a><span id="l74.2" class="difflineminus">--- /dev/null</span>
<a href="#l74.3"></a><span id="l74.3" class="difflineplus">+++ b/mail/test/mozmill/folder-display/test-mail-views.js</span>
<a href="#l74.4"></a><span id="l74.4" class="difflineat">@@ -0,0 +1,112 @@</span>
<a href="#l74.5"></a><span id="l74.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l74.6"></a><span id="l74.6" class="difflineplus">+ *   Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l74.7"></a><span id="l74.7" class="difflineplus">+ *</span>
<a href="#l74.8"></a><span id="l74.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l74.9"></a><span id="l74.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l74.10"></a><span id="l74.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l74.11"></a><span id="l74.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l74.12"></a><span id="l74.12" class="difflineplus">+ *</span>
<a href="#l74.13"></a><span id="l74.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l74.14"></a><span id="l74.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l74.15"></a><span id="l74.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l74.16"></a><span id="l74.16" class="difflineplus">+ * License.</span>
<a href="#l74.17"></a><span id="l74.17" class="difflineplus">+ *</span>
<a href="#l74.18"></a><span id="l74.18" class="difflineplus">+ * The Original Code is Thunderbird Mail Client.</span>
<a href="#l74.19"></a><span id="l74.19" class="difflineplus">+ *</span>
<a href="#l74.20"></a><span id="l74.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l74.21"></a><span id="l74.21" class="difflineplus">+ * Mozilla Messaging, Inc.</span>
<a href="#l74.22"></a><span id="l74.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l74.23"></a><span id="l74.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l74.24"></a><span id="l74.24" class="difflineplus">+ *</span>
<a href="#l74.25"></a><span id="l74.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l74.26"></a><span id="l74.26" class="difflineplus">+ *   Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a href="#l74.27"></a><span id="l74.27" class="difflineplus">+ *</span>
<a href="#l74.28"></a><span id="l74.28" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l74.29"></a><span id="l74.29" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l74.30"></a><span id="l74.30" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l74.31"></a><span id="l74.31" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l74.32"></a><span id="l74.32" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l74.33"></a><span id="l74.33" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l74.34"></a><span id="l74.34" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l74.35"></a><span id="l74.35" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l74.36"></a><span id="l74.36" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l74.37"></a><span id="l74.37" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l74.38"></a><span id="l74.38" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l74.39"></a><span id="l74.39" class="difflineplus">+ *</span>
<a href="#l74.40"></a><span id="l74.40" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l74.41"></a><span id="l74.41" class="difflineplus">+</span>
<a href="#l74.42"></a><span id="l74.42" class="difflineplus">+var MODULE_NAME = 'test-mail-views';</span>
<a href="#l74.43"></a><span id="l74.43" class="difflineplus">+</span>
<a href="#l74.44"></a><span id="l74.44" class="difflineplus">+var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l74.45"></a><span id="l74.45" class="difflineplus">+var MODULE_REQUIRES = ['folder-display-helpers', 'window-helpers'];</span>
<a href="#l74.46"></a><span id="l74.46" class="difflineplus">+</span>
<a href="#l74.47"></a><span id="l74.47" class="difflineplus">+var baseFolder, savedFolder;</span>
<a href="#l74.48"></a><span id="l74.48" class="difflineplus">+var setUntagged, setTagged;</span>
<a href="#l74.49"></a><span id="l74.49" class="difflineplus">+</span>
<a href="#l74.50"></a><span id="l74.50" class="difflineplus">+Components.utils.import(&quot;resource://app/modules/mailViewManager.js&quot;);</span>
<a href="#l74.51"></a><span id="l74.51" class="difflineplus">+</span>
<a href="#l74.52"></a><span id="l74.52" class="difflineplus">+var setupModule = function(module) {</span>
<a href="#l74.53"></a><span id="l74.53" class="difflineplus">+  let fdh = collector.getModule('folder-display-helpers');</span>
<a href="#l74.54"></a><span id="l74.54" class="difflineplus">+  fdh.installInto(module);</span>
<a href="#l74.55"></a><span id="l74.55" class="difflineplus">+  let wh = collector.getModule('window-helpers');</span>
<a href="#l74.56"></a><span id="l74.56" class="difflineplus">+  wh.installInto(module);</span>
<a href="#l74.57"></a><span id="l74.57" class="difflineplus">+</span>
<a href="#l74.58"></a><span id="l74.58" class="difflineplus">+  // Create a folder with some messages that have no tags and some that are</span>
<a href="#l74.59"></a><span id="l74.59" class="difflineplus">+  //  tagged Important ($label1).</span>
<a href="#l74.60"></a><span id="l74.60" class="difflineplus">+  baseFolder = create_folder(&quot;MailViewA&quot;);</span>
<a href="#l74.61"></a><span id="l74.61" class="difflineplus">+  [setUntagged, setTagged] = make_new_sets_in_folder(baseFolder,</span>
<a href="#l74.62"></a><span id="l74.62" class="difflineplus">+                                                     [{}, {}]);</span>
<a href="#l74.63"></a><span id="l74.63" class="difflineplus">+  setTagged.addTag(&quot;$label1&quot;); // Important, by default</span>
<a href="#l74.64"></a><span id="l74.64" class="difflineplus">+};</span>
<a href="#l74.65"></a><span id="l74.65" class="difflineplus">+</span>
<a href="#l74.66"></a><span id="l74.66" class="difflineplus">+function test_put_view_picker_on_toolbar() {</span>
<a href="#l74.67"></a><span id="l74.67" class="difflineplus">+  let toolbar = mc.e(&quot;mail-bar2&quot;);</span>
<a href="#l74.68"></a><span id="l74.68" class="difflineplus">+  toolbar.insertItem(&quot;mailviews-container&quot;, null);</span>
<a href="#l74.69"></a><span id="l74.69" class="difflineplus">+  mc.assertNode(mc.eid(&quot;mailviews-container&quot;));</span>
<a href="#l74.70"></a><span id="l74.70" class="difflineplus">+}</span>
<a href="#l74.71"></a><span id="l74.71" class="difflineplus">+</span>
<a href="#l74.72"></a><span id="l74.72" class="difflineplus">+/**</span>
<a href="#l74.73"></a><span id="l74.73" class="difflineplus">+ * https://bugzilla.mozilla.org/show_bug.cgi?id=474701#c97</span>
<a href="#l74.74"></a><span id="l74.74" class="difflineplus">+ */</span>
<a href="#l74.75"></a><span id="l74.75" class="difflineplus">+function test_save_view_as_folder() {</span>
<a href="#l74.76"></a><span id="l74.76" class="difflineplus">+  // - enter the folder</span>
<a href="#l74.77"></a><span id="l74.77" class="difflineplus">+  be_in_folder(baseFolder);</span>
<a href="#l74.78"></a><span id="l74.78" class="difflineplus">+</span>
<a href="#l74.79"></a><span id="l74.79" class="difflineplus">+  // - apply the mail view</span>
<a href="#l74.80"></a><span id="l74.80" class="difflineplus">+  // okay, mozmill is just not ready to click on the view picker...</span>
<a href="#l74.81"></a><span id="l74.81" class="difflineplus">+  // just call the ViewChange global.  it's sad, but it has the same effects.</span>
<a href="#l74.82"></a><span id="l74.82" class="difflineplus">+  // at least, it does once we've caused the popups to get refreshed.</span>
<a href="#l74.83"></a><span id="l74.83" class="difflineplus">+  mc.window.RefreshAllViewPopups(mc.e(&quot;viewPickerPopup&quot;));</span>
<a href="#l74.84"></a><span id="l74.84" class="difflineplus">+  mc.window.ViewChange(&quot;:$label1&quot;);</span>
<a href="#l74.85"></a><span id="l74.85" class="difflineplus">+  wait_for_all_messages_to_load();</span>
<a href="#l74.86"></a><span id="l74.86" class="difflineplus">+</span>
<a href="#l74.87"></a><span id="l74.87" class="difflineplus">+  // - save it</span>
<a href="#l74.88"></a><span id="l74.88" class="difflineplus">+  plan_for_modal_dialog(&quot;mailnews:virtualFolderProperties&quot;,</span>
<a href="#l74.89"></a><span id="l74.89" class="difflineplus">+                        subtest_save_mail_view);</span>
<a href="#l74.90"></a><span id="l74.90" class="difflineplus">+  // we have to use value here because the option mechanism is not sophisticated</span>
<a href="#l74.91"></a><span id="l74.91" class="difflineplus">+  //  enough.</span>
<a href="#l74.92"></a><span id="l74.92" class="difflineplus">+  mc.window.ViewChange(MailViewConstants.kViewItemVirtual);</span>
<a href="#l74.93"></a><span id="l74.93" class="difflineplus">+  wait_for_modal_dialog(&quot;mailnews:virtualFolderProperties&quot;);</span>
<a href="#l74.94"></a><span id="l74.94" class="difflineplus">+}</span>
<a href="#l74.95"></a><span id="l74.95" class="difflineplus">+</span>
<a href="#l74.96"></a><span id="l74.96" class="difflineplus">+function subtest_save_mail_view(savc) {</span>
<a href="#l74.97"></a><span id="l74.97" class="difflineplus">+  // - make sure the name is right</span>
<a href="#l74.98"></a><span id="l74.98" class="difflineplus">+  savc.assertValue(savc.eid(&quot;name&quot;), baseFolder.prettyName + &quot;-Important&quot;);</span>
<a href="#l74.99"></a><span id="l74.99" class="difflineplus">+</span>
<a href="#l74.100"></a><span id="l74.100" class="difflineplus">+  // - make sure the constraint is right</span>
<a href="#l74.101"></a><span id="l74.101" class="difflineplus">+  savc.assertValue(savc.aid(&quot;searchVal0&quot;, {crazyDeck: 0}), &quot;$label1&quot;);</span>
<a href="#l74.102"></a><span id="l74.102" class="difflineplus">+</span>
<a href="#l74.103"></a><span id="l74.103" class="difflineplus">+  // - save it</span>
<a href="#l74.104"></a><span id="l74.104" class="difflineplus">+  savc.window.onOK();</span>
<a href="#l74.105"></a><span id="l74.105" class="difflineplus">+}</span>
<a href="#l74.106"></a><span id="l74.106" class="difflineplus">+</span>
<a href="#l74.107"></a><span id="l74.107" class="difflineplus">+function test_verify_saved_mail_view() {</span>
<a href="#l74.108"></a><span id="l74.108" class="difflineplus">+  // - make sure the folder got created</span>
<a href="#l74.109"></a><span id="l74.109" class="difflineplus">+  savedFolder = baseFolder.findSubFolder(baseFolder.prettyName + &quot;-Important&quot;);</span>
<a href="#l74.110"></a><span id="l74.110" class="difflineplus">+  if (!savedFolder)</span>
<a href="#l74.111"></a><span id="l74.111" class="difflineplus">+    throw new Error(&quot;MailViewA-Important was not created!&quot;);</span>
<a href="#l74.112"></a><span id="l74.112" class="difflineplus">+</span>
<a href="#l74.113"></a><span id="l74.113" class="difflineplus">+  // - go in the folder and make sure the right messages are displayed</span>
<a href="#l74.114"></a><span id="l74.114" class="difflineplus">+  be_in_folder(savedFolder);</span>
<a href="#l74.115"></a><span id="l74.115" class="difflineplus">+  assert_messages_in_view(setTagged, mc);</span>
<a href="#l74.116"></a><span id="l74.116" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l75.1"></a><span id="l75.1">new file mode 100644</span>
<a href="#l75.2"></a><span id="l75.2" class="difflineminus">--- /dev/null</span>
<a href="#l75.3"></a><span id="l75.3" class="difflineplus">+++ b/mail/test/mozmill/folder-display/test-message-window.js</span>
<a href="#l75.4"></a><span id="l75.4" class="difflineat">@@ -0,0 +1,81 @@</span>
<a href="#l75.5"></a><span id="l75.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l75.6"></a><span id="l75.6" class="difflineplus">+ *   Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l75.7"></a><span id="l75.7" class="difflineplus">+ *</span>
<a href="#l75.8"></a><span id="l75.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l75.9"></a><span id="l75.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l75.10"></a><span id="l75.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l75.11"></a><span id="l75.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l75.12"></a><span id="l75.12" class="difflineplus">+ *</span>
<a href="#l75.13"></a><span id="l75.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l75.14"></a><span id="l75.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l75.15"></a><span id="l75.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l75.16"></a><span id="l75.16" class="difflineplus">+ * License.</span>
<a href="#l75.17"></a><span id="l75.17" class="difflineplus">+ *</span>
<a href="#l75.18"></a><span id="l75.18" class="difflineplus">+ * The Original Code is Thunderbird Mail Client.</span>
<a href="#l75.19"></a><span id="l75.19" class="difflineplus">+ *</span>
<a href="#l75.20"></a><span id="l75.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l75.21"></a><span id="l75.21" class="difflineplus">+ * Mozilla Messaging, Inc.</span>
<a href="#l75.22"></a><span id="l75.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l75.23"></a><span id="l75.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l75.24"></a><span id="l75.24" class="difflineplus">+ *</span>
<a href="#l75.25"></a><span id="l75.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l75.26"></a><span id="l75.26" class="difflineplus">+ *   Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a href="#l75.27"></a><span id="l75.27" class="difflineplus">+ *</span>
<a href="#l75.28"></a><span id="l75.28" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l75.29"></a><span id="l75.29" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l75.30"></a><span id="l75.30" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l75.31"></a><span id="l75.31" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l75.32"></a><span id="l75.32" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l75.33"></a><span id="l75.33" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l75.34"></a><span id="l75.34" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l75.35"></a><span id="l75.35" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l75.36"></a><span id="l75.36" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l75.37"></a><span id="l75.37" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l75.38"></a><span id="l75.38" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l75.39"></a><span id="l75.39" class="difflineplus">+ *</span>
<a href="#l75.40"></a><span id="l75.40" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l75.41"></a><span id="l75.41" class="difflineplus">+</span>
<a href="#l75.42"></a><span id="l75.42" class="difflineplus">+/*</span>
<a href="#l75.43"></a><span id="l75.43" class="difflineplus">+ * Test that we can open and close a standalone message display window from the</span>
<a href="#l75.44"></a><span id="l75.44" class="difflineplus">+ *  folder pane.</span>
<a href="#l75.45"></a><span id="l75.45" class="difflineplus">+ */</span>
<a href="#l75.46"></a><span id="l75.46" class="difflineplus">+var MODULE_NAME = 'test-message-window';</span>
<a href="#l75.47"></a><span id="l75.47" class="difflineplus">+</span>
<a href="#l75.48"></a><span id="l75.48" class="difflineplus">+var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l75.49"></a><span id="l75.49" class="difflineplus">+var MODULE_REQUIRES = ['folder-display-helpers', 'window-helpers'];</span>
<a href="#l75.50"></a><span id="l75.50" class="difflineplus">+</span>
<a href="#l75.51"></a><span id="l75.51" class="difflineplus">+var folder;</span>
<a href="#l75.52"></a><span id="l75.52" class="difflineplus">+</span>
<a href="#l75.53"></a><span id="l75.53" class="difflineplus">+function setupModule(module) {</span>
<a href="#l75.54"></a><span id="l75.54" class="difflineplus">+  let fdh = collector.getModule('folder-display-helpers');</span>
<a href="#l75.55"></a><span id="l75.55" class="difflineplus">+  fdh.installInto(module);</span>
<a href="#l75.56"></a><span id="l75.56" class="difflineplus">+  let wh = collector.getModule('window-helpers');</span>
<a href="#l75.57"></a><span id="l75.57" class="difflineplus">+  wh.installInto(module);</span>
<a href="#l75.58"></a><span id="l75.58" class="difflineplus">+</span>
<a href="#l75.59"></a><span id="l75.59" class="difflineplus">+  folder = create_folder(&quot;MessageWindowA&quot;);</span>
<a href="#l75.60"></a><span id="l75.60" class="difflineplus">+  // create a single message in the folder to display</span>
<a href="#l75.61"></a><span id="l75.61" class="difflineplus">+  make_new_sets_in_folder(folder, [{count: 1}]);</span>
<a href="#l75.62"></a><span id="l75.62" class="difflineplus">+}</span>
<a href="#l75.63"></a><span id="l75.63" class="difflineplus">+</span>
<a href="#l75.64"></a><span id="l75.64" class="difflineplus">+/** The message window controller. */</span>
<a href="#l75.65"></a><span id="l75.65" class="difflineplus">+var msgc;</span>
<a href="#l75.66"></a><span id="l75.66" class="difflineplus">+</span>
<a href="#l75.67"></a><span id="l75.67" class="difflineplus">+function test_open_message_window() {</span>
<a href="#l75.68"></a><span id="l75.68" class="difflineplus">+  be_in_folder(folder);</span>
<a href="#l75.69"></a><span id="l75.69" class="difflineplus">+</span>
<a href="#l75.70"></a><span id="l75.70" class="difflineplus">+  // select the one and only message</span>
<a href="#l75.71"></a><span id="l75.71" class="difflineplus">+  let curMessage = select_click_row(0);</span>
<a href="#l75.72"></a><span id="l75.72" class="difflineplus">+</span>
<a href="#l75.73"></a><span id="l75.73" class="difflineplus">+  // display it</span>
<a href="#l75.74"></a><span id="l75.74" class="difflineplus">+  msgc = open_selected_message_in_new_window();</span>
<a href="#l75.75"></a><span id="l75.75" class="difflineplus">+  assert_selected_and_displayed(msgc, curMessage);</span>
<a href="#l75.76"></a><span id="l75.76" class="difflineplus">+}</span>
<a href="#l75.77"></a><span id="l75.77" class="difflineplus">+</span>
<a href="#l75.78"></a><span id="l75.78" class="difflineplus">+/**</span>
<a href="#l75.79"></a><span id="l75.79" class="difflineplus">+ * Close the window by hitting escape.</span>
<a href="#l75.80"></a><span id="l75.80" class="difflineplus">+ */</span>
<a href="#l75.81"></a><span id="l75.81" class="difflineplus">+function test_close_message_window() {</span>
<a href="#l75.82"></a><span id="l75.82" class="difflineplus">+  plan_for_window_close(msgc);</span>
<a href="#l75.83"></a><span id="l75.83" class="difflineplus">+  msgc.keypress(null, &quot;VK_ESCAPE&quot;, {});</span>
<a href="#l75.84"></a><span id="l75.84" class="difflineplus">+  wait_for_window_close(msgc);</span>
<a href="#l75.85"></a><span id="l75.85" class="difflineplus">+}</span>
<a href="#l75.86"></a><span id="l75.86">\ No newline at end of file</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l76.1"></a><span id="l76.1">new file mode 100644</span>
<a href="#l76.2"></a><span id="l76.2" class="difflineminus">--- /dev/null</span>
<a href="#l76.3"></a><span id="l76.3" class="difflineplus">+++ b/mail/test/mozmill/folder-display/test-right-click-middle-click.js</span>
<a href="#l76.4"></a><span id="l76.4" class="difflineat">@@ -0,0 +1,313 @@</span>
<a href="#l76.5"></a><span id="l76.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l76.6"></a><span id="l76.6" class="difflineplus">+ *   Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l76.7"></a><span id="l76.7" class="difflineplus">+ *</span>
<a href="#l76.8"></a><span id="l76.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l76.9"></a><span id="l76.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l76.10"></a><span id="l76.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l76.11"></a><span id="l76.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l76.12"></a><span id="l76.12" class="difflineplus">+ *</span>
<a href="#l76.13"></a><span id="l76.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l76.14"></a><span id="l76.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l76.15"></a><span id="l76.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l76.16"></a><span id="l76.16" class="difflineplus">+ * License.</span>
<a href="#l76.17"></a><span id="l76.17" class="difflineplus">+ *</span>
<a href="#l76.18"></a><span id="l76.18" class="difflineplus">+ * The Original Code is Thunderbird Mail Client.</span>
<a href="#l76.19"></a><span id="l76.19" class="difflineplus">+ *</span>
<a href="#l76.20"></a><span id="l76.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l76.21"></a><span id="l76.21" class="difflineplus">+ * Mozilla Messaging, Inc.</span>
<a href="#l76.22"></a><span id="l76.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l76.23"></a><span id="l76.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l76.24"></a><span id="l76.24" class="difflineplus">+ *</span>
<a href="#l76.25"></a><span id="l76.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l76.26"></a><span id="l76.26" class="difflineplus">+ *   Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a href="#l76.27"></a><span id="l76.27" class="difflineplus">+ *</span>
<a href="#l76.28"></a><span id="l76.28" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l76.29"></a><span id="l76.29" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l76.30"></a><span id="l76.30" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l76.31"></a><span id="l76.31" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l76.32"></a><span id="l76.32" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l76.33"></a><span id="l76.33" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l76.34"></a><span id="l76.34" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l76.35"></a><span id="l76.35" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l76.36"></a><span id="l76.36" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l76.37"></a><span id="l76.37" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l76.38"></a><span id="l76.38" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l76.39"></a><span id="l76.39" class="difflineplus">+ *</span>
<a href="#l76.40"></a><span id="l76.40" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l76.41"></a><span id="l76.41" class="difflineplus">+</span>
<a href="#l76.42"></a><span id="l76.42" class="difflineplus">+/*</span>
<a href="#l76.43"></a><span id="l76.43" class="difflineplus">+ * Test the many horrors involving right-clicks, middle clicks, and selections.</span>
<a href="#l76.44"></a><span id="l76.44" class="difflineplus">+ */</span>
<a href="#l76.45"></a><span id="l76.45" class="difflineplus">+</span>
<a href="#l76.46"></a><span id="l76.46" class="difflineplus">+var MODULE_NAME = 'test-deletion-with-multiple-displays';</span>
<a href="#l76.47"></a><span id="l76.47" class="difflineplus">+</span>
<a href="#l76.48"></a><span id="l76.48" class="difflineplus">+var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l76.49"></a><span id="l76.49" class="difflineplus">+var MODULE_REQUIRES = ['folder-display-helpers', 'window-helpers'];</span>
<a href="#l76.50"></a><span id="l76.50" class="difflineplus">+</span>
<a href="#l76.51"></a><span id="l76.51" class="difflineplus">+var folder;</span>
<a href="#l76.52"></a><span id="l76.52" class="difflineplus">+</span>
<a href="#l76.53"></a><span id="l76.53" class="difflineplus">+function setupModule(module) {</span>
<a href="#l76.54"></a><span id="l76.54" class="difflineplus">+  let fdh = collector.getModule('folder-display-helpers');</span>
<a href="#l76.55"></a><span id="l76.55" class="difflineplus">+  fdh.installInto(module);</span>
<a href="#l76.56"></a><span id="l76.56" class="difflineplus">+  let wh = collector.getModule('window-helpers');</span>
<a href="#l76.57"></a><span id="l76.57" class="difflineplus">+  wh.installInto(module);</span>
<a href="#l76.58"></a><span id="l76.58" class="difflineplus">+</span>
<a href="#l76.59"></a><span id="l76.59" class="difflineplus">+  folder = create_folder(&quot;RightClickMiddleClickA&quot;);</span>
<a href="#l76.60"></a><span id="l76.60" class="difflineplus">+  // we want exactly as many messages as we plan to delete, so that we can test</span>
<a href="#l76.61"></a><span id="l76.61" class="difflineplus">+  //  that the message window and tabs close when they run out of things to</span>
<a href="#l76.62"></a><span id="l76.62" class="difflineplus">+  //  to display.</span>
<a href="#l76.63"></a><span id="l76.63" class="difflineplus">+  make_new_sets_in_folder(folder, [{count: 20}]);</span>
<a href="#l76.64"></a><span id="l76.64" class="difflineplus">+}</span>
<a href="#l76.65"></a><span id="l76.65" class="difflineplus">+</span>
<a href="#l76.66"></a><span id="l76.66" class="difflineplus">+/**</span>
<a href="#l76.67"></a><span id="l76.67" class="difflineplus">+ * Make sure that a right-click when there is nothing currently selected does</span>
<a href="#l76.68"></a><span id="l76.68" class="difflineplus">+ *  not cause us to display something, as well as correctly causing a transient</span>
<a href="#l76.69"></a><span id="l76.69" class="difflineplus">+ *  selection to occur.</span>
<a href="#l76.70"></a><span id="l76.70" class="difflineplus">+ */</span>
<a href="#l76.71"></a><span id="l76.71" class="difflineplus">+function test_right_click_with_nothing_selected() {</span>
<a href="#l76.72"></a><span id="l76.72" class="difflineplus">+  be_in_folder(folder);</span>
<a href="#l76.73"></a><span id="l76.73" class="difflineplus">+</span>
<a href="#l76.74"></a><span id="l76.74" class="difflineplus">+  select_none();</span>
<a href="#l76.75"></a><span id="l76.75" class="difflineplus">+  assert_nothing_selected();</span>
<a href="#l76.76"></a><span id="l76.76" class="difflineplus">+</span>
<a href="#l76.77"></a><span id="l76.77" class="difflineplus">+  right_click_on_row(1);</span>
<a href="#l76.78"></a><span id="l76.78" class="difflineplus">+  assert_selected(1);</span>
<a href="#l76.79"></a><span id="l76.79" class="difflineplus">+  assert_displayed();</span>
<a href="#l76.80"></a><span id="l76.80" class="difflineplus">+</span>
<a href="#l76.81"></a><span id="l76.81" class="difflineplus">+  close_popup();</span>
<a href="#l76.82"></a><span id="l76.82" class="difflineplus">+  assert_nothing_selected();</span>
<a href="#l76.83"></a><span id="l76.83" class="difflineplus">+}</span>
<a href="#l76.84"></a><span id="l76.84" class="difflineplus">+</span>
<a href="#l76.85"></a><span id="l76.85" class="difflineplus">+/**</span>
<a href="#l76.86"></a><span id="l76.86" class="difflineplus">+ * One-thing selected, right-click on something else.</span>
<a href="#l76.87"></a><span id="l76.87" class="difflineplus">+ */</span>
<a href="#l76.88"></a><span id="l76.88" class="difflineplus">+function test_right_click_with_one_thing_selected() {</span>
<a href="#l76.89"></a><span id="l76.89" class="difflineplus">+  be_in_folder(folder);</span>
<a href="#l76.90"></a><span id="l76.90" class="difflineplus">+</span>
<a href="#l76.91"></a><span id="l76.91" class="difflineplus">+  select_click_row(0);</span>
<a href="#l76.92"></a><span id="l76.92" class="difflineplus">+  assert_selected_and_displayed(0);</span>
<a href="#l76.93"></a><span id="l76.93" class="difflineplus">+</span>
<a href="#l76.94"></a><span id="l76.94" class="difflineplus">+  right_click_on_row(1);</span>
<a href="#l76.95"></a><span id="l76.95" class="difflineplus">+  assert_selected(1);</span>
<a href="#l76.96"></a><span id="l76.96" class="difflineplus">+  assert_displayed(0);</span>
<a href="#l76.97"></a><span id="l76.97" class="difflineplus">+</span>
<a href="#l76.98"></a><span id="l76.98" class="difflineplus">+  close_popup();</span>
<a href="#l76.99"></a><span id="l76.99" class="difflineplus">+  assert_selected_and_displayed(0);</span>
<a href="#l76.100"></a><span id="l76.100" class="difflineplus">+}</span>
<a href="#l76.101"></a><span id="l76.101" class="difflineplus">+</span>
<a href="#l76.102"></a><span id="l76.102" class="difflineplus">+/**</span>
<a href="#l76.103"></a><span id="l76.103" class="difflineplus">+ * Many things selected, right-click on something that is not in that selection.</span>
<a href="#l76.104"></a><span id="l76.104" class="difflineplus">+ */</span>
<a href="#l76.105"></a><span id="l76.105" class="difflineplus">+function test_right_click_with_many_things_selected() {</span>
<a href="#l76.106"></a><span id="l76.106" class="difflineplus">+  be_in_folder(folder);</span>
<a href="#l76.107"></a><span id="l76.107" class="difflineplus">+</span>
<a href="#l76.108"></a><span id="l76.108" class="difflineplus">+  select_click_row(0);</span>
<a href="#l76.109"></a><span id="l76.109" class="difflineplus">+  select_shift_click_row(5);</span>
<a href="#l76.110"></a><span id="l76.110" class="difflineplus">+  assert_selected_and_displayed([0, 5]);</span>
<a href="#l76.111"></a><span id="l76.111" class="difflineplus">+</span>
<a href="#l76.112"></a><span id="l76.112" class="difflineplus">+  right_click_on_row(6);</span>
<a href="#l76.113"></a><span id="l76.113" class="difflineplus">+  assert_selected(6);</span>
<a href="#l76.114"></a><span id="l76.114" class="difflineplus">+  assert_displayed([0, 5]);</span>
<a href="#l76.115"></a><span id="l76.115" class="difflineplus">+</span>
<a href="#l76.116"></a><span id="l76.116" class="difflineplus">+  close_popup();</span>
<a href="#l76.117"></a><span id="l76.117" class="difflineplus">+  assert_selected_and_displayed([0, 5]);</span>
<a href="#l76.118"></a><span id="l76.118" class="difflineplus">+}</span>
<a href="#l76.119"></a><span id="l76.119" class="difflineplus">+</span>
<a href="#l76.120"></a><span id="l76.120" class="difflineplus">+/**</span>
<a href="#l76.121"></a><span id="l76.121" class="difflineplus">+ * One thing selected, right-click on that.</span>
<a href="#l76.122"></a><span id="l76.122" class="difflineplus">+ */</span>
<a href="#l76.123"></a><span id="l76.123" class="difflineplus">+function test_right_click_on_existing_single_selection() {</span>
<a href="#l76.124"></a><span id="l76.124" class="difflineplus">+  be_in_folder(folder);</span>
<a href="#l76.125"></a><span id="l76.125" class="difflineplus">+</span>
<a href="#l76.126"></a><span id="l76.126" class="difflineplus">+  select_click_row(3);</span>
<a href="#l76.127"></a><span id="l76.127" class="difflineplus">+  assert_selected_and_displayed(3);</span>
<a href="#l76.128"></a><span id="l76.128" class="difflineplus">+</span>
<a href="#l76.129"></a><span id="l76.129" class="difflineplus">+  right_click_on_row(3);</span>
<a href="#l76.130"></a><span id="l76.130" class="difflineplus">+  assert_selected_and_displayed(3);</span>
<a href="#l76.131"></a><span id="l76.131" class="difflineplus">+</span>
<a href="#l76.132"></a><span id="l76.132" class="difflineplus">+  close_popup();</span>
<a href="#l76.133"></a><span id="l76.133" class="difflineplus">+  assert_selected_and_displayed(3);</span>
<a href="#l76.134"></a><span id="l76.134" class="difflineplus">+}</span>
<a href="#l76.135"></a><span id="l76.135" class="difflineplus">+</span>
<a href="#l76.136"></a><span id="l76.136" class="difflineplus">+/**</span>
<a href="#l76.137"></a><span id="l76.137" class="difflineplus">+ * Many things selected, right-click somewhere in the selection.</span>
<a href="#l76.138"></a><span id="l76.138" class="difflineplus">+ */</span>
<a href="#l76.139"></a><span id="l76.139" class="difflineplus">+function test_right_click_on_existing_multi_selection() {</span>
<a href="#l76.140"></a><span id="l76.140" class="difflineplus">+  be_in_folder(folder);</span>
<a href="#l76.141"></a><span id="l76.141" class="difflineplus">+</span>
<a href="#l76.142"></a><span id="l76.142" class="difflineplus">+  select_click_row(3);</span>
<a href="#l76.143"></a><span id="l76.143" class="difflineplus">+  select_shift_click_row(6);</span>
<a href="#l76.144"></a><span id="l76.144" class="difflineplus">+  assert_selected_and_displayed([3, 6]);</span>
<a href="#l76.145"></a><span id="l76.145" class="difflineplus">+</span>
<a href="#l76.146"></a><span id="l76.146" class="difflineplus">+  right_click_on_row(5);</span>
<a href="#l76.147"></a><span id="l76.147" class="difflineplus">+  assert_selected_and_displayed([3, 6]);</span>
<a href="#l76.148"></a><span id="l76.148" class="difflineplus">+</span>
<a href="#l76.149"></a><span id="l76.149" class="difflineplus">+  close_popup();</span>
<a href="#l76.150"></a><span id="l76.150" class="difflineplus">+  assert_selected_and_displayed([3, 6]);</span>
<a href="#l76.151"></a><span id="l76.151" class="difflineplus">+}</span>
<a href="#l76.152"></a><span id="l76.152" class="difflineplus">+</span>
<a href="#l76.153"></a><span id="l76.153" class="difflineplus">+/**</span>
<a href="#l76.154"></a><span id="l76.154" class="difflineplus">+ * Middle clicking should open a message in a tab, but not affect our selection.</span>
<a href="#l76.155"></a><span id="l76.155" class="difflineplus">+ */</span>
<a href="#l76.156"></a><span id="l76.156" class="difflineplus">+function test_middle_click_with_nothing_selected() {</span>
<a href="#l76.157"></a><span id="l76.157" class="difflineplus">+  be_in_folder(folder);</span>
<a href="#l76.158"></a><span id="l76.158" class="difflineplus">+</span>
<a href="#l76.159"></a><span id="l76.159" class="difflineplus">+  select_none();</span>
<a href="#l76.160"></a><span id="l76.160" class="difflineplus">+  assert_nothing_selected();</span>
<a href="#l76.161"></a><span id="l76.161" class="difflineplus">+</span>
<a href="#l76.162"></a><span id="l76.162" class="difflineplus">+  let [tabMessage, curMessage] = middle_click_on_row(1);</span>
<a href="#l76.163"></a><span id="l76.163" class="difflineplus">+  // as of immediately right now, the tab opens in the foreground, but soon</span>
<a href="#l76.164"></a><span id="l76.164" class="difflineplus">+  //  it will open in the background, so prepare the test for that...</span>
<a href="#l76.165"></a><span id="l76.165" class="difflineplus">+  switch_tab(tabMessage);</span>
<a href="#l76.166"></a><span id="l76.166" class="difflineplus">+  assert_selected_and_displayed(curMessage);</span>
<a href="#l76.167"></a><span id="l76.167" class="difflineplus">+  close_tab(tabMessage);</span>
<a href="#l76.168"></a><span id="l76.168" class="difflineplus">+</span>
<a href="#l76.169"></a><span id="l76.169" class="difflineplus">+  assert_nothing_selected();</span>
<a href="#l76.170"></a><span id="l76.170" class="difflineplus">+}</span>
<a href="#l76.171"></a><span id="l76.171" class="difflineplus">+</span>
<a href="#l76.172"></a><span id="l76.172" class="difflineplus">+/**</span>
<a href="#l76.173"></a><span id="l76.173" class="difflineplus">+ * One-thing selected, middle-click on something else.</span>
<a href="#l76.174"></a><span id="l76.174" class="difflineplus">+ */</span>
<a href="#l76.175"></a><span id="l76.175" class="difflineplus">+function test_middle_click_with_one_thing_selected() {</span>
<a href="#l76.176"></a><span id="l76.176" class="difflineplus">+  be_in_folder(folder);</span>
<a href="#l76.177"></a><span id="l76.177" class="difflineplus">+</span>
<a href="#l76.178"></a><span id="l76.178" class="difflineplus">+  select_click_row(0);</span>
<a href="#l76.179"></a><span id="l76.179" class="difflineplus">+  assert_selected_and_displayed(0);</span>
<a href="#l76.180"></a><span id="l76.180" class="difflineplus">+</span>
<a href="#l76.181"></a><span id="l76.181" class="difflineplus">+  let [tabMessage, curMessage] = middle_click_on_row(1);</span>
<a href="#l76.182"></a><span id="l76.182" class="difflineplus">+  switch_tab(tabMessage);</span>
<a href="#l76.183"></a><span id="l76.183" class="difflineplus">+  assert_selected_and_displayed(curMessage);</span>
<a href="#l76.184"></a><span id="l76.184" class="difflineplus">+  close_tab(tabMessage);</span>
<a href="#l76.185"></a><span id="l76.185" class="difflineplus">+</span>
<a href="#l76.186"></a><span id="l76.186" class="difflineplus">+  assert_selected_and_displayed(0);</span>
<a href="#l76.187"></a><span id="l76.187" class="difflineplus">+}</span>
<a href="#l76.188"></a><span id="l76.188" class="difflineplus">+</span>
<a href="#l76.189"></a><span id="l76.189" class="difflineplus">+/**</span>
<a href="#l76.190"></a><span id="l76.190" class="difflineplus">+ * Many things selected, middle-click on something that is not in that</span>
<a href="#l76.191"></a><span id="l76.191" class="difflineplus">+ *  selection.</span>
<a href="#l76.192"></a><span id="l76.192" class="difflineplus">+ */</span>
<a href="#l76.193"></a><span id="l76.193" class="difflineplus">+function test_middle_click_with_many_things_selected() {</span>
<a href="#l76.194"></a><span id="l76.194" class="difflineplus">+  be_in_folder(folder);</span>
<a href="#l76.195"></a><span id="l76.195" class="difflineplus">+</span>
<a href="#l76.196"></a><span id="l76.196" class="difflineplus">+  select_click_row(0);</span>
<a href="#l76.197"></a><span id="l76.197" class="difflineplus">+  select_shift_click_row(5);</span>
<a href="#l76.198"></a><span id="l76.198" class="difflineplus">+  assert_selected_and_displayed([0, 5]);</span>
<a href="#l76.199"></a><span id="l76.199" class="difflineplus">+</span>
<a href="#l76.200"></a><span id="l76.200" class="difflineplus">+  let [tabMessage, curMessage] = middle_click_on_row(1);</span>
<a href="#l76.201"></a><span id="l76.201" class="difflineplus">+  switch_tab(tabMessage);</span>
<a href="#l76.202"></a><span id="l76.202" class="difflineplus">+  assert_selected_and_displayed(curMessage);</span>
<a href="#l76.203"></a><span id="l76.203" class="difflineplus">+  close_tab(tabMessage);</span>
<a href="#l76.204"></a><span id="l76.204" class="difflineplus">+</span>
<a href="#l76.205"></a><span id="l76.205" class="difflineplus">+  assert_selected_and_displayed([0, 5]);</span>
<a href="#l76.206"></a><span id="l76.206" class="difflineplus">+}</span>
<a href="#l76.207"></a><span id="l76.207" class="difflineplus">+</span>
<a href="#l76.208"></a><span id="l76.208" class="difflineplus">+/**</span>
<a href="#l76.209"></a><span id="l76.209" class="difflineplus">+ * One thing selected, middle-click on that.</span>
<a href="#l76.210"></a><span id="l76.210" class="difflineplus">+ */</span>
<a href="#l76.211"></a><span id="l76.211" class="difflineplus">+function test_middle_click_on_existing_single_selection() {</span>
<a href="#l76.212"></a><span id="l76.212" class="difflineplus">+  be_in_folder(folder);</span>
<a href="#l76.213"></a><span id="l76.213" class="difflineplus">+</span>
<a href="#l76.214"></a><span id="l76.214" class="difflineplus">+  select_click_row(3);</span>
<a href="#l76.215"></a><span id="l76.215" class="difflineplus">+  assert_selected_and_displayed(3);</span>
<a href="#l76.216"></a><span id="l76.216" class="difflineplus">+</span>
<a href="#l76.217"></a><span id="l76.217" class="difflineplus">+  let [tabMessage, curMessage] = middle_click_on_row(3);</span>
<a href="#l76.218"></a><span id="l76.218" class="difflineplus">+  switch_tab(tabMessage);</span>
<a href="#l76.219"></a><span id="l76.219" class="difflineplus">+  assert_selected_and_displayed(curMessage);</span>
<a href="#l76.220"></a><span id="l76.220" class="difflineplus">+  close_tab(tabMessage);</span>
<a href="#l76.221"></a><span id="l76.221" class="difflineplus">+</span>
<a href="#l76.222"></a><span id="l76.222" class="difflineplus">+  assert_selected_and_displayed(3);</span>
<a href="#l76.223"></a><span id="l76.223" class="difflineplus">+}</span>
<a href="#l76.224"></a><span id="l76.224" class="difflineplus">+</span>
<a href="#l76.225"></a><span id="l76.225" class="difflineplus">+/**</span>
<a href="#l76.226"></a><span id="l76.226" class="difflineplus">+ * Many things selected, right-click somewhere in the selection.</span>
<a href="#l76.227"></a><span id="l76.227" class="difflineplus">+ */</span>
<a href="#l76.228"></a><span id="l76.228" class="difflineplus">+function test_middle_click_on_existing_multi_selection() {</span>
<a href="#l76.229"></a><span id="l76.229" class="difflineplus">+  be_in_folder(folder);</span>
<a href="#l76.230"></a><span id="l76.230" class="difflineplus">+</span>
<a href="#l76.231"></a><span id="l76.231" class="difflineplus">+  select_click_row(3);</span>
<a href="#l76.232"></a><span id="l76.232" class="difflineplus">+  select_shift_click_row(6);</span>
<a href="#l76.233"></a><span id="l76.233" class="difflineplus">+  assert_selected_and_displayed([3, 6]);</span>
<a href="#l76.234"></a><span id="l76.234" class="difflineplus">+</span>
<a href="#l76.235"></a><span id="l76.235" class="difflineplus">+  let [tabMessage, curMessage] = middle_click_on_row(5);</span>
<a href="#l76.236"></a><span id="l76.236" class="difflineplus">+  switch_tab(tabMessage);</span>
<a href="#l76.237"></a><span id="l76.237" class="difflineplus">+  assert_selected_and_displayed(curMessage);</span>
<a href="#l76.238"></a><span id="l76.238" class="difflineplus">+  close_tab(tabMessage);</span>
<a href="#l76.239"></a><span id="l76.239" class="difflineplus">+</span>
<a href="#l76.240"></a><span id="l76.240" class="difflineplus">+  assert_selected_and_displayed([3, 6]);</span>
<a href="#l76.241"></a><span id="l76.241" class="difflineplus">+}</span>
<a href="#l76.242"></a><span id="l76.242" class="difflineplus">+</span>
<a href="#l76.243"></a><span id="l76.243" class="difflineplus">+/**</span>
<a href="#l76.244"></a><span id="l76.244" class="difflineplus">+ * Right-click on something and delete it, having no selection previously.</span>
<a href="#l76.245"></a><span id="l76.245" class="difflineplus">+ */</span>
<a href="#l76.246"></a><span id="l76.246" class="difflineplus">+function test_right_click_deletion_nothing_selected() {</span>
<a href="#l76.247"></a><span id="l76.247" class="difflineplus">+  be_in_folder(folder);</span>
<a href="#l76.248"></a><span id="l76.248" class="difflineplus">+</span>
<a href="#l76.249"></a><span id="l76.249" class="difflineplus">+  select_none();</span>
<a href="#l76.250"></a><span id="l76.250" class="difflineplus">+  assert_selected_and_displayed();</span>
<a href="#l76.251"></a><span id="l76.251" class="difflineplus">+</span>
<a href="#l76.252"></a><span id="l76.252" class="difflineplus">+  let delMessage = right_click_on_row(3);</span>
<a href="#l76.253"></a><span id="l76.253" class="difflineplus">+  delete_via_popup();</span>
<a href="#l76.254"></a><span id="l76.254" class="difflineplus">+  // eh, might as well make sure the deletion worked while we are here</span>
<a href="#l76.255"></a><span id="l76.255" class="difflineplus">+  assert_message_not_in_view(delMessage);</span>
<a href="#l76.256"></a><span id="l76.256" class="difflineplus">+</span>
<a href="#l76.257"></a><span id="l76.257" class="difflineplus">+  assert_selected_and_displayed();</span>
<a href="#l76.258"></a><span id="l76.258" class="difflineplus">+}</span>
<a href="#l76.259"></a><span id="l76.259" class="difflineplus">+</span>
<a href="#l76.260"></a><span id="l76.260" class="difflineplus">+/**</span>
<a href="#l76.261"></a><span id="l76.261" class="difflineplus">+ * We want to make sure that the selection post-delete still includes the same</span>
<a href="#l76.262"></a><span id="l76.262" class="difflineplus">+ *  message (and that it is displayed).  In order for this to be interesting,</span>
<a href="#l76.263"></a><span id="l76.263" class="difflineplus">+ *  we want to make sure that we right-click delete a message above the selected</span>
<a href="#l76.264"></a><span id="l76.264" class="difflineplus">+ *  message so there is a shift in row numbering.</span>
<a href="#l76.265"></a><span id="l76.265" class="difflineplus">+ */</span>
<a href="#l76.266"></a><span id="l76.266" class="difflineplus">+function test_right_click_deletion_one_other_thing_selected() {</span>
<a href="#l76.267"></a><span id="l76.267" class="difflineplus">+  be_in_folder(folder);</span>
<a href="#l76.268"></a><span id="l76.268" class="difflineplus">+</span>
<a href="#l76.269"></a><span id="l76.269" class="difflineplus">+  let curMessage = select_click_row(5);</span>
<a href="#l76.270"></a><span id="l76.270" class="difflineplus">+</span>
<a href="#l76.271"></a><span id="l76.271" class="difflineplus">+  let delMessage = right_click_on_row(3);</span>
<a href="#l76.272"></a><span id="l76.272" class="difflineplus">+  delete_via_popup();</span>
<a href="#l76.273"></a><span id="l76.273" class="difflineplus">+  assert_message_not_in_view(delMessage);</span>
<a href="#l76.274"></a><span id="l76.274" class="difflineplus">+</span>
<a href="#l76.275"></a><span id="l76.275" class="difflineplus">+  assert_selected_and_displayed(curMessage);</span>
<a href="#l76.276"></a><span id="l76.276" class="difflineplus">+}</span>
<a href="#l76.277"></a><span id="l76.277" class="difflineplus">+</span>
<a href="#l76.278"></a><span id="l76.278" class="difflineplus">+function test_right_click_deletion_many_other_things_selected() {</span>
<a href="#l76.279"></a><span id="l76.279" class="difflineplus">+  be_in_folder(folder);</span>
<a href="#l76.280"></a><span id="l76.280" class="difflineplus">+</span>
<a href="#l76.281"></a><span id="l76.281" class="difflineplus">+  select_click_row(4);</span>
<a href="#l76.282"></a><span id="l76.282" class="difflineplus">+  let messages = select_shift_click_row(6);</span>
<a href="#l76.283"></a><span id="l76.283" class="difflineplus">+</span>
<a href="#l76.284"></a><span id="l76.284" class="difflineplus">+  let delMessage = right_click_on_row(2);</span>
<a href="#l76.285"></a><span id="l76.285" class="difflineplus">+  delete_via_popup();</span>
<a href="#l76.286"></a><span id="l76.286" class="difflineplus">+  assert_message_not_in_view(delMessage);</span>
<a href="#l76.287"></a><span id="l76.287" class="difflineplus">+</span>
<a href="#l76.288"></a><span id="l76.288" class="difflineplus">+  assert_selected_and_displayed(messages);</span>
<a href="#l76.289"></a><span id="l76.289" class="difflineplus">+}</span>
<a href="#l76.290"></a><span id="l76.290" class="difflineplus">+</span>
<a href="#l76.291"></a><span id="l76.291" class="difflineplus">+function test_right_click_deletion_of_one_selected_thing() {</span>
<a href="#l76.292"></a><span id="l76.292" class="difflineplus">+  be_in_folder(folder);</span>
<a href="#l76.293"></a><span id="l76.293" class="difflineplus">+</span>
<a href="#l76.294"></a><span id="l76.294" class="difflineplus">+  let curMessage = select_click_row(2);</span>
<a href="#l76.295"></a><span id="l76.295" class="difflineplus">+</span>
<a href="#l76.296"></a><span id="l76.296" class="difflineplus">+  right_click_on_row(2);</span>
<a href="#l76.297"></a><span id="l76.297" class="difflineplus">+  delete_via_popup();</span>
<a href="#l76.298"></a><span id="l76.298" class="difflineplus">+  assert_message_not_in_view(curMessage);</span>
<a href="#l76.299"></a><span id="l76.299" class="difflineplus">+</span>
<a href="#l76.300"></a><span id="l76.300" class="difflineplus">+  if (!mc.folderDisplay.selectedCount)</span>
<a href="#l76.301"></a><span id="l76.301" class="difflineplus">+    throw new Error(&quot;We should have tried to select something!&quot;);</span>
<a href="#l76.302"></a><span id="l76.302" class="difflineplus">+}</span>
<a href="#l76.303"></a><span id="l76.303" class="difflineplus">+</span>
<a href="#l76.304"></a><span id="l76.304" class="difflineplus">+function test_right_click_deletion_of_many_selected_things() {</span>
<a href="#l76.305"></a><span id="l76.305" class="difflineplus">+  be_in_folder(folder);</span>
<a href="#l76.306"></a><span id="l76.306" class="difflineplus">+</span>
<a href="#l76.307"></a><span id="l76.307" class="difflineplus">+  select_click_row(2);</span>
<a href="#l76.308"></a><span id="l76.308" class="difflineplus">+  let messages = select_shift_click_row(4);</span>
<a href="#l76.309"></a><span id="l76.309" class="difflineplus">+</span>
<a href="#l76.310"></a><span id="l76.310" class="difflineplus">+  right_click_on_row(3);</span>
<a href="#l76.311"></a><span id="l76.311" class="difflineplus">+  delete_via_popup();</span>
<a href="#l76.312"></a><span id="l76.312" class="difflineplus">+  assert_messages_not_in_view(messages);</span>
<a href="#l76.313"></a><span id="l76.313" class="difflineplus">+</span>
<a href="#l76.314"></a><span id="l76.314" class="difflineplus">+  if (!mc.folderDisplay.selectedCount)</span>
<a href="#l76.315"></a><span id="l76.315" class="difflineplus">+    throw new Error(&quot;We should have tried to select something!&quot;);</span>
<a href="#l76.316"></a><span id="l76.316" class="difflineplus">+}</span>
<a href="#l76.317"></a><span id="l76.317" class="difflineplus">+</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l77.1"></a><span id="l77.1">new file mode 100644</span>
<a href="#l77.2"></a><span id="l77.2" class="difflineminus">--- /dev/null</span>
<a href="#l77.3"></a><span id="l77.3" class="difflineplus">+++ b/mail/test/mozmill/folder-display/test-selection.js</span>
<a href="#l77.4"></a><span id="l77.4" class="difflineat">@@ -0,0 +1,157 @@</span>
<a href="#l77.5"></a><span id="l77.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l77.6"></a><span id="l77.6" class="difflineplus">+ *   Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l77.7"></a><span id="l77.7" class="difflineplus">+ *</span>
<a href="#l77.8"></a><span id="l77.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l77.9"></a><span id="l77.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l77.10"></a><span id="l77.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l77.11"></a><span id="l77.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l77.12"></a><span id="l77.12" class="difflineplus">+ *</span>
<a href="#l77.13"></a><span id="l77.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l77.14"></a><span id="l77.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l77.15"></a><span id="l77.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l77.16"></a><span id="l77.16" class="difflineplus">+ * License.</span>
<a href="#l77.17"></a><span id="l77.17" class="difflineplus">+ *</span>
<a href="#l77.18"></a><span id="l77.18" class="difflineplus">+ * The Original Code is Thunderbird Mail Client.</span>
<a href="#l77.19"></a><span id="l77.19" class="difflineplus">+ *</span>
<a href="#l77.20"></a><span id="l77.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l77.21"></a><span id="l77.21" class="difflineplus">+ * Mozilla Messaging, Inc.</span>
<a href="#l77.22"></a><span id="l77.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l77.23"></a><span id="l77.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l77.24"></a><span id="l77.24" class="difflineplus">+ *</span>
<a href="#l77.25"></a><span id="l77.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l77.26"></a><span id="l77.26" class="difflineplus">+ *   Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a href="#l77.27"></a><span id="l77.27" class="difflineplus">+ *</span>
<a href="#l77.28"></a><span id="l77.28" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l77.29"></a><span id="l77.29" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l77.30"></a><span id="l77.30" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l77.31"></a><span id="l77.31" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l77.32"></a><span id="l77.32" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l77.33"></a><span id="l77.33" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l77.34"></a><span id="l77.34" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l77.35"></a><span id="l77.35" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l77.36"></a><span id="l77.36" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l77.37"></a><span id="l77.37" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l77.38"></a><span id="l77.38" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l77.39"></a><span id="l77.39" class="difflineplus">+ *</span>
<a href="#l77.40"></a><span id="l77.40" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l77.41"></a><span id="l77.41" class="difflineplus">+</span>
<a href="#l77.42"></a><span id="l77.42" class="difflineplus">+var MODULE_NAME = 'test-selection';</span>
<a href="#l77.43"></a><span id="l77.43" class="difflineplus">+</span>
<a href="#l77.44"></a><span id="l77.44" class="difflineplus">+var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l77.45"></a><span id="l77.45" class="difflineplus">+var MODULE_REQUIRES = ['folder-display-helpers'];</span>
<a href="#l77.46"></a><span id="l77.46" class="difflineplus">+</span>
<a href="#l77.47"></a><span id="l77.47" class="difflineplus">+// let us have 2 folders</span>
<a href="#l77.48"></a><span id="l77.48" class="difflineplus">+var folder = null, folder2 = null;</span>
<a href="#l77.49"></a><span id="l77.49" class="difflineplus">+</span>
<a href="#l77.50"></a><span id="l77.50" class="difflineplus">+var setupModule = function(module) {</span>
<a href="#l77.51"></a><span id="l77.51" class="difflineplus">+  let fdh = collector.getModule('folder-display-helpers');</span>
<a href="#l77.52"></a><span id="l77.52" class="difflineplus">+  fdh.installInto(module);</span>
<a href="#l77.53"></a><span id="l77.53" class="difflineplus">+</span>
<a href="#l77.54"></a><span id="l77.54" class="difflineplus">+  folder = create_folder(&quot;SelectionA&quot;);</span>
<a href="#l77.55"></a><span id="l77.55" class="difflineplus">+  folder2 = create_folder(&quot;SelectionB&quot;);</span>
<a href="#l77.56"></a><span id="l77.56" class="difflineplus">+  make_new_sets_in_folders([folder, folder2], [{count: 50}]);</span>
<a href="#l77.57"></a><span id="l77.57" class="difflineplus">+};</span>
<a href="#l77.58"></a><span id="l77.58" class="difflineplus">+</span>
<a href="#l77.59"></a><span id="l77.59" class="difflineplus">+// https://bugzilla.mozilla.org/show_bug.cgi?id=474701#c80</span>
<a href="#l77.60"></a><span id="l77.60" class="difflineplus">+function test_selection_on_entry() {</span>
<a href="#l77.61"></a><span id="l77.61" class="difflineplus">+  enter_folder(folder);</span>
<a href="#l77.62"></a><span id="l77.62" class="difflineplus">+  assert_nothing_selected();</span>
<a href="#l77.63"></a><span id="l77.63" class="difflineplus">+}</span>
<a href="#l77.64"></a><span id="l77.64" class="difflineplus">+</span>
<a href="#l77.65"></a><span id="l77.65" class="difflineplus">+function test_selection_extension() {</span>
<a href="#l77.66"></a><span id="l77.66" class="difflineplus">+  be_in_folder(folder);</span>
<a href="#l77.67"></a><span id="l77.67" class="difflineplus">+</span>
<a href="#l77.68"></a><span id="l77.68" class="difflineplus">+  // https://bugzilla.mozilla.org/show_bug.cgi?id=474701#c79 (was good)</span>
<a href="#l77.69"></a><span id="l77.69" class="difflineplus">+  select_click_row(1);</span>
<a href="#l77.70"></a><span id="l77.70" class="difflineplus">+  select_control_click_row(2);</span>
<a href="#l77.71"></a><span id="l77.71" class="difflineplus">+  press_delete();</span>
<a href="#l77.72"></a><span id="l77.72" class="difflineplus">+  assert_selected_and_displayed(1);</span>
<a href="#l77.73"></a><span id="l77.73" class="difflineplus">+  // https://bugzilla.mozilla.org/show_bug.cgi?id=474701#c79 (was bad)</span>
<a href="#l77.74"></a><span id="l77.74" class="difflineplus">+  select_click_row(2);</span>
<a href="#l77.75"></a><span id="l77.75" class="difflineplus">+  select_control_click_row(1);</span>
<a href="#l77.76"></a><span id="l77.76" class="difflineplus">+  press_delete();</span>
<a href="#l77.77"></a><span id="l77.77" class="difflineplus">+  assert_selected_and_displayed(1);</span>
<a href="#l77.78"></a><span id="l77.78" class="difflineplus">+</span>
<a href="#l77.79"></a><span id="l77.79" class="difflineplus">+  // https://bugzilla.mozilla.org/show_bug.cgi?id=474701#c87 first bit</span>
<a href="#l77.80"></a><span id="l77.80" class="difflineplus">+  press_delete();</span>
<a href="#l77.81"></a><span id="l77.81" class="difflineplus">+  assert_selected_and_displayed(1);</span>
<a href="#l77.82"></a><span id="l77.82" class="difflineplus">+}</span>
<a href="#l77.83"></a><span id="l77.83" class="difflineplus">+</span>
<a href="#l77.84"></a><span id="l77.84" class="difflineplus">+// https://bugzilla.mozilla.org/show_bug.cgi?id=474701#c87 last bit</span>
<a href="#l77.85"></a><span id="l77.85" class="difflineplus">+function test_selection_last_message_deleted() {</span>
<a href="#l77.86"></a><span id="l77.86" class="difflineplus">+  be_in_folder(folder);</span>
<a href="#l77.87"></a><span id="l77.87" class="difflineplus">+  select_click_row(-1);</span>
<a href="#l77.88"></a><span id="l77.88" class="difflineplus">+  press_delete();</span>
<a href="#l77.89"></a><span id="l77.89" class="difflineplus">+  assert_selected_and_displayed(-1);</span>
<a href="#l77.90"></a><span id="l77.90" class="difflineplus">+}</span>
<a href="#l77.91"></a><span id="l77.91" class="difflineplus">+</span>
<a href="#l77.92"></a><span id="l77.92" class="difflineplus">+</span>
<a href="#l77.93"></a><span id="l77.93" class="difflineplus">+function test_selection_persists_through_threading_changes() {</span>
<a href="#l77.94"></a><span id="l77.94" class="difflineplus">+  be_in_folder(folder);</span>
<a href="#l77.95"></a><span id="l77.95" class="difflineplus">+</span>
<a href="#l77.96"></a><span id="l77.96" class="difflineplus">+  make_display_unthreaded();</span>
<a href="#l77.97"></a><span id="l77.97" class="difflineplus">+  let message = select_click_row(3);</span>
<a href="#l77.98"></a><span id="l77.98" class="difflineplus">+  make_display_threaded();</span>
<a href="#l77.99"></a><span id="l77.99" class="difflineplus">+  assert_selected_and_displayed(message);</span>
<a href="#l77.100"></a><span id="l77.100" class="difflineplus">+  make_display_grouped();</span>
<a href="#l77.101"></a><span id="l77.101" class="difflineplus">+  assert_selected_and_displayed(message);</span>
<a href="#l77.102"></a><span id="l77.102" class="difflineplus">+}</span>
<a href="#l77.103"></a><span id="l77.103" class="difflineplus">+</span>
<a href="#l77.104"></a><span id="l77.104" class="difflineplus">+// https://bugzilla.mozilla.org/show_bug.cgi?id=474701#c82 2nd half</span>
<a href="#l77.105"></a><span id="l77.105" class="difflineplus">+function test_no_selection_persists_through_threading_changes() {</span>
<a href="#l77.106"></a><span id="l77.106" class="difflineplus">+  be_in_folder(folder);</span>
<a href="#l77.107"></a><span id="l77.107" class="difflineplus">+</span>
<a href="#l77.108"></a><span id="l77.108" class="difflineplus">+  make_display_unthreaded();</span>
<a href="#l77.109"></a><span id="l77.109" class="difflineplus">+  select_none();</span>
<a href="#l77.110"></a><span id="l77.110" class="difflineplus">+  make_display_threaded();</span>
<a href="#l77.111"></a><span id="l77.111" class="difflineplus">+  assert_nothing_selected();</span>
<a href="#l77.112"></a><span id="l77.112" class="difflineplus">+  make_display_grouped();</span>
<a href="#l77.113"></a><span id="l77.113" class="difflineplus">+  assert_nothing_selected();</span>
<a href="#l77.114"></a><span id="l77.114" class="difflineplus">+  make_display_unthreaded();</span>
<a href="#l77.115"></a><span id="l77.115" class="difflineplus">+}</span>
<a href="#l77.116"></a><span id="l77.116" class="difflineplus">+</span>
<a href="#l77.117"></a><span id="l77.117" class="difflineplus">+function test_selection_persists_through_folder_tab_changes() {</span>
<a href="#l77.118"></a><span id="l77.118" class="difflineplus">+  let tab1 = be_in_folder(folder);</span>
<a href="#l77.119"></a><span id="l77.119" class="difflineplus">+</span>
<a href="#l77.120"></a><span id="l77.120" class="difflineplus">+  select_click_row(2);</span>
<a href="#l77.121"></a><span id="l77.121" class="difflineplus">+</span>
<a href="#l77.122"></a><span id="l77.122" class="difflineplus">+  let tab2 = open_folder_in_new_tab(folder2);</span>
<a href="#l77.123"></a><span id="l77.123" class="difflineplus">+  assert_nothing_selected();</span>
<a href="#l77.124"></a><span id="l77.124" class="difflineplus">+</span>
<a href="#l77.125"></a><span id="l77.125" class="difflineplus">+  switch_tab(tab1);</span>
<a href="#l77.126"></a><span id="l77.126" class="difflineplus">+  assert_selected_and_displayed(2);</span>
<a href="#l77.127"></a><span id="l77.127" class="difflineplus">+</span>
<a href="#l77.128"></a><span id="l77.128" class="difflineplus">+  switch_tab(tab2);</span>
<a href="#l77.129"></a><span id="l77.129" class="difflineplus">+  assert_nothing_selected();</span>
<a href="#l77.130"></a><span id="l77.130" class="difflineplus">+  select_click_row(3);</span>
<a href="#l77.131"></a><span id="l77.131" class="difflineplus">+</span>
<a href="#l77.132"></a><span id="l77.132" class="difflineplus">+  switch_tab(tab1);</span>
<a href="#l77.133"></a><span id="l77.133" class="difflineplus">+  assert_selected_and_displayed(2);</span>
<a href="#l77.134"></a><span id="l77.134" class="difflineplus">+  select_shift_click_row(4); // 2-4 selected</span>
<a href="#l77.135"></a><span id="l77.135" class="difflineplus">+  assert_selected_and_displayed([2,4]); // ensures multi-message summary</span>
<a href="#l77.136"></a><span id="l77.136" class="difflineplus">+</span>
<a href="#l77.137"></a><span id="l77.137" class="difflineplus">+  switch_tab(tab2);</span>
<a href="#l77.138"></a><span id="l77.138" class="difflineplus">+  assert_selected_and_displayed(3);</span>
<a href="#l77.139"></a><span id="l77.139" class="difflineplus">+</span>
<a href="#l77.140"></a><span id="l77.140" class="difflineplus">+  close_tab(tab2);</span>
<a href="#l77.141"></a><span id="l77.141" class="difflineplus">+  assert_selected_and_displayed([2,4]);</span>
<a href="#l77.142"></a><span id="l77.142" class="difflineplus">+}</span>
<a href="#l77.143"></a><span id="l77.143" class="difflineplus">+</span>
<a href="#l77.144"></a><span id="l77.144" class="difflineplus">+// https://bugzilla.mozilla.org/show_bug.cgi?id=474701#c87</span>
<a href="#l77.145"></a><span id="l77.145" class="difflineplus">+/**</span>
<a href="#l77.146"></a><span id="l77.146" class="difflineplus">+ * Verify that we scroll to new messages when we enter a folder.</span>
<a href="#l77.147"></a><span id="l77.147" class="difflineplus">+ */</span>
<a href="#l77.148"></a><span id="l77.148" class="difflineplus">+function test_enter_scroll_to_new() {</span>
<a href="#l77.149"></a><span id="l77.149" class="difflineplus">+  // be in the folder</span>
<a href="#l77.150"></a><span id="l77.150" class="difflineplus">+  be_in_folder(folder);</span>
<a href="#l77.151"></a><span id="l77.151" class="difflineplus">+  // make sure the sort is ascending...</span>
<a href="#l77.152"></a><span id="l77.152" class="difflineplus">+  mc.folderDisplay.view.sortAscending();</span>
<a href="#l77.153"></a><span id="l77.153" class="difflineplus">+  // leave the folder so that the messages get marked as read</span>
<a href="#l77.154"></a><span id="l77.154" class="difflineplus">+  enter_folder(folder.rootFolder);</span>
<a href="#l77.155"></a><span id="l77.155" class="difflineplus">+  // add a new message, and make sure it is new</span>
<a href="#l77.156"></a><span id="l77.156" class="difflineplus">+  let newSet = make_new_sets_in_folder(folder, [{count: 1}]);</span>
<a href="#l77.157"></a><span id="l77.157" class="difflineplus">+  // enter the folder</span>
<a href="#l77.158"></a><span id="l77.158" class="difflineplus">+  enter_folder(folder);</span>
<a href="#l77.159"></a><span id="l77.159" class="difflineplus">+  // make sure it (which must be the last row) is visible</span>
<a href="#l77.160"></a><span id="l77.160" class="difflineplus">+  assert_visible(-1);</span>
<a href="#l77.161"></a><span id="l77.161" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l78.1"></a><span id="l78.1">new file mode 100644</span>
<a href="#l78.2"></a><span id="l78.2" class="difflineminus">--- /dev/null</span>
<a href="#l78.3"></a><span id="l78.3" class="difflineplus">+++ b/mail/test/mozmill/folder-display/test-summarization.js</span>
<a href="#l78.4"></a><span id="l78.4" class="difflineat">@@ -0,0 +1,221 @@</span>
<a href="#l78.5"></a><span id="l78.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l78.6"></a><span id="l78.6" class="difflineplus">+ *   Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l78.7"></a><span id="l78.7" class="difflineplus">+ *</span>
<a href="#l78.8"></a><span id="l78.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l78.9"></a><span id="l78.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l78.10"></a><span id="l78.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l78.11"></a><span id="l78.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l78.12"></a><span id="l78.12" class="difflineplus">+ *</span>
<a href="#l78.13"></a><span id="l78.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l78.14"></a><span id="l78.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l78.15"></a><span id="l78.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l78.16"></a><span id="l78.16" class="difflineplus">+ * License.</span>
<a href="#l78.17"></a><span id="l78.17" class="difflineplus">+ *</span>
<a href="#l78.18"></a><span id="l78.18" class="difflineplus">+ * The Original Code is Thunderbird Mail Client.</span>
<a href="#l78.19"></a><span id="l78.19" class="difflineplus">+ *</span>
<a href="#l78.20"></a><span id="l78.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l78.21"></a><span id="l78.21" class="difflineplus">+ * Mozilla Messaging, Inc.</span>
<a href="#l78.22"></a><span id="l78.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l78.23"></a><span id="l78.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l78.24"></a><span id="l78.24" class="difflineplus">+ *</span>
<a href="#l78.25"></a><span id="l78.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l78.26"></a><span id="l78.26" class="difflineplus">+ *   Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a href="#l78.27"></a><span id="l78.27" class="difflineplus">+ *</span>
<a href="#l78.28"></a><span id="l78.28" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l78.29"></a><span id="l78.29" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l78.30"></a><span id="l78.30" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l78.31"></a><span id="l78.31" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l78.32"></a><span id="l78.32" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l78.33"></a><span id="l78.33" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l78.34"></a><span id="l78.34" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l78.35"></a><span id="l78.35" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l78.36"></a><span id="l78.36" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l78.37"></a><span id="l78.37" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l78.38"></a><span id="l78.38" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l78.39"></a><span id="l78.39" class="difflineplus">+ *</span>
<a href="#l78.40"></a><span id="l78.40" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l78.41"></a><span id="l78.41" class="difflineplus">+</span>
<a href="#l78.42"></a><span id="l78.42" class="difflineplus">+/**</span>
<a href="#l78.43"></a><span id="l78.43" class="difflineplus">+ * Test that summarization happens at the right time, that it clears itself at</span>
<a href="#l78.44"></a><span id="l78.44" class="difflineplus">+ *  the right time, that it waits for selection stability when recently</span>
<a href="#l78.45"></a><span id="l78.45" class="difflineplus">+ *  summarized, and that summarization does not break under tabbing.</span>
<a href="#l78.46"></a><span id="l78.46" class="difflineplus">+ *</span>
<a href="#l78.47"></a><span id="l78.47" class="difflineplus">+ * Because most of the legwork is done automatically by</span>
<a href="#l78.48"></a><span id="l78.48" class="difflineplus">+ *  test-folder-display-helpers, the more basic tests may look like general</span>
<a href="#l78.49"></a><span id="l78.49" class="difflineplus">+ *  selection / tabbing tests, but are intended to specifically exercise the</span>
<a href="#l78.50"></a><span id="l78.50" class="difflineplus">+ *  summarization logic and edge cases.  (Although general selection tests and</span>
<a href="#l78.51"></a><span id="l78.51" class="difflineplus">+ *  tab tests may do the same thing too...)</span>
<a href="#l78.52"></a><span id="l78.52" class="difflineplus">+ *</span>
<a href="#l78.53"></a><span id="l78.53" class="difflineplus">+ * Things we don't test but should:</span>
<a href="#l78.54"></a><span id="l78.54" class="difflineplus">+ * - The difference between thread summary and multi-message summary.</span>
<a href="#l78.55"></a><span id="l78.55" class="difflineplus">+ */</span>
<a href="#l78.56"></a><span id="l78.56" class="difflineplus">+</span>
<a href="#l78.57"></a><span id="l78.57" class="difflineplus">+var MODULE_NAME = 'test-summarization';</span>
<a href="#l78.58"></a><span id="l78.58" class="difflineplus">+</span>
<a href="#l78.59"></a><span id="l78.59" class="difflineplus">+var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l78.60"></a><span id="l78.60" class="difflineplus">+var MODULE_REQUIRES = ['folder-display-helpers'];</span>
<a href="#l78.61"></a><span id="l78.61" class="difflineplus">+</span>
<a href="#l78.62"></a><span id="l78.62" class="difflineplus">+var folder;</span>
<a href="#l78.63"></a><span id="l78.63" class="difflineplus">+var thread1, thread2, msg1, msg2;</span>
<a href="#l78.64"></a><span id="l78.64" class="difflineplus">+</span>
<a href="#l78.65"></a><span id="l78.65" class="difflineplus">+var setupModule = function(module) {</span>
<a href="#l78.66"></a><span id="l78.66" class="difflineplus">+  let fdh = collector.getModule('folder-display-helpers');</span>
<a href="#l78.67"></a><span id="l78.67" class="difflineplus">+  fdh.installInto(module);</span>
<a href="#l78.68"></a><span id="l78.68" class="difflineplus">+</span>
<a href="#l78.69"></a><span id="l78.69" class="difflineplus">+  folder = create_folder(&quot;SummarizationA&quot;);</span>
<a href="#l78.70"></a><span id="l78.70" class="difflineplus">+  thread1 = create_thread(10);</span>
<a href="#l78.71"></a><span id="l78.71" class="difflineplus">+  msg1 = create_thread(1);</span>
<a href="#l78.72"></a><span id="l78.72" class="difflineplus">+  thread2 = create_thread(10);</span>
<a href="#l78.73"></a><span id="l78.73" class="difflineplus">+  msg2 = create_thread(1);</span>
<a href="#l78.74"></a><span id="l78.74" class="difflineplus">+  add_sets_to_folders([folder], [thread1, msg1, thread2, msg2]);</span>
<a href="#l78.75"></a><span id="l78.75" class="difflineplus">+};</span>
<a href="#l78.76"></a><span id="l78.76" class="difflineplus">+</span>
<a href="#l78.77"></a><span id="l78.77" class="difflineplus">+function test_basic_summarization() {</span>
<a href="#l78.78"></a><span id="l78.78" class="difflineplus">+  be_in_folder(folder);</span>
<a href="#l78.79"></a><span id="l78.79" class="difflineplus">+</span>
<a href="#l78.80"></a><span id="l78.80" class="difflineplus">+  // - make sure we get a summary</span>
<a href="#l78.81"></a><span id="l78.81" class="difflineplus">+  select_click_row(0);</span>
<a href="#l78.82"></a><span id="l78.82" class="difflineplus">+  select_shift_click_row(5);</span>
<a href="#l78.83"></a><span id="l78.83" class="difflineplus">+  // this will verify a multi-message display is happening</span>
<a href="#l78.84"></a><span id="l78.84" class="difflineplus">+  assert_selected_and_displayed([0, 5]);</span>
<a href="#l78.85"></a><span id="l78.85" class="difflineplus">+}</span>
<a href="#l78.86"></a><span id="l78.86" class="difflineplus">+</span>
<a href="#l78.87"></a><span id="l78.87" class="difflineplus">+function test_summarization_goes_away() {</span>
<a href="#l78.88"></a><span id="l78.88" class="difflineplus">+  select_none();</span>
<a href="#l78.89"></a><span id="l78.89" class="difflineplus">+  assert_nothing_selected();</span>
<a href="#l78.90"></a><span id="l78.90" class="difflineplus">+}</span>
<a href="#l78.91"></a><span id="l78.91" class="difflineplus">+</span>
<a href="#l78.92"></a><span id="l78.92" class="difflineplus">+/**</span>
<a href="#l78.93"></a><span id="l78.93" class="difflineplus">+ * Verify that we update summarization when switching amongst tabs.</span>
<a href="#l78.94"></a><span id="l78.94" class="difflineplus">+ */</span>
<a href="#l78.95"></a><span id="l78.95" class="difflineplus">+function test_folder_tabs_update_correctly() {</span>
<a href="#l78.96"></a><span id="l78.96" class="difflineplus">+  // tab with summary</span>
<a href="#l78.97"></a><span id="l78.97" class="difflineplus">+  let tabA = be_in_folder(folder);</span>
<a href="#l78.98"></a><span id="l78.98" class="difflineplus">+  select_click_row(0);</span>
<a href="#l78.99"></a><span id="l78.99" class="difflineplus">+  select_control_click_row(2);</span>
<a href="#l78.100"></a><span id="l78.100" class="difflineplus">+  assert_selected_and_displayed(0, 2);</span>
<a href="#l78.101"></a><span id="l78.101" class="difflineplus">+</span>
<a href="#l78.102"></a><span id="l78.102" class="difflineplus">+  // tab with nothing</span>
<a href="#l78.103"></a><span id="l78.103" class="difflineplus">+  let tabB = open_folder_in_new_tab(folder);</span>
<a href="#l78.104"></a><span id="l78.104" class="difflineplus">+  assert_nothing_selected();</span>
<a href="#l78.105"></a><span id="l78.105" class="difflineplus">+</span>
<a href="#l78.106"></a><span id="l78.106" class="difflineplus">+  // correct changes, none &lt;=&gt; summary</span>
<a href="#l78.107"></a><span id="l78.107" class="difflineplus">+  switch_tab(tabA);</span>
<a href="#l78.108"></a><span id="l78.108" class="difflineplus">+  assert_selected_and_displayed(0, 2);</span>
<a href="#l78.109"></a><span id="l78.109" class="difflineplus">+  switch_tab(tabB);</span>
<a href="#l78.110"></a><span id="l78.110" class="difflineplus">+  assert_nothing_selected();</span>
<a href="#l78.111"></a><span id="l78.111" class="difflineplus">+</span>
<a href="#l78.112"></a><span id="l78.112" class="difflineplus">+  // correct changes, one &lt;=&gt; summary</span>
<a href="#l78.113"></a><span id="l78.113" class="difflineplus">+  select_click_row(0);</span>
<a href="#l78.114"></a><span id="l78.114" class="difflineplus">+  assert_selected_and_displayed(0);</span>
<a href="#l78.115"></a><span id="l78.115" class="difflineplus">+  switch_tab(tabA);</span>
<a href="#l78.116"></a><span id="l78.116" class="difflineplus">+  assert_selected_and_displayed(0, 2);</span>
<a href="#l78.117"></a><span id="l78.117" class="difflineplus">+  switch_tab(tabB);</span>
<a href="#l78.118"></a><span id="l78.118" class="difflineplus">+  assert_selected_and_displayed(0);</span>
<a href="#l78.119"></a><span id="l78.119" class="difflineplus">+</span>
<a href="#l78.120"></a><span id="l78.120" class="difflineplus">+  // correct changes, summary &lt;=&gt; summary</span>
<a href="#l78.121"></a><span id="l78.121" class="difflineplus">+  select_shift_click_row(3);</span>
<a href="#l78.122"></a><span id="l78.122" class="difflineplus">+  assert_selected_and_displayed([0, 3]);</span>
<a href="#l78.123"></a><span id="l78.123" class="difflineplus">+  switch_tab(tabA);</span>
<a href="#l78.124"></a><span id="l78.124" class="difflineplus">+  assert_selected_and_displayed(0, 2);</span>
<a href="#l78.125"></a><span id="l78.125" class="difflineplus">+  switch_tab(tabB);</span>
<a href="#l78.126"></a><span id="l78.126" class="difflineplus">+  assert_selected_and_displayed([0, 3]);</span>
<a href="#l78.127"></a><span id="l78.127" class="difflineplus">+</span>
<a href="#l78.128"></a><span id="l78.128" class="difflineplus">+  // closing tab returns state correctly...</span>
<a href="#l78.129"></a><span id="l78.129" class="difflineplus">+  close_tab(tabB);</span>
<a href="#l78.130"></a><span id="l78.130" class="difflineplus">+  assert_selected_and_displayed(0, 2);</span>
<a href="#l78.131"></a><span id="l78.131" class="difflineplus">+}</span>
<a href="#l78.132"></a><span id="l78.132" class="difflineplus">+</span>
<a href="#l78.133"></a><span id="l78.133" class="difflineplus">+function test_message_tabs_update_correctly() {</span>
<a href="#l78.134"></a><span id="l78.134" class="difflineplus">+  let tabFolder = be_in_folder(folder);</span>
<a href="#l78.135"></a><span id="l78.135" class="difflineplus">+  let message = select_click_row(0);</span>
<a href="#l78.136"></a><span id="l78.136" class="difflineplus">+  assert_selected_and_displayed(0);</span>
<a href="#l78.137"></a><span id="l78.137" class="difflineplus">+</span>
<a href="#l78.138"></a><span id="l78.138" class="difflineplus">+  let tabMessage = open_selected_message_in_new_tab();</span>
<a href="#l78.139"></a><span id="l78.139" class="difflineplus">+  assert_selected_and_displayed(message);</span>
<a href="#l78.140"></a><span id="l78.140" class="difflineplus">+</span>
<a href="#l78.141"></a><span id="l78.141" class="difflineplus">+  switch_tab(tabFolder);</span>
<a href="#l78.142"></a><span id="l78.142" class="difflineplus">+  select_shift_click_row(2);</span>
<a href="#l78.143"></a><span id="l78.143" class="difflineplus">+  assert_selected_and_displayed([0, 2]);</span>
<a href="#l78.144"></a><span id="l78.144" class="difflineplus">+</span>
<a href="#l78.145"></a><span id="l78.145" class="difflineplus">+  switch_tab(tabMessage);</span>
<a href="#l78.146"></a><span id="l78.146" class="difflineplus">+  assert_selected_and_displayed(message);</span>
<a href="#l78.147"></a><span id="l78.147" class="difflineplus">+</span>
<a href="#l78.148"></a><span id="l78.148" class="difflineplus">+  switch_tab(tabFolder);</span>
<a href="#l78.149"></a><span id="l78.149" class="difflineplus">+  assert_selected_and_displayed([0, 2]);</span>
<a href="#l78.150"></a><span id="l78.150" class="difflineplus">+</span>
<a href="#l78.151"></a><span id="l78.151" class="difflineplus">+  close_tab(tabMessage);</span>
<a href="#l78.152"></a><span id="l78.152" class="difflineplus">+}</span>
<a href="#l78.153"></a><span id="l78.153" class="difflineplus">+</span>
<a href="#l78.154"></a><span id="l78.154" class="difflineplus">+/**</span>
<a href="#l78.155"></a><span id="l78.155" class="difflineplus">+ * Test the stabilization logic by making the stabilization interval absurd and</span>
<a href="#l78.156"></a><span id="l78.156" class="difflineplus">+ *  then manually clearing things up.</span>
<a href="#l78.157"></a><span id="l78.157" class="difflineplus">+ */</span>
<a href="#l78.158"></a><span id="l78.158" class="difflineplus">+function test_selection_stabilization_logic() {</span>
<a href="#l78.159"></a><span id="l78.159" class="difflineplus">+  // make sure all summarization has run to completion.</span>
<a href="#l78.160"></a><span id="l78.160" class="difflineplus">+  mc.sleep(0);</span>
<a href="#l78.161"></a><span id="l78.161" class="difflineplus">+  // make it inconceivable that the timeout happens.</span>
<a href="#l78.162"></a><span id="l78.162" class="difflineplus">+  mc.window.MessageDisplayWidget.prototype</span>
<a href="#l78.163"></a><span id="l78.163" class="difflineplus">+    .SUMMARIZATION_SELECTION_STABILITY_INTERVAL_MS = 10000;</span>
<a href="#l78.164"></a><span id="l78.164" class="difflineplus">+  // does not summarize anything, does not affect timer</span>
<a href="#l78.165"></a><span id="l78.165" class="difflineplus">+  select_click_row(0);</span>
<a href="#l78.166"></a><span id="l78.166" class="difflineplus">+  // does summarize things.  timer will be tick tick ticking!</span>
<a href="#l78.167"></a><span id="l78.167" class="difflineplus">+  select_shift_click_row(1);</span>
<a href="#l78.168"></a><span id="l78.168" class="difflineplus">+  // verify that things were summarized...</span>
<a href="#l78.169"></a><span id="l78.169" class="difflineplus">+  assert_selected_and_displayed([0, 1]);</span>
<a href="#l78.170"></a><span id="l78.170" class="difflineplus">+  // save the set of messages so we can verify the summary sticks to this.</span>
<a href="#l78.171"></a><span id="l78.171" class="difflineplus">+  let messages = mc.folderDisplay.selectedMessages;</span>
<a href="#l78.172"></a><span id="l78.172" class="difflineplus">+</span>
<a href="#l78.173"></a><span id="l78.173" class="difflineplus">+  // make sure the</span>
<a href="#l78.174"></a><span id="l78.174" class="difflineplus">+</span>
<a href="#l78.175"></a><span id="l78.175" class="difflineplus">+  // this will not summarize!</span>
<a href="#l78.176"></a><span id="l78.176" class="difflineplus">+  select_shift_click_row(2);</span>
<a href="#l78.177"></a><span id="l78.177" class="difflineplus">+  // verify that our summary is still just 0 and 1.</span>
<a href="#l78.178"></a><span id="l78.178" class="difflineplus">+  assert_selection_summarized(mc, messages);</span>
<a href="#l78.179"></a><span id="l78.179" class="difflineplus">+</span>
<a href="#l78.180"></a><span id="l78.180" class="difflineplus">+  // - put it back, the way it was</span>
<a href="#l78.181"></a><span id="l78.181" class="difflineplus">+  // oh put it back the way it was</span>
<a href="#l78.182"></a><span id="l78.182" class="difflineplus">+  // ...</span>
<a href="#l78.183"></a><span id="l78.183" class="difflineplus">+  // That's right folks, a 'Lil Abner reference.</span>
<a href="#l78.184"></a><span id="l78.184" class="difflineplus">+  // ...</span>
<a href="#l78.185"></a><span id="l78.185" class="difflineplus">+  // Culture!</span>
<a href="#l78.186"></a><span id="l78.186" class="difflineplus">+  // ...</span>
<a href="#l78.187"></a><span id="l78.187" class="difflineplus">+  // I'm already embarassed I wrote that.</span>
<a href="#l78.188"></a><span id="l78.188" class="difflineplus">+  mc.window.MessageDisplayWidget.prototype</span>
<a href="#l78.189"></a><span id="l78.189" class="difflineplus">+    .SUMMARIZATION_SELECTION_STABILITY_INTERVAL_MS = 0;</span>
<a href="#l78.190"></a><span id="l78.190" class="difflineplus">+  // (we did that because the stability logic is going to schedule another guard</span>
<a href="#l78.191"></a><span id="l78.191" class="difflineplus">+  //  timer when we manually trigger it, and we want that to clear immediately.)</span>
<a href="#l78.192"></a><span id="l78.192" class="difflineplus">+</span>
<a href="#l78.193"></a><span id="l78.193" class="difflineplus">+  // - pretend the timer fired.</span>
<a href="#l78.194"></a><span id="l78.194" class="difflineplus">+  // we need to de-schedule the timer, but do not need to clear the variable</span>
<a href="#l78.195"></a><span id="l78.195" class="difflineplus">+  //  because it will just get overwritten anyways</span>
<a href="#l78.196"></a><span id="l78.196" class="difflineplus">+  mc.window.clearTimeout(mc.messageDisplay._summaryStabilityTimeout);</span>
<a href="#l78.197"></a><span id="l78.197" class="difflineplus">+  mc.messageDisplay._showSummary(true);</span>
<a href="#l78.198"></a><span id="l78.198" class="difflineplus">+</span>
<a href="#l78.199"></a><span id="l78.199" class="difflineplus">+  // - the summary should now be up-to-date</span>
<a href="#l78.200"></a><span id="l78.200" class="difflineplus">+  assert_selected_and_displayed([0, 2]);</span>
<a href="#l78.201"></a><span id="l78.201" class="difflineplus">+}</span>
<a href="#l78.202"></a><span id="l78.202" class="difflineplus">+</span>
<a href="#l78.203"></a><span id="l78.203" class="difflineplus">+</span>
<a href="#l78.204"></a><span id="l78.204" class="difflineplus">+function test_summarization_thread_detection() {</span>
<a href="#l78.205"></a><span id="l78.205" class="difflineplus">+  select_none();</span>
<a href="#l78.206"></a><span id="l78.206" class="difflineplus">+  assert_nothing_selected();</span>
<a href="#l78.207"></a><span id="l78.207" class="difflineplus">+  make_display_threaded();</span>
<a href="#l78.208"></a><span id="l78.208" class="difflineplus">+  select_click_row(0);</span>
<a href="#l78.209"></a><span id="l78.209" class="difflineplus">+  select_shift_click_row(9);</span>
<a href="#l78.210"></a><span id="l78.210" class="difflineplus">+  let messages = mc.folderDisplay.selectedMessages;</span>
<a href="#l78.211"></a><span id="l78.211" class="difflineplus">+  toggle_thread_row(0);</span>
<a href="#l78.212"></a><span id="l78.212" class="difflineplus">+  assert_selection_summarized(mc, messages);</span>
<a href="#l78.213"></a><span id="l78.213" class="difflineplus">+  // count the number of messages represented</span>
<a href="#l78.214"></a><span id="l78.214" class="difflineplus">+  assert_summary_contains_N_divs('wrappedsender', 10);</span>
<a href="#l78.215"></a><span id="l78.215" class="difflineplus">+  select_shift_click_row(1);</span>
<a href="#l78.216"></a><span id="l78.216" class="difflineplus">+  // this should have shifted to the multi-message view</span>
<a href="#l78.217"></a><span id="l78.217" class="difflineplus">+  assert_summary_contains_N_divs('wrappedsender', 0);</span>
<a href="#l78.218"></a><span id="l78.218" class="difflineplus">+  assert_summary_contains_N_divs('wrappedsubject', 2);</span>
<a href="#l78.219"></a><span id="l78.219" class="difflineplus">+  select_none();</span>
<a href="#l78.220"></a><span id="l78.220" class="difflineplus">+  assert_nothing_selected();</span>
<a href="#l78.221"></a><span id="l78.221" class="difflineplus">+  select_click_row(1); // select a single message</span>
<a href="#l78.222"></a><span id="l78.222" class="difflineplus">+  select_shift_click_row(2); // add a thread</span>
<a href="#l78.223"></a><span id="l78.223" class="difflineplus">+  assert_summary_contains_N_divs('wrappedsender', 0);</span>
<a href="#l78.224"></a><span id="l78.224" class="difflineplus">+  assert_summary_contains_N_divs('wrappedsubject', 2);</span>
<a href="#l78.225"></a><span id="l78.225" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l79.1"></a><span id="l79.1">new file mode 100644</span>
<a href="#l79.2"></a><span id="l79.2" class="difflineminus">--- /dev/null</span>
<a href="#l79.3"></a><span id="l79.3" class="difflineplus">+++ b/mail/test/mozmill/folder-display/test-tabs-simple.js</span>
<a href="#l79.4"></a><span id="l79.4" class="difflineat">@@ -0,0 +1,178 @@</span>
<a href="#l79.5"></a><span id="l79.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l79.6"></a><span id="l79.6" class="difflineplus">+ *   Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l79.7"></a><span id="l79.7" class="difflineplus">+ *</span>
<a href="#l79.8"></a><span id="l79.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l79.9"></a><span id="l79.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l79.10"></a><span id="l79.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l79.11"></a><span id="l79.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l79.12"></a><span id="l79.12" class="difflineplus">+ *</span>
<a href="#l79.13"></a><span id="l79.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l79.14"></a><span id="l79.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l79.15"></a><span id="l79.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l79.16"></a><span id="l79.16" class="difflineplus">+ * License.</span>
<a href="#l79.17"></a><span id="l79.17" class="difflineplus">+ *</span>
<a href="#l79.18"></a><span id="l79.18" class="difflineplus">+ * The Original Code is Thunderbird Mail Client.</span>
<a href="#l79.19"></a><span id="l79.19" class="difflineplus">+ *</span>
<a href="#l79.20"></a><span id="l79.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l79.21"></a><span id="l79.21" class="difflineplus">+ * Mozilla Messaging, Inc.</span>
<a href="#l79.22"></a><span id="l79.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l79.23"></a><span id="l79.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l79.24"></a><span id="l79.24" class="difflineplus">+ *</span>
<a href="#l79.25"></a><span id="l79.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l79.26"></a><span id="l79.26" class="difflineplus">+ *   Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a href="#l79.27"></a><span id="l79.27" class="difflineplus">+ *</span>
<a href="#l79.28"></a><span id="l79.28" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l79.29"></a><span id="l79.29" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l79.30"></a><span id="l79.30" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l79.31"></a><span id="l79.31" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l79.32"></a><span id="l79.32" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l79.33"></a><span id="l79.33" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l79.34"></a><span id="l79.34" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l79.35"></a><span id="l79.35" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l79.36"></a><span id="l79.36" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l79.37"></a><span id="l79.37" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l79.38"></a><span id="l79.38" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l79.39"></a><span id="l79.39" class="difflineplus">+ *</span>
<a href="#l79.40"></a><span id="l79.40" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l79.41"></a><span id="l79.41" class="difflineplus">+</span>
<a href="#l79.42"></a><span id="l79.42" class="difflineplus">+/*</span>
<a href="#l79.43"></a><span id="l79.43" class="difflineplus">+ * Test that opening new folder and message tabs has the expected result and</span>
<a href="#l79.44"></a><span id="l79.44" class="difflineplus">+ *  that closing them doesn't break anything.</span>
<a href="#l79.45"></a><span id="l79.45" class="difflineplus">+ */</span>
<a href="#l79.46"></a><span id="l79.46" class="difflineplus">+var MODULE_NAME = 'test-tabs-simple';</span>
<a href="#l79.47"></a><span id="l79.47" class="difflineplus">+</span>
<a href="#l79.48"></a><span id="l79.48" class="difflineplus">+var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l79.49"></a><span id="l79.49" class="difflineplus">+var MODULE_REQUIRES = ['folder-display-helpers', 'window-helpers'];</span>
<a href="#l79.50"></a><span id="l79.50" class="difflineplus">+</span>
<a href="#l79.51"></a><span id="l79.51" class="difflineplus">+var folderA, folderB, setA, setB;</span>
<a href="#l79.52"></a><span id="l79.52" class="difflineplus">+</span>
<a href="#l79.53"></a><span id="l79.53" class="difflineplus">+function setupModule(module) {</span>
<a href="#l79.54"></a><span id="l79.54" class="difflineplus">+  let fdh = collector.getModule('folder-display-helpers');</span>
<a href="#l79.55"></a><span id="l79.55" class="difflineplus">+  fdh.installInto(module);</span>
<a href="#l79.56"></a><span id="l79.56" class="difflineplus">+  let wh = collector.getModule('window-helpers');</span>
<a href="#l79.57"></a><span id="l79.57" class="difflineplus">+  wh.installInto(module);</span>
<a href="#l79.58"></a><span id="l79.58" class="difflineplus">+</span>
<a href="#l79.59"></a><span id="l79.59" class="difflineplus">+  folderA = create_folder(&quot;TabsSimpleA&quot;);</span>
<a href="#l79.60"></a><span id="l79.60" class="difflineplus">+  folderB = create_folder(&quot;TabsSimpleB&quot;);</span>
<a href="#l79.61"></a><span id="l79.61" class="difflineplus">+</span>
<a href="#l79.62"></a><span id="l79.62" class="difflineplus">+  // We will verify we are seeing the right folder by checking that it has the</span>
<a href="#l79.63"></a><span id="l79.63" class="difflineplus">+  //  right messages in it.</span>
<a href="#l79.64"></a><span id="l79.64" class="difflineplus">+  [setA] = make_new_sets_in_folder(folderA, [{}]);</span>
<a href="#l79.65"></a><span id="l79.65" class="difflineplus">+  [setB] = make_new_sets_in_folder(folderB, [{}]);</span>
<a href="#l79.66"></a><span id="l79.66" class="difflineplus">+}</span>
<a href="#l79.67"></a><span id="l79.67" class="difflineplus">+</span>
<a href="#l79.68"></a><span id="l79.68" class="difflineplus">+/** The tabs in our test. */</span>
<a href="#l79.69"></a><span id="l79.69" class="difflineplus">+var tabFolderA, tabFolderB, tabMessageA, tabMessageB;</span>
<a href="#l79.70"></a><span id="l79.70" class="difflineplus">+/** The message that we selected for tab display, to check it worked right. */</span>
<a href="#l79.71"></a><span id="l79.71" class="difflineplus">+var messageA, messageB;</span>
<a href="#l79.72"></a><span id="l79.72" class="difflineplus">+</span>
<a href="#l79.73"></a><span id="l79.73" class="difflineplus">+/**</span>
<a href="#l79.74"></a><span id="l79.74" class="difflineplus">+ * Make sure the default tab works right.</span>
<a href="#l79.75"></a><span id="l79.75" class="difflineplus">+ */</span>
<a href="#l79.76"></a><span id="l79.76" class="difflineplus">+function test_open_folder_a() {</span>
<a href="#l79.77"></a><span id="l79.77" class="difflineplus">+  tabFolderA = be_in_folder(folderA);</span>
<a href="#l79.78"></a><span id="l79.78" class="difflineplus">+  assert_messages_in_view(setA);</span>
<a href="#l79.79"></a><span id="l79.79" class="difflineplus">+  assert_nothing_selected();</span>
<a href="#l79.80"></a><span id="l79.80" class="difflineplus">+}</span>
<a href="#l79.81"></a><span id="l79.81" class="difflineplus">+</span>
<a href="#l79.82"></a><span id="l79.82" class="difflineplus">+/**</span>
<a href="#l79.83"></a><span id="l79.83" class="difflineplus">+ * Open tab b, make sure it works right.</span>
<a href="#l79.84"></a><span id="l79.84" class="difflineplus">+ */</span>
<a href="#l79.85"></a><span id="l79.85" class="difflineplus">+function test_open_folder_b_in_tab() {</span>
<a href="#l79.86"></a><span id="l79.86" class="difflineplus">+  tabFolderB = open_folder_in_new_tab(folderB);</span>
<a href="#l79.87"></a><span id="l79.87" class="difflineplus">+  assert_messages_in_view(setB);</span>
<a href="#l79.88"></a><span id="l79.88" class="difflineplus">+  assert_nothing_selected();</span>
<a href="#l79.89"></a><span id="l79.89" class="difflineplus">+}</span>
<a href="#l79.90"></a><span id="l79.90" class="difflineplus">+</span>
<a href="#l79.91"></a><span id="l79.91" class="difflineplus">+/**</span>
<a href="#l79.92"></a><span id="l79.92" class="difflineplus">+ * Go back to tab/folder A and make sure we change correctly.</span>
<a href="#l79.93"></a><span id="l79.93" class="difflineplus">+ */</span>
<a href="#l79.94"></a><span id="l79.94" class="difflineplus">+function test_switch_to_tab_folder_a() {</span>
<a href="#l79.95"></a><span id="l79.95" class="difflineplus">+  switch_tab(tabFolderA);</span>
<a href="#l79.96"></a><span id="l79.96" class="difflineplus">+  assert_messages_in_view(setA);</span>
<a href="#l79.97"></a><span id="l79.97" class="difflineplus">+  assert_nothing_selected();</span>
<a href="#l79.98"></a><span id="l79.98" class="difflineplus">+}</span>
<a href="#l79.99"></a><span id="l79.99" class="difflineplus">+</span>
<a href="#l79.100"></a><span id="l79.100" class="difflineplus">+/**</span>
<a href="#l79.101"></a><span id="l79.101" class="difflineplus">+ * Select a message in folder A and open it in a new window, making sure that</span>
<a href="#l79.102"></a><span id="l79.102" class="difflineplus">+ *  the displayed message is the right one.</span>
<a href="#l79.103"></a><span id="l79.103" class="difflineplus">+ */</span>
<a href="#l79.104"></a><span id="l79.104" class="difflineplus">+function test_open_message_a_in_tab() {</span>
<a href="#l79.105"></a><span id="l79.105" class="difflineplus">+  messageA = select_click_row(0);</span>
<a href="#l79.106"></a><span id="l79.106" class="difflineplus">+  tabMessageA = open_selected_message_in_new_tab();</span>
<a href="#l79.107"></a><span id="l79.107" class="difflineplus">+  assert_selected_and_displayed(messageA);</span>
<a href="#l79.108"></a><span id="l79.108" class="difflineplus">+}</span>
<a href="#l79.109"></a><span id="l79.109" class="difflineplus">+</span>
<a href="#l79.110"></a><span id="l79.110" class="difflineplus">+/**</span>
<a href="#l79.111"></a><span id="l79.111" class="difflineplus">+ * Go back to tab/folder B and make sure we change correctly.</span>
<a href="#l79.112"></a><span id="l79.112" class="difflineplus">+ */</span>
<a href="#l79.113"></a><span id="l79.113" class="difflineplus">+function test_switch_to_tab_folder_b() {</span>
<a href="#l79.114"></a><span id="l79.114" class="difflineplus">+  switch_tab(tabFolderB);</span>
<a href="#l79.115"></a><span id="l79.115" class="difflineplus">+  assert_messages_in_view(setB);</span>
<a href="#l79.116"></a><span id="l79.116" class="difflineplus">+  assert_nothing_selected();</span>
<a href="#l79.117"></a><span id="l79.117" class="difflineplus">+}</span>
<a href="#l79.118"></a><span id="l79.118" class="difflineplus">+</span>
<a href="#l79.119"></a><span id="l79.119" class="difflineplus">+/**</span>
<a href="#l79.120"></a><span id="l79.120" class="difflineplus">+ * Select a message in folder B and open it in a new window, making sure that</span>
<a href="#l79.121"></a><span id="l79.121" class="difflineplus">+ *  the displayed message is the right one.</span>
<a href="#l79.122"></a><span id="l79.122" class="difflineplus">+ */</span>
<a href="#l79.123"></a><span id="l79.123" class="difflineplus">+function test_open_message_b_in_tab() {</span>
<a href="#l79.124"></a><span id="l79.124" class="difflineplus">+  messageB = select_click_row(0);</span>
<a href="#l79.125"></a><span id="l79.125" class="difflineplus">+  tabMessageB = open_selected_message_in_new_tab();</span>
<a href="#l79.126"></a><span id="l79.126" class="difflineplus">+  assert_selected_and_displayed(messageB);</span>
<a href="#l79.127"></a><span id="l79.127" class="difflineplus">+}</span>
<a href="#l79.128"></a><span id="l79.128" class="difflineplus">+</span>
<a href="#l79.129"></a><span id="l79.129" class="difflineplus">+/**</span>
<a href="#l79.130"></a><span id="l79.130" class="difflineplus">+ * Switch to message tab A.</span>
<a href="#l79.131"></a><span id="l79.131" class="difflineplus">+ */</span>
<a href="#l79.132"></a><span id="l79.132" class="difflineplus">+function test_switch_to_message_a() {</span>
<a href="#l79.133"></a><span id="l79.133" class="difflineplus">+  switch_tab(tabMessageA);</span>
<a href="#l79.134"></a><span id="l79.134" class="difflineplus">+  assert_selected_and_displayed(messageA);</span>
<a href="#l79.135"></a><span id="l79.135" class="difflineplus">+}</span>
<a href="#l79.136"></a><span id="l79.136" class="difflineplus">+</span>
<a href="#l79.137"></a><span id="l79.137" class="difflineplus">+/**</span>
<a href="#l79.138"></a><span id="l79.138" class="difflineplus">+ * Close message tab A (when it's in the foreground).</span>
<a href="#l79.139"></a><span id="l79.139" class="difflineplus">+ */</span>
<a href="#l79.140"></a><span id="l79.140" class="difflineplus">+function test_close_message_a() {</span>
<a href="#l79.141"></a><span id="l79.141" class="difflineplus">+  close_tab();</span>
<a href="#l79.142"></a><span id="l79.142" class="difflineplus">+  // our current tab is now undefined for the purposes of this test.</span>
<a href="#l79.143"></a><span id="l79.143" class="difflineplus">+}</span>
<a href="#l79.144"></a><span id="l79.144" class="difflineplus">+</span>
<a href="#l79.145"></a><span id="l79.145" class="difflineplus">+/**</span>
<a href="#l79.146"></a><span id="l79.146" class="difflineplus">+ * Make sure all the other tabs are still happy.</span>
<a href="#l79.147"></a><span id="l79.147" class="difflineplus">+ */</span>
<a href="#l79.148"></a><span id="l79.148" class="difflineplus">+function test_tabs_are_still_happy() {</span>
<a href="#l79.149"></a><span id="l79.149" class="difflineplus">+  switch_tab(tabFolderB);</span>
<a href="#l79.150"></a><span id="l79.150" class="difflineplus">+  assert_messages_in_view(setB);</span>
<a href="#l79.151"></a><span id="l79.151" class="difflineplus">+  assert_selected_and_displayed(messageB);</span>
<a href="#l79.152"></a><span id="l79.152" class="difflineplus">+</span>
<a href="#l79.153"></a><span id="l79.153" class="difflineplus">+  switch_tab(tabMessageB);</span>
<a href="#l79.154"></a><span id="l79.154" class="difflineplus">+  assert_selected_and_displayed(messageB);</span>
<a href="#l79.155"></a><span id="l79.155" class="difflineplus">+</span>
<a href="#l79.156"></a><span id="l79.156" class="difflineplus">+  switch_tab(tabFolderA);</span>
<a href="#l79.157"></a><span id="l79.157" class="difflineplus">+  assert_messages_in_view(setA);</span>
<a href="#l79.158"></a><span id="l79.158" class="difflineplus">+  assert_selected_and_displayed(messageA);</span>
<a href="#l79.159"></a><span id="l79.159" class="difflineplus">+}</span>
<a href="#l79.160"></a><span id="l79.160" class="difflineplus">+</span>
<a href="#l79.161"></a><span id="l79.161" class="difflineplus">+/**</span>
<a href="#l79.162"></a><span id="l79.162" class="difflineplus">+ * Close message tab B (when it's in the background).</span>
<a href="#l79.163"></a><span id="l79.163" class="difflineplus">+ */</span>
<a href="#l79.164"></a><span id="l79.164" class="difflineplus">+function test_close_message_b() {</span>
<a href="#l79.165"></a><span id="l79.165" class="difflineplus">+  close_tab(tabMessageB);</span>
<a href="#l79.166"></a><span id="l79.166" class="difflineplus">+  // we should still be on folder A</span>
<a href="#l79.167"></a><span id="l79.167" class="difflineplus">+  assert_messages_in_view(setA);</span>
<a href="#l79.168"></a><span id="l79.168" class="difflineplus">+  assert_selected_and_displayed(messageA);</span>
<a href="#l79.169"></a><span id="l79.169" class="difflineplus">+}</span>
<a href="#l79.170"></a><span id="l79.170" class="difflineplus">+</span>
<a href="#l79.171"></a><span id="l79.171" class="difflineplus">+/**</span>
<a href="#l79.172"></a><span id="l79.172" class="difflineplus">+ * Switch to tab B, close it, make sure we end up on tab A.</span>
<a href="#l79.173"></a><span id="l79.173" class="difflineplus">+ */</span>
<a href="#l79.174"></a><span id="l79.174" class="difflineplus">+function test_close_folder_b() {</span>
<a href="#l79.175"></a><span id="l79.175" class="difflineplus">+  switch_tab(tabFolderB);</span>
<a href="#l79.176"></a><span id="l79.176" class="difflineplus">+  assert_messages_in_view(setB);</span>
<a href="#l79.177"></a><span id="l79.177" class="difflineplus">+  assert_selected_and_displayed(messageB);</span>
<a href="#l79.178"></a><span id="l79.178" class="difflineplus">+</span>
<a href="#l79.179"></a><span id="l79.179" class="difflineplus">+  close_tab();</span>
<a href="#l79.180"></a><span id="l79.180" class="difflineplus">+  assert_messages_in_view(setA);</span>
<a href="#l79.181"></a><span id="l79.181" class="difflineplus">+  assert_selected_and_displayed(messageA);</span>
<a href="#l79.182"></a><span id="l79.182" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l80.1"></a><span id="l80.1" class="difflineminus">--- a/mail/test/mozmill/runtest.py</span>
<a href="#l80.2"></a><span id="l80.2" class="difflineplus">+++ b/mail/test/mozmill/runtest.py</span>
<a href="#l80.3"></a><span id="l80.3" class="difflineat">@@ -66,49 +66,48 @@ class ThunderTestProfile(mozrunner.Thund</span>
<a href="#l80.4"></a><span id="l80.4">         'mail.winsearch.enable': False,</span>
<a href="#l80.5"></a><span id="l80.5">         'mail.winsearch.firstRunDone': True,</span>
<a href="#l80.6"></a><span id="l80.6">         'mail.spotlight.enable': False,</span>
<a href="#l80.7"></a><span id="l80.7">         'mail.spotlight.firstRunDone': True,</span>
<a href="#l80.8"></a><span id="l80.8">         # disable address books for undisclosed reasons</span>
<a href="#l80.9"></a><span id="l80.9">         'ldap_2.servers.osx.position': 0,</span>
<a href="#l80.10"></a><span id="l80.10">         'ldap_2.servers.oe.position': 0,</span>
<a href="#l80.11"></a><span id="l80.11">         # other unknown voodoo</span>
<a href="#l80.12"></a><span id="l80.12" class="difflineminus">-	'dom.max_chrome_script_run_time' :  200,</span>
<a href="#l80.13"></a><span id="l80.13" class="difflineminus">-	'dom.max_script_run_time' :  0,</span>
<a href="#l80.14"></a><span id="l80.14" class="difflineplus">+        # -- dummied up local accounts to stop the account wizard</span>
<a href="#l80.15"></a><span id="l80.15">         'mail.account.account1.server' :  &quot;server1&quot;,</span>
<a href="#l80.16"></a><span id="l80.16">         'mail.account.account2.identities' :  &quot;id1&quot;,</span>
<a href="#l80.17"></a><span id="l80.17">         'mail.account.account2.server' :  &quot;server2&quot;,</span>
<a href="#l80.18"></a><span id="l80.18">         'mail.accountmanager.accounts' :  &quot;account1,account2&quot;,</span>
<a href="#l80.19"></a><span id="l80.19">         'mail.accountmanager.defaultaccount' :  &quot;account2&quot;,</span>
<a href="#l80.20"></a><span id="l80.20">         'mail.accountmanager.localfoldersserver' :  &quot;server1&quot;,</span>
<a href="#l80.21"></a><span id="l80.21" class="difflineminus">-       	'mail.identity.id1.fullName' :  &quot;Tinderbox&quot;,</span>
<a href="#l80.22"></a><span id="l80.22" class="difflineplus">+        'mail.identity.id1.fullName' :  &quot;Tinderbox&quot;,</span>
<a href="#l80.23"></a><span id="l80.23">         'mail.identity.id1.smtpServer' :  &quot;smtp1&quot;,</span>
<a href="#l80.24"></a><span id="l80.24" class="difflineminus">-       	'mail.identity.id1.useremail' :  &quot;tinderbox@invalid.com&quot;,</span>
<a href="#l80.25"></a><span id="l80.25" class="difflineplus">+        'mail.identity.id1.useremail' :  &quot;tinderbox@invalid.com&quot;,</span>
<a href="#l80.26"></a><span id="l80.26">         'mail.identity.id1.valid' :  True,</span>
<a href="#l80.27"></a><span id="l80.27" class="difflineminus">-       	'mail.root.none-rel' :  &quot;[ProfD]Mail&quot;,</span>
<a href="#l80.28"></a><span id="l80.28" class="difflineplus">+        'mail.root.none-rel' :  &quot;[ProfD]Mail&quot;,</span>
<a href="#l80.29"></a><span id="l80.29">         'mail.root.pop3-rel' :  &quot;[ProfD]Mail&quot;,</span>
<a href="#l80.30"></a><span id="l80.30">         'mail.server.server1.directory-rel' :  &quot;[ProfD]Mail/Local Folders&quot;,</span>
<a href="#l80.31"></a><span id="l80.31">         'mail.server.server1.hostname' :  &quot;Local Folders&quot;,</span>
<a href="#l80.32"></a><span id="l80.32" class="difflineminus">-       	'mail.server.server1.name' :  &quot;Local Folders&quot;,</span>
<a href="#l80.33"></a><span id="l80.33" class="difflineplus">+        'mail.server.server1.name' :  &quot;Local Folders&quot;,</span>
<a href="#l80.34"></a><span id="l80.34">         'mail.server.server1.type' :  &quot;none&quot;,</span>
<a href="#l80.35"></a><span id="l80.35">         'mail.server.server1.userName' :  &quot;nobody&quot;,</span>
<a href="#l80.36"></a><span id="l80.36">         'mail.server.server2.check_new_mail' :  False,</span>
<a href="#l80.37"></a><span id="l80.37">         'mail.server.server2.directory-rel' :  &quot;[ProfD]Mail/tinderbox&quot;,</span>
<a href="#l80.38"></a><span id="l80.38">         'mail.server.server2.download_on_biff' :  True,</span>
<a href="#l80.39"></a><span id="l80.39" class="difflineminus">-       	'mail.server.server2.hostname' :  &quot;tinderbox&quot;,</span>
<a href="#l80.40"></a><span id="l80.40" class="difflineminus">-       	'mail.server.server2.login_at_startup' :  False,</span>
<a href="#l80.41"></a><span id="l80.41" class="difflineminus">-       	'mail.server.server2.name' :  &quot;tinderbox@invalid.com&quot;,</span>
<a href="#l80.42"></a><span id="l80.42" class="difflineminus">-       	'mail.server.server2.type' :  &quot;pop3&quot;,</span>
<a href="#l80.43"></a><span id="l80.43" class="difflineminus">-       	'mail.server.server2.userName' :  &quot;tinderbox&quot;,</span>
<a href="#l80.44"></a><span id="l80.44" class="difflineminus">-       	'mail.smtp.defaultserver' :  &quot;smtp1&quot;,</span>
<a href="#l80.45"></a><span id="l80.45" class="difflineminus">-       	'mail.smtpserver.smtp1.hostname' :  &quot;tinderbox&quot;,</span>
<a href="#l80.46"></a><span id="l80.46" class="difflineminus">-       	'mail.smtpserver.smtp1.username' :  &quot;tinderbox&quot;,</span>
<a href="#l80.47"></a><span id="l80.47" class="difflineminus">-       	'mail.smtpservers' :  &quot;smtp1&quot;,</span>
<a href="#l80.48"></a><span id="l80.48" class="difflineminus">-       	'mail.startup.enabledMailCheckOnce' :  True,</span>
<a href="#l80.49"></a><span id="l80.49" class="difflineminus">-       	'mailnews.start_page_override.mstone' :  &quot;ignore&quot;,</span>
<a href="#l80.50"></a><span id="l80.50" class="difflineplus">+        'mail.server.server2.hostname' :  &quot;tinderbox&quot;,</span>
<a href="#l80.51"></a><span id="l80.51" class="difflineplus">+        'mail.server.server2.login_at_startup' :  False,</span>
<a href="#l80.52"></a><span id="l80.52" class="difflineplus">+        'mail.server.server2.name' :  &quot;tinderbox@invalid.com&quot;,</span>
<a href="#l80.53"></a><span id="l80.53" class="difflineplus">+        'mail.server.server2.type' :  &quot;pop3&quot;,</span>
<a href="#l80.54"></a><span id="l80.54" class="difflineplus">+        'mail.server.server2.userName' :  &quot;tinderbox&quot;,</span>
<a href="#l80.55"></a><span id="l80.55" class="difflineplus">+        'mail.smtp.defaultserver' :  &quot;smtp1&quot;,</span>
<a href="#l80.56"></a><span id="l80.56" class="difflineplus">+        'mail.smtpserver.smtp1.hostname' :  &quot;tinderbox&quot;,</span>
<a href="#l80.57"></a><span id="l80.57" class="difflineplus">+        'mail.smtpserver.smtp1.username' :  &quot;tinderbox&quot;,</span>
<a href="#l80.58"></a><span id="l80.58" class="difflineplus">+        'mail.smtpservers' :  &quot;smtp1&quot;,</span>
<a href="#l80.59"></a><span id="l80.59" class="difflineplus">+        'mail.startup.enabledMailCheckOnce' :  True,</span>
<a href="#l80.60"></a><span id="l80.60" class="difflineplus">+        'mailnews.start_page_override.mstone' :  &quot;ignore&quot;,</span>
<a href="#l80.61"></a><span id="l80.61">         }</span>
<a href="#l80.62"></a><span id="l80.62"> </span>
<a href="#l80.63"></a><span id="l80.63">     def __init__(self, default_profile=None, profile=None, create_new=True,</span>
<a href="#l80.64"></a><span id="l80.64">                  plugins=[], preferences={}):</span>
<a href="#l80.65"></a><span id="l80.65">         self.init_env()</span>
<a href="#l80.66"></a><span id="l80.66">         self.init_paths()</span>
<a href="#l80.67"></a><span id="l80.67">         mozrunner.Profile.__init__(self, None, None, True, plugins, preferences)</span>
<a href="#l80.68"></a><span id="l80.68"> </span>
<a href="#l80.69"></a><span id="l80.69" class="difflineat">@@ -120,17 +119,21 @@ class ThunderTestProfile(mozrunner.Thund</span>
<a href="#l80.70"></a><span id="l80.70">         self.automation_dir = os.path.join(self.obj_dir, 'mozilla', 'build')</span>
<a href="#l80.71"></a><span id="l80.71">         sys.path.append(self.automation_dir)</span>
<a href="#l80.72"></a><span id="l80.72">         import automation</span>
<a href="#l80.73"></a><span id="l80.73"> </span>
<a href="#l80.74"></a><span id="l80.74">         self.profile_dir = os.path.join(self.obj_dir, 'mozilla',</span>
<a href="#l80.75"></a><span id="l80.75">                                         '_tests', 'leakprofile')</span>
<a href="#l80.76"></a><span id="l80.76">         # XXX tidy up</span>
<a href="#l80.77"></a><span id="l80.77">         if automation.IS_MAC:</span>
<a href="#l80.78"></a><span id="l80.78" class="difflineminus">-            self.bin_dir = os.path.join(self.obj_dir, 'mozilla', 'dist', 'ShredderDebug.app', 'Contents', 'MacOS')</span>
<a href="#l80.79"></a><span id="l80.79" class="difflineplus">+            if automation.IS_DEBUG_BUILD:</span>
<a href="#l80.80"></a><span id="l80.80" class="difflineplus">+              appName = 'ShredderDebug.app'</span>
<a href="#l80.81"></a><span id="l80.81" class="difflineplus">+            else:</span>
<a href="#l80.82"></a><span id="l80.82" class="difflineplus">+              appName = 'Shredder.app'</span>
<a href="#l80.83"></a><span id="l80.83" class="difflineplus">+            self.bin_dir = os.path.join(self.obj_dir, 'mozilla', 'dist', appName, 'Contents', 'MacOS')</span>
<a href="#l80.84"></a><span id="l80.84">             appname = 'thunderbird-bin'</span>
<a href="#l80.85"></a><span id="l80.85">         else:</span>
<a href="#l80.86"></a><span id="l80.86">             self.bin_dir = os.path.join(self.obj_dir, 'mozilla', 'dist', 'bin')</span>
<a href="#l80.87"></a><span id="l80.87">             appname = 'thunderbird'</span>
<a href="#l80.88"></a><span id="l80.88">             if automation.IS_WIN32:</span>
<a href="#l80.89"></a><span id="l80.89">                 appname += '.exe'</span>
<a href="#l80.90"></a><span id="l80.90"> </span>
<a href="#l80.91"></a><span id="l80.91">         self.app_path = os.path.join(self.bin_dir, appname)</span>
<a href="#l80.92"></a><span id="l80.92" class="difflineat">@@ -139,17 +142,17 @@ class ThunderTestProfile(mozrunner.Thund</span>
<a href="#l80.93"></a><span id="l80.93"> </span>
<a href="#l80.94"></a><span id="l80.94"> </span>
<a href="#l80.95"></a><span id="l80.95">     def find_src_dir(self):</span>
<a href="#l80.96"></a><span id="l80.96">         curdir = os.getcwd()</span>
<a href="#l80.97"></a><span id="l80.97">         while not os.path.isdir(os.path.join(curdir, '.hg')):</span>
<a href="#l80.98"></a><span id="l80.98">             curdir, olddir = os.path.split(curdir)</span>
<a href="#l80.99"></a><span id="l80.99">             if curdir == '':</span>
<a href="#l80.100"></a><span id="l80.100">                 raise Exception(&quot;unable to figure out src_dir&quot;)</span>
<a href="#l80.101"></a><span id="l80.101" class="difflineminus">-        return curdir</span>
<a href="#l80.102"></a><span id="l80.102" class="difflineplus">+        return os.path.expanduser(os.path.expandvars(curdir))</span>
<a href="#l80.103"></a><span id="l80.103"> </span>
<a href="#l80.104"></a><span id="l80.104">     def find_obj_dir(self):</span>
<a href="#l80.105"></a><span id="l80.105">         if 'MOZCONFIG' in os.environ:</span>
<a href="#l80.106"></a><span id="l80.106">             mozconfig_path = os.environ['MOZCONFIG']</span>
<a href="#l80.107"></a><span id="l80.107">         else:</span>
<a href="#l80.108"></a><span id="l80.108">             mozconfig_path = os.path.join(self.src_dir, '.mozconfig.mk')</span>
<a href="#l80.109"></a><span id="l80.109"> </span>
<a href="#l80.110"></a><span id="l80.110">         guess_path = os.path.join(self.src_dir, 'mozilla/build/autoconf/config.guess')</span>
<a href="#l80.111"></a><span id="l80.111" class="difflineat">@@ -157,26 +160,26 @@ class ThunderTestProfile(mozrunner.Thund</span>
<a href="#l80.112"></a><span id="l80.112">         config_guess = config_guess.strip()</span>
<a href="#l80.113"></a><span id="l80.113">         f = open(mozconfig_path, 'rt')</span>
<a href="#l80.114"></a><span id="l80.114">         for line in f:</span>
<a href="#l80.115"></a><span id="l80.115">             if 'MOZ_OBJDIR' in line:</span>
<a href="#l80.116"></a><span id="l80.116">                 varpath = line.split('=')[1].strip()</span>
<a href="#l80.117"></a><span id="l80.117">                 varpath = varpath.replace('@TOPSRCDIR@', self.src_dir)</span>
<a href="#l80.118"></a><span id="l80.118">                 varpath = varpath.replace('$(TOPSRCDIR)', self.src_dir)</span>
<a href="#l80.119"></a><span id="l80.119">                 varpath = varpath.replace('@CONFIG_GUESS@',config_guess)</span>
<a href="#l80.120"></a><span id="l80.120" class="difflineminus">-                return varpath</span>
<a href="#l80.121"></a><span id="l80.121" class="difflineplus">+                return os.path.expanduser(os.path.expandvars(varpath))</span>
<a href="#l80.122"></a><span id="l80.122">         f.close()</span>
<a href="#l80.123"></a><span id="l80.123"> </span>
<a href="#l80.124"></a><span id="l80.124">         raise Exception(&quot;unable to figure out obj_dir&quot;)</span>
<a href="#l80.125"></a><span id="l80.125"> </span>
<a href="#l80.126"></a><span id="l80.126">     def init_env(self):</span>
<a href="#l80.127"></a><span id="l80.127">         self.base_env = dict(os.environ)</span>
<a href="#l80.128"></a><span id="l80.128">         # note, we do NOT want to set NO_EM_RESTART or jsbridge wouldn't work</span>
<a href="#l80.129"></a><span id="l80.129">         # avoid dialogs on windows</span>
<a href="#l80.130"></a><span id="l80.130" class="difflineminus">-        self.base_env['XPCOM_DEBUG_BREAK'] = 'warn'</span>
<a href="#l80.131"></a><span id="l80.131" class="difflineplus">+        self.base_env['XPCOM_DEBUG_BREAK'] = 'stack'</span>
<a href="#l80.132"></a><span id="l80.132">         # do not reuse an existing instance</span>
<a href="#l80.133"></a><span id="l80.133">         self.base_env['MOZ_NO_REMOTE'] = '1'</span>
<a href="#l80.134"></a><span id="l80.134"> </span>
<a href="#l80.135"></a><span id="l80.135">     def _run(self, *args, **extraenv):</span>
<a href="#l80.136"></a><span id="l80.136">         env = self.base_env.copy()</span>
<a href="#l80.137"></a><span id="l80.137">         env.update(extraenv)</span>
<a href="#l80.138"></a><span id="l80.138">         allArgs = [self.app_path]</span>
<a href="#l80.139"></a><span id="l80.139">         allArgs.extend(args)</span>
<a href="#l80.140"></a><span id="l80.140" class="difflineat">@@ -213,10 +216,66 @@ class ThunderTestRunner(mozrunner.Thunde</span>
<a href="#l80.141"></a><span id="l80.141">     def find_binary(self):</span>
<a href="#l80.142"></a><span id="l80.142">         return self.profile.app_path</span>
<a href="#l80.143"></a><span id="l80.143"> </span>
<a href="#l80.144"></a><span id="l80.144"> </span>
<a href="#l80.145"></a><span id="l80.145"> class ThunderTestCLI(mozmill.CLI):</span>
<a href="#l80.146"></a><span id="l80.146">     profile_class = ThunderTestProfile</span>
<a href="#l80.147"></a><span id="l80.147">     runner_class = ThunderTestRunner</span>
<a href="#l80.148"></a><span id="l80.148"> </span>
<a href="#l80.149"></a><span id="l80.149" class="difflineplus">+TEST_RESULTS = []</span>
<a href="#l80.150"></a><span id="l80.150" class="difflineplus">+# override mozmill's default logging case, which I hate.</span>
<a href="#l80.151"></a><span id="l80.151" class="difflineplus">+def logFailure(obj):</span>
<a href="#l80.152"></a><span id="l80.152" class="difflineplus">+    FAILURE_LIST.append(obj)</span>
<a href="#l80.153"></a><span id="l80.153" class="difflineplus">+def logEndTest(obj):</span>
<a href="#l80.154"></a><span id="l80.154" class="difflineplus">+    TEST_RESULTS.append(obj)</span>
<a href="#l80.155"></a><span id="l80.155" class="difflineplus">+#mozmill.LoggerListener.cases['mozmill.fail'] = logFailure</span>
<a href="#l80.156"></a><span id="l80.156" class="difflineplus">+mozmill.LoggerListener.cases['mozmill.endTest'] = logEndTest</span>
<a href="#l80.157"></a><span id="l80.157" class="difflineplus">+</span>
<a href="#l80.158"></a><span id="l80.158" class="difflineplus">+def prettifyFilename(path):</span>
<a href="#l80.159"></a><span id="l80.159" class="difflineplus">+    lslash = path.rfind('/')</span>
<a href="#l80.160"></a><span id="l80.160" class="difflineplus">+    if lslash != -1:</span>
<a href="#l80.161"></a><span id="l80.161" class="difflineplus">+        return path[lslash+1:]</span>
<a href="#l80.162"></a><span id="l80.162" class="difflineplus">+    else:</span>
<a href="#l80.163"></a><span id="l80.163" class="difflineplus">+        return path</span>
<a href="#l80.164"></a><span id="l80.164" class="difflineplus">+</span>
<a href="#l80.165"></a><span id="l80.165" class="difflineplus">+def prettyPrintException(e):</span>
<a href="#l80.166"></a><span id="l80.166" class="difflineplus">+    print '  EXCEPTION:', e.get('message', 'no message!')</span>
<a href="#l80.167"></a><span id="l80.167" class="difflineplus">+    print '    at:', prettifyFilename(e.get('fileName', 'nonesuch')), 'line', e.get('lineNumber', 0)</span>
<a href="#l80.168"></a><span id="l80.168" class="difflineplus">+    if 'stack' in e:</span>
<a href="#l80.169"></a><span id="l80.169" class="difflineplus">+        for line in e['stack'].splitlines():</span>
<a href="#l80.170"></a><span id="l80.170" class="difflineplus">+            if not line:</span>
<a href="#l80.171"></a><span id="l80.171" class="difflineplus">+                continue</span>
<a href="#l80.172"></a><span id="l80.172" class="difflineplus">+            if line[0] == &quot;(&quot;:</span>
<a href="#l80.173"></a><span id="l80.173" class="difflineplus">+                funcname = None</span>
<a href="#l80.174"></a><span id="l80.174" class="difflineplus">+            elif line[0] == &quot;@&quot;:</span>
<a href="#l80.175"></a><span id="l80.175" class="difflineplus">+                # this is probably the root, don't care</span>
<a href="#l80.176"></a><span id="l80.176" class="difflineplus">+                continue</span>
<a href="#l80.177"></a><span id="l80.177" class="difflineplus">+            else:</span>
<a href="#l80.178"></a><span id="l80.178" class="difflineplus">+                funcname = line[:line.find('@')]</span>
<a href="#l80.179"></a><span id="l80.179" class="difflineplus">+            pathAndLine = line[line.rfind('@')+1:]</span>
<a href="#l80.180"></a><span id="l80.180" class="difflineplus">+            rcolon = pathAndLine.rfind(':')</span>
<a href="#l80.181"></a><span id="l80.181" class="difflineplus">+            if rcolon != -1:</span>
<a href="#l80.182"></a><span id="l80.182" class="difflineplus">+                path = pathAndLine[:rcolon]</span>
<a href="#l80.183"></a><span id="l80.183" class="difflineplus">+                line = pathAndLine[rcolon+1:]</span>
<a href="#l80.184"></a><span id="l80.184" class="difflineplus">+            else:</span>
<a href="#l80.185"></a><span id="l80.185" class="difflineplus">+                path = pathAndLine</span>
<a href="#l80.186"></a><span id="l80.186" class="difflineplus">+                line = 0</span>
<a href="#l80.187"></a><span id="l80.187" class="difflineplus">+            if funcname:</span>
<a href="#l80.188"></a><span id="l80.188" class="difflineplus">+                print '      ', funcname, prettifyFilename(path), line</span>
<a href="#l80.189"></a><span id="l80.189" class="difflineplus">+            else:</span>
<a href="#l80.190"></a><span id="l80.190" class="difflineplus">+                print '           ', prettifyFilename(path), line</span>
<a href="#l80.191"></a><span id="l80.191" class="difflineplus">+</span>
<a href="#l80.192"></a><span id="l80.192" class="difflineplus">+</span>
<a href="#l80.193"></a><span id="l80.193" class="difflineplus">+import pprint</span>
<a href="#l80.194"></a><span id="l80.194" class="difflineplus">+def prettyPrintResults():</span>
<a href="#l80.195"></a><span id="l80.195" class="difflineplus">+    for result in TEST_RESULTS:</span>
<a href="#l80.196"></a><span id="l80.196" class="difflineplus">+        #pprint.pprint(result)</span>
<a href="#l80.197"></a><span id="l80.197" class="difflineplus">+        print 'TEST', result['name'], len(result['fails']) and &quot;FAILED&quot; or &quot;PASSED&quot;</span>
<a href="#l80.198"></a><span id="l80.198" class="difflineplus">+        for failure in result['fails']:</span>
<a href="#l80.199"></a><span id="l80.199" class="difflineplus">+            if 'exception' in failure:</span>
<a href="#l80.200"></a><span id="l80.200" class="difflineplus">+                prettyPrintException(failure['exception'])</span>
<a href="#l80.201"></a><span id="l80.201" class="difflineplus">+</span>
<a href="#l80.202"></a><span id="l80.202" class="difflineplus">+import atexit</span>
<a href="#l80.203"></a><span id="l80.203" class="difflineplus">+atexit.register(prettyPrintResults)</span>
<a href="#l80.204"></a><span id="l80.204" class="difflineplus">+</span>
<a href="#l80.205"></a><span id="l80.205"> if __name__ == '__main__':</span>
<a href="#l80.206"></a><span id="l80.206">     ThunderTestCLI().run()</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l81.1"></a><span id="l81.1">new file mode 100644</span>
<a href="#l81.2"></a><span id="l81.2" class="difflineminus">--- /dev/null</span>
<a href="#l81.3"></a><span id="l81.3" class="difflineplus">+++ b/mail/test/mozmill/search-window/test-search-window.js</span>
<a href="#l81.4"></a><span id="l81.4" class="difflineat">@@ -0,0 +1,178 @@</span>
<a href="#l81.5"></a><span id="l81.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l81.6"></a><span id="l81.6" class="difflineplus">+ *   Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l81.7"></a><span id="l81.7" class="difflineplus">+ *</span>
<a href="#l81.8"></a><span id="l81.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l81.9"></a><span id="l81.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l81.10"></a><span id="l81.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l81.11"></a><span id="l81.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l81.12"></a><span id="l81.12" class="difflineplus">+ *</span>
<a href="#l81.13"></a><span id="l81.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l81.14"></a><span id="l81.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l81.15"></a><span id="l81.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l81.16"></a><span id="l81.16" class="difflineplus">+ * License.</span>
<a href="#l81.17"></a><span id="l81.17" class="difflineplus">+ *</span>
<a href="#l81.18"></a><span id="l81.18" class="difflineplus">+ * The Original Code is Thunderbird Mail Client.</span>
<a href="#l81.19"></a><span id="l81.19" class="difflineplus">+ *</span>
<a href="#l81.20"></a><span id="l81.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l81.21"></a><span id="l81.21" class="difflineplus">+ * Mozilla Messaging, Inc.</span>
<a href="#l81.22"></a><span id="l81.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l81.23"></a><span id="l81.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l81.24"></a><span id="l81.24" class="difflineplus">+ *</span>
<a href="#l81.25"></a><span id="l81.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l81.26"></a><span id="l81.26" class="difflineplus">+ *   Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a href="#l81.27"></a><span id="l81.27" class="difflineplus">+ *</span>
<a href="#l81.28"></a><span id="l81.28" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l81.29"></a><span id="l81.29" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l81.30"></a><span id="l81.30" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l81.31"></a><span id="l81.31" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l81.32"></a><span id="l81.32" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l81.33"></a><span id="l81.33" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l81.34"></a><span id="l81.34" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l81.35"></a><span id="l81.35" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l81.36"></a><span id="l81.36" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l81.37"></a><span id="l81.37" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l81.38"></a><span id="l81.38" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l81.39"></a><span id="l81.39" class="difflineplus">+ *</span>
<a href="#l81.40"></a><span id="l81.40" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l81.41"></a><span id="l81.41" class="difflineplus">+</span>
<a href="#l81.42"></a><span id="l81.42" class="difflineplus">+/*</span>
<a href="#l81.43"></a><span id="l81.43" class="difflineplus">+ * Tests:</span>
<a href="#l81.44"></a><span id="l81.44" class="difflineplus">+ * - https://bugzilla.mozilla.org/show_bug.cgi?id=474701#c96 first para</span>
<a href="#l81.45"></a><span id="l81.45" class="difflineplus">+ */</span>
<a href="#l81.46"></a><span id="l81.46" class="difflineplus">+var MODULE_NAME = 'test-search-window';</span>
<a href="#l81.47"></a><span id="l81.47" class="difflineplus">+</span>
<a href="#l81.48"></a><span id="l81.48" class="difflineplus">+var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l81.49"></a><span id="l81.49" class="difflineplus">+var MODULE_REQUIRES = ['folder-display-helpers', 'window-helpers'];</span>
<a href="#l81.50"></a><span id="l81.50" class="difflineplus">+</span>
<a href="#l81.51"></a><span id="l81.51" class="difflineplus">+function setupModule(module) {</span>
<a href="#l81.52"></a><span id="l81.52" class="difflineplus">+  let fdh = collector.getModule('folder-display-helpers');</span>
<a href="#l81.53"></a><span id="l81.53" class="difflineplus">+  fdh.installInto(module);</span>
<a href="#l81.54"></a><span id="l81.54" class="difflineplus">+  let wh = collector.getModule('window-helpers');</span>
<a href="#l81.55"></a><span id="l81.55" class="difflineplus">+  wh.installInto(module);</span>
<a href="#l81.56"></a><span id="l81.56" class="difflineplus">+}</span>
<a href="#l81.57"></a><span id="l81.57" class="difflineplus">+</span>
<a href="#l81.58"></a><span id="l81.58" class="difflineplus">+var folder, setFoo, setBar, setFooBar;</span>
<a href="#l81.59"></a><span id="l81.59" class="difflineplus">+</span>
<a href="#l81.60"></a><span id="l81.60" class="difflineplus">+/**</span>
<a href="#l81.61"></a><span id="l81.61" class="difflineplus">+ * Create some messages that our constraint below will satisfy</span>
<a href="#l81.62"></a><span id="l81.62" class="difflineplus">+ */</span>
<a href="#l81.63"></a><span id="l81.63" class="difflineplus">+function test_create_messages() {</span>
<a href="#l81.64"></a><span id="l81.64" class="difflineplus">+  folder = create_folder(&quot;SearchWindowA&quot;);</span>
<a href="#l81.65"></a><span id="l81.65" class="difflineplus">+  [setFoo, setBar, setFooBar] =</span>
<a href="#l81.66"></a><span id="l81.66" class="difflineplus">+    make_new_sets_in_folder(folder, [{subject: &quot;foo&quot;}, {subject: &quot;bar&quot;},</span>
<a href="#l81.67"></a><span id="l81.67" class="difflineplus">+                                     {subject: &quot;foo bar&quot;}]);</span>
<a href="#l81.68"></a><span id="l81.68" class="difflineplus">+}</span>
<a href="#l81.69"></a><span id="l81.69" class="difflineplus">+</span>
<a href="#l81.70"></a><span id="l81.70" class="difflineplus">+/**</span>
<a href="#l81.71"></a><span id="l81.71" class="difflineplus">+ * The search window controller.</span>
<a href="#l81.72"></a><span id="l81.72" class="difflineplus">+ */</span>
<a href="#l81.73"></a><span id="l81.73" class="difflineplus">+var swc = null;</span>
<a href="#l81.74"></a><span id="l81.74" class="difflineplus">+</span>
<a href="#l81.75"></a><span id="l81.75" class="difflineplus">+/**</span>
<a href="#l81.76"></a><span id="l81.76" class="difflineplus">+ * Bring up the search window.</span>
<a href="#l81.77"></a><span id="l81.77" class="difflineplus">+ */</span>
<a href="#l81.78"></a><span id="l81.78" class="difflineplus">+function test_show_search_window() {</span>
<a href="#l81.79"></a><span id="l81.79" class="difflineplus">+  // put us in the folder we care about so it defaults to that</span>
<a href="#l81.80"></a><span id="l81.80" class="difflineplus">+  be_in_folder(folder);</span>
<a href="#l81.81"></a><span id="l81.81" class="difflineplus">+</span>
<a href="#l81.82"></a><span id="l81.82" class="difflineplus">+  // push control-shift-F, wait for it to show</span>
<a href="#l81.83"></a><span id="l81.83" class="difflineplus">+  plan_for_new_window(&quot;mailnews:search&quot;);</span>
<a href="#l81.84"></a><span id="l81.84" class="difflineplus">+  mc.keypress(null, &quot;f&quot;, {shiftKey: true, ctrlKey: true});</span>
<a href="#l81.85"></a><span id="l81.85" class="difflineplus">+  swc = wait_for_new_window(&quot;mailnews:search&quot;);</span>
<a href="#l81.86"></a><span id="l81.86" class="difflineplus">+}</span>
<a href="#l81.87"></a><span id="l81.87" class="difflineplus">+</span>
<a href="#l81.88"></a><span id="l81.88" class="difflineplus">+/**</span>
<a href="#l81.89"></a><span id="l81.89" class="difflineplus">+ * Set up the search.</span>
<a href="#l81.90"></a><span id="l81.90" class="difflineplus">+ */</span>
<a href="#l81.91"></a><span id="l81.91" class="difflineplus">+function test_enter_some_stuff() {</span>
<a href="#l81.92"></a><span id="l81.92" class="difflineplus">+  // - turn off search subfolders</span>
<a href="#l81.93"></a><span id="l81.93" class="difflineplus">+  // (we're not testing the UI, direct access is fine)</span>
<a href="#l81.94"></a><span id="l81.94" class="difflineplus">+  swc.e(&quot;checkSearchSubFolders&quot;).removeAttribute(&quot;checked&quot;);</span>
<a href="#l81.95"></a><span id="l81.95" class="difflineplus">+</span>
<a href="#l81.96"></a><span id="l81.96" class="difflineplus">+  // - put &quot;foo&quot; in the subject contains box</span>
<a href="#l81.97"></a><span id="l81.97" class="difflineplus">+  // Each filter criterion is a listitem in the listbox with id=searchTermList.</span>
<a href="#l81.98"></a><span id="l81.98" class="difflineplus">+  // Each filter criterion has id &quot;searchRowN&quot;, and the textbox has id</span>
<a href="#l81.99"></a><span id="l81.99" class="difflineplus">+  //  &quot;searchValN&quot; exposing the value on attribute &quot;value&quot;.</span>
<a href="#l81.100"></a><span id="l81.100" class="difflineplus">+  // XXX I am having real difficulty getting the click/type pair to actually</span>
<a href="#l81.101"></a><span id="l81.101" class="difflineplus">+  //  get the text in there reliably.  I am just going to poke things directly</span>
<a href="#l81.102"></a><span id="l81.102" class="difflineplus">+  //  into the text widget. (We used to use .aid instead of .a with swc.click</span>
<a href="#l81.103"></a><span id="l81.103" class="difflineplus">+  //  and swc.type.)</span>
<a href="#l81.104"></a><span id="l81.104" class="difflineplus">+  let searchVal0 = swc.a(&quot;searchVal0&quot;, {crazyDeck: 0});</span>
<a href="#l81.105"></a><span id="l81.105" class="difflineplus">+  searchVal0.value = &quot;foo&quot;;</span>
<a href="#l81.106"></a><span id="l81.106" class="difflineplus">+</span>
<a href="#l81.107"></a><span id="l81.107" class="difflineplus">+  // - add another subject box</span>
<a href="#l81.108"></a><span id="l81.108" class="difflineplus">+  let plusButton = swc.eid(&quot;searchRow0&quot;, {tagName: &quot;button&quot;, label: &quot;+&quot;});</span>
<a href="#l81.109"></a><span id="l81.109" class="difflineplus">+  swc.click(plusButton);</span>
<a href="#l81.110"></a><span id="l81.110" class="difflineplus">+</span>
<a href="#l81.111"></a><span id="l81.111" class="difflineplus">+  // - put &quot;bar&quot; in it</span>
<a href="#l81.112"></a><span id="l81.112" class="difflineplus">+  let searchVal1 = swc.a(&quot;searchVal1&quot;, {crazyDeck: 0});</span>
<a href="#l81.113"></a><span id="l81.113" class="difflineplus">+  searchVal1.value = &quot;bar&quot;;</span>
<a href="#l81.114"></a><span id="l81.114" class="difflineplus">+}</span>
<a href="#l81.115"></a><span id="l81.115" class="difflineplus">+</span>
<a href="#l81.116"></a><span id="l81.116" class="difflineplus">+/**</span>
<a href="#l81.117"></a><span id="l81.117" class="difflineplus">+ * Trigger the search, make sure the right results show up.</span>
<a href="#l81.118"></a><span id="l81.118" class="difflineplus">+ */</span>
<a href="#l81.119"></a><span id="l81.119" class="difflineplus">+function test_go_search() {</span>
<a href="#l81.120"></a><span id="l81.120" class="difflineplus">+  // - Trigger the search</span>
<a href="#l81.121"></a><span id="l81.121" class="difflineplus">+  // The &quot;Search&quot; button has id &quot;search-button&quot;</span>
<a href="#l81.122"></a><span id="l81.122" class="difflineplus">+  swc.click(swc.eid(&quot;search-button&quot;));</span>
<a href="#l81.123"></a><span id="l81.123" class="difflineplus">+  wait_for_all_messages_to_load(swc);</span>
<a href="#l81.124"></a><span id="l81.124" class="difflineplus">+</span>
<a href="#l81.125"></a><span id="l81.125" class="difflineplus">+  // - Verify we got the right messages</span>
<a href="#l81.126"></a><span id="l81.126" class="difflineplus">+  assert_messages_in_view(setFooBar, swc);</span>
<a href="#l81.127"></a><span id="l81.127" class="difflineplus">+</span>
<a href="#l81.128"></a><span id="l81.128" class="difflineplus">+  // - Click the &quot;Save as Search Folder&quot; button, id &quot;saveAsVFButton&quot;</span>
<a href="#l81.129"></a><span id="l81.129" class="difflineplus">+  // This will create a virtual folder properties dialog...</span>
<a href="#l81.130"></a><span id="l81.130" class="difflineplus">+  // (label: &quot;New Saved Search Folder&quot;, source: virtualFolderProperties.xul</span>
<a href="#l81.131"></a><span id="l81.131" class="difflineplus">+  //  no windowtype, id: &quot;virtualFolderPropertiesDialog&quot;)</span>
<a href="#l81.132"></a><span id="l81.132" class="difflineplus">+  plan_for_modal_dialog(&quot;mailnews:virtualFolderProperties&quot;,</span>
<a href="#l81.133"></a><span id="l81.133" class="difflineplus">+                        subtest_save_search);</span>
<a href="#l81.134"></a><span id="l81.134" class="difflineplus">+  swc.click(swc.eid(&quot;saveAsVFButton&quot;));</span>
<a href="#l81.135"></a><span id="l81.135" class="difflineplus">+  wait_for_modal_dialog(&quot;mailnews:virtualFolderProperties&quot;);</span>
<a href="#l81.136"></a><span id="l81.136" class="difflineplus">+}</span>
<a href="#l81.137"></a><span id="l81.137" class="difflineplus">+</span>
<a href="#l81.138"></a><span id="l81.138" class="difflineplus">+/**</span>
<a href="#l81.139"></a><span id="l81.139" class="difflineplus">+ * Save the search, making sure the constraints propagated.</span>
<a href="#l81.140"></a><span id="l81.140" class="difflineplus">+ */</span>
<a href="#l81.141"></a><span id="l81.141" class="difflineplus">+function subtest_save_search(savc) {</span>
<a href="#l81.142"></a><span id="l81.142" class="difflineplus">+  // - make sure our constraint propagated</span>
<a href="#l81.143"></a><span id="l81.143" class="difflineplus">+  // The query constraints are displayed using the same widgets (and code) that</span>
<a href="#l81.144"></a><span id="l81.144" class="difflineplus">+  //  we used to enter them, so it's very similar to check.</span>
<a href="#l81.145"></a><span id="l81.145" class="difflineplus">+  let searchVal0 = savc.aid(&quot;searchVal0&quot;, {crazyDeck: 0});</span>
<a href="#l81.146"></a><span id="l81.146" class="difflineplus">+  savc.assertNode(searchVal0);</span>
<a href="#l81.147"></a><span id="l81.147" class="difflineplus">+  savc.assertValue(searchVal0, &quot;foo&quot;);</span>
<a href="#l81.148"></a><span id="l81.148" class="difflineplus">+  let searchVal1 = savc.aid(&quot;searchVal1&quot;, {crazyDeck: 0});</span>
<a href="#l81.149"></a><span id="l81.149" class="difflineplus">+  savc.assertNode(searchVal1);</span>
<a href="#l81.150"></a><span id="l81.150" class="difflineplus">+  savc.assertValue(searchVal1, &quot;bar&quot;);</span>
<a href="#l81.151"></a><span id="l81.151" class="difflineplus">+</span>
<a href="#l81.152"></a><span id="l81.152" class="difflineplus">+  // - name the search</span>
<a href="#l81.153"></a><span id="l81.153" class="difflineplus">+  // I am having no luck with click/type on XUL things. workaround it.</span>
<a href="#l81.154"></a><span id="l81.154" class="difflineplus">+  savc.e(&quot;name&quot;).value = &quot;SearchSaved&quot;;</span>
<a href="#l81.155"></a><span id="l81.155" class="difflineplus">+  savc.window.doEnabling();</span>
<a href="#l81.156"></a><span id="l81.156" class="difflineplus">+</span>
<a href="#l81.157"></a><span id="l81.157" class="difflineplus">+  // - save it!</span>
<a href="#l81.158"></a><span id="l81.158" class="difflineplus">+  // this will close the dialog, which wait_for_modal_dialog is making sure</span>
<a href="#l81.159"></a><span id="l81.159" class="difflineplus">+  //  happens.</span>
<a href="#l81.160"></a><span id="l81.160" class="difflineplus">+  savc.window.onOK();</span>
<a href="#l81.161"></a><span id="l81.161" class="difflineplus">+}</span>
<a href="#l81.162"></a><span id="l81.162" class="difflineplus">+</span>
<a href="#l81.163"></a><span id="l81.163" class="difflineplus">+function test_close_search_window() {</span>
<a href="#l81.164"></a><span id="l81.164" class="difflineplus">+  // now close the search window</span>
<a href="#l81.165"></a><span id="l81.165" class="difflineplus">+  plan_for_window_close(swc);</span>
<a href="#l81.166"></a><span id="l81.166" class="difflineplus">+  swc.keypress(null, &quot;VK_ESCAPE&quot;, {});</span>
<a href="#l81.167"></a><span id="l81.167" class="difflineplus">+  wait_for_window_close(swc);</span>
<a href="#l81.168"></a><span id="l81.168" class="difflineplus">+  swc = null;</span>
<a href="#l81.169"></a><span id="l81.169" class="difflineplus">+}</span>
<a href="#l81.170"></a><span id="l81.170" class="difflineplus">+</span>
<a href="#l81.171"></a><span id="l81.171" class="difflineplus">+/**</span>
<a href="#l81.172"></a><span id="l81.172" class="difflineplus">+ * Make sure the folder showed up with the right name, and that displaying it</span>
<a href="#l81.173"></a><span id="l81.173" class="difflineplus">+ *  has the right contents.</span>
<a href="#l81.174"></a><span id="l81.174" class="difflineplus">+ */</span>
<a href="#l81.175"></a><span id="l81.175" class="difflineplus">+function test_verify_saved_search() {</span>
<a href="#l81.176"></a><span id="l81.176" class="difflineplus">+  let savedFolder = folder.findSubFolder(&quot;SearchSaved&quot;);</span>
<a href="#l81.177"></a><span id="l81.177" class="difflineplus">+  if (savedFolder == null)</span>
<a href="#l81.178"></a><span id="l81.178" class="difflineplus">+    throw new Error(&quot;Saved folder did not show up.&quot;);</span>
<a href="#l81.179"></a><span id="l81.179" class="difflineplus">+</span>
<a href="#l81.180"></a><span id="l81.180" class="difflineplus">+  be_in_folder(savedFolder);</span>
<a href="#l81.181"></a><span id="l81.181" class="difflineplus">+  assert_messages_in_view(setFooBar);</span>
<a href="#l81.182"></a><span id="l81.182" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l82.1"></a><span id="l82.1">new file mode 100644</span>
<a href="#l82.2"></a><span id="l82.2" class="difflineminus">--- /dev/null</span>
<a href="#l82.3"></a><span id="l82.3" class="difflineplus">+++ b/mail/test/mozmill/shared-modules/test-folder-display-helpers.js</span>
<a href="#l82.4"></a><span id="l82.4" class="difflineat">@@ -0,0 +1,1078 @@</span>
<a href="#l82.5"></a><span id="l82.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l82.6"></a><span id="l82.6" class="difflineplus">+ *   Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l82.7"></a><span id="l82.7" class="difflineplus">+ *</span>
<a href="#l82.8"></a><span id="l82.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l82.9"></a><span id="l82.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l82.10"></a><span id="l82.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l82.11"></a><span id="l82.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l82.12"></a><span id="l82.12" class="difflineplus">+ *</span>
<a href="#l82.13"></a><span id="l82.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l82.14"></a><span id="l82.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l82.15"></a><span id="l82.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l82.16"></a><span id="l82.16" class="difflineplus">+ * License.</span>
<a href="#l82.17"></a><span id="l82.17" class="difflineplus">+ *</span>
<a href="#l82.18"></a><span id="l82.18" class="difflineplus">+ * The Original Code is Thunderbird Mail Client.</span>
<a href="#l82.19"></a><span id="l82.19" class="difflineplus">+ *</span>
<a href="#l82.20"></a><span id="l82.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l82.21"></a><span id="l82.21" class="difflineplus">+ * Mozilla Messaging, Inc.</span>
<a href="#l82.22"></a><span id="l82.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l82.23"></a><span id="l82.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l82.24"></a><span id="l82.24" class="difflineplus">+ *</span>
<a href="#l82.25"></a><span id="l82.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l82.26"></a><span id="l82.26" class="difflineplus">+ *   Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a href="#l82.27"></a><span id="l82.27" class="difflineplus">+ *</span>
<a href="#l82.28"></a><span id="l82.28" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l82.29"></a><span id="l82.29" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l82.30"></a><span id="l82.30" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l82.31"></a><span id="l82.31" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l82.32"></a><span id="l82.32" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l82.33"></a><span id="l82.33" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l82.34"></a><span id="l82.34" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l82.35"></a><span id="l82.35" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l82.36"></a><span id="l82.36" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l82.37"></a><span id="l82.37" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l82.38"></a><span id="l82.38" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l82.39"></a><span id="l82.39" class="difflineplus">+ *</span>
<a href="#l82.40"></a><span id="l82.40" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l82.41"></a><span id="l82.41" class="difflineplus">+</span>
<a href="#l82.42"></a><span id="l82.42" class="difflineplus">+var Ci = Components.interfaces;</span>
<a href="#l82.43"></a><span id="l82.43" class="difflineplus">+var Cc = Components.classes;</span>
<a href="#l82.44"></a><span id="l82.44" class="difflineplus">+var Cu = Components.utils;</span>
<a href="#l82.45"></a><span id="l82.45" class="difflineplus">+</span>
<a href="#l82.46"></a><span id="l82.46" class="difflineplus">+var elib = {};</span>
<a href="#l82.47"></a><span id="l82.47" class="difflineplus">+Cu.import('resource://mozmill/modules/elementslib.js', elib);</span>
<a href="#l82.48"></a><span id="l82.48" class="difflineplus">+var EventUtils = {};</span>
<a href="#l82.49"></a><span id="l82.49" class="difflineplus">+Cu.import('resource://mozmill/modules/EventUtils.js', EventUtils);</span>
<a href="#l82.50"></a><span id="l82.50" class="difflineplus">+var mozmill = {};</span>
<a href="#l82.51"></a><span id="l82.51" class="difflineplus">+Cu.import('resource://mozmill/modules/mozmill.js', mozmill);</span>
<a href="#l82.52"></a><span id="l82.52" class="difflineplus">+var controller = {};</span>
<a href="#l82.53"></a><span id="l82.53" class="difflineplus">+Cu.import('resource://mozmill/modules/controller.js', controller);</span>
<a href="#l82.54"></a><span id="l82.54" class="difflineplus">+var frame = {};</span>
<a href="#l82.55"></a><span id="l82.55" class="difflineplus">+Cu.import('resource://mozmill/modules/frame.js', frame);</span>
<a href="#l82.56"></a><span id="l82.56" class="difflineplus">+var os = {};</span>
<a href="#l82.57"></a><span id="l82.57" class="difflineplus">+Cu.import('resource://mozmill/stdlib/os.js', os);</span>
<a href="#l82.58"></a><span id="l82.58" class="difflineplus">+</span>
<a href="#l82.59"></a><span id="l82.59" class="difflineplus">+const MODULE_NAME = 'folder-display-helpers';</span>
<a href="#l82.60"></a><span id="l82.60" class="difflineplus">+</span>
<a href="#l82.61"></a><span id="l82.61" class="difflineplus">+const RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l82.62"></a><span id="l82.62" class="difflineplus">+// we need window-helpers for augment_controller</span>
<a href="#l82.63"></a><span id="l82.63" class="difflineplus">+const MODULES_REQUIRES = ['window-helpers'];</span>
<a href="#l82.64"></a><span id="l82.64" class="difflineplus">+</span>
<a href="#l82.65"></a><span id="l82.65" class="difflineplus">+const nsMsgViewIndex_None = 0xffffffff;</span>
<a href="#l82.66"></a><span id="l82.66" class="difflineplus">+</span>
<a href="#l82.67"></a><span id="l82.67" class="difflineplus">+</span>
<a href="#l82.68"></a><span id="l82.68" class="difflineplus">+const DO_NOT_EXPORT = {</span>
<a href="#l82.69"></a><span id="l82.69" class="difflineplus">+  // magic globals</span>
<a href="#l82.70"></a><span id="l82.70" class="difflineplus">+  MODULE_NAME: true, DO_NOT_EXPORT: true,</span>
<a href="#l82.71"></a><span id="l82.71" class="difflineplus">+  // imported modules</span>
<a href="#l82.72"></a><span id="l82.72" class="difflineplus">+  elib: true, mozmill: true, controller: true, frame: true, os: true,</span>
<a href="#l82.73"></a><span id="l82.73" class="difflineplus">+  // convenience constants</span>
<a href="#l82.74"></a><span id="l82.74" class="difflineplus">+  Ci: true, Cc: true, Cu: true, Cr: true,</span>
<a href="#l82.75"></a><span id="l82.75" class="difflineplus">+  // useful constants</span>
<a href="#l82.76"></a><span id="l82.76" class="difflineplus">+  nsMsgViewIndex_None: true,</span>
<a href="#l82.77"></a><span id="l82.77" class="difflineplus">+  // internal setup functions</span>
<a href="#l82.78"></a><span id="l82.78" class="difflineplus">+  setupModule: true, setupAccountStuff: true,</span>
<a href="#l82.79"></a><span id="l82.79" class="difflineplus">+  // internal setup flags</span>
<a href="#l82.80"></a><span id="l82.80" class="difflineplus">+  initialized: false,</span>
<a href="#l82.81"></a><span id="l82.81" class="difflineplus">+  // other libraries we use</span>
<a href="#l82.82"></a><span id="l82.82" class="difflineplus">+  windowHelper: true</span>
<a href="#l82.83"></a><span id="l82.83" class="difflineplus">+};</span>
<a href="#l82.84"></a><span id="l82.84" class="difflineplus">+</span>
<a href="#l82.85"></a><span id="l82.85" class="difflineplus">+var mainController = null;</span>
<a href="#l82.86"></a><span id="l82.86" class="difflineplus">+/** convenience shorthand for the mainController. */</span>
<a href="#l82.87"></a><span id="l82.87" class="difflineplus">+var mc;</span>
<a href="#l82.88"></a><span id="l82.88" class="difflineplus">+/** the index of the current 'other' tab */</span>
<a href="#l82.89"></a><span id="l82.89" class="difflineplus">+var otherTab;</span>
<a href="#l82.90"></a><span id="l82.90" class="difflineplus">+</span>
<a href="#l82.91"></a><span id="l82.91" class="difflineplus">+// These are pseudo-modules setup by setupModule:</span>
<a href="#l82.92"></a><span id="l82.92" class="difflineplus">+var messageGenerator;</span>
<a href="#l82.93"></a><span id="l82.93" class="difflineplus">+var messageModifier;</span>
<a href="#l82.94"></a><span id="l82.94" class="difflineplus">+var viewWrapperTestUtils;</span>
<a href="#l82.95"></a><span id="l82.95" class="difflineplus">+// (end pseudo-modules)</span>
<a href="#l82.96"></a><span id="l82.96" class="difflineplus">+</span>
<a href="#l82.97"></a><span id="l82.97" class="difflineplus">+var msgGen;</span>
<a href="#l82.98"></a><span id="l82.98" class="difflineplus">+</span>
<a href="#l82.99"></a><span id="l82.99" class="difflineplus">+var gLocalIncomingServer = null;</span>
<a href="#l82.100"></a><span id="l82.100" class="difflineplus">+var gLocalInboxFolder = null;</span>
<a href="#l82.101"></a><span id="l82.101" class="difflineplus">+</span>
<a href="#l82.102"></a><span id="l82.102" class="difflineplus">+var rootFolder = null;</span>
<a href="#l82.103"></a><span id="l82.103" class="difflineplus">+</span>
<a href="#l82.104"></a><span id="l82.104" class="difflineplus">+// the windowHelper module</span>
<a href="#l82.105"></a><span id="l82.105" class="difflineplus">+var windowHelper;</span>
<a href="#l82.106"></a><span id="l82.106" class="difflineplus">+</span>
<a href="#l82.107"></a><span id="l82.107" class="difflineplus">+var initialized = false;</span>
<a href="#l82.108"></a><span id="l82.108" class="difflineplus">+function setupModule() {</span>
<a href="#l82.109"></a><span id="l82.109" class="difflineplus">+  if (initialized)</span>
<a href="#l82.110"></a><span id="l82.110" class="difflineplus">+    return;</span>
<a href="#l82.111"></a><span id="l82.111" class="difflineplus">+  initialized = true;</span>
<a href="#l82.112"></a><span id="l82.112" class="difflineplus">+</span>
<a href="#l82.113"></a><span id="l82.113" class="difflineplus">+  // The xpcshell test resources assume they are loaded into a single global</span>
<a href="#l82.114"></a><span id="l82.114" class="difflineplus">+  //  namespace, so we need to help them out to maintain their delusion.</span>
<a href="#l82.115"></a><span id="l82.115" class="difflineplus">+  messageGenerator = load_via_src_path(</span>
<a href="#l82.116"></a><span id="l82.116" class="difflineplus">+    'mailnews/test/resources/messageGenerator.js');</span>
<a href="#l82.117"></a><span id="l82.117" class="difflineplus">+  messageModifier = load_via_src_path(</span>
<a href="#l82.118"></a><span id="l82.118" class="difflineplus">+    'mailnews/test/resources/messageModifier.js');</span>
<a href="#l82.119"></a><span id="l82.119" class="difflineplus">+  viewWrapperTestUtils = load_via_src_path(</span>
<a href="#l82.120"></a><span id="l82.120" class="difflineplus">+    'mailnews/test/resources/viewWrapperTestUtils.js');</span>
<a href="#l82.121"></a><span id="l82.121" class="difflineplus">+  // desired global types...</span>
<a href="#l82.122"></a><span id="l82.122" class="difflineplus">+  viewWrapperTestUtils.SyntheticMessageSet =</span>
<a href="#l82.123"></a><span id="l82.123" class="difflineplus">+    messageModifier.SyntheticMessageSet;</span>
<a href="#l82.124"></a><span id="l82.124" class="difflineplus">+  viewWrapperTestUtils.do_throw = function(aMsg) {</span>
<a href="#l82.125"></a><span id="l82.125" class="difflineplus">+    throw new Error(aMsg);</span>
<a href="#l82.126"></a><span id="l82.126" class="difflineplus">+  };</span>
<a href="#l82.127"></a><span id="l82.127" class="difflineplus">+  // viewWrapperTestUtils wants a gMessageGenerator (and so do we)</span>
<a href="#l82.128"></a><span id="l82.128" class="difflineplus">+  msgGen = new messageGenerator.MessageGenerator();</span>
<a href="#l82.129"></a><span id="l82.129" class="difflineplus">+  viewWrapperTestUtils.gMessageGenerator = msgGen;</span>
<a href="#l82.130"></a><span id="l82.130" class="difflineplus">+  viewWrapperTestUtils.gMessageScenarioFactory =</span>
<a href="#l82.131"></a><span id="l82.131" class="difflineplus">+    new messageGenerator.MessageScenarioFactory(msgGen);</span>
<a href="#l82.132"></a><span id="l82.132" class="difflineplus">+</span>
<a href="#l82.133"></a><span id="l82.133" class="difflineplus">+  make_new_sets_in_folders = make_new_sets_in_folder =</span>
<a href="#l82.134"></a><span id="l82.134" class="difflineplus">+    viewWrapperTestUtils.make_new_sets_in_folders;</span>
<a href="#l82.135"></a><span id="l82.135" class="difflineplus">+  add_sets_to_folders = viewWrapperTestUtils.add_sets_to_folders;</span>
<a href="#l82.136"></a><span id="l82.136" class="difflineplus">+  viewWrapperTestUtils.Ci = Ci;</span>
<a href="#l82.137"></a><span id="l82.137" class="difflineplus">+  viewWrapperTestUtils.Cu = Cu;</span>
<a href="#l82.138"></a><span id="l82.138" class="difflineplus">+  viewWrapperTestUtils.Cc = Cc;</span>
<a href="#l82.139"></a><span id="l82.139" class="difflineplus">+</span>
<a href="#l82.140"></a><span id="l82.140" class="difflineplus">+  // use window-helper's augment_controller method to get our extra good stuff</span>
<a href="#l82.141"></a><span id="l82.141" class="difflineplus">+  //  we need.</span>
<a href="#l82.142"></a><span id="l82.142" class="difflineplus">+  windowHelper = collector.getModule('window-helpers');</span>
<a href="#l82.143"></a><span id="l82.143" class="difflineplus">+  mc = mainController = windowHelper.wait_for_existing_window(&quot;mail:3pane&quot;);</span>
<a href="#l82.144"></a><span id="l82.144" class="difflineplus">+  windowHelper.augment_controller(mc);</span>
<a href="#l82.145"></a><span id="l82.145" class="difflineplus">+</span>
<a href="#l82.146"></a><span id="l82.146" class="difflineplus">+  setupAccountStuff();</span>
<a href="#l82.147"></a><span id="l82.147" class="difflineplus">+}</span>
<a href="#l82.148"></a><span id="l82.148" class="difflineplus">+</span>
<a href="#l82.149"></a><span id="l82.149" class="difflineplus">+/**</span>
<a href="#l82.150"></a><span id="l82.150" class="difflineplus">+ * Install this module into the provided module.</span>
<a href="#l82.151"></a><span id="l82.151" class="difflineplus">+ */</span>
<a href="#l82.152"></a><span id="l82.152" class="difflineplus">+function installInto(module) {</span>
<a href="#l82.153"></a><span id="l82.153" class="difflineplus">+  setupModule();</span>
<a href="#l82.154"></a><span id="l82.154" class="difflineplus">+</span>
<a href="#l82.155"></a><span id="l82.155" class="difflineplus">+  // now copy everything into the module they provided to us...</span>
<a href="#l82.156"></a><span id="l82.156" class="difflineplus">+  let us = collector.getModule('folder-display-helpers');</span>
<a href="#l82.157"></a><span id="l82.157" class="difflineplus">+  for each (let [key, value] in Iterator(us)) {</span>
<a href="#l82.158"></a><span id="l82.158" class="difflineplus">+    if (!(key in DO_NOT_EXPORT) &amp;&amp;</span>
<a href="#l82.159"></a><span id="l82.159" class="difflineplus">+        key[0] != &quot;_&quot;)</span>
<a href="#l82.160"></a><span id="l82.160" class="difflineplus">+      module[key] = value;</span>
<a href="#l82.161"></a><span id="l82.161" class="difflineplus">+  }</span>
<a href="#l82.162"></a><span id="l82.162" class="difflineplus">+}</span>
<a href="#l82.163"></a><span id="l82.163" class="difflineplus">+</span>
<a href="#l82.164"></a><span id="l82.164" class="difflineplus">+function setupAccountStuff() {</span>
<a href="#l82.165"></a><span id="l82.165" class="difflineplus">+  // Create a local account to work with folders.</span>
<a href="#l82.166"></a><span id="l82.166" class="difflineplus">+  // (Note this gives you an Outbox and Trash folder by default).</span>
<a href="#l82.167"></a><span id="l82.167" class="difflineplus">+  let acctMgr = Components.classes[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l82.168"></a><span id="l82.168" class="difflineplus">+                          .getService(Components.interfaces.nsIMsgAccountManager);</span>
<a href="#l82.169"></a><span id="l82.169" class="difflineplus">+  //acctMgr.createLocalMailAccount();</span>
<a href="#l82.170"></a><span id="l82.170" class="difflineplus">+</span>
<a href="#l82.171"></a><span id="l82.171" class="difflineplus">+  gLocalIncomingServer = acctMgr.localFoldersServer;</span>
<a href="#l82.172"></a><span id="l82.172" class="difflineplus">+</span>
<a href="#l82.173"></a><span id="l82.173" class="difflineplus">+  rootFolder = gLocalIncomingServer.rootMsgFolder;</span>
<a href="#l82.174"></a><span id="l82.174" class="difflineplus">+  // Note: Inbox is not created automatically when there is no deferred server,</span>
<a href="#l82.175"></a><span id="l82.175" class="difflineplus">+  // so we need to create it.</span>
<a href="#l82.176"></a><span id="l82.176" class="difflineplus">+  gLocalInboxFolder = rootFolder.addSubfolder(&quot;Inbox&quot;);</span>
<a href="#l82.177"></a><span id="l82.177" class="difflineplus">+  // a local inbox should have a Mail flag!</span>
<a href="#l82.178"></a><span id="l82.178" class="difflineplus">+  gLocalInboxFolder.setFlag(Components.interfaces.nsMsgFolderFlags.Mail);</span>
<a href="#l82.179"></a><span id="l82.179" class="difflineplus">+</span>
<a href="#l82.180"></a><span id="l82.180" class="difflineplus">+  // Force an initialization of the Inbox folder database.</span>
<a href="#l82.181"></a><span id="l82.181" class="difflineplus">+  var folderName = gLocalInboxFolder.prettiestName;</span>
<a href="#l82.182"></a><span id="l82.182" class="difflineplus">+</span>
<a href="#l82.183"></a><span id="l82.183" class="difflineplus">+  gLocalInboxFolder = rootFolder.getChildNamed(&quot;Inbox&quot;);</span>
<a href="#l82.184"></a><span id="l82.184" class="difflineplus">+}</span>
<a href="#l82.185"></a><span id="l82.185" class="difflineplus">+</span>
<a href="#l82.186"></a><span id="l82.186" class="difflineplus">+/*</span>
<a href="#l82.187"></a><span id="l82.187" class="difflineplus">+ * Although we all agree that the use of generators when dealing with async</span>
<a href="#l82.188"></a><span id="l82.188" class="difflineplus">+ *  operations is awesome, the mozmill idiom is for calls to be synchronous and</span>
<a href="#l82.189"></a><span id="l82.189" class="difflineplus">+ *  just spin event loops when they need to wait for things to happen.  This</span>
<a href="#l82.190"></a><span id="l82.190" class="difflineplus">+ *  does make the test code significantly less confusing, so we do it too.</span>
<a href="#l82.191"></a><span id="l82.191" class="difflineplus">+ * All of our operations are synchronous and just spin until they are happy.</span>
<a href="#l82.192"></a><span id="l82.192" class="difflineplus">+ */</span>
<a href="#l82.193"></a><span id="l82.193" class="difflineplus">+</span>
<a href="#l82.194"></a><span id="l82.194" class="difflineplus">+const NORMAL_TIMEOUT = 6000;</span>
<a href="#l82.195"></a><span id="l82.195" class="difflineplus">+const FAST_INTERVAL = 100;</span>
<a href="#l82.196"></a><span id="l82.196" class="difflineplus">+</span>
<a href="#l82.197"></a><span id="l82.197" class="difflineplus">+/**</span>
<a href="#l82.198"></a><span id="l82.198" class="difflineplus">+ * Create a folder and rebuild the folder tree view.</span>
<a href="#l82.199"></a><span id="l82.199" class="difflineplus">+ */</span>
<a href="#l82.200"></a><span id="l82.200" class="difflineplus">+function create_folder(aFolderName) {</span>
<a href="#l82.201"></a><span id="l82.201" class="difflineplus">+  let folder = rootFolder.addSubfolder(aFolderName);</span>
<a href="#l82.202"></a><span id="l82.202" class="difflineplus">+  mc.folderTreeView.mode = &quot;all&quot;;</span>
<a href="#l82.203"></a><span id="l82.203" class="difflineplus">+  return folder;</span>
<a href="#l82.204"></a><span id="l82.204" class="difflineplus">+}</span>
<a href="#l82.205"></a><span id="l82.205" class="difflineplus">+</span>
<a href="#l82.206"></a><span id="l82.206" class="difflineplus">+/**</span>
<a href="#l82.207"></a><span id="l82.207" class="difflineplus">+ * Create a thread with the specified number of messages in it.</span>
<a href="#l82.208"></a><span id="l82.208" class="difflineplus">+ */</span>
<a href="#l82.209"></a><span id="l82.209" class="difflineplus">+function create_thread(aCount) {</span>
<a href="#l82.210"></a><span id="l82.210" class="difflineplus">+  return new viewWrapperTestUtils.SyntheticMessageSet(viewWrapperTestUtils.gMessageScenarioFactory.directReply(aCount));</span>
<a href="#l82.211"></a><span id="l82.211" class="difflineplus">+}</span>
<a href="#l82.212"></a><span id="l82.212" class="difflineplus">+</span>
<a href="#l82.213"></a><span id="l82.213" class="difflineplus">+/**</span>
<a href="#l82.214"></a><span id="l82.214" class="difflineplus">+ * Make sure we are entering the folder from not having been in the folder.  We</span>
<a href="#l82.215"></a><span id="l82.215" class="difflineplus">+ *  will leave the folder and come back if we have to.</span>
<a href="#l82.216"></a><span id="l82.216" class="difflineplus">+ */</span>
<a href="#l82.217"></a><span id="l82.217" class="difflineplus">+function enter_folder(aFolder) {</span>
<a href="#l82.218"></a><span id="l82.218" class="difflineplus">+  // if we're already selected, go back to the root...</span>
<a href="#l82.219"></a><span id="l82.219" class="difflineplus">+  if (mc.folderDisplay.displayedFolder == aFolder)</span>
<a href="#l82.220"></a><span id="l82.220" class="difflineplus">+    enter_folder(aFolder.rootFolder);</span>
<a href="#l82.221"></a><span id="l82.221" class="difflineplus">+</span>
<a href="#l82.222"></a><span id="l82.222" class="difflineplus">+  mc.folderTreeView.selectFolder(aFolder);</span>
<a href="#l82.223"></a><span id="l82.223" class="difflineplus">+  wait_for_all_messages_to_load();</span>
<a href="#l82.224"></a><span id="l82.224" class="difflineplus">+  // and drain the event queue</span>
<a href="#l82.225"></a><span id="l82.225" class="difflineplus">+  controller.sleep(0);</span>
<a href="#l82.226"></a><span id="l82.226" class="difflineplus">+}</span>
<a href="#l82.227"></a><span id="l82.227" class="difflineplus">+</span>
<a href="#l82.228"></a><span id="l82.228" class="difflineplus">+/**</span>
<a href="#l82.229"></a><span id="l82.229" class="difflineplus">+ * Make sure we are in the given folder, entering it if we were not.</span>
<a href="#l82.230"></a><span id="l82.230" class="difflineplus">+ *</span>
<a href="#l82.231"></a><span id="l82.231" class="difflineplus">+ * @return The tab info of the current tab (a more persistent identifier for</span>
<a href="#l82.232"></a><span id="l82.232" class="difflineplus">+ *     tabs than the index, which will change as tabs open/close).</span>
<a href="#l82.233"></a><span id="l82.233" class="difflineplus">+ */</span>
<a href="#l82.234"></a><span id="l82.234" class="difflineplus">+function be_in_folder(aFolder) {</span>
<a href="#l82.235"></a><span id="l82.235" class="difflineplus">+  if (mc.folderDisplay.displayedFolder != aFolder)</span>
<a href="#l82.236"></a><span id="l82.236" class="difflineplus">+    enter_folder(aFolder);</span>
<a href="#l82.237"></a><span id="l82.237" class="difflineplus">+  return mc.tabmail.currentTabInfo;</span>
<a href="#l82.238"></a><span id="l82.238" class="difflineplus">+}</span>
<a href="#l82.239"></a><span id="l82.239" class="difflineplus">+</span>
<a href="#l82.240"></a><span id="l82.240" class="difflineplus">+/**</span>
<a href="#l82.241"></a><span id="l82.241" class="difflineplus">+ * Create a new tab displaying a folder, making that tab the current tab.</span>
<a href="#l82.242"></a><span id="l82.242" class="difflineplus">+ *</span>
<a href="#l82.243"></a><span id="l82.243" class="difflineplus">+ * @return The tab info of the current tab (a more persistent identifier for</span>
<a href="#l82.244"></a><span id="l82.244" class="difflineplus">+ *     tabs than the index, which will change as tabs open/close).</span>
<a href="#l82.245"></a><span id="l82.245" class="difflineplus">+ */</span>
<a href="#l82.246"></a><span id="l82.246" class="difflineplus">+function open_folder_in_new_tab(aFolder) {</span>
<a href="#l82.247"></a><span id="l82.247" class="difflineplus">+  // save the current tab as the 'other' tab</span>
<a href="#l82.248"></a><span id="l82.248" class="difflineplus">+  otherTab = mc.tabmail.currentTabInfo;</span>
<a href="#l82.249"></a><span id="l82.249" class="difflineplus">+  mc.tabmail.openTab(&quot;folder&quot;, aFolder);</span>
<a href="#l82.250"></a><span id="l82.250" class="difflineplus">+  wait_for_all_messages_to_load();</span>
<a href="#l82.251"></a><span id="l82.251" class="difflineplus">+  return mc.tabmail.currentTabInfo;</span>
<a href="#l82.252"></a><span id="l82.252" class="difflineplus">+}</span>
<a href="#l82.253"></a><span id="l82.253" class="difflineplus">+</span>
<a href="#l82.254"></a><span id="l82.254" class="difflineplus">+/**</span>
<a href="#l82.255"></a><span id="l82.255" class="difflineplus">+ * Create a new tab displaying the currently selected message, making that tab</span>
<a href="#l82.256"></a><span id="l82.256" class="difflineplus">+ *  the current tab.  We block until the message finishes loading.</span>
<a href="#l82.257"></a><span id="l82.257" class="difflineplus">+ *</span>
<a href="#l82.258"></a><span id="l82.258" class="difflineplus">+ * @return The tab info of the current tab (a more persistent identifier for</span>
<a href="#l82.259"></a><span id="l82.259" class="difflineplus">+ *     tabs than the index, which will change as tabs open/close).</span>
<a href="#l82.260"></a><span id="l82.260" class="difflineplus">+ */</span>
<a href="#l82.261"></a><span id="l82.261" class="difflineplus">+function open_selected_message_in_new_tab() {</span>
<a href="#l82.262"></a><span id="l82.262" class="difflineplus">+  // get the current tab count so we can make sure the tab actually opened.</span>
<a href="#l82.263"></a><span id="l82.263" class="difflineplus">+  let preCount = mc.tabmail.tabContainer.childNodes.length;</span>
<a href="#l82.264"></a><span id="l82.264" class="difflineplus">+</span>
<a href="#l82.265"></a><span id="l82.265" class="difflineplus">+  // save the current tab as the 'other' tab</span>
<a href="#l82.266"></a><span id="l82.266" class="difflineplus">+  otherTab = mc.tabmail.currentTabInfo;</span>
<a href="#l82.267"></a><span id="l82.267" class="difflineplus">+</span>
<a href="#l82.268"></a><span id="l82.268" class="difflineplus">+  mc.window.MsgOpenNewTabForMessage();</span>
<a href="#l82.269"></a><span id="l82.269" class="difflineplus">+  wait_for_message_display_completion(mc, true);</span>
<a href="#l82.270"></a><span id="l82.270" class="difflineplus">+</span>
<a href="#l82.271"></a><span id="l82.271" class="difflineplus">+  // check that the tab count increased</span>
<a href="#l82.272"></a><span id="l82.272" class="difflineplus">+  if (mc.tabmail.tabContainer.childNodes.length != preCount + 1)</span>
<a href="#l82.273"></a><span id="l82.273" class="difflineplus">+    throw new Error(&quot;The tab never actually got opened!&quot;);</span>
<a href="#l82.274"></a><span id="l82.274" class="difflineplus">+</span>
<a href="#l82.275"></a><span id="l82.275" class="difflineplus">+  return mc.tabmail.currentTabInfo;</span>
<a href="#l82.276"></a><span id="l82.276" class="difflineplus">+}</span>
<a href="#l82.277"></a><span id="l82.277" class="difflineplus">+</span>
<a href="#l82.278"></a><span id="l82.278" class="difflineplus">+/**</span>
<a href="#l82.279"></a><span id="l82.279" class="difflineplus">+ * Create a new window displaying the currently selected message.  We do not</span>
<a href="#l82.280"></a><span id="l82.280" class="difflineplus">+ *  return until the message has finished loading.</span>
<a href="#l82.281"></a><span id="l82.281" class="difflineplus">+ *</span>
<a href="#l82.282"></a><span id="l82.282" class="difflineplus">+ * @return The MozmillController-wrapped new window.</span>
<a href="#l82.283"></a><span id="l82.283" class="difflineplus">+ */</span>
<a href="#l82.284"></a><span id="l82.284" class="difflineplus">+function open_selected_message_in_new_window() {</span>
<a href="#l82.285"></a><span id="l82.285" class="difflineplus">+  windowHelper.plan_for_new_window(&quot;mail:messageWindow&quot;);</span>
<a href="#l82.286"></a><span id="l82.286" class="difflineplus">+  mc.window.MsgOpenNewWindowForMessage();</span>
<a href="#l82.287"></a><span id="l82.287" class="difflineplus">+  let msgc = windowHelper.wait_for_new_window(&quot;mail:messageWindow&quot;);</span>
<a href="#l82.288"></a><span id="l82.288" class="difflineplus">+  wait_for_message_display_completion(msgc, true);</span>
<a href="#l82.289"></a><span id="l82.289" class="difflineplus">+  return msgc;</span>
<a href="#l82.290"></a><span id="l82.290" class="difflineplus">+}</span>
<a href="#l82.291"></a><span id="l82.291" class="difflineplus">+</span>
<a href="#l82.292"></a><span id="l82.292" class="difflineplus">+/**</span>
<a href="#l82.293"></a><span id="l82.293" class="difflineplus">+ * Switch to another tab.  If no tab is specified, we switch to the 'other' tab.</span>
<a href="#l82.294"></a><span id="l82.294" class="difflineplus">+ *  That is the last tab we used, most likely the tab that was current when we</span>
<a href="#l82.295"></a><span id="l82.295" class="difflineplus">+ *  created this tab.</span>
<a href="#l82.296"></a><span id="l82.296" class="difflineplus">+ *</span>
<a href="#l82.297"></a><span id="l82.297" class="difflineplus">+ * @param aNewTab Optional, index of the other tab to switch to.</span>
<a href="#l82.298"></a><span id="l82.298" class="difflineplus">+ */</span>
<a href="#l82.299"></a><span id="l82.299" class="difflineplus">+function switch_tab(aNewTab) {</span>
<a href="#l82.300"></a><span id="l82.300" class="difflineplus">+  let targetTab = (aNewTab != null) ? aNewTab : otherTab;</span>
<a href="#l82.301"></a><span id="l82.301" class="difflineplus">+  // now the current tab will be the 'other' tab after we switch</span>
<a href="#l82.302"></a><span id="l82.302" class="difflineplus">+  otherTab = mc.tabmail.currentTabInfo;</span>
<a href="#l82.303"></a><span id="l82.303" class="difflineplus">+  mc.tabmail.switchToTab(targetTab);</span>
<a href="#l82.304"></a><span id="l82.304" class="difflineplus">+  wait_for_message_display_completion();</span>
<a href="#l82.305"></a><span id="l82.305" class="difflineplus">+}</span>
<a href="#l82.306"></a><span id="l82.306" class="difflineplus">+</span>
<a href="#l82.307"></a><span id="l82.307" class="difflineplus">+/**</span>
<a href="#l82.308"></a><span id="l82.308" class="difflineplus">+ * Assert that the given tab's title is based on the provided folder or</span>
<a href="#l82.309"></a><span id="l82.309" class="difflineplus">+ *  message.</span>
<a href="#l82.310"></a><span id="l82.310" class="difflineplus">+ *</span>
<a href="#l82.311"></a><span id="l82.311" class="difflineplus">+ * @param aTab A Tab.</span>
<a href="#l82.312"></a><span id="l82.312" class="difflineplus">+ * @param aWhat Either an nsIMsgFolder or an nsIMsgDBHdr</span>
<a href="#l82.313"></a><span id="l82.313" class="difflineplus">+ */</span>
<a href="#l82.314"></a><span id="l82.314" class="difflineplus">+function assert_tab_titled_from(aTab, aWhat) {</span>
<a href="#l82.315"></a><span id="l82.315" class="difflineplus">+  let text;</span>
<a href="#l82.316"></a><span id="l82.316" class="difflineplus">+  if (aWhat instanceof Ci.nsIMsgFolder)</span>
<a href="#l82.317"></a><span id="l82.317" class="difflineplus">+    text = aWhat.prettiestName;</span>
<a href="#l82.318"></a><span id="l82.318" class="difflineplus">+  else if (aWhat instanceof Ci.nsIMsgDBHdr)</span>
<a href="#l82.319"></a><span id="l82.319" class="difflineplus">+    text = aWhat.mime2DecodedSubject;</span>
<a href="#l82.320"></a><span id="l82.320" class="difflineplus">+</span>
<a href="#l82.321"></a><span id="l82.321" class="difflineplus">+  if (aTab.title.indexOf(text) == -1)</span>
<a href="#l82.322"></a><span id="l82.322" class="difflineplus">+    throw new Error(&quot;Tab title should include '&quot; + text + &quot;' but does not.&quot; +</span>
<a href="#l82.323"></a><span id="l82.323" class="difflineplus">+                    &quot; (Current title: '&quot; + aTab.title + &quot;'&quot;);</span>
<a href="#l82.324"></a><span id="l82.324" class="difflineplus">+}</span>
<a href="#l82.325"></a><span id="l82.325" class="difflineplus">+</span>
<a href="#l82.326"></a><span id="l82.326" class="difflineplus">+/**</span>
<a href="#l82.327"></a><span id="l82.327" class="difflineplus">+ * Close a tab.  If no tab is specified, it is assumed you want to close the</span>
<a href="#l82.328"></a><span id="l82.328" class="difflineplus">+ *  current tab.</span>
<a href="#l82.329"></a><span id="l82.329" class="difflineplus">+ */</span>
<a href="#l82.330"></a><span id="l82.330" class="difflineplus">+function close_tab(aTabToClose) {</span>
<a href="#l82.331"></a><span id="l82.331" class="difflineplus">+  // get the current tab count so we can make sure the tab actually opened.</span>
<a href="#l82.332"></a><span id="l82.332" class="difflineplus">+  let preCount = mc.tabmail.tabContainer.childNodes.length;</span>
<a href="#l82.333"></a><span id="l82.333" class="difflineplus">+</span>
<a href="#l82.334"></a><span id="l82.334" class="difflineplus">+  mc.tabmail.closeTab(aTabToClose);</span>
<a href="#l82.335"></a><span id="l82.335" class="difflineplus">+  wait_for_message_display_completion();</span>
<a href="#l82.336"></a><span id="l82.336" class="difflineplus">+</span>
<a href="#l82.337"></a><span id="l82.337" class="difflineplus">+  // check that the tab count decreased</span>
<a href="#l82.338"></a><span id="l82.338" class="difflineplus">+  if (mc.tabmail.tabContainer.childNodes.length != preCount - 1)</span>
<a href="#l82.339"></a><span id="l82.339" class="difflineplus">+    throw new Error(&quot;The tab never actually got closed!&quot;);</span>
<a href="#l82.340"></a><span id="l82.340" class="difflineplus">+}</span>
<a href="#l82.341"></a><span id="l82.341" class="difflineplus">+</span>
<a href="#l82.342"></a><span id="l82.342" class="difflineplus">+/**</span>
<a href="#l82.343"></a><span id="l82.343" class="difflineplus">+ * Clear the selection.  I'm not sure how we're pretending we did that.</span>
<a href="#l82.344"></a><span id="l82.344" class="difflineplus">+ */</span>
<a href="#l82.345"></a><span id="l82.345" class="difflineplus">+function select_none() {</span>
<a href="#l82.346"></a><span id="l82.346" class="difflineplus">+  wait_for_message_display_completion();</span>
<a href="#l82.347"></a><span id="l82.347" class="difflineplus">+  mc.dbView.selection.clearSelection();</span>
<a href="#l82.348"></a><span id="l82.348" class="difflineplus">+  // give the event queue a chance to drain...</span>
<a href="#l82.349"></a><span id="l82.349" class="difflineplus">+  controller.sleep(0);</span>
<a href="#l82.350"></a><span id="l82.350" class="difflineplus">+}</span>
<a href="#l82.351"></a><span id="l82.351" class="difflineplus">+</span>
<a href="#l82.352"></a><span id="l82.352" class="difflineplus">+function _normalize_view_index(aViewIndex) {</span>
<a href="#l82.353"></a><span id="l82.353" class="difflineplus">+  if (aViewIndex &lt; 0)</span>
<a href="#l82.354"></a><span id="l82.354" class="difflineplus">+    return mc.dbView.QueryInterface(Ci.nsITreeView).rowCount + aViewIndex;</span>
<a href="#l82.355"></a><span id="l82.355" class="difflineplus">+  return aViewIndex;</span>
<a href="#l82.356"></a><span id="l82.356" class="difflineplus">+}</span>
<a href="#l82.357"></a><span id="l82.357" class="difflineplus">+</span>
<a href="#l82.358"></a><span id="l82.358" class="difflineplus">+/**</span>
<a href="#l82.359"></a><span id="l82.359" class="difflineplus">+ * Pretend we are clicking on a row with our mouse.</span>
<a href="#l82.360"></a><span id="l82.360" class="difflineplus">+ *</span>
<a href="#l82.361"></a><span id="l82.361" class="difflineplus">+ * @param aViewIndex If &gt;= 0, the view index provided, if &lt; 0, a reference to</span>
<a href="#l82.362"></a><span id="l82.362" class="difflineplus">+ *     a view index counting from the last row in the tree.  -1 indicates the</span>
<a href="#l82.363"></a><span id="l82.363" class="difflineplus">+ *     last message in the tree, -2 the second to last, etc.</span>
<a href="#l82.364"></a><span id="l82.364" class="difflineplus">+ *</span>
<a href="#l82.365"></a><span id="l82.365" class="difflineplus">+ * @return The message header selected.</span>
<a href="#l82.366"></a><span id="l82.366" class="difflineplus">+ */</span>
<a href="#l82.367"></a><span id="l82.367" class="difflineplus">+function select_click_row(aViewIndex) {</span>
<a href="#l82.368"></a><span id="l82.368" class="difflineplus">+  wait_for_message_display_completion();</span>
<a href="#l82.369"></a><span id="l82.369" class="difflineplus">+  aViewIndex = _normalize_view_index(aViewIndex);</span>
<a href="#l82.370"></a><span id="l82.370" class="difflineplus">+  // this should set the current index as well as setting the selection.</span>
<a href="#l82.371"></a><span id="l82.371" class="difflineplus">+  mc.dbView.selection.select(aViewIndex);</span>
<a href="#l82.372"></a><span id="l82.372" class="difflineplus">+  wait_for_message_display_completion(mc, true);</span>
<a href="#l82.373"></a><span id="l82.373" class="difflineplus">+  return mc.dbView.getMsgHdrAt(aViewIndex);</span>
<a href="#l82.374"></a><span id="l82.374" class="difflineplus">+}</span>
<a href="#l82.375"></a><span id="l82.375" class="difflineplus">+</span>
<a href="#l82.376"></a><span id="l82.376" class="difflineplus">+/**</span>
<a href="#l82.377"></a><span id="l82.377" class="difflineplus">+ * Pretend we are toggling the thread specified by a row.</span>
<a href="#l82.378"></a><span id="l82.378" class="difflineplus">+ *</span>
<a href="#l82.379"></a><span id="l82.379" class="difflineplus">+ * @param aViewIndex If &gt;= 0, the view index provided, if &lt; 0, a reference to</span>
<a href="#l82.380"></a><span id="l82.380" class="difflineplus">+ *     a view index counting from the last row in the tree.  -1 indicates the</span>
<a href="#l82.381"></a><span id="l82.381" class="difflineplus">+ *     last message in the tree, -2 the second to last, etc.</span>
<a href="#l82.382"></a><span id="l82.382" class="difflineplus">+ *</span>
<a href="#l82.383"></a><span id="l82.383" class="difflineplus">+ */</span>
<a href="#l82.384"></a><span id="l82.384" class="difflineplus">+function toggle_thread_row(aViewIndex) {</span>
<a href="#l82.385"></a><span id="l82.385" class="difflineplus">+  wait_for_message_display_completion();</span>
<a href="#l82.386"></a><span id="l82.386" class="difflineplus">+  aViewIndex = _normalize_view_index(aViewIndex);</span>
<a href="#l82.387"></a><span id="l82.387" class="difflineplus">+  mc.dbView.toggleOpenState(aViewIndex);</span>
<a href="#l82.388"></a><span id="l82.388" class="difflineplus">+  wait_for_message_display_completion(mc, true);</span>
<a href="#l82.389"></a><span id="l82.389" class="difflineplus">+}</span>
<a href="#l82.390"></a><span id="l82.390" class="difflineplus">+</span>
<a href="#l82.391"></a><span id="l82.391" class="difflineplus">+</span>
<a href="#l82.392"></a><span id="l82.392" class="difflineplus">+/**</span>
<a href="#l82.393"></a><span id="l82.393" class="difflineplus">+ * Pretend we are clicking on a row with our mouse with the control key pressed,</span>
<a href="#l82.394"></a><span id="l82.394" class="difflineplus">+ *  resulting in the addition/removal of just that row to/from the selection.</span>
<a href="#l82.395"></a><span id="l82.395" class="difflineplus">+ *</span>
<a href="#l82.396"></a><span id="l82.396" class="difflineplus">+ * @param aViewIndex If &gt;= 0, the view index provided, if &lt; 0, a reference to</span>
<a href="#l82.397"></a><span id="l82.397" class="difflineplus">+ *     a view index counting from the last row in the tree.  -1 indicates the</span>
<a href="#l82.398"></a><span id="l82.398" class="difflineplus">+ *     last message in the tree, -2 the second to last, etc.</span>
<a href="#l82.399"></a><span id="l82.399" class="difflineplus">+ *</span>
<a href="#l82.400"></a><span id="l82.400" class="difflineplus">+ * @return The message header of the affected message.</span>
<a href="#l82.401"></a><span id="l82.401" class="difflineplus">+ */</span>
<a href="#l82.402"></a><span id="l82.402" class="difflineplus">+function select_control_click_row(aViewIndex) {</span>
<a href="#l82.403"></a><span id="l82.403" class="difflineplus">+  wait_for_message_display_completion();</span>
<a href="#l82.404"></a><span id="l82.404" class="difflineplus">+  aViewIndex = _normalize_view_index(aViewIndex);</span>
<a href="#l82.405"></a><span id="l82.405" class="difflineplus">+  // Control-clicking augments the selection and moves the current index.  It</span>
<a href="#l82.406"></a><span id="l82.406" class="difflineplus">+  //  also clears the shift pivot, but that's fine as it falls back to the</span>
<a href="#l82.407"></a><span id="l82.407" class="difflineplus">+  //  current index if there is no shift pivot, which works for duplicating</span>
<a href="#l82.408"></a><span id="l82.408" class="difflineplus">+  //  actual behavior.</span>
<a href="#l82.409"></a><span id="l82.409" class="difflineplus">+  mc.dbView.selection.rangedSelect(aViewIndex, aViewIndex, true);</span>
<a href="#l82.410"></a><span id="l82.410" class="difflineplus">+  mc.dbView.selection.currentIndex = aViewIndex;</span>
<a href="#l82.411"></a><span id="l82.411" class="difflineplus">+  // give the event queue a chance to drain...</span>
<a href="#l82.412"></a><span id="l82.412" class="difflineplus">+  controller.sleep(0);</span>
<a href="#l82.413"></a><span id="l82.413" class="difflineplus">+  wait_for_message_display_completion();</span>
<a href="#l82.414"></a><span id="l82.414" class="difflineplus">+  return mc.dbView.getMsgHdrAt(aViewIndex);</span>
<a href="#l82.415"></a><span id="l82.415" class="difflineplus">+}</span>
<a href="#l82.416"></a><span id="l82.416" class="difflineplus">+</span>
<a href="#l82.417"></a><span id="l82.417" class="difflineplus">+/**</span>
<a href="#l82.418"></a><span id="l82.418" class="difflineplus">+ * Pretend we are clicking on a row with our mouse with the shift key pressed,</span>
<a href="#l82.419"></a><span id="l82.419" class="difflineplus">+ *  adding all the messages between the shift pivot and the shift selected row.</span>
<a href="#l82.420"></a><span id="l82.420" class="difflineplus">+ *</span>
<a href="#l82.421"></a><span id="l82.421" class="difflineplus">+ * @param aViewIndex If &gt;= 0, the view index provided, if &lt; 0, a reference to</span>
<a href="#l82.422"></a><span id="l82.422" class="difflineplus">+ *     a view index counting from the last row in the tree.  -1 indicates the</span>
<a href="#l82.423"></a><span id="l82.423" class="difflineplus">+ *     last message in the tree, -2 the second to last, etc.</span>
<a href="#l82.424"></a><span id="l82.424" class="difflineplus">+ *</span>
<a href="#l82.425"></a><span id="l82.425" class="difflineplus">+ * @return The message headers for all messages that are now selected.</span>
<a href="#l82.426"></a><span id="l82.426" class="difflineplus">+ */</span>
<a href="#l82.427"></a><span id="l82.427" class="difflineplus">+function select_shift_click_row(aViewIndex) {</span>
<a href="#l82.428"></a><span id="l82.428" class="difflineplus">+  wait_for_message_display_completion();</span>
<a href="#l82.429"></a><span id="l82.429" class="difflineplus">+  aViewIndex = _normalize_view_index(aViewIndex);</span>
<a href="#l82.430"></a><span id="l82.430" class="difflineplus">+  // Passing -1 as the start range checks the shift-pivot, which should be -1,</span>
<a href="#l82.431"></a><span id="l82.431" class="difflineplus">+  //  so it should fall over to the current index, which is what we want.  It</span>
<a href="#l82.432"></a><span id="l82.432" class="difflineplus">+  //  will then set the shift-pivot to the previously-current-index and update</span>
<a href="#l82.433"></a><span id="l82.433" class="difflineplus">+  //  the current index to be what we shift-clicked on.  All matches user</span>
<a href="#l82.434"></a><span id="l82.434" class="difflineplus">+  //  interaction.</span>
<a href="#l82.435"></a><span id="l82.435" class="difflineplus">+  mc.dbView.selection.rangedSelect(-1, aViewIndex, false);</span>
<a href="#l82.436"></a><span id="l82.436" class="difflineplus">+  // give the event queue a chance to drain...</span>
<a href="#l82.437"></a><span id="l82.437" class="difflineplus">+  controller.sleep(0);</span>
<a href="#l82.438"></a><span id="l82.438" class="difflineplus">+  wait_for_message_display_completion();</span>
<a href="#l82.439"></a><span id="l82.439" class="difflineplus">+  return mc.folderDisplay.selectedMessages;</span>
<a href="#l82.440"></a><span id="l82.440" class="difflineplus">+}</span>
<a href="#l82.441"></a><span id="l82.441" class="difflineplus">+</span>
<a href="#l82.442"></a><span id="l82.442" class="difflineplus">+/**</span>
<a href="#l82.443"></a><span id="l82.443" class="difflineplus">+ * Helper function to click on a row with a given button.</span>
<a href="#l82.444"></a><span id="l82.444" class="difflineplus">+ */</span>
<a href="#l82.445"></a><span id="l82.445" class="difflineplus">+function _row_click_helper(aViewIndex, aButton) {</span>
<a href="#l82.446"></a><span id="l82.446" class="difflineplus">+  let treeBox = mc.threadTree.treeBoxObject;</span>
<a href="#l82.447"></a><span id="l82.447" class="difflineplus">+  // very important, gotta be able to see the row</span>
<a href="#l82.448"></a><span id="l82.448" class="difflineplus">+  treeBox.ensureRowIsVisible(aViewIndex);</span>
<a href="#l82.449"></a><span id="l82.449" class="difflineplus">+  // now figure out the coords</span>
<a href="#l82.450"></a><span id="l82.450" class="difflineplus">+  let children = mc.e(&quot;threadTree&quot;, {tagName: &quot;treechildren&quot;});</span>
<a href="#l82.451"></a><span id="l82.451" class="difflineplus">+  let x = children.boxObject.x;</span>
<a href="#l82.452"></a><span id="l82.452" class="difflineplus">+  let y = children.boxObject.y;</span>
<a href="#l82.453"></a><span id="l82.453" class="difflineplus">+  let rowX = 10;</span>
<a href="#l82.454"></a><span id="l82.454" class="difflineplus">+  let rowY = treeBox.rowHeight * (aViewIndex - treeBox.getFirstVisibleRow());</span>
<a href="#l82.455"></a><span id="l82.455" class="difflineplus">+  if (treeBox.getRowAt(x + rowX, y + rowY) != aViewIndex) {</span>
<a href="#l82.456"></a><span id="l82.456" class="difflineplus">+    throw new Error(&quot;Thought we would find row &quot; + aViewIndex + &quot; at &quot; +</span>
<a href="#l82.457"></a><span id="l82.457" class="difflineplus">+                    rowX + &quot;,&quot; + rowY + &quot; but we found &quot; +</span>
<a href="#l82.458"></a><span id="l82.458" class="difflineplus">+                    treeBox.getRowAt(rowX, rowY));</span>
<a href="#l82.459"></a><span id="l82.459" class="difflineplus">+  }</span>
<a href="#l82.460"></a><span id="l82.460" class="difflineplus">+  let tx = mc.threadTree.boxObject.x;</span>
<a href="#l82.461"></a><span id="l82.461" class="difflineplus">+  let ty = mc.threadTree.boxObject.y;</span>
<a href="#l82.462"></a><span id="l82.462" class="difflineplus">+  EventUtils.synthesizeMouse(mc.threadTree, x + rowX - tx, y + rowY - ty,</span>
<a href="#l82.463"></a><span id="l82.463" class="difflineplus">+                             {type: &quot;mousedown&quot;, button: aButton}, mc.window);</span>
<a href="#l82.464"></a><span id="l82.464" class="difflineplus">+  if (aButton == 2)</span>
<a href="#l82.465"></a><span id="l82.465" class="difflineplus">+    EventUtils.synthesizeMouse(mc.threadTree, x + rowX - tx, y + rowY - ty,</span>
<a href="#l82.466"></a><span id="l82.466" class="difflineplus">+                               {type: &quot;contextmenu&quot;, button: aButton},</span>
<a href="#l82.467"></a><span id="l82.467" class="difflineplus">+                               mc.window);</span>
<a href="#l82.468"></a><span id="l82.468" class="difflineplus">+  EventUtils.synthesizeMouse(mc.threadTree, x + rowX - tx, y + rowY - ty,</span>
<a href="#l82.469"></a><span id="l82.469" class="difflineplus">+                             {type: &quot;mouseup&quot;, button: aButton}, mc.window);</span>
<a href="#l82.470"></a><span id="l82.470" class="difflineplus">+}</span>
<a href="#l82.471"></a><span id="l82.471" class="difflineplus">+</span>
<a href="#l82.472"></a><span id="l82.472" class="difflineplus">+/**</span>
<a href="#l82.473"></a><span id="l82.473" class="difflineplus">+ * Right-click on the tree-view in question.  With any luck, this will have</span>
<a href="#l82.474"></a><span id="l82.474" class="difflineplus">+ *  the side-effect of opening up a pop-up which it is then on _your_ head</span>
<a href="#l82.475"></a><span id="l82.475" class="difflineplus">+ *  to do something with or close.  However, we have helpful popup function</span>
<a href="#l82.476"></a><span id="l82.476" class="difflineplus">+ *  helpers because I'm so nice.</span>
<a href="#l82.477"></a><span id="l82.477" class="difflineplus">+ *</span>
<a href="#l82.478"></a><span id="l82.478" class="difflineplus">+ * @return The message header that you clicked on.</span>
<a href="#l82.479"></a><span id="l82.479" class="difflineplus">+ */</span>
<a href="#l82.480"></a><span id="l82.480" class="difflineplus">+function right_click_on_row(aViewIndex) {</span>
<a href="#l82.481"></a><span id="l82.481" class="difflineplus">+  let msgHdr = mc.dbView.getMsgHdrAt(aViewIndex);</span>
<a href="#l82.482"></a><span id="l82.482" class="difflineplus">+  _row_click_helper(aViewIndex, 2);</span>
<a href="#l82.483"></a><span id="l82.483" class="difflineplus">+  return msgHdr;</span>
<a href="#l82.484"></a><span id="l82.484" class="difflineplus">+}</span>
<a href="#l82.485"></a><span id="l82.485" class="difflineplus">+</span>
<a href="#l82.486"></a><span id="l82.486" class="difflineplus">+/**</span>
<a href="#l82.487"></a><span id="l82.487" class="difflineplus">+ * Middle-click on the tree-view in question, presumably opening a new message</span>
<a href="#l82.488"></a><span id="l82.488" class="difflineplus">+ *  tab.</span>
<a href="#l82.489"></a><span id="l82.489" class="difflineplus">+ *</span>
<a href="#l82.490"></a><span id="l82.490" class="difflineplus">+ * @return [The new tab, the message that you clicked on.]</span>
<a href="#l82.491"></a><span id="l82.491" class="difflineplus">+ */</span>
<a href="#l82.492"></a><span id="l82.492" class="difflineplus">+function middle_click_on_row(aViewIndex) {</span>
<a href="#l82.493"></a><span id="l82.493" class="difflineplus">+  let msgHdr = mc.dbView.getMsgHdrAt(aViewIndex);</span>
<a href="#l82.494"></a><span id="l82.494" class="difflineplus">+  _row_click_helper(aViewIndex, 1);</span>
<a href="#l82.495"></a><span id="l82.495" class="difflineplus">+  return [mc.tabmail.currentTabInfo, msgHdr];</span>
<a href="#l82.496"></a><span id="l82.496" class="difflineplus">+}</span>
<a href="#l82.497"></a><span id="l82.497" class="difflineplus">+</span>
<a href="#l82.498"></a><span id="l82.498" class="difflineplus">+/**</span>
<a href="#l82.499"></a><span id="l82.499" class="difflineplus">+ * Assuming the context popup is popped-up (via right_click_on_row), select</span>
<a href="#l82.500"></a><span id="l82.500" class="difflineplus">+ *  the deletion option.  If the popup is not popped up, you are out of luck.</span>
<a href="#l82.501"></a><span id="l82.501" class="difflineplus">+ */</span>
<a href="#l82.502"></a><span id="l82.502" class="difflineplus">+function delete_via_popup() {</span>
<a href="#l82.503"></a><span id="l82.503" class="difflineplus">+  plan_to_wait_for_folder_events(&quot;DeleteOrMoveMsgCompleted&quot;,</span>
<a href="#l82.504"></a><span id="l82.504" class="difflineplus">+                                 &quot;DeleteOrMoveMsgFailed&quot;);</span>
<a href="#l82.505"></a><span id="l82.505" class="difflineplus">+  mc.click(mc.eid(&quot;mailContext-delete&quot;));</span>
<a href="#l82.506"></a><span id="l82.506" class="difflineplus">+  // for reasons unknown, the pop-up does not close itself?</span>
<a href="#l82.507"></a><span id="l82.507" class="difflineplus">+  close_popup();</span>
<a href="#l82.508"></a><span id="l82.508" class="difflineplus">+  wait_for_folder_events();</span>
<a href="#l82.509"></a><span id="l82.509" class="difflineplus">+}</span>
<a href="#l82.510"></a><span id="l82.510" class="difflineplus">+</span>
<a href="#l82.511"></a><span id="l82.511" class="difflineplus">+/**</span>
<a href="#l82.512"></a><span id="l82.512" class="difflineplus">+ * Close the open pop-up.</span>
<a href="#l82.513"></a><span id="l82.513" class="difflineplus">+ */</span>
<a href="#l82.514"></a><span id="l82.514" class="difflineplus">+function close_popup(aController) {</span>
<a href="#l82.515"></a><span id="l82.515" class="difflineplus">+  if (aController === undefined)</span>
<a href="#l82.516"></a><span id="l82.516" class="difflineplus">+    aController = mc;</span>
<a href="#l82.517"></a><span id="l82.517" class="difflineplus">+  aController.keypress(aController.eid(&quot;mailContext&quot;), &quot;VK_ESCAPE&quot;, {});</span>
<a href="#l82.518"></a><span id="l82.518" class="difflineplus">+  // drain event queue</span>
<a href="#l82.519"></a><span id="l82.519" class="difflineplus">+  aController.sleep(0);</span>
<a href="#l82.520"></a><span id="l82.520" class="difflineplus">+}</span>
<a href="#l82.521"></a><span id="l82.521" class="difflineplus">+</span>
<a href="#l82.522"></a><span id="l82.522" class="difflineplus">+/**</span>
<a href="#l82.523"></a><span id="l82.523" class="difflineplus">+ * Pretend we are pressing the delete key, triggering message deletion of the</span>
<a href="#l82.524"></a><span id="l82.524" class="difflineplus">+ *  selected messages.</span>
<a href="#l82.525"></a><span id="l82.525" class="difflineplus">+ *</span>
<a href="#l82.526"></a><span id="l82.526" class="difflineplus">+ * @param aController The controller in whose context to do this, defaults to</span>
<a href="#l82.527"></a><span id="l82.527" class="difflineplus">+ *     |mc| if omitted.</span>
<a href="#l82.528"></a><span id="l82.528" class="difflineplus">+ */</span>
<a href="#l82.529"></a><span id="l82.529" class="difflineplus">+function press_delete(aController) {</span>
<a href="#l82.530"></a><span id="l82.530" class="difflineplus">+  if (aController === undefined)</span>
<a href="#l82.531"></a><span id="l82.531" class="difflineplus">+    aController = mc;</span>
<a href="#l82.532"></a><span id="l82.532" class="difflineplus">+  // if something is loading, make sure it finishes loading...</span>
<a href="#l82.533"></a><span id="l82.533" class="difflineplus">+  wait_for_message_display_completion(aController);</span>
<a href="#l82.534"></a><span id="l82.534" class="difflineplus">+  plan_to_wait_for_folder_events(&quot;DeleteOrMoveMsgCompleted&quot;,</span>
<a href="#l82.535"></a><span id="l82.535" class="difflineplus">+                                 &quot;DeleteOrMoveMsgFailed&quot;);</span>
<a href="#l82.536"></a><span id="l82.536" class="difflineplus">+  aController.keypress(aController == mc ? mc.eThreadTree : null,</span>
<a href="#l82.537"></a><span id="l82.537" class="difflineplus">+                       &quot;VK_DELETE&quot;, {});</span>
<a href="#l82.538"></a><span id="l82.538" class="difflineplus">+  wait_for_folder_events();</span>
<a href="#l82.539"></a><span id="l82.539" class="difflineplus">+}</span>
<a href="#l82.540"></a><span id="l82.540" class="difflineplus">+</span>
<a href="#l82.541"></a><span id="l82.541" class="difflineplus">+/**</span>
<a href="#l82.542"></a><span id="l82.542" class="difflineplus">+ * Wait for the |folderDisplay| on aController (defaults to mc if omitted) to</span>
<a href="#l82.543"></a><span id="l82.543" class="difflineplus">+ *  finish loading.  This generally only matters for folders that have an active</span>
<a href="#l82.544"></a><span id="l82.544" class="difflineplus">+ *  search.</span>
<a href="#l82.545"></a><span id="l82.545" class="difflineplus">+ * This method is generally called automatically most of the time, and you</span>
<a href="#l82.546"></a><span id="l82.546" class="difflineplus">+ *  should not need to call it yourself unless you are operating outside the</span>
<a href="#l82.547"></a><span id="l82.547" class="difflineplus">+ *  helper methods in this file.</span>
<a href="#l82.548"></a><span id="l82.548" class="difflineplus">+ */</span>
<a href="#l82.549"></a><span id="l82.549" class="difflineplus">+function wait_for_all_messages_to_load(aController) {</span>
<a href="#l82.550"></a><span id="l82.550" class="difflineplus">+  if (aController === undefined)</span>
<a href="#l82.551"></a><span id="l82.551" class="difflineplus">+    aController = mc;</span>
<a href="#l82.552"></a><span id="l82.552" class="difflineplus">+  if (aController.allMessagesLoaded) {</span>
<a href="#l82.553"></a><span id="l82.553" class="difflineplus">+    // even though we're taking the fast-path out, let's give the event loop a</span>
<a href="#l82.554"></a><span id="l82.554" class="difflineplus">+    //  chance to drain.</span>
<a href="#l82.555"></a><span id="l82.555" class="difflineplus">+    aController.sleep(0);</span>
<a href="#l82.556"></a><span id="l82.556" class="difflineplus">+    return;</span>
<a href="#l82.557"></a><span id="l82.557" class="difflineplus">+  }</span>
<a href="#l82.558"></a><span id="l82.558" class="difflineplus">+  if(!controller.waitForEval('subject.allMessagesLoaded', NORMAL_TIMEOUT,</span>
<a href="#l82.559"></a><span id="l82.559" class="difflineplus">+                              FAST_INTERVAL, aController.folderDisplay))</span>
<a href="#l82.560"></a><span id="l82.560" class="difflineplus">+    throw new Error(&quot;Messages never finished loading.  Timed Out.&quot;);</span>
<a href="#l82.561"></a><span id="l82.561" class="difflineplus">+  // the above may return immediately, meaning the event queue might not get a</span>
<a href="#l82.562"></a><span id="l82.562" class="difflineplus">+  //  chance.  give it a chance now.</span>
<a href="#l82.563"></a><span id="l82.563" class="difflineplus">+  aController.sleep(0);</span>
<a href="#l82.564"></a><span id="l82.564" class="difflineplus">+}</span>
<a href="#l82.565"></a><span id="l82.565" class="difflineplus">+</span>
<a href="#l82.566"></a><span id="l82.566" class="difflineplus">+/**</span>
<a href="#l82.567"></a><span id="l82.567" class="difflineplus">+ * If  a message is in the process of loading, let it finish.  Otherwise we get</span>
<a href="#l82.568"></a><span id="l82.568" class="difflineplus">+ *  horrible assertions like so:</span>
<a href="#l82.569"></a><span id="l82.569" class="difflineplus">+ * ###!!! ASSERTION: Overwriting an existing document channel!</span>
<a href="#l82.570"></a><span id="l82.570" class="difflineplus">+ *</span>
<a href="#l82.571"></a><span id="l82.571" class="difflineplus">+ * @param aController optional controller, defaulting to |mc|.</span>
<a href="#l82.572"></a><span id="l82.572" class="difflineplus">+ * @param aLoadDemanded optional indication that we expect and demand that a</span>
<a href="#l82.573"></a><span id="l82.573" class="difflineplus">+ *     message be loaded.  If you call us before the message loading is</span>
<a href="#l82.574"></a><span id="l82.574" class="difflineplus">+ *     initiated, you will need to pass true for this so that we don't see</span>
<a href="#l82.575"></a><span id="l82.575" class="difflineplus">+ *     that a load hasn't started and assume none is required.  Defaults to</span>
<a href="#l82.576"></a><span id="l82.576" class="difflineplus">+ *     false.  This relies on aController.messageDisplay.messageLoaded to</span>
<a href="#l82.577"></a><span id="l82.577" class="difflineplus">+ *     be reliable; make sure it is false when entering this function.</span>
<a href="#l82.578"></a><span id="l82.578" class="difflineplus">+ */</span>
<a href="#l82.579"></a><span id="l82.579" class="difflineplus">+function wait_for_message_display_completion(aController, aLoadDemanded) {</span>
<a href="#l82.580"></a><span id="l82.580" class="difflineplus">+  if (aController === undefined)</span>
<a href="#l82.581"></a><span id="l82.581" class="difflineplus">+    aController = mc;</span>
<a href="#l82.582"></a><span id="l82.582" class="difflineplus">+  let contentPane = aController.contentPane;</span>
<a href="#l82.583"></a><span id="l82.583" class="difflineplus">+  let oldHref = null;</span>
<a href="#l82.584"></a><span id="l82.584" class="difflineplus">+</span>
<a href="#l82.585"></a><span id="l82.585" class="difflineplus">+  // There are a couple possible states the universe can be in:</span>
<a href="#l82.586"></a><span id="l82.586" class="difflineplus">+  // 1) No message load happened or is going to happen.</span>
<a href="#l82.587"></a><span id="l82.587" class="difflineplus">+  // 2) The only message load that is going to happened has happened.</span>
<a href="#l82.588"></a><span id="l82.588" class="difflineplus">+  // 3) A message load is happening right now.</span>
<a href="#l82.589"></a><span id="l82.589" class="difflineplus">+  // 4) A message load should happen in the near future.</span>
<a href="#l82.590"></a><span id="l82.590" class="difflineplus">+  //</span>
<a href="#l82.591"></a><span id="l82.591" class="difflineplus">+  // We have nothing that needs to be done in cases 1 and 2.  Case 3 is pretty</span>
<a href="#l82.592"></a><span id="l82.592" class="difflineplus">+  //  easy for us.  The question is differentiating between case 4 and (1, 2).</span>
<a href="#l82.593"></a><span id="l82.593" class="difflineplus">+  //  We rely on MessageDisplayWidget.messageLoaded to differentiate this case</span>
<a href="#l82.594"></a><span id="l82.594" class="difflineplus">+  //  for us.</span>
<a href="#l82.595"></a><span id="l82.595" class="difflineplus">+  let isLoadedChecker = function() {</span>
<a href="#l82.596"></a><span id="l82.596" class="difflineplus">+    // If a load is demanded, first require that MessageDisplayWidget think</span>
<a href="#l82.597"></a><span id="l82.597" class="difflineplus">+    //  that the message is loaded.  Because the notification is imperfect,</span>
<a href="#l82.598"></a><span id="l82.598" class="difflineplus">+    //  this will strictly happen before the URL finishes running.</span>
<a href="#l82.599"></a><span id="l82.599" class="difflineplus">+    if (aLoadDemanded &amp;&amp; !aController.messageDisplay.messageLoaded)</span>
<a href="#l82.600"></a><span id="l82.600" class="difflineplus">+      return false;</span>
<a href="#l82.601"></a><span id="l82.601" class="difflineplus">+</span>
<a href="#l82.602"></a><span id="l82.602" class="difflineplus">+    let docShell = contentPane.docShell;</span>
<a href="#l82.603"></a><span id="l82.603" class="difflineplus">+    if (!docShell)</span>
<a href="#l82.604"></a><span id="l82.604" class="difflineplus">+      return false;</span>
<a href="#l82.605"></a><span id="l82.605" class="difflineplus">+    let uri = docShell.currentURI;</span>
<a href="#l82.606"></a><span id="l82.606" class="difflineplus">+    // the URL will tell us if it is running, saves us from potential error</span>
<a href="#l82.607"></a><span id="l82.607" class="difflineplus">+    if (uri &amp;&amp; (uri instanceof Components.interfaces.nsIMsgMailNewsUrl)) {</span>
<a href="#l82.608"></a><span id="l82.608" class="difflineplus">+      let urlRunningObj = {};</span>
<a href="#l82.609"></a><span id="l82.609" class="difflineplus">+      uri.GetUrlState(urlRunningObj);</span>
<a href="#l82.610"></a><span id="l82.610" class="difflineplus">+      // GetUrlState returns true if the url is still running</span>
<a href="#l82.611"></a><span id="l82.611" class="difflineplus">+      return !urlRunningObj.value;</span>
<a href="#l82.612"></a><span id="l82.612" class="difflineplus">+    }</span>
<a href="#l82.613"></a><span id="l82.613" class="difflineplus">+    // not a mailnews URL, just check the busy flags...</span>
<a href="#l82.614"></a><span id="l82.614" class="difflineplus">+    return !docShell.busyFlags;</span>
<a href="#l82.615"></a><span id="l82.615" class="difflineplus">+  };</span>
<a href="#l82.616"></a><span id="l82.616" class="difflineplus">+  controller.waitForEval('subject()',</span>
<a href="#l82.617"></a><span id="l82.617" class="difflineplus">+                         NORMAL_TIMEOUT,</span>
<a href="#l82.618"></a><span id="l82.618" class="difflineplus">+                         FAST_INTERVAL, isLoadedChecker);</span>
<a href="#l82.619"></a><span id="l82.619" class="difflineplus">+  // the above may return immediately, meaning the event queue might not get a</span>
<a href="#l82.620"></a><span id="l82.620" class="difflineplus">+  //  chance.  give it a chance now.</span>
<a href="#l82.621"></a><span id="l82.621" class="difflineplus">+  aController.sleep(0);</span>
<a href="#l82.622"></a><span id="l82.622" class="difflineplus">+}</span>
<a href="#l82.623"></a><span id="l82.623" class="difflineplus">+</span>
<a href="#l82.624"></a><span id="l82.624" class="difflineplus">+</span>
<a href="#l82.625"></a><span id="l82.625" class="difflineplus">+var FolderListener = {</span>
<a href="#l82.626"></a><span id="l82.626" class="difflineplus">+  _inited: false,</span>
<a href="#l82.627"></a><span id="l82.627" class="difflineplus">+  ensureInited: function() {</span>
<a href="#l82.628"></a><span id="l82.628" class="difflineplus">+    if (this._inited)</span>
<a href="#l82.629"></a><span id="l82.629" class="difflineplus">+      return;</span>
<a href="#l82.630"></a><span id="l82.630" class="difflineplus">+</span>
<a href="#l82.631"></a><span id="l82.631" class="difflineplus">+    let mailSession =</span>
<a href="#l82.632"></a><span id="l82.632" class="difflineplus">+      Cc[&quot;@mozilla.org/messenger/services/session;1&quot;]</span>
<a href="#l82.633"></a><span id="l82.633" class="difflineplus">+        .getService(Ci.nsIMsgMailSession);</span>
<a href="#l82.634"></a><span id="l82.634" class="difflineplus">+    mailSession.AddFolderListener(this,</span>
<a href="#l82.635"></a><span id="l82.635" class="difflineplus">+                                  Ci.nsIFolderListener.event);</span>
<a href="#l82.636"></a><span id="l82.636" class="difflineplus">+</span>
<a href="#l82.637"></a><span id="l82.637" class="difflineplus">+    this._inited = true;</span>
<a href="#l82.638"></a><span id="l82.638" class="difflineplus">+  },</span>
<a href="#l82.639"></a><span id="l82.639" class="difflineplus">+</span>
<a href="#l82.640"></a><span id="l82.640" class="difflineplus">+  sawEvents: false,</span>
<a href="#l82.641"></a><span id="l82.641" class="difflineplus">+  watchingFor: null,</span>
<a href="#l82.642"></a><span id="l82.642" class="difflineplus">+  planToWaitFor: function FolderListener_planToWaitFor() {</span>
<a href="#l82.643"></a><span id="l82.643" class="difflineplus">+    this.sawEvents = false;</span>
<a href="#l82.644"></a><span id="l82.644" class="difflineplus">+    this.watchingFor = [];</span>
<a href="#l82.645"></a><span id="l82.645" class="difflineplus">+    for (let i = 0; i &lt; arguments.length; i++)</span>
<a href="#l82.646"></a><span id="l82.646" class="difflineplus">+      this.watchingFor[i] = arguments[i];</span>
<a href="#l82.647"></a><span id="l82.647" class="difflineplus">+  },</span>
<a href="#l82.648"></a><span id="l82.648" class="difflineplus">+  waitForEvents: function FolderListener_waitForEvents() {</span>
<a href="#l82.649"></a><span id="l82.649" class="difflineplus">+    if (this.sawEvents)</span>
<a href="#l82.650"></a><span id="l82.650" class="difflineplus">+      return;</span>
<a href="#l82.651"></a><span id="l82.651" class="difflineplus">+    controller.waitForEval('subject.sawEvents', NORMAL_TIMEOUT,</span>
<a href="#l82.652"></a><span id="l82.652" class="difflineplus">+                           FAST_INTERVAL, this);</span>
<a href="#l82.653"></a><span id="l82.653" class="difflineplus">+  },</span>
<a href="#l82.654"></a><span id="l82.654" class="difflineplus">+</span>
<a href="#l82.655"></a><span id="l82.655" class="difflineplus">+  OnItemEvent: function FolderNotificationHelper_OnItemEvent(</span>
<a href="#l82.656"></a><span id="l82.656" class="difflineplus">+      aFolder, aEvent) {</span>
<a href="#l82.657"></a><span id="l82.657" class="difflineplus">+    if (!this.watchingFor)</span>
<a href="#l82.658"></a><span id="l82.658" class="difflineplus">+      return;</span>
<a href="#l82.659"></a><span id="l82.659" class="difflineplus">+    if (this.watchingFor.indexOf(aEvent.toString()) != -1) {</span>
<a href="#l82.660"></a><span id="l82.660" class="difflineplus">+      this.watchingFor = null;</span>
<a href="#l82.661"></a><span id="l82.661" class="difflineplus">+      this.sawEvents = true;</span>
<a href="#l82.662"></a><span id="l82.662" class="difflineplus">+    }</span>
<a href="#l82.663"></a><span id="l82.663" class="difflineplus">+  },</span>
<a href="#l82.664"></a><span id="l82.664" class="difflineplus">+};</span>
<a href="#l82.665"></a><span id="l82.665" class="difflineplus">+</span>
<a href="#l82.666"></a><span id="l82.666" class="difflineplus">+/**</span>
<a href="#l82.667"></a><span id="l82.667" class="difflineplus">+ * Plan to wait for an nsIFolderListener.OnItemEvent matching one of the</span>
<a href="#l82.668"></a><span id="l82.668" class="difflineplus">+ *  provided strings.  Call this before you do the thing that triggers the</span>
<a href="#l82.669"></a><span id="l82.669" class="difflineplus">+ *  event, then call |wait_for_folder_events| after the event.  This ensures</span>
<a href="#l82.670"></a><span id="l82.670" class="difflineplus">+ *  that we see the event, because it might be too late after you initiate</span>
<a href="#l82.671"></a><span id="l82.671" class="difflineplus">+ *  the thing that would generate the event.</span>
<a href="#l82.672"></a><span id="l82.672" class="difflineplus">+ * For example, plan_to_wait_for_folder_events(&quot;DeleteOrMoveMsgCompleted&quot;,</span>
<a href="#l82.673"></a><span id="l82.673" class="difflineplus">+ *  &quot;DeleteOrMoveMsgFailed&quot;) waits for a deletion completion notification</span>
<a href="#l82.674"></a><span id="l82.674" class="difflineplus">+ *  when you call |wait_for_folder_events|.</span>
<a href="#l82.675"></a><span id="l82.675" class="difflineplus">+ * The waiting is currently un-scoped, so the event happening on any folder</span>
<a href="#l82.676"></a><span id="l82.676" class="difflineplus">+ *  triggers us.  It is expected that you won't try and have multiple events</span>
<a href="#l82.677"></a><span id="l82.677" class="difflineplus">+ *  in-flight or will augment us when the time comes to have to deal with that.</span>
<a href="#l82.678"></a><span id="l82.678" class="difflineplus">+ */</span>
<a href="#l82.679"></a><span id="l82.679" class="difflineplus">+function plan_to_wait_for_folder_events() {</span>
<a href="#l82.680"></a><span id="l82.680" class="difflineplus">+  FolderListener.ensureInited();</span>
<a href="#l82.681"></a><span id="l82.681" class="difflineplus">+  FolderListener.planToWaitFor.apply(FolderListener, arguments);</span>
<a href="#l82.682"></a><span id="l82.682" class="difflineplus">+}</span>
<a href="#l82.683"></a><span id="l82.683" class="difflineplus">+function wait_for_folder_events() {</span>
<a href="#l82.684"></a><span id="l82.684" class="difflineplus">+  FolderListener.waitForEvents();</span>
<a href="#l82.685"></a><span id="l82.685" class="difflineplus">+}</span>
<a href="#l82.686"></a><span id="l82.686" class="difflineplus">+</span>
<a href="#l82.687"></a><span id="l82.687" class="difflineplus">+/**</span>
<a href="#l82.688"></a><span id="l82.688" class="difflineplus">+ * Assert that the given synthetic message sets are present in the folder</span>
<a href="#l82.689"></a><span id="l82.689" class="difflineplus">+ *  display.</span>
<a href="#l82.690"></a><span id="l82.690" class="difflineplus">+ *</span>
<a href="#l82.691"></a><span id="l82.691" class="difflineplus">+ * @param aSynSets Either a single SyntheticMessageSet or a list of them.</span>
<a href="#l82.692"></a><span id="l82.692" class="difflineplus">+ * @param aController Optional controller, which we get the folderDisplay</span>
<a href="#l82.693"></a><span id="l82.693" class="difflineplus">+ *     property from.  If omitted, we use the mc (mainController).</span>
<a href="#l82.694"></a><span id="l82.694" class="difflineplus">+ */</span>
<a href="#l82.695"></a><span id="l82.695" class="difflineplus">+function assert_messages_in_view(aSynSets, aController) {</span>
<a href="#l82.696"></a><span id="l82.696" class="difflineplus">+  if (aController === undefined)</span>
<a href="#l82.697"></a><span id="l82.697" class="difflineplus">+    aController = mc;</span>
<a href="#l82.698"></a><span id="l82.698" class="difflineplus">+  viewWrapperTestUtils.verify_messages_in_view(aSynSets,</span>
<a href="#l82.699"></a><span id="l82.699" class="difflineplus">+                                               aController.folderDisplay.view);</span>
<a href="#l82.700"></a><span id="l82.700" class="difflineplus">+}</span>
<a href="#l82.701"></a><span id="l82.701" class="difflineplus">+</span>
<a href="#l82.702"></a><span id="l82.702" class="difflineplus">+/**</span>
<a href="#l82.703"></a><span id="l82.703" class="difflineplus">+ * Assert the the given message/messages are not present in the view.</span>
<a href="#l82.704"></a><span id="l82.704" class="difflineplus">+ * @param aMessages Either a single nsIMsgDBHdr or a list of them.</span>
<a href="#l82.705"></a><span id="l82.705" class="difflineplus">+ */</span>
<a href="#l82.706"></a><span id="l82.706" class="difflineplus">+function assert_messages_not_in_view(aMessages, aController) {</span>
<a href="#l82.707"></a><span id="l82.707" class="difflineplus">+  if (aController === undefined)</span>
<a href="#l82.708"></a><span id="l82.708" class="difflineplus">+    aController = mc;</span>
<a href="#l82.709"></a><span id="l82.709" class="difflineplus">+  if (aMessages instanceof Ci.nsIMsgDBHdr)</span>
<a href="#l82.710"></a><span id="l82.710" class="difflineplus">+    aMessages = [aMessages];</span>
<a href="#l82.711"></a><span id="l82.711" class="difflineplus">+  for each (let [, msgHdr] in Iterator(aMessages)) {</span>
<a href="#l82.712"></a><span id="l82.712" class="difflineplus">+    if (mc.dbView.findIndexOfMsgHdr(msgHdr, true) != nsMsgViewIndex_None)</span>
<a href="#l82.713"></a><span id="l82.713" class="difflineplus">+      throw new Error(&quot;Message header is present in view but should not be: &quot; +</span>
<a href="#l82.714"></a><span id="l82.714" class="difflineplus">+                       msgHdr.mime2DecodedSubject + &quot; index: &quot; +</span>
<a href="#l82.715"></a><span id="l82.715" class="difflineplus">+                       mc.dbView.findIndexOfMsgHdr(msgHdr, true));</span>
<a href="#l82.716"></a><span id="l82.716" class="difflineplus">+  }</span>
<a href="#l82.717"></a><span id="l82.717" class="difflineplus">+}</span>
<a href="#l82.718"></a><span id="l82.718" class="difflineplus">+var assert_message_not_in_view = assert_messages_not_in_view;</span>
<a href="#l82.719"></a><span id="l82.719" class="difflineplus">+</span>
<a href="#l82.720"></a><span id="l82.720" class="difflineplus">+/**</span>
<a href="#l82.721"></a><span id="l82.721" class="difflineplus">+ * Helper function for use by assert_selected / assert_selected_and_displayed /</span>
<a href="#l82.722"></a><span id="l82.722" class="difflineplus">+ *  assert_displayed.</span>
<a href="#l82.723"></a><span id="l82.723" class="difflineplus">+ */</span>
<a href="#l82.724"></a><span id="l82.724" class="difflineplus">+function _process_row_message_arguments() {</span>
<a href="#l82.725"></a><span id="l82.725" class="difflineplus">+  let troller = mc;</span>
<a href="#l82.726"></a><span id="l82.726" class="difflineplus">+  // - normalize into desired selected view indices</span>
<a href="#l82.727"></a><span id="l82.727" class="difflineplus">+  let desiredIndices = [];</span>
<a href="#l82.728"></a><span id="l82.728" class="difflineplus">+  for (let iArg = 0; iArg &lt; arguments.length; iArg++) {</span>
<a href="#l82.729"></a><span id="l82.729" class="difflineplus">+    let arg = arguments[iArg];</span>
<a href="#l82.730"></a><span id="l82.730" class="difflineplus">+    // An integer identifying a view index</span>
<a href="#l82.731"></a><span id="l82.731" class="difflineplus">+    if (typeof(arg) == &quot;number&quot;) {</span>
<a href="#l82.732"></a><span id="l82.732" class="difflineplus">+      desiredIndices.push(_normalize_view_index(arg));</span>
<a href="#l82.733"></a><span id="l82.733" class="difflineplus">+    }</span>
<a href="#l82.734"></a><span id="l82.734" class="difflineplus">+    // A message header</span>
<a href="#l82.735"></a><span id="l82.735" class="difflineplus">+    else if (arg instanceof Ci.nsIMsgDBHdr) {</span>
<a href="#l82.736"></a><span id="l82.736" class="difflineplus">+      // do not expand; the thing should already be selected, eg expanded!</span>
<a href="#l82.737"></a><span id="l82.737" class="difflineplus">+      let viewIndex = troller.dbView.findIndexOfMsgHdr(arg, false);</span>
<a href="#l82.738"></a><span id="l82.738" class="difflineplus">+      if (viewIndex == nsMsgViewIndex_None)</span>
<a href="#l82.739"></a><span id="l82.739" class="difflineplus">+        throw_and_dump_view_state(</span>
<a href="#l82.740"></a><span id="l82.740" class="difflineplus">+          &quot;Message not present in view that should be there. &quot; +</span>
<a href="#l82.741"></a><span id="l82.741" class="difflineplus">+            &quot;(&quot; + arg.messageKey + &quot;: &quot; + arg.mime2DecodedSubject + &quot;)&quot;);</span>
<a href="#l82.742"></a><span id="l82.742" class="difflineplus">+      desiredIndices.push(viewIndex);</span>
<a href="#l82.743"></a><span id="l82.743" class="difflineplus">+    }</span>
<a href="#l82.744"></a><span id="l82.744" class="difflineplus">+    // A list containing two integers, indicating a range of view indices.</span>
<a href="#l82.745"></a><span id="l82.745" class="difflineplus">+    else if (arg.length == 2 &amp;&amp; typeof(arg[0]) == &quot;number&quot;) {</span>
<a href="#l82.746"></a><span id="l82.746" class="difflineplus">+      let lowIndex = _normalize_view_index(arg[0]);</span>
<a href="#l82.747"></a><span id="l82.747" class="difflineplus">+      let highIndex = _normalize_view_index(arg[1]);</span>
<a href="#l82.748"></a><span id="l82.748" class="difflineplus">+      for (let viewIndex = lowIndex; viewIndex &lt;= highIndex; viewIndex++)</span>
<a href="#l82.749"></a><span id="l82.749" class="difflineplus">+        desiredIndices.push(viewIndex);</span>
<a href="#l82.750"></a><span id="l82.750" class="difflineplus">+    }</span>
<a href="#l82.751"></a><span id="l82.751" class="difflineplus">+    // a List of message headers</span>
<a href="#l82.752"></a><span id="l82.752" class="difflineplus">+    else if (arg.length !== undefined) {</span>
<a href="#l82.753"></a><span id="l82.753" class="difflineplus">+      for (let iMsg = 0; iMsg &lt; arg.length; iMsg++) {</span>
<a href="#l82.754"></a><span id="l82.754" class="difflineplus">+        let msgHdr = arg[iMsg].QueryInterface(Ci.nsIMsgDBHdr);</span>
<a href="#l82.755"></a><span id="l82.755" class="difflineplus">+        if (!msgHdr)</span>
<a href="#l82.756"></a><span id="l82.756" class="difflineplus">+          throw new Error(arg[iMsg] + &quot; is not a message header!&quot;);</span>
<a href="#l82.757"></a><span id="l82.757" class="difflineplus">+        // false means do not expand, it should already be selected</span>
<a href="#l82.758"></a><span id="l82.758" class="difflineplus">+        let viewIndex = troller.dbView.findIndexOfMsgHdr(msgHdr, false);</span>
<a href="#l82.759"></a><span id="l82.759" class="difflineplus">+        if (viewIndex == nsMsgViewIndex_None)</span>
<a href="#l82.760"></a><span id="l82.760" class="difflineplus">+          throw new Error(&quot;Message not present in view that should be there.&quot;);</span>
<a href="#l82.761"></a><span id="l82.761" class="difflineplus">+        desiredIndices.push(viewIndex);</span>
<a href="#l82.762"></a><span id="l82.762" class="difflineplus">+      }</span>
<a href="#l82.763"></a><span id="l82.763" class="difflineplus">+    }</span>
<a href="#l82.764"></a><span id="l82.764" class="difflineplus">+    // it's a MozmillController</span>
<a href="#l82.765"></a><span id="l82.765" class="difflineplus">+    else if (arg.window) {</span>
<a href="#l82.766"></a><span id="l82.766" class="difflineplus">+      troller = arg;</span>
<a href="#l82.767"></a><span id="l82.767" class="difflineplus">+    }</span>
<a href="#l82.768"></a><span id="l82.768" class="difflineplus">+    else {</span>
<a href="#l82.769"></a><span id="l82.769" class="difflineplus">+      throw new Error(&quot;Illegal argument: &quot; + arg);</span>
<a href="#l82.770"></a><span id="l82.770" class="difflineplus">+    }</span>
<a href="#l82.771"></a><span id="l82.771" class="difflineplus">+  }</span>
<a href="#l82.772"></a><span id="l82.772" class="difflineplus">+  // sort by integer value</span>
<a href="#l82.773"></a><span id="l82.773" class="difflineplus">+  desiredIndices.sort(function (a, b) { return a - b;} );</span>
<a href="#l82.774"></a><span id="l82.774" class="difflineplus">+</span>
<a href="#l82.775"></a><span id="l82.775" class="difflineplus">+  return [troller, desiredIndices];</span>
<a href="#l82.776"></a><span id="l82.776" class="difflineplus">+}</span>
<a href="#l82.777"></a><span id="l82.777" class="difflineplus">+</span>
<a href="#l82.778"></a><span id="l82.778" class="difflineplus">+/**</span>
<a href="#l82.779"></a><span id="l82.779" class="difflineplus">+ * Asserts that the given set of messages are selected.  Unless you are dealing</span>
<a href="#l82.780"></a><span id="l82.780" class="difflineplus">+ *  with transient selections resulting from right-clicks, you want to be using</span>
<a href="#l82.781"></a><span id="l82.781" class="difflineplus">+ *  assert_selected_and_displayed because it makes sure that the display is</span>
<a href="#l82.782"></a><span id="l82.782" class="difflineplus">+ *  correct too.</span>
<a href="#l82.783"></a><span id="l82.783" class="difflineplus">+ *</span>
<a href="#l82.784"></a><span id="l82.784" class="difflineplus">+ * The arguments consist of one or more of the following:</span>
<a href="#l82.785"></a><span id="l82.785" class="difflineplus">+ * - A MozmillController, indicating we should use that controller instead of</span>
<a href="#l82.786"></a><span id="l82.786" class="difflineplus">+ *   the default, &quot;mc&quot; (corresponding to the 3pane.)  Pass this first!</span>
<a href="#l82.787"></a><span id="l82.787" class="difflineplus">+ * - An integer identifying a view index.</span>
<a href="#l82.788"></a><span id="l82.788" class="difflineplus">+ * - A list containing two integers, indicating a range of view indices.</span>
<a href="#l82.789"></a><span id="l82.789" class="difflineplus">+ * - A message header.</span>
<a href="#l82.790"></a><span id="l82.790" class="difflineplus">+ * - A list of message headers.</span>
<a href="#l82.791"></a><span id="l82.791" class="difflineplus">+ */</span>
<a href="#l82.792"></a><span id="l82.792" class="difflineplus">+function assert_selected() {</span>
<a href="#l82.793"></a><span id="l82.793" class="difflineplus">+  let [troller, desiredIndices] =</span>
<a href="#l82.794"></a><span id="l82.794" class="difflineplus">+    _process_row_message_arguments.apply(this, arguments);</span>
<a href="#l82.795"></a><span id="l82.795" class="difflineplus">+</span>
<a href="#l82.796"></a><span id="l82.796" class="difflineplus">+  // - get the actual selection (already sorted by integer value)</span>
<a href="#l82.797"></a><span id="l82.797" class="difflineplus">+  let selectedIndices = troller.folderDisplay.selectedIndices;</span>
<a href="#l82.798"></a><span id="l82.798" class="difflineplus">+  // - test selection equivalence</span>
<a href="#l82.799"></a><span id="l82.799" class="difflineplus">+  // which is the same as string equivalence in this case. muah hah hah.</span>
<a href="#l82.800"></a><span id="l82.800" class="difflineplus">+  if (desiredIndices.toString() != selectedIndices.toString())</span>
<a href="#l82.801"></a><span id="l82.801" class="difflineplus">+    throw new Error(&quot;Desired selection is: &quot; + desiredIndices + &quot; but actual &quot; +</span>
<a href="#l82.802"></a><span id="l82.802" class="difflineplus">+                    &quot;selection is: &quot; + selectedIndices);</span>
<a href="#l82.803"></a><span id="l82.803" class="difflineplus">+</span>
<a href="#l82.804"></a><span id="l82.804" class="difflineplus">+  return [troller, desiredIndices];</span>
<a href="#l82.805"></a><span id="l82.805" class="difflineplus">+}</span>
<a href="#l82.806"></a><span id="l82.806" class="difflineplus">+</span>
<a href="#l82.807"></a><span id="l82.807" class="difflineplus">+</span>
<a href="#l82.808"></a><span id="l82.808" class="difflineplus">+/**</span>
<a href="#l82.809"></a><span id="l82.809" class="difflineplus">+ * Assert that the given set of messages is displayed, but not necessarily</span>
<a href="#l82.810"></a><span id="l82.810" class="difflineplus">+ *  selected.  Unless you are dealing with transient selection issues or some</span>
<a href="#l82.811"></a><span id="l82.811" class="difflineplus">+ *  other situation where the FolderDisplay should not be correlated with the</span>
<a href="#l82.812"></a><span id="l82.812" class="difflineplus">+ *  MessageDisplay, you really should be using assert_selected_and_displayed.</span>
<a href="#l82.813"></a><span id="l82.813" class="difflineplus">+ *</span>
<a href="#l82.814"></a><span id="l82.814" class="difflineplus">+ * The arguments consist of one or more of the following:</span>
<a href="#l82.815"></a><span id="l82.815" class="difflineplus">+ * - A MozmillController, indicating we should use that controller instead of</span>
<a href="#l82.816"></a><span id="l82.816" class="difflineplus">+ *   the default, &quot;mc&quot; (corresponding to the 3pane.)  Pass this first!</span>
<a href="#l82.817"></a><span id="l82.817" class="difflineplus">+ * - An integer identifying a view index.</span>
<a href="#l82.818"></a><span id="l82.818" class="difflineplus">+ * - A list containing two integers, indicating a range of view indices.</span>
<a href="#l82.819"></a><span id="l82.819" class="difflineplus">+ * - A message header.</span>
<a href="#l82.820"></a><span id="l82.820" class="difflineplus">+ * - A list of message headers.</span>
<a href="#l82.821"></a><span id="l82.821" class="difflineplus">+ */</span>
<a href="#l82.822"></a><span id="l82.822" class="difflineplus">+function assert_displayed() {</span>
<a href="#l82.823"></a><span id="l82.823" class="difflineplus">+  let [troller, desiredIndices] =</span>
<a href="#l82.824"></a><span id="l82.824" class="difflineplus">+    _process_row_message_arguments.apply(this, arguments);</span>
<a href="#l82.825"></a><span id="l82.825" class="difflineplus">+  _internal_assert_displayed(false, troller, desiredIndices);</span>
<a href="#l82.826"></a><span id="l82.826" class="difflineplus">+}</span>
<a href="#l82.827"></a><span id="l82.827" class="difflineplus">+</span>
<a href="#l82.828"></a><span id="l82.828" class="difflineplus">+/**</span>
<a href="#l82.829"></a><span id="l82.829" class="difflineplus">+ * Assert-that-the-display-is-right logic.  We need an internal version so that</span>
<a href="#l82.830"></a><span id="l82.830" class="difflineplus">+ *  we can know whether we can trust/assert that folderDisplay.selectedMessage</span>
<a href="#l82.831"></a><span id="l82.831" class="difflineplus">+ *  agrees with messageDisplay, and also so that we don't have to re-compute</span>
<a href="#l82.832"></a><span id="l82.832" class="difflineplus">+ *  troller and desiredIndices.</span>
<a href="#l82.833"></a><span id="l82.833" class="difflineplus">+ */</span>
<a href="#l82.834"></a><span id="l82.834" class="difflineplus">+function _internal_assert_displayed(trustSelection, troller, desiredIndices) {</span>
<a href="#l82.835"></a><span id="l82.835" class="difflineplus">+  // - verify that the right thing is being displayed.</span>
<a href="#l82.836"></a><span id="l82.836" class="difflineplus">+  // no selection means folder summary.</span>
<a href="#l82.837"></a><span id="l82.837" class="difflineplus">+  if (desiredIndices.length == 0) {</span>
<a href="#l82.838"></a><span id="l82.838" class="difflineplus">+    // folder summary is not landed yet, just verify there is no message.</span>
<a href="#l82.839"></a><span id="l82.839" class="difflineplus">+    if (troller.messageDisplay.displayedMessage != null)</span>
<a href="#l82.840"></a><span id="l82.840" class="difflineplus">+      throw new Error(&quot;Message display should not think it is displaying a &quot; +</span>
<a href="#l82.841"></a><span id="l82.841" class="difflineplus">+                      &quot;message.&quot;);</span>
<a href="#l82.842"></a><span id="l82.842" class="difflineplus">+    // make sure the content pane is pointed at about:blank</span>
<a href="#l82.843"></a><span id="l82.843" class="difflineplus">+    if (troller.window.content.location.href != &quot;about:blank&quot;) {</span>
<a href="#l82.844"></a><span id="l82.844" class="difflineplus">+      throw new Error(&quot;the content pane should be blank, but is showing: '&quot; +</span>
<a href="#l82.845"></a><span id="l82.845" class="difflineplus">+                      troller.window.content.location.href + &quot;'&quot;);</span>
<a href="#l82.846"></a><span id="l82.846" class="difflineplus">+    }</span>
<a href="#l82.847"></a><span id="l82.847" class="difflineplus">+  }</span>
<a href="#l82.848"></a><span id="l82.848" class="difflineplus">+  // 1 means the message should be displayed</span>
<a href="#l82.849"></a><span id="l82.849" class="difflineplus">+  else if (desiredIndices.length == 1) {</span>
<a href="#l82.850"></a><span id="l82.850" class="difflineplus">+    // make sure message display thinks we are in single message display mode</span>
<a href="#l82.851"></a><span id="l82.851" class="difflineplus">+    if (!troller.messageDisplay.singleMessageDisplay)</span>
<a href="#l82.852"></a><span id="l82.852" class="difflineplus">+      throw new Error(&quot;Message display is not in single message display mode.&quot;);</span>
<a href="#l82.853"></a><span id="l82.853" class="difflineplus">+    // now make sure that we actually are in single message display mode</span>
<a href="#l82.854"></a><span id="l82.854" class="difflineplus">+    let singleMessagePane = troller.e(&quot;singlemessage&quot;);</span>
<a href="#l82.855"></a><span id="l82.855" class="difflineplus">+    let multiMessagePane = troller.e(&quot;multimessage&quot;);</span>
<a href="#l82.856"></a><span id="l82.856" class="difflineplus">+    if (singleMessagePane &amp;&amp; singleMessagePane.hidden)</span>
<a href="#l82.857"></a><span id="l82.857" class="difflineplus">+      throw new Error(&quot;Single message pane is hidden but it should not be.&quot;);</span>
<a href="#l82.858"></a><span id="l82.858" class="difflineplus">+    if (multiMessagePane &amp;&amp; !multiMessagePane.hidden)</span>
<a href="#l82.859"></a><span id="l82.859" class="difflineplus">+      throw new Error(&quot;Multiple message pane is visible but it should not be.&quot;);</span>
<a href="#l82.860"></a><span id="l82.860" class="difflineplus">+</span>
<a href="#l82.861"></a><span id="l82.861" class="difflineplus">+    if (trustSelection) {</span>
<a href="#l82.862"></a><span id="l82.862" class="difflineplus">+      if (troller.folderDisplay.selectedMessage !=</span>
<a href="#l82.863"></a><span id="l82.863" class="difflineplus">+          troller.messageDisplay.displayedMessage)</span>
<a href="#l82.864"></a><span id="l82.864" class="difflineplus">+        throw new Error(&quot;folderDisplay.selectedMessage != &quot; +</span>
<a href="#l82.865"></a><span id="l82.865" class="difflineplus">+                        &quot;messageDisplay.displayedMessage! (fd: &quot; +</span>
<a href="#l82.866"></a><span id="l82.866" class="difflineplus">+                        troller.folderDisplay.selectedMessage + &quot; vs md: &quot; +</span>
<a href="#l82.867"></a><span id="l82.867" class="difflineplus">+                        troller.messageDisplay.displayedMessage + &quot;)&quot;);</span>
<a href="#l82.868"></a><span id="l82.868" class="difflineplus">+    }</span>
<a href="#l82.869"></a><span id="l82.869" class="difflineplus">+</span>
<a href="#l82.870"></a><span id="l82.870" class="difflineplus">+    let msgHdr = troller.messageDisplay.displayedMessage;</span>
<a href="#l82.871"></a><span id="l82.871" class="difflineplus">+    let msgUri = msgHdr.folder.getUriForMsg(msgHdr);</span>
<a href="#l82.872"></a><span id="l82.872" class="difflineplus">+    // wait for the document to load so that we don't try and replace it later</span>
<a href="#l82.873"></a><span id="l82.873" class="difflineplus">+    //  and get that stupid assertion</span>
<a href="#l82.874"></a><span id="l82.874" class="difflineplus">+    wait_for_message_display_completion();</span>
<a href="#l82.875"></a><span id="l82.875" class="difflineplus">+    // make sure the content pane is pointed at the right thing</span>
<a href="#l82.876"></a><span id="l82.876" class="difflineplus">+</span>
<a href="#l82.877"></a><span id="l82.877" class="difflineplus">+    let msgService =</span>
<a href="#l82.878"></a><span id="l82.878" class="difflineplus">+      troller.folderDisplay.messenger.messageServiceFromURI(msgUri);</span>
<a href="#l82.879"></a><span id="l82.879" class="difflineplus">+    let msgUrlObj = {};</span>
<a href="#l82.880"></a><span id="l82.880" class="difflineplus">+    msgService.GetUrlForUri(msgUri, msgUrlObj, troller.folderDisplay.msgWindow);</span>
<a href="#l82.881"></a><span id="l82.881" class="difflineplus">+    let msgUrl = msgUrlObj.value;</span>
<a href="#l82.882"></a><span id="l82.882" class="difflineplus">+    if (troller.window.content.location.href != msgUrl.spec)</span>
<a href="#l82.883"></a><span id="l82.883" class="difflineplus">+      throw new Error(&quot;The content pane is not displaying the right message! &quot; +</span>
<a href="#l82.884"></a><span id="l82.884" class="difflineplus">+                      &quot;Should be: &quot; + msgUrl.spec + &quot; but it's: &quot; +</span>
<a href="#l82.885"></a><span id="l82.885" class="difflineplus">+                      troller.window.content.location.href);</span>
<a href="#l82.886"></a><span id="l82.886" class="difflineplus">+  }</span>
<a href="#l82.887"></a><span id="l82.887" class="difflineplus">+  // multiple means some form of multi-message summary</span>
<a href="#l82.888"></a><span id="l82.888" class="difflineplus">+  else {</span>
<a href="#l82.889"></a><span id="l82.889" class="difflineplus">+    // XXX deal with the summarization threshold bail case.</span>
<a href="#l82.890"></a><span id="l82.890" class="difflineplus">+</span>
<a href="#l82.891"></a><span id="l82.891" class="difflineplus">+    // make sure the message display thinks we are in multi-message mode</span>
<a href="#l82.892"></a><span id="l82.892" class="difflineplus">+    if (troller.messageDisplay.singleMessageDisplay)</span>
<a href="#l82.893"></a><span id="l82.893" class="difflineplus">+      throw new Error(&quot;Message display should not be in single message display&quot;+</span>
<a href="#l82.894"></a><span id="l82.894" class="difflineplus">+                      &quot;mode!  Selected indices: &quot; + selectedIndices);</span>
<a href="#l82.895"></a><span id="l82.895" class="difflineplus">+</span>
<a href="#l82.896"></a><span id="l82.896" class="difflineplus">+    // now make sure that we actually are in nultiple message display mode</span>
<a href="#l82.897"></a><span id="l82.897" class="difflineplus">+    let singleMessagePane = troller.e(&quot;singlemessage&quot;);</span>
<a href="#l82.898"></a><span id="l82.898" class="difflineplus">+    let multiMessagePane = troller.e(&quot;multimessage&quot;);</span>
<a href="#l82.899"></a><span id="l82.899" class="difflineplus">+    if (singleMessagePane &amp;&amp; !singleMessagePane.hidden)</span>
<a href="#l82.900"></a><span id="l82.900" class="difflineplus">+      throw new Error(&quot;Single message pane is visible but it should not be.&quot;);</span>
<a href="#l82.901"></a><span id="l82.901" class="difflineplus">+    if (multiMessagePane &amp;&amp; multiMessagePane.hidden)</span>
<a href="#l82.902"></a><span id="l82.902" class="difflineplus">+      throw new Error(&quot;Multiple message pane is hidden but it should not be.&quot;);</span>
<a href="#l82.903"></a><span id="l82.903" class="difflineplus">+</span>
<a href="#l82.904"></a><span id="l82.904" class="difflineplus">+    // and _now_ make sure that we actually summarized what we wanted to</span>
<a href="#l82.905"></a><span id="l82.905" class="difflineplus">+    //  summarize.</span>
<a href="#l82.906"></a><span id="l82.906" class="difflineplus">+    let desiredMessages = [mc.dbView.getMsgHdrAt(vi) for each</span>
<a href="#l82.907"></a><span id="l82.907" class="difflineplus">+                            ([, vi] in Iterator(desiredIndices))];</span>
<a href="#l82.908"></a><span id="l82.908" class="difflineplus">+    assert_selection_summarized(troller, desiredMessages);</span>
<a href="#l82.909"></a><span id="l82.909" class="difflineplus">+  }</span>
<a href="#l82.910"></a><span id="l82.910" class="difflineplus">+}</span>
<a href="#l82.911"></a><span id="l82.911" class="difflineplus">+</span>
<a href="#l82.912"></a><span id="l82.912" class="difflineplus">+/**</span>
<a href="#l82.913"></a><span id="l82.913" class="difflineplus">+ * Assert that the messages corresponding to the one or more message spec</span>
<a href="#l82.914"></a><span id="l82.914" class="difflineplus">+ *  arguments are selected and displayed.  If you specify multiple messages,</span>
<a href="#l82.915"></a><span id="l82.915" class="difflineplus">+ *  we verify that the multi-message selection mode is in effect and that they</span>
<a href="#l82.916"></a><span id="l82.916" class="difflineplus">+ *  are doing the desired thing.  (Verifying the summarization may seem</span>
<a href="#l82.917"></a><span id="l82.917" class="difflineplus">+ *  overkill, but it helps make the tests simpler and allows you to be more</span>
<a href="#l82.918"></a><span id="l82.918" class="difflineplus">+ *  confident if you're just running one test that everything in the test is</span>
<a href="#l82.919"></a><span id="l82.919" class="difflineplus">+ *  performing in a sane fashion.  Refactoring could be in order, of course.)</span>
<a href="#l82.920"></a><span id="l82.920" class="difflineplus">+ *</span>
<a href="#l82.921"></a><span id="l82.921" class="difflineplus">+ * The arguments consist of one or more of the following:</span>
<a href="#l82.922"></a><span id="l82.922" class="difflineplus">+ * - A MozmillController, indicating we should use that controller instead of</span>
<a href="#l82.923"></a><span id="l82.923" class="difflineplus">+ *   the default, &quot;mc&quot; (corresponding to the 3pane.)  Pass this first!</span>
<a href="#l82.924"></a><span id="l82.924" class="difflineplus">+ * - An integer identifying a view index.</span>
<a href="#l82.925"></a><span id="l82.925" class="difflineplus">+ * - A list containing two integers, indicating a range of view indices.</span>
<a href="#l82.926"></a><span id="l82.926" class="difflineplus">+ * - A message header.</span>
<a href="#l82.927"></a><span id="l82.927" class="difflineplus">+ * - A list of message headers.</span>
<a href="#l82.928"></a><span id="l82.928" class="difflineplus">+ */</span>
<a href="#l82.929"></a><span id="l82.929" class="difflineplus">+function assert_selected_and_displayed() {</span>
<a href="#l82.930"></a><span id="l82.930" class="difflineplus">+  // make sure the selection is right first.</span>
<a href="#l82.931"></a><span id="l82.931" class="difflineplus">+  let [troller, desiredIndices] = assert_selected.apply(this, arguments);</span>
<a href="#l82.932"></a><span id="l82.932" class="difflineplus">+  // now make sure the display is right</span>
<a href="#l82.933"></a><span id="l82.933" class="difflineplus">+  _internal_assert_displayed(true, troller, desiredIndices);</span>
<a href="#l82.934"></a><span id="l82.934" class="difflineplus">+}</span>
<a href="#l82.935"></a><span id="l82.935" class="difflineplus">+</span>
<a href="#l82.936"></a><span id="l82.936" class="difflineplus">+/**</span>
<a href="#l82.937"></a><span id="l82.937" class="difflineplus">+ * @return true if |aSetOne| is equivalent to |aSetTwo| where the sets are</span>
<a href="#l82.938"></a><span id="l82.938" class="difflineplus">+ *     really just lists of nsIMsgDBHdrs with cool names.</span>
<a href="#l82.939"></a><span id="l82.939" class="difflineplus">+ */</span>
<a href="#l82.940"></a><span id="l82.940" class="difflineplus">+function _verify_message_sets_equivalent(aSetOne, aSetTwo) {</span>
<a href="#l82.941"></a><span id="l82.941" class="difflineplus">+  let uniqy1 = [msgHdr.folder.URI + msgHdr.messageKey for each</span>
<a href="#l82.942"></a><span id="l82.942" class="difflineplus">+                 ([, msgHdr] in Iterator(aSetOne))];</span>
<a href="#l82.943"></a><span id="l82.943" class="difflineplus">+  uniqy1.sort();</span>
<a href="#l82.944"></a><span id="l82.944" class="difflineplus">+  let uniqy2 = [msgHdr.folder.URI + msgHdr.messageKey for each</span>
<a href="#l82.945"></a><span id="l82.945" class="difflineplus">+                 ([, msgHdr] in Iterator(aSetTwo))];</span>
<a href="#l82.946"></a><span id="l82.946" class="difflineplus">+  uniqy2.sort();</span>
<a href="#l82.947"></a><span id="l82.947" class="difflineplus">+  // stringified versions should now be equal...</span>
<a href="#l82.948"></a><span id="l82.948" class="difflineplus">+  return uniqy1.toString() == uniqy2.toString();</span>
<a href="#l82.949"></a><span id="l82.949" class="difflineplus">+}</span>
<a href="#l82.950"></a><span id="l82.950" class="difflineplus">+</span>
<a href="#l82.951"></a><span id="l82.951" class="difflineplus">+/**</span>
<a href="#l82.952"></a><span id="l82.952" class="difflineplus">+ * Asserts that the messages the controller's folder display widget thinks are</span>
<a href="#l82.953"></a><span id="l82.953" class="difflineplus">+ *  summarized are in fact summarized.  This is automatically called by</span>
<a href="#l82.954"></a><span id="l82.954" class="difflineplus">+ *  assert_selected_and_displayed, so you do not need to call this directly</span>
<a href="#l82.955"></a><span id="l82.955" class="difflineplus">+ *  unless you are testing the summarization logic.</span>
<a href="#l82.956"></a><span id="l82.956" class="difflineplus">+ *</span>
<a href="#l82.957"></a><span id="l82.957" class="difflineplus">+ * @param aController The controller who has the summarized display going on.</span>
<a href="#l82.958"></a><span id="l82.958" class="difflineplus">+ * @param aMessages Optional set of messages to verify.  If not provided, this</span>
<a href="#l82.959"></a><span id="l82.959" class="difflineplus">+ *     is extracted via the folderDisplay.</span>
<a href="#l82.960"></a><span id="l82.960" class="difflineplus">+ */</span>
<a href="#l82.961"></a><span id="l82.961" class="difflineplus">+function assert_selection_summarized(aController, aSelectedMessages) {</span>
<a href="#l82.962"></a><span id="l82.962" class="difflineplus">+  // - Compensate for selection stabilization code.</span>
<a href="#l82.963"></a><span id="l82.963" class="difflineplus">+  // Although test-window-helpers sets the stabilization interval to 0, we</span>
<a href="#l82.964"></a><span id="l82.964" class="difflineplus">+  //  still need to make sure we have drained the event queue so that it has</span>
<a href="#l82.965"></a><span id="l82.965" class="difflineplus">+  //  actually gotten a chance to run.</span>
<a href="#l82.966"></a><span id="l82.966" class="difflineplus">+  controller.sleep(0);</span>
<a href="#l82.967"></a><span id="l82.967" class="difflineplus">+</span>
<a href="#l82.968"></a><span id="l82.968" class="difflineplus">+  // - Verify summary object knows about right messages</span>
<a href="#l82.969"></a><span id="l82.969" class="difflineplus">+  if (aSelectedMessages == null)</span>
<a href="#l82.970"></a><span id="l82.970" class="difflineplus">+    aSelectedMessages = aController.folderDisplay.selectedMessages;</span>
<a href="#l82.971"></a><span id="l82.971" class="difflineplus">+</span>
<a href="#l82.972"></a><span id="l82.972" class="difflineplus">+  let summary = aController.window.gSummary;</span>
<a href="#l82.973"></a><span id="l82.973" class="difflineplus">+  if (aSelectedMessages.length != summary._msgHdrs.length) {</span>
<a href="#l82.974"></a><span id="l82.974" class="difflineplus">+    let elaboration = &quot;Summary contains &quot; + summary._msgHdrs.length +</span>
<a href="#l82.975"></a><span id="l82.975" class="difflineplus">+                      &quot; messages, expected &quot; + aSelectedMessages.length + &quot;.&quot;;</span>
<a href="#l82.976"></a><span id="l82.976" class="difflineplus">+    throw new Error(&quot;Summary does not contain the right set of messages. &quot; +</span>
<a href="#l82.977"></a><span id="l82.977" class="difflineplus">+                    elaboration);</span>
<a href="#l82.978"></a><span id="l82.978" class="difflineplus">+  }</span>
<a href="#l82.979"></a><span id="l82.979" class="difflineplus">+  if (!_verify_message_sets_equivalent(summary._msgHdrs, aSelectedMessages)) {</span>
<a href="#l82.980"></a><span id="l82.980" class="difflineplus">+    let elaboration = &quot;Summary: &quot; + summary._msgHdrs + &quot;  Selected: &quot; +</span>
<a href="#l82.981"></a><span id="l82.981" class="difflineplus">+                      aSelectedMessages + &quot;.&quot;;</span>
<a href="#l82.982"></a><span id="l82.982" class="difflineplus">+    throw new Error(&quot;Summary does not contain the right set of messages. &quot; +</span>
<a href="#l82.983"></a><span id="l82.983" class="difflineplus">+                    elaboration);</span>
<a href="#l82.984"></a><span id="l82.984" class="difflineplus">+  }</span>
<a href="#l82.985"></a><span id="l82.985" class="difflineplus">+}</span>
<a href="#l82.986"></a><span id="l82.986" class="difflineplus">+</span>
<a href="#l82.987"></a><span id="l82.987" class="difflineplus">+/**</span>
<a href="#l82.988"></a><span id="l82.988" class="difflineplus">+ * Assert that there is nothing selected and, assuming we are in a folder, that</span>
<a href="#l82.989"></a><span id="l82.989" class="difflineplus">+ *  the folder summary is displayed.</span>
<a href="#l82.990"></a><span id="l82.990" class="difflineplus">+ */</span>
<a href="#l82.991"></a><span id="l82.991" class="difflineplus">+let assert_nothing_selected = assert_selected_and_displayed;</span>
<a href="#l82.992"></a><span id="l82.992" class="difflineplus">+</span>
<a href="#l82.993"></a><span id="l82.993" class="difflineplus">+/**</span>
<a href="#l82.994"></a><span id="l82.994" class="difflineplus">+ * Assert that the given view index or message is visible in the thread pane.</span>
<a href="#l82.995"></a><span id="l82.995" class="difflineplus">+ */</span>
<a href="#l82.996"></a><span id="l82.996" class="difflineplus">+function assert_visible(aViewIndexOrMessage) {</span>
<a href="#l82.997"></a><span id="l82.997" class="difflineplus">+  let viewIndex;</span>
<a href="#l82.998"></a><span id="l82.998" class="difflineplus">+  if (typeof(aViewIndexOrMessage) == &quot;number&quot;)</span>
<a href="#l82.999"></a><span id="l82.999" class="difflineplus">+    viewIndex = _normalize_view_index(aViewIndexOrMessage);</span>
<a href="#l82.1000"></a><span id="l82.1000" class="difflineplus">+  else</span>
<a href="#l82.1001"></a><span id="l82.1001" class="difflineplus">+    viewIndex = mc.dbView.findIndexOfMsgHdr(aViewIndexOrMessage);</span>
<a href="#l82.1002"></a><span id="l82.1002" class="difflineplus">+  let treeBox = mc.threadTree.boxObject.QueryInterface(Ci.nsITreeBoxObject);</span>
<a href="#l82.1003"></a><span id="l82.1003" class="difflineplus">+  if (viewIndex &lt; treeBox.getFirstVisibleRow() ||</span>
<a href="#l82.1004"></a><span id="l82.1004" class="difflineplus">+      viewIndex &gt; treeBox.getLastVisibleRow())</span>
<a href="#l82.1005"></a><span id="l82.1005" class="difflineplus">+    throw new Error(&quot;View index &quot; + viewIndex + &quot; is not visible! (&quot; +</span>
<a href="#l82.1006"></a><span id="l82.1006" class="difflineplus">+                    treeBox.getFirstVisibleRow() + &quot;-&quot; +</span>
<a href="#l82.1007"></a><span id="l82.1007" class="difflineplus">+                    treeBox.getLastVisibleRow() + &quot; are visible)&quot;);</span>
<a href="#l82.1008"></a><span id="l82.1008" class="difflineplus">+}</span>
<a href="#l82.1009"></a><span id="l82.1009" class="difflineplus">+</span>
<a href="#l82.1010"></a><span id="l82.1010" class="difflineplus">+/**</span>
<a href="#l82.1011"></a><span id="l82.1011" class="difflineplus">+ * Put the view in unthreaded mode.</span>
<a href="#l82.1012"></a><span id="l82.1012" class="difflineplus">+ */</span>
<a href="#l82.1013"></a><span id="l82.1013" class="difflineplus">+function make_display_unthreaded() {</span>
<a href="#l82.1014"></a><span id="l82.1014" class="difflineplus">+  wait_for_message_display_completion();</span>
<a href="#l82.1015"></a><span id="l82.1015" class="difflineplus">+  mc.folderDisplay.view.showUnthreaded = true;</span>
<a href="#l82.1016"></a><span id="l82.1016" class="difflineplus">+  // drain event queue</span>
<a href="#l82.1017"></a><span id="l82.1017" class="difflineplus">+  mc.sleep(0);</span>
<a href="#l82.1018"></a><span id="l82.1018" class="difflineplus">+}</span>
<a href="#l82.1019"></a><span id="l82.1019" class="difflineplus">+</span>
<a href="#l82.1020"></a><span id="l82.1020" class="difflineplus">+/**</span>
<a href="#l82.1021"></a><span id="l82.1021" class="difflineplus">+ * Put the view in threaded mode.</span>
<a href="#l82.1022"></a><span id="l82.1022" class="difflineplus">+ */</span>
<a href="#l82.1023"></a><span id="l82.1023" class="difflineplus">+function make_display_threaded() {</span>
<a href="#l82.1024"></a><span id="l82.1024" class="difflineplus">+  wait_for_message_display_completion();</span>
<a href="#l82.1025"></a><span id="l82.1025" class="difflineplus">+  mc.folderDisplay.view.showThreaded = true;</span>
<a href="#l82.1026"></a><span id="l82.1026" class="difflineplus">+  // drain event queue</span>
<a href="#l82.1027"></a><span id="l82.1027" class="difflineplus">+  mc.sleep(0);</span>
<a href="#l82.1028"></a><span id="l82.1028" class="difflineplus">+}</span>
<a href="#l82.1029"></a><span id="l82.1029" class="difflineplus">+</span>
<a href="#l82.1030"></a><span id="l82.1030" class="difflineplus">+/**</span>
<a href="#l82.1031"></a><span id="l82.1031" class="difflineplus">+ * Put the view in group-by-sort mode.</span>
<a href="#l82.1032"></a><span id="l82.1032" class="difflineplus">+ */</span>
<a href="#l82.1033"></a><span id="l82.1033" class="difflineplus">+function make_display_grouped() {</span>
<a href="#l82.1034"></a><span id="l82.1034" class="difflineplus">+  wait_for_message_display_completion();</span>
<a href="#l82.1035"></a><span id="l82.1035" class="difflineplus">+  mc.folderDisplay.view.showGroupedBySort = true;</span>
<a href="#l82.1036"></a><span id="l82.1036" class="difflineplus">+  // drain event queue</span>
<a href="#l82.1037"></a><span id="l82.1037" class="difflineplus">+  mc.sleep(0);</span>
<a href="#l82.1038"></a><span id="l82.1038" class="difflineplus">+}</span>
<a href="#l82.1039"></a><span id="l82.1039" class="difflineplus">+</span>
<a href="#l82.1040"></a><span id="l82.1040" class="difflineplus">+/**</span>
<a href="#l82.1041"></a><span id="l82.1041" class="difflineplus">+ * assert that the multimessage/thread summary view contains</span>
<a href="#l82.1042"></a><span id="l82.1042" class="difflineplus">+ * the specified number of elements of the specified class.</span>
<a href="#l82.1043"></a><span id="l82.1043" class="difflineplus">+ *</span>
<a href="#l82.1044"></a><span id="l82.1044" class="difflineplus">+ * @param aClassName: the class to use to select</span>
<a href="#l82.1045"></a><span id="l82.1045" class="difflineplus">+ * @param aNumElts: the number of expected elements that have that class</span>
<a href="#l82.1046"></a><span id="l82.1046" class="difflineplus">+ */</span>
<a href="#l82.1047"></a><span id="l82.1047" class="difflineplus">+</span>
<a href="#l82.1048"></a><span id="l82.1048" class="difflineplus">+function assert_summary_contains_N_divs(aClassName, aNumElts) {</span>
<a href="#l82.1049"></a><span id="l82.1049" class="difflineplus">+  let htmlframe = mc.e('multimessage');</span>
<a href="#l82.1050"></a><span id="l82.1050" class="difflineplus">+  let matches = htmlframe.contentDocument.getElementsByClassName(aClassName);</span>
<a href="#l82.1051"></a><span id="l82.1051" class="difflineplus">+  if (matches.length != aNumElts)</span>
<a href="#l82.1052"></a><span id="l82.1052" class="difflineplus">+    throw new Error(&quot;Expected to find &quot; + aNumElts + &quot; elements with class &quot; +</span>
<a href="#l82.1053"></a><span id="l82.1053" class="difflineplus">+                    aClassName + &quot;, found: &quot; + matches.length);</span>
<a href="#l82.1054"></a><span id="l82.1054" class="difflineplus">+}</span>
<a href="#l82.1055"></a><span id="l82.1055" class="difflineplus">+</span>
<a href="#l82.1056"></a><span id="l82.1056" class="difflineplus">+</span>
<a href="#l82.1057"></a><span id="l82.1057" class="difflineplus">+function throw_and_dump_view_state(aMessage, aController) {</span>
<a href="#l82.1058"></a><span id="l82.1058" class="difflineplus">+  if (aController == null)</span>
<a href="#l82.1059"></a><span id="l82.1059" class="difflineplus">+    aController = mc;</span>
<a href="#l82.1060"></a><span id="l82.1060" class="difflineplus">+</span>
<a href="#l82.1061"></a><span id="l82.1061" class="difflineplus">+  dump(&quot;******** &quot; + aMessage + &quot;\n&quot;);</span>
<a href="#l82.1062"></a><span id="l82.1062" class="difflineplus">+  viewWrapperTestUtils.dump_view_state(aController.folderDisplay.view);</span>
<a href="#l82.1063"></a><span id="l82.1063" class="difflineplus">+  throw new Error(aMessage);</span>
<a href="#l82.1064"></a><span id="l82.1064" class="difflineplus">+}</span>
<a href="#l82.1065"></a><span id="l82.1065" class="difflineplus">+</span>
<a href="#l82.1066"></a><span id="l82.1066" class="difflineplus">+/** exported from viewWrapperTestUtils */</span>
<a href="#l82.1067"></a><span id="l82.1067" class="difflineplus">+var make_new_sets_in_folders;</span>
<a href="#l82.1068"></a><span id="l82.1068" class="difflineplus">+var make_new_sets_in_folder;</span>
<a href="#l82.1069"></a><span id="l82.1069" class="difflineplus">+var add_sets_to_folders;</span>
<a href="#l82.1070"></a><span id="l82.1070" class="difflineplus">+</span>
<a href="#l82.1071"></a><span id="l82.1071" class="difflineplus">+/**</span>
<a href="#l82.1072"></a><span id="l82.1072" class="difflineplus">+ * Load a file in its own 'module'.</span>
<a href="#l82.1073"></a><span id="l82.1073" class="difflineplus">+ *</span>
<a href="#l82.1074"></a><span id="l82.1074" class="difflineplus">+ * @param aPath A path relative to the comm-central source path.</span>
<a href="#l82.1075"></a><span id="l82.1075" class="difflineplus">+ *</span>
<a href="#l82.1076"></a><span id="l82.1076" class="difflineplus">+ * @return An object that serves as the global scope for the loaded file.</span>
<a href="#l82.1077"></a><span id="l82.1077" class="difflineplus">+ */</span>
<a href="#l82.1078"></a><span id="l82.1078" class="difflineplus">+function load_via_src_path(aPath) {</span>
<a href="#l82.1079"></a><span id="l82.1079" class="difflineplus">+  let srcPath = os.abspath(&quot;../../../..&quot;,os.getFileForPath( __file__));</span>
<a href="#l82.1080"></a><span id="l82.1080" class="difflineplus">+  let fullPath = os.abspath(aPath, os.getFileForPath(srcPath));</span>
<a href="#l82.1081"></a><span id="l82.1081" class="difflineplus">+  return frame.loadFile(fullPath, undefined);</span>
<a href="#l82.1082"></a><span id="l82.1082" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l83.1"></a><span id="l83.1">new file mode 100644</span>
<a href="#l83.2"></a><span id="l83.2" class="difflineminus">--- /dev/null</span>
<a href="#l83.3"></a><span id="l83.3" class="difflineplus">+++ b/mail/test/mozmill/shared-modules/test-window-helpers.js</span>
<a href="#l83.4"></a><span id="l83.4" class="difflineat">@@ -0,0 +1,782 @@</span>
<a href="#l83.5"></a><span id="l83.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l83.6"></a><span id="l83.6" class="difflineplus">+ *   Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l83.7"></a><span id="l83.7" class="difflineplus">+ *</span>
<a href="#l83.8"></a><span id="l83.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l83.9"></a><span id="l83.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l83.10"></a><span id="l83.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l83.11"></a><span id="l83.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l83.12"></a><span id="l83.12" class="difflineplus">+ *</span>
<a href="#l83.13"></a><span id="l83.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l83.14"></a><span id="l83.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l83.15"></a><span id="l83.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l83.16"></a><span id="l83.16" class="difflineplus">+ * License.</span>
<a href="#l83.17"></a><span id="l83.17" class="difflineplus">+ *</span>
<a href="#l83.18"></a><span id="l83.18" class="difflineplus">+ * The Original Code is Thunderbird Mail Client.</span>
<a href="#l83.19"></a><span id="l83.19" class="difflineplus">+ *</span>
<a href="#l83.20"></a><span id="l83.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l83.21"></a><span id="l83.21" class="difflineplus">+ * Mozilla Messaging, Inc.</span>
<a href="#l83.22"></a><span id="l83.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l83.23"></a><span id="l83.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l83.24"></a><span id="l83.24" class="difflineplus">+ *</span>
<a href="#l83.25"></a><span id="l83.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l83.26"></a><span id="l83.26" class="difflineplus">+ *   Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a href="#l83.27"></a><span id="l83.27" class="difflineplus">+ *</span>
<a href="#l83.28"></a><span id="l83.28" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l83.29"></a><span id="l83.29" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l83.30"></a><span id="l83.30" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l83.31"></a><span id="l83.31" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l83.32"></a><span id="l83.32" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l83.33"></a><span id="l83.33" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l83.34"></a><span id="l83.34" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l83.35"></a><span id="l83.35" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l83.36"></a><span id="l83.36" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l83.37"></a><span id="l83.37" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l83.38"></a><span id="l83.38" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l83.39"></a><span id="l83.39" class="difflineplus">+ *</span>
<a href="#l83.40"></a><span id="l83.40" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l83.41"></a><span id="l83.41" class="difflineplus">+</span>
<a href="#l83.42"></a><span id="l83.42" class="difflineplus">+var Ci = Components.interfaces;</span>
<a href="#l83.43"></a><span id="l83.43" class="difflineplus">+var Cc = Components.classes;</span>
<a href="#l83.44"></a><span id="l83.44" class="difflineplus">+var Cu = Components.utils;</span>
<a href="#l83.45"></a><span id="l83.45" class="difflineplus">+</span>
<a href="#l83.46"></a><span id="l83.46" class="difflineplus">+var mozmill = {};</span>
<a href="#l83.47"></a><span id="l83.47" class="difflineplus">+Cu.import('resource://mozmill/modules/mozmill.js', mozmill);</span>
<a href="#l83.48"></a><span id="l83.48" class="difflineplus">+var controller = {};</span>
<a href="#l83.49"></a><span id="l83.49" class="difflineplus">+Cu.import('resource://mozmill/modules/controller.js', controller);</span>
<a href="#l83.50"></a><span id="l83.50" class="difflineplus">+var elib = {};</span>
<a href="#l83.51"></a><span id="l83.51" class="difflineplus">+Cu.import('resource://mozmill/modules/elementslib.js', elib);</span>
<a href="#l83.52"></a><span id="l83.52" class="difflineplus">+var frame = {};</span>
<a href="#l83.53"></a><span id="l83.53" class="difflineplus">+Cu.import('resource://mozmill/modules/frame.js', frame);</span>
<a href="#l83.54"></a><span id="l83.54" class="difflineplus">+</span>
<a href="#l83.55"></a><span id="l83.55" class="difflineplus">+Cu.import('resource://app/modules/iteratorUtils.jsm');</span>
<a href="#l83.56"></a><span id="l83.56" class="difflineplus">+</span>
<a href="#l83.57"></a><span id="l83.57" class="difflineplus">+const MODULE_NAME = 'window-helpers';</span>
<a href="#l83.58"></a><span id="l83.58" class="difflineplus">+</span>
<a href="#l83.59"></a><span id="l83.59" class="difflineplus">+/**</span>
<a href="#l83.60"></a><span id="l83.60" class="difflineplus">+ * Timeout to use when waiting for the first window ever to load.  This is</span>
<a href="#l83.61"></a><span id="l83.61" class="difflineplus">+ *  long because we are basically waiting for the entire app startup process.</span>
<a href="#l83.62"></a><span id="l83.62" class="difflineplus">+ */</span>
<a href="#l83.63"></a><span id="l83.63" class="difflineplus">+const FIRST_WINDOW_EVER_TIMEOUT_MS = 30000;</span>
<a href="#l83.64"></a><span id="l83.64" class="difflineplus">+/**</span>
<a href="#l83.65"></a><span id="l83.65" class="difflineplus">+ * Interval to check if the window has shown up for the first window ever to</span>
<a href="#l83.66"></a><span id="l83.66" class="difflineplus">+ *  load.  The check interval is longer because it's less likely the window</span>
<a href="#l83.67"></a><span id="l83.67" class="difflineplus">+ *  is going to show up quickly and there is a cost to the check.</span>
<a href="#l83.68"></a><span id="l83.68" class="difflineplus">+ */</span>
<a href="#l83.69"></a><span id="l83.69" class="difflineplus">+const FIRST_WINDOW_CHECK_INTERVAL_MS = 300;</span>
<a href="#l83.70"></a><span id="l83.70" class="difflineplus">+</span>
<a href="#l83.71"></a><span id="l83.71" class="difflineplus">+/**</span>
<a href="#l83.72"></a><span id="l83.72" class="difflineplus">+ * Timeout for opening a window.</span>
<a href="#l83.73"></a><span id="l83.73" class="difflineplus">+ */</span>
<a href="#l83.74"></a><span id="l83.74" class="difflineplus">+const WINDOW_OPEN_TIMEOUT_MS = 10000;</span>
<a href="#l83.75"></a><span id="l83.75" class="difflineplus">+/**</span>
<a href="#l83.76"></a><span id="l83.76" class="difflineplus">+ * Check interval for opening a window.</span>
<a href="#l83.77"></a><span id="l83.77" class="difflineplus">+ */</span>
<a href="#l83.78"></a><span id="l83.78" class="difflineplus">+const WINDOW_OPEN_CHECK_INTERVAL_MS = 100;</span>
<a href="#l83.79"></a><span id="l83.79" class="difflineplus">+</span>
<a href="#l83.80"></a><span id="l83.80" class="difflineplus">+/**</span>
<a href="#l83.81"></a><span id="l83.81" class="difflineplus">+ * Timeout for closing a window.</span>
<a href="#l83.82"></a><span id="l83.82" class="difflineplus">+ */</span>
<a href="#l83.83"></a><span id="l83.83" class="difflineplus">+const WINDOW_CLOSE_TIMEOUT_MS = 10000;</span>
<a href="#l83.84"></a><span id="l83.84" class="difflineplus">+/**</span>
<a href="#l83.85"></a><span id="l83.85" class="difflineplus">+ * Check interval for closing a window.</span>
<a href="#l83.86"></a><span id="l83.86" class="difflineplus">+ */</span>
<a href="#l83.87"></a><span id="l83.87" class="difflineplus">+const WINDOW_CLOSE_CHECK_INTERVAL_MS = 100;</span>
<a href="#l83.88"></a><span id="l83.88" class="difflineplus">+</span>
<a href="#l83.89"></a><span id="l83.89" class="difflineplus">+function setupModule() {</span>
<a href="#l83.90"></a><span id="l83.90" class="difflineplus">+  // do nothing</span>
<a href="#l83.91"></a><span id="l83.91" class="difflineplus">+}</span>
<a href="#l83.92"></a><span id="l83.92" class="difflineplus">+</span>
<a href="#l83.93"></a><span id="l83.93" class="difflineplus">+function installInto(module) {</span>
<a href="#l83.94"></a><span id="l83.94" class="difflineplus">+  module.plan_for_new_window = plan_for_new_window;</span>
<a href="#l83.95"></a><span id="l83.95" class="difflineplus">+  module.wait_for_new_window = wait_for_new_window;</span>
<a href="#l83.96"></a><span id="l83.96" class="difflineplus">+  module.plan_for_modal_dialog = plan_for_modal_dialog;</span>
<a href="#l83.97"></a><span id="l83.97" class="difflineplus">+  module.wait_for_modal_dialog = wait_for_modal_dialog;</span>
<a href="#l83.98"></a><span id="l83.98" class="difflineplus">+  module.plan_for_window_close = plan_for_window_close;</span>
<a href="#l83.99"></a><span id="l83.99" class="difflineplus">+  module.wait_for_window_close = wait_for_window_close;</span>
<a href="#l83.100"></a><span id="l83.100" class="difflineplus">+  module.wait_for_existing_window = wait_for_existing_window;</span>
<a href="#l83.101"></a><span id="l83.101" class="difflineplus">+</span>
<a href="#l83.102"></a><span id="l83.102" class="difflineplus">+  module.augment_controller = augment_controller;</span>
<a href="#l83.103"></a><span id="l83.103" class="difflineplus">+}</span>
<a href="#l83.104"></a><span id="l83.104" class="difflineplus">+</span>
<a href="#l83.105"></a><span id="l83.105" class="difflineplus">+var WindowWatcher = {</span>
<a href="#l83.106"></a><span id="l83.106" class="difflineplus">+  _inited: false,</span>
<a href="#l83.107"></a><span id="l83.107" class="difflineplus">+  _firstWindowOpened: false,</span>
<a href="#l83.108"></a><span id="l83.108" class="difflineplus">+  ensureInited: function WindowWatcher_ensureInited() {</span>
<a href="#l83.109"></a><span id="l83.109" class="difflineplus">+    if (this._inited)</span>
<a href="#l83.110"></a><span id="l83.110" class="difflineplus">+      return;</span>
<a href="#l83.111"></a><span id="l83.111" class="difflineplus">+</span>
<a href="#l83.112"></a><span id="l83.112" class="difflineplus">+    // Add ourselves as an nsIWindowMediatorListener so we can here about when</span>
<a href="#l83.113"></a><span id="l83.113" class="difflineplus">+    //  windows get registered with the window mediator.  Because this</span>
<a href="#l83.114"></a><span id="l83.114" class="difflineplus">+    //  generally happens</span>
<a href="#l83.115"></a><span id="l83.115" class="difflineplus">+    // Another possible means of getting this info would be to observe</span>
<a href="#l83.116"></a><span id="l83.116" class="difflineplus">+    //  &quot;xul-window-visible&quot;, but it provides no context and may still require</span>
<a href="#l83.117"></a><span id="l83.117" class="difflineplus">+    //  polling anyways.</span>
<a href="#l83.118"></a><span id="l83.118" class="difflineplus">+    mozmill.wm.addListener(this);</span>
<a href="#l83.119"></a><span id="l83.119" class="difflineplus">+</span>
<a href="#l83.120"></a><span id="l83.120" class="difflineplus">+    this._inited = true;</span>
<a href="#l83.121"></a><span id="l83.121" class="difflineplus">+  },</span>
<a href="#l83.122"></a><span id="l83.122" class="difflineplus">+</span>
<a href="#l83.123"></a><span id="l83.123" class="difflineplus">+  /**</span>
<a href="#l83.124"></a><span id="l83.124" class="difflineplus">+   * Track the windowtypes we are waiting on.  Keys are windowtypes.  When</span>
<a href="#l83.125"></a><span id="l83.125" class="difflineplus">+   *  watching for new windows, values are initially null, and are set to an</span>
<a href="#l83.126"></a><span id="l83.126" class="difflineplus">+   *  nsIXULWindow when we actually find the window.  When watching for closing</span>
<a href="#l83.127"></a><span id="l83.127" class="difflineplus">+   *  windows, values are nsIXULWindows.  This symmetry lets us have windows</span>
<a href="#l83.128"></a><span id="l83.128" class="difflineplus">+   *  that appear and dis-appear do so without dangerously confusing us (as</span>
<a href="#l83.129"></a><span id="l83.129" class="difflineplus">+   *  long as another one comes along...)</span>
<a href="#l83.130"></a><span id="l83.130" class="difflineplus">+   */</span>
<a href="#l83.131"></a><span id="l83.131" class="difflineplus">+  waitingList: {},</span>
<a href="#l83.132"></a><span id="l83.132" class="difflineplus">+  /**</span>
<a href="#l83.133"></a><span id="l83.133" class="difflineplus">+   * Note that we will be looking for a window with the given window type</span>
<a href="#l83.134"></a><span id="l83.134" class="difflineplus">+   *  (ex: &quot;mailnews:search&quot;).  This allows us to be ready if an event shows</span>
<a href="#l83.135"></a><span id="l83.135" class="difflineplus">+   *  up before waitForWindow is called.</span>
<a href="#l83.136"></a><span id="l83.136" class="difflineplus">+   */</span>
<a href="#l83.137"></a><span id="l83.137" class="difflineplus">+  planForWindowOpen: function WindowWatcher_planForWindowOpen(aWindowType) {</span>
<a href="#l83.138"></a><span id="l83.138" class="difflineplus">+    this.waitingList[aWindowType] = null;</span>
<a href="#l83.139"></a><span id="l83.139" class="difflineplus">+  },</span>
<a href="#l83.140"></a><span id="l83.140" class="difflineplus">+</span>
<a href="#l83.141"></a><span id="l83.141" class="difflineplus">+  /**</span>
<a href="#l83.142"></a><span id="l83.142" class="difflineplus">+   * Like planForWindowOpen but we check for already-existing windows.</span>
<a href="#l83.143"></a><span id="l83.143" class="difflineplus">+   */</span>
<a href="#l83.144"></a><span id="l83.144" class="difflineplus">+  planForAlreadyOpenWindow:</span>
<a href="#l83.145"></a><span id="l83.145" class="difflineplus">+      function WindowWatcher_planForAlreadyOpenWindow(aWindowType) {</span>
<a href="#l83.146"></a><span id="l83.146" class="difflineplus">+    this.waitingList[aWindowType] = null;</span>
<a href="#l83.147"></a><span id="l83.147" class="difflineplus">+    // We need to iterate over all the XUL windows and consider them all.</span>
<a href="#l83.148"></a><span id="l83.148" class="difflineplus">+    //  We can't pass the window type because the window might not have a</span>
<a href="#l83.149"></a><span id="l83.149" class="difflineplus">+    //  window type yet.</span>
<a href="#l83.150"></a><span id="l83.150" class="difflineplus">+    // because this iterates from old to new, this does the right thing in that</span>
<a href="#l83.151"></a><span id="l83.151" class="difflineplus">+    //  side-effects of consider will pick the most recent window.</span>
<a href="#l83.152"></a><span id="l83.152" class="difflineplus">+    for each (let xulWindow in fixIterator(</span>
<a href="#l83.153"></a><span id="l83.153" class="difflineplus">+                                 mozmill.wm.getXULWindowEnumerator(null),</span>
<a href="#l83.154"></a><span id="l83.154" class="difflineplus">+                                 Ci.nsIXULWindow)) {</span>
<a href="#l83.155"></a><span id="l83.155" class="difflineplus">+      if (!this.consider(xulWindow))</span>
<a href="#l83.156"></a><span id="l83.156" class="difflineplus">+        this.monitoringList.push(xulWindow);</span>
<a href="#l83.157"></a><span id="l83.157" class="difflineplus">+    }</span>
<a href="#l83.158"></a><span id="l83.158" class="difflineplus">+  },</span>
<a href="#l83.159"></a><span id="l83.159" class="difflineplus">+</span>
<a href="#l83.160"></a><span id="l83.160" class="difflineplus">+  /**</span>
<a href="#l83.161"></a><span id="l83.161" class="difflineplus">+   * The current windowType we are waiting to open.  This is mainly a means of</span>
<a href="#l83.162"></a><span id="l83.162" class="difflineplus">+   *  communicating the desired window type to monitorize without having to</span>
<a href="#l83.163"></a><span id="l83.163" class="difflineplus">+   *  put the argument in the eval string.</span>
<a href="#l83.164"></a><span id="l83.164" class="difflineplus">+   */</span>
<a href="#l83.165"></a><span id="l83.165" class="difflineplus">+  waitingForOpen: null,</span>
<a href="#l83.166"></a><span id="l83.166" class="difflineplus">+  /**</span>
<a href="#l83.167"></a><span id="l83.167" class="difflineplus">+   * Wait for the given windowType to open and finish loading.</span>
<a href="#l83.168"></a><span id="l83.168" class="difflineplus">+   *</span>
<a href="#l83.169"></a><span id="l83.169" class="difflineplus">+   * @return The window wrapped in a MozMillController.</span>
<a href="#l83.170"></a><span id="l83.170" class="difflineplus">+   */</span>
<a href="#l83.171"></a><span id="l83.171" class="difflineplus">+  waitForWindowOpen: function WindowWatcher_waitForWindowOpen(aWindowType) {</span>
<a href="#l83.172"></a><span id="l83.172" class="difflineplus">+    this.waitingForOpen = aWindowType;</span>
<a href="#l83.173"></a><span id="l83.173" class="difflineplus">+    controller.waitForEval(</span>
<a href="#l83.174"></a><span id="l83.174" class="difflineplus">+      'subject.monitorizeOpen()',</span>
<a href="#l83.175"></a><span id="l83.175" class="difflineplus">+      this._firstWindowOpened ? WINDOW_OPEN_TIMEOUT_MS</span>
<a href="#l83.176"></a><span id="l83.176" class="difflineplus">+                              : FIRST_WINDOW_EVER_TIMEOUT_MS,</span>
<a href="#l83.177"></a><span id="l83.177" class="difflineplus">+      this._firstWindowOpened ? WINDOW_OPEN_CHECK_INTERVAL_MS</span>
<a href="#l83.178"></a><span id="l83.178" class="difflineplus">+                              : FIRST_WINDOW_CHECK_INTERVAL_MS,</span>
<a href="#l83.179"></a><span id="l83.179" class="difflineplus">+      this);</span>
<a href="#l83.180"></a><span id="l83.180" class="difflineplus">+    this.waitingForOpen = null;</span>
<a href="#l83.181"></a><span id="l83.181" class="difflineplus">+    let xulWindow = this.waitingList[aWindowType];</span>
<a href="#l83.182"></a><span id="l83.182" class="difflineplus">+dump(&quot;### XUL window: &quot; + xulWindow + &quot;\n&quot;);</span>
<a href="#l83.183"></a><span id="l83.183" class="difflineplus">+    let domWindow = xulWindow.docShell.QueryInterface(Ci.nsIInterfaceRequestor)</span>
<a href="#l83.184"></a><span id="l83.184" class="difflineplus">+                                      .getInterface(Ci.nsIDOMWindowInternal);</span>
<a href="#l83.185"></a><span id="l83.185" class="difflineplus">+dump(&quot;domWindow: &quot; + domWindow + &quot;\n&quot;);</span>
<a href="#l83.186"></a><span id="l83.186" class="difflineplus">+    delete this.waitingList[aWindowType];</span>
<a href="#l83.187"></a><span id="l83.187" class="difflineplus">+    // spin the event loop to make sure any setTimeout 0 calls have gotten their</span>
<a href="#l83.188"></a><span id="l83.188" class="difflineplus">+    //  time in the sun.</span>
<a href="#l83.189"></a><span id="l83.189" class="difflineplus">+    controller.sleep(0);</span>
<a href="#l83.190"></a><span id="l83.190" class="difflineplus">+    this._firstWindowOpened = true;</span>
<a href="#l83.191"></a><span id="l83.191" class="difflineplus">+    return new controller.MozMillController(domWindow);</span>
<a href="#l83.192"></a><span id="l83.192" class="difflineplus">+  },</span>
<a href="#l83.193"></a><span id="l83.193" class="difflineplus">+</span>
<a href="#l83.194"></a><span id="l83.194" class="difflineplus">+  /**</span>
<a href="#l83.195"></a><span id="l83.195" class="difflineplus">+   * Because the modal dialog spins its own event loop, the mozmill idiom of</span>
<a href="#l83.196"></a><span id="l83.196" class="difflineplus">+   *  spinning your own event-loop as performed by waitForEval is no good.  We</span>
<a href="#l83.197"></a><span id="l83.197" class="difflineplus">+   *  use this timer to generate our events so that we can have a waitForEval</span>
<a href="#l83.198"></a><span id="l83.198" class="difflineplus">+   *  equivalent.</span>
<a href="#l83.199"></a><span id="l83.199" class="difflineplus">+   *</span>
<a href="#l83.200"></a><span id="l83.200" class="difflineplus">+   * We only have one timer right now because modal dialogs that spawn modal</span>
<a href="#l83.201"></a><span id="l83.201" class="difflineplus">+   *  dialogs are not tremendously likely.</span>
<a href="#l83.202"></a><span id="l83.202" class="difflineplus">+   */</span>
<a href="#l83.203"></a><span id="l83.203" class="difflineplus">+  _timer: null,</span>
<a href="#l83.204"></a><span id="l83.204" class="difflineplus">+  _timerRuntimeSoFar: 0,</span>
<a href="#l83.205"></a><span id="l83.205" class="difflineplus">+  /**</span>
<a href="#l83.206"></a><span id="l83.206" class="difflineplus">+   * The test function to run when the modal dialog opens.</span>
<a href="#l83.207"></a><span id="l83.207" class="difflineplus">+   */</span>
<a href="#l83.208"></a><span id="l83.208" class="difflineplus">+  subTestFunc: null,</span>
<a href="#l83.209"></a><span id="l83.209" class="difflineplus">+  planForModalDialog: function WindowWatcher_planForModalDialog(aWindowType,</span>
<a href="#l83.210"></a><span id="l83.210" class="difflineplus">+                                                                aSubTestFunc) {</span>
<a href="#l83.211"></a><span id="l83.211" class="difflineplus">+    if (this._timer == null)</span>
<a href="#l83.212"></a><span id="l83.212" class="difflineplus">+      this._timer = Cc[&quot;@mozilla.org/timer;1&quot;].createInstance(Ci.nsITimer);</span>
<a href="#l83.213"></a><span id="l83.213" class="difflineplus">+    this.waitingForOpen = aWindowType;</span>
<a href="#l83.214"></a><span id="l83.214" class="difflineplus">+    this.subTestFunc = aSubTestFunc;</span>
<a href="#l83.215"></a><span id="l83.215" class="difflineplus">+    this.waitingList[aWindowType] = null;</span>
<a href="#l83.216"></a><span id="l83.216" class="difflineplus">+</span>
<a href="#l83.217"></a><span id="l83.217" class="difflineplus">+    this._timerRuntimeSoFar = 0;</span>
<a href="#l83.218"></a><span id="l83.218" class="difflineplus">+    this._timer.initWithCallback(this, WINDOW_OPEN_CHECK_INTERVAL_MS,</span>
<a href="#l83.219"></a><span id="l83.219" class="difflineplus">+                                 Ci.nsITimer.TYPE_REPEATING_SLACK);</span>
<a href="#l83.220"></a><span id="l83.220" class="difflineplus">+  },</span>
<a href="#l83.221"></a><span id="l83.221" class="difflineplus">+</span>
<a href="#l83.222"></a><span id="l83.222" class="difflineplus">+  /**</span>
<a href="#l83.223"></a><span id="l83.223" class="difflineplus">+   * This is the nsITimer notification we receive...</span>
<a href="#l83.224"></a><span id="l83.224" class="difflineplus">+   */</span>
<a href="#l83.225"></a><span id="l83.225" class="difflineplus">+  notify: function WindowWatcher_notify() {</span>
<a href="#l83.226"></a><span id="l83.226" class="difflineplus">+dump(&quot;Timer check!\n&quot;);</span>
<a href="#l83.227"></a><span id="l83.227" class="difflineplus">+    if (this.monitorizeOpen()) {</span>
<a href="#l83.228"></a><span id="l83.228" class="difflineplus">+      // okay, the window is opened, and we should be in its event loop now.</span>
<a href="#l83.229"></a><span id="l83.229" class="difflineplus">+dump(&quot;  THIS IS IT!\n&quot;);</span>
<a href="#l83.230"></a><span id="l83.230" class="difflineplus">+      let xulWindow = this.waitingList[this.waitingForOpen];</span>
<a href="#l83.231"></a><span id="l83.231" class="difflineplus">+dump(&quot; xul window: &quot; + xulWindow + &quot;\n&quot;);</span>
<a href="#l83.232"></a><span id="l83.232" class="difflineplus">+      let domWindow = xulWindow.docShell.QueryInterface(Ci.nsIInterfaceRequestor)</span>
<a href="#l83.233"></a><span id="l83.233" class="difflineplus">+                                        .getInterface(Ci.nsIDOMWindowInternal);</span>
<a href="#l83.234"></a><span id="l83.234" class="difflineplus">+dump(&quot; dom window: &quot; + domWindow + &quot;\n&quot;);</span>
<a href="#l83.235"></a><span id="l83.235" class="difflineplus">+      let troller = new controller.MozMillController(domWindow);</span>
<a href="#l83.236"></a><span id="l83.236" class="difflineplus">+      augment_controller(troller, this.waitingForOpen);</span>
<a href="#l83.237"></a><span id="l83.237" class="difflineplus">+</span>
<a href="#l83.238"></a><span id="l83.238" class="difflineplus">+dump(&quot; cleanup!\n&quot;);</span>
<a href="#l83.239"></a><span id="l83.239" class="difflineplus">+      delete this.waitingList[this.waitingForOpen];</span>
<a href="#l83.240"></a><span id="l83.240" class="difflineplus">+      this._timer.cancel();</span>
<a href="#l83.241"></a><span id="l83.241" class="difflineplus">+dump(&quot;canceled!\n&quot;);</span>
<a href="#l83.242"></a><span id="l83.242" class="difflineplus">+      try {</span>
<a href="#l83.243"></a><span id="l83.243" class="difflineplus">+        dump(&quot;::: calling\n&quot;);</span>
<a href="#l83.244"></a><span id="l83.244" class="difflineplus">+        try {</span>
<a href="#l83.245"></a><span id="l83.245" class="difflineplus">+          let runner = new frame.Runner(collector);</span>
<a href="#l83.246"></a><span id="l83.246" class="difflineplus">+          runner.wrapper(this.subTestFunc, troller);</span>
<a href="#l83.247"></a><span id="l83.247" class="difflineplus">+        }</span>
<a href="#l83.248"></a><span id="l83.248" class="difflineplus">+        catch (ex) {</span>
<a href="#l83.249"></a><span id="l83.249" class="difflineplus">+          dump(&quot;problem running: &quot; + ex.fileName + &quot;:&quot; + ex.lineNumber + &quot;: &quot; + ex + &quot;\n&quot;);</span>
<a href="#l83.250"></a><span id="l83.250" class="difflineplus">+        }</span>
<a href="#l83.251"></a><span id="l83.251" class="difflineplus">+        dump(&quot;::: called\n&quot;);</span>
<a href="#l83.252"></a><span id="l83.252" class="difflineplus">+      }</span>
<a href="#l83.253"></a><span id="l83.253" class="difflineplus">+      finally {</span>
<a href="#l83.254"></a><span id="l83.254" class="difflineplus">+        this.subTestFunc = null;</span>
<a href="#l83.255"></a><span id="l83.255" class="difflineplus">+      }</span>
<a href="#l83.256"></a><span id="l83.256" class="difflineplus">+      // now we are waiting for it to close...</span>
<a href="#l83.257"></a><span id="l83.257" class="difflineplus">+      this.waitingForClose = this.waitingForOpen;</span>
<a href="#l83.258"></a><span id="l83.258" class="difflineplus">+      this.waitingForOpen = null;</span>
<a href="#l83.259"></a><span id="l83.259" class="difflineplus">+</span>
<a href="#l83.260"></a><span id="l83.260" class="difflineplus">+      // if the test failed, make sure we force the window closed...</span>
<a href="#l83.261"></a><span id="l83.261" class="difflineplus">+      // except I'm not sure how to easily figure that out...</span>
<a href="#l83.262"></a><span id="l83.262" class="difflineplus">+      // so just close it no matter what.</span>
<a href="#l83.263"></a><span id="l83.263" class="difflineplus">+      troller.window.close();</span>
<a href="#l83.264"></a><span id="l83.264" class="difflineplus">+    }</span>
<a href="#l83.265"></a><span id="l83.265" class="difflineplus">+    // notify is only used for modal dialogs, which are never the first window,</span>
<a href="#l83.266"></a><span id="l83.266" class="difflineplus">+    //  so we can always just use this set of timeouts/intervals.</span>
<a href="#l83.267"></a><span id="l83.267" class="difflineplus">+    this._timerRuntimeSoFar += WINDOW_OPEN_CHECK_INTERVAL_MS;</span>
<a href="#l83.268"></a><span id="l83.268" class="difflineplus">+    if (this._timerRuntimeSoFar &gt;= WINDOW_OPEN_TIMEOUT_MS) {</span>
<a href="#l83.269"></a><span id="l83.269" class="difflineplus">+      dump(&quot;!!! TIMEOUT WHILE WAITING FOR MODAL DIALOG !!!\n&quot;);</span>
<a href="#l83.270"></a><span id="l83.270" class="difflineplus">+      this._timer.cancel();</span>
<a href="#l83.271"></a><span id="l83.271" class="difflineplus">+      throw new Error(&quot;Timeout while waiting for modal dialog.\n&quot;);</span>
<a href="#l83.272"></a><span id="l83.272" class="difflineplus">+    }</span>
<a href="#l83.273"></a><span id="l83.273" class="difflineplus">+  },</span>
<a href="#l83.274"></a><span id="l83.274" class="difflineplus">+</span>
<a href="#l83.275"></a><span id="l83.275" class="difflineplus">+  /**</span>
<a href="#l83.276"></a><span id="l83.276" class="difflineplus">+   * Symmetry for planForModalDialog; conceptually provides the waiting.  In</span>
<a href="#l83.277"></a><span id="l83.277" class="difflineplus">+   *  reality, all we do is potentially soak up the event loop a little to</span>
<a href="#l83.278"></a><span id="l83.278" class="difflineplus">+   */</span>
<a href="#l83.279"></a><span id="l83.279" class="difflineplus">+  waitForModalDialog: function WindowWatcher_waitForModalDialog(aWindowType) {</span>
<a href="#l83.280"></a><span id="l83.280" class="difflineplus">+    // did the window already come and go?</span>
<a href="#l83.281"></a><span id="l83.281" class="difflineplus">+    if (this.subTestFunc == null)</span>
<a href="#l83.282"></a><span id="l83.282" class="difflineplus">+      return;</span>
<a href="#l83.283"></a><span id="l83.283" class="difflineplus">+    // spin the event loop until we the window has come and gone.</span>
<a href="#l83.284"></a><span id="l83.284" class="difflineplus">+    controller.waitForEval(</span>
<a href="#l83.285"></a><span id="l83.285" class="difflineplus">+      'subject.waitingForOpen == null &amp;&amp; subject.waitingForClose == null',</span>
<a href="#l83.286"></a><span id="l83.286" class="difflineplus">+      WINDOW_OPEN_TIMEOUT_MS, WINDOW_OPEN_CHECK_INTERVAL_MS, this);</span>
<a href="#l83.287"></a><span id="l83.287" class="difflineplus">+    this.waitingForClose = null;</span>
<a href="#l83.288"></a><span id="l83.288" class="difflineplus">+  },</span>
<a href="#l83.289"></a><span id="l83.289" class="difflineplus">+</span>
<a href="#l83.290"></a><span id="l83.290" class="difflineplus">+  planForWindowClose: function WindowWatcher_planForWindowClose(aXULWindow) {</span>
<a href="#l83.291"></a><span id="l83.291" class="difflineplus">+    let windowType =</span>
<a href="#l83.292"></a><span id="l83.292" class="difflineplus">+      aXULWindow.document.documentElement.getAttribute(&quot;windowtype&quot;);</span>
<a href="#l83.293"></a><span id="l83.293" class="difflineplus">+    this.waitingList[windowType] = aXULWindow;</span>
<a href="#l83.294"></a><span id="l83.294" class="difflineplus">+    this.waitingForClose = windowType;</span>
<a href="#l83.295"></a><span id="l83.295" class="difflineplus">+  },</span>
<a href="#l83.296"></a><span id="l83.296" class="difflineplus">+</span>
<a href="#l83.297"></a><span id="l83.297" class="difflineplus">+  /**</span>
<a href="#l83.298"></a><span id="l83.298" class="difflineplus">+   * The current windowType we are waiting to close.  Same deal as</span>
<a href="#l83.299"></a><span id="l83.299" class="difflineplus">+   *  waitingForOpen, this makes the eval less crazy.</span>
<a href="#l83.300"></a><span id="l83.300" class="difflineplus">+   */</span>
<a href="#l83.301"></a><span id="l83.301" class="difflineplus">+  waitingForClose: null,</span>
<a href="#l83.302"></a><span id="l83.302" class="difflineplus">+  waitForWindowClose: function WindowWatcher_waitForWindowClose() {</span>
<a href="#l83.303"></a><span id="l83.303" class="difflineplus">+    controller.waitForEval('subject.monitorizeClose()',</span>
<a href="#l83.304"></a><span id="l83.304" class="difflineplus">+                           WINDOW_CLOSE_TIMEOUT_MS,</span>
<a href="#l83.305"></a><span id="l83.305" class="difflineplus">+                           WINDOW_CLOSE_CHECK_INTERVAL_MS, this);</span>
<a href="#l83.306"></a><span id="l83.306" class="difflineplus">+    let didDisappear = this.waitingList[this.waitingForClose] == null;</span>
<a href="#l83.307"></a><span id="l83.307" class="difflineplus">+    delete this.waitingList[windowType];</span>
<a href="#l83.308"></a><span id="l83.308" class="difflineplus">+    let windowType = this.waitingForClose;</span>
<a href="#l83.309"></a><span id="l83.309" class="difflineplus">+    this.waitingForClose = null;</span>
<a href="#l83.310"></a><span id="l83.310" class="difflineplus">+    if (!didDisappear)</span>
<a href="#l83.311"></a><span id="l83.311" class="difflineplus">+      throw new Error(windowType + &quot; window did not disappear!&quot;);</span>
<a href="#l83.312"></a><span id="l83.312" class="difflineplus">+  },</span>
<a href="#l83.313"></a><span id="l83.313" class="difflineplus">+</span>
<a href="#l83.314"></a><span id="l83.314" class="difflineplus">+  /**</span>
<a href="#l83.315"></a><span id="l83.315" class="difflineplus">+   * This notification gets called when windows tell the widnow mediator when</span>
<a href="#l83.316"></a><span id="l83.316" class="difflineplus">+   *  the window title gets changed.  In theory, we could use this to be</span>
<a href="#l83.317"></a><span id="l83.317" class="difflineplus">+   *  event driven with less polling (effort), but it is not to be.</span>
<a href="#l83.318"></a><span id="l83.318" class="difflineplus">+   */</span>
<a href="#l83.319"></a><span id="l83.319" class="difflineplus">+  onWindowTitleChange: function WindowWatcher_onWindowTitleChange(</span>
<a href="#l83.320"></a><span id="l83.320" class="difflineplus">+      aXULWindow, aNewTitle) {</span>
<a href="#l83.321"></a><span id="l83.321" class="difflineplus">+  },</span>
<a href="#l83.322"></a><span id="l83.322" class="difflineplus">+</span>
<a href="#l83.323"></a><span id="l83.323" class="difflineplus">+  /**</span>
<a href="#l83.324"></a><span id="l83.324" class="difflineplus">+   * Used by waitForWindowOpen to check all of the windows we are monitoring and</span>
<a href="#l83.325"></a><span id="l83.325" class="difflineplus">+   *  then check if we have any results.</span>
<a href="#l83.326"></a><span id="l83.326" class="difflineplus">+   *</span>
<a href="#l83.327"></a><span id="l83.327" class="difflineplus">+   * @return true if we found what we were |waitingForOpen|, false otherwise.</span>
<a href="#l83.328"></a><span id="l83.328" class="difflineplus">+   */</span>
<a href="#l83.329"></a><span id="l83.329" class="difflineplus">+  monitorizeOpen: function () {</span>
<a href="#l83.330"></a><span id="l83.330" class="difflineplus">+    for (let iWin = this.monitoringList.length - 1; iWin &gt;= 0; iWin--) {</span>
<a href="#l83.331"></a><span id="l83.331" class="difflineplus">+      let xulWindow = this.monitoringList[iWin];</span>
<a href="#l83.332"></a><span id="l83.332" class="difflineplus">+      if (this.consider(xulWindow))</span>
<a href="#l83.333"></a><span id="l83.333" class="difflineplus">+        this.monitoringList.splice(iWin, 1);</span>
<a href="#l83.334"></a><span id="l83.334" class="difflineplus">+    }</span>
<a href="#l83.335"></a><span id="l83.335" class="difflineplus">+</span>
<a href="#l83.336"></a><span id="l83.336" class="difflineplus">+    return this.waitingList[this.waitingForOpen] != null;</span>
<a href="#l83.337"></a><span id="l83.337" class="difflineplus">+  },</span>
<a href="#l83.338"></a><span id="l83.338" class="difflineplus">+</span>
<a href="#l83.339"></a><span id="l83.339" class="difflineplus">+  /**</span>
<a href="#l83.340"></a><span id="l83.340" class="difflineplus">+   * Used by waitForWindowClose to check if the window we are waiting to close</span>
<a href="#l83.341"></a><span id="l83.341" class="difflineplus">+   *  actually closed yet.</span>
<a href="#l83.342"></a><span id="l83.342" class="difflineplus">+   *</span>
<a href="#l83.343"></a><span id="l83.343" class="difflineplus">+   * @return true if it closed.</span>
<a href="#l83.344"></a><span id="l83.344" class="difflineplus">+   */</span>
<a href="#l83.345"></a><span id="l83.345" class="difflineplus">+  monitorizeClose: function () {</span>
<a href="#l83.346"></a><span id="l83.346" class="difflineplus">+    return this.waitingList[this.waitingForClose] == null;</span>
<a href="#l83.347"></a><span id="l83.347" class="difflineplus">+  },</span>
<a href="#l83.348"></a><span id="l83.348" class="difflineplus">+</span>
<a href="#l83.349"></a><span id="l83.349" class="difflineplus">+  /**</span>
<a href="#l83.350"></a><span id="l83.350" class="difflineplus">+   * A list of xul windows to monitor because they are loading and it's not yet</span>
<a href="#l83.351"></a><span id="l83.351" class="difflineplus">+   *  possible to tell whether they are something we are looking for.</span>
<a href="#l83.352"></a><span id="l83.352" class="difflineplus">+   */</span>
<a href="#l83.353"></a><span id="l83.353" class="difflineplus">+  monitoringList: [],</span>
<a href="#l83.354"></a><span id="l83.354" class="difflineplus">+  /**</span>
<a href="#l83.355"></a><span id="l83.355" class="difflineplus">+   * Monitor the given window's loading process until we can determine whether</span>
<a href="#l83.356"></a><span id="l83.356" class="difflineplus">+   *  it is what we are looking for.</span>
<a href="#l83.357"></a><span id="l83.357" class="difflineplus">+   */</span>
<a href="#l83.358"></a><span id="l83.358" class="difflineplus">+  monitorWindowLoad: function(aXULWindow) {</span>
<a href="#l83.359"></a><span id="l83.359" class="difflineplus">+    this.monitoringList.push(aXULWindow);</span>
<a href="#l83.360"></a><span id="l83.360" class="difflineplus">+  },</span>
<a href="#l83.361"></a><span id="l83.361" class="difflineplus">+</span>
<a href="#l83.362"></a><span id="l83.362" class="difflineplus">+  /**</span>
<a href="#l83.363"></a><span id="l83.363" class="difflineplus">+   * nsIWindowMediatorListener notification that a XUL window was opened.  We</span>
<a href="#l83.364"></a><span id="l83.364" class="difflineplus">+   *  check out the window, and if we were not able to fully consider it, we</span>
<a href="#l83.365"></a><span id="l83.365" class="difflineplus">+   *  add it to our monitoring list.</span>
<a href="#l83.366"></a><span id="l83.366" class="difflineplus">+   */</span>
<a href="#l83.367"></a><span id="l83.367" class="difflineplus">+  onOpenWindow: function WindowWatcher_onOpenWindow(aXULWindow) {</span>
<a href="#l83.368"></a><span id="l83.368" class="difflineplus">+    if (!this.consider(aXULWindow))</span>
<a href="#l83.369"></a><span id="l83.369" class="difflineplus">+      this.monitorWindowLoad(aXULWindow);</span>
<a href="#l83.370"></a><span id="l83.370" class="difflineplus">+  },</span>
<a href="#l83.371"></a><span id="l83.371" class="difflineplus">+</span>
<a href="#l83.372"></a><span id="l83.372" class="difflineplus">+  /**</span>
<a href="#l83.373"></a><span id="l83.373" class="difflineplus">+   * Consider if the given window is something in our |waitingList|.</span>
<a href="#l83.374"></a><span id="l83.374" class="difflineplus">+   *</span>
<a href="#l83.375"></a><span id="l83.375" class="difflineplus">+   * @return true if we were able to fully consider the object, false if we were</span>
<a href="#l83.376"></a><span id="l83.376" class="difflineplus">+   *     not and need to be called again on the window later.  This has no</span>
<a href="#l83.377"></a><span id="l83.377" class="difflineplus">+   *     relation to whether the window was one in our waitingList or not.</span>
<a href="#l83.378"></a><span id="l83.378" class="difflineplus">+   *     Check the waitingList structure for that.</span>
<a href="#l83.379"></a><span id="l83.379" class="difflineplus">+   */</span>
<a href="#l83.380"></a><span id="l83.380" class="difflineplus">+  consider: function (aXULWindow) {</span>
<a href="#l83.381"></a><span id="l83.381" class="difflineplus">+dump(&quot;### considering: &quot; + aXULWindow + &quot;\n&quot;);</span>
<a href="#l83.382"></a><span id="l83.382" class="difflineplus">+    let docshell = aXULWindow.docShell;</span>
<a href="#l83.383"></a><span id="l83.383" class="difflineplus">+    // we need the docshell to exist...</span>
<a href="#l83.384"></a><span id="l83.384" class="difflineplus">+    if (!docshell)</span>
<a href="#l83.385"></a><span id="l83.385" class="difflineplus">+      return false;</span>
<a href="#l83.386"></a><span id="l83.386" class="difflineplus">+dump(&quot;### has docshell\n&quot;);</span>
<a href="#l83.387"></a><span id="l83.387" class="difflineplus">+    // we can't know if it's the right document until it's not busy</span>
<a href="#l83.388"></a><span id="l83.388" class="difflineplus">+    if (docshell.busyFlags)</span>
<a href="#l83.389"></a><span id="l83.389" class="difflineplus">+      return false;</span>
<a href="#l83.390"></a><span id="l83.390" class="difflineplus">+dump(&quot;### not busy\n&quot;);</span>
<a href="#l83.391"></a><span id="l83.391" class="difflineplus">+    // it also needs to have content loaded (it starts out not busy with no</span>
<a href="#l83.392"></a><span id="l83.392" class="difflineplus">+    //  content viewer.)</span>
<a href="#l83.393"></a><span id="l83.393" class="difflineplus">+    if (docshell.contentViewer == null)</span>
<a href="#l83.394"></a><span id="l83.394" class="difflineplus">+      return false;</span>
<a href="#l83.395"></a><span id="l83.395" class="difflineplus">+dump(&quot;### has contentViewer\n&quot;);</span>
<a href="#l83.396"></a><span id="l83.396" class="difflineplus">+    // now we're cooking! let's get the document...</span>
<a href="#l83.397"></a><span id="l83.397" class="difflineplus">+    let outerDoc = docshell.contentViewer.DOMDocument;</span>
<a href="#l83.398"></a><span id="l83.398" class="difflineplus">+    // and make sure it's not blank.  that's also an intermediate state.</span>
<a href="#l83.399"></a><span id="l83.399" class="difflineplus">+    if (outerDoc.location.href == &quot;about:blank&quot;)</span>
<a href="#l83.400"></a><span id="l83.400" class="difflineplus">+      return false;</span>
<a href="#l83.401"></a><span id="l83.401" class="difflineplus">+dump(&quot;has href: &quot; + outerDoc.location.href + &quot;\n&quot;);</span>
<a href="#l83.402"></a><span id="l83.402" class="difflineplus">+    // finally, we can now have a windowtype!</span>
<a href="#l83.403"></a><span id="l83.403" class="difflineplus">+    let windowType = outerDoc.documentElement.getAttribute(&quot;windowtype&quot;);</span>
<a href="#l83.404"></a><span id="l83.404" class="difflineplus">+dump(&quot;has windowtype: &quot; + windowType + &quot;\n&quot;);</span>
<a href="#l83.405"></a><span id="l83.405" class="difflineplus">+dump(&quot;this: &quot; + this + &quot;\n&quot;);</span>
<a href="#l83.406"></a><span id="l83.406" class="difflineplus">+dump(&quot;waitingList: &quot; + this.waitingList + &quot;\n&quot;);</span>
<a href="#l83.407"></a><span id="l83.407" class="difflineplus">+    // stash the window if we were watching for it</span>
<a href="#l83.408"></a><span id="l83.408" class="difflineplus">+    if (windowType in this.waitingList) {</span>
<a href="#l83.409"></a><span id="l83.409" class="difflineplus">+      dump(&quot;It's there! setting...\n&quot;);</span>
<a href="#l83.410"></a><span id="l83.410" class="difflineplus">+      this.waitingList[windowType] = aXULWindow;</span>
<a href="#l83.411"></a><span id="l83.411" class="difflineplus">+    }</span>
<a href="#l83.412"></a><span id="l83.412" class="difflineplus">+    else {</span>
<a href="#l83.413"></a><span id="l83.413" class="difflineplus">+      dump(&quot;Not there! :( SCREWED\n&quot;);</span>
<a href="#l83.414"></a><span id="l83.414" class="difflineplus">+    }</span>
<a href="#l83.415"></a><span id="l83.415" class="difflineplus">+</span>
<a href="#l83.416"></a><span id="l83.416" class="difflineplus">+    return true;</span>
<a href="#l83.417"></a><span id="l83.417" class="difflineplus">+  },</span>
<a href="#l83.418"></a><span id="l83.418" class="difflineplus">+</span>
<a href="#l83.419"></a><span id="l83.419" class="difflineplus">+  /**</span>
<a href="#l83.420"></a><span id="l83.420" class="difflineplus">+   * Closing windows have the advantage of having to already have been loaded,</span>
<a href="#l83.421"></a><span id="l83.421" class="difflineplus">+   *  so things like their windowtype are immediately available.</span>
<a href="#l83.422"></a><span id="l83.422" class="difflineplus">+   */</span>
<a href="#l83.423"></a><span id="l83.423" class="difflineplus">+  onCloseWindow: function WindowWatcher_onCloseWindow(aXULWindow) {</span>
<a href="#l83.424"></a><span id="l83.424" class="difflineplus">+    dump(&quot;!!! CLOSE EVENT: &quot; + aXULWindow + &quot;\n&quot;);</span>
<a href="#l83.425"></a><span id="l83.425" class="difflineplus">+    let domWindow = aXULWindow.docShell.QueryInterface(Ci.nsIInterfaceRequestor)</span>
<a href="#l83.426"></a><span id="l83.426" class="difflineplus">+                                       .getInterface(Ci.nsIDOMWindowInternal);</span>
<a href="#l83.427"></a><span id="l83.427" class="difflineplus">+    let windowType =</span>
<a href="#l83.428"></a><span id="l83.428" class="difflineplus">+      domWindow.document.documentElement.getAttribute(&quot;windowtype&quot;);</span>
<a href="#l83.429"></a><span id="l83.429" class="difflineplus">+    // XXX because of how we dance with things, equivalence is not gonna</span>
<a href="#l83.430"></a><span id="l83.430" class="difflineplus">+    //  happen for us.  This is most pragmatic.</span>
<a href="#l83.431"></a><span id="l83.431" class="difflineplus">+    if (this.waitingList[windowType] !== null)</span>
<a href="#l83.432"></a><span id="l83.432" class="difflineplus">+      this.waitingList[windowType] = null;</span>
<a href="#l83.433"></a><span id="l83.433" class="difflineplus">+    dump(&quot;close end proc\n&quot;);</span>
<a href="#l83.434"></a><span id="l83.434" class="difflineplus">+  },</span>
<a href="#l83.435"></a><span id="l83.435" class="difflineplus">+};</span>
<a href="#l83.436"></a><span id="l83.436" class="difflineplus">+</span>
<a href="#l83.437"></a><span id="l83.437" class="difflineplus">+/**</span>
<a href="#l83.438"></a><span id="l83.438" class="difflineplus">+ * Call this if the window you want to get may already be open.  What we</span>
<a href="#l83.439"></a><span id="l83.439" class="difflineplus">+ *  provide above just directly grabbing the window yourself is:</span>
<a href="#l83.440"></a><span id="l83.440" class="difflineplus">+ * - We wait for it to finish loading.</span>
<a href="#l83.441"></a><span id="l83.441" class="difflineplus">+ * - We augment it via the augment_controller mechanism.</span>
<a href="#l83.442"></a><span id="l83.442" class="difflineplus">+ *</span>
<a href="#l83.443"></a><span id="l83.443" class="difflineplus">+ * @param aWindowType the window type that will be created.  This is literally</span>
<a href="#l83.444"></a><span id="l83.444" class="difflineplus">+ *     the value of the &quot;windowtype&quot; attribute on the window.  The values tend</span>
<a href="#l83.445"></a><span id="l83.445" class="difflineplus">+ *     to look like &quot;app:windowname&quot;, for example &quot;mailnews:search&quot;.</span>
<a href="#l83.446"></a><span id="l83.446" class="difflineplus">+ *</span>
<a href="#l83.447"></a><span id="l83.447" class="difflineplus">+ * @return The loaded window of the given type wrapped in a MozmillController</span>
<a href="#l83.448"></a><span id="l83.448" class="difflineplus">+ *     that is augmented using augment_controller.</span>
<a href="#l83.449"></a><span id="l83.449" class="difflineplus">+ */</span>
<a href="#l83.450"></a><span id="l83.450" class="difflineplus">+function wait_for_existing_window(aWindowType) {</span>
<a href="#l83.451"></a><span id="l83.451" class="difflineplus">+  WindowWatcher.ensureInited();</span>
<a href="#l83.452"></a><span id="l83.452" class="difflineplus">+  WindowWatcher.planForAlreadyOpenWindow(aWindowType);</span>
<a href="#l83.453"></a><span id="l83.453" class="difflineplus">+  return augment_controller(WindowWatcher.waitForWindowOpen(aWindowType),</span>
<a href="#l83.454"></a><span id="l83.454" class="difflineplus">+                            aWindowType);</span>
<a href="#l83.455"></a><span id="l83.455" class="difflineplus">+}</span>
<a href="#l83.456"></a><span id="l83.456" class="difflineplus">+</span>
<a href="#l83.457"></a><span id="l83.457" class="difflineplus">+/**</span>
<a href="#l83.458"></a><span id="l83.458" class="difflineplus">+ * Call this just before you trigger the event that will cause a window to be</span>
<a href="#l83.459"></a><span id="l83.459" class="difflineplus">+ *  displayed.</span>
<a href="#l83.460"></a><span id="l83.460" class="difflineplus">+ * In theory, we don't need this and could just do a sweep of existing windows</span>
<a href="#l83.461"></a><span id="l83.461" class="difflineplus">+ *  when you call wait_for_new_window, or we could always just keep track of</span>
<a href="#l83.462"></a><span id="l83.462" class="difflineplus">+ *  the most recently seen window of each type, but this is arguably more</span>
<a href="#l83.463"></a><span id="l83.463" class="difflineplus">+ *  resilient in the face of multiple windows of the same type as long as you</span>
<a href="#l83.464"></a><span id="l83.464" class="difflineplus">+ *  don't try and open them all at the same time.</span>
<a href="#l83.465"></a><span id="l83.465" class="difflineplus">+ *</span>
<a href="#l83.466"></a><span id="l83.466" class="difflineplus">+ * @param aWindowType the window type that will be created.  This is literally</span>
<a href="#l83.467"></a><span id="l83.467" class="difflineplus">+ *     the value of the &quot;windowtype&quot; attribute on the window.  The values tend</span>
<a href="#l83.468"></a><span id="l83.468" class="difflineplus">+ *     to look like &quot;app:windowname&quot;, for example &quot;mailnews:search&quot;.</span>
<a href="#l83.469"></a><span id="l83.469" class="difflineplus">+ */</span>
<a href="#l83.470"></a><span id="l83.470" class="difflineplus">+function plan_for_new_window(aWindowType) {</span>
<a href="#l83.471"></a><span id="l83.471" class="difflineplus">+  WindowWatcher.ensureInited();</span>
<a href="#l83.472"></a><span id="l83.472" class="difflineplus">+  WindowWatcher.planForWindowOpen(aWindowType);</span>
<a href="#l83.473"></a><span id="l83.473" class="difflineplus">+}</span>
<a href="#l83.474"></a><span id="l83.474" class="difflineplus">+</span>
<a href="#l83.475"></a><span id="l83.475" class="difflineplus">+</span>
<a href="#l83.476"></a><span id="l83.476" class="difflineplus">+/**</span>
<a href="#l83.477"></a><span id="l83.477" class="difflineplus">+ * Wait for the loading of the given window type to complete (that you</span>
<a href="#l83.478"></a><span id="l83.478" class="difflineplus">+ *  previously told us about via |plan_for_new_window|), returning it wrapped</span>
<a href="#l83.479"></a><span id="l83.479" class="difflineplus">+ *  in a MozmillController.</span>
<a href="#l83.480"></a><span id="l83.480" class="difflineplus">+ *</span>
<a href="#l83.481"></a><span id="l83.481" class="difflineplus">+ * @return The loaded window of the given type wrapped in a MozmillController</span>
<a href="#l83.482"></a><span id="l83.482" class="difflineplus">+ *     that is augmented using augment_controller.</span>
<a href="#l83.483"></a><span id="l83.483" class="difflineplus">+ */</span>
<a href="#l83.484"></a><span id="l83.484" class="difflineplus">+function wait_for_new_window(aWindowType) {</span>
<a href="#l83.485"></a><span id="l83.485" class="difflineplus">+  return augment_controller(WindowWatcher.waitForWindowOpen(aWindowType),</span>
<a href="#l83.486"></a><span id="l83.486" class="difflineplus">+                            aWindowType);</span>
<a href="#l83.487"></a><span id="l83.487" class="difflineplus">+}</span>
<a href="#l83.488"></a><span id="l83.488" class="difflineplus">+</span>
<a href="#l83.489"></a><span id="l83.489" class="difflineplus">+/**</span>
<a href="#l83.490"></a><span id="l83.490" class="difflineplus">+ * Plan for the imminent display of a modal dialog.  Modal dialogs spin their</span>
<a href="#l83.491"></a><span id="l83.491" class="difflineplus">+ *  own event loop which means that either that control flow will not return</span>
<a href="#l83.492"></a><span id="l83.492" class="difflineplus">+ *  to the caller until the modal dialog finishes running.  This means that</span>
<a href="#l83.493"></a><span id="l83.493" class="difflineplus">+ *  you need to provide a sub-test function to be run inside the modal dialog</span>
<a href="#l83.494"></a><span id="l83.494" class="difflineplus">+ *  (and it should not start with &quot;test&quot; or mozmill will also try and run it.)</span>
<a href="#l83.495"></a><span id="l83.495" class="difflineplus">+ *</span>
<a href="#l83.496"></a><span id="l83.496" class="difflineplus">+ * @param aWindowType The window type that you expect the modal dialog to have.</span>
<a href="#l83.497"></a><span id="l83.497" class="difflineplus">+ * @param aSubTestFunction The sub-test function that will be run once the modal</span>
<a href="#l83.498"></a><span id="l83.498" class="difflineplus">+ *     dialog appears and is loaded.  This function should take one argument,</span>
<a href="#l83.499"></a><span id="l83.499" class="difflineplus">+ *     a MozmillController against the modal dialog.</span>
<a href="#l83.500"></a><span id="l83.500" class="difflineplus">+ */</span>
<a href="#l83.501"></a><span id="l83.501" class="difflineplus">+function plan_for_modal_dialog(aWindowType, aSubTestFunction) {</span>
<a href="#l83.502"></a><span id="l83.502" class="difflineplus">+  WindowWatcher.ensureInited();</span>
<a href="#l83.503"></a><span id="l83.503" class="difflineplus">+  WindowWatcher.planForModalDialog(aWindowType, aSubTestFunction);</span>
<a href="#l83.504"></a><span id="l83.504" class="difflineplus">+}</span>
<a href="#l83.505"></a><span id="l83.505" class="difflineplus">+function wait_for_modal_dialog(aWindowType) {</span>
<a href="#l83.506"></a><span id="l83.506" class="difflineplus">+  WindowWatcher.waitForModalDialog(aWindowType);</span>
<a href="#l83.507"></a><span id="l83.507" class="difflineplus">+}</span>
<a href="#l83.508"></a><span id="l83.508" class="difflineplus">+</span>
<a href="#l83.509"></a><span id="l83.509" class="difflineplus">+/**</span>
<a href="#l83.510"></a><span id="l83.510" class="difflineplus">+ * Call this just before you trigger the event that will cause the provided</span>
<a href="#l83.511"></a><span id="l83.511" class="difflineplus">+ *  controller's window to disappear.  You then follow this with a call to</span>
<a href="#l83.512"></a><span id="l83.512" class="difflineplus">+ *  |wait_for_window_close| when you want to block on verifying the close.</span>
<a href="#l83.513"></a><span id="l83.513" class="difflineplus">+ *</span>
<a href="#l83.514"></a><span id="l83.514" class="difflineplus">+ * @param aController The MozmillController, potentially returned from a call to</span>
<a href="#l83.515"></a><span id="l83.515" class="difflineplus">+ *     wait_for_new_window, whose window should be disappearing.</span>
<a href="#l83.516"></a><span id="l83.516" class="difflineplus">+ */</span>
<a href="#l83.517"></a><span id="l83.517" class="difflineplus">+function plan_for_window_close(aController) {</span>
<a href="#l83.518"></a><span id="l83.518" class="difflineplus">+  WindowWatcher.ensureInited();</span>
<a href="#l83.519"></a><span id="l83.519" class="difflineplus">+  WindowWatcher.planForWindowClose(aController.window);</span>
<a href="#l83.520"></a><span id="l83.520" class="difflineplus">+}</span>
<a href="#l83.521"></a><span id="l83.521" class="difflineplus">+</span>
<a href="#l83.522"></a><span id="l83.522" class="difflineplus">+/**</span>
<a href="#l83.523"></a><span id="l83.523" class="difflineplus">+ * Wait for the closure of the window you noted you would listen for its close</span>
<a href="#l83.524"></a><span id="l83.524" class="difflineplus">+ *  in plan_for_window_close.</span>
<a href="#l83.525"></a><span id="l83.525" class="difflineplus">+ */</span>
<a href="#l83.526"></a><span id="l83.526" class="difflineplus">+function wait_for_window_close() {</span>
<a href="#l83.527"></a><span id="l83.527" class="difflineplus">+  WindowWatcher.waitForWindowClose();</span>
<a href="#l83.528"></a><span id="l83.528" class="difflineplus">+}</span>
<a href="#l83.529"></a><span id="l83.529" class="difflineplus">+</span>
<a href="#l83.530"></a><span id="l83.530" class="difflineplus">+/**</span>
<a href="#l83.531"></a><span id="l83.531" class="difflineplus">+ * Methods to augment every controller that passes through augment_controller.</span>
<a href="#l83.532"></a><span id="l83.532" class="difflineplus">+ */</span>
<a href="#l83.533"></a><span id="l83.533" class="difflineplus">+var AugmentEverybodyWith = {</span>
<a href="#l83.534"></a><span id="l83.534" class="difflineplus">+  methods: {</span>
<a href="#l83.535"></a><span id="l83.535" class="difflineplus">+    /**</span>
<a href="#l83.536"></a><span id="l83.536" class="difflineplus">+     * @param aId The element id to use to locate the (initial) element.</span>
<a href="#l83.537"></a><span id="l83.537" class="difflineplus">+     * @param aQuery Optional query to pick a child of the element identified</span>
<a href="#l83.538"></a><span id="l83.538" class="difflineplus">+     *   by the id.  Terms that can be used (and applied in this order):</span>
<a href="#l83.539"></a><span id="l83.539" class="difflineplus">+     * - tagName: Find children with the tagname, if further constraints don't</span>
<a href="#l83.540"></a><span id="l83.540" class="difflineplus">+     *     whittle it down, the first element is chosen.</span>
<a href="#l83.541"></a><span id="l83.541" class="difflineplus">+     * - label: Whittle previous elements by their label.</span>
<a href="#l83.542"></a><span id="l83.542" class="difflineplus">+     *</span>
<a href="#l83.543"></a><span id="l83.543" class="difflineplus">+     * example:</span>
<a href="#l83.544"></a><span id="l83.544" class="difflineplus">+     *  // find the child of bob that is a button with a &quot;+&quot; on it.</span>
<a href="#l83.545"></a><span id="l83.545" class="difflineplus">+     *  e(&quot;bob&quot;, {tagName: &quot;button&quot;, label: &quot;+&quot;});</span>
<a href="#l83.546"></a><span id="l83.546" class="difflineplus">+     *  // example:</span>
<a href="#l83.547"></a><span id="l83.547" class="difflineplus">+     *  e(&quot;threadTree&quot;, {tagName: &quot;treechildren&quot;});</span>
<a href="#l83.548"></a><span id="l83.548" class="difflineplus">+     *</span>
<a href="#l83.549"></a><span id="l83.549" class="difflineplus">+     * @return the element with the given id on the window's document</span>
<a href="#l83.550"></a><span id="l83.550" class="difflineplus">+     */</span>
<a href="#l83.551"></a><span id="l83.551" class="difflineplus">+    e: function _get_element_by_id_helper(aId, aQuery) {</span>
<a href="#l83.552"></a><span id="l83.552" class="difflineplus">+      let elem = this.window.document.getElementById(aId);</span>
<a href="#l83.553"></a><span id="l83.553" class="difflineplus">+      if (aQuery) {</span>
<a href="#l83.554"></a><span id="l83.554" class="difflineplus">+        if (aQuery.tagName) {</span>
<a href="#l83.555"></a><span id="l83.555" class="difflineplus">+          let elems = Array.slice.call(</span>
<a href="#l83.556"></a><span id="l83.556" class="difflineplus">+                        elem.getElementsByTagName(aQuery.tagName));</span>
<a href="#l83.557"></a><span id="l83.557" class="difflineplus">+          if (aQuery.label)</span>
<a href="#l83.558"></a><span id="l83.558" class="difflineplus">+            elems = [elem for each (elem in elems)</span>
<a href="#l83.559"></a><span id="l83.559" class="difflineplus">+                          if (elem.label == aQuery.label)];</span>
<a href="#l83.560"></a><span id="l83.560" class="difflineplus">+          elem = elems[0];</span>
<a href="#l83.561"></a><span id="l83.561" class="difflineplus">+        }</span>
<a href="#l83.562"></a><span id="l83.562" class="difflineplus">+      }</span>
<a href="#l83.563"></a><span id="l83.563" class="difflineplus">+      return elem;</span>
<a href="#l83.564"></a><span id="l83.564" class="difflineplus">+    },</span>
<a href="#l83.565"></a><span id="l83.565" class="difflineplus">+</span>
<a href="#l83.566"></a><span id="l83.566" class="difflineplus">+    /**</span>
<a href="#l83.567"></a><span id="l83.567" class="difflineplus">+     * @return an elementlib.Elem for the element with the given id on the</span>
<a href="#l83.568"></a><span id="l83.568" class="difflineplus">+     *  window's document.</span>
<a href="#l83.569"></a><span id="l83.569" class="difflineplus">+     */</span>
<a href="#l83.570"></a><span id="l83.570" class="difflineplus">+    eid: function _get_elementid_by_id_helper(aId, aQuery) {</span>
<a href="#l83.571"></a><span id="l83.571" class="difflineplus">+      return new elib.Elem(this.e(aId, aQuery));</span>
<a href="#l83.572"></a><span id="l83.572" class="difflineplus">+    },</span>
<a href="#l83.573"></a><span id="l83.573" class="difflineplus">+</span>
<a href="#l83.574"></a><span id="l83.574" class="difflineplus">+    /**</span>
<a href="#l83.575"></a><span id="l83.575" class="difflineplus">+     * Find an element in the anonymous subtree of an element in the document</span>
<a href="#l83.576"></a><span id="l83.576" class="difflineplus">+     *  identified by its id.  You would use this to dig into XBL bindings that</span>
<a href="#l83.577"></a><span id="l83.577" class="difflineplus">+     *  are not doing what you want.  For example, jerks that don't focus right.</span>
<a href="#l83.578"></a><span id="l83.578" class="difflineplus">+     *</span>
<a href="#l83.579"></a><span id="l83.579" class="difflineplus">+     * Examples:</span>
<a href="#l83.580"></a><span id="l83.580" class="difflineplus">+     *  // by class of the node</span>
<a href="#l83.581"></a><span id="l83.581" class="difflineplus">+     *  a(&quot;searchVal0&quot;, {class: &quot;search-value-textbox&quot;});</span>
<a href="#l83.582"></a><span id="l83.582" class="difflineplus">+     *  // when the thing is vaguely deck-like</span>
<a href="#l83.583"></a><span id="l83.583" class="difflineplus">+     *  a(&quot;searchVal0&quot;, {crazyDeck: 0});</span>
<a href="#l83.584"></a><span id="l83.584" class="difflineplus">+     *  // when you want the first descendent with the given tagName</span>
<a href="#l83.585"></a><span id="l83.585" class="difflineplus">+     *  a(&quot;threadTree&quot;, {tagName: treechildren})</span>
<a href="#l83.586"></a><span id="l83.586" class="difflineplus">+     *</span>
<a href="#l83.587"></a><span id="l83.587" class="difflineplus">+     * @return the anonymous element determined by the query found in the</span>
<a href="#l83.588"></a><span id="l83.588" class="difflineplus">+     *  anonymous sub-tree of the element with the given id.</span>
<a href="#l83.589"></a><span id="l83.589" class="difflineplus">+     */</span>
<a href="#l83.590"></a><span id="l83.590" class="difflineplus">+    a: function _get_anon_element_by_id_and_query(aId, aQuery) {</span>
<a href="#l83.591"></a><span id="l83.591" class="difflineplus">+      let realElem = this.window.document.getElementById(aId);</span>
<a href="#l83.592"></a><span id="l83.592" class="difflineplus">+      if (aQuery[&quot;class&quot;]) {</span>
<a href="#l83.593"></a><span id="l83.593" class="difflineplus">+        return this.window.document.getAnonymousElementByAttribute(</span>
<a href="#l83.594"></a><span id="l83.594" class="difflineplus">+          realElem, &quot;class&quot;, aQuery[&quot;class&quot;]);</span>
<a href="#l83.595"></a><span id="l83.595" class="difflineplus">+      }</span>
<a href="#l83.596"></a><span id="l83.596" class="difflineplus">+      else if(aQuery.crazyDeck != null) {</span>
<a href="#l83.597"></a><span id="l83.597" class="difflineplus">+        let anonNodes = this.window.document.getAnonymousNodes(realElem);</span>
<a href="#l83.598"></a><span id="l83.598" class="difflineplus">+        let index;</span>
<a href="#l83.599"></a><span id="l83.599" class="difflineplus">+        if (realElem.hasAttribute(&quot;selectedIndex&quot;))</span>
<a href="#l83.600"></a><span id="l83.600" class="difflineplus">+          index = parseInt(realElem.getAttribute(&quot;selectedIndex&quot;));</span>
<a href="#l83.601"></a><span id="l83.601" class="difflineplus">+        else</span>
<a href="#l83.602"></a><span id="l83.602" class="difflineplus">+          index = aQuery.crazyDeck;</span>
<a href="#l83.603"></a><span id="l83.603" class="difflineplus">+        let elem = anonNodes[index];</span>
<a href="#l83.604"></a><span id="l83.604" class="difflineplus">+        return elem;</span>
<a href="#l83.605"></a><span id="l83.605" class="difflineplus">+      }</span>
<a href="#l83.606"></a><span id="l83.606" class="difflineplus">+      else if(aQuery.tagName) {</span>
<a href="#l83.607"></a><span id="l83.607" class="difflineplus">+        let anonNodes = this.window.document.getAnonymousNodes(realElem);</span>
<a href="#l83.608"></a><span id="l83.608" class="difflineplus">+        let index;</span>
<a href="#l83.609"></a><span id="l83.609" class="difflineplus">+        for (let iNode = 0; iNode &lt; anonNodes.length; iNode++) {</span>
<a href="#l83.610"></a><span id="l83.610" class="difflineplus">+          let node = anonNodes[iNode];</span>
<a href="#l83.611"></a><span id="l83.611" class="difflineplus">+          let named = node.getElementsByTagName(aQuery.tagName);</span>
<a href="#l83.612"></a><span id="l83.612" class="difflineplus">+          if (named.length)</span>
<a href="#l83.613"></a><span id="l83.613" class="difflineplus">+            return named[0];</span>
<a href="#l83.614"></a><span id="l83.614" class="difflineplus">+        }</span>
<a href="#l83.615"></a><span id="l83.615" class="difflineplus">+      }</span>
<a href="#l83.616"></a><span id="l83.616" class="difflineplus">+      else {</span>
<a href="#l83.617"></a><span id="l83.617" class="difflineplus">+        let msg = &quot;Query constraint not implemented, query contained:&quot;;</span>
<a href="#l83.618"></a><span id="l83.618" class="difflineplus">+        for (let [key, val] in Iterator(aQuery)) {</span>
<a href="#l83.619"></a><span id="l83.619" class="difflineplus">+          msg += &quot; '&quot; + key + &quot;': &quot; + val;</span>
<a href="#l83.620"></a><span id="l83.620" class="difflineplus">+        }</span>
<a href="#l83.621"></a><span id="l83.621" class="difflineplus">+        throw new Error(msg);</span>
<a href="#l83.622"></a><span id="l83.622" class="difflineplus">+      }</span>
<a href="#l83.623"></a><span id="l83.623" class="difflineplus">+      return null;</span>
<a href="#l83.624"></a><span id="l83.624" class="difflineplus">+    },</span>
<a href="#l83.625"></a><span id="l83.625" class="difflineplus">+    /**</span>
<a href="#l83.626"></a><span id="l83.626" class="difflineplus">+     * Wraps a call to a() in an elib.Elem.</span>
<a href="#l83.627"></a><span id="l83.627" class="difflineplus">+     */</span>
<a href="#l83.628"></a><span id="l83.628" class="difflineplus">+    aid: function _get_anon_elementid(aId, aQuery) {</span>
<a href="#l83.629"></a><span id="l83.629" class="difflineplus">+      return new elib.Elem(this.a(aId, aQuery));</span>
<a href="#l83.630"></a><span id="l83.630" class="difflineplus">+    },</span>
<a href="#l83.631"></a><span id="l83.631" class="difflineplus">+  },</span>
<a href="#l83.632"></a><span id="l83.632" class="difflineplus">+};</span>
<a href="#l83.633"></a><span id="l83.633" class="difflineplus">+</span>
<a href="#l83.634"></a><span id="l83.634" class="difflineplus">+/**</span>
<a href="#l83.635"></a><span id="l83.635" class="difflineplus">+ * Per-windowtype augmentations.  Please use the documentation and general</span>
<a href="#l83.636"></a><span id="l83.636" class="difflineplus">+ *  example of mail:3pane as your example.</span>
<a href="#l83.637"></a><span id="l83.637" class="difflineplus">+ */</span>
<a href="#l83.638"></a><span id="l83.638" class="difflineplus">+var PerWindowTypeAugmentations = {</span>
<a href="#l83.639"></a><span id="l83.639" class="difflineplus">+  /**</span>
<a href="#l83.640"></a><span id="l83.640" class="difflineplus">+   * The 3pane window is messenger.xul, the default window.</span>
<a href="#l83.641"></a><span id="l83.641" class="difflineplus">+   */</span>
<a href="#l83.642"></a><span id="l83.642" class="difflineplus">+  &quot;mail:3pane&quot;: {</span>
<a href="#l83.643"></a><span id="l83.643" class="difflineplus">+    /**</span>
<a href="#l83.644"></a><span id="l83.644" class="difflineplus">+     * DOM elements to expose as attributes (by copying at augmentation time.)</span>
<a href="#l83.645"></a><span id="l83.645" class="difflineplus">+     */</span>
<a href="#l83.646"></a><span id="l83.646" class="difflineplus">+    elementsToExpose: {</span>
<a href="#l83.647"></a><span id="l83.647" class="difflineplus">+      threadTree: &quot;threadTree&quot;,</span>
<a href="#l83.648"></a><span id="l83.648" class="difflineplus">+      tabmail: &quot;tabmail&quot;,</span>
<a href="#l83.649"></a><span id="l83.649" class="difflineplus">+    },</span>
<a href="#l83.650"></a><span id="l83.650" class="difflineplus">+    /**</span>
<a href="#l83.651"></a><span id="l83.651" class="difflineplus">+     * DOM elements to expose as elementslib.IDs as attributes (at augmentation</span>
<a href="#l83.652"></a><span id="l83.652" class="difflineplus">+     *  time.)</span>
<a href="#l83.653"></a><span id="l83.653" class="difflineplus">+     */</span>
<a href="#l83.654"></a><span id="l83.654" class="difflineplus">+    elementIDsToExpose: {</span>
<a href="#l83.655"></a><span id="l83.655" class="difflineplus">+      eThreadTree: &quot;threadTree&quot;,</span>
<a href="#l83.656"></a><span id="l83.656" class="difflineplus">+    },</span>
<a href="#l83.657"></a><span id="l83.657" class="difflineplus">+    /**</span>
<a href="#l83.658"></a><span id="l83.658" class="difflineplus">+     * Globals from the controller's windows global scope at augmentation time.</span>
<a href="#l83.659"></a><span id="l83.659" class="difflineplus">+     */</span>
<a href="#l83.660"></a><span id="l83.660" class="difflineplus">+    globalsToExposeAtStartup: {</span>
<a href="#l83.661"></a><span id="l83.661" class="difflineplus">+      folderTreeView: &quot;gFolderTreeView&quot;,</span>
<a href="#l83.662"></a><span id="l83.662" class="difflineplus">+    },</span>
<a href="#l83.663"></a><span id="l83.663" class="difflineplus">+    /**</span>
<a href="#l83.664"></a><span id="l83.664" class="difflineplus">+     * Globals from the controller's windows global to retrieve on-demand</span>
<a href="#l83.665"></a><span id="l83.665" class="difflineplus">+     *  through getters.</span>
<a href="#l83.666"></a><span id="l83.666" class="difflineplus">+     */</span>
<a href="#l83.667"></a><span id="l83.667" class="difflineplus">+    globalsToExposeViaGetters: {</span>
<a href="#l83.668"></a><span id="l83.668" class="difflineplus">+      // all of these dudes</span>
<a href="#l83.669"></a><span id="l83.669" class="difflineplus">+      folderDisplay: &quot;gFolderDisplay&quot;,</span>
<a href="#l83.670"></a><span id="l83.670" class="difflineplus">+      messageDisplay: &quot;gMessageDisplay&quot;,</span>
<a href="#l83.671"></a><span id="l83.671" class="difflineplus">+    },</span>
<a href="#l83.672"></a><span id="l83.672" class="difflineplus">+    /**</span>
<a href="#l83.673"></a><span id="l83.673" class="difflineplus">+     * Custom getters whose |this| is the controller.</span>
<a href="#l83.674"></a><span id="l83.674" class="difflineplus">+     */</span>
<a href="#l83.675"></a><span id="l83.675" class="difflineplus">+    getters: {</span>
<a href="#l83.676"></a><span id="l83.676" class="difflineplus">+      dbView: function () {</span>
<a href="#l83.677"></a><span id="l83.677" class="difflineplus">+        return this.threadTree.view.QueryInterface(Ci.nsIMsgDBView);</span>
<a href="#l83.678"></a><span id="l83.678" class="difflineplus">+      },</span>
<a href="#l83.679"></a><span id="l83.679" class="difflineplus">+      contentPane: function () {</span>
<a href="#l83.680"></a><span id="l83.680" class="difflineplus">+        return this.tabmail.getBrowserForSelectedTab();</span>
<a href="#l83.681"></a><span id="l83.681" class="difflineplus">+      },</span>
<a href="#l83.682"></a><span id="l83.682" class="difflineplus">+    },</span>
<a href="#l83.683"></a><span id="l83.683" class="difflineplus">+</span>
<a href="#l83.684"></a><span id="l83.684" class="difflineplus">+    /**</span>
<a href="#l83.685"></a><span id="l83.685" class="difflineplus">+     * Invoked when we are augmenting a controller.  This is a great time to</span>
<a href="#l83.686"></a><span id="l83.686" class="difflineplus">+     *  poke into the global namespace as required.</span>
<a href="#l83.687"></a><span id="l83.687" class="difflineplus">+     */</span>
<a href="#l83.688"></a><span id="l83.688" class="difflineplus">+    onAugment: function(aController) {</span>
<a href="#l83.689"></a><span id="l83.689" class="difflineplus">+      // -- turn off summarization's stabilization logic for now by setting the</span>
<a href="#l83.690"></a><span id="l83.690" class="difflineplus">+      //  timer interval to 0.  We do need to make sure that we drain the event</span>
<a href="#l83.691"></a><span id="l83.691" class="difflineplus">+      //  queue after performing anything that will summarize, but use of</span>
<a href="#l83.692"></a><span id="l83.692" class="difflineplus">+      //  assert_selected_and_displayed in test-folder-display-helpers should</span>
<a href="#l83.693"></a><span id="l83.693" class="difflineplus">+      //  handle that.</span>
<a href="#l83.694"></a><span id="l83.694" class="difflineplus">+      aController.window.MessageDisplayWidget.prototype</span>
<a href="#l83.695"></a><span id="l83.695" class="difflineplus">+                 .SUMMARIZATION_SELECTION_STABILITY_INTERVAL_MS = 0;</span>
<a href="#l83.696"></a><span id="l83.696" class="difflineplus">+    }</span>
<a href="#l83.697"></a><span id="l83.697" class="difflineplus">+  },</span>
<a href="#l83.698"></a><span id="l83.698" class="difflineplus">+</span>
<a href="#l83.699"></a><span id="l83.699" class="difflineplus">+  /**</span>
<a href="#l83.700"></a><span id="l83.700" class="difflineplus">+   * Standalone message window.</span>
<a href="#l83.701"></a><span id="l83.701" class="difflineplus">+   */</span>
<a href="#l83.702"></a><span id="l83.702" class="difflineplus">+  &quot;mail:messageWindow&quot;: {</span>
<a href="#l83.703"></a><span id="l83.703" class="difflineplus">+    elementsToExpose: {</span>
<a href="#l83.704"></a><span id="l83.704" class="difflineplus">+      contentPane: &quot;messagepane&quot;,</span>
<a href="#l83.705"></a><span id="l83.705" class="difflineplus">+    },</span>
<a href="#l83.706"></a><span id="l83.706" class="difflineplus">+    // the load is deferred, so use a getter.</span>
<a href="#l83.707"></a><span id="l83.707" class="difflineplus">+    globalsToExposeViaGetters: {</span>
<a href="#l83.708"></a><span id="l83.708" class="difflineplus">+      folderDisplay: &quot;gFolderDisplay&quot;,</span>
<a href="#l83.709"></a><span id="l83.709" class="difflineplus">+      messageDisplay: &quot;gMessageDisplay&quot;,</span>
<a href="#l83.710"></a><span id="l83.710" class="difflineplus">+    },</span>
<a href="#l83.711"></a><span id="l83.711" class="difflineplus">+    getters: {</span>
<a href="#l83.712"></a><span id="l83.712" class="difflineplus">+      dbView: function () {</span>
<a href="#l83.713"></a><span id="l83.713" class="difflineplus">+        return this.folderDisplay.view.dbView;</span>
<a href="#l83.714"></a><span id="l83.714" class="difflineplus">+      },</span>
<a href="#l83.715"></a><span id="l83.715" class="difflineplus">+    },</span>
<a href="#l83.716"></a><span id="l83.716" class="difflineplus">+  },</span>
<a href="#l83.717"></a><span id="l83.717" class="difflineplus">+</span>
<a href="#l83.718"></a><span id="l83.718" class="difflineplus">+  /**</span>
<a href="#l83.719"></a><span id="l83.719" class="difflineplus">+   * The search window, via control-shift-F.</span>
<a href="#l83.720"></a><span id="l83.720" class="difflineplus">+   */</span>
<a href="#l83.721"></a><span id="l83.721" class="difflineplus">+  &quot;mailnews:search&quot;: {</span>
<a href="#l83.722"></a><span id="l83.722" class="difflineplus">+    globalsToExposeAtStartup: {</span>
<a href="#l83.723"></a><span id="l83.723" class="difflineplus">+      folderDisplay: &quot;gFolderDisplay&quot;,</span>
<a href="#l83.724"></a><span id="l83.724" class="difflineplus">+    }</span>
<a href="#l83.725"></a><span id="l83.725" class="difflineplus">+  }</span>
<a href="#l83.726"></a><span id="l83.726" class="difflineplus">+};</span>
<a href="#l83.727"></a><span id="l83.727" class="difflineplus">+</span>
<a href="#l83.728"></a><span id="l83.728" class="difflineplus">+function _augment_helper(aController, aAugmentDef) {</span>
<a href="#l83.729"></a><span id="l83.729" class="difflineplus">+  if (aAugmentDef.elementsToExpose) {</span>
<a href="#l83.730"></a><span id="l83.730" class="difflineplus">+    for each (let [key, value] in Iterator(aAugmentDef.elementsToExpose)) {</span>
<a href="#l83.731"></a><span id="l83.731" class="difflineplus">+      aController[key] = aController.window.document.getElementById(value);</span>
<a href="#l83.732"></a><span id="l83.732" class="difflineplus">+    }</span>
<a href="#l83.733"></a><span id="l83.733" class="difflineplus">+  }</span>
<a href="#l83.734"></a><span id="l83.734" class="difflineplus">+  if (aAugmentDef.elementsIDsToExpose) {</span>
<a href="#l83.735"></a><span id="l83.735" class="difflineplus">+    for each (let [key, value] in Iterator(aAugmentDef.elementIDsToExpose)) {</span>
<a href="#l83.736"></a><span id="l83.736" class="difflineplus">+      aController[key] = new elib.ID(</span>
<a href="#l83.737"></a><span id="l83.737" class="difflineplus">+                           aController.window.document, value);</span>
<a href="#l83.738"></a><span id="l83.738" class="difflineplus">+    }</span>
<a href="#l83.739"></a><span id="l83.739" class="difflineplus">+  }</span>
<a href="#l83.740"></a><span id="l83.740" class="difflineplus">+  if (aAugmentDef.globalsToExposeAtStartup) {</span>
<a href="#l83.741"></a><span id="l83.741" class="difflineplus">+    for each (let [key, value] in</span>
<a href="#l83.742"></a><span id="l83.742" class="difflineplus">+              Iterator(aAugmentDef.globalsToExposeAtStartup)) {</span>
<a href="#l83.743"></a><span id="l83.743" class="difflineplus">+      aController[key] = aController.window[value];</span>
<a href="#l83.744"></a><span id="l83.744" class="difflineplus">+    }</span>
<a href="#l83.745"></a><span id="l83.745" class="difflineplus">+  }</span>
<a href="#l83.746"></a><span id="l83.746" class="difflineplus">+  if (aAugmentDef.globalsToExposeViaGetters) {</span>
<a href="#l83.747"></a><span id="l83.747" class="difflineplus">+    for each (let [key, value] in</span>
<a href="#l83.748"></a><span id="l83.748" class="difflineplus">+              Iterator(aAugmentDef.globalsToExposeViaGetters)) {</span>
<a href="#l83.749"></a><span id="l83.749" class="difflineplus">+      let globalName = value;</span>
<a href="#l83.750"></a><span id="l83.750" class="difflineplus">+      aController.__defineGetter__(key, function() {</span>
<a href="#l83.751"></a><span id="l83.751" class="difflineplus">+          return this.window[globalName];</span>
<a href="#l83.752"></a><span id="l83.752" class="difflineplus">+        });</span>
<a href="#l83.753"></a><span id="l83.753" class="difflineplus">+    }</span>
<a href="#l83.754"></a><span id="l83.754" class="difflineplus">+  }</span>
<a href="#l83.755"></a><span id="l83.755" class="difflineplus">+  if (aAugmentDef.getters) {</span>
<a href="#l83.756"></a><span id="l83.756" class="difflineplus">+    for each (let [key, value] in Iterator(aAugmentDef.getters)) {</span>
<a href="#l83.757"></a><span id="l83.757" class="difflineplus">+      aController.__defineGetter__(key, value);</span>
<a href="#l83.758"></a><span id="l83.758" class="difflineplus">+    }</span>
<a href="#l83.759"></a><span id="l83.759" class="difflineplus">+  }</span>
<a href="#l83.760"></a><span id="l83.760" class="difflineplus">+  if (aAugmentDef.methods) {</span>
<a href="#l83.761"></a><span id="l83.761" class="difflineplus">+    for each (let [key, value] in Iterator(aAugmentDef.methods)) {</span>
<a href="#l83.762"></a><span id="l83.762" class="difflineplus">+      aController[key] = value;</span>
<a href="#l83.763"></a><span id="l83.763" class="difflineplus">+    }</span>
<a href="#l83.764"></a><span id="l83.764" class="difflineplus">+  }</span>
<a href="#l83.765"></a><span id="l83.765" class="difflineplus">+</span>
<a href="#l83.766"></a><span id="l83.766" class="difflineplus">+  if (aAugmentDef.onAugment) {</span>
<a href="#l83.767"></a><span id="l83.767" class="difflineplus">+    aAugmentDef.onAugment(aController);</span>
<a href="#l83.768"></a><span id="l83.768" class="difflineplus">+  }</span>
<a href="#l83.769"></a><span id="l83.769" class="difflineplus">+}</span>
<a href="#l83.770"></a><span id="l83.770" class="difflineplus">+</span>
<a href="#l83.771"></a><span id="l83.771" class="difflineplus">+/**</span>
<a href="#l83.772"></a><span id="l83.772" class="difflineplus">+ * controller.js in mozmill actually has its own extension mechanism,</span>
<a href="#l83.773"></a><span id="l83.773" class="difflineplus">+ *  controllerAdditions.  Unfortunately, it does not make its stuff public at</span>
<a href="#l83.774"></a><span id="l83.774" class="difflineplus">+ *  this time.  In the future we can change ourselves to just use that</span>
<a href="#l83.775"></a><span id="l83.775" class="difflineplus">+ *  mechanism.</span>
<a href="#l83.776"></a><span id="l83.776" class="difflineplus">+ */</span>
<a href="#l83.777"></a><span id="l83.777" class="difflineplus">+function augment_controller(aController, aWindowType) {</span>
<a href="#l83.778"></a><span id="l83.778" class="difflineplus">+  if (aWindowType === undefined)</span>
<a href="#l83.779"></a><span id="l83.779" class="difflineplus">+    aWindowType =</span>
<a href="#l83.780"></a><span id="l83.780" class="difflineplus">+      aController.window.document.documentElement.getAttribute(&quot;windowtype&quot;);</span>
<a href="#l83.781"></a><span id="l83.781" class="difflineplus">+</span>
<a href="#l83.782"></a><span id="l83.782" class="difflineplus">+  _augment_helper(aController, AugmentEverybodyWith);</span>
<a href="#l83.783"></a><span id="l83.783" class="difflineplus">+  if (PerWindowTypeAugmentations[aWindowType])</span>
<a href="#l83.784"></a><span id="l83.784" class="difflineplus">+    _augment_helper(aController, PerWindowTypeAugmentations[aWindowType]);</span>
<a href="#l83.785"></a><span id="l83.785" class="difflineplus">+  return aController;</span>
<a href="#l83.786"></a><span id="l83.786" class="difflineplus">+}</span>
<a href="#l83.787"></a><span id="l83.787">\ No newline at end of file</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l84.1"></a><span id="l84.1" class="difflineminus">--- a/mail/themes/gnomestripe/jar.mn</span>
<a href="#l84.2"></a><span id="l84.2" class="difflineplus">+++ b/mail/themes/gnomestripe/jar.mn</span>
<a href="#l84.3"></a><span id="l84.3" class="difflineat">@@ -1,12 +1,9 @@</span>
<a href="#l84.4"></a><span id="l84.4"> classic.jar:</span>
<a href="#l84.5"></a><span id="l84.5" class="difflineminus">-+ skin/classic/global/tree.css                                (mail/tree.css)</span>
<a href="#l84.6"></a><span id="l84.6" class="difflineminus">-+ skin/classic/global/tree/sort-asc.gif                       (mail/icons/sort-asc.gif)</span>
<a href="#l84.7"></a><span id="l84.7" class="difflineminus">-+ skin/classic/global/tree/sort-dsc.gif                       (mail/icons/sort-dsc.gif)</span>
<a href="#l84.8"></a><span id="l84.8">   skin/classic/communicator/smileys.css                       (mail/smileys.css)</span>
<a href="#l84.9"></a><span id="l84.9"> % skin messenger classic/1.0 %skin/classic/messenger/</span>
<a href="#l84.10"></a><span id="l84.10">   skin/classic/messenger/primaryToolbar.css                   (mail/primaryToolbar.css)</span>
<a href="#l84.11"></a><span id="l84.11">   skin/classic/messenger/accountCentral.css                   (mail/accountCentral.css)</span>
<a href="#l84.12"></a><span id="l84.12">   skin/classic/messenger/accountCreation.css                     (mail/accountCreation.css)</span>
<a href="#l84.13"></a><span id="l84.13">   skin/classic/messenger/accountManage.css                    (mail/accountManage.css)</span>
<a href="#l84.14"></a><span id="l84.14">   skin/classic/messenger/accountWizard.css                    (mail/accountWizard.css)</span>
<a href="#l84.15"></a><span id="l84.15">   skin/classic/messenger/messageHeader.css                    (mail/messageHeader.css)</span>
<a href="#l84.16"></a><span id="l84.16" class="difflineat">@@ -194,17 +191,16 @@ classic.jar:</span>
<a href="#l84.17"></a><span id="l84.17">   skin/classic/messenger/icons/arrow/arrow-left.png           (mail/icons/arrow/arrow-left.png)</span>
<a href="#l84.18"></a><span id="l84.18">   skin/classic/messenger/icons/arrow/arrow-right.png          (mail/icons/arrow/arrow-right.png)</span>
<a href="#l84.19"></a><span id="l84.19">   skin/classic/messenger/icons/arrow/arrow-up.png             (mail/icons/arrow/arrow-up.png)</span>
<a href="#l84.20"></a><span id="l84.20">   skin/classic/messenger/icons/arrow/arrow-down.png           (mail/icons/arrow/arrow-down.png)</span>
<a href="#l84.21"></a><span id="l84.21">   skin/classic/messenger/icons/arrow/arrow-left-dim.png       (mail/icons/arrow/arrow-left-dim.png)</span>
<a href="#l84.22"></a><span id="l84.22">   skin/classic/messenger/icons/arrow/arrow-right-dim.png      (mail/icons/arrow/arrow-right-dim.png)</span>
<a href="#l84.23"></a><span id="l84.23">   skin/classic/messenger/icons/arrow/arrow-up-dim.png         (mail/icons/arrow/arrow-up-dim.png)</span>
<a href="#l84.24"></a><span id="l84.24">   skin/classic/messenger/icons/arrow/arrow-down-dim.png       (mail/icons/arrow/arrow-down-dim.png)</span>
<a href="#l84.25"></a><span id="l84.25" class="difflineminus">-  skin/classic/messenger/icons/chevron.png                    (mail/icons/chevron.png)</span>
<a href="#l84.26"></a><span id="l84.26">   skin/classic/messenger/tagbg.png                            (mail/tagbg.png)</span>
<a href="#l84.27"></a><span id="l84.27">   icon.png                                                    (mail/icon.png)</span>
<a href="#l84.28"></a><span id="l84.28">   preview.png                                                 (mail/preview.png)</span>
<a href="#l84.29"></a><span id="l84.29"> % skin editor classic/1.0 %skin/classic/editor/</span>
<a href="#l84.30"></a><span id="l84.30">   skin/classic/editor/editor.css                              (editor/editor.css)</span>
<a href="#l84.31"></a><span id="l84.31">   skin/classic/editor/EditorDialog.css                        (editor/EditorDialog.css)</span>
<a href="#l84.32"></a><span id="l84.32">   skin/classic/editor/icons/img-align-bottom.gif              (editor/img-align-bottom.gif)</span>
<a href="#l84.33"></a><span id="l84.33">   skin/classic/editor/icons/img-align-left.gif                (editor/img-align-left.gif)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l85.1"></a><span id="l85.1">deleted file mode 100644</span>
<a href="#l85.2"></a><span id="l85.2">index 246d5ee8bd00d75dfe1aecb18a70a4c898b4f2b7..e69de29bb2d1d6434b8b29ae775ad8c2e48c5391</span>
<a href="#l85.3"></a><span id="l85.3">GIT binary patch
literal 0
Hc$@&lt;O00001</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l86.1"></a><span id="l86.1">deleted file mode 100755</span>
<a href="#l86.2"></a><span id="l86.2">index b341abde70d4854bce80a79007ebde65e6b21c04..e69de29bb2d1d6434b8b29ae775ad8c2e48c5391</span>
<a href="#l86.3"></a><span id="l86.3">GIT binary patch
literal 0
Hc$@&lt;O00001</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l87.1"></a><span id="l87.1">deleted file mode 100755</span>
<a href="#l87.2"></a><span id="l87.2">index bfeb6a8a8ae42839b54de9a4645e56826a1a1bf7..e69de29bb2d1d6434b8b29ae775ad8c2e48c5391</span>
<a href="#l87.3"></a><span id="l87.3">GIT binary patch
literal 0
Hc$@&lt;O00001</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l88.1"></a><span id="l88.1" class="difflineminus">--- a/mail/themes/gnomestripe/mail/messageBody.css</span>
<a href="#l88.2"></a><span id="l88.2" class="difflineplus">+++ b/mail/themes/gnomestripe/mail/messageBody.css</span>
<a href="#l88.3"></a><span id="l88.3" class="difflineat">@@ -1,163 +1,170 @@</span>
<a href="#l88.4"></a><span id="l88.4" class="difflineminus">-/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l88.5"></a><span id="l88.5" class="difflineminus">- * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l88.6"></a><span id="l88.6" class="difflineminus">- *</span>
<a href="#l88.7"></a><span id="l88.7" class="difflineminus">- * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l88.8"></a><span id="l88.8" class="difflineminus">- * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l88.9"></a><span id="l88.9" class="difflineminus">- * the License. You may obtain a copy of the License at</span>
<a href="#l88.10"></a><span id="l88.10" class="difflineminus">- * http://www.mozilla.org/MPL/</span>
<a href="#l88.11"></a><span id="l88.11" class="difflineminus">- *</span>
<a href="#l88.12"></a><span id="l88.12" class="difflineminus">- * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l88.13"></a><span id="l88.13" class="difflineminus">- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l88.14"></a><span id="l88.14" class="difflineminus">- * for the specific language governing rights and limitations under the</span>
<a href="#l88.15"></a><span id="l88.15" class="difflineminus">- * License.</span>
<a href="#l88.16"></a><span id="l88.16" class="difflineminus">- *</span>
<a href="#l88.17"></a><span id="l88.17" class="difflineminus">- * The Original Code is mozilla.org code.</span>
<a href="#l88.18"></a><span id="l88.18" class="difflineminus">- *</span>
<a href="#l88.19"></a><span id="l88.19" class="difflineminus">- * The Initial Developer of the Original Code is</span>
<a href="#l88.20"></a><span id="l88.20" class="difflineminus">- * Netscape Communications Corporation.</span>
<a href="#l88.21"></a><span id="l88.21" class="difflineminus">- * Portions created by the Initial Developer are Copyright (C) 1998</span>
<a href="#l88.22"></a><span id="l88.22" class="difflineminus">- * the Initial Developer. All Rights Reserved.</span>
<a href="#l88.23"></a><span id="l88.23" class="difflineminus">- *</span>
<a href="#l88.24"></a><span id="l88.24" class="difflineminus">- * Contributor(s):</span>
<a href="#l88.25"></a><span id="l88.25" class="difflineminus">- *   Joe Hewitt &lt;hewitt@netscape.com&gt;</span>
<a href="#l88.26"></a><span id="l88.26" class="difflineminus">- *</span>
<a href="#l88.27"></a><span id="l88.27" class="difflineminus">- * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l88.28"></a><span id="l88.28" class="difflineminus">- * either of the GNU General Public License Version 2 or later (the &quot;GPL&quot;),</span>
<a href="#l88.29"></a><span id="l88.29" class="difflineminus">- * or the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l88.30"></a><span id="l88.30" class="difflineminus">- * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l88.31"></a><span id="l88.31" class="difflineminus">- * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l88.32"></a><span id="l88.32" class="difflineminus">- * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l88.33"></a><span id="l88.33" class="difflineminus">- * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l88.34"></a><span id="l88.34" class="difflineminus">- * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l88.35"></a><span id="l88.35" class="difflineminus">- * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l88.36"></a><span id="l88.36" class="difflineminus">- * the provisions above, a recipient may use your version of this file under</span>
<a href="#l88.37"></a><span id="l88.37" class="difflineminus">- * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l88.38"></a><span id="l88.38" class="difflineminus">- *</span>
<a href="#l88.39"></a><span id="l88.39" class="difflineminus">- * ***** END LICENSE BLOCK ***** */</span>
<a href="#l88.40"></a><span id="l88.40" class="difflineminus">-</span>
<a href="#l88.41"></a><span id="l88.41" class="difflineminus">-/* ===== messageBody.css =================================================</span>
<a href="#l88.42"></a><span id="l88.42" class="difflineminus">-  == Styles for the body of a mail message.</span>
<a href="#l88.43"></a><span id="l88.43" class="difflineminus">-  ======================================================================= */</span>
<a href="#l88.44"></a><span id="l88.44" class="difflineminus">-</span>
<a href="#l88.45"></a><span id="l88.45" class="difflineminus">-@import url(chrome://communicator/skin/smileys.css);</span>
<a href="#l88.46"></a><span id="l88.46" class="difflineminus">-@import url(chrome://messenger/skin/messageQuotes.css);</span>
<a href="#l88.47"></a><span id="l88.47" class="difflineminus">-</span>
<a href="#l88.48"></a><span id="l88.48" class="difflineminus">-@namespace url(&quot;http://www.w3.org/1999/xhtml&quot;);</span>
<a href="#l88.49"></a><span id="l88.49" class="difflineminus">-</span>
<a href="#l88.50"></a><span id="l88.50" class="difflineminus">-mailattachcount {</span>
<a href="#l88.51"></a><span id="l88.51" class="difflineminus">-  display: none;</span>
<a href="#l88.52"></a><span id="l88.52" class="difflineminus">-}</span>
<a href="#l88.53"></a><span id="l88.53" class="difflineminus">-</span>
<a href="#l88.54"></a><span id="l88.54" class="difflineminus">-/* :::: message header ::::: */</span>
<a href="#l88.55"></a><span id="l88.55" class="difflineminus">-</span>
<a href="#l88.56"></a><span id="l88.56" class="difflineminus">-.header-part1 {</span>
<a href="#l88.57"></a><span id="l88.57" class="difflineminus">-  background-color: #EFEFEF;</span>
<a href="#l88.58"></a><span id="l88.58" class="difflineminus">-}</span>
<a href="#l88.59"></a><span id="l88.59" class="difflineminus">-</span>
<a href="#l88.60"></a><span id="l88.60" class="difflineminus">-.header-part2,</span>
<a href="#l88.61"></a><span id="l88.61" class="difflineminus">-.header-part3 {</span>
<a href="#l88.62"></a><span id="l88.62" class="difflineminus">-  background-color: #DEDEDE;</span>
<a href="#l88.63"></a><span id="l88.63" class="difflineminus">-}</span>
<a href="#l88.64"></a><span id="l88.64" class="difflineminus">-</span>
<a href="#l88.65"></a><span id="l88.65" class="difflineminus">-div.headerdisplayname {</span>
<a href="#l88.66"></a><span id="l88.66" class="difflineminus">-  display: inline;</span>
<a href="#l88.67"></a><span id="l88.67" class="difflineminus">-  font-weight: bold;</span>
<a href="#l88.68"></a><span id="l88.68" class="difflineminus">-  white-space: pre;</span>
<a href="#l88.69"></a><span id="l88.69" class="difflineminus">-}</span>
<a href="#l88.70"></a><span id="l88.70" class="difflineminus">-</span>
<a href="#l88.71"></a><span id="l88.71" class="difflineminus">-/* ::::: message text, incl. quotes ::::: */</span>
<a href="#l88.72"></a><span id="l88.72" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l88.73"></a><span id="l88.73" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l88.74"></a><span id="l88.74" class="difflineplus">+ *</span>
<a href="#l88.75"></a><span id="l88.75" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l88.76"></a><span id="l88.76" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l88.77"></a><span id="l88.77" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l88.78"></a><span id="l88.78" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l88.79"></a><span id="l88.79" class="difflineplus">+ *</span>
<a href="#l88.80"></a><span id="l88.80" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l88.81"></a><span id="l88.81" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l88.82"></a><span id="l88.82" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l88.83"></a><span id="l88.83" class="difflineplus">+ * License.</span>
<a href="#l88.84"></a><span id="l88.84" class="difflineplus">+ *</span>
<a href="#l88.85"></a><span id="l88.85" class="difflineplus">+ * The Original Code is mozilla.org code.</span>
<a href="#l88.86"></a><span id="l88.86" class="difflineplus">+ *</span>
<a href="#l88.87"></a><span id="l88.87" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l88.88"></a><span id="l88.88" class="difflineplus">+ * Netscape Communications Corporation.</span>
<a href="#l88.89"></a><span id="l88.89" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 1998</span>
<a href="#l88.90"></a><span id="l88.90" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l88.91"></a><span id="l88.91" class="difflineplus">+ *</span>
<a href="#l88.92"></a><span id="l88.92" class="difflineplus">+ * Contributor(s):</span>
<a href="#l88.93"></a><span id="l88.93" class="difflineplus">+ *   Joe Hewitt &lt;hewitt@netscape.com&gt;</span>
<a href="#l88.94"></a><span id="l88.94" class="difflineplus">+ *</span>
<a href="#l88.95"></a><span id="l88.95" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l88.96"></a><span id="l88.96" class="difflineplus">+ * either of the GNU General Public License Version 2 or later (the &quot;GPL&quot;),</span>
<a href="#l88.97"></a><span id="l88.97" class="difflineplus">+ * or the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l88.98"></a><span id="l88.98" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l88.99"></a><span id="l88.99" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l88.100"></a><span id="l88.100" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l88.101"></a><span id="l88.101" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l88.102"></a><span id="l88.102" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l88.103"></a><span id="l88.103" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l88.104"></a><span id="l88.104" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l88.105"></a><span id="l88.105" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l88.106"></a><span id="l88.106" class="difflineplus">+ *</span>
<a href="#l88.107"></a><span id="l88.107" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l88.108"></a><span id="l88.108" class="difflineplus">+</span>
<a href="#l88.109"></a><span id="l88.109" class="difflineplus">+/* ===== messageBody.css =================================================</span>
<a href="#l88.110"></a><span id="l88.110" class="difflineplus">+  == Styles for the body of a mail message.</span>
<a href="#l88.111"></a><span id="l88.111" class="difflineplus">+  ======================================================================= */</span>
<a href="#l88.112"></a><span id="l88.112" class="difflineplus">+</span>
<a href="#l88.113"></a><span id="l88.113" class="difflineplus">+@import url(chrome://communicator/skin/smileys.css);</span>
<a href="#l88.114"></a><span id="l88.114" class="difflineplus">+@import url(chrome://messenger/skin/messageQuotes.css);</span>
<a href="#l88.115"></a><span id="l88.115" class="difflineplus">+</span>
<a href="#l88.116"></a><span id="l88.116" class="difflineplus">+@namespace url(&quot;http://www.w3.org/1999/xhtml&quot;);</span>
<a href="#l88.117"></a><span id="l88.117" class="difflineplus">+</span>
<a href="#l88.118"></a><span id="l88.118" class="difflineplus">+mailattachcount {</span>
<a href="#l88.119"></a><span id="l88.119" class="difflineplus">+  display: none;</span>
<a href="#l88.120"></a><span id="l88.120" class="difflineplus">+}</span>
<a href="#l88.121"></a><span id="l88.121" class="difflineplus">+</span>
<a href="#l88.122"></a><span id="l88.122" class="difflineplus">+/* :::: message header ::::: */</span>
<a href="#l88.123"></a><span id="l88.123" class="difflineplus">+</span>
<a href="#l88.124"></a><span id="l88.124" class="difflineplus">+.header-part1 {</span>
<a href="#l88.125"></a><span id="l88.125" class="difflineplus">+  background-color: #EFEFEF;</span>
<a href="#l88.126"></a><span id="l88.126" class="difflineplus">+}</span>
<a href="#l88.127"></a><span id="l88.127" class="difflineplus">+</span>
<a href="#l88.128"></a><span id="l88.128" class="difflineplus">+.header-part2,</span>
<a href="#l88.129"></a><span id="l88.129" class="difflineplus">+.header-part3 {</span>
<a href="#l88.130"></a><span id="l88.130" class="difflineplus">+  background-color: #DEDEDE;</span>
<a href="#l88.131"></a><span id="l88.131" class="difflineplus">+}</span>
<a href="#l88.132"></a><span id="l88.132" class="difflineplus">+</span>
<a href="#l88.133"></a><span id="l88.133" class="difflineplus">+div.headerdisplayname {</span>
<a href="#l88.134"></a><span id="l88.134" class="difflineplus">+  display: inline;</span>
<a href="#l88.135"></a><span id="l88.135" class="difflineplus">+  font-weight: bold;</span>
<a href="#l88.136"></a><span id="l88.136" class="difflineplus">+  white-space: pre;</span>
<a href="#l88.137"></a><span id="l88.137" class="difflineplus">+}</span>
<a href="#l88.138"></a><span id="l88.138" class="difflineplus">+</span>
<a href="#l88.139"></a><span id="l88.139" class="difflineplus">+/* ::::: message text, incl. quotes ::::: */</span>
<a href="#l88.140"></a><span id="l88.140"> </span>
<a href="#l88.141"></a><span id="l88.141"> a {</span>
<a href="#l88.142"></a><span id="l88.142">   color: rgb(32,74,135); /* Sky Blue 3 */</span>
<a href="#l88.143"></a><span id="l88.143"> }</span>
<a href="#l88.144"></a><span id="l88.144" class="difflineminus">-</span>
<a href="#l88.145"></a><span id="l88.145" class="difflineminus">-.moz-text-flowed blockquote,</span>
<a href="#l88.146"></a><span id="l88.146" class="difflineminus">-.moz-text-plain blockquote {</span>
<a href="#l88.147"></a><span id="l88.147" class="difflineminus">-  margin: 0;</span>
<a href="#l88.148"></a><span id="l88.148" class="difflineminus">-}</span>
<a href="#l88.149"></a><span id="l88.149" class="difflineminus">-</span>
<a href="#l88.150"></a><span id="l88.150" class="difflineminus">-.moz-text-plain pre {</span>
<a href="#l88.151"></a><span id="l88.151" class="difflineminus">-  margin: 0;</span>
<a href="#l88.152"></a><span id="l88.152" class="difflineminus">-  font-family: inherit;</span>
<a href="#l88.153"></a><span id="l88.153" class="difflineminus">-}</span>
<a href="#l88.154"></a><span id="l88.154" class="difflineminus">-</span>
<a href="#l88.155"></a><span id="l88.155" class="difflineminus">-.moz-text-plain[wrap=&quot;true&quot;] {</span>
<a href="#l88.156"></a><span id="l88.156" class="difflineminus">-  white-space: pre-wrap;</span>
<a href="#l88.157"></a><span id="l88.157" class="difflineminus">-}</span>
<a href="#l88.158"></a><span id="l88.158" class="difflineminus">-</span>
<a href="#l88.159"></a><span id="l88.159" class="difflineminus">-.moz-text-plain[wrap=&quot;false&quot;] {</span>
<a href="#l88.160"></a><span id="l88.160" class="difflineminus">-  white-space: pre;</span>
<a href="#l88.161"></a><span id="l88.161" class="difflineminus">-}</span>
<a href="#l88.162"></a><span id="l88.162" class="difflineminus">-</span>
<a href="#l88.163"></a><span id="l88.163" class="difflineminus">-.moz-text-plain[wrap=&quot;flow&quot;] .moz-txt-sig {</span>
<a href="#l88.164"></a><span id="l88.164" class="difflineminus">-  white-space: pre-wrap;</span>
<a href="#l88.165"></a><span id="l88.165" class="difflineminus">-}</span>
<a href="#l88.166"></a><span id="l88.166" class="difflineminus">-</span>
<a href="#l88.167"></a><span id="l88.167" class="difflineminus">-.moz-text-plain[graphical-quote=&quot;false&quot;] blockquote {</span>
<a href="#l88.168"></a><span id="l88.168" class="difflineminus">-  border-style: none;</span>
<a href="#l88.169"></a><span id="l88.169" class="difflineminus">-  padding: 0;</span>
<a href="#l88.170"></a><span id="l88.170" class="difflineminus">-}</span>
<a href="#l88.171"></a><span id="l88.171" class="difflineminus">-</span>
<a href="#l88.172"></a><span id="l88.172" class="difflineminus">-.moz-text-plain[graphical-quote=&quot;true&quot;] .moz-txt-citetags {</span>
<a href="#l88.173"></a><span id="l88.173" class="difflineminus">-  display: none;</span>
<a href="#l88.174"></a><span id="l88.174" class="difflineminus">-}</span>
<a href="#l88.175"></a><span id="l88.175" class="difflineminus">-</span>
<a href="#l88.176"></a><span id="l88.176" class="difflineminus">-span.moz-txt-underscore {</span>
<a href="#l88.177"></a><span id="l88.177" class="difflineminus">-  text-decoration: underline;</span>
<a href="#l88.178"></a><span id="l88.178" class="difflineminus">-}</span>
<a href="#l88.179"></a><span id="l88.179" class="difflineminus">-</span>
<a href="#l88.180"></a><span id="l88.180" class="difflineminus">-span.moz-txt-formfeed {</span>
<a href="#l88.181"></a><span id="l88.181" class="difflineminus">-  display: block;</span>
<a href="#l88.182"></a><span id="l88.182" class="difflineminus">-  height: 100%;</span>
<a href="#l88.183"></a><span id="l88.183" class="difflineminus">-}</span>
<a href="#l88.184"></a><span id="l88.184" class="difflineminus">-</span>
<a href="#l88.185"></a><span id="l88.185" class="difflineminus">-/* ::::: attached images ::::: */</span>
<a href="#l88.186"></a><span id="l88.186" class="difflineminus">-.moz-attached-image[overflowing=&quot;true&quot;] { </span>
<a href="#l88.187"></a><span id="l88.187" class="difflineminus">-  cursor: -moz-zoom-out;</span>
<a href="#l88.188"></a><span id="l88.188" class="difflineminus">-}</span>
<a href="#l88.189"></a><span id="l88.189" class="difflineminus">-</span>
<a href="#l88.190"></a><span id="l88.190" class="difflineminus">-.moz-attached-image[isshrunk=&quot;true&quot;] { </span>
<a href="#l88.191"></a><span id="l88.191" class="difflineminus">-  cursor: -moz-zoom-in;</span>
<a href="#l88.192"></a><span id="l88.192" class="difflineminus">-  max-width: 100%;</span>
<a href="#l88.193"></a><span id="l88.193" class="difflineminus">-}</span>
<a href="#l88.194"></a><span id="l88.194" class="difflineminus">-</span>
<a href="#l88.195"></a><span id="l88.195" class="difflineminus">-</span>
<a href="#l88.196"></a><span id="l88.196" class="difflineminus">-/* ::::: vcard ::::: */</span>
<a href="#l88.197"></a><span id="l88.197" class="difflineminus">-</span>
<a href="#l88.198"></a><span id="l88.198" class="difflineminus">-.moz-vcard-table {</span>
<a href="#l88.199"></a><span id="l88.199" class="difflineminus">-  -moz-border-radius: 8px;</span>
<a href="#l88.200"></a><span id="l88.200" class="difflineminus">-  border: thin solid gray;</span>
<a href="#l88.201"></a><span id="l88.201" class="difflineminus">-  margin-top: 10px;</span>
<a href="#l88.202"></a><span id="l88.202" class="difflineminus">-}</span>
<a href="#l88.203"></a><span id="l88.203" class="difflineminus">-</span>
<a href="#l88.204"></a><span id="l88.204" class="difflineminus">-.moz-vcard-property {</span>
<a href="#l88.205"></a><span id="l88.205" class="difflineminus">-  font-size: 80%;</span>
<a href="#l88.206"></a><span id="l88.206" class="difflineminus">-  color: gray;</span>
<a href="#l88.207"></a><span id="l88.207" class="difflineminus">-}</span>
<a href="#l88.208"></a><span id="l88.208" class="difflineminus">-</span>
<a href="#l88.209"></a><span id="l88.209" class="difflineminus">-.moz-vcard-title-property {</span>
<a href="#l88.210"></a><span id="l88.210" class="difflineminus">-} </span>
<a href="#l88.211"></a><span id="l88.211" class="difflineminus">-</span>
<a href="#l88.212"></a><span id="l88.212" class="difflineminus">-.moz-vcard-badge {</span>
<a href="#l88.213"></a><span id="l88.213" class="difflineminus">-  height: 24px;</span>
<a href="#l88.214"></a><span id="l88.214" class="difflineminus">-  width: 24px;</span>
<a href="#l88.215"></a><span id="l88.215" class="difflineminus">-  background-color: transparent;</span>
<a href="#l88.216"></a><span id="l88.216" class="difflineminus">-  display: block;</span>
<a href="#l88.217"></a><span id="l88.217" class="difflineminus">-  background-image: url(&quot;chrome://messenger/skin/addressbook/icons/abcard-large.png&quot;);</span>
<a href="#l88.218"></a><span id="l88.218" class="difflineminus">-}</span>
<a href="#l88.219"></a><span id="l88.219" class="difflineminus">-</span>
<a href="#l88.220"></a><span id="l88.220" class="difflineminus">-.moz-vcard-badge:hover {</span>
<a href="#l88.221"></a><span id="l88.221" class="difflineminus">-  -moz-image-region: rect(30px 30px 60px 0px);</span>
<a href="#l88.222"></a><span id="l88.222" class="difflineminus">-} </span>
<a href="#l88.223"></a><span id="l88.223" class="difflineminus">-</span>
<a href="#l88.224"></a><span id="l88.224" class="difflineminus">-.moz-vcard-badge:focus {</span>
<a href="#l88.225"></a><span id="l88.225" class="difflineminus">-  outline: none;</span>
<a href="#l88.226"></a><span id="l88.226" class="difflineminus">-}</span>
<a href="#l88.227"></a><span id="l88.227" class="difflineminus">-</span>
<a href="#l88.228"></a><span id="l88.228" class="difflineminus">-/* Correct style for messages already converted from RSS to HTML email;</span>
<a href="#l88.229"></a><span id="l88.229" class="difflineminus">-   see bug 363154. */</span>
<a href="#l88.230"></a><span id="l88.230" class="difflineminus">-</span>
<a href="#l88.231"></a><span id="l88.231" class="difflineminus">-#\_mailrssiframe {</span>
<a href="#l88.232"></a><span id="l88.232" class="difflineminus">-  width: 100%;</span>
<a href="#l88.233"></a><span id="l88.233" class="difflineminus">-  height: 100%;</span>
<a href="#l88.234"></a><span id="l88.234" class="difflineminus">-}</span>
<a href="#l88.235"></a><span id="l88.235" class="difflineplus">+</span>
<a href="#l88.236"></a><span id="l88.236" class="difflineplus">+.moz-text-flowed blockquote,</span>
<a href="#l88.237"></a><span id="l88.237" class="difflineplus">+.moz-text-plain blockquote {</span>
<a href="#l88.238"></a><span id="l88.238" class="difflineplus">+  margin: 0;</span>
<a href="#l88.239"></a><span id="l88.239" class="difflineplus">+}</span>
<a href="#l88.240"></a><span id="l88.240" class="difflineplus">+</span>
<a href="#l88.241"></a><span id="l88.241" class="difflineplus">+.moz-text-plain pre {</span>
<a href="#l88.242"></a><span id="l88.242" class="difflineplus">+  margin: 0;</span>
<a href="#l88.243"></a><span id="l88.243" class="difflineplus">+  font-family: inherit;</span>
<a href="#l88.244"></a><span id="l88.244" class="difflineplus">+}</span>
<a href="#l88.245"></a><span id="l88.245" class="difflineplus">+</span>
<a href="#l88.246"></a><span id="l88.246" class="difflineplus">+.moz-text-plain[wrap=&quot;true&quot;] {</span>
<a href="#l88.247"></a><span id="l88.247" class="difflineplus">+  white-space: pre-wrap;</span>
<a href="#l88.248"></a><span id="l88.248" class="difflineplus">+}</span>
<a href="#l88.249"></a><span id="l88.249" class="difflineplus">+</span>
<a href="#l88.250"></a><span id="l88.250" class="difflineplus">+.moz-text-plain[wrap=&quot;false&quot;] {</span>
<a href="#l88.251"></a><span id="l88.251" class="difflineplus">+  white-space: pre;</span>
<a href="#l88.252"></a><span id="l88.252" class="difflineplus">+}</span>
<a href="#l88.253"></a><span id="l88.253" class="difflineplus">+</span>
<a href="#l88.254"></a><span id="l88.254" class="difflineplus">+.moz-text-plain[wrap=&quot;flow&quot;] .moz-txt-sig {</span>
<a href="#l88.255"></a><span id="l88.255" class="difflineplus">+  white-space: pre-wrap;</span>
<a href="#l88.256"></a><span id="l88.256" class="difflineplus">+}</span>
<a href="#l88.257"></a><span id="l88.257" class="difflineplus">+</span>
<a href="#l88.258"></a><span id="l88.258" class="difflineplus">+.moz-text-plain[graphical-quote=&quot;false&quot;] blockquote {</span>
<a href="#l88.259"></a><span id="l88.259" class="difflineplus">+  border-style: none;</span>
<a href="#l88.260"></a><span id="l88.260" class="difflineplus">+  padding: 0;</span>
<a href="#l88.261"></a><span id="l88.261" class="difflineplus">+}</span>
<a href="#l88.262"></a><span id="l88.262" class="difflineplus">+</span>
<a href="#l88.263"></a><span id="l88.263" class="difflineplus">+.moz-text-plain[graphical-quote=&quot;true&quot;] .moz-txt-citetags {</span>
<a href="#l88.264"></a><span id="l88.264" class="difflineplus">+  display: none;</span>
<a href="#l88.265"></a><span id="l88.265" class="difflineplus">+}</span>
<a href="#l88.266"></a><span id="l88.266" class="difflineplus">+</span>
<a href="#l88.267"></a><span id="l88.267" class="difflineplus">+span.moz-txt-underscore {</span>
<a href="#l88.268"></a><span id="l88.268" class="difflineplus">+  text-decoration: underline;</span>
<a href="#l88.269"></a><span id="l88.269" class="difflineplus">+}</span>
<a href="#l88.270"></a><span id="l88.270" class="difflineplus">+</span>
<a href="#l88.271"></a><span id="l88.271" class="difflineplus">+span.moz-txt-formfeed {</span>
<a href="#l88.272"></a><span id="l88.272" class="difflineplus">+  display: block;</span>
<a href="#l88.273"></a><span id="l88.273" class="difflineplus">+  height: 100%;</span>
<a href="#l88.274"></a><span id="l88.274" class="difflineplus">+}</span>
<a href="#l88.275"></a><span id="l88.275" class="difflineplus">+</span>
<a href="#l88.276"></a><span id="l88.276" class="difflineplus">+/* ::::: attached images ::::: */</span>
<a href="#l88.277"></a><span id="l88.277" class="difflineplus">+.moz-attached-image[overflowing=&quot;true&quot;] { </span>
<a href="#l88.278"></a><span id="l88.278" class="difflineplus">+  cursor: -moz-zoom-out;</span>
<a href="#l88.279"></a><span id="l88.279" class="difflineplus">+}</span>
<a href="#l88.280"></a><span id="l88.280" class="difflineplus">+</span>
<a href="#l88.281"></a><span id="l88.281" class="difflineplus">+.moz-attached-image[isshrunk=&quot;true&quot;] { </span>
<a href="#l88.282"></a><span id="l88.282" class="difflineplus">+  cursor: -moz-zoom-in;</span>
<a href="#l88.283"></a><span id="l88.283" class="difflineplus">+  max-width: 100%;</span>
<a href="#l88.284"></a><span id="l88.284" class="difflineplus">+}</span>
<a href="#l88.285"></a><span id="l88.285" class="difflineplus">+</span>
<a href="#l88.286"></a><span id="l88.286" class="difflineplus">+</span>
<a href="#l88.287"></a><span id="l88.287" class="difflineplus">+/* ::::: vcard ::::: */</span>
<a href="#l88.288"></a><span id="l88.288" class="difflineplus">+</span>
<a href="#l88.289"></a><span id="l88.289" class="difflineplus">+.moz-vcard-table {</span>
<a href="#l88.290"></a><span id="l88.290" class="difflineplus">+  -moz-border-radius: 8px;</span>
<a href="#l88.291"></a><span id="l88.291" class="difflineplus">+  border: thin solid gray;</span>
<a href="#l88.292"></a><span id="l88.292" class="difflineplus">+  margin-top: 10px;</span>
<a href="#l88.293"></a><span id="l88.293" class="difflineplus">+}</span>
<a href="#l88.294"></a><span id="l88.294" class="difflineplus">+</span>
<a href="#l88.295"></a><span id="l88.295" class="difflineplus">+.moz-vcard-property {</span>
<a href="#l88.296"></a><span id="l88.296" class="difflineplus">+  font-size: 80%;</span>
<a href="#l88.297"></a><span id="l88.297" class="difflineplus">+  color: gray;</span>
<a href="#l88.298"></a><span id="l88.298" class="difflineplus">+}</span>
<a href="#l88.299"></a><span id="l88.299" class="difflineplus">+</span>
<a href="#l88.300"></a><span id="l88.300" class="difflineplus">+.moz-vcard-title-property {</span>
<a href="#l88.301"></a><span id="l88.301" class="difflineplus">+} </span>
<a href="#l88.302"></a><span id="l88.302" class="difflineplus">+</span>
<a href="#l88.303"></a><span id="l88.303" class="difflineplus">+.moz-vcard-badge {</span>
<a href="#l88.304"></a><span id="l88.304" class="difflineplus">+  height: 24px;</span>
<a href="#l88.305"></a><span id="l88.305" class="difflineplus">+  width: 24px;</span>
<a href="#l88.306"></a><span id="l88.306" class="difflineplus">+  background-color: transparent;</span>
<a href="#l88.307"></a><span id="l88.307" class="difflineplus">+  display: block;</span>
<a href="#l88.308"></a><span id="l88.308" class="difflineplus">+  background-image: url(&quot;chrome://messenger/skin/addressbook/icons/abcard-large.png&quot;);</span>
<a href="#l88.309"></a><span id="l88.309" class="difflineplus">+}</span>
<a href="#l88.310"></a><span id="l88.310" class="difflineplus">+</span>
<a href="#l88.311"></a><span id="l88.311" class="difflineplus">+.moz-vcard-badge:hover {</span>
<a href="#l88.312"></a><span id="l88.312" class="difflineplus">+  -moz-image-region: rect(30px 30px 60px 0px);</span>
<a href="#l88.313"></a><span id="l88.313" class="difflineplus">+} </span>
<a href="#l88.314"></a><span id="l88.314" class="difflineplus">+</span>
<a href="#l88.315"></a><span id="l88.315" class="difflineplus">+.moz-vcard-badge:focus {</span>
<a href="#l88.316"></a><span id="l88.316" class="difflineplus">+  outline: none;</span>
<a href="#l88.317"></a><span id="l88.317" class="difflineplus">+}</span>
<a href="#l88.318"></a><span id="l88.318" class="difflineplus">+</span>
<a href="#l88.319"></a><span id="l88.319" class="difflineplus">+/* Style new format rss summary vs web page */</span>
<a href="#l88.320"></a><span id="l88.320" class="difflineplus">+body[selected=&quot;false&quot;],</span>
<a href="#l88.321"></a><span id="l88.321" class="difflineplus">+iframe[selected=&quot;false&quot;] {</span>
<a href="#l88.322"></a><span id="l88.322" class="difflineplus">+  display: none;</span>
<a href="#l88.323"></a><span id="l88.323" class="difflineplus">+}</span>
<a href="#l88.324"></a><span id="l88.324" class="difflineplus">+</span>
<a href="#l88.325"></a><span id="l88.325" class="difflineplus">+#_mailrssiframe {</span>
<a href="#l88.326"></a><span id="l88.326" class="difflineplus">+  position: fixed;</span>
<a href="#l88.327"></a><span id="l88.327" class="difflineplus">+  top: 0;</span>
<a href="#l88.328"></a><span id="l88.328" class="difflineplus">+  left: 0;</span>
<a href="#l88.329"></a><span id="l88.329" class="difflineplus">+  width: 100%;</span>
<a href="#l88.330"></a><span id="l88.330" class="difflineplus">+  height: 100%;</span>
<a href="#l88.331"></a><span id="l88.331" class="difflineplus">+  border: none;</span>
<a href="#l88.332"></a><span id="l88.332" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l89.1"></a><span id="l89.1" class="difflineminus">--- a/mail/themes/gnomestripe/mail/messageHeader.css</span>
<a href="#l89.2"></a><span id="l89.2" class="difflineplus">+++ b/mail/themes/gnomestripe/mail/messageHeader.css</span>
<a href="#l89.3"></a><span id="l89.3" class="difflineat">@@ -46,34 +46,26 @@</span>
<a href="#l89.4"></a><span id="l89.4">   color: WindowText;</span>
<a href="#l89.5"></a><span id="l89.5">   background-color: AppWorkspace;</span>
<a href="#l89.6"></a><span id="l89.6">   border-bottom: 2px groove ThreeDLightShadow;</span>
<a href="#l89.7"></a><span id="l89.7">   padding: 0.4ex;</span>
<a href="#l89.8"></a><span id="l89.8"> }</span>
<a href="#l89.9"></a><span id="l89.9"> </span>
<a href="#l89.10"></a><span id="l89.10"> /* ::::: msg header toolbars ::::: */</span>
<a href="#l89.11"></a><span id="l89.11"> </span>
<a href="#l89.12"></a><span id="l89.12" class="difflineminus">-#collapsedHeaderView {</span>
<a href="#l89.13"></a><span id="l89.13" class="difflineminus">-  min-width: 1px;</span>
<a href="#l89.14"></a><span id="l89.14" class="difflineminus">-}</span>
<a href="#l89.15"></a><span id="l89.15" class="difflineminus">-</span>
<a href="#l89.16"></a><span id="l89.16"> #expandedHeaderView {</span>
<a href="#l89.17"></a><span id="l89.17">   overflow-y: auto;</span>
<a href="#l89.18"></a><span id="l89.18">   overflow-x: hidden;</span>
<a href="#l89.19"></a><span id="l89.19">   max-height: 14em;</span>
<a href="#l89.20"></a><span id="l89.20"> }</span>
<a href="#l89.21"></a><span id="l89.21"> </span>
<a href="#l89.22"></a><span id="l89.22"> #variousHeadersBox{</span>
<a href="#l89.23"></a><span id="l89.23">   padding-bottom: 1em;</span>
<a href="#l89.24"></a><span id="l89.24"> }</span>
<a href="#l89.25"></a><span id="l89.25"> </span>
<a href="#l89.26"></a><span id="l89.26" class="difflineminus">-#collapsedHeaderDisplayName {</span>
<a href="#l89.27"></a><span id="l89.27" class="difflineminus">-  text-align: left;</span>
<a href="#l89.28"></a><span id="l89.28" class="difflineminus">-}</span>
<a href="#l89.29"></a><span id="l89.29" class="difflineminus">-</span>
<a href="#l89.30"></a><span id="l89.30"> /* ::::: msg header buttons ::::: */</span>
<a href="#l89.31"></a><span id="l89.31"> .headerContainer</span>
<a href="#l89.32"></a><span id="l89.32"> {</span>
<a href="#l89.33"></a><span id="l89.33">   min-width: 1px;</span>
<a href="#l89.34"></a><span id="l89.34"> }</span>
<a href="#l89.35"></a><span id="l89.35"> </span>
<a href="#l89.36"></a><span id="l89.36"> #otherActionsButton {</span>
<a href="#l89.37"></a><span id="l89.37">   margin-bottom: .1em;</span>
<a href="#l89.38"></a><span id="l89.38" class="difflineat">@@ -91,38 +83,16 @@</span>
<a href="#l89.39"></a><span id="l89.39">   list-style-image: url(&quot;chrome://messenger/skin/icons/arrow-dn-grey.png&quot;);</span>
<a href="#l89.40"></a><span id="l89.40"> }</span>
<a href="#l89.41"></a><span id="l89.41"> </span>
<a href="#l89.42"></a><span id="l89.42"> .msgHeaderView-flat-button[type=&quot;menu&quot;]:hover &gt; .button-box &gt; .button-menu-dropmarker &gt; .dropmarker-icon,</span>
<a href="#l89.43"></a><span id="l89.43"> .msgHeaderView-flat-button[type=&quot;menu-button&quot;]:hover &gt; .button-menubutton-dropmarker &gt; .dropmarker-icon {</span>
<a href="#l89.44"></a><span id="l89.44">   list-style-image: url(&quot;chrome://messenger/skin/icons/arrow-dn-black.png&quot;);</span>
<a href="#l89.45"></a><span id="l89.45"> }</span>
<a href="#l89.46"></a><span id="l89.46"> </span>
<a href="#l89.47"></a><span id="l89.47" class="difflineminus">-#collapsedsubjectValue {</span>
<a href="#l89.48"></a><span id="l89.48" class="difflineminus">-  -moz-margin-start: 3px !important;</span>
<a href="#l89.49"></a><span id="l89.49" class="difflineminus">-  -moz-box-align: stretch;</span>
<a href="#l89.50"></a><span id="l89.50" class="difflineminus">-  font-weight: bold;</span>
<a href="#l89.51"></a><span id="l89.51" class="difflineminus">-}</span>
<a href="#l89.52"></a><span id="l89.52" class="difflineminus">-</span>
<a href="#l89.53"></a><span id="l89.53" class="difflineminus">-#collapseddateValue {</span>
<a href="#l89.54"></a><span id="l89.54" class="difflineminus">-  -moz-box-align: stretch;</span>
<a href="#l89.55"></a><span id="l89.55" class="difflineminus">-  text-align: right;</span>
<a href="#l89.56"></a><span id="l89.56" class="difflineminus">-  -moz-padding-end: 0.5em !important;</span>
<a href="#l89.57"></a><span id="l89.57" class="difflineminus">-}</span>
<a href="#l89.58"></a><span id="l89.58" class="difflineminus">-</span>
<a href="#l89.59"></a><span id="l89.59" class="difflineminus">-#showDetailsButton {</span>
<a href="#l89.60"></a><span id="l89.60" class="difflineminus">-  -moz-appearance: none !important;</span>
<a href="#l89.61"></a><span id="l89.61" class="difflineminus">-  width: 22px;</span>
<a href="#l89.62"></a><span id="l89.62" class="difflineminus">-  padding-bottom: 0px !important;</span>
<a href="#l89.63"></a><span id="l89.63" class="difflineminus">-  height: 22px;</span>
<a href="#l89.64"></a><span id="l89.64" class="difflineminus">-  background-image: url(&quot;chrome://messenger/skin/icons/chevron.png&quot;);</span>
<a href="#l89.65"></a><span id="l89.65" class="difflineminus">-  background-repeat: no-repeat;</span>
<a href="#l89.66"></a><span id="l89.66" class="difflineminus">-  background-position: center center;</span>
<a href="#l89.67"></a><span id="l89.67" class="difflineminus">-}</span>
<a href="#l89.68"></a><span id="l89.68" class="difflineminus">-</span>
<a href="#l89.69"></a><span id="l89.69"> /* ::::: expanded header pane ::::: */</span>
<a href="#l89.70"></a><span id="l89.70"> </span>
<a href="#l89.71"></a><span id="l89.71"> header-view-button-box {</span>
<a href="#l89.72"></a><span id="l89.72">   padding: 0px;</span>
<a href="#l89.73"></a><span id="l89.73"> }</span>
<a href="#l89.74"></a><span id="l89.74"> </span>
<a href="#l89.75"></a><span id="l89.75"> #expandedfromBox {</span>
<a href="#l89.76"></a><span id="l89.76">   padding-top: 0.5em;</span>
<a href="#l89.77"></a><span id="l89.77" class="difflineat">@@ -380,43 +350,16 @@ description[selectable=&quot;true&quot;]:focus &gt; d</span>
<a href="#l89.78"></a><span id="l89.78"> .headerValueUrl:hover {</span>
<a href="#l89.79"></a><span id="l89.79">   color: red;</span>
<a href="#l89.80"></a><span id="l89.80"> }</span>
<a href="#l89.81"></a><span id="l89.81"> </span>
<a href="#l89.82"></a><span id="l89.82"> .headerField {</span>
<a href="#l89.83"></a><span id="l89.83">   color: inherit;</span>
<a href="#l89.84"></a><span id="l89.84"> }</span>
<a href="#l89.85"></a><span id="l89.85"> </span>
<a href="#l89.86"></a><span id="l89.86" class="difflineminus">-#collapsedsubjectBox {</span>
<a href="#l89.87"></a><span id="l89.87" class="difflineminus">-  margin: 0px;</span>
<a href="#l89.88"></a><span id="l89.88" class="difflineminus">-  padding: 0px;</span>
<a href="#l89.89"></a><span id="l89.89" class="difflineminus">-}</span>
<a href="#l89.90"></a><span id="l89.90" class="difflineminus">-</span>
<a href="#l89.91"></a><span id="l89.91" class="difflineminus">-#collapsedfromBox {</span>
<a href="#l89.92"></a><span id="l89.92" class="difflineminus">-  padding-top: 0.5em;</span>
<a href="#l89.93"></a><span id="l89.93" class="difflineminus">-}</span>
<a href="#l89.94"></a><span id="l89.94" class="difflineminus">-</span>
<a href="#l89.95"></a><span id="l89.95" class="difflineminus">-#collapsedfromValue &gt; .headerNameBox {</span>
<a href="#l89.96"></a><span id="l89.96" class="difflineminus">-  display: none;</span>
<a href="#l89.97"></a><span id="l89.97" class="difflineminus">-}</span>
<a href="#l89.98"></a><span id="l89.98" class="difflineminus">-</span>
<a href="#l89.99"></a><span id="l89.99" class="difflineminus">-#collapsedtoCcBccValue &gt; .headerNameBox {</span>
<a href="#l89.100"></a><span id="l89.100" class="difflineminus">-  display: none;</span>
<a href="#l89.101"></a><span id="l89.101" class="difflineminus">-}</span>
<a href="#l89.102"></a><span id="l89.102" class="difflineminus">-</span>
<a href="#l89.103"></a><span id="l89.103" class="difflineminus">-#collapsedtoCcBccValue &gt; .headerValueBox[singleline] {</span>
<a href="#l89.104"></a><span id="l89.104" class="difflineminus">-  padding-top: 0;</span>
<a href="#l89.105"></a><span id="l89.105" class="difflineminus">-  padding-bottom: 0;</span>
<a href="#l89.106"></a><span id="l89.106" class="difflineminus">-}</span>
<a href="#l89.107"></a><span id="l89.107" class="difflineminus">-</span>
<a href="#l89.108"></a><span id="l89.108" class="difflineminus">-#collapsedtoCcBccValue &gt; .headerValueBox:not([singleline]) {</span>
<a href="#l89.109"></a><span id="l89.109" class="difflineminus">-  padding-top: 0.5em;</span>
<a href="#l89.110"></a><span id="l89.110" class="difflineminus">-  padding-bottom: 0;</span>
<a href="#l89.111"></a><span id="l89.111" class="difflineminus">-}</span>
<a href="#l89.112"></a><span id="l89.112" class="difflineminus">-</span>
<a href="#l89.113"></a><span id="l89.113"> .moreIndicator {</span>
<a href="#l89.114"></a><span id="l89.114">   font-weight: bold;</span>
<a href="#l89.115"></a><span id="l89.115"> }</span>
<a href="#l89.116"></a><span id="l89.116"> </span>
<a href="#l89.117"></a><span id="l89.117"> .moreIndicator:hover {</span>
<a href="#l89.118"></a><span id="l89.118">   text-decoration: underline;</span>
<a href="#l89.119"></a><span id="l89.119">   color: darkred;</span>
<a href="#l89.120"></a><span id="l89.120"> }</span>
<a href="#l89.121"></a><span id="l89.121" class="difflineat">@@ -554,23 +497,19 @@ mail-emailaddress[selected=&quot;true&quot;] .emai</span>
<a href="#l89.122"></a><span id="l89.122"> .addresstwisty[open] {</span>
<a href="#l89.123"></a><span id="l89.123">   list-style-image:url(&quot;chrome://messenger/skin/icons/arrow/arrow-down-dim.png&quot;);</span>
<a href="#l89.124"></a><span id="l89.124"> }</span>
<a href="#l89.125"></a><span id="l89.125"> </span>
<a href="#l89.126"></a><span id="l89.126"> .addresstwisty[open]:hover {</span>
<a href="#l89.127"></a><span id="l89.127">   list-style-image:url(&quot;chrome://messenger/skin/icons/arrow/arrow-down.png&quot;);</span>
<a href="#l89.128"></a><span id="l89.128"> }</span>
<a href="#l89.129"></a><span id="l89.129"> </span>
<a href="#l89.130"></a><span id="l89.130" class="difflineminus">-/* ::::: view expand and collapse twisties  ::::: */</span>
<a href="#l89.131"></a><span id="l89.131" class="difflineplus">+/* ::::: view expand twisty  ::::: */</span>
<a href="#l89.132"></a><span id="l89.132"> </span>
<a href="#l89.133"></a><span id="l89.133"> .expandHeaderViewButton {</span>
<a href="#l89.134"></a><span id="l89.134">   list-style-image: url(&quot;chrome://global/skin/tree/twisty-open.png&quot;);</span>
<a href="#l89.135"></a><span id="l89.135"> }</span>
<a href="#l89.136"></a><span id="l89.136"> </span>
<a href="#l89.137"></a><span id="l89.137" class="difflineminus">-.collapsedHeaderViewButton  {</span>
<a href="#l89.138"></a><span id="l89.138" class="difflineminus">-  list-style-image: url(&quot;chrome://global/skin/tree/twisty-clsd.png&quot;);</span>
<a href="#l89.139"></a><span id="l89.139" class="difflineminus">-}</span>
<a href="#l89.140"></a><span id="l89.140" class="difflineminus">-</span>
<a href="#l89.141"></a><span id="l89.141"> mail-multi-emailHeaderField,</span>
<a href="#l89.142"></a><span id="l89.142"> mail-headerfield {</span>
<a href="#l89.143"></a><span id="l89.143">   margin: 0;</span>
<a href="#l89.144"></a><span id="l89.144">   padding: 0;</span>
<a href="#l89.145"></a><span id="l89.145"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l90.1"></a><span id="l90.1" class="difflineminus">--- a/mail/themes/gnomestripe/mail/messenger.css</span>
<a href="#l90.2"></a><span id="l90.2" class="difflineplus">+++ b/mail/themes/gnomestripe/mail/messenger.css</span>
<a href="#l90.3"></a><span id="l90.3" class="difflineat">@@ -14,16 +14,28 @@ description.error {</span>
<a href="#l90.4"></a><span id="l90.4"> .toolbar-primary {</span>
<a href="#l90.5"></a><span id="l90.5">   -moz-binding: url(&quot;chrome://global/content/bindings/toolbar.xml#toolbar&quot;);</span>
<a href="#l90.6"></a><span id="l90.6"> }</span>
<a href="#l90.7"></a><span id="l90.7"> </span>
<a href="#l90.8"></a><span id="l90.8"> toolbar[printpreview=&quot;true&quot;] {</span>
<a href="#l90.9"></a><span id="l90.9">   -moz-binding: url(&quot;chrome://global/content/printPreviewBindings.xml#printpreviewtoolbar&quot;);</span>
<a href="#l90.10"></a><span id="l90.10"> }</span>
<a href="#l90.11"></a><span id="l90.11"> </span>
<a href="#l90.12"></a><span id="l90.12" class="difflineplus">+/*</span>
<a href="#l90.13"></a><span id="l90.13" class="difflineplus">+ * Override the menulist icon forbidding in menu.css so that we can show</span>
<a href="#l90.14"></a><span id="l90.14" class="difflineplus">+ * check-marks. bug 443516</span>
<a href="#l90.15"></a><span id="l90.15" class="difflineplus">+ */</span>
<a href="#l90.16"></a><span id="l90.16" class="difflineplus">+.menulist-menupopup &gt; menuitem &gt; .menu-iconic-left,</span>
<a href="#l90.17"></a><span id="l90.17" class="difflineplus">+menulist &gt; menupopup &gt; menuitem &gt; .menu-iconic-left,</span>
<a href="#l90.18"></a><span id="l90.18" class="difflineplus">+.menulist-menupopup &gt; menu &gt; .menu-iconic-left,</span>
<a href="#l90.19"></a><span id="l90.19" class="difflineplus">+menulist &gt; menupopup &gt; menu &gt; .menu-iconic-left {</span>
<a href="#l90.20"></a><span id="l90.20" class="difflineplus">+  display: -moz-box;</span>
<a href="#l90.21"></a><span id="l90.21" class="difflineplus">+}</span>
<a href="#l90.22"></a><span id="l90.22" class="difflineplus">+</span>
<a href="#l90.23"></a><span id="l90.23" class="difflineplus">+</span>
<a href="#l90.24"></a><span id="l90.24"> /* ::::: throbber ::::: */</span>
<a href="#l90.25"></a><span id="l90.25"> </span>
<a href="#l90.26"></a><span id="l90.26"> #navigator-throbber {</span>
<a href="#l90.27"></a><span id="l90.27">   -moz-appearance: none;</span>
<a href="#l90.28"></a><span id="l90.28">   -moz-user-focus: ignore;</span>
<a href="#l90.29"></a><span id="l90.29">   margin: 0 !important;</span>
<a href="#l90.30"></a><span id="l90.30">   border: none !important;</span>
<a href="#l90.31"></a><span id="l90.31">   padding: 0px !important;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l91.1"></a><span id="l91.1" class="difflineminus">--- a/mail/themes/gnomestripe/mail/tabmail.css</span>
<a href="#l91.2"></a><span id="l91.2" class="difflineplus">+++ b/mail/themes/gnomestripe/mail/tabmail.css</span>
<a href="#l91.3"></a><span id="l91.3" class="difflineat">@@ -70,16 +70,20 @@</span>
<a href="#l91.4"></a><span id="l91.4">   padding-top: 1px;</span>
<a href="#l91.5"></a><span id="l91.5">   -moz-padding-start: 1px;</span>
<a href="#l91.6"></a><span id="l91.6"> }</span>
<a href="#l91.7"></a><span id="l91.7"> </span>
<a href="#l91.8"></a><span id="l91.8"> .tabmail-tab[busy] &gt; .tab-image-middle &gt; .tab-icon &gt; .tab-icon-image {</span>
<a href="#l91.9"></a><span id="l91.9">   list-style-image: url(&quot;chrome://global/skin/icons/loading_16.png&quot;) !important;</span>
<a href="#l91.10"></a><span id="l91.10"> }</span>
<a href="#l91.11"></a><span id="l91.11"> </span>
<a href="#l91.12"></a><span id="l91.12" class="difflineplus">+.tabmail-tab[thinking] &gt; .tab-image-middle &gt; .tab-icon &gt; .tab-icon-image {</span>
<a href="#l91.13"></a><span id="l91.13" class="difflineplus">+  list-style-image: url(&quot;chrome://global/skin/icons/loading_16.png&quot;) !important;</span>
<a href="#l91.14"></a><span id="l91.14" class="difflineplus">+}</span>
<a href="#l91.15"></a><span id="l91.15" class="difflineplus">+</span>
<a href="#l91.16"></a><span id="l91.16"> .tabmail-tab[selected=&quot;true&quot;] {</span>
<a href="#l91.17"></a><span id="l91.17">   font-weight: bold;</span>
<a href="#l91.18"></a><span id="l91.18"> }</span>
<a href="#l91.19"></a><span id="l91.19"> </span>
<a href="#l91.20"></a><span id="l91.20"> .tabmail-tab[selected=&quot;true&quot;] &gt; .tab-image-middle &gt; .tab-text {</span>
<a href="#l91.21"></a><span id="l91.21">   opacity: 1.0 !important;</span>
<a href="#l91.22"></a><span id="l91.22"> }</span>
<a href="#l91.23"></a><span id="l91.23"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l92.1"></a><span id="l92.1">deleted file mode 100644</span>
<a href="#l92.2"></a><span id="l92.2" class="difflineminus">--- a/mail/themes/gnomestripe/mail/tree.css</span>
<a href="#l92.3"></a><span id="l92.3" class="difflineplus">+++ /dev/null</span>
<a href="#l92.4"></a><span id="l92.4" class="difflineat">@@ -1,347 +0,0 @@</span>
<a href="#l92.5"></a><span id="l92.5" class="difflineminus">-/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l92.6"></a><span id="l92.6" class="difflineminus">- * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l92.7"></a><span id="l92.7" class="difflineminus">- *</span>
<a href="#l92.8"></a><span id="l92.8" class="difflineminus">- * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l92.9"></a><span id="l92.9" class="difflineminus">- * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l92.10"></a><span id="l92.10" class="difflineminus">- * the License. You may obtain a copy of the License at</span>
<a href="#l92.11"></a><span id="l92.11" class="difflineminus">- * http://www.mozilla.org/MPL/</span>
<a href="#l92.12"></a><span id="l92.12" class="difflineminus">- *</span>
<a href="#l92.13"></a><span id="l92.13" class="difflineminus">- * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l92.14"></a><span id="l92.14" class="difflineminus">- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l92.15"></a><span id="l92.15" class="difflineminus">- * for the specific language governing rights and limitations under the</span>
<a href="#l92.16"></a><span id="l92.16" class="difflineminus">- * License.</span>
<a href="#l92.17"></a><span id="l92.17" class="difflineminus">- *</span>
<a href="#l92.18"></a><span id="l92.18" class="difflineminus">- * The Original Code is Mozilla Communicator client code, released</span>
<a href="#l92.19"></a><span id="l92.19" class="difflineminus">- * March 31, 1998.</span>
<a href="#l92.20"></a><span id="l92.20" class="difflineminus">- *</span>
<a href="#l92.21"></a><span id="l92.21" class="difflineminus">- * The Initial Developer of the Original Code is</span>
<a href="#l92.22"></a><span id="l92.22" class="difflineminus">- * Netscape Communications Corporation.</span>
<a href="#l92.23"></a><span id="l92.23" class="difflineminus">- * Portions created by the Initial Developer are Copyright (C) 1998-2001</span>
<a href="#l92.24"></a><span id="l92.24" class="difflineminus">- * the Initial Developer. All Rights Reserved.</span>
<a href="#l92.25"></a><span id="l92.25" class="difflineminus">- *</span>
<a href="#l92.26"></a><span id="l92.26" class="difflineminus">- * Contributor(s):</span>
<a href="#l92.27"></a><span id="l92.27" class="difflineminus">- *   Joe Hewitt (hewitt@netscape.com)</span>
<a href="#l92.28"></a><span id="l92.28" class="difflineminus">- *   Dean Tessman (dean_tessman@hotmail.com)</span>
<a href="#l92.29"></a><span id="l92.29" class="difflineminus">- *</span>
<a href="#l92.30"></a><span id="l92.30" class="difflineminus">- * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l92.31"></a><span id="l92.31" class="difflineminus">- * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l92.32"></a><span id="l92.32" class="difflineminus">- * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l92.33"></a><span id="l92.33" class="difflineminus">- * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l92.34"></a><span id="l92.34" class="difflineminus">- * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l92.35"></a><span id="l92.35" class="difflineminus">- * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l92.36"></a><span id="l92.36" class="difflineminus">- * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l92.37"></a><span id="l92.37" class="difflineminus">- * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l92.38"></a><span id="l92.38" class="difflineminus">- * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l92.39"></a><span id="l92.39" class="difflineminus">- * the provisions above, a recipient may use your version of this file under</span>
<a href="#l92.40"></a><span id="l92.40" class="difflineminus">- * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l92.41"></a><span id="l92.41" class="difflineminus">- *</span>
<a href="#l92.42"></a><span id="l92.42" class="difflineminus">- * ***** END LICENSE BLOCK ***** */</span>
<a href="#l92.43"></a><span id="l92.43" class="difflineminus">-</span>
<a href="#l92.44"></a><span id="l92.44" class="difflineminus">-/* ===== tree.css ===================================================</span>
<a href="#l92.45"></a><span id="l92.45" class="difflineminus">-  == Styles used by the XUL outline element.</span>
<a href="#l92.46"></a><span id="l92.46" class="difflineminus">-  ======================================================================= */</span>
<a href="#l92.47"></a><span id="l92.47" class="difflineminus">-</span>
<a href="#l92.48"></a><span id="l92.48" class="difflineminus">-@namespace url(&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;);</span>
<a href="#l92.49"></a><span id="l92.49" class="difflineminus">-</span>
<a href="#l92.50"></a><span id="l92.50" class="difflineminus">-/* ::::: tree ::::: */</span>
<a href="#l92.51"></a><span id="l92.51" class="difflineminus">-</span>
<a href="#l92.52"></a><span id="l92.52" class="difflineminus">-tree {</span>
<a href="#l92.53"></a><span id="l92.53" class="difflineminus">-  margin: 0px 4px;</span>
<a href="#l92.54"></a><span id="l92.54" class="difflineminus">-  border: 2px solid;</span>
<a href="#l92.55"></a><span id="l92.55" class="difflineminus">-  -moz-border-top-colors: ThreeDShadow ThreeDDarkShadow;</span>
<a href="#l92.56"></a><span id="l92.56" class="difflineminus">-  -moz-border-right-colors: ThreeDHighlight ThreeDLightShadow;</span>
<a href="#l92.57"></a><span id="l92.57" class="difflineminus">-  -moz-border-bottom-colors: ThreeDHighlight ThreeDLightShadow;</span>
<a href="#l92.58"></a><span id="l92.58" class="difflineminus">-  -moz-border-left-colors: ThreeDShadow ThreeDDarkShadow;</span>
<a href="#l92.59"></a><span id="l92.59" class="difflineminus">-  background-color: -moz-Field;</span>
<a href="#l92.60"></a><span id="l92.60" class="difflineminus">-  color: -moz-FieldText;</span>
<a href="#l92.61"></a><span id="l92.61" class="difflineminus">-  -moz-appearance: listbox;</span>
<a href="#l92.62"></a><span id="l92.62" class="difflineminus">-}</span>
<a href="#l92.63"></a><span id="l92.63" class="difflineminus">-</span>
<a href="#l92.64"></a><span id="l92.64" class="difflineminus">-/* ::::: tree rows ::::: */</span>
<a href="#l92.65"></a><span id="l92.65" class="difflineminus">-</span>
<a href="#l92.66"></a><span id="l92.66" class="difflineminus">-treechildren::-moz-tree-row {</span>
<a href="#l92.67"></a><span id="l92.67" class="difflineminus">-  border: 1px solid transparent;</span>
<a href="#l92.68"></a><span id="l92.68" class="difflineminus">-  background-color: transparent;</span>
<a href="#l92.69"></a><span id="l92.69" class="difflineminus">-  min-height: 18px;</span>
<a href="#l92.70"></a><span id="l92.70" class="difflineminus">-  height: 1.3em;</span>
<a href="#l92.71"></a><span id="l92.71" class="difflineminus">-}</span>
<a href="#l92.72"></a><span id="l92.72" class="difflineminus">-</span>
<a href="#l92.73"></a><span id="l92.73" class="difflineminus">-treechildren::-moz-tree-row(selected) {</span>
<a href="#l92.74"></a><span id="l92.74" class="difflineminus">-  background-color: -moz-Dialog;</span>
<a href="#l92.75"></a><span id="l92.75" class="difflineminus">-}</span>
<a href="#l92.76"></a><span id="l92.76" class="difflineminus">-</span>
<a href="#l92.77"></a><span id="l92.77" class="difflineminus">-treechildren::-moz-tree-row(selected, focus) {</span>
<a href="#l92.78"></a><span id="l92.78" class="difflineminus">-  background-color: Highlight;</span>
<a href="#l92.79"></a><span id="l92.79" class="difflineminus">-}</span>
<a href="#l92.80"></a><span id="l92.80" class="difflineminus">-</span>
<a href="#l92.81"></a><span id="l92.81" class="difflineminus">-treechildren::-moz-tree-row(current, focus) {</span>
<a href="#l92.82"></a><span id="l92.82" class="difflineminus">-  border: 1px dotted #000000;</span>
<a href="#l92.83"></a><span id="l92.83" class="difflineminus">-}</span>
<a href="#l92.84"></a><span id="l92.84" class="difflineminus">-</span>
<a href="#l92.85"></a><span id="l92.85" class="difflineminus">-treechildren::-moz-tree-row(selected, current, focus) {</span>
<a href="#l92.86"></a><span id="l92.86" class="difflineminus">-  border: 1px dotted #C0C0C0;</span>
<a href="#l92.87"></a><span id="l92.87" class="difflineminus">-}</span>
<a href="#l92.88"></a><span id="l92.88" class="difflineminus">-</span>
<a href="#l92.89"></a><span id="l92.89" class="difflineminus">-tree[seltype=&quot;cell&quot;] &gt; treechildren::-moz-tree-row,</span>
<a href="#l92.90"></a><span id="l92.90" class="difflineminus">-tree[seltype=&quot;text&quot;] &gt; treechildren::-moz-tree-row {</span>
<a href="#l92.91"></a><span id="l92.91" class="difflineminus">-  border: none;</span>
<a href="#l92.92"></a><span id="l92.92" class="difflineminus">-  background-color: transparent;</span>
<a href="#l92.93"></a><span id="l92.93" class="difflineminus">-}</span>
<a href="#l92.94"></a><span id="l92.94" class="difflineminus">-</span>
<a href="#l92.95"></a><span id="l92.95" class="difflineminus">-/* ::::: tree cells ::::: */</span>
<a href="#l92.96"></a><span id="l92.96" class="difflineminus">-</span>
<a href="#l92.97"></a><span id="l92.97" class="difflineminus">-treechildren::-moz-tree-cell {</span>
<a href="#l92.98"></a><span id="l92.98" class="difflineminus">-  padding: 0px 2px;</span>
<a href="#l92.99"></a><span id="l92.99" class="difflineminus">-}</span>
<a href="#l92.100"></a><span id="l92.100" class="difflineminus">-</span>
<a href="#l92.101"></a><span id="l92.101" class="difflineminus">-tree[seltype=&quot;cell&quot;] &gt; treechildren::-moz-tree-cell-text,</span>
<a href="#l92.102"></a><span id="l92.102" class="difflineminus">-tree[seltype=&quot;text&quot;] &gt; treechildren::-moz-tree-cell-text,</span>
<a href="#l92.103"></a><span id="l92.103" class="difflineminus">-treechildren::-moz-tree-cell-text {</span>
<a href="#l92.104"></a><span id="l92.104" class="difflineminus">-  color: inherit;</span>
<a href="#l92.105"></a><span id="l92.105" class="difflineminus">-}</span>
<a href="#l92.106"></a><span id="l92.106" class="difflineminus">-</span>
<a href="#l92.107"></a><span id="l92.107" class="difflineminus">-treechildren::-moz-tree-cell-text(selected) {</span>
<a href="#l92.108"></a><span id="l92.108" class="difflineminus">-  color: -moz-DialogText;</span>
<a href="#l92.109"></a><span id="l92.109" class="difflineminus">-}</span>
<a href="#l92.110"></a><span id="l92.110" class="difflineminus">-</span>
<a href="#l92.111"></a><span id="l92.111" class="difflineminus">-tree[seltype=&quot;cell&quot;] &gt; treechildren::-moz-tree-cell {</span>
<a href="#l92.112"></a><span id="l92.112" class="difflineminus">-  border: 1px solid transparent;</span>
<a href="#l92.113"></a><span id="l92.113" class="difflineminus">-  padding: 0px 1px;</span>
<a href="#l92.114"></a><span id="l92.114" class="difflineminus">-}</span>
<a href="#l92.115"></a><span id="l92.115" class="difflineminus">-</span>
<a href="#l92.116"></a><span id="l92.116" class="difflineminus">-tree[seltype=&quot;text&quot;] &gt; treechildren::-moz-tree-cell-text {</span>
<a href="#l92.117"></a><span id="l92.117" class="difflineminus">-  border: 1px solid transparent;</span>
<a href="#l92.118"></a><span id="l92.118" class="difflineminus">-  padding: 0px 1px 1px;</span>
<a href="#l92.119"></a><span id="l92.119" class="difflineminus">-}</span>
<a href="#l92.120"></a><span id="l92.120" class="difflineminus">-</span>
<a href="#l92.121"></a><span id="l92.121" class="difflineminus">-tree[seltype=&quot;cell&quot;] &gt; treechildren::-moz-tree-cell(active, selected) {</span>
<a href="#l92.122"></a><span id="l92.122" class="difflineminus">-  background-color: -moz-Dialog;</span>
<a href="#l92.123"></a><span id="l92.123" class="difflineminus">-}</span>
<a href="#l92.124"></a><span id="l92.124" class="difflineminus">-tree[seltype=&quot;cell&quot;] &gt; treechildren::-moz-tree-cell-text(active, selected) {</span>
<a href="#l92.125"></a><span id="l92.125" class="difflineminus">-  color: -moz-DialogText;</span>
<a href="#l92.126"></a><span id="l92.126" class="difflineminus">-}</span>
<a href="#l92.127"></a><span id="l92.127" class="difflineminus">-</span>
<a href="#l92.128"></a><span id="l92.128" class="difflineminus">-tree[seltype=&quot;text&quot;] &gt; treechildren::-moz-tree-cell-text(active, selected) {</span>
<a href="#l92.129"></a><span id="l92.129" class="difflineminus">-  background-color: -moz-Dialog;</span>
<a href="#l92.130"></a><span id="l92.130" class="difflineminus">-  color: -moz-DialogText;</span>
<a href="#l92.131"></a><span id="l92.131" class="difflineminus">-}</span>
<a href="#l92.132"></a><span id="l92.132" class="difflineminus">-</span>
<a href="#l92.133"></a><span id="l92.133" class="difflineminus">-treechildren::-moz-tree-cell-text(selected, focus) {</span>
<a href="#l92.134"></a><span id="l92.134" class="difflineminus">-  color: HighlightText;</span>
<a href="#l92.135"></a><span id="l92.135" class="difflineminus">-}</span>
<a href="#l92.136"></a><span id="l92.136" class="difflineminus">-</span>
<a href="#l92.137"></a><span id="l92.137" class="difflineminus">-tree[seltype=&quot;cell&quot;] &gt; treechildren::-moz-tree-cell(active, selected, focus) {</span>
<a href="#l92.138"></a><span id="l92.138" class="difflineminus">-  background-color: Highlight;</span>
<a href="#l92.139"></a><span id="l92.139" class="difflineminus">-}</span>
<a href="#l92.140"></a><span id="l92.140" class="difflineminus">-tree[seltype=&quot;cell&quot;] &gt; treechildren::-moz-tree-cell-text(active, selected, focus) {</span>
<a href="#l92.141"></a><span id="l92.141" class="difflineminus">-  color: HighlightText;</span>
<a href="#l92.142"></a><span id="l92.142" class="difflineminus">-}</span>
<a href="#l92.143"></a><span id="l92.143" class="difflineminus">-</span>
<a href="#l92.144"></a><span id="l92.144" class="difflineminus">-tree[seltype=&quot;text&quot;] &gt; treechildren::-moz-tree-cell-text(active, selected, focus) {</span>
<a href="#l92.145"></a><span id="l92.145" class="difflineminus">-  background-color: Highlight;</span>
<a href="#l92.146"></a><span id="l92.146" class="difflineminus">-  color: HighlightText;</span>
<a href="#l92.147"></a><span id="l92.147" class="difflineminus">-}</span>
<a href="#l92.148"></a><span id="l92.148" class="difflineminus">-</span>
<a href="#l92.149"></a><span id="l92.149" class="difflineminus">-tree[seltype=&quot;cell&quot;] &gt; treechildren::-moz-tree-cell(active, current, focus) {</span>
<a href="#l92.150"></a><span id="l92.150" class="difflineminus">-  border: 1px dotted #000000;</span>
<a href="#l92.151"></a><span id="l92.151" class="difflineminus">-}</span>
<a href="#l92.152"></a><span id="l92.152" class="difflineminus">-</span>
<a href="#l92.153"></a><span id="l92.153" class="difflineminus">-tree[seltype=&quot;text&quot;] &gt; treechildren::-moz-tree-cell-text(active, current, focus) {</span>
<a href="#l92.154"></a><span id="l92.154" class="difflineminus">-  border: 1px dotted #000000;</span>
<a href="#l92.155"></a><span id="l92.155" class="difflineminus">-}</span>
<a href="#l92.156"></a><span id="l92.156" class="difflineminus">-</span>
<a href="#l92.157"></a><span id="l92.157" class="difflineminus">-tree[seltype=&quot;cell&quot;] &gt; treechildren::-moz-tree-cell(active, selected, current, focus) {</span>
<a href="#l92.158"></a><span id="l92.158" class="difflineminus">-  border: 1px dotted #C0C0C0;</span>
<a href="#l92.159"></a><span id="l92.159" class="difflineminus">-}</span>
<a href="#l92.160"></a><span id="l92.160" class="difflineminus">-</span>
<a href="#l92.161"></a><span id="l92.161" class="difflineminus">-tree[seltype=&quot;text&quot;] &gt; treechildren::-moz-tree-cell-text(active, selected, current, focus) {</span>
<a href="#l92.162"></a><span id="l92.162" class="difflineminus">-  border: 1px dotted #C0C0C0;</span>
<a href="#l92.163"></a><span id="l92.163" class="difflineminus">-}</span>
<a href="#l92.164"></a><span id="l92.164" class="difflineminus">-</span>
<a href="#l92.165"></a><span id="l92.165" class="difflineminus">-</span>
<a href="#l92.166"></a><span id="l92.166" class="difflineminus">-/* ::::: lines connecting cells ::::: */</span>
<a href="#l92.167"></a><span id="l92.167" class="difflineminus">-</span>
<a href="#l92.168"></a><span id="l92.168" class="difflineminus">-tree[seltype=&quot;cell&quot;] &gt; treechildren::-moz-tree-line,</span>
<a href="#l92.169"></a><span id="l92.169" class="difflineminus">-tree[seltype=&quot;text&quot;] &gt; treechildren::-moz-tree-line,</span>
<a href="#l92.170"></a><span id="l92.170" class="difflineminus">-treechildren::-moz-tree-line {</span>
<a href="#l92.171"></a><span id="l92.171" class="difflineminus">-  border: 1px dotted ThreeDShadow;</span>
<a href="#l92.172"></a><span id="l92.172" class="difflineminus">-}</span>
<a href="#l92.173"></a><span id="l92.173" class="difflineminus">-</span>
<a href="#l92.174"></a><span id="l92.174" class="difflineminus">-tree[seltype=&quot;cell&quot;] &gt; treechildren::-moz-tree-line(active, selected, focus),</span>
<a href="#l92.175"></a><span id="l92.175" class="difflineminus">-treechildren::-moz-tree-line(selected, focus) {</span>
<a href="#l92.176"></a><span id="l92.176" class="difflineminus">-  border: 1px dotted HighlightText;</span>
<a href="#l92.177"></a><span id="l92.177" class="difflineminus">-}</span>
<a href="#l92.178"></a><span id="l92.178" class="difflineminus">-</span>
<a href="#l92.179"></a><span id="l92.179" class="difflineminus">-</span>
<a href="#l92.180"></a><span id="l92.180" class="difflineminus">-/* ::::: tree separator ::::: */</span>
<a href="#l92.181"></a><span id="l92.181" class="difflineminus">-</span>
<a href="#l92.182"></a><span id="l92.182" class="difflineminus">-treechildren::-moz-tree-separator {</span>
<a href="#l92.183"></a><span id="l92.183" class="difflineminus">-  border-top: 1px solid ThreeDShadow;</span>
<a href="#l92.184"></a><span id="l92.184" class="difflineminus">-  border-bottom: 1px solid ThreeDHighlight;</span>
<a href="#l92.185"></a><span id="l92.185" class="difflineminus">-}</span>
<a href="#l92.186"></a><span id="l92.186" class="difflineminus">-</span>
<a href="#l92.187"></a><span id="l92.187" class="difflineminus">-</span>
<a href="#l92.188"></a><span id="l92.188" class="difflineminus">-/* ::::: drop feedback ::::: */</span>
<a href="#l92.189"></a><span id="l92.189" class="difflineminus">-</span>
<a href="#l92.190"></a><span id="l92.190" class="difflineminus">-tree[seltype=&quot;cell&quot;] &gt; treechildren::-moz-tree-cell-text(primary, dropOn),</span>
<a href="#l92.191"></a><span id="l92.191" class="difflineminus">-tree[seltype=&quot;text&quot;] &gt; treechildren::-moz-tree-cell-text(primary, dropOn),</span>
<a href="#l92.192"></a><span id="l92.192" class="difflineminus">-treechildren::-moz-tree-cell-text(primary, dropOn) {</span>
<a href="#l92.193"></a><span id="l92.193" class="difflineminus">-  background-color: Highlight;</span>
<a href="#l92.194"></a><span id="l92.194" class="difflineminus">-  color: HighlightText;</span>
<a href="#l92.195"></a><span id="l92.195" class="difflineminus">-}</span>
<a href="#l92.196"></a><span id="l92.196" class="difflineminus">-</span>
<a href="#l92.197"></a><span id="l92.197" class="difflineminus">-treechildren::-moz-tree-drop-feedback {</span>
<a href="#l92.198"></a><span id="l92.198" class="difflineminus">-  background-color: Highlight;</span>
<a href="#l92.199"></a><span id="l92.199" class="difflineminus">-  width: 50px;</span>
<a href="#l92.200"></a><span id="l92.200" class="difflineminus">-  height: 2px;</span>
<a href="#l92.201"></a><span id="l92.201" class="difflineminus">-  -moz-margin-start: 5px;</span>
<a href="#l92.202"></a><span id="l92.202" class="difflineminus">-}</span>
<a href="#l92.203"></a><span id="l92.203" class="difflineminus">-</span>
<a href="#l92.204"></a><span id="l92.204" class="difflineminus">-/* ::::: tree progress meter ::::: */</span>
<a href="#l92.205"></a><span id="l92.205" class="difflineminus">-</span>
<a href="#l92.206"></a><span id="l92.206" class="difflineminus">-treechildren::-moz-tree-progressmeter {</span>
<a href="#l92.207"></a><span id="l92.207" class="difflineminus">-  margin: 2px 4px;</span>
<a href="#l92.208"></a><span id="l92.208" class="difflineminus">-  border: 2px solid;</span>
<a href="#l92.209"></a><span id="l92.209" class="difflineminus">-  -moz-border-top-colors: ThreeDShadow -moz-Dialog;</span>
<a href="#l92.210"></a><span id="l92.210" class="difflineminus">-  -moz-border-right-colors: ThreeDHighlight -moz-Dialog;</span>
<a href="#l92.211"></a><span id="l92.211" class="difflineminus">-  -moz-border-bottom-colors: ThreeDHighlight -moz-Dialog;</span>
<a href="#l92.212"></a><span id="l92.212" class="difflineminus">-  -moz-border-left-colors: ThreeDShadow -moz-Dialog;</span>
<a href="#l92.213"></a><span id="l92.213" class="difflineminus">-  background-color: -moz-Dialog;</span>
<a href="#l92.214"></a><span id="l92.214" class="difflineminus">-  color: ThreeDShadow;</span>
<a href="#l92.215"></a><span id="l92.215" class="difflineminus">-}</span>
<a href="#l92.216"></a><span id="l92.216" class="difflineminus">-</span>
<a href="#l92.217"></a><span id="l92.217" class="difflineminus">-treechildren::-moz-tree-progressmeter(progressUndetermined) {</span>
<a href="#l92.218"></a><span id="l92.218" class="difflineminus">-  list-style-image: url(&quot;chrome://global/skin/progressmeter/progressmeter-busy.gif&quot;);</span>
<a href="#l92.219"></a><span id="l92.219" class="difflineminus">-}</span>
<a href="#l92.220"></a><span id="l92.220" class="difflineminus">-</span>
<a href="#l92.221"></a><span id="l92.221" class="difflineminus">-treechildren::-moz-tree-cell-text(progressmeter) {</span>
<a href="#l92.222"></a><span id="l92.222" class="difflineminus">-  margin: 2px 4px;</span>
<a href="#l92.223"></a><span id="l92.223" class="difflineminus">-}</span>
<a href="#l92.224"></a><span id="l92.224" class="difflineminus">-</span>
<a href="#l92.225"></a><span id="l92.225" class="difflineminus">-/* ::::: tree columns ::::: */</span>
<a href="#l92.226"></a><span id="l92.226" class="difflineminus">-</span>
<a href="#l92.227"></a><span id="l92.227" class="difflineminus">-treecol,</span>
<a href="#l92.228"></a><span id="l92.228" class="difflineminus">-treecolpicker { </span>
<a href="#l92.229"></a><span id="l92.229" class="difflineminus">-  -moz-appearance: treeheadercell;</span>
<a href="#l92.230"></a><span id="l92.230" class="difflineminus">-  -moz-box-align: center;</span>
<a href="#l92.231"></a><span id="l92.231" class="difflineminus">-  -moz-box-pack: center;</span>
<a href="#l92.232"></a><span id="l92.232" class="difflineminus">-  border: 2px solid;</span>
<a href="#l92.233"></a><span id="l92.233" class="difflineminus">-  -moz-border-top-colors: ThreeDHighlight ThreeDLightShadow;</span>
<a href="#l92.234"></a><span id="l92.234" class="difflineminus">-  -moz-border-right-colors: ThreeDDarkShadow ThreeDShadow;</span>
<a href="#l92.235"></a><span id="l92.235" class="difflineminus">-  -moz-border-bottom-colors: ThreeDDarkShadow ThreeDShadow;</span>
<a href="#l92.236"></a><span id="l92.236" class="difflineminus">-  -moz-border-left-colors: ThreeDHighlight ThreeDLightShadow;</span>
<a href="#l92.237"></a><span id="l92.237" class="difflineminus">-  background-color: -moz-Dialog;</span>
<a href="#l92.238"></a><span id="l92.238" class="difflineminus">-  color: -moz-DialogText;</span>
<a href="#l92.239"></a><span id="l92.239" class="difflineminus">-  padding-top: 1px;</span>
<a href="#l92.240"></a><span id="l92.240" class="difflineminus">-  padding-bottom: 0px;</span>
<a href="#l92.241"></a><span id="l92.241" class="difflineminus">-  -moz-padding-start: 5px;</span>
<a href="#l92.242"></a><span id="l92.242" class="difflineminus">-  -moz-padding-end: 4px;</span>
<a href="#l92.243"></a><span id="l92.243" class="difflineminus">-}</span>
<a href="#l92.244"></a><span id="l92.244" class="difflineminus">-</span>
<a href="#l92.245"></a><span id="l92.245" class="difflineminus">-.treecol-image {</span>
<a href="#l92.246"></a><span id="l92.246" class="difflineminus">-  padding-top: 1px;</span>
<a href="#l92.247"></a><span id="l92.247" class="difflineminus">-  padding-bottom: 0px;</span>
<a href="#l92.248"></a><span id="l92.248" class="difflineminus">-  -moz-padding-start: 2px;</span>
<a href="#l92.249"></a><span id="l92.249" class="difflineminus">-  -moz-padding-end: 1px;</span>
<a href="#l92.250"></a><span id="l92.250" class="difflineminus">-}</span>
<a href="#l92.251"></a><span id="l92.251" class="difflineminus">-</span>
<a href="#l92.252"></a><span id="l92.252" class="difflineminus">-.treecol-text {</span>
<a href="#l92.253"></a><span id="l92.253" class="difflineminus">-  margin: 0px !important;</span>
<a href="#l92.254"></a><span id="l92.254" class="difflineminus">-}</span>
<a href="#l92.255"></a><span id="l92.255" class="difflineminus">-</span>
<a href="#l92.256"></a><span id="l92.256" class="difflineminus">-treecol[hideheader=&quot;true&quot;] {</span>
<a href="#l92.257"></a><span id="l92.257" class="difflineminus">-  -moz-appearance: none;</span>
<a href="#l92.258"></a><span id="l92.258" class="difflineminus">-  border: none;</span>
<a href="#l92.259"></a><span id="l92.259" class="difflineminus">-  padding: 0;</span>
<a href="#l92.260"></a><span id="l92.260" class="difflineminus">-}</span>
<a href="#l92.261"></a><span id="l92.261" class="difflineminus">-</span>
<a href="#l92.262"></a><span id="l92.262" class="difflineminus">-/* ..... internal box ..... */</span>
<a href="#l92.263"></a><span id="l92.263" class="difflineminus">-</span>
<a href="#l92.264"></a><span id="l92.264" class="difflineminus">-treecol:hover:active,</span>
<a href="#l92.265"></a><span id="l92.265" class="difflineminus">-treecolpicker:hover:active {</span>
<a href="#l92.266"></a><span id="l92.266" class="difflineminus">-  border-top: 2px solid;</span>
<a href="#l92.267"></a><span id="l92.267" class="difflineminus">-  border-right: 1px solid;</span>
<a href="#l92.268"></a><span id="l92.268" class="difflineminus">-  border-bottom: 1px solid;</span>
<a href="#l92.269"></a><span id="l92.269" class="difflineminus">-  border-left: 2px solid;</span>
<a href="#l92.270"></a><span id="l92.270" class="difflineminus">-  -moz-border-top-colors: ThreeDShadow -moz-Dialog;</span>
<a href="#l92.271"></a><span id="l92.271" class="difflineminus">-  -moz-border-right-colors: ThreeDShadow;</span>
<a href="#l92.272"></a><span id="l92.272" class="difflineminus">-  -moz-border-bottom-colors: ThreeDShadow;</span>
<a href="#l92.273"></a><span id="l92.273" class="difflineminus">-  -moz-border-left-colors: ThreeDShadow -moz-Dialog;</span>
<a href="#l92.274"></a><span id="l92.274" class="difflineminus">-}</span>
<a href="#l92.275"></a><span id="l92.275" class="difflineminus">-</span>
<a href="#l92.276"></a><span id="l92.276" class="difflineminus">-</span>
<a href="#l92.277"></a><span id="l92.277" class="difflineminus">-/* ::::: column drag and drop styles ::::: */</span>
<a href="#l92.278"></a><span id="l92.278" class="difflineminus">-</span>
<a href="#l92.279"></a><span id="l92.279" class="difflineminus">-treecol[dragging=&quot;true&quot;] {</span>
<a href="#l92.280"></a><span id="l92.280" class="difflineminus">-  -moz-border-top-colors: ThreeDDarkShadow transparent !important;</span>
<a href="#l92.281"></a><span id="l92.281" class="difflineminus">-  -moz-border-right-colors: ThreeDDarkShadow transparent!important;</span>
<a href="#l92.282"></a><span id="l92.282" class="difflineminus">-  -moz-border-bottom-colors: ThreeDDarkShadow transparent !important;</span>
<a href="#l92.283"></a><span id="l92.283" class="difflineminus">-  -moz-border-left-colors: ThreeDDarkShadow transparent !important;</span>
<a href="#l92.284"></a><span id="l92.284" class="difflineminus">-  background-color: ThreeDShadow !important;</span>
<a href="#l92.285"></a><span id="l92.285" class="difflineminus">-  color: ThreeDHighlight !important;</span>
<a href="#l92.286"></a><span id="l92.286" class="difflineminus">-}</span>
<a href="#l92.287"></a><span id="l92.287" class="difflineminus">-</span>
<a href="#l92.288"></a><span id="l92.288" class="difflineminus">-treecol[insertafter=&quot;true&quot;] {</span>
<a href="#l92.289"></a><span id="l92.289" class="difflineminus">-  -moz-border-right-colors: ThreeDDarkShadow ThreeDShadow;</span>
<a href="#l92.290"></a><span id="l92.290" class="difflineminus">-}</span>
<a href="#l92.291"></a><span id="l92.291" class="difflineminus">-</span>
<a href="#l92.292"></a><span id="l92.292" class="difflineminus">-treecol[insertbefore=&quot;true&quot;] {</span>
<a href="#l92.293"></a><span id="l92.293" class="difflineminus">-  -moz-border-left-colors: ThreeDDarkShadow ThreeDShadow;</span>
<a href="#l92.294"></a><span id="l92.294" class="difflineminus">-}</span>
<a href="#l92.295"></a><span id="l92.295" class="difflineminus">-</span>
<a href="#l92.296"></a><span id="l92.296" class="difflineminus">-treechildren::-moz-tree-column(insertbefore) {</span>
<a href="#l92.297"></a><span id="l92.297" class="difflineminus">-  border-left: 1px solid ThreeDShadow;</span>
<a href="#l92.298"></a><span id="l92.298" class="difflineminus">-}</span>
<a href="#l92.299"></a><span id="l92.299" class="difflineminus">-</span>
<a href="#l92.300"></a><span id="l92.300" class="difflineminus">-treechildren::-moz-tree-column(insertafter) {</span>
<a href="#l92.301"></a><span id="l92.301" class="difflineminus">-  border-right: 1px solid ThreeDShadow;</span>
<a href="#l92.302"></a><span id="l92.302" class="difflineminus">-}</span>
<a href="#l92.303"></a><span id="l92.303" class="difflineminus">-</span>
<a href="#l92.304"></a><span id="l92.304" class="difflineminus">-/* ::::: sort direction indicator :::::  */</span>
<a href="#l92.305"></a><span id="l92.305" class="difflineminus">-</span>
<a href="#l92.306"></a><span id="l92.306" class="difflineminus">-.treecol-sortdirection {</span>
<a href="#l92.307"></a><span id="l92.307" class="difflineminus">-  list-style-image: none;</span>
<a href="#l92.308"></a><span id="l92.308" class="difflineminus">-  width: 8px;  /* The image's width is 7 pixels */</span>
<a href="#l92.309"></a><span id="l92.309" class="difflineminus">-}</span>
<a href="#l92.310"></a><span id="l92.310" class="difflineminus">-</span>
<a href="#l92.311"></a><span id="l92.311" class="difflineminus">-.treecol-sortdirection[sortDirection=&quot;ascending&quot;] {</span>
<a href="#l92.312"></a><span id="l92.312" class="difflineminus">-  list-style-image: url(&quot;chrome://global/skin/tree/sort-asc.gif&quot;);</span>
<a href="#l92.313"></a><span id="l92.313" class="difflineminus">-}</span>
<a href="#l92.314"></a><span id="l92.314" class="difflineminus">-</span>
<a href="#l92.315"></a><span id="l92.315" class="difflineminus">-.treecol-sortdirection[sortDirection=&quot;descending&quot;] {</span>
<a href="#l92.316"></a><span id="l92.316" class="difflineminus">-  list-style-image: url(&quot;chrome://global/skin/tree/sort-dsc.gif&quot;);</span>
<a href="#l92.317"></a><span id="l92.317" class="difflineminus">-}</span>
<a href="#l92.318"></a><span id="l92.318" class="difflineminus">-</span>
<a href="#l92.319"></a><span id="l92.319" class="difflineminus">-/* ::::: column picker :::::  */</span>
<a href="#l92.320"></a><span id="l92.320" class="difflineminus">-</span>
<a href="#l92.321"></a><span id="l92.321" class="difflineminus">-.tree-columnpicker-icon {</span>
<a href="#l92.322"></a><span id="l92.322" class="difflineminus">-  list-style-image: url(&quot;chrome://global/skin/tree/columnpicker.gif&quot;);</span>
<a href="#l92.323"></a><span id="l92.323" class="difflineminus">-}</span>
<a href="#l92.324"></a><span id="l92.324" class="difflineminus">-</span>
<a href="#l92.325"></a><span id="l92.325" class="difflineminus">-/* ::::: twisty :::::  */</span>
<a href="#l92.326"></a><span id="l92.326" class="difflineminus">-</span>
<a href="#l92.327"></a><span id="l92.327" class="difflineminus">-treechildren::-moz-tree-twisty {</span>
<a href="#l92.328"></a><span id="l92.328" class="difflineminus">-  -moz-padding-end: 2px;</span>
<a href="#l92.329"></a><span id="l92.329" class="difflineminus">-  width: 10px; /* The image's width is 9 pixels */</span>
<a href="#l92.330"></a><span id="l92.330" class="difflineminus">-  list-style-image: url(&quot;chrome://global/skin/tree/twisty-clsd.png&quot;);</span>
<a href="#l92.331"></a><span id="l92.331" class="difflineminus">-}</span>
<a href="#l92.332"></a><span id="l92.332" class="difflineminus">-</span>
<a href="#l92.333"></a><span id="l92.333" class="difflineminus">-treechildren::-moz-tree-twisty(open) {</span>
<a href="#l92.334"></a><span id="l92.334" class="difflineminus">-  width: 10px; /* The image's width is 9 pixels */</span>
<a href="#l92.335"></a><span id="l92.335" class="difflineminus">-  list-style-image: url(&quot;chrome://global/skin/tree/twisty-open.png&quot;);</span>
<a href="#l92.336"></a><span id="l92.336" class="difflineminus">-}</span>
<a href="#l92.337"></a><span id="l92.337" class="difflineminus">-</span>
<a href="#l92.338"></a><span id="l92.338" class="difflineminus">-treechildren::-moz-tree-indentation {</span>
<a href="#l92.339"></a><span id="l92.339" class="difflineminus">-  width: 16px;</span>
<a href="#l92.340"></a><span id="l92.340" class="difflineminus">-}</span>
<a href="#l92.341"></a><span id="l92.341" class="difflineminus">-</span>
<a href="#l92.342"></a><span id="l92.342" class="difflineminus">-/* ::::: gridline style ::::: */</span>
<a href="#l92.343"></a><span id="l92.343" class="difflineminus">-</span>
<a href="#l92.344"></a><span id="l92.344" class="difflineminus">-treechildren.gridlines::-moz-tree-cell {</span>
<a href="#l92.345"></a><span id="l92.345" class="difflineminus">-  border-right: 1px solid GrayText;</span>
<a href="#l92.346"></a><span id="l92.346" class="difflineminus">-  border-bottom: 1px solid GrayText;</span>
<a href="#l92.347"></a><span id="l92.347" class="difflineminus">-}</span>
<a href="#l92.348"></a><span id="l92.348" class="difflineminus">-</span>
<a href="#l92.349"></a><span id="l92.349" class="difflineminus">-treechildren.gridlines::-moz-tree-row {</span>
<a href="#l92.350"></a><span id="l92.350" class="difflineminus">-  border: none;</span>
<a href="#l92.351"></a><span id="l92.351" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l93.1"></a><span id="l93.1" class="difflineminus">--- a/mail/themes/pinstripe/jar.mn</span>
<a href="#l93.2"></a><span id="l93.2" class="difflineplus">+++ b/mail/themes/pinstripe/jar.mn</span>
<a href="#l93.3"></a><span id="l93.3" class="difflineat">@@ -108,19 +108,17 @@ classic.jar:</span>
<a href="#l93.4"></a><span id="l93.4">   skin/classic/messenger/smime/icons/sbSignNotOk.gif             (mail/smime/sbSignNotOk.gif)</span>
<a href="#l93.5"></a><span id="l93.5">   skin/classic/messenger/smime/icons/sbCryptoOk.gif              (mail/smime/sbCryptoOk.gif)</span>
<a href="#l93.6"></a><span id="l93.6">   skin/classic/messenger/smime/icons/sbCryptoNotOk.gif           (mail/smime/sbCryptoNotOk.gif)</span>
<a href="#l93.7"></a><span id="l93.7">   skin/classic/messenger/smime/icons/hdrSignOk.gif               (mail/smime/hdrSignOk.gif)</span>
<a href="#l93.8"></a><span id="l93.8">   skin/classic/messenger/smime/icons/hdrSignUnknown.gif          (mail/smime/hdrSignUnknown.gif)</span>
<a href="#l93.9"></a><span id="l93.9">   skin/classic/messenger/smime/icons/hdrSignNotOk.gif            (mail/smime/hdrSignNotOk.gif)</span>
<a href="#l93.10"></a><span id="l93.10">   skin/classic/messenger/smime/icons/hdrCryptoOk.gif             (mail/smime/hdrCryptoOk.gif)</span>
<a href="#l93.11"></a><span id="l93.11">   skin/classic/messenger/smime/icons/hdrCryptoNotOk.gif          (mail/smime/hdrCryptoNotOk.gif)</span>
<a href="#l93.12"></a><span id="l93.12" class="difflineminus">-  skin/classic/messenger/icons/chevron.png                       (mail/icons/chevron.png)</span>
<a href="#l93.13"></a><span id="l93.13">   skin/classic/messenger/icons/twisty-open.gif                   (mail/icons/twisty-open.gif)</span>
<a href="#l93.14"></a><span id="l93.14" class="difflineminus">-  skin/classic/messenger/icons/twisty-closed.gif                 (mail/icons/twisty-closed.gif)</span>
<a href="#l93.15"></a><span id="l93.15">   skin/classic/messenger/icons/spin-buttons-active.png           (mail/icons/spin-buttons-active.png)</span>
<a href="#l93.16"></a><span id="l93.16">   skin/classic/messenger/icons/spin-buttons.png                  (mail/icons/spin-buttons.png)</span>
<a href="#l93.17"></a><span id="l93.17">   skin/classic/messenger/icons/sidebar-item.png                  (mail/icons/sidebar-item.png)</span>
<a href="#l93.18"></a><span id="l93.18">   skin/classic/messenger/icons/attachment-deleted.png            (mail/icons/attachment-deleted.png)</span>
<a href="#l93.19"></a><span id="l93.19">   skin/classic/messenger/icons/attachment-deleted-large.png      (mail/icons/attachment-deleted-large.png)</span>
<a href="#l93.20"></a><span id="l93.20">   skin/classic/messenger/icons/attachment-col.png                (mail/icons/attachment-col.png)</span>
<a href="#l93.21"></a><span id="l93.21">   skin/classic/messenger/icons/attachment-selected.png           (mail/icons/attachment-selected.png)</span>
<a href="#l93.22"></a><span id="l93.22">   skin/classic/messenger/icons/attachment.png                    (mail/icons/attachment.png)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l94.1"></a><span id="l94.1">deleted file mode 100644</span>
<a href="#l94.2"></a><span id="l94.2">index 246d5ee8bd00d75dfe1aecb18a70a4c898b4f2b7..e69de29bb2d1d6434b8b29ae775ad8c2e48c5391</span>
<a href="#l94.3"></a><span id="l94.3">GIT binary patch
literal 0
Hc$@&lt;O00001</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l95.1"></a><span id="l95.1">deleted file mode 100644</span>
<a href="#l95.2"></a><span id="l95.2">index d87a58b82a6c2b30d6193dc1bbebb797a4234e57..e69de29bb2d1d6434b8b29ae775ad8c2e48c5391</span>
<a href="#l95.3"></a><span id="l95.3">GIT binary patch
literal 0
Hc$@&lt;O00001</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l96.1"></a><span id="l96.1" class="difflineminus">--- a/mail/themes/pinstripe/mail/messageHeader.css</span>
<a href="#l96.2"></a><span id="l96.2" class="difflineplus">+++ b/mail/themes/pinstripe/mail/messageHeader.css</span>
<a href="#l96.3"></a><span id="l96.3" class="difflineat">@@ -45,34 +45,26 @@</span>
<a href="#l96.4"></a><span id="l96.4"> .main-header-area {</span>
<a href="#l96.5"></a><span id="l96.5">   color: rgb(46, 52, 54); /* Aluminium 6 */</span>
<a href="#l96.6"></a><span id="l96.6">   background-color: rgb(238, 238, 236); /* Aluminium 1 */</span>
<a href="#l96.7"></a><span id="l96.7">   border-bottom: 2px groove rgb(186,189,182); /* Aluminium 3 */</span>
<a href="#l96.8"></a><span id="l96.8">   padding: 0.6ex;</span>
<a href="#l96.9"></a><span id="l96.9"> }</span>
<a href="#l96.10"></a><span id="l96.10"> </span>
<a href="#l96.11"></a><span id="l96.11"> /* ::::: msg header toolbars ::::: */</span>
<a href="#l96.12"></a><span id="l96.12" class="difflineminus">-#collapsedHeaderView {</span>
<a href="#l96.13"></a><span id="l96.13" class="difflineminus">-  min-width: 1px;</span>
<a href="#l96.14"></a><span id="l96.14" class="difflineminus">-}</span>
<a href="#l96.15"></a><span id="l96.15" class="difflineminus">-</span>
<a href="#l96.16"></a><span id="l96.16"> #expandedHeaderView {</span>
<a href="#l96.17"></a><span id="l96.17">   overflow-x: hidden;</span>
<a href="#l96.18"></a><span id="l96.18">   overflow-y: visible;</span>
<a href="#l96.19"></a><span id="l96.19">   max-height: 14em;</span>
<a href="#l96.20"></a><span id="l96.20"> }</span>
<a href="#l96.21"></a><span id="l96.21"> </span>
<a href="#l96.22"></a><span id="l96.22"> #variousHeadersBox{</span>
<a href="#l96.23"></a><span id="l96.23">   padding-bottom: 1em;</span>
<a href="#l96.24"></a><span id="l96.24"> }</span>
<a href="#l96.25"></a><span id="l96.25"> </span>
<a href="#l96.26"></a><span id="l96.26" class="difflineminus">-#collapsedHeaderDisplayName {</span>
<a href="#l96.27"></a><span id="l96.27" class="difflineminus">-  text-align: left;</span>
<a href="#l96.28"></a><span id="l96.28" class="difflineminus">-}</span>
<a href="#l96.29"></a><span id="l96.29" class="difflineminus">-</span>
<a href="#l96.30"></a><span id="l96.30"> /* ::::: msg header buttons ::::: */</span>
<a href="#l96.31"></a><span id="l96.31"> .headerContainer</span>
<a href="#l96.32"></a><span id="l96.32"> {</span>
<a href="#l96.33"></a><span id="l96.33">   min-width: 1px;</span>
<a href="#l96.34"></a><span id="l96.34"> }</span>
<a href="#l96.35"></a><span id="l96.35"> </span>
<a href="#l96.36"></a><span id="l96.36"> #otherActionsButton {</span>
<a href="#l96.37"></a><span id="l96.37">   margin-bottom: 0.1em;</span>
<a href="#l96.38"></a><span id="l96.38" class="difflineat">@@ -101,59 +93,16 @@</span>
<a href="#l96.39"></a><span id="l96.39">   list-style-image: url(&quot;chrome://messenger/skin/icons/arrow-dn-grey.png&quot;);</span>
<a href="#l96.40"></a><span id="l96.40"> }</span>
<a href="#l96.41"></a><span id="l96.41"> </span>
<a href="#l96.42"></a><span id="l96.42"> .msgHeaderView-flat-button[type=&quot;menu&quot;]:hover &gt; .button-box &gt; .button-menu-dropmarker &gt; .dropmarker-icon,</span>
<a href="#l96.43"></a><span id="l96.43"> .msgHeaderView-flat-button[type=&quot;menu-button&quot;]:hover &gt; .button-menubutton-dropmarker &gt; .dropmarker-icon {</span>
<a href="#l96.44"></a><span id="l96.44">   list-style-image: url(&quot;chrome://messenger/skin/icons/arrow-dn-black.png&quot;);</span>
<a href="#l96.45"></a><span id="l96.45"> }</span>
<a href="#l96.46"></a><span id="l96.46"> </span>
<a href="#l96.47"></a><span id="l96.47" class="difflineminus">-#hideDetailsButton {</span>
<a href="#l96.48"></a><span id="l96.48" class="difflineminus">-  font-weight: normal;</span>
<a href="#l96.49"></a><span id="l96.49" class="difflineminus">-  font-size: 100%;</span>
<a href="#l96.50"></a><span id="l96.50" class="difflineminus">-  background: none;</span>
<a href="#l96.51"></a><span id="l96.51" class="difflineminus">-  color: #41413F; /* higher contrast */</span>
<a href="#l96.52"></a><span id="l96.52" class="difflineminus">-  border: 2px solid transparent;</span>
<a href="#l96.53"></a><span id="l96.53" class="difflineminus">-  font-size: 100%;</span>
<a href="#l96.54"></a><span id="l96.54" class="difflineminus">-}</span>
<a href="#l96.55"></a><span id="l96.55" class="difflineminus">-</span>
<a href="#l96.56"></a><span id="l96.56" class="difflineminus">-#hideDetailsButton:hover {</span>
<a href="#l96.57"></a><span id="l96.57" class="difflineminus">-  color: black;</span>
<a href="#l96.58"></a><span id="l96.58" class="difflineminus">-  background-color: rgb(230,231,227);</span>
<a href="#l96.59"></a><span id="l96.59" class="difflineminus">-  border: 2px solid #C0C3C6;</span>
<a href="#l96.60"></a><span id="l96.60" class="difflineminus">-}</span>
<a href="#l96.61"></a><span id="l96.61" class="difflineminus">-</span>
<a href="#l96.62"></a><span id="l96.62" class="difflineminus">-#collapsedsubjectValue {</span>
<a href="#l96.63"></a><span id="l96.63" class="difflineminus">-  -moz-margin-start: 3px !important;</span>
<a href="#l96.64"></a><span id="l96.64" class="difflineminus">-  -moz-box-align: stretch;</span>
<a href="#l96.65"></a><span id="l96.65" class="difflineminus">-  font-weight: bold;</span>
<a href="#l96.66"></a><span id="l96.66" class="difflineminus">-}</span>
<a href="#l96.67"></a><span id="l96.67" class="difflineminus">-</span>
<a href="#l96.68"></a><span id="l96.68" class="difflineminus">-#collapseddateValue {</span>
<a href="#l96.69"></a><span id="l96.69" class="difflineminus">-  -moz-box-align: stretch;</span>
<a href="#l96.70"></a><span id="l96.70" class="difflineminus">-  text-align: right;</span>
<a href="#l96.71"></a><span id="l96.71" class="difflineminus">-  -moz-padding-end: 0.5em !important;</span>
<a href="#l96.72"></a><span id="l96.72" class="difflineminus">-}</span>
<a href="#l96.73"></a><span id="l96.73" class="difflineminus">-</span>
<a href="#l96.74"></a><span id="l96.74" class="difflineminus">-#showDetailsButton {</span>
<a href="#l96.75"></a><span id="l96.75" class="difflineminus">-  -moz-appearance: none !important;</span>
<a href="#l96.76"></a><span id="l96.76" class="difflineminus">-  border: 2px solid transparent;</span>
<a href="#l96.77"></a><span id="l96.77" class="difflineminus">-  background-color: transparent;</span>
<a href="#l96.78"></a><span id="l96.78" class="difflineminus">-  width: 22px;</span>
<a href="#l96.79"></a><span id="l96.79" class="difflineminus">-  padding-bottom: 0px !important;</span>
<a href="#l96.80"></a><span id="l96.80" class="difflineminus">-  background-image: url(&quot;chrome://messenger/skin/icons/chevron.png&quot;);</span>
<a href="#l96.81"></a><span id="l96.81" class="difflineminus">-  background-repeat: no-repeat;</span>
<a href="#l96.82"></a><span id="l96.82" class="difflineminus">-  background-position: center center;</span>
<a href="#l96.83"></a><span id="l96.83" class="difflineminus">-}</span>
<a href="#l96.84"></a><span id="l96.84" class="difflineminus">-</span>
<a href="#l96.85"></a><span id="l96.85" class="difflineminus">-#showDetailsButton:hover {</span>
<a href="#l96.86"></a><span id="l96.86" class="difflineminus">-  background-color: rgb(230,231,227);</span>
<a href="#l96.87"></a><span id="l96.87" class="difflineminus">-  border: 2px solid #C0C3C6;</span>
<a href="#l96.88"></a><span id="l96.88" class="difflineminus">-}</span>
<a href="#l96.89"></a><span id="l96.89" class="difflineminus">-</span>
<a href="#l96.90"></a><span id="l96.90"> .hdrTrashButton {</span>
<a href="#l96.91"></a><span id="l96.91">   -moz-box-orient: vertical;</span>
<a href="#l96.92"></a><span id="l96.92">   list-style-image: url(&quot;chrome://messenger/skin/icons/folder-trash.png&quot;);</span>
<a href="#l96.93"></a><span id="l96.93"> }</span>
<a href="#l96.94"></a><span id="l96.94"> </span>
<a href="#l96.95"></a><span id="l96.95"> /* ::::: expanded header pane ::::: */</span>
<a href="#l96.96"></a><span id="l96.96"> </span>
<a href="#l96.97"></a><span id="l96.97"> header-view-button-box {</span>
<a href="#l96.98"></a><span id="l96.98" class="difflineat">@@ -437,39 +386,16 @@ description[selectable=&quot;true&quot;]:focus &gt; d</span>
<a href="#l96.99"></a><span id="l96.99"> .headerValueUrl:hover {</span>
<a href="#l96.100"></a><span id="l96.100">   color: red;</span>
<a href="#l96.101"></a><span id="l96.101"> }</span>
<a href="#l96.102"></a><span id="l96.102"> </span>
<a href="#l96.103"></a><span id="l96.103"> .headerField {</span>
<a href="#l96.104"></a><span id="l96.104">   color: inherit;</span>
<a href="#l96.105"></a><span id="l96.105"> }</span>
<a href="#l96.106"></a><span id="l96.106"> </span>
<a href="#l96.107"></a><span id="l96.107" class="difflineminus">-#collapsedsubjectBox {</span>
<a href="#l96.108"></a><span id="l96.108" class="difflineminus">-  margin: 0px;</span>
<a href="#l96.109"></a><span id="l96.109" class="difflineminus">-  padding: 0px;</span>
<a href="#l96.110"></a><span id="l96.110" class="difflineminus">-}</span>
<a href="#l96.111"></a><span id="l96.111" class="difflineminus">-</span>
<a href="#l96.112"></a><span id="l96.112" class="difflineminus">-#collapsedfromValue &gt; .headerNameBox {</span>
<a href="#l96.113"></a><span id="l96.113" class="difflineminus">-  display: none;</span>
<a href="#l96.114"></a><span id="l96.114" class="difflineminus">-}</span>
<a href="#l96.115"></a><span id="l96.115" class="difflineminus">-</span>
<a href="#l96.116"></a><span id="l96.116" class="difflineminus">-#collapsedtoCcBccValue &gt; .headerNameBox {</span>
<a href="#l96.117"></a><span id="l96.117" class="difflineminus">-  display: none;</span>
<a href="#l96.118"></a><span id="l96.118" class="difflineminus">-}</span>
<a href="#l96.119"></a><span id="l96.119" class="difflineminus">-</span>
<a href="#l96.120"></a><span id="l96.120" class="difflineminus">-#collapsedtoCcBccValue &gt; .headerValueBox[singleline] {</span>
<a href="#l96.121"></a><span id="l96.121" class="difflineminus">-  padding-top: 0;</span>
<a href="#l96.122"></a><span id="l96.122" class="difflineminus">-  padding-bottom: 0;</span>
<a href="#l96.123"></a><span id="l96.123" class="difflineminus">-}</span>
<a href="#l96.124"></a><span id="l96.124" class="difflineminus">-</span>
<a href="#l96.125"></a><span id="l96.125" class="difflineminus">-#collapsedtoCcBccValue &gt; .headerValueBox:not([singleline]) {</span>
<a href="#l96.126"></a><span id="l96.126" class="difflineminus">-  padding-top: 0.5em;</span>
<a href="#l96.127"></a><span id="l96.127" class="difflineminus">-  padding-bottom: 0;</span>
<a href="#l96.128"></a><span id="l96.128" class="difflineminus">-}</span>
<a href="#l96.129"></a><span id="l96.129" class="difflineminus">-</span>
<a href="#l96.130"></a><span id="l96.130"> .moreIndicator {</span>
<a href="#l96.131"></a><span id="l96.131">   font-weight: bold;</span>
<a href="#l96.132"></a><span id="l96.132">   font-size: small;</span>
<a href="#l96.133"></a><span id="l96.133"> }</span>
<a href="#l96.134"></a><span id="l96.134"> </span>
<a href="#l96.135"></a><span id="l96.135"> .moreIndicator:hover {</span>
<a href="#l96.136"></a><span id="l96.136">   text-decoration: underline;</span>
<a href="#l96.137"></a><span id="l96.137">   color: darkred;</span>
<a href="#l96.138"></a><span id="l96.138" class="difflineat">@@ -619,19 +545,15 @@ mail-emailaddress[selected=&quot;true&quot;] .emai</span>
<a href="#l96.139"></a><span id="l96.139"> }</span>
<a href="#l96.140"></a><span id="l96.140"> </span>
<a href="#l96.141"></a><span id="l96.141"> /* ::::: view expand and collapse twisties  ::::: */</span>
<a href="#l96.142"></a><span id="l96.142"> </span>
<a href="#l96.143"></a><span id="l96.143"> .expandHeaderViewButton {</span>
<a href="#l96.144"></a><span id="l96.144">   list-style-image:url(&quot;chrome://messenger/skin/icons/twisty-open.gif&quot;);</span>
<a href="#l96.145"></a><span id="l96.145"> }</span>
<a href="#l96.146"></a><span id="l96.146"> </span>
<a href="#l96.147"></a><span id="l96.147" class="difflineminus">-.collapsedHeaderViewButton  {</span>
<a href="#l96.148"></a><span id="l96.148" class="difflineminus">-  list-style-image:url(&quot;chrome://messenger/skin/icons/twisty-closed.gif&quot;);</span>
<a href="#l96.149"></a><span id="l96.149" class="difflineminus">-}</span>
<a href="#l96.150"></a><span id="l96.150" class="difflineminus">-</span>
<a href="#l96.151"></a><span id="l96.151"> /* ::::: collapsed view styles ::::: */</span>
<a href="#l96.152"></a><span id="l96.152"> </span>
<a href="#l96.153"></a><span id="l96.153"> mail-multi-emailHeaderField,</span>
<a href="#l96.154"></a><span id="l96.154"> mail-headerfield {</span>
<a href="#l96.155"></a><span id="l96.155">   margin: 0;</span>
<a href="#l96.156"></a><span id="l96.156">   padding: 0;</span>
<a href="#l96.157"></a><span id="l96.157"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l97.1"></a><span id="l97.1" class="difflineminus">--- a/mail/themes/pinstripe/mail/tabmail.css</span>
<a href="#l97.2"></a><span id="l97.2" class="difflineplus">+++ b/mail/themes/pinstripe/mail/tabmail.css</span>
<a href="#l97.3"></a><span id="l97.3" class="difflineat">@@ -71,16 +71,20 @@</span>
<a href="#l97.4"></a><span id="l97.4"> .tabmail-tab[selected=&quot;true&quot;] &gt; .tab-icon {</span>
<a href="#l97.5"></a><span id="l97.5">   list-style-image: url(&quot;chrome://global/skin/tree/item.png&quot;);</span>
<a href="#l97.6"></a><span id="l97.6"> }</span>
<a href="#l97.7"></a><span id="l97.7"> </span>
<a href="#l97.8"></a><span id="l97.8"> .tabmail-tab[busy] &gt; .tab-icon {</span>
<a href="#l97.9"></a><span id="l97.9">   list-style-image: url(&quot;chrome://global/skin/icons/loading_16.png&quot;) !important;</span>
<a href="#l97.10"></a><span id="l97.10"> }</span>
<a href="#l97.11"></a><span id="l97.11"> </span>
<a href="#l97.12"></a><span id="l97.12" class="difflineplus">+.tabmail-tab[thinking] &gt; .tab-icon {</span>
<a href="#l97.13"></a><span id="l97.13" class="difflineplus">+  list-style-image: url(&quot;chrome://global/skin/icons/loading_16.png&quot;) !important;</span>
<a href="#l97.14"></a><span id="l97.14" class="difflineplus">+}</span>
<a href="#l97.15"></a><span id="l97.15" class="difflineplus">+</span>
<a href="#l97.16"></a><span id="l97.16"> .tabmail-tab:hover &gt; .tab-icon,</span>
<a href="#l97.17"></a><span id="l97.17"> .tabmail-tab[selected=&quot;true&quot;] &gt; .tab-icon {</span>
<a href="#l97.18"></a><span id="l97.18">   opacity: 1;</span>
<a href="#l97.19"></a><span id="l97.19"> }</span>
<a href="#l97.20"></a><span id="l97.20"> </span>
<a href="#l97.21"></a><span id="l97.21"> .tab-text {</span>
<a href="#l97.22"></a><span id="l97.22">   margin-top: 3px !important;</span>
<a href="#l97.23"></a><span id="l97.23">   margin-bottom: 0 !important;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l98.1"></a><span id="l98.1" class="difflineminus">--- a/mail/themes/qute/jar.mn</span>
<a href="#l98.2"></a><span id="l98.2" class="difflineplus">+++ b/mail/themes/qute/jar.mn</span>
<a href="#l98.3"></a><span id="l98.3" class="difflineat">@@ -1,12 +1,9 @@</span>
<a href="#l98.4"></a><span id="l98.4"> classic.jar:</span>
<a href="#l98.5"></a><span id="l98.5" class="difflineminus">-+ skin/classic/global/tree.css                                (mail/tree.css)</span>
<a href="#l98.6"></a><span id="l98.6" class="difflineminus">-+ skin/classic/global/tree/sort-asc.gif                       (mail/icons/sort-asc.gif)</span>
<a href="#l98.7"></a><span id="l98.7" class="difflineminus">-+ skin/classic/global/tree/sort-dsc.gif                       (mail/icons/sort-dsc.gif)</span>
<a href="#l98.8"></a><span id="l98.8">   icon.png                                                    (mail/icon.png)</span>
<a href="#l98.9"></a><span id="l98.9">   preview.png                                                 (mail/preview.png)</span>
<a href="#l98.10"></a><span id="l98.10"> % skin communicator classic/1.0 %skin/classic/communicator/</span>
<a href="#l98.11"></a><span id="l98.11">   skin/classic/communicator/communicator.css                      (mail/communicator.css)</span>
<a href="#l98.12"></a><span id="l98.12">   skin/classic/communicator/smileys.css                       (mail/smileys.css)</span>
<a href="#l98.13"></a><span id="l98.13">   skin/classic/communicator/icons/smileys/smiley-smile.png        (mail/icons/smiley-smile.png)</span>
<a href="#l98.14"></a><span id="l98.14">   skin/classic/communicator/icons/smileys/smiley-frown.png        (mail/icons/smiley-frown.png)</span>
<a href="#l98.15"></a><span id="l98.15">   skin/classic/communicator/icons/smileys/smiley-wink.png         (mail/icons/smiley-wink.png)</span>
<a href="#l98.16"></a><span id="l98.16" class="difflineat">@@ -206,18 +203,16 @@ classic.jar:</span>
<a href="#l98.17"></a><span id="l98.17">   skin/classic/messenger/icons/arrow/arrow-left.png           (mail/icons/arrow/arrow-left.png)</span>
<a href="#l98.18"></a><span id="l98.18">   skin/classic/messenger/icons/arrow/arrow-right.png          (mail/icons/arrow/arrow-right.png)</span>
<a href="#l98.19"></a><span id="l98.19">   skin/classic/messenger/icons/arrow/arrow-up.png             (mail/icons/arrow/arrow-up.png)</span>
<a href="#l98.20"></a><span id="l98.20">   skin/classic/messenger/icons/arrow/arrow-down.png           (mail/icons/arrow/arrow-down.png)</span>
<a href="#l98.21"></a><span id="l98.21">   skin/classic/messenger/icons/arrow/arrow-left-dim.png       (mail/icons/arrow/arrow-left-dim.png)</span>
<a href="#l98.22"></a><span id="l98.22">   skin/classic/messenger/icons/arrow/arrow-right-dim.png      (mail/icons/arrow/arrow-right-dim.png)</span>
<a href="#l98.23"></a><span id="l98.23">   skin/classic/messenger/icons/arrow/arrow-up-dim.png         (mail/icons/arrow/arrow-up-dim.png)</span>
<a href="#l98.24"></a><span id="l98.24">   skin/classic/messenger/icons/arrow/arrow-down-dim.png       (mail/icons/arrow/arrow-down-dim.png)</span>
<a href="#l98.25"></a><span id="l98.25" class="difflineminus">-  skin/classic/messenger/icons/chevron.png                    (mail/icons/chevron.png)</span>
<a href="#l98.26"></a><span id="l98.26" class="difflineminus">-  skin/classic/messenger/icons/croppedchevron.png             (mail/icons/croppedchevron.png)</span>
<a href="#l98.27"></a><span id="l98.27">   skin/classic/messenger/tagbg.png                            (mail/tagbg.png)</span>
<a href="#l98.28"></a><span id="l98.28"> % skin messenger-newsblog classic/1.0 %skin/classic/messenger-newsblog/ os=WINNT osversion&lt;6</span>
<a href="#l98.29"></a><span id="l98.29"> % skin messenger-newsblog classic/1.0 %skin/classic/messenger-newsblog/ os!=WINNT</span>
<a href="#l98.30"></a><span id="l98.30">   skin/classic/messenger-newsblog/feed-subscriptions.css      (mail/newsblog/feed-subscriptions.css)</span>
<a href="#l98.31"></a><span id="l98.31">   skin/classic/messenger-newsblog/icons/rss-feed.png          (mail/newsblog/rss-feed.png)</span>
<a href="#l98.32"></a><span id="l98.32">   skin/classic/messenger-newsblog/icons/server-rss.png        (mail/newsblog/server-rss.png)</span>
<a href="#l98.33"></a><span id="l98.33"> #ifdef XP_WIN</span>
<a href="#l98.34"></a><span id="l98.34"> % skin messenger classic/1.0 %skin/classic/aero/messenger/ os=WINNT osversion&gt;=6</span>
<a href="#l98.35"></a><span id="l98.35" class="difflineat">@@ -393,17 +388,15 @@ classic.jar:</span>
<a href="#l98.36"></a><span id="l98.36">   skin/classic/aero/messenger/icons/arrow/arrow-left.png           (mail/icons/arrow/arrow-left.png)</span>
<a href="#l98.37"></a><span id="l98.37">   skin/classic/aero/messenger/icons/arrow/arrow-right.png          (mail/icons/arrow/arrow-right.png)</span>
<a href="#l98.38"></a><span id="l98.38">   skin/classic/aero/messenger/icons/arrow/arrow-up.png             (mail/icons/arrow/arrow-up.png)</span>
<a href="#l98.39"></a><span id="l98.39">   skin/classic/aero/messenger/icons/arrow/arrow-down.png           (mail/icons/arrow/arrow-down.png)</span>
<a href="#l98.40"></a><span id="l98.40">   skin/classic/aero/messenger/icons/arrow/arrow-left-dim.png       (mail/icons/arrow/arrow-left-dim.png)</span>
<a href="#l98.41"></a><span id="l98.41">   skin/classic/aero/messenger/icons/arrow/arrow-right-dim.png      (mail/icons/arrow/arrow-right-dim.png)</span>
<a href="#l98.42"></a><span id="l98.42">   skin/classic/aero/messenger/icons/arrow/arrow-up-dim.png         (mail/icons/arrow/arrow-up-dim.png)</span>
<a href="#l98.43"></a><span id="l98.43">   skin/classic/aero/messenger/icons/arrow/arrow-down-dim.png       (mail/icons/arrow/arrow-down-dim.png)</span>
<a href="#l98.44"></a><span id="l98.44" class="difflineminus">-  skin/classic/aero/messenger/icons/chevron.png                    (mail/icons/chevron.png)</span>
<a href="#l98.45"></a><span id="l98.45" class="difflineminus">-  skin/classic/aero/messenger/icons/croppedchevron.png             (mail/icons/croppedchevron.png)</span>
<a href="#l98.46"></a><span id="l98.46">   skin/classic/aero/messenger/tagbg.png                            (mail/tagbg.png)</span>
<a href="#l98.47"></a><span id="l98.47"> % skin messenger-newsblog classic/1.0 %skin/classic/aero/messenger-newsblog/ os=WINNT osversion&gt;=6</span>
<a href="#l98.48"></a><span id="l98.48">   skin/classic/aero/messenger-newsblog/feed-subscriptions.css      (mail/newsblog/feed-subscriptions.css)</span>
<a href="#l98.49"></a><span id="l98.49">   skin/classic/aero/messenger-newsblog/icons/rss-feed.png          (mail/newsblog/rss-feed.png)</span>
<a href="#l98.50"></a><span id="l98.50">   skin/classic/aero/messenger-newsblog/icons/server-rss.png        (mail/newsblog/server-rss.png)</span>
<a href="#l98.51"></a><span id="l98.51"> </span>
<a href="#l98.52"></a><span id="l98.52"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l99.1"></a><span id="l99.1">deleted file mode 100644</span>
<a href="#l99.2"></a><span id="l99.2">index 246d5ee8bd00d75dfe1aecb18a70a4c898b4f2b7..e69de29bb2d1d6434b8b29ae775ad8c2e48c5391</span>
<a href="#l99.3"></a><span id="l99.3">GIT binary patch
literal 0
Hc$@&lt;O00001</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l100.1"></a><span id="l100.1">deleted file mode 100644</span>
<a href="#l100.2"></a><span id="l100.2">index e63e4ecef93b11108763929b2e50d64fae0fdca0..e69de29bb2d1d6434b8b29ae775ad8c2e48c5391</span>
<a href="#l100.3"></a><span id="l100.3">GIT binary patch
literal 0
Hc$@&lt;O00001</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l101.1"></a><span id="l101.1">deleted file mode 100755</span>
<a href="#l101.2"></a><span id="l101.2">index b341abde70d4854bce80a79007ebde65e6b21c04..e69de29bb2d1d6434b8b29ae775ad8c2e48c5391</span>
<a href="#l101.3"></a><span id="l101.3">GIT binary patch
literal 0
Hc$@&lt;O00001</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l102.1"></a><span id="l102.1">deleted file mode 100755</span>
<a href="#l102.2"></a><span id="l102.2">index bfeb6a8a8ae42839b54de9a4645e56826a1a1bf7..e69de29bb2d1d6434b8b29ae775ad8c2e48c5391</span>
<a href="#l102.3"></a><span id="l102.3">GIT binary patch
literal 0
Hc$@&lt;O00001</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l103.1"></a><span id="l103.1" class="difflineminus">--- a/mail/themes/qute/mail/messageHeader.css</span>
<a href="#l103.2"></a><span id="l103.2" class="difflineplus">+++ b/mail/themes/qute/mail/messageHeader.css</span>
<a href="#l103.3"></a><span id="l103.3" class="difflineat">@@ -46,74 +46,37 @@</span>
<a href="#l103.4"></a><span id="l103.4">   color: WindowText;</span>
<a href="#l103.5"></a><span id="l103.5">   background-color: ButtonFace;</span>
<a href="#l103.6"></a><span id="l103.6">   border-bottom: 2px groove ThreeDLightShadow;</span>
<a href="#l103.7"></a><span id="l103.7">   padding: 0.4ex;</span>
<a href="#l103.8"></a><span id="l103.8"> }</span>
<a href="#l103.9"></a><span id="l103.9"> </span>
<a href="#l103.10"></a><span id="l103.10"> /* ::::: msg header toolbars ::::: */</span>
<a href="#l103.11"></a><span id="l103.11"> </span>
<a href="#l103.12"></a><span id="l103.12" class="difflineminus">-#collapsedHeaderView {</span>
<a href="#l103.13"></a><span id="l103.13" class="difflineminus">-  min-width: 1px;</span>
<a href="#l103.14"></a><span id="l103.14" class="difflineminus">-}</span>
<a href="#l103.15"></a><span id="l103.15" class="difflineminus">-</span>
<a href="#l103.16"></a><span id="l103.16"> #expandedHeaderView {</span>
<a href="#l103.17"></a><span id="l103.17">   overflow-y: auto;</span>
<a href="#l103.18"></a><span id="l103.18">   overflow-x: hidden;</span>
<a href="#l103.19"></a><span id="l103.19">   max-height: 14em;</span>
<a href="#l103.20"></a><span id="l103.20"> }</span>
<a href="#l103.21"></a><span id="l103.21"> </span>
<a href="#l103.22"></a><span id="l103.22"> #variousHeadersBox{</span>
<a href="#l103.23"></a><span id="l103.23">   padding-bottom: 1em;</span>
<a href="#l103.24"></a><span id="l103.24"> }</span>
<a href="#l103.25"></a><span id="l103.25"> </span>
<a href="#l103.26"></a><span id="l103.26" class="difflineminus">-#collapsedHeaderDisplayName {</span>
<a href="#l103.27"></a><span id="l103.27" class="difflineminus">-  text-align: left;</span>
<a href="#l103.28"></a><span id="l103.28" class="difflineminus">-}</span>
<a href="#l103.29"></a><span id="l103.29" class="difflineminus">-</span>
<a href="#l103.30"></a><span id="l103.30"> /* ::::: msg header buttons ::::: */</span>
<a href="#l103.31"></a><span id="l103.31"> .headerContainer</span>
<a href="#l103.32"></a><span id="l103.32"> {</span>
<a href="#l103.33"></a><span id="l103.33">   min-width: 1px;</span>
<a href="#l103.34"></a><span id="l103.34"> }</span>
<a href="#l103.35"></a><span id="l103.35"> </span>
<a href="#l103.36"></a><span id="l103.36"> #otherActionsButton {</span>
<a href="#l103.37"></a><span id="l103.37">   margin-bottom: .1em;</span>
<a href="#l103.38"></a><span id="l103.38">   padding-top: 0px;</span>
<a href="#l103.39"></a><span id="l103.39"> }</span>
<a href="#l103.40"></a><span id="l103.40"> </span>
<a href="#l103.41"></a><span id="l103.41" class="difflineminus">-#collapsedsubjectValue {</span>
<a href="#l103.42"></a><span id="l103.42" class="difflineminus">-  -moz-margin-start: 3px !important;</span>
<a href="#l103.43"></a><span id="l103.43" class="difflineminus">-  -moz-box-align: stretch;</span>
<a href="#l103.44"></a><span id="l103.44" class="difflineminus">-  font-weight: bold;</span>
<a href="#l103.45"></a><span id="l103.45" class="difflineminus">-}</span>
<a href="#l103.46"></a><span id="l103.46" class="difflineminus">-</span>
<a href="#l103.47"></a><span id="l103.47" class="difflineminus">-#collapseddateValue {</span>
<a href="#l103.48"></a><span id="l103.48" class="difflineminus">-  -moz-box-align: stretch;</span>
<a href="#l103.49"></a><span id="l103.49" class="difflineminus">-  text-align: right;</span>
<a href="#l103.50"></a><span id="l103.50" class="difflineminus">-  -moz-padding-end: 0.5em !important;</span>
<a href="#l103.51"></a><span id="l103.51" class="difflineminus">-}</span>
<a href="#l103.52"></a><span id="l103.52" class="difflineminus">-</span>
<a href="#l103.53"></a><span id="l103.53" class="difflineminus">-#showDetailsButton {</span>
<a href="#l103.54"></a><span id="l103.54" class="difflineminus">-  width: 26px;</span>
<a href="#l103.55"></a><span id="l103.55" class="difflineminus">-  padding-bottom: 0px;</span>
<a href="#l103.56"></a><span id="l103.56" class="difflineminus">-  height: 23px;</span>
<a href="#l103.57"></a><span id="l103.57" class="difflineminus">-  border: solid 3px transparent;</span>
<a href="#l103.58"></a><span id="l103.58" class="difflineminus">-  margin: 0;</span>
<a href="#l103.59"></a><span id="l103.59" class="difflineminus">-  text-align: center;</span>
<a href="#l103.60"></a><span id="l103.60" class="difflineminus">-  list-style-image: url(&quot;chrome://messenger/skin/icons/croppedchevron.png&quot;);</span>
<a href="#l103.61"></a><span id="l103.61" class="difflineminus">-}</span>
<a href="#l103.62"></a><span id="l103.62" class="difflineminus">-</span>
<a href="#l103.63"></a><span id="l103.63" class="difflineminus">-#showDetailsButton &gt; .button-box,</span>
<a href="#l103.64"></a><span id="l103.64" class="difflineminus">-#showDetailsButton &gt; .button-box &gt; .button-icon,</span>
<a href="#l103.65"></a><span id="l103.65" class="difflineminus">-#showDetailsButton &gt; .button-box &gt; .button-text{</span>
<a href="#l103.66"></a><span id="l103.66" class="difflineminus">-  margin: 0;</span>
<a href="#l103.67"></a><span id="l103.67" class="difflineminus">-  padding: 0;</span>
<a href="#l103.68"></a><span id="l103.68" class="difflineminus">-}</span>
<a href="#l103.69"></a><span id="l103.69" class="difflineminus">-</span>
<a href="#l103.70"></a><span id="l103.70"> /* ::::: expanded header pane ::::: */</span>
<a href="#l103.71"></a><span id="l103.71"> </span>
<a href="#l103.72"></a><span id="l103.72"> header-view-button-box {</span>
<a href="#l103.73"></a><span id="l103.73">   padding: 0px;</span>
<a href="#l103.74"></a><span id="l103.74"> }</span>
<a href="#l103.75"></a><span id="l103.75"> </span>
<a href="#l103.76"></a><span id="l103.76"> #expandedfromBox {</span>
<a href="#l103.77"></a><span id="l103.77">   padding-top: 0.5em;</span>
<a href="#l103.78"></a><span id="l103.78" class="difflineat">@@ -357,43 +320,16 @@ description[selectable=&quot;true&quot;]:focus &gt; d</span>
<a href="#l103.79"></a><span id="l103.79"> .headerValueUrl:hover {</span>
<a href="#l103.80"></a><span id="l103.80">   color: red;</span>
<a href="#l103.81"></a><span id="l103.81"> }</span>
<a href="#l103.82"></a><span id="l103.82"> </span>
<a href="#l103.83"></a><span id="l103.83"> .headerField {</span>
<a href="#l103.84"></a><span id="l103.84">   color: inherit;</span>
<a href="#l103.85"></a><span id="l103.85"> }</span>
<a href="#l103.86"></a><span id="l103.86"> </span>
<a href="#l103.87"></a><span id="l103.87" class="difflineminus">-#collapsedsubjectBox {</span>
<a href="#l103.88"></a><span id="l103.88" class="difflineminus">-  margin: 0px;</span>
<a href="#l103.89"></a><span id="l103.89" class="difflineminus">-  padding: 0px;</span>
<a href="#l103.90"></a><span id="l103.90" class="difflineminus">-}</span>
<a href="#l103.91"></a><span id="l103.91" class="difflineminus">-</span>
<a href="#l103.92"></a><span id="l103.92" class="difflineminus">-#collapsedfromBox {</span>
<a href="#l103.93"></a><span id="l103.93" class="difflineminus">-  padding-top: 0.5em;</span>
<a href="#l103.94"></a><span id="l103.94" class="difflineminus">-}</span>
<a href="#l103.95"></a><span id="l103.95" class="difflineminus">-</span>
<a href="#l103.96"></a><span id="l103.96" class="difflineminus">-#collapsedfromValue &gt; .headerNameBox {</span>
<a href="#l103.97"></a><span id="l103.97" class="difflineminus">-  display: none;</span>
<a href="#l103.98"></a><span id="l103.98" class="difflineminus">-}</span>
<a href="#l103.99"></a><span id="l103.99" class="difflineminus">-</span>
<a href="#l103.100"></a><span id="l103.100" class="difflineminus">-#collapsedtoCcBccValue &gt; .headerNameBox {</span>
<a href="#l103.101"></a><span id="l103.101" class="difflineminus">-  display: none;</span>
<a href="#l103.102"></a><span id="l103.102" class="difflineminus">-}</span>
<a href="#l103.103"></a><span id="l103.103" class="difflineminus">-</span>
<a href="#l103.104"></a><span id="l103.104" class="difflineminus">-#collapsedtoCcBccValue &gt; .headerValueBox[singleline] {</span>
<a href="#l103.105"></a><span id="l103.105" class="difflineminus">-  padding-top: 0;</span>
<a href="#l103.106"></a><span id="l103.106" class="difflineminus">-  padding-bottom: 0;</span>
<a href="#l103.107"></a><span id="l103.107" class="difflineminus">-}</span>
<a href="#l103.108"></a><span id="l103.108" class="difflineminus">-</span>
<a href="#l103.109"></a><span id="l103.109" class="difflineminus">-#collapsedtoCcBccValue &gt; .headerValueBox:not([singleline]) {</span>
<a href="#l103.110"></a><span id="l103.110" class="difflineminus">-  padding-top: 0.5em;</span>
<a href="#l103.111"></a><span id="l103.111" class="difflineminus">-  padding-bottom: 0;</span>
<a href="#l103.112"></a><span id="l103.112" class="difflineminus">-}</span>
<a href="#l103.113"></a><span id="l103.113" class="difflineminus">-</span>
<a href="#l103.114"></a><span id="l103.114"> .moreIndicator {</span>
<a href="#l103.115"></a><span id="l103.115">   font-weight: bold;</span>
<a href="#l103.116"></a><span id="l103.116"> }</span>
<a href="#l103.117"></a><span id="l103.117"> </span>
<a href="#l103.118"></a><span id="l103.118"> .moreIndicator:hover {</span>
<a href="#l103.119"></a><span id="l103.119">   text-decoration: underline;</span>
<a href="#l103.120"></a><span id="l103.120">   color: darkred;</span>
<a href="#l103.121"></a><span id="l103.121"> }</span>
<a href="#l103.122"></a><span id="l103.122" class="difflineat">@@ -537,17 +473,13 @@ mail-emailaddress[selected=&quot;true&quot;] .emai</span>
<a href="#l103.123"></a><span id="l103.123"> }</span>
<a href="#l103.124"></a><span id="l103.124"> </span>
<a href="#l103.125"></a><span id="l103.125"> /* ::::: view expand and collapse twisties  ::::: */</span>
<a href="#l103.126"></a><span id="l103.126"> </span>
<a href="#l103.127"></a><span id="l103.127"> .expandHeaderViewButton {</span>
<a href="#l103.128"></a><span id="l103.128">   list-style-image: url(&quot;chrome://global/skin/tree/twisty-open.png&quot;);</span>
<a href="#l103.129"></a><span id="l103.129"> }</span>
<a href="#l103.130"></a><span id="l103.130"> </span>
<a href="#l103.131"></a><span id="l103.131" class="difflineminus">-.collapsedHeaderViewButton  {</span>
<a href="#l103.132"></a><span id="l103.132" class="difflineminus">-  list-style-image: url(&quot;chrome://global/skin/tree/twisty-clsd.png&quot;);</span>
<a href="#l103.133"></a><span id="l103.133" class="difflineminus">-}</span>
<a href="#l103.134"></a><span id="l103.134" class="difflineminus">-</span>
<a href="#l103.135"></a><span id="l103.135"> mail-multi-emailHeaderField,</span>
<a href="#l103.136"></a><span id="l103.136"> mail-headerfield {</span>
<a href="#l103.137"></a><span id="l103.137">   margin: 0;</span>
<a href="#l103.138"></a><span id="l103.138">   padding: 0;</span>
<a href="#l103.139"></a><span id="l103.139"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l104.1"></a><span id="l104.1" class="difflineminus">--- a/mail/themes/qute/mail/tabmail.css</span>
<a href="#l104.2"></a><span id="l104.2" class="difflineplus">+++ b/mail/themes/qute/mail/tabmail.css</span>
<a href="#l104.3"></a><span id="l104.3" class="difflineat">@@ -70,16 +70,20 @@</span>
<a href="#l104.4"></a><span id="l104.4">   padding-top: 1px;</span>
<a href="#l104.5"></a><span id="l104.5">   -moz-padding-start: 1px;</span>
<a href="#l104.6"></a><span id="l104.6"> }</span>
<a href="#l104.7"></a><span id="l104.7"> </span>
<a href="#l104.8"></a><span id="l104.8"> .tabmail-tab[busy] &gt; .tab-image-middle &gt; .tab-icon &gt; .tab-icon-image {</span>
<a href="#l104.9"></a><span id="l104.9">   list-style-image: url(&quot;chrome://global/skin/icons/loading_16.png&quot;) !important;</span>
<a href="#l104.10"></a><span id="l104.10"> }</span>
<a href="#l104.11"></a><span id="l104.11"> </span>
<a href="#l104.12"></a><span id="l104.12" class="difflineplus">+.tabmail-tab[thinking] &gt; .tab-image-middle &gt; .tab-icon &gt; .tab-icon-image {</span>
<a href="#l104.13"></a><span id="l104.13" class="difflineplus">+  list-style-image: url(&quot;chrome://global/skin/icons/loading_16.png&quot;) !important;</span>
<a href="#l104.14"></a><span id="l104.14" class="difflineplus">+}</span>
<a href="#l104.15"></a><span id="l104.15" class="difflineplus">+</span>
<a href="#l104.16"></a><span id="l104.16"> .tabmail-tab[selected=&quot;true&quot;] {</span>
<a href="#l104.17"></a><span id="l104.17">   font-weight: bold;</span>
<a href="#l104.18"></a><span id="l104.18"> }</span>
<a href="#l104.19"></a><span id="l104.19"> </span>
<a href="#l104.20"></a><span id="l104.20"> .tabmail-tab[selected=&quot;true&quot;] &gt; .tab-image-middle &gt; .tab-text {</span>
<a href="#l104.21"></a><span id="l104.21">   opacity: 1.0 !important;</span>
<a href="#l104.22"></a><span id="l104.22"> }</span>
<a href="#l104.23"></a><span id="l104.23"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l105.1"></a><span id="l105.1">deleted file mode 100644</span>
<a href="#l105.2"></a><span id="l105.2" class="difflineminus">--- a/mail/themes/qute/mail/tree.css</span>
<a href="#l105.3"></a><span id="l105.3" class="difflineplus">+++ /dev/null</span>
<a href="#l105.4"></a><span id="l105.4" class="difflineat">@@ -1,347 +0,0 @@</span>
<a href="#l105.5"></a><span id="l105.5" class="difflineminus">-/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l105.6"></a><span id="l105.6" class="difflineminus">- * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l105.7"></a><span id="l105.7" class="difflineminus">- *</span>
<a href="#l105.8"></a><span id="l105.8" class="difflineminus">- * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l105.9"></a><span id="l105.9" class="difflineminus">- * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l105.10"></a><span id="l105.10" class="difflineminus">- * the License. You may obtain a copy of the License at</span>
<a href="#l105.11"></a><span id="l105.11" class="difflineminus">- * http://www.mozilla.org/MPL/</span>
<a href="#l105.12"></a><span id="l105.12" class="difflineminus">- *</span>
<a href="#l105.13"></a><span id="l105.13" class="difflineminus">- * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l105.14"></a><span id="l105.14" class="difflineminus">- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l105.15"></a><span id="l105.15" class="difflineminus">- * for the specific language governing rights and limitations under the</span>
<a href="#l105.16"></a><span id="l105.16" class="difflineminus">- * License.</span>
<a href="#l105.17"></a><span id="l105.17" class="difflineminus">- *</span>
<a href="#l105.18"></a><span id="l105.18" class="difflineminus">- * The Original Code is Mozilla Communicator client code, released</span>
<a href="#l105.19"></a><span id="l105.19" class="difflineminus">- * March 31, 1998.</span>
<a href="#l105.20"></a><span id="l105.20" class="difflineminus">- *</span>
<a href="#l105.21"></a><span id="l105.21" class="difflineminus">- * The Initial Developer of the Original Code is</span>
<a href="#l105.22"></a><span id="l105.22" class="difflineminus">- * Netscape Communications Corporation.</span>
<a href="#l105.23"></a><span id="l105.23" class="difflineminus">- * Portions created by the Initial Developer are Copyright (C) 1998-2001</span>
<a href="#l105.24"></a><span id="l105.24" class="difflineminus">- * the Initial Developer. All Rights Reserved.</span>
<a href="#l105.25"></a><span id="l105.25" class="difflineminus">- *</span>
<a href="#l105.26"></a><span id="l105.26" class="difflineminus">- * Contributor(s):</span>
<a href="#l105.27"></a><span id="l105.27" class="difflineminus">- *   Joe Hewitt (hewitt@netscape.com)</span>
<a href="#l105.28"></a><span id="l105.28" class="difflineminus">- *   Dean Tessman (dean_tessman@hotmail.com)</span>
<a href="#l105.29"></a><span id="l105.29" class="difflineminus">- *</span>
<a href="#l105.30"></a><span id="l105.30" class="difflineminus">- * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l105.31"></a><span id="l105.31" class="difflineminus">- * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l105.32"></a><span id="l105.32" class="difflineminus">- * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l105.33"></a><span id="l105.33" class="difflineminus">- * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l105.34"></a><span id="l105.34" class="difflineminus">- * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l105.35"></a><span id="l105.35" class="difflineminus">- * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l105.36"></a><span id="l105.36" class="difflineminus">- * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l105.37"></a><span id="l105.37" class="difflineminus">- * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l105.38"></a><span id="l105.38" class="difflineminus">- * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l105.39"></a><span id="l105.39" class="difflineminus">- * the provisions above, a recipient may use your version of this file under</span>
<a href="#l105.40"></a><span id="l105.40" class="difflineminus">- * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l105.41"></a><span id="l105.41" class="difflineminus">- *</span>
<a href="#l105.42"></a><span id="l105.42" class="difflineminus">- * ***** END LICENSE BLOCK ***** */</span>
<a href="#l105.43"></a><span id="l105.43" class="difflineminus">-</span>
<a href="#l105.44"></a><span id="l105.44" class="difflineminus">-/* ===== tree.css ===================================================</span>
<a href="#l105.45"></a><span id="l105.45" class="difflineminus">-  == Styles used by the XUL outline element.</span>
<a href="#l105.46"></a><span id="l105.46" class="difflineminus">-  ======================================================================= */</span>
<a href="#l105.47"></a><span id="l105.47" class="difflineminus">-</span>
<a href="#l105.48"></a><span id="l105.48" class="difflineminus">-@namespace url(&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;);</span>
<a href="#l105.49"></a><span id="l105.49" class="difflineminus">-</span>
<a href="#l105.50"></a><span id="l105.50" class="difflineminus">-/* ::::: tree ::::: */</span>
<a href="#l105.51"></a><span id="l105.51" class="difflineminus">-</span>
<a href="#l105.52"></a><span id="l105.52" class="difflineminus">-tree {</span>
<a href="#l105.53"></a><span id="l105.53" class="difflineminus">-  margin: 0px 4px;</span>
<a href="#l105.54"></a><span id="l105.54" class="difflineminus">-  border: 2px solid;</span>
<a href="#l105.55"></a><span id="l105.55" class="difflineminus">-  -moz-border-top-colors: ThreeDShadow ThreeDDarkShadow;</span>
<a href="#l105.56"></a><span id="l105.56" class="difflineminus">-  -moz-border-right-colors: ThreeDHighlight ThreeDLightShadow;</span>
<a href="#l105.57"></a><span id="l105.57" class="difflineminus">-  -moz-border-bottom-colors: ThreeDHighlight ThreeDLightShadow;</span>
<a href="#l105.58"></a><span id="l105.58" class="difflineminus">-  -moz-border-left-colors: ThreeDShadow ThreeDDarkShadow;</span>
<a href="#l105.59"></a><span id="l105.59" class="difflineminus">-  background-color: -moz-Field;</span>
<a href="#l105.60"></a><span id="l105.60" class="difflineminus">-  color: -moz-FieldText;</span>
<a href="#l105.61"></a><span id="l105.61" class="difflineminus">-  -moz-appearance: listbox;</span>
<a href="#l105.62"></a><span id="l105.62" class="difflineminus">-}</span>
<a href="#l105.63"></a><span id="l105.63" class="difflineminus">-</span>
<a href="#l105.64"></a><span id="l105.64" class="difflineminus">-/* ::::: tree rows ::::: */</span>
<a href="#l105.65"></a><span id="l105.65" class="difflineminus">-</span>
<a href="#l105.66"></a><span id="l105.66" class="difflineminus">-treechildren::-moz-tree-row {</span>
<a href="#l105.67"></a><span id="l105.67" class="difflineminus">-  border: 1px solid transparent;</span>
<a href="#l105.68"></a><span id="l105.68" class="difflineminus">-  background-color: transparent;</span>
<a href="#l105.69"></a><span id="l105.69" class="difflineminus">-  min-height: 18px;</span>
<a href="#l105.70"></a><span id="l105.70" class="difflineminus">-  height: 1.3em;</span>
<a href="#l105.71"></a><span id="l105.71" class="difflineminus">-}</span>
<a href="#l105.72"></a><span id="l105.72" class="difflineminus">-</span>
<a href="#l105.73"></a><span id="l105.73" class="difflineminus">-treechildren::-moz-tree-row(selected) {</span>
<a href="#l105.74"></a><span id="l105.74" class="difflineminus">-  background-color: -moz-Dialog;</span>
<a href="#l105.75"></a><span id="l105.75" class="difflineminus">-}</span>
<a href="#l105.76"></a><span id="l105.76" class="difflineminus">-</span>
<a href="#l105.77"></a><span id="l105.77" class="difflineminus">-treechildren::-moz-tree-row(selected, focus) {</span>
<a href="#l105.78"></a><span id="l105.78" class="difflineminus">-  background-color: Highlight;</span>
<a href="#l105.79"></a><span id="l105.79" class="difflineminus">-}</span>
<a href="#l105.80"></a><span id="l105.80" class="difflineminus">-</span>
<a href="#l105.81"></a><span id="l105.81" class="difflineminus">-treechildren::-moz-tree-row(current, focus) {</span>
<a href="#l105.82"></a><span id="l105.82" class="difflineminus">-  border: 1px dotted #000000;</span>
<a href="#l105.83"></a><span id="l105.83" class="difflineminus">-}</span>
<a href="#l105.84"></a><span id="l105.84" class="difflineminus">-</span>
<a href="#l105.85"></a><span id="l105.85" class="difflineminus">-treechildren::-moz-tree-row(selected, current, focus) {</span>
<a href="#l105.86"></a><span id="l105.86" class="difflineminus">-  border: 1px dotted #C0C0C0;</span>
<a href="#l105.87"></a><span id="l105.87" class="difflineminus">-}</span>
<a href="#l105.88"></a><span id="l105.88" class="difflineminus">-</span>
<a href="#l105.89"></a><span id="l105.89" class="difflineminus">-tree[seltype=&quot;cell&quot;] &gt; treechildren::-moz-tree-row,</span>
<a href="#l105.90"></a><span id="l105.90" class="difflineminus">-tree[seltype=&quot;text&quot;] &gt; treechildren::-moz-tree-row {</span>
<a href="#l105.91"></a><span id="l105.91" class="difflineminus">-  border: none;</span>
<a href="#l105.92"></a><span id="l105.92" class="difflineminus">-  background-color: transparent;</span>
<a href="#l105.93"></a><span id="l105.93" class="difflineminus">-}</span>
<a href="#l105.94"></a><span id="l105.94" class="difflineminus">-</span>
<a href="#l105.95"></a><span id="l105.95" class="difflineminus">-/* ::::: tree cells ::::: */</span>
<a href="#l105.96"></a><span id="l105.96" class="difflineminus">-</span>
<a href="#l105.97"></a><span id="l105.97" class="difflineminus">-treechildren::-moz-tree-cell {</span>
<a href="#l105.98"></a><span id="l105.98" class="difflineminus">-  padding: 0px 2px;</span>
<a href="#l105.99"></a><span id="l105.99" class="difflineminus">-}</span>
<a href="#l105.100"></a><span id="l105.100" class="difflineminus">-</span>
<a href="#l105.101"></a><span id="l105.101" class="difflineminus">-tree[seltype=&quot;cell&quot;] &gt; treechildren::-moz-tree-cell-text,</span>
<a href="#l105.102"></a><span id="l105.102" class="difflineminus">-tree[seltype=&quot;text&quot;] &gt; treechildren::-moz-tree-cell-text,</span>
<a href="#l105.103"></a><span id="l105.103" class="difflineminus">-treechildren::-moz-tree-cell-text {</span>
<a href="#l105.104"></a><span id="l105.104" class="difflineminus">-  color: inherit;</span>
<a href="#l105.105"></a><span id="l105.105" class="difflineminus">-}</span>
<a href="#l105.106"></a><span id="l105.106" class="difflineminus">-</span>
<a href="#l105.107"></a><span id="l105.107" class="difflineminus">-treechildren::-moz-tree-cell-text(selected) {</span>
<a href="#l105.108"></a><span id="l105.108" class="difflineminus">-  color: -moz-DialogText;</span>
<a href="#l105.109"></a><span id="l105.109" class="difflineminus">-}</span>
<a href="#l105.110"></a><span id="l105.110" class="difflineminus">-</span>
<a href="#l105.111"></a><span id="l105.111" class="difflineminus">-tree[seltype=&quot;cell&quot;] &gt; treechildren::-moz-tree-cell {</span>
<a href="#l105.112"></a><span id="l105.112" class="difflineminus">-  border: 1px solid transparent;</span>
<a href="#l105.113"></a><span id="l105.113" class="difflineminus">-  padding: 0px 1px;</span>
<a href="#l105.114"></a><span id="l105.114" class="difflineminus">-}</span>
<a href="#l105.115"></a><span id="l105.115" class="difflineminus">-</span>
<a href="#l105.116"></a><span id="l105.116" class="difflineminus">-tree[seltype=&quot;text&quot;] &gt; treechildren::-moz-tree-cell-text {</span>
<a href="#l105.117"></a><span id="l105.117" class="difflineminus">-  border: 1px solid transparent;</span>
<a href="#l105.118"></a><span id="l105.118" class="difflineminus">-  padding: 0px 1px 1px;</span>
<a href="#l105.119"></a><span id="l105.119" class="difflineminus">-}</span>
<a href="#l105.120"></a><span id="l105.120" class="difflineminus">-</span>
<a href="#l105.121"></a><span id="l105.121" class="difflineminus">-tree[seltype=&quot;cell&quot;] &gt; treechildren::-moz-tree-cell(active, selected) {</span>
<a href="#l105.122"></a><span id="l105.122" class="difflineminus">-  background-color: -moz-Dialog;</span>
<a href="#l105.123"></a><span id="l105.123" class="difflineminus">-}</span>
<a href="#l105.124"></a><span id="l105.124" class="difflineminus">-tree[seltype=&quot;cell&quot;] &gt; treechildren::-moz-tree-cell-text(active, selected) {</span>
<a href="#l105.125"></a><span id="l105.125" class="difflineminus">-  color: -moz-DialogText;</span>
<a href="#l105.126"></a><span id="l105.126" class="difflineminus">-}</span>
<a href="#l105.127"></a><span id="l105.127" class="difflineminus">-</span>
<a href="#l105.128"></a><span id="l105.128" class="difflineminus">-tree[seltype=&quot;text&quot;] &gt; treechildren::-moz-tree-cell-text(active, selected) {</span>
<a href="#l105.129"></a><span id="l105.129" class="difflineminus">-  background-color: -moz-Dialog;</span>
<a href="#l105.130"></a><span id="l105.130" class="difflineminus">-  color: -moz-DialogText;</span>
<a href="#l105.131"></a><span id="l105.131" class="difflineminus">-}</span>
<a href="#l105.132"></a><span id="l105.132" class="difflineminus">-</span>
<a href="#l105.133"></a><span id="l105.133" class="difflineminus">-treechildren::-moz-tree-cell-text(selected, focus) {</span>
<a href="#l105.134"></a><span id="l105.134" class="difflineminus">-  color: HighlightText;</span>
<a href="#l105.135"></a><span id="l105.135" class="difflineminus">-}</span>
<a href="#l105.136"></a><span id="l105.136" class="difflineminus">-</span>
<a href="#l105.137"></a><span id="l105.137" class="difflineminus">-tree[seltype=&quot;cell&quot;] &gt; treechildren::-moz-tree-cell(active, selected, focus) {</span>
<a href="#l105.138"></a><span id="l105.138" class="difflineminus">-  background-color: Highlight;</span>
<a href="#l105.139"></a><span id="l105.139" class="difflineminus">-}</span>
<a href="#l105.140"></a><span id="l105.140" class="difflineminus">-tree[seltype=&quot;cell&quot;] &gt; treechildren::-moz-tree-cell-text(active, selected, focus) {</span>
<a href="#l105.141"></a><span id="l105.141" class="difflineminus">-  color: HighlightText;</span>
<a href="#l105.142"></a><span id="l105.142" class="difflineminus">-}</span>
<a href="#l105.143"></a><span id="l105.143" class="difflineminus">-</span>
<a href="#l105.144"></a><span id="l105.144" class="difflineminus">-tree[seltype=&quot;text&quot;] &gt; treechildren::-moz-tree-cell-text(active, selected, focus) {</span>
<a href="#l105.145"></a><span id="l105.145" class="difflineminus">-  background-color: Highlight;</span>
<a href="#l105.146"></a><span id="l105.146" class="difflineminus">-  color: HighlightText;</span>
<a href="#l105.147"></a><span id="l105.147" class="difflineminus">-}</span>
<a href="#l105.148"></a><span id="l105.148" class="difflineminus">-</span>
<a href="#l105.149"></a><span id="l105.149" class="difflineminus">-tree[seltype=&quot;cell&quot;] &gt; treechildren::-moz-tree-cell(active, current, focus) {</span>
<a href="#l105.150"></a><span id="l105.150" class="difflineminus">-  border: 1px dotted #000000;</span>
<a href="#l105.151"></a><span id="l105.151" class="difflineminus">-}</span>
<a href="#l105.152"></a><span id="l105.152" class="difflineminus">-</span>
<a href="#l105.153"></a><span id="l105.153" class="difflineminus">-tree[seltype=&quot;text&quot;] &gt; treechildren::-moz-tree-cell-text(active, current, focus) {</span>
<a href="#l105.154"></a><span id="l105.154" class="difflineminus">-  border: 1px dotted #000000;</span>
<a href="#l105.155"></a><span id="l105.155" class="difflineminus">-}</span>
<a href="#l105.156"></a><span id="l105.156" class="difflineminus">-</span>
<a href="#l105.157"></a><span id="l105.157" class="difflineminus">-tree[seltype=&quot;cell&quot;] &gt; treechildren::-moz-tree-cell(active, selected, current, focus) {</span>
<a href="#l105.158"></a><span id="l105.158" class="difflineminus">-  border: 1px dotted #C0C0C0;</span>
<a href="#l105.159"></a><span id="l105.159" class="difflineminus">-}</span>
<a href="#l105.160"></a><span id="l105.160" class="difflineminus">-</span>
<a href="#l105.161"></a><span id="l105.161" class="difflineminus">-tree[seltype=&quot;text&quot;] &gt; treechildren::-moz-tree-cell-text(active, selected, current, focus) {</span>
<a href="#l105.162"></a><span id="l105.162" class="difflineminus">-  border: 1px dotted #C0C0C0;</span>
<a href="#l105.163"></a><span id="l105.163" class="difflineminus">-}</span>
<a href="#l105.164"></a><span id="l105.164" class="difflineminus">-</span>
<a href="#l105.165"></a><span id="l105.165" class="difflineminus">-</span>
<a href="#l105.166"></a><span id="l105.166" class="difflineminus">-/* ::::: lines connecting cells ::::: */</span>
<a href="#l105.167"></a><span id="l105.167" class="difflineminus">-</span>
<a href="#l105.168"></a><span id="l105.168" class="difflineminus">-tree[seltype=&quot;cell&quot;] &gt; treechildren::-moz-tree-line,</span>
<a href="#l105.169"></a><span id="l105.169" class="difflineminus">-tree[seltype=&quot;text&quot;] &gt; treechildren::-moz-tree-line,</span>
<a href="#l105.170"></a><span id="l105.170" class="difflineminus">-treechildren::-moz-tree-line {</span>
<a href="#l105.171"></a><span id="l105.171" class="difflineminus">-  border: 1px dotted ThreeDShadow;</span>
<a href="#l105.172"></a><span id="l105.172" class="difflineminus">-}</span>
<a href="#l105.173"></a><span id="l105.173" class="difflineminus">-</span>
<a href="#l105.174"></a><span id="l105.174" class="difflineminus">-tree[seltype=&quot;cell&quot;] &gt; treechildren::-moz-tree-line(active, selected, focus),</span>
<a href="#l105.175"></a><span id="l105.175" class="difflineminus">-treechildren::-moz-tree-line(selected, focus) {</span>
<a href="#l105.176"></a><span id="l105.176" class="difflineminus">-  border: 1px dotted HighlightText;</span>
<a href="#l105.177"></a><span id="l105.177" class="difflineminus">-}</span>
<a href="#l105.178"></a><span id="l105.178" class="difflineminus">-</span>
<a href="#l105.179"></a><span id="l105.179" class="difflineminus">-</span>
<a href="#l105.180"></a><span id="l105.180" class="difflineminus">-/* ::::: tree separator ::::: */</span>
<a href="#l105.181"></a><span id="l105.181" class="difflineminus">-</span>
<a href="#l105.182"></a><span id="l105.182" class="difflineminus">-treechildren::-moz-tree-separator {</span>
<a href="#l105.183"></a><span id="l105.183" class="difflineminus">-  border-top: 1px solid ThreeDShadow;</span>
<a href="#l105.184"></a><span id="l105.184" class="difflineminus">-  border-bottom: 1px solid ThreeDHighlight;</span>
<a href="#l105.185"></a><span id="l105.185" class="difflineminus">-}</span>
<a href="#l105.186"></a><span id="l105.186" class="difflineminus">-</span>
<a href="#l105.187"></a><span id="l105.187" class="difflineminus">-</span>
<a href="#l105.188"></a><span id="l105.188" class="difflineminus">-/* ::::: drop feedback ::::: */</span>
<a href="#l105.189"></a><span id="l105.189" class="difflineminus">-</span>
<a href="#l105.190"></a><span id="l105.190" class="difflineminus">-tree[seltype=&quot;cell&quot;] &gt; treechildren::-moz-tree-cell-text(primary, dropOn),</span>
<a href="#l105.191"></a><span id="l105.191" class="difflineminus">-tree[seltype=&quot;text&quot;] &gt; treechildren::-moz-tree-cell-text(primary, dropOn),</span>
<a href="#l105.192"></a><span id="l105.192" class="difflineminus">-treechildren::-moz-tree-cell-text(primary, dropOn) {</span>
<a href="#l105.193"></a><span id="l105.193" class="difflineminus">-  background-color: Highlight;</span>
<a href="#l105.194"></a><span id="l105.194" class="difflineminus">-  color: HighlightText;</span>
<a href="#l105.195"></a><span id="l105.195" class="difflineminus">-}</span>
<a href="#l105.196"></a><span id="l105.196" class="difflineminus">-</span>
<a href="#l105.197"></a><span id="l105.197" class="difflineminus">-treechildren::-moz-tree-drop-feedback {</span>
<a href="#l105.198"></a><span id="l105.198" class="difflineminus">-  background-color: Highlight;</span>
<a href="#l105.199"></a><span id="l105.199" class="difflineminus">-  width: 50px;</span>
<a href="#l105.200"></a><span id="l105.200" class="difflineminus">-  height: 2px;</span>
<a href="#l105.201"></a><span id="l105.201" class="difflineminus">-  -moz-margin-start: 5px;</span>
<a href="#l105.202"></a><span id="l105.202" class="difflineminus">-}</span>
<a href="#l105.203"></a><span id="l105.203" class="difflineminus">-</span>
<a href="#l105.204"></a><span id="l105.204" class="difflineminus">-/* ::::: tree progress meter ::::: */</span>
<a href="#l105.205"></a><span id="l105.205" class="difflineminus">-</span>
<a href="#l105.206"></a><span id="l105.206" class="difflineminus">-treechildren::-moz-tree-progressmeter {</span>
<a href="#l105.207"></a><span id="l105.207" class="difflineminus">-  margin: 2px 4px;</span>
<a href="#l105.208"></a><span id="l105.208" class="difflineminus">-  border: 2px solid;</span>
<a href="#l105.209"></a><span id="l105.209" class="difflineminus">-  -moz-border-top-colors: ThreeDShadow -moz-Dialog;</span>
<a href="#l105.210"></a><span id="l105.210" class="difflineminus">-  -moz-border-right-colors: ThreeDHighlight -moz-Dialog;</span>
<a href="#l105.211"></a><span id="l105.211" class="difflineminus">-  -moz-border-bottom-colors: ThreeDHighlight -moz-Dialog;</span>
<a href="#l105.212"></a><span id="l105.212" class="difflineminus">-  -moz-border-left-colors: ThreeDShadow -moz-Dialog;</span>
<a href="#l105.213"></a><span id="l105.213" class="difflineminus">-  background-color: -moz-Dialog;</span>
<a href="#l105.214"></a><span id="l105.214" class="difflineminus">-  color: ThreeDShadow;</span>
<a href="#l105.215"></a><span id="l105.215" class="difflineminus">-}</span>
<a href="#l105.216"></a><span id="l105.216" class="difflineminus">-</span>
<a href="#l105.217"></a><span id="l105.217" class="difflineminus">-treechildren::-moz-tree-progressmeter(progressUndetermined) {</span>
<a href="#l105.218"></a><span id="l105.218" class="difflineminus">-  list-style-image: url(&quot;chrome://global/skin/progressmeter/progressmeter-busy.gif&quot;);</span>
<a href="#l105.219"></a><span id="l105.219" class="difflineminus">-}</span>
<a href="#l105.220"></a><span id="l105.220" class="difflineminus">-</span>
<a href="#l105.221"></a><span id="l105.221" class="difflineminus">-treechildren::-moz-tree-cell-text(progressmeter) {</span>
<a href="#l105.222"></a><span id="l105.222" class="difflineminus">-  margin: 2px 4px;</span>
<a href="#l105.223"></a><span id="l105.223" class="difflineminus">-}</span>
<a href="#l105.224"></a><span id="l105.224" class="difflineminus">-</span>
<a href="#l105.225"></a><span id="l105.225" class="difflineminus">-/* ::::: tree columns ::::: */</span>
<a href="#l105.226"></a><span id="l105.226" class="difflineminus">-</span>
<a href="#l105.227"></a><span id="l105.227" class="difflineminus">-treecol,</span>
<a href="#l105.228"></a><span id="l105.228" class="difflineminus">-treecolpicker { </span>
<a href="#l105.229"></a><span id="l105.229" class="difflineminus">-  -moz-appearance: treeheadercell;</span>
<a href="#l105.230"></a><span id="l105.230" class="difflineminus">-  -moz-box-align: center;</span>
<a href="#l105.231"></a><span id="l105.231" class="difflineminus">-  -moz-box-pack: center;</span>
<a href="#l105.232"></a><span id="l105.232" class="difflineminus">-  border: 2px solid;</span>
<a href="#l105.233"></a><span id="l105.233" class="difflineminus">-  -moz-border-top-colors: ThreeDHighlight ThreeDLightShadow;</span>
<a href="#l105.234"></a><span id="l105.234" class="difflineminus">-  -moz-border-right-colors: ThreeDDarkShadow ThreeDShadow;</span>
<a href="#l105.235"></a><span id="l105.235" class="difflineminus">-  -moz-border-bottom-colors: ThreeDDarkShadow ThreeDShadow;</span>
<a href="#l105.236"></a><span id="l105.236" class="difflineminus">-  -moz-border-left-colors: ThreeDHighlight ThreeDLightShadow;</span>
<a href="#l105.237"></a><span id="l105.237" class="difflineminus">-  background-color: -moz-Dialog;</span>
<a href="#l105.238"></a><span id="l105.238" class="difflineminus">-  color: -moz-DialogText;</span>
<a href="#l105.239"></a><span id="l105.239" class="difflineminus">-  padding-top: 1px;</span>
<a href="#l105.240"></a><span id="l105.240" class="difflineminus">-  padding-bottom: 0px;</span>
<a href="#l105.241"></a><span id="l105.241" class="difflineminus">-  -moz-padding-start: 5px;</span>
<a href="#l105.242"></a><span id="l105.242" class="difflineminus">-  -moz-padding-end: 4px;</span>
<a href="#l105.243"></a><span id="l105.243" class="difflineminus">-}</span>
<a href="#l105.244"></a><span id="l105.244" class="difflineminus">-</span>
<a href="#l105.245"></a><span id="l105.245" class="difflineminus">-.treecol-image {</span>
<a href="#l105.246"></a><span id="l105.246" class="difflineminus">-  padding-top: 1px;</span>
<a href="#l105.247"></a><span id="l105.247" class="difflineminus">-  padding-bottom: 0px;</span>
<a href="#l105.248"></a><span id="l105.248" class="difflineminus">-  -moz-padding-start: 2px;</span>
<a href="#l105.249"></a><span id="l105.249" class="difflineminus">-  -moz-padding-end: 1px;</span>
<a href="#l105.250"></a><span id="l105.250" class="difflineminus">-}</span>
<a href="#l105.251"></a><span id="l105.251" class="difflineminus">-</span>
<a href="#l105.252"></a><span id="l105.252" class="difflineminus">-.treecol-text {</span>
<a href="#l105.253"></a><span id="l105.253" class="difflineminus">-  margin: 0px !important;</span>
<a href="#l105.254"></a><span id="l105.254" class="difflineminus">-}</span>
<a href="#l105.255"></a><span id="l105.255" class="difflineminus">-</span>
<a href="#l105.256"></a><span id="l105.256" class="difflineminus">-treecol[hideheader=&quot;true&quot;] {</span>
<a href="#l105.257"></a><span id="l105.257" class="difflineminus">-  -moz-appearance: none;</span>
<a href="#l105.258"></a><span id="l105.258" class="difflineminus">-  border: none;</span>
<a href="#l105.259"></a><span id="l105.259" class="difflineminus">-  padding: 0;</span>
<a href="#l105.260"></a><span id="l105.260" class="difflineminus">-}</span>
<a href="#l105.261"></a><span id="l105.261" class="difflineminus">-</span>
<a href="#l105.262"></a><span id="l105.262" class="difflineminus">-/* ..... internal box ..... */</span>
<a href="#l105.263"></a><span id="l105.263" class="difflineminus">-</span>
<a href="#l105.264"></a><span id="l105.264" class="difflineminus">-treecol:hover:active,</span>
<a href="#l105.265"></a><span id="l105.265" class="difflineminus">-treecolpicker:hover:active {</span>
<a href="#l105.266"></a><span id="l105.266" class="difflineminus">-  border-top: 2px solid;</span>
<a href="#l105.267"></a><span id="l105.267" class="difflineminus">-  border-right: 1px solid;</span>
<a href="#l105.268"></a><span id="l105.268" class="difflineminus">-  border-bottom: 1px solid;</span>
<a href="#l105.269"></a><span id="l105.269" class="difflineminus">-  border-left: 2px solid;</span>
<a href="#l105.270"></a><span id="l105.270" class="difflineminus">-  -moz-border-top-colors: ThreeDShadow -moz-Dialog;</span>
<a href="#l105.271"></a><span id="l105.271" class="difflineminus">-  -moz-border-right-colors: ThreeDShadow;</span>
<a href="#l105.272"></a><span id="l105.272" class="difflineminus">-  -moz-border-bottom-colors: ThreeDShadow;</span>
<a href="#l105.273"></a><span id="l105.273" class="difflineminus">-  -moz-border-left-colors: ThreeDShadow -moz-Dialog;</span>
<a href="#l105.274"></a><span id="l105.274" class="difflineminus">-}</span>
<a href="#l105.275"></a><span id="l105.275" class="difflineminus">-</span>
<a href="#l105.276"></a><span id="l105.276" class="difflineminus">-</span>
<a href="#l105.277"></a><span id="l105.277" class="difflineminus">-/* ::::: column drag and drop styles ::::: */</span>
<a href="#l105.278"></a><span id="l105.278" class="difflineminus">-</span>
<a href="#l105.279"></a><span id="l105.279" class="difflineminus">-treecol[dragging=&quot;true&quot;] {</span>
<a href="#l105.280"></a><span id="l105.280" class="difflineminus">-  -moz-border-top-colors: ThreeDDarkShadow transparent !important;</span>
<a href="#l105.281"></a><span id="l105.281" class="difflineminus">-  -moz-border-right-colors: ThreeDDarkShadow transparent!important;</span>
<a href="#l105.282"></a><span id="l105.282" class="difflineminus">-  -moz-border-bottom-colors: ThreeDDarkShadow transparent !important;</span>
<a href="#l105.283"></a><span id="l105.283" class="difflineminus">-  -moz-border-left-colors: ThreeDDarkShadow transparent !important;</span>
<a href="#l105.284"></a><span id="l105.284" class="difflineminus">-  background-color: ThreeDShadow !important;</span>
<a href="#l105.285"></a><span id="l105.285" class="difflineminus">-  color: ThreeDHighlight !important;</span>
<a href="#l105.286"></a><span id="l105.286" class="difflineminus">-}</span>
<a href="#l105.287"></a><span id="l105.287" class="difflineminus">-</span>
<a href="#l105.288"></a><span id="l105.288" class="difflineminus">-treecol[insertafter=&quot;true&quot;] {</span>
<a href="#l105.289"></a><span id="l105.289" class="difflineminus">-  -moz-border-right-colors: ThreeDDarkShadow ThreeDShadow;</span>
<a href="#l105.290"></a><span id="l105.290" class="difflineminus">-}</span>
<a href="#l105.291"></a><span id="l105.291" class="difflineminus">-</span>
<a href="#l105.292"></a><span id="l105.292" class="difflineminus">-treecol[insertbefore=&quot;true&quot;] {</span>
<a href="#l105.293"></a><span id="l105.293" class="difflineminus">-  -moz-border-left-colors: ThreeDDarkShadow ThreeDShadow;</span>
<a href="#l105.294"></a><span id="l105.294" class="difflineminus">-}</span>
<a href="#l105.295"></a><span id="l105.295" class="difflineminus">-</span>
<a href="#l105.296"></a><span id="l105.296" class="difflineminus">-treechildren::-moz-tree-column(insertbefore) {</span>
<a href="#l105.297"></a><span id="l105.297" class="difflineminus">-  border-left: 1px solid ThreeDShadow;</span>
<a href="#l105.298"></a><span id="l105.298" class="difflineminus">-}</span>
<a href="#l105.299"></a><span id="l105.299" class="difflineminus">-</span>
<a href="#l105.300"></a><span id="l105.300" class="difflineminus">-treechildren::-moz-tree-column(insertafter) {</span>
<a href="#l105.301"></a><span id="l105.301" class="difflineminus">-  border-right: 1px solid ThreeDShadow;</span>
<a href="#l105.302"></a><span id="l105.302" class="difflineminus">-}</span>
<a href="#l105.303"></a><span id="l105.303" class="difflineminus">-</span>
<a href="#l105.304"></a><span id="l105.304" class="difflineminus">-/* ::::: sort direction indicator :::::  */</span>
<a href="#l105.305"></a><span id="l105.305" class="difflineminus">-</span>
<a href="#l105.306"></a><span id="l105.306" class="difflineminus">-.treecol-sortdirection {</span>
<a href="#l105.307"></a><span id="l105.307" class="difflineminus">-  list-style-image: none;</span>
<a href="#l105.308"></a><span id="l105.308" class="difflineminus">-  width: 8px;  /* The image's width is 7 pixels */</span>
<a href="#l105.309"></a><span id="l105.309" class="difflineminus">-}</span>
<a href="#l105.310"></a><span id="l105.310" class="difflineminus">-</span>
<a href="#l105.311"></a><span id="l105.311" class="difflineminus">-.treecol-sortdirection[sortDirection=&quot;ascending&quot;] {</span>
<a href="#l105.312"></a><span id="l105.312" class="difflineminus">-  list-style-image: url(&quot;chrome://global/skin/tree/sort-asc.gif&quot;);</span>
<a href="#l105.313"></a><span id="l105.313" class="difflineminus">-}</span>
<a href="#l105.314"></a><span id="l105.314" class="difflineminus">-</span>
<a href="#l105.315"></a><span id="l105.315" class="difflineminus">-.treecol-sortdirection[sortDirection=&quot;descending&quot;] {</span>
<a href="#l105.316"></a><span id="l105.316" class="difflineminus">-  list-style-image: url(&quot;chrome://global/skin/tree/sort-dsc.gif&quot;);</span>
<a href="#l105.317"></a><span id="l105.317" class="difflineminus">-}</span>
<a href="#l105.318"></a><span id="l105.318" class="difflineminus">-</span>
<a href="#l105.319"></a><span id="l105.319" class="difflineminus">-/* ::::: column picker :::::  */</span>
<a href="#l105.320"></a><span id="l105.320" class="difflineminus">-</span>
<a href="#l105.321"></a><span id="l105.321" class="difflineminus">-.tree-columnpicker-icon {</span>
<a href="#l105.322"></a><span id="l105.322" class="difflineminus">-  list-style-image: url(&quot;chrome://global/skin/tree/columnpicker.gif&quot;);</span>
<a href="#l105.323"></a><span id="l105.323" class="difflineminus">-}</span>
<a href="#l105.324"></a><span id="l105.324" class="difflineminus">-</span>
<a href="#l105.325"></a><span id="l105.325" class="difflineminus">-/* ::::: twisty :::::  */</span>
<a href="#l105.326"></a><span id="l105.326" class="difflineminus">-</span>
<a href="#l105.327"></a><span id="l105.327" class="difflineminus">-treechildren::-moz-tree-twisty {</span>
<a href="#l105.328"></a><span id="l105.328" class="difflineminus">-  -moz-padding-end: 2px;</span>
<a href="#l105.329"></a><span id="l105.329" class="difflineminus">-  width: 10px; /* The image's width is 9 pixels */</span>
<a href="#l105.330"></a><span id="l105.330" class="difflineminus">-  list-style-image: url(&quot;chrome://global/skin/tree/twisty-clsd.png&quot;);</span>
<a href="#l105.331"></a><span id="l105.331" class="difflineminus">-}</span>
<a href="#l105.332"></a><span id="l105.332" class="difflineminus">-</span>
<a href="#l105.333"></a><span id="l105.333" class="difflineminus">-treechildren::-moz-tree-twisty(open) {</span>
<a href="#l105.334"></a><span id="l105.334" class="difflineminus">-  width: 10px; /* The image's width is 9 pixels */</span>
<a href="#l105.335"></a><span id="l105.335" class="difflineminus">-  list-style-image: url(&quot;chrome://global/skin/tree/twisty-open.png&quot;);</span>
<a href="#l105.336"></a><span id="l105.336" class="difflineminus">-}</span>
<a href="#l105.337"></a><span id="l105.337" class="difflineminus">-</span>
<a href="#l105.338"></a><span id="l105.338" class="difflineminus">-treechildren::-moz-tree-indentation {</span>
<a href="#l105.339"></a><span id="l105.339" class="difflineminus">-  width: 16px;</span>
<a href="#l105.340"></a><span id="l105.340" class="difflineminus">-}</span>
<a href="#l105.341"></a><span id="l105.341" class="difflineminus">-</span>
<a href="#l105.342"></a><span id="l105.342" class="difflineminus">-/* ::::: gridline style ::::: */</span>
<a href="#l105.343"></a><span id="l105.343" class="difflineminus">-</span>
<a href="#l105.344"></a><span id="l105.344" class="difflineminus">-treechildren.gridlines::-moz-tree-cell {</span>
<a href="#l105.345"></a><span id="l105.345" class="difflineminus">-  border-right: 1px solid GrayText;</span>
<a href="#l105.346"></a><span id="l105.346" class="difflineminus">-  border-bottom: 1px solid GrayText;</span>
<a href="#l105.347"></a><span id="l105.347" class="difflineminus">-}</span>
<a href="#l105.348"></a><span id="l105.348" class="difflineminus">-</span>
<a href="#l105.349"></a><span id="l105.349" class="difflineminus">-treechildren.gridlines::-moz-tree-row {</span>
<a href="#l105.350"></a><span id="l105.350" class="difflineminus">-  border: none;</span>
<a href="#l105.351"></a><span id="l105.351" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l106.1"></a><span id="l106.1">new file mode 100644</span>
<a href="#l106.2"></a><span id="l106.2" class="difflineminus">--- /dev/null</span>
<a href="#l106.3"></a><span id="l106.3" class="difflineplus">+++ b/mailnews/addrbook/test/unit/tail_addrbook.js</span>
<a href="#l106.4"></a><span id="l106.4" class="difflineat">@@ -0,0 +1,1 @@</span>
<a href="#l106.5"></a><span id="l106.5" class="difflineplus">+load(&quot;../../mailnews/resources/mailShutdown.js&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l107.1"></a><span id="l107.1" class="difflineminus">--- a/mailnews/base/prefs/resources/content/AccountManager.js</span>
<a href="#l107.2"></a><span id="l107.2" class="difflineplus">+++ b/mailnews/base/prefs/resources/content/AccountManager.js</span>
<a href="#l107.3"></a><span id="l107.3" class="difflineat">@@ -326,17 +326,17 @@ function checkUserServerChanges(showAler</span>
<a href="#l107.4"></a><span id="l107.4"> </span>
<a href="#l107.5"></a><span id="l107.5">     // If username is changed remind users to change Your Name and Email Address.</span>
<a href="#l107.6"></a><span id="l107.6">     // If serve name is changed and has defined filters then remind users to edit rules.</span>
<a href="#l107.7"></a><span id="l107.7">     if (showAlert) {</span>
<a href="#l107.8"></a><span id="l107.8">       var account = currentAccount</span>
<a href="#l107.9"></a><span id="l107.9">       var filterList;</span>
<a href="#l107.10"></a><span id="l107.10">       if (account &amp;&amp; (newType != &quot;nntp&quot;)) {</span>
<a href="#l107.11"></a><span id="l107.11">         var server = account.incomingServer;</span>
<a href="#l107.12"></a><span id="l107.12" class="difflineminus">-        filterList = server.getFilterList(null);</span>
<a href="#l107.13"></a><span id="l107.13" class="difflineplus">+        filterList = server.getEditableFilterList(null);</span>
<a href="#l107.14"></a><span id="l107.14">       }</span>
<a href="#l107.15"></a><span id="l107.15">       var userChangeText, serverChangeText;</span>
<a href="#l107.16"></a><span id="l107.16">       var bundle = document.getElementById(&quot;bundle_prefs&quot;);</span>
<a href="#l107.17"></a><span id="l107.17">       if ( (oldHost != newHost) &amp;&amp; (filterList != undefined) &amp;&amp; filterList.filterCount )</span>
<a href="#l107.18"></a><span id="l107.18">         serverChangeText = bundle.getString(&quot;serverNameChanged&quot;);</span>
<a href="#l107.19"></a><span id="l107.19">       if (oldUser != newUser)</span>
<a href="#l107.20"></a><span id="l107.20">         userChangeText = bundle.getString(&quot;userNameChanged&quot;);</span>
<a href="#l107.21"></a><span id="l107.21"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l108.1"></a><span id="l108.1" class="difflineminus">--- a/mailnews/base/prefs/resources/content/accountcreation/emailWizard.xul</span>
<a href="#l108.2"></a><span id="l108.2" class="difflineplus">+++ b/mailnews/base/prefs/resources/content/accountcreation/emailWizard.xul</span>
<a href="#l108.3"></a><span id="l108.3" class="difflineat">@@ -180,17 +180,17 @@</span>
<a href="#l108.4"></a><span id="l108.4">             &lt;/rows&gt;</span>
<a href="#l108.5"></a><span id="l108.5">           &lt;/grid&gt;</span>
<a href="#l108.6"></a><span id="l108.6">           &lt;vbox&gt;</span>
<a href="#l108.7"></a><span id="l108.7">             &lt;groupbox id=&quot;settingsbox&quot; class=&quot;settings&quot; hidden=&quot;true&quot;&gt;</span>
<a href="#l108.8"></a><span id="l108.8">               &lt;vbox&gt;</span>
<a href="#l108.9"></a><span id="l108.9">                 &lt;vbox id=&quot;configarea&quot;&gt;</span>
<a href="#l108.10"></a><span id="l108.10">                   &lt;hbox&gt;</span>
<a href="#l108.11"></a><span id="l108.11">                     &lt;hbox flex=&quot;1&quot;&gt;</span>
<a href="#l108.12"></a><span id="l108.12" class="difflineminus">-                      &lt;description id=&quot;config_status_title&quot;/&gt;</span>
<a href="#l108.13"></a><span id="l108.13" class="difflineplus">+                      &lt;description id=&quot;config_status_title&quot; flex=&quot;1&quot;/&gt;</span>
<a href="#l108.14"></a><span id="l108.14">                     &lt;/hbox&gt;</span>
<a href="#l108.15"></a><span id="l108.15">                     &lt;hbox pack=&quot;end&quot;&gt;</span>
<a href="#l108.16"></a><span id="l108.16">                       &lt;button id=&quot;stop_button&quot;</span>
<a href="#l108.17"></a><span id="l108.17">                               oncommand=&quot;gEmailConfigWizard.onStop();&quot;</span>
<a href="#l108.18"></a><span id="l108.18">                               label=&quot;&amp;stop.label;&quot; class=&quot;smaller-button&quot;/&gt;</span>
<a href="#l108.19"></a><span id="l108.19">                       &lt;button id=&quot;edit_button&quot;</span>
<a href="#l108.20"></a><span id="l108.20">                               oncommand=&quot;gEmailConfigWizard.onEdit();&quot;</span>
<a href="#l108.21"></a><span id="l108.21">                               label=&quot;&amp;edit.label;&quot; class=&quot;smaller-button&quot;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l109.1"></a><span id="l109.1" class="difflineminus">--- a/mailnews/base/prefs/resources/content/am-offline.js</span>
<a href="#l109.2"></a><span id="l109.2" class="difflineplus">+++ b/mailnews/base/prefs/resources/content/am-offline.js</span>
<a href="#l109.3"></a><span id="l109.3" class="difflineat">@@ -128,18 +128,16 @@ function onPreInit(account, accountValue</span>
<a href="#l109.4"></a><span id="l109.4">     if (gServerType == &quot;pop3&quot;)</span>
<a href="#l109.5"></a><span id="l109.5">     {</span>
<a href="#l109.6"></a><span id="l109.6">       var pop3Server = gIncomingServer.QueryInterface(Components.interfaces.nsIPop3IncomingServer);</span>
<a href="#l109.7"></a><span id="l109.7">       // hide retention settings for deferred accounts</span>
<a href="#l109.8"></a><span id="l109.8">       if (pop3Server.deferredToAccount.length)</span>
<a href="#l109.9"></a><span id="l109.9">       {</span>
<a href="#l109.10"></a><span id="l109.10">         var retentionRadio = document.getElementById(&quot;retention.keepMsg&quot;);</span>
<a href="#l109.11"></a><span id="l109.11">         retentionRadio.setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l109.12"></a><span id="l109.12" class="difflineminus">-        var retentionCheckbox = document.getElementById(&quot;retention.keepUnread&quot;);</span>
<a href="#l109.13"></a><span id="l109.13" class="difflineminus">-        retentionCheckbox.setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l109.14"></a><span id="l109.14">         var retentionLabel = document.getElementById(&quot;retentionDescriptionPop&quot;);</span>
<a href="#l109.15"></a><span id="l109.15">         retentionLabel.setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l109.16"></a><span id="l109.16">         var applyToFlaggedCheckbox = document.getElementById(&quot;retention.applyToFlagged&quot;);</span>
<a href="#l109.17"></a><span id="l109.17">         applyToFlaggedCheckbox.setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l109.18"></a><span id="l109.18">       }</span>
<a href="#l109.19"></a><span id="l109.19">     }</span>
<a href="#l109.20"></a><span id="l109.20"> }</span>
<a href="#l109.21"></a><span id="l109.21"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l110.1"></a><span id="l110.1" class="difflineminus">--- a/mailnews/base/prefs/resources/content/am-offline.xul</span>
<a href="#l110.2"></a><span id="l110.2" class="difflineplus">+++ b/mailnews/base/prefs/resources/content/am-offline.xul</span>
<a href="#l110.3"></a><span id="l110.3" class="difflineat">@@ -116,18 +116,18 @@</span>
<a href="#l110.4"></a><span id="l110.4">     &lt;label id=&quot;retentionDescription&quot; hidefor=&quot;imap,pop3&quot; class=&quot;desc&quot; control=&quot;retention.keepMsg&quot;&gt;&amp;retentionCleanup.label;&lt;/label&gt;</span>
<a href="#l110.5"></a><span id="l110.5">     &lt;label id=&quot;retentionDescriptionImap&quot; hidefor=&quot;movemail,pop3,nntp,none,rss&quot; class=&quot;desc&quot; control=&quot;retention.keepMsg&quot;&gt;&amp;retentionCleanupImap.label;&lt;/label&gt;</span>
<a href="#l110.6"></a><span id="l110.6">     &lt;label id=&quot;retentionDescriptionPop&quot; hidefor=&quot;movemail,imap,nntp,none,rss&quot; class=&quot;desc&quot; control=&quot;retention.keepMsg&quot;&gt;&amp;retentionCleanupPop.label;&lt;/label&gt;</span>
<a href="#l110.7"></a><span id="l110.7"> </span>
<a href="#l110.8"></a><span id="l110.8">     &lt;radiogroup wsm_persist=&quot;true&quot; hidefor=&quot;&quot; id=&quot;retention.keepMsg&quot; class=&quot;indent&quot;&gt;</span>
<a href="#l110.9"></a><span id="l110.9">         &lt;radio wsm_persist=&quot;true&quot; id=&quot;retention.keepAllMsg&quot; value=&quot;1&quot; accesskey=&quot;&amp;retentionKeepAll.accesskey;&quot;</span>
<a href="#l110.10"></a><span id="l110.10">             label=&quot;&amp;retentionKeepAll.label;&quot; oncommand=&quot;onCheckKeepMsg();&quot;/&gt;</span>
<a href="#l110.11"></a><span id="l110.11">         &lt;hbox flex=&quot;1&quot; align=&quot;center&quot;&gt;</span>
<a href="#l110.12"></a><span id="l110.12" class="difflineminus">-            &lt;radio wsm_persist=&quot;true&quot; id=&quot;retention.keepNewMsg&quot; accesskey=&quot;&amp;retentionKeepNew.accesskey;&quot; </span>
<a href="#l110.13"></a><span id="l110.13" class="difflineminus">-                value=&quot;3&quot; label=&quot;&amp;retentionKeepNew.label;&quot; oncommand=&quot;onCheckKeepMsg();&quot;/&gt;</span>
<a href="#l110.14"></a><span id="l110.14" class="difflineplus">+            &lt;radio wsm_persist=&quot;true&quot; id=&quot;retention.keepNewMsg&quot; accesskey=&quot;&amp;retentionKeepRecent.accesskey;&quot; </span>
<a href="#l110.15"></a><span id="l110.15" class="difflineplus">+                value=&quot;3&quot; label=&quot;&amp;retentionKeepRecent.label;&quot; oncommand=&quot;onCheckKeepMsg();&quot;/&gt;</span>
<a href="#l110.16"></a><span id="l110.16">             &lt;textbox wsm_persist=&quot;true&quot; id=&quot;retention.keepNewMsgMin&quot;</span>
<a href="#l110.17"></a><span id="l110.17">                      type=&quot;number&quot; min=&quot;1&quot; increment=&quot;10&quot; size=&quot;4&quot; value=&quot;2000&quot;</span>
<a href="#l110.18"></a><span id="l110.18">                      aria-labelledby=&quot;retention.keepNewMsg retention.keepNewMsgMin newMsgLabel&quot;/&gt;</span>
<a href="#l110.19"></a><span id="l110.19">             &lt;label value=&quot;&amp;message.label;&quot; control=&quot;retention.keepNewMsgMin&quot; id=&quot;newMsgLabel&quot;/&gt;</span>
<a href="#l110.20"></a><span id="l110.20">         &lt;/hbox&gt;</span>
<a href="#l110.21"></a><span id="l110.21">         &lt;hbox flex=&quot;1&quot; align=&quot;center&quot;&gt;</span>
<a href="#l110.22"></a><span id="l110.22">             &lt;radio wsm_persist=&quot;true&quot; id=&quot;retention.keepOldMsg&quot; accesskey=&quot;&amp;retentionKeepMsg.accesskey;&quot;</span>
<a href="#l110.23"></a><span id="l110.23">                 value=&quot;2&quot; label=&quot;&amp;retentionKeepMsg.label;&quot; oncommand=&quot;onCheckKeepMsg();&quot;/&gt;</span>
<a href="#l110.24"></a><span id="l110.24" class="difflineat">@@ -136,28 +136,28 @@</span>
<a href="#l110.25"></a><span id="l110.25">                      aria-labelledby=&quot;retention.keepOldMsg retention.keepOldMsgMin oldMsgLabel&quot;/&gt;</span>
<a href="#l110.26"></a><span id="l110.26">             &lt;label value=&quot;&amp;daysOld.label;&quot; control=&quot;retention.keepOldMsgMin&quot; id=&quot;oldMsgLabel&quot;/&gt;</span>
<a href="#l110.27"></a><span id="l110.27">         &lt;/hbox&gt;</span>
<a href="#l110.28"></a><span id="l110.28">     &lt;/radiogroup&gt;</span>
<a href="#l110.29"></a><span id="l110.29"> </span>
<a href="#l110.30"></a><span id="l110.30">     &lt;hbox align=&quot;center&quot; class=&quot;indent&quot;&gt;</span>
<a href="#l110.31"></a><span id="l110.31">       &lt;vbox&gt;</span>
<a href="#l110.32"></a><span id="l110.32">         &lt;checkbox id=&quot;retention.keepUnread&quot; wsm_persist=&quot;true&quot;</span>
<a href="#l110.33"></a><span id="l110.33" class="difflineminus">-                  label=&quot;&amp;retentionKeepUnread.label;&quot;</span>
<a href="#l110.34"></a><span id="l110.34" class="difflineminus">-                  accesskey=&quot;&amp;retentionKeepUnread.accesskey;&quot;</span>
<a href="#l110.35"></a><span id="l110.35" class="difflineplus">+                  label=&quot;&amp;retentionKeepUnreadHidden.label;&quot;</span>
<a href="#l110.36"></a><span id="l110.36" class="difflineplus">+                  class=&quot;keepUnreadOnly&quot; hidden=&quot;true&quot;</span>
<a href="#l110.37"></a><span id="l110.37">                   checked=&quot;false&quot;/&gt;</span>
<a href="#l110.38"></a><span id="l110.38">         &lt;checkbox id=&quot;retention.applyToFlagged&quot; wsm_persist=&quot;true&quot;</span>
<a href="#l110.39"></a><span id="l110.39" class="difflineminus">-                  label=&quot;&amp;retentionApplyToFlagged.label;&quot;</span>
<a href="#l110.40"></a><span id="l110.40" class="difflineplus">+                  label=&quot;&amp;retentionApplyToFlagged.label;&quot; hidefor=&quot;&quot;</span>
<a href="#l110.41"></a><span id="l110.41">                   accesskey=&quot;&amp;retentionApplyToFlagged.accesskey;&quot;</span>
<a href="#l110.42"></a><span id="l110.42">                   checked=&quot;true&quot;/&gt;</span>
<a href="#l110.43"></a><span id="l110.43">       &lt;/vbox&gt;</span>
<a href="#l110.44"></a><span id="l110.44">     &lt;/hbox&gt;</span>
<a href="#l110.45"></a><span id="l110.45">     &lt;hbox align=&quot;center&quot; class=&quot;indent&quot; hidefor=&quot;movemail,pop3,imap,none,rss&quot;&gt;</span>
<a href="#l110.46"></a><span id="l110.46" class="difflineminus">-        &lt;checkbox wsm_persist=&quot;true&quot; id=&quot;nntp.removeBody&quot; accesskey=&quot;&amp;nntpRemoveBody.accesskey;&quot;</span>
<a href="#l110.47"></a><span id="l110.47" class="difflineminus">-                  label=&quot;&amp;nntpRemoveBody.label;&quot; oncommand=&quot;onCheckItem('nntp.removeBodyMin','nntp.removeBody');&quot;/&gt;</span>
<a href="#l110.48"></a><span id="l110.48" class="difflineplus">+        &lt;checkbox wsm_persist=&quot;true&quot; id=&quot;nntp.removeBody&quot; accesskey=&quot;&amp;nntpRemoveMsgBody.accesskey;&quot;</span>
<a href="#l110.49"></a><span id="l110.49" class="difflineplus">+                  label=&quot;&amp;nntpRemoveMsgBody.label;&quot; oncommand=&quot;onCheckItem('nntp.removeBodyMin','nntp.removeBody');&quot;/&gt;</span>
<a href="#l110.50"></a><span id="l110.50">         &lt;textbox wsm_persist=&quot;true&quot; id=&quot;nntp.removeBodyMin&quot; size=&quot;2&quot; value=&quot;30&quot;</span>
<a href="#l110.51"></a><span id="l110.51">                  type=&quot;number&quot; min=&quot;1&quot;</span>
<a href="#l110.52"></a><span id="l110.52">                  aria-labelledby=&quot;nntp.removeBody nntp.removeBodyMin daysOldMsg&quot;/&gt;</span>
<a href="#l110.53"></a><span id="l110.53">         &lt;label value=&quot;&amp;daysOld.label;&quot; control=&quot;nntp.removeBodyMin&quot; id=&quot;daysOldMsg&quot;/&gt;</span>
<a href="#l110.54"></a><span id="l110.54">     &lt;/hbox&gt;</span>
<a href="#l110.55"></a><span id="l110.55">     &lt;/vbox&gt;</span>
<a href="#l110.56"></a><span id="l110.56">     &lt;/groupbox&gt;</span>
<a href="#l110.57"></a><span id="l110.57"> &lt;/page&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l111.1"></a><span id="l111.1" class="difflineminus">--- a/mailnews/base/public/nsIMsgCopyService.idl</span>
<a href="#l111.2"></a><span id="l111.2" class="difflineplus">+++ b/mailnews/base/public/nsIMsgCopyService.idl</span>
<a href="#l111.3"></a><span id="l111.3" class="difflineat">@@ -89,21 +89,22 @@ interface nsIMsgCopyService : nsISupport</span>
<a href="#l111.4"></a><span id="l111.4">                     in nsIMsgWindow msgWindow);</span>
<a href="#l111.5"></a><span id="l111.5"> </span>
<a href="#l111.6"></a><span id="l111.6">   /**</span>
<a href="#l111.7"></a><span id="l111.7">    * Copies message in rfc format from file to folder.</span>
<a href="#l111.8"></a><span id="l111.8">    *</span>
<a href="#l111.9"></a><span id="l111.9">    * @param aFile             A file which contains message in rfc format which</span>
<a href="#l111.10"></a><span id="l111.10">    *                          will copied to destFolder.</span>
<a href="#l111.11"></a><span id="l111.11">    * @param dstFolder         Destination folder where a message will be copied.</span>
<a href="#l111.12"></a><span id="l111.12" class="difflineminus">-   * @param msgToReplace      Header which identifies message which will be</span>
<a href="#l111.13"></a><span id="l111.13" class="difflineminus">-   *                          replaced by newly copied message or null. It is</span>
<a href="#l111.14"></a><span id="l111.14" class="difflineminus">-   *                          used generally for drafts, when saving a new copy</span>
<a href="#l111.15"></a><span id="l111.15" class="difflineminus">-   *                          of a draft message should replace the old</span>
<a href="#l111.16"></a><span id="l111.16" class="difflineminus">-   *                          draft message.</span>
<a href="#l111.17"></a><span id="l111.17" class="difflineplus">+   * @param msgToReplace      Header which identifies a message to use as a source</span>
<a href="#l111.18"></a><span id="l111.18" class="difflineplus">+   *                          of message properties, or null. For example, when</span>
<a href="#l111.19"></a><span id="l111.19" class="difflineplus">+   *                          deleting an attachment, the processed message is</span>
<a href="#l111.20"></a><span id="l111.20" class="difflineplus">+   *                          stored in a file, but the metadata should be copied</span>
<a href="#l111.21"></a><span id="l111.21" class="difflineplus">+   *                          from the original message. This method will NOT delete</span>
<a href="#l111.22"></a><span id="l111.22" class="difflineplus">+   *                          the original message.</span>
<a href="#l111.23"></a><span id="l111.23">    * @param isDraftOrTemplate Specifies whether a message is a stored in draft</span>
<a href="#l111.24"></a><span id="l111.24">    *                          folder or not. If is true listener should</span>
<a href="#l111.25"></a><span id="l111.25">    *                          implement GetMessageId and return unique id for</span>
<a href="#l111.26"></a><span id="l111.26">    *                          message in destination folder. This is important</span>
<a href="#l111.27"></a><span id="l111.27">    *                          for IMAP servers which doesn't support uidplus.</span>
<a href="#l111.28"></a><span id="l111.28">    *                          If destination folder contains message with the</span>
<a href="#l111.29"></a><span id="l111.29">    *                          same message-id then it is possible that listener</span>
<a href="#l111.30"></a><span id="l111.30">    *                          get wrong message key in callback</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l112.1"></a><span id="l112.1" class="difflineminus">--- a/mailnews/base/public/nsIMsgDBView.idl</span>
<a href="#l112.2"></a><span id="l112.2" class="difflineplus">+++ b/mailnews/base/public/nsIMsgDBView.idl</span>
<a href="#l112.3"></a><span id="l112.3" class="difflineat">@@ -41,16 +41,17 @@</span>
<a href="#l112.4"></a><span id="l112.4"> interface nsIMsgFolder;</span>
<a href="#l112.5"></a><span id="l112.5"> interface nsIMsgWindow;</span>
<a href="#l112.6"></a><span id="l112.6"> interface nsIMessenger;</span>
<a href="#l112.7"></a><span id="l112.7"> interface nsIMsgDBHdr;</span>
<a href="#l112.8"></a><span id="l112.8"> interface nsIMsgThread;</span>
<a href="#l112.9"></a><span id="l112.9"> interface nsIMsgDBViewCommandUpdater;</span>
<a href="#l112.10"></a><span id="l112.10"> interface nsIMsgDatabase;</span>
<a href="#l112.11"></a><span id="l112.11"> interface nsIMsgSearchSession;</span>
<a href="#l112.12"></a><span id="l112.12" class="difflineplus">+interface nsIMutableArray;</span>
<a href="#l112.13"></a><span id="l112.13"> interface nsISimpleEnumerator;</span>
<a href="#l112.14"></a><span id="l112.14"> interface nsITreeView;</span>
<a href="#l112.15"></a><span id="l112.15"> interface nsIMsgCustomColumnHandler;</span>
<a href="#l112.16"></a><span id="l112.16"> </span>
<a href="#l112.17"></a><span id="l112.17"> typedef long nsMsgViewNotificationCodeValue;</span>
<a href="#l112.18"></a><span id="l112.18"> typedef long nsMsgViewCommandCheckStateValue;</span>
<a href="#l112.19"></a><span id="l112.19"> typedef long nsMsgViewCommandTypeValue;</span>
<a href="#l112.20"></a><span id="l112.20"> typedef long nsMsgNavigationTypeValue;</span>
<a href="#l112.21"></a><span id="l112.21" class="difflineat">@@ -240,17 +241,17 @@ interface nsMsgNavigationType</span>
<a href="#l112.22"></a><span id="l112.22">   const nsMsgNavigationTypeValue previousFlagged = 19;</span>
<a href="#l112.23"></a><span id="l112.23">   const nsMsgNavigationTypeValue firstNew = 20;</span>
<a href="#l112.24"></a><span id="l112.24">   const nsMsgNavigationTypeValue editUndo = 21;</span>
<a href="#l112.25"></a><span id="l112.25">   const nsMsgNavigationTypeValue editRedo = 22;</span>
<a href="#l112.26"></a><span id="l112.26">   const nsMsgNavigationTypeValue toggleSubthreadKilled = 23;</span>
<a href="#l112.27"></a><span id="l112.27"> };</span>
<a href="#l112.28"></a><span id="l112.28"> </span>
<a href="#l112.29"></a><span id="l112.29"> </span>
<a href="#l112.30"></a><span id="l112.30" class="difflineminus">-[scriptable, uuid(03969356-7a74-4b78-bb17-0d56849c789f)]</span>
<a href="#l112.31"></a><span id="l112.31" class="difflineplus">+[scriptable, uuid(7b6f1f8f-f27a-409b-955b-ab40d46194e1)]</span>
<a href="#l112.32"></a><span id="l112.32"> interface nsIMsgDBView : nsISupports</span>
<a href="#l112.33"></a><span id="l112.33"> {</span>
<a href="#l112.34"></a><span id="l112.34">   void open(in nsIMsgFolder folder, in nsMsgViewSortTypeValue sortType, in nsMsgViewSortOrderValue sortOrder, in nsMsgViewFlagsTypeValue viewFlags, out long count);</span>
<a href="#l112.35"></a><span id="l112.35">   void openWithHdrs(in nsISimpleEnumerator aHeaders, in nsMsgViewSortTypeValue aSortType, </span>
<a href="#l112.36"></a><span id="l112.36">                       in nsMsgViewSortOrderValue aSortOrder, </span>
<a href="#l112.37"></a><span id="l112.37">                       in nsMsgViewFlagsTypeValue aViewFlags, out long aCount);</span>
<a href="#l112.38"></a><span id="l112.38">   void close();</span>
<a href="#l112.39"></a><span id="l112.39"> </span>
<a href="#l112.40"></a><span id="l112.40" class="difflineat">@@ -320,27 +321,50 @@ interface nsIMsgDBView : nsISupports</span>
<a href="#l112.41"></a><span id="l112.41">    * @return - msg hdr at the passed in index</span>
<a href="#l112.42"></a><span id="l112.42">    * @exception - NS_MSG_INVALID_DBVIEW_INDEX</span>
<a href="#l112.43"></a><span id="l112.43">    */</span>
<a href="#l112.44"></a><span id="l112.44">   nsIMsgDBHdr getMsgHdrAt(in nsMsgViewIndex aIndex);</span>
<a href="#l112.45"></a><span id="l112.45"> </span>
<a href="#l112.46"></a><span id="l112.46">   nsIMsgFolder getFolderForViewIndex(in nsMsgViewIndex index); // mainly for search</span>
<a href="#l112.47"></a><span id="l112.47">   ACString getURIForViewIndex(in nsMsgViewIndex index);</span>
<a href="#l112.48"></a><span id="l112.48">   nsIMsgDBView cloneDBView(in nsIMessenger aMessengerInstance, in nsIMsgWindow aMsgWindow, in nsIMsgDBViewCommandUpdater aCommandUpdater);</span>
<a href="#l112.49"></a><span id="l112.49" class="difflineplus">+</span>
<a href="#l112.50"></a><span id="l112.50" class="difflineplus">+  /**</span>
<a href="#l112.51"></a><span id="l112.51" class="difflineplus">+   * Provides a list of the message headers for the currently selected messages.</span>
<a href="#l112.52"></a><span id="l112.52" class="difflineplus">+   *  If the &quot;mail.operate_on_msgs_in_collapsed_threads&quot; preference is enabled,</span>
<a href="#l112.53"></a><span id="l112.53" class="difflineplus">+   *  then any collapsed thread roots that are selected will also (conceptually)</span>
<a href="#l112.54"></a><span id="l112.54" class="difflineplus">+   *  have all of the messages in that thread selected and they will be included</span>
<a href="#l112.55"></a><span id="l112.55" class="difflineplus">+   *  in the returned list.</span>
<a href="#l112.56"></a><span id="l112.56" class="difflineplus">+   *</span>
<a href="#l112.57"></a><span id="l112.57" class="difflineplus">+   * If the user has right-clicked on a message, this will return that message</span>
<a href="#l112.58"></a><span id="l112.58" class="difflineplus">+   *  (and any collapsed children if so enabled) and not the selection prior to</span>
<a href="#l112.59"></a><span id="l112.59" class="difflineplus">+   *  the right-click.</span>
<a href="#l112.60"></a><span id="l112.60" class="difflineplus">+   *</span>
<a href="#l112.61"></a><span id="l112.61" class="difflineplus">+   * @return an nsIMutableArray containing the selected message headers.  You</span>
<a href="#l112.62"></a><span id="l112.62" class="difflineplus">+   *     are free to mutate the array; it will not affect the underlying</span>
<a href="#l112.63"></a><span id="l112.63" class="difflineplus">+   *     selection.</span>
<a href="#l112.64"></a><span id="l112.64" class="difflineplus">+   */</span>
<a href="#l112.65"></a><span id="l112.65" class="difflineplus">+  nsIMutableArray getMsgHdrsForSelection();</span>
<a href="#l112.66"></a><span id="l112.66">   void getURIsForSelection(out unsigned long count, [retval, array, size_is(count)] out string uris);</span>
<a href="#l112.67"></a><span id="l112.67">   void getIndicesForSelection(out unsigned long count, [retval, array, size_is(count)] out nsMsgViewIndex indices);</span>
<a href="#l112.68"></a><span id="l112.68"> </span>
<a href="#l112.69"></a><span id="l112.69">   readonly attribute ACString URIForFirstSelectedMessage;</span>
<a href="#l112.70"></a><span id="l112.70">   readonly attribute nsIMsgDBHdr hdrForFirstSelectedMessage;</span>
<a href="#l112.71"></a><span id="l112.71">   void loadMessageByMsgKey(in nsMsgKey aMsgKey);</span>
<a href="#l112.72"></a><span id="l112.72">   void loadMessageByViewIndex(in nsMsgViewIndex aIndex);</span>
<a href="#l112.73"></a><span id="l112.73">   void loadMessageByUrl(in string aUrl);</span>
<a href="#l112.74"></a><span id="l112.74">   void reloadMessage();</span>
<a href="#l112.75"></a><span id="l112.75">   void reloadMessageWithAllParts();</span>
<a href="#l112.76"></a><span id="l112.76"> </span>
<a href="#l112.77"></a><span id="l112.77" class="difflineplus">+  /**</span>
<a href="#l112.78"></a><span id="l112.78" class="difflineplus">+   * The number of selected messages.  If the</span>
<a href="#l112.79"></a><span id="l112.79" class="difflineplus">+   *  &quot;mail.operate_on_msgs_in_collapsed_threads&quot; preference is enabled, then</span>
<a href="#l112.80"></a><span id="l112.80" class="difflineplus">+   *  any collapsed thread roots that are selected will also conceptually have</span>
<a href="#l112.81"></a><span id="l112.81" class="difflineplus">+   *  all of the messages in that thread selected.</span>
<a href="#l112.82"></a><span id="l112.82" class="difflineplus">+   */</span>
<a href="#l112.83"></a><span id="l112.83">   readonly attribute unsigned long numSelected;</span>
<a href="#l112.84"></a><span id="l112.84">   readonly attribute nsMsgViewIndex msgToSelectAfterDelete; </span>
<a href="#l112.85"></a><span id="l112.85">   readonly attribute nsMsgViewIndex currentlyDisplayedMessage; </span>
<a href="#l112.86"></a><span id="l112.86"> </span>
<a href="#l112.87"></a><span id="l112.87">   // used by &quot;go to folder&quot; feature</span>
<a href="#l112.88"></a><span id="l112.88">   // and &quot;remember last selected message&quot; feature</span>
<a href="#l112.89"></a><span id="l112.89">   // if key is not found, we don't select.</span>
<a href="#l112.90"></a><span id="l112.90">   void selectMsgByKey(in nsMsgKey key);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l113.1"></a><span id="l113.1" class="difflineminus">--- a/mailnews/base/public/nsIMsgFolder.idl</span>
<a href="#l113.2"></a><span id="l113.2" class="difflineplus">+++ b/mailnews/base/public/nsIMsgFolder.idl</span>
<a href="#l113.3"></a><span id="l113.3" class="difflineat">@@ -127,22 +127,61 @@ interface nsIMsgFolder : nsISupports {</span>
<a href="#l113.4"></a><span id="l113.4">   readonly attribute boolean canCompact;</span>
<a href="#l113.5"></a><span id="l113.5"> </span>
<a href="#l113.6"></a><span id="l113.6">   /**</span>
<a href="#l113.7"></a><span id="l113.7">    * the phantom server folder</span>
<a href="#l113.8"></a><span id="l113.8">    */</span>
<a href="#l113.9"></a><span id="l113.9">   readonly attribute nsIMsgFolder rootFolder;</span>
<a href="#l113.10"></a><span id="l113.10"> </span>
<a href="#l113.11"></a><span id="l113.11">   /**</span>
<a href="#l113.12"></a><span id="l113.12" class="difflineminus">-   * function to get the filter list on folder's server</span>
<a href="#l113.13"></a><span id="l113.13" class="difflineminus">-   * (or in the case of news, the filter list for this newsgroup)'</span>
<a href="#l113.14"></a><span id="l113.14" class="difflineplus">+   * Get the server's list of filters. (Or in the case of news, the </span>
<a href="#l113.15"></a><span id="l113.15" class="difflineplus">+   * filter list for this newsgroup)</span>
<a href="#l113.16"></a><span id="l113.16" class="difflineplus">+   * This list SHOULD be used for all incoming messages.</span>
<a href="#l113.17"></a><span id="l113.17" class="difflineplus">+   *</span>
<a href="#l113.18"></a><span id="l113.18" class="difflineplus">+   * Since the returned nsIMsgFilterList is mutable, it is not necessary to call</span>
<a href="#l113.19"></a><span id="l113.19" class="difflineplus">+   * setFilterList after the filters have been changed.</span>
<a href="#l113.20"></a><span id="l113.20" class="difflineplus">+   *</span>
<a href="#l113.21"></a><span id="l113.21" class="difflineplus">+   * @param aMsgWindow  @ref msgwindow &quot;The standard message window&quot;</span>
<a href="#l113.22"></a><span id="l113.22" class="difflineplus">+   * @return            The list of filters</span>
<a href="#l113.23"></a><span id="l113.23">    */</span>
<a href="#l113.24"></a><span id="l113.24">   nsIMsgFilterList getFilterList(in nsIMsgWindow msgWindow);</span>
<a href="#l113.25"></a><span id="l113.25" class="difflineplus">+</span>
<a href="#l113.26"></a><span id="l113.26" class="difflineplus">+  /**</span>
<a href="#l113.27"></a><span id="l113.27" class="difflineplus">+   * Set the server's list of filters.</span>
<a href="#l113.28"></a><span id="l113.28" class="difflineplus">+   *</span>
<a href="#l113.29"></a><span id="l113.29" class="difflineplus">+   * Note that this does not persist the filter list. To change the contents</span>
<a href="#l113.30"></a><span id="l113.30" class="difflineplus">+   * of the existing filters, use getFilterList and mutate the values as</span>
<a href="#l113.31"></a><span id="l113.31" class="difflineplus">+   * appopriate.</span>
<a href="#l113.32"></a><span id="l113.32" class="difflineplus">+   *</span>
<a href="#l113.33"></a><span id="l113.33" class="difflineplus">+   * @param aFilterList The new list of filters.</span>
<a href="#l113.34"></a><span id="l113.34" class="difflineplus">+   */</span>
<a href="#l113.35"></a><span id="l113.35">   void setFilterList(in nsIMsgFilterList filterList);</span>
<a href="#l113.36"></a><span id="l113.36"> </span>
<a href="#l113.37"></a><span id="l113.37" class="difflineplus">+  /**</span>
<a href="#l113.38"></a><span id="l113.38" class="difflineplus">+   * Get user editable filter list. This does not have to be the same as</span>
<a href="#l113.39"></a><span id="l113.39" class="difflineplus">+   * the filterlist above, typically depending on the users preferences.</span>
<a href="#l113.40"></a><span id="l113.40" class="difflineplus">+   * The filters in this list are not processed, but only to be edited by</span>
<a href="#l113.41"></a><span id="l113.41" class="difflineplus">+   * the user.</span>
<a href="#l113.42"></a><span id="l113.42" class="difflineplus">+   * @see getFilterList</span>
<a href="#l113.43"></a><span id="l113.43" class="difflineplus">+   *</span>
<a href="#l113.44"></a><span id="l113.44" class="difflineplus">+   * @param aMsgWindow  @ref msgwindow &quot;The standard message window&quot;</span>
<a href="#l113.45"></a><span id="l113.45" class="difflineplus">+   * @return            The list of filters</span>
<a href="#l113.46"></a><span id="l113.46" class="difflineplus">+   */</span>
<a href="#l113.47"></a><span id="l113.47" class="difflineplus">+  nsIMsgFilterList getEditableFilterList(in nsIMsgWindow aMsgWindow);</span>
<a href="#l113.48"></a><span id="l113.48" class="difflineplus">+</span>
<a href="#l113.49"></a><span id="l113.49" class="difflineplus">+  /**</span>
<a href="#l113.50"></a><span id="l113.50" class="difflineplus">+   * Set user editable filter list.</span>
<a href="#l113.51"></a><span id="l113.51" class="difflineplus">+   * This does not persist the filterlist, @see setFilterList</span>
<a href="#l113.52"></a><span id="l113.52" class="difflineplus">+   * @see getEditableFilterList</span>
<a href="#l113.53"></a><span id="l113.53" class="difflineplus">+   * @see setFilterList</span>
<a href="#l113.54"></a><span id="l113.54" class="difflineplus">+   *</span>
<a href="#l113.55"></a><span id="l113.55" class="difflineplus">+   * @param aFilterList The new list of filters.</span>
<a href="#l113.56"></a><span id="l113.56" class="difflineplus">+   */</span>
<a href="#l113.57"></a><span id="l113.57" class="difflineplus">+  void setEditableFilterList(in nsIMsgFilterList aFilterList);</span>
<a href="#l113.58"></a><span id="l113.58" class="difflineplus">+</span>
<a href="#l113.59"></a><span id="l113.59">   void ForceDBClosed ();</span>
<a href="#l113.60"></a><span id="l113.60">   /**</span>
<a href="#l113.61"></a><span id="l113.61">    * Close and backup a folder database prior to reparsing</span>
<a href="#l113.62"></a><span id="l113.62">    *</span>
<a href="#l113.63"></a><span id="l113.63">    * @param  newName  New name of the corresponding message folder.</span>
<a href="#l113.64"></a><span id="l113.64">    *                  Used in rename to set the file name to match the renamed</span>
<a href="#l113.65"></a><span id="l113.65">    *                  folder. Set to empty to use the existing folder name.</span>
<a href="#l113.66"></a><span id="l113.66">    */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l114.1"></a><span id="l114.1" class="difflineminus">--- a/mailnews/base/public/nsIMsgIncomingServer.idl</span>
<a href="#l114.2"></a><span id="l114.2" class="difflineplus">+++ b/mailnews/base/public/nsIMsgIncomingServer.idl</span>
<a href="#l114.3"></a><span id="l114.3" class="difflineat">@@ -189,22 +189,64 @@ interface nsIMsgIncomingServer : nsISupp</span>
<a href="#l114.4"></a><span id="l114.4">   attribute boolean logonFallback;</span>
<a href="#l114.5"></a><span id="l114.5"> </span>
<a href="#l114.6"></a><span id="l114.6">   /* dead code. */</span>
<a href="#l114.7"></a><span id="l114.7">   readonly attribute boolean isSecureServer;</span>
<a href="#l114.8"></a><span id="l114.8"> </span>
<a href="#l114.9"></a><span id="l114.9">   /* empty trash on exit */</span>
<a href="#l114.10"></a><span id="l114.10">   attribute boolean emptyTrashOnExit;</span>
<a href="#l114.11"></a><span id="l114.11"> </span>
<a href="#l114.12"></a><span id="l114.12" class="difflineminus">-  /* get filter list */</span>
<a href="#l114.13"></a><span id="l114.13" class="difflineplus">+  /**</span>
<a href="#l114.14"></a><span id="l114.14" class="difflineplus">+   * Get the server's list of filters.</span>
<a href="#l114.15"></a><span id="l114.15" class="difflineplus">+   *</span>
<a href="#l114.16"></a><span id="l114.16" class="difflineplus">+   * This SHOULD be the same filter list as the root folder's, if the server</span>
<a href="#l114.17"></a><span id="l114.17" class="difflineplus">+   * supports per-folder filters. Furthermore, this list SHOULD be used for all</span>
<a href="#l114.18"></a><span id="l114.18" class="difflineplus">+   * incoming messages.</span>
<a href="#l114.19"></a><span id="l114.19" class="difflineplus">+   *</span>
<a href="#l114.20"></a><span id="l114.20" class="difflineplus">+   * Since the returned nsIMsgFilterList is mutable, it is not necessary to call</span>
<a href="#l114.21"></a><span id="l114.21" class="difflineplus">+   * setFilterList after the filters have been changed.</span>
<a href="#l114.22"></a><span id="l114.22" class="difflineplus">+   *</span>
<a href="#l114.23"></a><span id="l114.23" class="difflineplus">+   * @param aMsgWindow  @ref msgwindow &quot;The standard message window&quot;</span>
<a href="#l114.24"></a><span id="l114.24" class="difflineplus">+   * @return            The list of filters.</span>
<a href="#l114.25"></a><span id="l114.25" class="difflineplus">+   */</span>
<a href="#l114.26"></a><span id="l114.26">   nsIMsgFilterList getFilterList(in nsIMsgWindow aMsgWindow);</span>
<a href="#l114.27"></a><span id="l114.27"> </span>
<a href="#l114.28"></a><span id="l114.28" class="difflineminus">-  /* set filter list */</span>
<a href="#l114.29"></a><span id="l114.29" class="difflineplus">+  /**</span>
<a href="#l114.30"></a><span id="l114.30" class="difflineplus">+   * Set the server's list of filters.</span>
<a href="#l114.31"></a><span id="l114.31" class="difflineplus">+   *</span>
<a href="#l114.32"></a><span id="l114.32" class="difflineplus">+   * Note that this does not persist the filter list. To change the contents</span>
<a href="#l114.33"></a><span id="l114.33" class="difflineplus">+   * of the existing filters, use getFilterList and mutate the values as</span>
<a href="#l114.34"></a><span id="l114.34" class="difflineplus">+   * appopriate.</span>
<a href="#l114.35"></a><span id="l114.35" class="difflineplus">+   *</span>
<a href="#l114.36"></a><span id="l114.36" class="difflineplus">+   * @param aFilterList The new list of filters.</span>
<a href="#l114.37"></a><span id="l114.37" class="difflineplus">+   */</span>
<a href="#l114.38"></a><span id="l114.38">   void setFilterList(in nsIMsgFilterList aFilterList);</span>
<a href="#l114.39"></a><span id="l114.39"> </span>
<a href="#l114.40"></a><span id="l114.40" class="difflineplus">+  /**</span>
<a href="#l114.41"></a><span id="l114.41" class="difflineplus">+   * Get user editable filter list. This does not have to be the same as</span>
<a href="#l114.42"></a><span id="l114.42" class="difflineplus">+   * the filterlist above, typically depending on the users preferences.</span>
<a href="#l114.43"></a><span id="l114.43" class="difflineplus">+   * The filters in this list are not processed, but only to be edited by</span>
<a href="#l114.44"></a><span id="l114.44" class="difflineplus">+   * the user.</span>
<a href="#l114.45"></a><span id="l114.45" class="difflineplus">+   * @see getFilterList</span>
<a href="#l114.46"></a><span id="l114.46" class="difflineplus">+   *</span>
<a href="#l114.47"></a><span id="l114.47" class="difflineplus">+   * @param aMsgWindow  @ref msgwindow &quot;The standard message window&quot;</span>
<a href="#l114.48"></a><span id="l114.48" class="difflineplus">+   * @return            The list of filters.</span>
<a href="#l114.49"></a><span id="l114.49" class="difflineplus">+   */</span>
<a href="#l114.50"></a><span id="l114.50" class="difflineplus">+  nsIMsgFilterList getEditableFilterList(in nsIMsgWindow aMsgWindow);</span>
<a href="#l114.51"></a><span id="l114.51" class="difflineplus">+</span>
<a href="#l114.52"></a><span id="l114.52" class="difflineplus">+  /**</span>
<a href="#l114.53"></a><span id="l114.53" class="difflineplus">+   * Set user editable filter list.</span>
<a href="#l114.54"></a><span id="l114.54" class="difflineplus">+   * This does not persist the filterlist, @see setFilterList</span>
<a href="#l114.55"></a><span id="l114.55" class="difflineplus">+   * @see getEditableFilterList</span>
<a href="#l114.56"></a><span id="l114.56" class="difflineplus">+   * @see setFilterList</span>
<a href="#l114.57"></a><span id="l114.57" class="difflineplus">+   *</span>
<a href="#l114.58"></a><span id="l114.58" class="difflineplus">+   * @param aFilterList The new list of filters.</span>
<a href="#l114.59"></a><span id="l114.59" class="difflineplus">+   */</span>
<a href="#l114.60"></a><span id="l114.60" class="difflineplus">+  void setEditableFilterList(in nsIMsgFilterList aFilterList);</span>
<a href="#l114.61"></a><span id="l114.61" class="difflineplus">+</span>
<a href="#l114.62"></a><span id="l114.62">   /* we use this to set the default local path.  we use this when migrating prefs */</span>
<a href="#l114.63"></a><span id="l114.63">   void setDefaultLocalPath(in nsILocalFile aDefaultLocalPath);</span>
<a href="#l114.64"></a><span id="l114.64"> </span>
<a href="#l114.65"></a><span id="l114.65">   /**</span>
<a href="#l114.66"></a><span id="l114.66">    * Verify that we can logon</span>
<a href="#l114.67"></a><span id="l114.67">    * </span>
<a href="#l114.68"></a><span id="l114.68">    * @param  aUrlListener - gets called back with success or failure.</span>
<a href="#l114.69"></a><span id="l114.69">    * @param aMsgWindow         nsIMsgWindow to use for notification callbacks.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l115.1"></a><span id="l115.1" class="difflineminus">--- a/mailnews/base/public/nsIMsgMailNewsUrl.idl</span>
<a href="#l115.2"></a><span id="l115.2" class="difflineplus">+++ b/mailnews/base/public/nsIMsgMailNewsUrl.idl</span>
<a href="#l115.3"></a><span id="l115.3" class="difflineat">@@ -48,17 +48,17 @@ interface nsIMsgSearchSession;</span>
<a href="#l115.4"></a><span id="l115.4"> interface nsICacheEntryDescriptor;</span>
<a href="#l115.5"></a><span id="l115.5"> interface nsICacheSession;</span>
<a href="#l115.6"></a><span id="l115.6"> interface nsIMimeHeaders;</span>
<a href="#l115.7"></a><span id="l115.7"> interface nsIStreamListener;</span>
<a href="#l115.8"></a><span id="l115.8"> interface nsIMsgFolder;</span>
<a href="#l115.9"></a><span id="l115.9"> interface nsIMsgHeaderSink;</span>
<a href="#l115.10"></a><span id="l115.10"> interface nsIMsgDBHdr;</span>
<a href="#l115.11"></a><span id="l115.11"> </span>
<a href="#l115.12"></a><span id="l115.12" class="difflineminus">-[scriptable, uuid(2FB327C2-00A3-4e3f-8CD6-93BED40BD621)]</span>
<a href="#l115.13"></a><span id="l115.13" class="difflineplus">+[scriptable, uuid(01850820-e382-4b0f-a109-23d69280876b)]</span>
<a href="#l115.14"></a><span id="l115.14"> interface nsIMsgMailNewsUrl : nsIURL {</span>
<a href="#l115.15"></a><span id="l115.15">   ///////////////////////////////////////////////////////////////////////////////</span>
<a href="#l115.16"></a><span id="l115.16">   // Eventually we'd like to push this type of functionality up into nsIURI.</span>
<a href="#l115.17"></a><span id="l115.17">   // The idea is to allow the &quot;application&quot; (the part of the code which wants to </span>
<a href="#l115.18"></a><span id="l115.18">   // run a url in order to perform some action) to register itself as a listener</span>
<a href="#l115.19"></a><span id="l115.19">   // on url. As a url listener, the app will be informed when the url begins to run</span>
<a href="#l115.20"></a><span id="l115.20">   // and when the url is finished. </span>
<a href="#l115.21"></a><span id="l115.21">   ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l115.22"></a><span id="l115.22" class="difflineat">@@ -80,16 +80,22 @@ interface nsIMsgMailNewsUrl : nsIURL {</span>
<a href="#l115.23"></a><span id="l115.23">    * @exception NS_ERROR_FAILURE    May be thrown if the url does not</span>
<a href="#l115.24"></a><span id="l115.24">    *                                relate to a folder, e.g. standalone</span>
<a href="#l115.25"></a><span id="l115.25">    *                                .eml messages.</span>
<a href="#l115.26"></a><span id="l115.26">    */</span>
<a href="#l115.27"></a><span id="l115.27">   attribute nsIMsgFolder folder;</span>
<a href="#l115.28"></a><span id="l115.28"> </span>
<a href="#l115.29"></a><span id="l115.29">   attribute nsIMsgStatusFeedback statusFeedback;</span>
<a href="#l115.30"></a><span id="l115.30"> </span>
<a href="#l115.31"></a><span id="l115.31" class="difflineplus">+  /**</span>
<a href="#l115.32"></a><span id="l115.32" class="difflineplus">+   * The maximum progress for this URL. This might be a count, or it might</span>
<a href="#l115.33"></a><span id="l115.33" class="difflineplus">+   * be a number of bytes. A value of -1 indicates that this is unknown.</span>
<a href="#l115.34"></a><span id="l115.34" class="difflineplus">+   */</span>
<a href="#l115.35"></a><span id="l115.35" class="difflineplus">+  attribute long long maxProgress;</span>
<a href="#l115.36"></a><span id="l115.36" class="difflineplus">+</span>
<a href="#l115.37"></a><span id="l115.37">   attribute nsIMsgWindow msgWindow;</span>
<a href="#l115.38"></a><span id="l115.38"> </span>
<a href="#l115.39"></a><span id="l115.39">   // current mime headers if reading message</span>
<a href="#l115.40"></a><span id="l115.40">   attribute nsIMimeHeaders mimeHeaders;</span>
<a href="#l115.41"></a><span id="l115.41"> </span>
<a href="#l115.42"></a><span id="l115.42">   // the load group is computed from the msgWindow</span>
<a href="#l115.43"></a><span id="l115.43">   readonly attribute nsILoadGroup loadGroup;</span>
<a href="#l115.44"></a><span id="l115.44"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l116.1"></a><span id="l116.1" class="difflineminus">--- a/mailnews/base/public/nsIMsgProgress.idl</span>
<a href="#l116.2"></a><span id="l116.2" class="difflineplus">+++ b/mailnews/base/public/nsIMsgProgress.idl</span>
<a href="#l116.3"></a><span id="l116.3" class="difflineat">@@ -38,17 +38,17 @@</span>
<a href="#l116.4"></a><span id="l116.4"> #include &quot;nsISupports.idl&quot;</span>
<a href="#l116.5"></a><span id="l116.5"> #include &quot;domstubs.idl&quot;</span>
<a href="#l116.6"></a><span id="l116.6"> #include &quot;nsIPrompt.idl&quot;</span>
<a href="#l116.7"></a><span id="l116.7"> #include &quot;nsIWebProgressListener.idl&quot;</span>
<a href="#l116.8"></a><span id="l116.8"> </span>
<a href="#l116.9"></a><span id="l116.9"> interface nsIDOMWindowInternal;</span>
<a href="#l116.10"></a><span id="l116.10"> interface nsIMsgWindow;</span>
<a href="#l116.11"></a><span id="l116.11"> </span>
<a href="#l116.12"></a><span id="l116.12" class="difflineminus">-[scriptable, uuid(892A9E47-853A-454A-8B02-94A7521D046D)]</span>
<a href="#l116.13"></a><span id="l116.13" class="difflineplus">+[scriptable, uuid(5aae7f1b-95f1-422e-86d5-2b1d599e2ccf)]</span>
<a href="#l116.14"></a><span id="l116.14"> interface nsIMsgProgress: nsIWebProgressListener {</span>
<a href="#l116.15"></a><span id="l116.15"> </span>
<a href="#l116.16"></a><span id="l116.16">   /** </span>
<a href="#l116.17"></a><span id="l116.17">    * Open the progress dialog, you can specify parameters through an xpcom object</span>
<a href="#l116.18"></a><span id="l116.18">    */</span>
<a href="#l116.19"></a><span id="l116.19">   void openProgressDialog(in nsIDOMWindowInternal parent, </span>
<a href="#l116.20"></a><span id="l116.20">                           in nsIMsgWindow aMsgWindow, </span>
<a href="#l116.21"></a><span id="l116.21">                           in string dialogURL, </span>
<a href="#l116.22"></a><span id="l116.22" class="difflineat">@@ -59,18 +59,15 @@ interface nsIMsgProgress: nsIWebProgress</span>
<a href="#l116.23"></a><span id="l116.23">   void closeProgressDialog(in boolean forceClose);</span>
<a href="#l116.24"></a><span id="l116.24">   </span>
<a href="#l116.25"></a><span id="l116.25">   /* Register a Web Progress Listener */</span>
<a href="#l116.26"></a><span id="l116.26">   void registerListener(in nsIWebProgressListener listener);</span>
<a href="#l116.27"></a><span id="l116.27"> </span>
<a href="#l116.28"></a><span id="l116.28">   /* Unregister a Web Progress Listener */</span>
<a href="#l116.29"></a><span id="l116.29">   void unregisterListener(in nsIWebProgressListener listener);</span>
<a href="#l116.30"></a><span id="l116.30">   </span>
<a href="#l116.31"></a><span id="l116.31" class="difflineminus">-  /* Retrieve the prompter, needed to display modal dialog on top of progress dialog */</span>
<a href="#l116.32"></a><span id="l116.32" class="difflineminus">-  nsIPrompt getPrompter();</span>
<a href="#l116.33"></a><span id="l116.33" class="difflineminus">-</span>
<a href="#l116.34"></a><span id="l116.34">   /* Indicated if the user asked to cancel the current process */</span>
<a href="#l116.35"></a><span id="l116.35">   attribute boolean processCanceledByUser;</span>
<a href="#l116.36"></a><span id="l116.36"> </span>
<a href="#l116.37"></a><span id="l116.37">   attribute nsIMsgWindow msgWindow;</span>
<a href="#l116.38"></a><span id="l116.38"> };</span>
<a href="#l116.39"></a><span id="l116.39"> </span>
<a href="#l116.40"></a><span id="l116.40"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l117.1"></a><span id="l117.1" class="difflineminus">--- a/mailnews/base/resources/content/folderProps.xul</span>
<a href="#l117.2"></a><span id="l117.2" class="difflineplus">+++ b/mailnews/base/resources/content/folderProps.xul</span>
<a href="#l117.3"></a><span id="l117.3" class="difflineat">@@ -121,18 +121,18 @@</span>
<a href="#l117.4"></a><span id="l117.4">               label=&quot;&amp;retentionUseDefault.label;&quot; checked=&quot;true&quot; oncommand=&quot;onUseDefaultRetentionSettings()&quot;/&gt;</span>
<a href="#l117.5"></a><span id="l117.5">         &lt;/hbox&gt;</span>
<a href="#l117.6"></a><span id="l117.6">         &lt;vbox class=&quot;indent&quot;&gt;</span>
<a href="#l117.7"></a><span id="l117.7">           &lt;hbox class=&quot;indent&quot;&gt;</span>
<a href="#l117.8"></a><span id="l117.8">             &lt;radiogroup wsm_persist=&quot;true&quot; id=&quot;retention.keepMsg&quot; aria-labelledby=&quot;retention.useDefault&quot;&gt;</span>
<a href="#l117.9"></a><span id="l117.9">               &lt;radio wsm_persist=&quot;true&quot; value=&quot;1&quot; accesskey=&quot;&amp;retentionKeepAll.accesskey;&quot;</span>
<a href="#l117.10"></a><span id="l117.10">                       label=&quot;&amp;retentionKeepAll.label;&quot; oncommand=&quot;onCheckKeepMsg();&quot;/&gt;</span>
<a href="#l117.11"></a><span id="l117.11">               &lt;hbox flex=&quot;1&quot; align=&quot;center&quot;&gt;</span>
<a href="#l117.12"></a><span id="l117.12" class="difflineminus">-                &lt;radio wsm_persist=&quot;true&quot; id=&quot;keepNewMsg&quot; accesskey=&quot;&amp;retentionKeepNew.accesskey;&quot; </span>
<a href="#l117.13"></a><span id="l117.13" class="difflineminus">-                        value=&quot;3&quot; label=&quot;&amp;retentionKeepNew.label;&quot; oncommand=&quot;onCheckKeepMsg();&quot;/&gt;</span>
<a href="#l117.14"></a><span id="l117.14" class="difflineplus">+                &lt;radio wsm_persist=&quot;true&quot; id=&quot;keepNewMsg&quot; accesskey=&quot;&amp;retentionKeepRecent.accesskey;&quot; </span>
<a href="#l117.15"></a><span id="l117.15" class="difflineplus">+                        value=&quot;3&quot; label=&quot;&amp;retentionKeepRecent.label;&quot; oncommand=&quot;onCheckKeepMsg();&quot;/&gt;</span>
<a href="#l117.16"></a><span id="l117.16">                 &lt;textbox wsm_persist=&quot;true&quot; id=&quot;retention.keepNewMsgMin&quot;</span>
<a href="#l117.17"></a><span id="l117.17">                          type=&quot;number&quot; min=&quot;1&quot; increment=&quot;10&quot; size=&quot;4&quot; value=&quot;2000&quot;</span>
<a href="#l117.18"></a><span id="l117.18">                          aria-labelledby=&quot;keepNewMsg retention.keepNewMsgMin retention.keepNewMsgMinLabel&quot;/&gt;</span>
<a href="#l117.19"></a><span id="l117.19">                 &lt;label value=&quot;&amp;message.label;&quot; control=&quot;retention.keepNewMsgMin&quot; id=&quot;retention.keepNewMsgMinLabel&quot;/&gt;</span>
<a href="#l117.20"></a><span id="l117.20">               &lt;/hbox&gt;</span>
<a href="#l117.21"></a><span id="l117.21">               &lt;hbox flex=&quot;1&quot; align=&quot;center&quot;&gt;</span>
<a href="#l117.22"></a><span id="l117.22">                 &lt;radio wsm_persist=&quot;true&quot; id=&quot;keepMsg&quot; accesskey=&quot;&amp;retentionDeleteMsg.accesskey;&quot;</span>
<a href="#l117.23"></a><span id="l117.23">                         value=&quot;2&quot; label=&quot;&amp;retentionDeleteMsg.label;&quot; oncommand=&quot;onCheckKeepMsg();&quot;/&gt;</span>
<a href="#l117.24"></a><span id="l117.24" class="difflineat">@@ -141,18 +141,18 @@</span>
<a href="#l117.25"></a><span id="l117.25">                          aria-labelledby=&quot;keepMsg retention.keepOldMsgMin retention.keepOldMsgMinLabel&quot;/&gt;</span>
<a href="#l117.26"></a><span id="l117.26">                 &lt;label value=&quot;&amp;daysOld.label;&quot; control=&quot;retention.keepOldMsgMin&quot; id=&quot;retention.keepOldMsgMinLabel&quot;/&gt;</span>
<a href="#l117.27"></a><span id="l117.27">               &lt;/hbox&gt;</span>
<a href="#l117.28"></a><span id="l117.28">             &lt;/radiogroup&gt;</span>
<a href="#l117.29"></a><span id="l117.29">           &lt;/hbox&gt;</span>
<a href="#l117.30"></a><span id="l117.30">           &lt;hbox class=&quot;indent&quot;&gt;</span>
<a href="#l117.31"></a><span id="l117.31">             &lt;vbox&gt;</span>
<a href="#l117.32"></a><span id="l117.32">               &lt;checkbox id=&quot;retention.keepUnread&quot; wsm_persist=&quot;true&quot;</span>
<a href="#l117.33"></a><span id="l117.33" class="difflineminus">-                        label=&quot;&amp;retentionKeepUnread.label;&quot;</span>
<a href="#l117.34"></a><span id="l117.34" class="difflineminus">-                        accesskey=&quot;&amp;retentionKeepUnread.accesskey;&quot;</span>
<a href="#l117.35"></a><span id="l117.35" class="difflineplus">+                        label=&quot;&amp;retentionKeepUnreadHidden.label;&quot;</span>
<a href="#l117.36"></a><span id="l117.36" class="difflineplus">+                        class=&quot;keepUnreadOnly&quot; hidden=&quot;true&quot;</span>
<a href="#l117.37"></a><span id="l117.37">                         observes=&quot;retention.keepMsg&quot; checked=&quot;false&quot;/&gt;</span>
<a href="#l117.38"></a><span id="l117.38">               &lt;checkbox id=&quot;retention.applyToFlagged&quot; wsm_persist=&quot;true&quot;</span>
<a href="#l117.39"></a><span id="l117.39">                         label=&quot;&amp;retentionApplyToFlagged.label;&quot;</span>
<a href="#l117.40"></a><span id="l117.40">                         accesskey=&quot;&amp;retentionApplyToFlagged.accesskey;&quot;</span>
<a href="#l117.41"></a><span id="l117.41">                         observes=&quot;retention.keepMsg&quot; checked=&quot;true&quot;/&gt;</span>
<a href="#l117.42"></a><span id="l117.42">             &lt;/vbox&gt;</span>
<a href="#l117.43"></a><span id="l117.43">           &lt;/hbox&gt;</span>
<a href="#l117.44"></a><span id="l117.44">         &lt;/vbox&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l119.1"></a><span id="l119.1" class="difflineminus">--- a/mailnews/base/resources/content/virtualFolderProperties.js</span>
<a href="#l119.2"></a><span id="l119.2" class="difflineplus">+++ b/mailnews/base/resources/content/virtualFolderProperties.js</span>
<a href="#l119.3"></a><span id="l119.3" class="difflineat">@@ -38,41 +38,46 @@</span>
<a href="#l119.4"></a><span id="l119.4">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l119.5"></a><span id="l119.5"> </span>
<a href="#l119.6"></a><span id="l119.6"> var gPickedFolder;</span>
<a href="#l119.7"></a><span id="l119.7"> var gMailView = null;</span>
<a href="#l119.8"></a><span id="l119.8"> var msgWindow; // important, don't change the name of this variable. it's really a global used by commandglue.js</span>
<a href="#l119.9"></a><span id="l119.9"> var gSearchTermSession; // really an in memory temporary filter we use to read in and write out the search terms</span>
<a href="#l119.10"></a><span id="l119.10"> var gSearchFolderURIs = &quot;&quot;;</span>
<a href="#l119.11"></a><span id="l119.11"> </span>
<a href="#l119.12"></a><span id="l119.12" class="difflineplus">+var nsMsgSearchScope = Components.interfaces.nsMsgSearchScope;</span>
<a href="#l119.13"></a><span id="l119.13" class="difflineplus">+</span>
<a href="#l119.14"></a><span id="l119.14" class="difflineplus">+Components.utils.import(&quot;resource://app/modules/virtualFolderWrapper.js&quot;);</span>
<a href="#l119.15"></a><span id="l119.15" class="difflineplus">+Components.utils.import(&quot;resource://app/modules/iteratorUtils.jsm&quot;);</span>
<a href="#l119.16"></a><span id="l119.16" class="difflineplus">+</span>
<a href="#l119.17"></a><span id="l119.17"> function onLoad()</span>
<a href="#l119.18"></a><span id="l119.18"> {</span>
<a href="#l119.19"></a><span id="l119.19">   var arguments = window.arguments[0];</span>
<a href="#l119.20"></a><span id="l119.20"> </span>
<a href="#l119.21"></a><span id="l119.21">   document.getElementById(&quot;name&quot;).focus();</span>
<a href="#l119.22"></a><span id="l119.22"> </span>
<a href="#l119.23"></a><span id="l119.23">   // call this when OK is pressed</span>
<a href="#l119.24"></a><span id="l119.24">   msgWindow = arguments.msgWindow;</span>
<a href="#l119.25"></a><span id="l119.25"> </span>
<a href="#l119.26"></a><span id="l119.26">   initializeSearchWidgets();</span>
<a href="#l119.27"></a><span id="l119.27">   setSearchScope(nsMsgSearchScope.offlineMail);</span>
<a href="#l119.28"></a><span id="l119.28"> </span>
<a href="#l119.29"></a><span id="l119.29">   if (arguments.editExistingFolder)</span>
<a href="#l119.30"></a><span id="l119.30" class="difflineminus">-    InitDialogWithVirtualFolder(arguments.folder ? arguments.folder.URI : null);</span>
<a href="#l119.31"></a><span id="l119.31" class="difflineplus">+    InitDialogWithVirtualFolder(arguments.folder);</span>
<a href="#l119.32"></a><span id="l119.32">   else // we are creating a new virtual folder</span>
<a href="#l119.33"></a><span id="l119.33">   {</span>
<a href="#l119.34"></a><span id="l119.34">     // it is possible that we were given arguments to pre-fill the dialog with...</span>
<a href="#l119.35"></a><span id="l119.35">     gSearchTermSession = Components.classes[&quot;@mozilla.org/messenger/searchSession;1&quot;]</span>
<a href="#l119.36"></a><span id="l119.36">                                    .createInstance(Components.interfaces.nsIMsgSearchSession);</span>
<a href="#l119.37"></a><span id="l119.37"> </span>
<a href="#l119.38"></a><span id="l119.38">     if (arguments.searchTerms) // then add them to our search session</span>
<a href="#l119.39"></a><span id="l119.39">     {</span>
<a href="#l119.40"></a><span id="l119.40" class="difflineminus">-      var count = arguments.searchTerms.Count();</span>
<a href="#l119.41"></a><span id="l119.41" class="difflineminus">-      for (var searchIndex = 0; searchIndex &lt; count; )</span>
<a href="#l119.42"></a><span id="l119.42" class="difflineminus">-        gSearchTermSession.appendTerm(arguments.searchTerms.QueryElementAt(searchIndex++, Components.interfaces.nsIMsgSearchTerm));</span>
<a href="#l119.43"></a><span id="l119.43" class="difflineplus">+      for each (let searchTerm in fixIterator(arguments.searchTerms,</span>
<a href="#l119.44"></a><span id="l119.44" class="difflineplus">+                                              Components.interfaces.nsIMsgSearchTerm))</span>
<a href="#l119.45"></a><span id="l119.45" class="difflineplus">+        gSearchTermSession.appendTerm(searchTerm);</span>
<a href="#l119.46"></a><span id="l119.46">     }</span>
<a href="#l119.47"></a><span id="l119.47">     if (arguments.folder)</span>
<a href="#l119.48"></a><span id="l119.48">     {</span>
<a href="#l119.49"></a><span id="l119.49">       // pre select the folderPicker, based on what they selected in the folder pane</span>
<a href="#l119.50"></a><span id="l119.50">       gPickedFolder = arguments.folder;</span>
<a href="#l119.51"></a><span id="l119.51">       try {</span>
<a href="#l119.52"></a><span id="l119.52">         document.getElementById(&quot;msgNewFolderPopup&quot;).selectFolder(arguments.folder);</span>
<a href="#l119.53"></a><span id="l119.53">       } catch(ex) {</span>
<a href="#l119.54"></a><span id="l119.54" class="difflineat">@@ -121,44 +126,39 @@ function updateOnlineSearchState()</span>
<a href="#l119.55"></a><span id="l119.55">     checkbox.removeAttribute('disabled');</span>
<a href="#l119.56"></a><span id="l119.56">   else</span>
<a href="#l119.57"></a><span id="l119.57">   {</span>
<a href="#l119.58"></a><span id="l119.58">     checkbox.setAttribute('disabled', true);</span>
<a href="#l119.59"></a><span id="l119.59">     checkbox.checked = false;</span>
<a href="#l119.60"></a><span id="l119.60">   }</span>
<a href="#l119.61"></a><span id="l119.61"> }</span>
<a href="#l119.62"></a><span id="l119.62"> </span>
<a href="#l119.63"></a><span id="l119.63" class="difflineminus">-function InitDialogWithVirtualFolder(aVirtualFolderURI)</span>
<a href="#l119.64"></a><span id="l119.64" class="difflineplus">+function InitDialogWithVirtualFolder(aVirtualFolder)</span>
<a href="#l119.65"></a><span id="l119.65"> {</span>
<a href="#l119.66"></a><span id="l119.66" class="difflineplus">+  let virtualFolderWrapper =</span>
<a href="#l119.67"></a><span id="l119.67" class="difflineplus">+    VirtualFolderHelper.wrapVirtualFolder(window.arguments[0].folder);</span>
<a href="#l119.68"></a><span id="l119.68" class="difflineplus">+</span>
<a href="#l119.69"></a><span id="l119.69">   // when editing an existing folder, hide the folder picker that stores the parent location of the folder</span>
<a href="#l119.70"></a><span id="l119.70">   document.getElementById(&quot;chooseFolderLocationRow&quot;).collapsed = true;</span>
<a href="#l119.71"></a><span id="l119.71">   var folderNameField = document.getElementById(&quot;name&quot;);</span>
<a href="#l119.72"></a><span id="l119.72">   folderNameField.disabled = true;</span>
<a href="#l119.73"></a><span id="l119.73"> </span>
<a href="#l119.74"></a><span id="l119.74" class="difflineminus">-  var msgFolder = GetMsgFolderFromUri(aVirtualFolderURI);</span>
<a href="#l119.75"></a><span id="l119.75" class="difflineminus">-  var dbFolderInfo = msgFolder.msgDatabase.dBFolderInfo;</span>
<a href="#l119.76"></a><span id="l119.76" class="difflineminus">-</span>
<a href="#l119.77"></a><span id="l119.77" class="difflineminus">-  gSearchFolderURIs = dbFolderInfo.getCharProperty(&quot;searchFolderUri&quot;);</span>
<a href="#l119.78"></a><span id="l119.78" class="difflineminus">-  var searchTermString = dbFolderInfo.getCharProperty(&quot;searchStr&quot;);</span>
<a href="#l119.79"></a><span id="l119.79" class="difflineminus">-  document.getElementById('searchOnline').checked = dbFolderInfo.getBooleanProperty(&quot;searchOnline&quot;, false);</span>
<a href="#l119.80"></a><span id="l119.80" class="difflineminus">-</span>
<a href="#l119.81"></a><span id="l119.81" class="difflineminus">-  // work around to get our search term string converted into a real array of search terms</span>
<a href="#l119.82"></a><span id="l119.82" class="difflineminus">-  var filterService = Components.classes[&quot;@mozilla.org/messenger/services/filters;1&quot;].getService(Components.interfaces.nsIMsgFilterService);</span>
<a href="#l119.83"></a><span id="l119.83" class="difflineminus">-  var filterList = filterService.getTempFilterList(msgFolder);</span>
<a href="#l119.84"></a><span id="l119.84" class="difflineminus">-  gSearchTermSession = filterList.createFilter(&quot;temp&quot;);</span>
<a href="#l119.85"></a><span id="l119.85" class="difflineminus">-  filterList.parseCondition(gSearchTermSession, searchTermString);</span>
<a href="#l119.86"></a><span id="l119.86" class="difflineplus">+  gSearchFolderURIs = virtualFolderWrapper.searchFolderURIs;</span>
<a href="#l119.87"></a><span id="l119.87" class="difflineplus">+  document.getElementById('searchOnline').checked = virtualFolderWrapper.onlineSearch;</span>
<a href="#l119.88"></a><span id="l119.88" class="difflineplus">+  gSearchTermSession = virtualFolderWrapper.searchTermsSession;</span>
<a href="#l119.89"></a><span id="l119.89"> </span>
<a href="#l119.90"></a><span id="l119.90">   setupSearchRows(gSearchTermSession.searchTerms);</span>
<a href="#l119.91"></a><span id="l119.91"> </span>
<a href="#l119.92"></a><span id="l119.92">   // set the name of the folder</span>
<a href="#l119.93"></a><span id="l119.93" class="difflineminus">-  folderNameField.value = msgFolder.prettyName;</span>
<a href="#l119.94"></a><span id="l119.94" class="difflineplus">+  folderNameField.value = aVirtualFolder.prettyName;</span>
<a href="#l119.95"></a><span id="l119.95"> </span>
<a href="#l119.96"></a><span id="l119.96">   // update the window title based on the name of the saved search</span>
<a href="#l119.97"></a><span id="l119.97">   var messengerBundle = document.getElementById(&quot;bundle_messenger&quot;);</span>
<a href="#l119.98"></a><span id="l119.98" class="difflineminus">-  document.title = messengerBundle.getFormattedString('editVirtualFolderPropertiesTitle', [msgFolder.prettyName]);</span>
<a href="#l119.99"></a><span id="l119.99" class="difflineplus">+  document.title = messengerBundle.getFormattedString('editVirtualFolderPropertiesTitle',</span>
<a href="#l119.100"></a><span id="l119.100" class="difflineplus">+                                                      [aVirtualFolder.prettyName]);</span>
<a href="#l119.101"></a><span id="l119.101"> }</span>
<a href="#l119.102"></a><span id="l119.102"> </span>
<a href="#l119.103"></a><span id="l119.103"> function onFolderPick(aEvent) {</span>
<a href="#l119.104"></a><span id="l119.104">   gPickedFolder = aEvent.target._folder;</span>
<a href="#l119.105"></a><span id="l119.105">   document.getElementById(&quot;msgNewFolderPicker&quot;)</span>
<a href="#l119.106"></a><span id="l119.106">           .setAttribute(&quot;label&quot;, gPickedFolder.prettyName);</span>
<a href="#l119.107"></a><span id="l119.107"> }</span>
<a href="#l119.108"></a><span id="l119.108"> </span>
<a href="#l119.109"></a><span id="l119.109" class="difflineat">@@ -177,34 +177,29 @@ function onOK()</span>
<a href="#l119.110"></a><span id="l119.110">                         messengerBundle.getString('alertNoSearchFoldersSelected'));</span>
<a href="#l119.111"></a><span id="l119.111">     return false;</span>
<a href="#l119.112"></a><span id="l119.112">   }</span>
<a href="#l119.113"></a><span id="l119.113"> </span>
<a href="#l119.114"></a><span id="l119.114">   if (window.arguments[0].editExistingFolder)</span>
<a href="#l119.115"></a><span id="l119.115">   {</span>
<a href="#l119.116"></a><span id="l119.116">     // update the search terms</span>
<a href="#l119.117"></a><span id="l119.117">     saveSearchTerms(gSearchTermSession.searchTerms, gSearchTermSession);</span>
<a href="#l119.118"></a><span id="l119.118" class="difflineminus">-    var searchTermString = getSearchTermString(gSearchTermSession.searchTerms);</span>
<a href="#l119.119"></a><span id="l119.119" class="difflineminus">-</span>
<a href="#l119.120"></a><span id="l119.120" class="difflineminus">-    var msgFolder = window.arguments[0].folder;</span>
<a href="#l119.121"></a><span id="l119.121" class="difflineminus">-    var msgDatabase = msgFolder.msgDatabase;</span>
<a href="#l119.122"></a><span id="l119.122" class="difflineminus">-    var dbFolderInfo = msgDatabase.dBFolderInfo;</span>
<a href="#l119.123"></a><span id="l119.123" class="difflineminus">-</span>
<a href="#l119.124"></a><span id="l119.124" class="difflineminus">-    // set the view string as a property of the db folder info</span>
<a href="#l119.125"></a><span id="l119.125" class="difflineminus">-    // set the original folder name as well.</span>
<a href="#l119.126"></a><span id="l119.126" class="difflineminus">-    dbFolderInfo.setCharProperty(&quot;searchStr&quot;, searchTermString);</span>
<a href="#l119.127"></a><span id="l119.127" class="difflineminus">-    dbFolderInfo.setCharProperty(&quot;searchFolderUri&quot;, gSearchFolderURIs);</span>
<a href="#l119.128"></a><span id="l119.128" class="difflineminus">-    dbFolderInfo.setBooleanProperty(&quot;searchOnline&quot;, searchOnline);</span>
<a href="#l119.129"></a><span id="l119.129" class="difflineminus">-    msgDatabase.Close(true);</span>
<a href="#l119.130"></a><span id="l119.130" class="difflineplus">+    // save the settings</span>
<a href="#l119.131"></a><span id="l119.131" class="difflineplus">+    let virtualFolderWrapper =</span>
<a href="#l119.132"></a><span id="l119.132" class="difflineplus">+      VirtualFolderHelper.wrapVirtualFolder(window.arguments[0].folder);</span>
<a href="#l119.133"></a><span id="l119.133" class="difflineplus">+    virtualFolderWrapper.searchTerms = gSearchTermSession.searchTerms;</span>
<a href="#l119.134"></a><span id="l119.134" class="difflineplus">+    virtualFolderWrapper.searchFolders = gSearchFolderURIs;</span>
<a href="#l119.135"></a><span id="l119.135" class="difflineplus">+    virtualFolderWrapper.onlineSearch = searchOnline;</span>
<a href="#l119.136"></a><span id="l119.136" class="difflineplus">+    virtualFolderWrapper.cleanUpMessageDatabase();</span>
<a href="#l119.137"></a><span id="l119.137"> </span>
<a href="#l119.138"></a><span id="l119.138">     var accountManager = Components.classes[&quot;@mozilla.org/messenger/account-manager;1&quot;].getService(Components.interfaces.nsIMsgAccountManager);</span>
<a href="#l119.139"></a><span id="l119.139">     accountManager.saveVirtualFolders();</span>
<a href="#l119.140"></a><span id="l119.140"> </span>
<a href="#l119.141"></a><span id="l119.141">     if (window.arguments[0].onOKCallback)</span>
<a href="#l119.142"></a><span id="l119.142" class="difflineminus">-      window.arguments[0].onOKCallback(msgFolder.URI);</span>
<a href="#l119.143"></a><span id="l119.143" class="difflineplus">+      window.arguments[0].onOKCallback(virtualFolderWrapper.virtualFolder.URI);</span>
<a href="#l119.144"></a><span id="l119.144">     return true;</span>
<a href="#l119.145"></a><span id="l119.145">   }</span>
<a href="#l119.146"></a><span id="l119.146">   var uri = gPickedFolder.URI;</span>
<a href="#l119.147"></a><span id="l119.147">   if (name &amp;&amp; uri) // create a new virtual folder</span>
<a href="#l119.148"></a><span id="l119.148">   {</span>
<a href="#l119.149"></a><span id="l119.149">     // check to see if we already have a folder with the same name and alert the user if so...</span>
<a href="#l119.150"></a><span id="l119.150">     var parentFolder = GetMsgFolderFromUri(uri);</span>
<a href="#l119.151"></a><span id="l119.151">     </span>
<a href="#l119.152"></a><span id="l119.152" class="difflineat">@@ -225,17 +220,19 @@ function onOK()</span>
<a href="#l119.153"></a><span id="l119.153">         Components.classes[&quot;@mozilla.org/embedcomp/prompt-service;1&quot;]</span>
<a href="#l119.154"></a><span id="l119.154">                   .getService(Components.interfaces.nsIPromptService);</span>
<a href="#l119.155"></a><span id="l119.155">       promptService.alert(window, null,</span>
<a href="#l119.156"></a><span id="l119.156">                           messengerBundle.getString('folderExists'));</span>
<a href="#l119.157"></a><span id="l119.157">       return false;</span>
<a href="#l119.158"></a><span id="l119.158">     }</span>
<a href="#l119.159"></a><span id="l119.159">     </span>
<a href="#l119.160"></a><span id="l119.160">     saveSearchTerms(gSearchTermSession.searchTerms, gSearchTermSession);</span>
<a href="#l119.161"></a><span id="l119.161" class="difflineminus">-    CreateVirtualFolder(name, parentFolder, gSearchFolderURIs, gSearchTermSession.searchTerms, searchOnline);</span>
<a href="#l119.162"></a><span id="l119.162" class="difflineplus">+    VirtualFolderHelper.createNewVirtualFolder(name, parentFolder, gSearchFolderURIs,</span>
<a href="#l119.163"></a><span id="l119.163" class="difflineplus">+                                               gSearchTermSession.searchTerms,</span>
<a href="#l119.164"></a><span id="l119.164" class="difflineplus">+                                               searchOnline);</span>
<a href="#l119.165"></a><span id="l119.165">   }</span>
<a href="#l119.166"></a><span id="l119.166"> </span>
<a href="#l119.167"></a><span id="l119.167">   return true;</span>
<a href="#l119.168"></a><span id="l119.168"> }</span>
<a href="#l119.169"></a><span id="l119.169"> </span>
<a href="#l119.170"></a><span id="l119.170"> function onCancel()</span>
<a href="#l119.171"></a><span id="l119.171"> {</span>
<a href="#l119.172"></a><span id="l119.172">   // close the window</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l120.1"></a><span id="l120.1" class="difflineminus">--- a/mailnews/base/resources/content/virtualFolderProperties.xul</span>
<a href="#l120.2"></a><span id="l120.2" class="difflineplus">+++ b/mailnews/base/resources/content/virtualFolderProperties.xul</span>
<a href="#l120.3"></a><span id="l120.3" class="difflineat">@@ -52,17 +52,18 @@</span>
<a href="#l120.4"></a><span id="l120.4"> ]&gt;</span>
<a href="#l120.5"></a><span id="l120.5"> </span>
<a href="#l120.6"></a><span id="l120.6"> &lt;dialog xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;</span>
<a href="#l120.7"></a><span id="l120.7">         id=&quot;virtualFolderPropertiesDialog&quot;</span>
<a href="#l120.8"></a><span id="l120.8">         title=&quot;&amp;virtualFolderProperties.title;&quot;</span>
<a href="#l120.9"></a><span id="l120.9">         onload=&quot;onLoad();&quot;</span>
<a href="#l120.10"></a><span id="l120.10">         buttons=&quot;accept,cancel&quot;</span>
<a href="#l120.11"></a><span id="l120.11">         style=&quot;width: 50em; height: 28em;&quot;</span>
<a href="#l120.12"></a><span id="l120.12" class="difflineminus">-	      ondialogaccept=&quot;return onOK();&quot;&gt;</span>
<a href="#l120.13"></a><span id="l120.13" class="difflineplus">+        windowtype=&quot;mailnews:virtualFolderProperties&quot;</span>
<a href="#l120.14"></a><span id="l120.14" class="difflineplus">+        ondialogaccept=&quot;return onOK();&quot;&gt;</span>
<a href="#l120.15"></a><span id="l120.15"> </span>
<a href="#l120.16"></a><span id="l120.16">   &lt;stringbundleset id=&quot;stringbundleset&quot;&gt;</span>
<a href="#l120.17"></a><span id="l120.17">     &lt;stringbundle id=&quot;bundle_search&quot;    src=&quot;chrome://messenger/locale/search.properties&quot;/&gt;</span>
<a href="#l120.18"></a><span id="l120.18">     &lt;stringbundle id=&quot;bundle_messenger&quot; src=&quot;chrome://messenger/locale/messenger.properties&quot;/&gt;</span>
<a href="#l120.19"></a><span id="l120.19">   &lt;/stringbundleset&gt;</span>
<a href="#l120.20"></a><span id="l120.20"> </span>
<a href="#l120.21"></a><span id="l120.21">   &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://messenger/content/mailCommands.js&quot;/&gt;</span>
<a href="#l120.22"></a><span id="l120.22">   &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://messenger/content/commandglue.js&quot;/&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l121.1"></a><span id="l121.1" class="difflineminus">--- a/mailnews/base/search/src/nsMsgSearchAdapter.cpp</span>
<a href="#l121.2"></a><span id="l121.2" class="difflineplus">+++ b/mailnews/base/search/src/nsMsgSearchAdapter.cpp</span>
<a href="#l121.3"></a><span id="l121.3" class="difflineat">@@ -714,19 +714,23 @@ nsresult nsMsgSearchAdapter::EncodeImap </span>
<a href="#l121.4"></a><span id="l121.4">   // create our expression</span>
<a href="#l121.5"></a><span id="l121.5">   nsMsgSearchBoolExpression * expression = new nsMsgSearchBoolExpression();</span>
<a href="#l121.6"></a><span id="l121.6">   if (!expression)</span>
<a href="#l121.7"></a><span id="l121.7">     return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l121.8"></a><span id="l121.8"> </span>
<a href="#l121.9"></a><span id="l121.9">   for (i = 0; i &lt; termCount &amp;&amp; NS_SUCCEEDED(err); i++)</span>
<a href="#l121.10"></a><span id="l121.10">   {</span>
<a href="#l121.11"></a><span id="l121.11">     char *termEncoding;</span>
<a href="#l121.12"></a><span id="l121.12" class="difflineplus">+    PRBool matchAll;</span>
<a href="#l121.13"></a><span id="l121.13">     nsCOMPtr&lt;nsIMsgSearchTerm&gt; pTerm;</span>
<a href="#l121.14"></a><span id="l121.14">     searchTerms-&gt;QueryElementAt(i, NS_GET_IID(nsIMsgSearchTerm),</span>
<a href="#l121.15"></a><span id="l121.15">       (void **)getter_AddRefs(pTerm));</span>
<a href="#l121.16"></a><span id="l121.16" class="difflineplus">+    pTerm-&gt;GetMatchAll(&amp;matchAll);</span>
<a href="#l121.17"></a><span id="l121.17" class="difflineplus">+    if (matchAll)</span>
<a href="#l121.18"></a><span id="l121.18" class="difflineplus">+      continue;</span>
<a href="#l121.19"></a><span id="l121.19">     err = EncodeImapTerm (pTerm, reallyDredd, srcCharset, destCharset, &amp;termEncoding);</span>
<a href="#l121.20"></a><span id="l121.20">     if (NS_SUCCEEDED(err) &amp;&amp; nsnull != termEncoding)</span>
<a href="#l121.21"></a><span id="l121.21">     {</span>
<a href="#l121.22"></a><span id="l121.22">       expression = nsMsgSearchBoolExpression::AddSearchTerm(expression, pTerm, termEncoding);</span>
<a href="#l121.23"></a><span id="l121.23">       delete [] termEncoding;</span>
<a href="#l121.24"></a><span id="l121.24">     }</span>
<a href="#l121.25"></a><span id="l121.25">   }</span>
<a href="#l121.26"></a><span id="l121.26"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l122.1"></a><span id="l122.1" class="difflineminus">--- a/mailnews/base/search/src/nsMsgSearchTerm.cpp</span>
<a href="#l122.2"></a><span id="l122.2" class="difflineplus">+++ b/mailnews/base/search/src/nsMsgSearchTerm.cpp</span>
<a href="#l122.3"></a><span id="l122.3" class="difflineat">@@ -788,28 +788,28 @@ nsresult nsMsgSearchTerm::MatchArbitrary</span>
<a href="#l122.4"></a><span id="l122.4">       // strip trailing white space</span>
<a href="#l122.5"></a><span id="l122.5">       char * end = buf_end - 1;</span>
<a href="#l122.6"></a><span id="l122.6">       while (end &gt; headerValue &amp;&amp; isspace(*end)) // while we haven't gone back past the start and we are white space....</span>
<a href="#l122.7"></a><span id="l122.7">       {</span>
<a href="#l122.8"></a><span id="l122.8">         *end = '\0';  // eat up the white space</span>
<a href="#l122.9"></a><span id="l122.9">         end--;      // move back and examine the previous character....</span>
<a href="#l122.10"></a><span id="l122.10">       }</span>
<a href="#l122.11"></a><span id="l122.11"> </span>
<a href="#l122.12"></a><span id="l122.12" class="difflineminus">-      if (headerValue &lt; buf_end &amp;&amp; *headerValue) // make sure buf has info besides just the header</span>
<a href="#l122.13"></a><span id="l122.13" class="difflineplus">+      // Make sure buf has info besides just the header.</span>
<a href="#l122.14"></a><span id="l122.14" class="difflineplus">+      // Otherwise, it's just an empty header.</span>
<a href="#l122.15"></a><span id="l122.15" class="difflineplus">+      if (headerValue &lt; buf_end &amp;&amp; *headerValue)</span>
<a href="#l122.16"></a><span id="l122.16">       {</span>
<a href="#l122.17"></a><span id="l122.17">         PRBool result2;</span>
<a href="#l122.18"></a><span id="l122.18">         err = MatchRfc2047String(headerValue, charset, charsetOverride, &amp;result2);  // match value with the other info...</span>
<a href="#l122.19"></a><span id="l122.19">         if (result != result2) // if we found a match</span>
<a href="#l122.20"></a><span id="l122.20">         {</span>
<a href="#l122.21"></a><span id="l122.21">           searchingHeaders = PR_FALSE;   // then stop examining the headers</span>
<a href="#l122.22"></a><span id="l122.22">           result = result2;</span>
<a href="#l122.23"></a><span id="l122.23">         }</span>
<a href="#l122.24"></a><span id="l122.24">       }</span>
<a href="#l122.25"></a><span id="l122.25" class="difflineminus">-      else</span>
<a href="#l122.26"></a><span id="l122.26" class="difflineminus">-        NS_ASSERTION(PR_FALSE, &quot;error matching arbitrary headers&quot;); // mscott --&gt; i'd be curious if there is a case where this fails....</span>
<a href="#l122.27"></a><span id="l122.27">     }</span>
<a href="#l122.28"></a><span id="l122.28">     if (EMPTY_MESSAGE_LINE(buf))</span>
<a href="#l122.29"></a><span id="l122.29">       searchingHeaders = PR_FALSE;</span>
<a href="#l122.30"></a><span id="l122.30">   }</span>
<a href="#l122.31"></a><span id="l122.31">   delete bodyHandler;</span>
<a href="#l122.32"></a><span id="l122.32">   *pResult = result;</span>
<a href="#l122.33"></a><span id="l122.33">   return err;</span>
<a href="#l122.34"></a><span id="l122.34"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l123.1"></a><span id="l123.1" class="difflineminus">--- a/mailnews/base/src/dbViewWrapper.js</span>
<a href="#l123.2"></a><span id="l123.2" class="difflineplus">+++ b/mailnews/base/src/dbViewWrapper.js</span>
<a href="#l123.3"></a><span id="l123.3" class="difflineat">@@ -45,16 +45,20 @@ const Cu = Components.utils;</span>
<a href="#l123.4"></a><span id="l123.4"> Cu.import(&quot;resource://app/modules/mailViewManager.js&quot;);</span>
<a href="#l123.5"></a><span id="l123.5"> Cu.import(&quot;resource://app/modules/searchSpec.js&quot;);</span>
<a href="#l123.6"></a><span id="l123.6"> Cu.import(&quot;resource://app/modules/virtualFolderWrapper.js&quot;);</span>
<a href="#l123.7"></a><span id="l123.7"> </span>
<a href="#l123.8"></a><span id="l123.8"> const nsMsgFolderFlags = Ci.nsMsgFolderFlags;</span>
<a href="#l123.9"></a><span id="l123.9"> const nsMsgViewType = Ci.nsMsgViewType;</span>
<a href="#l123.10"></a><span id="l123.10"> const nsMsgViewFlagsType = Ci.nsMsgViewFlagsType;</span>
<a href="#l123.11"></a><span id="l123.11"> const nsMsgViewSortType = Ci.nsMsgViewSortType;</span>
<a href="#l123.12"></a><span id="l123.12" class="difflineplus">+const nsMsgViewSortOrder = Ci.nsMsgViewSortOrder;</span>
<a href="#l123.13"></a><span id="l123.13" class="difflineplus">+const nsMsgMessageFlags = Ci.nsMsgMessageFlags;</span>
<a href="#l123.14"></a><span id="l123.14" class="difflineplus">+</span>
<a href="#l123.15"></a><span id="l123.15" class="difflineplus">+const MSG_VIEW_FLAG_DUMMY = 0x20000000;</span>
<a href="#l123.16"></a><span id="l123.16"> </span>
<a href="#l123.17"></a><span id="l123.17"> /**</span>
<a href="#l123.18"></a><span id="l123.18">  * Helper singleton for DBViewWrapper that tells instances when something</span>
<a href="#l123.19"></a><span id="l123.19">  *  interesting is happening to the folder(s) they care about.  The rationale</span>
<a href="#l123.20"></a><span id="l123.20">  *  for this is to:</span>
<a href="#l123.21"></a><span id="l123.21">  * - reduce listener overhead (although arguably the events we listen to are</span>
<a href="#l123.22"></a><span id="l123.22">  *     fairly rare)</span>
<a href="#l123.23"></a><span id="l123.23">  * - make testing / verification easier by centralizing and exposing listeners.</span>
<a href="#l123.24"></a><span id="l123.24" class="difflineat">@@ -75,27 +79,23 @@ var FolderNotificationHelper = {</span>
<a href="#l123.25"></a><span id="l123.25">   _interestedWrappers: {},</span>
<a href="#l123.26"></a><span id="l123.26"> </span>
<a href="#l123.27"></a><span id="l123.27">   /**</span>
<a href="#l123.28"></a><span id="l123.28">    * Initialize our listeners.  We currently don't bother cleaning these up</span>
<a href="#l123.29"></a><span id="l123.29">    *  because we are a singleton and if anyone imports us, they probably want</span>
<a href="#l123.30"></a><span id="l123.30">    *  us for as long as their application so shall live.</span>
<a href="#l123.31"></a><span id="l123.31">    */</span>
<a href="#l123.32"></a><span id="l123.32">   _init: function FolderNotificationHelper__init() {</span>
<a href="#l123.33"></a><span id="l123.33" class="difflineminus">-    let atomService =</span>
<a href="#l123.34"></a><span id="l123.34" class="difflineminus">-      Cc[&quot;@mozilla.org/atom-service;1&quot;]</span>
<a href="#l123.35"></a><span id="l123.35" class="difflineminus">-        .getService(Ci.nsIAtomService);</span>
<a href="#l123.36"></a><span id="l123.36" class="difflineminus">-      this._kFolderLoadedAtom = atomService.getAtom(&quot;FolderLoaded&quot;);</span>
<a href="#l123.37"></a><span id="l123.37" class="difflineminus">-</span>
<a href="#l123.38"></a><span id="l123.38">     // register with the session for our folded loaded notifications</span>
<a href="#l123.39"></a><span id="l123.39">     let mailSession =</span>
<a href="#l123.40"></a><span id="l123.40">       Cc[&quot;@mozilla.org/messenger/services/session;1&quot;]</span>
<a href="#l123.41"></a><span id="l123.41">         .getService(Ci.nsIMsgMailSession);</span>
<a href="#l123.42"></a><span id="l123.42">     mailSession.AddFolderListener(this,</span>
<a href="#l123.43"></a><span id="l123.43" class="difflineminus">-                                  Ci.nsIFolderListener.event);</span>
<a href="#l123.44"></a><span id="l123.44" class="difflineplus">+                                  Ci.nsIFolderListener.event |</span>
<a href="#l123.45"></a><span id="l123.45" class="difflineplus">+                                  Ci.nsIFolderListener.intPropertyChanged);</span>
<a href="#l123.46"></a><span id="l123.46"> </span>
<a href="#l123.47"></a><span id="l123.47">     // register with the notification service for deleted folder notifications</span>
<a href="#l123.48"></a><span id="l123.48">     let notificationService =</span>
<a href="#l123.49"></a><span id="l123.49">       Cc[&quot;@mozilla.org/messenger/msgnotificationservice;1&quot;]</span>
<a href="#l123.50"></a><span id="l123.50">         .getService(Ci.nsIMsgFolderNotificationService);</span>
<a href="#l123.51"></a><span id="l123.51">     notificationService.addListener(this,</span>
<a href="#l123.52"></a><span id="l123.52">       Ci.nsIMsgFolderNotificationService.folderDeleted |</span>
<a href="#l123.53"></a><span id="l123.53">       // we need to track renames because we key off of URIs. frick.</span>
<a href="#l123.54"></a><span id="l123.54" class="difflineat">@@ -138,17 +138,17 @@ var FolderNotificationHelper = {</span>
<a href="#l123.55"></a><span id="l123.55">    * @param aNotherFolder A folder that may or may not be in aFolders.</span>
<a href="#l123.56"></a><span id="l123.56">    * @param aViewWrapper The view wrapper that is up to no good.</span>
<a href="#l123.57"></a><span id="l123.57">    */</span>
<a href="#l123.58"></a><span id="l123.58">   stalkFolders: function FolderNotificationHelper_stalkFolders(</span>
<a href="#l123.59"></a><span id="l123.59">       aFolders, aNotherFolder, aViewWrapper) {</span>
<a href="#l123.60"></a><span id="l123.60">     let folders = aFolders.concat();</span>
<a href="#l123.61"></a><span id="l123.61">     if (aNotherFolder &amp;&amp; folders.indexOf(aNotherFolder) == -1)</span>
<a href="#l123.62"></a><span id="l123.62">       folders.push(aNotherFolder);</span>
<a href="#l123.63"></a><span id="l123.63" class="difflineminus">-    for each (let [, folder] in Iterator(aFolders)) {</span>
<a href="#l123.64"></a><span id="l123.64" class="difflineplus">+    for each (let [, folder] in Iterator(folders)) {</span>
<a href="#l123.65"></a><span id="l123.65">       let wrappers = this._interestedWrappers[folder.URI];</span>
<a href="#l123.66"></a><span id="l123.66">       if (wrappers == null)</span>
<a href="#l123.67"></a><span id="l123.67">         wrappers = this._interestedWrappers[folder.URI] = [];</span>
<a href="#l123.68"></a><span id="l123.68">       wrappers.push(aViewWrapper);</span>
<a href="#l123.69"></a><span id="l123.69">     }</span>
<a href="#l123.70"></a><span id="l123.70">   },</span>
<a href="#l123.71"></a><span id="l123.71"> </span>
<a href="#l123.72"></a><span id="l123.72">   /**</span>
<a href="#l123.73"></a><span id="l123.73" class="difflineat">@@ -195,38 +195,72 @@ var FolderNotificationHelper = {</span>
<a href="#l123.74"></a><span id="l123.74">     for each (let [folderURI, wrappers] in</span>
<a href="#l123.75"></a><span id="l123.75">               Iterator(this._interestedWrappers)) {</span>
<a href="#l123.76"></a><span id="l123.76">       return true;</span>
<a href="#l123.77"></a><span id="l123.77">     }</span>
<a href="#l123.78"></a><span id="l123.78">     return false;</span>
<a href="#l123.79"></a><span id="l123.79">   },</span>
<a href="#l123.80"></a><span id="l123.80"> </span>
<a href="#l123.81"></a><span id="l123.81">   /* ***** Notifications ***** */</span>
<a href="#l123.82"></a><span id="l123.82" class="difflineplus">+  _notifyHelper: function FolderNotificationHelper__notifyHelper(aFolder,</span>
<a href="#l123.83"></a><span id="l123.83" class="difflineplus">+                                                                 aHandlerName) {</span>
<a href="#l123.84"></a><span id="l123.84" class="difflineplus">+    let wrappers = this._interestedWrappers[aFolder.URI];</span>
<a href="#l123.85"></a><span id="l123.85" class="difflineplus">+    if (wrappers) {</span>
<a href="#l123.86"></a><span id="l123.86" class="difflineplus">+      // clone the list to avoid confusing mutation by listeners</span>
<a href="#l123.87"></a><span id="l123.87" class="difflineplus">+      for each (let [, wrapper] in Iterator(wrappers.concat())) {</span>
<a href="#l123.88"></a><span id="l123.88" class="difflineplus">+        wrapper[aHandlerName](aFolder);</span>
<a href="#l123.89"></a><span id="l123.89" class="difflineplus">+      }</span>
<a href="#l123.90"></a><span id="l123.90" class="difflineplus">+    }</span>
<a href="#l123.91"></a><span id="l123.91" class="difflineplus">+  },</span>
<a href="#l123.92"></a><span id="l123.92"> </span>
<a href="#l123.93"></a><span id="l123.93">   OnItemEvent: function FolderNotificationHelper_OnItemEvent(</span>
<a href="#l123.94"></a><span id="l123.94">       aFolder, aEvent) {</span>
<a href="#l123.95"></a><span id="l123.95" class="difflineminus">-    if (aEvent == this._kFolderLoadedAtom) {</span>
<a href="#l123.96"></a><span id="l123.96" class="difflineplus">+    let eventType = aEvent.toString();</span>
<a href="#l123.97"></a><span id="l123.97" class="difflineplus">+    if (eventType == &quot;FolderLoaded&quot;) {</span>
<a href="#l123.98"></a><span id="l123.98">       let folderURI = aFolder.URI;</span>
<a href="#l123.99"></a><span id="l123.99">       let widgets = this._pendingFolderUriToViewWrapperLists[folderURI];</span>
<a href="#l123.100"></a><span id="l123.100">       if (widgets) {</span>
<a href="#l123.101"></a><span id="l123.101">         for each (let [, widget] in Iterator(widgets)) {</span>
<a href="#l123.102"></a><span id="l123.102">           // we are friends, this is an explicit relationship.</span>
<a href="#l123.103"></a><span id="l123.103">           // (we don't use a generic callback mechanism because the 'this' stuff</span>
<a href="#l123.104"></a><span id="l123.104">           //  gets ugly and no one else should be hooking in at this level.)</span>
<a href="#l123.105"></a><span id="l123.105">           try {</span>
<a href="#l123.106"></a><span id="l123.106">             widget._folderLoaded(aFolder);</span>
<a href="#l123.107"></a><span id="l123.107">           }</span>
<a href="#l123.108"></a><span id="l123.108">           catch (ex) {</span>
<a href="#l123.109"></a><span id="l123.109">             dump(&quot;``` EXCEPTION DURING NOTIFY: &quot; + ex.fileName + &quot;:&quot; +</span>
<a href="#l123.110"></a><span id="l123.110">                  ex.lineNumber + &quot;: &quot; + ex + &quot;\n&quot;);</span>
<a href="#l123.111"></a><span id="l123.111" class="difflineplus">+            if (ex.stack)</span>
<a href="#l123.112"></a><span id="l123.112" class="difflineplus">+              dump(&quot;STACK: &quot; + ex.stack + &quot;\n&quot;);</span>
<a href="#l123.113"></a><span id="l123.113" class="difflineplus">+            Cu.reportError(ex);</span>
<a href="#l123.114"></a><span id="l123.114">           }</span>
<a href="#l123.115"></a><span id="l123.115">         }</span>
<a href="#l123.116"></a><span id="l123.116">         delete this._pendingFolderUriToViewWrapperLists[folderURI];</span>
<a href="#l123.117"></a><span id="l123.117">       }</span>
<a href="#l123.118"></a><span id="l123.118">     }</span>
<a href="#l123.119"></a><span id="l123.119" class="difflineplus">+    else if (eventType == &quot;AboutToCompact&quot;) {</span>
<a href="#l123.120"></a><span id="l123.120" class="difflineplus">+      this._notifyHelper(aFolder, &quot;_aboutToCompactFolder&quot;);</span>
<a href="#l123.121"></a><span id="l123.121" class="difflineplus">+    }</span>
<a href="#l123.122"></a><span id="l123.122" class="difflineplus">+    else if (eventType == &quot;CompactCompleted&quot;) {</span>
<a href="#l123.123"></a><span id="l123.123" class="difflineplus">+      this._notifyHelper(aFolder, &quot;_compactedFolder&quot;);</span>
<a href="#l123.124"></a><span id="l123.124" class="difflineplus">+    }</span>
<a href="#l123.125"></a><span id="l123.125" class="difflineplus">+    else if (eventType == &quot;DeleteOrMoveMsgCompleted&quot;) {</span>
<a href="#l123.126"></a><span id="l123.126" class="difflineplus">+      this._notifyHelper(aFolder, &quot;_deleteCompleted&quot;);</span>
<a href="#l123.127"></a><span id="l123.127" class="difflineplus">+    }</span>
<a href="#l123.128"></a><span id="l123.128" class="difflineplus">+    else if (eventType == &quot;DeleteOrMoveMsgFailed&quot;) {</span>
<a href="#l123.129"></a><span id="l123.129" class="difflineplus">+      this._notifyHelper(aFolder, &quot;_deleteFailed&quot;);</span>
<a href="#l123.130"></a><span id="l123.130" class="difflineplus">+    }</span>
<a href="#l123.131"></a><span id="l123.131" class="difflineplus">+</span>
<a href="#l123.132"></a><span id="l123.132" class="difflineplus">+  },</span>
<a href="#l123.133"></a><span id="l123.133" class="difflineplus">+</span>
<a href="#l123.134"></a><span id="l123.134" class="difflineplus">+  OnItemIntPropertyChanged: function(aFolder, aProperty, aOldValue, aNewValue) {</span>
<a href="#l123.135"></a><span id="l123.135" class="difflineplus">+    let propertyString = aProperty.toString();</span>
<a href="#l123.136"></a><span id="l123.136" class="difflineplus">+    if ((propertyString == &quot;TotalMessages&quot;) ||</span>
<a href="#l123.137"></a><span id="l123.137" class="difflineplus">+        (propertyString == &quot;TotalUnreadMessages&quot;))</span>
<a href="#l123.138"></a><span id="l123.138" class="difflineplus">+      this._notifyHelper(aFolder, &quot;_messageCountsChanged&quot;);</span>
<a href="#l123.139"></a><span id="l123.139">   },</span>
<a href="#l123.140"></a><span id="l123.140"> </span>
<a href="#l123.141"></a><span id="l123.141">   _folderMoveHelper: function(aOldFolder, aNewFolder) {</span>
<a href="#l123.142"></a><span id="l123.142">     let oldURI = aOldFolder.URI;</span>
<a href="#l123.143"></a><span id="l123.143">     let newURI = aNewFolder.URI;</span>
<a href="#l123.144"></a><span id="l123.144">     // fix up our listener tables.</span>
<a href="#l123.145"></a><span id="l123.145">     if (oldURI in this._pendingFolderUriToViewWrapperLists) {</span>
<a href="#l123.146"></a><span id="l123.146">       this._pendingFolderUriToViewWrapperLists[newURI] =</span>
<a href="#l123.147"></a><span id="l123.147" class="difflineat">@@ -271,17 +305,17 @@ var FolderNotificationHelper = {</span>
<a href="#l123.148"></a><span id="l123.148"> </span>
<a href="#l123.149"></a><span id="l123.149">   folderDeleted: function FolderNotificationHelper_folderDeleted(aFolder) {</span>
<a href="#l123.150"></a><span id="l123.150">     let wrappers = this._interestedWrappers[aFolder.URI];</span>
<a href="#l123.151"></a><span id="l123.151">     if (wrappers) {</span>
<a href="#l123.152"></a><span id="l123.152">       // clone the list to avoid confusing mutation by listeners</span>
<a href="#l123.153"></a><span id="l123.153">       for each (let [, wrapper] in Iterator(wrappers.concat())) {</span>
<a href="#l123.154"></a><span id="l123.154">         wrapper._folderDeleted(aFolder);</span>
<a href="#l123.155"></a><span id="l123.155">       }</span>
<a href="#l123.156"></a><span id="l123.156" class="difflineminus">-      // if the folder is deleted, it's not going to get deleted again.</span>
<a href="#l123.157"></a><span id="l123.157" class="difflineplus">+      // if the folder is deleted, it's not going to ever do anything again</span>
<a href="#l123.158"></a><span id="l123.158">       delete this._interestedWrappers[aFolder.URI];</span>
<a href="#l123.159"></a><span id="l123.159">     }</span>
<a href="#l123.160"></a><span id="l123.160">   },</span>
<a href="#l123.161"></a><span id="l123.161"> };</span>
<a href="#l123.162"></a><span id="l123.162"> FolderNotificationHelper._init();</span>
<a href="#l123.163"></a><span id="l123.163"> </span>
<a href="#l123.164"></a><span id="l123.164"> </span>
<a href="#l123.165"></a><span id="l123.165"> /**</span>
<a href="#l123.166"></a><span id="l123.166" class="difflineat">@@ -364,64 +398,117 @@ IDBViewWrapperListener.prototype = {</span>
<a href="#l123.167"></a><span id="l123.167">    *  is fundamentally a UI issue.  Additionally, because the MsgCreateDBView</span>
<a href="#l123.168"></a><span id="l123.168">    *  notification consumers assume gDBView whose exposure is affected by tabs,</span>
<a href="#l123.169"></a><span id="l123.169">    *  the tab logic needs to be involved.</span>
<a href="#l123.170"></a><span id="l123.170">    */</span>
<a href="#l123.171"></a><span id="l123.171">   onCreatedView: function() {</span>
<a href="#l123.172"></a><span id="l123.172">   },</span>
<a href="#l123.173"></a><span id="l123.173"> </span>
<a href="#l123.174"></a><span id="l123.174">   /**</span>
<a href="#l123.175"></a><span id="l123.175" class="difflineplus">+   * This event is generated just before we close/destroy a message view.</span>
<a href="#l123.176"></a><span id="l123.176" class="difflineplus">+   *</span>
<a href="#l123.177"></a><span id="l123.177" class="difflineplus">+   * @param aFolderIsComingBack Indicates whether we are planning to create a</span>
<a href="#l123.178"></a><span id="l123.178" class="difflineplus">+   *     new view to display the same folder after we destroy this view.  This</span>
<a href="#l123.179"></a><span id="l123.179" class="difflineplus">+   *     will be the case unless we are switching to display a new folder or</span>
<a href="#l123.180"></a><span id="l123.180" class="difflineplus">+   *     closing the view wrapper entirely.</span>
<a href="#l123.181"></a><span id="l123.181" class="difflineplus">+   */</span>
<a href="#l123.182"></a><span id="l123.182" class="difflineplus">+  onDestroyingView: function(aFolderIsComingBack) {</span>
<a href="#l123.183"></a><span id="l123.183" class="difflineplus">+  },</span>
<a href="#l123.184"></a><span id="l123.184" class="difflineplus">+</span>
<a href="#l123.185"></a><span id="l123.185" class="difflineplus">+  /**</span>
<a href="#l123.186"></a><span id="l123.186">    * Generated when the folder is being entered for display.  This is the chance</span>
<a href="#l123.187"></a><span id="l123.187">    *  for the listener to affect any UI-related changes to the folder required.</span>
<a href="#l123.188"></a><span id="l123.188">    *  Currently, this just means setting the header cache size (which needs to</span>
<a href="#l123.189"></a><span id="l123.189">    *  be proportional to the number of lines in the tree view, and is thus a</span>
<a href="#l123.190"></a><span id="l123.190">    *  UI issue.)</span>
<a href="#l123.191"></a><span id="l123.191">    */</span>
<a href="#l123.192"></a><span id="l123.192">   onDisplayingFolder: function() {</span>
<a href="#l123.193"></a><span id="l123.193">   },</span>
<a href="#l123.194"></a><span id="l123.194"> </span>
<a href="#l123.195"></a><span id="l123.195">   /**</span>
<a href="#l123.196"></a><span id="l123.196" class="difflineplus">+   * Generated when we are leaving a folder.</span>
<a href="#l123.197"></a><span id="l123.197" class="difflineplus">+   */</span>
<a href="#l123.198"></a><span id="l123.198" class="difflineplus">+  onLeavingFolder: function() {</span>
<a href="#l123.199"></a><span id="l123.199" class="difflineplus">+  },</span>
<a href="#l123.200"></a><span id="l123.200" class="difflineplus">+</span>
<a href="#l123.201"></a><span id="l123.201" class="difflineplus">+  /**</span>
<a href="#l123.202"></a><span id="l123.202">    * Things to do once all the messages that should show up in a folder have</span>
<a href="#l123.203"></a><span id="l123.203">    *  shown up.  For a real folder, this happens when the folder is entered.</span>
<a href="#l123.204"></a><span id="l123.204">    *  For a (multi-folder) virtual folder, this happens when the search</span>
<a href="#l123.205"></a><span id="l123.205">    *  completes.</span>
<a href="#l123.206"></a><span id="l123.206">    */</span>
<a href="#l123.207"></a><span id="l123.207">   onAllMessagesLoaded: function() {</span>
<a href="#l123.208"></a><span id="l123.208">   },</span>
<a href="#l123.209"></a><span id="l123.209"> </span>
<a href="#l123.210"></a><span id="l123.210">   /**</span>
<a href="#l123.211"></a><span id="l123.211">    * The mail view changed.  The mail view widget is likely to care about this.</span>
<a href="#l123.212"></a><span id="l123.212">    */</span>
<a href="#l123.213"></a><span id="l123.213" class="difflineminus">-  onMailViewChanged: function () {</span>
<a href="#l123.214"></a><span id="l123.214" class="difflineplus">+  onMailViewChanged: function() {</span>
<a href="#l123.215"></a><span id="l123.215" class="difflineplus">+  },</span>
<a href="#l123.216"></a><span id="l123.216"> </span>
<a href="#l123.217"></a><span id="l123.217" class="difflineplus">+  /**</span>
<a href="#l123.218"></a><span id="l123.218" class="difflineplus">+   * The active sort changed, and that is all that changed.  If the sort is</span>
<a href="#l123.219"></a><span id="l123.219" class="difflineplus">+   *  changing because the view is being destroyed and re-created, this event</span>
<a href="#l123.220"></a><span id="l123.220" class="difflineplus">+   *  will not be generated.</span>
<a href="#l123.221"></a><span id="l123.221" class="difflineplus">+   */</span>
<a href="#l123.222"></a><span id="l123.222" class="difflineplus">+  onSortChanged: function() {</span>
<a href="#l123.223"></a><span id="l123.223">   },</span>
<a href="#l123.224"></a><span id="l123.224"> </span>
<a href="#l123.225"></a><span id="l123.225" class="difflineplus">+  /**</span>
<a href="#l123.226"></a><span id="l123.226" class="difflineplus">+   * This event is generated when messages in one of the folders backing the</span>
<a href="#l123.227"></a><span id="l123.227" class="difflineplus">+   *  view have been removed by message moves / deletion.  If there is a search</span>
<a href="#l123.228"></a><span id="l123.228" class="difflineplus">+   *  in effect, it is possible that the removed messages were not visible in</span>
<a href="#l123.229"></a><span id="l123.229" class="difflineplus">+   *  the view in the first place.</span>
<a href="#l123.230"></a><span id="l123.230" class="difflineplus">+   */</span>
<a href="#l123.231"></a><span id="l123.231" class="difflineplus">+  onMessagesRemoved: function () {</span>
<a href="#l123.232"></a><span id="l123.232" class="difflineplus">+  },</span>
<a href="#l123.233"></a><span id="l123.233"> </span>
<a href="#l123.234"></a><span id="l123.234" class="difflineplus">+  /**</span>
<a href="#l123.235"></a><span id="l123.235" class="difflineplus">+   * Like onMessagesRemoved, but something went awry in the move/deletion and</span>
<a href="#l123.236"></a><span id="l123.236" class="difflineplus">+   *  it failed.  Although this is not a very interesting event on its own,</span>
<a href="#l123.237"></a><span id="l123.237" class="difflineplus">+   *  it is useful in cases where the listener was expecting an</span>
<a href="#l123.238"></a><span id="l123.238" class="difflineplus">+   *  onMessagesRemoved and might need to clean some state up.</span>
<a href="#l123.239"></a><span id="l123.239" class="difflineplus">+   */</span>
<a href="#l123.240"></a><span id="l123.240" class="difflineplus">+  onMessageRemovalFailed: function () {</span>
<a href="#l123.241"></a><span id="l123.241" class="difflineplus">+  },</span>
<a href="#l123.242"></a><span id="l123.242" class="difflineplus">+</span>
<a href="#l123.243"></a><span id="l123.243" class="difflineplus">+  /**</span>
<a href="#l123.244"></a><span id="l123.244" class="difflineplus">+   * The total message count or total unread message counts changed.</span>
<a href="#l123.245"></a><span id="l123.245" class="difflineplus">+   */</span>
<a href="#l123.246"></a><span id="l123.246" class="difflineplus">+  onMessageCountsChanged: function () {</span>
<a href="#l123.247"></a><span id="l123.247" class="difflineplus">+  },</span>
<a href="#l123.248"></a><span id="l123.248"> };</span>
<a href="#l123.249"></a><span id="l123.249"> </span>
<a href="#l123.250"></a><span id="l123.250"> /**</span>
<a href="#l123.251"></a><span id="l123.251">  * Encapsulates everything related to working with our nsIMsgDBView</span>
<a href="#l123.252"></a><span id="l123.252">  *  implementations.</span>
<a href="#l123.253"></a><span id="l123.253" class="difflineplus">+ *</span>
<a href="#l123.254"></a><span id="l123.254" class="difflineplus">+ * Things we do not do and why we do not do them:</span>
<a href="#l123.255"></a><span id="l123.255" class="difflineplus">+ * - Selection.  This depends on having an nsITreeSelection object and we choose</span>
<a href="#l123.256"></a><span id="l123.256" class="difflineplus">+ *   to avoid entanglement with XUL/layout code.  Selection accordingly must be</span>
<a href="#l123.257"></a><span id="l123.257" class="difflineplus">+ *   handled a layer up in the FolderDisplayWidget.</span>
<a href="#l123.258"></a><span id="l123.258">  */</span>
<a href="#l123.259"></a><span id="l123.259"> function DBViewWrapper(aListener) {</span>
<a href="#l123.260"></a><span id="l123.260">   this.displayedFolder = null;</span>
<a href="#l123.261"></a><span id="l123.261">   this.listener = aListener;</span>
<a href="#l123.262"></a><span id="l123.262"> </span>
<a href="#l123.263"></a><span id="l123.263">   this._underlyingData = this.kUnderlyingNone;</span>
<a href="#l123.264"></a><span id="l123.264">   this._underlyingFolders = null;</span>
<a href="#l123.265"></a><span id="l123.265" class="difflineplus">+  this._syntheticView = null;</span>
<a href="#l123.266"></a><span id="l123.266"> </span>
<a href="#l123.267"></a><span id="l123.267">   this._viewUpdateDepth = 0;</span>
<a href="#l123.268"></a><span id="l123.268"> </span>
<a href="#l123.269"></a><span id="l123.269">   this._mailViewIndex = MailViewConstants.kViewItemAll;</span>
<a href="#l123.270"></a><span id="l123.270">   this._mailViewData = null;</span>
<a href="#l123.271"></a><span id="l123.271"> </span>
<a href="#l123.272"></a><span id="l123.272">   this._specialView = null;</span>
<a href="#l123.273"></a><span id="l123.273"> </span>
<a href="#l123.274"></a><span id="l123.274">   this._sort = [];</span>
<a href="#l123.275"></a><span id="l123.275" class="difflineminus">-  this._viewFlags = 0;</span>
<a href="#l123.276"></a><span id="l123.276" class="difflineplus">+  // see the _viewFlags getter and setter for info on our use of __viewFlags.</span>
<a href="#l123.277"></a><span id="l123.277" class="difflineplus">+  this.__viewFlags = null;</span>
<a href="#l123.278"></a><span id="l123.278"> </span>
<a href="#l123.279"></a><span id="l123.279">   this.dbView = null;</span>
<a href="#l123.280"></a><span id="l123.280">   this.search = null;</span>
<a href="#l123.281"></a><span id="l123.281"> </span>
<a href="#l123.282"></a><span id="l123.282">   this._folderLoading = false;</span>
<a href="#l123.283"></a><span id="l123.283">   this._searching = false;</span>
<a href="#l123.284"></a><span id="l123.284"> }</span>
<a href="#l123.285"></a><span id="l123.285"> DBViewWrapper.prototype = {</span>
<a href="#l123.286"></a><span id="l123.286" class="difflineat">@@ -436,108 +523,226 @@ DBViewWrapper.prototype = {</span>
<a href="#l123.287"></a><span id="l123.287">   kUnderlyingRealFolder: 1,</span>
<a href="#l123.288"></a><span id="l123.288">   /**</span>
<a href="#l123.289"></a><span id="l123.289">    * The underlying data source is a virtual folder that is operating over</span>
<a href="#l123.290"></a><span id="l123.290">    *  multiple underlying folders.</span>
<a href="#l123.291"></a><span id="l123.291">    */</span>
<a href="#l123.292"></a><span id="l123.292">   kUnderlyingMultipleFolder: 2,</span>
<a href="#l123.293"></a><span id="l123.293">   /**</span>
<a href="#l123.294"></a><span id="l123.294">    * Our data source is transient, most likely a gloda search that crammed the</span>
<a href="#l123.295"></a><span id="l123.295" class="difflineminus">-   *  results into us.</span>
<a href="#l123.296"></a><span id="l123.296" class="difflineplus">+   *  results into us.  This is different from a search view.</span>
<a href="#l123.297"></a><span id="l123.297">    */</span>
<a href="#l123.298"></a><span id="l123.298">   kUnderlyingSynthetic: 3,</span>
<a href="#l123.299"></a><span id="l123.299" class="difflineplus">+  /**</span>
<a href="#l123.300"></a><span id="l123.300" class="difflineplus">+   * We are a search view, which translates into a search that has underlying</span>
<a href="#l123.301"></a><span id="l123.301" class="difflineplus">+   *  folders, just like kUnderlyingMultipleFolder, but we have no</span>
<a href="#l123.302"></a><span id="l123.302" class="difflineplus">+   *  displayedFolder.  We differ from kUnderlyingSynthetic in that we are</span>
<a href="#l123.303"></a><span id="l123.303" class="difflineplus">+   *  not just a bunch of message headers randomly crammed in.</span>
<a href="#l123.304"></a><span id="l123.304" class="difflineplus">+   */</span>
<a href="#l123.305"></a><span id="l123.305" class="difflineplus">+  kUnderlyingSearchView: 4,</span>
<a href="#l123.306"></a><span id="l123.306"> </span>
<a href="#l123.307"></a><span id="l123.307">   /**</span>
<a href="#l123.308"></a><span id="l123.308">    * @return true if the folder being displayed is backed by a single 'real'</span>
<a href="#l123.309"></a><span id="l123.309">    *     folder.  This folder can be a saved search on that folder or just</span>
<a href="#l123.310"></a><span id="l123.310">    *     an outright un-filtered display of that folder.</span>
<a href="#l123.311"></a><span id="l123.311">    */</span>
<a href="#l123.312"></a><span id="l123.312">   get isSingleFolder() {</span>
<a href="#l123.313"></a><span id="l123.313">     return this._underlyingData == this.kUnderlyingRealFolder;</span>
<a href="#l123.314"></a><span id="l123.314">   },</span>
<a href="#l123.315"></a><span id="l123.315"> </span>
<a href="#l123.316"></a><span id="l123.316">   /**</span>
<a href="#l123.317"></a><span id="l123.317">    * @return true if the folder being displayed is a virtual folder backed by</span>
<a href="#l123.318"></a><span id="l123.318" class="difflineminus">-   *     multiple 'real' folders.  This corresponds to a cross-folder saved</span>
<a href="#l123.319"></a><span id="l123.319" class="difflineminus">-   *     search.</span>
<a href="#l123.320"></a><span id="l123.320" class="difflineplus">+   *     multiple 'real' folders or a search view.  This corresponds to a</span>
<a href="#l123.321"></a><span id="l123.321" class="difflineplus">+   *     cross-folder saved search.</span>
<a href="#l123.322"></a><span id="l123.322">    */</span>
<a href="#l123.323"></a><span id="l123.323">   get isMultiFolder() {</span>
<a href="#l123.324"></a><span id="l123.324" class="difflineminus">-    return this._underlyingData == this.kUnderlyingMultipleFolder;</span>
<a href="#l123.325"></a><span id="l123.325" class="difflineplus">+    return (this._underlyingData == this.kUnderlyingMultipleFolder) ||</span>
<a href="#l123.326"></a><span id="l123.326" class="difflineplus">+           (this._underlyingData == this.kUnderlyingSearchView);;</span>
<a href="#l123.327"></a><span id="l123.327">   },</span>
<a href="#l123.328"></a><span id="l123.328"> </span>
<a href="#l123.329"></a><span id="l123.329">   /**</span>
<a href="#l123.330"></a><span id="l123.330">    * @return true if the folder being displayed is not a real folder at all,</span>
<a href="#l123.331"></a><span id="l123.331">    *     but rather the result of an un-scoped search, such as a gloda search.</span>
<a href="#l123.332"></a><span id="l123.332">    */</span>
<a href="#l123.333"></a><span id="l123.333">   get isSynthetic() {</span>
<a href="#l123.334"></a><span id="l123.334">     return this._underlyingData == this.kUnderlyingSynthetic;</span>
<a href="#l123.335"></a><span id="l123.335">   },</span>
<a href="#l123.336"></a><span id="l123.336"> </span>
<a href="#l123.337"></a><span id="l123.337">   /**</span>
<a href="#l123.338"></a><span id="l123.338" class="difflineplus">+   * Check if the folder in question backs the currently displayed folder.  For</span>
<a href="#l123.339"></a><span id="l123.339" class="difflineplus">+   *  a virtual folder, this is a test of whether the virtual folder includes</span>
<a href="#l123.340"></a><span id="l123.340" class="difflineplus">+   *  messages from the given folder.  For a 'real' single folder, this is</span>
<a href="#l123.341"></a><span id="l123.341" class="difflineplus">+   *  effectively a test against displayedFolder.</span>
<a href="#l123.342"></a><span id="l123.342" class="difflineplus">+   * If you want to see if the displayed folder is a folder, just compare</span>
<a href="#l123.343"></a><span id="l123.343" class="difflineplus">+   *  against the displayedFolder attribute.</span>
<a href="#l123.344"></a><span id="l123.344" class="difflineplus">+   */</span>
<a href="#l123.345"></a><span id="l123.345" class="difflineplus">+  isUnderlyingFolder: function DBViewWrapper_isUnderlyingFolder(aFolder) {</span>
<a href="#l123.346"></a><span id="l123.346" class="difflineplus">+    for each (let [i,underlyingFolder] in Iterator(this._underlyingFolders)) {</span>
<a href="#l123.347"></a><span id="l123.347" class="difflineplus">+      if (aFolder == underlyingFolder)</span>
<a href="#l123.348"></a><span id="l123.348" class="difflineplus">+        return true;</span>
<a href="#l123.349"></a><span id="l123.349" class="difflineplus">+    }</span>
<a href="#l123.350"></a><span id="l123.350" class="difflineplus">+    return false;</span>
<a href="#l123.351"></a><span id="l123.351" class="difflineplus">+  },</span>
<a href="#l123.352"></a><span id="l123.352" class="difflineplus">+</span>
<a href="#l123.353"></a><span id="l123.353" class="difflineplus">+  /**</span>
<a href="#l123.354"></a><span id="l123.354">    * Refresh the view by re-creating the view.  You would do this to get rid of</span>
<a href="#l123.355"></a><span id="l123.355">    *  messages that no longer match the view but are kept around for view</span>
<a href="#l123.356"></a><span id="l123.356">    *  stability reasons.  (In other words, in an unread-messages view, you would</span>
<a href="#l123.357"></a><span id="l123.357">    *  go insane if when you clicked on a message it immediately disappeared</span>
<a href="#l123.358"></a><span id="l123.358">    *  because it no longer matched.)</span>
<a href="#l123.359"></a><span id="l123.359">    * This method was adding for testing purposes and does not have a (legacy) UI</span>
<a href="#l123.360"></a><span id="l123.360">    *  reason for existing.  (The 'open' method is intended to behave identically</span>
<a href="#l123.361"></a><span id="l123.361">    *  to the legacy UI if you click on the currently displayed folder.)</span>
<a href="#l123.362"></a><span id="l123.362">    */</span>
<a href="#l123.363"></a><span id="l123.363">   refresh: function DBViewWrapper_refresh() {</span>
<a href="#l123.364"></a><span id="l123.364">     this._applyViewChanges();</span>
<a href="#l123.365"></a><span id="l123.365">   },</span>
<a href="#l123.366"></a><span id="l123.366"> </span>
<a href="#l123.367"></a><span id="l123.367">   /**</span>
<a href="#l123.368"></a><span id="l123.368" class="difflineplus">+   * Null out the folder's database to avoid memory bloat if we don't have a</span>
<a href="#l123.369"></a><span id="l123.369" class="difflineplus">+   *  reason to keep the database around.  Currently, we keep all Inboxes</span>
<a href="#l123.370"></a><span id="l123.370" class="difflineplus">+   *  around and null out everyone else.  This is a standard stopgap measure</span>
<a href="#l123.371"></a><span id="l123.371" class="difflineplus">+   *  until we have something more clever going on.</span>
<a href="#l123.372"></a><span id="l123.372" class="difflineplus">+   * In general, there is little potential downside to nulling out the message</span>
<a href="#l123.373"></a><span id="l123.373" class="difflineplus">+   *  database reference when it is in use.  As long as someone is holding onto</span>
<a href="#l123.374"></a><span id="l123.374" class="difflineplus">+   *  a message header from the database, the database will be kept open, and</span>
<a href="#l123.375"></a><span id="l123.375" class="difflineplus">+   *  therefore the database service will still have a reference to the db.</span>
<a href="#l123.376"></a><span id="l123.376" class="difflineplus">+   *  When the folder goes to ask for the database again, the service will have</span>
<a href="#l123.377"></a><span id="l123.377" class="difflineplus">+   *  it, and it will not need to be re-opened.</span>
<a href="#l123.378"></a><span id="l123.378" class="difflineplus">+   *</span>
<a href="#l123.379"></a><span id="l123.379" class="difflineplus">+   * Another heuristic we could theoretically use is use the mail session's</span>
<a href="#l123.380"></a><span id="l123.380" class="difflineplus">+   *  isFolderOpenInWindow call, except that uses the outmoded concept that each</span>
<a href="#l123.381"></a><span id="l123.381" class="difflineplus">+   *  window will have at most one folder open.  So nuts to that.</span>
<a href="#l123.382"></a><span id="l123.382" class="difflineplus">+   *</span>
<a href="#l123.383"></a><span id="l123.383" class="difflineplus">+   * Note: regrettably a unit test cannot verify that we did this; msgDatabase</span>
<a href="#l123.384"></a><span id="l123.384" class="difflineplus">+   *  is a getter that will always try and load the message database!</span>
<a href="#l123.385"></a><span id="l123.385" class="difflineplus">+   */</span>
<a href="#l123.386"></a><span id="l123.386" class="difflineplus">+  _releaseFolderDatabase: function DBViewWrapper__nullFolderDatabase(aFolder) {</span>
<a href="#l123.387"></a><span id="l123.387" class="difflineplus">+    if (!this._isSpecialFolder(aFolder, nsMsgFolderFlags.Inbox, false))</span>
<a href="#l123.388"></a><span id="l123.388" class="difflineplus">+      aFolder.msgDatabase = null;</span>
<a href="#l123.389"></a><span id="l123.389" class="difflineplus">+  },</span>
<a href="#l123.390"></a><span id="l123.390" class="difflineplus">+</span>
<a href="#l123.391"></a><span id="l123.391" class="difflineplus">+  /**</span>
<a href="#l123.392"></a><span id="l123.392" class="difflineplus">+   * Clone this DBViewWrapper and its underlying nsIMsgDBView.</span>
<a href="#l123.393"></a><span id="l123.393" class="difflineplus">+   *</span>
<a href="#l123.394"></a><span id="l123.394" class="difflineplus">+   * @param aListener {IDBViewWrapperListener} The listener to use on the new view.</span>
<a href="#l123.395"></a><span id="l123.395" class="difflineplus">+   */</span>
<a href="#l123.396"></a><span id="l123.396" class="difflineplus">+  clone: function DBViewWrapper_clone(aListener) {</span>
<a href="#l123.397"></a><span id="l123.397" class="difflineplus">+    let doppel = new DBViewWrapper(aListener);</span>
<a href="#l123.398"></a><span id="l123.398" class="difflineplus">+</span>
<a href="#l123.399"></a><span id="l123.399" class="difflineplus">+    // -- copy attributes</span>
<a href="#l123.400"></a><span id="l123.400" class="difflineplus">+    doppel.displayedFolder = this.displayedFolder;</span>
<a href="#l123.401"></a><span id="l123.401" class="difflineplus">+    doppel._underlyingData = this._underlyingData;</span>
<a href="#l123.402"></a><span id="l123.402" class="difflineplus">+    doppel._underlyingFolders = this._underlyingFolders ?</span>
<a href="#l123.403"></a><span id="l123.403" class="difflineplus">+                                  this._underlyingFolders.concat() : null;</span>
<a href="#l123.404"></a><span id="l123.404" class="difflineplus">+    doppel._syntheticView = this._syntheticView;</span>
<a href="#l123.405"></a><span id="l123.405" class="difflineplus">+</span>
<a href="#l123.406"></a><span id="l123.406" class="difflineplus">+    // _viewUpdateDepth should stay at its initial value of zero</span>
<a href="#l123.407"></a><span id="l123.407" class="difflineplus">+    doppel._mailViewIndex = this._mailViewIndex;</span>
<a href="#l123.408"></a><span id="l123.408" class="difflineplus">+    doppel._mailViewData = this._mailViewData;</span>
<a href="#l123.409"></a><span id="l123.409" class="difflineplus">+</span>
<a href="#l123.410"></a><span id="l123.410" class="difflineplus">+    doppel._specialView = this._specialView;</span>
<a href="#l123.411"></a><span id="l123.411" class="difflineplus">+    // a shallow copy is all that is required for sort; we do not mutate entries</span>
<a href="#l123.412"></a><span id="l123.412" class="difflineplus">+    doppel._sort = this._sort.concat();</span>
<a href="#l123.413"></a><span id="l123.413" class="difflineplus">+</span>
<a href="#l123.414"></a><span id="l123.414" class="difflineplus">+    // -- register listeners...</span>
<a href="#l123.415"></a><span id="l123.415" class="difflineplus">+    // note: this does not get us a folder loaded notification.  Our expected</span>
<a href="#l123.416"></a><span id="l123.416" class="difflineplus">+    //  use case for cloning is displaying a single message already visible in</span>
<a href="#l123.417"></a><span id="l123.417" class="difflineplus">+    //  the original view, which implies we don't need to hang about for folder</span>
<a href="#l123.418"></a><span id="l123.418" class="difflineplus">+    //  loaded notification messages.</span>
<a href="#l123.419"></a><span id="l123.419" class="difflineplus">+    FolderNotificationHelper.stalkFolders(doppel._underlyingFolders,</span>
<a href="#l123.420"></a><span id="l123.420" class="difflineplus">+                                          doppel.displayedFolder,</span>
<a href="#l123.421"></a><span id="l123.421" class="difflineplus">+                                          doppel);</span>
<a href="#l123.422"></a><span id="l123.422" class="difflineplus">+</span>
<a href="#l123.423"></a><span id="l123.423" class="difflineplus">+    // -- clone the view</span>
<a href="#l123.424"></a><span id="l123.424" class="difflineplus">+    if (this.dbView)</span>
<a href="#l123.425"></a><span id="l123.425" class="difflineplus">+      doppel.dbView = this.dbView.cloneDBView(aListener.messenger,</span>
<a href="#l123.426"></a><span id="l123.426" class="difflineplus">+                                              aListener.msgWindow,</span>
<a href="#l123.427"></a><span id="l123.427" class="difflineplus">+                                              aListener.threadPaneCommandUpdater)</span>
<a href="#l123.428"></a><span id="l123.428" class="difflineplus">+                          .QueryInterface(Components.interfaces.nsITreeView);</span>
<a href="#l123.429"></a><span id="l123.429" class="difflineplus">+    // -- clone the search</span>
<a href="#l123.430"></a><span id="l123.430" class="difflineplus">+    if (this.search)</span>
<a href="#l123.431"></a><span id="l123.431" class="difflineplus">+      doppel.search = this.search.clone(doppel);</span>
<a href="#l123.432"></a><span id="l123.432" class="difflineplus">+</span>
<a href="#l123.433"></a><span id="l123.433" class="difflineplus">+    return doppel;</span>
<a href="#l123.434"></a><span id="l123.434" class="difflineplus">+  },</span>
<a href="#l123.435"></a><span id="l123.435" class="difflineplus">+</span>
<a href="#l123.436"></a><span id="l123.436" class="difflineplus">+  /**</span>
<a href="#l123.437"></a><span id="l123.437">    * Close the current view.  You would only do this if you want to clean up all</span>
<a href="#l123.438"></a><span id="l123.438">    *  the resources associated with this view wrapper.  You would not do this</span>
<a href="#l123.439"></a><span id="l123.439">    *  for UI reasons like the user de-selecting the node in the tree; we should</span>
<a href="#l123.440"></a><span id="l123.440">    *  always be displaying something when used in a UI context!</span>
<a href="#l123.441"></a><span id="l123.441">    *</span>
<a href="#l123.442"></a><span id="l123.442">    * @param aFolderIsDead If true, tells us not to try and tidy up on our way</span>
<a href="#l123.443"></a><span id="l123.443">    *     out by virtue of the fact that the folder is dead and should not be</span>
<a href="#l123.444"></a><span id="l123.444">    *     messed with.</span>
<a href="#l123.445"></a><span id="l123.445">    */</span>
<a href="#l123.446"></a><span id="l123.446">   close: function DBViewWrapper_close(aFolderIsDead) {</span>
<a href="#l123.447"></a><span id="l123.447" class="difflineminus">-    if (this._underlyingFolders)</span>
<a href="#l123.448"></a><span id="l123.448" class="difflineminus">-      FolderNotificationHelper.removeNotifications(this._underlyingFolders,</span>
<a href="#l123.449"></a><span id="l123.449" class="difflineminus">-                                                   this);</span>
<a href="#l123.450"></a><span id="l123.450" class="difflineminus">-</span>
<a href="#l123.451"></a><span id="l123.451">     if (this.displayedFolder != null) {</span>
<a href="#l123.452"></a><span id="l123.452">       // onLeavingFolder does all the application-level stuff related to leaving</span>
<a href="#l123.453"></a><span id="l123.453">       //  the folder (marking as read, etc.)  We only do this when the folder</span>
<a href="#l123.454"></a><span id="l123.454">       //  is not dead (for obvious reasons).</span>
<a href="#l123.455"></a><span id="l123.455" class="difflineminus">-      if (!aFolderIsDead)</span>
<a href="#l123.456"></a><span id="l123.456" class="difflineminus">-        this.onLeavingFolder();</span>
<a href="#l123.457"></a><span id="l123.457" class="difflineplus">+      if (!aFolderIsDead) {</span>
<a href="#l123.458"></a><span id="l123.458" class="difflineplus">+        // onLeavingFolder must be called before we potentially null out its</span>
<a href="#l123.459"></a><span id="l123.459" class="difflineplus">+        //  msgDatabase, which we will do in the upcoming underlyingFolders loop</span>
<a href="#l123.460"></a><span id="l123.460" class="difflineplus">+        this.onLeavingFolder(); // application logic</span>
<a href="#l123.461"></a><span id="l123.461" class="difflineplus">+        this.listener.onLeavingFolder(); // display logic</span>
<a href="#l123.462"></a><span id="l123.462" class="difflineplus">+      }</span>
<a href="#l123.463"></a><span id="l123.463" class="difflineplus">+      // (potentially) zero out the display folder if we are dealing with a</span>
<a href="#l123.464"></a><span id="l123.464" class="difflineplus">+      //  virtual folder and so the next loop won't take care of it.</span>
<a href="#l123.465"></a><span id="l123.465" class="difflineplus">+      if (this.isVirtual) {</span>
<a href="#l123.466"></a><span id="l123.466" class="difflineplus">+        FolderNotificationHelper.removeNotifications([this.displayedFolder],</span>
<a href="#l123.467"></a><span id="l123.467" class="difflineplus">+                                                     this);</span>
<a href="#l123.468"></a><span id="l123.468" class="difflineplus">+        this._releaseFolderDatabase(this.displayedFolder);</span>
<a href="#l123.469"></a><span id="l123.469" class="difflineplus">+      }</span>
<a href="#l123.470"></a><span id="l123.470" class="difflineplus">+</span>
<a href="#l123.471"></a><span id="l123.471" class="difflineplus">+      this.folderLoading = false;</span>
<a href="#l123.472"></a><span id="l123.472">       this.displayedFolder = null;</span>
<a href="#l123.473"></a><span id="l123.473" class="difflineminus">-      this.folderLoading = false;</span>
<a href="#l123.474"></a><span id="l123.474" class="difflineplus">+    }</span>
<a href="#l123.475"></a><span id="l123.475" class="difflineplus">+</span>
<a href="#l123.476"></a><span id="l123.476" class="difflineplus">+    if (this._underlyingFolders) {</span>
<a href="#l123.477"></a><span id="l123.477" class="difflineplus">+      FolderNotificationHelper.removeNotifications(this._underlyingFolders,</span>
<a href="#l123.478"></a><span id="l123.478" class="difflineplus">+                                                   this);</span>
<a href="#l123.479"></a><span id="l123.479" class="difflineplus">+      // (potentially) zero out the underlying msgDatabase references</span>
<a href="#l123.480"></a><span id="l123.480" class="difflineplus">+      for each (let [, folder] in Iterator(this._underlyingFolders))</span>
<a href="#l123.481"></a><span id="l123.481" class="difflineplus">+        this._releaseFolderDatabase(folder);</span>
<a href="#l123.482"></a><span id="l123.482">     }</span>
<a href="#l123.483"></a><span id="l123.483"> </span>
<a href="#l123.484"></a><span id="l123.484">     // kill off the view and its search association</span>
<a href="#l123.485"></a><span id="l123.485">     if (this.dbView) {</span>
<a href="#l123.486"></a><span id="l123.486" class="difflineplus">+      this.listener.onDestroyingView(false);</span>
<a href="#l123.487"></a><span id="l123.487">       this.search.dissociateView(this.dbView);</span>
<a href="#l123.488"></a><span id="l123.488">       this.dbView.close();</span>
<a href="#l123.489"></a><span id="l123.489">       this.dbView = null;</span>
<a href="#l123.490"></a><span id="l123.490">     }</span>
<a href="#l123.491"></a><span id="l123.491"> </span>
<a href="#l123.492"></a><span id="l123.492" class="difflineplus">+    // zero out the view update depth here.  We don't do it on open because it's</span>
<a href="#l123.493"></a><span id="l123.493" class="difflineplus">+    //  theoretically be nice to be able to start a view update before you open</span>
<a href="#l123.494"></a><span id="l123.494" class="difflineplus">+    //  something so you can defer the open.  In practice, that is not yet</span>
<a href="#l123.495"></a><span id="l123.495" class="difflineplus">+    //  tested.</span>
<a href="#l123.496"></a><span id="l123.496" class="difflineplus">+    this._viewUpdateDepth = 0;</span>
<a href="#l123.497"></a><span id="l123.497" class="difflineplus">+</span>
<a href="#l123.498"></a><span id="l123.498">     this._underlyingData = this.kUnderlyingNone;</span>
<a href="#l123.499"></a><span id="l123.499">     this._underlyingFolders = null;</span>
<a href="#l123.500"></a><span id="l123.500" class="difflineplus">+    this._syntheticView = null;</span>
<a href="#l123.501"></a><span id="l123.501"> </span>
<a href="#l123.502"></a><span id="l123.502">     this._mailViewIndex = MailViewConstants.kViewItemAll;</span>
<a href="#l123.503"></a><span id="l123.503">     this._mailViewData = null;</span>
<a href="#l123.504"></a><span id="l123.504"> </span>
<a href="#l123.505"></a><span id="l123.505">     this._specialView = null;</span>
<a href="#l123.506"></a><span id="l123.506"> </span>
<a href="#l123.507"></a><span id="l123.507">     this._sort = [];</span>
<a href="#l123.508"></a><span id="l123.508" class="difflineminus">-    this._viewFlags = 0;</span>
<a href="#l123.509"></a><span id="l123.509" class="difflineplus">+    this.__viewFlags = null;</span>
<a href="#l123.510"></a><span id="l123.510"> </span>
<a href="#l123.511"></a><span id="l123.511">     this.search = null;</span>
<a href="#l123.512"></a><span id="l123.512">   },</span>
<a href="#l123.513"></a><span id="l123.513"> </span>
<a href="#l123.514"></a><span id="l123.514">   /**</span>
<a href="#l123.515"></a><span id="l123.515" class="difflineminus">-   * Open the passed-in folder.</span>
<a href="#l123.516"></a><span id="l123.516" class="difflineplus">+   * Open the passed-in nsIMsgFolder folder.  Use openSynthetic for synthetic</span>
<a href="#l123.517"></a><span id="l123.517" class="difflineplus">+   *  view providers.</span>
<a href="#l123.518"></a><span id="l123.518">    */</span>
<a href="#l123.519"></a><span id="l123.519">   open: function DBViewWrapper_open(aFolder) {</span>
<a href="#l123.520"></a><span id="l123.520">     if (aFolder == null) {</span>
<a href="#l123.521"></a><span id="l123.521">       this.close();</span>
<a href="#l123.522"></a><span id="l123.522">       return;</span>
<a href="#l123.523"></a><span id="l123.523">     }</span>
<a href="#l123.524"></a><span id="l123.524"> </span>
<a href="#l123.525"></a><span id="l123.525">     // If we are in the same folder, there is nothing to do unless we are a</span>
<a href="#l123.526"></a><span id="l123.526" class="difflineat">@@ -565,22 +770,32 @@ DBViewWrapper.prototype = {</span>
<a href="#l123.527"></a><span id="l123.527">     this.beginViewUpdate();</span>
<a href="#l123.528"></a><span id="l123.528">     let msgDatabase = this.displayedFolder.msgDatabase;</span>
<a href="#l123.529"></a><span id="l123.529">     if (msgDatabase) {</span>
<a href="#l123.530"></a><span id="l123.530">       let dbFolderInfo = msgDatabase.dBFolderInfo;</span>
<a href="#l123.531"></a><span id="l123.531">       // - retrieve persisted sort information</span>
<a href="#l123.532"></a><span id="l123.532">       this._sort = [[dbFolderInfo.sortType, dbFolderInfo.sortOrder]];</span>
<a href="#l123.533"></a><span id="l123.533"> </span>
<a href="#l123.534"></a><span id="l123.534">       // - retrieve persisted display settings</span>
<a href="#l123.535"></a><span id="l123.535" class="difflineminus">-      this._viewFlags = dbFolderInfo.viewFlags;</span>
<a href="#l123.536"></a><span id="l123.536" class="difflineplus">+      this.__viewFlags = dbFolderInfo.viewFlags;</span>
<a href="#l123.537"></a><span id="l123.537" class="difflineplus">+      // Make sure the threaded bit is set if group-by-sort is set.  The views</span>
<a href="#l123.538"></a><span id="l123.538" class="difflineplus">+      //  encode 3 states in 2-bits, and we want to avoid that odd-man-out</span>
<a href="#l123.539"></a><span id="l123.539" class="difflineplus">+      //  state.</span>
<a href="#l123.540"></a><span id="l123.540" class="difflineplus">+      if (this.__viewFlags &amp; nsMsgViewFlagsType.kGroupBySort) {</span>
<a href="#l123.541"></a><span id="l123.541" class="difflineplus">+        this.__viewFlags |= nsMsgViewFlagsType.kThreadedDisplay;</span>
<a href="#l123.542"></a><span id="l123.542" class="difflineplus">+        this._ensureValidSort();</span>
<a href="#l123.543"></a><span id="l123.543" class="difflineplus">+      }</span>
<a href="#l123.544"></a><span id="l123.544"> </span>
<a href="#l123.545"></a><span id="l123.545">       // - retrieve virtual folder configuration</span>
<a href="#l123.546"></a><span id="l123.546">       if (aFolder.flags &amp; nsMsgFolderFlags.Virtual) {</span>
<a href="#l123.547"></a><span id="l123.547">         let virtFolder = VirtualFolderHelper.wrapVirtualFolder(aFolder);</span>
<a href="#l123.548"></a><span id="l123.548" class="difflineminus">-        this._underlyingFolders = virtFolder.searchFolders;</span>
<a href="#l123.549"></a><span id="l123.549" class="difflineplus">+        // Filter out the server roots; they only exist for UI reasons.</span>
<a href="#l123.550"></a><span id="l123.550" class="difflineplus">+        this._underlyingFolders =</span>
<a href="#l123.551"></a><span id="l123.551" class="difflineplus">+          [folder for each ([, folder] in Iterator(virtFolder.searchFolders))</span>
<a href="#l123.552"></a><span id="l123.552" class="difflineplus">+                  if (!folder.isServer)];</span>
<a href="#l123.553"></a><span id="l123.553">         this._underlyingData = (this._underlyingFolders.length &gt; 1) ?</span>
<a href="#l123.554"></a><span id="l123.554">                                this.kUnderlyingMultipleFolder :</span>
<a href="#l123.555"></a><span id="l123.555">                                this.kUnderlyingRealFolder;</span>
<a href="#l123.556"></a><span id="l123.556"> </span>
<a href="#l123.557"></a><span id="l123.557">         // figure out if we are using online IMAP searching</span>
<a href="#l123.558"></a><span id="l123.558">         this.search.onlineSearch = virtFolder.onlineSearch;</span>
<a href="#l123.559"></a><span id="l123.559"> </span>
<a href="#l123.560"></a><span id="l123.560">         // retrieve and chew the search query</span>
<a href="#l123.561"></a><span id="l123.561" class="difflineat">@@ -624,32 +839,87 @@ DBViewWrapper.prototype = {</span>
<a href="#l123.562"></a><span id="l123.562">             this.setMailView(MailViewConstants.kViewItemTags,</span>
<a href="#l123.563"></a><span id="l123.563">                              &quot;$label&quot; + (mailViewIndex-1));</span>
<a href="#l123.564"></a><span id="l123.564">           else</span>
<a href="#l123.565"></a><span id="l123.565">             this.setMailView(mailViewIndex);</span>
<a href="#l123.566"></a><span id="l123.566">         }</span>
<a href="#l123.567"></a><span id="l123.567">       }</span>
<a href="#l123.568"></a><span id="l123.568">     }</span>
<a href="#l123.569"></a><span id="l123.569"> </span>
<a href="#l123.570"></a><span id="l123.570" class="difflineplus">+    if (!this.isVirtual) {</span>
<a href="#l123.571"></a><span id="l123.571" class="difflineplus">+      this.folderLoading = true;</span>
<a href="#l123.572"></a><span id="l123.572" class="difflineplus">+      FolderNotificationHelper.updateFolderAndNotifyOnLoad(</span>
<a href="#l123.573"></a><span id="l123.573" class="difflineplus">+        this.displayedFolder, this, this.listener.msgWindow);</span>
<a href="#l123.574"></a><span id="l123.574" class="difflineplus">+    }</span>
<a href="#l123.575"></a><span id="l123.575" class="difflineplus">+</span>
<a href="#l123.576"></a><span id="l123.576" class="difflineplus">+    // we do this after kicking off the update because this could initiate a</span>
<a href="#l123.577"></a><span id="l123.577" class="difflineplus">+    //  search which could fight our explicit updateFolder call if the search</span>
<a href="#l123.578"></a><span id="l123.578" class="difflineplus">+    //  is already outstanding.</span>
<a href="#l123.579"></a><span id="l123.579">     if (this.shouldShowMessagesForFolderImmediately())</span>
<a href="#l123.580"></a><span id="l123.580">       this._enterFolder();</span>
<a href="#l123.581"></a><span id="l123.581" class="difflineplus">+  },</span>
<a href="#l123.582"></a><span id="l123.582"> </span>
<a href="#l123.583"></a><span id="l123.583" class="difflineminus">-    this.folderLoading = true;</span>
<a href="#l123.584"></a><span id="l123.584" class="difflineminus">-    if (!this.isVirtual)</span>
<a href="#l123.585"></a><span id="l123.585" class="difflineminus">-      FolderNotificationHelper.updateFolderAndNotifyOnLoad(</span>
<a href="#l123.586"></a><span id="l123.586" class="difflineminus">-        this.displayedFolder, this, this.listener.msgWindow);</span>
<a href="#l123.587"></a><span id="l123.587" class="difflineplus">+  /**</span>
<a href="#l123.588"></a><span id="l123.588" class="difflineplus">+   * Open a synthetic view provider as backing our view.</span>
<a href="#l123.589"></a><span id="l123.589" class="difflineplus">+   */</span>
<a href="#l123.590"></a><span id="l123.590" class="difflineplus">+  openSynthetic: function DBViewWrapper_openSynthetic(aSyntheticView) {</span>
<a href="#l123.591"></a><span id="l123.591" class="difflineplus">+    this.close();</span>
<a href="#l123.592"></a><span id="l123.592" class="difflineplus">+</span>
<a href="#l123.593"></a><span id="l123.593" class="difflineplus">+    this._underlyingData = this.kUnderlyingSynthetic;</span>
<a href="#l123.594"></a><span id="l123.594" class="difflineplus">+    this._syntheticView = aSyntheticView;</span>
<a href="#l123.595"></a><span id="l123.595" class="difflineplus">+</span>
<a href="#l123.596"></a><span id="l123.596" class="difflineplus">+    this.search = new SearchSpec(this);</span>
<a href="#l123.597"></a><span id="l123.597" class="difflineplus">+    this._sort = this._syntheticView.defaultSort.concat();</span>
<a href="#l123.598"></a><span id="l123.598" class="difflineplus">+</span>
<a href="#l123.599"></a><span id="l123.599" class="difflineplus">+    this._applyViewChanges();</span>
<a href="#l123.600"></a><span id="l123.600" class="difflineplus">+  },</span>
<a href="#l123.601"></a><span id="l123.601" class="difflineplus">+</span>
<a href="#l123.602"></a><span id="l123.602" class="difflineplus">+  /**</span>
<a href="#l123.603"></a><span id="l123.603" class="difflineplus">+   * Makes us irrevocavbly be a search view, for use in search windows.</span>
<a href="#l123.604"></a><span id="l123.604" class="difflineplus">+   *  Once you call this, you are not allowed to use us for anything</span>
<a href="#l123.605"></a><span id="l123.605" class="difflineplus">+   *  but a search view!</span>
<a href="#l123.606"></a><span id="l123.606" class="difflineplus">+   * We add a 'searchFolders' property that allows you to control what</span>
<a href="#l123.607"></a><span id="l123.607" class="difflineplus">+   *  folders we are searching over.</span>
<a href="#l123.608"></a><span id="l123.608" class="difflineplus">+   */</span>
<a href="#l123.609"></a><span id="l123.609" class="difflineplus">+  openSearchView: function DBViewWrapper_openSearchView() {</span>
<a href="#l123.610"></a><span id="l123.610" class="difflineplus">+    this.close();</span>
<a href="#l123.611"></a><span id="l123.611" class="difflineplus">+</span>
<a href="#l123.612"></a><span id="l123.612" class="difflineplus">+    this._underlyingData = this.kUnderlyingSearchView;</span>
<a href="#l123.613"></a><span id="l123.613" class="difflineplus">+    this._underlyingFolders = [];</span>
<a href="#l123.614"></a><span id="l123.614" class="difflineplus">+</span>
<a href="#l123.615"></a><span id="l123.615" class="difflineplus">+    let dis = this;</span>
<a href="#l123.616"></a><span id="l123.616" class="difflineplus">+    this.__defineGetter__('searchFolders', function() {</span>
<a href="#l123.617"></a><span id="l123.617" class="difflineplus">+                            return dis._underlyingFolders;</span>
<a href="#l123.618"></a><span id="l123.618" class="difflineplus">+                          });</span>
<a href="#l123.619"></a><span id="l123.619" class="difflineplus">+    this.__defineSetter__('searchFolders', function(aSearchFolders) {</span>
<a href="#l123.620"></a><span id="l123.620" class="difflineplus">+                            dis._underlyingFolders = aSearchFolders;</span>
<a href="#l123.621"></a><span id="l123.621" class="difflineplus">+                            dis._applyViewChanges();</span>
<a href="#l123.622"></a><span id="l123.622" class="difflineplus">+                          });</span>
<a href="#l123.623"></a><span id="l123.623" class="difflineplus">+</span>
<a href="#l123.624"></a><span id="l123.624" class="difflineplus">+    this.search = new SearchSpec(this);</span>
<a href="#l123.625"></a><span id="l123.625" class="difflineplus">+    // the search view uses the order in which messages are added as the</span>
<a href="#l123.626"></a><span id="l123.626" class="difflineplus">+    //  order by default.</span>
<a href="#l123.627"></a><span id="l123.627" class="difflineplus">+    this._sort = [[nsMsgViewSortType.byNone, nsMsgViewSortOrder.ascending]];</span>
<a href="#l123.628"></a><span id="l123.628" class="difflineplus">+</span>
<a href="#l123.629"></a><span id="l123.629" class="difflineplus">+    this._applyViewChanges();</span>
<a href="#l123.630"></a><span id="l123.630">   },</span>
<a href="#l123.631"></a><span id="l123.631"> </span>
<a href="#l123.632"></a><span id="l123.632">   get folderLoading() {</span>
<a href="#l123.633"></a><span id="l123.633">     return this._folderLoading;</span>
<a href="#l123.634"></a><span id="l123.634">   },</span>
<a href="#l123.635"></a><span id="l123.635">   set folderLoading(aFolderLoading) {</span>
<a href="#l123.636"></a><span id="l123.636">     if (this._folderLoading == aFolderLoading)</span>
<a href="#l123.637"></a><span id="l123.637">       return;</span>
<a href="#l123.638"></a><span id="l123.638">     this._folderLoading = aFolderLoading;</span>
<a href="#l123.639"></a><span id="l123.639" class="difflineplus">+    // tell the folder about what is going on so it can remove its db change</span>
<a href="#l123.640"></a><span id="l123.640" class="difflineplus">+    //  listener and restore it, respectively.</span>
<a href="#l123.641"></a><span id="l123.641" class="difflineplus">+    if (aFolderLoading)</span>
<a href="#l123.642"></a><span id="l123.642" class="difflineplus">+      this.displayedFolder.startFolderLoading();</span>
<a href="#l123.643"></a><span id="l123.643" class="difflineplus">+    else</span>
<a href="#l123.644"></a><span id="l123.644" class="difflineplus">+      this.displayedFolder.endFolderLoading();</span>
<a href="#l123.645"></a><span id="l123.645">     this.listener.onFolderLoading(aFolderLoading);</span>
<a href="#l123.646"></a><span id="l123.646">   },</span>
<a href="#l123.647"></a><span id="l123.647"> </span>
<a href="#l123.648"></a><span id="l123.648">   get searching() {</span>
<a href="#l123.649"></a><span id="l123.649">     return this._searching;</span>
<a href="#l123.650"></a><span id="l123.650">   },</span>
<a href="#l123.651"></a><span id="l123.651">   set searching(aSearching) {</span>
<a href="#l123.652"></a><span id="l123.652">     if (aSearching == this._searching)</span>
<a href="#l123.653"></a><span id="l123.653" class="difflineat">@@ -692,17 +962,18 @@ DBViewWrapper.prototype = {</span>
<a href="#l123.654"></a><span id="l123.654">   /**</span>
<a href="#l123.655"></a><span id="l123.655">    * Creates a view appropriate to the current settings of the folder display</span>
<a href="#l123.656"></a><span id="l123.656">    *  widget, returning it.  The caller is responsible to assign the result to</span>
<a href="#l123.657"></a><span id="l123.657">    *  this.dbView (or whatever it wants to do with it.)</span>
<a href="#l123.658"></a><span id="l123.658">    */</span>
<a href="#l123.659"></a><span id="l123.659">   _createView: function DBViewWrapper__createView() {</span>
<a href="#l123.660"></a><span id="l123.660">     let dbviewContractId = &quot;@mozilla.org/messenger/msgdbview;1?type=&quot;;</span>
<a href="#l123.661"></a><span id="l123.661"> </span>
<a href="#l123.662"></a><span id="l123.662" class="difflineminus">-    let viewFlags = this._viewFlags;</span>
<a href="#l123.663"></a><span id="l123.663" class="difflineplus">+    // we will have saved these off when closing our view</span>
<a href="#l123.664"></a><span id="l123.664" class="difflineplus">+    let viewFlags = this.__viewFlags || 0;</span>
<a href="#l123.665"></a><span id="l123.665"> </span>
<a href="#l123.666"></a><span id="l123.666">     // real folders are subject to the most interest set of possibilities...</span>
<a href="#l123.667"></a><span id="l123.667">     if (this._underlyingData == this.kUnderlyingRealFolder) {</span>
<a href="#l123.668"></a><span id="l123.668">       // quick-search inherits from threaded which inherits from group, so this</span>
<a href="#l123.669"></a><span id="l123.669">       //  is right to choose it first.</span>
<a href="#l123.670"></a><span id="l123.670">       if (this.search.hasSearchTerms)</span>
<a href="#l123.671"></a><span id="l123.671">         dbviewContractId += &quot;quicksearch&quot;;</span>
<a href="#l123.672"></a><span id="l123.672">       else if (this.showGroupedBySort)</span>
<a href="#l123.673"></a><span id="l123.673" class="difflineat">@@ -713,66 +984,80 @@ DBViewWrapper.prototype = {</span>
<a href="#l123.674"></a><span id="l123.674">         dbviewContractId += &quot;watchedthreadswithunread&quot;;</span>
<a href="#l123.675"></a><span id="l123.675">       else</span>
<a href="#l123.676"></a><span id="l123.676">         dbviewContractId += &quot;threaded&quot;;</span>
<a href="#l123.677"></a><span id="l123.677">     }</span>
<a href="#l123.678"></a><span id="l123.678">     // if we're dealing with virtual folders, the answer is always an xfvf</span>
<a href="#l123.679"></a><span id="l123.679">     else if (this._underlyingData == this.kUnderlyingMultipleFolder) {</span>
<a href="#l123.680"></a><span id="l123.680">       dbviewContractId += &quot;xfvf&quot;;</span>
<a href="#l123.681"></a><span id="l123.681">     }</span>
<a href="#l123.682"></a><span id="l123.682" class="difflineminus">-    else if (this._underlyingData == this.kUnderlyingSynthetic) {</span>
<a href="#l123.683"></a><span id="l123.683" class="difflineplus">+    else { // kUnderlyingSynthetic or kUnderlyingSearchView</span>
<a href="#l123.684"></a><span id="l123.684">       dbviewContractId += &quot;search&quot;;</span>
<a href="#l123.685"></a><span id="l123.685">     }</span>
<a href="#l123.686"></a><span id="l123.686"> </span>
<a href="#l123.687"></a><span id="l123.687" class="difflineplus">+    // and now zero the saved-off flags.</span>
<a href="#l123.688"></a><span id="l123.688" class="difflineplus">+    this.__viewFlags = null;</span>
<a href="#l123.689"></a><span id="l123.689" class="difflineplus">+</span>
<a href="#l123.690"></a><span id="l123.690">     let dbView = Cc[dbviewContractId]</span>
<a href="#l123.691"></a><span id="l123.691">                    .createInstance(Ci.nsIMsgDBView);</span>
<a href="#l123.692"></a><span id="l123.692">     dbView.init(this.listener.messenger, this.listener.msgWindow,</span>
<a href="#l123.693"></a><span id="l123.693">                 this.listener.threadPaneCommandUpdater);</span>
<a href="#l123.694"></a><span id="l123.694">     // use the least-specific sort so we can clock them back through to build up</span>
<a href="#l123.695"></a><span id="l123.695">     //  the correct sort order...</span>
<a href="#l123.696"></a><span id="l123.696" class="difflineminus">-    let [sortType, sortOrder] = this._sort[this._sort.length-1];</span>
<a href="#l123.697"></a><span id="l123.697" class="difflineplus">+    let [sortType, sortOrder, sortCustomCol] =</span>
<a href="#l123.698"></a><span id="l123.698" class="difflineplus">+      this._getSortDetails(this._sort.length-1);</span>
<a href="#l123.699"></a><span id="l123.699">     let outCount = {};</span>
<a href="#l123.700"></a><span id="l123.700">     // when the underlying folder is a single real folder (virtual or no), we</span>
<a href="#l123.701"></a><span id="l123.701">     //  tell the view about the underlying folder.</span>
<a href="#l123.702"></a><span id="l123.702">     if (this.isSingleFolder) {</span>
<a href="#l123.703"></a><span id="l123.703">       dbView.open(this._underlyingFolders[0], sortType, sortOrder, viewFlags,</span>
<a href="#l123.704"></a><span id="l123.704">                   outCount);</span>
<a href="#l123.705"></a><span id="l123.705">       // but if it's a virtual folder, we need to tell the db view about the</span>
<a href="#l123.706"></a><span id="l123.706">       //  the display (virtual) folder so it can store all the view-specific</span>
<a href="#l123.707"></a><span id="l123.707">       //  data there (things like the active mail view and such that go in</span>
<a href="#l123.708"></a><span id="l123.708">       //  dbFolderInfo.)</span>
<a href="#l123.709"></a><span id="l123.709">       if (this.isVirtual)</span>
<a href="#l123.710"></a><span id="l123.710">         dbView.viewFolder = this.displayedFolder;</span>
<a href="#l123.711"></a><span id="l123.711">     }</span>
<a href="#l123.712"></a><span id="l123.712">     // when we're dealing with a multi-folder virtual folder, we just tell the</span>
<a href="#l123.713"></a><span id="l123.713">     //  db view about the display folder.  (It gets its own XFVF view, so it</span>
<a href="#l123.714"></a><span id="l123.714">     //  knows what to do.)</span>
<a href="#l123.715"></a><span id="l123.715" class="difflineplus">+    // and for a synthetic folder, displayedFolder is null anyways</span>
<a href="#l123.716"></a><span id="l123.716">     else {</span>
<a href="#l123.717"></a><span id="l123.717">       dbView.open(this.displayedFolder, sortType, sortOrder, viewFlags,</span>
<a href="#l123.718"></a><span id="l123.718">                   outCount);</span>
<a href="#l123.719"></a><span id="l123.719">     }</span>
<a href="#l123.720"></a><span id="l123.720" class="difflineplus">+    if (sortCustomCol)</span>
<a href="#l123.721"></a><span id="l123.721" class="difflineplus">+      dbView.curCustomColumn = sortCustomCol;</span>
<a href="#l123.722"></a><span id="l123.722" class="difflineplus">+</span>
<a href="#l123.723"></a><span id="l123.723" class="difflineplus">+    // we all know it's a tree view, make sure the interface is available</span>
<a href="#l123.724"></a><span id="l123.724" class="difflineplus">+    //  so no one else has to do this.</span>
<a href="#l123.725"></a><span id="l123.725" class="difflineplus">+    dbView.QueryInterface(Ci.nsITreeView);</span>
<a href="#l123.726"></a><span id="l123.726"> </span>
<a href="#l123.727"></a><span id="l123.727">     // clock through the rest of the sorts, if there are any</span>
<a href="#l123.728"></a><span id="l123.728">     for (let iSort = this._sort.length - 2; iSort &gt;=0; iSort--) {</span>
<a href="#l123.729"></a><span id="l123.729" class="difflineminus">-      [sortType, sortOrder] = this._sort[iSort];</span>
<a href="#l123.730"></a><span id="l123.730" class="difflineplus">+      [sortType, sortOrder, sortCustomCol] = this._getSortDetails(iSort);</span>
<a href="#l123.731"></a><span id="l123.731" class="difflineplus">+      if (sortCustomCol)</span>
<a href="#l123.732"></a><span id="l123.732" class="difflineplus">+        dbView.curCustomColumn = sortCustomCol;</span>
<a href="#l123.733"></a><span id="l123.733">       dbView.sort(sortType, sortOrder);</span>
<a href="#l123.734"></a><span id="l123.734">     }</span>
<a href="#l123.735"></a><span id="l123.735"> </span>
<a href="#l123.736"></a><span id="l123.736">     return dbView;</span>
<a href="#l123.737"></a><span id="l123.737">   },</span>
<a href="#l123.738"></a><span id="l123.738"> </span>
<a href="#l123.739"></a><span id="l123.739">   /**</span>
<a href="#l123.740"></a><span id="l123.740">    * Callback method invoked by FolderNotificationHelper when our folder is</span>
<a href="#l123.741"></a><span id="l123.741">    *  loaded.  Assuming we are still interested in the folder, we enter the</span>
<a href="#l123.742"></a><span id="l123.742">    *  folder via _enterFolder.</span>
<a href="#l123.743"></a><span id="l123.743">    */</span>
<a href="#l123.744"></a><span id="l123.744">   _folderLoaded: function DBViewWrapper__folderLoaded(aFolder) {</span>
<a href="#l123.745"></a><span id="l123.745">     if (aFolder == this.displayedFolder) {</span>
<a href="#l123.746"></a><span id="l123.746">       this.folderLoading = false;</span>
<a href="#l123.747"></a><span id="l123.747">       this._enterFolder();</span>
<a href="#l123.748"></a><span id="l123.748" class="difflineplus">+      this.listener.onAllMessagesLoaded();</span>
<a href="#l123.749"></a><span id="l123.749">     }</span>
<a href="#l123.750"></a><span id="l123.750">   },</span>
<a href="#l123.751"></a><span id="l123.751"> </span>
<a href="#l123.752"></a><span id="l123.752">   /**</span>
<a href="#l123.753"></a><span id="l123.753">    * Enter this.displayedFolder if we have not yet entered it.</span>
<a href="#l123.754"></a><span id="l123.754">    *</span>
<a href="#l123.755"></a><span id="l123.755">    * Things we do on entering a folder:</span>
<a href="#l123.756"></a><span id="l123.756">    * - clear the folder's biffState!</span>
<a href="#l123.757"></a><span id="l123.757" class="difflineat">@@ -780,19 +1065,21 @@ DBViewWrapper.prototype = {</span>
<a href="#l123.758"></a><span id="l123.758">    */</span>
<a href="#l123.759"></a><span id="l123.759">   _enterFolder: function DBViewWrapper__enterFolder() {</span>
<a href="#l123.760"></a><span id="l123.760">     if (this._enteredFolder)</span>
<a href="#l123.761"></a><span id="l123.761">       return;</span>
<a href="#l123.762"></a><span id="l123.762"> </span>
<a href="#l123.763"></a><span id="l123.763">     this.displayedFolder.biffState =</span>
<a href="#l123.764"></a><span id="l123.764">       Ci.nsIMsgFolder.nsMsgBiffState_NoMail;</span>
<a href="#l123.765"></a><span id="l123.765"> </span>
<a href="#l123.766"></a><span id="l123.766" class="difflineminus">-    this.listener.onDisplayingFolder();</span>
<a href="#l123.767"></a><span id="l123.767" class="difflineplus">+    // we definitely want a view at this point; force the view.</span>
<a href="#l123.768"></a><span id="l123.768" class="difflineplus">+    this._viewUpdateDepth = 0;</span>
<a href="#l123.769"></a><span id="l123.769" class="difflineplus">+    this._applyViewChanges();</span>
<a href="#l123.770"></a><span id="l123.770"> </span>
<a href="#l123.771"></a><span id="l123.771" class="difflineminus">-    this.endViewUpdate();</span>
<a href="#l123.772"></a><span id="l123.772" class="difflineplus">+    this.listener.onDisplayingFolder();</span>
<a href="#l123.773"></a><span id="l123.773"> </span>
<a href="#l123.774"></a><span id="l123.774">     this._enteredFolder = true;</span>
<a href="#l123.775"></a><span id="l123.775">   },</span>
<a href="#l123.776"></a><span id="l123.776"> </span>
<a href="#l123.777"></a><span id="l123.777">   /**</span>
<a href="#l123.778"></a><span id="l123.778">    * Renames, moves to the trash, it's all crazy.  We have to update all our</span>
<a href="#l123.779"></a><span id="l123.779">    *  references when this happens.</span>
<a href="#l123.780"></a><span id="l123.780">    */</span>
<a href="#l123.781"></a><span id="l123.781" class="difflineat">@@ -842,47 +1129,174 @@ DBViewWrapper.prototype = {</span>
<a href="#l123.782"></a><span id="l123.782">       return;</span>
<a href="#l123.783"></a><span id="l123.783">     }</span>
<a href="#l123.784"></a><span id="l123.784">     // if we are virtual, this will update the search session which draws its</span>
<a href="#l123.785"></a><span id="l123.785">     //  search scopes from this._underlyingFolders anyways.</span>
<a href="#l123.786"></a><span id="l123.786">     this._applyViewChanges();</span>
<a href="#l123.787"></a><span id="l123.787">   },</span>
<a href="#l123.788"></a><span id="l123.788"> </span>
<a href="#l123.789"></a><span id="l123.789">   /**</span>
<a href="#l123.790"></a><span id="l123.790" class="difflineplus">+   * Compacting a local folder nukes its message keys, requiring the view to be</span>
<a href="#l123.791"></a><span id="l123.791" class="difflineplus">+   *  rebuilt.  If the folder is IMAP, it doesn't matter because the UIDs are</span>
<a href="#l123.792"></a><span id="l123.792" class="difflineplus">+   *  the message keys and we can ignore it.  In the local case we want to</span>
<a href="#l123.793"></a><span id="l123.793" class="difflineplus">+   *  notify our listener so they have a chance to save the selected messages.</span>
<a href="#l123.794"></a><span id="l123.794" class="difflineplus">+   */</span>
<a href="#l123.795"></a><span id="l123.795" class="difflineplus">+  _aboutToCompactFolder: function DBViewWrapper__aboutToCompactFolder(aFolder) {</span>
<a href="#l123.796"></a><span id="l123.796" class="difflineplus">+    // IMAP compaction does not affect us unless we are holding headers</span>
<a href="#l123.797"></a><span id="l123.797" class="difflineplus">+    if (aFolder.server.type == &quot;imap&quot;)</span>
<a href="#l123.798"></a><span id="l123.798" class="difflineplus">+      return;</span>
<a href="#l123.799"></a><span id="l123.799" class="difflineplus">+</span>
<a href="#l123.800"></a><span id="l123.800" class="difflineplus">+    // we will have to re-create the view, so nuke the view now.</span>
<a href="#l123.801"></a><span id="l123.801" class="difflineplus">+    if (this.dbView) {</span>
<a href="#l123.802"></a><span id="l123.802" class="difflineplus">+      this.listener.onDestroyingView(true);</span>
<a href="#l123.803"></a><span id="l123.803" class="difflineplus">+      this.search.dissociateView(this.dbView);</span>
<a href="#l123.804"></a><span id="l123.804" class="difflineplus">+      this.dbView.close();</span>
<a href="#l123.805"></a><span id="l123.805" class="difflineplus">+      this.dbView = null;</span>
<a href="#l123.806"></a><span id="l123.806" class="difflineplus">+    }</span>
<a href="#l123.807"></a><span id="l123.807" class="difflineplus">+  },</span>
<a href="#l123.808"></a><span id="l123.808" class="difflineplus">+</span>
<a href="#l123.809"></a><span id="l123.809" class="difflineplus">+  /**</span>
<a href="#l123.810"></a><span id="l123.810" class="difflineplus">+   * Compaction is all done, let's re-create the view!  (Unless the folder is</span>
<a href="#l123.811"></a><span id="l123.811" class="difflineplus">+   *  IMAP, in which case we are ignoring this event sequence.)</span>
<a href="#l123.812"></a><span id="l123.812" class="difflineplus">+   */</span>
<a href="#l123.813"></a><span id="l123.813" class="difflineplus">+  _compactedFolder: function DBViewWrapper__compactedFolder(aFolder) {</span>
<a href="#l123.814"></a><span id="l123.814" class="difflineplus">+    // IMAP compaction does not affect us unless we are holding headers</span>
<a href="#l123.815"></a><span id="l123.815" class="difflineplus">+    if (aFolder.server.type == &quot;imap&quot;)</span>
<a href="#l123.816"></a><span id="l123.816" class="difflineplus">+      return;</span>
<a href="#l123.817"></a><span id="l123.817" class="difflineplus">+</span>
<a href="#l123.818"></a><span id="l123.818" class="difflineplus">+    this.refresh();</span>
<a href="#l123.819"></a><span id="l123.819" class="difflineplus">+  },</span>
<a href="#l123.820"></a><span id="l123.820" class="difflineplus">+</span>
<a href="#l123.821"></a><span id="l123.821" class="difflineplus">+  /**</span>
<a href="#l123.822"></a><span id="l123.822" class="difflineplus">+   * DB Views need help to know when their move / deletion operations complete.</span>
<a href="#l123.823"></a><span id="l123.823" class="difflineplus">+   *  This happens in both single-folder and multiple-folder backed searches.</span>
<a href="#l123.824"></a><span id="l123.824" class="difflineplus">+   *  In the latter case, there is potential danger that we tell a view that did</span>
<a href="#l123.825"></a><span id="l123.825" class="difflineplus">+   *  not initiate the move / deletion but has kicked off its own about the</span>
<a href="#l123.826"></a><span id="l123.826" class="difflineplus">+   *  completion and confuse it.  However, that's on the view code.</span>
<a href="#l123.827"></a><span id="l123.827" class="difflineplus">+   */</span>
<a href="#l123.828"></a><span id="l123.828" class="difflineplus">+  _deleteCompleted: function DBViewWrapper__deleteCompleted(aFolder) {</span>
<a href="#l123.829"></a><span id="l123.829" class="difflineplus">+    if (this.dbView)</span>
<a href="#l123.830"></a><span id="l123.830" class="difflineplus">+      this.dbView.onDeleteCompleted(true);</span>
<a href="#l123.831"></a><span id="l123.831" class="difflineplus">+    this.listener.onMessagesRemoved();</span>
<a href="#l123.832"></a><span id="l123.832" class="difflineplus">+  },</span>
<a href="#l123.833"></a><span id="l123.833" class="difflineplus">+</span>
<a href="#l123.834"></a><span id="l123.834" class="difflineplus">+  /**</span>
<a href="#l123.835"></a><span id="l123.835" class="difflineplus">+   * See _deleteCompleted for an explanation of what is going on.</span>
<a href="#l123.836"></a><span id="l123.836" class="difflineplus">+   */</span>
<a href="#l123.837"></a><span id="l123.837" class="difflineplus">+  _deleteFailed: function DBViewWrapper__deleteFailed(aFolder) {</span>
<a href="#l123.838"></a><span id="l123.838" class="difflineplus">+    if (this.dbView)</span>
<a href="#l123.839"></a><span id="l123.839" class="difflineplus">+      this.dbView.onDeleteCompleted(false);</span>
<a href="#l123.840"></a><span id="l123.840" class="difflineplus">+    this.listener.onMessageRemovalFailed();</span>
<a href="#l123.841"></a><span id="l123.841" class="difflineplus">+  },</span>
<a href="#l123.842"></a><span id="l123.842" class="difflineplus">+</span>
<a href="#l123.843"></a><span id="l123.843" class="difflineplus">+  /**</span>
<a href="#l123.844"></a><span id="l123.844" class="difflineplus">+   * If the displayed folder had its total message count or total unread message</span>
<a href="#l123.845"></a><span id="l123.845" class="difflineplus">+   *  count change, notify the listener.  (Note: only for the display folder;</span>
<a href="#l123.846"></a><span id="l123.846" class="difflineplus">+   *  not the underlying folders!)</span>
<a href="#l123.847"></a><span id="l123.847" class="difflineplus">+   */</span>
<a href="#l123.848"></a><span id="l123.848" class="difflineplus">+  _messageCountsChanged: function DBViewWrapper__messageCountsChanged(aFolder) {</span>
<a href="#l123.849"></a><span id="l123.849" class="difflineplus">+    if (aFolder == this.displayedFolder)</span>
<a href="#l123.850"></a><span id="l123.850" class="difflineplus">+      this.listener.onMessageCountsChanged();</span>
<a href="#l123.851"></a><span id="l123.851" class="difflineplus">+  },</span>
<a href="#l123.852"></a><span id="l123.852" class="difflineplus">+</span>
<a href="#l123.853"></a><span id="l123.853" class="difflineplus">+  /**</span>
<a href="#l123.854"></a><span id="l123.854" class="difflineplus">+   * @return the current set of viewFlags.  This may be:</span>
<a href="#l123.855"></a><span id="l123.855" class="difflineplus">+   * - A modified set of flags that are pending application because a view</span>
<a href="#l123.856"></a><span id="l123.856" class="difflineplus">+   *    update is in effect and we don't want to modify the view when it's just</span>
<a href="#l123.857"></a><span id="l123.857" class="difflineplus">+   *    going to get destroyed.</span>
<a href="#l123.858"></a><span id="l123.858" class="difflineplus">+   * - The live set of flags from the current dbView.</span>
<a href="#l123.859"></a><span id="l123.859" class="difflineplus">+   * - The 'limbo' set of flags because we currently lack a view but will have</span>
<a href="#l123.860"></a><span id="l123.860" class="difflineplus">+   *    one soon (and then we will apply the flags).</span>
<a href="#l123.861"></a><span id="l123.861" class="difflineplus">+   */</span>
<a href="#l123.862"></a><span id="l123.862" class="difflineplus">+  get _viewFlags DBViewWrapper_get__viewFlags() {</span>
<a href="#l123.863"></a><span id="l123.863" class="difflineplus">+    if (this.__viewFlags != null)</span>
<a href="#l123.864"></a><span id="l123.864" class="difflineplus">+      return this.__viewFlags;</span>
<a href="#l123.865"></a><span id="l123.865" class="difflineplus">+    if (this.dbView)</span>
<a href="#l123.866"></a><span id="l123.866" class="difflineplus">+      return this.dbView.viewFlags;</span>
<a href="#l123.867"></a><span id="l123.867" class="difflineplus">+    return 0;</span>
<a href="#l123.868"></a><span id="l123.868" class="difflineplus">+  },</span>
<a href="#l123.869"></a><span id="l123.869" class="difflineplus">+  /**</span>
<a href="#l123.870"></a><span id="l123.870" class="difflineplus">+   * Update the view flags to use on the view.  If we are in a view update or</span>
<a href="#l123.871"></a><span id="l123.871" class="difflineplus">+   *  currently don't have a view, we save the view flags for later usage when</span>
<a href="#l123.872"></a><span id="l123.872" class="difflineplus">+   *  the view gets (re)built.  If we have a view, depending on what's happening</span>
<a href="#l123.873"></a><span id="l123.873" class="difflineplus">+   *  we may re-create the view or just set the bits.  The rules/reasons are:</span>
<a href="#l123.874"></a><span id="l123.874" class="difflineplus">+   * - XFVF views can handle the flag changes, just set the flags.</span>
<a href="#l123.875"></a><span id="l123.875" class="difflineplus">+   * - Single-folder threaded/unthreaded can handle a change to/from unthreaded/</span>
<a href="#l123.876"></a><span id="l123.876" class="difflineplus">+   *    threaded, so set it.</span>
<a href="#l123.877"></a><span id="l123.877" class="difflineplus">+   * - Single-folder can _not_ handle a change between grouped and not-grouped,</span>
<a href="#l123.878"></a><span id="l123.878" class="difflineplus">+   *    so re-generate the view.</span>
<a href="#l123.879"></a><span id="l123.879" class="difflineplus">+   */</span>
<a href="#l123.880"></a><span id="l123.880" class="difflineplus">+  set _viewFlags DBViewWrapper_set__viewFlags(aViewFlags) {</span>
<a href="#l123.881"></a><span id="l123.881" class="difflineplus">+    if (this._viewUpdateDepth || !this.dbView)</span>
<a href="#l123.882"></a><span id="l123.882" class="difflineplus">+      this.__viewFlags = aViewFlags;</span>
<a href="#l123.883"></a><span id="l123.883" class="difflineplus">+    else {</span>
<a href="#l123.884"></a><span id="l123.884" class="difflineplus">+      let oldFlags = this.dbView.viewFlags;</span>
<a href="#l123.885"></a><span id="l123.885" class="difflineplus">+      let changedFlags = oldFlags ^ aViewFlags;</span>
<a href="#l123.886"></a><span id="l123.886" class="difflineplus">+      if ((this.isVirtual &amp;&amp; this.isMultiFolder) ||</span>
<a href="#l123.887"></a><span id="l123.887" class="difflineplus">+          (this.isSingleFolder &amp;&amp;</span>
<a href="#l123.888"></a><span id="l123.888" class="difflineplus">+           !(changedFlags &amp; nsMsgViewFlagsType.kGroupBySort))) {</span>
<a href="#l123.889"></a><span id="l123.889" class="difflineplus">+        this.dbView.viewFlags = aViewFlags;</span>
<a href="#l123.890"></a><span id="l123.890" class="difflineplus">+        // ugh, and the single folder case needs us to re-apply his sort...</span>
<a href="#l123.891"></a><span id="l123.891" class="difflineplus">+        if (this.isSingleFolder)</span>
<a href="#l123.892"></a><span id="l123.892" class="difflineplus">+          this.dbView.sort(this.dbView.sortType, this.dbView.sortOrder);</span>
<a href="#l123.893"></a><span id="l123.893" class="difflineplus">+        this.listener.onSortChanged();</span>
<a href="#l123.894"></a><span id="l123.894" class="difflineplus">+      }</span>
<a href="#l123.895"></a><span id="l123.895" class="difflineplus">+      else {</span>
<a href="#l123.896"></a><span id="l123.896" class="difflineplus">+        this.__viewFlags = aViewFlags;</span>
<a href="#l123.897"></a><span id="l123.897" class="difflineplus">+        this._applyViewChanges();</span>
<a href="#l123.898"></a><span id="l123.898" class="difflineplus">+      }</span>
<a href="#l123.899"></a><span id="l123.899" class="difflineplus">+    }</span>
<a href="#l123.900"></a><span id="l123.900" class="difflineplus">+  },</span>
<a href="#l123.901"></a><span id="l123.901" class="difflineplus">+</span>
<a href="#l123.902"></a><span id="l123.902" class="difflineplus">+  /**</span>
<a href="#l123.903"></a><span id="l123.903">    * Apply accumulated changes to the view.  If we are in a batch, we do</span>
<a href="#l123.904"></a><span id="l123.904">    *  nothing, relying on endDisplayUpdate to call us.</span>
<a href="#l123.905"></a><span id="l123.905">    */</span>
<a href="#l123.906"></a><span id="l123.906">   _applyViewChanges: function DBViewWrapper__applyViewChanges() {</span>
<a href="#l123.907"></a><span id="l123.907">     // if we are in a batch, wait for endDisplayUpdate to be called to get us</span>
<a href="#l123.908"></a><span id="l123.908">     //  out to zero.</span>
<a href="#l123.909"></a><span id="l123.909">     if (this._viewUpdateDepth)</span>
<a href="#l123.910"></a><span id="l123.910">       return;</span>
<a href="#l123.911"></a><span id="l123.911">     // make the dbView stop being a search listener if it is one</span>
<a href="#l123.912"></a><span id="l123.912">     if (this.dbView) {</span>
<a href="#l123.913"></a><span id="l123.913" class="difflineplus">+      // save the view's flags if it has any and we haven't already overridden</span>
<a href="#l123.914"></a><span id="l123.914" class="difflineplus">+      //  them.</span>
<a href="#l123.915"></a><span id="l123.915" class="difflineplus">+      if (this.__viewFlags == null)</span>
<a href="#l123.916"></a><span id="l123.916" class="difflineplus">+        this.__viewFlags = this.dbView.viewFlags;</span>
<a href="#l123.917"></a><span id="l123.917" class="difflineplus">+      this.listener.onDestroyingView(true); // we will re-create it!</span>
<a href="#l123.918"></a><span id="l123.918">       this.search.dissociateView(this.dbView);</span>
<a href="#l123.919"></a><span id="l123.919">       this.dbView.close();</span>
<a href="#l123.920"></a><span id="l123.920" class="difflineplus">+      this.dbView = null;</span>
<a href="#l123.921"></a><span id="l123.921">     }</span>
<a href="#l123.922"></a><span id="l123.922"> </span>
<a href="#l123.923"></a><span id="l123.923">     this.dbView = this._createView();</span>
<a href="#l123.924"></a><span id="l123.924" class="difflineplus">+    // if the synthetic view defines columns, add those for it</span>
<a href="#l123.925"></a><span id="l123.925" class="difflineplus">+    if (this.isSynthetic) {</span>
<a href="#l123.926"></a><span id="l123.926" class="difflineplus">+      for (let [, customCol] in Iterator(this._syntheticView.customColumns)) {</span>
<a href="#l123.927"></a><span id="l123.927" class="difflineplus">+        customCol.bindToView(this.dbView);</span>
<a href="#l123.928"></a><span id="l123.928" class="difflineplus">+        this.dbView.addColumnHandler(customCol.id, customCol);</span>
<a href="#l123.929"></a><span id="l123.929" class="difflineplus">+      }</span>
<a href="#l123.930"></a><span id="l123.930" class="difflineplus">+    }</span>
<a href="#l123.931"></a><span id="l123.931">     this.listener.onCreatedView();</span>
<a href="#l123.932"></a><span id="l123.932"> </span>
<a href="#l123.933"></a><span id="l123.933">     // this ends up being a no-op if there are no search terms</span>
<a href="#l123.934"></a><span id="l123.934">     this.search.associateView(this.dbView);</span>
<a href="#l123.935"></a><span id="l123.935"> </span>
<a href="#l123.936"></a><span id="l123.936">     // If we are searching, then the search will generate the all messages</span>
<a href="#l123.937"></a><span id="l123.937">     //  loaded notification.  Although in some cases the search may have</span>
<a href="#l123.938"></a><span id="l123.938">     //  completed by now, that is not a guarantee.  The search logic is</span>
<a href="#l123.939"></a><span id="l123.939">     //  time-slicing, which is why this can vary.  (If it uses up its time</span>
<a href="#l123.940"></a><span id="l123.940">     //  slices, it will re-schedule itself, returning to us before completing.)</span>
<a href="#l123.941"></a><span id="l123.941">     //  Which is why we always defer to the search if one is active.</span>
<a href="#l123.942"></a><span id="l123.942" class="difflineminus">-    if (!this.searching)</span>
<a href="#l123.943"></a><span id="l123.943" class="difflineplus">+    // If we are loading the folder, the load completion will also notify us,</span>
<a href="#l123.944"></a><span id="l123.944" class="difflineplus">+    //  so we should not generate all messages loaded right now.</span>
<a href="#l123.945"></a><span id="l123.945" class="difflineplus">+    if (!this.searching &amp;&amp; !this.folderLoading)</span>
<a href="#l123.946"></a><span id="l123.946">       this.listener.onAllMessagesLoaded();</span>
<a href="#l123.947"></a><span id="l123.947">   },</span>
<a href="#l123.948"></a><span id="l123.948"> </span>
<a href="#l123.949"></a><span id="l123.949" class="difflineminus">-</span>
<a href="#l123.950"></a><span id="l123.950">   /**</span>
<a href="#l123.951"></a><span id="l123.951">    * Check if the folder or (optionally) one of its ancestors has any one of the</span>
<a href="#l123.952"></a><span id="l123.952">    *  provided flags set.</span>
<a href="#l123.953"></a><span id="l123.953">    *</span>
<a href="#l123.954"></a><span id="l123.954">    * In the event there is a folder with both the SentMail and Inbox flags set,</span>
<a href="#l123.955"></a><span id="l123.955">    *  it will be treated as an Inbox, and not as a SentMail folder.</span>
<a href="#l123.956"></a><span id="l123.956">    *</span>
<a href="#l123.957"></a><span id="l123.957">    * @param {nsIMsgFolder} aMsgFolder The folder whose flags you want to check.</span>
<a href="#l123.958"></a><span id="l123.958" class="difflineat">@@ -912,153 +1326,355 @@ DBViewWrapper.prototype = {</span>
<a href="#l123.959"></a><span id="l123.959">       // and not a SENT folder</span>
<a href="#l123.960"></a><span id="l123.960">       const nsMsgFolderFlags = Ci.nsMsgFolderFlags;</span>
<a href="#l123.961"></a><span id="l123.961">       return !((aFlags &amp; nsMsgFolderFlags.SentMail) &amp;&amp;</span>
<a href="#l123.962"></a><span id="l123.962">                (aMsgFolder.flags &amp; nsMsgFolderFlags.Inbox));</span>
<a href="#l123.963"></a><span id="l123.963">     }</span>
<a href="#l123.964"></a><span id="l123.964">   },</span>
<a href="#l123.965"></a><span id="l123.965"> </span>
<a href="#l123.966"></a><span id="l123.966"> </span>
<a href="#l123.967"></a><span id="l123.967" class="difflineplus">+  get isMailFolder() {</span>
<a href="#l123.968"></a><span id="l123.968" class="difflineplus">+    return this.displayedFolder &amp;&amp;</span>
<a href="#l123.969"></a><span id="l123.969" class="difflineplus">+           (this.displayedFolder.flags &amp; nsMsgFolderFlags.Mail);</span>
<a href="#l123.970"></a><span id="l123.970" class="difflineplus">+  },</span>
<a href="#l123.971"></a><span id="l123.971" class="difflineplus">+</span>
<a href="#l123.972"></a><span id="l123.972" class="difflineplus">+  get isNewsFolder() {</span>
<a href="#l123.973"></a><span id="l123.973" class="difflineplus">+    return this.displayedFolder &amp;&amp;</span>
<a href="#l123.974"></a><span id="l123.974" class="difflineplus">+           (this.displayedFolder.flags &amp; nsMsgFolderFlags.Newsgroup);</span>
<a href="#l123.975"></a><span id="l123.975" class="difflineplus">+  },</span>
<a href="#l123.976"></a><span id="l123.976" class="difflineplus">+</span>
<a href="#l123.977"></a><span id="l123.977">   OUTGOING_FOLDER_FLAGS: nsMsgFolderFlags.SentMail |</span>
<a href="#l123.978"></a><span id="l123.978">                          nsMsgFolderFlags.Drafts |</span>
<a href="#l123.979"></a><span id="l123.979">                          nsMsgFolderFlags.Queue |</span>
<a href="#l123.980"></a><span id="l123.980" class="difflineminus">-                         nsMsgFolderFlags.Template,</span>
<a href="#l123.981"></a><span id="l123.981" class="difflineplus">+                         nsMsgFolderFlags.Templates,</span>
<a href="#l123.982"></a><span id="l123.982">   /**</span>
<a href="#l123.983"></a><span id="l123.983">    * @return true if the folder is not known to be a special outgoing folder</span>
<a href="#l123.984"></a><span id="l123.984">    *     or the descendent of a special outgoing folder.</span>
<a href="#l123.985"></a><span id="l123.985">    */</span>
<a href="#l123.986"></a><span id="l123.986">   get isIncomingFolder() {</span>
<a href="#l123.987"></a><span id="l123.987">     return !this._isSpecialFolder(this.displayedFolder,</span>
<a href="#l123.988"></a><span id="l123.988" class="difflineminus">-                                  this.OUTGOING_FOLDER_FLAGS,</span>
<a href="#l123.989"></a><span id="l123.989" class="difflineminus">-                                  true);</span>
<a href="#l123.990"></a><span id="l123.990" class="difflineplus">+                                 this.OUTGOING_FOLDER_FLAGS,</span>
<a href="#l123.991"></a><span id="l123.991" class="difflineplus">+                                 true);</span>
<a href="#l123.992"></a><span id="l123.992">   },</span>
<a href="#l123.993"></a><span id="l123.993">   /**</span>
<a href="#l123.994"></a><span id="l123.994">    * @return true if the folder is an outgoing folder by virtue of being a</span>
<a href="#l123.995"></a><span id="l123.995">    *     sent mail folder, drafts folder, queue folder, or template folder,</span>
<a href="#l123.996"></a><span id="l123.996">    *     or being a sub-folder of one of those types of folders.</span>
<a href="#l123.997"></a><span id="l123.997">    */</span>
<a href="#l123.998"></a><span id="l123.998">   get isOutgoingFolder() {</span>
<a href="#l123.999"></a><span id="l123.999" class="difflineminus">-    return !this._isSpecialFolder(this.displayedFolder,</span>
<a href="#l123.1000"></a><span id="l123.1000" class="difflineminus">-                                  this.OUTGOING_FOLDER_FLAGS,</span>
<a href="#l123.1001"></a><span id="l123.1001" class="difflineminus">-                                  true);</span>
<a href="#l123.1002"></a><span id="l123.1002" class="difflineplus">+    return this._isSpecialFolder(this.displayedFolder,</span>
<a href="#l123.1003"></a><span id="l123.1003" class="difflineplus">+                                 this.OUTGOING_FOLDER_FLAGS,</span>
<a href="#l123.1004"></a><span id="l123.1004" class="difflineplus">+                                 true);</span>
<a href="#l123.1005"></a><span id="l123.1005">   },</span>
<a href="#l123.1006"></a><span id="l123.1006"> </span>
<a href="#l123.1007"></a><span id="l123.1007">   get isVirtual() {</span>
<a href="#l123.1008"></a><span id="l123.1008">     return Boolean(this.displayedFolder &amp;&amp;</span>
<a href="#l123.1009"></a><span id="l123.1009">                    (this.displayedFolder.flags &amp; nsMsgFolderFlags.Virtual));</span>
<a href="#l123.1010"></a><span id="l123.1010">   },</span>
<a href="#l123.1011"></a><span id="l123.1011"> </span>
<a href="#l123.1012"></a><span id="l123.1012" class="difflineplus">+  /**</span>
<a href="#l123.1013"></a><span id="l123.1013" class="difflineplus">+   * Prevent view updates from running until a paired |endViewUpdate| call is</span>
<a href="#l123.1014"></a><span id="l123.1014" class="difflineplus">+   *  made.  This is an advisory method intended to aid us in performing</span>
<a href="#l123.1015"></a><span id="l123.1015" class="difflineplus">+   *  redundant view re-computations and does not forbid us from building the</span>
<a href="#l123.1016"></a><span id="l123.1016" class="difflineplus">+   *  view earlier if we have a good reason.</span>
<a href="#l123.1017"></a><span id="l123.1017" class="difflineplus">+   * Since calling endViewUpdate will compel a view update when the update</span>
<a href="#l123.1018"></a><span id="l123.1018" class="difflineplus">+   *  depth reaches 0, you should only call this method if you are sure that</span>
<a href="#l123.1019"></a><span id="l123.1019" class="difflineplus">+   *  you will need the view to be re-built.  If you are doing things like</span>
<a href="#l123.1020"></a><span id="l123.1020" class="difflineplus">+   *  changing to/from threaded mode that do not cause the view to be rebuilt,</span>
<a href="#l123.1021"></a><span id="l123.1021" class="difflineplus">+   *  you should just set those attributes directly.</span>
<a href="#l123.1022"></a><span id="l123.1022" class="difflineplus">+   */</span>
<a href="#l123.1023"></a><span id="l123.1023">   beginViewUpdate: function DBViewWrapper_beginViewUpdate() {</span>
<a href="#l123.1024"></a><span id="l123.1024">     this._viewUpdateDepth++;</span>
<a href="#l123.1025"></a><span id="l123.1025">   },</span>
<a href="#l123.1026"></a><span id="l123.1026"> </span>
<a href="#l123.1027"></a><span id="l123.1027" class="difflineminus">-  endViewUpdate: function DBViewWrapper_endViewUpdate() {</span>
<a href="#l123.1028"></a><span id="l123.1028" class="difflineminus">-    if (--this._viewUpdateDepth == 0) {</span>
<a href="#l123.1029"></a><span id="l123.1029" class="difflineplus">+  /**</span>
<a href="#l123.1030"></a><span id="l123.1030" class="difflineplus">+   * Conclude a paired call to |endViewUpdate|.  Assuming the view depth has</span>
<a href="#l123.1031"></a><span id="l123.1031" class="difflineplus">+   *  reached 0 with this call, the view will be re-created with the current</span>
<a href="#l123.1032"></a><span id="l123.1032" class="difflineplus">+   *  settings.</span>
<a href="#l123.1033"></a><span id="l123.1033" class="difflineplus">+   */</span>
<a href="#l123.1034"></a><span id="l123.1034" class="difflineplus">+  endViewUpdate: function DBViewWrapper_endViewUpdate(aForceLevel) {</span>
<a href="#l123.1035"></a><span id="l123.1035" class="difflineplus">+    if (--this._viewUpdateDepth == 0)</span>
<a href="#l123.1036"></a><span id="l123.1036">       this._applyViewChanges();</span>
<a href="#l123.1037"></a><span id="l123.1037" class="difflineminus">-    }</span>
<a href="#l123.1038"></a><span id="l123.1038" class="difflineplus">+    // Avoid pathological situations.</span>
<a href="#l123.1039"></a><span id="l123.1039" class="difflineplus">+    if (this._viewUpdateDepth &lt; 0)</span>
<a href="#l123.1040"></a><span id="l123.1040" class="difflineplus">+      this._viewUpdateDepth = 0;</span>
<a href="#l123.1041"></a><span id="l123.1041" class="difflineplus">+  },</span>
<a href="#l123.1042"></a><span id="l123.1042" class="difflineplus">+</span>
<a href="#l123.1043"></a><span id="l123.1043" class="difflineplus">+  /**</span>
<a href="#l123.1044"></a><span id="l123.1044" class="difflineplus">+   * @return the primary sort type (as one of the numeric constants from</span>
<a href="#l123.1045"></a><span id="l123.1045" class="difflineplus">+   *      nsMsgViewSortType).</span>
<a href="#l123.1046"></a><span id="l123.1046" class="difflineplus">+   */</span>
<a href="#l123.1047"></a><span id="l123.1047" class="difflineplus">+  get primarySortType() {</span>
<a href="#l123.1048"></a><span id="l123.1048" class="difflineplus">+    return this._sort[0][0];</span>
<a href="#l123.1049"></a><span id="l123.1049" class="difflineplus">+  },</span>
<a href="#l123.1050"></a><span id="l123.1050" class="difflineplus">+</span>
<a href="#l123.1051"></a><span id="l123.1051" class="difflineplus">+  /**</span>
<a href="#l123.1052"></a><span id="l123.1052" class="difflineplus">+   * @return the primary sort order (as one of the numeric constants from</span>
<a href="#l123.1053"></a><span id="l123.1053" class="difflineplus">+   *     nsMsgViewSortOrder.)</span>
<a href="#l123.1054"></a><span id="l123.1054" class="difflineplus">+   */</span>
<a href="#l123.1055"></a><span id="l123.1055" class="difflineplus">+  get primarySortOrder() {</span>
<a href="#l123.1056"></a><span id="l123.1056" class="difflineplus">+    return this._sort[0][1];</span>
<a href="#l123.1057"></a><span id="l123.1057" class="difflineplus">+  },</span>
<a href="#l123.1058"></a><span id="l123.1058" class="difflineplus">+</span>
<a href="#l123.1059"></a><span id="l123.1059" class="difflineplus">+  /**</span>
<a href="#l123.1060"></a><span id="l123.1060" class="difflineplus">+   * @return true if the dominant sort is ascending.</span>
<a href="#l123.1061"></a><span id="l123.1061" class="difflineplus">+   */</span>
<a href="#l123.1062"></a><span id="l123.1062" class="difflineplus">+  get isSortedAscending() {</span>
<a href="#l123.1063"></a><span id="l123.1063" class="difflineplus">+    return this._sort.length &amp;&amp;</span>
<a href="#l123.1064"></a><span id="l123.1064" class="difflineplus">+           this._sort[0][1] == nsMsgViewSortOrder.ascending;</span>
<a href="#l123.1065"></a><span id="l123.1065" class="difflineplus">+  },</span>
<a href="#l123.1066"></a><span id="l123.1066" class="difflineplus">+  /**</span>
<a href="#l123.1067"></a><span id="l123.1067" class="difflineplus">+   * @return true if the dominant sort is descending.</span>
<a href="#l123.1068"></a><span id="l123.1068" class="difflineplus">+   */</span>
<a href="#l123.1069"></a><span id="l123.1069" class="difflineplus">+  get isSortedDescending() {</span>
<a href="#l123.1070"></a><span id="l123.1070" class="difflineplus">+    return this._sort.length &amp;&amp;</span>
<a href="#l123.1071"></a><span id="l123.1071" class="difflineplus">+           this._sort[0][1] == nsMsgViewSortOrder.descending;</span>
<a href="#l123.1072"></a><span id="l123.1072" class="difflineplus">+  },</span>
<a href="#l123.1073"></a><span id="l123.1073" class="difflineplus">+  /**</span>
<a href="#l123.1074"></a><span id="l123.1074" class="difflineplus">+   * Indicate if we are sorting by time or something correlated with time.</span>
<a href="#l123.1075"></a><span id="l123.1075" class="difflineplus">+   *</span>
<a href="#l123.1076"></a><span id="l123.1076" class="difflineplus">+   * @return true if the dominant sort is by time.</span>
<a href="#l123.1077"></a><span id="l123.1077" class="difflineplus">+   */</span>
<a href="#l123.1078"></a><span id="l123.1078" class="difflineplus">+  get sortImpliesTemporalOrdering() {</span>
<a href="#l123.1079"></a><span id="l123.1079" class="difflineplus">+    if (!this._sort.length)</span>
<a href="#l123.1080"></a><span id="l123.1080" class="difflineplus">+      return false;</span>
<a href="#l123.1081"></a><span id="l123.1081" class="difflineplus">+    let sortType = this._sort[0][0];</span>
<a href="#l123.1082"></a><span id="l123.1082" class="difflineplus">+    return sortType == nsMsgViewSortType.byDate ||</span>
<a href="#l123.1083"></a><span id="l123.1083" class="difflineplus">+           sortType == nsMsgViewSortType.byReceived ||</span>
<a href="#l123.1084"></a><span id="l123.1084" class="difflineplus">+           sortType == nsMsgViewSortType.byId ||</span>
<a href="#l123.1085"></a><span id="l123.1085" class="difflineplus">+           sortType == nsMsgViewSortType.byThread;</span>
<a href="#l123.1086"></a><span id="l123.1086" class="difflineplus">+  },</span>
<a href="#l123.1087"></a><span id="l123.1087" class="difflineplus">+</span>
<a href="#l123.1088"></a><span id="l123.1088" class="difflineplus">+  sortAscending: function() {</span>
<a href="#l123.1089"></a><span id="l123.1089" class="difflineplus">+    if (!this.isSortedAscending)</span>
<a href="#l123.1090"></a><span id="l123.1090" class="difflineplus">+      this.magicSort(this._sort[0][0], nsMsgViewSortOrder.ascending);</span>
<a href="#l123.1091"></a><span id="l123.1091" class="difflineplus">+  },</span>
<a href="#l123.1092"></a><span id="l123.1092" class="difflineplus">+  sortDescending: function() {</span>
<a href="#l123.1093"></a><span id="l123.1093" class="difflineplus">+    if (!this.isSortedDescending)</span>
<a href="#l123.1094"></a><span id="l123.1094" class="difflineplus">+      this.magicSort(this._sort[0][0], nsMsgViewSortOrder.descending);</span>
<a href="#l123.1095"></a><span id="l123.1095">   },</span>
<a href="#l123.1096"></a><span id="l123.1096"> </span>
<a href="#l123.1097"></a><span id="l123.1097">   /**</span>
<a href="#l123.1098"></a><span id="l123.1098">    * Explicit sort command.  We ignore all previous sort state and only apply</span>
<a href="#l123.1099"></a><span id="l123.1099">    *  what you tell us.  If you want implied secondary sort, use |magicSort|.</span>
<a href="#l123.1100"></a><span id="l123.1100">    * You must use this sort command, and never directly call the sort commands</span>
<a href="#l123.1101"></a><span id="l123.1101">    *  on the underlying db view!  If you do not, make sure to fight us every</span>
<a href="#l123.1102"></a><span id="l123.1102">    *   step of the way, because we will keep clobbering your manually applied</span>
<a href="#l123.1103"></a><span id="l123.1103">    *   sort.</span>
<a href="#l123.1104"></a><span id="l123.1104">    */</span>
<a href="#l123.1105"></a><span id="l123.1105">   sort: function DBViewWrapper_sort(aSortType, aSortOrder,</span>
<a href="#l123.1106"></a><span id="l123.1106">                                     aSecondaryType, aSecondaryOrder) {</span>
<a href="#l123.1107"></a><span id="l123.1107">     this._sort = [[aSortType, aSortOrder]];</span>
<a href="#l123.1108"></a><span id="l123.1108">     if (aSecondaryType != null &amp;&amp; aSecondaryOrder != null)</span>
<a href="#l123.1109"></a><span id="l123.1109">       this._sort.push([aSecondaryType, aSecondaryOrder]);</span>
<a href="#l123.1110"></a><span id="l123.1110" class="difflineplus">+    // make sure the sort won't make the view angry...</span>
<a href="#l123.1111"></a><span id="l123.1111" class="difflineplus">+    this._ensureValidSort();</span>
<a href="#l123.1112"></a><span id="l123.1112">     // if we are not in a view update, invoke the sort.</span>
<a href="#l123.1113"></a><span id="l123.1113">     if ((this._viewUpdateDepth == 0) &amp;&amp; this.dbView) {</span>
<a href="#l123.1114"></a><span id="l123.1114">       for (let iSort = this._sort.length - 1; iSort &gt;=0; iSort--) {</span>
<a href="#l123.1115"></a><span id="l123.1115">         // apply them in the reverse order</span>
<a href="#l123.1116"></a><span id="l123.1116">         let [sortType, sortOrder] = this._sort[iSort];</span>
<a href="#l123.1117"></a><span id="l123.1117">         this.dbView.sort(sortType, sortOrder);</span>
<a href="#l123.1118"></a><span id="l123.1118">       }</span>
<a href="#l123.1119"></a><span id="l123.1119" class="difflineplus">+      // (only generate the event since we're not in a update batch)</span>
<a href="#l123.1120"></a><span id="l123.1120" class="difflineplus">+      this.listener.onSortChanged();</span>
<a href="#l123.1121"></a><span id="l123.1121">     }</span>
<a href="#l123.1122"></a><span id="l123.1122">     // (if we are in a view update, then a new view will be created when the</span>
<a href="#l123.1123"></a><span id="l123.1123">     //  update ends, and it will just use the new sort order anyways.)</span>
<a href="#l123.1124"></a><span id="l123.1124">   },</span>
<a href="#l123.1125"></a><span id="l123.1125"> </span>
<a href="#l123.1126"></a><span id="l123.1126">   /**</span>
<a href="#l123.1127"></a><span id="l123.1127" class="difflineplus">+   * Logic that compensates for custom column identifiers being provided as</span>
<a href="#l123.1128"></a><span id="l123.1128" class="difflineplus">+   *  sort types.</span>
<a href="#l123.1129"></a><span id="l123.1129" class="difflineplus">+   *</span>
<a href="#l123.1130"></a><span id="l123.1130" class="difflineplus">+   * @return [sort type, sort order, sort custom column name]</span>
<a href="#l123.1131"></a><span id="l123.1131" class="difflineplus">+   */</span>
<a href="#l123.1132"></a><span id="l123.1132" class="difflineplus">+  _getSortDetails: function(aIndex) {</span>
<a href="#l123.1133"></a><span id="l123.1133" class="difflineplus">+    let [sortType, sortOrder] = this._sort[aIndex];</span>
<a href="#l123.1134"></a><span id="l123.1134" class="difflineplus">+    let sortCustomColumn = null;</span>
<a href="#l123.1135"></a><span id="l123.1135" class="difflineplus">+    let sortTypeType = typeof(sortType);</span>
<a href="#l123.1136"></a><span id="l123.1136" class="difflineplus">+    if (sortTypeType != &quot;number&quot;) {</span>
<a href="#l123.1137"></a><span id="l123.1137" class="difflineplus">+      sortCustomColumn = (sortTypeType == &quot;string&quot;) ? sortType : sortType.id;</span>
<a href="#l123.1138"></a><span id="l123.1138" class="difflineplus">+      sortType = nsMsgViewSortType.byCustom;</span>
<a href="#l123.1139"></a><span id="l123.1139" class="difflineplus">+    }</span>
<a href="#l123.1140"></a><span id="l123.1140" class="difflineplus">+</span>
<a href="#l123.1141"></a><span id="l123.1141" class="difflineplus">+    return [sortType, sortOrder, sortCustomColumn];</span>
<a href="#l123.1142"></a><span id="l123.1142" class="difflineplus">+  },</span>
<a href="#l123.1143"></a><span id="l123.1143" class="difflineplus">+</span>
<a href="#l123.1144"></a><span id="l123.1144" class="difflineplus">+  /**</span>
<a href="#l123.1145"></a><span id="l123.1145">    * Accumulates implied secondary sorts based on multiple calls to this method.</span>
<a href="#l123.1146"></a><span id="l123.1146">    *  This is intended to be hooked up to be controlled by the UI.</span>
<a href="#l123.1147"></a><span id="l123.1147">    * Because we are lazy, we actually just poke the view's sort method and save</span>
<a href="#l123.1148"></a><span id="l123.1148">    *  the apparent secondary sort.  This also allows perfect compliance with the</span>
<a href="#l123.1149"></a><span id="l123.1149">    *  way this used to be implemented!</span>
<a href="#l123.1150"></a><span id="l123.1150">    */</span>
<a href="#l123.1151"></a><span id="l123.1151">   magicSort: function DBViewWrapper_magicSort(aSortType, aSortOrder) {</span>
<a href="#l123.1152"></a><span id="l123.1152">     if (this.dbView) {</span>
<a href="#l123.1153"></a><span id="l123.1153" class="difflineminus">-      this.dbView.sort(aSortType, aSortOrder);</span>
<a href="#l123.1154"></a><span id="l123.1154">       // so, the thing we just set obviously will be there</span>
<a href="#l123.1155"></a><span id="l123.1155">       this._sort = [[aSortType, aSortOrder]];</span>
<a href="#l123.1156"></a><span id="l123.1156" class="difflineplus">+      // (make sure it is valid...)</span>
<a href="#l123.1157"></a><span id="l123.1157" class="difflineplus">+      this._ensureValidSort();</span>
<a href="#l123.1158"></a><span id="l123.1158" class="difflineplus">+      // apply the sort to see what happens secondary-wise</span>
<a href="#l123.1159"></a><span id="l123.1159" class="difflineplus">+      this.dbView.sort(aSortType, aSortOrder);</span>
<a href="#l123.1160"></a><span id="l123.1160">       // there is only a secondary sort if it's not none and not the same.</span>
<a href="#l123.1161"></a><span id="l123.1161">       if (this.dbView.secondarySortType != nsMsgViewSortType.byNone &amp;&amp;</span>
<a href="#l123.1162"></a><span id="l123.1162">           this.dbView.secondarySortType != aSortType)</span>
<a href="#l123.1163"></a><span id="l123.1163">         this._sort.push([this.dbView.secondarySortType,</span>
<a href="#l123.1164"></a><span id="l123.1164">                          this.dbView.secondarySortOrder]);</span>
<a href="#l123.1165"></a><span id="l123.1165" class="difflineplus">+      // only tell our listener if we're not in a view update batch</span>
<a href="#l123.1166"></a><span id="l123.1166" class="difflineplus">+      if (this._viewUpdateDepth == 0)</span>
<a href="#l123.1167"></a><span id="l123.1167" class="difflineplus">+        this.listener.onSortChanged();</span>
<a href="#l123.1168"></a><span id="l123.1168">     }</span>
<a href="#l123.1169"></a><span id="l123.1169">   },</span>
<a href="#l123.1170"></a><span id="l123.1170"> </span>
<a href="#l123.1171"></a><span id="l123.1171" class="difflineplus">+  /**</span>
<a href="#l123.1172"></a><span id="l123.1172" class="difflineplus">+   * Make sure the current sort is valid under our other constraints, make it</span>
<a href="#l123.1173"></a><span id="l123.1173" class="difflineplus">+   *  safe if it is not.  Most specifically, some sorts are illegal when</span>
<a href="#l123.1174"></a><span id="l123.1174" class="difflineplus">+   *  grouping by sort, and we reset the sort to date in those cases.</span>
<a href="#l123.1175"></a><span id="l123.1175" class="difflineplus">+   *</span>
<a href="#l123.1176"></a><span id="l123.1176" class="difflineplus">+   * @param aViewFlags Optional set of view flags to consider instead of the</span>
<a href="#l123.1177"></a><span id="l123.1177" class="difflineplus">+   *     potentially live view flags.</span>
<a href="#l123.1178"></a><span id="l123.1178" class="difflineplus">+   */</span>
<a href="#l123.1179"></a><span id="l123.1179" class="difflineplus">+  _ensureValidSort: function DBViewWrapper_ensureValidSort(aViewFlags) {</span>
<a href="#l123.1180"></a><span id="l123.1180" class="difflineplus">+    if ((aViewFlags != null ? aViewFlags : this._viewFlags) &amp;</span>
<a href="#l123.1181"></a><span id="l123.1181" class="difflineplus">+        nsMsgViewFlagsType.kGroupBySort) {</span>
<a href="#l123.1182"></a><span id="l123.1182" class="difflineplus">+      // We cannot be sorting by thread, id, none, or size.  If we are, switch</span>
<a href="#l123.1183"></a><span id="l123.1183" class="difflineplus">+      //  to sorting by date.</span>
<a href="#l123.1184"></a><span id="l123.1184" class="difflineplus">+      let sortType = this._sort[0][0];</span>
<a href="#l123.1185"></a><span id="l123.1185" class="difflineplus">+      if (sortType == nsMsgViewSortType.byThread ||</span>
<a href="#l123.1186"></a><span id="l123.1186" class="difflineplus">+          sortType == nsMsgViewSortType.byId ||</span>
<a href="#l123.1187"></a><span id="l123.1187" class="difflineplus">+          sortType == nsMsgViewSortType.byNone ||</span>
<a href="#l123.1188"></a><span id="l123.1188" class="difflineplus">+          sortType == nsMsgViewSortType.bySize)</span>
<a href="#l123.1189"></a><span id="l123.1189" class="difflineplus">+        this._sort = [nsMsgViewSortType.byDate, this._sort[0][1]];</span>
<a href="#l123.1190"></a><span id="l123.1190" class="difflineplus">+    }</span>
<a href="#l123.1191"></a><span id="l123.1191" class="difflineplus">+  },</span>
<a href="#l123.1192"></a><span id="l123.1192" class="difflineplus">+</span>
<a href="#l123.1193"></a><span id="l123.1193" class="difflineplus">+  /**</span>
<a href="#l123.1194"></a><span id="l123.1194" class="difflineplus">+   * @return true if we are grouped-by-sort, false if not.  If we are not</span>
<a href="#l123.1195"></a><span id="l123.1195" class="difflineplus">+   *     grouped by sort, then we are either threaded or unthreaded; check</span>
<a href="#l123.1196"></a><span id="l123.1196" class="difflineplus">+   *     the showThreaded property to find out which of those it is.</span>
<a href="#l123.1197"></a><span id="l123.1197" class="difflineplus">+   */</span>
<a href="#l123.1198"></a><span id="l123.1198">   get showGroupedBySort() {</span>
<a href="#l123.1199"></a><span id="l123.1199">     return Boolean(this._viewFlags &amp; nsMsgViewFlagsType.kGroupBySort);</span>
<a href="#l123.1200"></a><span id="l123.1200">   },</span>
<a href="#l123.1201"></a><span id="l123.1201" class="difflineplus">+  /**</span>
<a href="#l123.1202"></a><span id="l123.1202" class="difflineplus">+   * Enable grouped-by-sort which is mutually exclusive with threaded display</span>
<a href="#l123.1203"></a><span id="l123.1203" class="difflineplus">+   *  (as controlled/exposed by showThreaded).  Grouped-by-sort is not legal</span>
<a href="#l123.1204"></a><span id="l123.1204" class="difflineplus">+   *  for sorts by thread/id/size/none and enabling this will cause us to change</span>
<a href="#l123.1205"></a><span id="l123.1205" class="difflineplus">+   *  our sort to by date in those cases.</span>
<a href="#l123.1206"></a><span id="l123.1206" class="difflineplus">+   */</span>
<a href="#l123.1207"></a><span id="l123.1207">   set showGroupedBySort(aShowGroupBySort) {</span>
<a href="#l123.1208"></a><span id="l123.1208">     if (this.showGroupedBySort != aShowGroupBySort) {</span>
<a href="#l123.1209"></a><span id="l123.1209" class="difflineminus">-      if (aShowGroupBySort)</span>
<a href="#l123.1210"></a><span id="l123.1210" class="difflineminus">-        this._viewFlags |= nsMsgViewFlagsType.kGroupBySort;</span>
<a href="#l123.1211"></a><span id="l123.1211" class="difflineplus">+      if (aShowGroupBySort) {</span>
<a href="#l123.1212"></a><span id="l123.1212" class="difflineplus">+        // do not apply the flag change until we have made the sort safe</span>
<a href="#l123.1213"></a><span id="l123.1213" class="difflineplus">+        let viewFlags = this._viewFlags |</span>
<a href="#l123.1214"></a><span id="l123.1214" class="difflineplus">+                        nsMsgViewFlagsType.kGroupBySort |</span>
<a href="#l123.1215"></a><span id="l123.1215" class="difflineplus">+                         nsMsgViewFlagsType.kThreadedDisplay;</span>
<a href="#l123.1216"></a><span id="l123.1216" class="difflineplus">+        this._ensureValidSort(viewFlags);</span>
<a href="#l123.1217"></a><span id="l123.1217" class="difflineplus">+        this._viewFlags = viewFlags;</span>
<a href="#l123.1218"></a><span id="l123.1218" class="difflineplus">+      }</span>
<a href="#l123.1219"></a><span id="l123.1219" class="difflineplus">+      // maybe we shouldn't do anything in this case?</span>
<a href="#l123.1220"></a><span id="l123.1220">       else</span>
<a href="#l123.1221"></a><span id="l123.1221" class="difflineminus">-        this._viewFlags &amp;= ~nsMsgViewFlagsType.kGroupBySort;</span>
<a href="#l123.1222"></a><span id="l123.1222" class="difflineminus">-      // lose the threading bit...</span>
<a href="#l123.1223"></a><span id="l123.1223" class="difflineminus">-      this._viewFlags &amp;= ~nsMsgViewFlagsType.kThreadedDisplay;</span>
<a href="#l123.1224"></a><span id="l123.1224" class="difflineminus">-      this._applyViewChanges();</span>
<a href="#l123.1225"></a><span id="l123.1225" class="difflineplus">+        this._viewFlags &amp;= ~(nsMsgViewFlagsType.kGroupBySort |</span>
<a href="#l123.1226"></a><span id="l123.1226" class="difflineplus">+                             nsMsgViewFlagsType.kThreadedDisplay);</span>
<a href="#l123.1227"></a><span id="l123.1227">     }</span>
<a href="#l123.1228"></a><span id="l123.1228">   },</span>
<a href="#l123.1229"></a><span id="l123.1229"> </span>
<a href="#l123.1230"></a><span id="l123.1230" class="difflineplus">+  /**</span>
<a href="#l123.1231"></a><span id="l123.1231" class="difflineplus">+   * Are we showing ignored/killed threads?  Only meaningful for newsgroups.</span>
<a href="#l123.1232"></a><span id="l123.1232" class="difflineplus">+   */</span>
<a href="#l123.1233"></a><span id="l123.1233">   get showIgnored() {</span>
<a href="#l123.1234"></a><span id="l123.1234">     return Boolean(this._viewFlags &amp; nsMsgViewFlagsType.kShowIgnored);</span>
<a href="#l123.1235"></a><span id="l123.1235">   },</span>
<a href="#l123.1236"></a><span id="l123.1236" class="difflineplus">+  /**</span>
<a href="#l123.1237"></a><span id="l123.1237" class="difflineplus">+   * Set whether we are showing ignored/killed threads.  Only meaningful for</span>
<a href="#l123.1238"></a><span id="l123.1238" class="difflineplus">+   *  newsgroups.</span>
<a href="#l123.1239"></a><span id="l123.1239" class="difflineplus">+   */</span>
<a href="#l123.1240"></a><span id="l123.1240">   set showIgnored(aShowIgnored) {</span>
<a href="#l123.1241"></a><span id="l123.1241">     if (this.showIgnored != aShowIgnored) {</span>
<a href="#l123.1242"></a><span id="l123.1242">       if (aShowIgnored)</span>
<a href="#l123.1243"></a><span id="l123.1243">         this._viewFlags |= nsMsgViewFlagsType.kShowIgnored;</span>
<a href="#l123.1244"></a><span id="l123.1244">       else</span>
<a href="#l123.1245"></a><span id="l123.1245">         this._viewFlags &amp;= ~nsMsgViewFlagsType.kShowIgnored;</span>
<a href="#l123.1246"></a><span id="l123.1246" class="difflineminus">-      this._applyViewChanges();</span>
<a href="#l123.1247"></a><span id="l123.1247" class="difflineplus">+    }</span>
<a href="#l123.1248"></a><span id="l123.1248" class="difflineplus">+  },</span>
<a href="#l123.1249"></a><span id="l123.1249" class="difflineplus">+</span>
<a href="#l123.1250"></a><span id="l123.1250" class="difflineplus">+  /**</span>
<a href="#l123.1251"></a><span id="l123.1251" class="difflineplus">+   * @return true if we are in threaded display (as opposed to grouped or</span>
<a href="#l123.1252"></a><span id="l123.1252" class="difflineplus">+   *     unthreaded.)</span>
<a href="#l123.1253"></a><span id="l123.1253" class="difflineplus">+   */</span>
<a href="#l123.1254"></a><span id="l123.1254" class="difflineplus">+  get showThreaded() {</span>
<a href="#l123.1255"></a><span id="l123.1255" class="difflineplus">+    return (this._viewFlags &amp; nsMsgViewFlagsType.kThreadedDisplay) &amp;&amp;</span>
<a href="#l123.1256"></a><span id="l123.1256" class="difflineplus">+           !(this._viewFlags &amp; nsMsgViewFlagsType.kGroupBySort);</span>
<a href="#l123.1257"></a><span id="l123.1257" class="difflineplus">+  },</span>
<a href="#l123.1258"></a><span id="l123.1258" class="difflineplus">+  /**</span>
<a href="#l123.1259"></a><span id="l123.1259" class="difflineplus">+   * Set us to threaded display mode when set to true.  If we are already in</span>
<a href="#l123.1260"></a><span id="l123.1260" class="difflineplus">+   *  threaded display mode, we do nothing.  If you want to set us to unthreaded</span>
<a href="#l123.1261"></a><span id="l123.1261" class="difflineplus">+   *  mode, set |showUnthreaded| to true.  (Because we have three modes of</span>
<a href="#l123.1262"></a><span id="l123.1262" class="difflineplus">+   *  operation: unthreaded, threaded, and grouped-by-sort, we are a tri-state</span>
<a href="#l123.1263"></a><span id="l123.1263" class="difflineplus">+   *  and setting us to false is ambiguous.  We should probably be using a</span>
<a href="#l123.1264"></a><span id="l123.1264" class="difflineplus">+   *  single attribute with three constants...)</span>
<a href="#l123.1265"></a><span id="l123.1265" class="difflineplus">+   */</span>
<a href="#l123.1266"></a><span id="l123.1266" class="difflineplus">+  set showThreaded(aShowThreaded) {</span>
<a href="#l123.1267"></a><span id="l123.1267" class="difflineplus">+    if (this.showThreaded != aShowThreaded) {</span>
<a href="#l123.1268"></a><span id="l123.1268" class="difflineplus">+      let viewFlags = this._viewFlags;</span>
<a href="#l123.1269"></a><span id="l123.1269" class="difflineplus">+      if (aShowThreaded)</span>
<a href="#l123.1270"></a><span id="l123.1270" class="difflineplus">+        viewFlags |= nsMsgViewFlagsType.kThreadedDisplay;</span>
<a href="#l123.1271"></a><span id="l123.1271" class="difflineplus">+      // maybe we shouldn't do anything in this case?</span>
<a href="#l123.1272"></a><span id="l123.1272" class="difflineplus">+      else</span>
<a href="#l123.1273"></a><span id="l123.1273" class="difflineplus">+        viewFlags &amp;= ~nsMsgViewFlagsType.kThreadedDisplay;</span>
<a href="#l123.1274"></a><span id="l123.1274" class="difflineplus">+      // lose the group bit...</span>
<a href="#l123.1275"></a><span id="l123.1275" class="difflineplus">+      viewFlags &amp;= ~nsMsgViewFlagsType.kGroupBySort;</span>
<a href="#l123.1276"></a><span id="l123.1276" class="difflineplus">+      this._viewFlags = viewFlags;</span>
<a href="#l123.1277"></a><span id="l123.1277">     }</span>
<a href="#l123.1278"></a><span id="l123.1278">   },</span>
<a href="#l123.1279"></a><span id="l123.1279"> </span>
<a href="#l123.1280"></a><span id="l123.1280" class="difflineminus">-  get showThreaded() {</span>
<a href="#l123.1281"></a><span id="l123.1281" class="difflineminus">-    return Boolean(this._viewFlags &amp; nsMsgViewFlagsType.kThreadedDisplay);</span>
<a href="#l123.1282"></a><span id="l123.1282" class="difflineplus">+  /**</span>
<a href="#l123.1283"></a><span id="l123.1283" class="difflineplus">+   * @return true if we are in unthreaded mode (which means not threaded and</span>
<a href="#l123.1284"></a><span id="l123.1284" class="difflineplus">+   *     not grouped by sort).</span>
<a href="#l123.1285"></a><span id="l123.1285" class="difflineplus">+   */</span>
<a href="#l123.1286"></a><span id="l123.1286" class="difflineplus">+  get showUnthreaded() {</span>
<a href="#l123.1287"></a><span id="l123.1287" class="difflineplus">+    return Boolean(!(this._viewFlags &amp; (nsMsgViewFlagsType.kGroupBySort |</span>
<a href="#l123.1288"></a><span id="l123.1288" class="difflineplus">+                                        nsMsgViewFlagsType.kThreadedDisplay)));</span>
<a href="#l123.1289"></a><span id="l123.1289">   },</span>
<a href="#l123.1290"></a><span id="l123.1290" class="difflineminus">-  set showThreaded(aShowThreaded) {</span>
<a href="#l123.1291"></a><span id="l123.1291" class="difflineminus">-    if (this.showThreaded != aShowThreaded) {</span>
<a href="#l123.1292"></a><span id="l123.1292" class="difflineminus">-      if (aShowThreaded)</span>
<a href="#l123.1293"></a><span id="l123.1293" class="difflineminus">-        this._viewFlags |= nsMsgViewFlagsType.kThreadedDisplay;</span>
<a href="#l123.1294"></a><span id="l123.1294" class="difflineplus">+  /**</span>
<a href="#l123.1295"></a><span id="l123.1295" class="difflineplus">+   * Set to true to put us in unthreaded mode (which means not threaded and</span>
<a href="#l123.1296"></a><span id="l123.1296" class="difflineplus">+   *  not grouped by sort).</span>
<a href="#l123.1297"></a><span id="l123.1297" class="difflineplus">+   */</span>
<a href="#l123.1298"></a><span id="l123.1298" class="difflineplus">+  set showUnthreaded(aShowUnthreaded) {</span>
<a href="#l123.1299"></a><span id="l123.1299" class="difflineplus">+    if (this.showUnthreaded != aShowUnthreaded) {</span>
<a href="#l123.1300"></a><span id="l123.1300" class="difflineplus">+      if (aShowUnthreaded)</span>
<a href="#l123.1301"></a><span id="l123.1301" class="difflineplus">+        this._viewFlags &amp;= ~(nsMsgViewFlagsType.kGroupBySort |</span>
<a href="#l123.1302"></a><span id="l123.1302" class="difflineplus">+                             nsMsgViewFlagsType.kThreadedDisplay);</span>
<a href="#l123.1303"></a><span id="l123.1303" class="difflineplus">+      // maybe we shouldn't do anything in this case?</span>
<a href="#l123.1304"></a><span id="l123.1304">       else</span>
<a href="#l123.1305"></a><span id="l123.1305" class="difflineminus">-        this._viewFlags &amp;= ~nsMsgViewFlagsType.kThreadedDisplay;</span>
<a href="#l123.1306"></a><span id="l123.1306" class="difflineminus">-      // lose the group bit...</span>
<a href="#l123.1307"></a><span id="l123.1307" class="difflineminus">-      this._viewFlags &amp;= ~nsMsgViewFlagsType.kGroupBySort;</span>
<a href="#l123.1308"></a><span id="l123.1308" class="difflineminus">-      this._applyViewChanges();</span>
<a href="#l123.1309"></a><span id="l123.1309" class="difflineplus">+        this._viewFlags = (this._viewFlags &amp; ~nsMsgViewFlagsType.kGroupBySort) |</span>
<a href="#l123.1310"></a><span id="l123.1310" class="difflineplus">+                            nsMsgViewFlagsType.kThreadedDisplay;</span>
<a href="#l123.1311"></a><span id="l123.1311">     }</span>
<a href="#l123.1312"></a><span id="l123.1312">   },</span>
<a href="#l123.1313"></a><span id="l123.1313"> </span>
<a href="#l123.1314"></a><span id="l123.1314" class="difflineplus">+  /**</span>
<a href="#l123.1315"></a><span id="l123.1315" class="difflineplus">+   * @return true if we are showing only unread messages.</span>
<a href="#l123.1316"></a><span id="l123.1316" class="difflineplus">+   */</span>
<a href="#l123.1317"></a><span id="l123.1317">   get showUnreadOnly() {</span>
<a href="#l123.1318"></a><span id="l123.1318">     return Boolean(this._viewFlags &amp; nsMsgViewFlagsType.kUnreadOnly);</span>
<a href="#l123.1319"></a><span id="l123.1319">   },</span>
<a href="#l123.1320"></a><span id="l123.1320" class="difflineplus">+  /**</span>
<a href="#l123.1321"></a><span id="l123.1321" class="difflineplus">+   * Enable/disable showing only unread messages using the view's flag-based</span>
<a href="#l123.1322"></a><span id="l123.1322" class="difflineplus">+   *  mechanism.  This functionality can also be approximated using a mail</span>
<a href="#l123.1323"></a><span id="l123.1323" class="difflineplus">+   *  view (or other search) for unread messages.  There also exist special</span>
<a href="#l123.1324"></a><span id="l123.1324" class="difflineplus">+   *  views for showing messages with unread threads which is different and</span>
<a href="#l123.1325"></a><span id="l123.1325" class="difflineplus">+   *  has serious limitations because of its nature.</span>
<a href="#l123.1326"></a><span id="l123.1326" class="difflineplus">+   */</span>
<a href="#l123.1327"></a><span id="l123.1327">   set showUnreadOnly(aShowUnreadOnly) {</span>
<a href="#l123.1328"></a><span id="l123.1328">     if (this.showUnreadOnly != aShowUnreadOnly) {</span>
<a href="#l123.1329"></a><span id="l123.1329">       if (aShowUnreadOnly)</span>
<a href="#l123.1330"></a><span id="l123.1330">         this._viewFlags |= nsMsgViewFlagsType.kUnreadOnly;</span>
<a href="#l123.1331"></a><span id="l123.1331">       else</span>
<a href="#l123.1332"></a><span id="l123.1332">         this._viewFlags &amp;= ~nsMsgViewFlagsType.kUnreadOnly;</span>
<a href="#l123.1333"></a><span id="l123.1333" class="difflineminus">-      this._applyViewChanges();</span>
<a href="#l123.1334"></a><span id="l123.1334">     }</span>
<a href="#l123.1335"></a><span id="l123.1335">   },</span>
<a href="#l123.1336"></a><span id="l123.1336"> </span>
<a href="#l123.1337"></a><span id="l123.1337">   /**</span>
<a href="#l123.1338"></a><span id="l123.1338">    * Read-only attribute indicating if a 'special view' is in use.  There are</span>
<a href="#l123.1339"></a><span id="l123.1339">    *  two special views in existence, both of which are concerned about</span>
<a href="#l123.1340"></a><span id="l123.1340">    *  showing you threads that have any unread messages in them.  They are views</span>
<a href="#l123.1341"></a><span id="l123.1341">    *  rather than search predicates because the search mechanism is not capable</span>
<a href="#l123.1342"></a><span id="l123.1342" class="difflineat">@@ -1143,17 +1759,18 @@ DBViewWrapper.prototype = {</span>
<a href="#l123.1343"></a><span id="l123.1343">    */</span>
<a href="#l123.1344"></a><span id="l123.1344">   setMailView: function DBViewWrapper_setMailView(aMailViewIndex, aData,</span>
<a href="#l123.1345"></a><span id="l123.1345">                                                   aDoNotPersist) {</span>
<a href="#l123.1346"></a><span id="l123.1346">     let mailViewDef = MailViewManager.getMailViewByIndex(aMailViewIndex);</span>
<a href="#l123.1347"></a><span id="l123.1347"> </span>
<a href="#l123.1348"></a><span id="l123.1348">     this._mailViewIndex = aMailViewIndex;</span>
<a href="#l123.1349"></a><span id="l123.1349">     this._mailViewData = aData;</span>
<a href="#l123.1350"></a><span id="l123.1350"> </span>
<a href="#l123.1351"></a><span id="l123.1351" class="difflineminus">-    // - update the search terms (this triggers the view update)</span>
<a href="#l123.1352"></a><span id="l123.1352" class="difflineplus">+    // - update the search terms</span>
<a href="#l123.1353"></a><span id="l123.1353" class="difflineplus">+    // (this triggers a view update if we are not in a batch)</span>
<a href="#l123.1354"></a><span id="l123.1354">     this.search.viewTerms = mailViewDef.makeTerms(this.search.session,</span>
<a href="#l123.1355"></a><span id="l123.1355">                                                   aData);</span>
<a href="#l123.1356"></a><span id="l123.1356"> </span>
<a href="#l123.1357"></a><span id="l123.1357">     // - persist the view to the folder.</span>
<a href="#l123.1358"></a><span id="l123.1358">     if (!aDoNotPersist) {</span>
<a href="#l123.1359"></a><span id="l123.1359">       let msgDatabase = this.displayedFolder.msgDatabase;</span>
<a href="#l123.1360"></a><span id="l123.1360">       if (msgDatabase) {</span>
<a href="#l123.1361"></a><span id="l123.1361">         let dbFolderInfo = msgDatabase.dBFolderInfo;</span>
<a href="#l123.1362"></a><span id="l123.1362" class="difflineat">@@ -1165,20 +1782,31 @@ DBViewWrapper.prototype = {</span>
<a href="#l123.1363"></a><span id="l123.1363">         //  when we persist it.  It's not like the property is really generic</span>
<a href="#l123.1364"></a><span id="l123.1364">         //  anyways.</span>
<a href="#l123.1365"></a><span id="l123.1365">         dbFolderInfo.setCharProperty(</span>
<a href="#l123.1366"></a><span id="l123.1366">           MailViewConstants.kViewCurrentTag,</span>
<a href="#l123.1367"></a><span id="l123.1367">           this._mailViewData ? (&quot;:&quot; + this._mailViewData) : &quot;&quot;);</span>
<a href="#l123.1368"></a><span id="l123.1368">       }</span>
<a href="#l123.1369"></a><span id="l123.1369">     }</span>
<a href="#l123.1370"></a><span id="l123.1370"> </span>
<a href="#l123.1371"></a><span id="l123.1371" class="difflineminus">-    // we don't need to notify the view picker to update because the makeActive that</span>
<a href="#l123.1372"></a><span id="l123.1372" class="difflineminus">-    //  cascades out of the view update will do it for us.</span>
<a href="#l123.1373"></a><span id="l123.1373" class="difflineplus">+    // we don't need to notify the view picker to update because the makeActive</span>
<a href="#l123.1374"></a><span id="l123.1374" class="difflineplus">+    //  that cascades out of the view update will do it for us.</span>
<a href="#l123.1375"></a><span id="l123.1375">   },</span>
<a href="#l123.1376"></a><span id="l123.1376"> </span>
<a href="#l123.1377"></a><span id="l123.1377" class="difflineplus">+  /**</span>
<a href="#l123.1378"></a><span id="l123.1378" class="difflineplus">+   * @return true if the row at the given index contains a collapsed thread,</span>
<a href="#l123.1379"></a><span id="l123.1379" class="difflineplus">+   *     false if the row is a collapsed group or anything else.</span>
<a href="#l123.1380"></a><span id="l123.1380" class="difflineplus">+   */</span>
<a href="#l123.1381"></a><span id="l123.1381" class="difflineplus">+  isCollapsedThreadAtIndex:</span>
<a href="#l123.1382"></a><span id="l123.1382" class="difflineplus">+      function DBViewWrapper_isCollapsedThreadAtIndex(aViewIndex) {</span>
<a href="#l123.1383"></a><span id="l123.1383" class="difflineplus">+    let flags = this.dbView.getFlagsAt(aViewIndex);</span>
<a href="#l123.1384"></a><span id="l123.1384" class="difflineplus">+    return (flags &amp; nsMsgMessageFlags.Elided) &amp;&amp;</span>
<a href="#l123.1385"></a><span id="l123.1385" class="difflineplus">+           !(flags &amp; MSG_VIEW_FLAG_DUMMY) &amp;&amp;</span>
<a href="#l123.1386"></a><span id="l123.1386" class="difflineplus">+           this.dbView.isContainer(aViewIndex);</span>
<a href="#l123.1387"></a><span id="l123.1387" class="difflineplus">+  },</span>
<a href="#l123.1388"></a><span id="l123.1388"> </span>
<a href="#l123.1389"></a><span id="l123.1389">   /**</span>
<a href="#l123.1390"></a><span id="l123.1390">    * Perform application-level behaviors related to leaving a folder that have</span>
<a href="#l123.1391"></a><span id="l123.1391">    *  nothing to do with our abstraction.</span>
<a href="#l123.1392"></a><span id="l123.1392">    *</span>
<a href="#l123.1393"></a><span id="l123.1393">    * Things we do on leaving a folder:</span>
<a href="#l123.1394"></a><span id="l123.1394">    * - Mark the folder's messages as no longer new</span>
<a href="#l123.1395"></a><span id="l123.1395">    * - Mark all messages read in the folder _if so configured_.</span>
<a href="#l123.1396"></a><span id="l123.1396" class="difflineat">@@ -1197,9 +1825,39 @@ DBViewWrapper.prototype = {</span>
<a href="#l123.1397"></a><span id="l123.1397">       // goDoCommand('cmd_markAllRead').</span>
<a href="#l123.1398"></a><span id="l123.1398">       if (this.dbView &amp;&amp;</span>
<a href="#l123.1399"></a><span id="l123.1399">           this.listener.shouldDeferMessageDisplayUntilAfterServerConnect(</span>
<a href="#l123.1400"></a><span id="l123.1400">             this.displayedFolder.server.type))</span>
<a href="#l123.1401"></a><span id="l123.1401">         this.dbView.doCommand(nsMsgViewCommandType.markAllRead);</span>
<a href="#l123.1402"></a><span id="l123.1402">     }</span>
<a href="#l123.1403"></a><span id="l123.1403">     catch(e){/* ignore */}</span>
<a href="#l123.1404"></a><span id="l123.1404">   },</span>
<a href="#l123.1405"></a><span id="l123.1405" class="difflineplus">+</span>
<a href="#l123.1406"></a><span id="l123.1406" class="difflineplus">+  /**</span>
<a href="#l123.1407"></a><span id="l123.1407" class="difflineplus">+   * Convenience function to retrieve the first nsIMsgDBHdr in any of the</span>
<a href="#l123.1408"></a><span id="l123.1408" class="difflineplus">+   *  folders backing this view with the given message-id header.  This</span>
<a href="#l123.1409"></a><span id="l123.1409" class="difflineplus">+   *  is for the benefit of FolderDisplayWidget's selection logic.</span>
<a href="#l123.1410"></a><span id="l123.1410" class="difflineplus">+   * When thinking about using this, please keep in mind that, currently, this</span>
<a href="#l123.1411"></a><span id="l123.1411" class="difflineplus">+   *  is O(n) for the total number of messages across all the backing folders.</span>
<a href="#l123.1412"></a><span id="l123.1412" class="difflineplus">+   *  Since the folder database should already be in memory, this should</span>
<a href="#l123.1413"></a><span id="l123.1413" class="difflineplus">+   *  ideally not involve any disk I/O.</span>
<a href="#l123.1414"></a><span id="l123.1414" class="difflineplus">+   * Additionally, duplicate message-ids can and will happen, but since we</span>
<a href="#l123.1415"></a><span id="l123.1415" class="difflineplus">+   *  are using the message database's getMsgHdrForMessageID method to be fast,</span>
<a href="#l123.1416"></a><span id="l123.1416" class="difflineplus">+   *  our semantics are limited to telling you about only the first one we find.</span>
<a href="#l123.1417"></a><span id="l123.1417" class="difflineplus">+   *</span>
<a href="#l123.1418"></a><span id="l123.1418" class="difflineplus">+   * @param aMessageId The message-id of the message you want.</span>
<a href="#l123.1419"></a><span id="l123.1419" class="difflineplus">+   * @return The first nsIMsgDBHdr found in any of the underlying folders with</span>
<a href="#l123.1420"></a><span id="l123.1420" class="difflineplus">+   *     the given message header, null if none are found.  The fact that we</span>
<a href="#l123.1421"></a><span id="l123.1421" class="difflineplus">+   *     return something does not guarantee that it is actually visible in the</span>
<a href="#l123.1422"></a><span id="l123.1422" class="difflineplus">+   *     view.  (The search may be filtering it out.)</span>
<a href="#l123.1423"></a><span id="l123.1423" class="difflineplus">+   */</span>
<a href="#l123.1424"></a><span id="l123.1424" class="difflineplus">+  getMsgHdrForMessageID: function DBViewWrapper_getMsgHdrForMessageID(</span>
<a href="#l123.1425"></a><span id="l123.1425" class="difflineplus">+      aMessageId) {</span>
<a href="#l123.1426"></a><span id="l123.1426" class="difflineplus">+    if (!this._underlyingFolders)</span>
<a href="#l123.1427"></a><span id="l123.1427" class="difflineplus">+      return null;</span>
<a href="#l123.1428"></a><span id="l123.1428" class="difflineplus">+    for (let [, folder] in Iterator(this._underlyingFolders)) {</span>
<a href="#l123.1429"></a><span id="l123.1429" class="difflineplus">+      let msgHdr = folder.msgDatabase.getMsgHdrForMessageID(aMessageId);</span>
<a href="#l123.1430"></a><span id="l123.1430" class="difflineplus">+      if (msgHdr)</span>
<a href="#l123.1431"></a><span id="l123.1431" class="difflineplus">+        return msgHdr;</span>
<a href="#l123.1432"></a><span id="l123.1432" class="difflineplus">+    }</span>
<a href="#l123.1433"></a><span id="l123.1433" class="difflineplus">+    return null;</span>
<a href="#l123.1434"></a><span id="l123.1434" class="difflineplus">+  },</span>
<a href="#l123.1435"></a><span id="l123.1435"> };</span>
<a href="#l123.1436"></a><span id="l123.1436">\ No newline at end of file</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l124.1"></a><span id="l124.1" class="difflineminus">--- a/mailnews/base/src/nsMessenger.cpp</span>
<a href="#l124.2"></a><span id="l124.2" class="difflineplus">+++ b/mailnews/base/src/nsMessenger.cpp</span>
<a href="#l124.3"></a><span id="l124.3" class="difflineat">@@ -253,23 +253,23 @@ public:</span>
<a href="#l124.4"></a><span id="l124.4">   }             m_outputFormat;</span>
<a href="#l124.5"></a><span id="l124.5">   nsString      m_msgBuffer;</span>
<a href="#l124.6"></a><span id="l124.6"> </span>
<a href="#l124.7"></a><span id="l124.7">   nsCString     m_contentType;    // used only when saving attachment</span>
<a href="#l124.8"></a><span id="l124.8"> </span>
<a href="#l124.9"></a><span id="l124.9">   nsCOMPtr&lt;nsITransfer&gt; mTransfer;</span>
<a href="#l124.10"></a><span id="l124.10">   nsCOMPtr&lt;nsIUrlListener&gt; mListener;</span>
<a href="#l124.11"></a><span id="l124.11">   nsCOMPtr&lt;nsIURI&gt; mListenerUri;</span>
<a href="#l124.12"></a><span id="l124.12" class="difflineminus">-  PRInt32 mProgress;</span>
<a href="#l124.13"></a><span id="l124.13" class="difflineminus">-  PRInt32 mContentLength;</span>
<a href="#l124.14"></a><span id="l124.14" class="difflineplus">+  PRInt64 mProgress;</span>
<a href="#l124.15"></a><span id="l124.15" class="difflineplus">+  PRInt64 mMaxProgress;</span>
<a href="#l124.16"></a><span id="l124.16">   PRBool  mCanceled;</span>
<a href="#l124.17"></a><span id="l124.17">   PRBool  mInitialized;</span>
<a href="#l124.18"></a><span id="l124.18">   PRBool  mUrlHasStopped;</span>
<a href="#l124.19"></a><span id="l124.19">   PRBool  mRequestHasStopped;</span>
<a href="#l124.20"></a><span id="l124.20" class="difflineminus">-  nsresult InitializeDownload(nsIRequest * aRequest, PRInt32 aBytesDownloaded);</span>
<a href="#l124.21"></a><span id="l124.21" class="difflineplus">+  nsresult InitializeDownload(nsIRequest * aRequest, PRUint32 aBytesDownloaded);</span>
<a href="#l124.22"></a><span id="l124.22"> };</span>
<a href="#l124.23"></a><span id="l124.23"> </span>
<a href="#l124.24"></a><span id="l124.24"> class nsSaveAllAttachmentsState</span>
<a href="#l124.25"></a><span id="l124.25"> {</span>
<a href="#l124.26"></a><span id="l124.26"> public:</span>
<a href="#l124.27"></a><span id="l124.27">   nsSaveAllAttachmentsState(PRUint32 count,</span>
<a href="#l124.28"></a><span id="l124.28">                             const char **contentTypeArray,</span>
<a href="#l124.29"></a><span id="l124.29">                             const char **urlArray,</span>
<a href="#l124.30"></a><span id="l124.30" class="difflineat">@@ -1432,17 +1432,17 @@ nsSaveMsgListener::nsSaveMsgListener(nsI</span>
<a href="#l124.31"></a><span id="l124.31">   mListener = aListener;</span>
<a href="#l124.32"></a><span id="l124.32">   mUrlHasStopped = PR_FALSE;</span>
<a href="#l124.33"></a><span id="l124.33">   mRequestHasStopped = PR_FALSE;</span>
<a href="#l124.34"></a><span id="l124.34">   </span>
<a href="#l124.35"></a><span id="l124.35">     // rhp: for charset handling</span>
<a href="#l124.36"></a><span id="l124.36">   m_doCharsetConversion = PR_FALSE;</span>
<a href="#l124.37"></a><span id="l124.37">   m_saveAllAttachmentsState = nsnull;</span>
<a href="#l124.38"></a><span id="l124.38">   mProgress = 0;</span>
<a href="#l124.39"></a><span id="l124.39" class="difflineminus">-  mContentLength = -1;</span>
<a href="#l124.40"></a><span id="l124.40" class="difflineplus">+  mMaxProgress = -1;</span>
<a href="#l124.41"></a><span id="l124.41">   mCanceled = PR_FALSE;</span>
<a href="#l124.42"></a><span id="l124.42">   m_outputFormat = eUnknown;</span>
<a href="#l124.43"></a><span id="l124.43">   mInitialized = PR_FALSE;</span>
<a href="#l124.44"></a><span id="l124.44">   m_dataBuffer = new char[FOUR_K];</span>
<a href="#l124.45"></a><span id="l124.45"> }</span>
<a href="#l124.46"></a><span id="l124.46"> </span>
<a href="#l124.47"></a><span id="l124.47"> nsSaveMsgListener::~nsSaveMsgListener()</span>
<a href="#l124.48"></a><span id="l124.48"> {</span>
<a href="#l124.49"></a><span id="l124.49" class="difflineat">@@ -1559,44 +1559,51 @@ nsSaveMsgListener::OnStopCopy(nsresult a</span>
<a href="#l124.50"></a><span id="l124.50">   if (m_file)</span>
<a href="#l124.51"></a><span id="l124.51">     m_file-&gt;Remove(PR_FALSE);</span>
<a href="#l124.52"></a><span id="l124.52">   Release(); // all done kill ourself</span>
<a href="#l124.53"></a><span id="l124.53">   return aStatus;</span>
<a href="#l124.54"></a><span id="l124.54"> }</span>
<a href="#l124.55"></a><span id="l124.55"> </span>
<a href="#l124.56"></a><span id="l124.56"> // initializes the progress window if we are going to show one</span>
<a href="#l124.57"></a><span id="l124.57"> // and for OSX, sets creator flags on the output file</span>
<a href="#l124.58"></a><span id="l124.58" class="difflineminus">-nsresult nsSaveMsgListener::InitializeDownload(nsIRequest * aRequest, PRInt32 aBytesDownloaded)</span>
<a href="#l124.59"></a><span id="l124.59" class="difflineplus">+nsresult nsSaveMsgListener::InitializeDownload(nsIRequest * aRequest, PRUint32 aBytesDownloaded)</span>
<a href="#l124.60"></a><span id="l124.60"> {</span>
<a href="#l124.61"></a><span id="l124.61">   nsresult rv = NS_OK;</span>
<a href="#l124.62"></a><span id="l124.62">   </span>
<a href="#l124.63"></a><span id="l124.63">   mInitialized = PR_TRUE;</span>
<a href="#l124.64"></a><span id="l124.64">   nsCOMPtr&lt;nsIChannel&gt; channel (do_QueryInterface(aRequest));</span>
<a href="#l124.65"></a><span id="l124.65">   </span>
<a href="#l124.66"></a><span id="l124.66">   if (!channel)</span>
<a href="#l124.67"></a><span id="l124.67">     return rv;</span>
<a href="#l124.68"></a><span id="l124.68">   </span>
<a href="#l124.69"></a><span id="l124.69" class="difflineminus">-  // Set content length if we haven't already got it.</span>
<a href="#l124.70"></a><span id="l124.70" class="difflineminus">-  if (mContentLength == -1)</span>
<a href="#l124.71"></a><span id="l124.71" class="difflineminus">-    channel-&gt;GetContentLength(&amp;mContentLength);</span>
<a href="#l124.72"></a><span id="l124.72" class="difflineplus">+  // Get the max progress from the URL if we haven't already got it.</span>
<a href="#l124.73"></a><span id="l124.73" class="difflineplus">+  if (mMaxProgress == -1)</span>
<a href="#l124.74"></a><span id="l124.74" class="difflineplus">+  {</span>
<a href="#l124.75"></a><span id="l124.75" class="difflineplus">+    nsCOMPtr&lt;nsIURI&gt; uri;</span>
<a href="#l124.76"></a><span id="l124.76" class="difflineplus">+    channel-&gt;GetURI(getter_AddRefs(uri));</span>
<a href="#l124.77"></a><span id="l124.77" class="difflineplus">+    nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsUrl(do_QueryInterface(uri));</span>
<a href="#l124.78"></a><span id="l124.78" class="difflineplus">+    if (mailnewsUrl)</span>
<a href="#l124.79"></a><span id="l124.79" class="difflineplus">+      mailnewsUrl-&gt;GetMaxProgress(&amp;mMaxProgress);</span>
<a href="#l124.80"></a><span id="l124.80" class="difflineplus">+  }</span>
<a href="#l124.81"></a><span id="l124.81">   </span>
<a href="#l124.82"></a><span id="l124.82">   if (!m_contentType.IsEmpty())</span>
<a href="#l124.83"></a><span id="l124.83">   {</span>
<a href="#l124.84"></a><span id="l124.84">     nsCOMPtr&lt;nsIMIMEService&gt; mimeService (do_GetService(NS_MIMESERVICE_CONTRACTID));</span>
<a href="#l124.85"></a><span id="l124.85">     nsCOMPtr&lt;nsIMIMEInfo&gt; mimeinfo;</span>
<a href="#l124.86"></a><span id="l124.86">     </span>
<a href="#l124.87"></a><span id="l124.87">     mimeService-&gt;GetFromTypeAndExtension(m_contentType, EmptyCString(), getter_AddRefs(mimeinfo));</span>
<a href="#l124.88"></a><span id="l124.88">     </span>
<a href="#l124.89"></a><span id="l124.89">     nsCOMPtr&lt;nsILocalFile&gt; outputFile = do_QueryInterface(m_file);</span>
<a href="#l124.90"></a><span id="l124.90">     </span>
<a href="#l124.91"></a><span id="l124.91" class="difflineminus">-      // create a download progress window</span>
<a href="#l124.92"></a><span id="l124.92" class="difflineminus">-      // XXX: we don't want to show the progress dialog if the download is really small.</span>
<a href="#l124.93"></a><span id="l124.93" class="difflineminus">-      // but what is a small download? Well that's kind of arbitrary</span>
<a href="#l124.94"></a><span id="l124.94" class="difflineminus">-      // so make an arbitrary decision based on the content length of the attachment</span>
<a href="#l124.95"></a><span id="l124.95" class="difflineminus">-    if (mContentLength != -1 &amp;&amp; mContentLength &gt; aBytesDownloaded * 2)</span>
<a href="#l124.96"></a><span id="l124.96" class="difflineplus">+    // create a download progress window</span>
<a href="#l124.97"></a><span id="l124.97" class="difflineplus">+    // We don't want to show the progress dialog if the download is really small.</span>
<a href="#l124.98"></a><span id="l124.98" class="difflineplus">+    // but what is a small download? Well that's kind of arbitrary</span>
<a href="#l124.99"></a><span id="l124.99" class="difflineplus">+    // so make an arbitrary decision based on the content length of the</span>
<a href="#l124.100"></a><span id="l124.100" class="difflineplus">+    // attachment -- show it if less than half of the download has completed</span>
<a href="#l124.101"></a><span id="l124.101" class="difflineplus">+    if (mMaxProgress != -1 &amp;&amp; mMaxProgress &gt; aBytesDownloaded * 2)</span>
<a href="#l124.102"></a><span id="l124.102">     {</span>
<a href="#l124.103"></a><span id="l124.103">       nsCOMPtr&lt;nsITransfer&gt; tr = do_CreateInstance(NS_TRANSFER_CONTRACTID, &amp;rv);</span>
<a href="#l124.104"></a><span id="l124.104">       if (tr &amp;&amp; outputFile)</span>
<a href="#l124.105"></a><span id="l124.105">       {</span>
<a href="#l124.106"></a><span id="l124.106">         PRTime timeDownloadStarted = PR_Now();</span>
<a href="#l124.107"></a><span id="l124.107">         </span>
<a href="#l124.108"></a><span id="l124.108">         nsCOMPtr&lt;nsIURI&gt; outputURI;</span>
<a href="#l124.109"></a><span id="l124.109">         NS_NewFileURI(getter_AddRefs(outputURI), outputFile);</span>
<a href="#l124.110"></a><span id="l124.110" class="difflineat">@@ -1753,17 +1760,17 @@ nsSaveMsgListener::OnStopRequest(nsIRequ</span>
<a href="#l124.111"></a><span id="l124.111">       </span>
<a href="#l124.112"></a><span id="l124.112">       delete m_saveAllAttachmentsState;</span>
<a href="#l124.113"></a><span id="l124.113">       m_saveAllAttachmentsState = nsnull;</span>
<a href="#l124.114"></a><span id="l124.114">     }</span>
<a href="#l124.115"></a><span id="l124.115">   }</span>
<a href="#l124.116"></a><span id="l124.116"> </span>
<a href="#l124.117"></a><span id="l124.117">   if(mTransfer)</span>
<a href="#l124.118"></a><span id="l124.118">   {</span>
<a href="#l124.119"></a><span id="l124.119" class="difflineminus">-    mTransfer-&gt;OnProgressChange(nsnull, nsnull, mContentLength, mContentLength, mContentLength, mContentLength);</span>
<a href="#l124.120"></a><span id="l124.120" class="difflineplus">+    mTransfer-&gt;OnProgressChange64(nsnull, nsnull, mMaxProgress, mMaxProgress, mMaxProgress, mMaxProgress);</span>
<a href="#l124.121"></a><span id="l124.121">     mTransfer-&gt;OnStateChange(nsnull, nsnull, nsIWebProgressListener::STATE_STOP |</span>
<a href="#l124.122"></a><span id="l124.122">       nsIWebProgressListener::STATE_IS_NETWORK, NS_OK);</span>
<a href="#l124.123"></a><span id="l124.123">     mTransfer = nsnull; // break any circular dependencies between the progress dialog and use</span>
<a href="#l124.124"></a><span id="l124.124">   }</span>
<a href="#l124.125"></a><span id="l124.125">   </span>
<a href="#l124.126"></a><span id="l124.126">   if (mUrlHasStopped &amp;&amp; mListener)</span>
<a href="#l124.127"></a><span id="l124.127">     mListener-&gt;OnStopRunningUrl(mListenerUri, rv);</span>
<a href="#l124.128"></a><span id="l124.128"> </span>
<a href="#l124.129"></a><span id="l124.129" class="difflineat">@@ -1811,17 +1818,17 @@ nsSaveMsgListener::OnDataAvailable(nsIRe</span>
<a href="#l124.130"></a><span id="l124.130">         else</span>
<a href="#l124.131"></a><span id="l124.131">           rv = m_outputStream-&gt;Write(m_dataBuffer, readCount, &amp;writeCount);</span>
<a href="#l124.132"></a><span id="l124.132"> </span>
<a href="#l124.133"></a><span id="l124.133">         available -= readCount;</span>
<a href="#l124.134"></a><span id="l124.134">       }</span>
<a href="#l124.135"></a><span id="l124.135">     }</span>
<a href="#l124.136"></a><span id="l124.136"> </span>
<a href="#l124.137"></a><span id="l124.137">     if (NS_SUCCEEDED(rv) &amp;&amp; mTransfer) // Send progress notification.</span>
<a href="#l124.138"></a><span id="l124.138" class="difflineminus">-      mTransfer-&gt;OnProgressChange(nsnull, request, mProgress, mContentLength, mProgress, mContentLength);</span>
<a href="#l124.139"></a><span id="l124.139" class="difflineplus">+      mTransfer-&gt;OnProgressChange64(nsnull, request, mProgress, mMaxProgress, mProgress, mMaxProgress);</span>
<a href="#l124.140"></a><span id="l124.140">   }</span>
<a href="#l124.141"></a><span id="l124.141">   return rv;</span>
<a href="#l124.142"></a><span id="l124.142"> }</span>
<a href="#l124.143"></a><span id="l124.143"> </span>
<a href="#l124.144"></a><span id="l124.144"> #define MESSENGER_STRING_URL       &quot;chrome://messenger/locale/messenger.properties&quot;</span>
<a href="#l124.145"></a><span id="l124.145"> </span>
<a href="#l124.146"></a><span id="l124.146"> nsresult</span>
<a href="#l124.147"></a><span id="l124.147"> nsMessenger::InitStringBundle()</span>
<a href="#l124.148"></a><span id="l124.148" class="difflineat">@@ -2416,35 +2423,35 @@ nsDelAttachListener::OnStopRequest(nsIRe</span>
<a href="#l124.149"></a><span id="l124.149">   mMessageFolder-&gt;CopyDataDone();</span>
<a href="#l124.150"></a><span id="l124.150">   if (NS_FAILED(aStatusCode))</span>
<a href="#l124.151"></a><span id="l124.151">     return aStatusCode;</span>
<a href="#l124.152"></a><span id="l124.152"> </span>
<a href="#l124.153"></a><span id="l124.153">   // called when we complete processing of the StreamMessage request.</span>
<a href="#l124.154"></a><span id="l124.154">   // This is called before OnStopRunningUrl().</span>
<a href="#l124.155"></a><span id="l124.155">   nsresult rv;</span>
<a href="#l124.156"></a><span id="l124.156"> </span>
<a href="#l124.157"></a><span id="l124.157" class="difflineminus">-  // copy the file back into the folder. Note: if we set msgToReplace then</span>
<a href="#l124.158"></a><span id="l124.158" class="difflineminus">-  // CopyFileMessage() fails, do the delete ourselves</span>
<a href="#l124.159"></a><span id="l124.159" class="difflineplus">+  // copy the file back into the folder. Note: setting msgToReplace only copies</span>
<a href="#l124.160"></a><span id="l124.160" class="difflineplus">+  // metadata, so we do the delete ourselves</span>
<a href="#l124.161"></a><span id="l124.161">   nsCOMPtr&lt;nsIMsgCopyServiceListener&gt; listenerCopyService;</span>
<a href="#l124.162"></a><span id="l124.162">   rv = this-&gt;QueryInterface( NS_GET_IID(nsIMsgCopyServiceListener), getter_AddRefs(listenerCopyService) );</span>
<a href="#l124.163"></a><span id="l124.163">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l124.164"></a><span id="l124.164"> </span>
<a href="#l124.165"></a><span id="l124.165">   mMsgFileStream-&gt;Close();</span>
<a href="#l124.166"></a><span id="l124.166">   mMsgFileStream = nsnull;</span>
<a href="#l124.167"></a><span id="l124.167">   mNewMessageKey = PR_UINT32_MAX;</span>
<a href="#l124.168"></a><span id="l124.168">   nsCOMPtr&lt;nsIMsgCopyService&gt; copyService = do_GetService(NS_MSGCOPYSERVICE_CONTRACTID);</span>
<a href="#l124.169"></a><span id="l124.169">   m_state = eCopyingNewMsg;</span>
<a href="#l124.170"></a><span id="l124.170">   // clone file because nsIFile on Windows caches the wrong file size.</span>
<a href="#l124.171"></a><span id="l124.171">   nsCOMPtr &lt;nsIFile&gt; clone;</span>
<a href="#l124.172"></a><span id="l124.172">   mMsgFile-&gt;Clone(getter_AddRefs(clone));</span>
<a href="#l124.173"></a><span id="l124.173">   if (copyService)</span>
<a href="#l124.174"></a><span id="l124.174">   {</span>
<a href="#l124.175"></a><span id="l124.175">     nsCString originalKeys;</span>
<a href="#l124.176"></a><span id="l124.176">     mOriginalMessage-&gt;GetStringProperty(&quot;keywords&quot;, getter_Copies(originalKeys));</span>
<a href="#l124.177"></a><span id="l124.177" class="difflineminus">-    rv = copyService-&gt;CopyFileMessage(clone, mMessageFolder, nsnull, PR_FALSE,</span>
<a href="#l124.178"></a><span id="l124.178" class="difflineplus">+    rv = copyService-&gt;CopyFileMessage(clone, mMessageFolder, mOriginalMessage, PR_FALSE,</span>
<a href="#l124.179"></a><span id="l124.179">                                       mOrigMsgFlags, originalKeys, listenerCopyService, mMsgWindow);</span>
<a href="#l124.180"></a><span id="l124.180">   }</span>
<a href="#l124.181"></a><span id="l124.181">   return rv;</span>
<a href="#l124.182"></a><span id="l124.182"> }</span>
<a href="#l124.183"></a><span id="l124.183"> </span>
<a href="#l124.184"></a><span id="l124.184"> //</span>
<a href="#l124.185"></a><span id="l124.185"> // nsIStreamListener</span>
<a href="#l124.186"></a><span id="l124.186"> //</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l125.1"></a><span id="l125.1" class="difflineminus">--- a/mailnews/base/src/nsMsgCopyService.cpp</span>
<a href="#l125.2"></a><span id="l125.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgCopyService.cpp</span>
<a href="#l125.3"></a><span id="l125.3" class="difflineat">@@ -600,17 +600,20 @@ nsMsgCopyService::CopyFileMessage(nsIFil</span>
<a href="#l125.4"></a><span id="l125.4">   if (NS_FAILED(rv)) goto done;</span>
<a href="#l125.5"></a><span id="l125.5"> </span>
<a href="#l125.6"></a><span id="l125.6">   rv = copyRequest-&gt;Init(nsCopyFileMessageType, fileSupport, dstFolder,</span>
<a href="#l125.7"></a><span id="l125.7">                          isDraft, aMsgFlags, aNewMsgKeywords, listener, window, PR_FALSE);</span>
<a href="#l125.8"></a><span id="l125.8">   if (NS_FAILED(rv)) goto done;</span>
<a href="#l125.9"></a><span id="l125.9"> </span>
<a href="#l125.10"></a><span id="l125.10">   if (msgToReplace)</span>
<a href="#l125.11"></a><span id="l125.11">   {</span>
<a href="#l125.12"></a><span id="l125.12" class="difflineminus">-    copySource = copyRequest-&gt;AddNewCopySource(dstFolder);</span>
<a href="#l125.13"></a><span id="l125.13" class="difflineplus">+    // The actual source of the message is a file not a folder, but</span>
<a href="#l125.14"></a><span id="l125.14" class="difflineplus">+    // we still need an nsCopySource to reference the old message header</span>
<a href="#l125.15"></a><span id="l125.15" class="difflineplus">+    // which will be used to recover message metadata.</span>
<a href="#l125.16"></a><span id="l125.16" class="difflineplus">+    copySource = copyRequest-&gt;AddNewCopySource(nsnull);</span>
<a href="#l125.17"></a><span id="l125.17">     if (!copySource)</span>
<a href="#l125.18"></a><span id="l125.18">     {</span>
<a href="#l125.19"></a><span id="l125.19">         rv = NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l125.20"></a><span id="l125.20">         goto done;</span>
<a href="#l125.21"></a><span id="l125.21">     }</span>
<a href="#l125.22"></a><span id="l125.22">     copySource-&gt;AddMessage(msgToReplace);</span>
<a href="#l125.23"></a><span id="l125.23">   }</span>
<a href="#l125.24"></a><span id="l125.24"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l126.1"></a><span id="l126.1" class="difflineminus">--- a/mailnews/base/src/nsMsgDBView.cpp</span>
<a href="#l126.2"></a><span id="l126.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgDBView.cpp</span>
<a href="#l126.3"></a><span id="l126.3" class="difflineat">@@ -2177,16 +2177,31 @@ NS_IMETHODIMP nsMsgDBView::GetIndicesFor</span>
<a href="#l126.4"></a><span id="l126.4"> </span>
<a href="#l126.5"></a><span id="l126.5">   PRUint32 datalen = numIndices * sizeof(nsMsgViewIndex);</span>
<a href="#l126.6"></a><span id="l126.6">   *indices = (nsMsgViewIndex *)NS_Alloc(datalen);</span>
<a href="#l126.7"></a><span id="l126.7">   if (!*indices) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l126.8"></a><span id="l126.8">   memcpy(*indices, selection.Elements(), datalen);</span>
<a href="#l126.9"></a><span id="l126.9">   return NS_OK;</span>
<a href="#l126.10"></a><span id="l126.10"> }</span>
<a href="#l126.11"></a><span id="l126.11"> </span>
<a href="#l126.12"></a><span id="l126.12" class="difflineplus">+NS_IMETHODIMP nsMsgDBView::GetMsgHdrsForSelection(nsIMutableArray **aResult)</span>
<a href="#l126.13"></a><span id="l126.13" class="difflineplus">+{</span>
<a href="#l126.14"></a><span id="l126.14" class="difflineplus">+  nsMsgViewIndexArray selection;</span>
<a href="#l126.15"></a><span id="l126.15" class="difflineplus">+  GetSelectedIndices(selection);</span>
<a href="#l126.16"></a><span id="l126.16" class="difflineplus">+  PRUint32 numIndices = selection.Length();</span>
<a href="#l126.17"></a><span id="l126.17" class="difflineplus">+</span>
<a href="#l126.18"></a><span id="l126.18" class="difflineplus">+  nsresult rv;</span>
<a href="#l126.19"></a><span id="l126.19" class="difflineplus">+  nsCOMPtr&lt;nsIMutableArray&gt; messages(do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l126.20"></a><span id="l126.20" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l126.21"></a><span id="l126.21" class="difflineplus">+  rv = GetHeadersFromSelection(selection.Elements(), numIndices, messages);</span>
<a href="#l126.22"></a><span id="l126.22" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l126.23"></a><span id="l126.23" class="difflineplus">+  messages.forget(aResult);</span>
<a href="#l126.24"></a><span id="l126.24" class="difflineplus">+  return rv;</span>
<a href="#l126.25"></a><span id="l126.25" class="difflineplus">+}</span>
<a href="#l126.26"></a><span id="l126.26" class="difflineplus">+</span>
<a href="#l126.27"></a><span id="l126.27"> NS_IMETHODIMP nsMsgDBView::GetURIsForSelection(PRUint32 *length, char ***uris)</span>
<a href="#l126.28"></a><span id="l126.28"> {</span>
<a href="#l126.29"></a><span id="l126.29">   nsresult rv = NS_OK;</span>
<a href="#l126.30"></a><span id="l126.30"> </span>
<a href="#l126.31"></a><span id="l126.31">   NS_ENSURE_ARG_POINTER(length);</span>
<a href="#l126.32"></a><span id="l126.32">   *length = 0;</span>
<a href="#l126.33"></a><span id="l126.33">   </span>
<a href="#l126.34"></a><span id="l126.34">   NS_ENSURE_ARG_POINTER(uris);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l127.1"></a><span id="l127.1" class="difflineminus">--- a/mailnews/base/src/nsMsgMailSession.cpp</span>
<a href="#l127.2"></a><span id="l127.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgMailSession.cpp</span>
<a href="#l127.3"></a><span id="l127.3" class="difflineat">@@ -522,17 +522,18 @@ nsMsgMailSession::GetDataFilesDir(const </span>
<a href="#l127.4"></a><span id="l127.4">   return rv;</span>
<a href="#l127.5"></a><span id="l127.5"> }</span>
<a href="#l127.6"></a><span id="l127.6"> </span>
<a href="#l127.7"></a><span id="l127.7"> /********************************************************************************/</span>
<a href="#l127.8"></a><span id="l127.8"> </span>
<a href="#l127.9"></a><span id="l127.9"> NS_IMPL_ISUPPORTS3(nsMsgShutdownService, nsIMsgShutdownService, nsIUrlListener, nsIObserver)</span>
<a href="#l127.10"></a><span id="l127.10"> </span>
<a href="#l127.11"></a><span id="l127.11"> nsMsgShutdownService::nsMsgShutdownService()</span>
<a href="#l127.12"></a><span id="l127.12" class="difflineminus">-: mProcessedShutdown(PR_FALSE),</span>
<a href="#l127.13"></a><span id="l127.13" class="difflineplus">+: mQuitMode(nsIAppStartup::eAttemptQuit),</span>
<a href="#l127.14"></a><span id="l127.14" class="difflineplus">+  mProcessedShutdown(PR_FALSE),</span>
<a href="#l127.15"></a><span id="l127.15">   mQuitForced(PR_FALSE),</span>
<a href="#l127.16"></a><span id="l127.16">   mReadyToQuit(PR_FALSE)</span>
<a href="#l127.17"></a><span id="l127.17"> {</span>
<a href="#l127.18"></a><span id="l127.18">   nsCOMPtr&lt;nsIObserverService&gt; observerService = do_GetService(&quot;@mozilla.org/observer-service;1&quot;);</span>
<a href="#l127.19"></a><span id="l127.19">   if (observerService)</span>
<a href="#l127.20"></a><span id="l127.20">   {</span>
<a href="#l127.21"></a><span id="l127.21">     observerService-&gt;AddObserver(this, &quot;quit-application-requested&quot;, PR_FALSE);</span>
<a href="#l127.22"></a><span id="l127.22">     observerService-&gt;AddObserver(this, &quot;quit-application-granted&quot;, PR_FALSE);</span>
<a href="#l127.23"></a><span id="l127.23" class="difflineat">@@ -600,17 +601,17 @@ void nsMsgShutdownService::AttemptShutdo</span>
<a href="#l127.24"></a><span id="l127.24">     PR_CNotifyAll(this);</span>
<a href="#l127.25"></a><span id="l127.25">     PR_CExitMonitor(this);</span>
<a href="#l127.26"></a><span id="l127.26">   }</span>
<a href="#l127.27"></a><span id="l127.27">   else</span>
<a href="#l127.28"></a><span id="l127.28">   {</span>
<a href="#l127.29"></a><span id="l127.29">     nsCOMPtr&lt;nsIAppStartup&gt; appStartup =</span>
<a href="#l127.30"></a><span id="l127.30">       do_GetService(NS_APPSTARTUP_CONTRACTID);</span>
<a href="#l127.31"></a><span id="l127.31">     NS_ENSURE_TRUE(appStartup, );</span>
<a href="#l127.32"></a><span id="l127.32" class="difflineminus">-    NS_ENSURE_SUCCESS(appStartup-&gt;Quit(nsIAppStartup::eAttemptQuit), );</span>
<a href="#l127.33"></a><span id="l127.33" class="difflineplus">+    NS_ENSURE_SUCCESS(appStartup-&gt;Quit(mQuitMode), );</span>
<a href="#l127.34"></a><span id="l127.34">   }</span>
<a href="#l127.35"></a><span id="l127.35"> }</span>
<a href="#l127.36"></a><span id="l127.36"> </span>
<a href="#l127.37"></a><span id="l127.37"> NS_IMETHODIMP nsMsgShutdownService::SetShutdownListener(nsIWebProgressListener *inListener)</span>
<a href="#l127.38"></a><span id="l127.38"> {</span>
<a href="#l127.39"></a><span id="l127.39">   NS_ENSURE_TRUE(mMsgProgress, NS_ERROR_FAILURE);</span>
<a href="#l127.40"></a><span id="l127.40">   mMsgProgress-&gt;RegisterListener(inListener);</span>
<a href="#l127.41"></a><span id="l127.41">   return NS_OK;</span>
<a href="#l127.42"></a><span id="l127.42" class="difflineat">@@ -702,16 +703,22 @@ NS_IMETHODIMP nsMsgShutdownService::Obse</span>
<a href="#l127.43"></a><span id="l127.43">         NS_ENSURE_TRUE(internalDomWin, NS_ERROR_FAILURE);  // bail if we don't get a window.</span>
<a href="#l127.44"></a><span id="l127.44">       }</span>
<a href="#l127.45"></a><span id="l127.45">     }</span>
<a href="#l127.46"></a><span id="l127.46"> </span>
<a href="#l127.47"></a><span id="l127.47">     if (!mQuitForced)</span>
<a href="#l127.48"></a><span id="l127.48">     {</span>
<a href="#l127.49"></a><span id="l127.49">       nsCOMPtr&lt;nsISupportsPRBool&gt; stopShutdown = do_QueryInterface(aSubject);</span>
<a href="#l127.50"></a><span id="l127.50">       stopShutdown-&gt;SetData(PR_TRUE);</span>
<a href="#l127.51"></a><span id="l127.51" class="difflineplus">+</span>
<a href="#l127.52"></a><span id="l127.52" class="difflineplus">+      // If the attempted quit was a restart, be sure to restart the app once</span>
<a href="#l127.53"></a><span id="l127.53" class="difflineplus">+      // the tasks have been run. This is usually the case when addons or</span>
<a href="#l127.54"></a><span id="l127.54" class="difflineplus">+      // updates are going to be installed.</span>
<a href="#l127.55"></a><span id="l127.55" class="difflineplus">+      if (nsDependentString(aData).EqualsLiteral(&quot;restart&quot;))</span>
<a href="#l127.56"></a><span id="l127.56" class="difflineplus">+        mQuitMode |= nsIAppStartup::eRestart;</span>
<a href="#l127.57"></a><span id="l127.57">     }</span>
<a href="#l127.58"></a><span id="l127.58"> </span>
<a href="#l127.59"></a><span id="l127.59">     mMsgProgress-&gt;OpenProgressDialog(internalDomWin, topMsgWindow, </span>
<a href="#l127.60"></a><span id="l127.60">                                      &quot;chrome://messenger/content/shutdownWindow.xul&quot;, </span>
<a href="#l127.61"></a><span id="l127.61">                                      PR_FALSE, nsnull);</span>
<a href="#l127.62"></a><span id="l127.62"> </span>
<a href="#l127.63"></a><span id="l127.63">     if (mQuitForced)</span>
<a href="#l127.64"></a><span id="l127.64">     {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l128.1"></a><span id="l128.1" class="difflineminus">--- a/mailnews/base/src/nsMsgMailSession.h</span>
<a href="#l128.2"></a><span id="l128.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgMailSession.h</span>
<a href="#l128.3"></a><span id="l128.3" class="difflineat">@@ -123,14 +123,15 @@ public:</span>
<a href="#l128.4"></a><span id="l128.4"> protected:</span>
<a href="#l128.5"></a><span id="l128.5">   nsresult ProcessNextTask();</span>
<a href="#l128.6"></a><span id="l128.6">   void AttemptShutdown();</span>
<a href="#l128.7"></a><span id="l128.7">   </span>
<a href="#l128.8"></a><span id="l128.8"> private:</span>
<a href="#l128.9"></a><span id="l128.9">   nsCOMArray&lt;nsIMsgShutdownTask&gt; mShutdownTasks;</span>
<a href="#l128.10"></a><span id="l128.10">   nsCOMPtr&lt;nsIMsgProgress&gt;       mMsgProgress;</span>
<a href="#l128.11"></a><span id="l128.11">   PRUint32                       mTaskIndex;</span>
<a href="#l128.12"></a><span id="l128.12" class="difflineplus">+  PRUint32                       mQuitMode;</span>
<a href="#l128.13"></a><span id="l128.13">   PRPackedBool mProcessedShutdown;</span>
<a href="#l128.14"></a><span id="l128.14">   PRPackedBool mQuitForced;</span>
<a href="#l128.15"></a><span id="l128.15">   PRPackedBool mReadyToQuit;</span>
<a href="#l128.16"></a><span id="l128.16"> };</span>
<a href="#l128.17"></a><span id="l128.17"> </span>
<a href="#l128.18"></a><span id="l128.18"> #endif /* nsMsgMailSession_h__ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l129.1"></a><span id="l129.1" class="difflineminus">--- a/mailnews/base/src/nsMsgProgress.cpp</span>
<a href="#l129.2"></a><span id="l129.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgProgress.cpp</span>
<a href="#l129.3"></a><span id="l129.3" class="difflineat">@@ -83,17 +83,16 @@ NS_IMETHODIMP nsMsgProgress::OpenProgres</span>
<a href="#l129.4"></a><span id="l129.4">   nsresult rv;</span>
<a href="#l129.5"></a><span id="l129.5">   </span>
<a href="#l129.6"></a><span id="l129.6">   if (aMsgWindow)</span>
<a href="#l129.7"></a><span id="l129.7">   {</span>
<a href="#l129.8"></a><span id="l129.8">     SetMsgWindow(aMsgWindow);</span>
<a href="#l129.9"></a><span id="l129.9">     aMsgWindow-&gt;SetStatusFeedback(this);</span>
<a href="#l129.10"></a><span id="l129.10">   }</span>
<a href="#l129.11"></a><span id="l129.11">   </span>
<a href="#l129.12"></a><span id="l129.12" class="difflineminus">-  NS_ENSURE_TRUE(!m_dialog, NS_ERROR_ALREADY_INITIALIZED);</span>
<a href="#l129.13"></a><span id="l129.13">   NS_ENSURE_ARG_POINTER(dialogURL);</span>
<a href="#l129.14"></a><span id="l129.14">   NS_ENSURE_ARG_POINTER(parent);</span>
<a href="#l129.15"></a><span id="l129.15">   </span>
<a href="#l129.16"></a><span id="l129.16">   // Set up window.arguments[0]...</span>
<a href="#l129.17"></a><span id="l129.17">   nsCOMPtr&lt;nsISupportsArray&gt; array;</span>
<a href="#l129.18"></a><span id="l129.18">   rv = NS_NewISupportsArray(getter_AddRefs(array));</span>
<a href="#l129.19"></a><span id="l129.19">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l129.20"></a><span id="l129.20">   </span>
<a href="#l129.21"></a><span id="l129.21" class="difflineat">@@ -122,24 +121,16 @@ NS_IMETHODIMP nsMsgProgress::OpenProgres</span>
<a href="#l129.22"></a><span id="l129.22"> </span>
<a href="#l129.23"></a><span id="l129.23"> /* void closeProgressDialog (in boolean forceClose); */</span>
<a href="#l129.24"></a><span id="l129.24"> NS_IMETHODIMP nsMsgProgress::CloseProgressDialog(PRBool forceClose)</span>
<a href="#l129.25"></a><span id="l129.25"> {</span>
<a href="#l129.26"></a><span id="l129.26">   m_closeProgress = PR_TRUE;</span>
<a href="#l129.27"></a><span id="l129.27">   return OnStateChange(nsnull, nsnull, nsIWebProgressListener::STATE_STOP, forceClose ? NS_ERROR_FAILURE : NS_OK);</span>
<a href="#l129.28"></a><span id="l129.28"> }</span>
<a href="#l129.29"></a><span id="l129.29"> </span>
<a href="#l129.30"></a><span id="l129.30" class="difflineminus">-/* nsIPrompt GetPrompter (); */</span>
<a href="#l129.31"></a><span id="l129.31" class="difflineminus">-NS_IMETHODIMP nsMsgProgress::GetPrompter(nsIPrompt **_retval)</span>
<a href="#l129.32"></a><span id="l129.32" class="difflineminus">-{</span>
<a href="#l129.33"></a><span id="l129.33" class="difflineminus">-  NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l129.34"></a><span id="l129.34" class="difflineminus">-  *_retval = nsnull;</span>
<a href="#l129.35"></a><span id="l129.35" class="difflineminus">-  return (! m_closeProgress &amp;&amp; m_dialog) ? m_dialog-&gt;GetPrompter(_retval) : NS_ERROR_FAILURE;</span>
<a href="#l129.36"></a><span id="l129.36" class="difflineminus">-}</span>
<a href="#l129.37"></a><span id="l129.37" class="difflineminus">-</span>
<a href="#l129.38"></a><span id="l129.38"> /* attribute boolean processCanceledByUser; */</span>
<a href="#l129.39"></a><span id="l129.39"> NS_IMETHODIMP nsMsgProgress::GetProcessCanceledByUser(PRBool *aProcessCanceledByUser)</span>
<a href="#l129.40"></a><span id="l129.40"> {</span>
<a href="#l129.41"></a><span id="l129.41">   NS_ENSURE_ARG_POINTER(aProcessCanceledByUser);</span>
<a href="#l129.42"></a><span id="l129.42">   *aProcessCanceledByUser = m_processCanceled;</span>
<a href="#l129.43"></a><span id="l129.43">   return NS_OK;</span>
<a href="#l129.44"></a><span id="l129.44"> }</span>
<a href="#l129.45"></a><span id="l129.45"> NS_IMETHODIMP nsMsgProgress::SetProcessCanceledByUser(PRBool aProcessCanceledByUser)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l130.1"></a><span id="l130.1" class="difflineminus">--- a/mailnews/base/src/nsMsgProgress.h</span>
<a href="#l130.2"></a><span id="l130.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgProgress.h</span>
<a href="#l130.3"></a><span id="l130.3" class="difflineat">@@ -68,14 +68,13 @@ public:</span>
<a href="#l130.4"></a><span id="l130.4"> private:</span>
<a href="#l130.5"></a><span id="l130.5">   nsresult ReleaseListeners(void);</span>
<a href="#l130.6"></a><span id="l130.6">   </span>
<a href="#l130.7"></a><span id="l130.7">   PRBool                             m_closeProgress;</span>
<a href="#l130.8"></a><span id="l130.8">   PRBool                             m_processCanceled;</span>
<a href="#l130.9"></a><span id="l130.9">   nsString                           m_pendingStatus;</span>
<a href="#l130.10"></a><span id="l130.10">   PRInt32                            m_pendingStateFlags;</span>
<a href="#l130.11"></a><span id="l130.11">   PRInt32                            m_pendingStateValue;</span>
<a href="#l130.12"></a><span id="l130.12" class="difflineminus">-  nsCOMPtr&lt;nsIDOMWindowInternal&gt;     m_dialog;</span>
<a href="#l130.13"></a><span id="l130.13">   nsWeakPtr                          m_msgWindow;</span>
<a href="#l130.14"></a><span id="l130.14">   nsCOMArray&lt;nsIWebProgressListener&gt; m_listenerList;</span>
<a href="#l130.15"></a><span id="l130.15"> };</span>
<a href="#l130.16"></a><span id="l130.16"> </span>
<a href="#l130.17"></a><span id="l130.17"> #endif  // nsMsgProgress_h_</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l131.1"></a><span id="l131.1" class="difflineminus">--- a/mailnews/base/src/nsMsgSearchDBView.cpp</span>
<a href="#l131.2"></a><span id="l131.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgSearchDBView.cpp</span>
<a href="#l131.3"></a><span id="l131.3" class="difflineat">@@ -50,16 +50,17 @@</span>
<a href="#l131.4"></a><span id="l131.4"> #include &quot;nsIMsgMessageService.h&quot;</span>
<a href="#l131.5"></a><span id="l131.5"> #include &quot;nsAutoPtr.h&quot;</span>
<a href="#l131.6"></a><span id="l131.6"> #include &quot;nsArrayUtils.h&quot;</span>
<a href="#l131.7"></a><span id="l131.7"> #include &quot;nsIMutableArray.h&quot;</span>
<a href="#l131.8"></a><span id="l131.8"> #include &quot;nsMsgGroupThread.h&quot;</span>
<a href="#l131.9"></a><span id="l131.9"> #include &quot;nsIPrefService.h&quot;</span>
<a href="#l131.10"></a><span id="l131.10"> #include &quot;nsIPrefBranch.h&quot;</span>
<a href="#l131.11"></a><span id="l131.11"> #include &quot;nsMsgMessageFlags.h&quot;</span>
<a href="#l131.12"></a><span id="l131.12" class="difflineplus">+#include &quot;nsIMsgSearchSession.h&quot;</span>
<a href="#l131.13"></a><span id="l131.13"> </span>
<a href="#l131.14"></a><span id="l131.14"> static PRBool gReferenceOnlyThreading;</span>
<a href="#l131.15"></a><span id="l131.15"> </span>
<a href="#l131.16"></a><span id="l131.16"> nsMsgSearchDBView::nsMsgSearchDBView()</span>
<a href="#l131.17"></a><span id="l131.17"> {</span>
<a href="#l131.18"></a><span id="l131.18">   // don't try to display messages for the search pane.</span>
<a href="#l131.19"></a><span id="l131.19">   mSuppressMsgDisplay = PR_TRUE;</span>
<a href="#l131.20"></a><span id="l131.20">   m_threadsTable.Init();</span>
<a href="#l131.21"></a><span id="l131.21" class="difflineat">@@ -731,16 +732,23 @@ nsMsgSearchDBView::OnNewSearch()</span>
<a href="#l131.22"></a><span id="l131.22"> </span>
<a href="#l131.23"></a><span id="l131.23"> NS_IMETHODIMP nsMsgSearchDBView::GetViewType(nsMsgViewTypeValue *aViewType)</span>
<a href="#l131.24"></a><span id="l131.24"> {</span>
<a href="#l131.25"></a><span id="l131.25">     NS_ENSURE_ARG_POINTER(aViewType);</span>
<a href="#l131.26"></a><span id="l131.26">     *aViewType = nsMsgViewType::eShowSearch;</span>
<a href="#l131.27"></a><span id="l131.27">     return NS_OK;</span>
<a href="#l131.28"></a><span id="l131.28"> }</span>
<a href="#l131.29"></a><span id="l131.29"> </span>
<a href="#l131.30"></a><span id="l131.30" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l131.31"></a><span id="l131.31" class="difflineplus">+nsMsgSearchDBView::SetSearchSession(nsIMsgSearchSession *aSession)</span>
<a href="#l131.32"></a><span id="l131.32" class="difflineplus">+{</span>
<a href="#l131.33"></a><span id="l131.33" class="difflineplus">+  m_searchSession = do_GetWeakReference(aSession);</span>
<a href="#l131.34"></a><span id="l131.34" class="difflineplus">+  return NS_OK;</span>
<a href="#l131.35"></a><span id="l131.35" class="difflineplus">+}</span>
<a href="#l131.36"></a><span id="l131.36" class="difflineplus">+</span>
<a href="#l131.37"></a><span id="l131.37"> NS_IMETHODIMP nsMsgSearchDBView::OnAnnouncerGoingAway(nsIDBChangeAnnouncer *instigator)</span>
<a href="#l131.38"></a><span id="l131.38"> {</span>
<a href="#l131.39"></a><span id="l131.39">   nsIMsgDatabase *db = static_cast&lt;nsIMsgDatabase *&gt;(instigator);</span>
<a href="#l131.40"></a><span id="l131.40">   if (db)</span>
<a href="#l131.41"></a><span id="l131.41">   {</span>
<a href="#l131.42"></a><span id="l131.42">     db-&gt;RemoveListener(this);</span>
<a href="#l131.43"></a><span id="l131.43">     m_dbToUseList.RemoveObject(db);</span>
<a href="#l131.44"></a><span id="l131.44">   }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l132.1"></a><span id="l132.1" class="difflineminus">--- a/mailnews/base/src/nsMsgSearchDBView.h</span>
<a href="#l132.2"></a><span id="l132.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgSearchDBView.h</span>
<a href="#l132.3"></a><span id="l132.3" class="difflineat">@@ -52,16 +52,18 @@ public:</span>
<a href="#l132.4"></a><span id="l132.4"> </span>
<a href="#l132.5"></a><span id="l132.5">   // these are tied together pretty intimately</span>
<a href="#l132.6"></a><span id="l132.6">   friend class nsMsgXFViewThread;</span>
<a href="#l132.7"></a><span id="l132.7"> </span>
<a href="#l132.8"></a><span id="l132.8">   NS_DECL_ISUPPORTS_INHERITED</span>
<a href="#l132.9"></a><span id="l132.9">   NS_DECL_NSIMSGSEARCHNOTIFY</span>
<a href="#l132.10"></a><span id="l132.10">   NS_DECL_NSIMSGCOPYSERVICELISTENER</span>
<a href="#l132.11"></a><span id="l132.11"> </span>
<a href="#l132.12"></a><span id="l132.12" class="difflineplus">+  NS_IMETHOD SetSearchSession(nsIMsgSearchSession *aSearchSession);</span>
<a href="#l132.13"></a><span id="l132.13" class="difflineplus">+</span>
<a href="#l132.14"></a><span id="l132.14">   virtual const char * GetViewName(void) {return &quot;SearchView&quot;; }</span>
<a href="#l132.15"></a><span id="l132.15">   NS_IMETHOD Open(nsIMsgFolder *folder, nsMsgViewSortTypeValue sortType, nsMsgViewSortOrderValue sortOrder, </span>
<a href="#l132.16"></a><span id="l132.16">         nsMsgViewFlagsTypeValue viewFlags, PRInt32 *pCount);</span>
<a href="#l132.17"></a><span id="l132.17">   NS_IMETHOD CloneDBView(nsIMessenger *aMessengerInstance, nsIMsgWindow *aMsgWindow,</span>
<a href="#l132.18"></a><span id="l132.18">                          nsIMsgDBViewCommandUpdater *aCmdUpdater, nsIMsgDBView **_retval);</span>
<a href="#l132.19"></a><span id="l132.19">   NS_IMETHOD CopyDBView(nsMsgDBView *aNewMsgDBView, nsIMessenger *aMessengerInstance, </span>
<a href="#l132.20"></a><span id="l132.20">                         nsIMsgWindow *aMsgWindow, nsIMsgDBViewCommandUpdater *aCmdUpdater);</span>
<a href="#l132.21"></a><span id="l132.21">   NS_IMETHOD Close();</span>
<a href="#l132.22"></a><span id="l132.22" class="difflineat">@@ -130,16 +132,17 @@ protected:</span>
<a href="#l132.23"></a><span id="l132.23">   PRUint32 mCurIndex;</span>
<a href="#l132.24"></a><span id="l132.24"> </span>
<a href="#l132.25"></a><span id="l132.25">   nsMsgViewIndex* mIndicesForChainedDeleteAndFile;</span>
<a href="#l132.26"></a><span id="l132.26">   PRInt32 mTotalIndices;</span>
<a href="#l132.27"></a><span id="l132.27">   nsCOMArray&lt;nsIMsgDatabase&gt; m_dbToUseList;</span>
<a href="#l132.28"></a><span id="l132.28">   nsMsgViewCommandTypeValue mCommand;</span>
<a href="#l132.29"></a><span id="l132.29">   nsCOMPtr &lt;nsIMsgFolder&gt; mDestFolder;</span>
<a href="#l132.30"></a><span id="l132.30">   nsString m_curCustomColumn;</span>
<a href="#l132.31"></a><span id="l132.31" class="difflineplus">+  nsWeakPtr m_searchSession;</span>
<a href="#l132.32"></a><span id="l132.32"> </span>
<a href="#l132.33"></a><span id="l132.33">   nsresult ProcessRequestsInOneFolder(nsIMsgWindow *window);</span>
<a href="#l132.34"></a><span id="l132.34">   nsresult ProcessRequestsInAllFolders(nsIMsgWindow *window);</span>
<a href="#l132.35"></a><span id="l132.35">   // these are for doing threading of the search hits</span>
<a href="#l132.36"></a><span id="l132.36"> </span>
<a href="#l132.37"></a><span id="l132.37"> </span>
<a href="#l132.38"></a><span id="l132.38">   // this maps message-ids and reference message ids to</span>
<a href="#l132.39"></a><span id="l132.39">   // the corresponding nsMsgXFViewThread object. If we're </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l133.1"></a><span id="l133.1" class="difflineminus">--- a/mailnews/base/src/nsMsgThreadedDBView.cpp</span>
<a href="#l133.2"></a><span id="l133.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgThreadedDBView.cpp</span>
<a href="#l133.3"></a><span id="l133.3" class="difflineat">@@ -136,21 +136,21 @@ nsresult nsMsgThreadedDBView::InitThread</span>
<a href="#l133.4"></a><span id="l133.4">   m_havePrevView = PR_FALSE;</span>
<a href="#l133.5"></a><span id="l133.5">   nsresult getSortrv = NS_OK; // ### TODO m_db-&gt;GetSortInfo(&amp;sortType, &amp;sortOrder);</span>
<a href="#l133.6"></a><span id="l133.6">   </span>
<a href="#l133.7"></a><span id="l133.7">   // list all the ids into m_keys.</span>
<a href="#l133.8"></a><span id="l133.8">   nsMsgKey startMsg = 0; </span>
<a href="#l133.9"></a><span id="l133.9">   do</span>
<a href="#l133.10"></a><span id="l133.10">   {</span>
<a href="#l133.11"></a><span id="l133.11">     const PRInt32 kIdChunkSize = 400;</span>
<a href="#l133.12"></a><span id="l133.12" class="difflineminus">-    PRInt32			numListed = 0;</span>
<a href="#l133.13"></a><span id="l133.13" class="difflineminus">-    nsMsgKey	idArray[kIdChunkSize];</span>
<a href="#l133.14"></a><span id="l133.14" class="difflineminus">-    PRInt32		flagArray[kIdChunkSize];</span>
<a href="#l133.15"></a><span id="l133.15" class="difflineminus">-    char		levelArray[kIdChunkSize];</span>
<a href="#l133.16"></a><span id="l133.16" class="difflineminus">-    </span>
<a href="#l133.17"></a><span id="l133.17" class="difflineplus">+    PRInt32  numListed = 0;</span>
<a href="#l133.18"></a><span id="l133.18" class="difflineplus">+    nsMsgKey idArray[kIdChunkSize];</span>
<a href="#l133.19"></a><span id="l133.19" class="difflineplus">+    PRInt32  flagArray[kIdChunkSize];</span>
<a href="#l133.20"></a><span id="l133.20" class="difflineplus">+    char     levelArray[kIdChunkSize];</span>
<a href="#l133.21"></a><span id="l133.21" class="difflineplus">+</span>
<a href="#l133.22"></a><span id="l133.22">     rv = ListThreadIds(&amp;startMsg, (m_viewFlags &amp; nsMsgViewFlagsType::kUnreadOnly) != 0, idArray, flagArray, </span>
<a href="#l133.23"></a><span id="l133.23">       levelArray, kIdChunkSize, &amp;numListed, nsnull);</span>
<a href="#l133.24"></a><span id="l133.24">     if (NS_SUCCEEDED(rv))</span>
<a href="#l133.25"></a><span id="l133.25">     {</span>
<a href="#l133.26"></a><span id="l133.26">       PRInt32 numAdded = AddKeys(idArray, flagArray, levelArray, m_sortType, numListed);</span>
<a href="#l133.27"></a><span id="l133.27">       if (pCount)</span>
<a href="#l133.28"></a><span id="l133.28">         *pCount += numAdded;</span>
<a href="#l133.29"></a><span id="l133.29">     }</span>
<a href="#l133.30"></a><span id="l133.30" class="difflineat">@@ -603,49 +603,49 @@ nsresult nsMsgThreadedDBView::OnNewHeade</span>
<a href="#l133.31"></a><span id="l133.31">     PRUint32 msgFlags;</span>
<a href="#l133.32"></a><span id="l133.32">     newHdr-&gt;GetFlags(&amp;msgFlags);</span>
<a href="#l133.33"></a><span id="l133.33">     if ((m_viewFlags &amp; nsMsgViewFlagsType::kUnreadOnly) &amp;&amp; !ensureListed &amp;&amp; (msgFlags &amp; nsMsgMessageFlags::Read))</span>
<a href="#l133.34"></a><span id="l133.34">       return NS_OK;</span>
<a href="#l133.35"></a><span id="l133.35">     // Currently, we only add the header in a threaded view if it's a thread.</span>
<a href="#l133.36"></a><span id="l133.36">     // We used to check if this was the first header in the thread, but that's</span>
<a href="#l133.37"></a><span id="l133.37">     // a bit harder in the unreadOnly view. But we'll catch it below.</span>
<a href="#l133.38"></a><span id="l133.38"> </span>
<a href="#l133.39"></a><span id="l133.39" class="difflineminus">-    // for search view we don't support threaded display so just add it to the view.   </span>
<a href="#l133.40"></a><span id="l133.40" class="difflineminus">-    if (!(m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay)) // || msgHdr-&gt;GetMessageKey() == m_messageDB-&gt;GetKeyOfFirstMsgInThread(msgHdr-&gt;GetMessageKey()))</span>
<a href="#l133.41"></a><span id="l133.41" class="difflineplus">+    // for search view we don't support threaded display so just add it to the view.</span>
<a href="#l133.42"></a><span id="l133.42" class="difflineplus">+    if (!(m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay))</span>
<a href="#l133.43"></a><span id="l133.43">       rv = AddHdr(newHdr);</span>
<a href="#l133.44"></a><span id="l133.44" class="difflineminus">-    else	// need to find the thread we added this to so we can change the hasnew flag</span>
<a href="#l133.45"></a><span id="l133.45" class="difflineminus">-      // added message to existing thread, but not to view</span>
<a href="#l133.46"></a><span id="l133.46" class="difflineminus">-    {	// Fix flags on thread header.</span>
<a href="#l133.47"></a><span id="l133.47" class="difflineplus">+    else // need to find the thread we added this to so we can change the hasnew flag</span>
<a href="#l133.48"></a><span id="l133.48" class="difflineplus">+         // added message to existing thread, but not to view</span>
<a href="#l133.49"></a><span id="l133.49" class="difflineplus">+    {    // Fix flags on thread header.</span>
<a href="#l133.50"></a><span id="l133.50">       PRInt32 threadCount;</span>
<a href="#l133.51"></a><span id="l133.51">       PRUint32 threadFlags;</span>
<a href="#l133.52"></a><span id="l133.52">       PRBool moveThread = PR_FALSE;</span>
<a href="#l133.53"></a><span id="l133.53">       nsMsgViewIndex threadIndex = ThreadIndexOfMsg(newKey, nsMsgViewIndex_None, &amp;threadCount, &amp;threadFlags);</span>
<a href="#l133.54"></a><span id="l133.54">       nsCOMPtr &lt;nsIMsgThread&gt; threadHdr;</span>
<a href="#l133.55"></a><span id="l133.55">       m_db-&gt;GetThreadContainingMsgHdr(newHdr, getter_AddRefs(threadHdr));</span>
<a href="#l133.56"></a><span id="l133.56">       if (threadHdr &amp;&amp; m_sortType == nsMsgViewSortType::byDate)</span>
<a href="#l133.57"></a><span id="l133.57">       {</span>
<a href="#l133.58"></a><span id="l133.58">         PRUint32 newestMsgInThread = 0, msgDate = 0;</span>
<a href="#l133.59"></a><span id="l133.59">         threadHdr-&gt;GetNewestMsgDate(&amp;newestMsgInThread);</span>
<a href="#l133.60"></a><span id="l133.60">         newHdr-&gt;GetDateInSeconds(&amp;msgDate);</span>
<a href="#l133.61"></a><span id="l133.61">         moveThread = (msgDate == newestMsgInThread);</span>
<a href="#l133.62"></a><span id="l133.62">       }</span>
<a href="#l133.63"></a><span id="l133.63">       if (threadIndex != nsMsgViewIndex_None)</span>
<a href="#l133.64"></a><span id="l133.64">       {</span>
<a href="#l133.65"></a><span id="l133.65" class="difflineminus">-        PRUint32	flags = m_flags[threadIndex];</span>
<a href="#l133.66"></a><span id="l133.66" class="difflineplus">+        PRUint32 flags = m_flags[threadIndex];</span>
<a href="#l133.67"></a><span id="l133.67">         if (!(flags &amp; MSG_VIEW_FLAG_HASCHILDREN))</span>
<a href="#l133.68"></a><span id="l133.68">         {</span>
<a href="#l133.69"></a><span id="l133.69">           flags |= MSG_VIEW_FLAG_HASCHILDREN | MSG_VIEW_FLAG_ISTHREAD;</span>
<a href="#l133.70"></a><span id="l133.70">           if (!(m_viewFlags &amp; nsMsgViewFlagsType::kUnreadOnly))</span>
<a href="#l133.71"></a><span id="l133.71">             flags |= nsMsgMessageFlags::Elided;</span>
<a href="#l133.72"></a><span id="l133.72">           m_flags[threadIndex] = flags;</span>
<a href="#l133.73"></a><span id="l133.73">         }</span>
<a href="#l133.74"></a><span id="l133.74" class="difflineminus">-        if (!(flags &amp; nsMsgMessageFlags::Elided))	// thread is expanded</span>
<a href="#l133.75"></a><span id="l133.75" class="difflineminus">-        {								// insert child into thread</span>
<a href="#l133.76"></a><span id="l133.76" class="difflineplus">+        if (!(flags &amp; nsMsgMessageFlags::Elided)) // thread is expanded</span>
<a href="#l133.77"></a><span id="l133.77" class="difflineplus">+        {  // insert child into thread</span>
<a href="#l133.78"></a><span id="l133.78">           // levels of other hdrs may have changed!</span>
<a href="#l133.79"></a><span id="l133.79" class="difflineminus">-          PRUint32	newFlags = msgFlags;</span>
<a href="#l133.80"></a><span id="l133.80" class="difflineplus">+          PRUint32 newFlags = msgFlags;</span>
<a href="#l133.81"></a><span id="l133.81">           PRInt32 level = 0;</span>
<a href="#l133.82"></a><span id="l133.82">           nsMsgViewIndex insertIndex = threadIndex;</span>
<a href="#l133.83"></a><span id="l133.83">           if (aParentKey == nsMsgKey_None)</span>
<a href="#l133.84"></a><span id="l133.84">           {</span>
<a href="#l133.85"></a><span id="l133.85">             newFlags |= MSG_VIEW_FLAG_ISTHREAD | MSG_VIEW_FLAG_HASCHILDREN;</span>
<a href="#l133.86"></a><span id="l133.86">           }</span>
<a href="#l133.87"></a><span id="l133.87">           else</span>
<a href="#l133.88"></a><span id="l133.88">           {</span>
<a href="#l133.89"></a><span id="l133.89" class="difflineat">@@ -659,31 +659,35 @@ nsresult nsMsgThreadedDBView::OnNewHeade</span>
<a href="#l133.90"></a><span id="l133.90">           NoteChange(insertIndex, 1, nsMsgViewNotificationCode::insertOrDelete);</span>
<a href="#l133.91"></a><span id="l133.91"> </span>
<a href="#l133.92"></a><span id="l133.92">           if (aParentKey == nsMsgKey_None)</span>
<a href="#l133.93"></a><span id="l133.93">           {</span>
<a href="#l133.94"></a><span id="l133.94">             // this header is the new king! try collapsing the existing thread,</span>
<a href="#l133.95"></a><span id="l133.95">             // removing it, installing this header as king, and expanding it.</span>
<a href="#l133.96"></a><span id="l133.96">             CollapseByIndex(threadIndex, nsnull);</span>
<a href="#l133.97"></a><span id="l133.97">             // call base class, so child won't get promoted.</span>
<a href="#l133.98"></a><span id="l133.98" class="difflineminus">-            // nsMsgDBView::RemoveByIndex(threadIndex);	</span>
<a href="#l133.99"></a><span id="l133.99" class="difflineplus">+            // nsMsgDBView::RemoveByIndex(threadIndex);</span>
<a href="#l133.100"></a><span id="l133.100">             ExpandByIndex(threadIndex, nsnull);</span>
<a href="#l133.101"></a><span id="l133.101">           }</span>
<a href="#l133.102"></a><span id="l133.102">         }</span>
<a href="#l133.103"></a><span id="l133.103">         else if (aParentKey == nsMsgKey_None)</span>
<a href="#l133.104"></a><span id="l133.104">         {</span>
<a href="#l133.105"></a><span id="l133.105">           // if we have a collapsed thread which just got a new</span>
<a href="#l133.106"></a><span id="l133.106">           // top of thread, change the keys array.</span>
<a href="#l133.107"></a><span id="l133.107">           m_keys[threadIndex] = newKey;</span>
<a href="#l133.108"></a><span id="l133.108">         }</span>
<a href="#l133.109"></a><span id="l133.109">         if (moveThread)</span>
<a href="#l133.110"></a><span id="l133.110">           MoveThreadAt(threadIndex);</span>
<a href="#l133.111"></a><span id="l133.111">         else</span>
<a href="#l133.112"></a><span id="l133.112">         // note change, to update the parent thread's unread and total counts</span>
<a href="#l133.113"></a><span id="l133.113">           NoteChange(threadIndex, 1, nsMsgViewNotificationCode::changed);</span>
<a href="#l133.114"></a><span id="l133.114" class="difflineplus">+        // if this message is new, and the thread is collapsed, expand it.</span>
<a href="#l133.115"></a><span id="l133.115" class="difflineplus">+        if (msgFlags &amp; nsMsgMessageFlags::New &amp;&amp;</span>
<a href="#l133.116"></a><span id="l133.116" class="difflineplus">+            m_flags[threadIndex] &amp; nsMsgMessageFlags::Elided)</span>
<a href="#l133.117"></a><span id="l133.117" class="difflineplus">+          ExpandByIndex(threadIndex, nsnull);</span>
<a href="#l133.118"></a><span id="l133.118">       }</span>
<a href="#l133.119"></a><span id="l133.119">       else // adding msg to thread that's not in view.</span>
<a href="#l133.120"></a><span id="l133.120">       {</span>
<a href="#l133.121"></a><span id="l133.121">         if (threadHdr)</span>
<a href="#l133.122"></a><span id="l133.122">         {</span>
<a href="#l133.123"></a><span id="l133.123">           AddMsgToThreadNotInView(threadHdr, newHdr, ensureListed);</span>
<a href="#l133.124"></a><span id="l133.124">         }</span>
<a href="#l133.125"></a><span id="l133.125">       }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l134.1"></a><span id="l134.1" class="difflineminus">--- a/mailnews/base/src/nsMsgXFVirtualFolderDBView.cpp</span>
<a href="#l134.2"></a><span id="l134.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgXFVirtualFolderDBView.cpp</span>
<a href="#l134.3"></a><span id="l134.3" class="difflineat">@@ -119,23 +119,16 @@ nsMsgXFVirtualFolderDBView::CopyDBView(n</span>
<a href="#l134.4"></a><span id="l134.4"> </span>
<a href="#l134.5"></a><span id="l134.5"> NS_IMETHODIMP nsMsgXFVirtualFolderDBView::GetViewType(nsMsgViewTypeValue *aViewType)</span>
<a href="#l134.6"></a><span id="l134.6"> {</span>
<a href="#l134.7"></a><span id="l134.7">     NS_ENSURE_ARG_POINTER(aViewType);</span>
<a href="#l134.8"></a><span id="l134.8">     *aViewType = nsMsgViewType::eShowVirtualFolderResults;</span>
<a href="#l134.9"></a><span id="l134.9">     return NS_OK;</span>
<a href="#l134.10"></a><span id="l134.10"> }</span>
<a href="#l134.11"></a><span id="l134.11"> </span>
<a href="#l134.12"></a><span id="l134.12" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l134.13"></a><span id="l134.13" class="difflineminus">-nsMsgXFVirtualFolderDBView::SetSearchSession(nsIMsgSearchSession *aSession)</span>
<a href="#l134.14"></a><span id="l134.14" class="difflineminus">-{</span>
<a href="#l134.15"></a><span id="l134.15" class="difflineminus">-  m_searchSession = do_GetWeakReference(aSession);</span>
<a href="#l134.16"></a><span id="l134.16" class="difflineminus">-  return NS_OK;</span>
<a href="#l134.17"></a><span id="l134.17" class="difflineminus">-}</span>
<a href="#l134.18"></a><span id="l134.18" class="difflineminus">-</span>
<a href="#l134.19"></a><span id="l134.19"> nsresult nsMsgXFVirtualFolderDBView::OnNewHeader(nsIMsgDBHdr *newHdr, nsMsgKey aParentKey, PRBool /*ensureListed*/)</span>
<a href="#l134.20"></a><span id="l134.20"> {</span>
<a href="#l134.21"></a><span id="l134.21">   if (newHdr)</span>
<a href="#l134.22"></a><span id="l134.22">   {</span>
<a href="#l134.23"></a><span id="l134.23">     PRBool match = PR_FALSE;</span>
<a href="#l134.24"></a><span id="l134.24">     nsCOMPtr &lt;nsIMsgSearchSession&gt; searchSession = do_QueryReferent(m_searchSession);</span>
<a href="#l134.25"></a><span id="l134.25">     if (searchSession)</span>
<a href="#l134.26"></a><span id="l134.26">       searchSession-&gt;MatchHdr(newHdr, m_db, &amp;match);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l135.1"></a><span id="l135.1" class="difflineminus">--- a/mailnews/base/src/nsMsgXFVirtualFolderDBView.h</span>
<a href="#l135.2"></a><span id="l135.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgXFVirtualFolderDBView.h</span>
<a href="#l135.3"></a><span id="l135.3" class="difflineat">@@ -47,17 +47,16 @@</span>
<a href="#l135.4"></a><span id="l135.4"> class nsMsgGroupThread;</span>
<a href="#l135.5"></a><span id="l135.5"> </span>
<a href="#l135.6"></a><span id="l135.6"> class nsMsgXFVirtualFolderDBView : public nsMsgSearchDBView</span>
<a href="#l135.7"></a><span id="l135.7"> {</span>
<a href="#l135.8"></a><span id="l135.8"> public:</span>
<a href="#l135.9"></a><span id="l135.9">   nsMsgXFVirtualFolderDBView();</span>
<a href="#l135.10"></a><span id="l135.10">   virtual ~nsMsgXFVirtualFolderDBView();</span>
<a href="#l135.11"></a><span id="l135.11"> </span>
<a href="#l135.12"></a><span id="l135.12" class="difflineminus">-  NS_IMETHOD SetSearchSession(nsIMsgSearchSession *aSearchSession);</span>
<a href="#l135.13"></a><span id="l135.13">   // we override all the methods, currently. Might change...</span>
<a href="#l135.14"></a><span id="l135.14">   NS_DECL_NSIMSGSEARCHNOTIFY</span>
<a href="#l135.15"></a><span id="l135.15"> </span>
<a href="#l135.16"></a><span id="l135.16">   virtual const char * GetViewName(void) {return &quot;XFVirtualFolderView&quot;; }</span>
<a href="#l135.17"></a><span id="l135.17">   NS_IMETHOD Open(nsIMsgFolder *folder, nsMsgViewSortTypeValue sortType, nsMsgViewSortOrderValue sortOrder, </span>
<a href="#l135.18"></a><span id="l135.18">         nsMsgViewFlagsTypeValue viewFlags, PRInt32 *pCount);</span>
<a href="#l135.19"></a><span id="l135.19">   NS_IMETHOD OpenWithHdrs(nsISimpleEnumerator *aHeaders, </span>
<a href="#l135.20"></a><span id="l135.20">                           nsMsgViewSortTypeValue aSortType,</span>
<a href="#l135.21"></a><span id="l135.21" class="difflineat">@@ -87,12 +86,11 @@ protected:</span>
<a href="#l135.22"></a><span id="l135.22"> </span>
<a href="#l135.23"></a><span id="l135.23">   PRUint32 m_cachedFolderArrayIndex; // array index of next folder with cached hits to deal with.</span>
<a href="#l135.24"></a><span id="l135.24">   nsCOMArray&lt;nsIMsgFolder&gt; m_foldersSearchingOver;</span>
<a href="#l135.25"></a><span id="l135.25">   nsCOMArray&lt;nsIMsgDBHdr&gt; m_hdrHits;</span>
<a href="#l135.26"></a><span id="l135.26">   nsCOMPtr &lt;nsIMsgFolder&gt; m_curFolderGettingHits;</span>
<a href="#l135.27"></a><span id="l135.27">   PRUint32 m_curFolderStartKeyIndex; // keeps track of the index of the first hit from the cur folder</span>
<a href="#l135.28"></a><span id="l135.28">   PRBool m_curFolderHasCachedHits;</span>
<a href="#l135.29"></a><span id="l135.29">   PRBool m_doingSearch;</span>
<a href="#l135.30"></a><span id="l135.30" class="difflineminus">-  nsWeakPtr m_searchSession;</span>
<a href="#l135.31"></a><span id="l135.31"> };</span>
<a href="#l135.32"></a><span id="l135.32"> </span>
<a href="#l135.33"></a><span id="l135.33"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l136.1"></a><span id="l136.1" class="difflineminus">--- a/mailnews/base/src/quickSearchManager.js</span>
<a href="#l136.2"></a><span id="l136.2" class="difflineplus">+++ b/mailnews/base/src/quickSearchManager.js</span>
<a href="#l136.3"></a><span id="l136.3" class="difflineat">@@ -176,11 +176,11 @@ var QuickSearchManager = {</span>
<a href="#l136.4"></a><span id="l136.4">         term.value = value;</span>
<a href="#l136.5"></a><span id="l136.5">         term.attrib = nsMsgSearchAttrib.ToOrCC;</span>
<a href="#l136.6"></a><span id="l136.6">         term.op = nsMsgSearchOp.Contains;</span>
<a href="#l136.7"></a><span id="l136.7">         term.booleanAnd = false;</span>
<a href="#l136.8"></a><span id="l136.8">         searchTerms.push(term);</span>
<a href="#l136.9"></a><span id="l136.9">       }</span>
<a href="#l136.10"></a><span id="l136.10">     }</span>
<a href="#l136.11"></a><span id="l136.11"> </span>
<a href="#l136.12"></a><span id="l136.12" class="difflineminus">-    return searchTerms;</span>
<a href="#l136.13"></a><span id="l136.13" class="difflineplus">+    return searchTerms.length ? searchTerms : null;</span>
<a href="#l136.14"></a><span id="l136.14">   }</span>
<a href="#l136.15"></a><span id="l136.15"> };</span>
<a href="#l136.16"></a><span id="l136.16">\ No newline at end of file</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l137.1"></a><span id="l137.1" class="difflineminus">--- a/mailnews/base/src/searchSpec.js</span>
<a href="#l137.2"></a><span id="l137.2" class="difflineplus">+++ b/mailnews/base/src/searchSpec.js</span>
<a href="#l137.3"></a><span id="l137.3" class="difflineat">@@ -44,35 +44,56 @@ const Cu = Components.utils;</span>
<a href="#l137.4"></a><span id="l137.4"> </span>
<a href="#l137.5"></a><span id="l137.5"> Cu.import(&quot;resource://app/modules/iteratorUtils.jsm&quot;);</span>
<a href="#l137.6"></a><span id="l137.6"> Cu.import(&quot;resource://app/modules/quickSearchManager.js&quot;);</span>
<a href="#l137.7"></a><span id="l137.7"> </span>
<a href="#l137.8"></a><span id="l137.8"> const nsMsgSearchScope = Ci.nsMsgSearchScope;</span>
<a href="#l137.9"></a><span id="l137.9"> const nsIMsgSearchTerm = Ci.nsIMsgSearchTerm;</span>
<a href="#l137.10"></a><span id="l137.10"> const nsIMsgLocalMailFolder = Ci.nsIMsgLocalMailFolder;</span>
<a href="#l137.11"></a><span id="l137.11"> const nsMsgFolderFlags = Ci.nsMsgFolderFlags;</span>
<a href="#l137.12"></a><span id="l137.12" class="difflineplus">+const nsMsgSearchAttrib = Ci.nsMsgSearchAttrib;</span>
<a href="#l137.13"></a><span id="l137.13"> </span>
<a href="#l137.14"></a><span id="l137.14"> const NS_MSG_SEARCH_INTERRUPTED = 0x00550002;</span>
<a href="#l137.15"></a><span id="l137.15"> </span>
<a href="#l137.16"></a><span id="l137.16"> /**</span>
<a href="#l137.17"></a><span id="l137.17">  * Wrapper abstraction around a view's search session.  This is basically a</span>
<a href="#l137.18"></a><span id="l137.18">  *  friend class of FolderDisplayWidget and is privy to some of its internals.</span>
<a href="#l137.19"></a><span id="l137.19">  */</span>
<a href="#l137.20"></a><span id="l137.20" class="difflineminus">-function SearchSpec(aFolderDisplayWidget) {</span>
<a href="#l137.21"></a><span id="l137.21" class="difflineminus">-  this.owner = aFolderDisplayWidget;</span>
<a href="#l137.22"></a><span id="l137.22" class="difflineplus">+function SearchSpec(aViewWrapper) {</span>
<a href="#l137.23"></a><span id="l137.23" class="difflineplus">+  this.owner = aViewWrapper;</span>
<a href="#l137.24"></a><span id="l137.24"> </span>
<a href="#l137.25"></a><span id="l137.25">   this._viewTerms = null;</span>
<a href="#l137.26"></a><span id="l137.26">   this._virtualFolderTerms = null;</span>
<a href="#l137.27"></a><span id="l137.27">   this._userTerms = null;</span>
<a href="#l137.28"></a><span id="l137.28"> </span>
<a href="#l137.29"></a><span id="l137.29">   this._session = null;</span>
<a href="#l137.30"></a><span id="l137.30">   this._sessionListener = null;</span>
<a href="#l137.31"></a><span id="l137.31">   this._listenersRegistered = false;</span>
<a href="#l137.32"></a><span id="l137.32" class="difflineplus">+</span>
<a href="#l137.33"></a><span id="l137.33" class="difflineplus">+  this._onlineSearch = false;</span>
<a href="#l137.34"></a><span id="l137.34"> }</span>
<a href="#l137.35"></a><span id="l137.35"> SearchSpec.prototype = {</span>
<a href="#l137.36"></a><span id="l137.36" class="difflineplus">+  /**</span>
<a href="#l137.37"></a><span id="l137.37" class="difflineplus">+   * Clone this SearchSpec; intended to be used by DBViewWrapper.clone().</span>
<a href="#l137.38"></a><span id="l137.38" class="difflineplus">+   */</span>
<a href="#l137.39"></a><span id="l137.39" class="difflineplus">+  clone: function SearchSpec_clone(aViewWrapper) {</span>
<a href="#l137.40"></a><span id="l137.40" class="difflineplus">+    let doppel = new SearchSpec(aViewWrapper);</span>
<a href="#l137.41"></a><span id="l137.41" class="difflineplus">+</span>
<a href="#l137.42"></a><span id="l137.42" class="difflineplus">+    // we can just copy the terms since we never mutate them</span>
<a href="#l137.43"></a><span id="l137.43" class="difflineplus">+    doppel._viewTerms = this._viewTerms;</span>
<a href="#l137.44"></a><span id="l137.44" class="difflineplus">+    doppel._virtualFolderTerms = this._viewTerms;</span>
<a href="#l137.45"></a><span id="l137.45" class="difflineplus">+    doppel._userTerms = this._viewTerms;</span>
<a href="#l137.46"></a><span id="l137.46" class="difflineplus">+</span>
<a href="#l137.47"></a><span id="l137.47" class="difflineplus">+    // _session can stay null</span>
<a href="#l137.48"></a><span id="l137.48" class="difflineplus">+    // no listener is required, so we can keep _sessionListener and</span>
<a href="#l137.49"></a><span id="l137.49" class="difflineplus">+    //  _listenersRegistered at their default values</span>
<a href="#l137.50"></a><span id="l137.50" class="difflineplus">+</span>
<a href="#l137.51"></a><span id="l137.51" class="difflineplus">+    return doppel;</span>
<a href="#l137.52"></a><span id="l137.52" class="difflineplus">+  },</span>
<a href="#l137.53"></a><span id="l137.53" class="difflineplus">+</span>
<a href="#l137.54"></a><span id="l137.54">   get hasSearchTerms() {</span>
<a href="#l137.55"></a><span id="l137.55">     return this._viewTerms || this._virtualFolderTerms || this._userTerms;</span>
<a href="#l137.56"></a><span id="l137.56">   },</span>
<a href="#l137.57"></a><span id="l137.57"> </span>
<a href="#l137.58"></a><span id="l137.58">   get hasOnlyVirtualTerms() {</span>
<a href="#l137.59"></a><span id="l137.59">     return this._virtualFolderTerms &amp;&amp; !this._viewTerms &amp;&amp; !this._userTerms;</span>
<a href="#l137.60"></a><span id="l137.60">   },</span>
<a href="#l137.61"></a><span id="l137.61"> </span>
<a href="#l137.62"></a><span id="l137.62" class="difflineat">@@ -99,17 +120,17 @@ SearchSpec.prototype = {</span>
<a href="#l137.63"></a><span id="l137.63">    * (Potentially) add the db view as a search listener and kick off the search.</span>
<a href="#l137.64"></a><span id="l137.64">    *  We only do that if we have search terms.  The intent is to allow you to</span>
<a href="#l137.65"></a><span id="l137.65">    *  call this all the time, even if you don't need to.</span>
<a href="#l137.66"></a><span id="l137.66">    * DBViewWrapper._applyViewChanges used to handle a lot more of this, but our</span>
<a href="#l137.67"></a><span id="l137.67">    *  need to make sure that the session listener gets added after the DBView</span>
<a href="#l137.68"></a><span id="l137.68">    *  caused us to introduce this method.  (We want the DB View's OnDone method</span>
<a href="#l137.69"></a><span id="l137.69">    *  to run before our listener, as it may do important work.)</span>
<a href="#l137.70"></a><span id="l137.70">    */</span>
<a href="#l137.71"></a><span id="l137.71" class="difflineminus">-  associateView: function(aDBView) {</span>
<a href="#l137.72"></a><span id="l137.72" class="difflineplus">+  associateView: function SearchSpec_associateView(aDBView) {</span>
<a href="#l137.73"></a><span id="l137.73">     if (this.hasSearchTerms) {</span>
<a href="#l137.74"></a><span id="l137.74">       this.updateSession();</span>
<a href="#l137.75"></a><span id="l137.75"> </span>
<a href="#l137.76"></a><span id="l137.76">       if (!this._sessionListener)</span>
<a href="#l137.77"></a><span id="l137.77">         this._sessionListener = new SearchSpecListener(this);</span>
<a href="#l137.78"></a><span id="l137.78"> </span>
<a href="#l137.79"></a><span id="l137.79">       this.session.registerListener(aDBView);</span>
<a href="#l137.80"></a><span id="l137.80">       aDBView.searchSession = this._session;</span>
<a href="#l137.81"></a><span id="l137.81" class="difflineat">@@ -119,17 +140,17 @@ SearchSpec.prototype = {</span>
<a href="#l137.82"></a><span id="l137.82">       this.owner.searching = true;</span>
<a href="#l137.83"></a><span id="l137.83">       this.session.search(this.owner.listener.msgWindow);</span>
<a href="#l137.84"></a><span id="l137.84">     }</span>
<a href="#l137.85"></a><span id="l137.85">   },</span>
<a href="#l137.86"></a><span id="l137.86">   /**</span>
<a href="#l137.87"></a><span id="l137.87">    * Stop any active search and stop the db view being a search listener (if it</span>
<a href="#l137.88"></a><span id="l137.88">    *  is one).</span>
<a href="#l137.89"></a><span id="l137.89">    */</span>
<a href="#l137.90"></a><span id="l137.90" class="difflineminus">-  dissociateView: function(aDBView) {</span>
<a href="#l137.91"></a><span id="l137.91" class="difflineplus">+  dissociateView: function SearchSpec_dissociateView(aDBView) {</span>
<a href="#l137.92"></a><span id="l137.92">     // If we are currently searching, interrupt the search.  This will</span>
<a href="#l137.93"></a><span id="l137.93">     //  immediately notify the listeners that the search is done with and</span>
<a href="#l137.94"></a><span id="l137.94">     //  clear the searching flag for us.</span>
<a href="#l137.95"></a><span id="l137.95">     if (this.owner.searching)</span>
<a href="#l137.96"></a><span id="l137.96">       this.session.interruptSearch();</span>
<a href="#l137.97"></a><span id="l137.97"> </span>
<a href="#l137.98"></a><span id="l137.98">     if (this._listenersRegistered) {</span>
<a href="#l137.99"></a><span id="l137.99">       this._session.unregisterListener(this._sessionListener);</span>
<a href="#l137.100"></a><span id="l137.100" class="difflineat">@@ -183,77 +204,109 @@ SearchSpec.prototype = {</span>
<a href="#l137.101"></a><span id="l137.101">   set viewTerms(aViewTerms) {</span>
<a href="#l137.102"></a><span id="l137.102">     if (aViewTerms)</span>
<a href="#l137.103"></a><span id="l137.103">       this._viewTerms = this._groupifyTerms(aViewTerms);</span>
<a href="#l137.104"></a><span id="l137.104">     else</span>
<a href="#l137.105"></a><span id="l137.105">       this._viewTerms = null;</span>
<a href="#l137.106"></a><span id="l137.106">     this.owner._applyViewChanges();</span>
<a href="#l137.107"></a><span id="l137.107">   },</span>
<a href="#l137.108"></a><span id="l137.108">   /**</span>
<a href="#l137.109"></a><span id="l137.109" class="difflineplus">+   * @return the view terms currently in effect.  Do not mutate this.</span>
<a href="#l137.110"></a><span id="l137.110" class="difflineplus">+   */</span>
<a href="#l137.111"></a><span id="l137.111" class="difflineplus">+  get viewTerms() {</span>
<a href="#l137.112"></a><span id="l137.112" class="difflineplus">+    return this._viewTerms;</span>
<a href="#l137.113"></a><span id="l137.113" class="difflineplus">+  },</span>
<a href="#l137.114"></a><span id="l137.114" class="difflineplus">+  /**</span>
<a href="#l137.115"></a><span id="l137.115">    * Set search terms that are defined by the 'virtual folder' definition.  This</span>
<a href="#l137.116"></a><span id="l137.116">    *  could also be thought of as the 'saved search' part of a saved search.</span>
<a href="#l137.117"></a><span id="l137.117">    *</span>
<a href="#l137.118"></a><span id="l137.118">    * @param aVirtualFolderTerms The list of terms.  We make our own copy and</span>
<a href="#l137.119"></a><span id="l137.119">    *     do not mutate yours.</span>
<a href="#l137.120"></a><span id="l137.120">    */</span>
<a href="#l137.121"></a><span id="l137.121">   set virtualFolderTerms(aVirtualFolderTerms) {</span>
<a href="#l137.122"></a><span id="l137.122">     if (aVirtualFolderTerms)</span>
<a href="#l137.123"></a><span id="l137.123">       // we need to clone virtual folder terms because they are pulled from a</span>
<a href="#l137.124"></a><span id="l137.124">       //  persistent location rather than created on demand</span>
<a href="#l137.125"></a><span id="l137.125">       this._virtualFolderTerms = this._groupifyTerms(aVirtualFolderTerms,</span>
<a href="#l137.126"></a><span id="l137.126">                                                      true);</span>
<a href="#l137.127"></a><span id="l137.127">     else</span>
<a href="#l137.128"></a><span id="l137.128">       this._virtualFolderTerms = null;</span>
<a href="#l137.129"></a><span id="l137.129">     this.owner._applyViewChanges();</span>
<a href="#l137.130"></a><span id="l137.130">   },</span>
<a href="#l137.131"></a><span id="l137.131" class="difflineplus">+  /**</span>
<a href="#l137.132"></a><span id="l137.132" class="difflineplus">+   * @return the Virtual folder terms currently in effect.  Do not mutate this.</span>
<a href="#l137.133"></a><span id="l137.133" class="difflineplus">+   */</span>
<a href="#l137.134"></a><span id="l137.134" class="difflineplus">+  get virtualFolderTerms() {</span>
<a href="#l137.135"></a><span id="l137.135" class="difflineplus">+    return this._virtualFolderTerms;</span>
<a href="#l137.136"></a><span id="l137.136" class="difflineplus">+  },</span>
<a href="#l137.137"></a><span id="l137.137"> </span>
<a href="#l137.138"></a><span id="l137.138">   /**</span>
<a href="#l137.139"></a><span id="l137.139">    * Set the terms that the user is explicitly searching on.  These will be</span>
<a href="#l137.140"></a><span id="l137.140">    *  augmented with the 'context' search terms potentially provided by</span>
<a href="#l137.141"></a><span id="l137.141">    *  viewTerms and virtualFolderTerms.</span>
<a href="#l137.142"></a><span id="l137.142">    *</span>
<a href="#l137.143"></a><span id="l137.143">    * @param aUserTerms The list of terms.  We take ownership and mutate it.</span>
<a href="#l137.144"></a><span id="l137.144">    */</span>
<a href="#l137.145"></a><span id="l137.145">   set userTerms(aUserTerms) {</span>
<a href="#l137.146"></a><span id="l137.146">     if (aUserTerms)</span>
<a href="#l137.147"></a><span id="l137.147">       this._userTerms = this._groupifyTerms(aUserTerms);</span>
<a href="#l137.148"></a><span id="l137.148">     else</span>
<a href="#l137.149"></a><span id="l137.149">       this._userTerms = null;</span>
<a href="#l137.150"></a><span id="l137.150">     this.owner._applyViewChanges();</span>
<a href="#l137.151"></a><span id="l137.151">   },</span>
<a href="#l137.152"></a><span id="l137.152">   /**</span>
<a href="#l137.153"></a><span id="l137.153" class="difflineplus">+   * @return the user terms currently in effect as set via the |userTerms|</span>
<a href="#l137.154"></a><span id="l137.154" class="difflineplus">+   *     attribute or via the |quickSearch| method.  Do not mutate this.</span>
<a href="#l137.155"></a><span id="l137.155" class="difflineplus">+   */</span>
<a href="#l137.156"></a><span id="l137.156" class="difflineplus">+  get userTerms() {</span>
<a href="#l137.157"></a><span id="l137.157" class="difflineplus">+    return this._userTerms;</span>
<a href="#l137.158"></a><span id="l137.158" class="difflineplus">+  },</span>
<a href="#l137.159"></a><span id="l137.159" class="difflineplus">+  /**</span>
<a href="#l137.160"></a><span id="l137.160">    * Apply a quick-search for the given search mode using the given search</span>
<a href="#l137.161"></a><span id="l137.161">    *  string.  All of the hard work is done by</span>
<a href="#l137.162"></a><span id="l137.162">    *  QuickSearchManager.createSearchTerms; we mainly just assign the result to</span>
<a href="#l137.163"></a><span id="l137.163">    *  our userTerms property.</span>
<a href="#l137.164"></a><span id="l137.164">    *</span>
<a href="#l137.165"></a><span id="l137.165">    * @param aSearchMode One of the QuickSearchConstants.kQuickSearch* search</span>
<a href="#l137.166"></a><span id="l137.166">    *     mode constants specifying what parts of the message to search on.</span>
<a href="#l137.167"></a><span id="l137.167">    * @param aSearchString The search string, consisting of sub-strings delimited</span>
<a href="#l137.168"></a><span id="l137.168">    *     by '|' to be OR-ed together.  Given the string &quot;foo&quot; we search for</span>
<a href="#l137.169"></a><span id="l137.169">    *     messages containing &quot;foo&quot;.  Given the string &quot;foo|bar&quot;, we search for</span>
<a href="#l137.170"></a><span id="l137.170">    *     messages containing &quot;foo&quot; or &quot;bar&quot;.</span>
<a href="#l137.171"></a><span id="l137.171">    */</span>
<a href="#l137.172"></a><span id="l137.172">   quickSearch: function SearchSpec_quickSearch(aSearchMode, aSearchString) {</span>
<a href="#l137.173"></a><span id="l137.173">     this.userTerms = QuickSearchManager.createSearchTerms(</span>
<a href="#l137.174"></a><span id="l137.174" class="difflineminus">-      this._session, aSearchMode, aSearchString);</span>
<a href="#l137.175"></a><span id="l137.175" class="difflineplus">+      this.session, aSearchMode, aSearchString);</span>
<a href="#l137.176"></a><span id="l137.176">   },</span>
<a href="#l137.177"></a><span id="l137.177"> </span>
<a href="#l137.178"></a><span id="l137.178">   clear: function SearchSpec_clear() {</span>
<a href="#l137.179"></a><span id="l137.179">     if (this.hasSearchTerms) {</span>
<a href="#l137.180"></a><span id="l137.180">       this._viewTerms = null;</span>
<a href="#l137.181"></a><span id="l137.181">       this._virtualFolderTerms = null;</span>
<a href="#l137.182"></a><span id="l137.182">       this._userTerms = null;</span>
<a href="#l137.183"></a><span id="l137.183">       this.owner._applyViewChanges();</span>
<a href="#l137.184"></a><span id="l137.184">     }</span>
<a href="#l137.185"></a><span id="l137.185">   },</span>
<a href="#l137.186"></a><span id="l137.186"> </span>
<a href="#l137.187"></a><span id="l137.187">   get onlineSearch() {</span>
<a href="#l137.188"></a><span id="l137.188">     return this._onlineSearch;</span>
<a href="#l137.189"></a><span id="l137.189">   },</span>
<a href="#l137.190"></a><span id="l137.190" class="difflineplus">+  /**</span>
<a href="#l137.191"></a><span id="l137.191" class="difflineplus">+   * Virtual folders have a concept of 'online search' which affects the logic</span>
<a href="#l137.192"></a><span id="l137.192" class="difflineplus">+   *  in updateSession that builds our search scopes.  If onlineSearch is false,</span>
<a href="#l137.193"></a><span id="l137.193" class="difflineplus">+   *  then when displaying the virtual folder unaffected by mail views or quick</span>
<a href="#l137.194"></a><span id="l137.194" class="difflineplus">+   *  searches, we will most definitely perform an offline search.  If</span>
<a href="#l137.195"></a><span id="l137.195" class="difflineplus">+   *  onlineSearch is true, we will perform an online search only for folders</span>
<a href="#l137.196"></a><span id="l137.196" class="difflineplus">+   *  which are not available offline and for which the server is configured</span>
<a href="#l137.197"></a><span id="l137.197" class="difflineplus">+   *  to have an online 'searchScope'.</span>
<a href="#l137.198"></a><span id="l137.198" class="difflineplus">+   * When mail views or quick searches are in effect our search is always</span>
<a href="#l137.199"></a><span id="l137.199" class="difflineplus">+   *  offline unless the only way to satisfy the needs of the constraints is an</span>
<a href="#l137.200"></a><span id="l137.200" class="difflineplus">+   *  online search (read: the message body is required but not available</span>
<a href="#l137.201"></a><span id="l137.201" class="difflineplus">+   *  offline.)</span>
<a href="#l137.202"></a><span id="l137.202" class="difflineplus">+   */</span>
<a href="#l137.203"></a><span id="l137.203">   set onlineSearch(aOnlineSearch) {</span>
<a href="#l137.204"></a><span id="l137.204">     this._onlineSearch = aOnlineSearch;</span>
<a href="#l137.205"></a><span id="l137.205">   },</span>
<a href="#l137.206"></a><span id="l137.206"> </span>
<a href="#l137.207"></a><span id="l137.207">   /**</span>
<a href="#l137.208"></a><span id="l137.208">    * Populate the search session using viewTerms, virtualFolderTerms, and</span>
<a href="#l137.209"></a><span id="l137.209">    *  userTerms.  The way this works is that each of the 'context' sets of</span>
<a href="#l137.210"></a><span id="l137.210">    *  terms gets wrapped into a group which is boolean anded together with</span>
<a href="#l137.211"></a><span id="l137.211" class="difflineat">@@ -261,53 +314,82 @@ SearchSpec.prototype = {</span>
<a href="#l137.212"></a><span id="l137.212">    */</span>
<a href="#l137.213"></a><span id="l137.213">   updateSession: function SearchSpec_applySearch() {</span>
<a href="#l137.214"></a><span id="l137.214">     let session = this.session;</span>
<a href="#l137.215"></a><span id="l137.215"> </span>
<a href="#l137.216"></a><span id="l137.216">     // clear out our current terms and scope</span>
<a href="#l137.217"></a><span id="l137.217">     session.searchTerms.QueryInterface(Ci.nsISupportsArray).Clear();</span>
<a href="#l137.218"></a><span id="l137.218">     session.clearScopes();</span>
<a href="#l137.219"></a><span id="l137.219"> </span>
<a href="#l137.220"></a><span id="l137.220" class="difflineplus">+    // the scope logic needs to know if any terms look at the body attribute.</span>
<a href="#l137.221"></a><span id="l137.221" class="difflineplus">+    let haveBodyTerm = false;</span>
<a href="#l137.222"></a><span id="l137.222" class="difflineplus">+</span>
<a href="#l137.223"></a><span id="l137.223">     // -- apply terms</span>
<a href="#l137.224"></a><span id="l137.224">     if (this._virtualFolderTerms) {</span>
<a href="#l137.225"></a><span id="l137.225">       for each (let term in fixIterator(this._virtualFolderTerms,</span>
<a href="#l137.226"></a><span id="l137.226">                                         nsIMsgSearchTerm)) {</span>
<a href="#l137.227"></a><span id="l137.227" class="difflineplus">+        if (term.attrib == nsMsgSearchAttrib.Body)</span>
<a href="#l137.228"></a><span id="l137.228" class="difflineplus">+          haveBodyTerm = true;</span>
<a href="#l137.229"></a><span id="l137.229">         session.appendTerm(term);</span>
<a href="#l137.230"></a><span id="l137.230">       }</span>
<a href="#l137.231"></a><span id="l137.231">     }</span>
<a href="#l137.232"></a><span id="l137.232"> </span>
<a href="#l137.233"></a><span id="l137.233">     if (this._viewTerms) {</span>
<a href="#l137.234"></a><span id="l137.234">       for each (let term in fixIterator(this._viewTerms,</span>
<a href="#l137.235"></a><span id="l137.235">                                         nsIMsgSearchTerm)) {</span>
<a href="#l137.236"></a><span id="l137.236" class="difflineplus">+        if (term.attrib == nsMsgSearchAttrib.Body)</span>
<a href="#l137.237"></a><span id="l137.237" class="difflineplus">+          haveBodyTerm = true;</span>
<a href="#l137.238"></a><span id="l137.238">         session.appendTerm(term);</span>
<a href="#l137.239"></a><span id="l137.239">       }</span>
<a href="#l137.240"></a><span id="l137.240">     }</span>
<a href="#l137.241"></a><span id="l137.241"> </span>
<a href="#l137.242"></a><span id="l137.242">     if (this._userTerms) {</span>
<a href="#l137.243"></a><span id="l137.243">       for each (let term in fixIterator(this._userTerms,</span>
<a href="#l137.244"></a><span id="l137.244">                                         nsIMsgSearchTerm)) {</span>
<a href="#l137.245"></a><span id="l137.245" class="difflineplus">+        if (term.attrib == nsMsgSearchAttrib.Body)</span>
<a href="#l137.246"></a><span id="l137.246" class="difflineplus">+          haveBodyTerm = true;</span>
<a href="#l137.247"></a><span id="l137.247">         session.appendTerm(term);</span>
<a href="#l137.248"></a><span id="l137.248">       }</span>
<a href="#l137.249"></a><span id="l137.249">     }</span>
<a href="#l137.250"></a><span id="l137.250"> </span>
<a href="#l137.251"></a><span id="l137.251">     // -- apply scopes</span>
<a href="#l137.252"></a><span id="l137.252" class="difflineminus">-    // if the folder is local, the folder is marked for offline access, or we</span>
<a href="#l137.253"></a><span id="l137.253" class="difflineminus">-    //  are offline, then perform an offline search.</span>
<a href="#l137.254"></a><span id="l137.254" class="difflineminus">-    // otherwise, rely on the server's search scope. if we were more thorough,</span>
<a href="#l137.255"></a><span id="l137.255" class="difflineminus">-    //  we could try and figure out what operands cause us to fall back toward</span>
<a href="#l137.256"></a><span id="l137.256" class="difflineminus">-    //  online usage.  (quick search previously specialized this by virtue of</span>
<a href="#l137.257"></a><span id="l137.257" class="difflineminus">-    //  having a very limited set of terms in use.)</span>
<a href="#l137.258"></a><span id="l137.258" class="difflineplus">+    // We are filtering if we have mail view terms or user terms.  When</span>
<a href="#l137.259"></a><span id="l137.259" class="difflineplus">+    //  filtering, we bias towards offline search.  The only time we would use</span>
<a href="#l137.260"></a><span id="l137.260" class="difflineplus">+    //  an online search when filtering is if one of the constraints uses the</span>
<a href="#l137.261"></a><span id="l137.261" class="difflineplus">+    //  body attribute and the folder is not marked for offline access.</span>
<a href="#l137.262"></a><span id="l137.262" class="difflineplus">+    // We are not filtering if we only have virtual folder terms, in which case</span>
<a href="#l137.263"></a><span id="l137.263" class="difflineplus">+    //  we honor the onlineSearch attribute.  This means that we use the</span>
<a href="#l137.264"></a><span id="l137.264" class="difflineplus">+    //  folder's server's searchScope if the folder is not explicitly marked</span>
<a href="#l137.265"></a><span id="l137.265" class="difflineplus">+    //  offline.</span>
<a href="#l137.266"></a><span id="l137.266" class="difflineplus">+    // For further discussion on this choice of logic, please read from:</span>
<a href="#l137.267"></a><span id="l137.267" class="difflineplus">+    //  https://bugzilla.mozilla.org/show_bug.cgi?id=474701#c73</span>
<a href="#l137.268"></a><span id="l137.268" class="difflineplus">+    let filtering = this._virtualFolderTerms == null &amp;&amp;</span>
<a href="#l137.269"></a><span id="l137.269" class="difflineplus">+                    this._viewTerms == null;</span>
<a href="#l137.270"></a><span id="l137.270" class="difflineplus">+</span>
<a href="#l137.271"></a><span id="l137.271">     let ioService = Cc[&quot;@mozilla.org/network/io-service;1&quot;]</span>
<a href="#l137.272"></a><span id="l137.272">                       .getService(Ci.nsIIOService);</span>
<a href="#l137.273"></a><span id="l137.273">     for each (let [, folder] in Iterator(this.owner._underlyingFolders)) {</span>
<a href="#l137.274"></a><span id="l137.274" class="difflineplus">+      // we do not need to check isServer here because _underlyingFolders</span>
<a href="#l137.275"></a><span id="l137.275" class="difflineplus">+      //  filtered it out when it was initialized.</span>
<a href="#l137.276"></a><span id="l137.276" class="difflineplus">+</span>
<a href="#l137.277"></a><span id="l137.277">       let scope;</span>
<a href="#l137.278"></a><span id="l137.278" class="difflineminus">-      if ((folder instanceof nsIMsgLocalMailFolder) ||</span>
<a href="#l137.279"></a><span id="l137.279" class="difflineminus">-        (folder.flags &amp; nsMsgFolderFlags.Offline) ||</span>
<a href="#l137.280"></a><span id="l137.280" class="difflineminus">-          ioService.offline)</span>
<a href="#l137.281"></a><span id="l137.281" class="difflineplus">+      let folderIsOffline = (folder instanceof nsIMsgLocalMailFolder) ||</span>
<a href="#l137.282"></a><span id="l137.282" class="difflineplus">+                            (folder.flags &amp; nsMsgFolderFlags.Offline) ||</span>
<a href="#l137.283"></a><span id="l137.283" class="difflineplus">+                            ioService.offline;</span>
<a href="#l137.284"></a><span id="l137.284" class="difflineplus">+      // To restate the above logic into simpler rules, the scope is definitely</span>
<a href="#l137.285"></a><span id="l137.285" class="difflineplus">+      //  offline if:</span>
<a href="#l137.286"></a><span id="l137.286" class="difflineplus">+      // - Folders available offline always use offline search.</span>
<a href="#l137.287"></a><span id="l137.287" class="difflineplus">+      // - If we are filtering and don't have a body term, use offline search.</span>
<a href="#l137.288"></a><span id="l137.288" class="difflineplus">+      // - If we are not filtering and our virtual folder is not marked for</span>
<a href="#l137.289"></a><span id="l137.289" class="difflineplus">+      //   onlineSearch.</span>
<a href="#l137.290"></a><span id="l137.290" class="difflineplus">+      if (folderIsOffline ||</span>
<a href="#l137.291"></a><span id="l137.291" class="difflineplus">+          (filtering &amp;&amp; !haveBodyTerm) ||</span>
<a href="#l137.292"></a><span id="l137.292" class="difflineplus">+          (!filtering &amp;&amp; !this.onlineSearch))</span>
<a href="#l137.293"></a><span id="l137.293">         scope = nsMsgSearchScope.offlineMail;</span>
<a href="#l137.294"></a><span id="l137.294" class="difflineplus">+      // Otherwise, it's up to the folder's sever's searchScope.</span>
<a href="#l137.295"></a><span id="l137.295">       else</span>
<a href="#l137.296"></a><span id="l137.296">         scope = folder.server.searchScope;</span>
<a href="#l137.297"></a><span id="l137.297">       session.addScopeTerm(scope, folder);</span>
<a href="#l137.298"></a><span id="l137.298">     }</span>
<a href="#l137.299"></a><span id="l137.299">   },</span>
<a href="#l137.300"></a><span id="l137.300"> </span>
<a href="#l137.301"></a><span id="l137.301">   prettyStringOfSearchTerms: function(aSearchTerms) {</span>
<a href="#l137.302"></a><span id="l137.302">     if (aSearchTerms == null)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l138.1"></a><span id="l138.1" class="difflineminus">--- a/mailnews/base/src/virtualFolderWrapper.js</span>
<a href="#l138.2"></a><span id="l138.2" class="difflineplus">+++ b/mailnews/base/src/virtualFolderWrapper.js</span>
<a href="#l138.3"></a><span id="l138.3" class="difflineat">@@ -61,17 +61,19 @@ var VirtualFolderHelper = {</span>
<a href="#l138.4"></a><span id="l138.4">    * If the call to addSubfolder fails (and therefore throws), we will NOT catch</span>
<a href="#l138.5"></a><span id="l138.5">    *  it.</span>
<a href="#l138.6"></a><span id="l138.6">    *</span>
<a href="#l138.7"></a><span id="l138.7">    * @param aFolderName The name of the new folder to create.</span>
<a href="#l138.8"></a><span id="l138.8">    * @param aParentFolder The folder in which to create the search folder.</span>
<a href="#l138.9"></a><span id="l138.9">    * @param aSearchFolders A list of nsIMsgFolders that you want to use as the</span>
<a href="#l138.10"></a><span id="l138.10">    *     sources for the virtual folder OR a string that is the already '|'</span>
<a href="#l138.11"></a><span id="l138.11">    *     delimited list of folder URIs to use.</span>
<a href="#l138.12"></a><span id="l138.12" class="difflineminus">-   * @param aSearchTerms The search terms to use for the virtual folder.</span>
<a href="#l138.13"></a><span id="l138.13" class="difflineplus">+   * @param aSearchTerms The search terms to use for the virtual folder.  This</span>
<a href="#l138.14"></a><span id="l138.14" class="difflineplus">+   *     should be a JS list/nsIMutableArray/nsISupportsArray of</span>
<a href="#l138.15"></a><span id="l138.15" class="difflineplus">+   *     nsIMsgSearchTermbs.</span>
<a href="#l138.16"></a><span id="l138.16">    * @param aOnlineSearch Should the search attempt to use the server's search</span>
<a href="#l138.17"></a><span id="l138.17">    *     capabilities when possible and appropriate?</span>
<a href="#l138.18"></a><span id="l138.18">    *</span>
<a href="#l138.19"></a><span id="l138.19">    * @return The VirtualFolderWrapper wrapping the newly created folder.  You</span>
<a href="#l138.20"></a><span id="l138.20">    *     would probably only want this for its virtualFolder attribute which has</span>
<a href="#l138.21"></a><span id="l138.21">    *     the nsIMsgFolder we created.  Be careful about accessing any of the</span>
<a href="#l138.22"></a><span id="l138.22">    *     other attributes, as they will bring its message database back to life.</span>
<a href="#l138.23"></a><span id="l138.23">    */</span>
<a href="#l138.24"></a><span id="l138.24" class="difflineat">@@ -160,70 +162,135 @@ VirtualFolderWrapper.prototype = {</span>
<a href="#l138.25"></a><span id="l138.25">       this.dbFolderInfo.getCharProperty(&quot;searchFolderUri&quot;).split(&quot;|&quot;);</span>
<a href="#l138.26"></a><span id="l138.26">     let folders = [];</span>
<a href="#l138.27"></a><span id="l138.27">     for each (let [, folderURI] in Iterator(virtualFolderUris)) {</span>
<a href="#l138.28"></a><span id="l138.28">       folders.push(rdfService.GetResource(folderURI)</span>
<a href="#l138.29"></a><span id="l138.29">                              .QueryInterface(Ci.nsIMsgFolder));</span>
<a href="#l138.30"></a><span id="l138.30">     }</span>
<a href="#l138.31"></a><span id="l138.31">     return folders;</span>
<a href="#l138.32"></a><span id="l138.32">   },</span>
<a href="#l138.33"></a><span id="l138.33" class="difflineplus">+  /**</span>
<a href="#l138.34"></a><span id="l138.34" class="difflineplus">+   * Set the search folders that back this virtual folder.</span>
<a href="#l138.35"></a><span id="l138.35" class="difflineplus">+   *</span>
<a href="#l138.36"></a><span id="l138.36" class="difflineplus">+   * @param aFolders Either a &quot;|&quot;-delimited string of folder URIs or a list of</span>
<a href="#l138.37"></a><span id="l138.37" class="difflineplus">+   *     nsIMsgFolders that fixIterator can traverse (JS array/nsIMutableArray/</span>
<a href="#l138.38"></a><span id="l138.38" class="difflineplus">+   *     nsISupportsArray).</span>
<a href="#l138.39"></a><span id="l138.39" class="difflineplus">+   */</span>
<a href="#l138.40"></a><span id="l138.40">   set searchFolders(aFolders) {</span>
<a href="#l138.41"></a><span id="l138.41">     if (typeof(aFolders) == &quot;string&quot;) {</span>
<a href="#l138.42"></a><span id="l138.42">       this.dbFolderInfo.setCharProperty(&quot;searchFolderUri&quot;, aFolders);</span>
<a href="#l138.43"></a><span id="l138.43">     }</span>
<a href="#l138.44"></a><span id="l138.44">     else {</span>
<a href="#l138.45"></a><span id="l138.45" class="difflineminus">-      let uris = [folder.URI for each ([, folder] in Iterator(aFolders))];</span>
<a href="#l138.46"></a><span id="l138.46" class="difflineplus">+      let uris = [folder.URI for each (folder in fixIterator(aFolders,</span>
<a href="#l138.47"></a><span id="l138.47" class="difflineplus">+                                                             Ci.nsIMsgFolder))];</span>
<a href="#l138.48"></a><span id="l138.48">       this.dbFolderInfo.setCharProperty(&quot;searchFolderUri&quot;, uris.join(&quot;|&quot;));</span>
<a href="#l138.49"></a><span id="l138.49">     }</span>
<a href="#l138.50"></a><span id="l138.50">   },</span>
<a href="#l138.51"></a><span id="l138.51"> </span>
<a href="#l138.52"></a><span id="l138.52">   /**</span>
<a href="#l138.53"></a><span id="l138.53" class="difflineplus">+   * @return a &quot;|&quot;-delimited string containing the URIs of the folders that back</span>
<a href="#l138.54"></a><span id="l138.54" class="difflineplus">+   *     this virtual folder.</span>
<a href="#l138.55"></a><span id="l138.55" class="difflineplus">+   */</span>
<a href="#l138.56"></a><span id="l138.56" class="difflineplus">+  get searchFolderURIs() {</span>
<a href="#l138.57"></a><span id="l138.57" class="difflineplus">+    return this.dbFolderInfo.getCharProperty(&quot;searchFolderUri&quot;);</span>
<a href="#l138.58"></a><span id="l138.58" class="difflineplus">+  },</span>
<a href="#l138.59"></a><span id="l138.59" class="difflineplus">+</span>
<a href="#l138.60"></a><span id="l138.60" class="difflineplus">+  /**</span>
<a href="#l138.61"></a><span id="l138.61">    * @return the list of search terms that define this virtual folder.</span>
<a href="#l138.62"></a><span id="l138.62">    */</span>
<a href="#l138.63"></a><span id="l138.63">   get searchTerms() {</span>
<a href="#l138.64"></a><span id="l138.64" class="difflineplus">+    return this.searchTermsSession.searchTerms;</span>
<a href="#l138.65"></a><span id="l138.65" class="difflineplus">+  },</span>
<a href="#l138.66"></a><span id="l138.66" class="difflineplus">+  /**</span>
<a href="#l138.67"></a><span id="l138.67" class="difflineplus">+   * @return a newly created filter with the search terms loaded into it that</span>
<a href="#l138.68"></a><span id="l138.68" class="difflineplus">+   *     define this virtual folder.  The filter is apparently useful as an</span>
<a href="#l138.69"></a><span id="l138.69" class="difflineplus">+   *     nsIMsgSearchSession stand-in to some code.</span>
<a href="#l138.70"></a><span id="l138.70" class="difflineplus">+   */</span>
<a href="#l138.71"></a><span id="l138.71" class="difflineplus">+  get searchTermsSession() {</span>
<a href="#l138.72"></a><span id="l138.72">     let filterService =</span>
<a href="#l138.73"></a><span id="l138.73">       Cc[&quot;@mozilla.org/messenger/services/filters;1&quot;]</span>
<a href="#l138.74"></a><span id="l138.74">         .getService(Ci.nsIMsgFilterService);</span>
<a href="#l138.75"></a><span id="l138.75">     // Temporary means it doesn't get exposed to the UI and doesn't get saved to</span>
<a href="#l138.76"></a><span id="l138.76">     //  disk.  Which is good, because this is just a trick to parse the string</span>
<a href="#l138.77"></a><span id="l138.77">     //  into search terms.</span>
<a href="#l138.78"></a><span id="l138.78">     let filterList = filterService.getTempFilterList(this.virtualFolder);</span>
<a href="#l138.79"></a><span id="l138.79">     let tempFilter = filterList.createFilter(&quot;temp&quot;);</span>
<a href="#l138.80"></a><span id="l138.80">     filterList.parseCondition(tempFilter, this.searchString);</span>
<a href="#l138.81"></a><span id="l138.81" class="difflineminus">-    return tempFilter.searchTerms;</span>
<a href="#l138.82"></a><span id="l138.82" class="difflineplus">+    return tempFilter;</span>
<a href="#l138.83"></a><span id="l138.83">   },</span>
<a href="#l138.84"></a><span id="l138.84" class="difflineplus">+</span>
<a href="#l138.85"></a><span id="l138.85">   /**</span>
<a href="#l138.86"></a><span id="l138.86">    * Set the search string for this virtual folder to the stringified version of</span>
<a href="#l138.87"></a><span id="l138.87" class="difflineminus">-   *  the provided list of search terms.</span>
<a href="#l138.88"></a><span id="l138.88" class="difflineplus">+   *  the provided list of nsIMsgSearchTerm search terms.  If you already have</span>
<a href="#l138.89"></a><span id="l138.89" class="difflineplus">+   *  a strinigified version of the search constraint, just set |searchString|</span>
<a href="#l138.90"></a><span id="l138.90" class="difflineplus">+   *  directly.</span>
<a href="#l138.91"></a><span id="l138.91" class="difflineplus">+   *</span>
<a href="#l138.92"></a><span id="l138.92" class="difflineplus">+   * @param aTerms Some collection that fixIterator can traverse.  A JS list or</span>
<a href="#l138.93"></a><span id="l138.93" class="difflineplus">+   *     XPCOM array (nsIMutableArray or nsISupportsArray) should work.</span>
<a href="#l138.94"></a><span id="l138.94">    */</span>
<a href="#l138.95"></a><span id="l138.95">   set searchTerms(aTerms) {</span>
<a href="#l138.96"></a><span id="l138.96">     let condition = &quot;&quot;;</span>
<a href="#l138.97"></a><span id="l138.97">     for (let term in fixIterator(aTerms, Ci.nsIMsgSearchTerm)) {</span>
<a href="#l138.98"></a><span id="l138.98">       if (condition.length)</span>
<a href="#l138.99"></a><span id="l138.99">         condition += &quot; &quot;;</span>
<a href="#l138.100"></a><span id="l138.100">       if (term.matchAll) {</span>
<a href="#l138.101"></a><span id="l138.101">         condition = &quot;ALL&quot;;</span>
<a href="#l138.102"></a><span id="l138.102">         break;</span>
<a href="#l138.103"></a><span id="l138.103">       }</span>
<a href="#l138.104"></a><span id="l138.104">       condition += (term.booleanAnd) ? &quot;AND (&quot; : &quot;OR (&quot;;</span>
<a href="#l138.105"></a><span id="l138.105">       condition += term.termAsString + &quot;)&quot;;</span>
<a href="#l138.106"></a><span id="l138.106">     }</span>
<a href="#l138.107"></a><span id="l138.107">     this.searchString = condition;</span>
<a href="#l138.108"></a><span id="l138.108">   },</span>
<a href="#l138.109"></a><span id="l138.109"> </span>
<a href="#l138.110"></a><span id="l138.110" class="difflineplus">+  /**</span>
<a href="#l138.111"></a><span id="l138.111" class="difflineplus">+   * @return the set of search terms that define this virtual folder as a</span>
<a href="#l138.112"></a><span id="l138.112" class="difflineplus">+   *     string.  You may prefer to use |searchTerms| which converts them</span>
<a href="#l138.113"></a><span id="l138.113" class="difflineplus">+   *     into a list of nsIMsgSearchTerms instead.</span>
<a href="#l138.114"></a><span id="l138.114" class="difflineplus">+   */</span>
<a href="#l138.115"></a><span id="l138.115">   get searchString() {</span>
<a href="#l138.116"></a><span id="l138.116">     return this.dbFolderInfo.getCharProperty(&quot;searchStr&quot;);</span>
<a href="#l138.117"></a><span id="l138.117">   },</span>
<a href="#l138.118"></a><span id="l138.118" class="difflineplus">+  /**</span>
<a href="#l138.119"></a><span id="l138.119" class="difflineplus">+   * Set the search that defines this virtual folder from a string.  If you have</span>
<a href="#l138.120"></a><span id="l138.120" class="difflineplus">+   *  a list of nsIMsgSearchTerms, you should use |searchTerms| instead.</span>
<a href="#l138.121"></a><span id="l138.121" class="difflineplus">+   */</span>
<a href="#l138.122"></a><span id="l138.122">   set searchString(aSearchString) {</span>
<a href="#l138.123"></a><span id="l138.123">     this.dbFolderInfo.setCharProperty(&quot;searchStr&quot;, aSearchString);</span>
<a href="#l138.124"></a><span id="l138.124">   },</span>
<a href="#l138.125"></a><span id="l138.125"> </span>
<a href="#l138.126"></a><span id="l138.126" class="difflineplus">+  /**</span>
<a href="#l138.127"></a><span id="l138.127" class="difflineplus">+   * @return whether the virtual folder is configured for online search.</span>
<a href="#l138.128"></a><span id="l138.128" class="difflineplus">+   */</span>
<a href="#l138.129"></a><span id="l138.129">   get onlineSearch() {</span>
<a href="#l138.130"></a><span id="l138.130">     return this.dbFolderInfo.getBooleanProperty(&quot;searchOnline&quot;, false);</span>
<a href="#l138.131"></a><span id="l138.131">   },</span>
<a href="#l138.132"></a><span id="l138.132" class="difflineplus">+  /**</span>
<a href="#l138.133"></a><span id="l138.133" class="difflineplus">+   * Set whether the virtual folder is configured for online search.</span>
<a href="#l138.134"></a><span id="l138.134" class="difflineplus">+   */</span>
<a href="#l138.135"></a><span id="l138.135">   set onlineSearch(aOnlineSearch) {</span>
<a href="#l138.136"></a><span id="l138.136">     this.dbFolderInfo.setBooleanProperty(&quot;searchOnline&quot;, aOnlineSearch);</span>
<a href="#l138.137"></a><span id="l138.137">   },</span>
<a href="#l138.138"></a><span id="l138.138"> </span>
<a href="#l138.139"></a><span id="l138.139" class="difflineplus">+  /**</span>
<a href="#l138.140"></a><span id="l138.140" class="difflineplus">+   * @return the dBFolderInfo associated with the virtual folder directly.  May</span>
<a href="#l138.141"></a><span id="l138.141" class="difflineplus">+   *     be null.  Will cause the message database to be opened, which may have</span>
<a href="#l138.142"></a><span id="l138.142" class="difflineplus">+   *     memory bloat/leak ramifications, so make sure the folder's database was</span>
<a href="#l138.143"></a><span id="l138.143" class="difflineplus">+   *     already going to be opened anyways or that you call</span>
<a href="#l138.144"></a><span id="l138.144" class="difflineplus">+   *     |cleanUpMessageDatabase|.</span>
<a href="#l138.145"></a><span id="l138.145" class="difflineplus">+   */</span>
<a href="#l138.146"></a><span id="l138.146">   get dbFolderInfo() {</span>
<a href="#l138.147"></a><span id="l138.147" class="difflineminus">-    return this.virtualFolder.msgDatabase.dBFolderInfo;</span>
<a href="#l138.148"></a><span id="l138.148" class="difflineplus">+    let msgDatabase = this.virtualFolder.msgDatabase;</span>
<a href="#l138.149"></a><span id="l138.149" class="difflineplus">+    return (msgDatabase &amp;&amp; msgDatabase.dBFolderInfo);</span>
<a href="#l138.150"></a><span id="l138.150" class="difflineplus">+  },</span>
<a href="#l138.151"></a><span id="l138.151" class="difflineplus">+</span>
<a href="#l138.152"></a><span id="l138.152" class="difflineplus">+  /**</span>
<a href="#l138.153"></a><span id="l138.153" class="difflineplus">+   * Avoid memory bloat by making the virtual folder forget about its database.</span>
<a href="#l138.154"></a><span id="l138.154" class="difflineplus">+   *  If the database is actually in use (read: someone is keeping it alive by</span>
<a href="#l138.155"></a><span id="l138.155" class="difflineplus">+   *  having references to it from places other than the nsIMsgFolder), the</span>
<a href="#l138.156"></a><span id="l138.156" class="difflineplus">+   *  folder will be able to re-establish the reference for minimal cost.</span>
<a href="#l138.157"></a><span id="l138.157" class="difflineplus">+   */</span>
<a href="#l138.158"></a><span id="l138.158" class="difflineplus">+  cleanUpMessageDatabase:</span>
<a href="#l138.159"></a><span id="l138.159" class="difflineplus">+      function VirtualFolderWrapper_cleanUpMessageDatabase() {</span>
<a href="#l138.160"></a><span id="l138.160" class="difflineplus">+    this.virtualFolder.msgDatabase.Close(true);</span>
<a href="#l138.161"></a><span id="l138.161" class="difflineplus">+    this.virtualFolder.msgDatabase = null;</span>
<a href="#l138.162"></a><span id="l138.162">   }</span>
<a href="#l138.163"></a><span id="l138.163"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l139.1"></a><span id="l139.1">new file mode 100644</span>
<a href="#l139.2"></a><span id="l139.2" class="difflineminus">--- /dev/null</span>
<a href="#l139.3"></a><span id="l139.3" class="difflineplus">+++ b/mailnews/base/test/unit/tail_base.js</span>
<a href="#l139.4"></a><span id="l139.4" class="difflineat">@@ -0,0 +1,1 @@</span>
<a href="#l139.5"></a><span id="l139.5" class="difflineplus">+load(&quot;../../mailnews/resources/mailShutdown.js&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l140.1"></a><span id="l140.1" class="difflineminus">--- a/mailnews/base/test/unit/test_bccInDatabase.js</span>
<a href="#l140.2"></a><span id="l140.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_bccInDatabase.js</span>
<a href="#l140.3"></a><span id="l140.3" class="difflineat">@@ -66,11 +66,12 @@ function run_test()</span>
<a href="#l140.4"></a><span id="l140.4"> function continueTest()</span>
<a href="#l140.5"></a><span id="l140.5"> {</span>
<a href="#l140.6"></a><span id="l140.6">   //dump(&quot;\nbccList &gt;&quot; + hdr.bccList);</span>
<a href="#l140.7"></a><span id="l140.7">   //dump(&quot;\nccList &gt;&quot; + hdr.ccList);</span>
<a href="#l140.8"></a><span id="l140.8">   //dump(&quot;\n&quot;);</span>
<a href="#l140.9"></a><span id="l140.9">   do_check_true(hdr.bccList.indexOf(&quot;Another Person&quot;) &gt;= 0);</span>
<a href="#l140.10"></a><span id="l140.10">   do_check_true(hdr.bccList.indexOf(&quot;&lt;u1@example.com&gt;&quot;) &gt;= 0);</span>
<a href="#l140.11"></a><span id="l140.11">   do_check_false(hdr.bccList.indexOf(&quot;IDoNotExist&quot;) &gt;=0);</span>
<a href="#l140.12"></a><span id="l140.12" class="difflineplus">+  hdr = null;</span>
<a href="#l140.13"></a><span id="l140.13">   do_test_finished();</span>
<a href="#l140.14"></a><span id="l140.14"> }</span>
<a href="#l140.15"></a><span id="l140.15"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l141.1"></a><span id="l141.1" class="difflineminus">--- a/mailnews/base/test/unit/test_bug428427.js</span>
<a href="#l141.2"></a><span id="l141.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_bug428427.js</span>
<a href="#l141.3"></a><span id="l141.3" class="difflineat">@@ -189,17 +189,20 @@ function testVirtualFolder()</span>
<a href="#l141.4"></a><span id="l141.4">    </span>
<a href="#l141.5"></a><span id="l141.5">   // remove tag from one item to decrease count</span>
<a href="#l141.6"></a><span id="l141.6">   var message1 = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(Ci.nsIMutableArray);</span>
<a href="#l141.7"></a><span id="l141.7">   message1.appendElement(hdrs[1], false);</span>
<a href="#l141.8"></a><span id="l141.8"> </span>
<a href="#l141.9"></a><span id="l141.9">   gLocalInboxFolder.removeKeywordsFromMessages(message1, tag1);</span>
<a href="#l141.10"></a><span id="l141.10">   do_check_eq(3, virtualFolder.getTotalMessages(false));</span>
<a href="#l141.11"></a><span id="l141.11">   do_check_eq(1, virtualFolder.getNumUnread(false));</span>
<a href="#l141.12"></a><span id="l141.12" class="difflineminus">-  </span>
<a href="#l141.13"></a><span id="l141.13" class="difflineplus">+</span>
<a href="#l141.14"></a><span id="l141.14" class="difflineplus">+  // End of test, so release our header references</span>
<a href="#l141.15"></a><span id="l141.15" class="difflineplus">+  hdrs = null;</span>
<a href="#l141.16"></a><span id="l141.16" class="difflineplus">+</span>
<a href="#l141.17"></a><span id="l141.17">   do_test_finished();</span>
<a href="#l141.18"></a><span id="l141.18">   return true;</span>
<a href="#l141.19"></a><span id="l141.19"> }</span>
<a href="#l141.20"></a><span id="l141.20"> </span>
<a href="#l141.21"></a><span id="l141.21"> // helper functions</span>
<a href="#l141.22"></a><span id="l141.22"> </span>
<a href="#l141.23"></a><span id="l141.23"> // adapted from commandglue.js</span>
<a href="#l141.24"></a><span id="l141.24"> function CreateVirtualFolder(newName, parentFolder, searchFolderURIs, searchTerm, searchOnline)</span>
<a href="#l141.25"></a><span id="l141.25" class="difflineat">@@ -255,9 +258,8 @@ function makeSearchTerm(aFolder, aStrVal</span>
<a href="#l141.26"></a><span id="l141.26">   value.str = aStrValue;</span>
<a href="#l141.27"></a><span id="l141.27">   searchTerm.value = value;</span>
<a href="#l141.28"></a><span id="l141.28">   searchTerm.attrib = aAttrib;</span>
<a href="#l141.29"></a><span id="l141.29">   searchTerm.op = aOp;</span>
<a href="#l141.30"></a><span id="l141.30">   searchTerm.booleanAnd = false;</span>
<a href="#l141.31"></a><span id="l141.31">   searchSession = null;</span>
<a href="#l141.32"></a><span id="l141.32">   return searchTerm;</span>
<a href="#l141.33"></a><span id="l141.33"> }</span>
<a href="#l141.34"></a><span id="l141.34" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l142.1"></a><span id="l142.1" class="difflineminus">--- a/mailnews/base/test/unit/test_bug471682.js</span>
<a href="#l142.2"></a><span id="l142.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_bug471682.js</span>
<a href="#l142.3"></a><span id="l142.3" class="difflineat">@@ -116,11 +116,13 @@ var step5 =</span>
<a href="#l142.4"></a><span id="l142.4">   {</span>
<a href="#l142.5"></a><span id="l142.5">     var dbSize = gSubfolder.msgDatabase.dBFolderInfo.folderSize;</span>
<a href="#l142.6"></a><span id="l142.6">     var dbDate = gSubfolder.msgDatabase.dBFolderInfo.folderDate;</span>
<a href="#l142.7"></a><span id="l142.7">     var filePath = gSubfolder.filePath;</span>
<a href="#l142.8"></a><span id="l142.8">     var date = parseInt(filePath.lastModifiedTime/1000);</span>
<a href="#l142.9"></a><span id="l142.9">     var size = filePath.fileSize;</span>
<a href="#l142.10"></a><span id="l142.10">     do_check_eq(size, dbSize);</span>
<a href="#l142.11"></a><span id="l142.11">     do_check_eq(date, dbDate);</span>
<a href="#l142.12"></a><span id="l142.12" class="difflineplus">+    // End of test, so release our header reference</span>
<a href="#l142.13"></a><span id="l142.13" class="difflineplus">+    gHdr = null;</span>
<a href="#l142.14"></a><span id="l142.14">     do_test_finished();</span>
<a href="#l142.15"></a><span id="l142.15">   }</span>
<a href="#l142.16"></a><span id="l142.16"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l143.1"></a><span id="l143.1">new file mode 100644</span>
<a href="#l143.2"></a><span id="l143.2" class="difflineminus">--- /dev/null</span>
<a href="#l143.3"></a><span id="l143.3" class="difflineplus">+++ b/mailnews/base/test/unit/test_emptyTrash.js</span>
<a href="#l143.4"></a><span id="l143.4" class="difflineat">@@ -0,0 +1,171 @@</span>
<a href="#l143.5"></a><span id="l143.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l143.6"></a><span id="l143.6" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l143.7"></a><span id="l143.7" class="difflineplus">+ *</span>
<a href="#l143.8"></a><span id="l143.8" class="difflineplus">+ * Any copyright is dedicated to the Public Domain.</span>
<a href="#l143.9"></a><span id="l143.9" class="difflineplus">+ * http://creativecommons.org/licenses/publicdomain/</span>
<a href="#l143.10"></a><span id="l143.10" class="difflineplus">+ *</span>
<a href="#l143.11"></a><span id="l143.11" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l143.12"></a><span id="l143.12" class="difflineplus">+</span>
<a href="#l143.13"></a><span id="l143.13" class="difflineplus">+ /*</span>
<a href="#l143.14"></a><span id="l143.14" class="difflineplus">+  * Test suite for empty trash</span>
<a href="#l143.15"></a><span id="l143.15" class="difflineplus">+  *</span>
<a href="#l143.16"></a><span id="l143.16" class="difflineplus">+  * Currently tested:</span>
<a href="#l143.17"></a><span id="l143.17" class="difflineplus">+  * - Empty local trash</span>
<a href="#l143.18"></a><span id="l143.18" class="difflineplus">+  * TODO</span>
<a href="#l143.19"></a><span id="l143.19" class="difflineplus">+  * - Empty imap trash</span>
<a href="#l143.20"></a><span id="l143.20" class="difflineplus">+  */</span>
<a href="#l143.21"></a><span id="l143.21" class="difflineplus">+</span>
<a href="#l143.22"></a><span id="l143.22" class="difflineplus">+// Globals</span>
<a href="#l143.23"></a><span id="l143.23" class="difflineplus">+var gMsgFile1;</span>
<a href="#l143.24"></a><span id="l143.24" class="difflineplus">+var gLocalTrashFolder;</span>
<a href="#l143.25"></a><span id="l143.25" class="difflineplus">+var gCurTestNum;</span>
<a href="#l143.26"></a><span id="l143.26" class="difflineplus">+var gMsgHdrs = new Array();</span>
<a href="#l143.27"></a><span id="l143.27" class="difflineplus">+</span>
<a href="#l143.28"></a><span id="l143.28" class="difflineplus">+const mFNSContractID = &quot;@mozilla.org/messenger/msgnotificationservice;1&quot;;</span>
<a href="#l143.29"></a><span id="l143.29" class="difflineplus">+const nsIMFNService = Ci.nsIMsgFolderNotificationService;</span>
<a href="#l143.30"></a><span id="l143.30" class="difflineplus">+const nsIMFListener = Ci.nsIMsgFolderListener;</span>
<a href="#l143.31"></a><span id="l143.31" class="difflineplus">+</span>
<a href="#l143.32"></a><span id="l143.32" class="difflineplus">+const gCopyService = Cc[&quot;@mozilla.org/messenger/messagecopyservice;1&quot;]</span>
<a href="#l143.33"></a><span id="l143.33" class="difflineplus">+                      .getService(Ci.nsIMsgCopyService);</span>
<a href="#l143.34"></a><span id="l143.34" class="difflineplus">+</span>
<a href="#l143.35"></a><span id="l143.35" class="difflineplus">+// nsIMsgCopyServiceListener implementation</span>
<a href="#l143.36"></a><span id="l143.36" class="difflineplus">+var copyListener = </span>
<a href="#l143.37"></a><span id="l143.37" class="difflineplus">+{</span>
<a href="#l143.38"></a><span id="l143.38" class="difflineplus">+  OnStartCopy: function() {},</span>
<a href="#l143.39"></a><span id="l143.39" class="difflineplus">+  OnProgress: function(aProgress, aProgressMax) {},</span>
<a href="#l143.40"></a><span id="l143.40" class="difflineplus">+  SetMessageKey: function(aKey)</span>
<a href="#l143.41"></a><span id="l143.41" class="difflineplus">+  {</span>
<a href="#l143.42"></a><span id="l143.42" class="difflineplus">+    let hdr = gLocalInboxFolder.GetMessageHeader(aKey);</span>
<a href="#l143.43"></a><span id="l143.43" class="difflineplus">+    gMsgHdrs.push({hdr: hdr, ID: hdr.messageId});</span>
<a href="#l143.44"></a><span id="l143.44" class="difflineplus">+  },</span>
<a href="#l143.45"></a><span id="l143.45" class="difflineplus">+  SetMessageId: function(aMessageId) {},</span>
<a href="#l143.46"></a><span id="l143.46" class="difflineplus">+  OnStopCopy: function(aStatus)</span>
<a href="#l143.47"></a><span id="l143.47" class="difflineplus">+  {</span>
<a href="#l143.48"></a><span id="l143.48" class="difflineplus">+    // Check: message successfully copied.</span>
<a href="#l143.49"></a><span id="l143.49" class="difflineplus">+    do_check_eq(aStatus, 0);</span>
<a href="#l143.50"></a><span id="l143.50" class="difflineplus">+    // Ugly hack: make sure we don't get stuck in a JS-&gt;C++-&gt;JS-&gt;C++... call stack</span>
<a href="#l143.51"></a><span id="l143.51" class="difflineplus">+    // This can happen with a bunch of synchronous functions grouped together, and</span>
<a href="#l143.52"></a><span id="l143.52" class="difflineplus">+    // can even cause tests to fail because they're still waiting for the listener</span>
<a href="#l143.53"></a><span id="l143.53" class="difflineplus">+    // to return</span>
<a href="#l143.54"></a><span id="l143.54" class="difflineplus">+    do_timeout(0, &quot;doTest(++gCurTestNum)&quot;);</span>
<a href="#l143.55"></a><span id="l143.55" class="difflineplus">+  }</span>
<a href="#l143.56"></a><span id="l143.56" class="difflineplus">+};</span>
<a href="#l143.57"></a><span id="l143.57" class="difflineplus">+</span>
<a href="#l143.58"></a><span id="l143.58" class="difflineplus">+var urlListener =</span>
<a href="#l143.59"></a><span id="l143.59" class="difflineplus">+{</span>
<a href="#l143.60"></a><span id="l143.60" class="difflineplus">+  OnStartRunningUrl: function (aUrl) {</span>
<a href="#l143.61"></a><span id="l143.61" class="difflineplus">+  },</span>
<a href="#l143.62"></a><span id="l143.62" class="difflineplus">+  OnStopRunningUrl: function (aUrl, aExitCode) {</span>
<a href="#l143.63"></a><span id="l143.63" class="difflineplus">+    // Check: message successfully copied.</span>
<a href="#l143.64"></a><span id="l143.64" class="difflineplus">+    do_check_eq(aExitCode, 0);</span>
<a href="#l143.65"></a><span id="l143.65" class="difflineplus">+    // Ugly hack: make sure we don't get stuck in a JS-&gt;C++-&gt;JS-&gt;C++... call stack</span>
<a href="#l143.66"></a><span id="l143.66" class="difflineplus">+    // This can happen with a bunch of synchronous functions grouped together, and</span>
<a href="#l143.67"></a><span id="l143.67" class="difflineplus">+    // can even cause tests to fail because they're still waiting for the listener</span>
<a href="#l143.68"></a><span id="l143.68" class="difflineplus">+    // to return</span>
<a href="#l143.69"></a><span id="l143.69" class="difflineplus">+    do_timeout(0, &quot;doTest(++gCurTestNum)&quot;);</span>
<a href="#l143.70"></a><span id="l143.70" class="difflineplus">+  }</span>
<a href="#l143.71"></a><span id="l143.71" class="difflineplus">+};</span>
<a href="#l143.72"></a><span id="l143.72" class="difflineplus">+</span>
<a href="#l143.73"></a><span id="l143.73" class="difflineplus">+function copyFileMessage(file, destFolder, isDraftOrTemplate)</span>
<a href="#l143.74"></a><span id="l143.74" class="difflineplus">+{</span>
<a href="#l143.75"></a><span id="l143.75" class="difflineplus">+  gCopyService.CopyFileMessage(file, destFolder, null, isDraftOrTemplate, 0, &quot;&quot;, copyListener, null);</span>
<a href="#l143.76"></a><span id="l143.76" class="difflineplus">+}</span>
<a href="#l143.77"></a><span id="l143.77" class="difflineplus">+</span>
<a href="#l143.78"></a><span id="l143.78" class="difflineplus">+function deleteMessages(srcFolder, items)</span>
<a href="#l143.79"></a><span id="l143.79" class="difflineplus">+{</span>
<a href="#l143.80"></a><span id="l143.80" class="difflineplus">+  var array = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(Ci.nsIMutableArray);</span>
<a href="#l143.81"></a><span id="l143.81" class="difflineplus">+  items.forEach(function (item) {</span>
<a href="#l143.82"></a><span id="l143.82" class="difflineplus">+    array.appendElement(item, false);</span>
<a href="#l143.83"></a><span id="l143.83" class="difflineplus">+  });</span>
<a href="#l143.84"></a><span id="l143.84" class="difflineplus">+  </span>
<a href="#l143.85"></a><span id="l143.85" class="difflineplus">+  srcFolder.deleteMessages(array, null, false, true, copyListener, true);</span>
<a href="#l143.86"></a><span id="l143.86" class="difflineplus">+}</span>
<a href="#l143.87"></a><span id="l143.87" class="difflineplus">+</span>
<a href="#l143.88"></a><span id="l143.88" class="difflineplus">+/*</span>
<a href="#l143.89"></a><span id="l143.89" class="difflineplus">+ * TESTS</span>
<a href="#l143.90"></a><span id="l143.90" class="difflineplus">+ */</span>
<a href="#l143.91"></a><span id="l143.91" class="difflineplus">+</span>
<a href="#l143.92"></a><span id="l143.92" class="difflineplus">+// Beware before commenting out a test -- later tests might just depend on earlier ones</span>
<a href="#l143.93"></a><span id="l143.93" class="difflineplus">+const gTestArray =</span>
<a href="#l143.94"></a><span id="l143.94" class="difflineplus">+[</span>
<a href="#l143.95"></a><span id="l143.95" class="difflineplus">+  // Copying message from file</span>
<a href="#l143.96"></a><span id="l143.96" class="difflineplus">+  function testCopyFileMessage1() { copyFileMessage(gMsgFile1, gLocalInboxFolder, false); },</span>
<a href="#l143.97"></a><span id="l143.97" class="difflineplus">+</span>
<a href="#l143.98"></a><span id="l143.98" class="difflineplus">+  // Delete message</span>
<a href="#l143.99"></a><span id="l143.99" class="difflineplus">+  function testDeleteMessage() { // delete to trash</span>
<a href="#l143.100"></a><span id="l143.100" class="difflineplus">+    // Let's take a moment to re-initialize stuff that got moved</span>
<a href="#l143.101"></a><span id="l143.101" class="difflineplus">+    let inboxDB = gLocalInboxFolder.msgDatabase;</span>
<a href="#l143.102"></a><span id="l143.102" class="difflineplus">+    gMsgHdrs[0].hdr = inboxDB.getMsgHdrForMessageID(gMsgHdrs[0].ID);</span>
<a href="#l143.103"></a><span id="l143.103" class="difflineplus">+</span>
<a href="#l143.104"></a><span id="l143.104" class="difflineplus">+    // Now delete the message</span>
<a href="#l143.105"></a><span id="l143.105" class="difflineplus">+    deleteMessages(gLocalInboxFolder, [gMsgHdrs[0].hdr], false, false);</span>
<a href="#l143.106"></a><span id="l143.106" class="difflineplus">+  },</span>
<a href="#l143.107"></a><span id="l143.107" class="difflineplus">+  function emptyTrash()</span>
<a href="#l143.108"></a><span id="l143.108" class="difflineplus">+  {</span>
<a href="#l143.109"></a><span id="l143.109" class="difflineplus">+    gRootFolder = gLocalIncomingServer.rootMsgFolder;</span>
<a href="#l143.110"></a><span id="l143.110" class="difflineplus">+    gLocalTrashFolder = gRootFolder.getChildNamed(&quot;Trash&quot;);</span>
<a href="#l143.111"></a><span id="l143.111" class="difflineplus">+    // hold onto a db to make sure that empty trash deals with the case</span>
<a href="#l143.112"></a><span id="l143.112" class="difflineplus">+    // of someone holding onto the db, but the trash folder has a null db.</span>
<a href="#l143.113"></a><span id="l143.113" class="difflineplus">+    let gLocalTrashDB = gLocalTrashFolder.msgDatabase;</span>
<a href="#l143.114"></a><span id="l143.114" class="difflineplus">+    gLocalTrashFolder.msgDatabase = null;</span>
<a href="#l143.115"></a><span id="l143.115" class="difflineplus">+    // this is synchronous</span>
<a href="#l143.116"></a><span id="l143.116" class="difflineplus">+    gLocalTrashFolder.emptyTrash(null, null);</span>
<a href="#l143.117"></a><span id="l143.117" class="difflineplus">+    // check that the trash folder is 0 size, that the db has a 0 message count</span>
<a href="#l143.118"></a><span id="l143.118" class="difflineplus">+    // and has no messages.</span>
<a href="#l143.119"></a><span id="l143.119" class="difflineplus">+    do_check_eq(0, gLocalTrashFolder.filePath.fileSize);</span>
<a href="#l143.120"></a><span id="l143.120" class="difflineplus">+    do_check_eq(0, gLocalTrashFolder.msgDatabase.dBFolderInfo.numMessages);</span>
<a href="#l143.121"></a><span id="l143.121" class="difflineplus">+    let enumerator = gLocalTrashFolder.msgDatabase.EnumerateMessages();</span>
<a href="#l143.122"></a><span id="l143.122" class="difflineplus">+    do_check_eq(false, enumerator.hasMoreElements());</span>
<a href="#l143.123"></a><span id="l143.123" class="difflineplus">+    urlListener.OnStopRunningUrl(null, 0);</span>
<a href="#l143.124"></a><span id="l143.124" class="difflineplus">+  }</span>
<a href="#l143.125"></a><span id="l143.125" class="difflineplus">+];</span>
<a href="#l143.126"></a><span id="l143.126" class="difflineplus">+</span>
<a href="#l143.127"></a><span id="l143.127" class="difflineplus">+var gMFNService = Cc[mFNSContractID].getService(nsIMFNService);</span>
<a href="#l143.128"></a><span id="l143.128" class="difflineplus">+</span>
<a href="#l143.129"></a><span id="l143.129" class="difflineplus">+// Our listener, which captures events.</span>
<a href="#l143.130"></a><span id="l143.130" class="difflineplus">+function gMFListener() {}</span>
<a href="#l143.131"></a><span id="l143.131" class="difflineplus">+gMFListener.prototype =</span>
<a href="#l143.132"></a><span id="l143.132" class="difflineplus">+{</span>
<a href="#l143.133"></a><span id="l143.133" class="difflineplus">+  folderDeleted: function (aFolder)</span>
<a href="#l143.134"></a><span id="l143.134" class="difflineplus">+  {</span>
<a href="#l143.135"></a><span id="l143.135" class="difflineplus">+    aFolder.msgDatabase = null;</span>
<a href="#l143.136"></a><span id="l143.136" class="difflineplus">+  },</span>
<a href="#l143.137"></a><span id="l143.137" class="difflineplus">+};</span>
<a href="#l143.138"></a><span id="l143.138" class="difflineplus">+</span>
<a href="#l143.139"></a><span id="l143.139" class="difflineplus">+function run_test()</span>
<a href="#l143.140"></a><span id="l143.140" class="difflineplus">+{</span>
<a href="#l143.141"></a><span id="l143.141" class="difflineplus">+  loadLocalMailAccount();</span>
<a href="#l143.142"></a><span id="l143.142" class="difflineplus">+  // Load up a message so that we can copy it in later.</span>
<a href="#l143.143"></a><span id="l143.143" class="difflineplus">+  gMsgFile1 = do_get_file(&quot;../../mailnews/data/bugmail10&quot;);</span>
<a href="#l143.144"></a><span id="l143.144" class="difflineplus">+  // our front end code clears the msg db when it gets told the folder for</span>
<a href="#l143.145"></a><span id="l143.145" class="difflineplus">+  // an open view has been deleted - so simulate that.</span>
<a href="#l143.146"></a><span id="l143.146" class="difflineplus">+  var folderDeletedListener = new gMFListener();</span>
<a href="#l143.147"></a><span id="l143.147" class="difflineplus">+  gMFNService.addListener(folderDeletedListener, nsIMFNService.folderDeleted);</span>
<a href="#l143.148"></a><span id="l143.148" class="difflineplus">+</span>
<a href="#l143.149"></a><span id="l143.149" class="difflineplus">+  // &quot;Master&quot; do_test_pending(), paired with a do_test_finished() at the end of all the operations.</span>
<a href="#l143.150"></a><span id="l143.150" class="difflineplus">+  do_test_pending();</span>
<a href="#l143.151"></a><span id="l143.151" class="difflineplus">+</span>
<a href="#l143.152"></a><span id="l143.152" class="difflineplus">+  // Do the test.</span>
<a href="#l143.153"></a><span id="l143.153" class="difflineplus">+  doTest(1);</span>
<a href="#l143.154"></a><span id="l143.154" class="difflineplus">+}</span>
<a href="#l143.155"></a><span id="l143.155" class="difflineplus">+</span>
<a href="#l143.156"></a><span id="l143.156" class="difflineplus">+function doTest(test)</span>
<a href="#l143.157"></a><span id="l143.157" class="difflineplus">+{</span>
<a href="#l143.158"></a><span id="l143.158" class="difflineplus">+  if (test &lt;= gTestArray.length)</span>
<a href="#l143.159"></a><span id="l143.159" class="difflineplus">+  {</span>
<a href="#l143.160"></a><span id="l143.160" class="difflineplus">+    gCurTestNum = test;</span>
<a href="#l143.161"></a><span id="l143.161" class="difflineplus">+    </span>
<a href="#l143.162"></a><span id="l143.162" class="difflineplus">+    var testFn = gTestArray[test-1];</span>
<a href="#l143.163"></a><span id="l143.163" class="difflineplus">+    // Set a limit of three seconds; if the notifications haven't arrived by then there's a problem.</span>
<a href="#l143.164"></a><span id="l143.164" class="difflineplus">+    do_timeout(10000, &quot;if (gCurTestNum == &quot;+test+&quot;) \</span>
<a href="#l143.165"></a><span id="l143.165" class="difflineplus">+      do_throw('Notifications not received in 10000 ms for operation &quot;+testFn.name+&quot;, current status is '+gCurrStatus);&quot;);</span>
<a href="#l143.166"></a><span id="l143.166" class="difflineplus">+    try {</span>
<a href="#l143.167"></a><span id="l143.167" class="difflineplus">+    testFn();</span>
<a href="#l143.168"></a><span id="l143.168" class="difflineplus">+    } catch(ex) {dump(ex);}</span>
<a href="#l143.169"></a><span id="l143.169" class="difflineplus">+  }</span>
<a href="#l143.170"></a><span id="l143.170" class="difflineplus">+  else</span>
<a href="#l143.171"></a><span id="l143.171" class="difflineplus">+  {</span>
<a href="#l143.172"></a><span id="l143.172" class="difflineplus">+    gMsgHdrs = null;</span>
<a href="#l143.173"></a><span id="l143.173" class="difflineplus">+    do_test_finished(); // for the one in run_test()</span>
<a href="#l143.174"></a><span id="l143.174" class="difflineplus">+  }</span>
<a href="#l143.175"></a><span id="l143.175" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l144.1"></a><span id="l144.1">new file mode 100644</span>
<a href="#l144.2"></a><span id="l144.2" class="difflineminus">--- /dev/null</span>
<a href="#l144.3"></a><span id="l144.3" class="difflineplus">+++ b/mailnews/base/test/unit/test_jsTreeSelection.js</span>
<a href="#l144.4"></a><span id="l144.4" class="difflineat">@@ -0,0 +1,444 @@</span>
<a href="#l144.5"></a><span id="l144.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l144.6"></a><span id="l144.6" class="difflineplus">+ *   Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l144.7"></a><span id="l144.7" class="difflineplus">+ *</span>
<a href="#l144.8"></a><span id="l144.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l144.9"></a><span id="l144.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l144.10"></a><span id="l144.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l144.11"></a><span id="l144.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l144.12"></a><span id="l144.12" class="difflineplus">+ *</span>
<a href="#l144.13"></a><span id="l144.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l144.14"></a><span id="l144.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l144.15"></a><span id="l144.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l144.16"></a><span id="l144.16" class="difflineplus">+ * License.</span>
<a href="#l144.17"></a><span id="l144.17" class="difflineplus">+ *</span>
<a href="#l144.18"></a><span id="l144.18" class="difflineplus">+ * The Original Code is Thunderbird Mail Client.</span>
<a href="#l144.19"></a><span id="l144.19" class="difflineplus">+ *</span>
<a href="#l144.20"></a><span id="l144.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l144.21"></a><span id="l144.21" class="difflineplus">+ * Mozilla Messaging, Inc.</span>
<a href="#l144.22"></a><span id="l144.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l144.23"></a><span id="l144.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l144.24"></a><span id="l144.24" class="difflineplus">+ *</span>
<a href="#l144.25"></a><span id="l144.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l144.26"></a><span id="l144.26" class="difflineplus">+ *   Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a href="#l144.27"></a><span id="l144.27" class="difflineplus">+ *</span>
<a href="#l144.28"></a><span id="l144.28" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l144.29"></a><span id="l144.29" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l144.30"></a><span id="l144.30" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l144.31"></a><span id="l144.31" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l144.32"></a><span id="l144.32" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l144.33"></a><span id="l144.33" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l144.34"></a><span id="l144.34" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l144.35"></a><span id="l144.35" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l144.36"></a><span id="l144.36" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l144.37"></a><span id="l144.37" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l144.38"></a><span id="l144.38" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l144.39"></a><span id="l144.39" class="difflineplus">+ *</span>
<a href="#l144.40"></a><span id="l144.40" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l144.41"></a><span id="l144.41" class="difflineplus">+</span>
<a href="#l144.42"></a><span id="l144.42" class="difflineplus">+Components.utils.import(&quot;resource://app/modules/jsTreeSelection.js&quot;);</span>
<a href="#l144.43"></a><span id="l144.43" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l144.44"></a><span id="l144.44" class="difflineplus">+</span>
<a href="#l144.45"></a><span id="l144.45" class="difflineplus">+var fakeView = {</span>
<a href="#l144.46"></a><span id="l144.46" class="difflineplus">+  rowCount: 101,</span>
<a href="#l144.47"></a><span id="l144.47" class="difflineplus">+  selectionChanged: function() {</span>
<a href="#l144.48"></a><span id="l144.48" class="difflineplus">+  },</span>
<a href="#l144.49"></a><span id="l144.49" class="difflineplus">+  QueryInterface: XPCOMUtils.generateQI(</span>
<a href="#l144.50"></a><span id="l144.50" class="difflineplus">+    [Ci.nsITreeView]),</span>
<a href="#l144.51"></a><span id="l144.51" class="difflineplus">+};</span>
<a href="#l144.52"></a><span id="l144.52" class="difflineplus">+</span>
<a href="#l144.53"></a><span id="l144.53" class="difflineplus">+var fakeBox = {</span>
<a href="#l144.54"></a><span id="l144.54" class="difflineplus">+  view: fakeView,</span>
<a href="#l144.55"></a><span id="l144.55" class="difflineplus">+  invalidate: function() {},</span>
<a href="#l144.56"></a><span id="l144.56" class="difflineplus">+  invalidateRow: function() {},</span>
<a href="#l144.57"></a><span id="l144.57" class="difflineplus">+  QueryInterface: XPCOMUtils.generateQI(</span>
<a href="#l144.58"></a><span id="l144.58" class="difflineplus">+    [Ci.nsITreeBoxObject]),</span>
<a href="#l144.59"></a><span id="l144.59" class="difflineplus">+};</span>
<a href="#l144.60"></a><span id="l144.60" class="difflineplus">+</span>
<a href="#l144.61"></a><span id="l144.61" class="difflineplus">+var sel = new JSTreeSelection(fakeBox);</span>
<a href="#l144.62"></a><span id="l144.62" class="difflineplus">+</span>
<a href="#l144.63"></a><span id="l144.63" class="difflineplus">+function bad_ranges(aMsg, aExpected) {</span>
<a href="#l144.64"></a><span id="l144.64" class="difflineplus">+  let s = &quot;\x1b[1;31m!!! BAD RANGES: &quot; + aMsg + &quot;\n&quot;;</span>
<a href="#l144.65"></a><span id="l144.65" class="difflineplus">+  s += &quot;Selection ranges: &quot; + sel._ranges.length + &quot;:&quot;;</span>
<a href="#l144.66"></a><span id="l144.66" class="difflineplus">+  for each (let [,[low,high]] in Iterator(sel._ranges)) {</span>
<a href="#l144.67"></a><span id="l144.67" class="difflineplus">+    s += &quot; &quot; + low + &quot;-&quot; + high;</span>
<a href="#l144.68"></a><span id="l144.68" class="difflineplus">+  }</span>
<a href="#l144.69"></a><span id="l144.69" class="difflineplus">+</span>
<a href="#l144.70"></a><span id="l144.70" class="difflineplus">+  s += &quot;\nExpected ranges: &quot; + aExpected.length + &quot;:&quot;;</span>
<a href="#l144.71"></a><span id="l144.71" class="difflineplus">+  for (let i = 0; i &lt; aExpected.length; i++) {</span>
<a href="#l144.72"></a><span id="l144.72" class="difflineplus">+    s += &quot; &quot; + aExpected[i][0] + &quot;-&quot; + aExpected[i][1];</span>
<a href="#l144.73"></a><span id="l144.73" class="difflineplus">+  }</span>
<a href="#l144.74"></a><span id="l144.74" class="difflineplus">+</span>
<a href="#l144.75"></a><span id="l144.75" class="difflineplus">+  s += &quot;\x1b[0m\n&quot;;</span>
<a href="#l144.76"></a><span id="l144.76" class="difflineplus">+</span>
<a href="#l144.77"></a><span id="l144.77" class="difflineplus">+  dump(s);</span>
<a href="#l144.78"></a><span id="l144.78" class="difflineplus">+  do_throw(aMsg);</span>
<a href="#l144.79"></a><span id="l144.79" class="difflineplus">+}</span>
<a href="#l144.80"></a><span id="l144.80" class="difflineplus">+</span>
<a href="#l144.81"></a><span id="l144.81" class="difflineplus">+function assert_selection_ranges() {</span>
<a href="#l144.82"></a><span id="l144.82" class="difflineplus">+  if (sel._ranges.length != arguments.length)</span>
<a href="#l144.83"></a><span id="l144.83" class="difflineplus">+    bad_ranges(&quot;Wrong number of ranges!&quot;, arguments);</span>
<a href="#l144.84"></a><span id="l144.84" class="difflineplus">+</span>
<a href="#l144.85"></a><span id="l144.85" class="difflineplus">+  let i = 0;</span>
<a href="#l144.86"></a><span id="l144.86" class="difflineplus">+  let ourCount = 0;</span>
<a href="#l144.87"></a><span id="l144.87" class="difflineplus">+  for each (let [,[slow,shigh]] in Iterator(sel._ranges)) {</span>
<a href="#l144.88"></a><span id="l144.88" class="difflineplus">+    let [dlow, dhigh] = arguments[i++];</span>
<a href="#l144.89"></a><span id="l144.89" class="difflineplus">+    if (dlow != slow || dhigh != shigh)</span>
<a href="#l144.90"></a><span id="l144.90" class="difflineplus">+      bad_ranges(&quot;Range mis-match on index &quot; + i, arguments);</span>
<a href="#l144.91"></a><span id="l144.91" class="difflineplus">+    ourCount += shigh - slow + 1;</span>
<a href="#l144.92"></a><span id="l144.92" class="difflineplus">+  }</span>
<a href="#l144.93"></a><span id="l144.93" class="difflineplus">+</span>
<a href="#l144.94"></a><span id="l144.94" class="difflineplus">+  if (ourCount != sel.count)</span>
<a href="#l144.95"></a><span id="l144.95" class="difflineplus">+    bad_ranges(&quot;Count was wrong! We counted &quot; + ourCount + &quot; but they say &quot; +</span>
<a href="#l144.96"></a><span id="l144.96" class="difflineplus">+               sel.count, arguments);</span>
<a href="#l144.97"></a><span id="l144.97" class="difflineplus">+}</span>
<a href="#l144.98"></a><span id="l144.98" class="difflineplus">+var asr = assert_selection_ranges;</span>
<a href="#l144.99"></a><span id="l144.99" class="difflineplus">+</span>
<a href="#l144.100"></a><span id="l144.100" class="difflineplus">+function assert_current_index(aIndex) {</span>
<a href="#l144.101"></a><span id="l144.101" class="difflineplus">+  if (sel.currentIndex != aIndex)</span>
<a href="#l144.102"></a><span id="l144.102" class="difflineplus">+    do_throw(&quot;Current index is wrong! Is &quot; + sel.currentIndex +</span>
<a href="#l144.103"></a><span id="l144.103" class="difflineplus">+             &quot; but should be &quot; + aIndex);</span>
<a href="#l144.104"></a><span id="l144.104" class="difflineplus">+}</span>
<a href="#l144.105"></a><span id="l144.105" class="difflineplus">+var aci = assert_current_index;</span>
<a href="#l144.106"></a><span id="l144.106" class="difflineplus">+</span>
<a href="#l144.107"></a><span id="l144.107" class="difflineplus">+function assert_shift_pivot(aIndex) {</span>
<a href="#l144.108"></a><span id="l144.108" class="difflineplus">+  if (sel.shiftSelectPivot != aIndex)</span>
<a href="#l144.109"></a><span id="l144.109" class="difflineplus">+    do_throw(&quot;Current index is wrong! Is &quot; + sel._shiftSelectPivot +</span>
<a href="#l144.110"></a><span id="l144.110" class="difflineplus">+             &quot; but should be &quot; + aIndex);</span>
<a href="#l144.111"></a><span id="l144.111" class="difflineplus">+}</span>
<a href="#l144.112"></a><span id="l144.112" class="difflineplus">+var asp = assert_shift_pivot;</span>
<a href="#l144.113"></a><span id="l144.113" class="difflineplus">+</span>
<a href="#l144.114"></a><span id="l144.114" class="difflineplus">+function assert_selected(aIndex) {</span>
<a href="#l144.115"></a><span id="l144.115" class="difflineplus">+  if (!sel.isSelected(aIndex))</span>
<a href="#l144.116"></a><span id="l144.116" class="difflineplus">+    do_throw(&quot;Index is not selected but should be: &quot; + aIndex);</span>
<a href="#l144.117"></a><span id="l144.117" class="difflineplus">+}</span>
<a href="#l144.118"></a><span id="l144.118" class="difflineplus">+var asel = assert_selected;</span>
<a href="#l144.119"></a><span id="l144.119" class="difflineplus">+</span>
<a href="#l144.120"></a><span id="l144.120" class="difflineplus">+function assert_not_selected(aIndex) {</span>
<a href="#l144.121"></a><span id="l144.121" class="difflineplus">+  if (sel.isSelected(aIndex))</span>
<a href="#l144.122"></a><span id="l144.122" class="difflineplus">+    do_throw(&quot;Index is selected but should not be: &quot; + aIndex);</span>
<a href="#l144.123"></a><span id="l144.123" class="difflineplus">+}</span>
<a href="#l144.124"></a><span id="l144.124" class="difflineplus">+var ansel = assert_not_selected;</span>
<a href="#l144.125"></a><span id="l144.125" class="difflineplus">+</span>
<a href="#l144.126"></a><span id="l144.126" class="difflineplus">+function run_test() {</span>
<a href="#l144.127"></a><span id="l144.127" class="difflineplus">+  // -- select</span>
<a href="#l144.128"></a><span id="l144.128" class="difflineplus">+  sel.select(1);</span>
<a href="#l144.129"></a><span id="l144.129" class="difflineplus">+  asel(1);</span>
<a href="#l144.130"></a><span id="l144.130" class="difflineplus">+  ansel(0);</span>
<a href="#l144.131"></a><span id="l144.131" class="difflineplus">+  ansel(2);</span>
<a href="#l144.132"></a><span id="l144.132" class="difflineplus">+  asr([1,1]);</span>
<a href="#l144.133"></a><span id="l144.133" class="difflineplus">+  aci(1);</span>
<a href="#l144.134"></a><span id="l144.134" class="difflineplus">+</span>
<a href="#l144.135"></a><span id="l144.135" class="difflineplus">+  sel.select(2);</span>
<a href="#l144.136"></a><span id="l144.136" class="difflineplus">+  asel(2);</span>
<a href="#l144.137"></a><span id="l144.137" class="difflineplus">+  ansel(1);</span>
<a href="#l144.138"></a><span id="l144.138" class="difflineplus">+  ansel(3);</span>
<a href="#l144.139"></a><span id="l144.139" class="difflineplus">+  asr([2,2]);</span>
<a href="#l144.140"></a><span id="l144.140" class="difflineplus">+  aci(2);</span>
<a href="#l144.141"></a><span id="l144.141" class="difflineplus">+</span>
<a href="#l144.142"></a><span id="l144.142" class="difflineplus">+  // -- clearSelection</span>
<a href="#l144.143"></a><span id="l144.143" class="difflineplus">+  sel.clearSelection();</span>
<a href="#l144.144"></a><span id="l144.144" class="difflineplus">+  asr();</span>
<a href="#l144.145"></a><span id="l144.145" class="difflineplus">+  aci(2); // should still be the same...</span>
<a href="#l144.146"></a><span id="l144.146" class="difflineplus">+</span>
<a href="#l144.147"></a><span id="l144.147" class="difflineplus">+  // -- toggleSelect</span>
<a href="#l144.148"></a><span id="l144.148" class="difflineplus">+  // lower fusion</span>
<a href="#l144.149"></a><span id="l144.149" class="difflineplus">+  sel.select(2);</span>
<a href="#l144.150"></a><span id="l144.150" class="difflineplus">+  sel.toggleSelect(1);</span>
<a href="#l144.151"></a><span id="l144.151" class="difflineplus">+  asr([1, 2]);</span>
<a href="#l144.152"></a><span id="l144.152" class="difflineplus">+  aci(1);</span>
<a href="#l144.153"></a><span id="l144.153" class="difflineplus">+</span>
<a href="#l144.154"></a><span id="l144.154" class="difflineplus">+  // upper fusion</span>
<a href="#l144.155"></a><span id="l144.155" class="difflineplus">+  sel.toggleSelect(3);</span>
<a href="#l144.156"></a><span id="l144.156" class="difflineplus">+  asr([1, 3]);</span>
<a href="#l144.157"></a><span id="l144.157" class="difflineplus">+  aci(3);</span>
<a href="#l144.158"></a><span id="l144.158" class="difflineplus">+</span>
<a href="#l144.159"></a><span id="l144.159" class="difflineplus">+  // splitting</span>
<a href="#l144.160"></a><span id="l144.160" class="difflineplus">+  sel.toggleSelect(2);</span>
<a href="#l144.161"></a><span id="l144.161" class="difflineplus">+  asr([1, 1], [3, 3]);</span>
<a href="#l144.162"></a><span id="l144.162" class="difflineplus">+  asel(1);</span>
<a href="#l144.163"></a><span id="l144.163" class="difflineplus">+  asel(3);</span>
<a href="#l144.164"></a><span id="l144.164" class="difflineplus">+  ansel(0);</span>
<a href="#l144.165"></a><span id="l144.165" class="difflineplus">+  ansel(2);</span>
<a href="#l144.166"></a><span id="l144.166" class="difflineplus">+  ansel(4);</span>
<a href="#l144.167"></a><span id="l144.167" class="difflineplus">+  aci(2);</span>
<a href="#l144.168"></a><span id="l144.168" class="difflineplus">+</span>
<a href="#l144.169"></a><span id="l144.169" class="difflineplus">+  // merge</span>
<a href="#l144.170"></a><span id="l144.170" class="difflineplus">+  sel.toggleSelect(2);</span>
<a href="#l144.171"></a><span id="l144.171" class="difflineplus">+  asr([1, 3]);</span>
<a href="#l144.172"></a><span id="l144.172" class="difflineplus">+  aci(2);</span>
<a href="#l144.173"></a><span id="l144.173" class="difflineplus">+</span>
<a href="#l144.174"></a><span id="l144.174" class="difflineplus">+  // lower shrinkage</span>
<a href="#l144.175"></a><span id="l144.175" class="difflineplus">+  sel.toggleSelect(1);</span>
<a href="#l144.176"></a><span id="l144.176" class="difflineplus">+  asr([2, 3]);</span>
<a href="#l144.177"></a><span id="l144.177" class="difflineplus">+  aci(1);</span>
<a href="#l144.178"></a><span id="l144.178" class="difflineplus">+</span>
<a href="#l144.179"></a><span id="l144.179" class="difflineplus">+  // upper shrinkage</span>
<a href="#l144.180"></a><span id="l144.180" class="difflineplus">+  sel.toggleSelect(3);</span>
<a href="#l144.181"></a><span id="l144.181" class="difflineplus">+  asr([2, 2]);</span>
<a href="#l144.182"></a><span id="l144.182" class="difflineplus">+  aci(3);</span>
<a href="#l144.183"></a><span id="l144.183" class="difflineplus">+</span>
<a href="#l144.184"></a><span id="l144.184" class="difflineplus">+  // nukage</span>
<a href="#l144.185"></a><span id="l144.185" class="difflineplus">+  sel.toggleSelect(2);</span>
<a href="#l144.186"></a><span id="l144.186" class="difflineplus">+  asr();</span>
<a href="#l144.187"></a><span id="l144.187" class="difflineplus">+  aci(2);</span>
<a href="#l144.188"></a><span id="l144.188" class="difflineplus">+</span>
<a href="#l144.189"></a><span id="l144.189" class="difflineplus">+  // -- rangedSelect</span>
<a href="#l144.190"></a><span id="l144.190" class="difflineplus">+  // simple non-augment</span>
<a href="#l144.191"></a><span id="l144.191" class="difflineplus">+  sel.rangedSelect(0, 0, false);</span>
<a href="#l144.192"></a><span id="l144.192" class="difflineplus">+  asr([0, 0]);</span>
<a href="#l144.193"></a><span id="l144.193" class="difflineplus">+  asp(0);</span>
<a href="#l144.194"></a><span id="l144.194" class="difflineplus">+  aci(0);</span>
<a href="#l144.195"></a><span id="l144.195" class="difflineplus">+</span>
<a href="#l144.196"></a><span id="l144.196" class="difflineplus">+  // slightly less simple non-augment</span>
<a href="#l144.197"></a><span id="l144.197" class="difflineplus">+  sel.rangedSelect(2, 4, false);</span>
<a href="#l144.198"></a><span id="l144.198" class="difflineplus">+  asr([2, 4]);</span>
<a href="#l144.199"></a><span id="l144.199" class="difflineplus">+  asp(2);</span>
<a href="#l144.200"></a><span id="l144.200" class="difflineplus">+  aci(4);</span>
<a href="#l144.201"></a><span id="l144.201" class="difflineplus">+</span>
<a href="#l144.202"></a><span id="l144.202" class="difflineplus">+  // higher distinct range</span>
<a href="#l144.203"></a><span id="l144.203" class="difflineplus">+  sel.rangedSelect(7, 9, true);</span>
<a href="#l144.204"></a><span id="l144.204" class="difflineplus">+  asr([2, 4], [7, 9]);</span>
<a href="#l144.205"></a><span id="l144.205" class="difflineplus">+  asp(7);</span>
<a href="#l144.206"></a><span id="l144.206" class="difflineplus">+  aci(9);</span>
<a href="#l144.207"></a><span id="l144.207" class="difflineplus">+</span>
<a href="#l144.208"></a><span id="l144.208" class="difflineplus">+  // lower distinct range</span>
<a href="#l144.209"></a><span id="l144.209" class="difflineplus">+  sel.rangedSelect(0, 0, true);</span>
<a href="#l144.210"></a><span id="l144.210" class="difflineplus">+  asr([0, 0], [2, 4], [7, 9]);</span>
<a href="#l144.211"></a><span id="l144.211" class="difflineplus">+  asp(0);</span>
<a href="#l144.212"></a><span id="l144.212" class="difflineplus">+  aci(0);</span>
<a href="#l144.213"></a><span id="l144.213" class="difflineplus">+</span>
<a href="#l144.214"></a><span id="l144.214" class="difflineplus">+  // lower fusion</span>
<a href="#l144.215"></a><span id="l144.215" class="difflineplus">+  sel.rangedSelect(6, 6, true);</span>
<a href="#l144.216"></a><span id="l144.216" class="difflineplus">+  asr([0, 0], [2, 4], [6, 9]);</span>
<a href="#l144.217"></a><span id="l144.217" class="difflineplus">+  asp(6);</span>
<a href="#l144.218"></a><span id="l144.218" class="difflineplus">+  aci(6);</span>
<a href="#l144.219"></a><span id="l144.219" class="difflineplus">+</span>
<a href="#l144.220"></a><span id="l144.220" class="difflineplus">+  // upper fusion</span>
<a href="#l144.221"></a><span id="l144.221" class="difflineplus">+  sel.rangedSelect(10, 11, true);</span>
<a href="#l144.222"></a><span id="l144.222" class="difflineplus">+  asr([0, 0], [2, 4], [6, 11]);</span>
<a href="#l144.223"></a><span id="l144.223" class="difflineplus">+  asp(10);</span>
<a href="#l144.224"></a><span id="l144.224" class="difflineplus">+  aci(11);</span>
<a href="#l144.225"></a><span id="l144.225" class="difflineplus">+</span>
<a href="#l144.226"></a><span id="l144.226" class="difflineplus">+  // notch merge</span>
<a href="#l144.227"></a><span id="l144.227" class="difflineplus">+  sel.rangedSelect(5, 5, true);</span>
<a href="#l144.228"></a><span id="l144.228" class="difflineplus">+  asr([0, 0], [2, 11]);</span>
<a href="#l144.229"></a><span id="l144.229" class="difflineplus">+  asp(5);</span>
<a href="#l144.230"></a><span id="l144.230" class="difflineplus">+  aci(5);</span>
<a href="#l144.231"></a><span id="l144.231" class="difflineplus">+</span>
<a href="#l144.232"></a><span id="l144.232" class="difflineplus">+  // ambiguous consume with merge</span>
<a href="#l144.233"></a><span id="l144.233" class="difflineplus">+  sel.rangedSelect(0, 5, true);</span>
<a href="#l144.234"></a><span id="l144.234" class="difflineplus">+  asr([0, 11]);</span>
<a href="#l144.235"></a><span id="l144.235" class="difflineplus">+  asp(0);</span>
<a href="#l144.236"></a><span id="l144.236" class="difflineplus">+  aci(5);</span>
<a href="#l144.237"></a><span id="l144.237" class="difflineplus">+</span>
<a href="#l144.238"></a><span id="l144.238" class="difflineplus">+  // aligned consumption</span>
<a href="#l144.239"></a><span id="l144.239" class="difflineplus">+  sel.rangedSelect(0, 15, true);</span>
<a href="#l144.240"></a><span id="l144.240" class="difflineplus">+  asr([0, 15]);</span>
<a href="#l144.241"></a><span id="l144.241" class="difflineplus">+  asp(0);</span>
<a href="#l144.242"></a><span id="l144.242" class="difflineplus">+  aci(15);</span>
<a href="#l144.243"></a><span id="l144.243" class="difflineplus">+</span>
<a href="#l144.244"></a><span id="l144.244" class="difflineplus">+  // excessive consumption</span>
<a href="#l144.245"></a><span id="l144.245" class="difflineplus">+  sel.rangedSelect(5, 7, false);</span>
<a href="#l144.246"></a><span id="l144.246" class="difflineplus">+  sel.rangedSelect(3, 10, true);</span>
<a href="#l144.247"></a><span id="l144.247" class="difflineplus">+  asr([3, 10]);</span>
<a href="#l144.248"></a><span id="l144.248" class="difflineplus">+  asp(3);</span>
<a href="#l144.249"></a><span id="l144.249" class="difflineplus">+  aci(10);</span>
<a href="#l144.250"></a><span id="l144.250" class="difflineplus">+</span>
<a href="#l144.251"></a><span id="l144.251" class="difflineplus">+  // overlap merge</span>
<a href="#l144.252"></a><span id="l144.252" class="difflineplus">+  sel.rangedSelect(5, 10, false);</span>
<a href="#l144.253"></a><span id="l144.253" class="difflineplus">+  sel.rangedSelect(15, 20, true);</span>
<a href="#l144.254"></a><span id="l144.254" class="difflineplus">+  sel.rangedSelect(7, 17, true);</span>
<a href="#l144.255"></a><span id="l144.255" class="difflineplus">+  asr([5, 20]);</span>
<a href="#l144.256"></a><span id="l144.256" class="difflineplus">+  asp(7);</span>
<a href="#l144.257"></a><span id="l144.257" class="difflineplus">+  aci(17);</span>
<a href="#l144.258"></a><span id="l144.258" class="difflineplus">+</span>
<a href="#l144.259"></a><span id="l144.259" class="difflineplus">+  // big merge and consume</span>
<a href="#l144.260"></a><span id="l144.260" class="difflineplus">+  sel.rangedSelect(5, 10, false);</span>
<a href="#l144.261"></a><span id="l144.261" class="difflineplus">+  sel.rangedSelect(15, 20, true);</span>
<a href="#l144.262"></a><span id="l144.262" class="difflineplus">+  sel.rangedSelect(25, 30, true);</span>
<a href="#l144.263"></a><span id="l144.263" class="difflineplus">+  sel.rangedSelect(35, 40, true);</span>
<a href="#l144.264"></a><span id="l144.264" class="difflineplus">+  sel.rangedSelect(7, 37, true);</span>
<a href="#l144.265"></a><span id="l144.265" class="difflineplus">+  asr([5, 40]);</span>
<a href="#l144.266"></a><span id="l144.266" class="difflineplus">+  asp(7);</span>
<a href="#l144.267"></a><span id="l144.267" class="difflineplus">+  aci(37);</span>
<a href="#l144.268"></a><span id="l144.268" class="difflineplus">+</span>
<a href="#l144.269"></a><span id="l144.269" class="difflineplus">+  // broad lower fusion</span>
<a href="#l144.270"></a><span id="l144.270" class="difflineplus">+  sel.rangedSelect(10, 20, false);</span>
<a href="#l144.271"></a><span id="l144.271" class="difflineplus">+  sel.rangedSelect(3, 15, true);</span>
<a href="#l144.272"></a><span id="l144.272" class="difflineplus">+  asr([3, 20]);</span>
<a href="#l144.273"></a><span id="l144.273" class="difflineplus">+  asp(3);</span>
<a href="#l144.274"></a><span id="l144.274" class="difflineplus">+  aci(15);</span>
<a href="#l144.275"></a><span id="l144.275" class="difflineplus">+</span>
<a href="#l144.276"></a><span id="l144.276" class="difflineplus">+  // -- clearRange</span>
<a href="#l144.277"></a><span id="l144.277" class="difflineplus">+  sel.rangedSelect(10, 30, false);</span>
<a href="#l144.278"></a><span id="l144.278" class="difflineplus">+</span>
<a href="#l144.279"></a><span id="l144.279" class="difflineplus">+  // irrelevant low</span>
<a href="#l144.280"></a><span id="l144.280" class="difflineplus">+  sel.clearRange(0, 5);</span>
<a href="#l144.281"></a><span id="l144.281" class="difflineplus">+  asr([10, 30]);</span>
<a href="#l144.282"></a><span id="l144.282" class="difflineplus">+</span>
<a href="#l144.283"></a><span id="l144.283" class="difflineplus">+  // irrelevant high</span>
<a href="#l144.284"></a><span id="l144.284" class="difflineplus">+  sel.clearRange(40, 45);</span>
<a href="#l144.285"></a><span id="l144.285" class="difflineplus">+  asr([10, 30]);</span>
<a href="#l144.286"></a><span id="l144.286" class="difflineplus">+</span>
<a href="#l144.287"></a><span id="l144.287" class="difflineplus">+  // lower shrinkage tight</span>
<a href="#l144.288"></a><span id="l144.288" class="difflineplus">+  sel.clearRange(10, 10);</span>
<a href="#l144.289"></a><span id="l144.289" class="difflineplus">+  asr([11, 30]);</span>
<a href="#l144.290"></a><span id="l144.290" class="difflineplus">+</span>
<a href="#l144.291"></a><span id="l144.291" class="difflineplus">+  // lower shrinkage broad</span>
<a href="#l144.292"></a><span id="l144.292" class="difflineplus">+  sel.clearRange(0, 13);</span>
<a href="#l144.293"></a><span id="l144.293" class="difflineplus">+  asr([14, 30]);</span>
<a href="#l144.294"></a><span id="l144.294" class="difflineplus">+</span>
<a href="#l144.295"></a><span id="l144.295" class="difflineplus">+  // upper shrinkage tight</span>
<a href="#l144.296"></a><span id="l144.296" class="difflineplus">+  sel.clearRange(30, 30);</span>
<a href="#l144.297"></a><span id="l144.297" class="difflineplus">+  asr([14, 29]);</span>
<a href="#l144.298"></a><span id="l144.298" class="difflineplus">+</span>
<a href="#l144.299"></a><span id="l144.299" class="difflineplus">+  // upper shrinkage broad</span>
<a href="#l144.300"></a><span id="l144.300" class="difflineplus">+  sel.clearRange(27, 50);</span>
<a href="#l144.301"></a><span id="l144.301" class="difflineplus">+  asr([14, 26]);</span>
<a href="#l144.302"></a><span id="l144.302" class="difflineplus">+</span>
<a href="#l144.303"></a><span id="l144.303" class="difflineplus">+  // split tight</span>
<a href="#l144.304"></a><span id="l144.304" class="difflineplus">+  sel.clearRange(20, 20);</span>
<a href="#l144.305"></a><span id="l144.305" class="difflineplus">+  asr([14, 19], [21, 26]);</span>
<a href="#l144.306"></a><span id="l144.306" class="difflineplus">+</span>
<a href="#l144.307"></a><span id="l144.307" class="difflineplus">+  // split broad</span>
<a href="#l144.308"></a><span id="l144.308" class="difflineplus">+  sel.toggleSelect(20);</span>
<a href="#l144.309"></a><span id="l144.309" class="difflineplus">+  sel.clearRange(19, 21);</span>
<a href="#l144.310"></a><span id="l144.310" class="difflineplus">+  asr([14, 18], [22, 26]);</span>
<a href="#l144.311"></a><span id="l144.311" class="difflineplus">+</span>
<a href="#l144.312"></a><span id="l144.312" class="difflineplus">+  // hit two with tight shrinkage</span>
<a href="#l144.313"></a><span id="l144.313" class="difflineplus">+  sel.clearRange(18, 22);</span>
<a href="#l144.314"></a><span id="l144.314" class="difflineplus">+  asr([14, 17], [23, 26]);</span>
<a href="#l144.315"></a><span id="l144.315" class="difflineplus">+</span>
<a href="#l144.316"></a><span id="l144.316" class="difflineplus">+  // hit two with broad shrinkage</span>
<a href="#l144.317"></a><span id="l144.317" class="difflineplus">+  sel.clearRange(15, 25);</span>
<a href="#l144.318"></a><span id="l144.318" class="difflineplus">+  asr([14, 14], [26, 26]);</span>
<a href="#l144.319"></a><span id="l144.319" class="difflineplus">+</span>
<a href="#l144.320"></a><span id="l144.320" class="difflineplus">+  // obliterate</span>
<a href="#l144.321"></a><span id="l144.321" class="difflineplus">+  sel.clearRange(0, 100);</span>
<a href="#l144.322"></a><span id="l144.322" class="difflineplus">+  asr();</span>
<a href="#l144.323"></a><span id="l144.323" class="difflineplus">+</span>
<a href="#l144.324"></a><span id="l144.324" class="difflineplus">+  // multi-obliterate</span>
<a href="#l144.325"></a><span id="l144.325" class="difflineplus">+  sel.rangedSelect(10, 20, true);</span>
<a href="#l144.326"></a><span id="l144.326" class="difflineplus">+  sel.rangedSelect(30, 40, true);</span>
<a href="#l144.327"></a><span id="l144.327" class="difflineplus">+  sel.clearRange(0, 100);</span>
<a href="#l144.328"></a><span id="l144.328" class="difflineplus">+  asr();</span>
<a href="#l144.329"></a><span id="l144.329" class="difflineplus">+</span>
<a href="#l144.330"></a><span id="l144.330" class="difflineplus">+  // obliterate with shrinkage</span>
<a href="#l144.331"></a><span id="l144.331" class="difflineplus">+  sel.rangedSelect(5, 10, true);</span>
<a href="#l144.332"></a><span id="l144.332" class="difflineplus">+  sel.rangedSelect(15, 20, true);</span>
<a href="#l144.333"></a><span id="l144.333" class="difflineplus">+  sel.rangedSelect(25, 30, true);</span>
<a href="#l144.334"></a><span id="l144.334" class="difflineplus">+  sel.rangedSelect(35, 40, true);</span>
<a href="#l144.335"></a><span id="l144.335" class="difflineplus">+  sel.clearRange(7, 37);</span>
<a href="#l144.336"></a><span id="l144.336" class="difflineplus">+  asr([5, 6], [38, 40]);</span>
<a href="#l144.337"></a><span id="l144.337" class="difflineplus">+</span>
<a href="#l144.338"></a><span id="l144.338" class="difflineplus">+  // -- selectAll</span>
<a href="#l144.339"></a><span id="l144.339" class="difflineplus">+  sel.selectAll();</span>
<a href="#l144.340"></a><span id="l144.340" class="difflineplus">+  asr([0, 100]);</span>
<a href="#l144.341"></a><span id="l144.341" class="difflineplus">+</span>
<a href="#l144.342"></a><span id="l144.342" class="difflineplus">+  // -- adjustSelection</span>
<a href="#l144.343"></a><span id="l144.343" class="difflineplus">+  // bump due to addition on simple select</span>
<a href="#l144.344"></a><span id="l144.344" class="difflineplus">+  sel.select(5);</span>
<a href="#l144.345"></a><span id="l144.345" class="difflineplus">+  sel.adjustSelection(5, 1);</span>
<a href="#l144.346"></a><span id="l144.346" class="difflineplus">+  asr([6, 6]);</span>
<a href="#l144.347"></a><span id="l144.347" class="difflineplus">+  aci(6);</span>
<a href="#l144.348"></a><span id="l144.348" class="difflineplus">+</span>
<a href="#l144.349"></a><span id="l144.349" class="difflineplus">+  sel.select(5);</span>
<a href="#l144.350"></a><span id="l144.350" class="difflineplus">+  sel.adjustSelection(0, 1);</span>
<a href="#l144.351"></a><span id="l144.351" class="difflineplus">+  asr([6, 6]);</span>
<a href="#l144.352"></a><span id="l144.352" class="difflineplus">+  aci(6);</span>
<a href="#l144.353"></a><span id="l144.353" class="difflineplus">+</span>
<a href="#l144.354"></a><span id="l144.354" class="difflineplus">+  // bump due to addition on ranged simple select</span>
<a href="#l144.355"></a><span id="l144.355" class="difflineplus">+  sel.rangedSelect(5, 5, false);</span>
<a href="#l144.356"></a><span id="l144.356" class="difflineplus">+  sel.adjustSelection(5, 1);</span>
<a href="#l144.357"></a><span id="l144.357" class="difflineplus">+  asr([6, 6]);</span>
<a href="#l144.358"></a><span id="l144.358" class="difflineplus">+  asp(6);</span>
<a href="#l144.359"></a><span id="l144.359" class="difflineplus">+  aci(6);</span>
<a href="#l144.360"></a><span id="l144.360" class="difflineplus">+</span>
<a href="#l144.361"></a><span id="l144.361" class="difflineplus">+  sel.rangedSelect(5, 5, false);</span>
<a href="#l144.362"></a><span id="l144.362" class="difflineplus">+  sel.adjustSelection(0, 1);</span>
<a href="#l144.363"></a><span id="l144.363" class="difflineplus">+  asr([6, 6]);</span>
<a href="#l144.364"></a><span id="l144.364" class="difflineplus">+  asp(6);</span>
<a href="#l144.365"></a><span id="l144.365" class="difflineplus">+  aci(6);</span>
<a href="#l144.366"></a><span id="l144.366" class="difflineplus">+</span>
<a href="#l144.367"></a><span id="l144.367" class="difflineplus">+  // bump due to addition on ranged select</span>
<a href="#l144.368"></a><span id="l144.368" class="difflineplus">+  sel.rangedSelect(5, 7, false);</span>
<a href="#l144.369"></a><span id="l144.369" class="difflineplus">+  sel.adjustSelection(5, 1);</span>
<a href="#l144.370"></a><span id="l144.370" class="difflineplus">+  asr([6, 8]);</span>
<a href="#l144.371"></a><span id="l144.371" class="difflineplus">+  asp(6);</span>
<a href="#l144.372"></a><span id="l144.372" class="difflineplus">+  aci(8);</span>
<a href="#l144.373"></a><span id="l144.373" class="difflineplus">+</span>
<a href="#l144.374"></a><span id="l144.374" class="difflineplus">+  // no-op with addition</span>
<a href="#l144.375"></a><span id="l144.375" class="difflineplus">+  sel.rangedSelect(0, 3, false);</span>
<a href="#l144.376"></a><span id="l144.376" class="difflineplus">+  sel.adjustSelection(10, 1);</span>
<a href="#l144.377"></a><span id="l144.377" class="difflineplus">+  asr([0, 3]);</span>
<a href="#l144.378"></a><span id="l144.378" class="difflineplus">+  asp(0);</span>
<a href="#l144.379"></a><span id="l144.379" class="difflineplus">+  aci(3);</span>
<a href="#l144.380"></a><span id="l144.380" class="difflineplus">+</span>
<a href="#l144.381"></a><span id="l144.381" class="difflineplus">+  // split due to addition</span>
<a href="#l144.382"></a><span id="l144.382" class="difflineplus">+  sel.rangedSelect(5, 6, false);</span>
<a href="#l144.383"></a><span id="l144.383" class="difflineplus">+  sel.adjustSelection(6, 1);</span>
<a href="#l144.384"></a><span id="l144.384" class="difflineplus">+  asr([5, 5], [7, 7]);</span>
<a href="#l144.385"></a><span id="l144.385" class="difflineplus">+  asp(5);</span>
<a href="#l144.386"></a><span id="l144.386" class="difflineplus">+  aci(7);</span>
<a href="#l144.387"></a><span id="l144.387" class="difflineplus">+</span>
<a href="#l144.388"></a><span id="l144.388" class="difflineplus">+  // shift due to removal on simple select</span>
<a href="#l144.389"></a><span id="l144.389" class="difflineplus">+  sel.select(5);</span>
<a href="#l144.390"></a><span id="l144.390" class="difflineplus">+  sel.adjustSelection(0, -1);</span>
<a href="#l144.391"></a><span id="l144.391" class="difflineplus">+  asr([4, 4]);</span>
<a href="#l144.392"></a><span id="l144.392" class="difflineplus">+  aci(4);</span>
<a href="#l144.393"></a><span id="l144.393" class="difflineplus">+</span>
<a href="#l144.394"></a><span id="l144.394" class="difflineplus">+  // shift due to removal on ranged simple select</span>
<a href="#l144.395"></a><span id="l144.395" class="difflineplus">+  sel.rangedSelect(5, 5, false);</span>
<a href="#l144.396"></a><span id="l144.396" class="difflineplus">+  sel.adjustSelection(0, -1);</span>
<a href="#l144.397"></a><span id="l144.397" class="difflineplus">+  asr([4, 4]);</span>
<a href="#l144.398"></a><span id="l144.398" class="difflineplus">+  asp(4);</span>
<a href="#l144.399"></a><span id="l144.399" class="difflineplus">+  aci(4);</span>
<a href="#l144.400"></a><span id="l144.400" class="difflineplus">+</span>
<a href="#l144.401"></a><span id="l144.401" class="difflineplus">+  // nuked due to removal on simple select</span>
<a href="#l144.402"></a><span id="l144.402" class="difflineplus">+  sel.select(5);</span>
<a href="#l144.403"></a><span id="l144.403" class="difflineplus">+  sel.adjustSelection(5, -1);</span>
<a href="#l144.404"></a><span id="l144.404" class="difflineplus">+  asr();</span>
<a href="#l144.405"></a><span id="l144.405" class="difflineplus">+  aci(-1);</span>
<a href="#l144.406"></a><span id="l144.406" class="difflineplus">+</span>
<a href="#l144.407"></a><span id="l144.407" class="difflineplus">+  // upper tight shrinkage due to removal</span>
<a href="#l144.408"></a><span id="l144.408" class="difflineplus">+  sel.rangedSelect(5, 10, false);</span>
<a href="#l144.409"></a><span id="l144.409" class="difflineplus">+  sel.adjustSelection(10, -1);</span>
<a href="#l144.410"></a><span id="l144.410" class="difflineplus">+  asr([5, 9]);</span>
<a href="#l144.411"></a><span id="l144.411" class="difflineplus">+  asp(5);</span>
<a href="#l144.412"></a><span id="l144.412" class="difflineplus">+  aci(-1);</span>
<a href="#l144.413"></a><span id="l144.413" class="difflineplus">+</span>
<a href="#l144.414"></a><span id="l144.414" class="difflineplus">+  // upper broad shrinkage due to removal</span>
<a href="#l144.415"></a><span id="l144.415" class="difflineplus">+  sel.rangedSelect(5, 10, false);</span>
<a href="#l144.416"></a><span id="l144.416" class="difflineplus">+  sel.adjustSelection(6, -10);</span>
<a href="#l144.417"></a><span id="l144.417" class="difflineplus">+  asr([5, 5]);</span>
<a href="#l144.418"></a><span id="l144.418" class="difflineplus">+  asp(5);</span>
<a href="#l144.419"></a><span id="l144.419" class="difflineplus">+  aci(-1);</span>
<a href="#l144.420"></a><span id="l144.420" class="difflineplus">+</span>
<a href="#l144.421"></a><span id="l144.421" class="difflineplus">+  // lower tight shrinkage due to removal</span>
<a href="#l144.422"></a><span id="l144.422" class="difflineplus">+  sel.rangedSelect(5, 10, false);</span>
<a href="#l144.423"></a><span id="l144.423" class="difflineplus">+  sel.adjustSelection(5, -1);</span>
<a href="#l144.424"></a><span id="l144.424" class="difflineplus">+  asr([5, 9]);</span>
<a href="#l144.425"></a><span id="l144.425" class="difflineplus">+  asp(-1);</span>
<a href="#l144.426"></a><span id="l144.426" class="difflineplus">+  aci(9);</span>
<a href="#l144.427"></a><span id="l144.427" class="difflineplus">+</span>
<a href="#l144.428"></a><span id="l144.428" class="difflineplus">+  // lower broad shrinkage due to removal</span>
<a href="#l144.429"></a><span id="l144.429" class="difflineplus">+  sel.rangedSelect(5, 10, false);</span>
<a href="#l144.430"></a><span id="l144.430" class="difflineplus">+  sel.adjustSelection(0, -10);</span>
<a href="#l144.431"></a><span id="l144.431" class="difflineplus">+  asr([0, 0]);</span>
<a href="#l144.432"></a><span id="l144.432" class="difflineplus">+  asp(-1);</span>
<a href="#l144.433"></a><span id="l144.433" class="difflineplus">+  aci(0);</span>
<a href="#l144.434"></a><span id="l144.434" class="difflineplus">+</span>
<a href="#l144.435"></a><span id="l144.435" class="difflineplus">+  // tight nuke due to removal</span>
<a href="#l144.436"></a><span id="l144.436" class="difflineplus">+  sel.rangedSelect(5, 10, false);</span>
<a href="#l144.437"></a><span id="l144.437" class="difflineplus">+  sel.adjustSelection(5, -6);</span>
<a href="#l144.438"></a><span id="l144.438" class="difflineplus">+  asr();</span>
<a href="#l144.439"></a><span id="l144.439" class="difflineplus">+  asp(-1);</span>
<a href="#l144.440"></a><span id="l144.440" class="difflineplus">+  aci(-1);</span>
<a href="#l144.441"></a><span id="l144.441" class="difflineplus">+</span>
<a href="#l144.442"></a><span id="l144.442" class="difflineplus">+  // broad nuke due to removal</span>
<a href="#l144.443"></a><span id="l144.443" class="difflineplus">+  sel.rangedSelect(5, 10, false);</span>
<a href="#l144.444"></a><span id="l144.444" class="difflineplus">+  sel.adjustSelection(0, -20);</span>
<a href="#l144.445"></a><span id="l144.445" class="difflineplus">+  asr();</span>
<a href="#l144.446"></a><span id="l144.446" class="difflineplus">+  asp(-1);</span>
<a href="#l144.447"></a><span id="l144.447" class="difflineplus">+  aci(-1);</span>
<a href="#l144.448"></a><span id="l144.448" class="difflineplus">+}</span>
<a href="#l144.449"></a><span id="l144.449">\ No newline at end of file</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l145.1"></a><span id="l145.1" class="difflineminus">--- a/mailnews/base/test/unit/test_junkWhitelisting.js</span>
<a href="#l145.2"></a><span id="l145.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_junkWhitelisting.js</span>
<a href="#l145.3"></a><span id="l145.3" class="difflineat">@@ -213,11 +213,14 @@ function continueTest()</span>
<a href="#l145.4"></a><span id="l145.4">   spamSettings.initialize(server);</span>
<a href="#l145.5"></a><span id="l145.5">   do_check_false(spamSettings.checkWhiteList(hdrs[kDomainTest]));</span>
<a href="#l145.6"></a><span id="l145.6"> </span>
<a href="#l145.7"></a><span id="l145.7">   // stop suppressing whitelist by domain</span>
<a href="#l145.8"></a><span id="l145.8">   server.setBoolValue(&quot;inhibitWhiteListingIdentityDomain&quot;, false);</span>
<a href="#l145.9"></a><span id="l145.9">   spamSettings.initialize(server);</span>
<a href="#l145.10"></a><span id="l145.10">   do_check_true(spamSettings.checkWhiteList(hdrs[kDomainTest]));</span>
<a href="#l145.11"></a><span id="l145.11"> </span>
<a href="#l145.12"></a><span id="l145.12" class="difflineplus">+  // Free our globals</span>
<a href="#l145.13"></a><span id="l145.13" class="difflineplus">+  hdrs = null;</span>
<a href="#l145.14"></a><span id="l145.14" class="difflineplus">+</span>
<a href="#l145.15"></a><span id="l145.15">   do_test_finished();</span>
<a href="#l145.16"></a><span id="l145.16"> }</span>
<a href="#l145.17"></a><span id="l145.17"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l146.1"></a><span id="l146.1" class="difflineminus">--- a/mailnews/base/test/unit/test_nsIMsgFolderListenerLocal.js</span>
<a href="#l146.2"></a><span id="l146.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_nsIMsgFolderListenerLocal.js</span>
<a href="#l146.3"></a><span id="l146.3" class="difflineat">@@ -278,12 +278,14 @@ function doTest(test)</span>
<a href="#l146.4"></a><span id="l146.4">     var testFn = gTestArray[test-1];</span>
<a href="#l146.5"></a><span id="l146.5">     // Set a limit of three seconds; if the notifications haven't arrived by then there's a problem.</span>
<a href="#l146.6"></a><span id="l146.6">     do_timeout(10000, &quot;if (gTest == &quot;+test+&quot;) \</span>
<a href="#l146.7"></a><span id="l146.7">       do_throw('Notifications not received in 10000 ms for operation &quot;+testFn.name+&quot;, current status is '+gCurrStatus);&quot;);</span>
<a href="#l146.8"></a><span id="l146.8">     testFn();</span>
<a href="#l146.9"></a><span id="l146.9">   }</span>
<a href="#l146.10"></a><span id="l146.10">   else</span>
<a href="#l146.11"></a><span id="l146.11">   {</span>
<a href="#l146.12"></a><span id="l146.12" class="difflineplus">+    gHdrsReceived = null;</span>
<a href="#l146.13"></a><span id="l146.13" class="difflineplus">+    gMsgHdrs = null;</span>
<a href="#l146.14"></a><span id="l146.14" class="difflineplus">+    gMFNService.removeListener(gMFListener);</span>
<a href="#l146.15"></a><span id="l146.15">     do_test_finished(); // for the one in run_test()</span>
<a href="#l146.16"></a><span id="l146.16" class="difflineminus">-    gMFNService.removeListener(gMFListener);</span>
<a href="#l146.17"></a><span id="l146.17">   }</span>
<a href="#l146.18"></a><span id="l146.18"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l147.1"></a><span id="l147.1" class="difflineminus">--- a/mailnews/base/test/unit/test_searchJunk.js</span>
<a href="#l147.2"></a><span id="l147.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_searchJunk.js</span>
<a href="#l147.3"></a><span id="l147.3" class="difflineat">@@ -252,11 +252,12 @@ function testJunkSearch()</span>
<a href="#l147.4"></a><span id="l147.4">                          test.attrib,</span>
<a href="#l147.5"></a><span id="l147.5">                          test.op,</span>
<a href="#l147.6"></a><span id="l147.6">                          test.count,</span>
<a href="#l147.7"></a><span id="l147.7">                          testJunkSearch);</span>
<a href="#l147.8"></a><span id="l147.8">   }</span>
<a href="#l147.9"></a><span id="l147.9">   else</span>
<a href="#l147.10"></a><span id="l147.10">   {</span>
<a href="#l147.11"></a><span id="l147.11">     testObject = null;</span>
<a href="#l147.12"></a><span id="l147.12" class="difflineplus">+    hdr = null;</span>
<a href="#l147.13"></a><span id="l147.13">     do_test_finished();</span>
<a href="#l147.14"></a><span id="l147.14">   }</span>
<a href="#l147.15"></a><span id="l147.15"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l148.1"></a><span id="l148.1" class="difflineminus">--- a/mailnews/base/test/unit/test_searchTag.js</span>
<a href="#l148.2"></a><span id="l148.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_searchTag.js</span>
<a href="#l148.3"></a><span id="l148.3" class="difflineat">@@ -402,12 +402,13 @@ function testKeywordSearch()</span>
<a href="#l148.4"></a><span id="l148.4">                          nsMsgSearchAttrib.Keywords,</span>
<a href="#l148.5"></a><span id="l148.5">                          test.op,</span>
<a href="#l148.6"></a><span id="l148.6">                          test.count,</span>
<a href="#l148.7"></a><span id="l148.7">                          testKeywordSearch);</span>
<a href="#l148.8"></a><span id="l148.8">   }</span>
<a href="#l148.9"></a><span id="l148.9">   else</span>
<a href="#l148.10"></a><span id="l148.10">   {</span>
<a href="#l148.11"></a><span id="l148.11">     testObject = null;</span>
<a href="#l148.12"></a><span id="l148.12" class="difflineplus">+    hdr = null;</span>
<a href="#l148.13"></a><span id="l148.13">     do_test_finished();</span>
<a href="#l148.14"></a><span id="l148.14">   }</span>
<a href="#l148.15"></a><span id="l148.15"> }</span>
<a href="#l148.16"></a><span id="l148.16"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l149.1"></a><span id="l149.1" class="difflineminus">--- a/mailnews/base/test/unit/test_viewWrapper_logic.js</span>
<a href="#l149.2"></a><span id="l149.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_viewWrapper_logic.js</span>
<a href="#l149.3"></a><span id="l149.3" class="difflineat">@@ -1,13 +1,14 @@</span>
<a href="#l149.4"></a><span id="l149.4"> load(&quot;../../mailnews/resources/messageGenerator.js&quot;);</span>
<a href="#l149.5"></a><span id="l149.5"> load(&quot;../../mailnews/resources/messageModifier.js&quot;);</span>
<a href="#l149.6"></a><span id="l149.6"> load(&quot;../../mailnews/resources/asyncTestUtils.js&quot;);</span>
<a href="#l149.7"></a><span id="l149.7"> </span>
<a href="#l149.8"></a><span id="l149.8"> load(&quot;../../mailnews/resources/viewWrapperTestUtils.js&quot;);</span>
<a href="#l149.9"></a><span id="l149.9" class="difflineplus">+initViewWrapperTestUtils();</span>
<a href="#l149.10"></a><span id="l149.10"> </span>
<a href="#l149.11"></a><span id="l149.11"> /**</span>
<a href="#l149.12"></a><span id="l149.12">  * Verify that flipping between threading and grouped by sort settings properly</span>
<a href="#l149.13"></a><span id="l149.13">  *  clears the other flag.  (Because they're mutually exclusive, you see.)</span>
<a href="#l149.14"></a><span id="l149.14">  */</span>
<a href="#l149.15"></a><span id="l149.15"> function test_threading_grouping_mutual_exclusion () {</span>
<a href="#l149.16"></a><span id="l149.16">   let viewWrapper = make_view_wrapper();</span>
<a href="#l149.17"></a><span id="l149.17">   let folder = make_empty_folder();</span>
<a href="#l149.18"></a><span id="l149.18" class="difflineat">@@ -153,20 +154,64 @@ function test_mailviews_persistence() {</span>
<a href="#l149.19"></a><span id="l149.19">   // ...open and verify that it did not take!</span>
<a href="#l149.20"></a><span id="l149.20">   yield async_view_open(viewWrapper, folder);</span>
<a href="#l149.21"></a><span id="l149.21">   do_check_eq(viewWrapper.mailViewIndex, MailViewConstants.kViewItemAll);</span>
<a href="#l149.22"></a><span id="l149.22"> </span>
<a href="#l149.23"></a><span id="l149.23">   // put the mailview setting back so other tests work</span>
<a href="#l149.24"></a><span id="l149.24">   gMockViewWrapperListener.shouldUseMailViews = true;</span>
<a href="#l149.25"></a><span id="l149.25"> }</span>
<a href="#l149.26"></a><span id="l149.26"> </span>
<a href="#l149.27"></a><span id="l149.27" class="difflineplus">+/**</span>
<a href="#l149.28"></a><span id="l149.28" class="difflineplus">+ * Make sure:</span>
<a href="#l149.29"></a><span id="l149.29" class="difflineplus">+ * - View update depth increments / decrements as expected, and triggers a</span>
<a href="#l149.30"></a><span id="l149.30" class="difflineplus">+ *    view rebuild when expected.</span>
<a href="#l149.31"></a><span id="l149.31" class="difflineplus">+ * - View update depth can't go below zero resulting in odd happenings.</span>
<a href="#l149.32"></a><span id="l149.32" class="difflineplus">+ * - That the view update depth is zeroed by a close so that we don't</span>
<a href="#l149.33"></a><span id="l149.33" class="difflineplus">+ *    get into awkward states.</span>
<a href="#l149.34"></a><span id="l149.34" class="difflineplus">+ *</span>
<a href="#l149.35"></a><span id="l149.35" class="difflineplus">+ * @bug 498145</span>
<a href="#l149.36"></a><span id="l149.36" class="difflineplus">+ */</span>
<a href="#l149.37"></a><span id="l149.37" class="difflineplus">+function test_view_update_depth_logic() {</span>
<a href="#l149.38"></a><span id="l149.38" class="difflineplus">+  let viewWrapper = make_view_wrapper();</span>
<a href="#l149.39"></a><span id="l149.39" class="difflineplus">+</span>
<a href="#l149.40"></a><span id="l149.40" class="difflineplus">+  // create an instance-specific dummy method that counts calls t</span>
<a href="#l149.41"></a><span id="l149.41" class="difflineplus">+  //  _applyViewChanges</span>
<a href="#l149.42"></a><span id="l149.42" class="difflineplus">+  let applyViewCount = 0;</span>
<a href="#l149.43"></a><span id="l149.43" class="difflineplus">+  viewWrapper._applyViewChanges = function() { applyViewCount++; };</span>
<a href="#l149.44"></a><span id="l149.44" class="difflineplus">+</span>
<a href="#l149.45"></a><span id="l149.45" class="difflineplus">+  // - view update depth basics</span>
<a href="#l149.46"></a><span id="l149.46" class="difflineplus">+  do_check_eq(viewWrapper._viewUpdateDepth, 0);</span>
<a href="#l149.47"></a><span id="l149.47" class="difflineplus">+  viewWrapper.beginViewUpdate();</span>
<a href="#l149.48"></a><span id="l149.48" class="difflineplus">+  do_check_eq(viewWrapper._viewUpdateDepth, 1);</span>
<a href="#l149.49"></a><span id="l149.49" class="difflineplus">+  viewWrapper.beginViewUpdate();</span>
<a href="#l149.50"></a><span id="l149.50" class="difflineplus">+  do_check_eq(viewWrapper._viewUpdateDepth, 2);</span>
<a href="#l149.51"></a><span id="l149.51" class="difflineplus">+  viewWrapper.endViewUpdate();</span>
<a href="#l149.52"></a><span id="l149.52" class="difflineplus">+  do_check_eq(applyViewCount, 0);</span>
<a href="#l149.53"></a><span id="l149.53" class="difflineplus">+  do_check_eq(viewWrapper._viewUpdateDepth, 1);</span>
<a href="#l149.54"></a><span id="l149.54" class="difflineplus">+  viewWrapper.endViewUpdate();</span>
<a href="#l149.55"></a><span id="l149.55" class="difflineplus">+  do_check_eq(applyViewCount, 1);</span>
<a href="#l149.56"></a><span id="l149.56" class="difflineplus">+  do_check_eq(viewWrapper._viewUpdateDepth, 0);</span>
<a href="#l149.57"></a><span id="l149.57" class="difflineplus">+</span>
<a href="#l149.58"></a><span id="l149.58" class="difflineplus">+  // - don't go below zero! (and don't trigger.)</span>
<a href="#l149.59"></a><span id="l149.59" class="difflineplus">+  applyViewCount = 0;</span>
<a href="#l149.60"></a><span id="l149.60" class="difflineplus">+  viewWrapper.endViewUpdate();</span>
<a href="#l149.61"></a><span id="l149.61" class="difflineplus">+  do_check_eq(applyViewCount, 0);</span>
<a href="#l149.62"></a><span id="l149.62" class="difflineplus">+  do_check_eq(viewWrapper._viewUpdateDepth, 0);</span>
<a href="#l149.63"></a><span id="l149.63" class="difflineplus">+</span>
<a href="#l149.64"></a><span id="l149.64" class="difflineplus">+  // - depth zeroed on clear</span>
<a href="#l149.65"></a><span id="l149.65" class="difflineplus">+  viewWrapper.beginViewUpdate();</span>
<a href="#l149.66"></a><span id="l149.66" class="difflineplus">+  viewWrapper.close(); // this does little else because there is nothing open</span>
<a href="#l149.67"></a><span id="l149.67" class="difflineplus">+  do_check_eq(viewWrapper._viewUpdateDepth, 0);</span>
<a href="#l149.68"></a><span id="l149.68" class="difflineplus">+}</span>
<a href="#l149.69"></a><span id="l149.69" class="difflineplus">+</span>
<a href="#l149.70"></a><span id="l149.70"> var tests = [</span>
<a href="#l149.71"></a><span id="l149.71">   test_threading_grouping_mutual_exclusion,</span>
<a href="#l149.72"></a><span id="l149.72">   test_sort_primary,</span>
<a href="#l149.73"></a><span id="l149.73">   test_sort_secondary_explicit,</span>
<a href="#l149.74"></a><span id="l149.74">   test_sort_secondary_implicit,</span>
<a href="#l149.75"></a><span id="l149.75">   test_mailviews_persistence,</span>
<a href="#l149.76"></a><span id="l149.76" class="difflineplus">+  test_view_update_depth_logic,</span>
<a href="#l149.77"></a><span id="l149.77"> ];</span>
<a href="#l149.78"></a><span id="l149.78"> </span>
<a href="#l149.79"></a><span id="l149.79"> function run_test() {</span>
<a href="#l149.80"></a><span id="l149.80">   loadLocalMailAccount();</span>
<a href="#l149.81"></a><span id="l149.81">   async_run_tests(tests);</span>
<a href="#l149.82"></a><span id="l149.82"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l150.1"></a><span id="l150.1" class="difflineminus">--- a/mailnews/base/test/unit/test_viewWrapper_realFolder.js</span>
<a href="#l150.2"></a><span id="l150.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_viewWrapper_realFolder.js</span>
<a href="#l150.3"></a><span id="l150.3" class="difflineat">@@ -4,16 +4,17 @@</span>
<a href="#l150.4"></a><span id="l150.4">  *  newsgroup specific.)</span>
<a href="#l150.5"></a><span id="l150.5">  */</span>
<a href="#l150.6"></a><span id="l150.6"> </span>
<a href="#l150.7"></a><span id="l150.7"> load(&quot;../../mailnews/resources/messageGenerator.js&quot;);</span>
<a href="#l150.8"></a><span id="l150.8"> load(&quot;../../mailnews/resources/messageModifier.js&quot;);</span>
<a href="#l150.9"></a><span id="l150.9"> load(&quot;../../mailnews/resources/asyncTestUtils.js&quot;);</span>
<a href="#l150.10"></a><span id="l150.10"> </span>
<a href="#l150.11"></a><span id="l150.11"> load(&quot;../../mailnews/resources/viewWrapperTestUtils.js&quot;);</span>
<a href="#l150.12"></a><span id="l150.12" class="difflineplus">+initViewWrapperTestUtils();</span>
<a href="#l150.13"></a><span id="l150.13"> </span>
<a href="#l150.14"></a><span id="l150.14"> /* ===== Real Folder, no features ===== */</span>
<a href="#l150.15"></a><span id="l150.15"> </span>
<a href="#l150.16"></a><span id="l150.16"> /**</span>
<a href="#l150.17"></a><span id="l150.17">  * Open a pre-populated real folder, make sure all the messages show up.</span>
<a href="#l150.18"></a><span id="l150.18">  */</span>
<a href="#l150.19"></a><span id="l150.19"> function test_real_folder_load() {</span>
<a href="#l150.20"></a><span id="l150.20">   let viewWrapper = make_view_wrapper();</span>
<a href="#l150.21"></a><span id="l150.21" class="difflineat">@@ -64,30 +65,47 @@ function test_real_folder_load_after_rea</span>
<a href="#l150.22"></a><span id="l150.22">   verify_messages_in_view(setOne, viewWrapper);</span>
<a href="#l150.23"></a><span id="l150.23"> </span>
<a href="#l150.24"></a><span id="l150.24">   let [folderTwo, setTwo] = make_folder_with_sets(1);</span>
<a href="#l150.25"></a><span id="l150.25">   yield async_view_open(viewWrapper, folderTwo);</span>
<a href="#l150.26"></a><span id="l150.26">   verify_messages_in_view(setTwo, viewWrapper);</span>
<a href="#l150.27"></a><span id="l150.27"> }</span>
<a href="#l150.28"></a><span id="l150.28"> </span>
<a href="#l150.29"></a><span id="l150.29"> /* ===== Real Folder, Threading Modes ==== */</span>
<a href="#l150.30"></a><span id="l150.30" class="difflineplus">+/*</span>
<a href="#l150.31"></a><span id="l150.31" class="difflineplus">+ * The first three tests that verify setting the threading flags has the</span>
<a href="#l150.32"></a><span id="l150.32" class="difflineplus">+ *  expected outcome do this by creating the view from scratch with the view</span>
<a href="#l150.33"></a><span id="l150.33" class="difflineplus">+ *  flags applied.  The view threading persistence test handles making sure</span>
<a href="#l150.34"></a><span id="l150.34" class="difflineplus">+ *  that changes in threading on-the-fly work from the perspective of the</span>
<a href="#l150.35"></a><span id="l150.35" class="difflineplus">+ *  bits and what not.  None of these are tests of the view implementation's</span>
<a href="#l150.36"></a><span id="l150.36" class="difflineplus">+ *  threading/grouping logic, just sanity checking that we are doing the right</span>
<a href="#l150.37"></a><span id="l150.37" class="difflineplus">+ *  thing.</span>
<a href="#l150.38"></a><span id="l150.38" class="difflineplus">+ */</span>
<a href="#l150.39"></a><span id="l150.39" class="difflineplus">+</span>
<a href="#l150.40"></a><span id="l150.40"> function test_real_folder_threading_unthreaded() {</span>
<a href="#l150.41"></a><span id="l150.41">   let viewWrapper = make_view_wrapper();</span>
<a href="#l150.42"></a><span id="l150.42">   let folder = make_empty_folder();</span>
<a href="#l150.43"></a><span id="l150.43"> </span>
<a href="#l150.44"></a><span id="l150.44">   // create a single maximally nested thread.</span>
<a href="#l150.45"></a><span id="l150.45">   const count = 10;</span>
<a href="#l150.46"></a><span id="l150.46">   let messageSet =</span>
<a href="#l150.47"></a><span id="l150.47">     new SyntheticMessageSet(gMessageScenarioFactory.directReply(count));</span>
<a href="#l150.48"></a><span id="l150.48">   add_sets_to_folder(folder, [messageSet]);</span>
<a href="#l150.49"></a><span id="l150.49"> </span>
<a href="#l150.50"></a><span id="l150.50">   // verify that we are not threaded (or grouped)</span>
<a href="#l150.51"></a><span id="l150.51">   yield async_view_open(viewWrapper, folder);</span>
<a href="#l150.52"></a><span id="l150.52">   viewWrapper.beginViewUpdate();</span>
<a href="#l150.53"></a><span id="l150.53" class="difflineminus">-  viewWrapper.showThreaded = false;</span>
<a href="#l150.54"></a><span id="l150.54" class="difflineplus">+  viewWrapper.showUnthreaded = true;</span>
<a href="#l150.55"></a><span id="l150.55" class="difflineplus">+  // whitebox test view flags (we've gotten them wrong before...)</span>
<a href="#l150.56"></a><span id="l150.56" class="difflineplus">+  assert_bit_not_set(viewWrapper._viewFlags,</span>
<a href="#l150.57"></a><span id="l150.57" class="difflineplus">+                     Ci.nsMsgViewFlagsType.kThreadedDisplay,</span>
<a href="#l150.58"></a><span id="l150.58" class="difflineplus">+                     &quot;View threaded bit should not be set.&quot;);</span>
<a href="#l150.59"></a><span id="l150.59" class="difflineplus">+  assert_bit_not_set(viewWrapper._viewFlags,</span>
<a href="#l150.60"></a><span id="l150.60" class="difflineplus">+                     Ci.nsMsgViewFlagsType.kGroupBySort,</span>
<a href="#l150.61"></a><span id="l150.61" class="difflineplus">+                     &quot;View group-by-sort bit should not be set.&quot;);</span>
<a href="#l150.62"></a><span id="l150.62">   yield async_view_end_update(viewWrapper);</span>
<a href="#l150.63"></a><span id="l150.63">   verify_view_level_histogram({0: count}, viewWrapper);</span>
<a href="#l150.64"></a><span id="l150.64"> }</span>
<a href="#l150.65"></a><span id="l150.65"> </span>
<a href="#l150.66"></a><span id="l150.66"> function test_real_folder_threading_threaded() {</span>
<a href="#l150.67"></a><span id="l150.67">   let viewWrapper = make_view_wrapper();</span>
<a href="#l150.68"></a><span id="l150.68">   let folder = make_empty_folder();</span>
<a href="#l150.69"></a><span id="l150.69"> </span>
<a href="#l150.70"></a><span id="l150.70" class="difflineat">@@ -96,18 +114,29 @@ function test_real_folder_threading_thre</span>
<a href="#l150.71"></a><span id="l150.71">   let messageSet =</span>
<a href="#l150.72"></a><span id="l150.72">     new SyntheticMessageSet(gMessageScenarioFactory.directReply(count));</span>
<a href="#l150.73"></a><span id="l150.73">   add_sets_to_folder(folder, [messageSet]);</span>
<a href="#l150.74"></a><span id="l150.74"> </span>
<a href="#l150.75"></a><span id="l150.75">   // verify that we are threaded (in such a way that we can't be grouped)</span>
<a href="#l150.76"></a><span id="l150.76">   yield async_view_open(viewWrapper, folder);</span>
<a href="#l150.77"></a><span id="l150.77">   viewWrapper.beginViewUpdate();</span>
<a href="#l150.78"></a><span id="l150.78">   viewWrapper.showThreaded = true;</span>
<a href="#l150.79"></a><span id="l150.79" class="difflineplus">+  // whitebox test view flags (we've gotten them wrong before...)</span>
<a href="#l150.80"></a><span id="l150.80" class="difflineplus">+  assert_bit_set(viewWrapper._viewFlags,</span>
<a href="#l150.81"></a><span id="l150.81" class="difflineplus">+                 Ci.nsMsgViewFlagsType.kThreadedDisplay,</span>
<a href="#l150.82"></a><span id="l150.82" class="difflineplus">+                 &quot;View threaded bit should be set.&quot;);</span>
<a href="#l150.83"></a><span id="l150.83" class="difflineplus">+  assert_bit_not_set(viewWrapper._viewFlags,</span>
<a href="#l150.84"></a><span id="l150.84" class="difflineplus">+                     Ci.nsMsgViewFlagsType.kGroupBySort,</span>
<a href="#l150.85"></a><span id="l150.85" class="difflineplus">+                     &quot;View group-by-sort bit should not be set.&quot;);</span>
<a href="#l150.86"></a><span id="l150.86" class="difflineplus">+  // expand everything so our logic below works.</span>
<a href="#l150.87"></a><span id="l150.87">   view_expand_all(viewWrapper);</span>
<a href="#l150.88"></a><span id="l150.88">   yield async_view_end_update(viewWrapper);</span>
<a href="#l150.89"></a><span id="l150.89" class="difflineplus">+  // blackbox test view flags: make sure IsContainer is true for the root</span>
<a href="#l150.90"></a><span id="l150.90" class="difflineplus">+  verify_view_row_at_index_is_container(viewWrapper, 0);</span>
<a href="#l150.91"></a><span id="l150.91" class="difflineplus">+  // do the histogram test to verify threading...</span>
<a href="#l150.92"></a><span id="l150.92">   let expectedHisto = {};</span>
<a href="#l150.93"></a><span id="l150.93">   for (let i = 0; i &lt; count; i++)</span>
<a href="#l150.94"></a><span id="l150.94">     expectedHisto[i] = 1;</span>
<a href="#l150.95"></a><span id="l150.95">   verify_view_level_histogram(expectedHisto, viewWrapper);</span>
<a href="#l150.96"></a><span id="l150.96"> }</span>
<a href="#l150.97"></a><span id="l150.97"> </span>
<a href="#l150.98"></a><span id="l150.98"> function test_real_folder_threading_grouped_by_sort() {</span>
<a href="#l150.99"></a><span id="l150.99">   let viewWrapper = make_view_wrapper();</span>
<a href="#l150.100"></a><span id="l150.100" class="difflineat">@@ -117,28 +146,115 @@ function test_real_folder_threading_grou</span>
<a href="#l150.101"></a><span id="l150.101">   const count = 5;</span>
<a href="#l150.102"></a><span id="l150.102">   let [folder, messageSet] = make_folder_with_sets([</span>
<a href="#l150.103"></a><span id="l150.103">     {count: count, age: {days: 2}, age_incr: {mins: 1}}]);</span>
<a href="#l150.104"></a><span id="l150.104"> </span>
<a href="#l150.105"></a><span id="l150.105">   // group-by-sort sorted by date</span>
<a href="#l150.106"></a><span id="l150.106">   yield async_view_open(viewWrapper, folder);</span>
<a href="#l150.107"></a><span id="l150.107">   viewWrapper.beginViewUpdate();</span>
<a href="#l150.108"></a><span id="l150.108">   viewWrapper.showGroupedBySort = true;</span>
<a href="#l150.109"></a><span id="l150.109" class="difflineplus">+  // whitebox test view flags (we've gotten them wrong before...)</span>
<a href="#l150.110"></a><span id="l150.110" class="difflineplus">+  assert_bit_set(viewWrapper._viewFlags,</span>
<a href="#l150.111"></a><span id="l150.111" class="difflineplus">+                 Ci.nsMsgViewFlagsType.kThreadedDisplay,</span>
<a href="#l150.112"></a><span id="l150.112" class="difflineplus">+                 &quot;View threaded bit should be set.&quot;);</span>
<a href="#l150.113"></a><span id="l150.113" class="difflineplus">+  assert_bit_set(viewWrapper._viewFlags,</span>
<a href="#l150.114"></a><span id="l150.114" class="difflineplus">+                 Ci.nsMsgViewFlagsType.kGroupBySort,</span>
<a href="#l150.115"></a><span id="l150.115" class="difflineplus">+                 &quot;View group-by-sort bit should be set.&quot;);</span>
<a href="#l150.116"></a><span id="l150.116">   viewWrapper.sort(Ci.nsMsgViewSortType.byDate,</span>
<a href="#l150.117"></a><span id="l150.117">                    Ci.nsMsgViewSortOrder.ascending);</span>
<a href="#l150.118"></a><span id="l150.118">   // expand everyone</span>
<a href="#l150.119"></a><span id="l150.119">   view_expand_all(viewWrapper);</span>
<a href="#l150.120"></a><span id="l150.120">   yield async_view_end_update(viewWrapper);</span>
<a href="#l150.121"></a><span id="l150.121"> </span>
<a href="#l150.122"></a><span id="l150.122">   // make sure the level depths are correct</span>
<a href="#l150.123"></a><span id="l150.123">   verify_view_level_histogram({0: 1, 1: count}, viewWrapper);</span>
<a href="#l150.124"></a><span id="l150.124">   // and make sure the first dude is a dummy</span>
<a href="#l150.125"></a><span id="l150.125">   verify_view_row_at_index_is_dummy(viewWrapper, 0);</span>
<a href="#l150.126"></a><span id="l150.126"> }</span>
<a href="#l150.127"></a><span id="l150.127"> </span>
<a href="#l150.128"></a><span id="l150.128" class="difflineplus">+/**</span>
<a href="#l150.129"></a><span id="l150.129" class="difflineplus">+ * Verify that we the threading modes are persisted.  We are only checking</span>
<a href="#l150.130"></a><span id="l150.130" class="difflineplus">+ *  flags here; we trust the previous tests to have done their job.</span>
<a href="#l150.131"></a><span id="l150.131" class="difflineplus">+ */</span>
<a href="#l150.132"></a><span id="l150.132" class="difflineplus">+function test_real_folder_threading_persistence() {</span>
<a href="#l150.133"></a><span id="l150.133" class="difflineplus">+  let viewWrapper = make_view_wrapper();</span>
<a href="#l150.134"></a><span id="l150.134" class="difflineplus">+  let folder = make_empty_folder();</span>
<a href="#l150.135"></a><span id="l150.135" class="difflineplus">+</span>
<a href="#l150.136"></a><span id="l150.136" class="difflineplus">+  // create a single maximally nested thread.</span>
<a href="#l150.137"></a><span id="l150.137" class="difflineplus">+  const count = 10;</span>
<a href="#l150.138"></a><span id="l150.138" class="difflineplus">+  let messageSet =</span>
<a href="#l150.139"></a><span id="l150.139" class="difflineplus">+    new SyntheticMessageSet(gMessageScenarioFactory.directReply(count));</span>
<a href="#l150.140"></a><span id="l150.140" class="difflineplus">+  add_sets_to_folder(folder, [messageSet]);</span>
<a href="#l150.141"></a><span id="l150.141" class="difflineplus">+</span>
<a href="#l150.142"></a><span id="l150.142" class="difflineplus">+  // open the folder, set threaded mode, close it</span>
<a href="#l150.143"></a><span id="l150.143" class="difflineplus">+  yield async_view_open(viewWrapper, folder);</span>
<a href="#l150.144"></a><span id="l150.144" class="difflineplus">+  viewWrapper.showThreaded = true; // should be instantaneous</span>
<a href="#l150.145"></a><span id="l150.145" class="difflineplus">+  verify_view_row_at_index_is_container(viewWrapper, 0);</span>
<a href="#l150.146"></a><span id="l150.146" class="difflineplus">+  assert_bit_set(viewWrapper._viewFlags,</span>
<a href="#l150.147"></a><span id="l150.147" class="difflineplus">+                 Ci.nsMsgViewFlagsType.kThreadedDisplay,</span>
<a href="#l150.148"></a><span id="l150.148" class="difflineplus">+                 &quot;View threaded bit should be set.&quot;);</span>
<a href="#l150.149"></a><span id="l150.149" class="difflineplus">+  assert_bit_not_set(viewWrapper._viewFlags,</span>
<a href="#l150.150"></a><span id="l150.150" class="difflineplus">+                     Ci.nsMsgViewFlagsType.kGroupBySort,</span>
<a href="#l150.151"></a><span id="l150.151" class="difflineplus">+                     &quot;View group-by-sort bit should not be set.&quot;);</span>
<a href="#l150.152"></a><span id="l150.152" class="difflineplus">+  viewWrapper.close();</span>
<a href="#l150.153"></a><span id="l150.153" class="difflineplus">+</span>
<a href="#l150.154"></a><span id="l150.154" class="difflineplus">+  // open it again, make sure we're threaded, go unthreaded, close</span>
<a href="#l150.155"></a><span id="l150.155" class="difflineplus">+  yield async_view_open(viewWrapper, folder);</span>
<a href="#l150.156"></a><span id="l150.156" class="difflineplus">+  assert_true(viewWrapper.showThreaded, &quot;view should be threaded&quot;);</span>
<a href="#l150.157"></a><span id="l150.157" class="difflineplus">+  assert_false(viewWrapper.showUnthreaded, &quot;view is lying about threading&quot;);</span>
<a href="#l150.158"></a><span id="l150.158" class="difflineplus">+  assert_false(viewWrapper.showGroupedBySort, &quot;view is lying about threading&quot;);</span>
<a href="#l150.159"></a><span id="l150.159" class="difflineplus">+  verify_view_row_at_index_is_container(viewWrapper, 0);</span>
<a href="#l150.160"></a><span id="l150.160" class="difflineplus">+  assert_bit_set(viewWrapper._viewFlags,</span>
<a href="#l150.161"></a><span id="l150.161" class="difflineplus">+                 Ci.nsMsgViewFlagsType.kThreadedDisplay,</span>
<a href="#l150.162"></a><span id="l150.162" class="difflineplus">+                 &quot;View threaded bit should be set.&quot;);</span>
<a href="#l150.163"></a><span id="l150.163" class="difflineplus">+  assert_bit_not_set(viewWrapper._viewFlags,</span>
<a href="#l150.164"></a><span id="l150.164" class="difflineplus">+                     Ci.nsMsgViewFlagsType.kGroupBySort,</span>
<a href="#l150.165"></a><span id="l150.165" class="difflineplus">+                     &quot;View group-by-sort bit should not be set.&quot;);</span>
<a href="#l150.166"></a><span id="l150.166" class="difflineplus">+</span>
<a href="#l150.167"></a><span id="l150.167" class="difflineplus">+  viewWrapper.showUnthreaded = true;</span>
<a href="#l150.168"></a><span id="l150.168" class="difflineplus">+  assert_bit_not_set(viewWrapper._viewFlags,</span>
<a href="#l150.169"></a><span id="l150.169" class="difflineplus">+                     Ci.nsMsgViewFlagsType.kThreadedDisplay,</span>
<a href="#l150.170"></a><span id="l150.170" class="difflineplus">+                     &quot;View threaded bit should not be set.&quot;);</span>
<a href="#l150.171"></a><span id="l150.171" class="difflineplus">+  assert_bit_not_set(viewWrapper._viewFlags,</span>
<a href="#l150.172"></a><span id="l150.172" class="difflineplus">+                     Ci.nsMsgViewFlagsType.kGroupBySort,</span>
<a href="#l150.173"></a><span id="l150.173" class="difflineplus">+                     &quot;View group-by-sort bit should not be set.&quot;);</span>
<a href="#l150.174"></a><span id="l150.174" class="difflineplus">+  viewWrapper.close();</span>
<a href="#l150.175"></a><span id="l150.175" class="difflineplus">+</span>
<a href="#l150.176"></a><span id="l150.176" class="difflineplus">+  // open it again, make sure we're unthreaded, go grouped, close</span>
<a href="#l150.177"></a><span id="l150.177" class="difflineplus">+  yield async_view_open(viewWrapper, folder);</span>
<a href="#l150.178"></a><span id="l150.178" class="difflineplus">+  assert_true(viewWrapper.showUnthreaded, &quot;view should be unthreaded&quot;);</span>
<a href="#l150.179"></a><span id="l150.179" class="difflineplus">+  assert_false(viewWrapper.showThreaded, &quot;view is lying about threading&quot;);</span>
<a href="#l150.180"></a><span id="l150.180" class="difflineplus">+  assert_false(viewWrapper.showGroupedBySort, &quot;view is lying about threading&quot;);</span>
<a href="#l150.181"></a><span id="l150.181" class="difflineplus">+  assert_bit_not_set(viewWrapper._viewFlags,</span>
<a href="#l150.182"></a><span id="l150.182" class="difflineplus">+                     Ci.nsMsgViewFlagsType.kThreadedDisplay,</span>
<a href="#l150.183"></a><span id="l150.183" class="difflineplus">+                     &quot;View threaded bit should not be set.&quot;);</span>
<a href="#l150.184"></a><span id="l150.184" class="difflineplus">+  assert_bit_not_set(viewWrapper._viewFlags,</span>
<a href="#l150.185"></a><span id="l150.185" class="difflineplus">+                     Ci.nsMsgViewFlagsType.kGroupBySort,</span>
<a href="#l150.186"></a><span id="l150.186" class="difflineplus">+                     &quot;View group-by-sort bit should not be set.&quot;);</span>
<a href="#l150.187"></a><span id="l150.187" class="difflineplus">+</span>
<a href="#l150.188"></a><span id="l150.188" class="difflineplus">+  viewWrapper.showGroupedBySort = true;</span>
<a href="#l150.189"></a><span id="l150.189" class="difflineplus">+  assert_bit_set(viewWrapper._viewFlags,</span>
<a href="#l150.190"></a><span id="l150.190" class="difflineplus">+                 Ci.nsMsgViewFlagsType.kThreadedDisplay,</span>
<a href="#l150.191"></a><span id="l150.191" class="difflineplus">+                 &quot;View threaded bit should be set.&quot;);</span>
<a href="#l150.192"></a><span id="l150.192" class="difflineplus">+  assert_bit_set(viewWrapper._viewFlags, Ci.nsMsgViewFlagsType.kGroupBySort,</span>
<a href="#l150.193"></a><span id="l150.193" class="difflineplus">+                 &quot;View group-by-sort bit should be set.&quot;);</span>
<a href="#l150.194"></a><span id="l150.194" class="difflineplus">+  viewWrapper.close();</span>
<a href="#l150.195"></a><span id="l150.195" class="difflineplus">+</span>
<a href="#l150.196"></a><span id="l150.196" class="difflineplus">+  // open it again, make sure we're grouped.</span>
<a href="#l150.197"></a><span id="l150.197" class="difflineplus">+  yield async_view_open(viewWrapper, folder);</span>
<a href="#l150.198"></a><span id="l150.198" class="difflineplus">+  assert_true(viewWrapper.showGroupedBySort, &quot;view should be grouped&quot;);</span>
<a href="#l150.199"></a><span id="l150.199" class="difflineplus">+  assert_false(viewWrapper.showThreaded, &quot;view is lying about threading&quot;);</span>
<a href="#l150.200"></a><span id="l150.200" class="difflineplus">+  assert_false(viewWrapper.showUnthreaded, &quot;view is lying about threading&quot;);</span>
<a href="#l150.201"></a><span id="l150.201" class="difflineplus">+  assert_bit_set(viewWrapper._viewFlags,</span>
<a href="#l150.202"></a><span id="l150.202" class="difflineplus">+                 Ci.nsMsgViewFlagsType.kThreadedDisplay,</span>
<a href="#l150.203"></a><span id="l150.203" class="difflineplus">+                 &quot;View threaded bit should be set.&quot;);</span>
<a href="#l150.204"></a><span id="l150.204" class="difflineplus">+  assert_bit_set(viewWrapper._viewFlags, Ci.nsMsgViewFlagsType.kGroupBySort,</span>
<a href="#l150.205"></a><span id="l150.205" class="difflineplus">+                 &quot;View group-by-sort bit should be set.&quot;);</span>
<a href="#l150.206"></a><span id="l150.206" class="difflineplus">+}</span>
<a href="#l150.207"></a><span id="l150.207" class="difflineplus">+</span>
<a href="#l150.208"></a><span id="l150.208"> /* ===== Real Folder, View Flags ===== */</span>
<a href="#l150.209"></a><span id="l150.209"> </span>
<a href="#l150.210"></a><span id="l150.210"> /*</span>
<a href="#l150.211"></a><span id="l150.211">  * We cannot test the ignored flag for a local folder because we cannot ignore</span>
<a href="#l150.212"></a><span id="l150.212">  *  threads in a local folder.  Only newsgroups can do that and that's not</span>
<a href="#l150.213"></a><span id="l150.213">  *  easily testable at this time.</span>
<a href="#l150.214"></a><span id="l150.214">  */</span>
<a href="#l150.215"></a><span id="l150.215"> </span>
<a href="#l150.216"></a><span id="l150.216" class="difflineat">@@ -566,16 +682,17 @@ function test_real_folder_special_views_</span>
<a href="#l150.217"></a><span id="l150.217"> var tests = [</span>
<a href="#l150.218"></a><span id="l150.218">   test_real_folder_load,</span>
<a href="#l150.219"></a><span id="l150.219">   test_real_folder_update,</span>
<a href="#l150.220"></a><span id="l150.220">   test_real_folder_load_after_real_folder_load,</span>
<a href="#l150.221"></a><span id="l150.221">   // - threading modes</span>
<a href="#l150.222"></a><span id="l150.222">   test_real_folder_threading_unthreaded,</span>
<a href="#l150.223"></a><span id="l150.223">   test_real_folder_threading_threaded,</span>
<a href="#l150.224"></a><span id="l150.224">   test_real_folder_threading_grouped_by_sort,</span>
<a href="#l150.225"></a><span id="l150.225" class="difflineplus">+  test_real_folder_threading_persistence,</span>
<a href="#l150.226"></a><span id="l150.226">   // - view flags</span>
<a href="#l150.227"></a><span id="l150.227">   // (we cannot test ignored flags in local folders)</span>
<a href="#l150.228"></a><span id="l150.228">   test_real_folder_flags_show_unread,</span>
<a href="#l150.229"></a><span id="l150.229">   // - mail views: test the actual views</span>
<a href="#l150.230"></a><span id="l150.230">   test_real_folder_mail_views_unread,</span>
<a href="#l150.231"></a><span id="l150.231">   test_real_folder_mail_views_tags,</span>
<a href="#l150.232"></a><span id="l150.232">   test_real_folder_mail_views_not_deleted,</span>
<a href="#l150.233"></a><span id="l150.233">   // - mail views: test the custom views</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l151.1"></a><span id="l151.1" class="difflineminus">--- a/mailnews/base/test/unit/test_viewWrapper_virtualFolder.js</span>
<a href="#l151.2"></a><span id="l151.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_viewWrapper_virtualFolder.js</span>
<a href="#l151.3"></a><span id="l151.3" class="difflineat">@@ -11,16 +11,17 @@</span>
<a href="#l151.4"></a><span id="l151.4">  * We could test all these things, but my patch is way behind schedule...</span>
<a href="#l151.5"></a><span id="l151.5">  */</span>
<a href="#l151.6"></a><span id="l151.6"> </span>
<a href="#l151.7"></a><span id="l151.7"> load(&quot;../../mailnews/resources/messageGenerator.js&quot;);</span>
<a href="#l151.8"></a><span id="l151.8"> load(&quot;../../mailnews/resources/messageModifier.js&quot;);</span>
<a href="#l151.9"></a><span id="l151.9"> load(&quot;../../mailnews/resources/asyncTestUtils.js&quot;);</span>
<a href="#l151.10"></a><span id="l151.10"> </span>
<a href="#l151.11"></a><span id="l151.11"> load(&quot;../../mailnews/resources/viewWrapperTestUtils.js&quot;);</span>
<a href="#l151.12"></a><span id="l151.12" class="difflineplus">+initViewWrapperTestUtils();</span>
<a href="#l151.13"></a><span id="l151.13"> </span>
<a href="#l151.14"></a><span id="l151.14"> /**</span>
<a href="#l151.15"></a><span id="l151.15">  * Make sure we open a virtual folder backed by a single underlying folder</span>
<a href="#l151.16"></a><span id="l151.16">  *  correctly; no constraints.</span>
<a href="#l151.17"></a><span id="l151.17">  */</span>
<a href="#l151.18"></a><span id="l151.18"> function test_virtual_folder_single_load_no_pred() {</span>
<a href="#l151.19"></a><span id="l151.19">   let viewWrapper = make_view_wrapper();</span>
<a href="#l151.20"></a><span id="l151.20"> </span>
<a href="#l151.21"></a><span id="l151.21" class="difflineat">@@ -238,16 +239,32 @@ function test_virtual_folder_combo_load_</span>
<a href="#l151.22"></a><span id="l151.22">   yield async_view_open(viewWrapper, virtTwo);</span>
<a href="#l151.23"></a><span id="l151.23">   verify_messages_in_view([twoSubjBar], viewWrapper);</span>
<a href="#l151.24"></a><span id="l151.24"> </span>
<a href="#l151.25"></a><span id="l151.25">   yield async_view_open(viewWrapper, virtOne);</span>
<a href="#l151.26"></a><span id="l151.26">   verify_messages_in_view([oneSubjFoo], viewWrapper);</span>
<a href="#l151.27"></a><span id="l151.27"> }</span>
<a href="#l151.28"></a><span id="l151.28"> </span>
<a href="#l151.29"></a><span id="l151.29"> /**</span>
<a href="#l151.30"></a><span id="l151.30" class="difflineplus">+ * Make sure that if a server is listed in a virtual folder's search Uris that</span>
<a href="#l151.31"></a><span id="l151.31" class="difflineplus">+ *  it does not get into our list of _underlyingFolders.</span>
<a href="#l151.32"></a><span id="l151.32" class="difflineplus">+ */</span>
<a href="#l151.33"></a><span id="l151.33" class="difflineplus">+function test_virtual_folder_filters_out_servers() {</span>
<a href="#l151.34"></a><span id="l151.34" class="difflineplus">+  let viewWrapper = make_view_wrapper();</span>
<a href="#l151.35"></a><span id="l151.35" class="difflineplus">+</span>
<a href="#l151.36"></a><span id="l151.36" class="difflineplus">+  let [folders] = make_folders_with_sets(2, []);</span>
<a href="#l151.37"></a><span id="l151.37" class="difflineplus">+  folders.push(folders[0].rootFolder);</span>
<a href="#l151.38"></a><span id="l151.38" class="difflineplus">+  let virtFolder = make_virtual_folder(folders, {});</span>
<a href="#l151.39"></a><span id="l151.39" class="difflineplus">+  yield async_view_open(viewWrapper, virtFolder);</span>
<a href="#l151.40"></a><span id="l151.40" class="difflineplus">+</span>
<a href="#l151.41"></a><span id="l151.41" class="difflineplus">+  assert_equals(viewWrapper._underlyingFolders.length, 2,</span>
<a href="#l151.42"></a><span id="l151.42" class="difflineplus">+                &quot;Server folder should have been filtered out.&quot;);</span>
<a href="#l151.43"></a><span id="l151.43" class="difflineplus">+}</span>
<a href="#l151.44"></a><span id="l151.44" class="difflineplus">+</span>
<a href="#l151.45"></a><span id="l151.45" class="difflineplus">+/**</span>
<a href="#l151.46"></a><span id="l151.46">  * Verify that if one of the folders backing our virtual folder is deleted that</span>
<a href="#l151.47"></a><span id="l151.47">  *  we do not explode.  Then verify that if we remove the rest of them that the</span>
<a href="#l151.48"></a><span id="l151.48">  *  view wrapper closes itself.</span>
<a href="#l151.49"></a><span id="l151.49">  */</span>
<a href="#l151.50"></a><span id="l151.50"> function test_virtual_folder_underlying_folder_deleted() {</span>
<a href="#l151.51"></a><span id="l151.51">   let viewWrapper = make_view_wrapper();</span>
<a href="#l151.52"></a><span id="l151.52"> </span>
<a href="#l151.53"></a><span id="l151.53">   let [folderOne, oneSubjFoo, oneNopers] = make_folder_with_sets([</span>
<a href="#l151.54"></a><span id="l151.54" class="difflineat">@@ -397,16 +414,18 @@ var tests = [</span>
<a href="#l151.55"></a><span id="l151.55">   test_virtual_folder_multi_load_no_pred,</span>
<a href="#l151.56"></a><span id="l151.56">   test_virtual_folder_multi_load_simple_pred,</span>
<a href="#l151.57"></a><span id="l151.57">   test_virtual_folder_multi_load_complex_pred,</span>
<a href="#l151.58"></a><span id="l151.58">   test_virtual_folder_multi_load_alotta_folders_no_pred,</span>
<a href="#l151.59"></a><span id="l151.59">   test_virtual_folder_multi_load_alotta_folders_simple_pred,</span>
<a href="#l151.60"></a><span id="l151.60">   test_virtual_folder_multi_load_after_load,</span>
<a href="#l151.61"></a><span id="l151.61">   // -- mixture of single-backed and multi-backed</span>
<a href="#l151.62"></a><span id="l151.62">   test_virtual_folder_combo_load_after_load,</span>
<a href="#l151.63"></a><span id="l151.63" class="difflineplus">+  // -- ignore things we should ignore</span>
<a href="#l151.64"></a><span id="l151.64" class="difflineplus">+  test_virtual_folder_filters_out_servers,</span>
<a href="#l151.65"></a><span id="l151.65">   // -- rare/edge cases!</span>
<a href="#l151.66"></a><span id="l151.66">   test_virtual_folder_underlying_folder_deleted,</span>
<a href="#l151.67"></a><span id="l151.67">   // -- mail views (parameterized)</span>
<a href="#l151.68"></a><span id="l151.68">   parameterizeTest(test_virtual_folder_mail_views_unread, [1, 4]),</span>
<a href="#l151.69"></a><span id="l151.69">   // -- quick search (parameterized for single and multi folder cases)</span>
<a href="#l151.70"></a><span id="l151.70">   parameterizeTest(test_virtual_folder_param_quick_search_simple, [1, 4]),</span>
<a href="#l151.71"></a><span id="l151.71">   parameterizeTest(test_virtual_folder_param_quick_search_complex, [1, 4]),</span>
<a href="#l151.72"></a><span id="l151.72">   // -- mail view with quick search</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l152.1"></a><span id="l152.1" class="difflineminus">--- a/mailnews/base/util/Makefile.in</span>
<a href="#l152.2"></a><span id="l152.2" class="difflineplus">+++ b/mailnews/base/util/Makefile.in</span>
<a href="#l152.3"></a><span id="l152.3" class="difflineat">@@ -124,17 +124,20 @@ EXPORTS		= \</span>
<a href="#l152.4"></a><span id="l152.4"> 		nsMsgTxn.h \</span>
<a href="#l152.5"></a><span id="l152.5"> 		nsMsgI18N.h \</span>
<a href="#l152.6"></a><span id="l152.6"> 		nsImapMoveCoalescer.h \</span>
<a href="#l152.7"></a><span id="l152.7"> 		nsMsgReadStateTxn.h \</span>
<a href="#l152.8"></a><span id="l152.8"> 		$(NULL)</span>
<a href="#l152.9"></a><span id="l152.9"> </span>
<a href="#l152.10"></a><span id="l152.10"> EXTRA_JS_MODULES = \</span>
<a href="#l152.11"></a><span id="l152.11"> 		folderUtils.jsm \</span>
<a href="#l152.12"></a><span id="l152.12" class="difflineminus">-		iteratorUtils.jsm</span>
<a href="#l152.13"></a><span id="l152.13" class="difflineplus">+		iteratorUtils.jsm \</span>
<a href="#l152.14"></a><span id="l152.14" class="difflineplus">+		jsTreeSelection.js \</span>
<a href="#l152.15"></a><span id="l152.15" class="difflineplus">+		traceHelper.js \</span>
<a href="#l152.16"></a><span id="l152.16" class="difflineplus">+		$(NULL)</span>
<a href="#l152.17"></a><span id="l152.17"> </span>
<a href="#l152.18"></a><span id="l152.18"> ifndef MOZ_STATIC_MAIL_BUILD</span>
<a href="#l152.19"></a><span id="l152.19"> </span>
<a href="#l152.20"></a><span id="l152.20"> ifdef MOZILLA_INTERNAL_API</span>
<a href="#l152.21"></a><span id="l152.21"> EXTRA_DSO_LDOPTS = \</span>
<a href="#l152.22"></a><span id="l152.22"> 	$(LIBS_DIR) \</span>
<a href="#l152.23"></a><span id="l152.23"> 	$(MOZDEPTH)/rdf/util/src/internal/$(LIB_PREFIX)rdfutil_s.$(LIB_SUFFIX) \</span>
<a href="#l152.24"></a><span id="l152.24"> 	$(MOZ_UNICHARUTIL_LIBS) \</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l153.1"></a><span id="l153.1">new file mode 100644</span>
<a href="#l153.2"></a><span id="l153.2" class="difflineminus">--- /dev/null</span>
<a href="#l153.3"></a><span id="l153.3" class="difflineplus">+++ b/mailnews/base/util/jsTreeSelection.js</span>
<a href="#l153.4"></a><span id="l153.4" class="difflineat">@@ -0,0 +1,648 @@</span>
<a href="#l153.5"></a><span id="l153.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l153.6"></a><span id="l153.6" class="difflineplus">+ *   Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l153.7"></a><span id="l153.7" class="difflineplus">+ *</span>
<a href="#l153.8"></a><span id="l153.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l153.9"></a><span id="l153.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l153.10"></a><span id="l153.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l153.11"></a><span id="l153.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l153.12"></a><span id="l153.12" class="difflineplus">+ *</span>
<a href="#l153.13"></a><span id="l153.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l153.14"></a><span id="l153.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l153.15"></a><span id="l153.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l153.16"></a><span id="l153.16" class="difflineplus">+ * License.</span>
<a href="#l153.17"></a><span id="l153.17" class="difflineplus">+ *</span>
<a href="#l153.18"></a><span id="l153.18" class="difflineplus">+ * The Original Code is Thunderbird Mail Client.</span>
<a href="#l153.19"></a><span id="l153.19" class="difflineplus">+ *</span>
<a href="#l153.20"></a><span id="l153.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l153.21"></a><span id="l153.21" class="difflineplus">+ * Mozilla Messaging, Inc.</span>
<a href="#l153.22"></a><span id="l153.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l153.23"></a><span id="l153.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l153.24"></a><span id="l153.24" class="difflineplus">+ *</span>
<a href="#l153.25"></a><span id="l153.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l153.26"></a><span id="l153.26" class="difflineplus">+ *   Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a href="#l153.27"></a><span id="l153.27" class="difflineplus">+ *</span>
<a href="#l153.28"></a><span id="l153.28" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l153.29"></a><span id="l153.29" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l153.30"></a><span id="l153.30" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l153.31"></a><span id="l153.31" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l153.32"></a><span id="l153.32" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l153.33"></a><span id="l153.33" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l153.34"></a><span id="l153.34" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l153.35"></a><span id="l153.35" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l153.36"></a><span id="l153.36" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l153.37"></a><span id="l153.37" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l153.38"></a><span id="l153.38" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l153.39"></a><span id="l153.39" class="difflineplus">+ *</span>
<a href="#l153.40"></a><span id="l153.40" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l153.41"></a><span id="l153.41" class="difflineplus">+</span>
<a href="#l153.42"></a><span id="l153.42" class="difflineplus">+EXPORTED_SYMBOLS = ['JSTreeSelection'];</span>
<a href="#l153.43"></a><span id="l153.43" class="difflineplus">+</span>
<a href="#l153.44"></a><span id="l153.44" class="difflineplus">+const Cc = Components.classes;</span>
<a href="#l153.45"></a><span id="l153.45" class="difflineplus">+const Ci = Components.interfaces;</span>
<a href="#l153.46"></a><span id="l153.46" class="difflineplus">+const Cr = Components.results;</span>
<a href="#l153.47"></a><span id="l153.47" class="difflineplus">+const Cu = Components.utils;</span>
<a href="#l153.48"></a><span id="l153.48" class="difflineplus">+</span>
<a href="#l153.49"></a><span id="l153.49" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l153.50"></a><span id="l153.50" class="difflineplus">+</span>
<a href="#l153.51"></a><span id="l153.51" class="difflineplus">+/**</span>
<a href="#l153.52"></a><span id="l153.52" class="difflineplus">+ * Partial nsITreeSelection implementation so that we can have nsMsgDBViews that</span>
<a href="#l153.53"></a><span id="l153.53" class="difflineplus">+ *  exist only for message display but do not need to be backed by a full</span>
<a href="#l153.54"></a><span id="l153.54" class="difflineplus">+ *  tree view widget.  This could also hopefully be used for more xpcshell unit</span>
<a href="#l153.55"></a><span id="l153.55" class="difflineplus">+ *  testing of the FolderDisplayWidget.  It might also be useful for creating</span>
<a href="#l153.56"></a><span id="l153.56" class="difflineplus">+ *  transient selections when right-click selection happens.</span>
<a href="#l153.57"></a><span id="l153.57" class="difflineplus">+ *</span>
<a href="#l153.58"></a><span id="l153.58" class="difflineplus">+ * Our current limitations:</span>
<a href="#l153.59"></a><span id="l153.59" class="difflineplus">+ * - We do not support any single selection modes.  This is mainly because we</span>
<a href="#l153.60"></a><span id="l153.60" class="difflineplus">+ *   need to look at the box object for that and we don't want to do it.</span>
<a href="#l153.61"></a><span id="l153.61" class="difflineplus">+ * - Timed selection.  Our expected consumers don't use it.</span>
<a href="#l153.62"></a><span id="l153.62" class="difflineplus">+ *</span>
<a href="#l153.63"></a><span id="l153.63" class="difflineplus">+ * Our current laziness:</span>
<a href="#l153.64"></a><span id="l153.64" class="difflineplus">+ * - We aren't very precise about invalidation when it would be potentially</span>
<a href="#l153.65"></a><span id="l153.65" class="difflineplus">+ *   complicated.  The theory is that if there is a tree box object, it's</span>
<a href="#l153.66"></a><span id="l153.66" class="difflineplus">+ *   probably native and the XPConnect overhead is probably a lot more than</span>
<a href="#l153.67"></a><span id="l153.67" class="difflineplus">+ *   any potential savings, at least for now when the tree display is</span>
<a href="#l153.68"></a><span id="l153.68" class="difflineplus">+ *   generally C++ XPCOM backed rather than JS XPCOM backed.  Also, we</span>
<a href="#l153.69"></a><span id="l153.69" class="difflineplus">+ *   aren't intended to actually be used with a real tree display; you should</span>
<a href="#l153.70"></a><span id="l153.70" class="difflineplus">+ *   be using the C++ object in that case!</span>
<a href="#l153.71"></a><span id="l153.71" class="difflineplus">+ *</span>
<a href="#l153.72"></a><span id="l153.72" class="difflineplus">+ * If documentation is omitted for something, it is because we have little to</span>
<a href="#l153.73"></a><span id="l153.73" class="difflineplus">+ *  add to the documentation of nsITreeSelection and really hope that our</span>
<a href="#l153.74"></a><span id="l153.74" class="difflineplus">+ *  documentation tool will copy-down that documentation.</span>
<a href="#l153.75"></a><span id="l153.75" class="difflineplus">+ *</span>
<a href="#l153.76"></a><span id="l153.76" class="difflineplus">+ * This implementation attempts to mimic the behavior of nsTreeSelection.  In</span>
<a href="#l153.77"></a><span id="l153.77" class="difflineplus">+ *  a few cases, this leads to potentially confusing actions.  I attempt to note</span>
<a href="#l153.78"></a><span id="l153.78" class="difflineplus">+ *  when we are doing this and why we do it.</span>
<a href="#l153.79"></a><span id="l153.79" class="difflineplus">+ *</span>
<a href="#l153.80"></a><span id="l153.80" class="difflineplus">+ * Unit test is in mailnews/base/util/test_jsTreeSelection.js</span>
<a href="#l153.81"></a><span id="l153.81" class="difflineplus">+ */</span>
<a href="#l153.82"></a><span id="l153.82" class="difflineplus">+function JSTreeSelection(aTreeBoxObject) {</span>
<a href="#l153.83"></a><span id="l153.83" class="difflineplus">+  this._treeBoxObject = aTreeBoxObject;</span>
<a href="#l153.84"></a><span id="l153.84" class="difflineplus">+</span>
<a href="#l153.85"></a><span id="l153.85" class="difflineplus">+  this._currentIndex = null;</span>
<a href="#l153.86"></a><span id="l153.86" class="difflineplus">+  this._shiftSelectPivot = null;</span>
<a href="#l153.87"></a><span id="l153.87" class="difflineplus">+  this._ranges = [];</span>
<a href="#l153.88"></a><span id="l153.88" class="difflineplus">+  this._count = 0;</span>
<a href="#l153.89"></a><span id="l153.89" class="difflineplus">+</span>
<a href="#l153.90"></a><span id="l153.90" class="difflineplus">+  this._selectEventsSuppressed = false;</span>
<a href="#l153.91"></a><span id="l153.91" class="difflineplus">+}</span>
<a href="#l153.92"></a><span id="l153.92" class="difflineplus">+JSTreeSelection.prototype = {</span>
<a href="#l153.93"></a><span id="l153.93" class="difflineplus">+  /**</span>
<a href="#l153.94"></a><span id="l153.94" class="difflineplus">+   * The current nsITreeBoxObject, appropriately QueryInterfaced.  May be null.</span>
<a href="#l153.95"></a><span id="l153.95" class="difflineplus">+   */</span>
<a href="#l153.96"></a><span id="l153.96" class="difflineplus">+  _treeBoxObject: null,</span>
<a href="#l153.97"></a><span id="l153.97" class="difflineplus">+</span>
<a href="#l153.98"></a><span id="l153.98" class="difflineplus">+  /**</span>
<a href="#l153.99"></a><span id="l153.99" class="difflineplus">+   * Where the focus rectangle (that little dotted thing) shows up.  Just</span>
<a href="#l153.100"></a><span id="l153.100" class="difflineplus">+   *  because something is focused does not mean it is actually selected.</span>
<a href="#l153.101"></a><span id="l153.101" class="difflineplus">+   */</span>
<a href="#l153.102"></a><span id="l153.102" class="difflineplus">+  _currentIndex: null,</span>
<a href="#l153.103"></a><span id="l153.103" class="difflineplus">+  /**</span>
<a href="#l153.104"></a><span id="l153.104" class="difflineplus">+   * The view index where the shift is anchored when it is not (conceptually)</span>
<a href="#l153.105"></a><span id="l153.105" class="difflineplus">+   *  the same as _currentIndex.  This only happens when you perform a ranged</span>
<a href="#l153.106"></a><span id="l153.106" class="difflineplus">+   *  selection.  In that case, the start index of the ranged selection becomes</span>
<a href="#l153.107"></a><span id="l153.107" class="difflineplus">+   *  the shift pivot (and the _currentIndex becomes the end of the ranged</span>
<a href="#l153.108"></a><span id="l153.108" class="difflineplus">+   *  selection.)</span>
<a href="#l153.109"></a><span id="l153.109" class="difflineplus">+   * It gets cleared whenever the selection changes and it's not the result of</span>
<a href="#l153.110"></a><span id="l153.110" class="difflineplus">+   *  a call to rangedSelect.</span>
<a href="#l153.111"></a><span id="l153.111" class="difflineplus">+   */</span>
<a href="#l153.112"></a><span id="l153.112" class="difflineplus">+  _shiftSelectPivot: null,</span>
<a href="#l153.113"></a><span id="l153.113" class="difflineplus">+  /**</span>
<a href="#l153.114"></a><span id="l153.114" class="difflineplus">+   * A list of [lowIndexInclusive, highIndexInclusive] non-overlapping,</span>
<a href="#l153.115"></a><span id="l153.115" class="difflineplus">+   *  non-adjacent 'tuples' sort in ascending order.</span>
<a href="#l153.116"></a><span id="l153.116" class="difflineplus">+   */</span>
<a href="#l153.117"></a><span id="l153.117" class="difflineplus">+  _ranges: [],</span>
<a href="#l153.118"></a><span id="l153.118" class="difflineplus">+  /**</span>
<a href="#l153.119"></a><span id="l153.119" class="difflineplus">+   * The number of currently selected rows.</span>
<a href="#l153.120"></a><span id="l153.120" class="difflineplus">+   */</span>
<a href="#l153.121"></a><span id="l153.121" class="difflineplus">+  _count: 0,</span>
<a href="#l153.122"></a><span id="l153.122" class="difflineplus">+</span>
<a href="#l153.123"></a><span id="l153.123" class="difflineplus">+  get tree JSTreeSelection_get_treeBoxObject() {</span>
<a href="#l153.124"></a><span id="l153.124" class="difflineplus">+    return this._treeBoxObject;</span>
<a href="#l153.125"></a><span id="l153.125" class="difflineplus">+  },</span>
<a href="#l153.126"></a><span id="l153.126" class="difflineplus">+  set tree JSTreeSelection_set_treeBoxObject(aTreeBoxObject) {</span>
<a href="#l153.127"></a><span id="l153.127" class="difflineplus">+    this._treeBoxObject = aTreeBoxObject;</span>
<a href="#l153.128"></a><span id="l153.128" class="difflineplus">+  },</span>
<a href="#l153.129"></a><span id="l153.129" class="difflineplus">+</span>
<a href="#l153.130"></a><span id="l153.130" class="difflineplus">+  /**</span>
<a href="#l153.131"></a><span id="l153.131" class="difflineplus">+   * Although the nsITreeSelection documentation doesn't say, what this method</span>
<a href="#l153.132"></a><span id="l153.132" class="difflineplus">+   *  is supposed to do is check if the seltype attribute on the XUL tree is any</span>
<a href="#l153.133"></a><span id="l153.133" class="difflineplus">+   *  of the following: &quot;single&quot; (only a single row may be selected at a time,</span>
<a href="#l153.134"></a><span id="l153.134" class="difflineplus">+   *  &quot;cell&quot; (a single cell may be selected), or &quot;text&quot; (the row gets selected</span>
<a href="#l153.135"></a><span id="l153.135" class="difflineplus">+   *  but only the primary column shows up as selected.)</span>
<a href="#l153.136"></a><span id="l153.136" class="difflineplus">+   *</span>
<a href="#l153.137"></a><span id="l153.137" class="difflineplus">+   * @return false because we don't support single-selection.</span>
<a href="#l153.138"></a><span id="l153.138" class="difflineplus">+   */</span>
<a href="#l153.139"></a><span id="l153.139" class="difflineplus">+  get single JSTreeSelection_get_single() {</span>
<a href="#l153.140"></a><span id="l153.140" class="difflineplus">+    return false;</span>
<a href="#l153.141"></a><span id="l153.141" class="difflineplus">+  },</span>
<a href="#l153.142"></a><span id="l153.142" class="difflineplus">+</span>
<a href="#l153.143"></a><span id="l153.143" class="difflineplus">+  _updateCount: function JSTreeSelection__updateCount() {</span>
<a href="#l153.144"></a><span id="l153.144" class="difflineplus">+    this._count = 0;</span>
<a href="#l153.145"></a><span id="l153.145" class="difflineplus">+    for each (let [, [low, high]] in Iterator(this._ranges)) {</span>
<a href="#l153.146"></a><span id="l153.146" class="difflineplus">+      this._count += high - low + 1;</span>
<a href="#l153.147"></a><span id="l153.147" class="difflineplus">+    }</span>
<a href="#l153.148"></a><span id="l153.148" class="difflineplus">+  },</span>
<a href="#l153.149"></a><span id="l153.149" class="difflineplus">+</span>
<a href="#l153.150"></a><span id="l153.150" class="difflineplus">+  get count JSTreeSelection_get_count() {</span>
<a href="#l153.151"></a><span id="l153.151" class="difflineplus">+    return this._count;</span>
<a href="#l153.152"></a><span id="l153.152" class="difflineplus">+  },</span>
<a href="#l153.153"></a><span id="l153.153" class="difflineplus">+</span>
<a href="#l153.154"></a><span id="l153.154" class="difflineplus">+  isSelected: function JSTreeSelection_isSelected(aViewIndex) {</span>
<a href="#l153.155"></a><span id="l153.155" class="difflineplus">+    for each (let [,[low, high]] in Iterator(this._ranges)) {</span>
<a href="#l153.156"></a><span id="l153.156" class="difflineplus">+      if (aViewIndex &gt;= low &amp;&amp; aViewIndex &lt;= high)</span>
<a href="#l153.157"></a><span id="l153.157" class="difflineplus">+        return true;</span>
<a href="#l153.158"></a><span id="l153.158" class="difflineplus">+    }</span>
<a href="#l153.159"></a><span id="l153.159" class="difflineplus">+    return false;</span>
<a href="#l153.160"></a><span id="l153.160" class="difflineplus">+  },</span>
<a href="#l153.161"></a><span id="l153.161" class="difflineplus">+</span>
<a href="#l153.162"></a><span id="l153.162" class="difflineplus">+  /**</span>
<a href="#l153.163"></a><span id="l153.163" class="difflineplus">+   * Select the given row.  It does nothing if that row was already selected.</span>
<a href="#l153.164"></a><span id="l153.164" class="difflineplus">+   */</span>
<a href="#l153.165"></a><span id="l153.165" class="difflineplus">+  select: function JSTreeSelection_select(aViewIndex) {</span>
<a href="#l153.166"></a><span id="l153.166" class="difflineplus">+    // current index will provide our effective shift pivot</span>
<a href="#l153.167"></a><span id="l153.167" class="difflineplus">+    this._shiftSelectPivot = null;</span>
<a href="#l153.168"></a><span id="l153.168" class="difflineplus">+    this.currentIndex = aViewIndex;</span>
<a href="#l153.169"></a><span id="l153.169" class="difflineplus">+</span>
<a href="#l153.170"></a><span id="l153.170" class="difflineplus">+    if (this._count == 1 &amp;&amp; this._ranges[0][0] == aViewIndex)</span>
<a href="#l153.171"></a><span id="l153.171" class="difflineplus">+      return;</span>
<a href="#l153.172"></a><span id="l153.172" class="difflineplus">+</span>
<a href="#l153.173"></a><span id="l153.173" class="difflineplus">+    this._count = 1;</span>
<a href="#l153.174"></a><span id="l153.174" class="difflineplus">+    this._ranges = [[aViewIndex, aViewIndex]];</span>
<a href="#l153.175"></a><span id="l153.175" class="difflineplus">+</span>
<a href="#l153.176"></a><span id="l153.176" class="difflineplus">+    if (this._treeBoxObject)</span>
<a href="#l153.177"></a><span id="l153.177" class="difflineplus">+      this._treeBoxObject.invalidate();</span>
<a href="#l153.178"></a><span id="l153.178" class="difflineplus">+</span>
<a href="#l153.179"></a><span id="l153.179" class="difflineplus">+    this._fireSelectionChanged();</span>
<a href="#l153.180"></a><span id="l153.180" class="difflineplus">+  },</span>
<a href="#l153.181"></a><span id="l153.181" class="difflineplus">+</span>
<a href="#l153.182"></a><span id="l153.182" class="difflineplus">+  timedSelect: function JSTreeSelection_timedSelect(aIndex, aDelay) {</span>
<a href="#l153.183"></a><span id="l153.183" class="difflineplus">+    throw new Error(&quot;We do not implement timed selection.&quot;);</span>
<a href="#l153.184"></a><span id="l153.184" class="difflineplus">+  },</span>
<a href="#l153.185"></a><span id="l153.185" class="difflineplus">+</span>
<a href="#l153.186"></a><span id="l153.186" class="difflineplus">+  toggleSelect: function JSTreeSelection_toggleSelect(aIndex) {</span>
<a href="#l153.187"></a><span id="l153.187" class="difflineplus">+    this.currentIndex = aIndex;</span>
<a href="#l153.188"></a><span id="l153.188" class="difflineplus">+    for each (let [iTupe, [low, high]] in Iterator(this._ranges)) {</span>
<a href="#l153.189"></a><span id="l153.189" class="difflineplus">+      // below the range? add it to the existing range or create a new one</span>
<a href="#l153.190"></a><span id="l153.190" class="difflineplus">+      if (aIndex &lt; low) {</span>
<a href="#l153.191"></a><span id="l153.191" class="difflineplus">+        this._count++;</span>
<a href="#l153.192"></a><span id="l153.192" class="difflineplus">+        // is it just below an existing range? (range fusion only happens in the</span>
<a href="#l153.193"></a><span id="l153.193" class="difflineplus">+        //  high case, not here.)</span>
<a href="#l153.194"></a><span id="l153.194" class="difflineplus">+        if (aIndex == low - 1) {</span>
<a href="#l153.195"></a><span id="l153.195" class="difflineplus">+          this._ranges[iTupe][0] = aIndex;</span>
<a href="#l153.196"></a><span id="l153.196" class="difflineplus">+          break;</span>
<a href="#l153.197"></a><span id="l153.197" class="difflineplus">+        }</span>
<a href="#l153.198"></a><span id="l153.198" class="difflineplus">+        // then it gets its own range</span>
<a href="#l153.199"></a><span id="l153.199" class="difflineplus">+        this._ranges.splice(iTupe, 0, [aIndex, aIndex]);</span>
<a href="#l153.200"></a><span id="l153.200" class="difflineplus">+        break;</span>
<a href="#l153.201"></a><span id="l153.201" class="difflineplus">+      }</span>
<a href="#l153.202"></a><span id="l153.202" class="difflineplus">+      // in the range?  will need to either nuke, shrink, or split the range to</span>
<a href="#l153.203"></a><span id="l153.203" class="difflineplus">+      //  remove it</span>
<a href="#l153.204"></a><span id="l153.204" class="difflineplus">+      if (aIndex &gt;= low &amp;&amp; aIndex &lt;= high) {</span>
<a href="#l153.205"></a><span id="l153.205" class="difflineplus">+        this._count--;</span>
<a href="#l153.206"></a><span id="l153.206" class="difflineplus">+        // nuke</span>
<a href="#l153.207"></a><span id="l153.207" class="difflineplus">+        if (aIndex == low &amp;&amp; aIndex == high)</span>
<a href="#l153.208"></a><span id="l153.208" class="difflineplus">+          this._ranges.splice(iTupe, 1);</span>
<a href="#l153.209"></a><span id="l153.209" class="difflineplus">+        // lower shrink</span>
<a href="#l153.210"></a><span id="l153.210" class="difflineplus">+        else if (aIndex == low)</span>
<a href="#l153.211"></a><span id="l153.211" class="difflineplus">+          this._ranges[iTupe][0] = aIndex + 1;</span>
<a href="#l153.212"></a><span id="l153.212" class="difflineplus">+        // upper shrink</span>
<a href="#l153.213"></a><span id="l153.213" class="difflineplus">+        else if (aIndex == high)</span>
<a href="#l153.214"></a><span id="l153.214" class="difflineplus">+          this._ranges[iTupe][1] = aIndex - 1;</span>
<a href="#l153.215"></a><span id="l153.215" class="difflineplus">+        // split</span>
<a href="#l153.216"></a><span id="l153.216" class="difflineplus">+        else</span>
<a href="#l153.217"></a><span id="l153.217" class="difflineplus">+          this._ranges.splice(iTupe, 1, [low, aIndex - 1], [aIndex + 1, high]);</span>
<a href="#l153.218"></a><span id="l153.218" class="difflineplus">+        break;</span>
<a href="#l153.219"></a><span id="l153.219" class="difflineplus">+      }</span>
<a href="#l153.220"></a><span id="l153.220" class="difflineplus">+      // just above the range?  fuse into the range, and possibly the next</span>
<a href="#l153.221"></a><span id="l153.221" class="difflineplus">+      //  range up.</span>
<a href="#l153.222"></a><span id="l153.222" class="difflineplus">+      if (aIndex == high + 1) {</span>
<a href="#l153.223"></a><span id="l153.223" class="difflineplus">+        this._count++;</span>
<a href="#l153.224"></a><span id="l153.224" class="difflineplus">+        // see if there is another range and there was just a gap of one between</span>
<a href="#l153.225"></a><span id="l153.225" class="difflineplus">+        //  the two ranges.</span>
<a href="#l153.226"></a><span id="l153.226" class="difflineplus">+        if ((iTupe + 1 &lt; this._ranges.length) &amp;&amp;</span>
<a href="#l153.227"></a><span id="l153.227" class="difflineplus">+            (this._ranges[iTupe+1][0] == aIndex + 1)) {</span>
<a href="#l153.228"></a><span id="l153.228" class="difflineplus">+          // yes, merge the ranges</span>
<a href="#l153.229"></a><span id="l153.229" class="difflineplus">+          this._ranges.splice(iTupe, 2, [low, this._ranges[iTupe+1][1]]);</span>
<a href="#l153.230"></a><span id="l153.230" class="difflineplus">+          break;</span>
<a href="#l153.231"></a><span id="l153.231" class="difflineplus">+        }</span>
<a href="#l153.232"></a><span id="l153.232" class="difflineplus">+        // nope, no merge required, just update the range</span>
<a href="#l153.233"></a><span id="l153.233" class="difflineplus">+        this._ranges[iTupe][1] = aIndex;</span>
<a href="#l153.234"></a><span id="l153.234" class="difflineplus">+        break;</span>
<a href="#l153.235"></a><span id="l153.235" class="difflineplus">+      }</span>
<a href="#l153.236"></a><span id="l153.236" class="difflineplus">+      // otherwise we need to keep going</span>
<a href="#l153.237"></a><span id="l153.237" class="difflineplus">+    }</span>
<a href="#l153.238"></a><span id="l153.238" class="difflineplus">+</span>
<a href="#l153.239"></a><span id="l153.239" class="difflineplus">+    if (this._treeBoxObject)</span>
<a href="#l153.240"></a><span id="l153.240" class="difflineplus">+      this._treeBoxObject.invalidateRow(aIndex);</span>
<a href="#l153.241"></a><span id="l153.241" class="difflineplus">+    this._fireSelectionChanged();</span>
<a href="#l153.242"></a><span id="l153.242" class="difflineplus">+  },</span>
<a href="#l153.243"></a><span id="l153.243" class="difflineplus">+</span>
<a href="#l153.244"></a><span id="l153.244" class="difflineplus">+  /**</span>
<a href="#l153.245"></a><span id="l153.245" class="difflineplus">+   * @param aRangeStart If omitted, it implies a shift-selection is happening,</span>
<a href="#l153.246"></a><span id="l153.246" class="difflineplus">+   *     in which case we use _shiftSelectPivot as the start if we have it,</span>
<a href="#l153.247"></a><span id="l153.247" class="difflineplus">+   *     _currentIndex if we don't, and if we somehow didn't have a</span>
<a href="#l153.248"></a><span id="l153.248" class="difflineplus">+   *     _currentIndex, we use the range end.</span>
<a href="#l153.249"></a><span id="l153.249" class="difflineplus">+   * @param aRangeEnd Just the inclusive end of the range.</span>
<a href="#l153.250"></a><span id="l153.250" class="difflineplus">+   * @param aAugment Does this set a new selection or should it be merged with</span>
<a href="#l153.251"></a><span id="l153.251" class="difflineplus">+   *     the existing selection?</span>
<a href="#l153.252"></a><span id="l153.252" class="difflineplus">+   */</span>
<a href="#l153.253"></a><span id="l153.253" class="difflineplus">+  rangedSelect: function JSTreeSelection_rangedSelect(aRangeStart, aRangeEnd,</span>
<a href="#l153.254"></a><span id="l153.254" class="difflineplus">+                                                      aAugment) {</span>
<a href="#l153.255"></a><span id="l153.255" class="difflineplus">+    if (aRangeStart == -1) {</span>
<a href="#l153.256"></a><span id="l153.256" class="difflineplus">+      if (this._shiftSelectPivot != null)</span>
<a href="#l153.257"></a><span id="l153.257" class="difflineplus">+        aRangeStart = this._shiftSelectPivot;</span>
<a href="#l153.258"></a><span id="l153.258" class="difflineplus">+      else if (this._currentIndex != null)</span>
<a href="#l153.259"></a><span id="l153.259" class="difflineplus">+        aRangeStart = this._currentIndex;</span>
<a href="#l153.260"></a><span id="l153.260" class="difflineplus">+      else</span>
<a href="#l153.261"></a><span id="l153.261" class="difflineplus">+        aRangeStart = aRangeEnd;</span>
<a href="#l153.262"></a><span id="l153.262" class="difflineplus">+    }</span>
<a href="#l153.263"></a><span id="l153.263" class="difflineplus">+</span>
<a href="#l153.264"></a><span id="l153.264" class="difflineplus">+    this._shiftSelectPivot = aRangeStart;</span>
<a href="#l153.265"></a><span id="l153.265" class="difflineplus">+    this.currentIndex = aRangeEnd;</span>
<a href="#l153.266"></a><span id="l153.266" class="difflineplus">+</span>
<a href="#l153.267"></a><span id="l153.267" class="difflineplus">+    // enforce our ordering constraint for our ranges</span>
<a href="#l153.268"></a><span id="l153.268" class="difflineplus">+    if (aRangeStart &gt; aRangeEnd)</span>
<a href="#l153.269"></a><span id="l153.269" class="difflineplus">+      [aRangeStart, aRangeEnd] = [aRangeEnd, aRangeStart];</span>
<a href="#l153.270"></a><span id="l153.270" class="difflineplus">+</span>
<a href="#l153.271"></a><span id="l153.271" class="difflineplus">+    // if we're not augmenting, then this is really easy.</span>
<a href="#l153.272"></a><span id="l153.272" class="difflineplus">+    if (!aAugment) {</span>
<a href="#l153.273"></a><span id="l153.273" class="difflineplus">+      this._count = aRangeEnd - aRangeStart + 1;</span>
<a href="#l153.274"></a><span id="l153.274" class="difflineplus">+      this._ranges = [[aRangeStart, aRangeEnd]];</span>
<a href="#l153.275"></a><span id="l153.275" class="difflineplus">+      if (this._treeBoxObject)</span>
<a href="#l153.276"></a><span id="l153.276" class="difflineplus">+        this._treeBoxObject.invalidate();</span>
<a href="#l153.277"></a><span id="l153.277" class="difflineplus">+      this._fireSelectionChanged();</span>
<a href="#l153.278"></a><span id="l153.278" class="difflineplus">+      return;</span>
<a href="#l153.279"></a><span id="l153.279" class="difflineplus">+    }</span>
<a href="#l153.280"></a><span id="l153.280" class="difflineplus">+</span>
<a href="#l153.281"></a><span id="l153.281" class="difflineplus">+    // Iterate over our existing set of ranges, finding the 'range' of ranges</span>
<a href="#l153.282"></a><span id="l153.282" class="difflineplus">+    //  that our new range overlaps or simply obviates.</span>
<a href="#l153.283"></a><span id="l153.283" class="difflineplus">+    // Overlap variables track blocks we need to keep some part of, Nuke</span>
<a href="#l153.284"></a><span id="l153.284" class="difflineplus">+    //  variables are for blocks that get spliced out.  For our purposes, all</span>
<a href="#l153.285"></a><span id="l153.285" class="difflineplus">+    //  overlap blocks are also nuke blocks.</span>
<a href="#l153.286"></a><span id="l153.286" class="difflineplus">+    let lowOverlap, lowNuke, highNuke, highOverlap;</span>
<a href="#l153.287"></a><span id="l153.287" class="difflineplus">+    // in case there is no overlap, also figure an insertionPoint</span>
<a href="#l153.288"></a><span id="l153.288" class="difflineplus">+    let insertionPoint = this._ranges.length; // default to the end</span>
<a href="#l153.289"></a><span id="l153.289" class="difflineplus">+    for each (let [iTupe, [low, high]] in Iterator(this._ranges)) {</span>
<a href="#l153.290"></a><span id="l153.290" class="difflineplus">+      // If it's completely include the range, it should be nuked</span>
<a href="#l153.291"></a><span id="l153.291" class="difflineplus">+      if (aRangeStart &lt;= low &amp;&amp; aRangeEnd &gt;= high) {</span>
<a href="#l153.292"></a><span id="l153.292" class="difflineplus">+        if (lowNuke == null) // only the first one we see is the low one</span>
<a href="#l153.293"></a><span id="l153.293" class="difflineplus">+          lowNuke = iTupe;</span>
<a href="#l153.294"></a><span id="l153.294" class="difflineplus">+        highNuke = iTupe;</span>
<a href="#l153.295"></a><span id="l153.295" class="difflineplus">+      }</span>
<a href="#l153.296"></a><span id="l153.296" class="difflineplus">+      // If our new range start is inside a range or is adjacent, it's overlap</span>
<a href="#l153.297"></a><span id="l153.297" class="difflineplus">+      if (aRangeStart &gt;= low - 1 &amp;&amp; aRangeStart &lt;= high + 1 &amp;&amp;</span>
<a href="#l153.298"></a><span id="l153.298" class="difflineplus">+          lowOverlap == null)</span>
<a href="#l153.299"></a><span id="l153.299" class="difflineplus">+        lowOverlap = lowNuke = highNuke = iTupe;</span>
<a href="#l153.300"></a><span id="l153.300" class="difflineplus">+      // If our new range ends inside a range or is adjacent, it's overlap</span>
<a href="#l153.301"></a><span id="l153.301" class="difflineplus">+      if (aRangeEnd &gt;= low - 1 &amp;&amp; aRangeEnd &lt;= high + 1) {</span>
<a href="#l153.302"></a><span id="l153.302" class="difflineplus">+        highOverlap = highNuke = iTupe;</span>
<a href="#l153.303"></a><span id="l153.303" class="difflineplus">+        if (lowNuke == null)</span>
<a href="#l153.304"></a><span id="l153.304" class="difflineplus">+          lowNuke = iTupe;</span>
<a href="#l153.305"></a><span id="l153.305" class="difflineplus">+      }</span>
<a href="#l153.306"></a><span id="l153.306" class="difflineplus">+</span>
<a href="#l153.307"></a><span id="l153.307" class="difflineplus">+      // we're done when no more overlap is possible</span>
<a href="#l153.308"></a><span id="l153.308" class="difflineplus">+      if (aRangeEnd &lt; low) {</span>
<a href="#l153.309"></a><span id="l153.309" class="difflineplus">+        insertionPoint = iTupe;</span>
<a href="#l153.310"></a><span id="l153.310" class="difflineplus">+        break;</span>
<a href="#l153.311"></a><span id="l153.311" class="difflineplus">+      }</span>
<a href="#l153.312"></a><span id="l153.312" class="difflineplus">+    }</span>
<a href="#l153.313"></a><span id="l153.313" class="difflineplus">+</span>
<a href="#l153.314"></a><span id="l153.314" class="difflineplus">+    if (lowOverlap != null)</span>
<a href="#l153.315"></a><span id="l153.315" class="difflineplus">+      aRangeStart = Math.min(aRangeStart, this._ranges[lowOverlap][0]);</span>
<a href="#l153.316"></a><span id="l153.316" class="difflineplus">+    if (highOverlap != null)</span>
<a href="#l153.317"></a><span id="l153.317" class="difflineplus">+      aRangeEnd = Math.max(aRangeEnd, this._ranges[highOverlap][1]);</span>
<a href="#l153.318"></a><span id="l153.318" class="difflineplus">+    if (lowNuke != null)</span>
<a href="#l153.319"></a><span id="l153.319" class="difflineplus">+      this._ranges.splice(lowNuke, highNuke - lowNuke + 1,</span>
<a href="#l153.320"></a><span id="l153.320" class="difflineplus">+                          [aRangeStart, aRangeEnd]);</span>
<a href="#l153.321"></a><span id="l153.321" class="difflineplus">+    else</span>
<a href="#l153.322"></a><span id="l153.322" class="difflineplus">+      this._ranges.splice(insertionPoint, 0, [aRangeStart, aRangeEnd]);</span>
<a href="#l153.323"></a><span id="l153.323" class="difflineplus">+</span>
<a href="#l153.324"></a><span id="l153.324" class="difflineplus">+    this._updateCount();</span>
<a href="#l153.325"></a><span id="l153.325" class="difflineplus">+    if (this._treeBoxObject)</span>
<a href="#l153.326"></a><span id="l153.326" class="difflineplus">+      this._treeBoxObject.invalidate();</span>
<a href="#l153.327"></a><span id="l153.327" class="difflineplus">+    this._fireSelectionChanged();</span>
<a href="#l153.328"></a><span id="l153.328" class="difflineplus">+  },</span>
<a href="#l153.329"></a><span id="l153.329" class="difflineplus">+</span>
<a href="#l153.330"></a><span id="l153.330" class="difflineplus">+  /**</span>
<a href="#l153.331"></a><span id="l153.331" class="difflineplus">+   * This is basically RangedSelect but without insertion of a new range and we</span>
<a href="#l153.332"></a><span id="l153.332" class="difflineplus">+   *  don't need to worry about adjacency.</span>
<a href="#l153.333"></a><span id="l153.333" class="difflineplus">+   * Oddly, nsTreeSelection doesn't fire a selection changed event here...</span>
<a href="#l153.334"></a><span id="l153.334" class="difflineplus">+   */</span>
<a href="#l153.335"></a><span id="l153.335" class="difflineplus">+  clearRange: function JSTreeSelection_clearRange(aRangeStart, aRangeEnd) {</span>
<a href="#l153.336"></a><span id="l153.336" class="difflineplus">+    // Iterate over our existing set of ranges, finding the 'range' of ranges</span>
<a href="#l153.337"></a><span id="l153.337" class="difflineplus">+    //  that our clear range overlaps or simply obviates.</span>
<a href="#l153.338"></a><span id="l153.338" class="difflineplus">+    // Overlap variables track blocks we need to keep some part of, Nuke</span>
<a href="#l153.339"></a><span id="l153.339" class="difflineplus">+    //  variables are for blocks that get spliced out.  For our purposes, all</span>
<a href="#l153.340"></a><span id="l153.340" class="difflineplus">+    //  overlap blocks are also nuke blocks.</span>
<a href="#l153.341"></a><span id="l153.341" class="difflineplus">+    let lowOverlap, lowNuke, highNuke, highOverlap;</span>
<a href="#l153.342"></a><span id="l153.342" class="difflineplus">+    for each (let [iTupe, [low, high]] in Iterator(this._ranges)) {</span>
<a href="#l153.343"></a><span id="l153.343" class="difflineplus">+      // If we completely include the range, it should be nuked</span>
<a href="#l153.344"></a><span id="l153.344" class="difflineplus">+      if (aRangeStart &lt;= low &amp;&amp; aRangeEnd &gt;= high) {</span>
<a href="#l153.345"></a><span id="l153.345" class="difflineplus">+        if (lowNuke == null) // only the first one we see is the low one</span>
<a href="#l153.346"></a><span id="l153.346" class="difflineplus">+          lowNuke = iTupe;</span>
<a href="#l153.347"></a><span id="l153.347" class="difflineplus">+        highNuke = iTupe;</span>
<a href="#l153.348"></a><span id="l153.348" class="difflineplus">+      }</span>
<a href="#l153.349"></a><span id="l153.349" class="difflineplus">+      // If our new range start is inside a range, it's nuke and maybe overlap</span>
<a href="#l153.350"></a><span id="l153.350" class="difflineplus">+      if (aRangeStart &gt;= low &amp;&amp; aRangeStart &lt;= high &amp;&amp; lowNuke == null) {</span>
<a href="#l153.351"></a><span id="l153.351" class="difflineplus">+        lowNuke = highNuke = iTupe;</span>
<a href="#l153.352"></a><span id="l153.352" class="difflineplus">+        // it's only overlap if we don't match at the low end</span>
<a href="#l153.353"></a><span id="l153.353" class="difflineplus">+        if (aRangeStart &gt; low)</span>
<a href="#l153.354"></a><span id="l153.354" class="difflineplus">+          lowOverlap = iTupe;</span>
<a href="#l153.355"></a><span id="l153.355" class="difflineplus">+      }</span>
<a href="#l153.356"></a><span id="l153.356" class="difflineplus">+      // If our new range ends inside a range, it's nuke and maybe overlap</span>
<a href="#l153.357"></a><span id="l153.357" class="difflineplus">+      if (aRangeEnd &gt;= low &amp;&amp; aRangeEnd &lt;= high) {</span>
<a href="#l153.358"></a><span id="l153.358" class="difflineplus">+        highNuke = iTupe;</span>
<a href="#l153.359"></a><span id="l153.359" class="difflineplus">+        // it's only overlap if we don't match at the high end</span>
<a href="#l153.360"></a><span id="l153.360" class="difflineplus">+        if (aRangeEnd &lt; high)</span>
<a href="#l153.361"></a><span id="l153.361" class="difflineplus">+          highOverlap = iTupe;</span>
<a href="#l153.362"></a><span id="l153.362" class="difflineplus">+        if (lowNuke == null)</span>
<a href="#l153.363"></a><span id="l153.363" class="difflineplus">+          lowNuke = iTupe;</span>
<a href="#l153.364"></a><span id="l153.364" class="difflineplus">+      }</span>
<a href="#l153.365"></a><span id="l153.365" class="difflineplus">+</span>
<a href="#l153.366"></a><span id="l153.366" class="difflineplus">+      // we're done when no more overlap is possible</span>
<a href="#l153.367"></a><span id="l153.367" class="difflineplus">+      if (aRangeEnd &lt; low)</span>
<a href="#l153.368"></a><span id="l153.368" class="difflineplus">+        break;</span>
<a href="#l153.369"></a><span id="l153.369" class="difflineplus">+    }</span>
<a href="#l153.370"></a><span id="l153.370" class="difflineplus">+    // nothing to do since there's nothing to nuke</span>
<a href="#l153.371"></a><span id="l153.371" class="difflineplus">+    if (lowNuke == null)</span>
<a href="#l153.372"></a><span id="l153.372" class="difflineplus">+      return;</span>
<a href="#l153.373"></a><span id="l153.373" class="difflineplus">+    let args = [lowNuke, highNuke - lowNuke + 1];</span>
<a href="#l153.374"></a><span id="l153.374" class="difflineplus">+    if (lowOverlap != null)</span>
<a href="#l153.375"></a><span id="l153.375" class="difflineplus">+      args.push([this._ranges[lowOverlap][0], aRangeStart - 1]);</span>
<a href="#l153.376"></a><span id="l153.376" class="difflineplus">+    if (highOverlap != null)</span>
<a href="#l153.377"></a><span id="l153.377" class="difflineplus">+      args.push([aRangeEnd + 1, this._ranges[highOverlap][1]]);</span>
<a href="#l153.378"></a><span id="l153.378" class="difflineplus">+    this._ranges.splice.apply(this._ranges, args);</span>
<a href="#l153.379"></a><span id="l153.379" class="difflineplus">+</span>
<a href="#l153.380"></a><span id="l153.380" class="difflineplus">+    this._updateCount();</span>
<a href="#l153.381"></a><span id="l153.381" class="difflineplus">+    if (this._treeBoxObject)</span>
<a href="#l153.382"></a><span id="l153.382" class="difflineplus">+      this._treeBoxObject.invalidate();</span>
<a href="#l153.383"></a><span id="l153.383" class="difflineplus">+    // note! nsTreeSelection doesn't fire a selection changed event, so neither</span>
<a href="#l153.384"></a><span id="l153.384" class="difflineplus">+    //  do we, but it seems like we should</span>
<a href="#l153.385"></a><span id="l153.385" class="difflineplus">+  },</span>
<a href="#l153.386"></a><span id="l153.386" class="difflineplus">+</span>
<a href="#l153.387"></a><span id="l153.387" class="difflineplus">+  /**</span>
<a href="#l153.388"></a><span id="l153.388" class="difflineplus">+   * nsTreeSelection always fires a select notification when the range is</span>
<a href="#l153.389"></a><span id="l153.389" class="difflineplus">+   *  cleared, even if there is no effective chance in selection.</span>
<a href="#l153.390"></a><span id="l153.390" class="difflineplus">+   */</span>
<a href="#l153.391"></a><span id="l153.391" class="difflineplus">+  clearSelection: function JSTreeSelection_clearSelection() {</span>
<a href="#l153.392"></a><span id="l153.392" class="difflineplus">+    this._shiftSelectPivot = null;</span>
<a href="#l153.393"></a><span id="l153.393" class="difflineplus">+    this._count = 0;</span>
<a href="#l153.394"></a><span id="l153.394" class="difflineplus">+    this._ranges = [];</span>
<a href="#l153.395"></a><span id="l153.395" class="difflineplus">+    if (this._treeBoxObject)</span>
<a href="#l153.396"></a><span id="l153.396" class="difflineplus">+      this._treeBoxObject.invalidate();</span>
<a href="#l153.397"></a><span id="l153.397" class="difflineplus">+    this._fireSelectionChanged();</span>
<a href="#l153.398"></a><span id="l153.398" class="difflineplus">+  },</span>
<a href="#l153.399"></a><span id="l153.399" class="difflineplus">+</span>
<a href="#l153.400"></a><span id="l153.400" class="difflineplus">+  /**</span>
<a href="#l153.401"></a><span id="l153.401" class="difflineplus">+   * Not even nsTreeSelection implements this.</span>
<a href="#l153.402"></a><span id="l153.402" class="difflineplus">+   */</span>
<a href="#l153.403"></a><span id="l153.403" class="difflineplus">+  invertSelection: function JSTreeSelection_invertSelection() {</span>
<a href="#l153.404"></a><span id="l153.404" class="difflineplus">+    throw new Error(&quot;Who really was going to use this?&quot;);</span>
<a href="#l153.405"></a><span id="l153.405" class="difflineplus">+  },</span>
<a href="#l153.406"></a><span id="l153.406" class="difflineplus">+</span>
<a href="#l153.407"></a><span id="l153.407" class="difflineplus">+  /**</span>
<a href="#l153.408"></a><span id="l153.408" class="difflineplus">+   * Select all with no rows is a no-op, otherwise we select all and notify.</span>
<a href="#l153.409"></a><span id="l153.409" class="difflineplus">+   */</span>
<a href="#l153.410"></a><span id="l153.410" class="difflineplus">+  selectAll: function JSTreeSelection_selectAll() {</span>
<a href="#l153.411"></a><span id="l153.411" class="difflineplus">+    if (!this._treeBoxObject)</span>
<a href="#l153.412"></a><span id="l153.412" class="difflineplus">+      return;</span>
<a href="#l153.413"></a><span id="l153.413" class="difflineplus">+</span>
<a href="#l153.414"></a><span id="l153.414" class="difflineplus">+    let view = this._treeBoxObject.view.QueryInterface(Ci.nsITreeView);</span>
<a href="#l153.415"></a><span id="l153.415" class="difflineplus">+    let rowCount = view.rowCount;</span>
<a href="#l153.416"></a><span id="l153.416" class="difflineplus">+</span>
<a href="#l153.417"></a><span id="l153.417" class="difflineplus">+    // no-ops-ville</span>
<a href="#l153.418"></a><span id="l153.418" class="difflineplus">+    if (!rowCount)</span>
<a href="#l153.419"></a><span id="l153.419" class="difflineplus">+      return;</span>
<a href="#l153.420"></a><span id="l153.420" class="difflineplus">+</span>
<a href="#l153.421"></a><span id="l153.421" class="difflineplus">+    this._count = rowCount;</span>
<a href="#l153.422"></a><span id="l153.422" class="difflineplus">+    this._ranges = [[0, rowCount - 1]];</span>
<a href="#l153.423"></a><span id="l153.423" class="difflineplus">+</span>
<a href="#l153.424"></a><span id="l153.424" class="difflineplus">+    this._treeBoxObject.invalidate();</span>
<a href="#l153.425"></a><span id="l153.425" class="difflineplus">+    this._fireSelectionChanged();</span>
<a href="#l153.426"></a><span id="l153.426" class="difflineplus">+  },</span>
<a href="#l153.427"></a><span id="l153.427" class="difflineplus">+</span>
<a href="#l153.428"></a><span id="l153.428" class="difflineplus">+  getRangeCount: function JSTreeSelection_getRangeCount() {</span>
<a href="#l153.429"></a><span id="l153.429" class="difflineplus">+    return this._ranges.length;</span>
<a href="#l153.430"></a><span id="l153.430" class="difflineplus">+  },</span>
<a href="#l153.431"></a><span id="l153.431" class="difflineplus">+  getRangeAt: function JSTreeSelection_getRangeAt(aRangeIndex, aMinObj,</span>
<a href="#l153.432"></a><span id="l153.432" class="difflineplus">+                                                  aMaxObj) {</span>
<a href="#l153.433"></a><span id="l153.433" class="difflineplus">+    if (aRangeIndex &lt; 0 || aRangeIndex &gt; this._ranges.length)</span>
<a href="#l153.434"></a><span id="l153.434" class="difflineplus">+      throw new Exception(&quot;Try a real range index next time.&quot;);</span>
<a href="#l153.435"></a><span id="l153.435" class="difflineplus">+    [aMinObj.value, aMaxObj.value] = this._ranges[aRangeIndex];</span>
<a href="#l153.436"></a><span id="l153.436" class="difflineplus">+  },</span>
<a href="#l153.437"></a><span id="l153.437" class="difflineplus">+</span>
<a href="#l153.438"></a><span id="l153.438" class="difflineplus">+  invalidateSelection: function JSTreeSelection_invalidateSelection() {</span>
<a href="#l153.439"></a><span id="l153.439" class="difflineplus">+    if (this._treeBoxObject)</span>
<a href="#l153.440"></a><span id="l153.440" class="difflineplus">+      this._treeBoxObject.invalidate();</span>
<a href="#l153.441"></a><span id="l153.441" class="difflineplus">+  },</span>
<a href="#l153.442"></a><span id="l153.442" class="difflineplus">+</span>
<a href="#l153.443"></a><span id="l153.443" class="difflineplus">+  /**</span>
<a href="#l153.444"></a><span id="l153.444" class="difflineplus">+   * Helper method to adjust points in the face of row additions/removal.</span>
<a href="#l153.445"></a><span id="l153.445" class="difflineplus">+   * @param aPoint The point, null if there isn't one, or an index otherwise.</span>
<a href="#l153.446"></a><span id="l153.446" class="difflineplus">+   * @param aDeltaAt The row at which the change is happening.</span>
<a href="#l153.447"></a><span id="l153.447" class="difflineplus">+   * @param aDelta The number of rows added if positive, or the (negative)</span>
<a href="#l153.448"></a><span id="l153.448" class="difflineplus">+   *     number of rows removed.</span>
<a href="#l153.449"></a><span id="l153.449" class="difflineplus">+   */</span>
<a href="#l153.450"></a><span id="l153.450" class="difflineplus">+  _adjustPoint: function JSTreeSelection__adjustPoint(aPoint, aDeltaAt,</span>
<a href="#l153.451"></a><span id="l153.451" class="difflineplus">+                                                      aDelta) {</span>
<a href="#l153.452"></a><span id="l153.452" class="difflineplus">+    // if there is no point, no change</span>
<a href="#l153.453"></a><span id="l153.453" class="difflineplus">+    if (aPoint == null)</span>
<a href="#l153.454"></a><span id="l153.454" class="difflineplus">+      return aPoint;</span>
<a href="#l153.455"></a><span id="l153.455" class="difflineplus">+    // if the point is before the change, no change</span>
<a href="#l153.456"></a><span id="l153.456" class="difflineplus">+    if (aPoint &lt; aDeltaAt)</span>
<a href="#l153.457"></a><span id="l153.457" class="difflineplus">+      return aPoint;</span>
<a href="#l153.458"></a><span id="l153.458" class="difflineplus">+    // if it's a deletion and it includes the point, clear it</span>
<a href="#l153.459"></a><span id="l153.459" class="difflineplus">+    if (aDelta &lt; 0 &amp;&amp; aPoint &gt;= aDeltaAt &amp;&amp; (aPoint + aDelta &lt; aDeltaAt))</span>
<a href="#l153.460"></a><span id="l153.460" class="difflineplus">+      return null;</span>
<a href="#l153.461"></a><span id="l153.461" class="difflineplus">+    // (else) the point is at/after the change, compensate</span>
<a href="#l153.462"></a><span id="l153.462" class="difflineplus">+    return aPoint + aDelta;</span>
<a href="#l153.463"></a><span id="l153.463" class="difflineplus">+  },</span>
<a href="#l153.464"></a><span id="l153.464" class="difflineplus">+  /**</span>
<a href="#l153.465"></a><span id="l153.465" class="difflineplus">+   * Find the index of the range, if any, that contains the given index, and</span>
<a href="#l153.466"></a><span id="l153.466" class="difflineplus">+   *  the index at which to insert a range if one does not exist.</span>
<a href="#l153.467"></a><span id="l153.467" class="difflineplus">+   *</span>
<a href="#l153.468"></a><span id="l153.468" class="difflineplus">+   * @return A tuple containing: 1) the index if there is one, null otherwise,</span>
<a href="#l153.469"></a><span id="l153.469" class="difflineplus">+   *     2) the index at which to insert a range that would contain the point.</span>
<a href="#l153.470"></a><span id="l153.470" class="difflineplus">+   */</span>
<a href="#l153.471"></a><span id="l153.471" class="difflineplus">+  _findRangeContainingRow:</span>
<a href="#l153.472"></a><span id="l153.472" class="difflineplus">+      function JSTreeSelection__findRangeContainingRow(aIndex) {</span>
<a href="#l153.473"></a><span id="l153.473" class="difflineplus">+    for each (let [iTupe, [low, high]] in Iterator(this._ranges)) {</span>
<a href="#l153.474"></a><span id="l153.474" class="difflineplus">+      if (aIndex &gt;= low &amp;&amp; aIndex &lt;= high)</span>
<a href="#l153.475"></a><span id="l153.475" class="difflineplus">+        return [iTupe, iTupe];</span>
<a href="#l153.476"></a><span id="l153.476" class="difflineplus">+      if (aIndex &lt; low)</span>
<a href="#l153.477"></a><span id="l153.477" class="difflineplus">+        return [null, iTupe];</span>
<a href="#l153.478"></a><span id="l153.478" class="difflineplus">+    }</span>
<a href="#l153.479"></a><span id="l153.479" class="difflineplus">+    return [null, this._ranges.length];</span>
<a href="#l153.480"></a><span id="l153.480" class="difflineplus">+  },</span>
<a href="#l153.481"></a><span id="l153.481" class="difflineplus">+</span>
<a href="#l153.482"></a><span id="l153.482" class="difflineplus">+</span>
<a href="#l153.483"></a><span id="l153.483" class="difflineplus">+  /**</span>
<a href="#l153.484"></a><span id="l153.484" class="difflineplus">+   * When present, a list of calls made to adjustSelection.  See</span>
<a href="#l153.485"></a><span id="l153.485" class="difflineplus">+   *  |logAdjustSelectionForReplay| and |replayAdjustSelectionLog|.</span>
<a href="#l153.486"></a><span id="l153.486" class="difflineplus">+   */</span>
<a href="#l153.487"></a><span id="l153.487" class="difflineplus">+  _adjustSelectionLog: null,</span>
<a href="#l153.488"></a><span id="l153.488" class="difflineplus">+  /**</span>
<a href="#l153.489"></a><span id="l153.489" class="difflineplus">+   * Start logging calls to adjustSelection made against this instance.  You</span>
<a href="#l153.490"></a><span id="l153.490" class="difflineplus">+   *  would do this because you are replacing an existing selection object</span>
<a href="#l153.491"></a><span id="l153.491" class="difflineplus">+   *  with this instance for the purposes of creating a transient selection.</span>
<a href="#l153.492"></a><span id="l153.492" class="difflineplus">+   *  Of course, you want the original selection object to be up-to-date when</span>
<a href="#l153.493"></a><span id="l153.493" class="difflineplus">+   *  you go to put it back, so then you can call replayAdjustSelectionLog</span>
<a href="#l153.494"></a><span id="l153.494" class="difflineplus">+   *  with that selection object and everything will be peachy.</span>
<a href="#l153.495"></a><span id="l153.495" class="difflineplus">+   */</span>
<a href="#l153.496"></a><span id="l153.496" class="difflineplus">+  logAdjustSelectionForReplay:</span>
<a href="#l153.497"></a><span id="l153.497" class="difflineplus">+      function JSTreeSelection_logAdjustSelectionForReplay() {</span>
<a href="#l153.498"></a><span id="l153.498" class="difflineplus">+    this._adjustSelectionLog = [];</span>
<a href="#l153.499"></a><span id="l153.499" class="difflineplus">+  },</span>
<a href="#l153.500"></a><span id="l153.500" class="difflineplus">+  /**</span>
<a href="#l153.501"></a><span id="l153.501" class="difflineplus">+   * Stop logging calls to adjustSelection and replay the existing log against</span>
<a href="#l153.502"></a><span id="l153.502" class="difflineplus">+   *  aSelection.</span>
<a href="#l153.503"></a><span id="l153.503" class="difflineplus">+   *</span>
<a href="#l153.504"></a><span id="l153.504" class="difflineplus">+   * @param aSelection {nsITreeSelection}.</span>
<a href="#l153.505"></a><span id="l153.505" class="difflineplus">+   */</span>
<a href="#l153.506"></a><span id="l153.506" class="difflineplus">+  replayAdjustSelectionLog:</span>
<a href="#l153.507"></a><span id="l153.507" class="difflineplus">+      function JSTreeSelection_replayAdjustSelectionLog(aSelection) {</span>
<a href="#l153.508"></a><span id="l153.508" class="difflineplus">+    if (this._adjustSelectionLog.length) {</span>
<a href="#l153.509"></a><span id="l153.509" class="difflineplus">+      // Temporarily disable selection events because adjustSelection is going</span>
<a href="#l153.510"></a><span id="l153.510" class="difflineplus">+      //  to generate an event each time otherwise, and better 1 event than</span>
<a href="#l153.511"></a><span id="l153.511" class="difflineplus">+      //  many.</span>
<a href="#l153.512"></a><span id="l153.512" class="difflineplus">+      aSelection.selectEventsSuppressed = true;</span>
<a href="#l153.513"></a><span id="l153.513" class="difflineplus">+      for each (let [, [index, count]] in Iterator(this._adjustSelectionLog)) {</span>
<a href="#l153.514"></a><span id="l153.514" class="difflineplus">+        aSelection.adjustSelection(index, count);</span>
<a href="#l153.515"></a><span id="l153.515" class="difflineplus">+      }</span>
<a href="#l153.516"></a><span id="l153.516" class="difflineplus">+      aSelection.selectEventsSuppressed = false;</span>
<a href="#l153.517"></a><span id="l153.517" class="difflineplus">+    }</span>
<a href="#l153.518"></a><span id="l153.518" class="difflineplus">+    this._adjustSelectionLog = null;</span>
<a href="#l153.519"></a><span id="l153.519" class="difflineplus">+  },</span>
<a href="#l153.520"></a><span id="l153.520" class="difflineplus">+</span>
<a href="#l153.521"></a><span id="l153.521" class="difflineplus">+  adjustSelection: function JSTreeSelection_adjustSelection(aIndex, aCount) {</span>
<a href="#l153.522"></a><span id="l153.522" class="difflineplus">+    // nothing to do if there is no actual change</span>
<a href="#l153.523"></a><span id="l153.523" class="difflineplus">+    if (!aCount)</span>
<a href="#l153.524"></a><span id="l153.524" class="difflineplus">+      return;</span>
<a href="#l153.525"></a><span id="l153.525" class="difflineplus">+</span>
<a href="#l153.526"></a><span id="l153.526" class="difflineplus">+    if (this._adjustSelectionLog)</span>
<a href="#l153.527"></a><span id="l153.527" class="difflineplus">+      this._adjustSelectionLog.push([aIndex, aCount]);</span>
<a href="#l153.528"></a><span id="l153.528" class="difflineplus">+</span>
<a href="#l153.529"></a><span id="l153.529" class="difflineplus">+    // adjust our points</span>
<a href="#l153.530"></a><span id="l153.530" class="difflineplus">+    this._shiftSelectPivot = this._adjustPoint(this._shiftSelectPivot,</span>
<a href="#l153.531"></a><span id="l153.531" class="difflineplus">+                                               aIndex, aCount);</span>
<a href="#l153.532"></a><span id="l153.532" class="difflineplus">+    this._currentIndex = this._adjustPoint(this._currentIndex, aIndex, aCount);</span>
<a href="#l153.533"></a><span id="l153.533" class="difflineplus">+</span>
<a href="#l153.534"></a><span id="l153.534" class="difflineplus">+    // If we are adding rows, we want to split any range at aIndex and then</span>
<a href="#l153.535"></a><span id="l153.535" class="difflineplus">+    //  translate all of the ranges above that point up.</span>
<a href="#l153.536"></a><span id="l153.536" class="difflineplus">+    if (aCount &gt; 0) {</span>
<a href="#l153.537"></a><span id="l153.537" class="difflineplus">+      let [iContain, iInsert] = this._findRangeContainingRow(aIndex);</span>
<a href="#l153.538"></a><span id="l153.538" class="difflineplus">+      if (iContain != null) {</span>
<a href="#l153.539"></a><span id="l153.539" class="difflineplus">+        let [low, high] = this._ranges[iContain];</span>
<a href="#l153.540"></a><span id="l153.540" class="difflineplus">+        // if it is the low value, we just want to shift the range entirely, so</span>
<a href="#l153.541"></a><span id="l153.541" class="difflineplus">+        //  do nothing (and keep iInsert pointing at it for translation)</span>
<a href="#l153.542"></a><span id="l153.542" class="difflineplus">+        // if it is not the low value, then there must be at least two values so</span>
<a href="#l153.543"></a><span id="l153.543" class="difflineplus">+        //  we should split it and only translate the new/upper block</span>
<a href="#l153.544"></a><span id="l153.544" class="difflineplus">+        if (aIndex != low) {</span>
<a href="#l153.545"></a><span id="l153.545" class="difflineplus">+          this._ranges.splice(iContain, 1, [low, aIndex - 1], [aIndex, high]);</span>
<a href="#l153.546"></a><span id="l153.546" class="difflineplus">+          iInsert++;</span>
<a href="#l153.547"></a><span id="l153.547" class="difflineplus">+        }</span>
<a href="#l153.548"></a><span id="l153.548" class="difflineplus">+      }</span>
<a href="#l153.549"></a><span id="l153.549" class="difflineplus">+      // now translate everything from iInsert on up</span>
<a href="#l153.550"></a><span id="l153.550" class="difflineplus">+      for (let iTrans = iInsert; iTrans &lt; this._ranges.length; iTrans++) {</span>
<a href="#l153.551"></a><span id="l153.551" class="difflineplus">+        let [low, high] = this._ranges[iTrans];</span>
<a href="#l153.552"></a><span id="l153.552" class="difflineplus">+        this._ranges[iTrans] = [low + aCount, high + aCount];</span>
<a href="#l153.553"></a><span id="l153.553" class="difflineplus">+      }</span>
<a href="#l153.554"></a><span id="l153.554" class="difflineplus">+      // invalidate and fire selection change notice</span>
<a href="#l153.555"></a><span id="l153.555" class="difflineplus">+      if (this._treeBoxObject)</span>
<a href="#l153.556"></a><span id="l153.556" class="difflineplus">+        this._treeBoxObject.invalidate();</span>
<a href="#l153.557"></a><span id="l153.557" class="difflineplus">+      this._fireSelectionChanged();</span>
<a href="#l153.558"></a><span id="l153.558" class="difflineplus">+      return;</span>
<a href="#l153.559"></a><span id="l153.559" class="difflineplus">+    }</span>
<a href="#l153.560"></a><span id="l153.560" class="difflineplus">+</span>
<a href="#l153.561"></a><span id="l153.561" class="difflineplus">+    // If we are removing rows, we are basically clearing the range that is</span>
<a href="#l153.562"></a><span id="l153.562" class="difflineplus">+    //  getting deleted and translating everyone above the remaining point</span>
<a href="#l153.563"></a><span id="l153.563" class="difflineplus">+    //  downwards.  The one trick is we may have to merge the lowest translated</span>
<a href="#l153.564"></a><span id="l153.564" class="difflineplus">+    //  block.</span>
<a href="#l153.565"></a><span id="l153.565" class="difflineplus">+    let saveSuppress = this.selectEventsSuppressed;</span>
<a href="#l153.566"></a><span id="l153.566" class="difflineplus">+    this.selectEventsSuppressed = true;</span>
<a href="#l153.567"></a><span id="l153.567" class="difflineplus">+    this.clearRange(aIndex, aIndex - aCount - 1);</span>
<a href="#l153.568"></a><span id="l153.568" class="difflineplus">+    // translate</span>
<a href="#l153.569"></a><span id="l153.569" class="difflineplus">+    let iTrans = this._findRangeContainingRow(aIndex)[1];</span>
<a href="#l153.570"></a><span id="l153.570" class="difflineplus">+    for (; iTrans &lt; this._ranges.length; iTrans++) {</span>
<a href="#l153.571"></a><span id="l153.571" class="difflineplus">+      let [low, high] = this._ranges[iTrans];</span>
<a href="#l153.572"></a><span id="l153.572" class="difflineplus">+      // for the first range, low may be below the index, in which case it</span>
<a href="#l153.573"></a><span id="l153.573" class="difflineplus">+      //  should not get translated</span>
<a href="#l153.574"></a><span id="l153.574" class="difflineplus">+      this._ranges[iTrans] = [(low &gt;= aIndex) ? low + aCount : low,</span>
<a href="#l153.575"></a><span id="l153.575" class="difflineplus">+                              high + aCount];</span>
<a href="#l153.576"></a><span id="l153.576" class="difflineplus">+    }</span>
<a href="#l153.577"></a><span id="l153.577" class="difflineplus">+    // we may have to merge the lowest translated block because it may now be</span>
<a href="#l153.578"></a><span id="l153.578" class="difflineplus">+    //  adjacent to the previous block</span>
<a href="#l153.579"></a><span id="l153.579" class="difflineplus">+    if (iTrans &gt; 0 &amp;&amp; iTrans &lt; this._ranges.length &amp;&amp;</span>
<a href="#l153.580"></a><span id="l153.580" class="difflineplus">+        this._ranges[iTrans-1][1] == this_ranges[iTrans][0]) {</span>
<a href="#l153.581"></a><span id="l153.581" class="difflineplus">+      this._ranges[iTrans-1][1] = this._ranges[iTrans][1];</span>
<a href="#l153.582"></a><span id="l153.582" class="difflineplus">+      this._ranges.splice(iTrans, 1);</span>
<a href="#l153.583"></a><span id="l153.583" class="difflineplus">+    }</span>
<a href="#l153.584"></a><span id="l153.584" class="difflineplus">+</span>
<a href="#l153.585"></a><span id="l153.585" class="difflineplus">+    if (this._treeBoxObject)</span>
<a href="#l153.586"></a><span id="l153.586" class="difflineplus">+      this._treeBoxObject.invalidate();</span>
<a href="#l153.587"></a><span id="l153.587" class="difflineplus">+    this.selectEventsSuppressed = saveSuppress;</span>
<a href="#l153.588"></a><span id="l153.588" class="difflineplus">+  },</span>
<a href="#l153.589"></a><span id="l153.589" class="difflineplus">+</span>
<a href="#l153.590"></a><span id="l153.590" class="difflineplus">+  get selectEventsSuppressed JSTreeSelection_get_selectEventsSuppressed() {</span>
<a href="#l153.591"></a><span id="l153.591" class="difflineplus">+    return this._selectEventsSuppressed;</span>
<a href="#l153.592"></a><span id="l153.592" class="difflineplus">+  },</span>
<a href="#l153.593"></a><span id="l153.593" class="difflineplus">+  /**</span>
<a href="#l153.594"></a><span id="l153.594" class="difflineplus">+   * Control whether selection events are suppressed.  For consistency with</span>
<a href="#l153.595"></a><span id="l153.595" class="difflineplus">+   *  nsTreeSelection, we always generate a selection event when a value of</span>
<a href="#l153.596"></a><span id="l153.596" class="difflineplus">+   *  false is assigned, even if the value was already false.</span>
<a href="#l153.597"></a><span id="l153.597" class="difflineplus">+   */</span>
<a href="#l153.598"></a><span id="l153.598" class="difflineplus">+  set selectEventsSuppressed</span>
<a href="#l153.599"></a><span id="l153.599" class="difflineplus">+      JSTreeSelection_set_selectEventsSuppressed(aSuppress) {</span>
<a href="#l153.600"></a><span id="l153.600" class="difflineplus">+    this._selectEventsSuppressed = aSuppress;</span>
<a href="#l153.601"></a><span id="l153.601" class="difflineplus">+    if (!aSuppress)</span>
<a href="#l153.602"></a><span id="l153.602" class="difflineplus">+      this._fireSelectionChanged();</span>
<a href="#l153.603"></a><span id="l153.603" class="difflineplus">+  },</span>
<a href="#l153.604"></a><span id="l153.604" class="difflineplus">+</span>
<a href="#l153.605"></a><span id="l153.605" class="difflineplus">+  /**</span>
<a href="#l153.606"></a><span id="l153.606" class="difflineplus">+   * Note that we bypass any XUL &quot;onselect&quot; handler that may exist and go</span>
<a href="#l153.607"></a><span id="l153.607" class="difflineplus">+   *  straight to the view.  If you have a tree, you shouldn't be using us,</span>
<a href="#l153.608"></a><span id="l153.608" class="difflineplus">+   *  so this seems aboot right.</span>
<a href="#l153.609"></a><span id="l153.609" class="difflineplus">+   */</span>
<a href="#l153.610"></a><span id="l153.610" class="difflineplus">+  _fireSelectionChanged: function JSTreeSelection__fireSelectionChanged() {</span>
<a href="#l153.611"></a><span id="l153.611" class="difflineplus">+    // don't fire if we are suppressed; we will fire when un-suppressed</span>
<a href="#l153.612"></a><span id="l153.612" class="difflineplus">+    if (this.selectEventsSuppressed)</span>
<a href="#l153.613"></a><span id="l153.613" class="difflineplus">+      return;</span>
<a href="#l153.614"></a><span id="l153.614" class="difflineplus">+    // we need a box object to get at the view</span>
<a href="#l153.615"></a><span id="l153.615" class="difflineplus">+    if (!this._treeBoxObject)</span>
<a href="#l153.616"></a><span id="l153.616" class="difflineplus">+      return;</span>
<a href="#l153.617"></a><span id="l153.617" class="difflineplus">+    // we need a view to have a view...</span>
<a href="#l153.618"></a><span id="l153.618" class="difflineplus">+    if (!this._treeBoxObject.view)</span>
<a href="#l153.619"></a><span id="l153.619" class="difflineplus">+      return;</span>
<a href="#l153.620"></a><span id="l153.620" class="difflineplus">+</span>
<a href="#l153.621"></a><span id="l153.621" class="difflineplus">+    let view = this._treeBoxObject.view.QueryInterface(Ci.nsITreeView);</span>
<a href="#l153.622"></a><span id="l153.622" class="difflineplus">+    view.selectionChanged();</span>
<a href="#l153.623"></a><span id="l153.623" class="difflineplus">+  },</span>
<a href="#l153.624"></a><span id="l153.624" class="difflineplus">+</span>
<a href="#l153.625"></a><span id="l153.625" class="difflineplus">+  get currentIndex JSTreeSelection_get_currentIndex() {</span>
<a href="#l153.626"></a><span id="l153.626" class="difflineplus">+    if (this._currentIndex == null)</span>
<a href="#l153.627"></a><span id="l153.627" class="difflineplus">+      return -1;</span>
<a href="#l153.628"></a><span id="l153.628" class="difflineplus">+    return this._currentIndex;</span>
<a href="#l153.629"></a><span id="l153.629" class="difflineplus">+  },</span>
<a href="#l153.630"></a><span id="l153.630" class="difflineplus">+  /**</span>
<a href="#l153.631"></a><span id="l153.631" class="difflineplus">+   * Sets the current index.  Other than updating the variable, this just</span>
<a href="#l153.632"></a><span id="l153.632" class="difflineplus">+   *  invalidates the tree row if we have a tree.</span>
<a href="#l153.633"></a><span id="l153.633" class="difflineplus">+   * The real selection object would send a DOM event we don't care about.</span>
<a href="#l153.634"></a><span id="l153.634" class="difflineplus">+   */</span>
<a href="#l153.635"></a><span id="l153.635" class="difflineplus">+  set currentIndex JSTreeSelection_set_currentIndex(aIndex) {</span>
<a href="#l153.636"></a><span id="l153.636" class="difflineplus">+    if (aIndex == this.currentIndex)</span>
<a href="#l153.637"></a><span id="l153.637" class="difflineplus">+      return;</span>
<a href="#l153.638"></a><span id="l153.638" class="difflineplus">+</span>
<a href="#l153.639"></a><span id="l153.639" class="difflineplus">+    this._currentIndex = (aIndex != -1) ? aIndex : null;</span>
<a href="#l153.640"></a><span id="l153.640" class="difflineplus">+    if (this._treeBoxObject)</span>
<a href="#l153.641"></a><span id="l153.641" class="difflineplus">+      this._treeBoxObject.invalidateRow(aIndex);</span>
<a href="#l153.642"></a><span id="l153.642" class="difflineplus">+  },</span>
<a href="#l153.643"></a><span id="l153.643" class="difflineplus">+</span>
<a href="#l153.644"></a><span id="l153.644" class="difflineplus">+  currentColumn: null,</span>
<a href="#l153.645"></a><span id="l153.645" class="difflineplus">+</span>
<a href="#l153.646"></a><span id="l153.646" class="difflineplus">+  get shiftSelectPivot JSTreeSelection_get_shiftSelectPivot() {</span>
<a href="#l153.647"></a><span id="l153.647" class="difflineplus">+    return this._shiftSelectPivot != null ? this._shiftSelectPivot : -1;</span>
<a href="#l153.648"></a><span id="l153.648" class="difflineplus">+  },</span>
<a href="#l153.649"></a><span id="l153.649" class="difflineplus">+</span>
<a href="#l153.650"></a><span id="l153.650" class="difflineplus">+  QueryInterface: XPCOMUtils.generateQI(</span>
<a href="#l153.651"></a><span id="l153.651" class="difflineplus">+    [Ci.nsITreeSelection]),</span>
<a href="#l153.652"></a><span id="l153.652" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l154.1"></a><span id="l154.1" class="difflineminus">--- a/mailnews/base/util/nsMsgDBFolder.cpp</span>
<a href="#l154.2"></a><span id="l154.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgDBFolder.cpp</span>
<a href="#l154.3"></a><span id="l154.3" class="difflineat">@@ -1911,21 +1911,30 @@ nsMsgDBFolder::MatchOrChangeFilterDestin</span>
<a href="#l154.4"></a><span id="l154.4">   {</span>
<a href="#l154.5"></a><span id="l154.5">     nsCOMPtr &lt;nsIMsgIncomingServer&gt; server = do_QueryElementAt(allServers, serverIndex);</span>
<a href="#l154.6"></a><span id="l154.6">     if (server)</span>
<a href="#l154.7"></a><span id="l154.7">     {</span>
<a href="#l154.8"></a><span id="l154.8">       PRBool canHaveFilters;</span>
<a href="#l154.9"></a><span id="l154.9">       rv = server-&gt;GetCanHaveFilters(&amp;canHaveFilters);</span>
<a href="#l154.10"></a><span id="l154.10">       if (NS_SUCCEEDED(rv) &amp;&amp; canHaveFilters)</span>
<a href="#l154.11"></a><span id="l154.11">       {</span>
<a href="#l154.12"></a><span id="l154.12" class="difflineplus">+        // update the filterlist to match the new folder name</span>
<a href="#l154.13"></a><span id="l154.13">         rv = server-&gt;GetFilterList(nsnull, getter_AddRefs(filterList));</span>
<a href="#l154.14"></a><span id="l154.14" class="difflineminus">-        if (filterList)</span>
<a href="#l154.15"></a><span id="l154.15" class="difflineplus">+        if (NS_SUCCEEDED(rv) &amp;&amp; filterList)</span>
<a href="#l154.16"></a><span id="l154.16">         {</span>
<a href="#l154.17"></a><span id="l154.17">           rv = filterList-&gt;MatchOrChangeFilterTarget(oldUri, newUri, caseInsensitive, found);</span>
<a href="#l154.18"></a><span id="l154.18" class="difflineminus">-          if (found &amp;&amp; newFolder &amp;&amp; !newUri.IsEmpty())</span>
<a href="#l154.19"></a><span id="l154.19" class="difflineplus">+          if (NS_SUCCEEDED(rv) &amp;&amp; found &amp;&amp; newFolder &amp;&amp; !newUri.IsEmpty())</span>
<a href="#l154.20"></a><span id="l154.20" class="difflineplus">+            rv = filterList-&gt;SaveToDefaultFile();</span>
<a href="#l154.21"></a><span id="l154.21" class="difflineplus">+        }</span>
<a href="#l154.22"></a><span id="l154.22" class="difflineplus">+        // update the editable filterlist to match the new folder name</span>
<a href="#l154.23"></a><span id="l154.23" class="difflineplus">+        rv = server-&gt;GetEditableFilterList(nsnull, getter_AddRefs(filterList));</span>
<a href="#l154.24"></a><span id="l154.24" class="difflineplus">+        if (NS_SUCCEEDED(rv) &amp;&amp; filterList)</span>
<a href="#l154.25"></a><span id="l154.25" class="difflineplus">+        {</span>
<a href="#l154.26"></a><span id="l154.26" class="difflineplus">+          rv = filterList-&gt;MatchOrChangeFilterTarget(oldUri, newUri, caseInsensitive, found);</span>
<a href="#l154.27"></a><span id="l154.27" class="difflineplus">+          if (NS_SUCCEEDED(rv) &amp;&amp; found &amp;&amp; newFolder &amp;&amp; !newUri.IsEmpty())</span>
<a href="#l154.28"></a><span id="l154.28">             rv = filterList-&gt;SaveToDefaultFile();</span>
<a href="#l154.29"></a><span id="l154.29">         }</span>
<a href="#l154.30"></a><span id="l154.30">       }</span>
<a href="#l154.31"></a><span id="l154.31">     }</span>
<a href="#l154.32"></a><span id="l154.32">   }</span>
<a href="#l154.33"></a><span id="l154.33">   return rv;</span>
<a href="#l154.34"></a><span id="l154.34"> }</span>
<a href="#l154.35"></a><span id="l154.35"> </span>
<a href="#l154.36"></a><span id="l154.36" class="difflineat">@@ -4733,16 +4742,35 @@ NS_IMETHODIMP</span>
<a href="#l154.37"></a><span id="l154.37"> nsMsgDBFolder::SetFilterList(nsIMsgFilterList *aFilterList)</span>
<a href="#l154.38"></a><span id="l154.38"> {</span>
<a href="#l154.39"></a><span id="l154.39">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l154.40"></a><span id="l154.40">   nsresult rv = GetServer(getter_AddRefs(server));</span>
<a href="#l154.41"></a><span id="l154.41">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l154.42"></a><span id="l154.42">   return server-&gt;SetFilterList(aFilterList);</span>
<a href="#l154.43"></a><span id="l154.43"> }</span>
<a href="#l154.44"></a><span id="l154.44"> </span>
<a href="#l154.45"></a><span id="l154.45" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l154.46"></a><span id="l154.46" class="difflineplus">+nsMsgDBFolder::GetEditableFilterList(nsIMsgWindow *aMsgWindow, nsIMsgFilterList **aResult)</span>
<a href="#l154.47"></a><span id="l154.47" class="difflineplus">+{</span>
<a href="#l154.48"></a><span id="l154.48" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l154.49"></a><span id="l154.49" class="difflineplus">+  nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l154.50"></a><span id="l154.50" class="difflineplus">+  nsresult rv = GetServer(getter_AddRefs(server));</span>
<a href="#l154.51"></a><span id="l154.51" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l154.52"></a><span id="l154.52" class="difflineplus">+  return server-&gt;GetEditableFilterList(aMsgWindow, aResult);</span>
<a href="#l154.53"></a><span id="l154.53" class="difflineplus">+}</span>
<a href="#l154.54"></a><span id="l154.54" class="difflineplus">+</span>
<a href="#l154.55"></a><span id="l154.55" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l154.56"></a><span id="l154.56" class="difflineplus">+nsMsgDBFolder::SetEditableFilterList(nsIMsgFilterList *aFilterList)</span>
<a href="#l154.57"></a><span id="l154.57" class="difflineplus">+{</span>
<a href="#l154.58"></a><span id="l154.58" class="difflineplus">+  nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l154.59"></a><span id="l154.59" class="difflineplus">+  nsresult rv = GetServer(getter_AddRefs(server));</span>
<a href="#l154.60"></a><span id="l154.60" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l154.61"></a><span id="l154.61" class="difflineplus">+  return server-&gt;SetEditableFilterList(aFilterList);</span>
<a href="#l154.62"></a><span id="l154.62" class="difflineplus">+}</span>
<a href="#l154.63"></a><span id="l154.63" class="difflineplus">+</span>
<a href="#l154.64"></a><span id="l154.64"> /* void enableNotifications (in long notificationType, in boolean enable); */</span>
<a href="#l154.65"></a><span id="l154.65"> NS_IMETHODIMP nsMsgDBFolder::EnableNotifications(PRInt32 notificationType, PRBool enable, PRBool dbBatching)</span>
<a href="#l154.66"></a><span id="l154.66"> {</span>
<a href="#l154.67"></a><span id="l154.67">   if (notificationType == nsIMsgFolder::allMessageCountNotifications)</span>
<a href="#l154.68"></a><span id="l154.68">   {</span>
<a href="#l154.69"></a><span id="l154.69">     mNotifyCountChanges = enable;</span>
<a href="#l154.70"></a><span id="l154.70">     // start and stop db batching here. This is under the theory</span>
<a href="#l154.71"></a><span id="l154.71">     // that any time we want to enable and disable notifications,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l155.1"></a><span id="l155.1" class="difflineminus">--- a/mailnews/base/util/nsMsgIncomingServer.cpp</span>
<a href="#l155.2"></a><span id="l155.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgIncomingServer.cpp</span>
<a href="#l155.3"></a><span id="l155.3" class="difflineat">@@ -1032,25 +1032,48 @@ nsMsgIncomingServer::SetFilterList(nsIMs</span>
<a href="#l155.4"></a><span id="l155.4"> {</span>
<a href="#l155.5"></a><span id="l155.5">   mFilterList = aFilterList;</span>
<a href="#l155.6"></a><span id="l155.6">   return NS_OK;</span>
<a href="#l155.7"></a><span id="l155.7"> }</span>
<a href="#l155.8"></a><span id="l155.8"> </span>
<a href="#l155.9"></a><span id="l155.9"> NS_IMETHODIMP</span>
<a href="#l155.10"></a><span id="l155.10"> nsMsgIncomingServer::GetFilterList(nsIMsgWindow *aMsgWindow, nsIMsgFilterList **aResult)</span>
<a href="#l155.11"></a><span id="l155.11"> {</span>
<a href="#l155.12"></a><span id="l155.12" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l155.13"></a><span id="l155.13">   if (!mFilterList)</span>
<a href="#l155.14"></a><span id="l155.14">   {</span>
<a href="#l155.15"></a><span id="l155.15">       nsCOMPtr&lt;nsIMsgFolder&gt; msgFolder;</span>
<a href="#l155.16"></a><span id="l155.16">       // use GetRootFolder so for deferred pop3 accounts, we'll get the filters</span>
<a href="#l155.17"></a><span id="l155.17">       // file from the deferred account, not the deferred to account,</span>
<a href="#l155.18"></a><span id="l155.18">       // so that filters will still be per-server.</span>
<a href="#l155.19"></a><span id="l155.19">       nsresult rv = GetRootFolder(getter_AddRefs(msgFolder));</span>
<a href="#l155.20"></a><span id="l155.20">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l155.21"></a><span id="l155.21"> </span>
<a href="#l155.22"></a><span id="l155.22" class="difflineplus">+      nsCString filterType;</span>
<a href="#l155.23"></a><span id="l155.23" class="difflineplus">+      rv = GetCharValue(&quot;filter.type&quot;, filterType);</span>
<a href="#l155.24"></a><span id="l155.24" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l155.25"></a><span id="l155.25" class="difflineplus">+</span>
<a href="#l155.26"></a><span id="l155.26" class="difflineplus">+      if (!filterType.IsEmpty() &amp;&amp; !filterType.EqualsLiteral(&quot;default&quot;))</span>
<a href="#l155.27"></a><span id="l155.27" class="difflineplus">+      {</span>
<a href="#l155.28"></a><span id="l155.28" class="difflineplus">+        nsCAutoString contractID(&quot;@mozilla.org/filterlist;1?type=&quot;);</span>
<a href="#l155.29"></a><span id="l155.29" class="difflineplus">+        contractID += filterType;</span>
<a href="#l155.30"></a><span id="l155.30" class="difflineplus">+        ToLowerCase(contractID);</span>
<a href="#l155.31"></a><span id="l155.31" class="difflineplus">+        mFilterList = do_CreateInstance(contractID.get(), &amp;rv);</span>
<a href="#l155.32"></a><span id="l155.32" class="difflineplus">+        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l155.33"></a><span id="l155.33" class="difflineplus">+</span>
<a href="#l155.34"></a><span id="l155.34" class="difflineplus">+        rv = mFilterList-&gt;SetFolder(msgFolder);</span>
<a href="#l155.35"></a><span id="l155.35" class="difflineplus">+        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l155.36"></a><span id="l155.36" class="difflineplus">+</span>
<a href="#l155.37"></a><span id="l155.37" class="difflineplus">+        NS_ADDREF(*aResult = mFilterList);</span>
<a href="#l155.38"></a><span id="l155.38" class="difflineplus">+        return NS_OK;</span>
<a href="#l155.39"></a><span id="l155.39" class="difflineplus">+      }</span>
<a href="#l155.40"></a><span id="l155.40" class="difflineplus">+</span>
<a href="#l155.41"></a><span id="l155.41" class="difflineplus">+      // The default case, a local folder, is a bit special. It requires</span>
<a href="#l155.42"></a><span id="l155.42" class="difflineplus">+      // more initialization.</span>
<a href="#l155.43"></a><span id="l155.43" class="difflineplus">+</span>
<a href="#l155.44"></a><span id="l155.44">       nsCOMPtr&lt;nsILocalFile&gt; thisFolder;</span>
<a href="#l155.45"></a><span id="l155.45">       rv = msgFolder-&gt;GetFilePath(getter_AddRefs(thisFolder));</span>
<a href="#l155.46"></a><span id="l155.46">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l155.47"></a><span id="l155.47"> </span>
<a href="#l155.48"></a><span id="l155.48">       mFilterFile = do_CreateInstance(NS_LOCAL_FILE_CONTRACTID, &amp;rv);</span>
<a href="#l155.49"></a><span id="l155.49">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l155.50"></a><span id="l155.50">       rv = mFilterFile-&gt;InitWithFile(thisFolder);</span>
<a href="#l155.51"></a><span id="l155.51">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l155.52"></a><span id="l155.52" class="difflineat">@@ -1079,17 +1102,62 @@ nsMsgIncomingServer::GetFilterList(nsIMs</span>
<a href="#l155.53"></a><span id="l155.53">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l155.54"></a><span id="l155.54"> </span>
<a href="#l155.55"></a><span id="l155.55">       rv = filterService-&gt;OpenFilterList(mFilterFile, msgFolder, aMsgWindow, getter_AddRefs(mFilterList));</span>
<a href="#l155.56"></a><span id="l155.56">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l155.57"></a><span id="l155.57">   }</span>
<a href="#l155.58"></a><span id="l155.58"> </span>
<a href="#l155.59"></a><span id="l155.59">   NS_IF_ADDREF(*aResult = mFilterList);</span>
<a href="#l155.60"></a><span id="l155.60">   return NS_OK;</span>
<a href="#l155.61"></a><span id="l155.61" class="difflineplus">+}</span>
<a href="#l155.62"></a><span id="l155.62"> </span>
<a href="#l155.63"></a><span id="l155.63" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l155.64"></a><span id="l155.64" class="difflineplus">+nsMsgIncomingServer::SetEditableFilterList(nsIMsgFilterList *aEditableFilterList)</span>
<a href="#l155.65"></a><span id="l155.65" class="difflineplus">+{</span>
<a href="#l155.66"></a><span id="l155.66" class="difflineplus">+  mEditableFilterList = aEditableFilterList;</span>
<a href="#l155.67"></a><span id="l155.67" class="difflineplus">+  return NS_OK;</span>
<a href="#l155.68"></a><span id="l155.68" class="difflineplus">+}</span>
<a href="#l155.69"></a><span id="l155.69" class="difflineplus">+</span>
<a href="#l155.70"></a><span id="l155.70" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l155.71"></a><span id="l155.71" class="difflineplus">+nsMsgIncomingServer::GetEditableFilterList(nsIMsgWindow *aMsgWindow, nsIMsgFilterList **aResult)</span>
<a href="#l155.72"></a><span id="l155.72" class="difflineplus">+{</span>
<a href="#l155.73"></a><span id="l155.73" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l155.74"></a><span id="l155.74" class="difflineplus">+  if (!mEditableFilterList)</span>
<a href="#l155.75"></a><span id="l155.75" class="difflineplus">+  {</span>
<a href="#l155.76"></a><span id="l155.76" class="difflineplus">+    PRBool editSeparate;</span>
<a href="#l155.77"></a><span id="l155.77" class="difflineplus">+    nsresult rv = GetBoolValue(&quot;filter.editable.separate&quot;, &amp;editSeparate);</span>
<a href="#l155.78"></a><span id="l155.78" class="difflineplus">+    if (NS_FAILED(rv) || !editSeparate)</span>
<a href="#l155.79"></a><span id="l155.79" class="difflineplus">+      return GetFilterList(aMsgWindow, aResult);</span>
<a href="#l155.80"></a><span id="l155.80" class="difflineplus">+</span>
<a href="#l155.81"></a><span id="l155.81" class="difflineplus">+    nsCString filterType;</span>
<a href="#l155.82"></a><span id="l155.82" class="difflineplus">+    rv = GetCharValue(&quot;filter.editable.type&quot;, filterType);</span>
<a href="#l155.83"></a><span id="l155.83" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l155.84"></a><span id="l155.84" class="difflineplus">+</span>
<a href="#l155.85"></a><span id="l155.85" class="difflineplus">+    nsCAutoString contractID(&quot;@mozilla.org/filterlist;1?type=&quot;);</span>
<a href="#l155.86"></a><span id="l155.86" class="difflineplus">+    contractID += filterType;</span>
<a href="#l155.87"></a><span id="l155.87" class="difflineplus">+    ToLowerCase(contractID);</span>
<a href="#l155.88"></a><span id="l155.88" class="difflineplus">+    mEditableFilterList = do_CreateInstance(contractID.get(), &amp;rv);</span>
<a href="#l155.89"></a><span id="l155.89" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l155.90"></a><span id="l155.90" class="difflineplus">+</span>
<a href="#l155.91"></a><span id="l155.91" class="difflineplus">+    nsCOMPtr&lt;nsIMsgFolder&gt; msgFolder;</span>
<a href="#l155.92"></a><span id="l155.92" class="difflineplus">+    // use GetRootFolder so for deferred pop3 accounts, we'll get the filters</span>
<a href="#l155.93"></a><span id="l155.93" class="difflineplus">+    // file from the deferred account, not the deferred to account,</span>
<a href="#l155.94"></a><span id="l155.94" class="difflineplus">+    // so that filters will still be per-server.</span>
<a href="#l155.95"></a><span id="l155.95" class="difflineplus">+    rv = GetRootFolder(getter_AddRefs(msgFolder));</span>
<a href="#l155.96"></a><span id="l155.96" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l155.97"></a><span id="l155.97" class="difflineplus">+</span>
<a href="#l155.98"></a><span id="l155.98" class="difflineplus">+    rv = mEditableFilterList-&gt;SetFolder(msgFolder);</span>
<a href="#l155.99"></a><span id="l155.99" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l155.100"></a><span id="l155.100" class="difflineplus">+</span>
<a href="#l155.101"></a><span id="l155.101" class="difflineplus">+    NS_ADDREF(*aResult = mEditableFilterList);</span>
<a href="#l155.102"></a><span id="l155.102" class="difflineplus">+    return NS_OK;</span>
<a href="#l155.103"></a><span id="l155.103" class="difflineplus">+  }</span>
<a href="#l155.104"></a><span id="l155.104" class="difflineplus">+</span>
<a href="#l155.105"></a><span id="l155.105" class="difflineplus">+  NS_IF_ADDREF(*aResult = mEditableFilterList);</span>
<a href="#l155.106"></a><span id="l155.106" class="difflineplus">+  return NS_OK;</span>
<a href="#l155.107"></a><span id="l155.107"> }</span>
<a href="#l155.108"></a><span id="l155.108"> </span>
<a href="#l155.109"></a><span id="l155.109"> // If the hostname contains ':' (like hostname:1431)</span>
<a href="#l155.110"></a><span id="l155.110"> // then parse and set the port number.</span>
<a href="#l155.111"></a><span id="l155.111"> nsresult</span>
<a href="#l155.112"></a><span id="l155.112"> nsMsgIncomingServer::InternalSetHostName(const nsACString&amp; aHostname, const char * prefName)</span>
<a href="#l155.113"></a><span id="l155.113"> {</span>
<a href="#l155.114"></a><span id="l155.114">   nsCString hostname;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l156.1"></a><span id="l156.1" class="difflineminus">--- a/mailnews/base/util/nsMsgIncomingServer.h</span>
<a href="#l156.2"></a><span id="l156.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgIncomingServer.h</span>
<a href="#l156.3"></a><span id="l156.3" class="difflineat">@@ -95,16 +95,17 @@ protected:</span>
<a href="#l156.4"></a><span id="l156.4">   virtual nsresult CreateRootFolderFromUri(const nsCString &amp;serverUri,</span>
<a href="#l156.5"></a><span id="l156.5">                                            nsIMsgFolder **rootFolder) = 0;</span>
<a href="#l156.6"></a><span id="l156.6"> </span>
<a href="#l156.7"></a><span id="l156.7">   nsresult InternalSetHostName(const nsACString&amp; aHostname, const char * prefName);</span>
<a href="#l156.8"></a><span id="l156.8"> </span>
<a href="#l156.9"></a><span id="l156.9">   nsresult getProtocolInfo(nsIMsgProtocolInfo **aResult);</span>
<a href="#l156.10"></a><span id="l156.10">   nsCOMPtr &lt;nsILocalFile&gt; mFilterFile;</span>
<a href="#l156.11"></a><span id="l156.11">   nsCOMPtr &lt;nsIMsgFilterList&gt; mFilterList;</span>
<a href="#l156.12"></a><span id="l156.12" class="difflineplus">+  nsCOMPtr &lt;nsIMsgFilterList&gt; mEditableFilterList;</span>
<a href="#l156.13"></a><span id="l156.13">   nsCOMPtr&lt;nsIPrefBranch&gt; mPrefBranch;</span>
<a href="#l156.14"></a><span id="l156.14">   nsCOMPtr&lt;nsIPrefBranch&gt; mDefPrefBranch;</span>
<a href="#l156.15"></a><span id="l156.15"> </span>
<a href="#l156.16"></a><span id="l156.16">   // these allow us to handle duplicate incoming messages, e.g. delete them.</span>
<a href="#l156.17"></a><span id="l156.17">   nsDataHashtable&lt;nsCStringHashKey,PRInt32&gt; m_downloadedHdrs;</span>
<a href="#l156.18"></a><span id="l156.18">   PRInt32  m_numMsgsDownloaded;</span>
<a href="#l156.19"></a><span id="l156.19"> static PLDHashOperator evictOldEntries(nsCStringHashKey::KeyType aKey, PRInt32 &amp;aData, void *aClosure);</span>
<a href="#l156.20"></a><span id="l156.20"> private:</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l157.1"></a><span id="l157.1" class="difflineminus">--- a/mailnews/base/util/nsMsgMailNewsUrl.cpp</span>
<a href="#l157.2"></a><span id="l157.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgMailNewsUrl.cpp</span>
<a href="#l157.3"></a><span id="l157.3" class="difflineat">@@ -60,16 +60,17 @@ nsMsgMailNewsUrl::nsMsgMailNewsUrl()</span>
<a href="#l157.4"></a><span id="l157.4"> {</span>
<a href="#l157.5"></a><span id="l157.5">   // nsIURI specific state</span>
<a href="#l157.6"></a><span id="l157.6">   m_errorMessage = nsnull;</span>
<a href="#l157.7"></a><span id="l157.7">   m_runningUrl = PR_FALSE;</span>
<a href="#l157.8"></a><span id="l157.8">   m_updatingFolder = PR_FALSE;</span>
<a href="#l157.9"></a><span id="l157.9">   m_addContentToCache = PR_FALSE;</span>
<a href="#l157.10"></a><span id="l157.10">   m_msgIsInLocalCache = PR_FALSE;</span>
<a href="#l157.11"></a><span id="l157.11">   m_suppressErrorMsgs = PR_FALSE;</span>
<a href="#l157.12"></a><span id="l157.12" class="difflineplus">+  mMaxProgress = -1;</span>
<a href="#l157.13"></a><span id="l157.13">   </span>
<a href="#l157.14"></a><span id="l157.14">   m_baseURL = do_CreateInstance(NS_STANDARDURL_CONTRACTID);</span>
<a href="#l157.15"></a><span id="l157.15"> }</span>
<a href="#l157.16"></a><span id="l157.16"> </span>
<a href="#l157.17"></a><span id="l157.17"> #define NOTIFY_URL_LISTENERS(propertyfunc_, params_)                   \</span>
<a href="#l157.18"></a><span id="l157.18">   PR_BEGIN_MACRO                                                       \</span>
<a href="#l157.19"></a><span id="l157.19">   nsTObserverArray&lt;nsCOMPtr&lt;nsIUrlListener&gt; &gt;::ForwardIterator iter(mUrlListeners); \</span>
<a href="#l157.20"></a><span id="l157.20">   while (iter.HasMore()) {                                             \</span>
<a href="#l157.21"></a><span id="l157.21" class="difflineat">@@ -248,16 +249,28 @@ NS_IMETHODIMP nsMsgMailNewsUrl::GetStatu</span>
<a href="#l157.22"></a><span id="l157.22"> </span>
<a href="#l157.23"></a><span id="l157.23"> NS_IMETHODIMP nsMsgMailNewsUrl::SetStatusFeedback(nsIMsgStatusFeedback *aMsgFeedback)</span>
<a href="#l157.24"></a><span id="l157.24"> {</span>
<a href="#l157.25"></a><span id="l157.25">   if (aMsgFeedback)</span>
<a href="#l157.26"></a><span id="l157.26">     m_statusFeedbackWeak = do_GetWeakReference(aMsgFeedback);</span>
<a href="#l157.27"></a><span id="l157.27">   return NS_OK;</span>
<a href="#l157.28"></a><span id="l157.28"> }</span>
<a href="#l157.29"></a><span id="l157.29"> </span>
<a href="#l157.30"></a><span id="l157.30" class="difflineplus">+NS_IMETHODIMP nsMsgMailNewsUrl::GetMaxProgress(PRInt64 *aMaxProgress)</span>
<a href="#l157.31"></a><span id="l157.31" class="difflineplus">+{</span>
<a href="#l157.32"></a><span id="l157.32" class="difflineplus">+  *aMaxProgress = mMaxProgress;</span>
<a href="#l157.33"></a><span id="l157.33" class="difflineplus">+  return NS_OK;</span>
<a href="#l157.34"></a><span id="l157.34" class="difflineplus">+}</span>
<a href="#l157.35"></a><span id="l157.35" class="difflineplus">+</span>
<a href="#l157.36"></a><span id="l157.36" class="difflineplus">+NS_IMETHODIMP nsMsgMailNewsUrl::SetMaxProgress(PRInt64 aMaxProgress)</span>
<a href="#l157.37"></a><span id="l157.37" class="difflineplus">+{</span>
<a href="#l157.38"></a><span id="l157.38" class="difflineplus">+  mMaxProgress = aMaxProgress;</span>
<a href="#l157.39"></a><span id="l157.39" class="difflineplus">+  return NS_OK;</span>
<a href="#l157.40"></a><span id="l157.40" class="difflineplus">+}</span>
<a href="#l157.41"></a><span id="l157.41" class="difflineplus">+</span>
<a href="#l157.42"></a><span id="l157.42"> NS_IMETHODIMP nsMsgMailNewsUrl::GetLoadGroup(nsILoadGroup **aLoadGroup)</span>
<a href="#l157.43"></a><span id="l157.43"> {</span>
<a href="#l157.44"></a><span id="l157.44">   *aLoadGroup = nsnull;</span>
<a href="#l157.45"></a><span id="l157.45">   // note: it is okay to return a null load group and not return an error</span>
<a href="#l157.46"></a><span id="l157.46">   // it's possible the url really doesn't have load group</span>
<a href="#l157.47"></a><span id="l157.47">   nsCOMPtr&lt;nsILoadGroup&gt; loadGroup (do_QueryReferent(m_loadGroupWeak));</span>
<a href="#l157.48"></a><span id="l157.48">   if (!loadGroup)</span>
<a href="#l157.49"></a><span id="l157.49">   {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l158.1"></a><span id="l158.1" class="difflineminus">--- a/mailnews/base/util/nsMsgMailNewsUrl.h</span>
<a href="#l158.2"></a><span id="l158.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgMailNewsUrl.h</span>
<a href="#l158.3"></a><span id="l158.3" class="difflineat">@@ -87,16 +87,17 @@ protected:</span>
<a href="#l158.4"></a><span id="l158.4">   nsWeakPtr m_loadGroupWeak;</span>
<a href="#l158.5"></a><span id="l158.5">   nsCOMPtr&lt;nsIMimeHeaders&gt; mMimeHeaders;</span>
<a href="#l158.6"></a><span id="l158.6">   nsCOMPtr&lt;nsIMsgSearchSession&gt; m_searchSession;</span>
<a href="#l158.7"></a><span id="l158.7">   nsCOMPtr&lt;nsICacheEntryDescriptor&gt; m_memCacheEntry;</span>
<a href="#l158.8"></a><span id="l158.8">   nsCOMPtr&lt;nsICacheSession&gt; m_imageCacheSession;</span>
<a href="#l158.9"></a><span id="l158.9">   nsCOMPtr&lt;nsISupportsArray&gt; m_cachedMemCacheEntries;</span>
<a href="#l158.10"></a><span id="l158.10">   nsCOMPtr&lt;nsIMsgHeaderSink&gt; mMsgHeaderSink;</span>
<a href="#l158.11"></a><span id="l158.11">   char *m_errorMessage;</span>
<a href="#l158.12"></a><span id="l158.12" class="difflineplus">+  PRInt64 mMaxProgress;</span>
<a href="#l158.13"></a><span id="l158.13">   PRBool m_runningUrl;</span>
<a href="#l158.14"></a><span id="l158.14">   PRBool m_updatingFolder;</span>
<a href="#l158.15"></a><span id="l158.15">   PRBool m_addContentToCache;</span>
<a href="#l158.16"></a><span id="l158.16">   PRBool m_msgIsInLocalCache;</span>
<a href="#l158.17"></a><span id="l158.17">   PRBool m_suppressErrorMsgs;</span>
<a href="#l158.18"></a><span id="l158.18"> </span>
<a href="#l158.19"></a><span id="l158.19">   // the following field is really a bit of a hack to make </span>
<a href="#l158.20"></a><span id="l158.20">   // open attachments work. The external applications code sometimes tries to figure out the right</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l159.1"></a><span id="l159.1" class="difflineminus">--- a/mailnews/base/util/nsMsgProtocol.cpp</span>
<a href="#l159.2"></a><span id="l159.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgProtocol.cpp</span>
<a href="#l159.3"></a><span id="l159.3" class="difflineat">@@ -82,16 +82,17 @@ static PRUnichar *FormatStringWithHostNa</span>
<a href="#l159.4"></a><span id="l159.4"> </span>
<a href="#l159.5"></a><span id="l159.5"> </span>
<a href="#l159.6"></a><span id="l159.6"> nsMsgProtocol::nsMsgProtocol(nsIURI * aURL)</span>
<a href="#l159.7"></a><span id="l159.7"> {</span>
<a href="#l159.8"></a><span id="l159.8">   m_flags = 0;</span>
<a href="#l159.9"></a><span id="l159.9">   m_readCount = 0;</span>
<a href="#l159.10"></a><span id="l159.10">   mLoadFlags = 0;</span>
<a href="#l159.11"></a><span id="l159.11">   m_socketIsOpen = PR_FALSE;</span>
<a href="#l159.12"></a><span id="l159.12" class="difflineplus">+  mContentLength = -1;</span>
<a href="#l159.13"></a><span id="l159.13"> </span>
<a href="#l159.14"></a><span id="l159.14">   GetSpecialDirectoryWithFileName(NS_OS_TEMP_DIR, &quot;tempMessage.eml&quot;,</span>
<a href="#l159.15"></a><span id="l159.15">                                   getter_AddRefs(m_tempMsgFile));</span>
<a href="#l159.16"></a><span id="l159.16"> </span>
<a href="#l159.17"></a><span id="l159.17">   mSuppressListenerNotifications = PR_FALSE;</span>
<a href="#l159.18"></a><span id="l159.18">   InitFromURI(aURL);</span>
<a href="#l159.19"></a><span id="l159.19"> }</span>
<a href="#l159.20"></a><span id="l159.20"> </span>
<a href="#l159.21"></a><span id="l159.21" class="difflineat">@@ -634,17 +635,23 @@ NS_IMETHODIMP nsMsgProtocol::GetContentC</span>
<a href="#l159.22"></a><span id="l159.22"> NS_IMETHODIMP nsMsgProtocol::SetContentCharset(const nsACString &amp;aContentCharset)</span>
<a href="#l159.23"></a><span id="l159.23"> {</span>
<a href="#l159.24"></a><span id="l159.24">   NS_WARNING(&quot;nsMsgProtocol::SetContentCharset() not implemented&quot;);</span>
<a href="#l159.25"></a><span id="l159.25">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l159.26"></a><span id="l159.26"> }</span>
<a href="#l159.27"></a><span id="l159.27"> </span>
<a href="#l159.28"></a><span id="l159.28"> NS_IMETHODIMP nsMsgProtocol::GetContentLength(PRInt32 * aContentLength)</span>
<a href="#l159.29"></a><span id="l159.29"> {</span>
<a href="#l159.30"></a><span id="l159.30" class="difflineminus">-  *aContentLength = -1;</span>
<a href="#l159.31"></a><span id="l159.31" class="difflineplus">+  *aContentLength = mContentLength;</span>
<a href="#l159.32"></a><span id="l159.32" class="difflineplus">+  return NS_OK;</span>
<a href="#l159.33"></a><span id="l159.33" class="difflineplus">+}</span>
<a href="#l159.34"></a><span id="l159.34" class="difflineplus">+</span>
<a href="#l159.35"></a><span id="l159.35" class="difflineplus">+NS_IMETHODIMP nsMsgProtocol::SetContentLength(PRInt32 aContentLength)</span>
<a href="#l159.36"></a><span id="l159.36" class="difflineplus">+{</span>
<a href="#l159.37"></a><span id="l159.37" class="difflineplus">+  mContentLength = aContentLength;</span>
<a href="#l159.38"></a><span id="l159.38">   return NS_OK;</span>
<a href="#l159.39"></a><span id="l159.39"> }</span>
<a href="#l159.40"></a><span id="l159.40"> </span>
<a href="#l159.41"></a><span id="l159.41"> NS_IMETHODIMP nsMsgProtocol::GetSecurityInfo(nsISupports * *aSecurityInfo)</span>
<a href="#l159.42"></a><span id="l159.42"> {</span>
<a href="#l159.43"></a><span id="l159.43">   *aSecurityInfo = nsnull;</span>
<a href="#l159.44"></a><span id="l159.44">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l159.45"></a><span id="l159.45"> }</span>
<a href="#l159.46"></a><span id="l159.46" class="difflineat">@@ -652,23 +659,16 @@ NS_IMETHODIMP nsMsgProtocol::GetSecurity</span>
<a href="#l159.47"></a><span id="l159.47"> NS_IMETHODIMP nsMsgProtocol::GetName(nsACString &amp;result)</span>
<a href="#l159.48"></a><span id="l159.48"> {</span>
<a href="#l159.49"></a><span id="l159.49">   if (m_url)</span>
<a href="#l159.50"></a><span id="l159.50">     return m_url-&gt;GetSpec(result);</span>
<a href="#l159.51"></a><span id="l159.51">   result.Truncate();</span>
<a href="#l159.52"></a><span id="l159.52">   return NS_OK;</span>
<a href="#l159.53"></a><span id="l159.53"> }</span>
<a href="#l159.54"></a><span id="l159.54"> </span>
<a href="#l159.55"></a><span id="l159.55" class="difflineminus">-</span>
<a href="#l159.56"></a><span id="l159.56" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l159.57"></a><span id="l159.57" class="difflineminus">-nsMsgProtocol::SetContentLength(PRInt32 aContentLength)</span>
<a href="#l159.58"></a><span id="l159.58" class="difflineminus">-{</span>
<a href="#l159.59"></a><span id="l159.59" class="difflineminus">-  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l159.60"></a><span id="l159.60" class="difflineminus">-}</span>
<a href="#l159.61"></a><span id="l159.61" class="difflineminus">-</span>
<a href="#l159.62"></a><span id="l159.62"> NS_IMETHODIMP nsMsgProtocol::GetOwner(nsISupports * *aPrincipal)</span>
<a href="#l159.63"></a><span id="l159.63"> {</span>
<a href="#l159.64"></a><span id="l159.64">   *aPrincipal = mOwner;</span>
<a href="#l159.65"></a><span id="l159.65">   NS_IF_ADDREF(*aPrincipal);</span>
<a href="#l159.66"></a><span id="l159.66">   return NS_OK;</span>
<a href="#l159.67"></a><span id="l159.67"> }</span>
<a href="#l159.68"></a><span id="l159.68"> </span>
<a href="#l159.69"></a><span id="l159.69"> NS_IMETHODIMP nsMsgProtocol::SetOwner(nsISupports * aPrincipal)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l160.1"></a><span id="l160.1" class="difflineminus">--- a/mailnews/base/util/nsMsgProtocol.h</span>
<a href="#l160.2"></a><span id="l160.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgProtocol.h</span>
<a href="#l160.3"></a><span id="l160.3" class="difflineat">@@ -176,16 +176,17 @@ protected:</span>
<a href="#l160.4"></a><span id="l160.4">   nsCOMPtr&lt;nsIStreamListener&gt; m_channelListener;</span>
<a href="#l160.5"></a><span id="l160.5">   nsCOMPtr&lt;nsISupports&gt;        m_channelContext;</span>
<a href="#l160.6"></a><span id="l160.6">   nsCOMPtr&lt;nsILoadGroup&gt;      m_loadGroup;</span>
<a href="#l160.7"></a><span id="l160.7">   nsLoadFlags                 mLoadFlags;</span>
<a href="#l160.8"></a><span id="l160.8">   nsCOMPtr&lt;nsIProgressEventSink&gt; mProgressEventSink;</span>
<a href="#l160.9"></a><span id="l160.9">   nsCOMPtr&lt;nsIInterfaceRequestor&gt; mCallbacks;</span>
<a href="#l160.10"></a><span id="l160.10">   nsCOMPtr&lt;nsISupports&gt;       mOwner;</span>
<a href="#l160.11"></a><span id="l160.11">   nsCString                   m_ContentType;</span>
<a href="#l160.12"></a><span id="l160.12" class="difflineplus">+  PRInt32                     mContentLength;</span>
<a href="#l160.13"></a><span id="l160.13"> </span>
<a href="#l160.14"></a><span id="l160.14">   nsCString m_lastPasswordSent; // used to prefill the password prompt</span>
<a href="#l160.15"></a><span id="l160.15"> </span>
<a href="#l160.16"></a><span id="l160.16">   // private helper routine used by subclasses to quickly get a reference to the correct prompt dialog</span>
<a href="#l160.17"></a><span id="l160.17">   // for a mailnews url. </span>
<a href="#l160.18"></a><span id="l160.18">   nsresult GetPromptDialogFromUrl(nsIMsgMailNewsUrl * aMsgUrl, nsIPrompt ** aPromptDialog);</span>
<a href="#l160.19"></a><span id="l160.19"> </span>
<a href="#l160.20"></a><span id="l160.20">   // if a url isn't going to result in any content then we want to suppress calls to</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l161.1"></a><span id="l161.1" class="difflineminus">--- a/mailnews/base/util/nsMsgUtils.cpp</span>
<a href="#l161.2"></a><span id="l161.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgUtils.cpp</span>
<a href="#l161.3"></a><span id="l161.3" class="difflineat">@@ -77,16 +77,17 @@</span>
<a href="#l161.4"></a><span id="l161.4"> #include &quot;nsIMsgAccountManager.h&quot;</span>
<a href="#l161.5"></a><span id="l161.5"> #include &quot;nsIOutputStream.h&quot;</span>
<a href="#l161.6"></a><span id="l161.6"> #include &quot;nsMsgFileStream.h&quot;</span>
<a href="#l161.7"></a><span id="l161.7"> #include &quot;nsIFileURL.h&quot;</span>
<a href="#l161.8"></a><span id="l161.8"> #include &quot;nsNetUtil.h&quot;</span>
<a href="#l161.9"></a><span id="l161.9"> #include &quot;nsIMsgDatabase.h&quot;</span>
<a href="#l161.10"></a><span id="l161.10"> #include &quot;nsIMutableArray.h&quot;</span>
<a href="#l161.11"></a><span id="l161.11"> #include &quot;nsIMsgMailNewsUrl.h&quot;</span>
<a href="#l161.12"></a><span id="l161.12" class="difflineplus">+#include &quot;nsArrayUtils.h&quot;</span>
<a href="#l161.13"></a><span id="l161.13"> </span>
<a href="#l161.14"></a><span id="l161.14"> static NS_DEFINE_CID(kImapUrlCID, NS_IMAPURL_CID);</span>
<a href="#l161.15"></a><span id="l161.15"> static NS_DEFINE_CID(kCMailboxUrl, NS_MAILBOXURL_CID);</span>
<a href="#l161.16"></a><span id="l161.16"> static NS_DEFINE_CID(kCNntpUrlCID, NS_NNTPURL_CID);</span>
<a href="#l161.17"></a><span id="l161.17"> </span>
<a href="#l161.18"></a><span id="l161.18"> #define ILLEGAL_FOLDER_CHARS &quot;;#&quot;</span>
<a href="#l161.19"></a><span id="l161.19"> #define ILLEGAL_FOLDER_CHARS_AS_FIRST_LETTER &quot;.&quot;</span>
<a href="#l161.20"></a><span id="l161.20"> #define ILLEGAL_FOLDER_CHARS_AS_LAST_LETTER  &quot;.~ &quot;</span>
<a href="#l161.21"></a><span id="l161.21" class="difflineat">@@ -1399,76 +1400,48 @@ PRBool MsgHostDomainIsTrusted(nsCString </span>
<a href="#l161.22"></a><span id="l161.22"> </span>
<a href="#l161.23"></a><span id="l161.23">     domain = end + 1;</span>
<a href="#l161.24"></a><span id="l161.24">   } while (*end);</span>
<a href="#l161.25"></a><span id="l161.25">   return domainIsTrusted;</span>
<a href="#l161.26"></a><span id="l161.26"> }</span>
<a href="#l161.27"></a><span id="l161.27"> </span>
<a href="#l161.28"></a><span id="l161.28"> nsresult FolderUriFromDirInProfile(nsILocalFile *aLocalPath, nsACString &amp;mailboxUri)</span>
<a href="#l161.29"></a><span id="l161.29"> {</span>
<a href="#l161.30"></a><span id="l161.30" class="difflineminus">-</span>
<a href="#l161.31"></a><span id="l161.31">   nsresult rv;</span>
<a href="#l161.32"></a><span id="l161.32"> </span>
<a href="#l161.33"></a><span id="l161.33">   nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l161.34"></a><span id="l161.34">     do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l161.35"></a><span id="l161.35" class="difflineminus">-</span>
<a href="#l161.36"></a><span id="l161.36">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l161.37"></a><span id="l161.37" class="difflineminus">-  nsCOMPtr&lt;nsISupportsArray&gt; serverArray;</span>
<a href="#l161.38"></a><span id="l161.38" class="difflineminus">-  accountManager-&gt;GetAllServers(getter_AddRefs(serverArray));</span>
<a href="#l161.39"></a><span id="l161.39" class="difflineminus">-</span>
<a href="#l161.40"></a><span id="l161.40" class="difflineminus">-  PRUint32 cnt;</span>
<a href="#l161.41"></a><span id="l161.41" class="difflineminus">-  rv = serverArray-&gt;Count(&amp;cnt);</span>
<a href="#l161.42"></a><span id="l161.42" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l161.43"></a><span id="l161.43" class="difflineminus">-  PRInt32 count = cnt;</span>
<a href="#l161.44"></a><span id="l161.44" class="difflineminus">-  PRInt32 i;</span>
<a href="#l161.45"></a><span id="l161.45"> </span>
<a href="#l161.46"></a><span id="l161.46" class="difflineminus">-  for (i = 0; i &lt; count; i++)</span>
<a href="#l161.47"></a><span id="l161.47" class="difflineminus">-  {</span>
<a href="#l161.48"></a><span id="l161.48" class="difflineminus">-    nsCOMPtr&lt;nsIMsgIncomingServer&gt; server = do_QueryElementAt(serverArray, i);</span>
<a href="#l161.49"></a><span id="l161.49" class="difflineminus">-    if (!server) continue;</span>
<a href="#l161.50"></a><span id="l161.50" class="difflineplus">+  nsCOMPtr&lt;nsIArray&gt; folderArray;</span>
<a href="#l161.51"></a><span id="l161.51" class="difflineplus">+  rv = accountManager-&gt;GetAllFolders(getter_AddRefs(folderArray));</span>
<a href="#l161.52"></a><span id="l161.52" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l161.53"></a><span id="l161.53"> </span>
<a href="#l161.54"></a><span id="l161.54" class="difflineminus">-    // get the base directory</span>
<a href="#l161.55"></a><span id="l161.55" class="difflineminus">-    nsCOMPtr&lt;nsILocalFile&gt; serverPath;</span>
<a href="#l161.56"></a><span id="l161.56" class="difflineminus">-    rv = server-&gt;GetLocalPath(getter_AddRefs(serverPath));</span>
<a href="#l161.57"></a><span id="l161.57" class="difflineminus">-    if (NS_FAILED(rv)) continue;</span>
<a href="#l161.58"></a><span id="l161.58" class="difflineminus">-</span>
<a href="#l161.59"></a><span id="l161.59" class="difflineminus">-    // compare, getting the relative descriptor</span>
<a href="#l161.60"></a><span id="l161.60" class="difflineminus">-    nsCAutoString pathStr;</span>
<a href="#l161.61"></a><span id="l161.61" class="difflineminus">-    aLocalPath-&gt;GetRelativeDescriptor(serverPath, pathStr);</span>
<a href="#l161.62"></a><span id="l161.62" class="difflineplus">+  PRUint32 count;</span>
<a href="#l161.63"></a><span id="l161.63" class="difflineplus">+  rv = folderArray-&gt;GetLength(&amp;count);</span>
<a href="#l161.64"></a><span id="l161.64" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l161.65"></a><span id="l161.65"> </span>
<a href="#l161.66"></a><span id="l161.66" class="difflineminus">-    // if the argument directory is inside the main server directory</span>
<a href="#l161.67"></a><span id="l161.67" class="difflineminus">-    if (!StringBeginsWith(pathStr, NS_LITERAL_CSTRING(&quot;../&quot;)))</span>
<a href="#l161.68"></a><span id="l161.68" class="difflineminus">-    {</span>
<a href="#l161.69"></a><span id="l161.69" class="difflineminus">-      nsCString serverURI;</span>
<a href="#l161.70"></a><span id="l161.70" class="difflineminus">-      rv = server-&gt;GetServerURI(serverURI);</span>
<a href="#l161.71"></a><span id="l161.71" class="difflineminus">-      if (NS_FAILED(rv)) continue;</span>
<a href="#l161.72"></a><span id="l161.72" class="difflineplus">+  for (PRUint32 i = 0; i &lt; count; i++)</span>
<a href="#l161.73"></a><span id="l161.73" class="difflineplus">+  {</span>
<a href="#l161.74"></a><span id="l161.74" class="difflineplus">+    nsCOMPtr&lt;nsIMsgFolder&gt; folder(do_QueryElementAt(folderArray, i, &amp;rv));</span>
<a href="#l161.75"></a><span id="l161.75" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l161.76"></a><span id="l161.76"> </span>
<a href="#l161.77"></a><span id="l161.77" class="difflineminus">-      PRInt32 sbdIndex;</span>
<a href="#l161.78"></a><span id="l161.78" class="difflineminus">-      while((sbdIndex = pathStr.Find(&quot;.sbd&quot;, PR_TRUE)) != -1)</span>
<a href="#l161.79"></a><span id="l161.79" class="difflineminus">-        pathStr.Cut(sbdIndex, 4);</span>
<a href="#l161.80"></a><span id="l161.80" class="difflineminus">-</span>
<a href="#l161.81"></a><span id="l161.81" class="difflineminus">-      mailboxUri = serverURI;</span>
<a href="#l161.82"></a><span id="l161.82" class="difflineminus">-      mailboxUri.Append('/');</span>
<a href="#l161.83"></a><span id="l161.83" class="difflineplus">+    nsCOMPtr&lt;nsILocalFile&gt; folderPath;</span>
<a href="#l161.84"></a><span id="l161.84" class="difflineplus">+    rv = folder-&gt;GetFilePath(getter_AddRefs(folderPath));</span>
<a href="#l161.85"></a><span id="l161.85" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l161.86"></a><span id="l161.86"> </span>
<a href="#l161.87"></a><span id="l161.87" class="difflineminus">-      // If it's a local folder, escape the folder name</span>
<a href="#l161.88"></a><span id="l161.88" class="difflineminus">-      nsCAutoString localStoreType;</span>
<a href="#l161.89"></a><span id="l161.89" class="difflineminus">-      server-&gt;GetLocalStoreType(localStoreType);</span>
<a href="#l161.90"></a><span id="l161.90" class="difflineminus">-      if (localStoreType.Equals(NS_LITERAL_CSTRING(&quot;mailbox&quot;)))</span>
<a href="#l161.91"></a><span id="l161.91" class="difflineminus">-      {</span>
<a href="#l161.92"></a><span id="l161.92" class="difflineminus">-        nsCAutoString escapedPathStr;</span>
<a href="#l161.93"></a><span id="l161.93" class="difflineminus">-        MsgEscapeURL(pathStr, nsINetUtil::ESCAPE_URL_MINIMAL, escapedPathStr);</span>
<a href="#l161.94"></a><span id="l161.94" class="difflineminus">-        mailboxUri.Append(escapedPathStr);</span>
<a href="#l161.95"></a><span id="l161.95" class="difflineminus">-      }</span>
<a href="#l161.96"></a><span id="l161.96" class="difflineminus">-      else</span>
<a href="#l161.97"></a><span id="l161.97" class="difflineminus">-        mailboxUri.Append(pathStr);</span>
<a href="#l161.98"></a><span id="l161.98" class="difflineplus">+    // Check if we're equal</span>
<a href="#l161.99"></a><span id="l161.99" class="difflineplus">+    PRBool isEqual;</span>
<a href="#l161.100"></a><span id="l161.100" class="difflineplus">+    rv = folderPath-&gt;Equals(aLocalPath, &amp;isEqual);</span>
<a href="#l161.101"></a><span id="l161.101" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l161.102"></a><span id="l161.102"> </span>
<a href="#l161.103"></a><span id="l161.103" class="difflineminus">-      break;</span>
<a href="#l161.104"></a><span id="l161.104" class="difflineminus">-    }</span>
<a href="#l161.105"></a><span id="l161.105" class="difflineplus">+    if (isEqual)</span>
<a href="#l161.106"></a><span id="l161.106" class="difflineplus">+      return folder-&gt;GetURI(mailboxUri);</span>
<a href="#l161.107"></a><span id="l161.107">   }</span>
<a href="#l161.108"></a><span id="l161.108" class="difflineminus">-  return mailboxUri.IsEmpty() ? NS_ERROR_FAILURE : NS_OK;</span>
<a href="#l161.109"></a><span id="l161.109" class="difflineplus">+  return NS_ERROR_FAILURE;</span>
<a href="#l161.110"></a><span id="l161.110"> }</span>
<a href="#l161.111"></a><span id="l161.111"> </span>
<a href="#l161.112"></a><span id="l161.112"> nsresult MsgGetLocalFileFromURI(const nsACString &amp;aUTF8Path, nsILocalFile **aFile)</span>
<a href="#l161.113"></a><span id="l161.113"> {</span>
<a href="#l161.114"></a><span id="l161.114">   nsresult rv;</span>
<a href="#l161.115"></a><span id="l161.115">   nsCOMPtr&lt;nsIURI&gt; argURI;</span>
<a href="#l161.116"></a><span id="l161.116">   rv = NS_NewURI(getter_AddRefs(argURI), aUTF8Path);</span>
<a href="#l161.117"></a><span id="l161.117">   NS_ENSURE_SUCCESS(rv, rv);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l162.1"></a><span id="l162.1">new file mode 100644</span>
<a href="#l162.2"></a><span id="l162.2" class="difflineminus">--- /dev/null</span>
<a href="#l162.3"></a><span id="l162.3" class="difflineplus">+++ b/mailnews/base/util/traceHelper.js</span>
<a href="#l162.4"></a><span id="l162.4" class="difflineat">@@ -0,0 +1,146 @@</span>
<a href="#l162.5"></a><span id="l162.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l162.6"></a><span id="l162.6" class="difflineplus">+ *   Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l162.7"></a><span id="l162.7" class="difflineplus">+ *</span>
<a href="#l162.8"></a><span id="l162.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l162.9"></a><span id="l162.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l162.10"></a><span id="l162.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l162.11"></a><span id="l162.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l162.12"></a><span id="l162.12" class="difflineplus">+ *</span>
<a href="#l162.13"></a><span id="l162.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l162.14"></a><span id="l162.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l162.15"></a><span id="l162.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l162.16"></a><span id="l162.16" class="difflineplus">+ * License.</span>
<a href="#l162.17"></a><span id="l162.17" class="difflineplus">+ *</span>
<a href="#l162.18"></a><span id="l162.18" class="difflineplus">+ * The Original Code is Thunderbird Mail Client.</span>
<a href="#l162.19"></a><span id="l162.19" class="difflineplus">+ *</span>
<a href="#l162.20"></a><span id="l162.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l162.21"></a><span id="l162.21" class="difflineplus">+ * Mozilla Messaging, Inc.</span>
<a href="#l162.22"></a><span id="l162.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l162.23"></a><span id="l162.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l162.24"></a><span id="l162.24" class="difflineplus">+ *</span>
<a href="#l162.25"></a><span id="l162.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l162.26"></a><span id="l162.26" class="difflineplus">+ *   Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a href="#l162.27"></a><span id="l162.27" class="difflineplus">+ *</span>
<a href="#l162.28"></a><span id="l162.28" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l162.29"></a><span id="l162.29" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l162.30"></a><span id="l162.30" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l162.31"></a><span id="l162.31" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l162.32"></a><span id="l162.32" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l162.33"></a><span id="l162.33" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l162.34"></a><span id="l162.34" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l162.35"></a><span id="l162.35" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l162.36"></a><span id="l162.36" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l162.37"></a><span id="l162.37" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l162.38"></a><span id="l162.38" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l162.39"></a><span id="l162.39" class="difflineplus">+ *</span>
<a href="#l162.40"></a><span id="l162.40" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l162.41"></a><span id="l162.41" class="difflineplus">+</span>
<a href="#l162.42"></a><span id="l162.42" class="difflineplus">+EXPORTED_SYMBOLS = ['DebugTraceHelper'];</span>
<a href="#l162.43"></a><span id="l162.43" class="difflineplus">+</span>
<a href="#l162.44"></a><span id="l162.44" class="difflineplus">+const Cc = Components.classes;</span>
<a href="#l162.45"></a><span id="l162.45" class="difflineplus">+const Ci = Components.interfaces;</span>
<a href="#l162.46"></a><span id="l162.46" class="difflineplus">+const Cr = Components.results;</span>
<a href="#l162.47"></a><span id="l162.47" class="difflineplus">+const Cu = Components.utils;</span>
<a href="#l162.48"></a><span id="l162.48" class="difflineplus">+</span>
<a href="#l162.49"></a><span id="l162.49" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l162.50"></a><span id="l162.50" class="difflineplus">+</span>
<a href="#l162.51"></a><span id="l162.51" class="difflineplus">+var SPACES = &quot;                                                   &quot;;</span>
<a href="#l162.52"></a><span id="l162.52" class="difflineplus">+var BRIGHT_COLORS = {</span>
<a href="#l162.53"></a><span id="l162.53" class="difflineplus">+  red: &quot;\x1b[1;31m&quot;,</span>
<a href="#l162.54"></a><span id="l162.54" class="difflineplus">+  green: &quot;\x1b[1;32m&quot;,</span>
<a href="#l162.55"></a><span id="l162.55" class="difflineplus">+  yellow: &quot;\x1b[1;33m&quot;,</span>
<a href="#l162.56"></a><span id="l162.56" class="difflineplus">+  blue: &quot;\x1b[1;34m&quot;,</span>
<a href="#l162.57"></a><span id="l162.57" class="difflineplus">+  magenta: &quot;\x1b[1;35m&quot;,</span>
<a href="#l162.58"></a><span id="l162.58" class="difflineplus">+  cyan: &quot;\x1b[1;36m&quot;,</span>
<a href="#l162.59"></a><span id="l162.59" class="difflineplus">+  white: &quot;\x1b[1;37m&quot;,</span>
<a href="#l162.60"></a><span id="l162.60" class="difflineplus">+};</span>
<a href="#l162.61"></a><span id="l162.61" class="difflineplus">+var DARK_COLORS = {</span>
<a href="#l162.62"></a><span id="l162.62" class="difflineplus">+  red: &quot;\x1b[0;31m&quot;,</span>
<a href="#l162.63"></a><span id="l162.63" class="difflineplus">+  green: &quot;\x1b[0;32m&quot;,</span>
<a href="#l162.64"></a><span id="l162.64" class="difflineplus">+  yellow: &quot;\x1b[0;33m&quot;,</span>
<a href="#l162.65"></a><span id="l162.65" class="difflineplus">+  blue: &quot;\x1b[0;34m&quot;,</span>
<a href="#l162.66"></a><span id="l162.66" class="difflineplus">+  magenta: &quot;\x1b[0;35m&quot;,</span>
<a href="#l162.67"></a><span id="l162.67" class="difflineplus">+  cyan: &quot;\x1b[0;36m&quot;,</span>
<a href="#l162.68"></a><span id="l162.68" class="difflineplus">+  white: &quot;\x1b[0;37m&quot;,</span>
<a href="#l162.69"></a><span id="l162.69" class="difflineplus">+};</span>
<a href="#l162.70"></a><span id="l162.70" class="difflineplus">+var STOP_COLORS = &quot;\x1b[0m&quot;;</span>
<a href="#l162.71"></a><span id="l162.71" class="difflineplus">+</span>
<a href="#l162.72"></a><span id="l162.72" class="difflineplus">+</span>
<a href="#l162.73"></a><span id="l162.73" class="difflineplus">+/**</span>
<a href="#l162.74"></a><span id="l162.74" class="difflineplus">+ * Example usages:</span>
<a href="#l162.75"></a><span id="l162.75" class="difflineplus">+ *</span>
<a href="#l162.76"></a><span id="l162.76" class="difflineplus">+ * Components.utils.import(&quot;resource://app/modules/traceHelper.js&quot;);</span>
<a href="#l162.77"></a><span id="l162.77" class="difflineplus">+ * var debugContext = {color: &quot;cyan&quot;};</span>
<a href="#l162.78"></a><span id="l162.78" class="difflineplus">+ * DebugTraceHelper.tracify(FolderDisplayWidget.prototype,</span>
<a href="#l162.79"></a><span id="l162.79" class="difflineplus">+ *                          &quot;FolderDisplayWidget&quot;, /.+/, debugContext);</span>
<a href="#l162.80"></a><span id="l162.80" class="difflineplus">+ * DebugTraceHelper.tracify(MessageDisplayWidget.prototype,</span>
<a href="#l162.81"></a><span id="l162.81" class="difflineplus">+ *                          &quot;MessageDisplayWidget&quot;, /.+/, debugContext);</span>
<a href="#l162.82"></a><span id="l162.82" class="difflineplus">+ * DebugTraceHelper.tracify(StandaloneFolderDisplayWidget.prototype,</span>
<a href="#l162.83"></a><span id="l162.83" class="difflineplus">+ *                          &quot;StandaloneFolderDisplayWidget&quot;, /.+/, debugContext);</span>
<a href="#l162.84"></a><span id="l162.84" class="difflineplus">+ * DebugTraceHelper.tracify(StandaloneMessageDisplayWidget.prototype,</span>
<a href="#l162.85"></a><span id="l162.85" class="difflineplus">+ *                          &quot;StandaloneMessageDisplayWidget&quot;, /.+/, debugContext);</span>
<a href="#l162.86"></a><span id="l162.86" class="difflineplus">+ * DebugTraceHelper.tracify(DBViewWrapper.prototype,</span>
<a href="#l162.87"></a><span id="l162.87" class="difflineplus">+ *                          &quot;DBViewWrapper&quot;, /.+/, {color: &quot;green&quot;});</span>
<a href="#l162.88"></a><span id="l162.88" class="difflineplus">+ * DebugTraceHelper.tracify(JSTreeSelection.prototype,</span>
<a href="#l162.89"></a><span id="l162.89" class="difflineplus">+ *                          &quot;JSTreeSelection&quot;, /.+/, {color: &quot;yellow&quot;});</span>
<a href="#l162.90"></a><span id="l162.90" class="difflineplus">+ */</span>
<a href="#l162.91"></a><span id="l162.91" class="difflineplus">+var DebugTraceHelper = {</span>
<a href="#l162.92"></a><span id="l162.92" class="difflineplus">+  tracify: function(aObj, aDesc, aPat, aContext, aSettings) {</span>
<a href="#l162.93"></a><span id="l162.93" class="difflineplus">+    aContext.depth = 0;</span>
<a href="#l162.94"></a><span id="l162.94" class="difflineplus">+    let color = aSettings.color || &quot;cyan&quot;;</span>
<a href="#l162.95"></a><span id="l162.95" class="difflineplus">+    aSettings.introCode = BRIGHT_COLORS[color];</span>
<a href="#l162.96"></a><span id="l162.96" class="difflineplus">+    aSettings.outroCode = DARK_COLORS[color];</span>
<a href="#l162.97"></a><span id="l162.97" class="difflineplus">+    for each (let key in Iterator(aObj, true)) {</span>
<a href="#l162.98"></a><span id="l162.98" class="difflineplus">+      if (aPat.test(key)) {</span>
<a href="#l162.99"></a><span id="l162.99" class="difflineplus">+        // ignore properties!</span>
<a href="#l162.100"></a><span id="l162.100" class="difflineplus">+        if (aObj.__lookupGetter__(key) || aObj.__lookupSetter__(key))</span>
<a href="#l162.101"></a><span id="l162.101" class="difflineplus">+          continue;</span>
<a href="#l162.102"></a><span id="l162.102" class="difflineplus">+        // ignore non-functions!</span>
<a href="#l162.103"></a><span id="l162.103" class="difflineplus">+        if (typeof(aObj[key]) != &quot;function&quot;)</span>
<a href="#l162.104"></a><span id="l162.104" class="difflineplus">+          continue;</span>
<a href="#l162.105"></a><span id="l162.105" class="difflineplus">+        let name = key;</span>
<a href="#l162.106"></a><span id="l162.106" class="difflineplus">+        let prev = aObj[name];</span>
<a href="#l162.107"></a><span id="l162.107" class="difflineplus">+        aObj[name] = function() {</span>
<a href="#l162.108"></a><span id="l162.108" class="difflineplus">+          let argstr = &quot;&quot;;</span>
<a href="#l162.109"></a><span id="l162.109" class="difflineplus">+          for (let i = 0; i &lt; arguments.length; i++) {</span>
<a href="#l162.110"></a><span id="l162.110" class="difflineplus">+            let arg = arguments[i];</span>
<a href="#l162.111"></a><span id="l162.111" class="difflineplus">+            if (arg == null)</span>
<a href="#l162.112"></a><span id="l162.112" class="difflineplus">+              argstr += &quot; null&quot;;</span>
<a href="#l162.113"></a><span id="l162.113" class="difflineplus">+            else if (typeof(arg) == &quot;function&quot;)</span>
<a href="#l162.114"></a><span id="l162.114" class="difflineplus">+              argstr += &quot; function &quot;+ arg.name;</span>
<a href="#l162.115"></a><span id="l162.115" class="difflineplus">+            else</span>
<a href="#l162.116"></a><span id="l162.116" class="difflineplus">+              argstr += &quot; &quot; + arguments[i].toString();</span>
<a href="#l162.117"></a><span id="l162.117" class="difflineplus">+          }</span>
<a href="#l162.118"></a><span id="l162.118" class="difflineplus">+</span>
<a href="#l162.119"></a><span id="l162.119" class="difflineplus">+          let indent = SPACES.substr(0, aContext.depth++ * 2);</span>
<a href="#l162.120"></a><span id="l162.120" class="difflineplus">+          dump(indent + &quot;--&gt; &quot; + aSettings.introCode + aDesc + &quot;::&quot; + name +</span>
<a href="#l162.121"></a><span id="l162.121" class="difflineplus">+               &quot;:&quot; + argstr +</span>
<a href="#l162.122"></a><span id="l162.122" class="difflineplus">+               STOP_COLORS + &quot;\n&quot;);</span>
<a href="#l162.123"></a><span id="l162.123" class="difflineplus">+          let ret;</span>
<a href="#l162.124"></a><span id="l162.124" class="difflineplus">+          try {</span>
<a href="#l162.125"></a><span id="l162.125" class="difflineplus">+            ret = prev.apply(this, arguments);</span>
<a href="#l162.126"></a><span id="l162.126" class="difflineplus">+          }</span>
<a href="#l162.127"></a><span id="l162.127" class="difflineplus">+          catch (ex) {</span>
<a href="#l162.128"></a><span id="l162.128" class="difflineplus">+            if (ex.stack) {</span>
<a href="#l162.129"></a><span id="l162.129" class="difflineplus">+              dump(BRIGHT_COLORS.red + &quot;Exception: &quot; + ex + &quot;\n  &quot; +</span>
<a href="#l162.130"></a><span id="l162.130" class="difflineplus">+                   ex.stack.replace(&quot;\n&quot;, &quot;\n  &quot;) + STOP_COLORS + &quot;\n&quot;);</span>
<a href="#l162.131"></a><span id="l162.131" class="difflineplus">+            }</span>
<a href="#l162.132"></a><span id="l162.132" class="difflineplus">+            else {</span>
<a href="#l162.133"></a><span id="l162.133" class="difflineplus">+              dump(BRIGHT_COLORS.red + &quot;Exception: &quot; + ex.fileName + &quot;:&quot; +</span>
<a href="#l162.134"></a><span id="l162.134" class="difflineplus">+                   ex.lineNumber + &quot;: &quot; + ex + STOP_COLORS + &quot;\n&quot;);</span>
<a href="#l162.135"></a><span id="l162.135" class="difflineplus">+            }</span>
<a href="#l162.136"></a><span id="l162.136" class="difflineplus">+            aContext.depth--;</span>
<a href="#l162.137"></a><span id="l162.137" class="difflineplus">+            dump(indent + &quot;&lt;-- &quot; + aSettings.outroCode + aDesc + &quot;::&quot; + name +</span>
<a href="#l162.138"></a><span id="l162.138" class="difflineplus">+                 STOP_COLORS + &quot;\n&quot;);</span>
<a href="#l162.139"></a><span id="l162.139" class="difflineplus">+            throw ex;</span>
<a href="#l162.140"></a><span id="l162.140" class="difflineplus">+          }</span>
<a href="#l162.141"></a><span id="l162.141" class="difflineplus">+          aContext.depth--;</span>
<a href="#l162.142"></a><span id="l162.142" class="difflineplus">+          dump(indent + &quot;&lt;-- &quot; + aSettings.outroCode + aDesc + &quot;::&quot; + name +</span>
<a href="#l162.143"></a><span id="l162.143" class="difflineplus">+               &quot;: &quot; + (ret != null ? ret.toString() : &quot;null&quot;) +</span>
<a href="#l162.144"></a><span id="l162.144" class="difflineplus">+               STOP_COLORS + &quot;\n&quot;);</span>
<a href="#l162.145"></a><span id="l162.145" class="difflineplus">+          return ret;</span>
<a href="#l162.146"></a><span id="l162.146" class="difflineplus">+        };</span>
<a href="#l162.147"></a><span id="l162.147" class="difflineplus">+      }</span>
<a href="#l162.148"></a><span id="l162.148" class="difflineplus">+    }</span>
<a href="#l162.149"></a><span id="l162.149" class="difflineplus">+  }</span>
<a href="#l162.150"></a><span id="l162.150" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l163.1"></a><span id="l163.1">deleted file mode 100644</span>
<a href="#l163.2"></a><span id="l163.2" class="difflineminus">--- a/mailnews/compose/public/nsIMsgComposeProgress.idl</span>
<a href="#l163.3"></a><span id="l163.3" class="difflineplus">+++ /dev/null</span>
<a href="#l163.4"></a><span id="l163.4" class="difflineat">@@ -1,69 +0,0 @@</span>
<a href="#l163.5"></a><span id="l163.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l163.6"></a><span id="l163.6" class="difflineminus">-/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l163.7"></a><span id="l163.7" class="difflineminus">- * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l163.8"></a><span id="l163.8" class="difflineminus">- *</span>
<a href="#l163.9"></a><span id="l163.9" class="difflineminus">- * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l163.10"></a><span id="l163.10" class="difflineminus">- * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l163.11"></a><span id="l163.11" class="difflineminus">- * the License. You may obtain a copy of the License at</span>
<a href="#l163.12"></a><span id="l163.12" class="difflineminus">- * http://www.mozilla.org/MPL/</span>
<a href="#l163.13"></a><span id="l163.13" class="difflineminus">- *</span>
<a href="#l163.14"></a><span id="l163.14" class="difflineminus">- * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l163.15"></a><span id="l163.15" class="difflineminus">- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l163.16"></a><span id="l163.16" class="difflineminus">- * for the specific language governing rights and limitations under the</span>
<a href="#l163.17"></a><span id="l163.17" class="difflineminus">- * License.</span>
<a href="#l163.18"></a><span id="l163.18" class="difflineminus">- *</span>
<a href="#l163.19"></a><span id="l163.19" class="difflineminus">- * The Original Code is mozilla.org code.</span>
<a href="#l163.20"></a><span id="l163.20" class="difflineminus">- *</span>
<a href="#l163.21"></a><span id="l163.21" class="difflineminus">- * The Initial Developer of the Original Code is</span>
<a href="#l163.22"></a><span id="l163.22" class="difflineminus">- * Netscape Communications Corporation.</span>
<a href="#l163.23"></a><span id="l163.23" class="difflineminus">- * Portions created by the Initial Developer are Copyright (C) 1998</span>
<a href="#l163.24"></a><span id="l163.24" class="difflineminus">- * the Initial Developer. All Rights Reserved.</span>
<a href="#l163.25"></a><span id="l163.25" class="difflineminus">- *</span>
<a href="#l163.26"></a><span id="l163.26" class="difflineminus">- * Contributor(s):</span>
<a href="#l163.27"></a><span id="l163.27" class="difflineminus">- *</span>
<a href="#l163.28"></a><span id="l163.28" class="difflineminus">- * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l163.29"></a><span id="l163.29" class="difflineminus">- * either of the GNU General Public License Version 2 or later (the &quot;GPL&quot;),</span>
<a href="#l163.30"></a><span id="l163.30" class="difflineminus">- * or the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l163.31"></a><span id="l163.31" class="difflineminus">- * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l163.32"></a><span id="l163.32" class="difflineminus">- * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l163.33"></a><span id="l163.33" class="difflineminus">- * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l163.34"></a><span id="l163.34" class="difflineminus">- * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l163.35"></a><span id="l163.35" class="difflineminus">- * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l163.36"></a><span id="l163.36" class="difflineminus">- * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l163.37"></a><span id="l163.37" class="difflineminus">- * the provisions above, a recipient may use your version of this file under</span>
<a href="#l163.38"></a><span id="l163.38" class="difflineminus">- * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l163.39"></a><span id="l163.39" class="difflineminus">- *</span>
<a href="#l163.40"></a><span id="l163.40" class="difflineminus">- * ***** END LICENSE BLOCK ***** */</span>
<a href="#l163.41"></a><span id="l163.41" class="difflineminus">-#include &quot;nsISupports.idl&quot;</span>
<a href="#l163.42"></a><span id="l163.42" class="difflineminus">-#include &quot;domstubs.idl&quot;</span>
<a href="#l163.43"></a><span id="l163.43" class="difflineminus">-#include &quot;nsIPrompt.idl&quot;</span>
<a href="#l163.44"></a><span id="l163.44" class="difflineminus">-#include &quot;nsIWebProgressListener.idl&quot;</span>
<a href="#l163.45"></a><span id="l163.45" class="difflineminus">-</span>
<a href="#l163.46"></a><span id="l163.46" class="difflineminus">-interface nsIDOMWindowInternal;</span>
<a href="#l163.47"></a><span id="l163.47" class="difflineminus">-</span>
<a href="#l163.48"></a><span id="l163.48" class="difflineminus">-[scriptable, uuid(2080d500-149e-11d5-9daa-e276a42bc27c)]</span>
<a href="#l163.49"></a><span id="l163.49" class="difflineminus">-interface nsIMsgComposeProgress: nsIWebProgressListener {</span>
<a href="#l163.50"></a><span id="l163.50" class="difflineminus">-</span>
<a href="#l163.51"></a><span id="l163.51" class="difflineminus">-  /* Open the progress widget, usually it's a dialog</span>
<a href="#l163.52"></a><span id="l163.52" class="difflineminus">-     you can specify the subject of the message,</span>
<a href="#l163.53"></a><span id="l163.53" class="difflineminus">-     and specify if it a save or send operation</span>
<a href="#l163.54"></a><span id="l163.54" class="difflineminus">-  */</span>
<a href="#l163.55"></a><span id="l163.55" class="difflineminus">-  void openProgress(in nsIDOMWindowInternal parent, in wstring subject, in boolean itsASaveOperation);</span>
<a href="#l163.56"></a><span id="l163.56" class="difflineminus">-  </span>
<a href="#l163.57"></a><span id="l163.57" class="difflineminus">-  /* Close the progress widget, usually it's a dialog */</span>
<a href="#l163.58"></a><span id="l163.58" class="difflineminus">-  void closeProgress(in boolean forceClose);</span>
<a href="#l163.59"></a><span id="l163.59" class="difflineminus">-  </span>
<a href="#l163.60"></a><span id="l163.60" class="difflineminus">-  /* Register a Web Progress Listener */</span>
<a href="#l163.61"></a><span id="l163.61" class="difflineminus">-  void registerListener(in nsIWebProgressListener listener);</span>
<a href="#l163.62"></a><span id="l163.62" class="difflineminus">-</span>
<a href="#l163.63"></a><span id="l163.63" class="difflineminus">-  /* Unregister a Web Progress Listener */</span>
<a href="#l163.64"></a><span id="l163.64" class="difflineminus">-  void unregisterListener(in nsIWebProgressListener listener);</span>
<a href="#l163.65"></a><span id="l163.65" class="difflineminus">-  </span>
<a href="#l163.66"></a><span id="l163.66" class="difflineminus">-  /* Retrieve the prompter, needed to display modal dialog on top of progress dialog */</span>
<a href="#l163.67"></a><span id="l163.67" class="difflineminus">-  nsIPrompt getPrompter();</span>
<a href="#l163.68"></a><span id="l163.68" class="difflineminus">-</span>
<a href="#l163.69"></a><span id="l163.69" class="difflineminus">-  /* Indicated if the user asked to cancel the current process */</span>
<a href="#l163.70"></a><span id="l163.70" class="difflineminus">-  attribute boolean processCanceledByUser;</span>
<a href="#l163.71"></a><span id="l163.71" class="difflineminus">-};</span>
<a href="#l163.72"></a><span id="l163.72" class="difflineminus">-</span>
<a href="#l163.73"></a><span id="l163.73" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l164.1"></a><span id="l164.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgCompose.cpp</span>
<a href="#l164.2"></a><span id="l164.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgCompose.cpp</span>
<a href="#l164.3"></a><span id="l164.3" class="difflineat">@@ -1173,18 +1173,16 @@ NS_IMETHODIMP nsMsgCompose::SendMsg(MSG_</span>
<a href="#l164.4"></a><span id="l164.4">             return NS_ERROR_FAILURE;</span>
<a href="#l164.5"></a><span id="l164.5"> </span>
<a href="#l164.6"></a><span id="l164.6">           params-&gt;SetSubject(msgSubject.get());</span>
<a href="#l164.7"></a><span id="l164.7">           params-&gt;SetDeliveryMode(deliverMode);</span>
<a href="#l164.8"></a><span id="l164.8"> </span>
<a href="#l164.9"></a><span id="l164.9">           mProgress-&gt;OpenProgressDialog(m_window, aMsgWindow, </span>
<a href="#l164.10"></a><span id="l164.10">                                         &quot;chrome://messenger/content/messengercompose/sendProgress.xul&quot;, </span>
<a href="#l164.11"></a><span id="l164.11">                                         PR_FALSE, params);</span>
<a href="#l164.12"></a><span id="l164.12" class="difflineminus">-          </span>
<a href="#l164.13"></a><span id="l164.13" class="difflineminus">-          mProgress-&gt;GetPrompter(getter_AddRefs(prompt));</span>
<a href="#l164.14"></a><span id="l164.14">         }</span>
<a href="#l164.15"></a><span id="l164.15">       }</span>
<a href="#l164.16"></a><span id="l164.16">     }</span>
<a href="#l164.17"></a><span id="l164.17"> </span>
<a href="#l164.18"></a><span id="l164.18">     mProgress-&gt;OnStateChange(nsnull, nsnull, nsIWebProgressListener::STATE_START, NS_OK);</span>
<a href="#l164.19"></a><span id="l164.19">   }</span>
<a href="#l164.20"></a><span id="l164.20"> </span>
<a href="#l164.21"></a><span id="l164.21">   PRBool attachVCard = PR_FALSE;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l165.1"></a><span id="l165.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgSend.cpp</span>
<a href="#l165.2"></a><span id="l165.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgSend.cpp</span>
<a href="#l165.3"></a><span id="l165.3" class="difflineat">@@ -372,23 +372,16 @@ nsMsgComposeAndSend::~nsMsgComposeAndSen</span>
<a href="#l165.4"></a><span id="l165.4"> </span>
<a href="#l165.5"></a><span id="l165.5"> NS_IMETHODIMP nsMsgComposeAndSend::GetDefaultPrompt(nsIPrompt ** aPrompt)</span>
<a href="#l165.6"></a><span id="l165.6"> {</span>
<a href="#l165.7"></a><span id="l165.7">   NS_ENSURE_ARG(aPrompt);</span>
<a href="#l165.8"></a><span id="l165.8">   *aPrompt = nsnull;</span>
<a href="#l165.9"></a><span id="l165.9"> </span>
<a href="#l165.10"></a><span id="l165.10">   nsresult rv = NS_OK;</span>
<a href="#l165.11"></a><span id="l165.11"> </span>
<a href="#l165.12"></a><span id="l165.12" class="difflineminus">-  if (mSendProgress)</span>
<a href="#l165.13"></a><span id="l165.13" class="difflineminus">-  {</span>
<a href="#l165.14"></a><span id="l165.14" class="difflineminus">-    rv = mSendProgress-&gt;GetPrompter(aPrompt);</span>
<a href="#l165.15"></a><span id="l165.15" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; *aPrompt)</span>
<a href="#l165.16"></a><span id="l165.16" class="difflineminus">-      return NS_OK;</span>
<a href="#l165.17"></a><span id="l165.17" class="difflineminus">-  }</span>
<a href="#l165.18"></a><span id="l165.18" class="difflineminus">-</span>
<a href="#l165.19"></a><span id="l165.19">   if (mParentWindow)</span>
<a href="#l165.20"></a><span id="l165.20">   {</span>
<a href="#l165.21"></a><span id="l165.21">     rv = mParentWindow-&gt;GetPrompter(aPrompt);</span>
<a href="#l165.22"></a><span id="l165.22">     if (NS_SUCCEEDED(rv) &amp;&amp; *aPrompt)</span>
<a href="#l165.23"></a><span id="l165.23">       return NS_OK;</span>
<a href="#l165.24"></a><span id="l165.24">   }</span>
<a href="#l165.25"></a><span id="l165.25"> </span>
<a href="#l165.26"></a><span id="l165.26">   /* If we cannot find a prompter, try the mail3Pane window */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l166.1"></a><span id="l166.1">new file mode 100644</span>
<a href="#l166.2"></a><span id="l166.2" class="difflineminus">--- /dev/null</span>
<a href="#l166.3"></a><span id="l166.3" class="difflineplus">+++ b/mailnews/compose/test/unit/tail_compose.js</span>
<a href="#l166.4"></a><span id="l166.4" class="difflineat">@@ -0,0 +1,1 @@</span>
<a href="#l166.5"></a><span id="l166.5" class="difflineplus">+load(&quot;../../mailnews/resources/mailShutdown.js&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l167.1"></a><span id="l167.1" class="difflineminus">--- a/mailnews/db/gloda/modules/datastore.js</span>
<a href="#l167.2"></a><span id="l167.2" class="difflineplus">+++ b/mailnews/db/gloda/modules/datastore.js</span>
<a href="#l167.3"></a><span id="l167.3" class="difflineat">@@ -2214,17 +2214,16 @@ var GlodaDatastore = {</span>
<a href="#l167.4"></a><span id="l167.4">     return this._updateMessagesMarkDeletedByFolderID;</span>
<a href="#l167.5"></a><span id="l167.5">   },</span>
<a href="#l167.6"></a><span id="l167.6"> </span>
<a href="#l167.7"></a><span id="l167.7">   markMessagesDeletedByFolderID:</span>
<a href="#l167.8"></a><span id="l167.8">       function gloda_ds_markMessagesDeletedByFolderID(aFolderID) {</span>
<a href="#l167.9"></a><span id="l167.9">     let statement = this._updateMessagesMarkDeletedByFolderID;</span>
<a href="#l167.10"></a><span id="l167.10">     statement.bindInt64Parameter(0, aFolderID);</span>
<a href="#l167.11"></a><span id="l167.11">     statement.executeAsync(this.trackAsync());</span>
<a href="#l167.12"></a><span id="l167.12" class="difflineminus">-    statement.finalize();</span>
<a href="#l167.13"></a><span id="l167.13">   },</span>
<a href="#l167.14"></a><span id="l167.14"> </span>
<a href="#l167.15"></a><span id="l167.15">   markMessagesDeletedByIDs: function gloda_ds_markMessagesDeletedByIDs(</span>
<a href="#l167.16"></a><span id="l167.16">       aMessageIDs) {</span>
<a href="#l167.17"></a><span id="l167.17">     let sqlString = &quot;UPDATE messages SET deleted = 1 WHERE id IN (&quot; +</span>
<a href="#l167.18"></a><span id="l167.18">       aMessageIDs.join(&quot;,&quot;) + &quot;)&quot;;</span>
<a href="#l167.19"></a><span id="l167.19"> </span>
<a href="#l167.20"></a><span id="l167.20">     let statement = this._createAsyncStatement(sqlString, true);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l168.1"></a><span id="l168.1" class="difflineminus">--- a/mailnews/db/gloda/modules/indexer.js</span>
<a href="#l168.2"></a><span id="l168.2" class="difflineplus">+++ b/mailnews/db/gloda/modules/indexer.js</span>
<a href="#l168.3"></a><span id="l168.3" class="difflineat">@@ -2167,16 +2167,17 @@ var GlodaIndexer = {</span>
<a href="#l168.4"></a><span id="l168.4">      *  action, but arguably a set of completely duplicate messages is not</span>
<a href="#l168.5"></a><span id="l168.5">      *  a high priority for indexing.</span>
<a href="#l168.6"></a><span id="l168.6">      */</span>
<a href="#l168.7"></a><span id="l168.7">     folderMoveCopyCompleted: function gloda_indexer_folderMoveCopyCompleted(</span>
<a href="#l168.8"></a><span id="l168.8">                                aMove, aSrcFolder, aDestFolder) {</span>
<a href="#l168.9"></a><span id="l168.9">       this.indexer._log.debug(&quot;folderMoveCopy notification (Move: &quot; + aMove</span>
<a href="#l168.10"></a><span id="l168.10">                               + &quot;)&quot;);</span>
<a href="#l168.11"></a><span id="l168.11">       if (aMove) {</span>
<a href="#l168.12"></a><span id="l168.12" class="difflineplus">+        let srcURI = aSrcFolder.URI;</span>
<a href="#l168.13"></a><span id="l168.13">         let targetURI = aDestFolder.URI +</span>
<a href="#l168.14"></a><span id="l168.14">                         srcURI.substring(srcURI.lastIndexOf(&quot;/&quot;));</span>
<a href="#l168.15"></a><span id="l168.15">         return this._folderRenameHelper(aSrcFolder, targetURI);</span>
<a href="#l168.16"></a><span id="l168.16">       }</span>
<a href="#l168.17"></a><span id="l168.17">       this.indexer.indexingSweepNeeded = true;</span>
<a href="#l168.18"></a><span id="l168.18">     },</span>
<a href="#l168.19"></a><span id="l168.19">     </span>
<a href="#l168.20"></a><span id="l168.20">     /**</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l169.1"></a><span id="l169.1" class="difflineminus">--- a/mailnews/db/msgdb/public/nsIMsgDatabase.idl</span>
<a href="#l169.2"></a><span id="l169.2" class="difflineplus">+++ b/mailnews/db/msgdb/public/nsIMsgDatabase.idl</span>
<a href="#l169.3"></a><span id="l169.3" class="difflineat">@@ -131,17 +131,17 @@ interface nsMsgDBCommitType</span>
<a href="#l169.4"></a><span id="l169.4"> [ptr] native nsMsgKeyArrayPtr(nsTArray&lt;nsMsgKey&gt;);</span>
<a href="#l169.5"></a><span id="l169.5"> </span>
<a href="#l169.6"></a><span id="l169.6"> /**</span>
<a href="#l169.7"></a><span id="l169.7">  * A service to open mail databases and manipulate listeners automatically.</span>
<a href="#l169.8"></a><span id="l169.8">  *</span>
<a href="#l169.9"></a><span id="l169.9">  * The contract ID for this component is</span>
<a href="#l169.10"></a><span id="l169.10">  * &lt;tt&gt;\@mozilla.org/msgDatabase/msgDBService;1&lt;/tt&gt;.</span>
<a href="#l169.11"></a><span id="l169.11">  */</span>
<a href="#l169.12"></a><span id="l169.12" class="difflineminus">-[scriptable, uuid(26cb7242-a4ba-4811-ad7b-ff993450aae3)]</span>
<a href="#l169.13"></a><span id="l169.13" class="difflineplus">+[scriptable, uuid(959d0a27-9a00-4ce8-b01d-180ff2387b6a)]</span>
<a href="#l169.14"></a><span id="l169.14"> interface nsIMsgDBService : nsISupports</span>
<a href="#l169.15"></a><span id="l169.15"> {</span>
<a href="#l169.16"></a><span id="l169.16">   /**</span>
<a href="#l169.17"></a><span id="l169.17">    * Opens a database for a given folder.</span>
<a href="#l169.18"></a><span id="l169.18">    *</span>
<a href="#l169.19"></a><span id="l169.19">    * This method is preferred over nsIMsgDBService::openMailDBFromFile if the</span>
<a href="#l169.20"></a><span id="l169.20">    * caller has an actual nsIMsgFolder around. If the database detects that it</span>
<a href="#l169.21"></a><span id="l169.21">    * is unreadable or out of date (using nsIMsgDatabase::outOfDate) it will</span>
<a href="#l169.22"></a><span id="l169.22" class="difflineat">@@ -225,16 +225,25 @@ interface nsIMsgDBService : nsISupports</span>
<a href="#l169.23"></a><span id="l169.23">   /**</span>
<a href="#l169.24"></a><span id="l169.24">    * Removes the listener from all folder listener sets.</span>
<a href="#l169.25"></a><span id="l169.25">    *</span>
<a href="#l169.26"></a><span id="l169.26">    * @param aListener       The listener to remove.</span>
<a href="#l169.27"></a><span id="l169.27">    * @exception NS_ERROR_FAILURE</span>
<a href="#l169.28"></a><span id="l169.28">    *                        The listener is not registered.</span>
<a href="#l169.29"></a><span id="l169.29">    */</span>
<a href="#l169.30"></a><span id="l169.30">   void unregisterPendingListener(in nsIDBChangeListener aListener);</span>
<a href="#l169.31"></a><span id="l169.31" class="difflineplus">+</span>
<a href="#l169.32"></a><span id="l169.32" class="difflineplus">+  /**</span>
<a href="#l169.33"></a><span id="l169.33" class="difflineplus">+   * Get the db for a folder, if already open.</span>
<a href="#l169.34"></a><span id="l169.34" class="difflineplus">+   *</span>
<a href="#l169.35"></a><span id="l169.35" class="difflineplus">+   * @param aFolder   The folder to get the cached (open) db for.</span>
<a href="#l169.36"></a><span id="l169.36" class="difflineplus">+   *</span>
<a href="#l169.37"></a><span id="l169.37" class="difflineplus">+   * @returns         null if the db isn't open, otherwise the db.</span>
<a href="#l169.38"></a><span id="l169.38" class="difflineplus">+   */</span>
<a href="#l169.39"></a><span id="l169.39" class="difflineplus">+  nsIMsgDatabase cachedDBForFolder(in nsIMsgFolder aFolder);</span>
<a href="#l169.40"></a><span id="l169.40"> };</span>
<a href="#l169.41"></a><span id="l169.41"> </span>
<a href="#l169.42"></a><span id="l169.42"> [scriptable, uuid(51fd11c9-5be6-4cad-af6b-fb18d6232be4)]</span>
<a href="#l169.43"></a><span id="l169.43"> interface nsIMsgDatabase : nsIDBChangeAnnouncer {</span>
<a href="#l169.44"></a><span id="l169.44">   /**</span>
<a href="#l169.45"></a><span id="l169.45">    * Opens a database folder.</span>
<a href="#l169.46"></a><span id="l169.46">    *</span>
<a href="#l169.47"></a><span id="l169.47">    * @param aFolderName     The name of the folder to create.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l170.1"></a><span id="l170.1" class="difflineminus">--- a/mailnews/db/msgdb/public/nsMsgDatabase.h</span>
<a href="#l170.2"></a><span id="l170.2" class="difflineplus">+++ b/mailnews/db/msgdb/public/nsMsgDatabase.h</span>
<a href="#l170.3"></a><span id="l170.3" class="difflineat">@@ -50,16 +50,17 @@</span>
<a href="#l170.4"></a><span id="l170.4"> #include &quot;nsDBFolderInfo.h&quot;</span>
<a href="#l170.5"></a><span id="l170.5"> #include &quot;nsICollation.h&quot;</span>
<a href="#l170.6"></a><span id="l170.6"> #include &quot;nsIMimeConverter.h&quot;</span>
<a href="#l170.7"></a><span id="l170.7"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l170.8"></a><span id="l170.8"> #include &quot;nsCOMArray.h&quot;</span>
<a href="#l170.9"></a><span id="l170.9"> #include &quot;pldhash.h&quot;</span>
<a href="#l170.10"></a><span id="l170.10"> #include &quot;nsTArray.h&quot;</span>
<a href="#l170.11"></a><span id="l170.11"> #include &quot;nsTObserverArray.h&quot;</span>
<a href="#l170.12"></a><span id="l170.12" class="difflineplus">+#include &quot;nsAutoPtr.h&quot;</span>
<a href="#l170.13"></a><span id="l170.13"> class ListContext;</span>
<a href="#l170.14"></a><span id="l170.14"> class nsMsgKeySet;</span>
<a href="#l170.15"></a><span id="l170.15"> class nsMsgThread;</span>
<a href="#l170.16"></a><span id="l170.16"> class nsIMsgThread;</span>
<a href="#l170.17"></a><span id="l170.17"> class nsIDBFolderInfo;</span>
<a href="#l170.18"></a><span id="l170.18"> class nsIMsgHeaderParser;</span>
<a href="#l170.19"></a><span id="l170.19"> </span>
<a href="#l170.20"></a><span id="l170.20"> const PRInt32 kMsgDBVersion = 1;</span>
<a href="#l170.21"></a><span id="l170.21" class="difflineat">@@ -72,16 +73,48 @@ public:</span>
<a href="#l170.22"></a><span id="l170.22"> </span>
<a href="#l170.23"></a><span id="l170.23">   nsMsgDBService();</span>
<a href="#l170.24"></a><span id="l170.24">   ~nsMsgDBService();</span>
<a href="#l170.25"></a><span id="l170.25"> protected:</span>
<a href="#l170.26"></a><span id="l170.26">   nsCOMArray &lt;nsIMsgFolder&gt; m_foldersPendingListeners;</span>
<a href="#l170.27"></a><span id="l170.27">   nsCOMArray &lt;nsIDBChangeListener&gt; m_pendingListeners;</span>
<a href="#l170.28"></a><span id="l170.28"> };</span>
<a href="#l170.29"></a><span id="l170.29"> </span>
<a href="#l170.30"></a><span id="l170.30" class="difflineplus">+class nsMsgDBEnumerator : public nsISimpleEnumerator {</span>
<a href="#l170.31"></a><span id="l170.31" class="difflineplus">+public:</span>
<a href="#l170.32"></a><span id="l170.32" class="difflineplus">+    NS_DECL_ISUPPORTS</span>
<a href="#l170.33"></a><span id="l170.33" class="difflineplus">+</span>
<a href="#l170.34"></a><span id="l170.34" class="difflineplus">+    // nsISimpleEnumerator methods:</span>
<a href="#l170.35"></a><span id="l170.35" class="difflineplus">+    NS_DECL_NSISIMPLEENUMERATOR</span>
<a href="#l170.36"></a><span id="l170.36" class="difflineplus">+</span>
<a href="#l170.37"></a><span id="l170.37" class="difflineplus">+    // nsMsgDBEnumerator methods:</span>
<a href="#l170.38"></a><span id="l170.38" class="difflineplus">+    typedef nsresult (*nsMsgDBEnumeratorFilter)(nsIMsgDBHdr* hdr, void* closure);</span>
<a href="#l170.39"></a><span id="l170.39" class="difflineplus">+</span>
<a href="#l170.40"></a><span id="l170.40" class="difflineplus">+    nsMsgDBEnumerator(nsMsgDatabase* db, nsIMdbTable *table,</span>
<a href="#l170.41"></a><span id="l170.41" class="difflineplus">+                      nsMsgDBEnumeratorFilter filter, void* closure,</span>
<a href="#l170.42"></a><span id="l170.42" class="difflineplus">+                      PRBool iterateForwards = PR_TRUE);</span>
<a href="#l170.43"></a><span id="l170.43" class="difflineplus">+    virtual ~nsMsgDBEnumerator();</span>
<a href="#l170.44"></a><span id="l170.44" class="difflineplus">+</span>
<a href="#l170.45"></a><span id="l170.45" class="difflineplus">+    void Clear();</span>
<a href="#l170.46"></a><span id="l170.46" class="difflineplus">+</span>
<a href="#l170.47"></a><span id="l170.47" class="difflineplus">+protected:</span>
<a href="#l170.48"></a><span id="l170.48" class="difflineplus">+    nsresult                        GetRowCursor();</span>
<a href="#l170.49"></a><span id="l170.49" class="difflineplus">+    nsresult                        PrefetchNext();</span>
<a href="#l170.50"></a><span id="l170.50" class="difflineplus">+    nsRefPtr&lt;nsMsgDatabase&gt;         mDB;</span>
<a href="#l170.51"></a><span id="l170.51" class="difflineplus">+    nsCOMPtr&lt;nsIMdbTableRowCursor&gt;  mRowCursor;</span>
<a href="#l170.52"></a><span id="l170.52" class="difflineplus">+    nsCOMPtr&lt;nsIMsgDBHdr&gt;           mResultHdr;</span>
<a href="#l170.53"></a><span id="l170.53" class="difflineplus">+    PRBool                          mDone;</span>
<a href="#l170.54"></a><span id="l170.54" class="difflineplus">+    PRBool                          mNextPrefetched;</span>
<a href="#l170.55"></a><span id="l170.55" class="difflineplus">+    PRBool                          mIterateForwards;</span>
<a href="#l170.56"></a><span id="l170.56" class="difflineplus">+    nsMsgDBEnumeratorFilter         mFilter;</span>
<a href="#l170.57"></a><span id="l170.57" class="difflineplus">+    nsCOMPtr &lt;nsIMdbTable&gt;          mTable;</span>
<a href="#l170.58"></a><span id="l170.58" class="difflineplus">+    void*                           mClosure;</span>
<a href="#l170.59"></a><span id="l170.59" class="difflineplus">+};</span>
<a href="#l170.60"></a><span id="l170.60" class="difflineplus">+</span>
<a href="#l170.61"></a><span id="l170.61" class="difflineplus">+</span>
<a href="#l170.62"></a><span id="l170.62"> class nsMsgDatabase : public nsIMsgDatabase</span>
<a href="#l170.63"></a><span id="l170.63"> {</span>
<a href="#l170.64"></a><span id="l170.64"> public:</span>
<a href="#l170.65"></a><span id="l170.65">   friend class nsMsgDBService;</span>
<a href="#l170.66"></a><span id="l170.66">   friend class nsMsgPropertyEnumerator; // accesses m_mdbEnv and m_mdbStore</span>
<a href="#l170.67"></a><span id="l170.67"> </span>
<a href="#l170.68"></a><span id="l170.68">   NS_DECL_ISUPPORTS</span>
<a href="#l170.69"></a><span id="l170.69">   NS_DECL_NSIDBCHANGEANNOUNCER</span>
<a href="#l170.70"></a><span id="l170.70" class="difflineat">@@ -182,18 +215,17 @@ protected:</span>
<a href="#l170.71"></a><span id="l170.71">   // threading interfaces</span>
<a href="#l170.72"></a><span id="l170.72">   virtual nsresult CreateNewThread(nsMsgKey key, const char *subject, nsMsgThread **newThread);</span>
<a href="#l170.73"></a><span id="l170.73">   virtual PRBool  ThreadBySubjectWithoutRe();</span>
<a href="#l170.74"></a><span id="l170.74">   virtual PRBool  UseStrictThreading();</span>
<a href="#l170.75"></a><span id="l170.75">   virtual PRBool  UseCorrectThreading();</span>
<a href="#l170.76"></a><span id="l170.76">   virtual nsresult ThreadNewHdr(nsMsgHdr* hdr, PRBool &amp;newThread);</span>
<a href="#l170.77"></a><span id="l170.77">   virtual nsresult AddNewThread(nsMsgHdr *msgHdr);</span>
<a href="#l170.78"></a><span id="l170.78">   virtual nsresult AddToThread(nsMsgHdr *newHdr, nsIMsgThread *thread, nsIMsgDBHdr *pMsgHdr, PRBool threadInThread);</span>
<a href="#l170.79"></a><span id="l170.79" class="difflineminus">-  </span>
<a href="#l170.80"></a><span id="l170.80" class="difflineminus">-  </span>
<a href="#l170.81"></a><span id="l170.81" class="difflineplus">+</span>
<a href="#l170.82"></a><span id="l170.82">   static nsTArray&lt;nsMsgDatabase*&gt;* m_dbCache;</span>
<a href="#l170.83"></a><span id="l170.83">   static nsTArray&lt;nsMsgDatabase*&gt;* GetDBCache();</span>
<a href="#l170.84"></a><span id="l170.84">   </span>
<a href="#l170.85"></a><span id="l170.85">   static void    AddToCache(nsMsgDatabase* pMessageDB) </span>
<a href="#l170.86"></a><span id="l170.86">   {</span>
<a href="#l170.87"></a><span id="l170.87"> #ifdef DEBUG_David_Bienvenu</span>
<a href="#l170.88"></a><span id="l170.88"> //    NS_ASSERTION(GetDBCache()-&gt;Length() &lt; 50, &quot;50 or more open db's&quot;);</span>
<a href="#l170.89"></a><span id="l170.89"> #endif</span>
<a href="#l170.90"></a><span id="l170.90" class="difflineat">@@ -327,16 +359,19 @@ protected:</span>
<a href="#l170.91"></a><span id="l170.91">   PLDHashTable *m_msgReferences;</span>
<a href="#l170.92"></a><span id="l170.92">   nsresult GetRefFromHash(nsCString &amp;reference, nsMsgKey *threadId);</span>
<a href="#l170.93"></a><span id="l170.93">   nsresult AddRefToHash(nsCString &amp;reference, nsMsgKey threadId);</span>
<a href="#l170.94"></a><span id="l170.94">   nsresult AddMsgRefsToHash(nsIMsgDBHdr *msgHdr);</span>
<a href="#l170.95"></a><span id="l170.95">   nsresult RemoveRefFromHash(nsCString &amp;reference);</span>
<a href="#l170.96"></a><span id="l170.96">   nsresult RemoveMsgRefsFromHash(nsIMsgDBHdr *msgHdr);</span>
<a href="#l170.97"></a><span id="l170.97">   nsresult InitRefHash();</span>
<a href="#l170.98"></a><span id="l170.98"> </span>
<a href="#l170.99"></a><span id="l170.99" class="difflineplus">+  // not-reference holding array of enumerators we've handed out.</span>
<a href="#l170.100"></a><span id="l170.100" class="difflineplus">+  // If a db goes away, it will clean up the outstanding enumerators.</span>
<a href="#l170.101"></a><span id="l170.101" class="difflineplus">+  nsTArray&lt;nsMsgDBEnumerator *&gt; m_enumerators;</span>
<a href="#l170.102"></a><span id="l170.102"> private:</span>
<a href="#l170.103"></a><span id="l170.103">   PRUint32 m_cacheSize;</span>
<a href="#l170.104"></a><span id="l170.104"> };</span>
<a href="#l170.105"></a><span id="l170.105"> </span>
<a href="#l170.106"></a><span id="l170.106"> class nsMsgRetentionSettings : public nsIMsgRetentionSettings</span>
<a href="#l170.107"></a><span id="l170.107"> {</span>
<a href="#l170.108"></a><span id="l170.108"> public:</span>
<a href="#l170.109"></a><span id="l170.109">   nsMsgRetentionSettings();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l171.1"></a><span id="l171.1" class="difflineminus">--- a/mailnews/db/msgdb/src/nsMsgDatabase.cpp</span>
<a href="#l171.2"></a><span id="l171.2" class="difflineplus">+++ b/mailnews/db/msgdb/src/nsMsgDatabase.cpp</span>
<a href="#l171.3"></a><span id="l171.3" class="difflineat">@@ -281,16 +281,24 @@ NS_IMETHODIMP nsMsgDBService::Unregister</span>
<a href="#l171.4"></a><span id="l171.4">       msgDB-&gt;RemoveListener(aListener);</span>
<a href="#l171.5"></a><span id="l171.5">     m_foldersPendingListeners.RemoveObjectAt(listenerIndex);</span>
<a href="#l171.6"></a><span id="l171.6">     m_pendingListeners.RemoveObjectAt(listenerIndex);</span>
<a href="#l171.7"></a><span id="l171.7">     return NS_OK;</span>
<a href="#l171.8"></a><span id="l171.8">   }</span>
<a href="#l171.9"></a><span id="l171.9">   return NS_ERROR_FAILURE;</span>
<a href="#l171.10"></a><span id="l171.10"> }</span>
<a href="#l171.11"></a><span id="l171.11"> </span>
<a href="#l171.12"></a><span id="l171.12" class="difflineplus">+NS_IMETHODIMP nsMsgDBService::CachedDBForFolder(nsIMsgFolder *aFolder, nsIMsgDatabase **aRetDB)</span>
<a href="#l171.13"></a><span id="l171.13" class="difflineplus">+{</span>
<a href="#l171.14"></a><span id="l171.14" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aFolder);</span>
<a href="#l171.15"></a><span id="l171.15" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aRetDB);</span>
<a href="#l171.16"></a><span id="l171.16" class="difflineplus">+  *aRetDB = nsMsgDatabase::FindInCache(aFolder);</span>
<a href="#l171.17"></a><span id="l171.17" class="difflineplus">+  return NS_OK;</span>
<a href="#l171.18"></a><span id="l171.18" class="difflineplus">+}</span>
<a href="#l171.19"></a><span id="l171.19" class="difflineplus">+</span>
<a href="#l171.20"></a><span id="l171.20"> static PRBool gGotGlobalPrefs = PR_FALSE;</span>
<a href="#l171.21"></a><span id="l171.21"> static PRBool gThreadWithoutRe = PR_TRUE;</span>
<a href="#l171.22"></a><span id="l171.22"> static PRBool gStrictThreading = PR_FALSE;</span>
<a href="#l171.23"></a><span id="l171.23"> static PRBool gCorrectThreading = PR_FALSE;</span>
<a href="#l171.24"></a><span id="l171.24"> </span>
<a href="#l171.25"></a><span id="l171.25"> void nsMsgDatabase::GetGlobalPrefs()</span>
<a href="#l171.26"></a><span id="l171.26"> {</span>
<a href="#l171.27"></a><span id="l171.27">   if (!gGotGlobalPrefs)</span>
<a href="#l171.28"></a><span id="l171.28" class="difflineat">@@ -422,16 +430,23 @@ void nsMsgDatabase::ClearCachedObjects(P</span>
<a href="#l171.29"></a><span id="l171.29"> #endif</span>
<a href="#l171.30"></a><span id="l171.30">   // We should only clear the use hdr cache when the db is going away, or we could</span>
<a href="#l171.31"></a><span id="l171.31">   // end up with multiple copies of the same logical msg hdr, which will lead to</span>
<a href="#l171.32"></a><span id="l171.32">   // ref-counting problems.</span>
<a href="#l171.33"></a><span id="l171.33">   if (dbGoingAway)</span>
<a href="#l171.34"></a><span id="l171.34">     ClearUseHdrCache();</span>
<a href="#l171.35"></a><span id="l171.35">   m_cachedThread = nsnull;</span>
<a href="#l171.36"></a><span id="l171.36">   m_cachedThreadId = nsMsgKey_None;</span>
<a href="#l171.37"></a><span id="l171.37" class="difflineplus">+  // clean out existing enumerators</span>
<a href="#l171.38"></a><span id="l171.38" class="difflineplus">+  nsTArray&lt;nsMsgDBEnumerator *&gt; copyEnumerators;</span>
<a href="#l171.39"></a><span id="l171.39" class="difflineplus">+  copyEnumerators.SwapElements(m_enumerators);</span>
<a href="#l171.40"></a><span id="l171.40" class="difflineplus">+</span>
<a href="#l171.41"></a><span id="l171.41" class="difflineplus">+  PRInt32 numEnums = copyEnumerators.Length();</span>
<a href="#l171.42"></a><span id="l171.42" class="difflineplus">+  for (PRUint32 i = 0; i &lt; numEnums; i++)</span>
<a href="#l171.43"></a><span id="l171.43" class="difflineplus">+    copyEnumerators[i]-&gt;Clear();</span>
<a href="#l171.44"></a><span id="l171.44"> }</span>
<a href="#l171.45"></a><span id="l171.45"> </span>
<a href="#l171.46"></a><span id="l171.46"> nsresult nsMsgDatabase::ClearHdrCache(PRBool reInit)</span>
<a href="#l171.47"></a><span id="l171.47"> {</span>
<a href="#l171.48"></a><span id="l171.48">   if (m_cachedHeaders)</span>
<a href="#l171.49"></a><span id="l171.49">   {</span>
<a href="#l171.50"></a><span id="l171.50">     // save this away in case we renter this code.</span>
<a href="#l171.51"></a><span id="l171.51">     PLDHashTable  *saveCachedHeaders = m_cachedHeaders;</span>
<a href="#l171.52"></a><span id="l171.52" class="difflineat">@@ -1835,18 +1850,16 @@ PRUint32  nsMsgDatabase::GetStatusFlags(</span>
<a href="#l171.53"></a><span id="l171.53"> {</span>
<a href="#l171.54"></a><span id="l171.54">   PRUint32  statusFlags = origFlags;</span>
<a href="#l171.55"></a><span id="l171.55">   PRBool  isRead = PR_TRUE;</span>
<a href="#l171.56"></a><span id="l171.56"> </span>
<a href="#l171.57"></a><span id="l171.57">   nsMsgKey key;</span>
<a href="#l171.58"></a><span id="l171.58">   (void)msgHdr-&gt;GetMessageKey(&amp;key);</span>
<a href="#l171.59"></a><span id="l171.59">   if (!m_newSet.IsEmpty() &amp;&amp; m_newSet[m_newSet.Length() - 1] == key || m_newSet.BinaryIndexOf(key) != -1)</span>
<a href="#l171.60"></a><span id="l171.60">     statusFlags |= nsMsgMessageFlags::New;</span>
<a href="#l171.61"></a><span id="l171.61" class="difflineminus">-  else</span>
<a href="#l171.62"></a><span id="l171.62" class="difflineminus">-    statusFlags &amp;= ~nsMsgMessageFlags::New;</span>
<a href="#l171.63"></a><span id="l171.63">   if (IsHeaderRead(msgHdr, &amp;isRead) == NS_OK &amp;&amp; isRead)</span>
<a href="#l171.64"></a><span id="l171.64">     statusFlags |= nsMsgMessageFlags::Read;</span>
<a href="#l171.65"></a><span id="l171.65">   return statusFlags;</span>
<a href="#l171.66"></a><span id="l171.66"> }</span>
<a href="#l171.67"></a><span id="l171.67"> </span>
<a href="#l171.68"></a><span id="l171.68"> nsresult nsMsgDatabase::IsHeaderRead(nsIMsgDBHdr *msgHdr, PRBool *pRead)</span>
<a href="#l171.69"></a><span id="l171.69"> {</span>
<a href="#l171.70"></a><span id="l171.70">   if (!msgHdr)</span>
<a href="#l171.71"></a><span id="l171.71" class="difflineat">@@ -2459,17 +2472,20 @@ NS_IMETHODIMP nsMsgDatabase::ClearNewLis</span>
<a href="#l171.72"></a><span id="l171.72">       nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l171.73"></a><span id="l171.73">       err = GetMsgHdrForKey(lastNewKey, getter_AddRefs(msgHdr));</span>
<a href="#l171.74"></a><span id="l171.74">       if (NS_SUCCEEDED(err))</span>
<a href="#l171.75"></a><span id="l171.75">       {</span>
<a href="#l171.76"></a><span id="l171.76">         PRUint32 flags;</span>
<a href="#l171.77"></a><span id="l171.77">         (void)msgHdr-&gt;GetFlags(&amp;flags);</span>
<a href="#l171.78"></a><span id="l171.78"> </span>
<a href="#l171.79"></a><span id="l171.79">         if ((flags | nsMsgMessageFlags::New) != flags)</span>
<a href="#l171.80"></a><span id="l171.80" class="difflineplus">+        {</span>
<a href="#l171.81"></a><span id="l171.81" class="difflineplus">+          msgHdr-&gt;AndFlags(~nsMsgMessageFlags::New, &amp;flags);</span>
<a href="#l171.82"></a><span id="l171.82">           NotifyHdrChangeAll(msgHdr, flags | nsMsgMessageFlags::New, flags, nsnull);</span>
<a href="#l171.83"></a><span id="l171.83" class="difflineplus">+        }</span>
<a href="#l171.84"></a><span id="l171.84">       }</span>
<a href="#l171.85"></a><span id="l171.85">       if (elementIndex == 0)</span>
<a href="#l171.86"></a><span id="l171.86">         break;</span>
<a href="#l171.87"></a><span id="l171.87">     }</span>
<a href="#l171.88"></a><span id="l171.88">   }</span>
<a href="#l171.89"></a><span id="l171.89">   return err;</span>
<a href="#l171.90"></a><span id="l171.90"> }</span>
<a href="#l171.91"></a><span id="l171.91"> </span>
<a href="#l171.92"></a><span id="l171.92" class="difflineat">@@ -2488,67 +2504,42 @@ NS_IMETHODIMP nsMsgDatabase::GetFirstNew</span>
<a href="#l171.93"></a><span id="l171.93">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l171.94"></a><span id="l171.94">   *result = (hasnew) ? m_newSet.ElementAt(0) : nsMsgKey_None;</span>
<a href="#l171.95"></a><span id="l171.95">   return NS_OK;</span>
<a href="#l171.96"></a><span id="l171.96"> }</span>
<a href="#l171.97"></a><span id="l171.97"> </span>
<a href="#l171.98"></a><span id="l171.98"> </span>
<a href="#l171.99"></a><span id="l171.99"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l171.100"></a><span id="l171.100"> </span>
<a href="#l171.101"></a><span id="l171.101" class="difflineminus">-</span>
<a href="#l171.102"></a><span id="l171.102" class="difflineminus">-class nsMsgDBEnumerator : public nsISimpleEnumerator {</span>
<a href="#l171.103"></a><span id="l171.103" class="difflineminus">-public:</span>
<a href="#l171.104"></a><span id="l171.104" class="difflineminus">-    NS_DECL_ISUPPORTS</span>
<a href="#l171.105"></a><span id="l171.105" class="difflineminus">-</span>
<a href="#l171.106"></a><span id="l171.106" class="difflineminus">-    // nsISimpleEnumerator methods:</span>
<a href="#l171.107"></a><span id="l171.107" class="difflineminus">-    NS_DECL_NSISIMPLEENUMERATOR</span>
<a href="#l171.108"></a><span id="l171.108" class="difflineminus">-</span>
<a href="#l171.109"></a><span id="l171.109" class="difflineminus">-    // nsMsgDBEnumerator methods:</span>
<a href="#l171.110"></a><span id="l171.110" class="difflineminus">-    typedef nsresult (*nsMsgDBEnumeratorFilter)(nsIMsgDBHdr* hdr, void* closure);</span>
<a href="#l171.111"></a><span id="l171.111" class="difflineminus">-</span>
<a href="#l171.112"></a><span id="l171.112" class="difflineminus">-    nsMsgDBEnumerator(nsMsgDatabase* db, nsIMdbTable *table,</span>
<a href="#l171.113"></a><span id="l171.113" class="difflineminus">-                      nsMsgDBEnumeratorFilter filter, void* closure,</span>
<a href="#l171.114"></a><span id="l171.114" class="difflineminus">-                      PRBool iterateForwards = PR_TRUE);</span>
<a href="#l171.115"></a><span id="l171.115" class="difflineminus">-    virtual ~nsMsgDBEnumerator();</span>
<a href="#l171.116"></a><span id="l171.116" class="difflineminus">-</span>
<a href="#l171.117"></a><span id="l171.117" class="difflineminus">-protected:</span>
<a href="#l171.118"></a><span id="l171.118" class="difflineminus">-    nsresult          GetRowCursor();</span>
<a href="#l171.119"></a><span id="l171.119" class="difflineminus">-    nsresult          PrefetchNext();</span>
<a href="#l171.120"></a><span id="l171.120" class="difflineminus">-    nsMsgDatabase*              mDB;</span>
<a href="#l171.121"></a><span id="l171.121" class="difflineminus">-    nsIMdbTableRowCursor*       mRowCursor;</span>
<a href="#l171.122"></a><span id="l171.122" class="difflineminus">-    nsIMsgDBHdr*                 mResultHdr;</span>
<a href="#l171.123"></a><span id="l171.123" class="difflineminus">-    PRBool                      mDone;</span>
<a href="#l171.124"></a><span id="l171.124" class="difflineminus">-    PRBool                      mNextPrefetched;</span>
<a href="#l171.125"></a><span id="l171.125" class="difflineminus">-    PRBool                      mIterateForwards;</span>
<a href="#l171.126"></a><span id="l171.126" class="difflineminus">-    nsMsgDBEnumeratorFilter     mFilter;</span>
<a href="#l171.127"></a><span id="l171.127" class="difflineminus">-    nsCOMPtr &lt;nsIMdbTable&gt;      mTable;</span>
<a href="#l171.128"></a><span id="l171.128" class="difflineminus">-    void*                       mClosure;</span>
<a href="#l171.129"></a><span id="l171.129" class="difflineminus">-</span>
<a href="#l171.130"></a><span id="l171.130" class="difflineminus">-};</span>
<a href="#l171.131"></a><span id="l171.131" class="difflineminus">-</span>
<a href="#l171.132"></a><span id="l171.132"> nsMsgDBEnumerator::nsMsgDBEnumerator(nsMsgDatabase* db,</span>
<a href="#l171.133"></a><span id="l171.133">                                      nsIMdbTable *table,</span>
<a href="#l171.134"></a><span id="l171.134">                                      nsMsgDBEnumeratorFilter filter,</span>
<a href="#l171.135"></a><span id="l171.135">                                      void* closure,</span>
<a href="#l171.136"></a><span id="l171.136">                                      PRBool iterateForwards)</span>
<a href="#l171.137"></a><span id="l171.137" class="difflineminus">-    : mDB(db), mRowCursor(nsnull), mResultHdr(nsnull), mDone(PR_FALSE),</span>
<a href="#l171.138"></a><span id="l171.138" class="difflineminus">-      mFilter(filter), mClosure(closure), mIterateForwards(iterateForwards)</span>
<a href="#l171.139"></a><span id="l171.139" class="difflineminus">-{</span>
<a href="#l171.140"></a><span id="l171.140" class="difflineminus">-    NS_ADDREF(mDB);</span>
<a href="#l171.141"></a><span id="l171.141" class="difflineminus">-    mNextPrefetched = PR_FALSE;</span>
<a href="#l171.142"></a><span id="l171.142" class="difflineminus">-    mTable = table;</span>
<a href="#l171.143"></a><span id="l171.143" class="difflineplus">+    : mDB(db), mDone(PR_FALSE), mFilter(filter),</span>
<a href="#l171.144"></a><span id="l171.144" class="difflineplus">+      mClosure(closure), mIterateForwards(iterateForwards)</span>
<a href="#l171.145"></a><span id="l171.145" class="difflineplus">+{</span>
<a href="#l171.146"></a><span id="l171.146" class="difflineplus">+  mNextPrefetched = PR_FALSE;</span>
<a href="#l171.147"></a><span id="l171.147" class="difflineplus">+  mTable = table;</span>
<a href="#l171.148"></a><span id="l171.148" class="difflineplus">+  mDB-&gt;m_enumerators.AppendElement(this);</span>
<a href="#l171.149"></a><span id="l171.149"> }</span>
<a href="#l171.150"></a><span id="l171.150"> </span>
<a href="#l171.151"></a><span id="l171.151"> nsMsgDBEnumerator::~nsMsgDBEnumerator()</span>
<a href="#l171.152"></a><span id="l171.152"> {</span>
<a href="#l171.153"></a><span id="l171.153" class="difflineminus">-  if (mRowCursor)</span>
<a href="#l171.154"></a><span id="l171.154" class="difflineminus">-    mRowCursor-&gt;Release();</span>
<a href="#l171.155"></a><span id="l171.155" class="difflineplus">+  Clear();</span>
<a href="#l171.156"></a><span id="l171.156" class="difflineplus">+}</span>
<a href="#l171.157"></a><span id="l171.157" class="difflineplus">+</span>
<a href="#l171.158"></a><span id="l171.158" class="difflineplus">+void nsMsgDBEnumerator::Clear()</span>
<a href="#l171.159"></a><span id="l171.159" class="difflineplus">+{</span>
<a href="#l171.160"></a><span id="l171.160" class="difflineplus">+  mRowCursor = nsnull;</span>
<a href="#l171.161"></a><span id="l171.161">   mTable = nsnull;</span>
<a href="#l171.162"></a><span id="l171.162" class="difflineminus">-  NS_IF_RELEASE(mResultHdr);</span>
<a href="#l171.163"></a><span id="l171.163" class="difflineminus">-  NS_RELEASE(mDB);</span>
<a href="#l171.164"></a><span id="l171.164" class="difflineplus">+  mResultHdr = nsnull;</span>
<a href="#l171.165"></a><span id="l171.165" class="difflineplus">+  if (mDB)</span>
<a href="#l171.166"></a><span id="l171.166" class="difflineplus">+    mDB-&gt;m_enumerators.RemoveElement(this);</span>
<a href="#l171.167"></a><span id="l171.167" class="difflineplus">+  mDB = nsnull;</span>
<a href="#l171.168"></a><span id="l171.168"> }</span>
<a href="#l171.169"></a><span id="l171.169"> </span>
<a href="#l171.170"></a><span id="l171.170"> NS_IMPL_ISUPPORTS1(nsMsgDBEnumerator, nsISimpleEnumerator)</span>
<a href="#l171.171"></a><span id="l171.171"> </span>
<a href="#l171.172"></a><span id="l171.172"> nsresult nsMsgDBEnumerator::GetRowCursor()</span>
<a href="#l171.173"></a><span id="l171.173"> {</span>
<a href="#l171.174"></a><span id="l171.174">   mDone = PR_FALSE;</span>
<a href="#l171.175"></a><span id="l171.175"> </span>
<a href="#l171.176"></a><span id="l171.176" class="difflineat">@@ -2561,32 +2552,32 @@ nsresult nsMsgDBEnumerator::GetRowCursor</span>
<a href="#l171.177"></a><span id="l171.177">     startPos = -1;</span>
<a href="#l171.178"></a><span id="l171.178">   }</span>
<a href="#l171.179"></a><span id="l171.179">   else</span>
<a href="#l171.180"></a><span id="l171.180">   {</span>
<a href="#l171.181"></a><span id="l171.181">     mdb_count numRows;</span>
<a href="#l171.182"></a><span id="l171.182">     mTable-&gt;GetCount(mDB-&gt;GetEnv(), &amp;numRows);</span>
<a href="#l171.183"></a><span id="l171.183">     startPos = numRows; // startPos is 0 relative.</span>
<a href="#l171.184"></a><span id="l171.184">   }</span>
<a href="#l171.185"></a><span id="l171.185" class="difflineminus">-  return mTable-&gt;GetTableRowCursor(mDB-&gt;GetEnv(), startPos, &amp;mRowCursor);</span>
<a href="#l171.186"></a><span id="l171.186" class="difflineplus">+  return mTable-&gt;GetTableRowCursor(mDB-&gt;GetEnv(), startPos, getter_AddRefs(mRowCursor));</span>
<a href="#l171.187"></a><span id="l171.187"> }</span>
<a href="#l171.188"></a><span id="l171.188"> </span>
<a href="#l171.189"></a><span id="l171.189"> NS_IMETHODIMP nsMsgDBEnumerator::GetNext(nsISupports **aItem)</span>
<a href="#l171.190"></a><span id="l171.190"> {</span>
<a href="#l171.191"></a><span id="l171.191">   if (!aItem)</span>
<a href="#l171.192"></a><span id="l171.192">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l171.193"></a><span id="l171.193">   nsresult rv = NS_OK;</span>
<a href="#l171.194"></a><span id="l171.194">   if (!mNextPrefetched)</span>
<a href="#l171.195"></a><span id="l171.195">     rv = PrefetchNext();</span>
<a href="#l171.196"></a><span id="l171.196">   if (NS_SUCCEEDED(rv))</span>
<a href="#l171.197"></a><span id="l171.197">   {</span>
<a href="#l171.198"></a><span id="l171.198">     if (mResultHdr)</span>
<a href="#l171.199"></a><span id="l171.199">     {</span>
<a href="#l171.200"></a><span id="l171.200">       *aItem = mResultHdr;</span>
<a href="#l171.201"></a><span id="l171.201" class="difflineminus">-      NS_ADDREF(mResultHdr);</span>
<a href="#l171.202"></a><span id="l171.202" class="difflineplus">+      NS_ADDREF(*aItem);</span>
<a href="#l171.203"></a><span id="l171.203">       mNextPrefetched = PR_FALSE;</span>
<a href="#l171.204"></a><span id="l171.204">     }</span>
<a href="#l171.205"></a><span id="l171.205">   }</span>
<a href="#l171.206"></a><span id="l171.206">   return rv;</span>
<a href="#l171.207"></a><span id="l171.207"> }</span>
<a href="#l171.208"></a><span id="l171.208"> </span>
<a href="#l171.209"></a><span id="l171.209"> nsresult nsMsgDBEnumerator::PrefetchNext()</span>
<a href="#l171.210"></a><span id="l171.210"> {</span>
<a href="#l171.211"></a><span id="l171.211" class="difflineat">@@ -2599,17 +2590,16 @@ nsresult nsMsgDBEnumerator::PrefetchNext</span>
<a href="#l171.212"></a><span id="l171.212">   {</span>
<a href="#l171.213"></a><span id="l171.213">     rv = GetRowCursor();</span>
<a href="#l171.214"></a><span id="l171.214">     if (NS_FAILED(rv))</span>
<a href="#l171.215"></a><span id="l171.215">       return rv;</span>
<a href="#l171.216"></a><span id="l171.216">   }</span>
<a href="#l171.217"></a><span id="l171.217"> </span>
<a href="#l171.218"></a><span id="l171.218">   do</span>
<a href="#l171.219"></a><span id="l171.219">   {</span>
<a href="#l171.220"></a><span id="l171.220" class="difflineminus">-    NS_IF_RELEASE(mResultHdr);</span>
<a href="#l171.221"></a><span id="l171.221">     mResultHdr = nsnull;</span>
<a href="#l171.222"></a><span id="l171.222">     if (mIterateForwards)</span>
<a href="#l171.223"></a><span id="l171.223">       rv = mRowCursor-&gt;NextRow(mDB-&gt;GetEnv(), &amp;hdrRow, &amp;rowPos);</span>
<a href="#l171.224"></a><span id="l171.224">     else</span>
<a href="#l171.225"></a><span id="l171.225">       rv = mRowCursor-&gt;PrevRow(mDB-&gt;GetEnv(), &amp;hdrRow, &amp;rowPos);</span>
<a href="#l171.226"></a><span id="l171.226">     if (!hdrRow)</span>
<a href="#l171.227"></a><span id="l171.227">     {</span>
<a href="#l171.228"></a><span id="l171.228">       mDone = PR_TRUE;</span>
<a href="#l171.229"></a><span id="l171.229" class="difflineat">@@ -2621,21 +2611,21 @@ nsresult nsMsgDBEnumerator::PrefetchNext</span>
<a href="#l171.230"></a><span id="l171.230">       return rv;</span>
<a href="#l171.231"></a><span id="l171.231">     }</span>
<a href="#l171.232"></a><span id="l171.232">     //Get key from row</span>
<a href="#l171.233"></a><span id="l171.233">     mdbOid outOid;</span>
<a href="#l171.234"></a><span id="l171.234">     nsMsgKey key=0;</span>
<a href="#l171.235"></a><span id="l171.235">     if (hdrRow-&gt;GetOid(mDB-&gt;GetEnv(), &amp;outOid) == NS_OK)</span>
<a href="#l171.236"></a><span id="l171.236">       key = outOid.mOid_Id;</span>
<a href="#l171.237"></a><span id="l171.237"> </span>
<a href="#l171.238"></a><span id="l171.238" class="difflineminus">-    rv = mDB-&gt;GetHdrFromUseCache(key, &amp;mResultHdr);</span>
<a href="#l171.239"></a><span id="l171.239" class="difflineplus">+    rv = mDB-&gt;GetHdrFromUseCache(key, getter_AddRefs(mResultHdr));</span>
<a href="#l171.240"></a><span id="l171.240">     if (NS_SUCCEEDED(rv) &amp;&amp; mResultHdr)</span>
<a href="#l171.241"></a><span id="l171.241">       hdrRow-&gt;Release();</span>
<a href="#l171.242"></a><span id="l171.242">     else</span>
<a href="#l171.243"></a><span id="l171.243" class="difflineminus">-      rv = mDB-&gt;CreateMsgHdr(hdrRow, key, &amp;mResultHdr);</span>
<a href="#l171.244"></a><span id="l171.244" class="difflineplus">+      rv = mDB-&gt;CreateMsgHdr(hdrRow, key, getter_AddRefs(mResultHdr));</span>
<a href="#l171.245"></a><span id="l171.245">     if (NS_FAILED(rv))</span>
<a href="#l171.246"></a><span id="l171.246">       return rv;</span>
<a href="#l171.247"></a><span id="l171.247"> </span>
<a href="#l171.248"></a><span id="l171.248">     if (mResultHdr)</span>
<a href="#l171.249"></a><span id="l171.249">       mResultHdr-&gt;GetFlags(&amp;flags);</span>
<a href="#l171.250"></a><span id="l171.250">     else</span>
<a href="#l171.251"></a><span id="l171.251">       flags = 0;</span>
<a href="#l171.252"></a><span id="l171.252">   }</span>
<a href="#l171.253"></a><span id="l171.253" class="difflineat">@@ -2649,18 +2639,18 @@ nsresult nsMsgDBEnumerator::PrefetchNext</span>
<a href="#l171.254"></a><span id="l171.254">   return NS_ERROR_FAILURE;</span>
<a href="#l171.255"></a><span id="l171.255"> }</span>
<a href="#l171.256"></a><span id="l171.256"> </span>
<a href="#l171.257"></a><span id="l171.257"> NS_IMETHODIMP nsMsgDBEnumerator::HasMoreElements(PRBool *aResult)</span>
<a href="#l171.258"></a><span id="l171.258"> {</span>
<a href="#l171.259"></a><span id="l171.259">   if (!aResult)</span>
<a href="#l171.260"></a><span id="l171.260">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l171.261"></a><span id="l171.261"> </span>
<a href="#l171.262"></a><span id="l171.262" class="difflineminus">-  if (!mNextPrefetched)</span>
<a href="#l171.263"></a><span id="l171.263" class="difflineminus">-    PrefetchNext();</span>
<a href="#l171.264"></a><span id="l171.264" class="difflineplus">+  if (!mNextPrefetched &amp;&amp; (NS_FAILED(PrefetchNext())))</span>
<a href="#l171.265"></a><span id="l171.265" class="difflineplus">+    mDone = PR_TRUE;</span>
<a href="#l171.266"></a><span id="l171.266">   *aResult = !mDone;</span>
<a href="#l171.267"></a><span id="l171.267">   return NS_OK;</span>
<a href="#l171.268"></a><span id="l171.268"> }</span>
<a href="#l171.269"></a><span id="l171.269"> </span>
<a href="#l171.270"></a><span id="l171.270"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l171.271"></a><span id="l171.271"> </span>
<a href="#l171.272"></a><span id="l171.272"> NS_IMETHODIMP</span>
<a href="#l171.273"></a><span id="l171.273"> nsMsgDatabase::EnumerateMessages(nsISimpleEnumerator* *result)</span>
<a href="#l171.274"></a><span id="l171.274" class="difflineat">@@ -3820,16 +3810,17 @@ nsresult nsMsgDatabase::CreateNewThread(</span>
<a href="#l171.275"></a><span id="l171.275"> #endif</span>
<a href="#l171.276"></a><span id="l171.276">     threadRow-&gt;CutAllColumns(GetEnv());</span>
<a href="#l171.277"></a><span id="l171.277">     nsCOMPtr&lt;nsIMdbRow&gt; metaRow;</span>
<a href="#l171.278"></a><span id="l171.278">     threadTable-&gt;GetMetaRow(GetEnv(), nsnull, nsnull, getter_AddRefs(metaRow));</span>
<a href="#l171.279"></a><span id="l171.279">     if (metaRow)</span>
<a href="#l171.280"></a><span id="l171.280">       metaRow-&gt;CutAllColumns(GetEnv());</span>
<a href="#l171.281"></a><span id="l171.281"> </span>
<a href="#l171.282"></a><span id="l171.282">     CharPtrToRowCellColumn(threadRow, m_threadSubjectColumnToken, subject);</span>
<a href="#l171.283"></a><span id="l171.283" class="difflineplus">+    threadRow-&gt;Release();</span>
<a href="#l171.284"></a><span id="l171.284">   }</span>
<a href="#l171.285"></a><span id="l171.285"> </span>
<a href="#l171.286"></a><span id="l171.286"> </span>
<a href="#l171.287"></a><span id="l171.287">   *pnewThread = new nsMsgThread(this, threadTable);</span>
<a href="#l171.288"></a><span id="l171.288">   if (*pnewThread)</span>
<a href="#l171.289"></a><span id="l171.289">   {</span>
<a href="#l171.290"></a><span id="l171.290">     (*pnewThread)-&gt;SetThreadKey(threadId);</span>
<a href="#l171.291"></a><span id="l171.291">      m_cachedThread = *pnewThread;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l172.1"></a><span id="l172.1" class="difflineminus">--- a/mailnews/db/msgdb/src/nsMsgThread.cpp</span>
<a href="#l172.2"></a><span id="l172.2" class="difflineplus">+++ b/mailnews/db/msgdb/src/nsMsgThread.cpp</span>
<a href="#l172.3"></a><span id="l172.3" class="difflineat">@@ -42,17 +42,16 @@</span>
<a href="#l172.4"></a><span id="l172.4"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l172.5"></a><span id="l172.5"> #include &quot;MailNewsTypes2.h&quot;</span>
<a href="#l172.6"></a><span id="l172.6"> </span>
<a href="#l172.7"></a><span id="l172.7"> NS_IMPL_ISUPPORTS1(nsMsgThread, nsIMsgThread)</span>
<a href="#l172.8"></a><span id="l172.8"> </span>
<a href="#l172.9"></a><span id="l172.9"> </span>
<a href="#l172.10"></a><span id="l172.10"> nsMsgThread::nsMsgThread()</span>
<a href="#l172.11"></a><span id="l172.11"> {</span>
<a href="#l172.12"></a><span id="l172.12" class="difflineminus">-</span>
<a href="#l172.13"></a><span id="l172.13">   MOZ_COUNT_CTOR(nsMsgThread);</span>
<a href="#l172.14"></a><span id="l172.14">   Init();</span>
<a href="#l172.15"></a><span id="l172.15"> }</span>
<a href="#l172.16"></a><span id="l172.16"> nsMsgThread::nsMsgThread(nsMsgDatabase *db, nsIMdbTable *table)</span>
<a href="#l172.17"></a><span id="l172.17"> {</span>
<a href="#l172.18"></a><span id="l172.18">   MOZ_COUNT_CTOR(nsMsgThread);</span>
<a href="#l172.19"></a><span id="l172.19">   Init();</span>
<a href="#l172.20"></a><span id="l172.20">   m_mdbTable = table;</span>
<a href="#l172.21"></a><span id="l172.21" class="difflineat">@@ -82,20 +81,20 @@ void nsMsgThread::Init()</span>
<a href="#l172.22"></a><span id="l172.22"> }</span>
<a href="#l172.23"></a><span id="l172.23"> </span>
<a href="#l172.24"></a><span id="l172.24"> </span>
<a href="#l172.25"></a><span id="l172.25"> nsMsgThread::~nsMsgThread()</span>
<a href="#l172.26"></a><span id="l172.26"> {</span>
<a href="#l172.27"></a><span id="l172.27">   MOZ_COUNT_DTOR(nsMsgThread);</span>
<a href="#l172.28"></a><span id="l172.28">   if (m_mdbTable)</span>
<a href="#l172.29"></a><span id="l172.29">     m_mdbTable-&gt;Release();</span>
<a href="#l172.30"></a><span id="l172.30" class="difflineplus">+  if (m_metaRow)</span>
<a href="#l172.31"></a><span id="l172.31" class="difflineplus">+    m_metaRow-&gt;Release();</span>
<a href="#l172.32"></a><span id="l172.32">   if (m_mdbDB)</span>
<a href="#l172.33"></a><span id="l172.33">     m_mdbDB-&gt;Release();</span>
<a href="#l172.34"></a><span id="l172.34" class="difflineminus">-  if (m_metaRow)</span>
<a href="#l172.35"></a><span id="l172.35" class="difflineminus">-    m_metaRow-&gt;Release();</span>
<a href="#l172.36"></a><span id="l172.36"> }</span>
<a href="#l172.37"></a><span id="l172.37"> </span>
<a href="#l172.38"></a><span id="l172.38"> nsresult nsMsgThread::InitCachedValues()</span>
<a href="#l172.39"></a><span id="l172.39"> {</span>
<a href="#l172.40"></a><span id="l172.40">   nsresult err = NS_OK;</span>
<a href="#l172.41"></a><span id="l172.41"> </span>
<a href="#l172.42"></a><span id="l172.42">   NS_ENSURE_TRUE(m_mdbDB &amp;&amp; m_metaRow, NS_ERROR_INVALID_POINTER);</span>
<a href="#l172.43"></a><span id="l172.43"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l173.1"></a><span id="l173.1">new file mode 100644</span>
<a href="#l173.2"></a><span id="l173.2" class="difflineminus">--- /dev/null</span>
<a href="#l173.3"></a><span id="l173.3" class="difflineplus">+++ b/mailnews/db/msgdb/test/unit/tail_msgdb.js</span>
<a href="#l173.4"></a><span id="l173.4" class="difflineat">@@ -0,0 +1,1 @@</span>
<a href="#l173.5"></a><span id="l173.5" class="difflineplus">+load(&quot;../../mailnews/resources/mailShutdown.js&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l174.1"></a><span id="l174.1">new file mode 100644</span>
<a href="#l174.2"></a><span id="l174.2" class="difflineminus">--- /dev/null</span>
<a href="#l174.3"></a><span id="l174.3" class="difflineplus">+++ b/mailnews/db/msgdb/test/unit/test_enumerator_cleanup.js</span>
<a href="#l174.4"></a><span id="l174.4" class="difflineat">@@ -0,0 +1,47 @@</span>
<a href="#l174.5"></a><span id="l174.5" class="difflineplus">+/*</span>
<a href="#l174.6"></a><span id="l174.6" class="difflineplus">+ * Test nsMsgDatabase's cleanup of nsMsgDBEnumerators</span>
<a href="#l174.7"></a><span id="l174.7" class="difflineplus">+ */</span>
<a href="#l174.8"></a><span id="l174.8" class="difflineplus">+</span>
<a href="#l174.9"></a><span id="l174.9" class="difflineplus">+const copyService = Cc[&quot;@mozilla.org/messenger/messagecopyservice;1&quot;]</span>
<a href="#l174.10"></a><span id="l174.10" class="difflineplus">+                      .getService(Ci.nsIMsgCopyService);</span>
<a href="#l174.11"></a><span id="l174.11" class="difflineplus">+const anyOldMessage = do_get_file(&quot;../../mailnews/data/bugmail1&quot;);</span>
<a href="#l174.12"></a><span id="l174.12" class="difflineplus">+</span>
<a href="#l174.13"></a><span id="l174.13" class="difflineplus">+/**</span>
<a href="#l174.14"></a><span id="l174.14" class="difflineplus">+ * Test closing a db with an outstanding enumerator.</span>
<a href="#l174.15"></a><span id="l174.15" class="difflineplus">+ */</span>
<a href="#l174.16"></a><span id="l174.16" class="difflineplus">+function test_enumerator_cleanup() {</span>
<a href="#l174.17"></a><span id="l174.17" class="difflineplus">+  let db = gLocalInboxFolder.msgDatabase;</span>
<a href="#l174.18"></a><span id="l174.18" class="difflineplus">+  let enumerator = db.EnumerateMessages();</span>
<a href="#l174.19"></a><span id="l174.19" class="difflineplus">+  db.forceFolderDBClosed(gLocalInboxFolder);</span>
<a href="#l174.20"></a><span id="l174.20" class="difflineplus">+  gLocalInboxFolder.msgDatabase = null;</span>
<a href="#l174.21"></a><span id="l174.21" class="difflineplus">+  db = null;</span>
<a href="#l174.22"></a><span id="l174.22" class="difflineplus">+  gc();</span>
<a href="#l174.23"></a><span id="l174.23" class="difflineplus">+  while (enumerator.hasMoreElements())</span>
<a href="#l174.24"></a><span id="l174.24" class="difflineplus">+    var header = enumerator.getNext();</span>
<a href="#l174.25"></a><span id="l174.25" class="difflineplus">+</span>
<a href="#l174.26"></a><span id="l174.26" class="difflineplus">+  do_test_finished();</span>
<a href="#l174.27"></a><span id="l174.27" class="difflineplus">+}</span>
<a href="#l174.28"></a><span id="l174.28" class="difflineplus">+</span>
<a href="#l174.29"></a><span id="l174.29" class="difflineplus">+/*</span>
<a href="#l174.30"></a><span id="l174.30" class="difflineplus">+ * This infrastructure down here exists just to get</span>
<a href="#l174.31"></a><span id="l174.31" class="difflineplus">+ *  test_references_header_parsing its message header.</span>
<a href="#l174.32"></a><span id="l174.32" class="difflineplus">+ */</span>
<a href="#l174.33"></a><span id="l174.33" class="difflineplus">+</span>
<a href="#l174.34"></a><span id="l174.34" class="difflineplus">+function run_test() {</span>
<a href="#l174.35"></a><span id="l174.35" class="difflineplus">+  loadLocalMailAccount();</span>
<a href="#l174.36"></a><span id="l174.36" class="difflineplus">+  do_test_pending();</span>
<a href="#l174.37"></a><span id="l174.37" class="difflineplus">+  copyService.CopyFileMessage(anyOldMessage, gLocalInboxFolder, null, false, 0,</span>
<a href="#l174.38"></a><span id="l174.38" class="difflineplus">+                              &quot;&quot;, messageHeaderGetterListener, null);</span>
<a href="#l174.39"></a><span id="l174.39" class="difflineplus">+  return true;</span>
<a href="#l174.40"></a><span id="l174.40" class="difflineplus">+}</span>
<a href="#l174.41"></a><span id="l174.41" class="difflineplus">+</span>
<a href="#l174.42"></a><span id="l174.42" class="difflineplus">+var messageHeaderGetterListener = {</span>
<a href="#l174.43"></a><span id="l174.43" class="difflineplus">+  OnStartCopy: function() {},</span>
<a href="#l174.44"></a><span id="l174.44" class="difflineplus">+  OnProgress: function(aProgress, aProgressMax) {},</span>
<a href="#l174.45"></a><span id="l174.45" class="difflineplus">+  GetMessageId: function (aMessageId) {},</span>
<a href="#l174.46"></a><span id="l174.46" class="difflineplus">+  SetMessageKey: function(aKey) {</span>
<a href="#l174.47"></a><span id="l174.47" class="difflineplus">+  },</span>
<a href="#l174.48"></a><span id="l174.48" class="difflineplus">+  OnStopCopy: function(aStatus) {</span>
<a href="#l174.49"></a><span id="l174.49" class="difflineplus">+    do_timeout(0, &quot;test_enumerator_cleanup();&quot;);</span>
<a href="#l174.50"></a><span id="l174.50" class="difflineplus">+  }</span>
<a href="#l174.51"></a><span id="l174.51" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l175.1"></a><span id="l175.1" class="difflineminus">--- a/mailnews/db/msgdb/test/unit/test_propertyEnumerator.js</span>
<a href="#l175.2"></a><span id="l175.2" class="difflineplus">+++ b/mailnews/db/msgdb/test/unit/test_propertyEnumerator.js</span>
<a href="#l175.3"></a><span id="l175.3" class="difflineat">@@ -88,10 +88,11 @@ function continue_test()</span>
<a href="#l175.4"></a><span id="l175.4">     //dump(&quot;\nProperty 2 is &quot; + property);</span>
<a href="#l175.5"></a><span id="l175.5">     properties.push(property);</span>
<a href="#l175.6"></a><span id="l175.6">   }</span>
<a href="#l175.7"></a><span id="l175.7">   do_check_true(properties.indexOf(&quot;flags&quot;) &gt;= 0);</span>
<a href="#l175.8"></a><span id="l175.8">   do_check_true(properties.indexOf(&quot;size&quot;) &gt;= 0);</span>
<a href="#l175.9"></a><span id="l175.9">   do_check_true(properties.indexOf(&quot;iamnew&quot;) &gt;= 0);</span>
<a href="#l175.10"></a><span id="l175.10">   do_check_true(properties.indexOf(&quot;idonotexist&quot;) &lt; 0);</span>
<a href="#l175.11"></a><span id="l175.11"> </span>
<a href="#l175.12"></a><span id="l175.12" class="difflineplus">+  gHdr = null;</span>
<a href="#l175.13"></a><span id="l175.13">   do_test_finished();</span>
<a href="#l175.14"></a><span id="l175.14"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l176.1"></a><span id="l176.1">new file mode 100644</span>
<a href="#l176.2"></a><span id="l176.2" class="difflineminus">--- /dev/null</span>
<a href="#l176.3"></a><span id="l176.3" class="difflineplus">+++ b/mailnews/extensions/bayesian-spam-filter/test/unit/tail_bayesian.js</span>
<a href="#l176.4"></a><span id="l176.4" class="difflineat">@@ -0,0 +1,1 @@</span>
<a href="#l176.5"></a><span id="l176.5" class="difflineplus">+load(&quot;../../mailnews/resources/mailShutdown.js&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l177.1"></a><span id="l177.1" class="difflineminus">--- a/mailnews/extensions/newsblog/content/Feed.js</span>
<a href="#l177.2"></a><span id="l177.2" class="difflineplus">+++ b/mailnews/extensions/newsblog/content/Feed.js</span>
<a href="#l177.3"></a><span id="l177.3" class="difflineat">@@ -42,31 +42,36 @@ const kNewsBlogInvalidFeed = 1; // usual</span>
<a href="#l177.4"></a><span id="l177.4"> const kNewsBlogRequestFailure = 2; // generic networking failure when trying to download the feed.</span>
<a href="#l177.5"></a><span id="l177.5"> const kNewsBlogFeedIsBusy = 3;</span>
<a href="#l177.6"></a><span id="l177.6"> const kNewsBlogNoNewItems = 4; // there are no new articles for this feed</span>
<a href="#l177.7"></a><span id="l177.7"> </span>
<a href="#l177.8"></a><span id="l177.8"> // Cache for all of the feeds currently being downloaded, indexed by URL, so the load event listener</span>
<a href="#l177.9"></a><span id="l177.9"> // can access the Feed objects after it finishes downloading the feed.</span>
<a href="#l177.10"></a><span id="l177.10"> var FeedCache = </span>
<a href="#l177.11"></a><span id="l177.11"> {</span>
<a href="#l177.12"></a><span id="l177.12" class="difflineminus">-  mFeeds: new Array(),</span>
<a href="#l177.13"></a><span id="l177.13" class="difflineplus">+  mFeeds: {},</span>
<a href="#l177.14"></a><span id="l177.14"> </span>
<a href="#l177.15"></a><span id="l177.15">   putFeed: function (aFeed)</span>
<a href="#l177.16"></a><span id="l177.16">   {</span>
<a href="#l177.17"></a><span id="l177.17">     this.mFeeds[this.normalizeHost(aFeed.url)] = aFeed;</span>
<a href="#l177.18"></a><span id="l177.18">   },</span>
<a href="#l177.19"></a><span id="l177.19"> </span>
<a href="#l177.20"></a><span id="l177.20">   getFeed: function (aUrl)</span>
<a href="#l177.21"></a><span id="l177.21">   {</span>
<a href="#l177.22"></a><span id="l177.22" class="difflineminus">-    return this.mFeeds[this.normalizeHost(aUrl)];</span>
<a href="#l177.23"></a><span id="l177.23" class="difflineplus">+    var index = this.normalizeHost(aUrl);</span>
<a href="#l177.24"></a><span id="l177.24" class="difflineplus">+    if (index in this.mFeeds)</span>
<a href="#l177.25"></a><span id="l177.25" class="difflineplus">+      return this.mFeeds[index];</span>
<a href="#l177.26"></a><span id="l177.26" class="difflineplus">+    return null;</span>
<a href="#l177.27"></a><span id="l177.27">   },</span>
<a href="#l177.28"></a><span id="l177.28"> </span>
<a href="#l177.29"></a><span id="l177.29">   removeFeed: function (aUrl)</span>
<a href="#l177.30"></a><span id="l177.30">   {</span>
<a href="#l177.31"></a><span id="l177.31" class="difflineminus">-    delete this.mFeeds[this.normalizeHost(aUrl)];</span>
<a href="#l177.32"></a><span id="l177.32" class="difflineplus">+    var index = this.normalizeHost(aUrl);</span>
<a href="#l177.33"></a><span id="l177.33" class="difflineplus">+    if (index in this.mFeeds)</span>
<a href="#l177.34"></a><span id="l177.34" class="difflineplus">+      delete this.mFeeds[index];</span>
<a href="#l177.35"></a><span id="l177.35">   },</span>
<a href="#l177.36"></a><span id="l177.36"> </span>
<a href="#l177.37"></a><span id="l177.37">   normalizeHost: function (aUrl)</span>
<a href="#l177.38"></a><span id="l177.38">   {</span>
<a href="#l177.39"></a><span id="l177.39">     var ioService = Components.classes[&quot;@mozilla.org/network/io-service;1&quot;].</span>
<a href="#l177.40"></a><span id="l177.40">                     getService(Components.interfaces.nsIIOService);</span>
<a href="#l177.41"></a><span id="l177.41">     var normalizedUrl = ioService.newURI(aUrl, null, null);</span>
<a href="#l177.42"></a><span id="l177.42">     normalizedUrl.host = normalizedUrl.host.toLowerCase();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l178.1"></a><span id="l178.1" class="difflineminus">--- a/mailnews/extensions/newsblog/js/newsblog.js</span>
<a href="#l178.2"></a><span id="l178.2" class="difflineplus">+++ b/mailnews/extensions/newsblog/js/newsblog.js</span>
<a href="#l178.3"></a><span id="l178.3" class="difflineat">@@ -390,17 +390,17 @@ function loadScripts()</span>
<a href="#l178.4"></a><span id="l178.4"> //                           this number may not reflect the # of entries in our mFeeds array because not all</span>
<a href="#l178.5"></a><span id="l178.5"> //                           feeds may have reported in for the first time...</span>
<a href="#l178.6"></a><span id="l178.6"> var gNumPendingFeedDownloads = 0;</span>
<a href="#l178.7"></a><span id="l178.7"> </span>
<a href="#l178.8"></a><span id="l178.8"> var progressNotifier = {</span>
<a href="#l178.9"></a><span id="l178.9">   mSubscribeMode: false,</span>
<a href="#l178.10"></a><span id="l178.10">   mMsgWindow: null, </span>
<a href="#l178.11"></a><span id="l178.11">   mStatusFeedback: null,</span>
<a href="#l178.12"></a><span id="l178.12" class="difflineminus">-  mFeeds: new Array,</span>
<a href="#l178.13"></a><span id="l178.13" class="difflineplus">+  mFeeds: {},</span>
<a href="#l178.14"></a><span id="l178.14"> </span>
<a href="#l178.15"></a><span id="l178.15">   init: function(aMsgWindow, aSubscribeMode)</span>
<a href="#l178.16"></a><span id="l178.16">   {</span>
<a href="#l178.17"></a><span id="l178.17">     if (!gNumPendingFeedDownloads) // if we aren't already in the middle of downloading feed items...</span>
<a href="#l178.18"></a><span id="l178.18">     {</span>
<a href="#l178.19"></a><span id="l178.19">       this.mStatusFeedback = aMsgWindow ? aMsgWindow.statusFeedback : null;</span>
<a href="#l178.20"></a><span id="l178.20">       this.mSubscribeMode = aSubscribeMode;</span>
<a href="#l178.21"></a><span id="l178.21">       this.mMsgWindow = aMsgWindow;</span>
<a href="#l178.22"></a><span id="l178.22" class="difflineat">@@ -440,21 +440,19 @@ var progressNotifier = {</span>
<a href="#l178.23"></a><span id="l178.23">         this.mStatusFeedback.showStatusString(</span>
<a href="#l178.24"></a><span id="l178.24">           newsBlogBundle.formatStringFromName(&quot;newsblog-feedNotValid&quot;, [feed.url], 1));</span>
<a href="#l178.25"></a><span id="l178.25">       else if (aErrorCode == kNewsBlogRequestFailure)</span>
<a href="#l178.26"></a><span id="l178.26">         this.mStatusFeedback.showStatusString(newsBlogBundle.formatStringFromName(&quot;newsblog-networkError&quot;,</span>
<a href="#l178.27"></a><span id="l178.27">                                               [feed.url], 1));                                           </span>
<a href="#l178.28"></a><span id="l178.28">       this.mStatusFeedback.stopMeteors();</span>
<a href="#l178.29"></a><span id="l178.29">     }</span>
<a href="#l178.30"></a><span id="l178.30"> </span>
<a href="#l178.31"></a><span id="l178.31" class="difflineminus">-    gNumPendingFeedDownloads--;</span>
<a href="#l178.32"></a><span id="l178.32" class="difflineminus">-</span>
<a href="#l178.33"></a><span id="l178.33" class="difflineminus">-    if (!gNumPendingFeedDownloads)</span>
<a href="#l178.34"></a><span id="l178.34" class="difflineplus">+    if (!--gNumPendingFeedDownloads)</span>
<a href="#l178.35"></a><span id="l178.35">     {</span>
<a href="#l178.36"></a><span id="l178.36" class="difflineminus">-      this.mFeeds = new Array;</span>
<a href="#l178.37"></a><span id="l178.37" class="difflineplus">+      this.mFeeds = {};</span>
<a href="#l178.38"></a><span id="l178.38"> </span>
<a href="#l178.39"></a><span id="l178.39">       this.mSubscribeMode = false;</span>
<a href="#l178.40"></a><span id="l178.40"> </span>
<a href="#l178.41"></a><span id="l178.41">       // should we do this on a timer so the text sticks around for a little while? </span>
<a href="#l178.42"></a><span id="l178.42">       // It doesnt look like we do it on a timer for newsgroups so we'll follow that model.</span>
<a href="#l178.43"></a><span id="l178.43">       if (aErrorCode == kNewsBlogSuccess &amp;&amp; this.mStatusFeedback) // don't clear the status text if we just dumped an error to the status bar!</span>
<a href="#l178.44"></a><span id="l178.44">         this.mStatusFeedback.showStatusString(&quot;&quot;);</span>
<a href="#l178.45"></a><span id="l178.45">     }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l179.1"></a><span id="l179.1" class="difflineminus">--- a/mailnews/imap/public/nsIImapMailFolderSink.idl</span>
<a href="#l179.2"></a><span id="l179.2" class="difflineplus">+++ b/mailnews/imap/public/nsIImapMailFolderSink.idl</span>
<a href="#l179.3"></a><span id="l179.3" class="difflineat">@@ -59,17 +59,17 @@ interface ImapOnlineCopyStateType</span>
<a href="#l179.4"></a><span id="l179.4">    const long kFailedDelete = 4;</span>
<a href="#l179.5"></a><span id="l179.5">    const long kReadyForAppendData = 5;</span>
<a href="#l179.6"></a><span id="l179.6">    const long kFailedAppend = 6;</span>
<a href="#l179.7"></a><span id="l179.7">    const long kInterruptedState = 7;</span>
<a href="#l179.8"></a><span id="l179.8">    const long kFailedCopy = 8;</span>
<a href="#l179.9"></a><span id="l179.9">    const long kFailedMove = 9;</span>
<a href="#l179.10"></a><span id="l179.10"> };</span>
<a href="#l179.11"></a><span id="l179.11"> </span>
<a href="#l179.12"></a><span id="l179.12" class="difflineminus">-[scriptable, uuid(471adbb6-95c2-4a5f-b98e-0055804fce48)]</span>
<a href="#l179.13"></a><span id="l179.13" class="difflineplus">+[scriptable, uuid(531d4a3a-4921-4b7d-a46d-c66be8bec781)]</span>
<a href="#l179.14"></a><span id="l179.14"> interface nsIImapMailFolderSink : nsISupports {</span>
<a href="#l179.15"></a><span id="l179.15">   attribute boolean folderNeedsACLListed;</span>
<a href="#l179.16"></a><span id="l179.16">   attribute boolean folderNeedsSubscribing;</span>
<a href="#l179.17"></a><span id="l179.17">   attribute boolean folderNeedsAdded;</span>
<a href="#l179.18"></a><span id="l179.18">   attribute unsigned long aclFlags;</span>
<a href="#l179.19"></a><span id="l179.19">   attribute long uidValidity;</span>
<a href="#l179.20"></a><span id="l179.20">   /**</span>
<a href="#l179.21"></a><span id="l179.21">    * Whether we have asked the server for this folder's quota information.</span>
<a href="#l179.22"></a><span id="l179.22" class="difflineat">@@ -108,17 +108,17 @@ interface nsIImapMailFolderSink : nsISup</span>
<a href="#l179.23"></a><span id="l179.23">   void closeMockChannel(in nsIImapMockChannel aChannel);</span>
<a href="#l179.24"></a><span id="l179.24">   void setUrlState(in nsIImapProtocol aProtocol, in nsIMsgMailNewsUrl aUrl, in boolean isRunning, in nsresult status);</span>
<a href="#l179.25"></a><span id="l179.25">   void releaseUrlCacheEntry(in nsIMsgMailNewsUrl aUrl);</span>
<a href="#l179.26"></a><span id="l179.26"> </span>
<a href="#l179.27"></a><span id="l179.27">   void headerFetchCompleted(in nsIImapProtocol aProtocol);</span>
<a href="#l179.28"></a><span id="l179.28">   void setBiffStateAndUpdate(in long biffState);</span>
<a href="#l179.29"></a><span id="l179.29">   void progressStatus(in nsIImapProtocol aProtocol, in unsigned long aMsgId, in wstring extraInfo);</span>
<a href="#l179.30"></a><span id="l179.30">   void percentProgress(in nsIImapProtocol aProtocol, in wstring aMessage, </span>
<a href="#l179.31"></a><span id="l179.31" class="difflineminus">-                       in long aCurrentProgress, in long aMaxProgressProgressInfo);</span>
<a href="#l179.32"></a><span id="l179.32" class="difflineplus">+                       in long long aCurrentProgress, in long long aMaxProgressProgressInfo);</span>
<a href="#l179.33"></a><span id="l179.33"> </span>
<a href="#l179.34"></a><span id="l179.34">   void clearFolderRights();</span>
<a href="#l179.35"></a><span id="l179.35">   void setCopyResponseUid(in string msgIdString,</span>
<a href="#l179.36"></a><span id="l179.36">                                 in nsIImapUrl aUrl);</span>
<a href="#l179.37"></a><span id="l179.37">   void setAppendMsgUid(in nsMsgKey newKey,</span>
<a href="#l179.38"></a><span id="l179.38">                              in nsIImapUrl aUrl);</span>
<a href="#l179.39"></a><span id="l179.39">   ACString getMessageId(in nsIImapUrl aUrl);</span>
<a href="#l179.40"></a><span id="l179.40"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l180.1"></a><span id="l180.1" class="difflineminus">--- a/mailnews/imap/public/nsIMsgImapMailFolder.idl</span>
<a href="#l180.2"></a><span id="l180.2" class="difflineplus">+++ b/mailnews/imap/public/nsIMsgImapMailFolder.idl</span>
<a href="#l180.3"></a><span id="l180.3" class="difflineat">@@ -101,17 +101,17 @@ interface nsIMsgImapMailFolder : nsISupp</span>
<a href="#l180.4"></a><span id="l180.4">   void fillInFolderProps(in nsIMsgImapFolderProps aFolderProps);</span>
<a href="#l180.5"></a><span id="l180.5">   void resetNamespaceReferences();</span>
<a href="#l180.6"></a><span id="l180.6">   void folderPrivileges(in nsIMsgWindow aWindow);</span>
<a href="#l180.7"></a><span id="l180.7">   nsIMsgImapMailFolder findOnlineSubFolder(in ACString onlineName);</span>
<a href="#l180.8"></a><span id="l180.8">   void addFolderRights(in ACString userName, in ACString rights);</span>
<a href="#l180.9"></a><span id="l180.9">   void refreshFolderRights();</span>
<a href="#l180.10"></a><span id="l180.10"> </span>
<a href="#l180.11"></a><span id="l180.11">   void updateStatus(in nsIUrlListener aListener, in nsIMsgWindow aMsgWindow);</span>
<a href="#l180.12"></a><span id="l180.12" class="difflineminus">-  void updateFolder(in nsIMsgWindow aWindow, in nsIUrlListener aListener);</span>
<a href="#l180.13"></a><span id="l180.13" class="difflineplus">+  void updateFolderWithListener(in nsIMsgWindow aMsgWindow, in nsIUrlListener aListener);</span>
<a href="#l180.14"></a><span id="l180.14">   // this is used to issue an arbitrary imap command on the passed in msgs.</span>
<a href="#l180.15"></a><span id="l180.15">   // It assumes the command needs to be run in the selected state.</span>
<a href="#l180.16"></a><span id="l180.16">   nsIURI issueCommandOnMsgs(in ACString command, in string uids, in nsIMsgWindow aWindow);</span>
<a href="#l180.17"></a><span id="l180.17">   nsIURI fetchCustomMsgAttribute(in ACString msgAttribute, in string uids, in nsIMsgWindow aWindow);</span>
<a href="#l180.18"></a><span id="l180.18">   nsIURI storeCustomKeywords(in nsIMsgWindow aMsgWindow,</span>
<a href="#l180.19"></a><span id="l180.19">                       in ACString aFlagsToAdd,</span>
<a href="#l180.20"></a><span id="l180.20">                       in ACString aFlagsToSubtract,</span>
<a href="#l180.21"></a><span id="l180.21">                       [array, size_is (aNumKeys)] in nsMsgKey aKeysToStore,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l181.1"></a><span id="l181.1" class="difflineminus">--- a/mailnews/imap/src/nsAutoSyncState.cpp</span>
<a href="#l181.2"></a><span id="l181.2" class="difflineplus">+++ b/mailnews/imap/src/nsAutoSyncState.cpp</span>
<a href="#l181.3"></a><span id="l181.3" class="difflineat">@@ -471,17 +471,17 @@ NS_IMETHODIMP nsAutoSyncState::OnStopRun</span>
<a href="#l181.4"></a><span id="l181.4">       nsCString folderName;</span>
<a href="#l181.5"></a><span id="l181.5">       ownerFolder-&gt;GetURI(folderName);</span>
<a href="#l181.6"></a><span id="l181.6">       printf(&quot;folder %s status changed serverNextUID = %lx lastNextUID = %lx\n&quot;, folderName.get(),</span>
<a href="#l181.7"></a><span id="l181.7">              serverNextUID, mLastNextUID);</span>
<a href="#l181.8"></a><span id="l181.8">       printf(&quot;serverTotal = %lx lastServerTotal = %lx serverRecent = %lx lastServerRecent = %lx\n&quot;,</span>
<a href="#l181.9"></a><span id="l181.9">         serverTotal, mLastServerTotal, serverRecent, mLastServerRecent);</span>
<a href="#l181.10"></a><span id="l181.10"> #endif</span>
<a href="#l181.11"></a><span id="l181.11">       mSyncState = nsAutoSyncState::stUpdateIssued;</span>
<a href="#l181.12"></a><span id="l181.12" class="difflineminus">-      return imapFolder-&gt;UpdateFolder(nsnull, autoSyncMgrListener);</span>
<a href="#l181.13"></a><span id="l181.13" class="difflineplus">+      return imapFolder-&gt;UpdateFolderWithListener(nsnull, autoSyncMgrListener);</span>
<a href="#l181.14"></a><span id="l181.14">     }</span>
<a href="#l181.15"></a><span id="l181.15">     else</span>
<a href="#l181.16"></a><span id="l181.16">     {</span>
<a href="#l181.17"></a><span id="l181.17">       ownerFolder-&gt;SetMsgDatabase(nsnull);</span>
<a href="#l181.18"></a><span id="l181.18">       // nothing more to do.</span>
<a href="#l181.19"></a><span id="l181.19">       mSyncState = nsAutoSyncState::stCompletedIdle;</span>
<a href="#l181.20"></a><span id="l181.20">       // autoSyncMgr needs this notification, so manufacture it.</span>
<a href="#l181.21"></a><span id="l181.21">       return autoSyncMgrListener-&gt;OnStopRunningUrl(nsnull, NS_OK);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l182.1"></a><span id="l182.1" class="difflineminus">--- a/mailnews/imap/src/nsImapMailFolder.cpp</span>
<a href="#l182.2"></a><span id="l182.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapMailFolder.cpp</span>
<a href="#l182.3"></a><span id="l182.3" class="difflineat">@@ -679,31 +679,31 @@ nsresult nsImapMailFolder::GetDatabase()</span>
<a href="#l182.4"></a><span id="l182.4">       mDatabase = database;</span>
<a href="#l182.5"></a><span id="l182.5">     }</span>
<a href="#l182.6"></a><span id="l182.6">   }</span>
<a href="#l182.7"></a><span id="l182.7">   return rv;</span>
<a href="#l182.8"></a><span id="l182.8"> }</span>
<a href="#l182.9"></a><span id="l182.9"> </span>
<a href="#l182.10"></a><span id="l182.10"> NS_IMETHODIMP nsImapMailFolder::UpdateFolder(nsIMsgWindow * inMsgWindow)</span>
<a href="#l182.11"></a><span id="l182.11"> {</span>
<a href="#l182.12"></a><span id="l182.12" class="difflineminus">-  return UpdateFolder(inMsgWindow, nsnull);</span>
<a href="#l182.13"></a><span id="l182.13" class="difflineminus">-}</span>
<a href="#l182.14"></a><span id="l182.14" class="difflineminus">-</span>
<a href="#l182.15"></a><span id="l182.15" class="difflineminus">-NS_IMETHODIMP nsImapMailFolder::UpdateFolder(nsIMsgWindow *msgWindow, nsIUrlListener *aUrlListener)</span>
<a href="#l182.16"></a><span id="l182.16" class="difflineplus">+  return UpdateFolderWithListener(inMsgWindow, nsnull);</span>
<a href="#l182.17"></a><span id="l182.17" class="difflineplus">+}</span>
<a href="#l182.18"></a><span id="l182.18" class="difflineplus">+</span>
<a href="#l182.19"></a><span id="l182.19" class="difflineplus">+NS_IMETHODIMP nsImapMailFolder::UpdateFolderWithListener(nsIMsgWindow *aMsgWindow, nsIUrlListener *aUrlListener)</span>
<a href="#l182.20"></a><span id="l182.20"> {</span>
<a href="#l182.21"></a><span id="l182.21">   nsresult rv;</span>
<a href="#l182.22"></a><span id="l182.22">   PRBool selectFolder = PR_FALSE;</span>
<a href="#l182.23"></a><span id="l182.23"> </span>
<a href="#l182.24"></a><span id="l182.24">   if (mFlags &amp; nsMsgFolderFlags::Inbox)</span>
<a href="#l182.25"></a><span id="l182.25">   {</span>
<a href="#l182.26"></a><span id="l182.26">     if (!m_filterList)</span>
<a href="#l182.27"></a><span id="l182.27" class="difflineminus">-      rv = GetFilterList(msgWindow, getter_AddRefs(m_filterList));</span>
<a href="#l182.28"></a><span id="l182.28" class="difflineplus">+      rv = GetFilterList(aMsgWindow, getter_AddRefs(m_filterList));</span>
<a href="#l182.29"></a><span id="l182.29">     // if there's no msg window, but someone is updating the inbox, we're</span>
<a href="#l182.30"></a><span id="l182.30">     // doing something biff-like, and may download headers, so make biff notify.</span>
<a href="#l182.31"></a><span id="l182.31" class="difflineminus">-    if (!msgWindow)</span>
<a href="#l182.32"></a><span id="l182.32" class="difflineplus">+    if (!aMsgWindow)</span>
<a href="#l182.33"></a><span id="l182.33">       SetPerformingBiff(PR_TRUE);</span>
<a href="#l182.34"></a><span id="l182.34">   }</span>
<a href="#l182.35"></a><span id="l182.35"> </span>
<a href="#l182.36"></a><span id="l182.36">   if (m_filterList)</span>
<a href="#l182.37"></a><span id="l182.37">   {</span>
<a href="#l182.38"></a><span id="l182.38">     nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l182.39"></a><span id="l182.39">     rv = GetServer(getter_AddRefs(server));</span>
<a href="#l182.40"></a><span id="l182.40">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l182.41"></a><span id="l182.41" class="difflineat">@@ -737,30 +737,30 @@ NS_IMETHODIMP nsImapMailFolder::UpdateFo</span>
<a href="#l182.42"></a><span id="l182.42">       }</span>
<a href="#l182.43"></a><span id="l182.43">       m_haveDiscoveredAllFolders = PR_TRUE;</span>
<a href="#l182.44"></a><span id="l182.44">     }</span>
<a href="#l182.45"></a><span id="l182.45">     selectFolder = PR_FALSE;</span>
<a href="#l182.46"></a><span id="l182.46">   }</span>
<a href="#l182.47"></a><span id="l182.47">   rv = GetDatabase();</span>
<a href="#l182.48"></a><span id="l182.48">   if (NS_FAILED(rv))</span>
<a href="#l182.49"></a><span id="l182.49">   {</span>
<a href="#l182.50"></a><span id="l182.50" class="difflineminus">-    ThrowAlertMsg(&quot;errorGettingDB&quot;, msgWindow);</span>
<a href="#l182.51"></a><span id="l182.51" class="difflineplus">+    ThrowAlertMsg(&quot;errorGettingDB&quot;, aMsgWindow);</span>
<a href="#l182.52"></a><span id="l182.52">     return rv;</span>
<a href="#l182.53"></a><span id="l182.53">   }</span>
<a href="#l182.54"></a><span id="l182.54">   PRBool canOpenThisFolder = PR_TRUE;</span>
<a href="#l182.55"></a><span id="l182.55">   GetCanOpenFolder(&amp;canOpenThisFolder);</span>
<a href="#l182.56"></a><span id="l182.56"> </span>
<a href="#l182.57"></a><span id="l182.57">   PRBool hasOfflineEvents = PR_FALSE;</span>
<a href="#l182.58"></a><span id="l182.58">   GetFlag(nsMsgFolderFlags::OfflineEvents, &amp;hasOfflineEvents);</span>
<a href="#l182.59"></a><span id="l182.59"> </span>
<a href="#l182.60"></a><span id="l182.60">   if (!WeAreOffline())</span>
<a href="#l182.61"></a><span id="l182.61">   {</span>
<a href="#l182.62"></a><span id="l182.62">     if (hasOfflineEvents)</span>
<a href="#l182.63"></a><span id="l182.63">     {</span>
<a href="#l182.64"></a><span id="l182.64" class="difflineminus">-      nsImapOfflineSync *goOnline = new nsImapOfflineSync(msgWindow, this, this);</span>
<a href="#l182.65"></a><span id="l182.65" class="difflineplus">+      nsImapOfflineSync *goOnline = new nsImapOfflineSync(aMsgWindow, this, this);</span>
<a href="#l182.66"></a><span id="l182.66">       if (goOnline)</span>
<a href="#l182.67"></a><span id="l182.67">         return goOnline-&gt;ProcessNextOperation();</span>
<a href="#l182.68"></a><span id="l182.68">     }</span>
<a href="#l182.69"></a><span id="l182.69">   }</span>
<a href="#l182.70"></a><span id="l182.70"> </span>
<a href="#l182.71"></a><span id="l182.71">   // Check it we're password protecting the local store.</span>
<a href="#l182.72"></a><span id="l182.72">   if (!PromptForMasterPasswordIfNecessary())</span>
<a href="#l182.73"></a><span id="l182.73">     return NS_ERROR_FAILURE;</span>
<a href="#l182.74"></a><span id="l182.74" class="difflineat">@@ -769,34 +769,34 @@ NS_IMETHODIMP nsImapMailFolder::UpdateFo</span>
<a href="#l182.75"></a><span id="l182.75">     selectFolder = PR_FALSE;</span>
<a href="#l182.76"></a><span id="l182.76">   // don't run select if we can't select the folder...</span>
<a href="#l182.77"></a><span id="l182.77">   if (NS_SUCCEEDED(rv) &amp;&amp; !m_urlRunning &amp;&amp; selectFolder)</span>
<a href="#l182.78"></a><span id="l182.78">   {</span>
<a href="#l182.79"></a><span id="l182.79">     nsCOMPtr&lt;nsIImapService&gt; imapService = do_GetService(NS_IMAPSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l182.80"></a><span id="l182.80">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l182.81"></a><span id="l182.81"> </span>
<a href="#l182.82"></a><span id="l182.82">     nsCOMPtr &lt;nsIURI&gt; url;</span>
<a href="#l182.83"></a><span id="l182.83" class="difflineminus">-    rv = imapService-&gt;SelectFolder(m_thread, this, m_urlListener, msgWindow, getter_AddRefs(url));</span>
<a href="#l182.84"></a><span id="l182.84" class="difflineplus">+    rv = imapService-&gt;SelectFolder(m_thread, this, m_urlListener, aMsgWindow, getter_AddRefs(url));</span>
<a href="#l182.85"></a><span id="l182.85">     if (NS_SUCCEEDED(rv))</span>
<a href="#l182.86"></a><span id="l182.86">     {</span>
<a href="#l182.87"></a><span id="l182.87">       m_urlRunning = PR_TRUE;</span>
<a href="#l182.88"></a><span id="l182.88">       m_updatingFolder = PR_TRUE;</span>
<a href="#l182.89"></a><span id="l182.89">     }</span>
<a href="#l182.90"></a><span id="l182.90">     if (url)</span>
<a href="#l182.91"></a><span id="l182.91">     {</span>
<a href="#l182.92"></a><span id="l182.92">       nsCOMPtr &lt;nsIMsgMailNewsUrl&gt; mailnewsUrl = do_QueryInterface(url, &amp;rv);</span>
<a href="#l182.93"></a><span id="l182.93">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l182.94"></a><span id="l182.94">       mailnewsUrl-&gt;RegisterListener(this);</span>
<a href="#l182.95"></a><span id="l182.95">       m_urlListener = aUrlListener;</span>
<a href="#l182.96"></a><span id="l182.96">     }</span>
<a href="#l182.97"></a><span id="l182.97">     switch (rv)</span>
<a href="#l182.98"></a><span id="l182.98">     {</span>
<a href="#l182.99"></a><span id="l182.99">       case NS_MSG_ERROR_OFFLINE:</span>
<a href="#l182.100"></a><span id="l182.100" class="difflineminus">-        if (msgWindow)</span>
<a href="#l182.101"></a><span id="l182.101" class="difflineminus">-          AutoCompact(msgWindow);</span>
<a href="#l182.102"></a><span id="l182.102" class="difflineplus">+        if (aMsgWindow)</span>
<a href="#l182.103"></a><span id="l182.103" class="difflineplus">+          AutoCompact(aMsgWindow);</span>
<a href="#l182.104"></a><span id="l182.104">         // note fall through to next case.</span>
<a href="#l182.105"></a><span id="l182.105">       case NS_BINDING_ABORTED:</span>
<a href="#l182.106"></a><span id="l182.106">         rv = NS_OK;</span>
<a href="#l182.107"></a><span id="l182.107">         NotifyFolderEvent(mFolderLoadedAtom);</span>
<a href="#l182.108"></a><span id="l182.108">         break;</span>
<a href="#l182.109"></a><span id="l182.109">       default:</span>
<a href="#l182.110"></a><span id="l182.110">         break;</span>
<a href="#l182.111"></a><span id="l182.111">     }</span>
<a href="#l182.112"></a><span id="l182.112" class="difflineat">@@ -4898,16 +4898,34 @@ nsImapMailFolder::OnStopRunningUrl(nsIUR</span>
<a href="#l182.113"></a><span id="l182.113">                 (void) OnCopyCompleted(m_copyState-&gt;m_srcSupport, aExitCode);</span>
<a href="#l182.114"></a><span id="l182.114">               }</span>
<a href="#l182.115"></a><span id="l182.115">             }</span>
<a href="#l182.116"></a><span id="l182.116">             else</span>
<a href="#l182.117"></a><span id="l182.117">               //clear the copyState if copy has failed</span>
<a href="#l182.118"></a><span id="l182.118">               (void) OnCopyCompleted(m_copyState-&gt;m_srcSupport, aExitCode);</span>
<a href="#l182.119"></a><span id="l182.119">           }</span>
<a href="#l182.120"></a><span id="l182.120">           break;</span>
<a href="#l182.121"></a><span id="l182.121" class="difflineplus">+      case nsIImapUrl::nsImapMoveFolderHierarchy:</span>
<a href="#l182.122"></a><span id="l182.122" class="difflineplus">+        if (m_copyState) // delete folder gets here, but w/o an m_copyState</span>
<a href="#l182.123"></a><span id="l182.123" class="difflineplus">+        {</span>
<a href="#l182.124"></a><span id="l182.124" class="difflineplus">+          nsCOMPtr&lt;nsIMsgCopyService&gt; copyService = do_GetService(NS_MSGCOPYSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l182.125"></a><span id="l182.125" class="difflineplus">+          NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l182.126"></a><span id="l182.126" class="difflineplus">+          nsCOMPtr&lt;nsIMsgFolder&gt; srcFolder = do_QueryInterface(m_copyState-&gt;m_srcSupport);</span>
<a href="#l182.127"></a><span id="l182.127" class="difflineplus">+          if (srcFolder)</span>
<a href="#l182.128"></a><span id="l182.128" class="difflineplus">+          {</span>
<a href="#l182.129"></a><span id="l182.129" class="difflineplus">+            nsCOMPtr&lt;nsIMsgFolder&gt; destFolder;</span>
<a href="#l182.130"></a><span id="l182.130" class="difflineplus">+            nsString srcName;</span>
<a href="#l182.131"></a><span id="l182.131" class="difflineplus">+            srcFolder-&gt;GetName(srcName);</span>
<a href="#l182.132"></a><span id="l182.132" class="difflineplus">+            GetChildNamed(srcName, getter_AddRefs(destFolder));</span>
<a href="#l182.133"></a><span id="l182.133" class="difflineplus">+            if (destFolder)</span>
<a href="#l182.134"></a><span id="l182.134" class="difflineplus">+              copyService-&gt;NotifyCompletion(m_copyState-&gt;m_srcSupport, destFolder, aExitCode);</span>
<a href="#l182.135"></a><span id="l182.135" class="difflineplus">+          }</span>
<a href="#l182.136"></a><span id="l182.136" class="difflineplus">+          m_copyState = nsnull;</span>
<a href="#l182.137"></a><span id="l182.137" class="difflineplus">+        }</span>
<a href="#l182.138"></a><span id="l182.138" class="difflineplus">+        break;</span>
<a href="#l182.139"></a><span id="l182.139">       case nsIImapUrl::nsImapRenameFolder:</span>
<a href="#l182.140"></a><span id="l182.140">         if (NS_FAILED(aExitCode))</span>
<a href="#l182.141"></a><span id="l182.141">         {</span>
<a href="#l182.142"></a><span id="l182.142">           nsCOMPtr &lt;nsIAtom&gt; folderRenameAtom;</span>
<a href="#l182.143"></a><span id="l182.143">           folderRenameAtom = do_GetAtom(&quot;RenameCompleted&quot;);</span>
<a href="#l182.144"></a><span id="l182.144">           NotifyFolderEvent(folderRenameAtom);</span>
<a href="#l182.145"></a><span id="l182.145">         }</span>
<a href="#l182.146"></a><span id="l182.146">         break;</span>
<a href="#l182.147"></a><span id="l182.147" class="difflineat">@@ -6059,17 +6077,17 @@ nsImapMailFolder::ProgressStatus(nsIImap</span>
<a href="#l182.148"></a><span id="l182.148">     }</span>
<a href="#l182.149"></a><span id="l182.149">   }</span>
<a href="#l182.150"></a><span id="l182.150">   return NS_OK;</span>
<a href="#l182.151"></a><span id="l182.151"> }</span>
<a href="#l182.152"></a><span id="l182.152"> </span>
<a href="#l182.153"></a><span id="l182.153"> NS_IMETHODIMP</span>
<a href="#l182.154"></a><span id="l182.154"> nsImapMailFolder::PercentProgress(nsIImapProtocol* aProtocol,</span>
<a href="#l182.155"></a><span id="l182.155">                                   const PRUnichar * aMessage,</span>
<a href="#l182.156"></a><span id="l182.156" class="difflineminus">-                                  PRInt32 aCurrentProgress, PRInt32 aMaxProgress)</span>
<a href="#l182.157"></a><span id="l182.157" class="difflineplus">+                                  PRInt64 aCurrentProgress, PRInt64 aMaxProgress)</span>
<a href="#l182.158"></a><span id="l182.158"> {</span>
<a href="#l182.159"></a><span id="l182.159">   if (aProtocol)</span>
<a href="#l182.160"></a><span id="l182.160">   {</span>
<a href="#l182.161"></a><span id="l182.161">     nsCOMPtr &lt;nsIImapUrl&gt; imapUrl;</span>
<a href="#l182.162"></a><span id="l182.162">     aProtocol-&gt;GetRunningImapURL(getter_AddRefs(imapUrl));</span>
<a href="#l182.163"></a><span id="l182.163">     if (imapUrl)</span>
<a href="#l182.164"></a><span id="l182.164">     {</span>
<a href="#l182.165"></a><span id="l182.165">       nsCOMPtr&lt;nsIImapMockChannel&gt; mockChannel;</span>
<a href="#l182.166"></a><span id="l182.166" class="difflineat">@@ -6077,20 +6095,19 @@ nsImapMailFolder::PercentProgress(nsIIma</span>
<a href="#l182.167"></a><span id="l182.167">       if (mockChannel)</span>
<a href="#l182.168"></a><span id="l182.168">       {</span>
<a href="#l182.169"></a><span id="l182.169">         nsCOMPtr&lt;nsIProgressEventSink&gt; progressSink;</span>
<a href="#l182.170"></a><span id="l182.170">         mockChannel-&gt;GetProgressEventSink(getter_AddRefs(progressSink));</span>
<a href="#l182.171"></a><span id="l182.171">         if (progressSink)</span>
<a href="#l182.172"></a><span id="l182.172">         {</span>
<a href="#l182.173"></a><span id="l182.173">             nsCOMPtr&lt;nsIRequest&gt; request = do_QueryInterface(mockChannel);</span>
<a href="#l182.174"></a><span id="l182.174">             if (!request) return NS_ERROR_FAILURE;</span>
<a href="#l182.175"></a><span id="l182.175" class="difflineminus">-            // XXX handle 64-bit ints for real</span>
<a href="#l182.176"></a><span id="l182.176">             progressSink-&gt;OnProgress(request, nsnull,</span>
<a href="#l182.177"></a><span id="l182.177" class="difflineminus">-                                     nsUint64(aCurrentProgress),</span>
<a href="#l182.178"></a><span id="l182.178" class="difflineminus">-                                     nsUint64(aMaxProgress));</span>
<a href="#l182.179"></a><span id="l182.179" class="difflineplus">+                                     aCurrentProgress,</span>
<a href="#l182.180"></a><span id="l182.180" class="difflineplus">+                                     aMaxProgress);</span>
<a href="#l182.181"></a><span id="l182.181">             if (aMessage)</span>
<a href="#l182.182"></a><span id="l182.182">               progressSink-&gt;OnStatus(request, nsnull, NS_OK, aMessage); // XXX i18n message</span>
<a href="#l182.183"></a><span id="l182.183">         }</span>
<a href="#l182.184"></a><span id="l182.184">       }</span>
<a href="#l182.185"></a><span id="l182.185">     }</span>
<a href="#l182.186"></a><span id="l182.186">   }</span>
<a href="#l182.187"></a><span id="l182.187">   return NS_OK;</span>
<a href="#l182.188"></a><span id="l182.188"> }</span>
<a href="#l182.189"></a><span id="l182.189" class="difflineat">@@ -6699,17 +6716,17 @@ void nsImapMailFolder::SetPendingAttribu</span>
<a href="#l182.190"></a><span id="l182.190">   dontPreserveEx.AppendLiteral(&quot; &quot;);</span>
<a href="#l182.191"></a><span id="l182.191"> </span>
<a href="#l182.192"></a><span id="l182.192">   // these properties are set as integers below, so don't set them again</span>
<a href="#l182.193"></a><span id="l182.193">   // in the iteration through the properties</span>
<a href="#l182.194"></a><span id="l182.194">   dontPreserveEx.AppendLiteral(&quot;offlineMsgSize msgOffset flags priority &quot;);</span>
<a href="#l182.195"></a><span id="l182.195"> </span>
<a href="#l182.196"></a><span id="l182.196">   // these fields are either copied separately when the server does not support</span>
<a href="#l182.197"></a><span id="l182.197">   // custom IMAP flags, or managed directly through the flags</span>
<a href="#l182.198"></a><span id="l182.198" class="difflineminus">-  dontPreserveEx.AppendLiteral(&quot;keywords label junkscore &quot;);</span>
<a href="#l182.199"></a><span id="l182.199" class="difflineplus">+  dontPreserveEx.AppendLiteral(&quot;keywords label &quot;);</span>
<a href="#l182.200"></a><span id="l182.200"> </span>
<a href="#l182.201"></a><span id="l182.201">   PRUint32 i, count;</span>
<a href="#l182.202"></a><span id="l182.202"> </span>
<a href="#l182.203"></a><span id="l182.203">   rv = messages-&gt;GetLength(&amp;count);</span>
<a href="#l182.204"></a><span id="l182.204">   if (NS_FAILED(rv)) </span>
<a href="#l182.205"></a><span id="l182.205">     return;</span>
<a href="#l182.206"></a><span id="l182.206"> </span>
<a href="#l182.207"></a><span id="l182.207">   // check if any msg hdr has special flags or properties set</span>
<a href="#l182.208"></a><span id="l182.208" class="difflineat">@@ -6717,20 +6734,16 @@ void nsImapMailFolder::SetPendingAttribu</span>
<a href="#l182.209"></a><span id="l182.209">   for (i = 0; i &lt; count; i++)</span>
<a href="#l182.210"></a><span id="l182.210">   {</span>
<a href="#l182.211"></a><span id="l182.211">     nsCOMPtr &lt;nsIMsgDBHdr&gt; msgDBHdr = do_QueryElementAt(messages, i, &amp;rv);</span>
<a href="#l182.212"></a><span id="l182.212">     if (mDatabase &amp;&amp; msgDBHdr)</span>
<a href="#l182.213"></a><span id="l182.213">     {</span>
<a href="#l182.214"></a><span id="l182.214">       if (!(supportedUserFlags &amp; kImapMsgSupportUserFlag))</span>
<a href="#l182.215"></a><span id="l182.215">       {</span>
<a href="#l182.216"></a><span id="l182.216">         nsMsgLabelValue label;</span>
<a href="#l182.217"></a><span id="l182.217" class="difflineminus">-        nsCString junkScore;</span>
<a href="#l182.218"></a><span id="l182.218" class="difflineminus">-        msgDBHdr-&gt;GetStringProperty(&quot;junkscore&quot;, getter_Copies(junkScore));</span>
<a href="#l182.219"></a><span id="l182.219" class="difflineminus">-        if (!junkScore.IsEmpty()) // ignore already scored messages.</span>
<a href="#l182.220"></a><span id="l182.220" class="difflineminus">-          mDatabase-&gt;SetAttributeOnPendingHdr(msgDBHdr, &quot;junkscore&quot;, junkScore.get());</span>
<a href="#l182.221"></a><span id="l182.221">         msgDBHdr-&gt;GetLabel(&amp;label);</span>
<a href="#l182.222"></a><span id="l182.222">         if (label != 0)</span>
<a href="#l182.223"></a><span id="l182.223">         {</span>
<a href="#l182.224"></a><span id="l182.224">           nsCAutoString labelStr;</span>
<a href="#l182.225"></a><span id="l182.225">           labelStr.AppendInt(label);</span>
<a href="#l182.226"></a><span id="l182.226">           mDatabase-&gt;SetAttributeOnPendingHdr(msgDBHdr, &quot;label&quot;, labelStr.get());</span>
<a href="#l182.227"></a><span id="l182.227">         }</span>
<a href="#l182.228"></a><span id="l182.228">         nsCString keywords;</span>
<a href="#l182.229"></a><span id="l182.229" class="difflineat">@@ -7240,35 +7253,41 @@ nsImapMailFolder::CopyFolder(nsIMsgFolde</span>
<a href="#l182.230"></a><span id="l182.230">         if (children &amp;&amp; NS_SUCCEEDED(children-&gt;HasMoreElements(&amp;more)) &amp;&amp; !more)</span>
<a href="#l182.231"></a><span id="l182.231">           parentPathFile-&gt;Remove(PR_TRUE);</span>
<a href="#l182.232"></a><span id="l182.232">       }</span>
<a href="#l182.233"></a><span id="l182.233">     }</span>
<a href="#l182.234"></a><span id="l182.234">     else // non-virtual folder</span>
<a href="#l182.235"></a><span id="l182.235">     {</span>
<a href="#l182.236"></a><span id="l182.236">       nsCOMPtr &lt;nsIImapService&gt; imapService = do_GetService (NS_IMAPSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l182.237"></a><span id="l182.237">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l182.238"></a><span id="l182.238" class="difflineminus">-      nsCOMPtr &lt;nsIUrlListener&gt; urlListener = do_QueryInterface(srcFolder);</span>
<a href="#l182.239"></a><span id="l182.239" class="difflineplus">+      nsCOMPtr&lt;nsISupports&gt; srcSupport = do_QueryInterface(srcFolder);</span>
<a href="#l182.240"></a><span id="l182.240">       PRBool match = PR_FALSE;</span>
<a href="#l182.241"></a><span id="l182.241">       PRBool confirmed = PR_FALSE;</span>
<a href="#l182.242"></a><span id="l182.242">       if (mFlags &amp; nsMsgFolderFlags::Trash)</span>
<a href="#l182.243"></a><span id="l182.243">       {</span>
<a href="#l182.244"></a><span id="l182.244">         rv = srcFolder-&gt;MatchOrChangeFilterDestination(nsnull, PR_FALSE, &amp;match);</span>
<a href="#l182.245"></a><span id="l182.245">         if (match)</span>
<a href="#l182.246"></a><span id="l182.246">         {</span>
<a href="#l182.247"></a><span id="l182.247">           srcFolder-&gt;ConfirmFolderDeletionForFilter(msgWindow, &amp;confirmed);</span>
<a href="#l182.248"></a><span id="l182.248">           // should we return an error to copy service?</span>
<a href="#l182.249"></a><span id="l182.249">           // or send a notification?</span>
<a href="#l182.250"></a><span id="l182.250">           if (!confirmed)</span>
<a href="#l182.251"></a><span id="l182.251">             return NS_OK;</span>
<a href="#l182.252"></a><span id="l182.252">         }</span>
<a href="#l182.253"></a><span id="l182.253">       }</span>
<a href="#l182.254"></a><span id="l182.254" class="difflineplus">+      rv = InitCopyState(srcSupport, nsnull, PR_FALSE, nsnull,</span>
<a href="#l182.255"></a><span id="l182.255" class="difflineplus">+                         PR_FALSE, 0, EmptyCString(), listener, </span>
<a href="#l182.256"></a><span id="l182.256" class="difflineplus">+                         msgWindow, PR_FALSE);</span>
<a href="#l182.257"></a><span id="l182.257" class="difflineplus">+      if (NS_FAILED(rv))</span>
<a href="#l182.258"></a><span id="l182.258" class="difflineplus">+        return OnCopyCompleted(srcSupport, rv);</span>
<a href="#l182.259"></a><span id="l182.259" class="difflineplus">+</span>
<a href="#l182.260"></a><span id="l182.260">       rv = imapService-&gt;MoveFolder(m_thread,</span>
<a href="#l182.261"></a><span id="l182.261">                                    srcFolder,</span>
<a href="#l182.262"></a><span id="l182.262">                                    this,</span>
<a href="#l182.263"></a><span id="l182.263" class="difflineminus">-                                   urlListener,</span>
<a href="#l182.264"></a><span id="l182.264" class="difflineplus">+                                   this,</span>
<a href="#l182.265"></a><span id="l182.265">                                    msgWindow,</span>
<a href="#l182.266"></a><span id="l182.266">                                    nsnull);</span>
<a href="#l182.267"></a><span id="l182.267">     }</span>
<a href="#l182.268"></a><span id="l182.268">   }</span>
<a href="#l182.269"></a><span id="l182.269">   else // copying folder (should only be across server?)</span>
<a href="#l182.270"></a><span id="l182.270">   {</span>
<a href="#l182.271"></a><span id="l182.271">     nsImapFolderCopyState *folderCopier = new nsImapFolderCopyState(this, srcFolder, isMoveFolder, msgWindow, listener);</span>
<a href="#l182.272"></a><span id="l182.272">     NS_ADDREF(folderCopier); // it owns itself.</span>
<a href="#l182.273"></a><span id="l182.273" class="difflineat">@@ -7301,20 +7320,31 @@ nsImapMailFolder::CopyFileMessage(nsIFil</span>
<a href="#l182.274"></a><span id="l182.274">       return OnCopyCompleted(srcSupport, rv);</span>
<a href="#l182.275"></a><span id="l182.275"> </span>
<a href="#l182.276"></a><span id="l182.276">     rv = QueryInterface(NS_GET_IID(nsIUrlListener), getter_AddRefs(urlListener));</span>
<a href="#l182.277"></a><span id="l182.277"> </span>
<a href="#l182.278"></a><span id="l182.278">     if (msgToReplace)</span>
<a href="#l182.279"></a><span id="l182.279">     {</span>
<a href="#l182.280"></a><span id="l182.280">         rv = msgToReplace-&gt;GetMessageKey(&amp;key);</span>
<a href="#l182.281"></a><span id="l182.281">         if (NS_SUCCEEDED(rv))</span>
<a href="#l182.282"></a><span id="l182.282" class="difflineminus">-            messageId.AppendInt((PRInt32) key);</span>
<a href="#l182.283"></a><span id="l182.283" class="difflineminus">-    }</span>
<a href="#l182.284"></a><span id="l182.284" class="difflineminus">-</span>
<a href="#l182.285"></a><span id="l182.285" class="difflineminus">-    rv = InitCopyState(srcSupport, messages, PR_FALSE, isDraftOrTemplate,</span>
<a href="#l182.286"></a><span id="l182.286" class="difflineplus">+        {</span>
<a href="#l182.287"></a><span id="l182.287" class="difflineplus">+          messageId.AppendInt((PRInt32) key);</span>
<a href="#l182.288"></a><span id="l182.288" class="difflineplus">+          // Perhaps we have the message offline, but even if we do it is</span>
<a href="#l182.289"></a><span id="l182.289" class="difflineplus">+          // not valid, since the only time we do a file copy for an</span>
<a href="#l182.290"></a><span id="l182.290" class="difflineplus">+          // existing message is when we are changing the message.</span>
<a href="#l182.291"></a><span id="l182.291" class="difflineplus">+          // So set the offline size to 0 to force SetPendingAttributes to</span>
<a href="#l182.292"></a><span id="l182.292" class="difflineplus">+          // clear the offline message flag.</span>
<a href="#l182.293"></a><span id="l182.293" class="difflineplus">+          msgToReplace-&gt;SetOfflineMessageSize(0);</span>
<a href="#l182.294"></a><span id="l182.294" class="difflineplus">+          messages-&gt;AppendElement(msgToReplace, PR_FALSE);</span>
<a href="#l182.295"></a><span id="l182.295" class="difflineplus">+          SetPendingAttributes(messages, PR_FALSE);</span>
<a href="#l182.296"></a><span id="l182.296" class="difflineplus">+        }</span>
<a href="#l182.297"></a><span id="l182.297" class="difflineplus">+    }</span>
<a href="#l182.298"></a><span id="l182.298" class="difflineplus">+</span>
<a href="#l182.299"></a><span id="l182.299" class="difflineplus">+    PRBool isMove = (msgToReplace ? PR_TRUE : PR_FALSE);</span>
<a href="#l182.300"></a><span id="l182.300" class="difflineplus">+    rv = InitCopyState(srcSupport, messages, isMove, isDraftOrTemplate,</span>
<a href="#l182.301"></a><span id="l182.301">                        PR_FALSE, aNewMsgFlags, aNewMsgKeywords, listener, </span>
<a href="#l182.302"></a><span id="l182.302">                        msgWindow, PR_FALSE);</span>
<a href="#l182.303"></a><span id="l182.303">     if (NS_FAILED(rv))</span>
<a href="#l182.304"></a><span id="l182.304">       return OnCopyCompleted(srcSupport, rv);</span>
<a href="#l182.305"></a><span id="l182.305"> </span>
<a href="#l182.306"></a><span id="l182.306">     m_copyState-&gt;m_streamCopy = PR_TRUE;</span>
<a href="#l182.307"></a><span id="l182.307">     nsCOMPtr&lt;nsISupports&gt; copySupport;</span>
<a href="#l182.308"></a><span id="l182.308">     if( m_copyState )</span>
<a href="#l182.309"></a><span id="l182.309" class="difflineat">@@ -7440,30 +7470,30 @@ nsImapMailFolder::InitCopyState(nsISuppo</span>
<a href="#l182.310"></a><span id="l182.310">                                 PRBool acrossServers,</span>
<a href="#l182.311"></a><span id="l182.311">                                 PRUint32 newMsgFlags,</span>
<a href="#l182.312"></a><span id="l182.312">                                 const nsACString &amp;newMsgKeywords,</span>
<a href="#l182.313"></a><span id="l182.313">                                 nsIMsgCopyServiceListener* listener,</span>
<a href="#l182.314"></a><span id="l182.314">                                 nsIMsgWindow *msgWindow,</span>
<a href="#l182.315"></a><span id="l182.315">                                 PRBool allowUndo)</span>
<a href="#l182.316"></a><span id="l182.316"> {</span>
<a href="#l182.317"></a><span id="l182.317">   NS_ENSURE_ARG_POINTER(srcSupport);</span>
<a href="#l182.318"></a><span id="l182.318" class="difflineminus">-  NS_ENSURE_ARG_POINTER(messages);</span>
<a href="#l182.319"></a><span id="l182.319">   NS_ENSURE_TRUE(!m_copyState, NS_ERROR_FAILURE);</span>
<a href="#l182.320"></a><span id="l182.320">   nsresult rv;</span>
<a href="#l182.321"></a><span id="l182.321"> </span>
<a href="#l182.322"></a><span id="l182.322">   nsImapMailCopyState* copyState = new nsImapMailCopyState();</span>
<a href="#l182.323"></a><span id="l182.323">   m_copyState = do_QueryInterface(copyState);</span>
<a href="#l182.324"></a><span id="l182.324">   NS_ENSURE_TRUE(m_copyState,NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l182.325"></a><span id="l182.325"> </span>
<a href="#l182.326"></a><span id="l182.326">   m_copyState-&gt;m_isCrossServerOp = acrossServers;</span>
<a href="#l182.327"></a><span id="l182.327">   m_copyState-&gt;m_srcSupport = do_QueryInterface(srcSupport, &amp;rv);</span>
<a href="#l182.328"></a><span id="l182.328">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l182.329"></a><span id="l182.329"> </span>
<a href="#l182.330"></a><span id="l182.330">   m_copyState-&gt;m_messages = messages;</span>
<a href="#l182.331"></a><span id="l182.331" class="difflineminus">-  rv = messages-&gt;GetLength(&amp;m_copyState-&gt;m_totalCount);</span>
<a href="#l182.332"></a><span id="l182.332" class="difflineplus">+  if (messages)</span>
<a href="#l182.333"></a><span id="l182.333" class="difflineplus">+    rv = messages-&gt;GetLength(&amp;m_copyState-&gt;m_totalCount);</span>
<a href="#l182.334"></a><span id="l182.334">   if (!m_copyState-&gt;m_isCrossServerOp)</span>
<a href="#l182.335"></a><span id="l182.335">   {</span>
<a href="#l182.336"></a><span id="l182.336">     if (NS_SUCCEEDED(rv))</span>
<a href="#l182.337"></a><span id="l182.337">     {</span>
<a href="#l182.338"></a><span id="l182.338">         PRUint32 numUnread = 0;</span>
<a href="#l182.339"></a><span id="l182.339">         for (PRUint32 keyIndex=0; keyIndex &lt; m_copyState-&gt;m_totalCount; keyIndex++)</span>
<a href="#l182.340"></a><span id="l182.340">         {</span>
<a href="#l182.341"></a><span id="l182.341">           nsCOMPtr&lt;nsIMsgDBHdr&gt; message = do_QueryElementAt(m_copyState-&gt;m_messages, keyIndex, &amp;rv);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l183.1"></a><span id="l183.1" class="difflineminus">--- a/mailnews/imap/src/nsImapProtocol.cpp</span>
<a href="#l183.2"></a><span id="l183.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapProtocol.cpp</span>
<a href="#l183.3"></a><span id="l183.3" class="difflineat">@@ -4979,19 +4979,18 @@ nsImapProtocol::ProgressEventFunctionUsi</span>
<a href="#l183.4"></a><span id="l183.4">     nsString unicodeStr;</span>
<a href="#l183.5"></a><span id="l183.5">     nsresult rv = CopyMUTF7toUTF16(nsDependentCString(aExtraInfo), unicodeStr);</span>
<a href="#l183.6"></a><span id="l183.6">     if (NS_SUCCEEDED(rv))</span>
<a href="#l183.7"></a><span id="l183.7">       m_imapMailFolderSink-&gt;ProgressStatus(this, aMsgId, unicodeStr.get());</span>
<a href="#l183.8"></a><span id="l183.8">   }</span>
<a href="#l183.9"></a><span id="l183.9"> }</span>
<a href="#l183.10"></a><span id="l183.10"> </span>
<a href="#l183.11"></a><span id="l183.11"> void</span>
<a href="#l183.12"></a><span id="l183.12" class="difflineminus">-nsImapProtocol::PercentProgressUpdateEvent(PRUnichar *message, PRInt32 currentProgress, PRInt32 maxProgress)</span>
<a href="#l183.13"></a><span id="l183.13" class="difflineminus">-{</span>
<a href="#l183.14"></a><span id="l183.14" class="difflineminus">-</span>
<a href="#l183.15"></a><span id="l183.15" class="difflineplus">+nsImapProtocol::PercentProgressUpdateEvent(PRUnichar *message, PRInt64 currentProgress, PRInt64 maxProgress)</span>
<a href="#l183.16"></a><span id="l183.16" class="difflineplus">+{</span>
<a href="#l183.17"></a><span id="l183.17">   PRInt64 nowMS = LL_ZERO;</span>
<a href="#l183.18"></a><span id="l183.18">   PRInt32 percent = (100 * currentProgress) / maxProgress;</span>
<a href="#l183.19"></a><span id="l183.19">   if (percent == m_lastPercent)</span>
<a href="#l183.20"></a><span id="l183.20">     return; // hasn't changed, right? So just return. Do we need to clear this anywhere?</span>
<a href="#l183.21"></a><span id="l183.21"> </span>
<a href="#l183.22"></a><span id="l183.22">   if (percent &lt; 100)  // always need to do 100%</span>
<a href="#l183.23"></a><span id="l183.23">   {</span>
<a href="#l183.24"></a><span id="l183.24">     int64 minIntervalBetweenProgress;</span>
<a href="#l183.25"></a><span id="l183.25" class="difflineat">@@ -5003,23 +5002,25 @@ nsImapProtocol::PercentProgressUpdateEve</span>
<a href="#l183.26"></a><span id="l183.26">     LL_SUB(diffSinceLastProgress, diffSinceLastProgress, minIntervalBetweenProgress); // r = a - b</span>
<a href="#l183.27"></a><span id="l183.27">     if (!LL_GE_ZERO(diffSinceLastProgress))</span>
<a href="#l183.28"></a><span id="l183.28">       return;</span>
<a href="#l183.29"></a><span id="l183.29">   }</span>
<a href="#l183.30"></a><span id="l183.30"> </span>
<a href="#l183.31"></a><span id="l183.31">   m_lastPercent = percent;</span>
<a href="#l183.32"></a><span id="l183.32">   m_lastProgressTime = nowMS;</span>
<a href="#l183.33"></a><span id="l183.33"> </span>
<a href="#l183.34"></a><span id="l183.34" class="difflineminus">-  // set our max progress as the content length on the mock channel</span>
<a href="#l183.35"></a><span id="l183.35" class="difflineminus">-  if (m_mockChannel)</span>
<a href="#l183.36"></a><span id="l183.36" class="difflineminus">-      m_mockChannel-&gt;SetContentLength(maxProgress);</span>
<a href="#l183.37"></a><span id="l183.37" class="difflineminus">-</span>
<a href="#l183.38"></a><span id="l183.38" class="difflineplus">+  // set our max progress on the running URL</span>
<a href="#l183.39"></a><span id="l183.39" class="difflineplus">+  if (m_runningUrl)</span>
<a href="#l183.40"></a><span id="l183.40" class="difflineplus">+  {</span>
<a href="#l183.41"></a><span id="l183.41" class="difflineplus">+    nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsUrl(do_QueryInterface(m_runningUrl));</span>
<a href="#l183.42"></a><span id="l183.42" class="difflineplus">+    mailnewsUrl-&gt;SetMaxProgress(maxProgress);</span>
<a href="#l183.43"></a><span id="l183.43" class="difflineplus">+  }</span>
<a href="#l183.44"></a><span id="l183.44"> </span>
<a href="#l183.45"></a><span id="l183.45">   if (m_imapMailFolderSink)</span>
<a href="#l183.46"></a><span id="l183.46" class="difflineminus">-      m_imapMailFolderSink-&gt;PercentProgress(this, message, currentProgress, maxProgress);</span>
<a href="#l183.47"></a><span id="l183.47" class="difflineplus">+    m_imapMailFolderSink-&gt;PercentProgress(this, message, currentProgress, maxProgress);</span>
<a href="#l183.48"></a><span id="l183.48"> }</span>
<a href="#l183.49"></a><span id="l183.49"> </span>
<a href="#l183.50"></a><span id="l183.50">   // imap commands issued by the parser</span>
<a href="#l183.51"></a><span id="l183.51"> void</span>
<a href="#l183.52"></a><span id="l183.52"> nsImapProtocol::Store(const nsCString &amp;messageList, const char * messageData,</span>
<a href="#l183.53"></a><span id="l183.53">                       PRBool idsAreUid)</span>
<a href="#l183.54"></a><span id="l183.54"> {</span>
<a href="#l183.55"></a><span id="l183.55"> </span>
<a href="#l183.56"></a><span id="l183.56" class="difflineat">@@ -5683,17 +5684,17 @@ void nsImapProtocol::UploadMessageFromFi</span>
<a href="#l183.57"></a><span id="l183.57">                                             PRTime date,</span>
<a href="#l183.58"></a><span id="l183.58">                                             imapMessageFlagsType flags,</span>
<a href="#l183.59"></a><span id="l183.59">                                             nsCString &amp;keywords)</span>
<a href="#l183.60"></a><span id="l183.60"> {</span>
<a href="#l183.61"></a><span id="l183.61">   if (!file || !mailboxName) return;</span>
<a href="#l183.62"></a><span id="l183.62">   IncrementCommandTagNumber();</span>
<a href="#l183.63"></a><span id="l183.63"> </span>
<a href="#l183.64"></a><span id="l183.64">   PRInt64 fileSize = 0;</span>
<a href="#l183.65"></a><span id="l183.65" class="difflineminus">-  PRInt32 totalSize;</span>
<a href="#l183.66"></a><span id="l183.66" class="difflineplus">+  PRInt64 totalSize;</span>
<a href="#l183.67"></a><span id="l183.67">   PRUint32 readCount;</span>
<a href="#l183.68"></a><span id="l183.68">   char *dataBuffer = nsnull;</span>
<a href="#l183.69"></a><span id="l183.69">   nsCString command(GetServerCommandTag());</span>
<a href="#l183.70"></a><span id="l183.70">   nsCString escapedName;</span>
<a href="#l183.71"></a><span id="l183.71">   CreateEscapedMailboxName(mailboxName, escapedName);</span>
<a href="#l183.72"></a><span id="l183.72">   nsresult rv;</span>
<a href="#l183.73"></a><span id="l183.73">   PRBool eof = PR_FALSE;</span>
<a href="#l183.74"></a><span id="l183.74">   nsCString flagString;</span>
<a href="#l183.75"></a><span id="l183.75" class="difflineat">@@ -5772,16 +5773,19 @@ void nsImapProtocol::UploadMessageFromFi</span>
<a href="#l183.76"></a><span id="l183.76">     if (!hasLiteralPlus)</span>
<a href="#l183.77"></a><span id="l183.77">       ParseIMAPandCheckForNewMail();</span>
<a href="#l183.78"></a><span id="l183.78"> </span>
<a href="#l183.79"></a><span id="l183.79">     totalSize = fileSize;</span>
<a href="#l183.80"></a><span id="l183.80">     readCount = 0;</span>
<a href="#l183.81"></a><span id="l183.81">     while(NS_SUCCEEDED(rv) &amp;&amp; !eof &amp;&amp; totalSize &gt; 0)</span>
<a href="#l183.82"></a><span id="l183.82">     {</span>
<a href="#l183.83"></a><span id="l183.83">       rv = fileInputStream-&gt;Read(dataBuffer, COPY_BUFFER_SIZE, &amp;readCount);</span>
<a href="#l183.84"></a><span id="l183.84" class="difflineplus">+      if (NS_SUCCEEDED(rv) &amp;&amp; !readCount)</span>
<a href="#l183.85"></a><span id="l183.85" class="difflineplus">+        rv = NS_ERROR_FAILURE;</span>
<a href="#l183.86"></a><span id="l183.86" class="difflineplus">+</span>
<a href="#l183.87"></a><span id="l183.87">       if (NS_SUCCEEDED(rv))</span>
<a href="#l183.88"></a><span id="l183.88">       {</span>
<a href="#l183.89"></a><span id="l183.89">         NS_ASSERTION(readCount &lt;= (PRUint32) totalSize, &quot;got more bytes than there should be&quot;);</span>
<a href="#l183.90"></a><span id="l183.90">         dataBuffer[readCount] = 0;</span>
<a href="#l183.91"></a><span id="l183.91">         rv = SendData(dataBuffer);</span>
<a href="#l183.92"></a><span id="l183.92">         totalSize -= readCount;</span>
<a href="#l183.93"></a><span id="l183.93">         PercentProgressUpdateEvent(nsnull, fileSize - totalSize, fileSize);</span>
<a href="#l183.94"></a><span id="l183.94">       }</span>
<a href="#l183.95"></a><span id="l183.95" class="difflineat">@@ -7206,16 +7210,34 @@ void nsImapProtocol::CreateMailbox(const</span>
<a href="#l183.96"></a><span id="l183.96">   nsCString command(GetServerCommandTag());</span>
<a href="#l183.97"></a><span id="l183.97">   command += &quot; create \&quot;&quot;;</span>
<a href="#l183.98"></a><span id="l183.98">   command += escapedName;</span>
<a href="#l183.99"></a><span id="l183.99">   command += &quot;\&quot;&quot;CRLF;</span>
<a href="#l183.100"></a><span id="l183.100"> </span>
<a href="#l183.101"></a><span id="l183.101">   nsresult rv = SendData(command.get());</span>
<a href="#l183.102"></a><span id="l183.102">   if(NS_SUCCEEDED(rv))</span>
<a href="#l183.103"></a><span id="l183.103">     ParseIMAPandCheckForNewMail();</span>
<a href="#l183.104"></a><span id="l183.104" class="difflineplus">+  // If that failed, let's list the parent folder to see if</span>
<a href="#l183.105"></a><span id="l183.105" class="difflineplus">+  // it allows inferiors, so we won't try to create sub-folders</span>
<a href="#l183.106"></a><span id="l183.106" class="difflineplus">+  // of the parent folder again in the current session.</span>
<a href="#l183.107"></a><span id="l183.107" class="difflineplus">+  if (GetServerStateParser().CommandFailed())</span>
<a href="#l183.108"></a><span id="l183.108" class="difflineplus">+  {</span>
<a href="#l183.109"></a><span id="l183.109" class="difflineplus">+    // Figure out parent folder name.</span>
<a href="#l183.110"></a><span id="l183.110" class="difflineplus">+    nsCString parentName(mailboxName);</span>
<a href="#l183.111"></a><span id="l183.111" class="difflineplus">+    char hierarchyDelimiter;</span>
<a href="#l183.112"></a><span id="l183.112" class="difflineplus">+    m_runningUrl-&gt;GetOnlineSubDirSeparator(&amp;hierarchyDelimiter);</span>
<a href="#l183.113"></a><span id="l183.113" class="difflineplus">+    PRInt32 leafPos = parentName.RFindChar(hierarchyDelimiter);</span>
<a href="#l183.114"></a><span id="l183.114" class="difflineplus">+    if (leafPos &gt; 0)</span>
<a href="#l183.115"></a><span id="l183.115" class="difflineplus">+    {</span>
<a href="#l183.116"></a><span id="l183.116" class="difflineplus">+      parentName.Truncate(leafPos);</span>
<a href="#l183.117"></a><span id="l183.117" class="difflineplus">+      List(parentName.get(), PR_FALSE);</span>
<a href="#l183.118"></a><span id="l183.118" class="difflineplus">+      // We still want the caller to know the create failed, so restore that.</span>
<a href="#l183.119"></a><span id="l183.119" class="difflineplus">+      GetServerStateParser().SetCommandFailed(PR_TRUE);</span>
<a href="#l183.120"></a><span id="l183.120" class="difflineplus">+    }</span>
<a href="#l183.121"></a><span id="l183.121" class="difflineplus">+  }</span>
<a href="#l183.122"></a><span id="l183.122"> }</span>
<a href="#l183.123"></a><span id="l183.123"> </span>
<a href="#l183.124"></a><span id="l183.124"> void nsImapProtocol::DeleteMailbox(const char *mailboxName)</span>
<a href="#l183.125"></a><span id="l183.125"> {</span>
<a href="#l183.126"></a><span id="l183.126"> </span>
<a href="#l183.127"></a><span id="l183.127">   // check if this connection currently has the folder to be deleted selected.</span>
<a href="#l183.128"></a><span id="l183.128">   // If so, we should close it because at least some UW servers don't like you deleting</span>
<a href="#l183.129"></a><span id="l183.129">   // a folder you have open.</span>
<a href="#l183.130"></a><span id="l183.130" class="difflineat">@@ -8245,17 +8267,16 @@ NS_INTERFACE_MAP_END_THREADSAFE</span>
<a href="#l183.131"></a><span id="l183.131"> nsImapMockChannel::nsImapMockChannel()</span>
<a href="#l183.132"></a><span id="l183.132"> {</span>
<a href="#l183.133"></a><span id="l183.133">   m_channelContext = nsnull;</span>
<a href="#l183.134"></a><span id="l183.134">   m_cancelStatus = NS_OK;</span>
<a href="#l183.135"></a><span id="l183.135">   mLoadFlags = 0;</span>
<a href="#l183.136"></a><span id="l183.136">   mChannelClosed = PR_FALSE;</span>
<a href="#l183.137"></a><span id="l183.137">   mReadingFromCache = PR_FALSE;</span>
<a href="#l183.138"></a><span id="l183.138">   mTryingToReadPart = PR_FALSE;</span>
<a href="#l183.139"></a><span id="l183.139" class="difflineminus">-  mContentLength = -1;</span>
<a href="#l183.140"></a><span id="l183.140"> }</span>
<a href="#l183.141"></a><span id="l183.141"> </span>
<a href="#l183.142"></a><span id="l183.142"> nsImapMockChannel::~nsImapMockChannel()</span>
<a href="#l183.143"></a><span id="l183.143"> {</span>
<a href="#l183.144"></a><span id="l183.144">   // if we're offline, we may not get to close the channel correctly.</span>
<a href="#l183.145"></a><span id="l183.145">   // we need to do this to send the url state change notification in</span>
<a href="#l183.146"></a><span id="l183.146">   // the case of mem and disk cache reads.</span>
<a href="#l183.147"></a><span id="l183.147">   NS_WARN_IF_FALSE(NS_IsMainThread(), &quot;should only access mock channel on ui thread&quot;);</span>
<a href="#l183.148"></a><span id="l183.148" class="difflineat">@@ -8411,16 +8432,39 @@ NS_IMETHODIMP nsImapMockChannel::SetURI(</span>
<a href="#l183.149"></a><span id="l183.149">     // if we don't have a progress event sink yet, get it from the url for now...</span>
<a href="#l183.150"></a><span id="l183.150">     nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsUrl = do_QueryInterface(m_url);</span>
<a href="#l183.151"></a><span id="l183.151">     if (mailnewsUrl &amp;&amp; !mProgressEventSink)</span>
<a href="#l183.152"></a><span id="l183.152">     {</span>
<a href="#l183.153"></a><span id="l183.153">       nsCOMPtr&lt;nsIMsgStatusFeedback&gt; statusFeedback;</span>
<a href="#l183.154"></a><span id="l183.154">       mailnewsUrl-&gt;GetStatusFeedback(getter_AddRefs(statusFeedback));</span>
<a href="#l183.155"></a><span id="l183.155">       mProgressEventSink = do_QueryInterface(statusFeedback);</span>
<a href="#l183.156"></a><span id="l183.156">     }</span>
<a href="#l183.157"></a><span id="l183.157" class="difflineplus">+    // If this is a fetch URL and we can, get the message size from the message</span>
<a href="#l183.158"></a><span id="l183.158" class="difflineplus">+    // header and set it to be the content length.</span>
<a href="#l183.159"></a><span id="l183.159" class="difflineplus">+    // Note that for an attachment URL, this will set the content length to be</span>
<a href="#l183.160"></a><span id="l183.160" class="difflineplus">+    // equal to the size of the entire message.</span>
<a href="#l183.161"></a><span id="l183.161" class="difflineplus">+    nsCOMPtr&lt;nsIImapUrl&gt; imapUrl(do_QueryInterface(m_url));</span>
<a href="#l183.162"></a><span id="l183.162" class="difflineplus">+    nsImapAction imapAction;</span>
<a href="#l183.163"></a><span id="l183.163" class="difflineplus">+    imapUrl-&gt;GetImapAction(&amp;imapAction);</span>
<a href="#l183.164"></a><span id="l183.164" class="difflineplus">+    if (imapAction == nsIImapUrl::nsImapMsgFetch)</span>
<a href="#l183.165"></a><span id="l183.165" class="difflineplus">+    {</span>
<a href="#l183.166"></a><span id="l183.166" class="difflineplus">+      nsCOMPtr&lt;nsIMsgMessageUrl&gt; msgUrl(do_QueryInterface(m_url));</span>
<a href="#l183.167"></a><span id="l183.167" class="difflineplus">+      if (msgUrl)</span>
<a href="#l183.168"></a><span id="l183.168" class="difflineplus">+      {</span>
<a href="#l183.169"></a><span id="l183.169" class="difflineplus">+        nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l183.170"></a><span id="l183.170" class="difflineplus">+        // A failure to get a message header isn't an error</span>
<a href="#l183.171"></a><span id="l183.171" class="difflineplus">+        msgUrl-&gt;GetMessageHeader(getter_AddRefs(msgHdr));</span>
<a href="#l183.172"></a><span id="l183.172" class="difflineplus">+        if (msgHdr)</span>
<a href="#l183.173"></a><span id="l183.173" class="difflineplus">+        {</span>
<a href="#l183.174"></a><span id="l183.174" class="difflineplus">+          PRUint32 messageSize;</span>
<a href="#l183.175"></a><span id="l183.175" class="difflineplus">+          if (NS_SUCCEEDED(msgHdr-&gt;GetMessageSize(&amp;messageSize)))</span>
<a href="#l183.176"></a><span id="l183.176" class="difflineplus">+            SetContentLength(messageSize);</span>
<a href="#l183.177"></a><span id="l183.177" class="difflineplus">+        }</span>
<a href="#l183.178"></a><span id="l183.178" class="difflineplus">+      }</span>
<a href="#l183.179"></a><span id="l183.179" class="difflineplus">+    }</span>
<a href="#l183.180"></a><span id="l183.180">   }</span>
<a href="#l183.181"></a><span id="l183.181">   return NS_OK;</span>
<a href="#l183.182"></a><span id="l183.182"> }</span>
<a href="#l183.183"></a><span id="l183.183"> </span>
<a href="#l183.184"></a><span id="l183.184"> NS_IMETHODIMP nsImapMockChannel::Open(nsIInputStream **_retval)</span>
<a href="#l183.185"></a><span id="l183.185"> {</span>
<a href="#l183.186"></a><span id="l183.186">   return NS_ImplementChannelOpen(this, _retval);</span>
<a href="#l183.187"></a><span id="l183.187"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l184.1"></a><span id="l184.1" class="difflineminus">--- a/mailnews/imap/src/nsImapProtocol.h</span>
<a href="#l184.2"></a><span id="l184.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapProtocol.h</span>
<a href="#l184.3"></a><span id="l184.3" class="difflineat">@@ -261,17 +261,17 @@ public:</span>
<a href="#l184.4"></a><span id="l184.4">   void DiscoverMailboxSpec(nsImapMailboxSpec * adoptedBoxSpec);</span>
<a href="#l184.5"></a><span id="l184.5">   void AlertUserEventUsingId(PRUint32 aMessageId);</span>
<a href="#l184.6"></a><span id="l184.6">   void AlertUserEvent(const char * message);</span>
<a href="#l184.7"></a><span id="l184.7">   void AlertUserEventFromServer(const char * aServerEvent);</span>
<a href="#l184.8"></a><span id="l184.8"> </span>
<a href="#l184.9"></a><span id="l184.9">   void ProgressEventFunctionUsingId(PRUint32 aMsgId);</span>
<a href="#l184.10"></a><span id="l184.10">   void ProgressEventFunctionUsingIdWithString(PRUint32 aMsgId, const char *</span>
<a href="#l184.11"></a><span id="l184.11">     aExtraInfo);</span>
<a href="#l184.12"></a><span id="l184.12" class="difflineminus">-  void PercentProgressUpdateEvent(PRUnichar *message, PRInt32 currentProgress, PRInt32 maxProgress);</span>
<a href="#l184.13"></a><span id="l184.13" class="difflineplus">+  void PercentProgressUpdateEvent(PRUnichar *message, PRInt64 currentProgress, PRInt64 maxProgress);</span>
<a href="#l184.14"></a><span id="l184.14">   void ShowProgress();</span>
<a href="#l184.15"></a><span id="l184.15"> </span>
<a href="#l184.16"></a><span id="l184.16">   // utility function calls made by the server</span>
<a href="#l184.17"></a><span id="l184.17"> </span>
<a href="#l184.18"></a><span id="l184.18">   void Copy(const char * messageList, const char *destinationMailbox,</span>
<a href="#l184.19"></a><span id="l184.19">     PRBool idsAreUid);</span>
<a href="#l184.20"></a><span id="l184.20">   void Search(const char * searchCriteria,  PRBool useUID,</span>
<a href="#l184.21"></a><span id="l184.21">     PRBool notifyHit = PR_TRUE);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l185.1"></a><span id="l185.1" class="difflineminus">--- a/mailnews/imap/src/nsImapServerResponseParser.cpp</span>
<a href="#l185.2"></a><span id="l185.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapServerResponseParser.cpp</span>
<a href="#l185.3"></a><span id="l185.3" class="difflineat">@@ -134,16 +134,21 @@ PRBool nsImapServerResponseParser::GetNe</span>
<a href="#l185.4"></a><span id="l185.4">   return rv;</span>
<a href="#l185.5"></a><span id="l185.5"> }</span>
<a href="#l185.6"></a><span id="l185.6"> </span>
<a href="#l185.7"></a><span id="l185.7"> PRBool	nsImapServerResponseParser::CommandFailed()</span>
<a href="#l185.8"></a><span id="l185.8"> {</span>
<a href="#l185.9"></a><span id="l185.9">   return fCurrentCommandFailed;</span>
<a href="#l185.10"></a><span id="l185.10"> }</span>
<a href="#l185.11"></a><span id="l185.11"> </span>
<a href="#l185.12"></a><span id="l185.12" class="difflineplus">+void nsImapServerResponseParser::SetCommandFailed(PRBool failed)</span>
<a href="#l185.13"></a><span id="l185.13" class="difflineplus">+{</span>
<a href="#l185.14"></a><span id="l185.14" class="difflineplus">+  fCurrentCommandFailed = failed;</span>
<a href="#l185.15"></a><span id="l185.15" class="difflineplus">+}</span>
<a href="#l185.16"></a><span id="l185.16" class="difflineplus">+</span>
<a href="#l185.17"></a><span id="l185.17"> void nsImapServerResponseParser::SetFlagState(nsIImapFlagAndUidState *state)</span>
<a href="#l185.18"></a><span id="l185.18"> {</span>
<a href="#l185.19"></a><span id="l185.19">   fFlagState = state;</span>
<a href="#l185.20"></a><span id="l185.20"> }</span>
<a href="#l185.21"></a><span id="l185.21"> </span>
<a href="#l185.22"></a><span id="l185.22"> PRInt32 nsImapServerResponseParser::SizeOfMostRecentMessage()</span>
<a href="#l185.23"></a><span id="l185.23"> {</span>
<a href="#l185.24"></a><span id="l185.24">   return fSizeOfMostRecentMessage;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l186.1"></a><span id="l186.1" class="difflineminus">--- a/mailnews/imap/src/nsImapServerResponseParser.h</span>
<a href="#l186.2"></a><span id="l186.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapServerResponseParser.h</span>
<a href="#l186.3"></a><span id="l186.3" class="difflineat">@@ -69,16 +69,17 @@ public:</span>
<a href="#l186.4"></a><span id="l186.4">   // aignoreBadAndNOResponses --&gt; don't throw a error dialog if this command results in a NO or Bad response</span>
<a href="#l186.5"></a><span id="l186.5">   // from the server..in other words the command is &quot;exploratory&quot; and we don't really care if it succeeds or fails.</span>
<a href="#l186.6"></a><span id="l186.6">   // This value is typically FALSE for almost all cases.</span>
<a href="#l186.7"></a><span id="l186.7">   virtual void ParseIMAPServerResponse(const char *aCurrentCommand,</span>
<a href="#l186.8"></a><span id="l186.8">                                        PRBool aIgnoreBadAndNOResponses,</span>
<a href="#l186.9"></a><span id="l186.9">                                        char *aGreetingWithCapability = NULL);</span>
<a href="#l186.10"></a><span id="l186.10">   virtual void InitializeState();</span>
<a href="#l186.11"></a><span id="l186.11">   PRBool  CommandFailed();</span>
<a href="#l186.12"></a><span id="l186.12" class="difflineplus">+  void    SetCommandFailed(PRBool failed);</span>
<a href="#l186.13"></a><span id="l186.13"> </span>
<a href="#l186.14"></a><span id="l186.14">     enum eIMAPstate {</span>
<a href="#l186.15"></a><span id="l186.15">         kNonAuthenticated,</span>
<a href="#l186.16"></a><span id="l186.16">         kAuthenticated,</span>
<a href="#l186.17"></a><span id="l186.17">         kFolderSelected</span>
<a href="#l186.18"></a><span id="l186.18">     } ;</span>
<a href="#l186.19"></a><span id="l186.19"> </span>
<a href="#l186.20"></a><span id="l186.20">   virtual eIMAPstate GetIMAPstate();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l187.1"></a><span id="l187.1">new file mode 100644</span>
<a href="#l187.2"></a><span id="l187.2" class="difflineminus">--- /dev/null</span>
<a href="#l187.3"></a><span id="l187.3" class="difflineplus">+++ b/mailnews/imap/test/unit/tail_imap.js</span>
<a href="#l187.4"></a><span id="l187.4" class="difflineat">@@ -0,0 +1,1 @@</span>
<a href="#l187.5"></a><span id="l187.5" class="difflineplus">+load(&quot;../../mailnews/resources/mailShutdown.js&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l188.1"></a><span id="l188.1">new file mode 100644</span>
<a href="#l188.2"></a><span id="l188.2" class="difflineminus">--- /dev/null</span>
<a href="#l188.3"></a><span id="l188.3" class="difflineplus">+++ b/mailnews/imap/test/unit/test_imapContentLength.js</span>
<a href="#l188.4"></a><span id="l188.4" class="difflineat">@@ -0,0 +1,127 @@</span>
<a href="#l188.5"></a><span id="l188.5" class="difflineplus">+/* -*- Mode: JavaScript; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l188.6"></a><span id="l188.6" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l188.7"></a><span id="l188.7" class="difflineplus">+ *</span>
<a href="#l188.8"></a><span id="l188.8" class="difflineplus">+ * Any copyright is dedicated to the Public Domain.</span>
<a href="#l188.9"></a><span id="l188.9" class="difflineplus">+ * http://creativecommons.org/licenses/publicdomain/</span>
<a href="#l188.10"></a><span id="l188.10" class="difflineplus">+ *</span>
<a href="#l188.11"></a><span id="l188.11" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l188.12"></a><span id="l188.12" class="difflineplus">+</span>
<a href="#l188.13"></a><span id="l188.13" class="difflineplus">+/*</span>
<a href="#l188.14"></a><span id="l188.14" class="difflineplus">+ * Test content length for the IMAP protocol. This focuses on necko URLs</span>
<a href="#l188.15"></a><span id="l188.15" class="difflineplus">+ * that are run externally.</span>
<a href="#l188.16"></a><span id="l188.16" class="difflineplus">+ */</span>
<a href="#l188.17"></a><span id="l188.17" class="difflineplus">+</span>
<a href="#l188.18"></a><span id="l188.18" class="difflineplus">+// Take a multipart message as we're testing attachment URLs as well</span>
<a href="#l188.19"></a><span id="l188.19" class="difflineplus">+const gFile = do_get_file(&quot;../../mailnews/data/multipart-complex2&quot;);</span>
<a href="#l188.20"></a><span id="l188.20" class="difflineplus">+var gIMAPDaemon, gIMAPServer, gIMAPIncomingServer, gIMAPInbox;</span>
<a href="#l188.21"></a><span id="l188.21" class="difflineplus">+const gMFNService = Cc[&quot;@mozilla.org/messenger/msgnotificationservice;1&quot;]</span>
<a href="#l188.22"></a><span id="l188.22" class="difflineplus">+                      .getService(Ci.nsIMsgFolderNotificationService);</span>
<a href="#l188.23"></a><span id="l188.23" class="difflineplus">+                   </span>
<a href="#l188.24"></a><span id="l188.24" class="difflineplus">+// Adds some messages directly to a mailbox (eg new mail)</span>
<a href="#l188.25"></a><span id="l188.25" class="difflineplus">+function addMessageToServer(file, mailbox)</span>
<a href="#l188.26"></a><span id="l188.26" class="difflineplus">+{</span>
<a href="#l188.27"></a><span id="l188.27" class="difflineplus">+  let ioService = Cc[&quot;@mozilla.org/network/io-service;1&quot;]</span>
<a href="#l188.28"></a><span id="l188.28" class="difflineplus">+                    .getService(Ci.nsIIOService);</span>
<a href="#l188.29"></a><span id="l188.29" class="difflineplus">+</span>
<a href="#l188.30"></a><span id="l188.30" class="difflineplus">+  let URI = ioService.newFileURI(file).QueryInterface(Ci.nsIFileURL);</span>
<a href="#l188.31"></a><span id="l188.31" class="difflineplus">+  mailbox.addMessage(new imapMessage(URI.spec, mailbox.uidnext++, []));</span>
<a href="#l188.32"></a><span id="l188.32" class="difflineplus">+</span>
<a href="#l188.33"></a><span id="l188.33" class="difflineplus">+  gIMAPInbox.updateFolder(null);</span>
<a href="#l188.34"></a><span id="l188.34" class="difflineplus">+}</span>
<a href="#l188.35"></a><span id="l188.35" class="difflineplus">+</span>
<a href="#l188.36"></a><span id="l188.36" class="difflineplus">+var msgFolderListener =</span>
<a href="#l188.37"></a><span id="l188.37" class="difflineplus">+{</span>
<a href="#l188.38"></a><span id="l188.38" class="difflineplus">+  msgAdded: function(aMsgHdr)</span>
<a href="#l188.39"></a><span id="l188.39" class="difflineplus">+  {</span>
<a href="#l188.40"></a><span id="l188.40" class="difflineplus">+    do_timeout_function(0, verifyContentLength, null, [aMsgHdr]);</span>
<a href="#l188.41"></a><span id="l188.41" class="difflineplus">+  }</span>
<a href="#l188.42"></a><span id="l188.42" class="difflineplus">+};</span>
<a href="#l188.43"></a><span id="l188.43" class="difflineplus">+</span>
<a href="#l188.44"></a><span id="l188.44" class="difflineplus">+</span>
<a href="#l188.45"></a><span id="l188.45" class="difflineplus">+function run_test()</span>
<a href="#l188.46"></a><span id="l188.46" class="difflineplus">+{</span>
<a href="#l188.47"></a><span id="l188.47" class="difflineplus">+  // Disable new mail notifications</span>
<a href="#l188.48"></a><span id="l188.48" class="difflineplus">+  let prefSvc = Cc[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l188.49"></a><span id="l188.49" class="difflineplus">+                  .getService(Ci.nsIPrefBranch);</span>
<a href="#l188.50"></a><span id="l188.50" class="difflineplus">+</span>
<a href="#l188.51"></a><span id="l188.51" class="difflineplus">+  prefSvc.setBoolPref(&quot;mail.biff.play_sound&quot;, false);</span>
<a href="#l188.52"></a><span id="l188.52" class="difflineplus">+  prefSvc.setBoolPref(&quot;mail.biff.show_alert&quot;, false);</span>
<a href="#l188.53"></a><span id="l188.53" class="difflineplus">+  prefSvc.setBoolPref(&quot;mail.biff.show_tray_icon&quot;, false);</span>
<a href="#l188.54"></a><span id="l188.54" class="difflineplus">+  prefSvc.setBoolPref(&quot;mail.biff.animate_dock_icon&quot;, false);</span>
<a href="#l188.55"></a><span id="l188.55" class="difflineplus">+</span>
<a href="#l188.56"></a><span id="l188.56" class="difflineplus">+  // Set up nsIMsgFolderListener to get the header when it's received</span>
<a href="#l188.57"></a><span id="l188.57" class="difflineplus">+  gMFNService.addListener(msgFolderListener, gMFNService.msgAdded);</span>
<a href="#l188.58"></a><span id="l188.58" class="difflineplus">+</span>
<a href="#l188.59"></a><span id="l188.59" class="difflineplus">+  // set up IMAP fakeserver and incoming server</span>
<a href="#l188.60"></a><span id="l188.60" class="difflineplus">+  gIMAPDaemon = new imapDaemon();</span>
<a href="#l188.61"></a><span id="l188.61" class="difflineplus">+  gIMAPServer = makeServer(gIMAPDaemon, &quot;&quot;);</span>
<a href="#l188.62"></a><span id="l188.62" class="difflineplus">+  gIMAPIncomingServer = createLocalIMAPServer();</span>
<a href="#l188.63"></a><span id="l188.63" class="difflineplus">+</span>
<a href="#l188.64"></a><span id="l188.64" class="difflineplus">+  // we need a local account for the IMAP server to have its sent messages in</span>
<a href="#l188.65"></a><span id="l188.65" class="difflineplus">+  loadLocalMailAccount();</span>
<a href="#l188.66"></a><span id="l188.66" class="difflineplus">+</span>
<a href="#l188.67"></a><span id="l188.67" class="difflineplus">+  // We need an identity so that updateFolder doesn't fail</span>
<a href="#l188.68"></a><span id="l188.68" class="difflineplus">+  let acctMgr = Cc[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l188.69"></a><span id="l188.69" class="difflineplus">+                  .getService(Ci.nsIMsgAccountManager);</span>
<a href="#l188.70"></a><span id="l188.70" class="difflineplus">+  let imapAccount = acctMgr.createAccount();</span>
<a href="#l188.71"></a><span id="l188.71" class="difflineplus">+  let identity = acctMgr.createIdentity();</span>
<a href="#l188.72"></a><span id="l188.72" class="difflineplus">+  imapAccount.addIdentity(identity);</span>
<a href="#l188.73"></a><span id="l188.73" class="difflineplus">+  imapAccount.defaultIdentity = identity;</span>
<a href="#l188.74"></a><span id="l188.74" class="difflineplus">+  imapAccount.incomingServer = gIMAPIncomingServer;</span>
<a href="#l188.75"></a><span id="l188.75" class="difflineplus">+  acctMgr.defaultAccount = imapAccount;</span>
<a href="#l188.76"></a><span id="l188.76" class="difflineplus">+</span>
<a href="#l188.77"></a><span id="l188.77" class="difflineplus">+  // The server doesn't support more than one connection</span>
<a href="#l188.78"></a><span id="l188.78" class="difflineplus">+  prefSvc.setIntPref(&quot;mail.server.server1.max_cached_connections&quot;, 1);</span>
<a href="#l188.79"></a><span id="l188.79" class="difflineplus">+  // We aren't interested in downloading messages automatically</span>
<a href="#l188.80"></a><span id="l188.80" class="difflineplus">+  prefSvc.setBoolPref(&quot;mail.server.server1.download_on_biff&quot;, false);</span>
<a href="#l188.81"></a><span id="l188.81" class="difflineplus">+</span>
<a href="#l188.82"></a><span id="l188.82" class="difflineplus">+  gIMAPInbox = gIMAPIncomingServer.rootFolder.getChildNamed(&quot;Inbox&quot;);</span>
<a href="#l188.83"></a><span id="l188.83" class="difflineplus">+  gIMAPInbox.flags &amp;= ~Ci.nsMsgFolderFlags.Offline;</span>
<a href="#l188.84"></a><span id="l188.84" class="difflineplus">+</span>
<a href="#l188.85"></a><span id="l188.85" class="difflineplus">+  do_test_pending();</span>
<a href="#l188.86"></a><span id="l188.86" class="difflineplus">+</span>
<a href="#l188.87"></a><span id="l188.87" class="difflineplus">+  // Add a message to the IMAP server</span>
<a href="#l188.88"></a><span id="l188.88" class="difflineplus">+  addMessageToServer(gFile, gIMAPDaemon.getMailbox(&quot;INBOX&quot;));</span>
<a href="#l188.89"></a><span id="l188.89" class="difflineplus">+</span>
<a href="#l188.90"></a><span id="l188.90" class="difflineplus">+  gIMAPInbox.updateFolder(null);</span>
<a href="#l188.91"></a><span id="l188.91" class="difflineplus">+}</span>
<a href="#l188.92"></a><span id="l188.92" class="difflineplus">+</span>
<a href="#l188.93"></a><span id="l188.93" class="difflineplus">+function verifyContentLength(aMsgHdr)</span>
<a href="#l188.94"></a><span id="l188.94" class="difflineplus">+{</span>
<a href="#l188.95"></a><span id="l188.95" class="difflineplus">+  let messageUri = gIMAPInbox.getUriForMsg(aMsgHdr);</span>
<a href="#l188.96"></a><span id="l188.96" class="difflineplus">+  // Convert this to a URI that necko can run</span>
<a href="#l188.97"></a><span id="l188.97" class="difflineplus">+  let messenger = Cc[&quot;@mozilla.org/messenger;1&quot;].createInstance(Ci.nsIMessenger);</span>
<a href="#l188.98"></a><span id="l188.98" class="difflineplus">+  let neckoURL = {};</span>
<a href="#l188.99"></a><span id="l188.99" class="difflineplus">+  let messageService = messenger.messageServiceFromURI(messageUri);</span>
<a href="#l188.100"></a><span id="l188.100" class="difflineplus">+  messageService.GetUrlForUri(messageUri, neckoURL, null);</span>
<a href="#l188.101"></a><span id="l188.101" class="difflineplus">+  // Don't use the necko URL directly. Instead, get the spec and create a new</span>
<a href="#l188.102"></a><span id="l188.102" class="difflineplus">+  // URL using the IO service</span>
<a href="#l188.103"></a><span id="l188.103" class="difflineplus">+  let urlToRun = gIOService.newURI(neckoURL.value.spec, null, null);</span>
<a href="#l188.104"></a><span id="l188.104" class="difflineplus">+</span>
<a href="#l188.105"></a><span id="l188.105" class="difflineplus">+  // Get a channel from this URI, and check its content length</span>
<a href="#l188.106"></a><span id="l188.106" class="difflineplus">+  let channel = gIOService.newChannelFromURI(urlToRun);</span>
<a href="#l188.107"></a><span id="l188.107" class="difflineplus">+  do_check_eq(channel.contentLength, gFile.fileSize);</span>
<a href="#l188.108"></a><span id="l188.108" class="difflineplus">+</span>
<a href="#l188.109"></a><span id="l188.109" class="difflineplus">+  // Now try an attachment. &amp;part=1.2</span>
<a href="#l188.110"></a><span id="l188.110" class="difflineplus">+  let attachmentURL = gIOService.newURI(neckoURL.value.spec + &quot;&amp;part=1.2&quot;,</span>
<a href="#l188.111"></a><span id="l188.111" class="difflineplus">+                                        null, null);</span>
<a href="#l188.112"></a><span id="l188.112" class="difflineplus">+  let attachmentChannel = gIOService.newChannelFromURI(attachmentURL);</span>
<a href="#l188.113"></a><span id="l188.113" class="difflineplus">+  // Currently attachments have their content length set to the length of the</span>
<a href="#l188.114"></a><span id="l188.114" class="difflineplus">+  // entire message</span>
<a href="#l188.115"></a><span id="l188.115" class="difflineplus">+  do_check_eq(channel.contentLength, gFile.fileSize);</span>
<a href="#l188.116"></a><span id="l188.116" class="difflineplus">+</span>
<a href="#l188.117"></a><span id="l188.117" class="difflineplus">+  do_timeout_function(1000, endTest);</span>
<a href="#l188.118"></a><span id="l188.118" class="difflineplus">+}</span>
<a href="#l188.119"></a><span id="l188.119" class="difflineplus">+</span>
<a href="#l188.120"></a><span id="l188.120" class="difflineplus">+function endTest()</span>
<a href="#l188.121"></a><span id="l188.121" class="difflineplus">+{</span>
<a href="#l188.122"></a><span id="l188.122" class="difflineplus">+  gIMAPServer.resetTest();</span>
<a href="#l188.123"></a><span id="l188.123" class="difflineplus">+  gIMAPIncomingServer.closeCachedConnections();</span>
<a href="#l188.124"></a><span id="l188.124" class="difflineplus">+  gIMAPServer.performTest();</span>
<a href="#l188.125"></a><span id="l188.125" class="difflineplus">+  gIMAPServer.stop();</span>
<a href="#l188.126"></a><span id="l188.126" class="difflineplus">+  let thread = gThreadManager.currentThread;</span>
<a href="#l188.127"></a><span id="l188.127" class="difflineplus">+  while (thread.hasPendingEvents())</span>
<a href="#l188.128"></a><span id="l188.128" class="difflineplus">+    thread.processNextEvent(true);</span>
<a href="#l188.129"></a><span id="l188.129" class="difflineplus">+</span>
<a href="#l188.130"></a><span id="l188.130" class="difflineplus">+  do_test_finished(); // for the one in run_test()</span>
<a href="#l188.131"></a><span id="l188.131" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l189.1"></a><span id="l189.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_imapFolderCopy.js</span>
<a href="#l189.2"></a><span id="l189.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_imapFolderCopy.js</span>
<a href="#l189.3"></a><span id="l189.3" class="difflineat">@@ -47,16 +47,44 @@ const gTestArray =</span>
<a href="#l189.4"></a><span id="l189.4">     let folder2 = gIMAPInbox.getChildNamed(&quot;empty 2&quot;);</span>
<a href="#l189.5"></a><span id="l189.5">     dump(&quot;found folder2\n&quot;);</span>
<a href="#l189.6"></a><span id="l189.6">     let folder3 = gIMAPInbox.getChildNamed(&quot;empty 3&quot;);</span>
<a href="#l189.7"></a><span id="l189.7">     dump(&quot;found folder3\n&quot;);</span>
<a href="#l189.8"></a><span id="l189.8">     do_check_neq(folder1, null);</span>
<a href="#l189.9"></a><span id="l189.9">     do_check_neq(folder2, null);</span>
<a href="#l189.10"></a><span id="l189.10">     do_check_neq(folder3, null);</span>
<a href="#l189.11"></a><span id="l189.11">     doTest(++gCurTestNum);</span>
<a href="#l189.12"></a><span id="l189.12" class="difflineplus">+  },</span>
<a href="#l189.13"></a><span id="l189.13" class="difflineplus">+  function moveImapFolder1() {</span>
<a href="#l189.14"></a><span id="l189.14" class="difflineplus">+    let folders = new Array;</span>
<a href="#l189.15"></a><span id="l189.15" class="difflineplus">+    let folder1 = gIMAPInbox.getChildNamed(&quot;empty 1&quot;);</span>
<a href="#l189.16"></a><span id="l189.16" class="difflineplus">+    let folder2 = gIMAPInbox.getChildNamed(&quot;empty 2&quot;);</span>
<a href="#l189.17"></a><span id="l189.17" class="difflineplus">+    folders.push(folder2.QueryInterface(Ci.nsIMsgFolder));</span>
<a href="#l189.18"></a><span id="l189.18" class="difflineplus">+    let array = toXPCOMArray(folders, Ci.nsIMutableArray);</span>
<a href="#l189.19"></a><span id="l189.19" class="difflineplus">+    gCopyService.CopyFolders(array, folder1, true, CopyListener, null);</span>
<a href="#l189.20"></a><span id="l189.20" class="difflineplus">+  },</span>
<a href="#l189.21"></a><span id="l189.21" class="difflineplus">+  function moveImapFolder2() {</span>
<a href="#l189.22"></a><span id="l189.22" class="difflineplus">+    let folders = new Array;</span>
<a href="#l189.23"></a><span id="l189.23" class="difflineplus">+    let folder1 = gIMAPInbox.getChildNamed(&quot;empty 1&quot;);</span>
<a href="#l189.24"></a><span id="l189.24" class="difflineplus">+    let folder3 = gIMAPInbox.getChildNamed(&quot;empty 3&quot;);</span>
<a href="#l189.25"></a><span id="l189.25" class="difflineplus">+    folders.push(folder3.QueryInterface(Ci.nsIMsgFolder));</span>
<a href="#l189.26"></a><span id="l189.26" class="difflineplus">+    let array = toXPCOMArray(folders, Ci.nsIMutableArray);</span>
<a href="#l189.27"></a><span id="l189.27" class="difflineplus">+    gCopyService.CopyFolders(array, folder1, true, CopyListener, null);</span>
<a href="#l189.28"></a><span id="l189.28" class="difflineplus">+  },</span>
<a href="#l189.29"></a><span id="l189.29" class="difflineplus">+  function verifyImapFolders() {</span>
<a href="#l189.30"></a><span id="l189.30" class="difflineplus">+    let folder1 = gIMAPInbox.getChildNamed(&quot;empty 1&quot;);</span>
<a href="#l189.31"></a><span id="l189.31" class="difflineplus">+    dump(&quot;found folder1\n&quot;);</span>
<a href="#l189.32"></a><span id="l189.32" class="difflineplus">+    let folder2 = folder1.getChildNamed(&quot;empty 2&quot;);</span>
<a href="#l189.33"></a><span id="l189.33" class="difflineplus">+    dump(&quot;found folder2\n&quot;);</span>
<a href="#l189.34"></a><span id="l189.34" class="difflineplus">+    let folder3 = folder1.getChildNamed(&quot;empty 3&quot;);</span>
<a href="#l189.35"></a><span id="l189.35" class="difflineplus">+    dump(&quot;found folder3\n&quot;);</span>
<a href="#l189.36"></a><span id="l189.36" class="difflineplus">+    do_check_neq(folder1, null);</span>
<a href="#l189.37"></a><span id="l189.37" class="difflineplus">+    do_check_neq(folder2, null);</span>
<a href="#l189.38"></a><span id="l189.38" class="difflineplus">+    do_check_neq(folder3, null);</span>
<a href="#l189.39"></a><span id="l189.39" class="difflineplus">+    doTest(++gCurTestNum);</span>
<a href="#l189.40"></a><span id="l189.40">   }</span>
<a href="#l189.41"></a><span id="l189.41"> ];</span>
<a href="#l189.42"></a><span id="l189.42"> </span>
<a href="#l189.43"></a><span id="l189.43"> function run_test()</span>
<a href="#l189.44"></a><span id="l189.44"> {</span>
<a href="#l189.45"></a><span id="l189.45">   // This is before any of the actual tests, so...</span>
<a href="#l189.46"></a><span id="l189.46">   gTest = 0;</span>
<a href="#l189.47"></a><span id="l189.47"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l190.1"></a><span id="l190.1">new file mode 100644</span>
<a href="#l190.2"></a><span id="l190.2" class="difflineminus">--- /dev/null</span>
<a href="#l190.3"></a><span id="l190.3" class="difflineplus">+++ b/mailnews/import/test/unit/tail_import.js</span>
<a href="#l190.4"></a><span id="l190.4" class="difflineat">@@ -0,0 +1,1 @@</span>
<a href="#l190.5"></a><span id="l190.5" class="difflineplus">+load(&quot;../../mailnews/resources/mailShutdown.js&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l191.1"></a><span id="l191.1" class="difflineminus">--- a/mailnews/jar.mn</span>
<a href="#l191.2"></a><span id="l191.2" class="difflineplus">+++ b/mailnews/jar.mn</span>
<a href="#l191.3"></a><span id="l191.3" class="difflineat">@@ -83,17 +83,16 @@ messenger.jar:</span>
<a href="#l191.4"></a><span id="l191.4">     content/messenger/msgSynchronize.js                                        (base/resources/content/msgSynchronize.js)</span>
<a href="#l191.5"></a><span id="l191.5">     content/messenger/folderProps.xul                                          (base/resources/content/folderProps.xul)</span>
<a href="#l191.6"></a><span id="l191.6">     content/messenger/folderProps.js                                           (base/resources/content/folderProps.js)</span>
<a href="#l191.7"></a><span id="l191.7">     content/messenger/folderWidgets.xml                                        (base/resources/content/folderWidgets.xml)</span>
<a href="#l191.8"></a><span id="l191.8">     content/messenger/retention.js                                             (base/resources/content/retention.js)</span>
<a href="#l191.9"></a><span id="l191.9">     content/messenger/shareglue.js                                             (base/resources/content/shareglue.js)</span>
<a href="#l191.10"></a><span id="l191.10">     content/messenger/newFolderDialog.xul                                      (base/resources/content/newFolderDialog.xul)</span>
<a href="#l191.11"></a><span id="l191.11">     content/messenger/newFolderDialog.js                                       (base/resources/content/newFolderDialog.js)</span>
<a href="#l191.12"></a><span id="l191.12" class="difflineminus">-    content/messenger/msgViewNavigation.js                                     (base/resources/content/msgViewNavigation.js)</span>
<a href="#l191.13"></a><span id="l191.13"> *   content/messenger/msgAccountCentral.xul                                    (base/resources/content/msgAccountCentral.xul)</span>
<a href="#l191.14"></a><span id="l191.14">     content/messenger/msgAccountCentral.js                                     (base/resources/content/msgAccountCentral.js)</span>
<a href="#l191.15"></a><span id="l191.15">     content/messenger/msgFolderPickerOverlay.js                                (base/resources/content/msgFolderPickerOverlay.js)</span>
<a href="#l191.16"></a><span id="l191.16">     content/messenger/renameFolderDialog.xul                                   (base/resources/content/renameFolderDialog.xul)</span>
<a href="#l191.17"></a><span id="l191.17">     content/messenger/renameFolderDialog.js                                    (base/resources/content/renameFolderDialog.js)</span>
<a href="#l191.18"></a><span id="l191.18">     content/messenger/virtualFolderProperties.xul                              (base/resources/content/virtualFolderProperties.xul)</span>
<a href="#l191.19"></a><span id="l191.19">     content/messenger/virtualFolderProperties.js                               (base/resources/content/virtualFolderProperties.js)</span>
<a href="#l191.20"></a><span id="l191.20">     content/messenger/virtualFolderListDialog.xul                              (base/resources/content/virtualFolderListDialog.xul)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l192.1"></a><span id="l192.1" class="difflineminus">--- a/mailnews/local/src/nsLocalMailFolder.cpp</span>
<a href="#l192.2"></a><span id="l192.2" class="difflineplus">+++ b/mailnews/local/src/nsLocalMailFolder.cpp</span>
<a href="#l192.3"></a><span id="l192.3" class="difflineat">@@ -963,17 +963,20 @@ nsresult nsMsgLocalMailFolder::IsChildOf</span>
<a href="#l192.4"></a><span id="l192.4">     thisFolder = parentFolder;</span>
<a href="#l192.5"></a><span id="l192.5">   }</span>
<a href="#l192.6"></a><span id="l192.6">   return rv;</span>
<a href="#l192.7"></a><span id="l192.7"> }</span>
<a href="#l192.8"></a><span id="l192.8"> </span>
<a href="#l192.9"></a><span id="l192.9"> NS_IMETHODIMP nsMsgLocalMailFolder::Delete()</span>
<a href="#l192.10"></a><span id="l192.10"> {</span>
<a href="#l192.11"></a><span id="l192.11">   nsresult rv;</span>
<a href="#l192.12"></a><span id="l192.12" class="difflineminus">-  if(mDatabase)</span>
<a href="#l192.13"></a><span id="l192.13" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDBService&gt; msgDBService = do_GetService(NS_MSGDB_SERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l192.14"></a><span id="l192.14" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l192.15"></a><span id="l192.15" class="difflineplus">+  msgDBService-&gt;CachedDBForFolder(this, getter_AddRefs(mDatabase));</span>
<a href="#l192.16"></a><span id="l192.16" class="difflineplus">+  if (mDatabase)</span>
<a href="#l192.17"></a><span id="l192.17">   {</span>
<a href="#l192.18"></a><span id="l192.18">     mDatabase-&gt;ForceClosed();</span>
<a href="#l192.19"></a><span id="l192.19">     mDatabase = nsnull;</span>
<a href="#l192.20"></a><span id="l192.20">   }</span>
<a href="#l192.21"></a><span id="l192.21"> </span>
<a href="#l192.22"></a><span id="l192.22">   nsCOMPtr&lt;nsILocalFile&gt; pathFile;</span>
<a href="#l192.23"></a><span id="l192.23">   rv = GetFilePath(getter_AddRefs(pathFile));</span>
<a href="#l192.24"></a><span id="l192.24">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l192.25"></a><span id="l192.25" class="difflineat">@@ -2177,18 +2180,21 @@ nsMsgLocalMailFolder::CopyFileMessage(ns</span>
<a href="#l192.26"></a><span id="l192.26"> </span>
<a href="#l192.27"></a><span id="l192.27">     if (NS_SUCCEEDED(rv))</span>
<a href="#l192.28"></a><span id="l192.28">       rv = CopyData(inputStream, (PRInt32) fileSize);</span>
<a href="#l192.29"></a><span id="l192.29"> </span>
<a href="#l192.30"></a><span id="l192.30">     if (NS_SUCCEEDED(rv))</span>
<a href="#l192.31"></a><span id="l192.31">       rv = EndCopy(PR_TRUE);</span>
<a href="#l192.32"></a><span id="l192.32"> </span>
<a href="#l192.33"></a><span id="l192.33">     //mDatabase should have been initialized above - if we got msgDb</span>
<a href="#l192.34"></a><span id="l192.34" class="difflineplus">+    // If we were going to delete, here is where we would do it. But because</span>
<a href="#l192.35"></a><span id="l192.35" class="difflineplus">+    // existing code already supports doing those deletes, we are just going</span>
<a href="#l192.36"></a><span id="l192.36" class="difflineplus">+    // to end the copy.</span>
<a href="#l192.37"></a><span id="l192.37">     if (NS_SUCCEEDED(rv) &amp;&amp; msgToReplace &amp;&amp; mDatabase)</span>
<a href="#l192.38"></a><span id="l192.38" class="difflineminus">-      rv = DeleteMessage(msgToReplace, msgWindow, PR_TRUE, PR_TRUE);</span>
<a href="#l192.39"></a><span id="l192.39" class="difflineplus">+      rv = OnCopyCompleted(fileSupport, PR_TRUE);</span>
<a href="#l192.40"></a><span id="l192.40"> </span>
<a href="#l192.41"></a><span id="l192.41">     if (inputStream)</span>
<a href="#l192.42"></a><span id="l192.42">       inputStream-&gt;Close();</span>
<a href="#l192.43"></a><span id="l192.43">   }</span>
<a href="#l192.44"></a><span id="l192.44"> </span>
<a href="#l192.45"></a><span id="l192.45">   if(NS_FAILED(rv))</span>
<a href="#l192.46"></a><span id="l192.46">     (void) OnCopyCompleted(fileSupport, PR_FALSE);</span>
<a href="#l192.47"></a><span id="l192.47"> </span>
<a href="#l192.48"></a><span id="l192.48" class="difflineat">@@ -2525,18 +2531,17 @@ NS_IMETHODIMP nsMsgLocalMailFolder::EndC</span>
<a href="#l192.49"></a><span id="l192.49">         mCopyState-&gt;m_fileStream-&gt;Flush();</span>
<a href="#l192.50"></a><span id="l192.50">       else</span>
<a href="#l192.51"></a><span id="l192.51">         seekableStream-&gt;Seek(nsISeekableStream::NS_SEEK_CUR, 0);</span>
<a href="#l192.52"></a><span id="l192.52">     }</span>
<a href="#l192.53"></a><span id="l192.53">   }</span>
<a href="#l192.54"></a><span id="l192.54">   //Copy the header to the new database</span>
<a href="#l192.55"></a><span id="l192.55">   if (copySucceeded &amp;&amp; mCopyState-&gt;m_message)</span>
<a href="#l192.56"></a><span id="l192.56">   {</span>
<a href="#l192.57"></a><span id="l192.57" class="difflineminus">-    //  CopyMessages() goes here; CopyFileMessage() never gets in here because</span>
<a href="#l192.58"></a><span id="l192.58" class="difflineminus">-    //  the mCopyState-&gt;m_message will be always null for file message</span>
<a href="#l192.59"></a><span id="l192.59" class="difflineplus">+    //  CopyMessages() goes here, and CopyFileMessages() with metadata to save;</span>
<a href="#l192.60"></a><span id="l192.60">     nsCOMPtr&lt;nsIMsgDBHdr&gt; newHdr;</span>
<a href="#l192.61"></a><span id="l192.61">     if(!mCopyState-&gt;m_parseMsgState)</span>
<a href="#l192.62"></a><span id="l192.62">     {</span>
<a href="#l192.63"></a><span id="l192.63">       if(mCopyState-&gt;m_destDB)</span>
<a href="#l192.64"></a><span id="l192.64">       {</span>
<a href="#l192.65"></a><span id="l192.65">         rv = mCopyState-&gt;m_destDB-&gt;CopyHdrFromExistingHdr(mCopyState-&gt;m_curDstKey,</span>
<a href="#l192.66"></a><span id="l192.66">           mCopyState-&gt;m_message, PR_TRUE,</span>
<a href="#l192.67"></a><span id="l192.67">           getter_AddRefs(newHdr));</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l193.1"></a><span id="l193.1" class="difflineminus">--- a/mailnews/local/src/nsMailboxProtocol.cpp</span>
<a href="#l193.2"></a><span id="l193.2" class="difflineplus">+++ b/mailnews/local/src/nsMailboxProtocol.cpp</span>
<a href="#l193.3"></a><span id="l193.3" class="difflineat">@@ -92,41 +92,16 @@ nsMailboxProtocol::nsMailboxProtocol(nsI</span>
<a href="#l193.4"></a><span id="l193.4"> }</span>
<a href="#l193.5"></a><span id="l193.5"> </span>
<a href="#l193.6"></a><span id="l193.6"> nsMailboxProtocol::~nsMailboxProtocol()</span>
<a href="#l193.7"></a><span id="l193.7"> {</span>
<a href="#l193.8"></a><span id="l193.8">   // free our local state </span>
<a href="#l193.9"></a><span id="l193.9">   delete m_lineStreamBuffer;</span>
<a href="#l193.10"></a><span id="l193.10"> }</span>
<a href="#l193.11"></a><span id="l193.11"> </span>
<a href="#l193.12"></a><span id="l193.12" class="difflineminus">-NS_IMETHODIMP nsMailboxProtocol::GetContentLength(PRInt32 * aContentLength)</span>
<a href="#l193.13"></a><span id="l193.13" class="difflineminus">-{</span>
<a href="#l193.14"></a><span id="l193.14" class="difflineminus">-  *aContentLength = -1;</span>
<a href="#l193.15"></a><span id="l193.15" class="difflineminus">-  if (m_mailboxAction == nsIMailboxUrl::ActionParseMailbox)</span>
<a href="#l193.16"></a><span id="l193.16" class="difflineminus">-  {</span>
<a href="#l193.17"></a><span id="l193.17" class="difflineminus">-    // our file transport knows the entire length of the berkley mail folder</span>
<a href="#l193.18"></a><span id="l193.18" class="difflineminus">-    // so get it from there.</span>
<a href="#l193.19"></a><span id="l193.19" class="difflineminus">-    if (!m_request)</span>
<a href="#l193.20"></a><span id="l193.20" class="difflineminus">-      return NS_OK;</span>
<a href="#l193.21"></a><span id="l193.21" class="difflineminus">-</span>
<a href="#l193.22"></a><span id="l193.22" class="difflineminus">-    nsCOMPtr&lt;nsIChannel&gt; info = do_QueryInterface(m_request);</span>
<a href="#l193.23"></a><span id="l193.23" class="difflineminus">-    if (info) info-&gt;GetContentLength(aContentLength);</span>
<a href="#l193.24"></a><span id="l193.24" class="difflineminus">-    return NS_OK;</span>
<a href="#l193.25"></a><span id="l193.25" class="difflineminus">-</span>
<a href="#l193.26"></a><span id="l193.26" class="difflineminus">-  }</span>
<a href="#l193.27"></a><span id="l193.27" class="difflineminus">-  else if (m_runningUrl)</span>
<a href="#l193.28"></a><span id="l193.28" class="difflineminus">-  {</span>
<a href="#l193.29"></a><span id="l193.29" class="difflineminus">-    PRUint32 msgSize = 0;</span>
<a href="#l193.30"></a><span id="l193.30" class="difflineminus">-    m_runningUrl-&gt;GetMessageSize(&amp;msgSize);</span>
<a href="#l193.31"></a><span id="l193.31" class="difflineminus">-    *aContentLength = (PRInt32) msgSize;</span>
<a href="#l193.32"></a><span id="l193.32" class="difflineminus">-  }</span>
<a href="#l193.33"></a><span id="l193.33" class="difflineminus">-</span>
<a href="#l193.34"></a><span id="l193.34" class="difflineminus">-  return NS_OK;</span>
<a href="#l193.35"></a><span id="l193.35" class="difflineminus">-}</span>
<a href="#l193.36"></a><span id="l193.36" class="difflineminus">-</span>
<a href="#l193.37"></a><span id="l193.37"> nsresult nsMailboxProtocol::OpenMultipleMsgTransport(PRUint32 offset, PRInt32 size)</span>
<a href="#l193.38"></a><span id="l193.38"> {</span>
<a href="#l193.39"></a><span id="l193.39">   nsresult rv;</span>
<a href="#l193.40"></a><span id="l193.40"> </span>
<a href="#l193.41"></a><span id="l193.41">   nsCOMPtr&lt;nsIStreamTransportService&gt; serv =</span>
<a href="#l193.42"></a><span id="l193.42">       do_GetService(NS_STREAMTRANSPORTSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l193.43"></a><span id="l193.43">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l193.44"></a><span id="l193.44"> </span>
<a href="#l193.45"></a><span id="l193.45" class="difflineat">@@ -178,29 +153,45 @@ nsresult nsMailboxProtocol::Initialize(n</span>
<a href="#l193.46"></a><span id="l193.46">       // clear stopped flag on msg window, because we care.</span>
<a href="#l193.47"></a><span id="l193.47">       nsCOMPtr &lt;nsIMsgMailNewsUrl&gt; mailnewsUrl = do_QueryInterface(m_runningUrl);</span>
<a href="#l193.48"></a><span id="l193.48">       if (mailnewsUrl)</span>
<a href="#l193.49"></a><span id="l193.49">       {</span>
<a href="#l193.50"></a><span id="l193.50">         mailnewsUrl-&gt;GetMsgWindow(getter_AddRefs(window));</span>
<a href="#l193.51"></a><span id="l193.51">         if (window)</span>
<a href="#l193.52"></a><span id="l193.52">           window-&gt;SetStopped(PR_FALSE);</span>
<a href="#l193.53"></a><span id="l193.53">       }</span>
<a href="#l193.54"></a><span id="l193.54" class="difflineplus">+</span>
<a href="#l193.55"></a><span id="l193.55">       if (m_mailboxAction == nsIMailboxUrl::ActionParseMailbox)</span>
<a href="#l193.56"></a><span id="l193.56" class="difflineplus">+      {</span>
<a href="#l193.57"></a><span id="l193.57" class="difflineplus">+        // Set the length of the file equal to the max progress</span>
<a href="#l193.58"></a><span id="l193.58" class="difflineplus">+        nsCOMPtr&lt;nsIFile&gt; file;</span>
<a href="#l193.59"></a><span id="l193.59" class="difflineplus">+        GetFileFromURL(aURL, getter_AddRefs(file));</span>
<a href="#l193.60"></a><span id="l193.60" class="difflineplus">+        if (file)</span>
<a href="#l193.61"></a><span id="l193.61" class="difflineplus">+        {</span>
<a href="#l193.62"></a><span id="l193.62" class="difflineplus">+          PRInt64 fileSize = 0;</span>
<a href="#l193.63"></a><span id="l193.63" class="difflineplus">+          file-&gt;GetFileSize(&amp;fileSize);</span>
<a href="#l193.64"></a><span id="l193.64" class="difflineplus">+          mailnewsUrl-&gt;SetMaxProgress(fileSize);</span>
<a href="#l193.65"></a><span id="l193.65" class="difflineplus">+        }</span>
<a href="#l193.66"></a><span id="l193.66" class="difflineplus">+</span>
<a href="#l193.67"></a><span id="l193.67">         rv = OpenFileSocket(aURL, 0, -1 /* read in all the bytes in the file */);</span>
<a href="#l193.68"></a><span id="l193.68" class="difflineplus">+      }</span>
<a href="#l193.69"></a><span id="l193.69">       else</span>
<a href="#l193.70"></a><span id="l193.70">       {</span>
<a href="#l193.71"></a><span id="l193.71">         // we need to specify a byte range to read in so we read in JUST the message we want.</span>
<a href="#l193.72"></a><span id="l193.72">         rv = SetupMessageExtraction();</span>
<a href="#l193.73"></a><span id="l193.73">         if (NS_FAILED(rv)) return rv;</span>
<a href="#l193.74"></a><span id="l193.74">         nsMsgKey aMsgKey;</span>
<a href="#l193.75"></a><span id="l193.75">         PRUint32 aMsgSize = 0;</span>
<a href="#l193.76"></a><span id="l193.76">         rv = m_runningUrl-&gt;GetMessageKey(&amp;aMsgKey);</span>
<a href="#l193.77"></a><span id="l193.77">         NS_ASSERTION(NS_SUCCEEDED(rv), &quot;oops....i messed something up&quot;);</span>
<a href="#l193.78"></a><span id="l193.78">         rv = m_runningUrl-&gt;GetMessageSize(&amp;aMsgSize);</span>
<a href="#l193.79"></a><span id="l193.79">         NS_ASSERTION(NS_SUCCEEDED(rv), &quot;oops....i messed something up&quot;);</span>
<a href="#l193.80"></a><span id="l193.80" class="difflineplus">+        SetContentLength(aMsgSize);</span>
<a href="#l193.81"></a><span id="l193.81" class="difflineplus">+        mailnewsUrl-&gt;SetMaxProgress(aMsgSize);</span>
<a href="#l193.82"></a><span id="l193.82" class="difflineplus">+</span>
<a href="#l193.83"></a><span id="l193.83">         if (RunningMultipleMsgUrl())</span>
<a href="#l193.84"></a><span id="l193.84">         {</span>
<a href="#l193.85"></a><span id="l193.85">           rv = OpenFileSocketForReuse(aURL, (PRUint32) aMsgKey, aMsgSize);</span>
<a href="#l193.86"></a><span id="l193.86">           // if we're running multiple msg url, we clear the event sink because the multiple</span>
<a href="#l193.87"></a><span id="l193.87">           // msg urls will handle setting the progress.</span>
<a href="#l193.88"></a><span id="l193.88">           mProgressEventSink = nsnull;</span>
<a href="#l193.89"></a><span id="l193.89">         }</span>
<a href="#l193.90"></a><span id="l193.90">         else</span>
<a href="#l193.91"></a><span id="l193.91" class="difflineat">@@ -647,24 +638,24 @@ PRInt32 nsMailboxProtocol::ReadMessageRe</span>
<a href="#l193.92"></a><span id="l193.92">           SetFlag(MAILBOX_MSG_PARSE_FIRST_LINE);</span>
<a href="#l193.93"></a><span id="l193.93">       } </span>
<a href="#l193.94"></a><span id="l193.94">       PR_Free(saveLine);</span>
<a href="#l193.95"></a><span id="l193.95">     }</span>
<a href="#l193.96"></a><span id="l193.96">     while (line &amp;&amp; !pauseForMoreData);</span>
<a href="#l193.97"></a><span id="l193.97">   }</span>
<a href="#l193.98"></a><span id="l193.98">   </span>
<a href="#l193.99"></a><span id="l193.99">   SetFlag(MAILBOX_PAUSE_FOR_READ); // wait for more data to become available...</span>
<a href="#l193.100"></a><span id="l193.100" class="difflineminus">-  if (mProgressEventSink)</span>
<a href="#l193.101"></a><span id="l193.101" class="difflineplus">+  if (mProgressEventSink &amp;&amp; m_runningUrl)</span>
<a href="#l193.102"></a><span id="l193.102">   {</span>
<a href="#l193.103"></a><span id="l193.103" class="difflineminus">-    PRInt32 contentLength = 0;</span>
<a href="#l193.104"></a><span id="l193.104" class="difflineminus">-    GetContentLength(&amp;contentLength);</span>
<a href="#l193.105"></a><span id="l193.105" class="difflineminus">-    // XXX 64-bit</span>
<a href="#l193.106"></a><span id="l193.106" class="difflineplus">+    PRInt64 maxProgress;</span>
<a href="#l193.107"></a><span id="l193.107" class="difflineplus">+    nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsUrl(do_QueryInterface(m_runningUrl));</span>
<a href="#l193.108"></a><span id="l193.108" class="difflineplus">+    mailnewsUrl-&gt;GetMaxProgress(&amp;maxProgress);</span>
<a href="#l193.109"></a><span id="l193.109">     mProgressEventSink-&gt;OnProgress(this, m_channelContext,</span>
<a href="#l193.110"></a><span id="l193.110" class="difflineminus">-                                   nsUint64(mCurrentProgress),</span>
<a href="#l193.111"></a><span id="l193.111" class="difflineminus">-                                   nsUint64(contentLength));</span>
<a href="#l193.112"></a><span id="l193.112" class="difflineplus">+                                   mCurrentProgress,</span>
<a href="#l193.113"></a><span id="l193.113" class="difflineplus">+                                   maxProgress);</span>
<a href="#l193.114"></a><span id="l193.114">   }</span>
<a href="#l193.115"></a><span id="l193.115">   </span>
<a href="#l193.116"></a><span id="l193.116">   if (NS_FAILED(rv)) return -1;</span>
<a href="#l193.117"></a><span id="l193.117">   </span>
<a href="#l193.118"></a><span id="l193.118">   return 0;</span>
<a href="#l193.119"></a><span id="l193.119"> }</span>
<a href="#l193.120"></a><span id="l193.120"> </span>
<a href="#l193.121"></a><span id="l193.121"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l194.1"></a><span id="l194.1" class="difflineminus">--- a/mailnews/local/src/nsMailboxProtocol.h</span>
<a href="#l194.2"></a><span id="l194.2" class="difflineplus">+++ b/mailnews/local/src/nsMailboxProtocol.h</span>
<a href="#l194.3"></a><span id="l194.3" class="difflineat">@@ -90,17 +90,16 @@ public:</span>
<a href="#l194.4"></a><span id="l194.4">   virtual nsresult LoadUrl(nsIURI * aURL, nsISupports * aConsumer);</span>
<a href="#l194.5"></a><span id="l194.5"> </span>
<a href="#l194.6"></a><span id="l194.6">   ////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l194.7"></a><span id="l194.7">   // we suppport the nsIStreamListener interface</span>
<a href="#l194.8"></a><span id="l194.8">   ////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l194.9"></a><span id="l194.9"> </span>
<a href="#l194.10"></a><span id="l194.10">   NS_IMETHOD OnStartRequest(nsIRequest *request, nsISupports *ctxt);</span>
<a href="#l194.11"></a><span id="l194.11">   NS_IMETHOD OnStopRequest(nsIRequest *request, nsISupports *ctxt, nsresult aStatus);</span>
<a href="#l194.12"></a><span id="l194.12" class="difflineminus">-  NS_IMETHOD GetContentLength(PRInt32 * aContentLength);</span>
<a href="#l194.13"></a><span id="l194.13"> </span>
<a href="#l194.14"></a><span id="l194.14"> private:</span>
<a href="#l194.15"></a><span id="l194.15">   nsCOMPtr&lt;nsIMailboxUrl&gt;  m_runningUrl; // the nsIMailboxURL that is currently running</span>
<a href="#l194.16"></a><span id="l194.16">   nsMailboxAction m_mailboxAction; // current mailbox action associated with this connnection...</span>
<a href="#l194.17"></a><span id="l194.17">   PRInt32      m_originalContentLength; /* the content length at the time of calling graph progress */</span>
<a href="#l194.18"></a><span id="l194.18"> </span>
<a href="#l194.19"></a><span id="l194.19">   // Event sink handles</span>
<a href="#l194.20"></a><span id="l194.20">   nsCOMPtr&lt;nsIStreamListener&gt; m_mailboxParser;</span>
<a href="#l194.21"></a><span id="l194.21" class="difflineat">@@ -108,17 +107,17 @@ private:</span>
<a href="#l194.22"></a><span id="l194.22">   // Local state for the current operation</span>
<a href="#l194.23"></a><span id="l194.23">   nsMsgLineStreamBuffer   * m_lineStreamBuffer; // used to efficiently extract lines from the incoming data stream</span>
<a href="#l194.24"></a><span id="l194.24"> </span>
<a href="#l194.25"></a><span id="l194.25">   // Generic state information -- What state are we in? What state do we want to go to</span>
<a href="#l194.26"></a><span id="l194.26">   // after the next response? What was the last response code? etc.</span>
<a href="#l194.27"></a><span id="l194.27">   MailboxStatesEnum  m_nextState;</span>
<a href="#l194.28"></a><span id="l194.28">   MailboxStatesEnum  m_initialState;</span>
<a href="#l194.29"></a><span id="l194.29"> </span>
<a href="#l194.30"></a><span id="l194.30" class="difflineminus">-  PRInt32 mCurrentProgress;</span>
<a href="#l194.31"></a><span id="l194.31" class="difflineplus">+  PRInt64   mCurrentProgress;</span>
<a href="#l194.32"></a><span id="l194.32">   PRUint32  m_messageID;</span>
<a href="#l194.33"></a><span id="l194.33"> </span>
<a href="#l194.34"></a><span id="l194.34">         // can we just use the base class m_tempMsgFile?</span>
<a href="#l194.35"></a><span id="l194.35">   nsCOMPtr&lt;nsIFile&gt; m_tempMessageFile;</span>
<a href="#l194.36"></a><span id="l194.36">         nsCOMPtr&lt;nsIOutputStream&gt; m_msgFileOutputStream;</span>
<a href="#l194.37"></a><span id="l194.37"> </span>
<a href="#l194.38"></a><span id="l194.38">   // this is used to hold the source mailbox file open when move/copying</span>
<a href="#l194.39"></a><span id="l194.39">   // multiple messages.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l195.1"></a><span id="l195.1" class="difflineminus">--- a/mailnews/local/src/nsParseMailbox.cpp</span>
<a href="#l195.2"></a><span id="l195.2" class="difflineplus">+++ b/mailnews/local/src/nsParseMailbox.cpp</span>
<a href="#l195.3"></a><span id="l195.3" class="difflineat">@@ -1783,16 +1783,21 @@ void nsParseNewMailState::DoneParsingFol</span>
<a href="#l195.4"></a><span id="l195.4"> </span>
<a href="#l195.5"></a><span id="l195.5"> PRInt32 nsParseNewMailState::PublishMsgHeader(nsIMsgWindow *msgWindow)</span>
<a href="#l195.6"></a><span id="l195.6"> {</span>
<a href="#l195.7"></a><span id="l195.7">   PRBool moved = PR_FALSE;</span>
<a href="#l195.8"></a><span id="l195.8">   FinishHeader();</span>
<a href="#l195.9"></a><span id="l195.9"> </span>
<a href="#l195.10"></a><span id="l195.10">   if (m_newMsgHdr)</span>
<a href="#l195.11"></a><span id="l195.11">   {</span>
<a href="#l195.12"></a><span id="l195.12" class="difflineplus">+    PRUint32 newFlags, oldFlags;</span>
<a href="#l195.13"></a><span id="l195.13" class="difflineplus">+    m_newMsgHdr-&gt;GetFlags(&amp;oldFlags);</span>
<a href="#l195.14"></a><span id="l195.14" class="difflineplus">+    if (!(oldFlags &amp; nsMsgMessageFlags::Read)) // don't mark read messages as new.</span>
<a href="#l195.15"></a><span id="l195.15" class="difflineplus">+      m_newMsgHdr-&gt;OrFlags(nsMsgMessageFlags::New, &amp;newFlags);</span>
<a href="#l195.16"></a><span id="l195.16" class="difflineplus">+</span>
<a href="#l195.17"></a><span id="l195.17">     if (!m_disableFilters)</span>
<a href="#l195.18"></a><span id="l195.18">     {</span>
<a href="#l195.19"></a><span id="l195.19">       // seems like the code that's writing to disk should do</span>
<a href="#l195.20"></a><span id="l195.20">       // the flushing...</span>
<a href="#l195.21"></a><span id="l195.21">       // flush the inbox because filters will read from disk</span>
<a href="#l195.22"></a><span id="l195.22">       // m_inboxFileStream-&gt;Flush();</span>
<a href="#l195.23"></a><span id="l195.23">       PRUint32 msgOffset;</span>
<a href="#l195.24"></a><span id="l195.24">       (void) m_newMsgHdr-&gt;GetMessageOffset(&amp;msgOffset);</span>
<a href="#l195.25"></a><span id="l195.25" class="difflineat">@@ -1836,16 +1841,18 @@ PRInt32 nsParseNewMailState::PublishMsgH</span>
<a href="#l195.26"></a><span id="l195.26">               }</span>
<a href="#l195.27"></a><span id="l195.27">               break;</span>
<a href="#l195.28"></a><span id="l195.28">             case nsIMsgIncomingServer::moveDupsToTrash:</span>
<a href="#l195.29"></a><span id="l195.29">               {</span>
<a href="#l195.30"></a><span id="l195.30">                 nsCOMPtr &lt;nsIMsgFolder&gt; trash;</span>
<a href="#l195.31"></a><span id="l195.31">                 GetTrashFolder(getter_AddRefs(trash));</span>
<a href="#l195.32"></a><span id="l195.32">                 if (trash)</span>
<a href="#l195.33"></a><span id="l195.33">                 {</span>
<a href="#l195.34"></a><span id="l195.34" class="difflineplus">+                  PRUint32 newFlags;</span>
<a href="#l195.35"></a><span id="l195.35" class="difflineplus">+                  m_newMsgHdr-&gt;AndFlags(~nsMsgMessageFlags::New, &amp;newFlags);</span>
<a href="#l195.36"></a><span id="l195.36">                   // save off m_newMsgHdr because MoveIncorporatedMessage </span>
<a href="#l195.37"></a><span id="l195.37">                   // clears it by calling nsParseMailMessageState::Init</span>
<a href="#l195.38"></a><span id="l195.38">                   nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr = m_newMsgHdr;</span>
<a href="#l195.39"></a><span id="l195.39">                   MoveIncorporatedMessage(m_newMsgHdr, m_mailDB, trash,</span>
<a href="#l195.40"></a><span id="l195.40">                                                           nsnull, msgWindow);</span>
<a href="#l195.41"></a><span id="l195.41">                   if (!m_downloadingToTempFile)</span>
<a href="#l195.42"></a><span id="l195.42">                     m_mailDB-&gt;RemoveHeaderMdbRow(msgHdr);</span>
<a href="#l195.43"></a><span id="l195.43">                 }</span>
<a href="#l195.44"></a><span id="l195.44" class="difflineat">@@ -1865,21 +1872,16 @@ PRInt32 nsParseNewMailState::PublishMsgH</span>
<a href="#l195.45"></a><span id="l195.45">       }</span>
<a href="#l195.46"></a><span id="l195.46"> </span>
<a href="#l195.47"></a><span id="l195.47">       ApplyFilters(&amp;moved, msgWindow, msgOffset);</span>
<a href="#l195.48"></a><span id="l195.48">     }</span>
<a href="#l195.49"></a><span id="l195.49">     if (!moved)</span>
<a href="#l195.50"></a><span id="l195.50">     {</span>
<a href="#l195.51"></a><span id="l195.51">       if (m_mailDB)</span>
<a href="#l195.52"></a><span id="l195.52">       {</span>
<a href="#l195.53"></a><span id="l195.53" class="difflineminus">-        PRUint32 newFlags, oldFlags;</span>
<a href="#l195.54"></a><span id="l195.54" class="difflineminus">-        m_newMsgHdr-&gt;GetFlags(&amp;oldFlags);</span>
<a href="#l195.55"></a><span id="l195.55" class="difflineminus">-        if (!(oldFlags &amp; nsMsgMessageFlags::Read)) // don't mark read messages as new.</span>
<a href="#l195.56"></a><span id="l195.56" class="difflineminus">-          m_newMsgHdr-&gt;OrFlags(nsMsgMessageFlags::New, &amp;newFlags);</span>
<a href="#l195.57"></a><span id="l195.57" class="difflineminus">-</span>
<a href="#l195.58"></a><span id="l195.58">         m_mailDB-&gt;AddNewHdrToDB(m_newMsgHdr, PR_TRUE);</span>
<a href="#l195.59"></a><span id="l195.59">         nsCOMPtr&lt;nsIMsgFolderNotificationService&gt; notifier(do_GetService(NS_MSGNOTIFICATIONSERVICE_CONTRACTID));</span>
<a href="#l195.60"></a><span id="l195.60">         if (notifier)</span>
<a href="#l195.61"></a><span id="l195.61">           notifier-&gt;NotifyMsgAdded(m_newMsgHdr);</span>
<a href="#l195.62"></a><span id="l195.62">       }</span>
<a href="#l195.63"></a><span id="l195.63">     } // if it was moved by imap filter, m_parseMsgState-&gt;m_newMsgHdr == nsnull</span>
<a href="#l195.64"></a><span id="l195.64">     m_newMsgHdr = nsnull;</span>
<a href="#l195.65"></a><span id="l195.65">   }</span>
<a href="#l195.66"></a><span id="l195.66" class="difflineat">@@ -2290,19 +2292,24 @@ nsresult nsParseNewMailState::ApplyForwa</span>
<a href="#l195.67"></a><span id="l195.67">   return rv;</span>
<a href="#l195.68"></a><span id="l195.68"> }</span>
<a href="#l195.69"></a><span id="l195.69"> </span>
<a href="#l195.70"></a><span id="l195.70"> </span>
<a href="#l195.71"></a><span id="l195.71"> int nsParseNewMailState::MarkFilteredMessageRead(nsIMsgDBHdr *msgHdr)</span>
<a href="#l195.72"></a><span id="l195.72"> {</span>
<a href="#l195.73"></a><span id="l195.73">   PRUint32 newFlags;</span>
<a href="#l195.74"></a><span id="l195.74">   if (m_mailDB)</span>
<a href="#l195.75"></a><span id="l195.75" class="difflineplus">+  {</span>
<a href="#l195.76"></a><span id="l195.76">     m_mailDB-&gt;MarkHdrRead(msgHdr, PR_TRUE, nsnull);</span>
<a href="#l195.77"></a><span id="l195.77" class="difflineplus">+  }</span>
<a href="#l195.78"></a><span id="l195.78">   else</span>
<a href="#l195.79"></a><span id="l195.79" class="difflineplus">+  {</span>
<a href="#l195.80"></a><span id="l195.80">     msgHdr-&gt;OrFlags(nsMsgMessageFlags::Read, &amp;newFlags);</span>
<a href="#l195.81"></a><span id="l195.81" class="difflineplus">+    msgHdr-&gt;AndFlags(~nsMsgMessageFlags::New, &amp;newFlags);</span>
<a href="#l195.82"></a><span id="l195.82" class="difflineplus">+  }</span>
<a href="#l195.83"></a><span id="l195.83">   return 0;</span>
<a href="#l195.84"></a><span id="l195.84"> }</span>
<a href="#l195.85"></a><span id="l195.85"> </span>
<a href="#l195.86"></a><span id="l195.86"> nsresult nsParseNewMailState::EndMsgDownload()</span>
<a href="#l195.87"></a><span id="l195.87"> {</span>
<a href="#l195.88"></a><span id="l195.88">   if (m_moveCoalescer)</span>
<a href="#l195.89"></a><span id="l195.89">     m_moveCoalescer-&gt;PlaybackMoves();</span>
<a href="#l195.90"></a><span id="l195.90"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l196.1"></a><span id="l196.1">new file mode 100644</span>
<a href="#l196.2"></a><span id="l196.2" class="difflineminus">--- /dev/null</span>
<a href="#l196.3"></a><span id="l196.3" class="difflineplus">+++ b/mailnews/local/test/unit/tail_local.js</span>
<a href="#l196.4"></a><span id="l196.4" class="difflineat">@@ -0,0 +1,1 @@</span>
<a href="#l196.5"></a><span id="l196.5" class="difflineplus">+load(&quot;../../mailnews/resources/mailShutdown.js&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l197.1"></a><span id="l197.1">new file mode 100644</span>
<a href="#l197.2"></a><span id="l197.2" class="difflineminus">--- /dev/null</span>
<a href="#l197.3"></a><span id="l197.3" class="difflineplus">+++ b/mailnews/local/test/unit/test_mailboxContentLength.js</span>
<a href="#l197.4"></a><span id="l197.4" class="difflineat">@@ -0,0 +1,73 @@</span>
<a href="#l197.5"></a><span id="l197.5" class="difflineplus">+/* -*- Mode: JavaScript; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l197.6"></a><span id="l197.6" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l197.7"></a><span id="l197.7" class="difflineplus">+ *</span>
<a href="#l197.8"></a><span id="l197.8" class="difflineplus">+ * Any copyright is dedicated to the Public Domain.</span>
<a href="#l197.9"></a><span id="l197.9" class="difflineplus">+ * http://creativecommons.org/licenses/publicdomain/</span>
<a href="#l197.10"></a><span id="l197.10" class="difflineplus">+ *</span>
<a href="#l197.11"></a><span id="l197.11" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l197.12"></a><span id="l197.12" class="difflineplus">+</span>
<a href="#l197.13"></a><span id="l197.13" class="difflineplus">+/*</span>
<a href="#l197.14"></a><span id="l197.14" class="difflineplus">+ * Test content length for the mailbox protocol. This focuses on necko URLs</span>
<a href="#l197.15"></a><span id="l197.15" class="difflineplus">+ * that are run externally.</span>
<a href="#l197.16"></a><span id="l197.16" class="difflineplus">+ */</span>
<a href="#l197.17"></a><span id="l197.17" class="difflineplus">+</span>
<a href="#l197.18"></a><span id="l197.18" class="difflineplus">+// Take a multipart message as we're testing attachment URLs as well</span>
<a href="#l197.19"></a><span id="l197.19" class="difflineplus">+var gFile = do_get_file(&quot;../../mailnews/data/multipart-complex2&quot;);</span>
<a href="#l197.20"></a><span id="l197.20" class="difflineplus">+var gMessageKey;</span>
<a href="#l197.21"></a><span id="l197.21" class="difflineplus">+</span>
<a href="#l197.22"></a><span id="l197.22" class="difflineplus">+function run_test()</span>
<a href="#l197.23"></a><span id="l197.23" class="difflineplus">+{</span>
<a href="#l197.24"></a><span id="l197.24" class="difflineplus">+  // Set up local folders</span>
<a href="#l197.25"></a><span id="l197.25" class="difflineplus">+  loadLocalMailAccount();</span>
<a href="#l197.26"></a><span id="l197.26" class="difflineplus">+</span>
<a href="#l197.27"></a><span id="l197.27" class="difflineplus">+  // Copy a message into the local folder</span>
<a href="#l197.28"></a><span id="l197.28" class="difflineplus">+  Cc[&quot;@mozilla.org/messenger/messagecopyservice;1&quot;]</span>
<a href="#l197.29"></a><span id="l197.29" class="difflineplus">+    .getService(Ci.nsIMsgCopyService)</span>
<a href="#l197.30"></a><span id="l197.30" class="difflineplus">+    .CopyFileMessage(gFile, gLocalInboxFolder, null, false, 0, &quot;&quot;,</span>
<a href="#l197.31"></a><span id="l197.31" class="difflineplus">+                     gCopyListener, null);</span>
<a href="#l197.32"></a><span id="l197.32" class="difflineplus">+</span>
<a href="#l197.33"></a><span id="l197.33" class="difflineplus">+  do_test_pending();</span>
<a href="#l197.34"></a><span id="l197.34" class="difflineplus">+}</span>
<a href="#l197.35"></a><span id="l197.35" class="difflineplus">+</span>
<a href="#l197.36"></a><span id="l197.36" class="difflineplus">+var gCopyListener =</span>
<a href="#l197.37"></a><span id="l197.37" class="difflineplus">+{</span>
<a href="#l197.38"></a><span id="l197.38" class="difflineplus">+  OnStartCopy: function() {},</span>
<a href="#l197.39"></a><span id="l197.39" class="difflineplus">+  OnProgress: function(aProgress, aProgressMax) {},</span>
<a href="#l197.40"></a><span id="l197.40" class="difflineplus">+  SetMessageKey: function(aKey) { gMessageKey = aKey; },</span>
<a href="#l197.41"></a><span id="l197.41" class="difflineplus">+  GetMessageId: function(aMessageId) {},</span>
<a href="#l197.42"></a><span id="l197.42" class="difflineplus">+  OnStopCopy: function(aStatus) </span>
<a href="#l197.43"></a><span id="l197.43" class="difflineplus">+  {</span>
<a href="#l197.44"></a><span id="l197.44" class="difflineplus">+    do_timeout_function(0, verifyContentLength);</span>
<a href="#l197.45"></a><span id="l197.45" class="difflineplus">+  }</span>
<a href="#l197.46"></a><span id="l197.46" class="difflineplus">+};</span>
<a href="#l197.47"></a><span id="l197.47" class="difflineplus">+</span>
<a href="#l197.48"></a><span id="l197.48" class="difflineplus">+function verifyContentLength()</span>
<a href="#l197.49"></a><span id="l197.49" class="difflineplus">+{</span>
<a href="#l197.50"></a><span id="l197.50" class="difflineplus">+  // First get the message URI</span>
<a href="#l197.51"></a><span id="l197.51" class="difflineplus">+  let msgHdr = gLocalInboxFolder.GetMessageHeader(gMessageKey);</span>
<a href="#l197.52"></a><span id="l197.52" class="difflineplus">+  let messageUri = gLocalInboxFolder.getUriForMsg(msgHdr);</span>
<a href="#l197.53"></a><span id="l197.53" class="difflineplus">+  // Convert this to a URI that necko can run</span>
<a href="#l197.54"></a><span id="l197.54" class="difflineplus">+  let messenger = Cc[&quot;@mozilla.org/messenger;1&quot;].createInstance(Ci.nsIMessenger);</span>
<a href="#l197.55"></a><span id="l197.55" class="difflineplus">+  let neckoURL = {};</span>
<a href="#l197.56"></a><span id="l197.56" class="difflineplus">+  let messageService = messenger.messageServiceFromURI(messageUri);</span>
<a href="#l197.57"></a><span id="l197.57" class="difflineplus">+  messageService.GetUrlForUri(messageUri, neckoURL, null);</span>
<a href="#l197.58"></a><span id="l197.58" class="difflineplus">+  // Don't use the necko URL directly. Instead, get the spec and create a new</span>
<a href="#l197.59"></a><span id="l197.59" class="difflineplus">+  // URL using the IO service</span>
<a href="#l197.60"></a><span id="l197.60" class="difflineplus">+  let ioService = Cc[&quot;@mozilla.org/network/io-service;1&quot;]</span>
<a href="#l197.61"></a><span id="l197.61" class="difflineplus">+                    .getService(Ci.nsIIOService);</span>
<a href="#l197.62"></a><span id="l197.62" class="difflineplus">+  let urlToRun = ioService.newURI(neckoURL.value.spec, null, null);</span>
<a href="#l197.63"></a><span id="l197.63" class="difflineplus">+</span>
<a href="#l197.64"></a><span id="l197.64" class="difflineplus">+  // Get a channel from this URI, and check its content length</span>
<a href="#l197.65"></a><span id="l197.65" class="difflineplus">+  let channel = ioService.newChannelFromURI(urlToRun);</span>
<a href="#l197.66"></a><span id="l197.66" class="difflineplus">+  do_check_eq(channel.contentLength, gFile.fileSize);</span>
<a href="#l197.67"></a><span id="l197.67" class="difflineplus">+</span>
<a href="#l197.68"></a><span id="l197.68" class="difflineplus">+  // Now try an attachment. &amp;part=1.2</span>
<a href="#l197.69"></a><span id="l197.69" class="difflineplus">+  let attachmentURL = ioService.newURI(neckoURL.value.spec + &quot;&amp;part=1.2&quot;,</span>
<a href="#l197.70"></a><span id="l197.70" class="difflineplus">+                                       null, null);</span>
<a href="#l197.71"></a><span id="l197.71" class="difflineplus">+  let attachmentChannel = ioService.newChannelFromURI(attachmentURL);</span>
<a href="#l197.72"></a><span id="l197.72" class="difflineplus">+  // Currently attachments have their content length set to the length of the</span>
<a href="#l197.73"></a><span id="l197.73" class="difflineplus">+  // entire message</span>
<a href="#l197.74"></a><span id="l197.74" class="difflineplus">+  do_check_eq(channel.contentLength, gFile.fileSize);</span>
<a href="#l197.75"></a><span id="l197.75" class="difflineplus">+</span>
<a href="#l197.76"></a><span id="l197.76" class="difflineplus">+  do_test_finished();</span>
<a href="#l197.77"></a><span id="l197.77" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l198.1"></a><span id="l198.1" class="difflineminus">--- a/mailnews/local/test/unit/test_msgCopy.js</span>
<a href="#l198.2"></a><span id="l198.2" class="difflineplus">+++ b/mailnews/local/test/unit/test_msgCopy.js</span>
<a href="#l198.3"></a><span id="l198.3" class="difflineat">@@ -67,13 +67,14 @@ var copyListener =</span>
<a href="#l198.4"></a><span id="l198.4">   SetMessageKey: function(aKey)</span>
<a href="#l198.5"></a><span id="l198.5">   {</span>
<a href="#l198.6"></a><span id="l198.6">     hdrs.push(gLocalInboxFolder.GetMessageHeader(aKey));</span>
<a href="#l198.7"></a><span id="l198.7">   },</span>
<a href="#l198.8"></a><span id="l198.8">   SetMessageId: function(aMessageId) {},</span>
<a href="#l198.9"></a><span id="l198.9">   OnStopCopy: function(aStatus)</span>
<a href="#l198.10"></a><span id="l198.10">   {</span>
<a href="#l198.11"></a><span id="l198.11">     var copiedMessage = gLocalInboxFolder.GetMessageHeader(hdrs[0]);</span>
<a href="#l198.12"></a><span id="l198.12" class="difflineminus">-    do_check_eq(copiedMessage.getStringProperty(&quot;keywords&quot;), tag1);    </span>
<a href="#l198.13"></a><span id="l198.13" class="difflineplus">+    do_check_eq(copiedMessage.getStringProperty(&quot;keywords&quot;), tag1);</span>
<a href="#l198.14"></a><span id="l198.14" class="difflineplus">+    hdrs = null;</span>
<a href="#l198.15"></a><span id="l198.15">     do_test_finished();</span>
<a href="#l198.16"></a><span id="l198.16">   }</span>
<a href="#l198.17"></a><span id="l198.17"> };</span>
<a href="#l198.18"></a><span id="l198.18"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l199.1"></a><span id="l199.1" class="difflineminus">--- a/mailnews/mailnews.js</span>
<a href="#l199.2"></a><span id="l199.2" class="difflineplus">+++ b/mailnews/mailnews.js</span>
<a href="#l199.3"></a><span id="l199.3" class="difflineat">@@ -137,17 +137,16 @@ pref(&quot;mail.default_templates&quot;, &quot;&quot;); // e</span>
<a href="#l199.4"></a><span id="l199.4"> // We will still always regenerate .msf files if the file size changes.</span>
<a href="#l199.5"></a><span id="l199.5"> pref(&quot;mail.db_timestamp_leeway&quot;, 4000);</span>
<a href="#l199.6"></a><span id="l199.6"> </span>
<a href="#l199.7"></a><span id="l199.7"> // check all folders for new mail</span>
<a href="#l199.8"></a><span id="l199.8"> pref(&quot;mail.check_all_imap_folders_for_new&quot;, false);</span>
<a href="#l199.9"></a><span id="l199.9"> </span>
<a href="#l199.10"></a><span id="l199.10"> pref(&quot;mail.imap.server_sub_directory&quot;,      &quot;&quot;);</span>
<a href="#l199.11"></a><span id="l199.11"> pref(&quot;mail.imap.max_cached_connections&quot;,    10);</span>
<a href="#l199.12"></a><span id="l199.12" class="difflineminus">-pref(&quot;mail.imap.fetch_by_chunks&quot;,           true);</span>
<a href="#l199.13"></a><span id="l199.13"> pref(&quot;mail.imap.chunk_size&quot;,                65536);</span>
<a href="#l199.14"></a><span id="l199.14"> pref(&quot;mail.imap.min_chunk_size_threshold&quot;,  98304);</span>
<a href="#l199.15"></a><span id="l199.15"> pref(&quot;mail.imap.chunk_fast&quot;,                2);</span>
<a href="#l199.16"></a><span id="l199.16"> pref(&quot;mail.imap.chunk_ideal&quot;,               4);</span>
<a href="#l199.17"></a><span id="l199.17"> pref(&quot;mail.imap.chunk_add&quot;,                 8192);</span>
<a href="#l199.18"></a><span id="l199.18"> pref(&quot;mail.imap.hide_other_users&quot;,          false);</span>
<a href="#l199.19"></a><span id="l199.19"> pref(&quot;mail.imap.hide_unused_namespaces&quot;,    true);</span>
<a href="#l199.20"></a><span id="l199.20"> pref(&quot;mail.imap.new_mail_get_headers&quot;,      true);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l200.1"></a><span id="l200.1" class="difflineminus">--- a/mailnews/mime/emitters/src/nsMimeHtmlEmitter.cpp</span>
<a href="#l200.2"></a><span id="l200.2" class="difflineplus">+++ b/mailnews/mime/emitters/src/nsMimeHtmlEmitter.cpp</span>
<a href="#l200.3"></a><span id="l200.3" class="difflineat">@@ -72,42 +72,43 @@</span>
<a href="#l200.4"></a><span id="l200.4">  * A helper class to implement nsIUTF8StringEnumerator</span>
<a href="#l200.5"></a><span id="l200.5">  */</span>
<a href="#l200.6"></a><span id="l200.6"> </span>
<a href="#l200.7"></a><span id="l200.7"> class nsMimeStringEnumerator : public nsIUTF8StringEnumerator {</span>
<a href="#l200.8"></a><span id="l200.8"> public:</span>
<a href="#l200.9"></a><span id="l200.9">   NS_DECL_ISUPPORTS</span>
<a href="#l200.10"></a><span id="l200.10">   NS_DECL_NSIUTF8STRINGENUMERATOR</span>
<a href="#l200.11"></a><span id="l200.11"> </span>
<a href="#l200.12"></a><span id="l200.12" class="difflineplus">+  nsMimeStringEnumerator() : mCurrentIndex(0) {}</span>
<a href="#l200.13"></a><span id="l200.13" class="difflineplus">+</span>
<a href="#l200.14"></a><span id="l200.14">   template&lt;class T&gt;</span>
<a href="#l200.15"></a><span id="l200.15" class="difflineminus">-  nsCString* Append(T value) { return values.AppendElement(value); }</span>
<a href="#l200.16"></a><span id="l200.16" class="difflineplus">+  nsCString* Append(T value) { return mValues.AppendElement(value); }</span>
<a href="#l200.17"></a><span id="l200.17"> </span>
<a href="#l200.18"></a><span id="l200.18"> protected:</span>
<a href="#l200.19"></a><span id="l200.19" class="difflineminus">-  nsTArray&lt;nsCString&gt; values;</span>
<a href="#l200.20"></a><span id="l200.20" class="difflineplus">+  nsTArray&lt;nsCString&gt; mValues;</span>
<a href="#l200.21"></a><span id="l200.21" class="difflineplus">+  PRUint32 mCurrentIndex; // consumers expect first-in first-out enumeration</span>
<a href="#l200.22"></a><span id="l200.22"> };</span>
<a href="#l200.23"></a><span id="l200.23"> </span>
<a href="#l200.24"></a><span id="l200.24"> NS_IMPL_ISUPPORTS1(nsMimeStringEnumerator, nsIUTF8StringEnumerator)</span>
<a href="#l200.25"></a><span id="l200.25"> </span>
<a href="#l200.26"></a><span id="l200.26"> NS_IMETHODIMP</span>
<a href="#l200.27"></a><span id="l200.27"> nsMimeStringEnumerator::HasMore(PRBool *result)</span>
<a href="#l200.28"></a><span id="l200.28"> {</span>
<a href="#l200.29"></a><span id="l200.29">   NS_ENSURE_ARG_POINTER(result);</span>
<a href="#l200.30"></a><span id="l200.30" class="difflineminus">-  *result = values.Length() != 0;</span>
<a href="#l200.31"></a><span id="l200.31" class="difflineplus">+  *result = mCurrentIndex &lt; mValues.Length();</span>
<a href="#l200.32"></a><span id="l200.32">   return NS_OK;</span>
<a href="#l200.33"></a><span id="l200.33"> }</span>
<a href="#l200.34"></a><span id="l200.34"> </span>
<a href="#l200.35"></a><span id="l200.35" class="difflineminus">-NS_IMETHODIMP nsMimeStringEnumerator::GetNext(nsACString&amp; result)</span>
<a href="#l200.36"></a><span id="l200.36" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l200.37"></a><span id="l200.37" class="difflineplus">+nsMimeStringEnumerator::GetNext(nsACString&amp; result)</span>
<a href="#l200.38"></a><span id="l200.38"> {</span>
<a href="#l200.39"></a><span id="l200.39" class="difflineminus">-  PRUint32 length = values.Length();</span>
<a href="#l200.40"></a><span id="l200.40" class="difflineminus">-  if (!length)</span>
<a href="#l200.41"></a><span id="l200.41" class="difflineplus">+  if (mCurrentIndex &gt;= mValues.Length())</span>
<a href="#l200.42"></a><span id="l200.42">     return NS_ERROR_UNEXPECTED;</span>
<a href="#l200.43"></a><span id="l200.43"> </span>
<a href="#l200.44"></a><span id="l200.44" class="difflineminus">-  length--;</span>
<a href="#l200.45"></a><span id="l200.45" class="difflineminus">-  result = values[length];</span>
<a href="#l200.46"></a><span id="l200.46" class="difflineminus">-  values.RemoveElementAt(length);</span>
<a href="#l200.47"></a><span id="l200.47" class="difflineplus">+  result = mValues[mCurrentIndex++];</span>
<a href="#l200.48"></a><span id="l200.48">   return NS_OK;</span>
<a href="#l200.49"></a><span id="l200.49"> }</span>
<a href="#l200.50"></a><span id="l200.50"> </span>
<a href="#l200.51"></a><span id="l200.51"> /*</span>
<a href="#l200.52"></a><span id="l200.52">  * nsMimeHtmlEmitter definitions....</span>
<a href="#l200.53"></a><span id="l200.53">  */</span>
<a href="#l200.54"></a><span id="l200.54"> nsMimeHtmlDisplayEmitter::nsMimeHtmlDisplayEmitter() : nsMimeBaseEmitter()</span>
<a href="#l200.55"></a><span id="l200.55"> {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l201.1"></a><span id="l201.1" class="difflineminus">--- a/mailnews/mime/src/mimemult.cpp</span>
<a href="#l201.2"></a><span id="l201.2" class="difflineplus">+++ b/mailnews/mime/src/mimemult.cpp</span>
<a href="#l201.3"></a><span id="l201.3" class="difflineat">@@ -286,30 +286,30 @@ MimeMultipart_parse_line (const char *li</span>
<a href="#l201.4"></a><span id="l201.4">           else</span>
<a href="#l201.5"></a><span id="l201.5">           {</span>
<a href="#l201.6"></a><span id="l201.6">             nsCAutoString header(&quot;Content-Type: text/x-moz-deleted; name=\&quot;Deleted: &quot;);</span>
<a href="#l201.7"></a><span id="l201.7">             header.Append(fileName);</span>
<a href="#l201.8"></a><span id="l201.8">             status = MimeWriteAString(obj, header);</span>
<a href="#l201.9"></a><span id="l201.9">             if (status &lt; 0) </span>
<a href="#l201.10"></a><span id="l201.10">               return status;</span>
<a href="#l201.11"></a><span id="l201.11">             status = MimeWriteAString(obj, NS_LITERAL_CSTRING(&quot;\&quot;&quot;MSG_LINEBREAK&quot;Content-Transfer-Encoding: 8bit&quot;MSG_LINEBREAK));</span>
<a href="#l201.12"></a><span id="l201.12" class="difflineminus">-            MimeWriteAString(obj, NS_LITERAL_CSTRING(&quot;Content-Disposition: inline; filename=\&quot;Deleted:&quot;));</span>
<a href="#l201.13"></a><span id="l201.13" class="difflineplus">+            MimeWriteAString(obj, NS_LITERAL_CSTRING(&quot;Content-Disposition: inline; filename=\&quot;Deleted: &quot;));</span>
<a href="#l201.14"></a><span id="l201.14">             MimeWriteAString(obj, fileName);</span>
<a href="#l201.15"></a><span id="l201.15">             MimeWriteAString(obj, NS_LITERAL_CSTRING(&quot;\&quot;&quot;MSG_LINEBREAK&quot;X-Mozilla-Altered: AttachmentDeleted; date=\&quot;&quot;));</span>
<a href="#l201.16"></a><span id="l201.16">           }</span>
<a href="#l201.17"></a><span id="l201.17">           nsCString result;</span>
<a href="#l201.18"></a><span id="l201.18">           char timeBuffer[128];</span>
<a href="#l201.19"></a><span id="l201.19">           PRExplodedTime now;</span>
<a href="#l201.20"></a><span id="l201.20">           PR_ExplodeTime(PR_Now(), PR_LocalTimeParameters, &amp;now);</span>
<a href="#l201.21"></a><span id="l201.21">           PR_FormatTimeUSEnglish(timeBuffer, sizeof(timeBuffer),</span>
<a href="#l201.22"></a><span id="l201.22">                                  &quot;%a %b %d %H:%M:%S %Y&quot;,</span>
<a href="#l201.23"></a><span id="l201.23">                                  &amp;now);</span>
<a href="#l201.24"></a><span id="l201.24">           MimeWriteAString(obj, nsDependentCString(timeBuffer));</span>
<a href="#l201.25"></a><span id="l201.25">           MimeWriteAString(obj, NS_LITERAL_CSTRING(&quot;\&quot;&quot;MSG_LINEBREAK));</span>
<a href="#l201.26"></a><span id="l201.26" class="difflineminus">-          MimeWriteAString(obj, NS_LITERAL_CSTRING(MSG_LINEBREAK&quot;The original MIME headers for this attachment are:&quot;MSG_LINEBREAK));</span>
<a href="#l201.27"></a><span id="l201.27" class="difflineplus">+          MimeWriteAString(obj, NS_LITERAL_CSTRING(MSG_LINEBREAK&quot;You deleted an attachment from this message. The original MIME headers for the attachment were:&quot;MSG_LINEBREAK));</span>
<a href="#l201.28"></a><span id="l201.28">           MimeHeaders_write_raw_headers(mult-&gt;hdrs, obj-&gt;options, PR_FALSE);</span>
<a href="#l201.29"></a><span id="l201.29">         }</span>
<a href="#l201.30"></a><span id="l201.30">         status = ((MimeMultipartClass *) obj-&gt;clazz)-&gt;create_child(obj);</span>
<a href="#l201.31"></a><span id="l201.31">         if (status &lt; 0) return status;</span>
<a href="#l201.32"></a><span id="l201.32">         NS_ASSERTION(mult-&gt;state != MimeMultipartHeaders,</span>
<a href="#l201.33"></a><span id="l201.33">                      &quot;mult-&gt;state shouldn't be MimeMultipartHeaders&quot;);</span>
<a href="#l201.34"></a><span id="l201.34"> </span>
<a href="#l201.35"></a><span id="l201.35">         // Ok, at this point, we need to examine the headers and see if there</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l202.1"></a><span id="l202.1">new file mode 100644</span>
<a href="#l202.2"></a><span id="l202.2" class="difflineminus">--- /dev/null</span>
<a href="#l202.3"></a><span id="l202.3" class="difflineplus">+++ b/mailnews/mime/test/unit/tail_mime.js</span>
<a href="#l202.4"></a><span id="l202.4" class="difflineat">@@ -0,0 +1,1 @@</span>
<a href="#l202.5"></a><span id="l202.5" class="difflineplus">+load(&quot;../../mailnews/resources/mailShutdown.js&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l203.1"></a><span id="l203.1" class="difflineminus">--- a/mailnews/news/src/nsNNTPProtocol.cpp</span>
<a href="#l203.2"></a><span id="l203.2" class="difflineplus">+++ b/mailnews/news/src/nsNNTPProtocol.cpp</span>
<a href="#l203.3"></a><span id="l203.3" class="difflineat">@@ -460,17 +460,34 @@ NS_IMETHODIMP nsNNTPProtocol::Initialize</span>
<a href="#l203.4"></a><span id="l203.4">     nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsUrl = do_QueryInterface(m_runningURL);</span>
<a href="#l203.5"></a><span id="l203.5">     if (mailnewsUrl)</span>
<a href="#l203.6"></a><span id="l203.6">     {</span>
<a href="#l203.7"></a><span id="l203.7">       if (aMsgWindow)</span>
<a href="#l203.8"></a><span id="l203.8">         mailnewsUrl-&gt;SetMsgWindow(aMsgWindow);</span>
<a href="#l203.9"></a><span id="l203.9"> </span>
<a href="#l203.10"></a><span id="l203.10">       m_runningURL-&gt;GetNewsAction(&amp;m_newsAction);</span>
<a href="#l203.11"></a><span id="l203.11">       if (m_newsAction == nsINntpUrl::ActionFetchArticle || m_newsAction == nsINntpUrl::ActionFetchPart</span>
<a href="#l203.12"></a><span id="l203.12" class="difflineminus">-        || m_newsAction == nsINntpUrl::ActionSaveMessageToDisk) {</span>
<a href="#l203.13"></a><span id="l203.13" class="difflineplus">+          || m_newsAction == nsINntpUrl::ActionSaveMessageToDisk)</span>
<a href="#l203.14"></a><span id="l203.14" class="difflineplus">+      {</span>
<a href="#l203.15"></a><span id="l203.15" class="difflineplus">+        // Look for the content length</span>
<a href="#l203.16"></a><span id="l203.16" class="difflineplus">+        nsCOMPtr&lt;nsIMsgMessageUrl&gt; msgUrl(do_QueryInterface(m_runningURL));</span>
<a href="#l203.17"></a><span id="l203.17" class="difflineplus">+        if (msgUrl)</span>
<a href="#l203.18"></a><span id="l203.18" class="difflineplus">+        {</span>
<a href="#l203.19"></a><span id="l203.19" class="difflineplus">+          nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l203.20"></a><span id="l203.20" class="difflineplus">+          msgUrl-&gt;GetMessageHeader(getter_AddRefs(msgHdr));</span>
<a href="#l203.21"></a><span id="l203.21" class="difflineplus">+          if (msgHdr)</span>
<a href="#l203.22"></a><span id="l203.22" class="difflineplus">+          {</span>
<a href="#l203.23"></a><span id="l203.23" class="difflineplus">+            // Note that for attachments, the messageSize is going to be the</span>
<a href="#l203.24"></a><span id="l203.24" class="difflineplus">+            // size of the entire message</span>
<a href="#l203.25"></a><span id="l203.25" class="difflineplus">+            PRUint32 messageSize;</span>
<a href="#l203.26"></a><span id="l203.26" class="difflineplus">+            msgHdr-&gt;GetMessageSize(&amp;messageSize);</span>
<a href="#l203.27"></a><span id="l203.27" class="difflineplus">+            SetContentLength(messageSize);</span>
<a href="#l203.28"></a><span id="l203.28" class="difflineplus">+          }</span>
<a href="#l203.29"></a><span id="l203.29" class="difflineplus">+        }</span>
<a href="#l203.30"></a><span id="l203.30" class="difflineplus">+</span>
<a href="#l203.31"></a><span id="l203.31">         PRBool msgIsInLocalCache = PR_FALSE;</span>
<a href="#l203.32"></a><span id="l203.32">         mailnewsUrl-&gt;GetMsgIsInLocalCache(&amp;msgIsInLocalCache);</span>
<a href="#l203.33"></a><span id="l203.33">         if (msgIsInLocalCache || WeAreOffline())</span>
<a href="#l203.34"></a><span id="l203.34">           return NS_OK; // probably don't need to do anything else - definitely don't want</span>
<a href="#l203.35"></a><span id="l203.35">         // to open the socket.</span>
<a href="#l203.36"></a><span id="l203.36">       }</span>
<a href="#l203.37"></a><span id="l203.37">     }</span>
<a href="#l203.38"></a><span id="l203.38">   }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l204.1"></a><span id="l204.1" class="difflineminus">--- a/mailnews/news/src/nsNntpUrl.cpp</span>
<a href="#l204.2"></a><span id="l204.2" class="difflineplus">+++ b/mailnews/news/src/nsNntpUrl.cpp</span>
<a href="#l204.3"></a><span id="l204.3" class="difflineat">@@ -264,25 +264,24 @@ NS_IMETHODIMP nsNntpUrl::GetMessageHeade</span>
<a href="#l204.4"></a><span id="l204.4">   nsresult rv;</span>
<a href="#l204.5"></a><span id="l204.5"> </span>
<a href="#l204.6"></a><span id="l204.6">   nsCOMPtr &lt;nsINntpService&gt; nntpService = do_GetService(NS_NNTPSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l204.7"></a><span id="l204.7">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l204.8"></a><span id="l204.8"> </span>
<a href="#l204.9"></a><span id="l204.9">   nsCOMPtr &lt;nsIMsgMessageService&gt; msgService = do_QueryInterface(nntpService, &amp;rv);</span>
<a href="#l204.10"></a><span id="l204.10">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l204.11"></a><span id="l204.11"> </span>
<a href="#l204.12"></a><span id="l204.12" class="difflineminus">-  if (mOriginalSpec.IsEmpty()) {</span>
<a href="#l204.13"></a><span id="l204.13" class="difflineminus">-    // this can happen when viewing a news://host/message-id url</span>
<a href="#l204.14"></a><span id="l204.14" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l204.15"></a><span id="l204.15" class="difflineminus">-  }</span>
<a href="#l204.16"></a><span id="l204.16" class="difflineplus">+  nsCAutoString spec(mOriginalSpec);</span>
<a href="#l204.17"></a><span id="l204.17" class="difflineplus">+  if (spec.IsEmpty())</span>
<a href="#l204.18"></a><span id="l204.18" class="difflineplus">+    // Handle the case where necko directly runs an internal news:// URL,</span>
<a href="#l204.19"></a><span id="l204.19" class="difflineplus">+    // one that looks like news://host/message-id?group=mozilla.announce&amp;key=15</span>
<a href="#l204.20"></a><span id="l204.20" class="difflineplus">+    // Other sorts of URLs -- e.g. news://host/message-id -- will not succeed.</span>
<a href="#l204.21"></a><span id="l204.21" class="difflineplus">+    GetSpec(spec);</span>
<a href="#l204.22"></a><span id="l204.22"> </span>
<a href="#l204.23"></a><span id="l204.23" class="difflineminus">-  rv = msgService-&gt;MessageURIToMsgHdr(mOriginalSpec.get(), aMsgHdr);</span>
<a href="#l204.24"></a><span id="l204.24" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l204.25"></a><span id="l204.25" class="difflineminus">-</span>
<a href="#l204.26"></a><span id="l204.26" class="difflineminus">-  return NS_OK;</span>
<a href="#l204.27"></a><span id="l204.27" class="difflineplus">+  return msgService-&gt;MessageURIToMsgHdr(spec.get(), aMsgHdr);</span>
<a href="#l204.28"></a><span id="l204.28"> }</span>
<a href="#l204.29"></a><span id="l204.29"> </span>
<a href="#l204.30"></a><span id="l204.30"> NS_IMETHODIMP nsNntpUrl::IsUrlType(PRUint32 type, PRBool *isType)</span>
<a href="#l204.31"></a><span id="l204.31"> {</span>
<a href="#l204.32"></a><span id="l204.32">   NS_ENSURE_ARG(isType);</span>
<a href="#l204.33"></a><span id="l204.33"> </span>
<a href="#l204.34"></a><span id="l204.34">   switch(type)</span>
<a href="#l204.35"></a><span id="l204.35">   {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l205.1"></a><span id="l205.1" class="difflineminus">--- a/mailnews/news/test/unit/head_server_setup.js</span>
<a href="#l205.2"></a><span id="l205.2" class="difflineplus">+++ b/mailnews/news/test/unit/head_server_setup.js</span>
<a href="#l205.3"></a><span id="l205.3" class="difflineat">@@ -167,16 +167,17 @@ function resetFolder(folder) {</span>
<a href="#l205.4"></a><span id="l205.4">   while (headerEnum.hasMoreElements())</span>
<a href="#l205.5"></a><span id="l205.5">     headers.push(headerEnum.getNext().QueryInterface(Ci.nsIMsgDBHdr));</span>
<a href="#l205.6"></a><span id="l205.6"> </span>
<a href="#l205.7"></a><span id="l205.7">   var db = folder.msgDatabase;</span>
<a href="#l205.8"></a><span id="l205.8">   db.dBFolderInfo.knownArtsSet = &quot;&quot;;</span>
<a href="#l205.9"></a><span id="l205.9">   for each (var header in headers) {</span>
<a href="#l205.10"></a><span id="l205.10">     db.DeleteHeader(header, null, true, false);</span>
<a href="#l205.11"></a><span id="l205.11">   }</span>
<a href="#l205.12"></a><span id="l205.12" class="difflineplus">+  dump(&quot;resetting folder\n&quot;);</span>
<a href="#l205.13"></a><span id="l205.13">   folder.msgDatabase = null;</span>
<a href="#l205.14"></a><span id="l205.14"> }</span>
<a href="#l205.15"></a><span id="l205.15"> </span>
<a href="#l205.16"></a><span id="l205.16"> function do_check_transaction(real, expected) {</span>
<a href="#l205.17"></a><span id="l205.17">   // real.them may have an extra QUIT on the end, where the stream is only</span>
<a href="#l205.18"></a><span id="l205.18">   // closed after we have a chance to process it and not them. We therefore</span>
<a href="#l205.19"></a><span id="l205.19">   // excise this from the list</span>
<a href="#l205.20"></a><span id="l205.20">   if (real.them[real.them.length-1] == &quot;QUIT&quot;)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l206.1"></a><span id="l206.1">new file mode 100644</span>
<a href="#l206.2"></a><span id="l206.2" class="difflineminus">--- /dev/null</span>
<a href="#l206.3"></a><span id="l206.3" class="difflineplus">+++ b/mailnews/news/test/unit/tail_news.js</span>
<a href="#l206.4"></a><span id="l206.4" class="difflineat">@@ -0,0 +1,1 @@</span>
<a href="#l206.5"></a><span id="l206.5" class="difflineplus">+load(&quot;../../mailnews/resources/mailShutdown.js&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l207.1"></a><span id="l207.1">new file mode 100644</span>
<a href="#l207.2"></a><span id="l207.2" class="difflineminus">--- /dev/null</span>
<a href="#l207.3"></a><span id="l207.3" class="difflineplus">+++ b/mailnews/news/test/unit/test_nntpContentLength.js</span>
<a href="#l207.4"></a><span id="l207.4" class="difflineat">@@ -0,0 +1,74 @@</span>
<a href="#l207.5"></a><span id="l207.5" class="difflineplus">+/* -*- Mode: JavaScript; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l207.6"></a><span id="l207.6" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l207.7"></a><span id="l207.7" class="difflineplus">+ *</span>
<a href="#l207.8"></a><span id="l207.8" class="difflineplus">+ * Any copyright is dedicated to the Public Domain.</span>
<a href="#l207.9"></a><span id="l207.9" class="difflineplus">+ * http://creativecommons.org/licenses/publicdomain/</span>
<a href="#l207.10"></a><span id="l207.10" class="difflineplus">+ *</span>
<a href="#l207.11"></a><span id="l207.11" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l207.12"></a><span id="l207.12" class="difflineplus">+</span>
<a href="#l207.13"></a><span id="l207.13" class="difflineplus">+/*</span>
<a href="#l207.14"></a><span id="l207.14" class="difflineplus">+ * Test content length for the news protocol. This focuses on necko URLs</span>
<a href="#l207.15"></a><span id="l207.15" class="difflineplus">+ * that are run externally.</span>
<a href="#l207.16"></a><span id="l207.16" class="difflineplus">+ */</span>
<a href="#l207.17"></a><span id="l207.17" class="difflineplus">+</span>
<a href="#l207.18"></a><span id="l207.18" class="difflineplus">+// The basic daemon to use for testing nntpd.js implementations</span>
<a href="#l207.19"></a><span id="l207.19" class="difflineplus">+var daemon = setupNNTPDaemon();</span>
<a href="#l207.20"></a><span id="l207.20" class="difflineplus">+</span>
<a href="#l207.21"></a><span id="l207.21" class="difflineplus">+var server;</span>
<a href="#l207.22"></a><span id="l207.22" class="difflineplus">+var localserver;</span>
<a href="#l207.23"></a><span id="l207.23" class="difflineplus">+</span>
<a href="#l207.24"></a><span id="l207.24" class="difflineplus">+function run_test() {</span>
<a href="#l207.25"></a><span id="l207.25" class="difflineplus">+  // XXX The server doesn't support returning sizes!</span>
<a href="#l207.26"></a><span id="l207.26" class="difflineplus">+  return;</span>
<a href="#l207.27"></a><span id="l207.27" class="difflineplus">+</span>
<a href="#l207.28"></a><span id="l207.28" class="difflineplus">+  type = &quot;RFC 977&quot;;</span>
<a href="#l207.29"></a><span id="l207.29" class="difflineplus">+  var handler = new NNTP_RFC977_handler(daemon);</span>
<a href="#l207.30"></a><span id="l207.30" class="difflineplus">+  localserver = setupLocalServer(NNTP_PORT);</span>
<a href="#l207.31"></a><span id="l207.31" class="difflineplus">+  server = new nsMailServer(handler);</span>
<a href="#l207.32"></a><span id="l207.32" class="difflineplus">+  server.start(NNTP_PORT);</span>
<a href="#l207.33"></a><span id="l207.33" class="difflineplus">+</span>
<a href="#l207.34"></a><span id="l207.34" class="difflineplus">+  try {</span>
<a href="#l207.35"></a><span id="l207.35" class="difflineplus">+    // Get the folder and new mail</span>
<a href="#l207.36"></a><span id="l207.36" class="difflineplus">+    let folder = localserver.rootFolder.getChildNamed(&quot;test.subscribe.simple&quot;);</span>
<a href="#l207.37"></a><span id="l207.37" class="difflineplus">+    folder.clearFlag(Ci.nsMsgFolderFlags.Offline);</span>
<a href="#l207.38"></a><span id="l207.38" class="difflineplus">+    folder.getNewMessages(null, {</span>
<a href="#l207.39"></a><span id="l207.39" class="difflineplus">+      OnStopRunningUrl: function () { localserver.closeCachedConnections(); }});</span>
<a href="#l207.40"></a><span id="l207.40" class="difflineplus">+    server.performTest();</span>
<a href="#l207.41"></a><span id="l207.41" class="difflineplus">+</span>
<a href="#l207.42"></a><span id="l207.42" class="difflineplus">+    do_check_eq(folder.getTotalMessages(false), 1);</span>
<a href="#l207.43"></a><span id="l207.43" class="difflineplus">+    do_check_true(folder.hasNewMessages);</span>
<a href="#l207.44"></a><span id="l207.44" class="difflineplus">+</span>
<a href="#l207.45"></a><span id="l207.45" class="difflineplus">+    server.resetTest();</span>
<a href="#l207.46"></a><span id="l207.46" class="difflineplus">+</span>
<a href="#l207.47"></a><span id="l207.47" class="difflineplus">+    // Get the message URI</span>
<a href="#l207.48"></a><span id="l207.48" class="difflineplus">+    let msgHdr = folder.firstNewMessage;</span>
<a href="#l207.49"></a><span id="l207.49" class="difflineplus">+    let messageUri = folder.getUriForMsg(msgHdr);</span>
<a href="#l207.50"></a><span id="l207.50" class="difflineplus">+    // Convert this to a URI that necko can run</span>
<a href="#l207.51"></a><span id="l207.51" class="difflineplus">+    let messenger = Cc[&quot;@mozilla.org/messenger;1&quot;].createInstance(Ci.nsIMessenger);</span>
<a href="#l207.52"></a><span id="l207.52" class="difflineplus">+    let neckoURL = {};</span>
<a href="#l207.53"></a><span id="l207.53" class="difflineplus">+    let messageService = messenger.messageServiceFromURI(messageUri);</span>
<a href="#l207.54"></a><span id="l207.54" class="difflineplus">+    messageService.GetUrlForUri(messageUri, neckoURL, null);</span>
<a href="#l207.55"></a><span id="l207.55" class="difflineplus">+    // Don't use the necko URL directly. Instead, get the spec and create a new</span>
<a href="#l207.56"></a><span id="l207.56" class="difflineplus">+    // URL using the IO service</span>
<a href="#l207.57"></a><span id="l207.57" class="difflineplus">+    let ioService = Cc[&quot;@mozilla.org/network/io-service;1&quot;]</span>
<a href="#l207.58"></a><span id="l207.58" class="difflineplus">+                      .getService(Ci.nsIIOService);</span>
<a href="#l207.59"></a><span id="l207.59" class="difflineplus">+    let urlToRun = ioService.newURI(neckoURL.value.spec, null, null);</span>
<a href="#l207.60"></a><span id="l207.60" class="difflineplus">+</span>
<a href="#l207.61"></a><span id="l207.61" class="difflineplus">+    // Get a channel from this URI, and check its content length</span>
<a href="#l207.62"></a><span id="l207.62" class="difflineplus">+    let channel = ioService.newChannelFromURI(urlToRun);</span>
<a href="#l207.63"></a><span id="l207.63" class="difflineplus">+    do_check_eq(channel.contentLength, kSimpleNewsArticle.length);</span>
<a href="#l207.64"></a><span id="l207.64" class="difflineplus">+</span>
<a href="#l207.65"></a><span id="l207.65" class="difflineplus">+    // Now try an attachment. &amp;part=1.2</span>
<a href="#l207.66"></a><span id="l207.66" class="difflineplus">+    // XXX the message doesn't really have an attachment</span>
<a href="#l207.67"></a><span id="l207.67" class="difflineplus">+    let attachmentURL = ioService.newURI(neckoURL.value.spec + &quot;&amp;part=1.2&quot;,</span>
<a href="#l207.68"></a><span id="l207.68" class="difflineplus">+                                         null, null);</span>
<a href="#l207.69"></a><span id="l207.69" class="difflineplus">+    let attachmentChannel = ioService.newChannelFromURI(attachmentURL);</span>
<a href="#l207.70"></a><span id="l207.70" class="difflineplus">+    // Currently attachments have their content length set to the length of the</span>
<a href="#l207.71"></a><span id="l207.71" class="difflineplus">+    // entire message</span>
<a href="#l207.72"></a><span id="l207.72" class="difflineplus">+    do_check_eq(channel.contentLength, kSimpleNewsArticle.length);</span>
<a href="#l207.73"></a><span id="l207.73" class="difflineplus">+  }</span>
<a href="#l207.74"></a><span id="l207.74" class="difflineplus">+  catch (e) {</span>
<a href="#l207.75"></a><span id="l207.75" class="difflineplus">+    server.stop();</span>
<a href="#l207.76"></a><span id="l207.76" class="difflineplus">+    do_throw(e);</span>
<a href="#l207.77"></a><span id="l207.77" class="difflineplus">+  }</span>
<a href="#l207.78"></a><span id="l207.78" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l208.1"></a><span id="l208.1" class="difflineminus">--- a/mailnews/test/data/multipart-complex2</span>
<a href="#l208.2"></a><span id="l208.2" class="difflineplus">+++ b/mailnews/test/data/multipart-complex2</span>
<a href="#l208.3"></a><span id="l208.3" class="difflineat">@@ -1,9 +1,11 @@</span>
<a href="#l208.4"></a><span id="l208.4" class="difflineplus">+From - Mon Jun 02 19:00:00 2008</span>
<a href="#l208.5"></a><span id="l208.5"> Content-Type: multipart/mixed; boundary=&quot;bou&quot;</span>
<a href="#l208.6"></a><span id="l208.6" class="difflineplus">+Message-Id: &lt;123456@example.com&gt;</span>
<a href="#l208.7"></a><span id="l208.7"> </span>
<a href="#l208.8"></a><span id="l208.8"> Part 1</span>
<a href="#l208.9"></a><span id="l208.9"> --bou                       </span>
<a href="#l208.10"></a><span id="l208.10"> Content-Type: multipart/related; boundary=&quot;bound&quot;</span>
<a href="#l208.11"></a><span id="l208.11"> </span>
<a href="#l208.12"></a><span id="l208.12"> Part 2</span>
<a href="#l208.13"></a><span id="l208.13"> --bound</span>
<a href="#l208.14"></a><span id="l208.14"> Content-Type: multipart/digest; boundary=&quot;boundar&quot;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l209.1"></a><span id="l209.1" class="difflineminus">--- a/mailnews/test/fakeserver/imapd.js</span>
<a href="#l209.2"></a><span id="l209.2" class="difflineplus">+++ b/mailnews/test/fakeserver/imapd.js</span>
<a href="#l209.3"></a><span id="l209.3" class="difflineat">@@ -132,19 +132,21 @@ imapDaemon.prototype = {</span>
<a href="#l209.4"></a><span id="l209.4">       box = box.getChild(component);</span>
<a href="#l209.5"></a><span id="l209.5">       // Yes, we won't autocreate intermediary boxes</span>
<a href="#l209.6"></a><span id="l209.6">       if (box == null || box.flags.indexOf('\\Noinferiors') != -1)</span>
<a href="#l209.7"></a><span id="l209.7">         return false;</span>
<a href="#l209.8"></a><span id="l209.8">     }</span>
<a href="#l209.9"></a><span id="l209.9">     // If this is an imapMailbox...</span>
<a href="#l209.10"></a><span id="l209.10">     if (oldBox &amp;&amp; oldBox._children) {</span>
<a href="#l209.11"></a><span id="l209.11">       // Only delete now so we don't screw ourselves up if creation fails</span>
<a href="#l209.12"></a><span id="l209.12" class="difflineminus">-      this._deleteMailbox(oldBox);</span>
<a href="#l209.13"></a><span id="l209.13" class="difflineminus">-      mailbox._parent = box == this.root ? null : box;</span>
<a href="#l209.14"></a><span id="l209.14" class="difflineminus">-      box.addMailbox(oldBox);</span>
<a href="#l209.15"></a><span id="l209.15" class="difflineplus">+      this.deleteMailbox(oldBox);</span>
<a href="#l209.16"></a><span id="l209.16" class="difflineplus">+      oldBox._parent = box == this.root ? null : box;</span>
<a href="#l209.17"></a><span id="l209.17" class="difflineplus">+      let newBox = new imapMailbox(oldBox.name, box, this.uidvalidity++);</span>
<a href="#l209.18"></a><span id="l209.18" class="difflineplus">+      newBox._messages = oldBox._messages;</span>
<a href="#l209.19"></a><span id="l209.19" class="difflineplus">+      box.addMailbox(newBox);</span>
<a href="#l209.20"></a><span id="l209.20"> </span>
<a href="#l209.21"></a><span id="l209.21">       // And if oldBox is an INBOX, we need to recreate that</span>
<a href="#l209.22"></a><span id="l209.22">       if (oldBox.name == &quot;INBOX&quot;) {</span>
<a href="#l209.23"></a><span id="l209.23">         this.inbox = new imapMailbox(&quot;INBOX&quot;, null, this.uidvalidity++);</span>
<a href="#l209.24"></a><span id="l209.24">         this.root.addMailbox(this.inbox);</span>
<a href="#l209.25"></a><span id="l209.25">       }</span>
<a href="#l209.26"></a><span id="l209.26">       oldBox.name = subName;</span>
<a href="#l209.27"></a><span id="l209.27">     } else if (oldBox) {</span>
<a href="#l209.28"></a><span id="l209.28" class="difflineat">@@ -252,34 +254,37 @@ imapMailbox.prototype = {</span>
<a href="#l209.29"></a><span id="l209.29">         for each (var part in parts) {</span>
<a href="#l209.30"></a><span id="l209.30">           index = name.indexOf(part, index);</span>
<a href="#l209.31"></a><span id="l209.31">           if (index == -1)</span>
<a href="#l209.32"></a><span id="l209.32">             return false;</span>
<a href="#l209.33"></a><span id="l209.33">         }</span>
<a href="#l209.34"></a><span id="l209.34">         return true;</span>
<a href="#l209.35"></a><span id="l209.35">       });</span>
<a href="#l209.36"></a><span id="l209.36">     }</span>
<a href="#l209.37"></a><span id="l209.37" class="difflineminus">-    if (matching[0] == this)</span>
<a href="#l209.38"></a><span id="l209.38" class="difflineminus">-      matching.shift();</span>
<a href="#l209.39"></a><span id="l209.39">     return matching;</span>
<a href="#l209.40"></a><span id="l209.40">   },</span>
<a href="#l209.41"></a><span id="l209.41">   get fullName () {</span>
<a href="#l209.42"></a><span id="l209.42">     return (this._parent ? this._parent.fullName + this.delimiter : &quot;&quot;) +</span>
<a href="#l209.43"></a><span id="l209.43">            this.name;</span>
<a href="#l209.44"></a><span id="l209.44">   },</span>
<a href="#l209.45"></a><span id="l209.45">   get displayName() {</span>
<a href="#l209.46"></a><span id="l209.46">     var converter = Cc[&quot;@mozilla.org/intl/scriptableunicodeconverter&quot;]</span>
<a href="#l209.47"></a><span id="l209.47">                       .createInstance(Ci.nsIScriptableUnicodeConverter);</span>
<a href="#l209.48"></a><span id="l209.48">     converter.charset = &quot;x-imap4-modified-utf7&quot;;</span>
<a href="#l209.49"></a><span id="l209.49">     return converter.ConvertFromUnicode(this.fullName.replace(</span>
<a href="#l209.50"></a><span id="l209.50">       /([\\&quot;])/g, '\\$1')) + converter.Finish();</span>
<a href="#l209.51"></a><span id="l209.51">   },</span>
<a href="#l209.52"></a><span id="l209.52">   get allChildren() {</span>
<a href="#l209.53"></a><span id="l209.53">     return this._children.reduce(function (arr, elem) {</span>
<a href="#l209.54"></a><span id="l209.54" class="difflineminus">-      return arr.concat(elem.allChildren);</span>
<a href="#l209.55"></a><span id="l209.55" class="difflineplus">+      return arr.concat(elem._allChildrenInternal);</span>
<a href="#l209.56"></a><span id="l209.56" class="difflineplus">+    }, []);</span>
<a href="#l209.57"></a><span id="l209.57" class="difflineplus">+  },</span>
<a href="#l209.58"></a><span id="l209.58" class="difflineplus">+  get _allChildrenInternal() {</span>
<a href="#l209.59"></a><span id="l209.59" class="difflineplus">+    return this._children.reduce(function (arr, elem) {</span>
<a href="#l209.60"></a><span id="l209.60" class="difflineplus">+      return arr.concat(elem._allChildrenInternal);</span>
<a href="#l209.61"></a><span id="l209.61">     }, [this]);</span>
<a href="#l209.62"></a><span id="l209.62">   },</span>
<a href="#l209.63"></a><span id="l209.63">   addMessage : function (message) {</span>
<a href="#l209.64"></a><span id="l209.64">     this._messages.push(message);</span>
<a href="#l209.65"></a><span id="l209.65">     if (message.uid &gt;= this.uidnext)</span>
<a href="#l209.66"></a><span id="l209.66">       this.uidnext = message.uid + 1;</span>
<a href="#l209.67"></a><span id="l209.67">     if (this._updates.indexOf(&quot;EXISTS&quot;) == -1)</span>
<a href="#l209.68"></a><span id="l209.68">       this._updates.push(&quot;EXISTS&quot;);</span>
<a href="#l209.69"></a><span id="l209.69" class="difflineat">@@ -950,27 +955,26 @@ IMAP_RFC3501_handler.prototype = {</span>
<a href="#l209.70"></a><span id="l209.70">     if (!mbox || mbox.name == &quot;&quot;)</span>
<a href="#l209.71"></a><span id="l209.71">       return &quot;NO no such mailbox&quot;;</span>
<a href="#l209.72"></a><span id="l209.72">     if (!this._daemon.createMailbox(args[1], mbox))</span>
<a href="#l209.73"></a><span id="l209.73">       return &quot;NO cannot rename mailbox&quot;;</span>
<a href="#l209.74"></a><span id="l209.74">     return &quot;OK RENAME completed&quot;;</span>
<a href="#l209.75"></a><span id="l209.75">   },</span>
<a href="#l209.76"></a><span id="l209.76">   SUBSCRIBE : function (args) {</span>
<a href="#l209.77"></a><span id="l209.77">     var mailbox = this._daemon.getMailbox(args[0]);</span>
<a href="#l209.78"></a><span id="l209.78" class="difflineminus">-    if (!mailbox || mailbox.subscribed)</span>
<a href="#l209.79"></a><span id="l209.79" class="difflineplus">+    if (!mailbox)</span>
<a href="#l209.80"></a><span id="l209.80">       return &quot;NO error in subscribing&quot;;</span>
<a href="#l209.81"></a><span id="l209.81">     mailbox.subscribed = true;</span>
<a href="#l209.82"></a><span id="l209.82">     return &quot;OK SUBSCRIBE completed&quot;;</span>
<a href="#l209.83"></a><span id="l209.83">   },</span>
<a href="#l209.84"></a><span id="l209.84">   UNSUBSCRIBE : function (args) {</span>
<a href="#l209.85"></a><span id="l209.85">     var mailbox = this._daemon.getMailbox(args[0]);</span>
<a href="#l209.86"></a><span id="l209.86" class="difflineminus">-    if (!mailbox || !mailbox.subscribed)</span>
<a href="#l209.87"></a><span id="l209.87" class="difflineminus">-      return &quot;NO error in unsubscribing&quot;;</span>
<a href="#l209.88"></a><span id="l209.88" class="difflineminus">-    mailbox.subscribed = false;</span>
<a href="#l209.89"></a><span id="l209.89" class="difflineminus">-    return &quot;OK SUBSCRIBE completed&quot;;</span>
<a href="#l209.90"></a><span id="l209.90" class="difflineplus">+    if (mailbox)</span>
<a href="#l209.91"></a><span id="l209.91" class="difflineplus">+      mailbox.subscribed = false;</span>
<a href="#l209.92"></a><span id="l209.92" class="difflineplus">+    return &quot;OK UNSUBSCRIBE completed&quot;;</span>
<a href="#l209.93"></a><span id="l209.93">   },</span>
<a href="#l209.94"></a><span id="l209.94">   LIST : function (args) {</span>
<a href="#l209.95"></a><span id="l209.95">     var base = this._daemon.getMailbox(args[0]);</span>
<a href="#l209.96"></a><span id="l209.96">     if (!base)</span>
<a href="#l209.97"></a><span id="l209.97">       return &quot;NO no such mailbox&quot;;</span>
<a href="#l209.98"></a><span id="l209.98">     var people = base.matchKids(args[1]);</span>
<a href="#l209.99"></a><span id="l209.99">     var response = &quot;&quot;;</span>
<a href="#l209.100"></a><span id="l209.100">     for each (var box in people)</span>
<a href="#l209.101"></a><span id="l209.101" class="difflineat">@@ -1018,17 +1022,17 @@ IMAP_RFC3501_handler.prototype = {</span>
<a href="#l209.102"></a><span id="l209.102">           return count + (message.flags.indexOf('\\Seen') == -1 ? 1 : 0);</span>
<a href="#l209.103"></a><span id="l209.103">         }, 0);</span>
<a href="#l209.104"></a><span id="l209.104">         break;</span>
<a href="#l209.105"></a><span id="l209.105">       default:</span>
<a href="#l209.106"></a><span id="l209.106">         return &quot;BAD unknown status flag: &quot; + status;</span>
<a href="#l209.107"></a><span id="l209.107">       }</span>
<a href="#l209.108"></a><span id="l209.108">       parts.push(line);</span>
<a href="#l209.109"></a><span id="l209.109">     }</span>
<a href="#l209.110"></a><span id="l209.110" class="difflineminus">-    return &quot;* STATUS &quot; + args[0] + &quot; (&quot; + parts.join(' ') +</span>
<a href="#l209.111"></a><span id="l209.111" class="difflineplus">+    return &quot;* STATUS \&quot;&quot; + args[0] + &quot;\&quot; (&quot; + parts.join(' ') +</span>
<a href="#l209.112"></a><span id="l209.112">            &quot;)\0OK STATUS completed&quot;;</span>
<a href="#l209.113"></a><span id="l209.113">   },</span>
<a href="#l209.114"></a><span id="l209.114">   APPEND : function (args) {</span>
<a href="#l209.115"></a><span id="l209.115">     var mailbox = this._daemon.getMailbox(args[0]);</span>
<a href="#l209.116"></a><span id="l209.116">     if (!mailbox)</span>
<a href="#l209.117"></a><span id="l209.117">       return &quot;NO [TRYCREATE] no such mailbox&quot;;</span>
<a href="#l209.118"></a><span id="l209.118">     if (args.length == 3) {</span>
<a href="#l209.119"></a><span id="l209.119">       if (args[1] instanceof Date) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l210.1"></a><span id="l210.1" class="difflineminus">--- a/mailnews/test/resources/mailDirService.js</span>
<a href="#l210.2"></a><span id="l210.2" class="difflineplus">+++ b/mailnews/test/resources/mailDirService.js</span>
<a href="#l210.3"></a><span id="l210.3" class="difflineat">@@ -12,16 +12,18 @@</span>
<a href="#l210.4"></a><span id="l210.4"> Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l210.5"></a><span id="l210.5"> </span>
<a href="#l210.6"></a><span id="l210.6"> // Declare these globally for unit tests and be done with it.</span>
<a href="#l210.7"></a><span id="l210.7"> var Cc = Components.classes;</span>
<a href="#l210.8"></a><span id="l210.8"> var Ci = Components.interfaces;</span>
<a href="#l210.9"></a><span id="l210.9"> var Cr = Components.results;</span>
<a href="#l210.10"></a><span id="l210.10"> var CC = Components.Constructor;</span>
<a href="#l210.11"></a><span id="l210.11"> </span>
<a href="#l210.12"></a><span id="l210.12" class="difflineplus">+var gProfileDirProvider = null;</span>
<a href="#l210.13"></a><span id="l210.13" class="difflineplus">+</span>
<a href="#l210.14"></a><span id="l210.14"> // keep things out of global scope where possible.</span>
<a href="#l210.15"></a><span id="l210.15"> function initializeDirServer() {</span>
<a href="#l210.16"></a><span id="l210.16">   const NS_APP_USER_PROFILE_50_DIR = &quot;ProfD&quot;;</span>
<a href="#l210.17"></a><span id="l210.17"> </span>
<a href="#l210.18"></a><span id="l210.18">   // Various functions common to the tests.</span>
<a href="#l210.19"></a><span id="l210.19">   const MailTestDirServer = {</span>
<a href="#l210.20"></a><span id="l210.20">     /*</span>
<a href="#l210.21"></a><span id="l210.21">      * makeDirectoryService</span>
<a href="#l210.22"></a><span id="l210.22" class="difflineat">@@ -65,18 +67,18 @@ function initializeDirServer() {</span>
<a href="#l210.23"></a><span id="l210.23">           dump(&quot;Directory request for: &quot; + prop + &quot; that we (mailDirService.js)&quot; +</span>
<a href="#l210.24"></a><span id="l210.24">                &quot; are not handling, leaving it to another handler.\n&quot;);</span>
<a href="#l210.25"></a><span id="l210.25">           throw Components.results.NS_ERROR_FAILURE;</span>
<a href="#l210.26"></a><span id="l210.26">         },</span>
<a href="#l210.27"></a><span id="l210.27"> </span>
<a href="#l210.28"></a><span id="l210.28">         QueryInterface:</span>
<a href="#l210.29"></a><span id="l210.29">           XPCOMUtils.generateQI([Ci.nsIDirectoryServiceProvider])</span>
<a href="#l210.30"></a><span id="l210.30">       };</span>
<a href="#l210.31"></a><span id="l210.31" class="difflineminus">-</span>
<a href="#l210.32"></a><span id="l210.32" class="difflineminus">-      dirSvc.QueryInterface(Ci.nsIDirectoryService).registerProvider(provider);</span>
<a href="#l210.33"></a><span id="l210.33" class="difflineplus">+      gProfileDirProvider = provider;</span>
<a href="#l210.34"></a><span id="l210.34" class="difflineplus">+      dirSvc.QueryInterface(Ci.nsIDirectoryService).registerProvider(gProfileDirProvider);</span>
<a href="#l210.35"></a><span id="l210.35">     }</span>
<a href="#l210.36"></a><span id="l210.36">   };</span>
<a href="#l210.37"></a><span id="l210.37"> </span>
<a href="#l210.38"></a><span id="l210.38">   // If there's no location registered for the profile directory, register one</span>
<a href="#l210.39"></a><span id="l210.39">   var dirSvc = Cc[&quot;@mozilla.org/file/directory_service;1&quot;]</span>
<a href="#l210.40"></a><span id="l210.40">                  .getService(Ci.nsIProperties);</span>
<a href="#l210.41"></a><span id="l210.41">   var profileDir;</span>
<a href="#l210.42"></a><span id="l210.42">   try {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l211.1"></a><span id="l211.1">new file mode 100644</span>
<a href="#l211.2"></a><span id="l211.2" class="difflineminus">--- /dev/null</span>
<a href="#l211.3"></a><span id="l211.3" class="difflineplus">+++ b/mailnews/test/resources/mailShutdown.js</span>
<a href="#l211.4"></a><span id="l211.4" class="difflineat">@@ -0,0 +1,44 @@</span>
<a href="#l211.5"></a><span id="l211.5" class="difflineplus">+ </span>
<a href="#l211.6"></a><span id="l211.6" class="difflineplus">+/* Provides methods to make sure our test shuts down mailnews properly. */</span>
<a href="#l211.7"></a><span id="l211.7" class="difflineplus">+</span>
<a href="#l211.8"></a><span id="l211.8" class="difflineplus">+// Notifies everyone that the we're shutting down. This is needed to make sure</span>
<a href="#l211.9"></a><span id="l211.9" class="difflineplus">+// that e.g. the account manager closes and cleans up correctly. It is semi-fake</span>
<a href="#l211.10"></a><span id="l211.10" class="difflineplus">+// because we don't actually do any work to make sure the profile goes away, but</span>
<a href="#l211.11"></a><span id="l211.11" class="difflineplus">+// it will mimic the behaviour in the app sufficiently.</span>
<a href="#l211.12"></a><span id="l211.12" class="difflineplus">+//</span>
<a href="#l211.13"></a><span id="l211.13" class="difflineplus">+// See also http://developer.mozilla.org/en/docs/Observer_Notifications</span>
<a href="#l211.14"></a><span id="l211.14" class="difflineplus">+function postShutdownNotifications()</span>
<a href="#l211.15"></a><span id="l211.15" class="difflineplus">+{</span>
<a href="#l211.16"></a><span id="l211.16" class="difflineplus">+  var observerService = Cc[&quot;@mozilla.org/observer-service;1&quot;]</span>
<a href="#l211.17"></a><span id="l211.17" class="difflineplus">+                          .getService(Components.interfaces.nsIObserverService);</span>
<a href="#l211.18"></a><span id="l211.18" class="difflineplus">+                          </span>
<a href="#l211.19"></a><span id="l211.19" class="difflineplus">+  // first give everyone a heads up about us shutting down. if someone wants</span>
<a href="#l211.20"></a><span id="l211.20" class="difflineplus">+  // to cancel this, our test should fail.</span>
<a href="#l211.21"></a><span id="l211.21" class="difflineplus">+  var cancelQuit = Cc[&quot;@mozilla.org/supports-PRBool;1&quot;]</span>
<a href="#l211.22"></a><span id="l211.22" class="difflineplus">+                     .createInstance(Components.interfaces.nsISupportsPRBool);</span>
<a href="#l211.23"></a><span id="l211.23" class="difflineplus">+  observerService.notifyObservers(cancelQuit, &quot;quit-application-requested&quot;, null);</span>
<a href="#l211.24"></a><span id="l211.24" class="difflineplus">+  if (cancelQuit.data) {</span>
<a href="#l211.25"></a><span id="l211.25" class="difflineplus">+    do_throw(&quot;Cannot shutdown: Someone cancelled the quit request!&quot;);</span>
<a href="#l211.26"></a><span id="l211.26" class="difflineplus">+  }</span>
<a href="#l211.27"></a><span id="l211.27" class="difflineplus">+  </span>
<a href="#l211.28"></a><span id="l211.28" class="difflineplus">+  // post all notifications in the right order. none of these are cancellable</span>
<a href="#l211.29"></a><span id="l211.29" class="difflineplus">+  var notifications = [&quot;quit-application&quot;, &quot;profile-change-net-teardown&quot;, &quot;profie-change-teardown&quot;, &quot;profile-before-change&quot;];</span>
<a href="#l211.30"></a><span id="l211.30" class="difflineplus">+  notifications.forEach(function(notification) {</span>
<a href="#l211.31"></a><span id="l211.31" class="difflineplus">+                          observerService.notifyObservers(null, notification, null)</span>
<a href="#l211.32"></a><span id="l211.32" class="difflineplus">+                        });</span>
<a href="#l211.33"></a><span id="l211.33" class="difflineplus">+</span>
<a href="#l211.34"></a><span id="l211.34" class="difflineplus">+  // finally, the xpcom-shutdown notification is handled by XPCOM itself.</span>
<a href="#l211.35"></a><span id="l211.35" class="difflineplus">+}</span>
<a href="#l211.36"></a><span id="l211.36" class="difflineplus">+</span>
<a href="#l211.37"></a><span id="l211.37" class="difflineplus">+// First do a gc to let anything not being referenced be cleaned up.</span>
<a href="#l211.38"></a><span id="l211.38" class="difflineplus">+gc();</span>
<a href="#l211.39"></a><span id="l211.39" class="difflineplus">+</span>
<a href="#l211.40"></a><span id="l211.40" class="difflineplus">+// Now shut everything down.</span>
<a href="#l211.41"></a><span id="l211.41" class="difflineplus">+postShutdownNotifications();</span>
<a href="#l211.42"></a><span id="l211.42" class="difflineplus">+</span>
<a href="#l211.43"></a><span id="l211.43" class="difflineplus">+gProfileDir = null;</span>
<a href="#l211.44"></a><span id="l211.44" class="difflineplus">+if (gProfileDirProvider) {</span>
<a href="#l211.45"></a><span id="l211.45" class="difflineplus">+  var dirSvc = Cc[&quot;@mozilla.org/file/directory_service;1&quot;]</span>
<a href="#l211.46"></a><span id="l211.46" class="difflineplus">+    .getService(Ci.nsIProperties);</span>
<a href="#l211.47"></a><span id="l211.47" class="difflineplus">+  dirSvc.unregisterProvider(gProfileDirProvider);</span>
<a href="#l211.48"></a><span id="l211.48" class="difflineplus">+ }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l212.1"></a><span id="l212.1" class="difflineminus">--- a/mailnews/test/resources/viewWrapperTestUtils.js</span>
<a href="#l212.2"></a><span id="l212.2" class="difflineplus">+++ b/mailnews/test/resources/viewWrapperTestUtils.js</span>
<a href="#l212.3"></a><span id="l212.3" class="difflineat">@@ -1,14 +1,63 @@</span>
<a href="#l212.4"></a><span id="l212.4" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l212.5"></a><span id="l212.5" class="difflineplus">+ *   Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l212.6"></a><span id="l212.6" class="difflineplus">+ *</span>
<a href="#l212.7"></a><span id="l212.7" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l212.8"></a><span id="l212.8" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l212.9"></a><span id="l212.9" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l212.10"></a><span id="l212.10" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l212.11"></a><span id="l212.11" class="difflineplus">+ *</span>
<a href="#l212.12"></a><span id="l212.12" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l212.13"></a><span id="l212.13" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l212.14"></a><span id="l212.14" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l212.15"></a><span id="l212.15" class="difflineplus">+ * License.</span>
<a href="#l212.16"></a><span id="l212.16" class="difflineplus">+ *</span>
<a href="#l212.17"></a><span id="l212.17" class="difflineplus">+ * The Original Code is Thunderbird Mail Client.</span>
<a href="#l212.18"></a><span id="l212.18" class="difflineplus">+ *</span>
<a href="#l212.19"></a><span id="l212.19" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l212.20"></a><span id="l212.20" class="difflineplus">+ * Mozilla Messaging, Inc.</span>
<a href="#l212.21"></a><span id="l212.21" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l212.22"></a><span id="l212.22" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l212.23"></a><span id="l212.23" class="difflineplus">+ *</span>
<a href="#l212.24"></a><span id="l212.24" class="difflineplus">+ * Contributor(s):</span>
<a href="#l212.25"></a><span id="l212.25" class="difflineplus">+ *   Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a href="#l212.26"></a><span id="l212.26" class="difflineplus">+ *</span>
<a href="#l212.27"></a><span id="l212.27" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l212.28"></a><span id="l212.28" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l212.29"></a><span id="l212.29" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l212.30"></a><span id="l212.30" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l212.31"></a><span id="l212.31" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l212.32"></a><span id="l212.32" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l212.33"></a><span id="l212.33" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l212.34"></a><span id="l212.34" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l212.35"></a><span id="l212.35" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l212.36"></a><span id="l212.36" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l212.37"></a><span id="l212.37" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l212.38"></a><span id="l212.38" class="difflineplus">+ *</span>
<a href="#l212.39"></a><span id="l212.39" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l212.40"></a><span id="l212.40"> </span>
<a href="#l212.41"></a><span id="l212.41"> Components.utils.import(&quot;resource://app/modules/dbViewWrapper.js&quot;);</span>
<a href="#l212.42"></a><span id="l212.42"> Components.utils.import(&quot;resource://app/modules/mailViewManager.js&quot;);</span>
<a href="#l212.43"></a><span id="l212.43"> Components.utils.import(&quot;resource://app/modules/quickSearchManager.js&quot;);</span>
<a href="#l212.44"></a><span id="l212.44"> Components.utils.import(&quot;resource://app/modules/virtualFolderWrapper.js&quot;);</span>
<a href="#l212.45"></a><span id="l212.45"> </span>
<a href="#l212.46"></a><span id="l212.46" class="difflineplus">+var gMessageGenerator, gMessageScenarioFactory;</span>
<a href="#l212.47"></a><span id="l212.47" class="difflineplus">+</span>
<a href="#l212.48"></a><span id="l212.48" class="difflineplus">+/**</span>
<a href="#l212.49"></a><span id="l212.49" class="difflineplus">+ * Do initialization for xpcshell-tests; not used by</span>
<a href="#l212.50"></a><span id="l212.50" class="difflineplus">+ *  test-folder-display-helpers.js, our friendly mozmill test helper.</span>
<a href="#l212.51"></a><span id="l212.51" class="difflineplus">+ */</span>
<a href="#l212.52"></a><span id="l212.52" class="difflineplus">+function initViewWrapperTestUtils() {</span>
<a href="#l212.53"></a><span id="l212.53" class="difflineplus">+  gMessageGenerator = new MessageGenerator();</span>
<a href="#l212.54"></a><span id="l212.54" class="difflineplus">+  gMessageScenarioFactory = new MessageScenarioFactory(gMessageGenerator);</span>
<a href="#l212.55"></a><span id="l212.55" class="difflineplus">+</span>
<a href="#l212.56"></a><span id="l212.56" class="difflineplus">+  async_test_runner_register_helper(VWTU_testHelper);</span>
<a href="#l212.57"></a><span id="l212.57" class="difflineplus">+}</span>
<a href="#l212.58"></a><span id="l212.58" class="difflineplus">+</span>
<a href="#l212.59"></a><span id="l212.59"> // something less sucky than do_check_true</span>
<a href="#l212.60"></a><span id="l212.60"> function assert_true(aBeTrue, aWhy, aDumpView) {</span>
<a href="#l212.61"></a><span id="l212.61">   if (!aBeTrue) {</span>
<a href="#l212.62"></a><span id="l212.62">     if (aDumpView)</span>
<a href="#l212.63"></a><span id="l212.63">       dump_view_state(VWTU_testHelper.active_view_wrappers[0]);</span>
<a href="#l212.64"></a><span id="l212.64">     do_throw(aWhy);</span>
<a href="#l212.65"></a><span id="l212.65">   }</span>
<a href="#l212.66"></a><span id="l212.66"> }</span>
<a href="#l212.67"></a><span id="l212.67" class="difflineat">@@ -24,27 +73,37 @@ function assert_false(aBeFalse, aWhy, aD</span>
<a href="#l212.68"></a><span id="l212.68"> function assert_equals(aA, aB, aWhy, aDumpView) {</span>
<a href="#l212.69"></a><span id="l212.69">   if (aA != aB) {</span>
<a href="#l212.70"></a><span id="l212.70">     if (aDumpView)</span>
<a href="#l212.71"></a><span id="l212.71">       dump_view_state(VWTU_testHelper.active_view_wrappers[0]);</span>
<a href="#l212.72"></a><span id="l212.72">     do_throw(aWhy);</span>
<a href="#l212.73"></a><span id="l212.73">   }</span>
<a href="#l212.74"></a><span id="l212.74"> }</span>
<a href="#l212.75"></a><span id="l212.75"> </span>
<a href="#l212.76"></a><span id="l212.76" class="difflineplus">+function assert_bit_set(aWhat, aBit, aWhy) {</span>
<a href="#l212.77"></a><span id="l212.77" class="difflineplus">+  if (!(aWhat &amp; aBit))</span>
<a href="#l212.78"></a><span id="l212.78" class="difflineplus">+    do_throw(aWhy);</span>
<a href="#l212.79"></a><span id="l212.79" class="difflineplus">+}</span>
<a href="#l212.80"></a><span id="l212.80" class="difflineplus">+</span>
<a href="#l212.81"></a><span id="l212.81" class="difflineplus">+function assert_bit_not_set(aWhat, aBit, aWhy) {</span>
<a href="#l212.82"></a><span id="l212.82" class="difflineplus">+  if (aWhat &amp; aBit)</span>
<a href="#l212.83"></a><span id="l212.83" class="difflineplus">+    do_throw(aWhy);</span>
<a href="#l212.84"></a><span id="l212.84" class="difflineplus">+}</span>
<a href="#l212.85"></a><span id="l212.85" class="difflineplus">+</span>
<a href="#l212.86"></a><span id="l212.86"> var gFakeCommandUpdater = {</span>
<a href="#l212.87"></a><span id="l212.87" class="difflineminus">-  updateCommandStatus : function()</span>
<a href="#l212.88"></a><span id="l212.88" class="difflineminus">-  {</span>
<a href="#l212.89"></a><span id="l212.89" class="difflineplus">+  updateCommandStatus : function() {</span>
<a href="#l212.90"></a><span id="l212.90">   },</span>
<a href="#l212.91"></a><span id="l212.91"> </span>
<a href="#l212.92"></a><span id="l212.92" class="difflineminus">-  displayMessageChanged : function(aFolder, aSubject, aKeywords)</span>
<a href="#l212.93"></a><span id="l212.93" class="difflineminus">-  {</span>
<a href="#l212.94"></a><span id="l212.94" class="difflineplus">+  displayMessageChanged : function(aFolder, aSubject, aKeywords) {</span>
<a href="#l212.95"></a><span id="l212.95">   },</span>
<a href="#l212.96"></a><span id="l212.96"> </span>
<a href="#l212.97"></a><span id="l212.97" class="difflineminus">-  updateNextMessageAfterDelete : function()</span>
<a href="#l212.98"></a><span id="l212.98" class="difflineminus">-  {</span>
<a href="#l212.99"></a><span id="l212.99" class="difflineplus">+  summarizeSelection: function () {</span>
<a href="#l212.100"></a><span id="l212.100" class="difflineplus">+  },</span>
<a href="#l212.101"></a><span id="l212.101" class="difflineplus">+</span>
<a href="#l212.102"></a><span id="l212.102" class="difflineplus">+  updateNextMessageAfterDelete : function() {</span>
<a href="#l212.103"></a><span id="l212.103">   }</span>
<a href="#l212.104"></a><span id="l212.104"> };</span>
<a href="#l212.105"></a><span id="l212.105"> </span>
<a href="#l212.106"></a><span id="l212.106"> var gMockViewWrapperListener = {</span>
<a href="#l212.107"></a><span id="l212.107">   __proto__: IDBViewWrapperListener.prototype,</span>
<a href="#l212.108"></a><span id="l212.108">   shouldUseMailViews: true,</span>
<a href="#l212.109"></a><span id="l212.109">   shouldDeferMessageDisplayUntilAfterServerConnect: false,</span>
<a href="#l212.110"></a><span id="l212.110">   messenger: null,</span>
<a href="#l212.111"></a><span id="l212.111" class="difflineat">@@ -83,18 +142,34 @@ var VWTU_testHelper = {</span>
<a href="#l212.112"></a><span id="l212.112">   active_virtual_folders: [],</span>
<a href="#l212.113"></a><span id="l212.113"> </span>
<a href="#l212.114"></a><span id="l212.114">   postTest: function () {</span>
<a href="#l212.115"></a><span id="l212.115">     // close all the views we opened</span>
<a href="#l212.116"></a><span id="l212.116">     this.active_view_wrappers.forEach(function (wrapper) {</span>
<a href="#l212.117"></a><span id="l212.117">       wrapper.close();</span>
<a href="#l212.118"></a><span id="l212.118">     });</span>
<a href="#l212.119"></a><span id="l212.119">     // verify that the notification helper has no outstanding listeners.</span>
<a href="#l212.120"></a><span id="l212.120" class="difflineminus">-    if (IDBViewWrapperListener.prototype._FNH.haveListeners())</span>
<a href="#l212.121"></a><span id="l212.121" class="difflineminus">-      do_throw(&quot;FolderNotificationHelper has listeners, but should not.&quot;);</span>
<a href="#l212.122"></a><span id="l212.122" class="difflineplus">+    if (IDBViewWrapperListener.prototype._FNH.haveListeners()) {</span>
<a href="#l212.123"></a><span id="l212.123" class="difflineplus">+      let msg = &quot;FolderNotificationHelper has listeners, but should not.&quot;;</span>
<a href="#l212.124"></a><span id="l212.124" class="difflineplus">+      dump(&quot;*** &quot; + msg + &quot;\n&quot;);</span>
<a href="#l212.125"></a><span id="l212.125" class="difflineplus">+      dump(&quot;Pending URIs:\n&quot;);</span>
<a href="#l212.126"></a><span id="l212.126" class="difflineplus">+      for each (let [folderURI, wrappers] in</span>
<a href="#l212.127"></a><span id="l212.127" class="difflineplus">+                Iterator(IDBViewWrapperListener.prototype._FNH</span>
<a href="#l212.128"></a><span id="l212.128" class="difflineplus">+                           ._pendingFolderUriToViewWrapperLists)) {</span>
<a href="#l212.129"></a><span id="l212.129" class="difflineplus">+        dump(&quot;  &quot; + folderURI + &quot;\n&quot;);</span>
<a href="#l212.130"></a><span id="l212.130" class="difflineplus">+      }</span>
<a href="#l212.131"></a><span id="l212.131" class="difflineplus">+      dump(&quot;Interested wrappers:\n&quot;);</span>
<a href="#l212.132"></a><span id="l212.132" class="difflineplus">+      for each (let [folderURI, wrappers] in</span>
<a href="#l212.133"></a><span id="l212.133" class="difflineplus">+                Iterator(IDBViewWrapperListener.prototype._FNH</span>
<a href="#l212.134"></a><span id="l212.134" class="difflineplus">+                           ._interestedWrappers)) {</span>
<a href="#l212.135"></a><span id="l212.135" class="difflineplus">+        dump(&quot;  &quot; + folderURI + &quot;\n&quot;);</span>
<a href="#l212.136"></a><span id="l212.136" class="difflineplus">+      }</span>
<a href="#l212.137"></a><span id="l212.137" class="difflineplus">+      dump(&quot;***\n&quot;);</span>
<a href="#l212.138"></a><span id="l212.138" class="difflineplus">+      do_throw(msg);</span>
<a href="#l212.139"></a><span id="l212.139" class="difflineplus">+    }</span>
<a href="#l212.140"></a><span id="l212.140">     // force the folder to forget about the message database</span>
<a href="#l212.141"></a><span id="l212.141">     this.active_virtual_folders.forEach(function (folder) {</span>
<a href="#l212.142"></a><span id="l212.142">       folder.msgDatabase = null;</span>
<a href="#l212.143"></a><span id="l212.143">     });</span>
<a href="#l212.144"></a><span id="l212.144">     this.active_real_folders.forEach(function (folder) {</span>
<a href="#l212.145"></a><span id="l212.145">       folder.msgDatabase = null;</span>
<a href="#l212.146"></a><span id="l212.146">     });</span>
<a href="#l212.147"></a><span id="l212.147"> </span>
<a href="#l212.148"></a><span id="l212.148" class="difflineat">@@ -115,17 +190,16 @@ var VWTU_testHelper = {</span>
<a href="#l212.149"></a><span id="l212.149">     }</span>
<a href="#l212.150"></a><span id="l212.150">     for each (let [i, viewWrapper] in Iterator(this.active_view_wrappers)) {</span>
<a href="#l212.151"></a><span id="l212.151">       dump(&quot;-----------------------------------\n&quot;);</span>
<a href="#l212.152"></a><span id="l212.152">       dump(&quot;Active view wrapper &quot; + i + &quot;\n&quot;);</span>
<a href="#l212.153"></a><span id="l212.153">       dump_view_state(viewWrapper);</span>
<a href="#l212.154"></a><span id="l212.154">     }</span>
<a href="#l212.155"></a><span id="l212.155">   }</span>
<a href="#l212.156"></a><span id="l212.156"> };</span>
<a href="#l212.157"></a><span id="l212.157" class="difflineminus">-async_test_runner_register_helper(VWTU_testHelper);</span>
<a href="#l212.158"></a><span id="l212.158"> </span>
<a href="#l212.159"></a><span id="l212.159"> function make_view_wrapper() {</span>
<a href="#l212.160"></a><span id="l212.160">   let wrapper = new DBViewWrapper(gMockViewWrapperListener);</span>
<a href="#l212.161"></a><span id="l212.161">   VWTU_testHelper.active_view_wrappers.push(wrapper);</span>
<a href="#l212.162"></a><span id="l212.162">   return wrapper;</span>
<a href="#l212.163"></a><span id="l212.163"> }</span>
<a href="#l212.164"></a><span id="l212.164"> </span>
<a href="#l212.165"></a><span id="l212.165"> /**</span>
<a href="#l212.166"></a><span id="l212.166" class="difflineat">@@ -457,16 +531,34 @@ function verify_view_level_histogram(aEx</span>
<a href="#l212.167"></a><span id="l212.167">       dump(&quot;Expected count for histogram level &quot; + level + &quot; was &quot; + count +</span>
<a href="#l212.168"></a><span id="l212.168">            &quot; but got &quot; + actualHisto[level] + &quot;\n&quot;);</span>
<a href="#l212.169"></a><span id="l212.169">       do_throw(&quot;View histogram does not match!&quot;);</span>
<a href="#l212.170"></a><span id="l212.170">     }</span>
<a href="#l212.171"></a><span id="l212.171">   }</span>
<a href="#l212.172"></a><span id="l212.172"> }</span>
<a href="#l212.173"></a><span id="l212.173"> </span>
<a href="#l212.174"></a><span id="l212.174"> /**</span>
<a href="#l212.175"></a><span id="l212.175" class="difflineplus">+ * Given a view wrapper and one or more view indices, verify that the row</span>
<a href="#l212.176"></a><span id="l212.176" class="difflineplus">+ *  returns true for isContainer.</span>
<a href="#l212.177"></a><span id="l212.177" class="difflineplus">+ *</span>
<a href="#l212.178"></a><span id="l212.178" class="difflineplus">+ * @param aViewWrapper The view wrapper in question</span>
<a href="#l212.179"></a><span id="l212.179" class="difflineplus">+ * @param ... View indices to check.</span>
<a href="#l212.180"></a><span id="l212.180" class="difflineplus">+ */</span>
<a href="#l212.181"></a><span id="l212.181" class="difflineplus">+function verify_view_row_at_index_is_container(aViewWrapper) {</span>
<a href="#l212.182"></a><span id="l212.182" class="difflineplus">+  let treeView = aViewWrapper.dbView.QueryInterface(Ci.nsITreeView);</span>
<a href="#l212.183"></a><span id="l212.183" class="difflineplus">+  for (let iArg = 1; iArg &lt; arguments.length; iArg++) {</span>
<a href="#l212.184"></a><span id="l212.184" class="difflineplus">+    let viewIndex = arguments[iArg];</span>
<a href="#l212.185"></a><span id="l212.185" class="difflineplus">+    if (!treeView.isContainer(viewIndex)) {</span>
<a href="#l212.186"></a><span id="l212.186" class="difflineplus">+      dump_view_state(aViewWrapper);</span>
<a href="#l212.187"></a><span id="l212.187" class="difflineplus">+      do_throw(&quot;Expected isContainer to be true at view index &quot; + viewIndex);</span>
<a href="#l212.188"></a><span id="l212.188" class="difflineplus">+    }</span>
<a href="#l212.189"></a><span id="l212.189" class="difflineplus">+  }</span>
<a href="#l212.190"></a><span id="l212.190" class="difflineplus">+}</span>
<a href="#l212.191"></a><span id="l212.191" class="difflineplus">+</span>
<a href="#l212.192"></a><span id="l212.192" class="difflineplus">+/**</span>
<a href="#l212.193"></a><span id="l212.193">  * Given a view wrapper and one or more view indices, verify that there is a</span>
<a href="#l212.194"></a><span id="l212.194">  *  dummy header at each provided index.</span>
<a href="#l212.195"></a><span id="l212.195">  *</span>
<a href="#l212.196"></a><span id="l212.196">  * @param aViewWrapper The view wrapper in question</span>
<a href="#l212.197"></a><span id="l212.197">  * @param ... View indices to check.</span>
<a href="#l212.198"></a><span id="l212.198">  */</span>
<a href="#l212.199"></a><span id="l212.199"> function verify_view_row_at_index_is_dummy(aViewWrapper) {</span>
<a href="#l212.200"></a><span id="l212.200">   for (let iArg = 1; iArg &lt; arguments.length; iArg++) {</span>
<a href="#l212.201"></a><span id="l212.201" class="difflineat">@@ -525,18 +617,16 @@ function make_folders_with_sets(aFolderC</span>
<a href="#l212.202"></a><span id="l212.202">   let msgFolders = [];</span>
<a href="#l212.203"></a><span id="l212.203">   for (let i = 0; i &lt; aFolderCount; i++)</span>
<a href="#l212.204"></a><span id="l212.204">     msgFolders.push(make_empty_folder());</span>
<a href="#l212.205"></a><span id="l212.205">   let results = make_new_sets_in_folders(msgFolders, aSynSetDefs);</span>
<a href="#l212.206"></a><span id="l212.206">   results.unshift(msgFolders);</span>
<a href="#l212.207"></a><span id="l212.207">   return results;</span>
<a href="#l212.208"></a><span id="l212.208"> }</span>
<a href="#l212.209"></a><span id="l212.209"> </span>
<a href="#l212.210"></a><span id="l212.210" class="difflineminus">-var gMessageGenerator = new MessageGenerator();</span>
<a href="#l212.211"></a><span id="l212.211" class="difflineminus">-var gMessageScenarioFactory = new MessageScenarioFactory(gMessageGenerator);</span>
<a href="#l212.212"></a><span id="l212.212"> /**</span>
<a href="#l212.213"></a><span id="l212.213">  * Given one or more existing local folder, create new message sets and add them</span>
<a href="#l212.214"></a><span id="l212.214">  *  to the folders using</span>
<a href="#l212.215"></a><span id="l212.215">  *</span>
<a href="#l212.216"></a><span id="l212.216">  * @param aMsgFolders A single nsIMsgLocalMailFolder or a list of them.  The</span>
<a href="#l212.217"></a><span id="l212.217">  *     synthetic messages will be added to the folder(s).</span>
<a href="#l212.218"></a><span id="l212.218">  * @param aSynSetDefs Either an integer describing the number of sets of</span>
<a href="#l212.219"></a><span id="l212.219">  *     messages to create (using default parameters), or a list of set</span>
<a href="#l212.220"></a><span id="l212.220" class="difflineat">@@ -625,16 +715,17 @@ function add_sets_to_folders(aMsgFolders</span>
<a href="#l212.221"></a><span id="l212.221">   // loop, incrementing our subscript until all message sets are out of messages</span>
<a href="#l212.222"></a><span id="l212.222">   let didSomething;</span>
<a href="#l212.223"></a><span id="l212.223">   do {</span>
<a href="#l212.224"></a><span id="l212.224">     didSomething = false;</span>
<a href="#l212.225"></a><span id="l212.225">     // for each message set, if it is not out of messages, add the message</span>
<a href="#l212.226"></a><span id="l212.226">     for each (let [, messageSet] in Iterator(aMessageSets)) {</span>
<a href="#l212.227"></a><span id="l212.227">       if (iPerSet &lt; messageSet.synMessages.length) {</span>
<a href="#l212.228"></a><span id="l212.228">         messageSet.addMessageToFolderByIndex(folder, iPerSet);</span>
<a href="#l212.229"></a><span id="l212.229" class="difflineplus">+        folder.hasNewMessages = true;</span>
<a href="#l212.230"></a><span id="l212.230">         didSomething = true;</span>
<a href="#l212.231"></a><span id="l212.231">       }</span>
<a href="#l212.232"></a><span id="l212.232">     }</span>
<a href="#l212.233"></a><span id="l212.233">     iPerSet++;</span>
<a href="#l212.234"></a><span id="l212.234">     folder = iterFolders.next();</span>
<a href="#l212.235"></a><span id="l212.235">   } while (didSomething);</span>
<a href="#l212.236"></a><span id="l212.236"> }</span>
<a href="#l212.237"></a><span id="l212.237"> /** singular function name for understandability of single-folder users */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l213.1"></a><span id="l213.1" class="difflineminus">--- a/suite/browser/browser-prefs.js</span>
<a href="#l213.2"></a><span id="l213.2" class="difflineplus">+++ b/suite/browser/browser-prefs.js</span>
<a href="#l213.3"></a><span id="l213.3" class="difflineat">@@ -431,17 +431,17 @@ pref(&quot;extensions.blocklist.detailsURL&quot;, </span>
<a href="#l213.4"></a><span id="l213.4"> // Symmetric (can be overridden by individual extensions) update preferences.</span>
<a href="#l213.5"></a><span id="l213.5"> // e.g.</span>
<a href="#l213.6"></a><span id="l213.6"> //  extensions.{GUID}.update.enabled</span>
<a href="#l213.7"></a><span id="l213.7"> //  extensions.{GUID}.update.url</span>
<a href="#l213.8"></a><span id="l213.8"> //  extensions.{GUID}.update.interval</span>
<a href="#l213.9"></a><span id="l213.9"> //  .. etc ..</span>
<a href="#l213.10"></a><span id="l213.10"> //</span>
<a href="#l213.11"></a><span id="l213.11"> pref(&quot;extensions.update.enabled&quot;, true);</span>
<a href="#l213.12"></a><span id="l213.12" class="difflineminus">-pref(&quot;extensions.update.url&quot;, &quot;https://versioncheck.addons.mozilla.org/update/VersionCheck.php?reqVersion=%REQ_VERSION%&amp;id=%ITEM_ID%&amp;version=%ITEM_VERSION%&amp;maxAppVersion=%ITEM_MAXAPPVERSION%&amp;status=%ITEM_STATUS%&amp;appID=%APP_ID%&amp;appVersion=%APP_VERSION%&amp;appOS=%APP_OS%&amp;appABI=%APP_ABI%&amp;locale=%APP_LOCALE%&quot;);</span>
<a href="#l213.13"></a><span id="l213.13" class="difflineplus">+pref(&quot;extensions.update.url&quot;, &quot;https://versioncheck.addons.mozilla.org/update/VersionCheck.php?reqVersion=%REQ_VERSION%&amp;id=%ITEM_ID%&amp;version=%ITEM_VERSION%&amp;maxAppVersion=%ITEM_MAXAPPVERSION%&amp;status=%ITEM_STATUS%&amp;appID=%APP_ID%&amp;appVersion=%APP_VERSION%&amp;appOS=%APP_OS%&amp;appABI=%APP_ABI%&amp;locale=%APP_LOCALE%&amp;currentAppVersion=%CURRENT_APP_VERSION%&quot;);</span>
<a href="#l213.14"></a><span id="l213.14"> pref(&quot;extensions.update.interval&quot;, 86400);  // Check for updates to Extensions and </span>
<a href="#l213.15"></a><span id="l213.15">                                             // Themes every day</span>
<a href="#l213.16"></a><span id="l213.16"> </span>
<a href="#l213.17"></a><span id="l213.17"> // Preferences for the Get Add-ons pane</span>
<a href="#l213.18"></a><span id="l213.18"> pref(&quot;extensions.getAddons.showPane&quot;, true);</span>
<a href="#l213.19"></a><span id="l213.19"> pref(&quot;extensions.getAddons.browseAddons&quot;, &quot;https://addons.mozilla.org/%LOCALE%/%APP%&quot;);</span>
<a href="#l213.20"></a><span id="l213.20"> pref(&quot;extensions.getAddons.maxResults&quot;, 5);</span>
<a href="#l213.21"></a><span id="l213.21"> pref(&quot;extensions.getAddons.recommended.browseURL&quot;, &quot;https://addons.mozilla.org/%LOCALE%/%APP%/recommended&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l214.1"></a><span id="l214.1" class="difflineminus">--- a/suite/browser/navigator.js</span>
<a href="#l214.2"></a><span id="l214.2" class="difflineplus">+++ b/suite/browser/navigator.js</span>
<a href="#l214.3"></a><span id="l214.3" class="difflineat">@@ -1687,23 +1687,43 @@ function BrowserViewSourceOfURL(url, cha</span>
<a href="#l214.4"></a><span id="l214.4"> {</span>
<a href="#l214.5"></a><span id="l214.5">   // try to open a view-source window while inheriting the charset (if any)</span>
<a href="#l214.6"></a><span id="l214.6">   openDialog(&quot;chrome://navigator/content/viewSource.xul&quot;,</span>
<a href="#l214.7"></a><span id="l214.7">              &quot;_blank&quot;,</span>
<a href="#l214.8"></a><span id="l214.8">              &quot;all,dialog=no&quot;,</span>
<a href="#l214.9"></a><span id="l214.9">              url, charset, pageCookie);</span>
<a href="#l214.10"></a><span id="l214.10"> }</span>
<a href="#l214.11"></a><span id="l214.11"> </span>
<a href="#l214.12"></a><span id="l214.12" class="difflineminus">-// doc=null for regular page info, doc=owner document for frame info.</span>
<a href="#l214.13"></a><span id="l214.13" class="difflineplus">+// doc - document to use for source, or null for the current tab</span>
<a href="#l214.14"></a><span id="l214.14" class="difflineplus">+// initialTab - id of the initial tab to display, or null for the first tab</span>
<a href="#l214.15"></a><span id="l214.15"> function BrowserPageInfo(doc, initialTab)</span>
<a href="#l214.16"></a><span id="l214.16"> {</span>
<a href="#l214.17"></a><span id="l214.17" class="difflineplus">+  if (!doc)</span>
<a href="#l214.18"></a><span id="l214.18" class="difflineplus">+    doc = window.content.document;</span>
<a href="#l214.19"></a><span id="l214.19" class="difflineplus">+  var relatedUrl = doc.location.toString();</span>
<a href="#l214.20"></a><span id="l214.20" class="difflineplus">+  var args = {doc: doc, initialTab: initialTab};</span>
<a href="#l214.21"></a><span id="l214.21" class="difflineplus">+</span>
<a href="#l214.22"></a><span id="l214.22" class="difflineplus">+  var wm = Components.classes['@mozilla.org/appshell/window-mediator;1']</span>
<a href="#l214.23"></a><span id="l214.23" class="difflineplus">+                     .getService(Components.interfaces.nsIWindowMediator);</span>
<a href="#l214.24"></a><span id="l214.24" class="difflineplus">+  var enumerator = wm.getEnumerator(&quot;Browser:page-info&quot;);</span>
<a href="#l214.25"></a><span id="l214.25" class="difflineplus">+  // Check for windows matching the url</span>
<a href="#l214.26"></a><span id="l214.26" class="difflineplus">+  while (enumerator.hasMoreElements()) {</span>
<a href="#l214.27"></a><span id="l214.27" class="difflineplus">+    let win = enumerator.getNext();</span>
<a href="#l214.28"></a><span id="l214.28" class="difflineplus">+    if (win.document.documentElement</span>
<a href="#l214.29"></a><span id="l214.29" class="difflineplus">+           .getAttribute(&quot;relatedUrl&quot;) == relatedUrl) {</span>
<a href="#l214.30"></a><span id="l214.30" class="difflineplus">+      win.focus();</span>
<a href="#l214.31"></a><span id="l214.31" class="difflineplus">+      win.resetPageInfo(args);</span>
<a href="#l214.32"></a><span id="l214.32" class="difflineplus">+      return win;</span>
<a href="#l214.33"></a><span id="l214.33" class="difflineplus">+    }</span>
<a href="#l214.34"></a><span id="l214.34" class="difflineplus">+  }</span>
<a href="#l214.35"></a><span id="l214.35" class="difflineplus">+  // We didn't find a matching window, so open a new one.</span>
<a href="#l214.36"></a><span id="l214.36">   return window.openDialog(&quot;chrome://navigator/content/pageinfo/pageInfo.xul&quot;,</span>
<a href="#l214.37"></a><span id="l214.37">                            &quot;_blank&quot;,</span>
<a href="#l214.38"></a><span id="l214.38">                            &quot;chrome,dialog=no&quot;,</span>
<a href="#l214.39"></a><span id="l214.39" class="difflineminus">-                           {doc: doc, initialTab: initialTab});</span>
<a href="#l214.40"></a><span id="l214.40" class="difflineplus">+                           args);</span>
<a href="#l214.41"></a><span id="l214.41"> }</span>
<a href="#l214.42"></a><span id="l214.42"> </span>
<a href="#l214.43"></a><span id="l214.43"> function hiddenWindowStartup()</span>
<a href="#l214.44"></a><span id="l214.44"> {</span>
<a href="#l214.45"></a><span id="l214.45">   // focus the hidden window</span>
<a href="#l214.46"></a><span id="l214.46">   window.focus();</span>
<a href="#l214.47"></a><span id="l214.47"> </span>
<a href="#l214.48"></a><span id="l214.48">   // Disable menus which are not appropriate</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l215.1"></a><span id="l215.1" class="difflineminus">--- a/suite/browser/navigator.xul</span>
<a href="#l215.2"></a><span id="l215.2" class="difflineplus">+++ b/suite/browser/navigator.xul</span>
<a href="#l215.3"></a><span id="l215.3" class="difflineat">@@ -279,16 +279,18 @@</span>
<a href="#l215.4"></a><span id="l215.4">                            event.stopPropagation();</span>
<a href="#l215.5"></a><span id="l215.5">                            HandleBookmarkIcon(this.src, true);&quot;</span>
<a href="#l215.6"></a><span id="l215.6">                    onerror=&quot;gBrowser.addToMissedIconCache(this.src); HandleBookmarkIcon(this.src, false);&quot;</span>
<a href="#l215.7"></a><span id="l215.7">                    tooltiptext=&quot;&amp;proxyIcon.tooltip;&quot;/&gt;</span>
<a href="#l215.8"></a><span id="l215.8">           &lt;/deck&gt;</span>
<a href="#l215.9"></a><span id="l215.9">           &lt;hbox id=&quot;urlbar-icons&quot;</span>
<a href="#l215.10"></a><span id="l215.10">                 class=&quot;urlbar-icons&quot;&gt;</span>
<a href="#l215.11"></a><span id="l215.11">             &lt;image id=&quot;feedsButton&quot; hidden=&quot;true&quot; popup=&quot;feedsPopup&quot;/&gt;</span>
<a href="#l215.12"></a><span id="l215.12" class="difflineplus">+            &lt;image id=&quot;ev-button&quot; hidden=&quot;true&quot;</span>
<a href="#l215.13"></a><span id="l215.13" class="difflineplus">+                   onclick=&quot;if (event.button == 0) BrowserPageInfo(null, 'securityTab');&quot;/&gt;</span>
<a href="#l215.14"></a><span id="l215.14">           &lt;/hbox&gt;</span>
<a href="#l215.15"></a><span id="l215.15">           &lt;menupopup id=&quot;ubhist-popup&quot; class=&quot;autocomplete-history-popup&quot;</span>
<a href="#l215.16"></a><span id="l215.16">                      popupalign=&quot;topleft&quot; popupanchor=&quot;bottomleft&quot;</span>
<a href="#l215.17"></a><span id="l215.17">                      onpopupshowing=&quot;createUBHistoryMenu(event.target);&quot;</span>
<a href="#l215.18"></a><span id="l215.18">                      oncommand=&quot;executeUrlBarHistoryCommand(event.target);&quot;/&gt;</span>
<a href="#l215.19"></a><span id="l215.19">         &lt;/textbox&gt;</span>
<a href="#l215.20"></a><span id="l215.20"> </span>
<a href="#l215.21"></a><span id="l215.21">         &lt;button id=&quot;go-button&quot; class=&quot;button-toolbar chromeclass-location&quot;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l216.1"></a><span id="l216.1" class="difflineminus">--- a/suite/browser/nsBrowserStatusHandler.js</span>
<a href="#l216.2"></a><span id="l216.2" class="difflineplus">+++ b/suite/browser/nsBrowserStatusHandler.js</span>
<a href="#l216.3"></a><span id="l216.3" class="difflineat">@@ -69,16 +69,17 @@ nsBrowserStatusHandler.prototype =</span>
<a href="#l216.4"></a><span id="l216.4">     this.statusMeter     = document.getElementById(&quot;statusbar-icon&quot;);</span>
<a href="#l216.5"></a><span id="l216.5">     this.statusPanel     = document.getElementById(&quot;statusbar-progresspanel&quot;);</span>
<a href="#l216.6"></a><span id="l216.6">     this.stopButton      = document.getElementById(&quot;stop-button&quot;);</span>
<a href="#l216.7"></a><span id="l216.7">     this.stopMenu        = document.getElementById(&quot;menuitem-stop&quot;);</span>
<a href="#l216.8"></a><span id="l216.8">     this.stopContext     = document.getElementById(&quot;context-stop&quot;);</span>
<a href="#l216.9"></a><span id="l216.9">     this.statusTextField = document.getElementById(&quot;statusbar-display&quot;);</span>
<a href="#l216.10"></a><span id="l216.10">     this.isImage         = document.getElementById(&quot;isImage&quot;);</span>
<a href="#l216.11"></a><span id="l216.11">     this.securityButton  = document.getElementById(&quot;security-button&quot;);</span>
<a href="#l216.12"></a><span id="l216.12" class="difflineplus">+    this.evButton        = document.getElementById(&quot;ev-button&quot;);</span>
<a href="#l216.13"></a><span id="l216.13">     this.feedsMenu       = document.getElementById(&quot;feedsMenu&quot;);</span>
<a href="#l216.14"></a><span id="l216.14">     this.feedsButton     = document.getElementById(&quot;feedsButton&quot;);</span>
<a href="#l216.15"></a><span id="l216.15"> </span>
<a href="#l216.16"></a><span id="l216.16">     // Initialize the security button's state and tooltip text</span>
<a href="#l216.17"></a><span id="l216.17">     const nsIWebProgressListener = Components.interfaces.nsIWebProgressListener;</span>
<a href="#l216.18"></a><span id="l216.18">     this.onSecurityChange(null, null, nsIWebProgressListener.STATE_IS_INSECURE);</span>
<a href="#l216.19"></a><span id="l216.19">   },</span>
<a href="#l216.20"></a><span id="l216.20"> </span>
<a href="#l216.21"></a><span id="l216.21" class="difflineat">@@ -90,16 +91,17 @@ nsBrowserStatusHandler.prototype =</span>
<a href="#l216.22"></a><span id="l216.22">     this.statusMeter     = null;</span>
<a href="#l216.23"></a><span id="l216.23">     this.statusPanel     = null;</span>
<a href="#l216.24"></a><span id="l216.24">     this.stopButton      = null;</span>
<a href="#l216.25"></a><span id="l216.25">     this.stopMenu        = null;</span>
<a href="#l216.26"></a><span id="l216.26">     this.stopContext     = null;</span>
<a href="#l216.27"></a><span id="l216.27">     this.statusTextField = null;</span>
<a href="#l216.28"></a><span id="l216.28">     this.isImage         = null;</span>
<a href="#l216.29"></a><span id="l216.29">     this.securityButton  = null;</span>
<a href="#l216.30"></a><span id="l216.30" class="difflineplus">+    this.evButton        = null;</span>
<a href="#l216.31"></a><span id="l216.31">     this.feedsButton     = null;</span>
<a href="#l216.32"></a><span id="l216.32">     this.feedsMenu       = null;</span>
<a href="#l216.33"></a><span id="l216.33">   },</span>
<a href="#l216.34"></a><span id="l216.34"> </span>
<a href="#l216.35"></a><span id="l216.35">   setJSStatus : function(status)</span>
<a href="#l216.36"></a><span id="l216.36">   {</span>
<a href="#l216.37"></a><span id="l216.37">     this.jsStatus = status;</span>
<a href="#l216.38"></a><span id="l216.38">     this.updateStatusField();</span>
<a href="#l216.39"></a><span id="l216.39" class="difflineat">@@ -390,24 +392,29 @@ nsBrowserStatusHandler.prototype =</span>
<a href="#l216.40"></a><span id="l216.40">     }</span>
<a href="#l216.41"></a><span id="l216.41"> </span>
<a href="#l216.42"></a><span id="l216.42">     var securityUI = getBrowser().securityUI;</span>
<a href="#l216.43"></a><span id="l216.43">     if (securityUI)</span>
<a href="#l216.44"></a><span id="l216.44">       this.securityButton.setAttribute(&quot;tooltiptext&quot;, securityUI.tooltipText);</span>
<a href="#l216.45"></a><span id="l216.45">     else</span>
<a href="#l216.46"></a><span id="l216.46">       this.securityButton.removeAttribute(&quot;tooltiptext&quot;);</span>
<a href="#l216.47"></a><span id="l216.47"> </span>
<a href="#l216.48"></a><span id="l216.48" class="difflineminus">-    if (aState &amp; wpl.STATE_IDENTITY_EV_TOPLEVEL)</span>
<a href="#l216.49"></a><span id="l216.49" class="difflineminus">-      this.securityButton.setAttribute(&quot;label&quot;,</span>
<a href="#l216.50"></a><span id="l216.50" class="difflineplus">+    if (aState &amp; wpl.STATE_IDENTITY_EV_TOPLEVEL) {</span>
<a href="#l216.51"></a><span id="l216.51" class="difflineplus">+      var organization =</span>
<a href="#l216.52"></a><span id="l216.52">           securityUI.QueryInterface(Components.interfaces.nsISSLStatusProvider)</span>
<a href="#l216.53"></a><span id="l216.53">                     .SSLStatus</span>
<a href="#l216.54"></a><span id="l216.54">                     .QueryInterface(Components.interfaces.nsISSLStatus)</span>
<a href="#l216.55"></a><span id="l216.55" class="difflineminus">-                    .serverCert.organization);</span>
<a href="#l216.56"></a><span id="l216.56" class="difflineminus">-    else</span>
<a href="#l216.57"></a><span id="l216.57" class="difflineplus">+                    .serverCert.organization;</span>
<a href="#l216.58"></a><span id="l216.58" class="difflineplus">+      this.securityButton.setAttribute(&quot;label&quot;, organization);</span>
<a href="#l216.59"></a><span id="l216.59" class="difflineplus">+      this.evButton.setAttribute(&quot;tooltiptext&quot;, organization);</span>
<a href="#l216.60"></a><span id="l216.60" class="difflineplus">+      this.evButton.hidden = false;</span>
<a href="#l216.61"></a><span id="l216.61" class="difflineplus">+    } else {</span>
<a href="#l216.62"></a><span id="l216.62">       this.securityButton.removeAttribute(&quot;label&quot;);</span>
<a href="#l216.63"></a><span id="l216.63" class="difflineplus">+      this.evButton.hidden = true;</span>
<a href="#l216.64"></a><span id="l216.64" class="difflineplus">+    }</span>
<a href="#l216.65"></a><span id="l216.65">   },</span>
<a href="#l216.66"></a><span id="l216.66"> </span>
<a href="#l216.67"></a><span id="l216.67">   startDocumentLoad : function(aRequest)</span>
<a href="#l216.68"></a><span id="l216.68">   {</span>
<a href="#l216.69"></a><span id="l216.69">     var uri = aRequest.QueryInterface(Components.interfaces.nsIChannel).URI;</span>
<a href="#l216.70"></a><span id="l216.70">     var observerService = Components.classes[&quot;@mozilla.org/observer-service;1&quot;]</span>
<a href="#l216.71"></a><span id="l216.71">                                     .getService(Components.interfaces.nsIObserverService);</span>
<a href="#l216.72"></a><span id="l216.72"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l217.1"></a><span id="l217.1" class="difflineminus">--- a/suite/common/nsContextMenu.js</span>
<a href="#l217.2"></a><span id="l217.2" class="difflineplus">+++ b/suite/common/nsContextMenu.js</span>
<a href="#l217.3"></a><span id="l217.3" class="difflineat">@@ -1157,24 +1157,28 @@ nsContextMenu.prototype = {</span>
<a href="#l217.4"></a><span id="l217.4">           case &quot;hidecontrols&quot;:</span>
<a href="#l217.5"></a><span id="l217.5">             media.removeAttribute(&quot;controls&quot;);</span>
<a href="#l217.6"></a><span id="l217.6">             break;</span>
<a href="#l217.7"></a><span id="l217.7">           case &quot;showcontrols&quot;:</span>
<a href="#l217.8"></a><span id="l217.8">             media.setAttribute(&quot;controls&quot;, &quot;true&quot;);</span>
<a href="#l217.9"></a><span id="l217.9">             break;</span>
<a href="#l217.10"></a><span id="l217.10">         }</span>
<a href="#l217.11"></a><span id="l217.11">     },</span>
<a href="#l217.12"></a><span id="l217.12" class="difflineminus">-</span>
<a href="#l217.13"></a><span id="l217.13">     copyMediaLocation : function () {</span>
<a href="#l217.14"></a><span id="l217.14">         var clipboard = Components.classes[&quot;@mozilla.org/widget/clipboardhelper;1&quot;]</span>
<a href="#l217.15"></a><span id="l217.15">                         .getService(Components.interfaces.nsIClipboardHelper);</span>
<a href="#l217.16"></a><span id="l217.16">         clipboard.copyString(this.mediaURL);</span>
<a href="#l217.17"></a><span id="l217.17" class="difflineplus">+    },</span>
<a href="#l217.18"></a><span id="l217.18" class="difflineplus">+</span>
<a href="#l217.19"></a><span id="l217.19" class="difflineplus">+    get imageURL() {</span>
<a href="#l217.20"></a><span id="l217.20" class="difflineplus">+        if (this.onImage)</span>
<a href="#l217.21"></a><span id="l217.21" class="difflineplus">+            return this.mediaURL;</span>
<a href="#l217.22"></a><span id="l217.22" class="difflineplus">+        return &quot;&quot;;</span>
<a href="#l217.23"></a><span id="l217.23">     }</span>
<a href="#l217.24"></a><span id="l217.24"> };</span>
<a href="#l217.25"></a><span id="l217.25" class="difflineminus">-</span>
<a href="#l217.26"></a><span id="l217.26"> /*************************************************************************</span>
<a href="#l217.27"></a><span id="l217.27">  *</span>
<a href="#l217.28"></a><span id="l217.28">  *   nsDefaultEngine : nsIObserver</span>
<a href="#l217.29"></a><span id="l217.29">  *</span>
<a href="#l217.30"></a><span id="l217.30">  *************************************************************************/</span>
<a href="#l217.31"></a><span id="l217.31"> function nsDefaultEngine()</span>
<a href="#l217.32"></a><span id="l217.32"> {</span>
<a href="#l217.33"></a><span id="l217.33">     try</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l218.1"></a><span id="l218.1" class="difflineminus">--- a/suite/debugQA/content/debugQAMenuOverlay.xul</span>
<a href="#l218.2"></a><span id="l218.2" class="difflineplus">+++ b/suite/debugQA/content/debugQAMenuOverlay.xul</span>
<a href="#l218.3"></a><span id="l218.3" class="difflineat">@@ -211,19 +211,19 @@</span>
<a href="#l218.4"></a><span id="l218.4">         &lt;menuitem label=&quot;File a Bug&quot;</span>
<a href="#l218.5"></a><span id="l218.5">                   oncommand=&quot;openTopWin('https://bugzilla.mozilla.org/enter_bug.cgi?format=guided');&quot;/&gt;</span>
<a href="#l218.6"></a><span id="l218.6"> </span>
<a href="#l218.7"></a><span id="l218.7">         &lt;menuseparator/&gt;</span>
<a href="#l218.8"></a><span id="l218.8"> </span>
<a href="#l218.9"></a><span id="l218.9">         &lt;menuitem label=&quot;Bugs Filed Today&quot;</span>
<a href="#l218.10"></a><span id="l218.10">                   oncommand=&quot;openTopWin('https://bugzilla.mozilla.org/buglist.cgi?product=Core&amp;amp;product=MailNews+Core&amp;amp;product=SeaMonkey&amp;amp;chfieldfrom=0d&amp;amp;chfieldto=Now&amp;amp;chfield=%5BBug+creation%5D');&quot;/&gt;</span>
<a href="#l218.11"></a><span id="l218.11">         &lt;menuitem label=&quot;Recent comm-central Checkins&quot;</span>
<a href="#l218.12"></a><span id="l218.12" class="difflineminus">-                  oncommand=&quot;openTopWin('http://hg.mozilla.org/comm-central/index.cgi/pushloghtml?startdate=24+hours+ago&amp;amp;enddate=now');&quot;/&gt;</span>
<a href="#l218.13"></a><span id="l218.13" class="difflineplus">+                  oncommand=&quot;openTopWin('http://hg.mozilla.org/comm-central/pushloghtml?startdate=24+hours+ago&amp;amp;enddate=now');&quot;/&gt;</span>
<a href="#l218.14"></a><span id="l218.14">         &lt;menuitem label=&quot;Recent mozilla-central Checkins&quot;</span>
<a href="#l218.15"></a><span id="l218.15" class="difflineminus">-                  oncommand=&quot;openTopWin('http://hg.mozilla.org/mozilla-central/index.cgi/pushloghtml?startdate=24+hours+ago&amp;amp;enddate=now');&quot;/&gt;</span>
<a href="#l218.16"></a><span id="l218.16" class="difflineplus">+                  oncommand=&quot;openTopWin('http://hg.mozilla.org/mozilla-central/pushloghtml?startdate=24+hours+ago&amp;amp;enddate=now');&quot;/&gt;</span>
<a href="#l218.17"></a><span id="l218.17">         &lt;menuitem label=&quot;Tree Status&quot;</span>
<a href="#l218.18"></a><span id="l218.18">                   oncommand=&quot;openTopWin('http://tinderbox.mozilla.org/showbuilds.cgi?tree=SeaMonkey');&quot;/&gt;</span>
<a href="#l218.19"></a><span id="l218.19"> </span>
<a href="#l218.20"></a><span id="l218.20">         &lt;menuseparator/&gt;</span>
<a href="#l218.21"></a><span id="l218.21"> </span>
<a href="#l218.22"></a><span id="l218.22">         &lt;menuitem label=&quot;Smoke Tests&quot;</span>
<a href="#l218.23"></a><span id="l218.23">                   oncommand=&quot;openTopWin('http://www.mozilla.org/quality/smoketests/');&quot;/&gt;</span>
<a href="#l218.24"></a><span id="l218.24">         &lt;menuitem label=&quot;Pre-Checkin Tests&quot;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l219.1"></a><span id="l219.1" class="difflineminus">--- a/suite/locales/en-US/chrome/common/help/cs_nav_prefs_navigator.xhtml</span>
<a href="#l219.2"></a><span id="l219.2" class="difflineplus">+++ b/suite/locales/en-US/chrome/common/help/cs_nav_prefs_navigator.xhtml</span>
<a href="#l219.3"></a><span id="l219.3" class="difflineat">@@ -131,31 +131,45 @@</span>
<a href="#l219.4"></a><span id="l219.4"> </span>
<a href="#l219.5"></a><span id="l219.5"> &lt;ol&gt;</span>
<a href="#l219.6"></a><span id="l219.6">   &lt;li&gt;Open the &lt;span class=&quot;mac&quot;&gt;&amp;brandShortName;&lt;/span&gt;</span>
<a href="#l219.7"></a><span id="l219.7">     &lt;span class=&quot;noMac&quot;&gt;Edit&lt;/span&gt;menu and choose Preferences.&lt;/li&gt;</span>
<a href="#l219.8"></a><span id="l219.8">   &lt;li&gt;Under the Browser category, click History. (If no subcategories are</span>
<a href="#l219.9"></a><span id="l219.9">     visible, double-click Browser to expand the list.)&lt;/li&gt;</span>
<a href="#l219.10"></a><span id="l219.10"> &lt;/ol&gt;</span>
<a href="#l219.11"></a><span id="l219.11"> </span>
<a href="#l219.12"></a><span id="l219.12" class="difflineminus">-&lt;p&gt;The History preferences panel allows you to configure three history settings</span>
<a href="#l219.13"></a><span id="l219.13" class="difflineplus">+&lt;p&gt;The History preferences panel allows you to configure the history settings</span>
<a href="#l219.14"></a><span id="l219.14">   for the browser.&lt;/p&gt;</span>
<a href="#l219.15"></a><span id="l219.15"> </span>
<a href="#l219.16"></a><span id="l219.16"> &lt;ul&gt;</span>
<a href="#l219.17"></a><span id="l219.17">   &lt;li&gt;&lt;strong&gt;Browsing History&lt;/strong&gt;:</span>
<a href="#l219.18"></a><span id="l219.18">     &lt;ul&gt;</span>
<a href="#l219.19"></a><span id="l219.19" class="difflineminus">-      &lt;li&gt;&lt;strong&gt;Remember visited pages for the last [__] days&lt;/strong&gt;: Type</span>
<a href="#l219.20"></a><span id="l219.20" class="difflineminus">-        the number of days you want &amp;brandShortName; to keep track of the web</span>
<a href="#l219.21"></a><span id="l219.21" class="difflineminus">-        pages you have previously visited. For example, if you set this number</span>
<a href="#l219.22"></a><span id="l219.22" class="difflineminus">-        to 10 days, pages 10 days old or less will be kept in the history</span>
<a href="#l219.23"></a><span id="l219.23" class="difflineminus">-        list.&lt;/li&gt;</span>
<a href="#l219.24"></a><span id="l219.24" class="difflineplus">+      &lt;li&gt;&lt;strong&gt;Clear History&lt;/strong&gt;: Click this to delete the list of</span>
<a href="#l219.25"></a><span id="l219.25" class="difflineplus">+        sites visited.&lt;/li&gt;</span>
<a href="#l219.26"></a><span id="l219.26" class="difflineplus">+      &lt;li&gt;&lt;strong&gt;Always remember visited pages for at least [__]</span>
<a href="#l219.27"></a><span id="l219.27" class="difflineplus">+        days&lt;/strong&gt;: Type the minimum number of days for which</span>
<a href="#l219.28"></a><span id="l219.28" class="difflineplus">+        &amp;brandShortName; should remember pages you have previously visited.</span>
<a href="#l219.29"></a><span id="l219.29" class="difflineplus">+        Unless you manually delete entries from the history, &amp;brandShortName;</span>
<a href="#l219.30"></a><span id="l219.30" class="difflineplus">+        will always remember visited pages for at least as many days as you</span>
<a href="#l219.31"></a><span id="l219.31" class="difflineplus">+        specify here, no matter what the other Browsing History preferences</span>
<a href="#l219.32"></a><span id="l219.32" class="difflineplus">+        say. After that time, &amp;brandShortName; may delete entries from the</span>
<a href="#l219.33"></a><span id="l219.33" class="difflineplus">+        history, depending on the next two preferences.&lt;/li&gt;</span>
<a href="#l219.34"></a><span id="l219.34" class="difflineplus">+      &lt;li&gt;&lt;strong&gt;Remember visited pages for up to [__] days&lt;/strong&gt;: Type the</span>
<a href="#l219.35"></a><span id="l219.35" class="difflineplus">+        maximum number of days you want &amp;brandShortName; to keep track of the</span>
<a href="#l219.36"></a><span id="l219.36" class="difflineplus">+        web pages you have previously visited. For example, if you set this</span>
<a href="#l219.37"></a><span id="l219.37" class="difflineplus">+        number to 180 days, pages 180 days old or less will be kept in the</span>
<a href="#l219.38"></a><span id="l219.38" class="difflineplus">+        history list unless you manually delete them from the history or the</span>
<a href="#l219.39"></a><span id="l219.39" class="difflineplus">+        maximum number of visited pages (see next point) has been reached.&lt;/li&gt;</span>
<a href="#l219.40"></a><span id="l219.40" class="difflineplus">+      &lt;li&gt;&lt;strong&gt;Remember up to [__] visited pages&lt;/strong&gt;: Type the maximum</span>
<a href="#l219.41"></a><span id="l219.41" class="difflineplus">+        number of visited pages &amp;brandShortName; should remember. When the</span>
<a href="#l219.42"></a><span id="l219.42" class="difflineplus">+        actual number of visited pages exceeds the number specified here,</span>
<a href="#l219.43"></a><span id="l219.43" class="difflineplus">+        &amp;brandShortName; will delete as many of the oldest history entries as</span>
<a href="#l219.44"></a><span id="l219.44" class="difflineplus">+        needed to get down to that number again.&lt;/li&gt;</span>
<a href="#l219.45"></a><span id="l219.45">     &lt;/ul&gt;</span>
<a href="#l219.46"></a><span id="l219.46">   &lt;/li&gt;</span>
<a href="#l219.47"></a><span id="l219.47" class="difflineminus">-  &lt;li&gt;&lt;strong&gt;Clear History&lt;/strong&gt;: Click this to delete the list of sites</span>
<a href="#l219.48"></a><span id="l219.48" class="difflineminus">-    visited.&lt;/li&gt;</span>
<a href="#l219.49"></a><span id="l219.49">   &lt;li&gt;&lt;strong&gt;Location Bar History&lt;/strong&gt;:</span>
<a href="#l219.50"></a><span id="l219.50">     &lt;ul&gt;</span>
<a href="#l219.51"></a><span id="l219.51">       &lt;li&gt;&lt;strong&gt;Clear Location Bar&lt;/strong&gt;: Click this to clear the list of</span>
<a href="#l219.52"></a><span id="l219.52">         sites in the Location bar menu.&lt;/li&gt;</span>
<a href="#l219.53"></a><span id="l219.53">     &lt;/ul&gt;</span>
<a href="#l219.54"></a><span id="l219.54">   &lt;/li&gt;</span>
<a href="#l219.55"></a><span id="l219.55"> &lt;/ul&gt;</span>
<a href="#l219.56"></a><span id="l219.56"> </span>
<a href="#l219.57"></a><span id="l219.57" class="difflineat">@@ -288,20 +302,47 @@</span>
<a href="#l219.58"></a><span id="l219.58"> </span>
<a href="#l219.59"></a><span id="l219.59"> &lt;ul&gt;</span>
<a href="#l219.60"></a><span id="l219.60">   &lt;li id=&quot;location_bar_autocomplete&quot;&gt;&lt;strong&gt;Autocomplete&lt;/strong&gt;:</span>
<a href="#l219.61"></a><span id="l219.61">     &lt;ul&gt;</span>
<a href="#l219.62"></a><span id="l219.62">       &lt;li&gt;&lt;strong&gt;Autocomplete from your browsing history as you type&lt;/strong&gt;:</span>
<a href="#l219.63"></a><span id="l219.63">         Select this to let &amp;brandShortName; automatically show suggestions from</span>
<a href="#l219.64"></a><span id="l219.64">         your browsing history when you type in the Location Bar.</span>
<a href="#l219.65"></a><span id="l219.65">         &lt;ul&gt;</span>
<a href="#l219.66"></a><span id="l219.66" class="difflineminus">-          &lt;li&gt;&lt;strong&gt;Match only website&amp;apos;s you&amp;apos;ve typed</span>
<a href="#l219.67"></a><span id="l219.67" class="difflineminus">-            previously&lt;/strong&gt;: Shows only websites that you&amp;apos;ve typed in</span>
<a href="#l219.68"></a><span id="l219.68" class="difflineminus">-            the Location Bar and not sites that were opened in other ways, such</span>
<a href="#l219.69"></a><span id="l219.69" class="difflineminus">-            as clicking a link on a web page.&lt;/li&gt;</span>
<a href="#l219.70"></a><span id="l219.70" class="difflineplus">+          &lt;li&gt;&lt;strong&gt;Match only websites you&amp;apos;ve typed previously&lt;/strong&gt;:</span>
<a href="#l219.71"></a><span id="l219.71" class="difflineplus">+            Shows only websites that you&amp;apos;ve typed in the Location Bar and</span>
<a href="#l219.72"></a><span id="l219.72" class="difflineplus">+            not sites that were opened in other ways, such as clicking a link on</span>
<a href="#l219.73"></a><span id="l219.73" class="difflineplus">+            a web page.&lt;/li&gt;</span>
<a href="#l219.74"></a><span id="l219.74" class="difflineplus">+          &lt;li&gt;&lt;strong&gt;Only match locations, not website titles&lt;/strong&gt;: Shows</span>
<a href="#l219.75"></a><span id="l219.75" class="difflineplus">+            only websites where the location matches what you typed. Websites</span>
<a href="#l219.76"></a><span id="l219.76" class="difflineplus">+            where the title matches what you typed will not show up as</span>
<a href="#l219.77"></a><span id="l219.77" class="difflineplus">+            autocomplete suggestions unless their location matches, too.&lt;/li&gt;</span>
<a href="#l219.78"></a><span id="l219.78" class="difflineplus">+          &lt;li&gt;&lt;strong&gt;Match&lt;/strong&gt;:</span>
<a href="#l219.79"></a><span id="l219.79" class="difflineplus">+            &lt;ul&gt;</span>
<a href="#l219.80"></a><span id="l219.80" class="difflineplus">+              &lt;li&gt;&lt;strong&gt;Anywhere in the location or title&lt;/strong&gt;: The</span>
<a href="#l219.81"></a><span id="l219.81" class="difflineplus">+                autocomplete suggestions will include all websites where what</span>
<a href="#l219.82"></a><span id="l219.82" class="difflineplus">+                you typed matches any part of the website&amp;apos;s location or</span>
<a href="#l219.83"></a><span id="l219.83" class="difflineplus">+                title.&lt;/li&gt;</span>
<a href="#l219.84"></a><span id="l219.84" class="difflineplus">+              &lt;li&gt;&lt;strong&gt;Anywhere but preferring word boundaries&lt;/strong&gt;: The</span>
<a href="#l219.85"></a><span id="l219.85" class="difflineplus">+                autocomplete suggestions will include all websites where what</span>
<a href="#l219.86"></a><span id="l219.86" class="difflineplus">+                you typed matches any part of the website&amp;apos;s location or</span>
<a href="#l219.87"></a><span id="l219.87" class="difflineplus">+                title but matches at word boundaries (see next point) are</span>
<a href="#l219.88"></a><span id="l219.88" class="difflineplus">+                preferred. This is the default setting.&lt;/li&gt;</span>
<a href="#l219.89"></a><span id="l219.89" class="difflineplus">+              &lt;li&gt;&lt;strong&gt;Only on word boundaries&lt;/strong&gt;: The autocomplete</span>
<a href="#l219.90"></a><span id="l219.90" class="difflineplus">+                suggestions will include all websites where what you typed</span>
<a href="#l219.91"></a><span id="l219.91" class="difflineplus">+                matches the beginning of any word contained in the</span>
<a href="#l219.92"></a><span id="l219.92" class="difflineplus">+                website&amp;apos;s location or title. Matches may also be found</span>
<a href="#l219.93"></a><span id="l219.93" class="difflineplus">+                inside a word if it contains medial capital letters (as in</span>
<a href="#l219.94"></a><span id="l219.94" class="difflineplus">+                CamelCase) since all non-lowercase characters are treated as</span>
<a href="#l219.95"></a><span id="l219.95" class="difflineplus">+                word boundaries.&lt;/li&gt;</span>
<a href="#l219.96"></a><span id="l219.96" class="difflineplus">+              &lt;li&gt;&lt;strong&gt;Only at the beginning of the location or</span>
<a href="#l219.97"></a><span id="l219.97" class="difflineplus">+                title&lt;/strong&gt;: The autocomplete suggestions will include all</span>
<a href="#l219.98"></a><span id="l219.98" class="difflineplus">+                websites where what you typed matches the beginning of the</span>
<a href="#l219.99"></a><span id="l219.99" class="difflineplus">+                website&amp;apos;s location or title.&lt;/li&gt;</span>
<a href="#l219.100"></a><span id="l219.100" class="difflineplus">+            &lt;/ul&gt;&lt;/li&gt;</span>
<a href="#l219.101"></a><span id="l219.101">           &lt;li&gt;&lt;strong&gt;Automatically prefill the best match&lt;/strong&gt;: As you</span>
<a href="#l219.102"></a><span id="l219.102">             type in the Location Bar, &amp;brandShortName; will automatically</span>
<a href="#l219.103"></a><span id="l219.103">             complete your web address using the visited website it most closely</span>
<a href="#l219.104"></a><span id="l219.104">             matches. &lt;span class=&quot;unix&quot;&gt;&lt;strong&gt;Note&lt;/strong&gt;: Having this</span>
<a href="#l219.105"></a><span id="l219.105">             option on will prefill local addresses (like paths to files on your</span>
<a href="#l219.106"></a><span id="l219.106">             hard drive) even if you have turned off &lt;q&gt;Autocomplete from your</span>
<a href="#l219.107"></a><span id="l219.107">             browsing history as you type&lt;/q&gt;.&lt;/span&gt;&lt;/li&gt;</span>
<a href="#l219.108"></a><span id="l219.108">           &lt;li&gt;&lt;strong&gt;Show list of matching results&lt;/strong&gt;: As you type in</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l220.1"></a><span id="l220.1" class="difflineminus">--- a/suite/locales/en-US/chrome/common/help/mail_help.xhtml</span>
<a href="#l220.2"></a><span id="l220.2" class="difflineplus">+++ b/suite/locales/en-US/chrome/common/help/mail_help.xhtml</span>
<a href="#l220.3"></a><span id="l220.3" class="difflineat">@@ -4103,36 +4103,35 @@ to filter unwanted mail, and how phishin</span>
<a href="#l220.4"></a><span id="l220.4"> </span>
<a href="#l220.5"></a><span id="l220.5"> &lt;p&gt;&amp;brandShortName; can automatically delete old messages for you. You</span>
<a href="#l220.6"></a><span id="l220.6">   can configure this process with the options listed below</span>
<a href="#l220.7"></a><span id="l220.7">   &lt;strong&gt;To recover disk space, old messages can be permanently</span>
<a href="#l220.8"></a><span id="l220.8">   deleted&lt;/strong&gt;:&lt;/p&gt;</span>
<a href="#l220.9"></a><span id="l220.9"> </span>
<a href="#l220.10"></a><span id="l220.10"> &lt;ul&gt;</span>
<a href="#l220.11"></a><span id="l220.11">   &lt;li&gt;&lt;strong&gt;Don't delete any messages&lt;/strong&gt;: Keep all messages. Never</span>
<a href="#l220.12"></a><span id="l220.12" class="difflineminus">-    delete messages automatically.&lt;/li&gt;</span>
<a href="#l220.13"></a><span id="l220.13" class="difflineminus">-  &lt;li&gt;&lt;strong&gt;Delete all but the last [__] messages&lt;/strong&gt;: Enter the number</span>
<a href="#l220.14"></a><span id="l220.14" class="difflineminus">-    of messages to keep. With this setting only messages older than these</span>
<a href="#l220.15"></a><span id="l220.15" class="difflineplus">+    delete messages automatically based on their age.&lt;/li&gt;</span>
<a href="#l220.16"></a><span id="l220.16" class="difflineplus">+  &lt;li&gt;&lt;strong&gt;Delete all but the most recent [__] messages&lt;/strong&gt;: Enter the</span>
<a href="#l220.17"></a><span id="l220.17" class="difflineplus">+    number of messages to keep. With this setting only messages older than these</span>
<a href="#l220.18"></a><span id="l220.18">     messages are deleted.&lt;/li&gt;</span>
<a href="#l220.19"></a><span id="l220.19">   &lt;li&gt;&lt;strong&gt;Delete messages more than [__] days old &lt;/strong&gt;:</span>
<a href="#l220.20"></a><span id="l220.20">     Keep all messages that arrived within the given number of days.&lt;/li&gt;</span>
<a href="#l220.21"></a><span id="l220.21"> &lt;/ul&gt;</span>
<a href="#l220.22"></a><span id="l220.22"> </span>
<a href="#l220.23"></a><span id="l220.23"> &lt;p&gt;With the following settings you can further constrain the three options to</span>
<a href="#l220.24"></a><span id="l220.24">   delete messages automatically. This is especially useful in combination with</span>
<a href="#l220.25"></a><span id="l220.25">   the option to keep all messages.&lt;/p&gt; </span>
<a href="#l220.26"></a><span id="l220.26"> </span>
<a href="#l220.27"></a><span id="l220.27"> &lt;ul&gt;</span>
<a href="#l220.28"></a><span id="l220.28" class="difflineminus">-  &lt;li&gt;&lt;strong&gt;Always delete read messages&lt;/strong&gt;: Select this option to</span>
<a href="#l220.29"></a><span id="l220.29" class="difflineminus">-    remove read messages.&lt;/li&gt;</span>
<a href="#l220.30"></a><span id="l220.30">   &lt;li&gt;&lt;strong&gt;Always keep flagged messages&lt;/strong&gt;: Use this option to deny</span>
<a href="#l220.31"></a><span id="l220.31">     &amp;brandShortName; to delete any messages you have flagged.&lt;/li&gt;</span>
<a href="#l220.32"></a><span id="l220.32" class="difflineminus">-  &lt;li&gt;&lt;strong&gt;Only message bodies less than [__] days old&lt;/strong&gt;: Select this</span>
<a href="#l220.33"></a><span id="l220.33" class="difflineminus">-    option to deny &amp;brandShortName; the deletion of messages that are newer</span>
<a href="#l220.34"></a><span id="l220.34" class="difflineminus">-    than the number of days you specify here (news accounts only).&lt;/li&gt;</span>
<a href="#l220.35"></a><span id="l220.35" class="difflineplus">+  &lt;li&gt;&lt;strong&gt;Remove bodies from message more than [__] days old&lt;/strong&gt;:</span>
<a href="#l220.36"></a><span id="l220.36" class="difflineplus">+    Select this option to retain all headers but to delete message bodies that</span>
<a href="#l220.37"></a><span id="l220.37" class="difflineplus">+    are older than the number of days you specify here (news accounts only).</span>
<a href="#l220.38"></a><span id="l220.38" class="difflineplus">+    Any option to delete the entire message based on age still applies.&lt;/li&gt;</span>
<a href="#l220.39"></a><span id="l220.39"> &lt;/ul&gt;</span>
<a href="#l220.40"></a><span id="l220.40"> </span>
<a href="#l220.41"></a><span id="l220.41"> &lt;p&gt;This policy can be overridden for an individual folder in the Folder</span>
<a href="#l220.42"></a><span id="l220.42">   Properties, Retention Policy tab.&lt;/p&gt;</span>
<a href="#l220.43"></a><span id="l220.43"> </span>
<a href="#l220.44"></a><span id="l220.44"> &lt;p&gt;&lt;strong&gt;Note:&lt;/strong&gt; If message synchronization is enabled (for IMAP), or</span>
<a href="#l220.45"></a><span id="l220.45">   messages are left on the server for POP accounts), the settings apply to</span>
<a href="#l220.46"></a><span id="l220.46">   &lt;em&gt;both&lt;/em&gt; local copies and their originals on the server.&lt;/p&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l221.1"></a><span id="l221.1" class="difflineminus">--- a/suite/locales/en-US/chrome/common/help/nav_help.xhtml</span>
<a href="#l221.2"></a><span id="l221.2" class="difflineplus">+++ b/suite/locales/en-US/chrome/common/help/nav_help.xhtml</span>
<a href="#l221.3"></a><span id="l221.3" class="difflineat">@@ -218,19 +218,19 @@</span>
<a href="#l221.4"></a><span id="l221.4">     &lt;span class=&quot;mac&quot;&gt;&amp;brandShortName;&lt;/span&gt;&lt;span class=&quot;noMac&quot;&gt;Edit&lt;/span&gt;</span>
<a href="#l221.5"></a><span id="l221.5">     menu and choose Preferences.&lt;/li&gt;</span>
<a href="#l221.6"></a><span id="l221.6">   &lt;li&gt;Under the Browser category, click History. (If no subcategories are</span>
<a href="#l221.7"></a><span id="l221.7">     visible, double-click Browser to expand the list.)&lt;/li&gt;</span>
<a href="#l221.8"></a><span id="l221.8">   &lt;li&gt;Click Clear History and Clear Location Bar to remove all previously</span>
<a href="#l221.9"></a><span id="l221.9">     visited web pages from the lists.&lt;/li&gt;</span>
<a href="#l221.10"></a><span id="l221.10"> &lt;/ol&gt;</span>
<a href="#l221.11"></a><span id="l221.11"> </span>
<a href="#l221.12"></a><span id="l221.12" class="difflineminus">-&lt;p&gt;&lt;strong&gt;Tip&lt;/strong&gt;: In &lt;q&gt;Remember visited pages for the last [__]</span>
<a href="#l221.13"></a><span id="l221.13" class="difflineminus">-  days&lt;/q&gt;, you can set the number of days pages will remain in the history</span>
<a href="#l221.14"></a><span id="l221.14" class="difflineminus">-  list.&lt;/p&gt;</span>
<a href="#l221.15"></a><span id="l221.15" class="difflineplus">+&lt;p&gt;&lt;strong&gt;Tip&lt;/strong&gt;: Use the preferences under &lt;a</span>
<a href="#l221.16"></a><span id="l221.16" class="difflineplus">+  href=&quot;cs_nav_prefs_navigator.xhtml#history&quot;&gt;Browsing History&lt;/a&gt; to set</span>
<a href="#l221.17"></a><span id="l221.17" class="difflineplus">+  how long and how many pages will remain in the history list.&lt;/p&gt;</span>
<a href="#l221.18"></a><span id="l221.18"> </span>
<a href="#l221.19"></a><span id="l221.19"> &lt;p&gt;To selectively delete pages from the history list, do any of the</span>
<a href="#l221.20"></a><span id="l221.20">   following:&lt;/p&gt;</span>
<a href="#l221.21"></a><span id="l221.21"> </span>
<a href="#l221.22"></a><span id="l221.22"> &lt;ul&gt;</span>
<a href="#l221.23"></a><span id="l221.23">   &lt;li&gt;To delete all pages from a domain, select a page within that domain</span>
<a href="#l221.24"></a><span id="l221.24">     (folder) in the History list, open the Edit menu, and select &lt;q&gt;Delete</span>
<a href="#l221.25"></a><span id="l221.25">     entire domain &lt;em&gt;*.[domain name]&lt;/em&gt;&lt;/q&gt;. For example, use this command</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l222.1"></a><span id="l222.1">deleted file mode 100644</span>
<a href="#l222.2"></a><span id="l222.2" class="difflineminus">--- a/suite/locales/en-US/chrome/common/pref/pref-applications-edit.dtd</span>
<a href="#l222.3"></a><span id="l222.3" class="difflineplus">+++ /dev/null</span>
<a href="#l222.4"></a><span id="l222.4" class="difflineat">@@ -1,24 +0,0 @@</span>
<a href="#l222.5"></a><span id="l222.5" class="difflineminus">-</span>
<a href="#l222.6"></a><span id="l222.6" class="difflineminus">-&lt;!ENTITY  editType.label                        &quot;Edit Type&quot;&gt;</span>
<a href="#l222.7"></a><span id="l222.7" class="difflineminus">-&lt;!ENTITY  newType.label                         &quot;New Type&quot;&gt;</span>
<a href="#l222.8"></a><span id="l222.8" class="difflineminus">-&lt;!ENTITY  extension.label                       &quot;Extension:&quot;&gt;</span>
<a href="#l222.9"></a><span id="l222.9" class="difflineminus">-&lt;!ENTITY  extension.accesskey                   &quot;E&quot;&gt;</span>
<a href="#l222.10"></a><span id="l222.10" class="difflineminus">-&lt;!--LOCALIZATION NOTE (mimeType): 'MIME' should not be translated --&gt;</span>
<a href="#l222.11"></a><span id="l222.11" class="difflineminus">-&lt;!ENTITY  mimetype.label                        &quot;MIME Type:&quot;&gt;</span>
<a href="#l222.12"></a><span id="l222.12" class="difflineminus">-&lt;!ENTITY  mimetype.accesskey                    &quot;m&quot;&gt;</span>
<a href="#l222.13"></a><span id="l222.13" class="difflineminus">-&lt;!ENTITY  description.label                     &quot;Description:&quot;&gt;</span>
<a href="#l222.14"></a><span id="l222.14" class="difflineminus">-&lt;!ENTITY  description.accesskey                 &quot;d&quot;&gt;</span>
<a href="#l222.15"></a><span id="l222.15" class="difflineminus">-</span>
<a href="#l222.16"></a><span id="l222.16" class="difflineminus">-&lt;!ENTITY  handling.label                        &quot;When a file of this type is encountered&quot;&gt;</span>
<a href="#l222.17"></a><span id="l222.17" class="difflineminus">-&lt;!ENTITY  useDefault.label                      &quot;Open it using the default application&quot;&gt;</span>
<a href="#l222.18"></a><span id="l222.18" class="difflineminus">-&lt;!ENTITY  useDefault.accesskey                  &quot;o&quot;&gt;</span>
<a href="#l222.19"></a><span id="l222.19" class="difflineminus">-&lt;!ENTITY  saveToDisk.label                      &quot;Save it to Disk&quot;&gt;</span>
<a href="#l222.20"></a><span id="l222.20" class="difflineminus">-&lt;!ENTITY  saveToDisk.accesskey                  &quot;s&quot;&gt;</span>
<a href="#l222.21"></a><span id="l222.21" class="difflineminus">-&lt;!ENTITY  application.label                     &quot;Open it with:&quot;&gt;</span>
<a href="#l222.22"></a><span id="l222.22" class="difflineminus">-&lt;!ENTITY  application.accesskey                 &quot;w&quot;&gt;</span>
<a href="#l222.23"></a><span id="l222.23" class="difflineminus">-</span>
<a href="#l222.24"></a><span id="l222.24" class="difflineminus">-&lt;!ENTITY  browse.label                          &quot;Choose...&quot;&gt;</span>
<a href="#l222.25"></a><span id="l222.25" class="difflineminus">-&lt;!ENTITY  browse.accesskey                      &quot;c&quot;&gt;</span>
<a href="#l222.26"></a><span id="l222.26" class="difflineminus">-</span>
<a href="#l222.27"></a><span id="l222.27" class="difflineminus">-&lt;!ENTITY  askBeforeOpen.label                   &quot;Always ask me before handling files of this type&quot;&gt;</span>
<a href="#l222.28"></a><span id="l222.28" class="difflineminus">-&lt;!ENTITY  askBeforeOpen.accesskey               &quot;k&quot;&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l223.1"></a><span id="l223.1" class="difflineminus">--- a/suite/locales/en-US/chrome/mailnews/folderProps.dtd</span>
<a href="#l223.2"></a><span id="l223.2" class="difflineplus">+++ b/suite/locales/en-US/chrome/mailnews/folderProps.dtd</span>
<a href="#l223.3"></a><span id="l223.3" class="difflineat">@@ -56,20 +56,20 @@</span>
<a href="#l223.4"></a><span id="l223.4"> &lt;!ENTITY message.label &quot;messages&quot;&gt;</span>
<a href="#l223.5"></a><span id="l223.5"> &lt;!ENTITY retentionCleanup.label &quot;Keep messages:&quot;&gt;</span>
<a href="#l223.6"></a><span id="l223.6"> &lt;!ENTITY retentionCleanupImap.label &quot;Keep messages, both the local copies and their originals on the server:&quot;&gt;</span>
<a href="#l223.7"></a><span id="l223.7"> &lt;!ENTITY retentionCleanupPop.label &quot;Keep messages, including their originals on the server:&quot;&gt;</span>
<a href="#l223.8"></a><span id="l223.8"> &lt;!ENTITY retentionDeleteMsg.label &quot;Delete messages more than&quot;&gt;</span>
<a href="#l223.9"></a><span id="l223.9"> &lt;!ENTITY retentionDeleteMsg.accesskey &quot;m&quot;&gt;</span>
<a href="#l223.10"></a><span id="l223.10"> &lt;!ENTITY retentionKeepAll.label &quot;All messages&quot;&gt;</span>
<a href="#l223.11"></a><span id="l223.11"> &lt;!ENTITY retentionKeepAll.accesskey &quot;A&quot;&gt;</span>
<a href="#l223.12"></a><span id="l223.12" class="difflineminus">-&lt;!ENTITY retentionKeepNew.label &quot;The newest&quot;&gt;</span>
<a href="#l223.13"></a><span id="l223.13" class="difflineminus">-&lt;!ENTITY retentionKeepNew.accesskey &quot;n&quot;&gt;</span>
<a href="#l223.14"></a><span id="l223.14" class="difflineminus">-&lt;!ENTITY retentionKeepUnread.label &quot;Only unread messages&quot;&gt;</span>
<a href="#l223.15"></a><span id="l223.15" class="difflineminus">-&lt;!ENTITY retentionKeepUnread.accesskey &quot;u&quot;&gt;</span>
<a href="#l223.16"></a><span id="l223.16" class="difflineplus">+&lt;!ENTITY retentionKeepRecent.label &quot;The newest&quot;&gt;</span>
<a href="#l223.17"></a><span id="l223.17" class="difflineplus">+&lt;!ENTITY retentionKeepRecent.accesskey &quot;n&quot;&gt;</span>
<a href="#l223.18"></a><span id="l223.18" class="difflineplus">+&lt;!-- LOCALIZATION NOTE: Unhide with .keepUnreadOnly { display: -moz-box; } --&gt;</span>
<a href="#l223.19"></a><span id="l223.19" class="difflineplus">+&lt;!ENTITY retentionKeepUnreadHidden.label &quot;Always delete read messages (overrides age settings)&quot;&gt;</span>
<a href="#l223.20"></a><span id="l223.20"> &lt;!ENTITY retentionApplyToFlagged.label &quot;Always keep flagged messages&quot;&gt;</span>
<a href="#l223.21"></a><span id="l223.21"> &lt;!ENTITY retentionApplyToFlagged.accesskey &quot;e&quot;&gt;</span>
<a href="#l223.22"></a><span id="l223.22"> </span>
<a href="#l223.23"></a><span id="l223.23"> &lt;!ENTITY folderSynchronizationTab.label          &quot;Synchronization&quot;&gt;</span>
<a href="#l223.24"></a><span id="l223.24"> &lt;!ENTITY folderCheckForNewMessages.label         &quot;Check this folder for new messages&quot;&gt;</span>
<a href="#l223.25"></a><span id="l223.25"> &lt;!ENTITY folderCheckForNewMessages.accesskey     &quot;C&quot;&gt;</span>
<a href="#l223.26"></a><span id="l223.26"> </span>
<a href="#l223.27"></a><span id="l223.27"> &lt;!ENTITY offlineFolder.check.label               &quot;Select this folder for offline use&quot;&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l224.1"></a><span id="l224.1" class="difflineminus">--- a/suite/locales/en-US/chrome/mailnews/pref/am-offline.dtd</span>
<a href="#l224.2"></a><span id="l224.2" class="difflineplus">+++ b/suite/locales/en-US/chrome/mailnews/pref/am-offline.dtd</span>
<a href="#l224.3"></a><span id="l224.3" class="difflineat">@@ -13,22 +13,22 @@</span>
<a href="#l224.4"></a><span id="l224.4"> &lt;!ENTITY nntpDownloadMsg.accesskey &quot;e&quot;&gt;</span>
<a href="#l224.5"></a><span id="l224.5"> &lt;!ENTITY retentionCleanup.label &quot;To recover disk space, old messages can be permanently deleted.&quot;&gt;</span>
<a href="#l224.6"></a><span id="l224.6"> &lt;!ENTITY retentionCleanupImap.label &quot;To recover disk space, old messages can be permanently deleted, both the local copies and their originals on the server.&quot;&gt;</span>
<a href="#l224.7"></a><span id="l224.7"> &lt;!ENTITY retentionCleanupPop.label &quot;To recover disk space, old messages can be permanently deleted, including their originals on the server.&quot;&gt;</span>
<a href="#l224.8"></a><span id="l224.8"> &lt;!ENTITY retentionKeepMsg.label &quot;Delete messages more than&quot;&gt;</span>
<a href="#l224.9"></a><span id="l224.9"> &lt;!ENTITY retentionKeepMsg.accesskey &quot;t&quot;&gt;</span>
<a href="#l224.10"></a><span id="l224.10"> &lt;!ENTITY retentionKeepAll.label &quot;Don't delete any messages&quot;&gt;</span>
<a href="#l224.11"></a><span id="l224.11"> &lt;!ENTITY retentionKeepAll.accesskey &quot;n&quot;&gt;</span>
<a href="#l224.12"></a><span id="l224.12" class="difflineminus">-&lt;!ENTITY retentionKeepNew.label &quot;Delete all but the last&quot;&gt;</span>
<a href="#l224.13"></a><span id="l224.13" class="difflineminus">-&lt;!ENTITY retentionKeepNew.accesskey &quot;b&quot;&gt;</span>
<a href="#l224.14"></a><span id="l224.14" class="difflineminus">-&lt;!ENTITY retentionKeepUnread.label &quot;Always delete read messages&quot;&gt;</span>
<a href="#l224.15"></a><span id="l224.15" class="difflineminus">-&lt;!ENTITY retentionKeepUnread.accesskey &quot;w&quot;&gt;</span>
<a href="#l224.16"></a><span id="l224.16" class="difflineplus">+&lt;!ENTITY retentionKeepRecent.label &quot;Delete all but the most recent&quot;&gt;</span>
<a href="#l224.17"></a><span id="l224.17" class="difflineplus">+&lt;!ENTITY retentionKeepRecent.accesskey &quot;b&quot;&gt;</span>
<a href="#l224.18"></a><span id="l224.18" class="difflineplus">+&lt;!-- LOCALIZATION NOTE: Unhide with .keepUnreadOnly { display: -moz-box; } --&gt;</span>
<a href="#l224.19"></a><span id="l224.19" class="difflineplus">+&lt;!ENTITY retentionKeepUnreadHidden.label &quot;Always delete read messages (overrides age settings)&quot;&gt;</span>
<a href="#l224.20"></a><span id="l224.20"> &lt;!ENTITY retentionApplyToFlagged.label &quot;Always keep flagged messages&quot;&gt;</span>
<a href="#l224.21"></a><span id="l224.21"> &lt;!ENTITY retentionApplyToFlagged.accesskey &quot;k&quot;&gt;</span>
<a href="#l224.22"></a><span id="l224.22" class="difflineminus">-&lt;!ENTITY nntpRemoveBody.label &quot;Only message bodies less than&quot;&gt;</span>
<a href="#l224.23"></a><span id="l224.23" class="difflineminus">-&lt;!ENTITY nntpRemoveBody.accesskey &quot;O&quot;&gt;</span>
<a href="#l224.24"></a><span id="l224.24" class="difflineplus">+&lt;!ENTITY nntpRemoveMsgBody.label &quot;Remove bodies from messages more than&quot;&gt;</span>
<a href="#l224.25"></a><span id="l224.25" class="difflineplus">+&lt;!ENTITY nntpRemoveMsgBody.accesskey &quot;o&quot;&gt;</span>
<a href="#l224.26"></a><span id="l224.26"> &lt;!ENTITY offlineSelectNntp.label &quot;Select newsgroups for offline useâ¦&quot;&gt;</span>
<a href="#l224.27"></a><span id="l224.27"> &lt;!ENTITY offlineSelectNntp.accesskey &quot;S&quot;&gt;</span>
<a href="#l224.28"></a><span id="l224.28"> &lt;!ENTITY offlineImapAdvancedOffline.label &quot;Advancedâ¦&quot;&gt;</span>
<a href="#l224.29"></a><span id="l224.29"> &lt;!ENTITY offlineImapAdvancedOffline.accesskey &quot;v&quot;&gt;</span>
<a href="#l224.30"></a><span id="l224.30"> &lt;!ENTITY syncGroupTitle.label &quot;Message Synchronizing&quot;&gt;</span>
<a href="#l224.31"></a><span id="l224.31"> &lt;!ENTITY diskspaceGroupTitle.label &quot;Disk Space&quot;&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l225.1"></a><span id="l225.1" class="difflineminus">--- a/suite/locales/en-US/installer/unix/README</span>
<a href="#l225.2"></a><span id="l225.2" class="difflineplus">+++ b/suite/locales/en-US/installer/unix/README</span>
<a href="#l225.3"></a><span id="l225.3" class="difflineat">@@ -125,13 +125,13 @@ Installation Instructions</span>
<a href="#l225.4"></a><span id="l225.4">      where directory_name is the name of the directory you downloaded</span>
<a href="#l225.5"></a><span id="l225.5">      SeaMonkey to. For example, the default directory that SeaMonkey</span>
<a href="#l225.6"></a><span id="l225.6">      suggests is /usr/local/seamonkey.</span>
<a href="#l225.7"></a><span id="l225.7"> </span>
<a href="#l225.8"></a><span id="l225.8">   3. Type in a name for the icon, and type in a comment if you wish.</span>
<a href="#l225.9"></a><span id="l225.9"> </span>
<a href="#l225.10"></a><span id="l225.10">   4. Click the icon button and type in the following as the icon's location:</span>
<a href="#l225.11"></a><span id="l225.11"> </span>
<a href="#l225.12"></a><span id="l225.12" class="difflineminus">-       directory_name/chrome/icons/default/default.xpm</span>
<a href="#l225.13"></a><span id="l225.13" class="difflineplus">+       directory_name/chrome/icons/default/default.png</span>
<a href="#l225.14"></a><span id="l225.14"> </span>
<a href="#l225.15"></a><span id="l225.15">      where directory_name is the directory where you installed SeaMonkey.</span>
<a href="#l225.16"></a><span id="l225.16">      For example, the default directory is</span>
<a href="#l225.17"></a><span id="l225.17" class="difflineminus">-     /usr/local/seamonkey/chrome/icons/default/default.xpm.</span>
<a href="#l225.18"></a><span id="l225.18" class="difflineplus">+     /usr/local/seamonkey/chrome/icons/default/default.png.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l226.1"></a><span id="l226.1" class="difflineminus">--- a/suite/locales/jar.mn</span>
<a href="#l226.2"></a><span id="l226.2" class="difflineplus">+++ b/suite/locales/jar.mn</span>
<a href="#l226.3"></a><span id="l226.3" class="difflineat">@@ -172,16 +172,17 @@</span>
<a href="#l226.4"></a><span id="l226.4">   locale/@AB_CD@/communicator/profile/profileSelection.dtd                  (%chrome/common/profile/profileSelection.dtd)</span>
<a href="#l226.5"></a><span id="l226.5">   locale/@AB_CD@/communicator/profile/profileSelection.properties           (%chrome/common/profile/profileSelection.properties)</span>
<a href="#l226.6"></a><span id="l226.6">   locale/@AB_CD@/communicator/search/default.htm                            (%chrome/common/search/default.htm)</span>
<a href="#l226.7"></a><span id="l226.7">   locale/@AB_CD@/communicator/search/internetresults.dtd                    (%chrome/common/search/internetresults.dtd)</span>
<a href="#l226.8"></a><span id="l226.8">   locale/@AB_CD@/communicator/search/search-editor.dtd                      (%chrome/common/search/search-editor.dtd)</span>
<a href="#l226.9"></a><span id="l226.9">   locale/@AB_CD@/communicator/search/search-editor.properties               (%chrome/common/search/search-editor.properties)</span>
<a href="#l226.10"></a><span id="l226.10">   locale/@AB_CD@/communicator/search/search-panel.dtd                       (%chrome/common/search/search-panel.dtd)</span>
<a href="#l226.11"></a><span id="l226.11">   locale/@AB_CD@/communicator/search/search-panel.properties                (%chrome/common/search/search-panel.properties)</span>
<a href="#l226.12"></a><span id="l226.12" class="difflineplus">+  locale/@AB_CD@/communicator/search/search-rdf.dtd                         (%chrome/common/search/search-rdf.dtd)</span>
<a href="#l226.13"></a><span id="l226.13">   locale/@AB_CD@/communicator/sidebar/customize.dtd                         (%chrome/common/sidebar/customize.dtd)</span>
<a href="#l226.14"></a><span id="l226.14">   locale/@AB_CD@/communicator/sidebar/local-panels.dtd                      (%chrome/common/sidebar/local-panels.dtd)</span>
<a href="#l226.15"></a><span id="l226.15">   locale/@AB_CD@/communicator/sidebar/preview.dtd                           (%chrome/common/sidebar/preview.dtd)</span>
<a href="#l226.16"></a><span id="l226.16">   locale/@AB_CD@/communicator/sidebar/sidebar.properties                    (%chrome/common/sidebar/sidebar.properties)</span>
<a href="#l226.17"></a><span id="l226.17">   locale/@AB_CD@/communicator/sidebar/sidebarOverlay.dtd                    (%chrome/common/sidebar/sidebarOverlay.dtd)</span>
<a href="#l226.18"></a><span id="l226.18">   locale/@AB_CD@/communicator-platform/win/platformCommunicatorOverlay.dtd  (%chrome/common/win/platformCommunicatorOverlay.dtd)</span>
<a href="#l226.19"></a><span id="l226.19">   locale/@AB_CD@/communicator-platform/unix/platformCommunicatorOverlay.dtd (%chrome/common/unix/platformCommunicatorOverlay.dtd)</span>
<a href="#l226.20"></a><span id="l226.20">   locale/@AB_CD@/communicator-platform/mac/platformCommunicatorOverlay.dtd  (%chrome/common/mac/platformCommunicatorOverlay.dtd)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l227.1"></a><span id="l227.1" class="difflineminus">--- a/suite/mailnews/jar.mn</span>
<a href="#l227.2"></a><span id="l227.2" class="difflineplus">+++ b/suite/mailnews/jar.mn</span>
<a href="#l227.3"></a><span id="l227.3" class="difflineat">@@ -32,16 +32,17 @@ messenger.jar:</span>
<a href="#l227.4"></a><span id="l227.4">     content/messenger/mailWindow.js</span>
<a href="#l227.5"></a><span id="l227.5">     content/messenger/messageWindow.xul</span>
<a href="#l227.6"></a><span id="l227.6">     content/messenger/messageWindow.js</span>
<a href="#l227.7"></a><span id="l227.7">     content/messenger/folderPane.xul</span>
<a href="#l227.8"></a><span id="l227.8">     content/messenger/threadPane.xul</span>
<a href="#l227.9"></a><span id="l227.9">     content/messenger/threadPane.js</span>
<a href="#l227.10"></a><span id="l227.10">     content/messenger/msgHdrViewOverlay.xul</span>
<a href="#l227.11"></a><span id="l227.11">     content/messenger/msgHdrViewOverlay.js</span>
<a href="#l227.12"></a><span id="l227.12" class="difflineplus">+    content/messenger/msgViewNavigation.js</span>
<a href="#l227.13"></a><span id="l227.13">     content/messenger/widgetglue.js</span>
<a href="#l227.14"></a><span id="l227.14">     content/messenger/commandglue.js</span>
<a href="#l227.15"></a><span id="l227.15">     content/messenger/mailCommands.js</span>
<a href="#l227.16"></a><span id="l227.16">     content/messenger/subscribe.xul</span>
<a href="#l227.17"></a><span id="l227.17">     content/messenger/subscribe.js</span>
<a href="#l227.18"></a><span id="l227.18">     content/messenger/msgMail3PaneWindow.js</span>
<a href="#l227.19"></a><span id="l227.19">     content/messenger/searchBar.js</span>
<a href="#l227.20"></a><span id="l227.20">     content/messenger/mail3PaneWindowCommands.js</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l228.1"></a><span id="l228.1" class="difflineminus">--- a/suite/mailnews/mailWindowOverlay.xul</span>
<a href="#l228.2"></a><span id="l228.2" class="difflineplus">+++ b/suite/mailnews/mailWindowOverlay.xul</span>
<a href="#l228.3"></a><span id="l228.3" class="difflineat">@@ -2116,35 +2116,36 @@</span>
<a href="#l228.4"></a><span id="l228.4">                   command=&quot;cmd_nextFlaggedMsg&quot;/&gt;</span>
<a href="#l228.5"></a><span id="l228.5">         &lt;menuseparator/&gt;</span>
<a href="#l228.6"></a><span id="l228.6">         &lt;menuitem label=&quot;&amp;nextUnreadThread.label;&quot;</span>
<a href="#l228.7"></a><span id="l228.7">                   accesskey=&quot;&amp;nextUnreadThread.accesskey;&quot;</span>
<a href="#l228.8"></a><span id="l228.8">                   command=&quot;cmd_nextUnreadThread&quot;/&gt;</span>
<a href="#l228.9"></a><span id="l228.9">       &lt;/menupopup&gt;</span>
<a href="#l228.10"></a><span id="l228.10">     &lt;/toolbarbutton&gt;</span>
<a href="#l228.11"></a><span id="l228.11"> </span>
<a href="#l228.12"></a><span id="l228.12" class="difflineminus">-    &lt;toolbaritem id=&quot;button-junk&quot;&gt;</span>
<a href="#l228.13"></a><span id="l228.13" class="difflineplus">+    &lt;toolbaritem id=&quot;button-junk&quot;</span>
<a href="#l228.14"></a><span id="l228.14" class="difflineplus">+                 observes=&quot;button_junk&quot;&gt;</span>
<a href="#l228.15"></a><span id="l228.15">       &lt;deck id=&quot;junk-deck&quot;</span>
<a href="#l228.16"></a><span id="l228.16" class="difflineminus">-            observes=&quot;button_junk&quot;</span>
<a href="#l228.17"></a><span id="l228.17">             oncommand=&quot;goDoCommand('button_junk')&quot;&gt;</span>
<a href="#l228.18"></a><span id="l228.18">         &lt;toolbarbutton id=&quot;button-isJunk&quot;</span>
<a href="#l228.19"></a><span id="l228.19">                        class=&quot;toolbarbutton-1&quot;</span>
<a href="#l228.20"></a><span id="l228.20">                        label=&quot;&amp;junkButton.label;&quot;</span>
<a href="#l228.21"></a><span id="l228.21">                        tooltiptext=&quot;&amp;junkButton.tooltip;&quot;</span>
<a href="#l228.22"></a><span id="l228.22">                        observes=&quot;button_junk&quot;/&gt;</span>
<a href="#l228.23"></a><span id="l228.23">         &lt;toolbarbutton id=&quot;button-notJunk&quot;</span>
<a href="#l228.24"></a><span id="l228.24">                        class=&quot;toolbarbutton-1&quot;</span>
<a href="#l228.25"></a><span id="l228.25">                        label=&quot;&amp;notJunkButton.label;&quot;</span>
<a href="#l228.26"></a><span id="l228.26">                        tooltiptext=&quot;&amp;notJunkButton.tooltip;&quot;</span>
<a href="#l228.27"></a><span id="l228.27">                        observes=&quot;button_junk&quot;/&gt;</span>
<a href="#l228.28"></a><span id="l228.28">       &lt;/deck&gt;</span>
<a href="#l228.29"></a><span id="l228.29">     &lt;/toolbaritem&gt;</span>
<a href="#l228.30"></a><span id="l228.30"> </span>
<a href="#l228.31"></a><span id="l228.31" class="difflineminus">-    &lt;toolbaritem id=&quot;button-delete&quot;&gt;</span>
<a href="#l228.32"></a><span id="l228.32" class="difflineminus">-      &lt;deck id=&quot;delete-deck&quot; observes=&quot;button_delete&quot;&gt;</span>
<a href="#l228.33"></a><span id="l228.33" class="difflineplus">+    &lt;toolbaritem id=&quot;button-delete&quot;</span>
<a href="#l228.34"></a><span id="l228.34" class="difflineplus">+                 observes=&quot;button_delete&quot;&gt;</span>
<a href="#l228.35"></a><span id="l228.35" class="difflineplus">+      &lt;deck id=&quot;delete-deck&quot;&gt;</span>
<a href="#l228.36"></a><span id="l228.36">         &lt;toolbarbutton id=&quot;button-mark-deleted&quot;</span>
<a href="#l228.37"></a><span id="l228.37">                        class=&quot;toolbarbutton-1&quot;</span>
<a href="#l228.38"></a><span id="l228.38">                        label=&quot;&amp;deleteButton.label;&quot;</span>
<a href="#l228.39"></a><span id="l228.39">                        tooltiptext=&quot;&amp;deleteButton.tooltip;&quot;</span>
<a href="#l228.40"></a><span id="l228.40">                        observes=&quot;button_delete&quot;</span>
<a href="#l228.41"></a><span id="l228.41">                        oncommand=&quot;goDoCommand(event.shiftKey ? 'button_shiftDelete' : 'button_delete')&quot;/&gt;</span>
<a href="#l228.42"></a><span id="l228.42">         &lt;toolbarbutton id=&quot;button-mark-undelete&quot;</span>
<a href="#l228.43"></a><span id="l228.43">                        class=&quot;toolbarbutton-1&quot;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l229.1"></a><span id="l229.1">copy from mailnews/base/resources/content/msgViewNavigation.js</span>
<a href="#l229.2"></a><span id="l229.2">copy to suite/mailnews/msgViewNavigation.js</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l230.1"></a><span id="l230.1">deleted file mode 100644</span>
<a href="#l230.2"></a><span id="l230.2" class="difflineminus">--- a/suite/mailnews/tabmail.xml</span>
<a href="#l230.3"></a><span id="l230.3" class="difflineplus">+++ /dev/null</span>
<a href="#l230.4"></a><span id="l230.4" class="difflineat">@@ -1,1421 +0,0 @@</span>
<a href="#l230.5"></a><span id="l230.5" class="difflineminus">-&lt;?xml version=&quot;1.0&quot;?&gt;</span>
<a href="#l230.6"></a><span id="l230.6" class="difflineminus">-# ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l230.7"></a><span id="l230.7" class="difflineminus">-# Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l230.8"></a><span id="l230.8" class="difflineminus">-#</span>
<a href="#l230.9"></a><span id="l230.9" class="difflineminus">-# The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l230.10"></a><span id="l230.10" class="difflineminus">-# 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l230.11"></a><span id="l230.11" class="difflineminus">-# the License. You may obtain a copy of the License at</span>
<a href="#l230.12"></a><span id="l230.12" class="difflineminus">-# http://www.mozilla.org/MPL/</span>
<a href="#l230.13"></a><span id="l230.13" class="difflineminus">-#</span>
<a href="#l230.14"></a><span id="l230.14" class="difflineminus">-# Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l230.15"></a><span id="l230.15" class="difflineminus">-# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l230.16"></a><span id="l230.16" class="difflineminus">-# for the specific language governing rights and limitations under the</span>
<a href="#l230.17"></a><span id="l230.17" class="difflineminus">-# License.</span>
<a href="#l230.18"></a><span id="l230.18" class="difflineminus">-#</span>
<a href="#l230.19"></a><span id="l230.19" class="difflineminus">-# The Original Code is tab email</span>
<a href="#l230.20"></a><span id="l230.20" class="difflineminus">-#</span>
<a href="#l230.21"></a><span id="l230.21" class="difflineminus">-# The Initial Developer of the Original Code is</span>
<a href="#l230.22"></a><span id="l230.22" class="difflineminus">-#   David Bienvenu &lt;bienvenu@nventure.com&gt;.</span>
<a href="#l230.23"></a><span id="l230.23" class="difflineminus">-# Portions created by the Initial Developer are Copyright (C) 2007</span>
<a href="#l230.24"></a><span id="l230.24" class="difflineminus">-# the Initial Developer. All Rights Reserved.</span>
<a href="#l230.25"></a><span id="l230.25" class="difflineminus">-#</span>
<a href="#l230.26"></a><span id="l230.26" class="difflineminus">-# Contributor(s):</span>
<a href="#l230.27"></a><span id="l230.27" class="difflineminus">-#  Scott MacGregor &lt;mscott@mozilla.org&gt;</span>
<a href="#l230.28"></a><span id="l230.28" class="difflineminus">-#  Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a href="#l230.29"></a><span id="l230.29" class="difflineminus">-#</span>
<a href="#l230.30"></a><span id="l230.30" class="difflineminus">-# Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l230.31"></a><span id="l230.31" class="difflineminus">-# either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l230.32"></a><span id="l230.32" class="difflineminus">-# the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l230.33"></a><span id="l230.33" class="difflineminus">-# in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l230.34"></a><span id="l230.34" class="difflineminus">-# of those above. If you wish to allow use of your version of this file only</span>
<a href="#l230.35"></a><span id="l230.35" class="difflineminus">-# under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l230.36"></a><span id="l230.36" class="difflineminus">-# use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l230.37"></a><span id="l230.37" class="difflineminus">-# decision by deleting the provisions above and replace them with the notice</span>
<a href="#l230.38"></a><span id="l230.38" class="difflineminus">-# and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l230.39"></a><span id="l230.39" class="difflineminus">-# the provisions above, a recipient may use your version of this file under</span>
<a href="#l230.40"></a><span id="l230.40" class="difflineminus">-# the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l230.41"></a><span id="l230.41" class="difflineminus">-#</span>
<a href="#l230.42"></a><span id="l230.42" class="difflineminus">-# ***** END LICENSE BLOCK *****</span>
<a href="#l230.43"></a><span id="l230.43" class="difflineminus">-</span>
<a href="#l230.44"></a><span id="l230.44" class="difflineminus">-&lt;!DOCTYPE bindings [</span>
<a href="#l230.45"></a><span id="l230.45" class="difflineminus">-&lt;!ENTITY % messengerDTD SYSTEM &quot;chrome://messenger/locale/messenger.dtd&quot; &gt;</span>
<a href="#l230.46"></a><span id="l230.46" class="difflineminus">-%messengerDTD;</span>
<a href="#l230.47"></a><span id="l230.47" class="difflineminus">-&lt;!ENTITY % tabMailDTD SYSTEM &quot;chrome://messenger/locale/tabmail.dtd&quot; &gt;</span>
<a href="#l230.48"></a><span id="l230.48" class="difflineminus">- %tabMailDTD;</span>
<a href="#l230.49"></a><span id="l230.49" class="difflineminus">- &lt;!ENTITY % globalDTD SYSTEM &quot;chrome://global/locale/global.dtd&quot;&gt;</span>
<a href="#l230.50"></a><span id="l230.50" class="difflineminus">- %globalDTD;</span>
<a href="#l230.51"></a><span id="l230.51" class="difflineminus">-]&gt;</span>
<a href="#l230.52"></a><span id="l230.52" class="difflineminus">-</span>
<a href="#l230.53"></a><span id="l230.53" class="difflineminus">-&lt;bindings id=&quot;tabmailBindings&quot;</span>
<a href="#l230.54"></a><span id="l230.54" class="difflineminus">-   xmlns=&quot;http://www.mozilla.org/xbl&quot;</span>
<a href="#l230.55"></a><span id="l230.55" class="difflineminus">-   xmlns:xul=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;</span>
<a href="#l230.56"></a><span id="l230.56" class="difflineminus">-   xmlns:xbl=&quot;http://www.mozilla.org/xbl&quot;&gt;</span>
<a href="#l230.57"></a><span id="l230.57" class="difflineminus">-</span>
<a href="#l230.58"></a><span id="l230.58" class="difflineminus">-  &lt;!-- Thunderbird's tab UI mechanism.</span>
<a href="#l230.59"></a><span id="l230.59" class="difflineminus">-    -</span>
<a href="#l230.60"></a><span id="l230.60" class="difflineminus">-    - We expect to be instantiated with the following children:</span>
<a href="#l230.61"></a><span id="l230.61" class="difflineminus">-    - * One &quot;tabpanels&quot; child element whose id must be placed in the</span>
<a href="#l230.62"></a><span id="l230.62" class="difflineminus">-    -   &quot;panelcontainer&quot; attribute on the element we are being bound to. We do</span>
<a href="#l230.63"></a><span id="l230.63" class="difflineminus">-    -   this because it is important to allow overlays to contribute panels.</span>
<a href="#l230.64"></a><span id="l230.64" class="difflineminus">-    -   When we attempted to have the immediate children of the bound element</span>
<a href="#l230.65"></a><span id="l230.65" class="difflineminus">-    -   be propagated through use of the &quot;children&quot; tag, we found that children</span>
<a href="#l230.66"></a><span id="l230.66" class="difflineminus">-    -   contributed by overlays did not propagate.</span>
<a href="#l230.67"></a><span id="l230.67" class="difflineminus">-    - * Any children you want added to the right side of the tab bar.  This is</span>
<a href="#l230.68"></a><span id="l230.68" class="difflineminus">-    -   primarily intended to allow for &quot;open a BLANK tab&quot; buttons, namely</span>
<a href="#l230.69"></a><span id="l230.69" class="difflineminus">-    -   calendar and tasks.  For reasons similar to the tabpanels case, we</span>
<a href="#l230.70"></a><span id="l230.70" class="difflineminus">-    -   expect the instantiating element to provide a child hbox for overlays</span>
<a href="#l230.71"></a><span id="l230.71" class="difflineminus">-    -   to contribute buttons to.</span>
<a href="#l230.72"></a><span id="l230.72" class="difflineminus">-    -</span>
<a href="#l230.73"></a><span id="l230.73" class="difflineminus">-    - From a javascript perspective, there are three types of code that we</span>
<a href="#l230.74"></a><span id="l230.74" class="difflineminus">-    -  expect to interact with:</span>
<a href="#l230.75"></a><span id="l230.75" class="difflineminus">-    - 1) Code that wants to open new tabs.</span>
<a href="#l230.76"></a><span id="l230.76" class="difflineminus">-    - 2) Code that wants to contribute one or more varieties of tabs.</span>
<a href="#l230.77"></a><span id="l230.77" class="difflineminus">-    - 3) Code that wants to monitor to know when the active tab changes.</span>
<a href="#l230.78"></a><span id="l230.78" class="difflineminus">-    -</span>
<a href="#l230.79"></a><span id="l230.79" class="difflineminus">-    - Consumer code should use the following methods:</span>
<a href="#l230.80"></a><span id="l230.80" class="difflineminus">-    - * openTab(aTabModeName, arguments...): Open a tab of the given &quot;mode&quot;,</span>
<a href="#l230.81"></a><span id="l230.81" class="difflineminus">-    -   passing the provided arguments.  The tab type author should tell you</span>
<a href="#l230.82"></a><span id="l230.82" class="difflineminus">-    -   the modes they implement and the required/optional arguments.</span>
<a href="#l230.83"></a><span id="l230.83" class="difflineminus">-    - * setTabTitle([aOptionalTabInfo]): Tells us that the title of the current</span>
<a href="#l230.84"></a><span id="l230.84" class="difflineminus">-    -   tab (if no argument is provided) or provided tab needs to be updated.</span>
<a href="#l230.85"></a><span id="l230.85" class="difflineminus">-    -   This will result in a call to the tab mode's logic to update the title.</span>
<a href="#l230.86"></a><span id="l230.86" class="difflineminus">-    -   In the event this is not for the current tab, the caller is responsible</span>
<a href="#l230.87"></a><span id="l230.87" class="difflineminus">-    -   for ensuring that the underlying tab mode is capable of providing a tab</span>
<a href="#l230.88"></a><span id="l230.88" class="difflineminus">-    -   title when it is in the background.  (The is currently not the case for</span>
<a href="#l230.89"></a><span id="l230.89" class="difflineminus">-    -   &quot;folder&quot; and &quot;mail&quot; modes because of their implementation.)</span>
<a href="#l230.90"></a><span id="l230.90" class="difflineminus">-    - * removeCurrentTab(): Close the current tab.</span>
<a href="#l230.91"></a><span id="l230.91" class="difflineminus">-    - * removeTabByNode(aTabElement): Close the tab whose tabmail-tab bound</span>
<a href="#l230.92"></a><span id="l230.92" class="difflineminus">-    -   element is passed in.</span>
<a href="#l230.93"></a><span id="l230.93" class="difflineminus">-    - Changing the currently displayed tab is accomplished by changing</span>
<a href="#l230.94"></a><span id="l230.94" class="difflineminus">-    -  tabmail.tabContainer's selectedIndex or selectedItem property.</span>
<a href="#l230.95"></a><span id="l230.95" class="difflineminus">-    -</span>
<a href="#l230.96"></a><span id="l230.96" class="difflineminus">-    - Tab contributing code should define a tab type object and register it</span>
<a href="#l230.97"></a><span id="l230.97" class="difflineminus">-    -  with us by calling registerTabType.  Each tab type can provide multiple</span>
<a href="#l230.98"></a><span id="l230.98" class="difflineminus">-    -  tab modes.  The rationale behind this organization is that Thunderbird</span>
<a href="#l230.99"></a><span id="l230.99" class="difflineminus">-    -  historically/currently uses a single 3-pane view to display both</span>
<a href="#l230.100"></a><span id="l230.100" class="difflineminus">-    -  three-pane folder browsing and single message browsing across multiple</span>
<a href="#l230.101"></a><span id="l230.101" class="difflineminus">-    -  tabs.  Each tab type has the ability to use a single tab panel for all</span>
<a href="#l230.102"></a><span id="l230.102" class="difflineminus">-    -  of its display needs.  So Thunderbird's &quot;mail&quot; tab type covers both the</span>
<a href="#l230.103"></a><span id="l230.103" class="difflineminus">-    -  &quot;folder&quot; (3-pane folder-based browsing)  and &quot;message&quot; (just a single</span>
<a href="#l230.104"></a><span id="l230.104" class="difflineminus">-    -  message) tab modes.  Likewise, calendar/lightning currently displays both</span>
<a href="#l230.105"></a><span id="l230.105" class="difflineminus">-    -  its calendar and tasks in the same panel.  A tab type can also create a</span>
<a href="#l230.106"></a><span id="l230.106" class="difflineminus">-    -  new tabpanel for each tab as it is created.  In that case, the tab type </span>
<a href="#l230.107"></a><span id="l230.107" class="difflineminus">-    -  should probably only have a single mode unless there are a number of</span>
<a href="#l230.108"></a><span id="l230.108" class="difflineminus">-    -  similar modes that can gain from code sharing.</span>
<a href="#l230.109"></a><span id="l230.109" class="difflineminus">-    - The tab type definition should include the following attributes:</span>
<a href="#l230.110"></a><span id="l230.110" class="difflineminus">-    - * name: The name of the tab-type, mainly to aid in debugging.</span>
<a href="#l230.111"></a><span id="l230.111" class="difflineminus">-    - * panelId or perTabPanel: If using a single tab panel, the id of the</span>
<a href="#l230.112"></a><span id="l230.112" class="difflineminus">-    -     panel must be provided in panelId.  If using one tab panel per tab,</span>
<a href="#l230.113"></a><span id="l230.113" class="difflineminus">-    -     perTabPanel should be the XUL element name that should be created for</span>
<a href="#l230.114"></a><span id="l230.114" class="difflineminus">-    -     each tab.  If a reason arises, in the future we might support</span>
<a href="#l230.115"></a><span id="l230.115" class="difflineminus">-    -     this being a helper function to create and return the element.</span>
<a href="#l230.116"></a><span id="l230.116" class="difflineminus">-    - * modes: An object whose attributes are mode names (which are</span>
<a href="#l230.117"></a><span id="l230.117" class="difflineminus">-    -     automatically propagated to a 'name' attribute for debugging) and</span>
<a href="#l230.118"></a><span id="l230.118" class="difflineminus">-    -     values are objects with the following attributes...</span>
<a href="#l230.119"></a><span id="l230.119" class="difflineminus">-    - * any of the openTab/closeTab/saveTabState/showTab/onTitleChanged</span>
<a href="#l230.120"></a><span id="l230.120" class="difflineminus">-    -     functions as described on the mode definitions.  These will only be</span>
<a href="#l230.121"></a><span id="l230.121" class="difflineminus">-    -     called if the mode does not provide the functions.  Note that because</span>
<a href="#l230.122"></a><span id="l230.122" class="difflineminus">-    -     the 'this' variable passed to the functions will always reference the</span>
<a href="#l230.123"></a><span id="l230.123" class="difflineminus">-    -     tab type definition (rather than the mode definition), the mode</span>
<a href="#l230.124"></a><span id="l230.124" class="difflineminus">-    -     functions can defer to the tab type functions by calling </span>
<a href="#l230.125"></a><span id="l230.125" class="difflineminus">-    -     this.functionName().  (This should prove convenient.)</span>
<a href="#l230.126"></a><span id="l230.126" class="difflineminus">-    - Mode definition attributes:</span>
<a href="#l230.127"></a><span id="l230.127" class="difflineminus">-    - * type: The &quot;type&quot; attribute to set on the displayed tab for CSS purposes.</span>
<a href="#l230.128"></a><span id="l230.128" class="difflineminus">-    -     Generally, this would be the same as the mode name, but you can do as</span>
<a href="#l230.129"></a><span id="l230.129" class="difflineminus">-    -     you please.</span>
<a href="#l230.130"></a><span id="l230.130" class="difflineminus">-    - * isDefault: This should only be present and should be true for the tab</span>
<a href="#l230.131"></a><span id="l230.131" class="difflineminus">-    -     mode that is the tab displayed automatically on startup.</span>
<a href="#l230.132"></a><span id="l230.132" class="difflineminus">-    - * maxTabs: The maximum number of this mode that can be opened at a time.</span>
<a href="#l230.133"></a><span id="l230.133" class="difflineminus">-    -     If this limit is reached, any additional calls to openTab for this</span>
<a href="#l230.134"></a><span id="l230.134" class="difflineminus">-    -     mode will simply result in the first existing tab of this mode being</span>
<a href="#l230.135"></a><span id="l230.135" class="difflineminus">-    -     displayed.</span>
<a href="#l230.136"></a><span id="l230.136" class="difflineminus">-    - * shouldSwitchTo(arguments...): Optional function. Called when</span>
<a href="#l230.137"></a><span id="l230.137" class="difflineminus">-    -     openTab is called on the top-level tabmail binding. It is used to</span>
<a href="#l230.138"></a><span id="l230.138" class="difflineminus">-    -     decide if the openTab function should switch to an existing tab or</span>
<a href="#l230.139"></a><span id="l230.139" class="difflineminus">-    -     actually open a new tab.</span>
<a href="#l230.140"></a><span id="l230.140" class="difflineminus">-    -     If the openTab function should switch to an existing tab, return the</span>
<a href="#l230.141"></a><span id="l230.141" class="difflineminus">-    -     index of that tab; otherwise return -1.</span>
<a href="#l230.142"></a><span id="l230.142" class="difflineminus">-    - * openTab(aTab, arguments...): Called when a tab of the given mode is</span>
<a href="#l230.143"></a><span id="l230.143" class="difflineminus">-    -     in the process of being opened.  aTab will have its &quot;mode&quot; attribute</span>
<a href="#l230.144"></a><span id="l230.144" class="difflineminus">-    -     set to the mode definition of the tab mode being opened.  You should</span>
<a href="#l230.145"></a><span id="l230.145" class="difflineminus">-    -     set the &quot;title&quot; attribute on it, and may set any other attributes</span>
<a href="#l230.146"></a><span id="l230.146" class="difflineminus">-    -     you wish for your own use in subsequent functions.  Note that 'this'</span>
<a href="#l230.147"></a><span id="l230.147" class="difflineminus">-    -     points to the tab type definition, not the mode definition as you</span>
<a href="#l230.148"></a><span id="l230.148" class="difflineminus">-    -     might expect.  This allows you to place common logic code on the</span>
<a href="#l230.149"></a><span id="l230.149" class="difflineminus">-    -     tab type for use by multiple modes and to defer to it.  Any arguments</span>
<a href="#l230.150"></a><span id="l230.150" class="difflineminus">-    -     provided to the caller of tabmail.openTab will be passed to your</span>
<a href="#l230.151"></a><span id="l230.151" class="difflineminus">-    -     function as well.</span>
<a href="#l230.152"></a><span id="l230.152" class="difflineminus">-    - * closeTab(aTab): Called when aTab is being closed.  The tab need not be</span>
<a href="#l230.153"></a><span id="l230.153" class="difflineminus">-    -     currently displayed.  You are responsible for properly cleaning up</span>
<a href="#l230.154"></a><span id="l230.154" class="difflineminus">-    -     any state you preserved in aTab.</span>
<a href="#l230.155"></a><span id="l230.155" class="difflineminus">-    - * saveTabState(aTab): Called when aTab is being switched away from so that</span>
<a href="#l230.156"></a><span id="l230.156" class="difflineminus">-    -     you can preserve its state on aTab.  This is primarily for single</span>
<a href="#l230.157"></a><span id="l230.157" class="difflineminus">-    -     tab panel implementations; you may not have much state to save if your</span>
<a href="#l230.158"></a><span id="l230.158" class="difflineminus">-    -     tab has its own tab panel.</span>
<a href="#l230.159"></a><span id="l230.159" class="difflineminus">-    - * showTab(aTab): Called when aTab is being displayed and you should</span>
<a href="#l230.160"></a><span id="l230.160" class="difflineminus">-    -     restore its state (if required).</span>
<a href="#l230.161"></a><span id="l230.161" class="difflineminus">-    - * onTitleChanged(aTab): Called when someone calls tabmail.setTabTitle() to</span>
<a href="#l230.162"></a><span id="l230.162" class="difflineminus">-    -     hint that the tab's title needs to be updated.  This function should</span>
<a href="#l230.163"></a><span id="l230.163" class="difflineminus">-    -     update aTab.title if it can.</span>
<a href="#l230.164"></a><span id="l230.164" class="difflineminus">-    - Mode definition functions to do with menu/toolbar commands:</span>
<a href="#l230.165"></a><span id="l230.165" class="difflineminus">-    - * supportsCommand(aTab, aCommand): Called when a menu or toolbar needs to</span>
<a href="#l230.166"></a><span id="l230.166" class="difflineminus">-    -     be updated. Return true if you support that command in</span>
<a href="#l230.167"></a><span id="l230.167" class="difflineminus">-    -     isCommandEnabled and doCommand, return false otherwise.</span>
<a href="#l230.168"></a><span id="l230.168" class="difflineminus">-    - * isCommandEnabled(aTab, aCommand): Called when a menu or toolbar needs</span>
<a href="#l230.169"></a><span id="l230.169" class="difflineminus">-    -     to be updated. Return true if the command can be executed at the</span>
<a href="#l230.170"></a><span id="l230.170" class="difflineminus">-    -     current time, false otherwise.</span>
<a href="#l230.171"></a><span id="l230.171" class="difflineminus">-    - * doCommand(aTab, aCommand): Called when a menu or toolbar command is to</span>
<a href="#l230.172"></a><span id="l230.172" class="difflineminus">-    -     be executed. Perform the action appropriate to the command.</span>
<a href="#l230.173"></a><span id="l230.173" class="difflineminus">-    - * onEvent(aTab, aEvent): This can be used to handle different events on</span>
<a href="#l230.174"></a><span id="l230.174" class="difflineminus">-    -     the window.</span>
<a href="#l230.175"></a><span id="l230.175" class="difflineminus">-    - * getBrowser(aTab): This function should return the browser element for</span>
<a href="#l230.176"></a><span id="l230.176" class="difflineminus">-    -     your tab if there is one (return null or don't define this function</span>
<a href="#l230.177"></a><span id="l230.177" class="difflineminus">-    -     otherwise). It is used for some toolkit functions that require a</span>
<a href="#l230.178"></a><span id="l230.178" class="difflineminus">-    -     global &quot;getBrowser&quot; function, e.g. ZoomManager.</span>
<a href="#l230.179"></a><span id="l230.179" class="difflineminus">-    -</span>
<a href="#l230.180"></a><span id="l230.180" class="difflineminus">-    - Tab monitoring code is expected to be used for widgets on the screen</span>
<a href="#l230.181"></a><span id="l230.181" class="difflineminus">-    -  outside of the tab box that need to update themselves as the active tab</span>
<a href="#l230.182"></a><span id="l230.182" class="difflineminus">-    -  changes.  This is primarily intended to be used for the ThunderBar; if</span>
<a href="#l230.183"></a><span id="l230.183" class="difflineminus">-    -  you are not the ThunderBar and this sounds appealing to you, please</span>
<a href="#l230.184"></a><span id="l230.184" class="difflineminus">-    -  solicit discussion on your needs on the mozilla.dev.apps.thunderbird</span>
<a href="#l230.185"></a><span id="l230.185" class="difflineminus">-    -  newsgroup.</span>
<a href="#l230.186"></a><span id="l230.186" class="difflineminus">-    - Tab monitoring code (un)registers itself via (un)registerTabMonitor.</span>
<a href="#l230.187"></a><span id="l230.187" class="difflineminus">-    -  The following functions should be provided on the monitor object:</span>
<a href="#l230.188"></a><span id="l230.188" class="difflineminus">-    - * onTabTitleChanged(aTab): Called when the tab's title changes.</span>
<a href="#l230.189"></a><span id="l230.189" class="difflineminus">-    - * onTabSwitched(aTab, aOldTab): Called when a new tab is made active.  If</span>
<a href="#l230.190"></a><span id="l230.190" class="difflineminus">-    -     this is the first tab ever, aOldTab will be null, otherwise aOldTab</span>
<a href="#l230.191"></a><span id="l230.191" class="difflineminus">-    -     will be the previously active tab.</span>
<a href="#l230.192"></a><span id="l230.192" class="difflineminus">-    --&gt;</span>
<a href="#l230.193"></a><span id="l230.193" class="difflineminus">-  &lt;binding id=&quot;tabmail&quot;&gt;</span>
<a href="#l230.194"></a><span id="l230.194" class="difflineminus">-    &lt;resources&gt;</span>
<a href="#l230.195"></a><span id="l230.195" class="difflineminus">-      &lt;stylesheet src=&quot;chrome://messenger/skin/tabmail.css&quot;/&gt;</span>
<a href="#l230.196"></a><span id="l230.196" class="difflineminus">-    &lt;/resources&gt;</span>
<a href="#l230.197"></a><span id="l230.197" class="difflineminus">-    &lt;content&gt;</span>
<a href="#l230.198"></a><span id="l230.198" class="difflineminus">-      &lt;xul:tabbox anonid=&quot;tabbox&quot; flex=&quot;1&quot; eventnode=&quot;document&quot; xbl:inherits=&quot;handleCtrlPageUpDown&quot;</span>
<a href="#l230.199"></a><span id="l230.199" class="difflineminus">-                  onselect=&quot;if (!('updateCurrentTab' in this.parentNode) || event.target.localName != 'tabs')</span>
<a href="#l230.200"></a><span id="l230.200" class="difflineminus">-                            return; this.parentNode.updateCurrentTab();&quot;&gt;</span>
<a href="#l230.201"></a><span id="l230.201" class="difflineminus">-        &lt;xul:hbox class=&quot;tab-drop-indicator-bar&quot; collapsed=&quot;true&quot;&gt;</span>
<a href="#l230.202"></a><span id="l230.202" class="difflineminus">-          &lt;xul:hbox class=&quot;tab-drop-indicator&quot; mousethrough=&quot;always&quot;/&gt;</span>
<a href="#l230.203"></a><span id="l230.203" class="difflineminus">-        &lt;/xul:hbox&gt;</span>
<a href="#l230.204"></a><span id="l230.204" class="difflineminus">-        &lt;xul:hbox class=&quot;tabmail-strip&quot; collapsed=&quot;false&quot; tooltip=&quot;_child&quot; context=&quot;_child&quot;</span>
<a href="#l230.205"></a><span id="l230.205" class="difflineminus">-                  anonid=&quot;strip&quot;</span>
<a href="#l230.206"></a><span id="l230.206" class="difflineminus">-                  ondraggesture=&quot;nsDragAndDrop.startDrag(event, this.parentNode.parentNode); event.stopPropagation();&quot;</span>
<a href="#l230.207"></a><span id="l230.207" class="difflineminus">-                  ondragover=&quot;nsDragAndDrop.dragOver(event, this.parentNode.parentNode); event.stopPropagation();&quot;</span>
<a href="#l230.208"></a><span id="l230.208" class="difflineminus">-                  ondragdrop=&quot;nsDragAndDrop.drop(event, this.parentNode.parentNode); event.stopPropagation();&quot;</span>
<a href="#l230.209"></a><span id="l230.209" class="difflineminus">-                  ondragexit=&quot;nsDragAndDrop.dragExit(event, this.parentNode.parentNode); event.stopPropagation();&quot;&gt;</span>
<a href="#l230.210"></a><span id="l230.210" class="difflineminus">-          &lt;xul:tooltip onpopupshowing=&quot;return CreateToolbarTooltip(document, event);&quot;/&gt;</span>
<a href="#l230.211"></a><span id="l230.211" class="difflineminus">-          &lt;xul:menupopup anonid=&quot;tabContextMenu&quot;</span>
<a href="#l230.212"></a><span id="l230.212" class="difflineminus">-                onpopupshowing=&quot;</span>
<a href="#l230.213"></a><span id="l230.213" class="difflineminus">-                  var tabmail = this.parentNode.parentNode.parentNode;</span>
<a href="#l230.214"></a><span id="l230.214" class="difflineminus">-                  return tabmail.onTabContextMenuShowing(document.popupNode);&quot;&gt;</span>
<a href="#l230.215"></a><span id="l230.215" class="difflineminus">-            &lt;xul:menuitem label=&quot;&amp;closeTabCmd.label;&quot; accesskey=&quot;&amp;closeTabCmd.accesskey;&quot;</span>
<a href="#l230.216"></a><span id="l230.216" class="difflineminus">-                          oncommand=&quot;var tabmail = this.parentNode.parentNode.parentNode.parentNode;</span>
<a href="#l230.217"></a><span id="l230.217" class="difflineminus">-                                     tabmail.removeTabByNode(document.popupNode);&quot;/&gt;</span>
<a href="#l230.218"></a><span id="l230.218" class="difflineminus">-          &lt;/xul:menupopup&gt;</span>
<a href="#l230.219"></a><span id="l230.219" class="difflineminus">-          &lt;xul:tabs class=&quot;tabmail-tabs&quot; flex=&quot;1&quot;</span>
<a href="#l230.220"></a><span id="l230.220" class="difflineminus">-                    anonid=&quot;tabcontainer&quot;</span>
<a href="#l230.221"></a><span id="l230.221" class="difflineminus">-                    setfocus=&quot;false&quot;</span>
<a href="#l230.222"></a><span id="l230.222" class="difflineminus">-                    onclick=&quot;this.parentNode.parentNode.parentNode.onTabClick(event);&quot;&gt;</span>
<a href="#l230.223"></a><span id="l230.223" class="difflineminus">-            &lt;xul:tab selected=&quot;true&quot; validate=&quot;never&quot; type=&quot;folder&quot;</span>
<a href="#l230.224"></a><span id="l230.224" class="difflineminus">-                     maxwidth=&quot;250&quot; width=&quot;0&quot; minwidth=&quot;100&quot; flex=&quot;100&quot;</span>
<a href="#l230.225"></a><span id="l230.225" class="difflineminus">-                     class=&quot;tabmail-tab&quot; crop=&quot;end&quot;/&gt;</span>
<a href="#l230.226"></a><span id="l230.226" class="difflineminus">-            &lt;children/&gt;</span>
<a href="#l230.227"></a><span id="l230.227" class="difflineminus">-          &lt;/xul:tabs&gt;</span>
<a href="#l230.228"></a><span id="l230.228" class="difflineminus">-        &lt;/xul:hbox&gt;</span>
<a href="#l230.229"></a><span id="l230.229" class="difflineminus">-        &lt;!-- Remember, user of this binding, you need to provide tabpanels!  --&gt;</span>
<a href="#l230.230"></a><span id="l230.230" class="difflineminus">-        &lt;children includes=&quot;tabpanels&quot;/&gt;</span>
<a href="#l230.231"></a><span id="l230.231" class="difflineminus">-      &lt;/xul:tabbox&gt;</span>
<a href="#l230.232"></a><span id="l230.232" class="difflineminus">-    &lt;/content&gt;</span>
<a href="#l230.233"></a><span id="l230.233" class="difflineminus">-</span>
<a href="#l230.234"></a><span id="l230.234" class="difflineminus">-    &lt;implementation implements=&quot;nsIController&quot;&gt;</span>
<a href="#l230.235"></a><span id="l230.235" class="difflineminus">-      &lt;constructor&gt;</span>
<a href="#l230.236"></a><span id="l230.236" class="difflineminus">-        window.controllers.insertControllerAt(0, this);</span>
<a href="#l230.237"></a><span id="l230.237" class="difflineminus">-      &lt;/constructor&gt;</span>
<a href="#l230.238"></a><span id="l230.238" class="difflineminus">-      &lt;destructor&gt;</span>
<a href="#l230.239"></a><span id="l230.239" class="difflineminus">-        window.controllers.removeController(this);</span>
<a href="#l230.240"></a><span id="l230.240" class="difflineminus">-      &lt;/destructor&gt;</span>
<a href="#l230.241"></a><span id="l230.241" class="difflineminus">-      &lt;field name=&quot;currentTabInfo&quot;&gt;</span>
<a href="#l230.242"></a><span id="l230.242" class="difflineminus">-        null</span>
<a href="#l230.243"></a><span id="l230.243" class="difflineminus">-      &lt;/field&gt;</span>
<a href="#l230.244"></a><span id="l230.244" class="difflineminus">-      &lt;field name=&quot;tabTypes&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l230.245"></a><span id="l230.245" class="difflineminus">-        new Object()</span>
<a href="#l230.246"></a><span id="l230.246" class="difflineminus">-      &lt;/field&gt;</span>
<a href="#l230.247"></a><span id="l230.247" class="difflineminus">-      &lt;field name=&quot;tabModes&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l230.248"></a><span id="l230.248" class="difflineminus">-        new Object()</span>
<a href="#l230.249"></a><span id="l230.249" class="difflineminus">-      &lt;/field&gt;</span>
<a href="#l230.250"></a><span id="l230.250" class="difflineminus">-      &lt;field name=&quot;defaultTabMode&quot;&gt;</span>
<a href="#l230.251"></a><span id="l230.251" class="difflineminus">-        null</span>
<a href="#l230.252"></a><span id="l230.252" class="difflineminus">-      &lt;/field&gt;</span>
<a href="#l230.253"></a><span id="l230.253" class="difflineminus">-      &lt;field name=&quot;tabInfo&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l230.254"></a><span id="l230.254" class="difflineminus">-        new Array()</span>
<a href="#l230.255"></a><span id="l230.255" class="difflineminus">-      &lt;/field&gt;</span>
<a href="#l230.256"></a><span id="l230.256" class="difflineminus">-      &lt;field name=&quot;tabStrip&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l230.257"></a><span id="l230.257" class="difflineminus">-        document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;strip&quot;);</span>
<a href="#l230.258"></a><span id="l230.258" class="difflineminus">-      &lt;/field&gt;</span>
<a href="#l230.259"></a><span id="l230.259" class="difflineminus">-      &lt;field name=&quot;tabContainer&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l230.260"></a><span id="l230.260" class="difflineminus">-        document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;tabcontainer&quot;);</span>
<a href="#l230.261"></a><span id="l230.261" class="difflineminus">-      &lt;/field&gt;</span>
<a href="#l230.262"></a><span id="l230.262" class="difflineminus">-      &lt;field name=&quot;panelContainer&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l230.263"></a><span id="l230.263" class="difflineminus">-        document.getElementById(this.getAttribute(&quot;panelcontainer&quot;));</span>
<a href="#l230.264"></a><span id="l230.264" class="difflineminus">-      &lt;/field&gt;</span>
<a href="#l230.265"></a><span id="l230.265" class="difflineminus">-      &lt;field name=&quot;tabMonitors&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l230.266"></a><span id="l230.266" class="difflineminus">-        new Array()</span>
<a href="#l230.267"></a><span id="l230.267" class="difflineminus">-      &lt;/field&gt;</span>
<a href="#l230.268"></a><span id="l230.268" class="difflineminus">-      &lt;method name=&quot;registerTabType&quot;&gt;</span>
<a href="#l230.269"></a><span id="l230.269" class="difflineminus">-        &lt;parameter name=&quot;aTabType&quot;/&gt;</span>
<a href="#l230.270"></a><span id="l230.270" class="difflineminus">-        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l230.271"></a><span id="l230.271" class="difflineminus">-          if (aTabType.name in this.tabTypes)</span>
<a href="#l230.272"></a><span id="l230.272" class="difflineminus">-            return;</span>
<a href="#l230.273"></a><span id="l230.273" class="difflineminus">-        </span>
<a href="#l230.274"></a><span id="l230.274" class="difflineminus">-          this.tabTypes[aTabType.name] = aTabType;</span>
<a href="#l230.275"></a><span id="l230.275" class="difflineminus">-          for (let [modeName, modeDetails] in Iterator(aTabType.modes)) {</span>
<a href="#l230.276"></a><span id="l230.276" class="difflineminus">-            modeDetails.name = modeName;</span>
<a href="#l230.277"></a><span id="l230.277" class="difflineminus">-            modeDetails.tabType = aTabType;</span>
<a href="#l230.278"></a><span id="l230.278" class="difflineminus">-            modeDetails.tabs = [];</span>
<a href="#l230.279"></a><span id="l230.279" class="difflineminus">-            this.tabModes[modeName] = modeDetails;</span>
<a href="#l230.280"></a><span id="l230.280" class="difflineminus">-            if (modeDetails.isDefault)</span>
<a href="#l230.281"></a><span id="l230.281" class="difflineminus">-              this.defaultTabMode = modeDetails;</span>
<a href="#l230.282"></a><span id="l230.282" class="difflineminus">-          }</span>
<a href="#l230.283"></a><span id="l230.283" class="difflineminus">-          </span>
<a href="#l230.284"></a><span id="l230.284" class="difflineminus">-          aTabType.panel = document.getElementById(aTabType.panelId);</span>
<a href="#l230.285"></a><span id="l230.285" class="difflineminus">-        ]]&gt;&lt;/body&gt;</span>
<a href="#l230.286"></a><span id="l230.286" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l230.287"></a><span id="l230.287" class="difflineminus">-      &lt;method name=&quot;registerTabMonitor&quot;&gt;</span>
<a href="#l230.288"></a><span id="l230.288" class="difflineminus">-        &lt;parameter name=&quot;aTabMonitor&quot;/&gt;</span>
<a href="#l230.289"></a><span id="l230.289" class="difflineminus">-        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l230.290"></a><span id="l230.290" class="difflineminus">-          if (this.tabMonitors.indexOf(aTabMonitor) == -1)</span>
<a href="#l230.291"></a><span id="l230.291" class="difflineminus">-            this.tabMonitors.push(aTabMonitor);</span>
<a href="#l230.292"></a><span id="l230.292" class="difflineminus">-        ]]&gt;&lt;/body&gt;</span>
<a href="#l230.293"></a><span id="l230.293" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l230.294"></a><span id="l230.294" class="difflineminus">-      &lt;method name=&quot;unregisterTabMonitor&quot;&gt;</span>
<a href="#l230.295"></a><span id="l230.295" class="difflineminus">-        &lt;parameter name=&quot;aTabMonitor&quot;/&gt;</span>
<a href="#l230.296"></a><span id="l230.296" class="difflineminus">-        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l230.297"></a><span id="l230.297" class="difflineminus">-          if (this.tabMonitors.indexOf(aTabMonitor) &gt;= 0)</span>
<a href="#l230.298"></a><span id="l230.298" class="difflineminus">-            this.tabMonitors.splice(this.tabMonitors.indexOf(aTabMonitor), 1);</span>
<a href="#l230.299"></a><span id="l230.299" class="difflineminus">-        ]]&gt;&lt;/body&gt;</span>
<a href="#l230.300"></a><span id="l230.300" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l230.301"></a><span id="l230.301" class="difflineminus">-      &lt;method name=&quot;openFirstTab&quot;&gt;</span>
<a href="#l230.302"></a><span id="l230.302" class="difflineminus">-        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l230.303"></a><span id="l230.303" class="difflineminus">-          // From the moment of creation, our XBL binding already has a visible</span>
<a href="#l230.304"></a><span id="l230.304" class="difflineminus">-          //  tab.  We need to create a tab information structure for this tab.</span>
<a href="#l230.305"></a><span id="l230.305" class="difflineminus">-          //  In the process we also generate a synthetic tab title changed</span>
<a href="#l230.306"></a><span id="l230.306" class="difflineminus">-          //  event to ensure we have an accurate title.  We assume the tab</span>
<a href="#l230.307"></a><span id="l230.307" class="difflineminus">-          //  contents will set themselves up correctly.</span>
<a href="#l230.308"></a><span id="l230.308" class="difflineminus">-          if (this.tabInfo.length == 0) {</span>
<a href="#l230.309"></a><span id="l230.309" class="difflineminus">-            let firstTab = {mode: this.defaultTabMode, canClose: false};</span>
<a href="#l230.310"></a><span id="l230.310" class="difflineminus">-            firstTab.mode.tabs.push(firstTab);</span>
<a href="#l230.311"></a><span id="l230.311" class="difflineminus">-           </span>
<a href="#l230.312"></a><span id="l230.312" class="difflineminus">-            this.tabInfo[0] = this.currentTabInfo = firstTab;</span>
<a href="#l230.313"></a><span id="l230.313" class="difflineminus">-            this.setTabTitle(firstTab);</span>
<a href="#l230.314"></a><span id="l230.314" class="difflineminus">-</span>
<a href="#l230.315"></a><span id="l230.315" class="difflineminus">-            if (this.tabMonitors.length) {</span>
<a href="#l230.316"></a><span id="l230.316" class="difflineminus">-              for each (let [i, tabMonitor] in Iterator(this.tabMonitors))</span>
<a href="#l230.317"></a><span id="l230.317" class="difflineminus">-                tabMonitor.onTabSwitched(tab, null);</span>
<a href="#l230.318"></a><span id="l230.318" class="difflineminus">-            }</span>
<a href="#l230.319"></a><span id="l230.319" class="difflineminus">-          }</span>
<a href="#l230.320"></a><span id="l230.320" class="difflineminus">-        ]]&gt;&lt;/body&gt;</span>
<a href="#l230.321"></a><span id="l230.321" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l230.322"></a><span id="l230.322" class="difflineminus">-      &lt;method name=&quot;openTab&quot;&gt;</span>
<a href="#l230.323"></a><span id="l230.323" class="difflineminus">-        &lt;parameter name=&quot;aTabModeName&quot;/&gt;</span>
<a href="#l230.324"></a><span id="l230.324" class="difflineminus">-        &lt;body&gt;</span>
<a href="#l230.325"></a><span id="l230.325" class="difflineminus">-            &lt;![CDATA[</span>
<a href="#l230.326"></a><span id="l230.326" class="difflineminus">-          let tabMode = this.tabModes[aTabModeName];</span>
<a href="#l230.327"></a><span id="l230.327" class="difflineminus">-          // if we are already at our limit for this mode, show an existing one</span>
<a href="#l230.328"></a><span id="l230.328" class="difflineminus">-          if (tabMode.tabs.length == tabMode.maxTabs) {</span>
<a href="#l230.329"></a><span id="l230.329" class="difflineminus">-            let desiredTab = tabMode.tabs[0];</span>
<a href="#l230.330"></a><span id="l230.330" class="difflineminus">-            this.tabContainer.selectedIndex = this.tabInfo.indexOf(desiredTab);</span>
<a href="#l230.331"></a><span id="l230.331" class="difflineminus">-            return;</span>
<a href="#l230.332"></a><span id="l230.332" class="difflineminus">-          }</span>
<a href="#l230.333"></a><span id="l230.333" class="difflineminus">-</span>
<a href="#l230.334"></a><span id="l230.334" class="difflineminus">-          // If the mode wants us to, we should switch to an existing tab</span>
<a href="#l230.335"></a><span id="l230.335" class="difflineminus">-          // rather than open a new one.</span>
<a href="#l230.336"></a><span id="l230.336" class="difflineminus">-          let shouldSwitchToFunc = tabMode.shouldSwitchTo ||</span>
<a href="#l230.337"></a><span id="l230.337" class="difflineminus">-                                   tabMode.tabType.shouldSwitchTo;</span>
<a href="#l230.338"></a><span id="l230.338" class="difflineminus">-</span>
<a href="#l230.339"></a><span id="l230.339" class="difflineminus">-          if (shouldSwitchToFunc) {</span>
<a href="#l230.340"></a><span id="l230.340" class="difflineminus">-            let args = Array.prototype.slice.call(arguments, 1);</span>
<a href="#l230.341"></a><span id="l230.341" class="difflineminus">-            let tabIndex = shouldSwitchToFunc.apply(tabMode.tabType, args);</span>
<a href="#l230.342"></a><span id="l230.342" class="difflineminus">-            if (tabIndex &gt;= 0) {</span>
<a href="#l230.343"></a><span id="l230.343" class="difflineminus">-              this.selectTabByIndex(null, tabIndex);</span>
<a href="#l230.344"></a><span id="l230.344" class="difflineminus">-              return;</span>
<a href="#l230.345"></a><span id="l230.345" class="difflineminus">-            }</span>
<a href="#l230.346"></a><span id="l230.346" class="difflineminus">-          }</span>
<a href="#l230.347"></a><span id="l230.347" class="difflineminus">-</span>
<a href="#l230.348"></a><span id="l230.348" class="difflineminus">-          // we need to save the state before it gets corrupted</span>
<a href="#l230.349"></a><span id="l230.349" class="difflineminus">-          this.saveCurrentTabState();</span>
<a href="#l230.350"></a><span id="l230.350" class="difflineminus">-</span>
<a href="#l230.351"></a><span id="l230.351" class="difflineminus">-          let tab = {mode: tabMode, canClose: true};</span>
<a href="#l230.352"></a><span id="l230.352" class="difflineminus">-          tabMode.tabs.push(tab);</span>
<a href="#l230.353"></a><span id="l230.353" class="difflineminus">-</span>
<a href="#l230.354"></a><span id="l230.354" class="difflineminus">-          var t = document.createElementNS(</span>
<a href="#l230.355"></a><span id="l230.355" class="difflineminus">-            &quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;,</span>
<a href="#l230.356"></a><span id="l230.356" class="difflineminus">-            &quot;tab&quot;);</span>
<a href="#l230.357"></a><span id="l230.357" class="difflineminus">-          t.setAttribute(&quot;crop&quot;, &quot;end&quot;);</span>
<a href="#l230.358"></a><span id="l230.358" class="difflineminus">-          t.maxWidth = this.tabContainer.mTabMaxWidth;</span>
<a href="#l230.359"></a><span id="l230.359" class="difflineminus">-          t.minWidth = this.tabContainer.mTabMinWidth;</span>
<a href="#l230.360"></a><span id="l230.360" class="difflineminus">-          t.width = 0;</span>
<a href="#l230.361"></a><span id="l230.361" class="difflineminus">-          t.setAttribute(&quot;flex&quot;, &quot;100&quot;);</span>
<a href="#l230.362"></a><span id="l230.362" class="difflineminus">-          t.setAttribute(&quot;validate&quot;, &quot;never&quot;);</span>
<a href="#l230.363"></a><span id="l230.363" class="difflineminus">-          t.className = &quot;tabmail-tab&quot;;</span>
<a href="#l230.364"></a><span id="l230.364" class="difflineminus">-          this.tabContainer.appendChild(t);</span>
<a href="#l230.365"></a><span id="l230.365" class="difflineminus">-          this.tabContainer.appendChild(t);</span>
<a href="#l230.366"></a><span id="l230.366" class="difflineminus">-          if (this.tabContainer.collapsed) {</span>
<a href="#l230.367"></a><span id="l230.367" class="difflineminus">-            this.tabContainer.collapsed = false;</span>
<a href="#l230.368"></a><span id="l230.368" class="difflineminus">-            this.tabContainer.adjustTabstrip();</span>
<a href="#l230.369"></a><span id="l230.369" class="difflineminus">-          }</span>
<a href="#l230.370"></a><span id="l230.370" class="difflineminus">-</span>
<a href="#l230.371"></a><span id="l230.371" class="difflineminus">-          let oldTab = this.currentTabInfo;</span>
<a href="#l230.372"></a><span id="l230.372" class="difflineminus">-</span>
<a href="#l230.373"></a><span id="l230.373" class="difflineminus">-          // the order of the following statements is important</span>
<a href="#l230.374"></a><span id="l230.374" class="difflineminus">-          this.currentTabInfo = tab;</span>
<a href="#l230.375"></a><span id="l230.375" class="difflineminus">-          this.tabInfo[this.tabContainer.childNodes.length - 1] = tab;</span>
<a href="#l230.376"></a><span id="l230.376" class="difflineminus">-          // this has a side effect of calling updateCurrentTab, but our</span>
<a href="#l230.377"></a><span id="l230.377" class="difflineminus">-          //  setting currentTabInfo above will cause it to take no action.</span>
<a href="#l230.378"></a><span id="l230.378" class="difflineminus">-          this.tabContainer.selectedIndex =</span>
<a href="#l230.379"></a><span id="l230.379" class="difflineminus">-            this.tabContainer.childNodes.length - 1;</span>
<a href="#l230.380"></a><span id="l230.380" class="difflineminus">-</span>
<a href="#l230.381"></a><span id="l230.381" class="difflineminus">-          // make sure we are on the right panel</span>
<a href="#l230.382"></a><span id="l230.382" class="difflineminus">-          if (tab.mode.tabType.perTabPanel) {</span>
<a href="#l230.383"></a><span id="l230.383" class="difflineminus">-            // should we create the element for them, or will they do it?</span>
<a href="#l230.384"></a><span id="l230.384" class="difflineminus">-            if (typeof(tab.mode.tabType.perTabPanel) == &quot;string&quot;) {</span>
<a href="#l230.385"></a><span id="l230.385" class="difflineminus">-              tab.panel = document.createElementNS(</span>
<a href="#l230.386"></a><span id="l230.386" class="difflineminus">-                &quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;,</span>
<a href="#l230.387"></a><span id="l230.387" class="difflineminus">-                tab.mode.tabType.perTabPanel);</span>
<a href="#l230.388"></a><span id="l230.388" class="difflineminus">-            }</span>
<a href="#l230.389"></a><span id="l230.389" class="difflineminus">-            else {</span>
<a href="#l230.390"></a><span id="l230.390" class="difflineminus">-              tab.panel = tab.mode.tabType.perTabPanel(tab);</span>
<a href="#l230.391"></a><span id="l230.391" class="difflineminus">-            }</span>
<a href="#l230.392"></a><span id="l230.392" class="difflineminus">-            this.panelContainer.appendChild(tab.panel);</span>
<a href="#l230.393"></a><span id="l230.393" class="difflineminus">-            this.panelContainer.selectedPanel = tab.panel;</span>
<a href="#l230.394"></a><span id="l230.394" class="difflineminus">-          }</span>
<a href="#l230.395"></a><span id="l230.395" class="difflineminus">-          else</span>
<a href="#l230.396"></a><span id="l230.396" class="difflineminus">-            this.panelContainer.selectedPanel = tab.mode.tabType.panel;</span>
<a href="#l230.397"></a><span id="l230.397" class="difflineminus">-            </span>
<a href="#l230.398"></a><span id="l230.398" class="difflineminus">-          let tabOpenFunc = tab.mode.openTab || tab.mode.tabType.openTab;</span>
<a href="#l230.399"></a><span id="l230.399" class="difflineminus">-          let args = [tab].concat(Array.prototype.slice.call(arguments, 1));</span>
<a href="#l230.400"></a><span id="l230.400" class="difflineminus">-          tabOpenFunc.apply(tab.mode.tabType, args);</span>
<a href="#l230.401"></a><span id="l230.401" class="difflineminus">-          </span>
<a href="#l230.402"></a><span id="l230.402" class="difflineminus">-          if (this.tabMonitors.length) {</span>
<a href="#l230.403"></a><span id="l230.403" class="difflineminus">-            for each (let [i, tabMonitor] in Iterator(this.tabMonitors))</span>
<a href="#l230.404"></a><span id="l230.404" class="difflineminus">-              tabMonitor.onTabSwitched(tab, oldTab);</span>
<a href="#l230.405"></a><span id="l230.405" class="difflineminus">-          }</span>
<a href="#l230.406"></a><span id="l230.406" class="difflineminus">-          </span>
<a href="#l230.407"></a><span id="l230.407" class="difflineminus">-          t.setAttribute(&quot;label&quot;, tab.title);</span>
<a href="#l230.408"></a><span id="l230.408" class="difflineminus">-          </span>
<a href="#l230.409"></a><span id="l230.409" class="difflineminus">-          let docTitle = tab.title;</span>
<a href="#l230.410"></a><span id="l230.410" class="difflineminus">-#ifndef XP_MACOSX</span>
<a href="#l230.411"></a><span id="l230.411" class="difflineminus">-          docTitle += &quot; - &quot; + gBrandBundle.getString(&quot;brandFullName&quot;);</span>
<a href="#l230.412"></a><span id="l230.412" class="difflineminus">-#endif</span>
<a href="#l230.413"></a><span id="l230.413" class="difflineminus">-          document.title = docTitle;</span>
<a href="#l230.414"></a><span id="l230.414" class="difflineminus">-          </span>
<a href="#l230.415"></a><span id="l230.415" class="difflineminus">-          // for styling purposes, apply the type to the tab...</span>
<a href="#l230.416"></a><span id="l230.416" class="difflineminus">-          t.setAttribute('type', tab.mode.type);</span>
<a href="#l230.417"></a><span id="l230.417" class="difflineminus">-        ]]&gt;&lt;/body&gt;</span>
<a href="#l230.418"></a><span id="l230.418" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l230.419"></a><span id="l230.419" class="difflineminus">-      &lt;method name=&quot;selectTabByMode&quot;&gt;</span>
<a href="#l230.420"></a><span id="l230.420" class="difflineminus">-        &lt;parameter name=&quot;aTabModeName&quot;/&gt;</span>
<a href="#l230.421"></a><span id="l230.421" class="difflineminus">-        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l230.422"></a><span id="l230.422" class="difflineminus">-          let tabMode = this.tabModes[aTabModeName];</span>
<a href="#l230.423"></a><span id="l230.423" class="difflineminus">-          if (tabMode.tabs.length) {</span>
<a href="#l230.424"></a><span id="l230.424" class="difflineminus">-            let desiredTab = tabMode.tabs[0];</span>
<a href="#l230.425"></a><span id="l230.425" class="difflineminus">-            this.tabContainer.selectedIndex = this.tabInfo.indexOf(desiredTab);</span>
<a href="#l230.426"></a><span id="l230.426" class="difflineminus">-          }</span>
<a href="#l230.427"></a><span id="l230.427" class="difflineminus">-        ]]&gt;&lt;/body&gt;</span>
<a href="#l230.428"></a><span id="l230.428" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l230.429"></a><span id="l230.429" class="difflineminus">-      &lt;method name=&quot;selectTabByIndex&quot;&gt;</span>
<a href="#l230.430"></a><span id="l230.430" class="difflineminus">-        &lt;parameter name=&quot;aEvent&quot;/&gt;</span>
<a href="#l230.431"></a><span id="l230.431" class="difflineminus">-        &lt;parameter name=&quot;aIndex&quot;/&gt;</span>
<a href="#l230.432"></a><span id="l230.432" class="difflineminus">-        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l230.433"></a><span id="l230.433" class="difflineminus">-          // count backwards for aIndex &lt; 0</span>
<a href="#l230.434"></a><span id="l230.434" class="difflineminus">-          if (aIndex &lt; 0)</span>
<a href="#l230.435"></a><span id="l230.435" class="difflineminus">-            aIndex += this.tabInfo.length;</span>
<a href="#l230.436"></a><span id="l230.436" class="difflineminus">-</span>
<a href="#l230.437"></a><span id="l230.437" class="difflineminus">-          if (aIndex &gt;= 0 &amp;&amp;</span>
<a href="#l230.438"></a><span id="l230.438" class="difflineminus">-              aIndex &lt; this.tabInfo.length &amp;&amp;</span>
<a href="#l230.439"></a><span id="l230.439" class="difflineminus">-              aIndex != this.tabContainer.selectedIndex) {</span>
<a href="#l230.440"></a><span id="l230.440" class="difflineminus">-            this.tabContainer.selectedIndex = aIndex;</span>
<a href="#l230.441"></a><span id="l230.441" class="difflineminus">-          }</span>
<a href="#l230.442"></a><span id="l230.442" class="difflineminus">-</span>
<a href="#l230.443"></a><span id="l230.443" class="difflineminus">-          if (aEvent) {</span>
<a href="#l230.444"></a><span id="l230.444" class="difflineminus">-            aEvent.preventDefault();</span>
<a href="#l230.445"></a><span id="l230.445" class="difflineminus">-            aEvent.stopPropagation();</span>
<a href="#l230.446"></a><span id="l230.446" class="difflineminus">-          }</span>
<a href="#l230.447"></a><span id="l230.447" class="difflineminus">-        ]]&gt;&lt;/body&gt;</span>
<a href="#l230.448"></a><span id="l230.448" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l230.449"></a><span id="l230.449" class="difflineminus">-      &lt;method name=&quot;closeTabs&quot;&gt;</span>
<a href="#l230.450"></a><span id="l230.450" class="difflineminus">-        &lt;body&gt;</span>
<a href="#l230.451"></a><span id="l230.451" class="difflineminus">-          &lt;![CDATA[</span>
<a href="#l230.452"></a><span id="l230.452" class="difflineminus">-            for (var i = 0; i &lt; this.tabInfo.length; i++) {</span>
<a href="#l230.453"></a><span id="l230.453" class="difflineminus">-              let tab = this.tabInfo[i];</span>
<a href="#l230.454"></a><span id="l230.454" class="difflineminus">-              </span>
<a href="#l230.455"></a><span id="l230.455" class="difflineminus">-              let tabCloseFunc = tab.mode.closeTab || tab.mode.tabType.closeTab;</span>
<a href="#l230.456"></a><span id="l230.456" class="difflineminus">-              tabCloseFunc.call(tab.mode.tabType, tab);</span>
<a href="#l230.457"></a><span id="l230.457" class="difflineminus">-            }</span>
<a href="#l230.458"></a><span id="l230.458" class="difflineminus">-          ]]&gt;</span>
<a href="#l230.459"></a><span id="l230.459" class="difflineminus">-        &lt;/body&gt;</span>
<a href="#l230.460"></a><span id="l230.460" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l230.461"></a><span id="l230.461" class="difflineminus">-      &lt;method name=&quot;removeTabByNode&quot;&gt;</span>
<a href="#l230.462"></a><span id="l230.462" class="difflineminus">-        &lt;parameter name=&quot;aTabNode&quot;/&gt;</span>
<a href="#l230.463"></a><span id="l230.463" class="difflineminus">-        &lt;body&gt;</span>
<a href="#l230.464"></a><span id="l230.464" class="difflineminus">-          &lt;![CDATA[</span>
<a href="#l230.465"></a><span id="l230.465" class="difflineminus">-            // Find and locate the tab in our list.</span>
<a href="#l230.466"></a><span id="l230.466" class="difflineminus">-            let iTab, numTabs = this.tabContainer.childNodes.length;</span>
<a href="#l230.467"></a><span id="l230.467" class="difflineminus">-            for (iTab = 0; iTab &lt; numTabs; iTab++)</span>
<a href="#l230.468"></a><span id="l230.468" class="difflineminus">-              if (this.tabContainer.childNodes[iTab] == aTabNode)</span>
<a href="#l230.469"></a><span id="l230.469" class="difflineminus">-                break;</span>
<a href="#l230.470"></a><span id="l230.470" class="difflineminus">-            let tab = this.tabInfo[iTab];</span>
<a href="#l230.471"></a><span id="l230.471" class="difflineminus">-</span>
<a href="#l230.472"></a><span id="l230.472" class="difflineminus">-            if (!tab.canClose)</span>
<a href="#l230.473"></a><span id="l230.473" class="difflineminus">-              return;</span>
<a href="#l230.474"></a><span id="l230.474" class="difflineminus">-            </span>
<a href="#l230.475"></a><span id="l230.475" class="difflineminus">-            let closeFunc = tab.mode.closeTab || tab.mode.tabType.closeTab;</span>
<a href="#l230.476"></a><span id="l230.476" class="difflineminus">-            closeFunc.call(tab.mode.tabType, tab);</span>
<a href="#l230.477"></a><span id="l230.477" class="difflineminus">-             </span>
<a href="#l230.478"></a><span id="l230.478" class="difflineminus">-            this.tabInfo.splice(iTab, 1);</span>
<a href="#l230.479"></a><span id="l230.479" class="difflineminus">-            tab.mode.tabs.splice(tab.mode.tabs.indexOf(tab), 1);</span>
<a href="#l230.480"></a><span id="l230.480" class="difflineminus">-            this.tabContainer.removeChild(aTabNode);</span>
<a href="#l230.481"></a><span id="l230.481" class="difflineminus">-            if (this.tabContainer.selectedIndex == -1)</span>
<a href="#l230.482"></a><span id="l230.482" class="difflineminus">-              this.tabContainer.selectedIndex = (iTab == --numTabs) ?</span>
<a href="#l230.483"></a><span id="l230.483" class="difflineminus">-                iTab - 1 : iTab;</span>
<a href="#l230.484"></a><span id="l230.484" class="difflineminus">-            if (this.currentTabInfo == tab)</span>
<a href="#l230.485"></a><span id="l230.485" class="difflineminus">-              this.updateCurrentTab();</span>
<a href="#l230.486"></a><span id="l230.486" class="difflineminus">-              </span>
<a href="#l230.487"></a><span id="l230.487" class="difflineminus">-            if (tab.panel) {</span>
<a href="#l230.488"></a><span id="l230.488" class="difflineminus">-              this.panelContainer.removeChild(tab.panel);</span>
<a href="#l230.489"></a><span id="l230.489" class="difflineminus">-              delete tab.panel;</span>
<a href="#l230.490"></a><span id="l230.490" class="difflineminus">-            }</span>
<a href="#l230.491"></a><span id="l230.491" class="difflineminus">-            if (numTabs == 1 &amp;&amp; this.tabContainer.mAutoHide)</span>
<a href="#l230.492"></a><span id="l230.492" class="difflineminus">-              this.tabContainer.collapsed = true;</span>
<a href="#l230.493"></a><span id="l230.493" class="difflineminus">-          ]]&gt;</span>
<a href="#l230.494"></a><span id="l230.494" class="difflineminus">-        &lt;/body&gt;</span>
<a href="#l230.495"></a><span id="l230.495" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l230.496"></a><span id="l230.496" class="difflineminus">-      &lt;!-- getBrowserForSelectedTab is required as some toolkit functions</span>
<a href="#l230.497"></a><span id="l230.497" class="difflineminus">-           require a getBrowser() function. --&gt;</span>
<a href="#l230.498"></a><span id="l230.498" class="difflineminus">-      &lt;method name=&quot;getBrowserForSelectedTab&quot;&gt;</span>
<a href="#l230.499"></a><span id="l230.499" class="difflineminus">-        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l230.500"></a><span id="l230.500" class="difflineminus">-          if (!this.currentTabInfo)</span>
<a href="#l230.501"></a><span id="l230.501" class="difflineminus">-            this.currentTabInfo = this.tabInfo[0];</span>
<a href="#l230.502"></a><span id="l230.502" class="difflineminus">-</span>
<a href="#l230.503"></a><span id="l230.503" class="difflineminus">-          let tab = this.currentTabInfo;</span>
<a href="#l230.504"></a><span id="l230.504" class="difflineminus">-</span>
<a href="#l230.505"></a><span id="l230.505" class="difflineminus">-          let browserFunc = tab.mode.getBrowser || tab.mode.tabType.getBrowser;</span>
<a href="#l230.506"></a><span id="l230.506" class="difflineminus">-          if (browserFunc)</span>
<a href="#l230.507"></a><span id="l230.507" class="difflineminus">-            return browserFunc.call(tab.mode.tabType, tab);</span>
<a href="#l230.508"></a><span id="l230.508" class="difflineminus">-</span>
<a href="#l230.509"></a><span id="l230.509" class="difflineminus">-          return null;</span>
<a href="#l230.510"></a><span id="l230.510" class="difflineminus">-        ]]&gt;&lt;/body&gt;</span>
<a href="#l230.511"></a><span id="l230.511" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l230.512"></a><span id="l230.512" class="difflineminus">-      &lt;method name=&quot;removeCurrentTab&quot;&gt;</span>
<a href="#l230.513"></a><span id="l230.513" class="difflineminus">-        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l230.514"></a><span id="l230.514" class="difflineminus">-          this.removeTabByNode(</span>
<a href="#l230.515"></a><span id="l230.515" class="difflineminus">-            this.tabContainer.childNodes[this.tabContainer.selectedIndex]);</span>
<a href="#l230.516"></a><span id="l230.516" class="difflineminus">-        ]]&gt;&lt;/body&gt;</span>
<a href="#l230.517"></a><span id="l230.517" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l230.518"></a><span id="l230.518" class="difflineminus">-      &lt;!--  UpdateCurrentTab - called in response to changing the current tab --&gt;</span>
<a href="#l230.519"></a><span id="l230.519" class="difflineminus">-      &lt;method name=&quot;updateCurrentTab&quot;&gt;</span>
<a href="#l230.520"></a><span id="l230.520" class="difflineminus">-        &lt;body&gt;</span>
<a href="#l230.521"></a><span id="l230.521" class="difflineminus">-          &lt;![CDATA[</span>
<a href="#l230.522"></a><span id="l230.522" class="difflineminus">-            if (this.currentTabInfo != this.tabInfo[this.tabContainer.selectedIndex])</span>
<a href="#l230.523"></a><span id="l230.523" class="difflineminus">-            {</span>
<a href="#l230.524"></a><span id="l230.524" class="difflineminus">-              if (this.currentTabInfo)</span>
<a href="#l230.525"></a><span id="l230.525" class="difflineminus">-                this.saveCurrentTabState();</span>
<a href="#l230.526"></a><span id="l230.526" class="difflineminus">-              </span>
<a href="#l230.527"></a><span id="l230.527" class="difflineminus">-              let oldTab = this.currentTabInfo;</span>
<a href="#l230.528"></a><span id="l230.528" class="difflineminus">-              let tab = this.currentTabInfo =</span>
<a href="#l230.529"></a><span id="l230.529" class="difflineminus">-                this.tabInfo[this.tabContainer.selectedIndex];</span>
<a href="#l230.530"></a><span id="l230.530" class="difflineminus">-</span>
<a href="#l230.531"></a><span id="l230.531" class="difflineminus">-              this.panelContainer.selectedPanel = tab.panel ||</span>
<a href="#l230.532"></a><span id="l230.532" class="difflineminus">-                                                  tab.mode.tabType.panel;</span>
<a href="#l230.533"></a><span id="l230.533" class="difflineminus">-</span>
<a href="#l230.534"></a><span id="l230.534" class="difflineminus">-              let showTabFunc = tab.mode.showTab || tab.mode.tabType.showTab;</span>
<a href="#l230.535"></a><span id="l230.535" class="difflineminus">-              showTabFunc.call(tab.mode.tabType, tab);</span>
<a href="#l230.536"></a><span id="l230.536" class="difflineminus">-</span>
<a href="#l230.537"></a><span id="l230.537" class="difflineminus">-              if (this.tabMonitors.length) {</span>
<a href="#l230.538"></a><span id="l230.538" class="difflineminus">-                for each (let [i, tabMonitor] in Iterator(this.tabMonitors))</span>
<a href="#l230.539"></a><span id="l230.539" class="difflineminus">-                  tabMonitor.onTabSwitched(tab, oldTab);</span>
<a href="#l230.540"></a><span id="l230.540" class="difflineminus">-              }</span>
<a href="#l230.541"></a><span id="l230.541" class="difflineminus">-</span>
<a href="#l230.542"></a><span id="l230.542" class="difflineminus">-</span>
<a href="#l230.543"></a><span id="l230.543" class="difflineminus">-              let docTitle = tab.title;</span>
<a href="#l230.544"></a><span id="l230.544" class="difflineminus">-#ifndef XP_MACOSX</span>
<a href="#l230.545"></a><span id="l230.545" class="difflineminus">-              docTitle += &quot; - &quot; + gBrandBundle.getString(&quot;brandFullName&quot;);</span>
<a href="#l230.546"></a><span id="l230.546" class="difflineminus">-#endif</span>
<a href="#l230.547"></a><span id="l230.547" class="difflineminus">-              document.title = docTitle;</span>
<a href="#l230.548"></a><span id="l230.548" class="difflineminus">-</span>
<a href="#l230.549"></a><span id="l230.549" class="difflineminus">-              // Update the toolbar status - we don't need to do menus as they</span>
<a href="#l230.550"></a><span id="l230.550" class="difflineminus">-              // do themselves when we open them.</span>
<a href="#l230.551"></a><span id="l230.551" class="difflineminus">-              UpdateMailToolbar(&quot;tabmail&quot;);</span>
<a href="#l230.552"></a><span id="l230.552" class="difflineminus">-            }</span>
<a href="#l230.553"></a><span id="l230.553" class="difflineminus">-          ]]&gt;</span>
<a href="#l230.554"></a><span id="l230.554" class="difflineminus">-        &lt;/body&gt;</span>
<a href="#l230.555"></a><span id="l230.555" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l230.556"></a><span id="l230.556" class="difflineminus">-      &lt;method name=&quot;saveCurrentTabState&quot;&gt;</span>
<a href="#l230.557"></a><span id="l230.557" class="difflineminus">-        &lt;body&gt;</span>
<a href="#l230.558"></a><span id="l230.558" class="difflineminus">-          &lt;![CDATA[</span>
<a href="#l230.559"></a><span id="l230.559" class="difflineminus">-            if (!this.currentTabInfo)</span>
<a href="#l230.560"></a><span id="l230.560" class="difflineminus">-              this.currentTabInfo = this.tabInfo[0];</span>
<a href="#l230.561"></a><span id="l230.561" class="difflineminus">-            let tab = this.currentTabInfo;</span>
<a href="#l230.562"></a><span id="l230.562" class="difflineminus">-            </span>
<a href="#l230.563"></a><span id="l230.563" class="difflineminus">-            // save the old tab state before we change the current tab</span>
<a href="#l230.564"></a><span id="l230.564" class="difflineminus">-            let saveTabFunc = tab.mode.saveTabState ||</span>
<a href="#l230.565"></a><span id="l230.565" class="difflineminus">-                              tab.mode.tabType.saveTabState;</span>
<a href="#l230.566"></a><span id="l230.566" class="difflineminus">-            saveTabFunc.call(tab.mode.tabType, tab);</span>
<a href="#l230.567"></a><span id="l230.567" class="difflineminus">-          ]]&gt;</span>
<a href="#l230.568"></a><span id="l230.568" class="difflineminus">-        &lt;/body&gt;</span>
<a href="#l230.569"></a><span id="l230.569" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l230.570"></a><span id="l230.570" class="difflineminus">-      &lt;method name=&quot;onTabClick&quot;&gt;</span>
<a href="#l230.571"></a><span id="l230.571" class="difflineminus">-        &lt;parameter name=&quot;event&quot;/&gt;</span>
<a href="#l230.572"></a><span id="l230.572" class="difflineminus">-        &lt;body&gt;</span>
<a href="#l230.573"></a><span id="l230.573" class="difflineminus">-          &lt;![CDATA[</span>
<a href="#l230.574"></a><span id="l230.574" class="difflineminus">-            // a middle mouse button click on a tab is a short cut for closing a tab</span>
<a href="#l230.575"></a><span id="l230.575" class="difflineminus">-            if (event.button != 1 || event.target.localName != 'tab')</span>
<a href="#l230.576"></a><span id="l230.576" class="difflineminus">-              return;</span>
<a href="#l230.577"></a><span id="l230.577" class="difflineminus">-            this.removeTabByNode(event.target);</span>
<a href="#l230.578"></a><span id="l230.578" class="difflineminus">-            event.stopPropagation();</span>
<a href="#l230.579"></a><span id="l230.579" class="difflineminus">-          ]]&gt;</span>
<a href="#l230.580"></a><span id="l230.580" class="difflineminus">-        &lt;/body&gt;</span>
<a href="#l230.581"></a><span id="l230.581" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l230.582"></a><span id="l230.582" class="difflineminus">-      &lt;method name=&quot;setTabTitle&quot;&gt;</span>
<a href="#l230.583"></a><span id="l230.583" class="difflineminus">-        &lt;parameter name=&quot;aTab&quot;/&gt;</span>
<a href="#l230.584"></a><span id="l230.584" class="difflineminus">-        &lt;body&gt;</span>
<a href="#l230.585"></a><span id="l230.585" class="difflineminus">-          &lt;![CDATA[</span>
<a href="#l230.586"></a><span id="l230.586" class="difflineminus">-            // First find the tab and its index.</span>
<a href="#l230.587"></a><span id="l230.587" class="difflineminus">-            let tab;</span>
<a href="#l230.588"></a><span id="l230.588" class="difflineminus">-            let index;</span>
<a href="#l230.589"></a><span id="l230.589" class="difflineminus">-            if (aTab) {</span>
<a href="#l230.590"></a><span id="l230.590" class="difflineminus">-              tab = aTab;</span>
<a href="#l230.591"></a><span id="l230.591" class="difflineminus">-              for (index = 0; index &lt; this.tabInfo.length; ++index) {</span>
<a href="#l230.592"></a><span id="l230.592" class="difflineminus">-                if (tab == this.tabInfo[index])</span>
<a href="#l230.593"></a><span id="l230.593" class="difflineminus">-                  break;</span>
<a href="#l230.594"></a><span id="l230.594" class="difflineminus">-              }</span>
<a href="#l230.595"></a><span id="l230.595" class="difflineminus">-            }</span>
<a href="#l230.596"></a><span id="l230.596" class="difflineminus">-            else {</span>
<a href="#l230.597"></a><span id="l230.597" class="difflineminus">-              index = this.tabContainer.selectedIndex;</span>
<a href="#l230.598"></a><span id="l230.598" class="difflineminus">-              tab = this.tabInfo[index];</span>
<a href="#l230.599"></a><span id="l230.599" class="difflineminus">-            }</span>
<a href="#l230.600"></a><span id="l230.600" class="difflineminus">-</span>
<a href="#l230.601"></a><span id="l230.601" class="difflineminus">-            // on startup, we may not have a tab...</span>
<a href="#l230.602"></a><span id="l230.602" class="difflineminus">-            if (tab)</span>
<a href="#l230.603"></a><span id="l230.603" class="difflineminus">-            {</span>
<a href="#l230.604"></a><span id="l230.604" class="difflineminus">-              let tabNode =</span>
<a href="#l230.605"></a><span id="l230.605" class="difflineminus">-                this.tabContainer.childNodes[index];</span>
<a href="#l230.606"></a><span id="l230.606" class="difflineminus">-</span>
<a href="#l230.607"></a><span id="l230.607" class="difflineminus">-              let titleChangeFunc = tab.mode.onTitleChanged ||</span>
<a href="#l230.608"></a><span id="l230.608" class="difflineminus">-                                    tab.mode.tabType.onTitleChanged;</span>
<a href="#l230.609"></a><span id="l230.609" class="difflineminus">-              if (titleChangeFunc)</span>
<a href="#l230.610"></a><span id="l230.610" class="difflineminus">-                titleChangeFunc.call(tab.mode.tabType, tab, tabNode);</span>
<a href="#l230.611"></a><span id="l230.611" class="difflineminus">-</span>
<a href="#l230.612"></a><span id="l230.612" class="difflineminus">-              if (this.tabMonitors.length) {</span>
<a href="#l230.613"></a><span id="l230.613" class="difflineminus">-                for each (let [index, tabMonitor] in Iterator(this.tabMonitors))</span>
<a href="#l230.614"></a><span id="l230.614" class="difflineminus">-                  tabMonitor.onTabTitleChanged(tab);</span>
<a href="#l230.615"></a><span id="l230.615" class="difflineminus">-              }</span>
<a href="#l230.616"></a><span id="l230.616" class="difflineminus">-</span>
<a href="#l230.617"></a><span id="l230.617" class="difflineminus">-              tabNode.setAttribute(&quot;label&quot;, tab.title);</span>
<a href="#l230.618"></a><span id="l230.618" class="difflineminus">-</span>
<a href="#l230.619"></a><span id="l230.619" class="difflineminus">-              // Update the window title if we're the displayed tab.</span>
<a href="#l230.620"></a><span id="l230.620" class="difflineminus">-              if (index == this.tabContainer.selectedIndex) {</span>
<a href="#l230.621"></a><span id="l230.621" class="difflineminus">-                let docTitle = tab.title;</span>
<a href="#l230.622"></a><span id="l230.622" class="difflineminus">-#ifndef XP_MACOSX</span>
<a href="#l230.623"></a><span id="l230.623" class="difflineminus">-                docTitle += &quot; - &quot; + gBrandBundle.getString(&quot;brandFullName&quot;);</span>
<a href="#l230.624"></a><span id="l230.624" class="difflineminus">-#endif</span>
<a href="#l230.625"></a><span id="l230.625" class="difflineminus">-                document.title = docTitle;</span>
<a href="#l230.626"></a><span id="l230.626" class="difflineminus">-              }</span>
<a href="#l230.627"></a><span id="l230.627" class="difflineminus">-            }</span>
<a href="#l230.628"></a><span id="l230.628" class="difflineminus">-          ]]&gt;</span>
<a href="#l230.629"></a><span id="l230.629" class="difflineminus">-        &lt;/body&gt;</span>
<a href="#l230.630"></a><span id="l230.630" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l230.631"></a><span id="l230.631" class="difflineminus">-      &lt;method name=&quot;onTabContextMenuShowing&quot;&gt;</span>
<a href="#l230.632"></a><span id="l230.632" class="difflineminus">-        &lt;parameter name=&quot;aTabNode&quot;/&gt;</span>
<a href="#l230.633"></a><span id="l230.633" class="difflineminus">-        &lt;body&gt;</span>
<a href="#l230.634"></a><span id="l230.634" class="difflineminus">-          &lt;![CDATA[</span>
<a href="#l230.635"></a><span id="l230.635" class="difflineminus">-            // To determine whether the 'Close Tab' context menu should be</span>
<a href="#l230.636"></a><span id="l230.636" class="difflineminus">-            // visible according to the tab node that was being clicked on.</span>
<a href="#l230.637"></a><span id="l230.637" class="difflineminus">-            // If the tab node is not closable, the context menu should not</span>
<a href="#l230.638"></a><span id="l230.638" class="difflineminus">-            // be shown.</span>
<a href="#l230.639"></a><span id="l230.639" class="difflineminus">-            if (aTabNode.localName != &quot;tab&quot;)</span>
<a href="#l230.640"></a><span id="l230.640" class="difflineminus">-              return false;</span>
<a href="#l230.641"></a><span id="l230.641" class="difflineminus">-</span>
<a href="#l230.642"></a><span id="l230.642" class="difflineminus">-            for (let iTab = 0; iTab &lt; this.tabContainer.childNodes.length; iTab++) {</span>
<a href="#l230.643"></a><span id="l230.643" class="difflineminus">-              if (this.tabContainer.childNodes[iTab] == aTabNode)</span>
<a href="#l230.644"></a><span id="l230.644" class="difflineminus">-                return this.tabInfo[iTab].canClose;</span>
<a href="#l230.645"></a><span id="l230.645" class="difflineminus">-            }</span>
<a href="#l230.646"></a><span id="l230.646" class="difflineminus">-            return false;</span>
<a href="#l230.647"></a><span id="l230.647" class="difflineminus">-          ]]&gt;</span>
<a href="#l230.648"></a><span id="l230.648" class="difflineminus">-        &lt;/body&gt;</span>
<a href="#l230.649"></a><span id="l230.649" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l230.650"></a><span id="l230.650" class="difflineminus">-      &lt;method name=&quot;supportsCommand&quot;&gt;</span>
<a href="#l230.651"></a><span id="l230.651" class="difflineminus">-        &lt;parameter name=&quot;aCommand&quot;/&gt;</span>
<a href="#l230.652"></a><span id="l230.652" class="difflineminus">-        &lt;body&gt;</span>
<a href="#l230.653"></a><span id="l230.653" class="difflineminus">-           &lt;![CDATA[</span>
<a href="#l230.654"></a><span id="l230.654" class="difflineminus">-             let tab = this.currentTabInfo;</span>
<a href="#l230.655"></a><span id="l230.655" class="difflineminus">-</span>
<a href="#l230.656"></a><span id="l230.656" class="difflineminus">-             // This can happen if we're starting up and haven't got a tab</span>
<a href="#l230.657"></a><span id="l230.657" class="difflineminus">-             // loaded yet.</span>
<a href="#l230.658"></a><span id="l230.658" class="difflineminus">-             if (!tab)</span>
<a href="#l230.659"></a><span id="l230.659" class="difflineminus">-               return false;</span>
<a href="#l230.660"></a><span id="l230.660" class="difflineminus">-</span>
<a href="#l230.661"></a><span id="l230.661" class="difflineminus">-             let supportsCommandFunc = tab.mode.supportsCommand ||</span>
<a href="#l230.662"></a><span id="l230.662" class="difflineminus">-                                       tab.mode.tabType.supportsCommand;</span>
<a href="#l230.663"></a><span id="l230.663" class="difflineminus">-             if (supportsCommandFunc)</span>
<a href="#l230.664"></a><span id="l230.664" class="difflineminus">-               return supportsCommandFunc.call(tab.mode.tabType, tab, aCommand);</span>
<a href="#l230.665"></a><span id="l230.665" class="difflineminus">-</span>
<a href="#l230.666"></a><span id="l230.666" class="difflineminus">-             return false;</span>
<a href="#l230.667"></a><span id="l230.667" class="difflineminus">-           ]]&gt;</span>
<a href="#l230.668"></a><span id="l230.668" class="difflineminus">-        &lt;/body&gt;</span>
<a href="#l230.669"></a><span id="l230.669" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l230.670"></a><span id="l230.670" class="difflineminus">-      &lt;method name=&quot;isCommandEnabled&quot;&gt;</span>
<a href="#l230.671"></a><span id="l230.671" class="difflineminus">-        &lt;parameter name=&quot;aCommand&quot;/&gt;</span>
<a href="#l230.672"></a><span id="l230.672" class="difflineminus">-        &lt;body&gt;</span>
<a href="#l230.673"></a><span id="l230.673" class="difflineminus">-           &lt;![CDATA[</span>
<a href="#l230.674"></a><span id="l230.674" class="difflineminus">-             let tab = this.currentTabInfo;</span>
<a href="#l230.675"></a><span id="l230.675" class="difflineminus">-</span>
<a href="#l230.676"></a><span id="l230.676" class="difflineminus">-             // This can happen if we're starting up and haven't got a tab</span>
<a href="#l230.677"></a><span id="l230.677" class="difflineminus">-             // loaded yet.</span>
<a href="#l230.678"></a><span id="l230.678" class="difflineminus">-             if (!tab)</span>
<a href="#l230.679"></a><span id="l230.679" class="difflineminus">-               return false;</span>
<a href="#l230.680"></a><span id="l230.680" class="difflineminus">-</span>
<a href="#l230.681"></a><span id="l230.681" class="difflineminus">-             let isCommandEnabledFunc = tab.mode.isCommandEnabled ||</span>
<a href="#l230.682"></a><span id="l230.682" class="difflineminus">-                                        tab.mode.tabType.isCommandEnabled;</span>
<a href="#l230.683"></a><span id="l230.683" class="difflineminus">-             if (isCommandEnabledFunc)</span>
<a href="#l230.684"></a><span id="l230.684" class="difflineminus">-               return isCommandEnabledFunc.call(tab.mode.tabType, tab, aCommand);</span>
<a href="#l230.685"></a><span id="l230.685" class="difflineminus">-</span>
<a href="#l230.686"></a><span id="l230.686" class="difflineminus">-             return false;</span>
<a href="#l230.687"></a><span id="l230.687" class="difflineminus">-           ]]&gt;</span>
<a href="#l230.688"></a><span id="l230.688" class="difflineminus">-        &lt;/body&gt;</span>
<a href="#l230.689"></a><span id="l230.689" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l230.690"></a><span id="l230.690" class="difflineminus">-      &lt;method name=&quot;doCommand&quot;&gt;</span>
<a href="#l230.691"></a><span id="l230.691" class="difflineminus">-        &lt;parameter name=&quot;aCommand&quot;/&gt;</span>
<a href="#l230.692"></a><span id="l230.692" class="difflineminus">-        &lt;body&gt;</span>
<a href="#l230.693"></a><span id="l230.693" class="difflineminus">-           &lt;![CDATA[</span>
<a href="#l230.694"></a><span id="l230.694" class="difflineminus">-             let tab = this.currentTabInfo;</span>
<a href="#l230.695"></a><span id="l230.695" class="difflineminus">-</span>
<a href="#l230.696"></a><span id="l230.696" class="difflineminus">-             // This can happen if we're starting up and haven't got a tab</span>
<a href="#l230.697"></a><span id="l230.697" class="difflineminus">-             // loaded yet.</span>
<a href="#l230.698"></a><span id="l230.698" class="difflineminus">-             if (!tab)</span>
<a href="#l230.699"></a><span id="l230.699" class="difflineminus">-               return;</span>
<a href="#l230.700"></a><span id="l230.700" class="difflineminus">-</span>
<a href="#l230.701"></a><span id="l230.701" class="difflineminus">-             let doCommandFunc = tab.mode.doCommand ||</span>
<a href="#l230.702"></a><span id="l230.702" class="difflineminus">-                                 tab.mode.tabType.doCommand;</span>
<a href="#l230.703"></a><span id="l230.703" class="difflineminus">-             if (doCommandFunc)</span>
<a href="#l230.704"></a><span id="l230.704" class="difflineminus">-               doCommandFunc.call(tab.mode.tabType, tab, aCommand);</span>
<a href="#l230.705"></a><span id="l230.705" class="difflineminus">-           ]]&gt;</span>
<a href="#l230.706"></a><span id="l230.706" class="difflineminus">-        &lt;/body&gt;</span>
<a href="#l230.707"></a><span id="l230.707" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l230.708"></a><span id="l230.708" class="difflineminus">-      &lt;method name=&quot;onEvent&quot;&gt;</span>
<a href="#l230.709"></a><span id="l230.709" class="difflineminus">-        &lt;parameter name=&quot;aEvent&quot;/&gt;</span>
<a href="#l230.710"></a><span id="l230.710" class="difflineminus">-        &lt;body&gt;</span>
<a href="#l230.711"></a><span id="l230.711" class="difflineminus">-           &lt;![CDATA[</span>
<a href="#l230.712"></a><span id="l230.712" class="difflineminus">-             let tab = this.currentTabInfo;</span>
<a href="#l230.713"></a><span id="l230.713" class="difflineminus">-</span>
<a href="#l230.714"></a><span id="l230.714" class="difflineminus">-             // This can happen if we're starting up and haven't got a tab</span>
<a href="#l230.715"></a><span id="l230.715" class="difflineminus">-             // loaded yet.</span>
<a href="#l230.716"></a><span id="l230.716" class="difflineminus">-             if (!tab)</span>
<a href="#l230.717"></a><span id="l230.717" class="difflineminus">-               return;</span>
<a href="#l230.718"></a><span id="l230.718" class="difflineminus">-</span>
<a href="#l230.719"></a><span id="l230.719" class="difflineminus">-             let onEventFunc = tab.mode.onEvent ||</span>
<a href="#l230.720"></a><span id="l230.720" class="difflineminus">-                               tab.mode.tabType.onEvent;</span>
<a href="#l230.721"></a><span id="l230.721" class="difflineminus">-             if (onEventFunc)</span>
<a href="#l230.722"></a><span id="l230.722" class="difflineminus">-               return onEventFunc.call(tab.mode.tabType, tab, aEvent);</span>
<a href="#l230.723"></a><span id="l230.723" class="difflineminus">-</span>
<a href="#l230.724"></a><span id="l230.724" class="difflineminus">-             return false;</span>
<a href="#l230.725"></a><span id="l230.725" class="difflineminus">-           ]]&gt;</span>
<a href="#l230.726"></a><span id="l230.726" class="difflineminus">-        &lt;/body&gt;</span>
<a href="#l230.727"></a><span id="l230.727" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l230.728"></a><span id="l230.728" class="difflineminus">-    &lt;/implementation&gt;</span>
<a href="#l230.729"></a><span id="l230.729" class="difflineminus">-  &lt;/binding&gt;</span>
<a href="#l230.730"></a><span id="l230.730" class="difflineminus">-  </span>
<a href="#l230.731"></a><span id="l230.731" class="difflineminus">- &lt;binding id=&quot;tabmail-tab&quot; display=&quot;xul:box&quot;</span>
<a href="#l230.732"></a><span id="l230.732" class="difflineminus">-           extends=&quot;chrome://global/content/bindings/tabbox.xml#tab&quot;&gt;</span>
<a href="#l230.733"></a><span id="l230.733" class="difflineminus">-    &lt;content chromedir=&quot;&amp;locale.dir;&quot;</span>
<a href="#l230.734"></a><span id="l230.734" class="difflineminus">-             closetabtext=&quot;&amp;closeTab.label;&quot;&gt;</span>
<a href="#l230.735"></a><span id="l230.735" class="difflineminus">-      &lt;xul:hbox class=&quot;tab-middle box-inherit&quot; xbl:inherits=&quot;align,dir,pack,orient,selected&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l230.736"></a><span id="l230.736" class="difflineminus">-        &lt;xul:image class=&quot;tab-icon&quot; xbl:inherits=&quot;validate,src=image&quot;/&gt;</span>
<a href="#l230.737"></a><span id="l230.737" class="difflineminus">-        &lt;xul:label class=&quot;tab-text&quot; xbl:inherits=&quot;value=label,accesskey,crop,disabled&quot; flex=&quot;1&quot;/&gt;</span>
<a href="#l230.738"></a><span id="l230.738" class="difflineminus">-      &lt;/xul:hbox&gt;</span>
<a href="#l230.739"></a><span id="l230.739" class="difflineminus">-      &lt;xul:toolbarbutton anonid=&quot;close-button&quot; tabindex=&quot;-1&quot; class=&quot;tab-close-button&quot;/&gt;</span>
<a href="#l230.740"></a><span id="l230.740" class="difflineminus">-    &lt;/content&gt;</span>
<a href="#l230.741"></a><span id="l230.741" class="difflineminus">-</span>
<a href="#l230.742"></a><span id="l230.742" class="difflineminus">-    &lt;implementation&gt;</span>
<a href="#l230.743"></a><span id="l230.743" class="difflineminus">-      &lt;field name=&quot;mOverCloseButton&quot;&gt;false&lt;/field&gt;</span>
<a href="#l230.744"></a><span id="l230.744" class="difflineminus">-      &lt;field name=&quot;mCorrespondingMenuitem&quot;&gt;null&lt;/field&gt;</span>
<a href="#l230.745"></a><span id="l230.745" class="difflineminus">-    &lt;/implementation&gt;</span>
<a href="#l230.746"></a><span id="l230.746" class="difflineminus">-</span>
<a href="#l230.747"></a><span id="l230.747" class="difflineminus">-    &lt;handlers&gt;</span>
<a href="#l230.748"></a><span id="l230.748" class="difflineminus">-      &lt;handler event=&quot;mouseover&quot;&gt;</span>
<a href="#l230.749"></a><span id="l230.749" class="difflineminus">-        var anonid = event.originalTarget.getAttribute(&quot;anonid&quot;);</span>
<a href="#l230.750"></a><span id="l230.750" class="difflineminus">-        if (anonid == &quot;close-button&quot;)</span>
<a href="#l230.751"></a><span id="l230.751" class="difflineminus">-          this.mOverCloseButton = true;</span>
<a href="#l230.752"></a><span id="l230.752" class="difflineminus">-      &lt;/handler&gt;</span>
<a href="#l230.753"></a><span id="l230.753" class="difflineminus">-      &lt;handler event=&quot;mouseout&quot;&gt;</span>
<a href="#l230.754"></a><span id="l230.754" class="difflineminus">-        var anonid = event.originalTarget.getAttribute(&quot;anonid&quot;);</span>
<a href="#l230.755"></a><span id="l230.755" class="difflineminus">-        if (anonid == &quot;close-button&quot;)</span>
<a href="#l230.756"></a><span id="l230.756" class="difflineminus">-          this.mOverCloseButton = false;</span>
<a href="#l230.757"></a><span id="l230.757" class="difflineminus">-      &lt;/handler&gt;</span>
<a href="#l230.758"></a><span id="l230.758" class="difflineminus">-      &lt;handler event=&quot;mousedown&quot; button=&quot;0&quot; phase=&quot;capturing&quot;&gt;</span>
<a href="#l230.759"></a><span id="l230.759" class="difflineminus">-      &lt;![CDATA[</span>
<a href="#l230.760"></a><span id="l230.760" class="difflineminus">-        if (this.mOverCloseButton)</span>
<a href="#l230.761"></a><span id="l230.761" class="difflineminus">-          event.stopPropagation();</span>
<a href="#l230.762"></a><span id="l230.762" class="difflineminus">-      ]]&gt;</span>
<a href="#l230.763"></a><span id="l230.763" class="difflineminus">-      &lt;/handler&gt;</span>
<a href="#l230.764"></a><span id="l230.764" class="difflineminus">-    &lt;/handlers&gt;</span>
<a href="#l230.765"></a><span id="l230.765" class="difflineminus">-  &lt;/binding&gt;</span>
<a href="#l230.766"></a><span id="l230.766" class="difflineminus">-</span>
<a href="#l230.767"></a><span id="l230.767" class="difflineminus">-  &lt;binding id=&quot;tabmail-arrowscrollbox&quot; extends=&quot;chrome://global/content/bindings/scrollbox.xml#arrowscrollbox-clicktoscroll&quot;&gt;</span>
<a href="#l230.768"></a><span id="l230.768" class="difflineminus">-    &lt;content&gt;</span>
<a href="#l230.769"></a><span id="l230.769" class="difflineminus">-      &lt;xul:toolbarbutton class=&quot;scrollbutton-up&quot; collapsed=&quot;true&quot;</span>
<a href="#l230.770"></a><span id="l230.770" class="difflineminus">-                         xbl:inherits=&quot;orient&quot;</span>
<a href="#l230.771"></a><span id="l230.771" class="difflineminus">-                         anonid=&quot;scrollbutton-up&quot;</span>
<a href="#l230.772"></a><span id="l230.772" class="difflineminus">-                         onmousedown=&quot;_startScroll(-1);&quot;</span>
<a href="#l230.773"></a><span id="l230.773" class="difflineminus">-                         onmouseup=&quot;_stopScroll();&quot;</span>
<a href="#l230.774"></a><span id="l230.774" class="difflineminus">-                         onmouseout=&quot;_stopScroll();&quot;</span>
<a href="#l230.775"></a><span id="l230.775" class="difflineminus">-                         chromedir=&quot;&amp;locale.dir;&quot;/&gt;</span>
<a href="#l230.776"></a><span id="l230.776" class="difflineminus">-      &lt;xul:scrollbox xbl:inherits=&quot;orient,align,pack,dir&quot; flex=&quot;1&quot; anonid=&quot;scrollbox&quot;&gt;</span>
<a href="#l230.777"></a><span id="l230.777" class="difflineminus">-        &lt;children/&gt;</span>
<a href="#l230.778"></a><span id="l230.778" class="difflineminus">-      &lt;/xul:scrollbox&gt;</span>
<a href="#l230.779"></a><span id="l230.779" class="difflineminus">-      &lt;xul:stack align=&quot;center&quot; pack=&quot;end&quot; class=&quot;scrollbutton-down-stack&quot;&gt;</span>
<a href="#l230.780"></a><span id="l230.780" class="difflineminus">-        &lt;xul:hbox flex=&quot;1&quot; class=&quot;scrollbutton-down-box&quot; </span>
<a href="#l230.781"></a><span id="l230.781" class="difflineminus">-                           collapsed=&quot;true&quot; anonid=&quot;down-box&quot;/&gt;</span>
<a href="#l230.782"></a><span id="l230.782" class="difflineminus">-        &lt;xul:hbox flex=&quot;1&quot; class=&quot;scrollbutton-down-box-animate&quot; </span>
<a href="#l230.783"></a><span id="l230.783" class="difflineminus">-                           collapsed=&quot;true&quot; anonid=&quot;down-box-animate&quot;/&gt;</span>
<a href="#l230.784"></a><span id="l230.784" class="difflineminus">-        &lt;xul:toolbarbutton class=&quot;scrollbutton-down&quot; collapsed=&quot;true&quot;</span>
<a href="#l230.785"></a><span id="l230.785" class="difflineminus">-                           xbl:inherits=&quot;orient&quot;</span>
<a href="#l230.786"></a><span id="l230.786" class="difflineminus">-                           anonid=&quot;scrollbutton-down&quot;</span>
<a href="#l230.787"></a><span id="l230.787" class="difflineminus">-                           onmousedown=&quot;_startScroll(1);&quot;</span>
<a href="#l230.788"></a><span id="l230.788" class="difflineminus">-                           onmouseup=&quot;_stopScroll();&quot;</span>
<a href="#l230.789"></a><span id="l230.789" class="difflineminus">-                           onmouseout=&quot;_stopScroll();&quot;</span>
<a href="#l230.790"></a><span id="l230.790" class="difflineminus">-                           chromedir=&quot;&amp;locale.dir;&quot;/&gt;</span>
<a href="#l230.791"></a><span id="l230.791" class="difflineminus">-      &lt;/xul:stack&gt;</span>
<a href="#l230.792"></a><span id="l230.792" class="difflineminus">-    &lt;/content&gt;</span>
<a href="#l230.793"></a><span id="l230.793" class="difflineminus">-    &lt;implementation&gt;</span>
<a href="#l230.794"></a><span id="l230.794" class="difflineminus">-      &lt;field name=&quot;_scrollButtonDownBox&quot;&gt;</span>
<a href="#l230.795"></a><span id="l230.795" class="difflineminus">-        document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;down-box&quot;);</span>
<a href="#l230.796"></a><span id="l230.796" class="difflineminus">-      &lt;/field&gt;</span>
<a href="#l230.797"></a><span id="l230.797" class="difflineminus">-      &lt;field name=&quot;_scrollButtonDownBoxAnimate&quot;&gt;</span>
<a href="#l230.798"></a><span id="l230.798" class="difflineminus">-        document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;down-box-animate&quot;);</span>
<a href="#l230.799"></a><span id="l230.799" class="difflineminus">-      &lt;/field&gt;</span>
<a href="#l230.800"></a><span id="l230.800" class="difflineminus">-    &lt;/implementation&gt;</span>
<a href="#l230.801"></a><span id="l230.801" class="difflineminus">-    &lt;handlers&gt;</span>
<a href="#l230.802"></a><span id="l230.802" class="difflineminus">-      &lt;handler event=&quot;underflow&quot;&gt;&lt;![CDATA[</span>
<a href="#l230.803"></a><span id="l230.803" class="difflineminus">-        // filter underflow events which were dispatched on nested scrollboxes</span>
<a href="#l230.804"></a><span id="l230.804" class="difflineminus">-        if (event.target != this)</span>
<a href="#l230.805"></a><span id="l230.805" class="difflineminus">-          return;</span>
<a href="#l230.806"></a><span id="l230.806" class="difflineminus">-</span>
<a href="#l230.807"></a><span id="l230.807" class="difflineminus">-        // Ignore vertical events.</span>
<a href="#l230.808"></a><span id="l230.808" class="difflineminus">-        if (event.detail == 0) {</span>
<a href="#l230.809"></a><span id="l230.809" class="difflineminus">-          return;</span>
<a href="#l230.810"></a><span id="l230.810" class="difflineminus">-        }</span>
<a href="#l230.811"></a><span id="l230.811" class="difflineminus">-</span>
<a href="#l230.812"></a><span id="l230.812" class="difflineminus">-        this._scrollButtonDownBox.collapsed = true;</span>
<a href="#l230.813"></a><span id="l230.813" class="difflineminus">-        this._scrollButtonDownBoxAnimate.collapsed = true;</span>
<a href="#l230.814"></a><span id="l230.814" class="difflineminus">-      ]]&gt;&lt;/handler&gt;</span>
<a href="#l230.815"></a><span id="l230.815" class="difflineminus">-</span>
<a href="#l230.816"></a><span id="l230.816" class="difflineminus">-      &lt;handler event=&quot;overflow&quot;&gt;&lt;![CDATA[</span>
<a href="#l230.817"></a><span id="l230.817" class="difflineminus">-        // filter underflow events which were dispatched on nested scrollboxes</span>
<a href="#l230.818"></a><span id="l230.818" class="difflineminus">-        if (event.target != this)</span>
<a href="#l230.819"></a><span id="l230.819" class="difflineminus">-          return;</span>
<a href="#l230.820"></a><span id="l230.820" class="difflineminus">-</span>
<a href="#l230.821"></a><span id="l230.821" class="difflineminus">-        // Ignore vertical events.</span>
<a href="#l230.822"></a><span id="l230.822" class="difflineminus">-        if (event.detail == 0) {</span>
<a href="#l230.823"></a><span id="l230.823" class="difflineminus">-          return;</span>
<a href="#l230.824"></a><span id="l230.824" class="difflineminus">-        }</span>
<a href="#l230.825"></a><span id="l230.825" class="difflineminus">-</span>
<a href="#l230.826"></a><span id="l230.826" class="difflineminus">-        this._scrollButtonDownBox.collapsed = false;</span>
<a href="#l230.827"></a><span id="l230.827" class="difflineminus">-        this._scrollButtonDownBoxAnimate.collapsed = false;</span>
<a href="#l230.828"></a><span id="l230.828" class="difflineminus">-      ]]&gt;&lt;/handler&gt;</span>
<a href="#l230.829"></a><span id="l230.829" class="difflineminus">-</span>
<a href="#l230.830"></a><span id="l230.830" class="difflineminus">-      &lt;handler event=&quot;UpdatedScrollButtonsDisabledState&quot;&gt;&lt;![CDATA[</span>
<a href="#l230.831"></a><span id="l230.831" class="difflineminus">-        // filter underflow events which were dispatched on nested scrollboxes</span>
<a href="#l230.832"></a><span id="l230.832" class="difflineminus">-        if (event.target != this)</span>
<a href="#l230.833"></a><span id="l230.833" class="difflineminus">-          return;</span>
<a href="#l230.834"></a><span id="l230.834" class="difflineminus">-</span>
<a href="#l230.835"></a><span id="l230.835" class="difflineminus">-        // fix for bug #352353</span>
<a href="#l230.836"></a><span id="l230.836" class="difflineminus">-        // unlike the scrollup button on the tab strip (which is a </span>
<a href="#l230.837"></a><span id="l230.837" class="difflineminus">-        // simple toolbarbutton) the scrolldown button is </span>
<a href="#l230.838"></a><span id="l230.838" class="difflineminus">-        // a more complicated stack of boxes and a toolbarbutton</span>
<a href="#l230.839"></a><span id="l230.839" class="difflineminus">-        // so that we can animate when a tab is opened offscreen.</span>
<a href="#l230.840"></a><span id="l230.840" class="difflineminus">-        // in order to style the box with the actual background image</span>
<a href="#l230.841"></a><span id="l230.841" class="difflineminus">-        // we need to manually set the disable state to match the</span>
<a href="#l230.842"></a><span id="l230.842" class="difflineminus">-        // disable state of the toolbarbutton.</span>
<a href="#l230.843"></a><span id="l230.843" class="difflineminus">-        this._scrollButtonDownBox</span>
<a href="#l230.844"></a><span id="l230.844" class="difflineminus">-            .setAttribute(&quot;disabled&quot;, this._scrollButtonDown.disabled);</span>
<a href="#l230.845"></a><span id="l230.845" class="difflineminus">-      ]]&gt;&lt;/handler&gt;</span>
<a href="#l230.846"></a><span id="l230.846" class="difflineminus">-</span>
<a href="#l230.847"></a><span id="l230.847" class="difflineminus">-    &lt;/handlers&gt;</span>
<a href="#l230.848"></a><span id="l230.848" class="difflineminus">-  &lt;/binding&gt;</span>
<a href="#l230.849"></a><span id="l230.849" class="difflineminus">-</span>
<a href="#l230.850"></a><span id="l230.850" class="difflineminus">-  &lt;binding id=&quot;tabmail-tabs&quot;</span>
<a href="#l230.851"></a><span id="l230.851" class="difflineminus">-           extends=&quot;chrome://global/content/bindings/tabbox.xml#tabs&quot;&gt;</span>
<a href="#l230.852"></a><span id="l230.852" class="difflineminus">-    &lt;content&gt;</span>
<a href="#l230.853"></a><span id="l230.853" class="difflineminus">-      &lt;xul:arrowscrollbox anonid=&quot;arrowscrollbox&quot; class=&quot;tabmail-arrowscrollbox&quot; flex=&quot;1&quot;</span>
<a href="#l230.854"></a><span id="l230.854" class="difflineminus">-                          xbl:inherits=&quot;smoothscroll&quot; orient=&quot;horizontal&quot; style=&quot;min-width: 1px;&quot;&gt;</span>
<a href="#l230.855"></a><span id="l230.855" class="difflineminus">-        &lt;children includes=&quot;tab&quot;/&gt;</span>
<a href="#l230.856"></a><span id="l230.856" class="difflineminus">-      &lt;/xul:arrowscrollbox&gt;</span>
<a href="#l230.857"></a><span id="l230.857" class="difflineminus">-      &lt;children/&gt;</span>
<a href="#l230.858"></a><span id="l230.858" class="difflineminus">-      &lt;xul:stack align=&quot;center&quot; pack=&quot;end&quot; class=&quot;tabs-alltabs-stack&quot;&gt;</span>
<a href="#l230.859"></a><span id="l230.859" class="difflineminus">-        &lt;xul:hbox flex=&quot;1&quot; class=&quot;tabs-alltabs-box&quot; anonid=&quot;alltabs-box&quot;/&gt;</span>
<a href="#l230.860"></a><span id="l230.860" class="difflineminus">-        &lt;xul:hbox flex=&quot;1&quot; class=&quot;tabs-alltabs-box-animate&quot; </span>
<a href="#l230.861"></a><span id="l230.861" class="difflineminus">-                  anonid=&quot;alltabs-box-animate&quot;/&gt;</span>
<a href="#l230.862"></a><span id="l230.862" class="difflineminus">-        &lt;xul:toolbarbutton class=&quot;tabs-alltabs-button&quot; type=&quot;menu&quot;</span>
<a href="#l230.863"></a><span id="l230.863" class="difflineminus">-                           anonid=&quot;alltabs-button&quot;</span>
<a href="#l230.864"></a><span id="l230.864" class="difflineminus">-                           tooltipstring=&quot;&amp;listAllTabs.label;&quot;&gt;</span>
<a href="#l230.865"></a><span id="l230.865" class="difflineminus">-          &lt;xul:menupopup class=&quot;tabs-alltabs-popup&quot;</span>
<a href="#l230.866"></a><span id="l230.866" class="difflineminus">-                         anonid=&quot;alltabs-popup&quot; </span>
<a href="#l230.867"></a><span id="l230.867" class="difflineminus">-                         position=&quot;after_end&quot;/&gt;</span>
<a href="#l230.868"></a><span id="l230.868" class="difflineminus">-        &lt;/xul:toolbarbutton&gt;</span>
<a href="#l230.869"></a><span id="l230.869" class="difflineminus">-      &lt;/xul:stack&gt;</span>
<a href="#l230.870"></a><span id="l230.870" class="difflineminus">-      &lt;xul:hbox class=&quot;tabs-closebutton-box&quot; align=&quot;center&quot; pack=&quot;end&quot; anonid=&quot;tabstrip-closebutton&quot;&gt;</span>
<a href="#l230.871"></a><span id="l230.871" class="difflineminus">-        &lt;xul:toolbarbutton class=&quot;close-button tabs-closebutton&quot;/&gt;</span>
<a href="#l230.872"></a><span id="l230.872" class="difflineminus">-      &lt;/xul:hbox&gt;</span>
<a href="#l230.873"></a><span id="l230.873" class="difflineminus">-    &lt;/content&gt;</span>
<a href="#l230.874"></a><span id="l230.874" class="difflineminus">-    &lt;implementation implements=&quot;nsITimerCallback, nsIDOMEventListener&quot;&gt;</span>
<a href="#l230.875"></a><span id="l230.875" class="difflineminus">-      &lt;constructor&gt;</span>
<a href="#l230.876"></a><span id="l230.876" class="difflineminus">-        &lt;![CDATA[</span>
<a href="#l230.877"></a><span id="l230.877" class="difflineminus">-          var pb2 =</span>
<a href="#l230.878"></a><span id="l230.878" class="difflineminus">-              Components.classes['@mozilla.org/preferences-service;1'].</span>
<a href="#l230.879"></a><span id="l230.879" class="difflineminus">-              getService(Components.interfaces.nsIPrefBranch2);</span>
<a href="#l230.880"></a><span id="l230.880" class="difflineminus">-</span>
<a href="#l230.881"></a><span id="l230.881" class="difflineminus">-          try {</span>
<a href="#l230.882"></a><span id="l230.882" class="difflineminus">-            this.mTabMinWidth = pb2.getIntPref(&quot;mail.tabs.tabMinWidth&quot;);</span>
<a href="#l230.883"></a><span id="l230.883" class="difflineminus">-          } catch (e) {</span>
<a href="#l230.884"></a><span id="l230.884" class="difflineminus">-          }</span>
<a href="#l230.885"></a><span id="l230.885" class="difflineminus">-          try {</span>
<a href="#l230.886"></a><span id="l230.886" class="difflineminus">-            this.mTabMaxWidth = pb2.getIntPref(&quot;mail.tabs.tabMaxWidth&quot;);</span>
<a href="#l230.887"></a><span id="l230.887" class="difflineminus">-          } catch (e) {</span>
<a href="#l230.888"></a><span id="l230.888" class="difflineminus">-          }</span>
<a href="#l230.889"></a><span id="l230.889" class="difflineminus">-          try {</span>
<a href="#l230.890"></a><span id="l230.890" class="difflineminus">-            this.mTabClipWidth = pb2.getIntPref(&quot;mail.tabs.tabClipWidth&quot;);</span>
<a href="#l230.891"></a><span id="l230.891" class="difflineminus">-          } catch (e) {</span>
<a href="#l230.892"></a><span id="l230.892" class="difflineminus">-          }</span>
<a href="#l230.893"></a><span id="l230.893" class="difflineminus">-          try {</span>
<a href="#l230.894"></a><span id="l230.894" class="difflineminus">-            this.mCloseButtons = pb2.getIntPref(&quot;mail.tabs.closeButtons&quot;);</span>
<a href="#l230.895"></a><span id="l230.895" class="difflineminus">-          } catch (e) {</span>
<a href="#l230.896"></a><span id="l230.896" class="difflineminus">-          }</span>
<a href="#l230.897"></a><span id="l230.897" class="difflineminus">-          try {</span>
<a href="#l230.898"></a><span id="l230.898" class="difflineminus">-            this.mAutoHide = pb2.getBoolPref(&quot;mail.tabs.autoHide&quot;);</span>
<a href="#l230.899"></a><span id="l230.899" class="difflineminus">-          } catch (e) {</span>
<a href="#l230.900"></a><span id="l230.900" class="difflineminus">-          }</span>
<a href="#l230.901"></a><span id="l230.901" class="difflineminus">-</span>
<a href="#l230.902"></a><span id="l230.902" class="difflineminus">-          if (this.mAutoHide)</span>
<a href="#l230.903"></a><span id="l230.903" class="difflineminus">-            this.collapsed = true;</span>
<a href="#l230.904"></a><span id="l230.904" class="difflineminus">-</span>
<a href="#l230.905"></a><span id="l230.905" class="difflineminus">-          this.firstChild.minWidth = this.mTabMinWidth;</span>
<a href="#l230.906"></a><span id="l230.906" class="difflineminus">-          this.firstChild.maxWidth = this.mTabMaxWidth;</span>
<a href="#l230.907"></a><span id="l230.907" class="difflineminus">-          this.adjustTabstrip();</span>
<a href="#l230.908"></a><span id="l230.908" class="difflineminus">-</span>
<a href="#l230.909"></a><span id="l230.909" class="difflineminus">-          pb2.addObserver(&quot;mail.tabs.&quot;, this._prefObserver, false);</span>
<a href="#l230.910"></a><span id="l230.910" class="difflineminus">-</span>
<a href="#l230.911"></a><span id="l230.911" class="difflineminus">-          window.addEventListener(&quot;resize&quot;, this, false);</span>
<a href="#l230.912"></a><span id="l230.912" class="difflineminus">-</span>
<a href="#l230.913"></a><span id="l230.913" class="difflineminus">-          // Listen to overflow/underflow events on the tabstrip,</span>
<a href="#l230.914"></a><span id="l230.914" class="difflineminus">-          // we cannot put these as xbl handlers on the entire binding because</span>
<a href="#l230.915"></a><span id="l230.915" class="difflineminus">-          // they would also get called for the all-tabs popup scrollbox.</span>
<a href="#l230.916"></a><span id="l230.916" class="difflineminus">-          // Also, we can't rely on event.target becuase these are all</span>
<a href="#l230.917"></a><span id="l230.917" class="difflineminus">-          // anonymous nodes.</span>
<a href="#l230.918"></a><span id="l230.918" class="difflineminus">-          this.mTabstrip.addEventListener(&quot;overflow&quot;, this, false);</span>
<a href="#l230.919"></a><span id="l230.919" class="difflineminus">-          this.mTabstrip.addEventListener(&quot;underflow&quot;, this, false);</span>
<a href="#l230.920"></a><span id="l230.920" class="difflineminus">-        ]]&gt;</span>
<a href="#l230.921"></a><span id="l230.921" class="difflineminus">-      &lt;/constructor&gt;</span>
<a href="#l230.922"></a><span id="l230.922" class="difflineminus">-</span>
<a href="#l230.923"></a><span id="l230.923" class="difflineminus">-      &lt;destructor&gt;</span>
<a href="#l230.924"></a><span id="l230.924" class="difflineminus">-        &lt;![CDATA[</span>
<a href="#l230.925"></a><span id="l230.925" class="difflineminus">-          var pb2 =</span>
<a href="#l230.926"></a><span id="l230.926" class="difflineminus">-              Components.classes['@mozilla.org/preferences-service;1'].</span>
<a href="#l230.927"></a><span id="l230.927" class="difflineminus">-              getService(Components.interfaces.nsIPrefBranch2);</span>
<a href="#l230.928"></a><span id="l230.928" class="difflineminus">-          pb2.removeObserver(&quot;mail.tabs.&quot;, this._prefObserver);</span>
<a href="#l230.929"></a><span id="l230.929" class="difflineminus">-</span>
<a href="#l230.930"></a><span id="l230.930" class="difflineminus">-          // Release timer to avoid reference cycles.</span>
<a href="#l230.931"></a><span id="l230.931" class="difflineminus">-          if (this._animateTimer) {</span>
<a href="#l230.932"></a><span id="l230.932" class="difflineminus">-            this._animateTimer.cancel();</span>
<a href="#l230.933"></a><span id="l230.933" class="difflineminus">-            this._animateTimer = null;</span>
<a href="#l230.934"></a><span id="l230.934" class="difflineminus">-          }</span>
<a href="#l230.935"></a><span id="l230.935" class="difflineminus">-</span>
<a href="#l230.936"></a><span id="l230.936" class="difflineminus">-          this.mTabstrip.removeEventListener(&quot;overflow&quot;, this, false);</span>
<a href="#l230.937"></a><span id="l230.937" class="difflineminus">-          this.mTabstrip.removeEventListener(&quot;underflow&quot;, this, false);</span>
<a href="#l230.938"></a><span id="l230.938" class="difflineminus">-        ]]&gt;</span>
<a href="#l230.939"></a><span id="l230.939" class="difflineminus">-      &lt;/destructor&gt;</span>
<a href="#l230.940"></a><span id="l230.940" class="difflineminus">-</span>
<a href="#l230.941"></a><span id="l230.941" class="difflineminus">-      &lt;field name=&quot;mTabstripWidth&quot;&gt;0&lt;/field&gt;</span>
<a href="#l230.942"></a><span id="l230.942" class="difflineminus">-</span>
<a href="#l230.943"></a><span id="l230.943" class="difflineminus">-      &lt;field name=&quot;mTabstrip&quot;&gt;</span>
<a href="#l230.944"></a><span id="l230.944" class="difflineminus">-        document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;arrowscrollbox&quot;);</span>
<a href="#l230.945"></a><span id="l230.945" class="difflineminus">-      &lt;/field&gt;</span>
<a href="#l230.946"></a><span id="l230.946" class="difflineminus">-</span>
<a href="#l230.947"></a><span id="l230.947" class="difflineminus">-      &lt;field name=&quot;mTabstripClosebutton&quot;&gt;</span>
<a href="#l230.948"></a><span id="l230.948" class="difflineminus">-        document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;tabstrip-closebutton&quot;);</span>
<a href="#l230.949"></a><span id="l230.949" class="difflineminus">-      &lt;/field&gt;</span>
<a href="#l230.950"></a><span id="l230.950" class="difflineminus">-</span>
<a href="#l230.951"></a><span id="l230.951" class="difflineminus">-      &lt;field name=&quot;_prefObserver&quot;&gt;({</span>
<a href="#l230.952"></a><span id="l230.952" class="difflineminus">-        tabbox: this,</span>
<a href="#l230.953"></a><span id="l230.953" class="difflineminus">-  </span>
<a href="#l230.954"></a><span id="l230.954" class="difflineminus">-        observe: function(subject, topic, data)</span>
<a href="#l230.955"></a><span id="l230.955" class="difflineminus">-        {</span>
<a href="#l230.956"></a><span id="l230.956" class="difflineminus">-          if (topic == &quot;nsPref:changed&quot;) {</span>
<a href="#l230.957"></a><span id="l230.957" class="difflineminus">-            subject.QueryInterface(Components.interfaces.nsIPrefBranch);</span>
<a href="#l230.958"></a><span id="l230.958" class="difflineminus">-            switch (data) {</span>
<a href="#l230.959"></a><span id="l230.959" class="difflineminus">-            case &quot;mail.tabs.closeButtons&quot;:</span>
<a href="#l230.960"></a><span id="l230.960" class="difflineminus">-              this.tabbox.mCloseButtons = subject.getIntPref(&quot;mail.tabs.closeButtons&quot;);</span>
<a href="#l230.961"></a><span id="l230.961" class="difflineminus">-              this.tabbox.adjustTabstrip();</span>
<a href="#l230.962"></a><span id="l230.962" class="difflineminus">-              break;</span>
<a href="#l230.963"></a><span id="l230.963" class="difflineminus">-            case &quot;mail.tabs.autoHide&quot;:</span>
<a href="#l230.964"></a><span id="l230.964" class="difflineminus">-              this.tabbox.mAutoHide = subject.getBoolPref(&quot;mail.tabs.autoHide&quot;);</span>
<a href="#l230.965"></a><span id="l230.965" class="difflineminus">-              break;</span>
<a href="#l230.966"></a><span id="l230.966" class="difflineminus">-            }</span>
<a href="#l230.967"></a><span id="l230.967" class="difflineminus">-          }</span>
<a href="#l230.968"></a><span id="l230.968" class="difflineminus">-        },</span>
<a href="#l230.969"></a><span id="l230.969" class="difflineminus">-  </span>
<a href="#l230.970"></a><span id="l230.970" class="difflineminus">-        QueryInterface: function(aIID)</span>
<a href="#l230.971"></a><span id="l230.971" class="difflineminus">-        {</span>
<a href="#l230.972"></a><span id="l230.972" class="difflineminus">-          if (aIID.equals(Components.interfaces.nsIObserver) ||</span>
<a href="#l230.973"></a><span id="l230.973" class="difflineminus">-              aIID.equals(Components.interfaces.nsISupports))</span>
<a href="#l230.974"></a><span id="l230.974" class="difflineminus">-            return this;</span>
<a href="#l230.975"></a><span id="l230.975" class="difflineminus">-          throw Components.results.NS_NOINTERFACE;</span>
<a href="#l230.976"></a><span id="l230.976" class="difflineminus">-        }</span>
<a href="#l230.977"></a><span id="l230.977" class="difflineminus">-        });</span>
<a href="#l230.978"></a><span id="l230.978" class="difflineminus">-      &lt;/field&gt;</span>
<a href="#l230.979"></a><span id="l230.979" class="difflineminus">-      &lt;field name=&quot;mTabMinWidth&quot;&gt;100&lt;/field&gt;</span>
<a href="#l230.980"></a><span id="l230.980" class="difflineminus">-      &lt;field name=&quot;mTabMaxWidth&quot;&gt;250&lt;/field&gt;</span>
<a href="#l230.981"></a><span id="l230.981" class="difflineminus">-      &lt;field name=&quot;mTabClipWidth&quot;&gt;140&lt;/field&gt;</span>
<a href="#l230.982"></a><span id="l230.982" class="difflineminus">-      &lt;field name=&quot;mCloseButtons&quot;&gt;1&lt;/field&gt;</span>
<a href="#l230.983"></a><span id="l230.983" class="difflineminus">-</span>
<a href="#l230.984"></a><span id="l230.984" class="difflineminus">-      &lt;field name=&quot;_mAutoHide&quot;&gt;false&lt;/field&gt;</span>
<a href="#l230.985"></a><span id="l230.985" class="difflineminus">-      &lt;property name=&quot;mAutoHide&quot; onget=&quot;return this._mAutoHide;&quot;&gt;</span>
<a href="#l230.986"></a><span id="l230.986" class="difflineminus">-        &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l230.987"></a><span id="l230.987" class="difflineminus">-          if (val != this._mAutoHide) {</span>
<a href="#l230.988"></a><span id="l230.988" class="difflineminus">-            if (this.childNodes.length == 1)</span>
<a href="#l230.989"></a><span id="l230.989" class="difflineminus">-              this.collapsed = val;</span>
<a href="#l230.990"></a><span id="l230.990" class="difflineminus">-            this._mAutoHide = val;</span>
<a href="#l230.991"></a><span id="l230.991" class="difflineminus">-          }</span>
<a href="#l230.992"></a><span id="l230.992" class="difflineminus">-          return val;</span>
<a href="#l230.993"></a><span id="l230.993" class="difflineminus">-        ]]&gt;&lt;/setter&gt;</span>
<a href="#l230.994"></a><span id="l230.994" class="difflineminus">-      &lt;/property&gt;</span>
<a href="#l230.995"></a><span id="l230.995" class="difflineminus">-</span>
<a href="#l230.996"></a><span id="l230.996" class="difflineminus">-      &lt;method name=&quot;adjustTabstrip&quot;&gt;</span>
<a href="#l230.997"></a><span id="l230.997" class="difflineminus">-        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l230.998"></a><span id="l230.998" class="difflineminus">-          // modes for tabstrip</span>
<a href="#l230.999"></a><span id="l230.999" class="difflineminus">-          // 0 - activetab  = close button on active tab only</span>
<a href="#l230.1000"></a><span id="l230.1000" class="difflineminus">-          // 1 - alltabs    = close buttons on all tabs</span>
<a href="#l230.1001"></a><span id="l230.1001" class="difflineminus">-          // 2 - noclose    = no close buttons at all</span>
<a href="#l230.1002"></a><span id="l230.1002" class="difflineminus">-          // 3 - closeatend = close button at the end of the tabstrip</span>
<a href="#l230.1003"></a><span id="l230.1003" class="difflineminus">-          switch (this.mCloseButtons) {</span>
<a href="#l230.1004"></a><span id="l230.1004" class="difflineminus">-          case 0:</span>
<a href="#l230.1005"></a><span id="l230.1005" class="difflineminus">-            this.setAttribute(&quot;closebuttons&quot;, &quot;activetab&quot;);</span>
<a href="#l230.1006"></a><span id="l230.1006" class="difflineminus">-            break;</span>
<a href="#l230.1007"></a><span id="l230.1007" class="difflineminus">-          case 1:</span>
<a href="#l230.1008"></a><span id="l230.1008" class="difflineminus">-            var width = this.firstChild.boxObject.width;</span>
<a href="#l230.1009"></a><span id="l230.1009" class="difflineminus">-            // 0 width is an invalid value and indicates</span>
<a href="#l230.1010"></a><span id="l230.1010" class="difflineminus">-            // an item without display, so ignore.</span>
<a href="#l230.1011"></a><span id="l230.1011" class="difflineminus">-            if (width &gt; this.mTabClipWidth || width == 0)</span>
<a href="#l230.1012"></a><span id="l230.1012" class="difflineminus">-              this.setAttribute(&quot;closebuttons&quot;, &quot;alltabs&quot;);</span>
<a href="#l230.1013"></a><span id="l230.1013" class="difflineminus">-            else</span>
<a href="#l230.1014"></a><span id="l230.1014" class="difflineminus">-              this.setAttribute(&quot;closebuttons&quot;, &quot;activetab&quot;);</span>
<a href="#l230.1015"></a><span id="l230.1015" class="difflineminus">-            break;</span>
<a href="#l230.1016"></a><span id="l230.1016" class="difflineminus">-          case 2:</span>
<a href="#l230.1017"></a><span id="l230.1017" class="difflineminus">-          case 3:</span>
<a href="#l230.1018"></a><span id="l230.1018" class="difflineminus">-            this.setAttribute(&quot;closebuttons&quot;, &quot;noclose&quot;);</span>
<a href="#l230.1019"></a><span id="l230.1019" class="difflineminus">-            break;</span>
<a href="#l230.1020"></a><span id="l230.1020" class="difflineminus">-          }</span>
<a href="#l230.1021"></a><span id="l230.1021" class="difflineminus">-          this.mTabstripClosebutton.collapsed = this.mCloseButtons != 3;</span>
<a href="#l230.1022"></a><span id="l230.1022" class="difflineminus">-        ]]&gt;&lt;/body&gt;</span>
<a href="#l230.1023"></a><span id="l230.1023" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l230.1024"></a><span id="l230.1024" class="difflineminus">-        </span>
<a href="#l230.1025"></a><span id="l230.1025" class="difflineminus">-      &lt;field name=&quot;_mPrefs&quot;&gt;null&lt;/field&gt;</span>
<a href="#l230.1026"></a><span id="l230.1026" class="difflineminus">-      &lt;property name=&quot;mPrefs&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l230.1027"></a><span id="l230.1027" class="difflineminus">-        &lt;getter&gt;</span>
<a href="#l230.1028"></a><span id="l230.1028" class="difflineminus">-        &lt;![CDATA[</span>
<a href="#l230.1029"></a><span id="l230.1029" class="difflineminus">-          if (!this._mPrefs) {</span>
<a href="#l230.1030"></a><span id="l230.1030" class="difflineminus">-            this._mPrefs =</span>
<a href="#l230.1031"></a><span id="l230.1031" class="difflineminus">-              Components.classes['@mozilla.org/preferences-service;1'].</span>
<a href="#l230.1032"></a><span id="l230.1032" class="difflineminus">-              getService(Components.interfaces.nsIPrefBranch2);</span>
<a href="#l230.1033"></a><span id="l230.1033" class="difflineminus">-          }</span>
<a href="#l230.1034"></a><span id="l230.1034" class="difflineminus">-          return this._mPrefs;</span>
<a href="#l230.1035"></a><span id="l230.1035" class="difflineminus">-        ]]&gt;</span>
<a href="#l230.1036"></a><span id="l230.1036" class="difflineminus">-        &lt;/getter&gt;</span>
<a href="#l230.1037"></a><span id="l230.1037" class="difflineminus">-      &lt;/property&gt;</span>
<a href="#l230.1038"></a><span id="l230.1038" class="difflineminus">-        </span>
<a href="#l230.1039"></a><span id="l230.1039" class="difflineminus">-      &lt;method name=&quot;_handleTabSelect&quot;&gt;</span>
<a href="#l230.1040"></a><span id="l230.1040" class="difflineminus">-        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l230.1041"></a><span id="l230.1041" class="difflineminus">-          this.mTabstrip.ensureElementIsVisible(this.selectedItem);</span>
<a href="#l230.1042"></a><span id="l230.1042" class="difflineminus">-        ]]&gt;&lt;/body&gt;</span>
<a href="#l230.1043"></a><span id="l230.1043" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l230.1044"></a><span id="l230.1044" class="difflineminus">-</span>
<a href="#l230.1045"></a><span id="l230.1045" class="difflineminus">-      &lt;method name=&quot;handleEvent&quot;&gt;</span>
<a href="#l230.1046"></a><span id="l230.1046" class="difflineminus">-        &lt;parameter name=&quot;aEvent&quot;/&gt;</span>
<a href="#l230.1047"></a><span id="l230.1047" class="difflineminus">-        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l230.1048"></a><span id="l230.1048" class="difflineminus">-          switch (aEvent.type) {</span>
<a href="#l230.1049"></a><span id="l230.1049" class="difflineminus">-            case &quot;overflow&quot;:</span>
<a href="#l230.1050"></a><span id="l230.1050" class="difflineminus">-              this.setAttribute(&quot;overflow&quot;, &quot;true&quot;);</span>
<a href="#l230.1051"></a><span id="l230.1051" class="difflineminus">-              this.mTabstrip.scrollBoxObject</span>
<a href="#l230.1052"></a><span id="l230.1052" class="difflineminus">-                            .ensureElementIsVisible(this.selectedItem);</span>
<a href="#l230.1053"></a><span id="l230.1053" class="difflineminus">-              break;</span>
<a href="#l230.1054"></a><span id="l230.1054" class="difflineminus">-            case &quot;underflow&quot;:</span>
<a href="#l230.1055"></a><span id="l230.1055" class="difflineminus">-              this.removeAttribute(&quot;overflow&quot;);</span>
<a href="#l230.1056"></a><span id="l230.1056" class="difflineminus">-              break;</span>
<a href="#l230.1057"></a><span id="l230.1057" class="difflineminus">-            case &quot;resize&quot;:</span>
<a href="#l230.1058"></a><span id="l230.1058" class="difflineminus">-              var width = this.mTabstrip.boxObject.width;</span>
<a href="#l230.1059"></a><span id="l230.1059" class="difflineminus">-              if (width != this.mTabstripWidth) {</span>
<a href="#l230.1060"></a><span id="l230.1060" class="difflineminus">-                this.adjustTabstrip();</span>
<a href="#l230.1061"></a><span id="l230.1061" class="difflineminus">-                // XXX without this line the tab bar won't budge</span>
<a href="#l230.1062"></a><span id="l230.1062" class="difflineminus">-                this.mTabstrip.scrollByPixels(1);</span>
<a href="#l230.1063"></a><span id="l230.1063" class="difflineminus">-                this._handleTabSelect();</span>
<a href="#l230.1064"></a><span id="l230.1064" class="difflineminus">-                this.mTabstripWidth = width;</span>
<a href="#l230.1065"></a><span id="l230.1065" class="difflineminus">-              }</span>
<a href="#l230.1066"></a><span id="l230.1066" class="difflineminus">-              break;</span>
<a href="#l230.1067"></a><span id="l230.1067" class="difflineminus">-          }</span>
<a href="#l230.1068"></a><span id="l230.1068" class="difflineminus">-        ]]&gt;&lt;/body&gt;</span>
<a href="#l230.1069"></a><span id="l230.1069" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l230.1070"></a><span id="l230.1070" class="difflineminus">-</span>
<a href="#l230.1071"></a><span id="l230.1071" class="difflineminus">-      &lt;field name=&quot;mAllTabsPopup&quot;&gt;</span>
<a href="#l230.1072"></a><span id="l230.1072" class="difflineminus">-        document.getAnonymousElementByAttribute(this, </span>
<a href="#l230.1073"></a><span id="l230.1073" class="difflineminus">-                                                &quot;anonid&quot;, &quot;alltabs-popup&quot;);</span>
<a href="#l230.1074"></a><span id="l230.1074" class="difflineminus">-      &lt;/field&gt;</span>
<a href="#l230.1075"></a><span id="l230.1075" class="difflineminus">-</span>
<a href="#l230.1076"></a><span id="l230.1076" class="difflineminus">-      &lt;field name=&quot;mAllTabsBoxAnimate&quot;&gt;</span>
<a href="#l230.1077"></a><span id="l230.1077" class="difflineminus">-        document.getAnonymousElementByAttribute(this, </span>
<a href="#l230.1078"></a><span id="l230.1078" class="difflineminus">-                                                &quot;anonid&quot;,</span>
<a href="#l230.1079"></a><span id="l230.1079" class="difflineminus">-                                                &quot;alltabs-box-animate&quot;);</span>
<a href="#l230.1080"></a><span id="l230.1080" class="difflineminus">-      &lt;/field&gt;</span>
<a href="#l230.1081"></a><span id="l230.1081" class="difflineminus">-</span>
<a href="#l230.1082"></a><span id="l230.1082" class="difflineminus">-      &lt;field name=&quot;mDownBoxAnimate&quot;&gt;</span>
<a href="#l230.1083"></a><span id="l230.1083" class="difflineminus">-        this.mTabstrip._scrollButtonDownBoxAnimate;</span>
<a href="#l230.1084"></a><span id="l230.1084" class="difflineminus">-      &lt;/field&gt;</span>
<a href="#l230.1085"></a><span id="l230.1085" class="difflineminus">-</span>
<a href="#l230.1086"></a><span id="l230.1086" class="difflineminus">-      &lt;field name=&quot;mAllTabsButton&quot;&gt;</span>
<a href="#l230.1087"></a><span id="l230.1087" class="difflineminus">-        document.getAnonymousElementByAttribute(this, </span>
<a href="#l230.1088"></a><span id="l230.1088" class="difflineminus">-                                                &quot;anonid&quot;, &quot;alltabs-button&quot;);</span>
<a href="#l230.1089"></a><span id="l230.1089" class="difflineminus">-      &lt;/field&gt;</span>
<a href="#l230.1090"></a><span id="l230.1090" class="difflineminus">-</span>
<a href="#l230.1091"></a><span id="l230.1091" class="difflineminus">-      &lt;field name=&quot;_animateTimer&quot;&gt;null&lt;/field&gt;</span>
<a href="#l230.1092"></a><span id="l230.1092" class="difflineminus">-      &lt;field name=&quot;_animateStep&quot;&gt;-1&lt;/field&gt;</span>
<a href="#l230.1093"></a><span id="l230.1093" class="difflineminus">-      &lt;field name=&quot;_animateDelay&quot;&gt;25&lt;/field&gt;</span>
<a href="#l230.1094"></a><span id="l230.1094" class="difflineminus">-      &lt;field name=&quot;_animatePercents&quot;&gt;</span>
<a href="#l230.1095"></a><span id="l230.1095" class="difflineminus">-       [1.00, 0.85, 0.80, 0.75, 0.71, 0.68, 0.65, 0.62, 0.59, 0.57,</span>
<a href="#l230.1096"></a><span id="l230.1096" class="difflineminus">-        0.54, 0.52, 0.50, 0.47, 0.45, 0.44, 0.42, 0.40, 0.38, 0.37,</span>
<a href="#l230.1097"></a><span id="l230.1097" class="difflineminus">-        0.35, 0.34, 0.32, 0.31, 0.30, 0.29, 0.28, 0.27, 0.26, 0.25,</span>
<a href="#l230.1098"></a><span id="l230.1098" class="difflineminus">-        0.24, 0.23, 0.23, 0.22, 0.22, 0.21, 0.21, 0.21, 0.20, 0.20,</span>
<a href="#l230.1099"></a><span id="l230.1099" class="difflineminus">-        0.20, 0.20, 0.20, 0.20, 0.20, 0.20, 0.19, 0.19, 0.19, 0.18,</span>
<a href="#l230.1100"></a><span id="l230.1100" class="difflineminus">-        0.18, 0.17, 0.17, 0.16, 0.15, 0.14, 0.13, 0.11, 0.09, 0.06]</span>
<a href="#l230.1101"></a><span id="l230.1101" class="difflineminus">-      &lt;/field&gt;</span>
<a href="#l230.1102"></a><span id="l230.1102" class="difflineminus">-</span>
<a href="#l230.1103"></a><span id="l230.1103" class="difflineminus">-      &lt;method name=&quot;_stopAnimation&quot;&gt;</span>
<a href="#l230.1104"></a><span id="l230.1104" class="difflineminus">-        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l230.1105"></a><span id="l230.1105" class="difflineminus">-          if (this._animateStep != -1) {</span>
<a href="#l230.1106"></a><span id="l230.1106" class="difflineminus">-            if (this._animateTimer)</span>
<a href="#l230.1107"></a><span id="l230.1107" class="difflineminus">-              this._animateTimer.cancel();</span>
<a href="#l230.1108"></a><span id="l230.1108" class="difflineminus">-</span>
<a href="#l230.1109"></a><span id="l230.1109" class="difflineminus">-            this._animateStep = -1;</span>
<a href="#l230.1110"></a><span id="l230.1110" class="difflineminus">-            this.mAllTabsBoxAnimate.style.opacity = 0.0;</span>
<a href="#l230.1111"></a><span id="l230.1111" class="difflineminus">-            this.mDownBoxAnimate.style.opacity = 0.0;</span>
<a href="#l230.1112"></a><span id="l230.1112" class="difflineminus">-          }</span>
<a href="#l230.1113"></a><span id="l230.1113" class="difflineminus">-        ]]&gt;&lt;/body&gt;</span>
<a href="#l230.1114"></a><span id="l230.1114" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l230.1115"></a><span id="l230.1115" class="difflineminus">-      </span>
<a href="#l230.1116"></a><span id="l230.1116" class="difflineminus">-      &lt;method name=&quot;_notifyBackgroundTab&quot;&gt;</span>
<a href="#l230.1117"></a><span id="l230.1117" class="difflineminus">-        &lt;parameter name=&quot;aTab&quot;/&gt;</span>
<a href="#l230.1118"></a><span id="l230.1118" class="difflineminus">-        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l230.1119"></a><span id="l230.1119" class="difflineminus">-          var tsbo = this.mTabstrip.scrollBoxObject;</span>
<a href="#l230.1120"></a><span id="l230.1120" class="difflineminus">-          var tsboStart = tsbo.screenX;</span>
<a href="#l230.1121"></a><span id="l230.1121" class="difflineminus">-          var tsboEnd = tsboStart + tsbo.width;</span>
<a href="#l230.1122"></a><span id="l230.1122" class="difflineminus">-</span>
<a href="#l230.1123"></a><span id="l230.1123" class="difflineminus">-          var ctbo = aTab.boxObject;</span>
<a href="#l230.1124"></a><span id="l230.1124" class="difflineminus">-          var ctboStart = ctbo.screenX;</span>
<a href="#l230.1125"></a><span id="l230.1125" class="difflineminus">-          var ctboEnd = ctboStart + ctbo.width;</span>
<a href="#l230.1126"></a><span id="l230.1126" class="difflineminus">-</span>
<a href="#l230.1127"></a><span id="l230.1127" class="difflineminus">-          // only start the flash timer if the new tab (which was loaded in</span>
<a href="#l230.1128"></a><span id="l230.1128" class="difflineminus">-          // the background) is not completely visible</span>
<a href="#l230.1129"></a><span id="l230.1129" class="difflineminus">-          if (tsboStart &gt; ctboStart || ctboEnd &gt; tsboEnd) {</span>
<a href="#l230.1130"></a><span id="l230.1130" class="difflineminus">-            this._animateStep = 0;</span>
<a href="#l230.1131"></a><span id="l230.1131" class="difflineminus">-</span>
<a href="#l230.1132"></a><span id="l230.1132" class="difflineminus">-            if (!this._animateTimer) </span>
<a href="#l230.1133"></a><span id="l230.1133" class="difflineminus">-              this._animateTimer =</span>
<a href="#l230.1134"></a><span id="l230.1134" class="difflineminus">-                Components.classes[&quot;@mozilla.org/timer;1&quot;]</span>
<a href="#l230.1135"></a><span id="l230.1135" class="difflineminus">-                          .createInstance(Components.interfaces.nsITimer);</span>
<a href="#l230.1136"></a><span id="l230.1136" class="difflineminus">-            else</span>
<a href="#l230.1137"></a><span id="l230.1137" class="difflineminus">-               this._animateTimer.cancel();</span>
<a href="#l230.1138"></a><span id="l230.1138" class="difflineminus">-</span>
<a href="#l230.1139"></a><span id="l230.1139" class="difflineminus">-            this._animateTimer.initWithCallback(this,</span>
<a href="#l230.1140"></a><span id="l230.1140" class="difflineminus">-                         this._animateDelay,</span>
<a href="#l230.1141"></a><span id="l230.1141" class="difflineminus">-                         Components.interfaces.nsITimer.TYPE_REPEATING_SLACK);</span>
<a href="#l230.1142"></a><span id="l230.1142" class="difflineminus">-          }</span>
<a href="#l230.1143"></a><span id="l230.1143" class="difflineminus">-        ]]&gt;&lt;/body&gt;</span>
<a href="#l230.1144"></a><span id="l230.1144" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l230.1145"></a><span id="l230.1145" class="difflineminus">-      </span>
<a href="#l230.1146"></a><span id="l230.1146" class="difflineminus">-      &lt;method name=&quot;notify&quot;&gt;</span>
<a href="#l230.1147"></a><span id="l230.1147" class="difflineminus">-        &lt;parameter name=&quot;aTimer&quot;/&gt;</span>
<a href="#l230.1148"></a><span id="l230.1148" class="difflineminus">-        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l230.1149"></a><span id="l230.1149" class="difflineminus">-          if (!document)</span>
<a href="#l230.1150"></a><span id="l230.1150" class="difflineminus">-            aTimer.cancel();</span>
<a href="#l230.1151"></a><span id="l230.1151" class="difflineminus">-</span>
<a href="#l230.1152"></a><span id="l230.1152" class="difflineminus">-          var percent = this._animatePercents[this._animateStep];</span>
<a href="#l230.1153"></a><span id="l230.1153" class="difflineminus">-          this.mAllTabsBoxAnimate.style.opacity = percent;</span>
<a href="#l230.1154"></a><span id="l230.1154" class="difflineminus">-          this.mDownBoxAnimate.style.opacity = percent;</span>
<a href="#l230.1155"></a><span id="l230.1155" class="difflineminus">-</span>
<a href="#l230.1156"></a><span id="l230.1156" class="difflineminus">-          if (this._animateStep &lt; (this._animatePercents.length - 1))</span>
<a href="#l230.1157"></a><span id="l230.1157" class="difflineminus">-            this._animateStep++;</span>
<a href="#l230.1158"></a><span id="l230.1158" class="difflineminus">-          else</span>
<a href="#l230.1159"></a><span id="l230.1159" class="difflineminus">-            this._stopAnimation();</span>
<a href="#l230.1160"></a><span id="l230.1160" class="difflineminus">-        ]]&gt;&lt;/body&gt;</span>
<a href="#l230.1161"></a><span id="l230.1161" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l230.1162"></a><span id="l230.1162" class="difflineminus">-    &lt;/implementation&gt;</span>
<a href="#l230.1163"></a><span id="l230.1163" class="difflineminus">-    &lt;handlers&gt;</span>
<a href="#l230.1164"></a><span id="l230.1164" class="difflineminus">-      &lt;handler event=&quot;TabSelect&quot; action=&quot;this._handleTabSelect();&quot;/&gt;</span>
<a href="#l230.1165"></a><span id="l230.1165" class="difflineminus">-      &lt;handler event=&quot;mouseover&quot;&gt;&lt;![CDATA[</span>
<a href="#l230.1166"></a><span id="l230.1166" class="difflineminus">-        if (event.originalTarget == this.mAllTabsButton) {</span>
<a href="#l230.1167"></a><span id="l230.1167" class="difflineminus">-          this.mAllTabsButton</span>
<a href="#l230.1168"></a><span id="l230.1168" class="difflineminus">-              .setAttribute(&quot;tooltiptext&quot;,</span>
<a href="#l230.1169"></a><span id="l230.1169" class="difflineminus">-                            this.mAllTabsButton.getAttribute(&quot;tooltipstring&quot;));</span>
<a href="#l230.1170"></a><span id="l230.1170" class="difflineminus">-        }</span>
<a href="#l230.1171"></a><span id="l230.1171" class="difflineminus">-        else</span>
<a href="#l230.1172"></a><span id="l230.1172" class="difflineminus">-          this.mAllTabsButton.removeAttribute(&quot;tooltiptext&quot;);</span>
<a href="#l230.1173"></a><span id="l230.1173" class="difflineminus">-      ]]&gt;&lt;/handler&gt;</span>
<a href="#l230.1174"></a><span id="l230.1174" class="difflineminus">-    &lt;/handlers&gt;</span>
<a href="#l230.1175"></a><span id="l230.1175" class="difflineminus">-  &lt;/binding&gt;</span>
<a href="#l230.1176"></a><span id="l230.1176" class="difflineminus">-  </span>
<a href="#l230.1177"></a><span id="l230.1177" class="difflineminus">-  &lt;!-- alltabs-popup binding</span>
<a href="#l230.1178"></a><span id="l230.1178" class="difflineminus">-       This binding relies on the structure of the tabbrowser binding.</span>
<a href="#l230.1179"></a><span id="l230.1179" class="difflineminus">-       Therefore it should only be used as a child of the tabs element.</span>
<a href="#l230.1180"></a><span id="l230.1180" class="difflineminus">-       This binding is exposed as a pseudo-public-API so themes can customize</span>
<a href="#l230.1181"></a><span id="l230.1181" class="difflineminus">-       the tabbar appearance without having to be scriptable</span>
<a href="#l230.1182"></a><span id="l230.1182" class="difflineminus">-       (see globalBindings.xml in Pinstripe for example).</span>
<a href="#l230.1183"></a><span id="l230.1183" class="difflineminus">-  --&gt;</span>
<a href="#l230.1184"></a><span id="l230.1184" class="difflineminus">-  &lt;binding id=&quot;tabmail-alltabs-popup&quot;</span>
<a href="#l230.1185"></a><span id="l230.1185" class="difflineminus">-           extends=&quot;chrome://global/content/bindings/popup.xml#popup&quot;&gt;</span>
<a href="#l230.1186"></a><span id="l230.1186" class="difflineminus">-    &lt;implementation implements=&quot;nsIDOMEventListener&quot;&gt;</span>
<a href="#l230.1187"></a><span id="l230.1187" class="difflineminus">-      &lt;field name=&quot;_xulWindow&quot;&gt;</span>
<a href="#l230.1188"></a><span id="l230.1188" class="difflineminus">-        null</span>
<a href="#l230.1189"></a><span id="l230.1189" class="difflineminus">-      &lt;/field&gt;</span>
<a href="#l230.1190"></a><span id="l230.1190" class="difflineminus">-</span>
<a href="#l230.1191"></a><span id="l230.1191" class="difflineminus">-      &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l230.1192"></a><span id="l230.1192" class="difflineminus">-        // We cannot cache the XULBrowserWindow object itself since it might</span>
<a href="#l230.1193"></a><span id="l230.1193" class="difflineminus">-        // be set after this binding is constructed.</span>
<a href="#l230.1194"></a><span id="l230.1194" class="difflineminus">-        try {</span>
<a href="#l230.1195"></a><span id="l230.1195" class="difflineminus">-          this._xulWindow = </span>
<a href="#l230.1196"></a><span id="l230.1196" class="difflineminus">-            window.QueryInterface(Components.interfaces.nsIInterfaceRequestor)</span>
<a href="#l230.1197"></a><span id="l230.1197" class="difflineminus">-                  .getInterface(Components.interfaces.nsIWebNavigation)</span>
<a href="#l230.1198"></a><span id="l230.1198" class="difflineminus">-                  .QueryInterface(Components.interfaces.nsIDocShellTreeItem)</span>
<a href="#l230.1199"></a><span id="l230.1199" class="difflineminus">-                  .treeOwner</span>
<a href="#l230.1200"></a><span id="l230.1200" class="difflineminus">-                  .QueryInterface(Components.interfaces.nsIInterfaceRequestor)</span>
<a href="#l230.1201"></a><span id="l230.1201" class="difflineminus">-                  .getInterface(Components.interfaces.nsIXULWindow);</span>
<a href="#l230.1202"></a><span id="l230.1202" class="difflineminus">-        }</span>
<a href="#l230.1203"></a><span id="l230.1203" class="difflineminus">-        catch(ex) { }</span>
<a href="#l230.1204"></a><span id="l230.1204" class="difflineminus">-      ]]&gt;&lt;/constructor&gt;</span>
<a href="#l230.1205"></a><span id="l230.1205" class="difflineminus">-</span>
<a href="#l230.1206"></a><span id="l230.1206" class="difflineminus">-      &lt;method name=&quot;_menuItemOnCommand&quot;&gt;</span>
<a href="#l230.1207"></a><span id="l230.1207" class="difflineminus">-        &lt;parameter name=&quot;aEvent&quot;/&gt;</span>
<a href="#l230.1208"></a><span id="l230.1208" class="difflineminus">-        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l230.1209"></a><span id="l230.1209" class="difflineminus">-          var tabcontainer = document.getBindingParent(this);</span>
<a href="#l230.1210"></a><span id="l230.1210" class="difflineminus">-          tabcontainer.selectedItem = aEvent.target.tab;</span>
<a href="#l230.1211"></a><span id="l230.1211" class="difflineminus">-        ]]&gt;&lt;/body&gt;</span>
<a href="#l230.1212"></a><span id="l230.1212" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l230.1213"></a><span id="l230.1213" class="difflineminus">-</span>
<a href="#l230.1214"></a><span id="l230.1214" class="difflineminus">-      &lt;method name=&quot;_tabOnAttrModified&quot;&gt;</span>
<a href="#l230.1215"></a><span id="l230.1215" class="difflineminus">-        &lt;parameter name=&quot;aEvent&quot;/&gt;</span>
<a href="#l230.1216"></a><span id="l230.1216" class="difflineminus">-        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l230.1217"></a><span id="l230.1217" class="difflineminus">-          var menuItem = aEvent.target.mCorrespondingMenuitem;</span>
<a href="#l230.1218"></a><span id="l230.1218" class="difflineminus">-          if (menuItem) {</span>
<a href="#l230.1219"></a><span id="l230.1219" class="difflineminus">-            var attrName = aEvent.attrName;</span>
<a href="#l230.1220"></a><span id="l230.1220" class="difflineminus">-            switch (attrName) {</span>
<a href="#l230.1221"></a><span id="l230.1221" class="difflineminus">-              case &quot;label&quot;:</span>
<a href="#l230.1222"></a><span id="l230.1222" class="difflineminus">-              case &quot;crop&quot;:</span>
<a href="#l230.1223"></a><span id="l230.1223" class="difflineminus">-              case &quot;busy&quot;:</span>
<a href="#l230.1224"></a><span id="l230.1224" class="difflineminus">-              case &quot;image&quot;:</span>
<a href="#l230.1225"></a><span id="l230.1225" class="difflineminus">-              case &quot;selected&quot;:</span>
<a href="#l230.1226"></a><span id="l230.1226" class="difflineminus">-                if (aEvent.attrChange == aEvent.REMOVAL)</span>
<a href="#l230.1227"></a><span id="l230.1227" class="difflineminus">-                  menuItem.removeAttribute(attrName);</span>
<a href="#l230.1228"></a><span id="l230.1228" class="difflineminus">-                else</span>
<a href="#l230.1229"></a><span id="l230.1229" class="difflineminus">-                  menuItem.setAttribute(attrName, aEvent.newValue);</span>
<a href="#l230.1230"></a><span id="l230.1230" class="difflineminus">-            }</span>
<a href="#l230.1231"></a><span id="l230.1231" class="difflineminus">-          }</span>
<a href="#l230.1232"></a><span id="l230.1232" class="difflineminus">-        ]]&gt;&lt;/body&gt;</span>
<a href="#l230.1233"></a><span id="l230.1233" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l230.1234"></a><span id="l230.1234" class="difflineminus">-</span>
<a href="#l230.1235"></a><span id="l230.1235" class="difflineminus">-      &lt;method name=&quot;_tabOnTabClose&quot;&gt;</span>
<a href="#l230.1236"></a><span id="l230.1236" class="difflineminus">-        &lt;parameter name=&quot;aEvent&quot;/&gt;</span>
<a href="#l230.1237"></a><span id="l230.1237" class="difflineminus">-        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l230.1238"></a><span id="l230.1238" class="difflineminus">-          var menuItem = aEvent.target.mCorrespondingMenuitem;</span>
<a href="#l230.1239"></a><span id="l230.1239" class="difflineminus">-          if (menuItem)</span>
<a href="#l230.1240"></a><span id="l230.1240" class="difflineminus">-            this.removeChild(menuItem);</span>
<a href="#l230.1241"></a><span id="l230.1241" class="difflineminus">-        ]]&gt;&lt;/body&gt;</span>
<a href="#l230.1242"></a><span id="l230.1242" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l230.1243"></a><span id="l230.1243" class="difflineminus">-</span>
<a href="#l230.1244"></a><span id="l230.1244" class="difflineminus">-      &lt;method name=&quot;handleEvent&quot;&gt;</span>
<a href="#l230.1245"></a><span id="l230.1245" class="difflineminus">-        &lt;parameter name=&quot;aEvent&quot;/&gt;</span>
<a href="#l230.1246"></a><span id="l230.1246" class="difflineminus">-        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l230.1247"></a><span id="l230.1247" class="difflineminus">-          if (!aEvent.isTrusted)</span>
<a href="#l230.1248"></a><span id="l230.1248" class="difflineminus">-            return;</span>
<a href="#l230.1249"></a><span id="l230.1249" class="difflineminus">-</span>
<a href="#l230.1250"></a><span id="l230.1250" class="difflineminus">-          switch (aEvent.type) {</span>
<a href="#l230.1251"></a><span id="l230.1251" class="difflineminus">-            case &quot;command&quot;:</span>
<a href="#l230.1252"></a><span id="l230.1252" class="difflineminus">-              this._menuItemOnCommand(aEvent);</span>
<a href="#l230.1253"></a><span id="l230.1253" class="difflineminus">-              break;</span>
<a href="#l230.1254"></a><span id="l230.1254" class="difflineminus">-            case &quot;DOMAttrModified&quot;:</span>
<a href="#l230.1255"></a><span id="l230.1255" class="difflineminus">-              this._tabOnAttrModified(aEvent);</span>
<a href="#l230.1256"></a><span id="l230.1256" class="difflineminus">-              break;</span>
<a href="#l230.1257"></a><span id="l230.1257" class="difflineminus">-            case &quot;TabClose&quot;:</span>
<a href="#l230.1258"></a><span id="l230.1258" class="difflineminus">-              this._tabOnTabClose(aEvent);</span>
<a href="#l230.1259"></a><span id="l230.1259" class="difflineminus">-              break;</span>
<a href="#l230.1260"></a><span id="l230.1260" class="difflineminus">-            case &quot;TabOpen&quot;:</span>
<a href="#l230.1261"></a><span id="l230.1261" class="difflineminus">-              this._createTabMenuItem(aEvent.originalTarget);</span>
<a href="#l230.1262"></a><span id="l230.1262" class="difflineminus">-              break;</span>
<a href="#l230.1263"></a><span id="l230.1263" class="difflineminus">-            case &quot;scroll&quot;:</span>
<a href="#l230.1264"></a><span id="l230.1264" class="difflineminus">-              this._updateTabsVisibilityStatus();</span>
<a href="#l230.1265"></a><span id="l230.1265" class="difflineminus">-              break;</span>
<a href="#l230.1266"></a><span id="l230.1266" class="difflineminus">-          }</span>
<a href="#l230.1267"></a><span id="l230.1267" class="difflineminus">-        ]]&gt;&lt;/body&gt;</span>
<a href="#l230.1268"></a><span id="l230.1268" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l230.1269"></a><span id="l230.1269" class="difflineminus">-</span>
<a href="#l230.1270"></a><span id="l230.1270" class="difflineminus">-      &lt;method name=&quot;_updateTabsVisibilityStatus&quot;&gt;</span>
<a href="#l230.1271"></a><span id="l230.1271" class="difflineminus">-        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l230.1272"></a><span id="l230.1272" class="difflineminus">-          var tabContainer = document.getBindingParent(this);</span>
<a href="#l230.1273"></a><span id="l230.1273" class="difflineminus">-          // We don't want menu item decoration unless there is overflow.</span>
<a href="#l230.1274"></a><span id="l230.1274" class="difflineminus">-          if (tabContainer.getAttribute(&quot;overflow&quot;) != &quot;true&quot;)</span>
<a href="#l230.1275"></a><span id="l230.1275" class="difflineminus">-            return;</span>
<a href="#l230.1276"></a><span id="l230.1276" class="difflineminus">-</span>
<a href="#l230.1277"></a><span id="l230.1277" class="difflineminus">-          var tabstripBO = tabContainer.mTabstrip.scrollBoxObject;</span>
<a href="#l230.1278"></a><span id="l230.1278" class="difflineminus">-          for (var i = 0; i &lt; this.childNodes.length; i++) {</span>
<a href="#l230.1279"></a><span id="l230.1279" class="difflineminus">-            var curTabBO = this.childNodes[i].tab.boxObject;</span>
<a href="#l230.1280"></a><span id="l230.1280" class="difflineminus">-            if (curTabBO.screenX &gt;= tabstripBO.screenX &amp;&amp;</span>
<a href="#l230.1281"></a><span id="l230.1281" class="difflineminus">-                curTabBO.screenX + curTabBO.width &lt;= tabstripBO.screenX + tabstripBO.width)</span>
<a href="#l230.1282"></a><span id="l230.1282" class="difflineminus">-              this.childNodes[i].setAttribute(&quot;tabIsVisible&quot;, &quot;true&quot;); </span>
<a href="#l230.1283"></a><span id="l230.1283" class="difflineminus">-            else</span>
<a href="#l230.1284"></a><span id="l230.1284" class="difflineminus">-              this.childNodes[i].removeAttribute(&quot;tabIsVisible&quot;);</span>
<a href="#l230.1285"></a><span id="l230.1285" class="difflineminus">-          }</span>
<a href="#l230.1286"></a><span id="l230.1286" class="difflineminus">-        ]]&gt;&lt;/body&gt;</span>
<a href="#l230.1287"></a><span id="l230.1287" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l230.1288"></a><span id="l230.1288" class="difflineminus">-</span>
<a href="#l230.1289"></a><span id="l230.1289" class="difflineminus">-      &lt;method name=&quot;_createTabMenuItem&quot;&gt;</span>
<a href="#l230.1290"></a><span id="l230.1290" class="difflineminus">-        &lt;parameter name=&quot;aTab&quot;/&gt;</span>
<a href="#l230.1291"></a><span id="l230.1291" class="difflineminus">-        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l230.1292"></a><span id="l230.1292" class="difflineminus">-          var menuItem = document.createElementNS(</span>
<a href="#l230.1293"></a><span id="l230.1293" class="difflineminus">-            &quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;, </span>
<a href="#l230.1294"></a><span id="l230.1294" class="difflineminus">-            &quot;menuitem&quot;);</span>
<a href="#l230.1295"></a><span id="l230.1295" class="difflineminus">-</span>
<a href="#l230.1296"></a><span id="l230.1296" class="difflineminus">-          menuItem.setAttribute(&quot;class&quot;, &quot;menuitem-iconic alltabs-item&quot;);</span>
<a href="#l230.1297"></a><span id="l230.1297" class="difflineminus">-</span>
<a href="#l230.1298"></a><span id="l230.1298" class="difflineminus">-          menuItem.setAttribute(&quot;label&quot;, aTab.label);</span>
<a href="#l230.1299"></a><span id="l230.1299" class="difflineminus">-          menuItem.setAttribute(&quot;crop&quot;, aTab.getAttribute(&quot;crop&quot;));</span>
<a href="#l230.1300"></a><span id="l230.1300" class="difflineminus">-          menuItem.setAttribute(&quot;image&quot;, aTab.getAttribute(&quot;image&quot;));</span>
<a href="#l230.1301"></a><span id="l230.1301" class="difflineminus">-</span>
<a href="#l230.1302"></a><span id="l230.1302" class="difflineminus">-          if (aTab.hasAttribute(&quot;busy&quot;))</span>
<a href="#l230.1303"></a><span id="l230.1303" class="difflineminus">-            menuItem.setAttribute(&quot;busy&quot;, aTab.getAttribute(&quot;busy&quot;));</span>
<a href="#l230.1304"></a><span id="l230.1304" class="difflineminus">-          if (aTab.selected)</span>
<a href="#l230.1305"></a><span id="l230.1305" class="difflineminus">-            menuItem.setAttribute(&quot;selected&quot;, &quot;true&quot;);</span>
<a href="#l230.1306"></a><span id="l230.1306" class="difflineminus">-</span>
<a href="#l230.1307"></a><span id="l230.1307" class="difflineminus">-          // Keep some attributes of the menuitem in sync with its</span>
<a href="#l230.1308"></a><span id="l230.1308" class="difflineminus">-          // corresponding tab (e.g. the tab label)</span>
<a href="#l230.1309"></a><span id="l230.1309" class="difflineminus">-          aTab.mCorrespondingMenuitem = menuItem;</span>
<a href="#l230.1310"></a><span id="l230.1310" class="difflineminus">-          aTab.addEventListener(&quot;DOMAttrModified&quot;, this, false);</span>
<a href="#l230.1311"></a><span id="l230.1311" class="difflineminus">-          aTab.addEventListener(&quot;TabClose&quot;, this, false);</span>
<a href="#l230.1312"></a><span id="l230.1312" class="difflineminus">-          menuItem.tab = aTab;</span>
<a href="#l230.1313"></a><span id="l230.1313" class="difflineminus">-          menuItem.addEventListener(&quot;command&quot;, this, false);</span>
<a href="#l230.1314"></a><span id="l230.1314" class="difflineminus">-</span>
<a href="#l230.1315"></a><span id="l230.1315" class="difflineminus">-          this.appendChild(menuItem);</span>
<a href="#l230.1316"></a><span id="l230.1316" class="difflineminus">-          return menuItem;</span>
<a href="#l230.1317"></a><span id="l230.1317" class="difflineminus">-        ]]&gt;&lt;/body&gt;</span>
<a href="#l230.1318"></a><span id="l230.1318" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l230.1319"></a><span id="l230.1319" class="difflineminus">-    &lt;/implementation&gt;</span>
<a href="#l230.1320"></a><span id="l230.1320" class="difflineminus">-</span>
<a href="#l230.1321"></a><span id="l230.1321" class="difflineminus">-    &lt;handlers&gt;</span>
<a href="#l230.1322"></a><span id="l230.1322" class="difflineminus">-      &lt;handler event=&quot;popupshowing&quot;&gt;</span>
<a href="#l230.1323"></a><span id="l230.1323" class="difflineminus">-      &lt;![CDATA[</span>
<a href="#l230.1324"></a><span id="l230.1324" class="difflineminus">-        // set up the menu popup</span>
<a href="#l230.1325"></a><span id="l230.1325" class="difflineminus">-        var tabcontainer = document.getBindingParent(this);</span>
<a href="#l230.1326"></a><span id="l230.1326" class="difflineminus">-        var tabs = tabcontainer.childNodes;</span>
<a href="#l230.1327"></a><span id="l230.1327" class="difflineminus">-</span>
<a href="#l230.1328"></a><span id="l230.1328" class="difflineminus">-        // Listen for changes in the tab bar.</span>
<a href="#l230.1329"></a><span id="l230.1329" class="difflineminus">-        var tabbrowser = document.getBindingParent(tabcontainer);</span>
<a href="#l230.1330"></a><span id="l230.1330" class="difflineminus">-        tabbrowser.addEventListener(&quot;TabOpen&quot;, this, false);</span>
<a href="#l230.1331"></a><span id="l230.1331" class="difflineminus">-        tabcontainer.mTabstrip.addEventListener(&quot;scroll&quot;, this, false);</span>
<a href="#l230.1332"></a><span id="l230.1332" class="difflineminus">-</span>
<a href="#l230.1333"></a><span id="l230.1333" class="difflineminus">-        // if an animation is in progress and the user</span>
<a href="#l230.1334"></a><span id="l230.1334" class="difflineminus">-        // clicks on the &quot;all tabs&quot; button, stop the animation</span>
<a href="#l230.1335"></a><span id="l230.1335" class="difflineminus">-        tabcontainer._stopAnimation();</span>
<a href="#l230.1336"></a><span id="l230.1336" class="difflineminus">-</span>
<a href="#l230.1337"></a><span id="l230.1337" class="difflineminus">-        for (var i = 0; i &lt; tabs.length; i++) {</span>
<a href="#l230.1338"></a><span id="l230.1338" class="difflineminus">-          this._createTabMenuItem(tabs[i]);</span>
<a href="#l230.1339"></a><span id="l230.1339" class="difflineminus">-        }</span>
<a href="#l230.1340"></a><span id="l230.1340" class="difflineminus">-        this._updateTabsVisibilityStatus();</span>
<a href="#l230.1341"></a><span id="l230.1341" class="difflineminus">-      ]]&gt;&lt;/handler&gt;</span>
<a href="#l230.1342"></a><span id="l230.1342" class="difflineminus">-</span>
<a href="#l230.1343"></a><span id="l230.1343" class="difflineminus">-      &lt;handler event=&quot;popuphiding&quot;&gt;</span>
<a href="#l230.1344"></a><span id="l230.1344" class="difflineminus">-      &lt;![CDATA[</span>
<a href="#l230.1345"></a><span id="l230.1345" class="difflineminus">-        // clear out the menu popup and remove the listeners</span>
<a href="#l230.1346"></a><span id="l230.1346" class="difflineminus">-        while (this.hasChildNodes()) {</span>
<a href="#l230.1347"></a><span id="l230.1347" class="difflineminus">-          var menuItem = this.lastChild;</span>
<a href="#l230.1348"></a><span id="l230.1348" class="difflineminus">-          menuItem.removeEventListener(&quot;command&quot;, this, false);</span>
<a href="#l230.1349"></a><span id="l230.1349" class="difflineminus">-          menuItem.tab.removeEventListener(&quot;DOMAttrModified&quot;, this, false);</span>
<a href="#l230.1350"></a><span id="l230.1350" class="difflineminus">-          menuItem.tab.removeEventListener(&quot;TabClose&quot;, this, false);</span>
<a href="#l230.1351"></a><span id="l230.1351" class="difflineminus">-          menuItem.tab.mCorrespondingMenuitem = null;</span>
<a href="#l230.1352"></a><span id="l230.1352" class="difflineminus">-          this.removeChild(menuItem);</span>
<a href="#l230.1353"></a><span id="l230.1353" class="difflineminus">-        }</span>
<a href="#l230.1354"></a><span id="l230.1354" class="difflineminus">-        var tabcontainer = document.getBindingParent(this);</span>
<a href="#l230.1355"></a><span id="l230.1355" class="difflineminus">-        tabcontainer.mTabstrip.removeEventListener(&quot;scroll&quot;, this, false);</span>
<a href="#l230.1356"></a><span id="l230.1356" class="difflineminus">-        document.getBindingParent(tabcontainer).removeEventListener(&quot;TabOpen&quot;, this, false);</span>
<a href="#l230.1357"></a><span id="l230.1357" class="difflineminus">-      ]]&gt;&lt;/handler&gt;</span>
<a href="#l230.1358"></a><span id="l230.1358" class="difflineminus">-    &lt;/handlers&gt;</span>
<a href="#l230.1359"></a><span id="l230.1359" class="difflineminus">-  &lt;/binding&gt;</span>
<a href="#l230.1360"></a><span id="l230.1360" class="difflineminus">-  &lt;!-- close-tab-button binding</span>
<a href="#l230.1361"></a><span id="l230.1361" class="difflineminus">-       This binding relies on the structure of the tabbrowser binding.</span>
<a href="#l230.1362"></a><span id="l230.1362" class="difflineminus">-       Therefore it should only be used as a child of the tab or the tabs</span>
<a href="#l230.1363"></a><span id="l230.1363" class="difflineminus">-       element (in both cases, when they are anonymous nodes of &lt;tabbrowser&gt;).</span>
<a href="#l230.1364"></a><span id="l230.1364" class="difflineminus">-       This binding is exposed as a pseudo-public-API so themes can customize</span>
<a href="#l230.1365"></a><span id="l230.1365" class="difflineminus">-       the tabbar appearance without having to be scriptable</span>
<a href="#l230.1366"></a><span id="l230.1366" class="difflineminus">-       (see globalBindings.xml in Pinstripe for example).</span>
<a href="#l230.1367"></a><span id="l230.1367" class="difflineminus">-  --&gt;</span>
<a href="#l230.1368"></a><span id="l230.1368" class="difflineminus">-  &lt;binding id=&quot;tabmail-close-tab-button&quot;</span>
<a href="#l230.1369"></a><span id="l230.1369" class="difflineminus">-           extends=&quot;chrome://global/content/bindings/toolbarbutton.xml#toolbarbutton-image&quot;&gt;</span>
<a href="#l230.1370"></a><span id="l230.1370" class="difflineminus">-    &lt;handlers&gt;</span>
<a href="#l230.1371"></a><span id="l230.1371" class="difflineminus">-      &lt;handler event=&quot;click&quot; button=&quot;0&quot;&gt;&lt;![CDATA[</span>
<a href="#l230.1372"></a><span id="l230.1372" class="difflineminus">-        var bindingParent = document.getBindingParent(this);</span>
<a href="#l230.1373"></a><span id="l230.1373" class="difflineminus">-        if (bindingParent) {</span>
<a href="#l230.1374"></a><span id="l230.1374" class="difflineminus">-          var tabbedBrowser = document.getBindingParent(bindingParent);</span>
<a href="#l230.1375"></a><span id="l230.1375" class="difflineminus">-          if (bindingParent.localName == &quot;tab&quot;) {</span>
<a href="#l230.1376"></a><span id="l230.1376" class="difflineminus">-            /* The only sequence in which a second click event (i.e. dblclik)</span>
<a href="#l230.1377"></a><span id="l230.1377" class="difflineminus">-             * can be dispatched on an in-tab close button is when it is shown</span>
<a href="#l230.1378"></a><span id="l230.1378" class="difflineminus">-             * after the first click (i.e. the first click event was dispatched</span>
<a href="#l230.1379"></a><span id="l230.1379" class="difflineminus">-             * on the tab). This happens when we show the close button only on</span>
<a href="#l230.1380"></a><span id="l230.1380" class="difflineminus">-             * the active tab. (bug 352021)</span>
<a href="#l230.1381"></a><span id="l230.1381" class="difflineminus">-             * The only sequence in which a third click event can be dispatched</span>
<a href="#l230.1382"></a><span id="l230.1382" class="difflineminus">-             * on an in-tab close button is when the tab was opened with a</span>
<a href="#l230.1383"></a><span id="l230.1383" class="difflineminus">-             * double click on the tabbar. (bug 378344)</span>
<a href="#l230.1384"></a><span id="l230.1384" class="difflineminus">-             * In both cases, it is most likely that the close button area has</span>
<a href="#l230.1385"></a><span id="l230.1385" class="difflineminus">-             * been accidentally clicked, therefore we do not close the tab.</span>
<a href="#l230.1386"></a><span id="l230.1386" class="difflineminus">-             */</span>
<a href="#l230.1387"></a><span id="l230.1387" class="difflineminus">-            if (event.detail &gt; 1)</span>
<a href="#l230.1388"></a><span id="l230.1388" class="difflineminus">-              return;</span>
<a href="#l230.1389"></a><span id="l230.1389" class="difflineminus">-</span>
<a href="#l230.1390"></a><span id="l230.1390" class="difflineminus">-            tabbedBrowser.removeTabByNode(bindingParent);</span>
<a href="#l230.1391"></a><span id="l230.1391" class="difflineminus">-            tabbedBrowser._blockDblClick = true;</span>
<a href="#l230.1392"></a><span id="l230.1392" class="difflineminus">-</span>
<a href="#l230.1393"></a><span id="l230.1393" class="difflineminus">-            /* XXXmano hack (see bug 343628):</span>
<a href="#l230.1394"></a><span id="l230.1394" class="difflineminus">-             * Since we're removing the event target, if the user</span>
<a href="#l230.1395"></a><span id="l230.1395" class="difflineminus">-             * double-clicks this button, the dblclick event will be dispatched</span>
<a href="#l230.1396"></a><span id="l230.1396" class="difflineminus">-             * with the tabbar as its event target (and explicit/originalTarget),</span>
<a href="#l230.1397"></a><span id="l230.1397" class="difflineminus">-             * which treats that as a mouse gesture for opening a new tab.</span>
<a href="#l230.1398"></a><span id="l230.1398" class="difflineminus">-             * In this context, we're manually blocking the dblclick event</span>
<a href="#l230.1399"></a><span id="l230.1399" class="difflineminus">-             * (see onTabBarDblClick).</span>
<a href="#l230.1400"></a><span id="l230.1400" class="difflineminus">-             */</span>
<a href="#l230.1401"></a><span id="l230.1401" class="difflineminus">-            var clickedOnce = false;</span>
<a href="#l230.1402"></a><span id="l230.1402" class="difflineminus">-            function enableDblClick(event) {</span>
<a href="#l230.1403"></a><span id="l230.1403" class="difflineminus">-              if (event.detail == 1 &amp;&amp; !clickedOnce) {</span>
<a href="#l230.1404"></a><span id="l230.1404" class="difflineminus">-                clickedOnce = true;</span>
<a href="#l230.1405"></a><span id="l230.1405" class="difflineminus">-                return;</span>
<a href="#l230.1406"></a><span id="l230.1406" class="difflineminus">-              }</span>
<a href="#l230.1407"></a><span id="l230.1407" class="difflineminus">-              setTimeout(function() {</span>
<a href="#l230.1408"></a><span id="l230.1408" class="difflineminus">-                tabbedBrowser._blockDblClick = false;</span>
<a href="#l230.1409"></a><span id="l230.1409" class="difflineminus">-              }, 0);</span>
<a href="#l230.1410"></a><span id="l230.1410" class="difflineminus">-              tabbedBrowser.removeEventListener(&quot;click&quot;, enableDblClick, false);</span>
<a href="#l230.1411"></a><span id="l230.1411" class="difflineminus">-            }</span>
<a href="#l230.1412"></a><span id="l230.1412" class="difflineminus">-            tabbedBrowser.addEventListener(&quot;click&quot;, enableDblClick, false);</span>
<a href="#l230.1413"></a><span id="l230.1413" class="difflineminus">-          }</span>
<a href="#l230.1414"></a><span id="l230.1414" class="difflineminus">-          else // &quot;tabs&quot;</span>
<a href="#l230.1415"></a><span id="l230.1415" class="difflineminus">-            tabbedBrowser.removeCurrentTab();</span>
<a href="#l230.1416"></a><span id="l230.1416" class="difflineminus">-        }</span>
<a href="#l230.1417"></a><span id="l230.1417" class="difflineminus">-      ]]&gt;&lt;/handler&gt;</span>
<a href="#l230.1418"></a><span id="l230.1418" class="difflineminus">-      &lt;handler event=&quot;dblclick&quot; button=&quot;0&quot; phase=&quot;capturing&quot;&gt;</span>
<a href="#l230.1419"></a><span id="l230.1419" class="difflineminus">-        // for the one-close-button case</span>
<a href="#l230.1420"></a><span id="l230.1420" class="difflineminus">-        event.stopPropagation();</span>
<a href="#l230.1421"></a><span id="l230.1421" class="difflineminus">-      &lt;/handler&gt;</span>
<a href="#l230.1422"></a><span id="l230.1422" class="difflineminus">-    &lt;/handlers&gt;</span>
<a href="#l230.1423"></a><span id="l230.1423" class="difflineminus">-  &lt;/binding&gt;</span>
<a href="#l230.1424"></a><span id="l230.1424" class="difflineminus">-</span>
<a href="#l230.1425"></a><span id="l230.1425" class="difflineminus">-&lt;/bindings&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l231.1"></a><span id="l231.1">new file mode 100644</span>
<a href="#l231.2"></a><span id="l231.2">index e69de29bb2d1d6434b8b29ae775ad8c2e48c5391..dc35c2c6fe1c2de14cdfcfe13196716af1d12dcd</span>
<a href="#l231.3"></a><span id="l231.3">GIT binary patch
literal 616
zc$@)f0+;=XP)&lt;h;3K|Lk000e1NJLTq000mG000mO1^@s6AM^iV0006nNkl&lt;ZILoDx
zZA(*O7{~ntz3^-F2?`8GAq5S~Rm{SuPY@_YQnqOgG8!tbGF0Xvnv4b8GR=l(x%IG|
z|Fw?p!NE3M?Chboxu&gt;(W=(Ns#S7&amp;0r2z&gt;Fox$ggUUB4Ii-PUY2+x7!JzKPWX)-TsA
zv-}0@#3(VH=*865Maqm+lbp=f#ZtR0c$Vt7@bwKuDo!k9Z(}igM_N&gt;4D$#?r^ee=3
zF$&amp;Tw%}CG8U$M!8$=F%&amp;wIHM#?{f_7ycQ&amp;T6g&gt;xP!~l-&gt;QCtZ-CZ&amp;w@2(rMi*^Q(S
zpn}z}W&gt;`Pp0?7=UDtIzxh@wc@Dh6N(tN!%5TY~XG7u;zh#GgM9EU&lt;VS?ghz4xziZ)
ztHEVnBUOrHKCb_rt)HTOS)lhTao?xJ9H++&amp;*9ZMaCGMdM&amp;jSpC$si&gt;p!T7asMqYsV
zq@gpiV8nX@cR!p&amp;v6=^$07hJwG3T2=qtTGrNWX!7ouRcWZU)(r1-f^gAeaI-P^e~+
z$!8%50#*|ax{%zCV%jqdp(fC~Gis*uvS7${41XE*oJS&lt;&lt;MJVHeZsiQND&gt;*!TdmX7f
zk9xgMS&amp;o?KtSlI071)V}J&amp;GY`C$#KwFut4c##T_O7Adt_4UX_r3@$5Lf`O$D?8$-x
z4_GZ`-QyIaYXap;8B4(@7&lt;k#y5?q}&gt;j6Ja_=v(Y&amp;QF=_$Z~X$&gt;W9hRU!fyH{Ol!mc
zpl2^Z=TO;YLG^o~eax%2YurchKakmEIdo7K?1x`Jd)k)upZ-$-0000&lt;MNUMnLSTY(
CuOCwY</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l232.1"></a><span id="l232.1" class="difflineminus">--- a/suite/themes/classic/jar.mn</span>
<a href="#l232.2"></a><span id="l232.2" class="difflineplus">+++ b/suite/themes/classic/jar.mn</span>
<a href="#l232.3"></a><span id="l232.3" class="difflineat">@@ -73,16 +73,17 @@ classic.jar:</span>
<a href="#l232.4"></a><span id="l232.4">   skin/classic/communicator/sidebar/sidebar.css                         (communicator/sidebar/sidebar.css)</span>
<a href="#l232.5"></a><span id="l232.5">   skin/classic/communicator/sidebar/sidebarListView.css                 (communicator/sidebar/sidebarListView.css)</span>
<a href="#l232.6"></a><span id="l232.6">   skin/classic/communicator/xpinstall/xpinstall.css                     (communicator/xpinstall/xpinstall.css)</span>
<a href="#l232.7"></a><span id="l232.7">   skin/classic/communicator/icons/audioFeedIcon.png                     (communicator/icons/feedIcon.png)</span>
<a href="#l232.8"></a><span id="l232.8">   skin/classic/communicator/icons/close-button.gif                      (communicator/icons/close-button.gif)</span>
<a href="#l232.9"></a><span id="l232.9">   skin/classic/communicator/icons/offline.png                           (communicator/icons/offline.png)</span>
<a href="#l232.10"></a><span id="l232.10">   skin/classic/communicator/icons/online.png                            (communicator/icons/online.png)</span>
<a href="#l232.11"></a><span id="l232.11">   skin/classic/communicator/icons/search.png                            (communicator/icons/search.png)</span>
<a href="#l232.12"></a><span id="l232.12" class="difflineplus">+  skin/classic/communicator/icons/identity.png                          (communicator/icons/identity.png)</span>
<a href="#l232.13"></a><span id="l232.13">   skin/classic/communicator/icons/lock-secure.png                       (communicator/icons/lock-secure.png)</span>
<a href="#l232.14"></a><span id="l232.14">   skin/classic/communicator/icons/lock-broken.png                       (communicator/icons/lock-broken.png)</span>
<a href="#l232.15"></a><span id="l232.15">   skin/classic/communicator/icons/lock-insecure.png                     (communicator/icons/lock-insecure.png)</span>
<a href="#l232.16"></a><span id="l232.16">   skin/classic/communicator/icons/loading.gif                           (communicator/icons/loading.gif)</span>
<a href="#l232.17"></a><span id="l232.17">   skin/classic/communicator/icons/communicatoricons.png                 (communicator/icons/communicatoricons.png)</span>
<a href="#l232.18"></a><span id="l232.18">   skin/classic/communicator/icons/communicatoricons-small.png           (communicator/icons/communicatoricons-small.png)</span>
<a href="#l232.19"></a><span id="l232.19">   skin/classic/communicator/icons/alwaysAsk.png                         (communicator/icons/alwaysAsk.png)</span>
<a href="#l232.20"></a><span id="l232.20">   skin/classic/communicator/icons/application.png                       (communicator/icons/application.png)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l233.1"></a><span id="l233.1" class="difflineminus">--- a/suite/themes/classic/messenger/primaryToolbar.css</span>
<a href="#l233.2"></a><span id="l233.2" class="difflineplus">+++ b/suite/themes/classic/messenger/primaryToolbar.css</span>
<a href="#l233.3"></a><span id="l233.3" class="difflineat">@@ -39,20 +39,16 @@</span>
<a href="#l233.4"></a><span id="l233.4"> /* ===== primaryToolbar.css =============================================</span>
<a href="#l233.5"></a><span id="l233.5">   == Images for the Mail primary toolbar.</span>
<a href="#l233.6"></a><span id="l233.6">   ======================================================================= */</span>
<a href="#l233.7"></a><span id="l233.7"> </span>
<a href="#l233.8"></a><span id="l233.8"> @namespace url(&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;);</span>
<a href="#l233.9"></a><span id="l233.9"> </span>
<a href="#l233.10"></a><span id="l233.10"> /* ::::: primary toolbar buttons ::::: */</span>
<a href="#l233.11"></a><span id="l233.11"> </span>
<a href="#l233.12"></a><span id="l233.12" class="difflineminus">-.toolbarbutton-1 {</span>
<a href="#l233.13"></a><span id="l233.13" class="difflineminus">-  list-style-image: url(&quot;chrome://messenger/skin/icons/messengericons.png&quot;);</span>
<a href="#l233.14"></a><span id="l233.14" class="difflineminus">-}</span>
<a href="#l233.15"></a><span id="l233.15" class="difflineminus">-</span>
<a href="#l233.16"></a><span id="l233.16"> #button-getmsg {</span>
<a href="#l233.17"></a><span id="l233.17">   list-style-image: url(&quot;chrome://messenger/skin/icons/messengericons.png&quot;);</span>
<a href="#l233.18"></a><span id="l233.18">   -moz-image-region: rect(90px 29px 119px 0);</span>
<a href="#l233.19"></a><span id="l233.19"> }</span>
<a href="#l233.20"></a><span id="l233.20"> </span>
<a href="#l233.21"></a><span id="l233.21"> #button-getmsg:hover {</span>
<a href="#l233.22"></a><span id="l233.22">   -moz-image-region: rect(90px 59px 119px 30px);</span>
<a href="#l233.23"></a><span id="l233.23"> } </span>
<a href="#l233.24"></a><span id="l233.24" class="difflineat">@@ -476,30 +472,30 @@ toolbar[iconsize=&quot;small&quot;] &gt; #button-mark</span>
<a href="#l233.25"></a><span id="l233.25"> toolbar[iconsize=&quot;small&quot;] &gt; #button-mark:hover:active {</span>
<a href="#l233.26"></a><span id="l233.26">   -moz-image-region: rect(80px 59px 99px 40px);</span>
<a href="#l233.27"></a><span id="l233.27"> }</span>
<a href="#l233.28"></a><span id="l233.28"> </span>
<a href="#l233.29"></a><span id="l233.29"> toolbar[iconsize=&quot;small&quot;] &gt; #button-mark[disabled] {</span>
<a href="#l233.30"></a><span id="l233.30">   -moz-image-region: rect(80px 79px 99px 60px) !important;</span>
<a href="#l233.31"></a><span id="l233.31"> }</span>
<a href="#l233.32"></a><span id="l233.32"> </span>
<a href="#l233.33"></a><span id="l233.33" class="difflineminus">-toolbar[iconsize=&quot;small&quot;] &gt; #button-junk &gt; #junk-deck &gt; .toolbarbutton-1 {</span>
<a href="#l233.34"></a><span id="l233.34" class="difflineplus">+toolbar[iconsize=&quot;small&quot;] &gt; #button-junk {</span>
<a href="#l233.35"></a><span id="l233.35">   list-style-image: url(&quot;chrome://messenger/skin/icons/messengericons-small.png&quot;);</span>
<a href="#l233.36"></a><span id="l233.36">   -moz-image-region: rect(240px 19px 259px 0);</span>
<a href="#l233.37"></a><span id="l233.37"> }</span>
<a href="#l233.38"></a><span id="l233.38"> </span>
<a href="#l233.39"></a><span id="l233.39" class="difflineminus">-toolbar[iconsize=&quot;small&quot;] &gt; #button-junk &gt; #junk-deck:hover &gt; .toolbarbutton-1 {</span>
<a href="#l233.40"></a><span id="l233.40" class="difflineplus">+toolbar[iconsize=&quot;small&quot;] &gt; #button-junk:hover {</span>
<a href="#l233.41"></a><span id="l233.41">   -moz-image-region: rect(240px 39px 259px 20px);</span>
<a href="#l233.42"></a><span id="l233.42"> }</span>
<a href="#l233.43"></a><span id="l233.43"> </span>
<a href="#l233.44"></a><span id="l233.44" class="difflineminus">-toolbar[iconsize=&quot;small&quot;] &gt; #button-junk &gt; #junk-deck:hover:active &gt; .toolbarbutton-1 {</span>
<a href="#l233.45"></a><span id="l233.45" class="difflineplus">+toolbar[iconsize=&quot;small&quot;] &gt; #button-junk:hover:active {</span>
<a href="#l233.46"></a><span id="l233.46">   -moz-image-region: rect(240px 59px 259px 40px);</span>
<a href="#l233.47"></a><span id="l233.47"> }</span>
<a href="#l233.48"></a><span id="l233.48"> </span>
<a href="#l233.49"></a><span id="l233.49" class="difflineminus">-toolbar[iconsize=&quot;small&quot;] &gt; #button-junk &gt; #junk-deck[disabled=&quot;true&quot;] &gt; .toolbarbutton-1 {</span>
<a href="#l233.50"></a><span id="l233.50" class="difflineplus">+toolbar[iconsize=&quot;small&quot;] &gt; #button-junk[disabled=&quot;true&quot;] {</span>
<a href="#l233.51"></a><span id="l233.51">   -moz-image-region: rect(240px 79px 259px 60px) !important;</span>
<a href="#l233.52"></a><span id="l233.52"> }</span>
<a href="#l233.53"></a><span id="l233.53"> </span>
<a href="#l233.54"></a><span id="l233.54"> toolbar[iconsize=&quot;small&quot;] &gt; #button-print {</span>
<a href="#l233.55"></a><span id="l233.55">   list-style-image: url(&quot;chrome://communicator/skin/icons/communicatoricons-small.png&quot;);</span>
<a href="#l233.56"></a><span id="l233.56">   -moz-image-region: rect(0 19px 19px 0);</span>
<a href="#l233.57"></a><span id="l233.57"> }</span>
<a href="#l233.58"></a><span id="l233.58"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l234.1"></a><span id="l234.1" class="difflineminus">--- a/suite/themes/classic/navigator/navigator.css</span>
<a href="#l234.2"></a><span id="l234.2" class="difflineplus">+++ b/suite/themes/classic/navigator/navigator.css</span>
<a href="#l234.3"></a><span id="l234.3" class="difflineat">@@ -39,20 +39,16 @@</span>
<a href="#l234.4"></a><span id="l234.4"> @import url(&quot;chrome://navigator/content/navigator.css&quot;);</span>
<a href="#l234.5"></a><span id="l234.5"> @import url(&quot;chrome://communicator/skin/&quot;);</span>
<a href="#l234.6"></a><span id="l234.6"> @import url(&quot;chrome://communicator/skin/bookmarks/bookmarksToolbar.css&quot;);</span>
<a href="#l234.7"></a><span id="l234.7"> </span>
<a href="#l234.8"></a><span id="l234.8"> @namespace url(&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;);</span>
<a href="#l234.9"></a><span id="l234.9"> </span>
<a href="#l234.10"></a><span id="l234.10"> /* ::::: primary toolbar buttons ::::: */</span>
<a href="#l234.11"></a><span id="l234.11"> </span>
<a href="#l234.12"></a><span id="l234.12" class="difflineminus">-.toolbarbutton-1 {</span>
<a href="#l234.13"></a><span id="l234.13" class="difflineminus">-  list-style-image: url(&quot;chrome://navigator/skin/icons/navigatoricons.png&quot;);</span>
<a href="#l234.14"></a><span id="l234.14" class="difflineminus">-}</span>
<a href="#l234.15"></a><span id="l234.15" class="difflineminus">-</span>
<a href="#l234.16"></a><span id="l234.16"> #back-button {</span>
<a href="#l234.17"></a><span id="l234.17">   list-style-image: url(&quot;chrome://communicator/skin/icons/communicatoricons.png&quot;);</span>
<a href="#l234.18"></a><span id="l234.18">   -moz-image-region: rect(60px 29px 89px 0);</span>
<a href="#l234.19"></a><span id="l234.19"> }</span>
<a href="#l234.20"></a><span id="l234.20"> </span>
<a href="#l234.21"></a><span id="l234.21"> #back-button:hover {</span>
<a href="#l234.22"></a><span id="l234.22">   -moz-image-region: rect(60px 59px 89px 30px);</span>
<a href="#l234.23"></a><span id="l234.23"> }</span>
<a href="#l234.24"></a><span id="l234.24" class="difflineat">@@ -482,16 +478,20 @@ toolbar[mode=&quot;icons&quot;] #search-button &gt; .</span>
<a href="#l234.25"></a><span id="l234.25"> </span>
<a href="#l234.26"></a><span id="l234.26"> #security-button[label] &gt; .statusbarpanel-icon,</span>
<a href="#l234.27"></a><span id="l234.27"> #security-button &gt; .statusbarpanel-text {</span>
<a href="#l234.28"></a><span id="l234.28">   margin: 0px;</span>
<a href="#l234.29"></a><span id="l234.29">   background-color: #62C441;</span>
<a href="#l234.30"></a><span id="l234.30">   color: #FFFFFF;</span>
<a href="#l234.31"></a><span id="l234.31"> }</span>
<a href="#l234.32"></a><span id="l234.32"> </span>
<a href="#l234.33"></a><span id="l234.33" class="difflineplus">+#ev-button {</span>
<a href="#l234.34"></a><span id="l234.34" class="difflineplus">+  list-style-image: url(&quot;chrome://communicator/skin/icons/identity.png&quot;);</span>
<a href="#l234.35"></a><span id="l234.35" class="difflineplus">+}</span>
<a href="#l234.36"></a><span id="l234.36" class="difflineplus">+</span>
<a href="#l234.37"></a><span id="l234.37"> #popupIcon {</span>
<a href="#l234.38"></a><span id="l234.38">   list-style-image: url(&quot;chrome://navigator/skin/icons/popup-blocked.png&quot;);</span>
<a href="#l234.39"></a><span id="l234.39"> }</span>
<a href="#l234.40"></a><span id="l234.40"> </span>
<a href="#l234.41"></a><span id="l234.41"> /* ::::: personal toolbar ::::: */</span>
<a href="#l234.42"></a><span id="l234.42"> </span>
<a href="#l234.43"></a><span id="l234.43"> #bookmarks-button {</span>
<a href="#l234.44"></a><span id="l234.44">   list-style-image: url(&quot;chrome://communicator/skin/bookmarks/bookmark-folder-closed.png&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l235.1"></a><span id="l235.1">new file mode 100644</span>
<a href="#l235.2"></a><span id="l235.2">index e69de29bb2d1d6434b8b29ae775ad8c2e48c5391..dc35c2c6fe1c2de14cdfcfe13196716af1d12dcd</span>
<a href="#l235.3"></a><span id="l235.3">GIT binary patch
literal 616
zc$@)f0+;=XP)&lt;h;3K|Lk000e1NJLTq000mG000mO1^@s6AM^iV0006nNkl&lt;ZILoDx
zZA(*O7{~ntz3^-F2?`8GAq5S~Rm{SuPY@_YQnqOgG8!tbGF0Xvnv4b8GR=l(x%IG|
z|Fw?p!NE3M?Chboxu&gt;(W=(Ns#S7&amp;0r2z&gt;Fox$ggUUB4Ii-PUY2+x7!JzKPWX)-TsA
zv-}0@#3(VH=*865Maqm+lbp=f#ZtR0c$Vt7@bwKuDo!k9Z(}igM_N&gt;4D$#?r^ee=3
zF$&amp;Tw%}CG8U$M!8$=F%&amp;wIHM#?{f_7ycQ&amp;T6g&gt;xP!~l-&gt;QCtZ-CZ&amp;w@2(rMi*^Q(S
zpn}z}W&gt;`Pp0?7=UDtIzxh@wc@Dh6N(tN!%5TY~XG7u;zh#GgM9EU&lt;VS?ghz4xziZ)
ztHEVnBUOrHKCb_rt)HTOS)lhTao?xJ9H++&amp;*9ZMaCGMdM&amp;jSpC$si&gt;p!T7asMqYsV
zq@gpiV8nX@cR!p&amp;v6=^$07hJwG3T2=qtTGrNWX!7ouRcWZU)(r1-f^gAeaI-P^e~+
z$!8%50#*|ax{%zCV%jqdp(fC~Gis*uvS7${41XE*oJS&lt;&lt;MJVHeZsiQND&gt;*!TdmX7f
zk9xgMS&amp;o?KtSlI071)V}J&amp;GY`C$#KwFut4c##T_O7Adt_4UX_r3@$5Lf`O$D?8$-x
z4_GZ`-QyIaYXap;8B4(@7&lt;k#y5?q}&gt;j6Ja_=v(Y&amp;QF=_$Z~X$&gt;W9hRU!fyH{Ol!mc
zpl2^Z=TO;YLG^o~eax%2YurchKakmEIdo7K?1x`Jd)k)upZ-$-0000&lt;MNUMnLSTY(
CuOCwY</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l236.1"></a><span id="l236.1" class="difflineminus">--- a/suite/themes/modern/jar.mn</span>
<a href="#l236.2"></a><span id="l236.2" class="difflineplus">+++ b/suite/themes/modern/jar.mn</span>
<a href="#l236.3"></a><span id="l236.3" class="difflineat">@@ -47,16 +47,17 @@ modern.jar:</span>
<a href="#l236.4"></a><span id="l236.4">   skin/modern/communicator/icons/application.png                   (communicator/icons/application.png)</span>
<a href="#l236.5"></a><span id="l236.5">   skin/modern/communicator/icons/audioFeedIcon.png                 (communicator/icons/feedIcon.png)</span>
<a href="#l236.6"></a><span id="l236.6">   skin/modern/communicator/icons/btn1.gif                          (communicator/icons/btn1.gif)</span>
<a href="#l236.7"></a><span id="l236.7">   skin/modern/communicator/icons/common.png                        (communicator/icons/common.png)</span>
<a href="#l236.8"></a><span id="l236.8">   skin/modern/communicator/icons/common-small.png                  (communicator/icons/common-small.png)</span>
<a href="#l236.9"></a><span id="l236.9">   skin/modern/communicator/icons/feedIcon.png                      (communicator/icons/feedIcon.png)</span>
<a href="#l236.10"></a><span id="l236.10">   skin/modern/communicator/icons/feedIcon16.png                    (communicator/icons/feedIcon16.png)</span>
<a href="#l236.11"></a><span id="l236.11">   skin/modern/communicator/icons/geo.png                           (communicator/icons/geo.png)</span>
<a href="#l236.12"></a><span id="l236.12" class="difflineplus">+  skin/modern/communicator/icons/identity.png                      (communicator/icons/identity.png)</span>
<a href="#l236.13"></a><span id="l236.13">   skin/modern/communicator/icons/loading.gif                       (communicator/icons/loading.gif)</span>
<a href="#l236.14"></a><span id="l236.14">   skin/modern/communicator/icons/lock-broken.png                   (communicator/icons/lock-broken.png)</span>
<a href="#l236.15"></a><span id="l236.15">   skin/modern/communicator/icons/lock-insecure.png                 (communicator/icons/lock-insecure.png)</span>
<a href="#l236.16"></a><span id="l236.16">   skin/modern/communicator/icons/lock-secure.png                   (communicator/icons/lock-secure.png)</span>
<a href="#l236.17"></a><span id="l236.17">   skin/modern/communicator/icons/offline.gif                       (communicator/icons/offline.gif)</span>
<a href="#l236.18"></a><span id="l236.18">   skin/modern/communicator/icons/online.gif                        (communicator/icons/online.gif)</span>
<a href="#l236.19"></a><span id="l236.19">   skin/modern/communicator/icons/plugin.png                        (communicator/icons/plugin.png)</span>
<a href="#l236.20"></a><span id="l236.20">   skin/modern/communicator/icons/save.png                          (communicator/icons/save.png)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l237.1"></a><span id="l237.1" class="difflineminus">--- a/suite/themes/modern/messenger/primaryToolbar.css</span>
<a href="#l237.2"></a><span id="l237.2" class="difflineplus">+++ b/suite/themes/modern/messenger/primaryToolbar.css</span>
<a href="#l237.3"></a><span id="l237.3" class="difflineat">@@ -47,17 +47,16 @@</span>
<a href="#l237.4"></a><span id="l237.4"> </span>
<a href="#l237.5"></a><span id="l237.5"> #msgToolbar &gt; .toolbar-holder &gt; .toolbar-primary-icon {</span>
<a href="#l237.6"></a><span id="l237.6">   list-style-image: url(&quot;chrome://messenger/skin/icons/mast-mail.gif&quot;);</span>
<a href="#l237.7"></a><span id="l237.7"> }</span>
<a href="#l237.8"></a><span id="l237.8"> </span>
<a href="#l237.9"></a><span id="l237.9"> /* ::::: primary toolbar buttons ::::: */</span>
<a href="#l237.10"></a><span id="l237.10"> </span>
<a href="#l237.11"></a><span id="l237.11"> .toolbarbutton-1 {</span>
<a href="#l237.12"></a><span id="l237.12" class="difflineminus">-  list-style-image: url(&quot;chrome://messenger/skin/icons/btn1.gif&quot;);</span>
<a href="#l237.13"></a><span id="l237.13">   min-width: 0px !important;</span>
<a href="#l237.14"></a><span id="l237.14"> }</span>
<a href="#l237.15"></a><span id="l237.15"> </span>
<a href="#l237.16"></a><span id="l237.16"> #button-getmsg {</span>
<a href="#l237.17"></a><span id="l237.17">   list-style-image: url(&quot;chrome://messenger/skin/icons/btn1.gif&quot;);</span>
<a href="#l237.18"></a><span id="l237.18">   -moz-image-region: rect(102px 49px 135px 0);</span>
<a href="#l237.19"></a><span id="l237.19"> }</span>
<a href="#l237.20"></a><span id="l237.20"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l238.1"></a><span id="l238.1" class="difflineminus">--- a/suite/themes/modern/navigator/navigator.css</span>
<a href="#l238.2"></a><span id="l238.2" class="difflineplus">+++ b/suite/themes/modern/navigator/navigator.css</span>
<a href="#l238.3"></a><span id="l238.3" class="difflineat">@@ -39,17 +39,16 @@</span>
<a href="#l238.4"></a><span id="l238.4"> @import url(&quot;chrome://communicator/skin/&quot;);</span>
<a href="#l238.5"></a><span id="l238.5"> @import url(&quot;chrome://communicator/skin/bookmarks/bookmarksToolbar.css&quot;);</span>
<a href="#l238.6"></a><span id="l238.6"> </span>
<a href="#l238.7"></a><span id="l238.7"> @namespace url(&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;);</span>
<a href="#l238.8"></a><span id="l238.8"> </span>
<a href="#l238.9"></a><span id="l238.9"> /* ::::: primary toolbar buttons ::::: */</span>
<a href="#l238.10"></a><span id="l238.10"> </span>
<a href="#l238.11"></a><span id="l238.11"> .toolbarbutton-1 {</span>
<a href="#l238.12"></a><span id="l238.12" class="difflineminus">-  list-style-image: url(&quot;chrome://communicator/skin/icons/common.png&quot;);</span>
<a href="#l238.13"></a><span id="l238.13">   min-width: 0px;</span>
<a href="#l238.14"></a><span id="l238.14"> }</span>
<a href="#l238.15"></a><span id="l238.15"> </span>
<a href="#l238.16"></a><span id="l238.16"> toolbox {</span>
<a href="#l238.17"></a><span id="l238.17">   border-bottom: none;</span>
<a href="#l238.18"></a><span id="l238.18"> }</span>
<a href="#l238.19"></a><span id="l238.19"> </span>
<a href="#l238.20"></a><span id="l238.20"> #appcontent {</span>
<a href="#l238.21"></a><span id="l238.21" class="difflineat">@@ -155,21 +154,16 @@ toolbox {</span>
<a href="#l238.22"></a><span id="l238.22"> }</span>
<a href="#l238.23"></a><span id="l238.23"> </span>
<a href="#l238.24"></a><span id="l238.24"> #home-button[disabled=&quot;true&quot;] {</span>
<a href="#l238.25"></a><span id="l238.25">   -moz-image-region: rect(156px 168px 195px 126px) !important;</span>
<a href="#l238.26"></a><span id="l238.26"> }</span>
<a href="#l238.27"></a><span id="l238.27"> </span>
<a href="#l238.28"></a><span id="l238.28"> /* ::::: small primary toolbar buttons ::::: */</span>
<a href="#l238.29"></a><span id="l238.29"> </span>
<a href="#l238.30"></a><span id="l238.30" class="difflineminus">-toolbar[iconsize=&quot;small&quot;] &gt; toolbarpaletteitem &gt; .toolbarbutton-1,</span>
<a href="#l238.31"></a><span id="l238.31" class="difflineminus">-toolbar[iconsize=&quot;small&quot;] &gt; .toolbarbutton-1 {</span>
<a href="#l238.32"></a><span id="l238.32" class="difflineminus">-  list-style-image: url(&quot;chrome://communicator/skin/icons/common-small.png&quot;);</span>
<a href="#l238.33"></a><span id="l238.33" class="difflineminus">-}</span>
<a href="#l238.34"></a><span id="l238.34" class="difflineminus">-</span>
<a href="#l238.35"></a><span id="l238.35"> toolbar[iconsize=&quot;small&quot;] &gt; toolbarpaletteitem &gt; #back-button,</span>
<a href="#l238.36"></a><span id="l238.36"> toolbar[iconsize=&quot;small&quot;] &gt; #back-button {</span>
<a href="#l238.37"></a><span id="l238.37">   list-style-image: url(&quot;chrome://communicator/skin/icons/common-small.png&quot;);</span>
<a href="#l238.38"></a><span id="l238.38">   -moz-image-region: rect(38px 19px 57px 0);</span>
<a href="#l238.39"></a><span id="l238.39"> }</span>
<a href="#l238.40"></a><span id="l238.40"> </span>
<a href="#l238.41"></a><span id="l238.41"> toolbar[iconsize=&quot;small&quot;] &gt; toolbarpaletteitem &gt; #back-button:hover,</span>
<a href="#l238.42"></a><span id="l238.42"> toolbar[iconsize=&quot;small&quot;] &gt; #back-button:hover {</span>
<a href="#l238.43"></a><span id="l238.43" class="difflineat">@@ -728,16 +722,20 @@ toolbarpaletteitem[place=&quot;palette&quot;] &gt; #p</span>
<a href="#l238.44"></a><span id="l238.44"> </span>
<a href="#l238.45"></a><span id="l238.45"> #security-button[label] &gt; .statusbarpanel-icon,</span>
<a href="#l238.46"></a><span id="l238.46"> #security-button &gt; .statusbarpanel-text {</span>
<a href="#l238.47"></a><span id="l238.47">   margin: 0px;</span>
<a href="#l238.48"></a><span id="l238.48">   background-color: #62C441;</span>
<a href="#l238.49"></a><span id="l238.49">   color: #FFFFFF;</span>
<a href="#l238.50"></a><span id="l238.50"> }</span>
<a href="#l238.51"></a><span id="l238.51"> </span>
<a href="#l238.52"></a><span id="l238.52" class="difflineplus">+#ev-button {</span>
<a href="#l238.53"></a><span id="l238.53" class="difflineplus">+  list-style-image: url(&quot;chrome://communicator/skin/icons/identity.png&quot;);</span>
<a href="#l238.54"></a><span id="l238.54" class="difflineplus">+}</span>
<a href="#l238.55"></a><span id="l238.55" class="difflineplus">+</span>
<a href="#l238.56"></a><span id="l238.56"> #popupIcon {</span>
<a href="#l238.57"></a><span id="l238.57">   list-style-image: url(&quot;chrome://navigator/skin/icons/popup-blocked.png&quot;);</span>
<a href="#l238.58"></a><span id="l238.58"> }</span>
<a href="#l238.59"></a><span id="l238.59"> </span>
<a href="#l238.60"></a><span id="l238.60"> /* ::::: feeds ::::: */</span>
<a href="#l238.61"></a><span id="l238.61"> </span>
<a href="#l238.62"></a><span id="l238.62"> #feedsMenu {</span>
<a href="#l238.63"></a><span id="l238.63">   list-style-image: url(&quot;chrome://navigator/skin/btn1/feeds.png&quot;) !important;</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

