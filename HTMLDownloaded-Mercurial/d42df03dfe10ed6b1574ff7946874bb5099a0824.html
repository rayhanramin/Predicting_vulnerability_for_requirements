<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 29143:d42df03dfe10ed6b1574ff7946874bb5099a0824</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ d42df03dfe10ed6b1574ff7946874bb5099a0824" />
<meta property="og:url" content="/comm-central/rev/d42df03dfe10ed6b1574ff7946874bb5099a0824" />
<meta property="og:description" content="Bug 1624207 - Implement address book export in javascript. r=mkmelin" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / d42df03dfe10ed6b1574ff7946874bb5099a0824 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/d42df03dfe10ed6b1574ff7946874bb5099a0824">shortlog</a> |
<a href="/comm-central/log/d42df03dfe10ed6b1574ff7946874bb5099a0824">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/d42df03dfe10ed6b1574ff7946874bb5099a0824">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/d42df03dfe10ed6b1574ff7946874bb5099a0824">files</a> |
changeset |
<a href="/comm-central/raw-rev/d42df03dfe10ed6b1574ff7946874bb5099a0824">raw</a>  | <a href="/comm-central/archive/d42df03dfe10ed6b1574ff7946874bb5099a0824.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1624207">Bug 1624207</a> - Implement address book export in javascript. r=mkmelin
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#71;&#101;&#111;&#102;&#102;&#32;&#76;&#97;&#110;&#107;&#111;&#119;&#32;&#60;&#103;&#101;&#111;&#102;&#102;&#64;&#100;&#97;&#114;&#107;&#116;&#114;&#111;&#106;&#97;&#110;&#46;&#110;&#101;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Mon, 23 Mar 2020 22:29:02 +1300</td></tr>

<tr>
 <td>changeset 29143</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/d42df03dfe10ed6b1574ff7946874bb5099a0824">d42df03dfe10ed6b1574ff7946874bb5099a0824</a></td>
</tr>



<tr>
<td>parent 29142</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/f38c4f986fa7dc0a930c2b1a60fca96471d29171">f38c4f986fa7dc0a930c2b1a60fca96471d29171</a>
</td>
</tr>

<tr>
<td>child 29144</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/7b54036ce7d67afa8361606c720287e5710b4775">7b54036ce7d67afa8361606c720287e5710b4775</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=d42df03dfe10ed6b1574ff7946874bb5099a0824">17222</a></td></tr>
<tr><td>push user</td><td>geoff@darktrojan.net</td></tr>
<tr><td>push date</td><td class="date age">Tue, 31 Mar 2020 23:48:22 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@d42df03dfe10 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=d42df03dfe10ed6b1574ff7946874bb5099a0824">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=d42df03dfe10ed6b1574ff7946874bb5099a0824&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=d42df03dfe10ed6b1574ff7946874bb5099a0824&newProject=comm-central&newRevision=3c16add31ebc743d7cb8e0b18f037b3ac6e95572&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=d42df03dfe10ed6b1574ff7946874bb5099a0824&newProject=comm-central&newRevision=3c16add31ebc743d7cb8e0b18f037b3ac6e95572&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=d42df03dfe10ed6b1574ff7946874bb5099a0824&newProject=comm-central&newRevision=3c16add31ebc743d7cb8e0b18f037b3ac6e95572&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28mkmelin%29&revcount=50">mkmelin</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1624207">1624207</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1624207">Bug 1624207</a> - Implement address book export in javascript. r=mkmelin</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d42df03dfe10ed6b1574ff7946874bb5099a0824/mail/components/addrbook/content/addressbook.js">mail/components/addrbook/content/addressbook.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d42df03dfe10ed6b1574ff7946874bb5099a0824/mail/components/addrbook/content/addressbook.js">file</a> |
<a href="/comm-central/annotate/d42df03dfe10ed6b1574ff7946874bb5099a0824/mail/components/addrbook/content/addressbook.js">annotate</a> |
<a href="/comm-central/diff/d42df03dfe10ed6b1574ff7946874bb5099a0824/mail/components/addrbook/content/addressbook.js">diff</a> |
<a href="/comm-central/comparison/d42df03dfe10ed6b1574ff7946874bb5099a0824/mail/components/addrbook/content/addressbook.js">comparison</a> |
<a href="/comm-central/log/d42df03dfe10ed6b1574ff7946874bb5099a0824/mail/components/addrbook/content/addressbook.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d42df03dfe10ed6b1574ff7946874bb5099a0824/mailnews/addrbook/jsaddrbook/AddrBookManager.jsm">mailnews/addrbook/jsaddrbook/AddrBookManager.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d42df03dfe10ed6b1574ff7946874bb5099a0824/mailnews/addrbook/jsaddrbook/AddrBookManager.jsm">file</a> |
<a href="/comm-central/annotate/d42df03dfe10ed6b1574ff7946874bb5099a0824/mailnews/addrbook/jsaddrbook/AddrBookManager.jsm">annotate</a> |
<a href="/comm-central/diff/d42df03dfe10ed6b1574ff7946874bb5099a0824/mailnews/addrbook/jsaddrbook/AddrBookManager.jsm">diff</a> |
<a href="/comm-central/comparison/d42df03dfe10ed6b1574ff7946874bb5099a0824/mailnews/addrbook/jsaddrbook/AddrBookManager.jsm">comparison</a> |
<a href="/comm-central/log/d42df03dfe10ed6b1574ff7946874bb5099a0824/mailnews/addrbook/jsaddrbook/AddrBookManager.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d42df03dfe10ed6b1574ff7946874bb5099a0824/mailnews/addrbook/jsaddrbook/AddrBookUtils.jsm">mailnews/addrbook/jsaddrbook/AddrBookUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d42df03dfe10ed6b1574ff7946874bb5099a0824/mailnews/addrbook/jsaddrbook/AddrBookUtils.jsm">file</a> |
<a href="/comm-central/annotate/d42df03dfe10ed6b1574ff7946874bb5099a0824/mailnews/addrbook/jsaddrbook/AddrBookUtils.jsm">annotate</a> |
<a href="/comm-central/diff/d42df03dfe10ed6b1574ff7946874bb5099a0824/mailnews/addrbook/jsaddrbook/AddrBookUtils.jsm">diff</a> |
<a href="/comm-central/comparison/d42df03dfe10ed6b1574ff7946874bb5099a0824/mailnews/addrbook/jsaddrbook/AddrBookUtils.jsm">comparison</a> |
<a href="/comm-central/log/d42df03dfe10ed6b1574ff7946874bb5099a0824/mailnews/addrbook/jsaddrbook/AddrBookUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d42df03dfe10ed6b1574ff7946874bb5099a0824/mailnews/addrbook/public/nsIAbManager.idl">mailnews/addrbook/public/nsIAbManager.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d42df03dfe10ed6b1574ff7946874bb5099a0824/mailnews/addrbook/public/nsIAbManager.idl">file</a> |
<a href="/comm-central/annotate/d42df03dfe10ed6b1574ff7946874bb5099a0824/mailnews/addrbook/public/nsIAbManager.idl">annotate</a> |
<a href="/comm-central/diff/d42df03dfe10ed6b1574ff7946874bb5099a0824/mailnews/addrbook/public/nsIAbManager.idl">diff</a> |
<a href="/comm-central/comparison/d42df03dfe10ed6b1574ff7946874bb5099a0824/mailnews/addrbook/public/nsIAbManager.idl">comparison</a> |
<a href="/comm-central/log/d42df03dfe10ed6b1574ff7946874bb5099a0824/mailnews/addrbook/public/nsIAbManager.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d42df03dfe10ed6b1574ff7946874bb5099a0824/mailnews/addrbook/test/unit/data/export.csv">mailnews/addrbook/test/unit/data/export.csv</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d42df03dfe10ed6b1574ff7946874bb5099a0824/mailnews/addrbook/test/unit/data/export.csv">file</a> |
<a href="/comm-central/annotate/d42df03dfe10ed6b1574ff7946874bb5099a0824/mailnews/addrbook/test/unit/data/export.csv">annotate</a> |
<a href="/comm-central/diff/d42df03dfe10ed6b1574ff7946874bb5099a0824/mailnews/addrbook/test/unit/data/export.csv">diff</a> |
<a href="/comm-central/comparison/d42df03dfe10ed6b1574ff7946874bb5099a0824/mailnews/addrbook/test/unit/data/export.csv">comparison</a> |
<a href="/comm-central/log/d42df03dfe10ed6b1574ff7946874bb5099a0824/mailnews/addrbook/test/unit/data/export.csv">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d42df03dfe10ed6b1574ff7946874bb5099a0824/mailnews/addrbook/test/unit/data/export.ldif">mailnews/addrbook/test/unit/data/export.ldif</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d42df03dfe10ed6b1574ff7946874bb5099a0824/mailnews/addrbook/test/unit/data/export.ldif">file</a> |
<a href="/comm-central/annotate/d42df03dfe10ed6b1574ff7946874bb5099a0824/mailnews/addrbook/test/unit/data/export.ldif">annotate</a> |
<a href="/comm-central/diff/d42df03dfe10ed6b1574ff7946874bb5099a0824/mailnews/addrbook/test/unit/data/export.ldif">diff</a> |
<a href="/comm-central/comparison/d42df03dfe10ed6b1574ff7946874bb5099a0824/mailnews/addrbook/test/unit/data/export.ldif">comparison</a> |
<a href="/comm-central/log/d42df03dfe10ed6b1574ff7946874bb5099a0824/mailnews/addrbook/test/unit/data/export.ldif">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d42df03dfe10ed6b1574ff7946874bb5099a0824/mailnews/addrbook/test/unit/data/export.txt">mailnews/addrbook/test/unit/data/export.txt</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d42df03dfe10ed6b1574ff7946874bb5099a0824/mailnews/addrbook/test/unit/data/export.txt">file</a> |
<a href="/comm-central/annotate/d42df03dfe10ed6b1574ff7946874bb5099a0824/mailnews/addrbook/test/unit/data/export.txt">annotate</a> |
<a href="/comm-central/diff/d42df03dfe10ed6b1574ff7946874bb5099a0824/mailnews/addrbook/test/unit/data/export.txt">diff</a> |
<a href="/comm-central/comparison/d42df03dfe10ed6b1574ff7946874bb5099a0824/mailnews/addrbook/test/unit/data/export.txt">comparison</a> |
<a href="/comm-central/log/d42df03dfe10ed6b1574ff7946874bb5099a0824/mailnews/addrbook/test/unit/data/export.txt">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d42df03dfe10ed6b1574ff7946874bb5099a0824/mailnews/addrbook/test/unit/data/export.vcf">mailnews/addrbook/test/unit/data/export.vcf</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d42df03dfe10ed6b1574ff7946874bb5099a0824/mailnews/addrbook/test/unit/data/export.vcf">file</a> |
<a href="/comm-central/annotate/d42df03dfe10ed6b1574ff7946874bb5099a0824/mailnews/addrbook/test/unit/data/export.vcf">annotate</a> |
<a href="/comm-central/diff/d42df03dfe10ed6b1574ff7946874bb5099a0824/mailnews/addrbook/test/unit/data/export.vcf">diff</a> |
<a href="/comm-central/comparison/d42df03dfe10ed6b1574ff7946874bb5099a0824/mailnews/addrbook/test/unit/data/export.vcf">comparison</a> |
<a href="/comm-central/log/d42df03dfe10ed6b1574ff7946874bb5099a0824/mailnews/addrbook/test/unit/data/export.vcf">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d42df03dfe10ed6b1574ff7946874bb5099a0824/mailnews/addrbook/test/unit/test_export.js">mailnews/addrbook/test/unit/test_export.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d42df03dfe10ed6b1574ff7946874bb5099a0824/mailnews/addrbook/test/unit/test_export.js">file</a> |
<a href="/comm-central/annotate/d42df03dfe10ed6b1574ff7946874bb5099a0824/mailnews/addrbook/test/unit/test_export.js">annotate</a> |
<a href="/comm-central/diff/d42df03dfe10ed6b1574ff7946874bb5099a0824/mailnews/addrbook/test/unit/test_export.js">diff</a> |
<a href="/comm-central/comparison/d42df03dfe10ed6b1574ff7946874bb5099a0824/mailnews/addrbook/test/unit/test_export.js">comparison</a> |
<a href="/comm-central/log/d42df03dfe10ed6b1574ff7946874bb5099a0824/mailnews/addrbook/test/unit/test_export.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d42df03dfe10ed6b1574ff7946874bb5099a0824/mailnews/addrbook/test/unit/xpcshell.ini">mailnews/addrbook/test/unit/xpcshell.ini</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d42df03dfe10ed6b1574ff7946874bb5099a0824/mailnews/addrbook/test/unit/xpcshell.ini">file</a> |
<a href="/comm-central/annotate/d42df03dfe10ed6b1574ff7946874bb5099a0824/mailnews/addrbook/test/unit/xpcshell.ini">annotate</a> |
<a href="/comm-central/diff/d42df03dfe10ed6b1574ff7946874bb5099a0824/mailnews/addrbook/test/unit/xpcshell.ini">diff</a> |
<a href="/comm-central/comparison/d42df03dfe10ed6b1574ff7946874bb5099a0824/mailnews/addrbook/test/unit/xpcshell.ini">comparison</a> |
<a href="/comm-central/log/d42df03dfe10ed6b1574ff7946874bb5099a0824/mailnews/addrbook/test/unit/xpcshell.ini">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/components/addrbook/content/addressbook.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/components/addrbook/content/addressbook.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -9,16 +9,21 @@</span>
<a href="#l1.4"></a><span id="l1.4"> /* import-globals-from abCardView.js */</span>
<a href="#l1.5"></a><span id="l1.5"> /* import-globals-from abCommon.js */</span>
<a href="#l1.6"></a><span id="l1.6"> </span>
<a href="#l1.7"></a><span id="l1.7"> // Ensure the activity modules are loaded for this window.</span>
<a href="#l1.8"></a><span id="l1.8"> ChromeUtils.import(&quot;resource:///modules/activity/activityModules.jsm&quot;);</span>
<a href="#l1.9"></a><span id="l1.9"> var { getSearchTokens, getModelQuery, generateQueryURI } = ChromeUtils.import(</span>
<a href="#l1.10"></a><span id="l1.10">   &quot;resource:///modules/ABQueryUtils.jsm&quot;</span>
<a href="#l1.11"></a><span id="l1.11"> );</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+var {</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+  exportDirectoryToLDIF,</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+  exportDirectoryToDelimitedText,</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+  exportDirectoryToVCard,</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineplus">+} = ChromeUtils.import(&quot;resource:///modules/AddrBookUtils.jsm&quot;);</span>
<a href="#l1.17"></a><span id="l1.17"> var { MailServices } = ChromeUtils.import(</span>
<a href="#l1.18"></a><span id="l1.18">   &quot;resource:///modules/MailServices.jsm&quot;</span>
<a href="#l1.19"></a><span id="l1.19"> );</span>
<a href="#l1.20"></a><span id="l1.20"> var { PluralForm } = ChromeUtils.import(</span>
<a href="#l1.21"></a><span id="l1.21">   &quot;resource://gre/modules/PluralForm.jsm&quot;</span>
<a href="#l1.22"></a><span id="l1.22"> );</span>
<a href="#l1.23"></a><span id="l1.23"> var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l1.24"></a><span id="l1.24"> </span>
<a href="#l1.25"></a><span id="l1.25" class="difflineat">@@ -474,43 +479,189 @@ function AbExportAll() {</span>
<a href="#l1.26"></a><span id="l1.26">  *</span>
<a href="#l1.27"></a><span id="l1.27">  * @param aSelectedDirURI  The URI of the addressbook to export.</span>
<a href="#l1.28"></a><span id="l1.28">  */</span>
<a href="#l1.29"></a><span id="l1.29"> function AbExport(aSelectedDirURI) {</span>
<a href="#l1.30"></a><span id="l1.30">   if (!aSelectedDirURI) {</span>
<a href="#l1.31"></a><span id="l1.31">     return;</span>
<a href="#l1.32"></a><span id="l1.32">   }</span>
<a href="#l1.33"></a><span id="l1.33"> </span>
<a href="#l1.34"></a><span id="l1.34" class="difflineminus">-  try {</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineminus">-    let directory = GetDirectoryFromURI(aSelectedDirURI);</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineminus">-    MailServices.ab.exportAddressBook(window, directory);</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineminus">-  } catch (ex) {</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineminus">-    let message;</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineminus">-    switch (ex.result) {</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineminus">-      case Cr.NS_ERROR_FILE_ACCESS_DENIED:</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineminus">-        message = gAddressBookBundle.getString(</span>
<a href="#l1.42"></a><span id="l1.42" class="difflineminus">-          &quot;failedToExportMessageFileAccessDenied&quot;</span>
<a href="#l1.43"></a><span id="l1.43" class="difflineminus">-        );</span>
<a href="#l1.44"></a><span id="l1.44" class="difflineplus">+  let systemCharset = &quot;utf-8&quot;;</span>
<a href="#l1.45"></a><span id="l1.45" class="difflineplus">+  if (AppConstants.platform == &quot;win&quot;) {</span>
<a href="#l1.46"></a><span id="l1.46" class="difflineplus">+    // Some Windows applications (notably Outlook) still don't understand</span>
<a href="#l1.47"></a><span id="l1.47" class="difflineplus">+    // UTF-8 encoding when importing address books and instead use the current</span>
<a href="#l1.48"></a><span id="l1.48" class="difflineplus">+    // operating system encoding. We can get that encoding from the registry.</span>
<a href="#l1.49"></a><span id="l1.49" class="difflineplus">+    let registryKey = Cc[&quot;@mozilla.org/windows-registry-key;1&quot;].createInstance(</span>
<a href="#l1.50"></a><span id="l1.50" class="difflineplus">+      Ci.nsIWindowsRegKey</span>
<a href="#l1.51"></a><span id="l1.51" class="difflineplus">+    );</span>
<a href="#l1.52"></a><span id="l1.52" class="difflineplus">+    registryKey.open(</span>
<a href="#l1.53"></a><span id="l1.53" class="difflineplus">+      Ci.nsIWindowsRegKey.ROOT_KEY_LOCAL_MACHINE,</span>
<a href="#l1.54"></a><span id="l1.54" class="difflineplus">+      &quot;SYSTEM\\CurrentControlSet\\Control\\Nls\\CodePage&quot;,</span>
<a href="#l1.55"></a><span id="l1.55" class="difflineplus">+      Ci.nsIWindowsRegKey.ACCESS_READ</span>
<a href="#l1.56"></a><span id="l1.56" class="difflineplus">+    );</span>
<a href="#l1.57"></a><span id="l1.57" class="difflineplus">+    let acpValue = registryKey.readStringValue(&quot;ACP&quot;);</span>
<a href="#l1.58"></a><span id="l1.58" class="difflineplus">+</span>
<a href="#l1.59"></a><span id="l1.59" class="difflineplus">+    // This data converts the registry key value into encodings that</span>
<a href="#l1.60"></a><span id="l1.60" class="difflineplus">+    // nsIConverterOutputStream understands. It is from</span>
<a href="#l1.61"></a><span id="l1.61" class="difflineplus">+    // https://github.com/hsivonen/encoding_rs/blob/c3eb642cdf3f17003b8dac95c8fff478568e46da/generate-encoding-data.py#L188</span>
<a href="#l1.62"></a><span id="l1.62" class="difflineplus">+    systemCharset =</span>
<a href="#l1.63"></a><span id="l1.63" class="difflineplus">+      {</span>
<a href="#l1.64"></a><span id="l1.64" class="difflineplus">+        866: &quot;IBM866&quot;,</span>
<a href="#l1.65"></a><span id="l1.65" class="difflineplus">+        874: &quot;windows-874&quot;,</span>
<a href="#l1.66"></a><span id="l1.66" class="difflineplus">+        932: &quot;Shift_JIS&quot;,</span>
<a href="#l1.67"></a><span id="l1.67" class="difflineplus">+        936: &quot;GBK&quot;,</span>
<a href="#l1.68"></a><span id="l1.68" class="difflineplus">+        949: &quot;EUC-KR&quot;,</span>
<a href="#l1.69"></a><span id="l1.69" class="difflineplus">+        950: &quot;Big5&quot;,</span>
<a href="#l1.70"></a><span id="l1.70" class="difflineplus">+        1200: &quot;UTF-16LE&quot;,</span>
<a href="#l1.71"></a><span id="l1.71" class="difflineplus">+        1201: &quot;UTF-16BE&quot;,</span>
<a href="#l1.72"></a><span id="l1.72" class="difflineplus">+        1250: &quot;windows-1250&quot;,</span>
<a href="#l1.73"></a><span id="l1.73" class="difflineplus">+        1251: &quot;windows-1251&quot;,</span>
<a href="#l1.74"></a><span id="l1.74" class="difflineplus">+        1252: &quot;windows-1252&quot;,</span>
<a href="#l1.75"></a><span id="l1.75" class="difflineplus">+        1253: &quot;windows-1253&quot;,</span>
<a href="#l1.76"></a><span id="l1.76" class="difflineplus">+        1254: &quot;windows-1254&quot;,</span>
<a href="#l1.77"></a><span id="l1.77" class="difflineplus">+        1255: &quot;windows-1255&quot;,</span>
<a href="#l1.78"></a><span id="l1.78" class="difflineplus">+        1256: &quot;windows-1256&quot;,</span>
<a href="#l1.79"></a><span id="l1.79" class="difflineplus">+        1257: &quot;windows-1257&quot;,</span>
<a href="#l1.80"></a><span id="l1.80" class="difflineplus">+        1258: &quot;windows-1258&quot;,</span>
<a href="#l1.81"></a><span id="l1.81" class="difflineplus">+        10000: &quot;macintosh&quot;,</span>
<a href="#l1.82"></a><span id="l1.82" class="difflineplus">+        10017: &quot;x-mac-cyrillic&quot;,</span>
<a href="#l1.83"></a><span id="l1.83" class="difflineplus">+        20866: &quot;KOI8-R&quot;,</span>
<a href="#l1.84"></a><span id="l1.84" class="difflineplus">+        20932: &quot;EUC-JP&quot;,</span>
<a href="#l1.85"></a><span id="l1.85" class="difflineplus">+        21866: &quot;KOI8-U&quot;,</span>
<a href="#l1.86"></a><span id="l1.86" class="difflineplus">+        28592: &quot;ISO-8859-2&quot;,</span>
<a href="#l1.87"></a><span id="l1.87" class="difflineplus">+        28593: &quot;ISO-8859-3&quot;,</span>
<a href="#l1.88"></a><span id="l1.88" class="difflineplus">+        28594: &quot;ISO-8859-4&quot;,</span>
<a href="#l1.89"></a><span id="l1.89" class="difflineplus">+        28595: &quot;ISO-8859-5&quot;,</span>
<a href="#l1.90"></a><span id="l1.90" class="difflineplus">+        28596: &quot;ISO-8859-6&quot;,</span>
<a href="#l1.91"></a><span id="l1.91" class="difflineplus">+        28597: &quot;ISO-8859-7&quot;,</span>
<a href="#l1.92"></a><span id="l1.92" class="difflineplus">+        28598: &quot;ISO-8859-8&quot;,</span>
<a href="#l1.93"></a><span id="l1.93" class="difflineplus">+        28600: &quot;ISO-8859-10&quot;,</span>
<a href="#l1.94"></a><span id="l1.94" class="difflineplus">+        28603: &quot;ISO-8859-13&quot;,</span>
<a href="#l1.95"></a><span id="l1.95" class="difflineplus">+        28604: &quot;ISO-8859-14&quot;,</span>
<a href="#l1.96"></a><span id="l1.96" class="difflineplus">+        28605: &quot;ISO-8859-15&quot;,</span>
<a href="#l1.97"></a><span id="l1.97" class="difflineplus">+        28606: &quot;ISO-8859-16&quot;,</span>
<a href="#l1.98"></a><span id="l1.98" class="difflineplus">+        38598: &quot;ISO-8859-8-I&quot;,</span>
<a href="#l1.99"></a><span id="l1.99" class="difflineplus">+        50221: &quot;ISO-2022-JP&quot;,</span>
<a href="#l1.100"></a><span id="l1.100" class="difflineplus">+        54936: &quot;gb18030&quot;,</span>
<a href="#l1.101"></a><span id="l1.101" class="difflineplus">+      }[acpValue] || systemCharset;</span>
<a href="#l1.102"></a><span id="l1.102" class="difflineplus">+  }</span>
<a href="#l1.103"></a><span id="l1.103" class="difflineplus">+</span>
<a href="#l1.104"></a><span id="l1.104" class="difflineplus">+  let directory = GetDirectoryFromURI(aSelectedDirURI);</span>
<a href="#l1.105"></a><span id="l1.105" class="difflineplus">+  let filePicker = Cc[&quot;@mozilla.org/filepicker;1&quot;].createInstance(</span>
<a href="#l1.106"></a><span id="l1.106" class="difflineplus">+    Ci.nsIFilePicker</span>
<a href="#l1.107"></a><span id="l1.107" class="difflineplus">+  );</span>
<a href="#l1.108"></a><span id="l1.108" class="difflineplus">+  let bundle = Services.strings.createBundle(</span>
<a href="#l1.109"></a><span id="l1.109" class="difflineplus">+    &quot;chrome://messenger/locale/addressbook/addressBook.properties&quot;</span>
<a href="#l1.110"></a><span id="l1.110" class="difflineplus">+  );</span>
<a href="#l1.111"></a><span id="l1.111" class="difflineplus">+</span>
<a href="#l1.112"></a><span id="l1.112" class="difflineplus">+  let title = bundle.formatStringFromName(&quot;ExportAddressBookNameTitle&quot;, [</span>
<a href="#l1.113"></a><span id="l1.113" class="difflineplus">+    directory.dirName,</span>
<a href="#l1.114"></a><span id="l1.114" class="difflineplus">+  ]);</span>
<a href="#l1.115"></a><span id="l1.115" class="difflineplus">+  filePicker.init(window, title, Ci.nsIFilePicker.modeSave);</span>
<a href="#l1.116"></a><span id="l1.116" class="difflineplus">+  filePicker.defaultString = directory.dirName;</span>
<a href="#l1.117"></a><span id="l1.117" class="difflineplus">+</span>
<a href="#l1.118"></a><span id="l1.118" class="difflineplus">+  let filterString;</span>
<a href="#l1.119"></a><span id="l1.119" class="difflineplus">+  // Since the list of file picker filters isn't fixed, keep track of which</span>
<a href="#l1.120"></a><span id="l1.120" class="difflineplus">+  // ones are added, so we can use them in the switch block below.</span>
<a href="#l1.121"></a><span id="l1.121" class="difflineplus">+  let activeFilters = [];</span>
<a href="#l1.122"></a><span id="l1.122" class="difflineplus">+</span>
<a href="#l1.123"></a><span id="l1.123" class="difflineplus">+  // CSV</span>
<a href="#l1.124"></a><span id="l1.124" class="difflineplus">+  if (systemCharset != &quot;utf-8&quot;) {</span>
<a href="#l1.125"></a><span id="l1.125" class="difflineplus">+    filterString = bundle.GetStringFromName(&quot;CSVFilesSysCharset&quot;);</span>
<a href="#l1.126"></a><span id="l1.126" class="difflineplus">+    filePicker.appendFilter(filterString, &quot;*.csv&quot;);</span>
<a href="#l1.127"></a><span id="l1.127" class="difflineplus">+    activeFilters.push(&quot;CSVFilesSysCharset&quot;);</span>
<a href="#l1.128"></a><span id="l1.128" class="difflineplus">+  }</span>
<a href="#l1.129"></a><span id="l1.129" class="difflineplus">+  filterString = bundle.GetStringFromName(&quot;CSVFilesUTF8&quot;);</span>
<a href="#l1.130"></a><span id="l1.130" class="difflineplus">+  filePicker.appendFilter(filterString, &quot;*.csv&quot;);</span>
<a href="#l1.131"></a><span id="l1.131" class="difflineplus">+  activeFilters.push(&quot;CSVFilesUTF8&quot;);</span>
<a href="#l1.132"></a><span id="l1.132" class="difflineplus">+</span>
<a href="#l1.133"></a><span id="l1.133" class="difflineplus">+  // Tab separated</span>
<a href="#l1.134"></a><span id="l1.134" class="difflineplus">+  if (systemCharset != &quot;utf-8&quot;) {</span>
<a href="#l1.135"></a><span id="l1.135" class="difflineplus">+    filterString = bundle.GetStringFromName(&quot;TABFilesSysCharset&quot;);</span>
<a href="#l1.136"></a><span id="l1.136" class="difflineplus">+    filePicker.appendFilter(filterString, &quot;*.tab; *.txt&quot;);</span>
<a href="#l1.137"></a><span id="l1.137" class="difflineplus">+    activeFilters.push(&quot;TABFilesSysCharset&quot;);</span>
<a href="#l1.138"></a><span id="l1.138" class="difflineplus">+  }</span>
<a href="#l1.139"></a><span id="l1.139" class="difflineplus">+  filterString = bundle.GetStringFromName(&quot;TABFilesUTF8&quot;);</span>
<a href="#l1.140"></a><span id="l1.140" class="difflineplus">+  filePicker.appendFilter(filterString, &quot;*.tab; *.txt&quot;);</span>
<a href="#l1.141"></a><span id="l1.141" class="difflineplus">+  activeFilters.push(&quot;TABFilesUTF8&quot;);</span>
<a href="#l1.142"></a><span id="l1.142" class="difflineplus">+</span>
<a href="#l1.143"></a><span id="l1.143" class="difflineplus">+  // vCard</span>
<a href="#l1.144"></a><span id="l1.144" class="difflineplus">+  filterString = bundle.GetStringFromName(&quot;VCFFiles&quot;);</span>
<a href="#l1.145"></a><span id="l1.145" class="difflineplus">+  filePicker.appendFilter(filterString, &quot;*.vcf&quot;);</span>
<a href="#l1.146"></a><span id="l1.146" class="difflineplus">+  activeFilters.push(&quot;VCFFiles&quot;);</span>
<a href="#l1.147"></a><span id="l1.147" class="difflineplus">+</span>
<a href="#l1.148"></a><span id="l1.148" class="difflineplus">+  // LDIF</span>
<a href="#l1.149"></a><span id="l1.149" class="difflineplus">+  filterString = bundle.GetStringFromName(&quot;LDIFFiles&quot;);</span>
<a href="#l1.150"></a><span id="l1.150" class="difflineplus">+  filePicker.appendFilter(filterString, &quot;*.ldi; *.ldif&quot;);</span>
<a href="#l1.151"></a><span id="l1.151" class="difflineplus">+  activeFilters.push(&quot;LDIFFiles&quot;);</span>
<a href="#l1.152"></a><span id="l1.152" class="difflineplus">+</span>
<a href="#l1.153"></a><span id="l1.153" class="difflineplus">+  filePicker.open(rv =&gt; {</span>
<a href="#l1.154"></a><span id="l1.154" class="difflineplus">+    if (</span>
<a href="#l1.155"></a><span id="l1.155" class="difflineplus">+      rv == Ci.nsIFilePicker.returnCancel ||</span>
<a href="#l1.156"></a><span id="l1.156" class="difflineplus">+      !filePicker.file ||</span>
<a href="#l1.157"></a><span id="l1.157" class="difflineplus">+      !filePicker.file.path</span>
<a href="#l1.158"></a><span id="l1.158" class="difflineplus">+    ) {</span>
<a href="#l1.159"></a><span id="l1.159" class="difflineplus">+      return;</span>
<a href="#l1.160"></a><span id="l1.160" class="difflineplus">+    }</span>
<a href="#l1.161"></a><span id="l1.161" class="difflineplus">+</span>
<a href="#l1.162"></a><span id="l1.162" class="difflineplus">+    if (rv == Ci.nsIFilePicker.returnReplace) {</span>
<a href="#l1.163"></a><span id="l1.163" class="difflineplus">+      if (filePicker.file.isFile()) {</span>
<a href="#l1.164"></a><span id="l1.164" class="difflineplus">+        filePicker.file.remove(false);</span>
<a href="#l1.165"></a><span id="l1.165" class="difflineplus">+      }</span>
<a href="#l1.166"></a><span id="l1.166" class="difflineplus">+    }</span>
<a href="#l1.167"></a><span id="l1.167" class="difflineplus">+</span>
<a href="#l1.168"></a><span id="l1.168" class="difflineplus">+    let exportFile = filePicker.file.clone();</span>
<a href="#l1.169"></a><span id="l1.169" class="difflineplus">+    let leafName = exportFile.leafName;</span>
<a href="#l1.170"></a><span id="l1.170" class="difflineplus">+    let output = &quot;&quot;;</span>
<a href="#l1.171"></a><span id="l1.171" class="difflineplus">+    let charset = &quot;utf-8&quot;;</span>
<a href="#l1.172"></a><span id="l1.172" class="difflineplus">+</span>
<a href="#l1.173"></a><span id="l1.173" class="difflineplus">+    switch (activeFilters[filePicker.filterIndex]) {</span>
<a href="#l1.174"></a><span id="l1.174" class="difflineplus">+      case &quot;CSVFilesSysCharset&quot;:</span>
<a href="#l1.175"></a><span id="l1.175" class="difflineplus">+        charset = systemCharset;</span>
<a href="#l1.176"></a><span id="l1.176" class="difflineplus">+      // Falls through.</span>
<a href="#l1.177"></a><span id="l1.177" class="difflineplus">+      case &quot;CSVFilesUTF8&quot;:</span>
<a href="#l1.178"></a><span id="l1.178" class="difflineplus">+        if (!leafName.endsWith(&quot;.csv&quot;)) {</span>
<a href="#l1.179"></a><span id="l1.179" class="difflineplus">+          exportFile.leafName += &quot;.csv&quot;;</span>
<a href="#l1.180"></a><span id="l1.180" class="difflineplus">+        }</span>
<a href="#l1.181"></a><span id="l1.181" class="difflineplus">+        output = exportDirectoryToDelimitedText(directory, &quot;,&quot;);</span>
<a href="#l1.182"></a><span id="l1.182">         break;</span>
<a href="#l1.183"></a><span id="l1.183" class="difflineminus">-      case Cr.NS_ERROR_FILE_NO_DEVICE_SPACE:</span>
<a href="#l1.184"></a><span id="l1.184" class="difflineminus">-        message = gAddressBookBundle.getString(</span>
<a href="#l1.185"></a><span id="l1.185" class="difflineminus">-          &quot;failedToExportMessageNoDeviceSpace&quot;</span>
<a href="#l1.186"></a><span id="l1.186" class="difflineminus">-        );</span>
<a href="#l1.187"></a><span id="l1.187" class="difflineplus">+      case &quot;TABFilesSysCharset&quot;:</span>
<a href="#l1.188"></a><span id="l1.188" class="difflineplus">+        charset = systemCharset;</span>
<a href="#l1.189"></a><span id="l1.189" class="difflineplus">+      // Falls through.</span>
<a href="#l1.190"></a><span id="l1.190" class="difflineplus">+      case &quot;TABFilesUTF8&quot;:</span>
<a href="#l1.191"></a><span id="l1.191" class="difflineplus">+        if (!leafName.endsWith(&quot;.txt&quot;) &amp;&amp; !leafName.endsWith(&quot;.tab&quot;)) {</span>
<a href="#l1.192"></a><span id="l1.192" class="difflineplus">+          exportFile.leafName += &quot;.txt&quot;;</span>
<a href="#l1.193"></a><span id="l1.193" class="difflineplus">+        }</span>
<a href="#l1.194"></a><span id="l1.194" class="difflineplus">+        output = exportDirectoryToDelimitedText(directory, &quot;\t&quot;);</span>
<a href="#l1.195"></a><span id="l1.195">         break;</span>
<a href="#l1.196"></a><span id="l1.196" class="difflineminus">-      default:</span>
<a href="#l1.197"></a><span id="l1.197" class="difflineminus">-        message = ex.message;</span>
<a href="#l1.198"></a><span id="l1.198" class="difflineplus">+      case &quot;VCFFiles&quot;:</span>
<a href="#l1.199"></a><span id="l1.199" class="difflineplus">+        if (!leafName.endsWith(&quot;.vcf&quot;)) {</span>
<a href="#l1.200"></a><span id="l1.200" class="difflineplus">+          exportFile.leafName += &quot;.vcf&quot;;</span>
<a href="#l1.201"></a><span id="l1.201" class="difflineplus">+        }</span>
<a href="#l1.202"></a><span id="l1.202" class="difflineplus">+        output = exportDirectoryToVCard(directory);</span>
<a href="#l1.203"></a><span id="l1.203" class="difflineplus">+        break;</span>
<a href="#l1.204"></a><span id="l1.204" class="difflineplus">+      case &quot;LDIFFiles&quot;:</span>
<a href="#l1.205"></a><span id="l1.205" class="difflineplus">+        if (!leafName.endsWith(&quot;.ldi&quot;) &amp;&amp; !leafName.endsWith(&quot;.ldif&quot;)) {</span>
<a href="#l1.206"></a><span id="l1.206" class="difflineplus">+          exportFile.leafName += &quot;.ldif&quot;;</span>
<a href="#l1.207"></a><span id="l1.207" class="difflineplus">+        }</span>
<a href="#l1.208"></a><span id="l1.208" class="difflineplus">+        output = exportDirectoryToLDIF(directory);</span>
<a href="#l1.209"></a><span id="l1.209">         break;</span>
<a href="#l1.210"></a><span id="l1.210">     }</span>
<a href="#l1.211"></a><span id="l1.211"> </span>
<a href="#l1.212"></a><span id="l1.212" class="difflineminus">-    Services.prompt.alert(</span>
<a href="#l1.213"></a><span id="l1.213" class="difflineminus">-      window,</span>
<a href="#l1.214"></a><span id="l1.214" class="difflineminus">-      gAddressBookBundle.getString(&quot;failedToExportTitle&quot;),</span>
<a href="#l1.215"></a><span id="l1.215" class="difflineminus">-      message</span>
<a href="#l1.216"></a><span id="l1.216" class="difflineminus">-    );</span>
<a href="#l1.217"></a><span id="l1.217" class="difflineminus">-  }</span>
<a href="#l1.218"></a><span id="l1.218" class="difflineplus">+    let outputFileStream = Cc[</span>
<a href="#l1.219"></a><span id="l1.219" class="difflineplus">+      &quot;@mozilla.org/network/file-output-stream;1&quot;</span>
<a href="#l1.220"></a><span id="l1.220" class="difflineplus">+    ].createInstance(Ci.nsIFileOutputStream);</span>
<a href="#l1.221"></a><span id="l1.221" class="difflineplus">+    outputFileStream.init(exportFile, -1, -1, 0);</span>
<a href="#l1.222"></a><span id="l1.222" class="difflineplus">+    let outputStream = Cc[</span>
<a href="#l1.223"></a><span id="l1.223" class="difflineplus">+      &quot;@mozilla.org/intl/converter-output-stream;1&quot;</span>
<a href="#l1.224"></a><span id="l1.224" class="difflineplus">+    ].createInstance(Ci.nsIConverterOutputStream);</span>
<a href="#l1.225"></a><span id="l1.225" class="difflineplus">+    outputStream.init(outputFileStream, charset);</span>
<a href="#l1.226"></a><span id="l1.226" class="difflineplus">+    outputStream.writeString(output);</span>
<a href="#l1.227"></a><span id="l1.227" class="difflineplus">+    outputStream.close();</span>
<a href="#l1.228"></a><span id="l1.228" class="difflineplus">+  });</span>
<a href="#l1.229"></a><span id="l1.229"> }</span>
<a href="#l1.230"></a><span id="l1.230"> </span>
<a href="#l1.231"></a><span id="l1.231"> function SetStatusText(total) {</span>
<a href="#l1.232"></a><span id="l1.232">   if (!gStatusText) {</span>
<a href="#l1.233"></a><span id="l1.233">     gStatusText = document.getElementById(&quot;statusText&quot;);</span>
<a href="#l1.234"></a><span id="l1.234">   }</span>
<a href="#l1.235"></a><span id="l1.235"> </span>
<a href="#l1.236"></a><span id="l1.236">   try {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/addrbook/jsaddrbook/AddrBookManager.jsm</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/addrbook/jsaddrbook/AddrBookManager.jsm</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -359,19 +359,16 @@ AddrBookManager.prototype = {</span>
<a href="#l2.4"></a><span id="l2.4">           file.remove(false);</span>
<a href="#l2.5"></a><span id="l2.5">         }</span>
<a href="#l2.6"></a><span id="l2.6">         this.notifyDirectoryDeleted(null, dir);</span>
<a href="#l2.7"></a><span id="l2.7">       });</span>
<a href="#l2.8"></a><span id="l2.8">     } else {</span>
<a href="#l2.9"></a><span id="l2.9">       this.notifyDirectoryDeleted(null, dir);</span>
<a href="#l2.10"></a><span id="l2.10">     }</span>
<a href="#l2.11"></a><span id="l2.11">   },</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-  exportAddressBook(parentWin, directory) {</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-    throw Cr.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineminus">-  },</span>
<a href="#l2.15"></a><span id="l2.15">   addAddressBookListener(listener, notifyFlags) {</span>
<a href="#l2.16"></a><span id="l2.16">     listeners.set(listener, notifyFlags);</span>
<a href="#l2.17"></a><span id="l2.17">   },</span>
<a href="#l2.18"></a><span id="l2.18">   removeAddressBookListener(listener) {</span>
<a href="#l2.19"></a><span id="l2.19">     listeners.delete(listener);</span>
<a href="#l2.20"></a><span id="l2.20">   },</span>
<a href="#l2.21"></a><span id="l2.21">   notifyItemPropertyChanged(item, property, oldValue, newValue) {</span>
<a href="#l2.22"></a><span id="l2.22">     for (let [listener, notifyFlags] of listeners.entries()) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/addrbook/jsaddrbook/AddrBookUtils.jsm</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/addrbook/jsaddrbook/AddrBookUtils.jsm</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -1,26 +1,38 @@</span>
<a href="#l3.4"></a><span id="l3.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l3.5"></a><span id="l3.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l3.6"></a><span id="l3.6">  * file, you can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l3.7"></a><span id="l3.7"> </span>
<a href="#l3.8"></a><span id="l3.8" class="difflineminus">-this.EXPORTED_SYMBOLS = [&quot;newUID&quot;, &quot;SimpleEnumerator&quot;];</span>
<a href="#l3.9"></a><span id="l3.9" class="difflineplus">+this.EXPORTED_SYMBOLS = [</span>
<a href="#l3.10"></a><span id="l3.10" class="difflineplus">+  &quot;exportDirectoryToDelimitedText&quot;,</span>
<a href="#l3.11"></a><span id="l3.11" class="difflineplus">+  &quot;exportDirectoryToLDIF&quot;,</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+  &quot;exportDirectoryToVCard&quot;,</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+  &quot;newUID&quot;,</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+  &quot;SimpleEnumerator&quot;,</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+];</span>
<a href="#l3.16"></a><span id="l3.16"> </span>
<a href="#l3.17"></a><span id="l3.17" class="difflineminus">-ChromeUtils.defineModuleGetter(</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineminus">-  this,</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineminus">-  &quot;XPCOMUtils&quot;,</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineplus">+const { AppConstants } = ChromeUtils.import(</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineplus">+  &quot;resource://gre/modules/AppConstants.jsm&quot;</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineplus">+);</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineplus">+const { MailServices } = ChromeUtils.import(</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineplus">+  &quot;resource:///modules/MailServices.jsm&quot;</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineplus">+);</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineplus">+const { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineplus">+const { XPCOMUtils } = ChromeUtils.import(</span>
<a href="#l3.28"></a><span id="l3.28">   &quot;resource://gre/modules/XPCOMUtils.jsm&quot;</span>
<a href="#l3.29"></a><span id="l3.29"> );</span>
<a href="#l3.30"></a><span id="l3.30"> </span>
<a href="#l3.31"></a><span id="l3.31" class="difflineminus">-XPCOMUtils.defineLazyServiceGetter(</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineminus">-  this,</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineminus">-  &quot;uuidGenerator&quot;,</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineminus">-  &quot;@mozilla.org/uuid-generator;1&quot;,</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineminus">-  &quot;nsIUUIDGenerator&quot;</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineminus">-);</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineplus">+XPCOMUtils.defineLazyServiceGetters(this, {</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineplus">+  attrMapService: [</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineplus">+    &quot;@mozilla.org/addressbook/ldap-attribute-map-service;1&quot;,</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineplus">+    &quot;nsIAbLDAPAttributeMapService&quot;,</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineplus">+  ],</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineplus">+  uuidGenerator: [&quot;@mozilla.org/uuid-generator;1&quot;, &quot;nsIUUIDGenerator&quot;],</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineplus">+});</span>
<a href="#l3.44"></a><span id="l3.44"> </span>
<a href="#l3.45"></a><span id="l3.45"> function SimpleEnumerator(elements) {</span>
<a href="#l3.46"></a><span id="l3.46">   this._elements = elements;</span>
<a href="#l3.47"></a><span id="l3.47">   this._position = 0;</span>
<a href="#l3.48"></a><span id="l3.48"> }</span>
<a href="#l3.49"></a><span id="l3.49"> SimpleEnumerator.prototype = {</span>
<a href="#l3.50"></a><span id="l3.50">   hasMoreElements() {</span>
<a href="#l3.51"></a><span id="l3.51">     return this._position &lt; this._elements.length;</span>
<a href="#l3.52"></a><span id="l3.52" class="difflineat">@@ -40,8 +52,228 @@ SimpleEnumerator.prototype = {</span>
<a href="#l3.53"></a><span id="l3.53"> };</span>
<a href="#l3.54"></a><span id="l3.54"> </span>
<a href="#l3.55"></a><span id="l3.55"> function newUID() {</span>
<a href="#l3.56"></a><span id="l3.56">   return uuidGenerator</span>
<a href="#l3.57"></a><span id="l3.57">     .generateUUID()</span>
<a href="#l3.58"></a><span id="l3.58">     .toString()</span>
<a href="#l3.59"></a><span id="l3.59">     .substring(1, 37);</span>
<a href="#l3.60"></a><span id="l3.60"> }</span>
<a href="#l3.61"></a><span id="l3.61" class="difflineplus">+</span>
<a href="#l3.62"></a><span id="l3.62" class="difflineplus">+const exportAttributes = [</span>
<a href="#l3.63"></a><span id="l3.63" class="difflineplus">+  [&quot;FirstName&quot;, 2100],</span>
<a href="#l3.64"></a><span id="l3.64" class="difflineplus">+  [&quot;LastName&quot;, 2101],</span>
<a href="#l3.65"></a><span id="l3.65" class="difflineplus">+  [&quot;DisplayName&quot;, 2102],</span>
<a href="#l3.66"></a><span id="l3.66" class="difflineplus">+  [&quot;NickName&quot;, 2103],</span>
<a href="#l3.67"></a><span id="l3.67" class="difflineplus">+  [&quot;PrimaryEmail&quot;, 2104],</span>
<a href="#l3.68"></a><span id="l3.68" class="difflineplus">+  [&quot;SecondEmail&quot;, 2105],</span>
<a href="#l3.69"></a><span id="l3.69" class="difflineplus">+  [&quot;_AimScreenName&quot;, 2136],</span>
<a href="#l3.70"></a><span id="l3.70" class="difflineplus">+  [&quot;PreferMailFormat&quot;, 0],</span>
<a href="#l3.71"></a><span id="l3.71" class="difflineplus">+  [&quot;LastModifiedDate&quot;, 0],</span>
<a href="#l3.72"></a><span id="l3.72" class="difflineplus">+  [&quot;WorkPhone&quot;, 2106],</span>
<a href="#l3.73"></a><span id="l3.73" class="difflineplus">+  [&quot;WorkPhoneType&quot;, 0],</span>
<a href="#l3.74"></a><span id="l3.74" class="difflineplus">+  [&quot;HomePhone&quot;, 2107],</span>
<a href="#l3.75"></a><span id="l3.75" class="difflineplus">+  [&quot;HomePhoneType&quot;, 0],</span>
<a href="#l3.76"></a><span id="l3.76" class="difflineplus">+  [&quot;FaxNumber&quot;, 2108],</span>
<a href="#l3.77"></a><span id="l3.77" class="difflineplus">+  [&quot;FaxNumberType&quot;, 0],</span>
<a href="#l3.78"></a><span id="l3.78" class="difflineplus">+  [&quot;PagerNumber&quot;, 2109],</span>
<a href="#l3.79"></a><span id="l3.79" class="difflineplus">+  [&quot;PagerNumberType&quot;, 0],</span>
<a href="#l3.80"></a><span id="l3.80" class="difflineplus">+  [&quot;CellularNumber&quot;, 2110],</span>
<a href="#l3.81"></a><span id="l3.81" class="difflineplus">+  [&quot;CellularNumberType&quot;, 0],</span>
<a href="#l3.82"></a><span id="l3.82" class="difflineplus">+  [&quot;HomeAddress&quot;, 2111],</span>
<a href="#l3.83"></a><span id="l3.83" class="difflineplus">+  [&quot;HomeAddress2&quot;, 2112],</span>
<a href="#l3.84"></a><span id="l3.84" class="difflineplus">+  [&quot;HomeCity&quot;, 2113],</span>
<a href="#l3.85"></a><span id="l3.85" class="difflineplus">+  [&quot;HomeState&quot;, 2114],</span>
<a href="#l3.86"></a><span id="l3.86" class="difflineplus">+  [&quot;HomeZipCode&quot;, 2115],</span>
<a href="#l3.87"></a><span id="l3.87" class="difflineplus">+  [&quot;HomeCountry&quot;, 2116],</span>
<a href="#l3.88"></a><span id="l3.88" class="difflineplus">+  [&quot;WorkAddress&quot;, 2117],</span>
<a href="#l3.89"></a><span id="l3.89" class="difflineplus">+  [&quot;WorkAddress2&quot;, 2118],</span>
<a href="#l3.90"></a><span id="l3.90" class="difflineplus">+  [&quot;WorkCity&quot;, 2119],</span>
<a href="#l3.91"></a><span id="l3.91" class="difflineplus">+  [&quot;WorkState&quot;, 2120],</span>
<a href="#l3.92"></a><span id="l3.92" class="difflineplus">+  [&quot;WorkZipCode&quot;, 2121],</span>
<a href="#l3.93"></a><span id="l3.93" class="difflineplus">+  [&quot;WorkCountry&quot;, 2122],</span>
<a href="#l3.94"></a><span id="l3.94" class="difflineplus">+  [&quot;JobTitle&quot;, 2123],</span>
<a href="#l3.95"></a><span id="l3.95" class="difflineplus">+  [&quot;Department&quot;, 2124],</span>
<a href="#l3.96"></a><span id="l3.96" class="difflineplus">+  [&quot;Company&quot;, 2125],</span>
<a href="#l3.97"></a><span id="l3.97" class="difflineplus">+  [&quot;WebPage1&quot;, 2126],</span>
<a href="#l3.98"></a><span id="l3.98" class="difflineplus">+  [&quot;WebPage2&quot;, 2127],</span>
<a href="#l3.99"></a><span id="l3.99" class="difflineplus">+  [&quot;BirthYear&quot;, 2128],</span>
<a href="#l3.100"></a><span id="l3.100" class="difflineplus">+  [&quot;BirthMonth&quot;, 2129],</span>
<a href="#l3.101"></a><span id="l3.101" class="difflineplus">+  [&quot;BirthDay&quot;, 2130],</span>
<a href="#l3.102"></a><span id="l3.102" class="difflineplus">+  [&quot;Custom1&quot;, 2131],</span>
<a href="#l3.103"></a><span id="l3.103" class="difflineplus">+  [&quot;Custom2&quot;, 2132],</span>
<a href="#l3.104"></a><span id="l3.104" class="difflineplus">+  [&quot;Custom3&quot;, 2133],</span>
<a href="#l3.105"></a><span id="l3.105" class="difflineplus">+  [&quot;Custom4&quot;, 2134],</span>
<a href="#l3.106"></a><span id="l3.106" class="difflineplus">+  [&quot;Notes&quot;, 2135],</span>
<a href="#l3.107"></a><span id="l3.107" class="difflineplus">+  [&quot;AnniversaryYear&quot;, 0],</span>
<a href="#l3.108"></a><span id="l3.108" class="difflineplus">+  [&quot;AnniversaryMonth&quot;, 0],</span>
<a href="#l3.109"></a><span id="l3.109" class="difflineplus">+  [&quot;AnniversaryDay&quot;, 0],</span>
<a href="#l3.110"></a><span id="l3.110" class="difflineplus">+  [&quot;SpouseName&quot;, 0],</span>
<a href="#l3.111"></a><span id="l3.111" class="difflineplus">+  [&quot;FamilyName&quot;, 0],</span>
<a href="#l3.112"></a><span id="l3.112" class="difflineplus">+];</span>
<a href="#l3.113"></a><span id="l3.113" class="difflineplus">+const LINEBREAK = AppConstants.platform == &quot;win&quot; ? &quot;\r\n&quot; : &quot;\n&quot;;</span>
<a href="#l3.114"></a><span id="l3.114" class="difflineplus">+</span>
<a href="#l3.115"></a><span id="l3.115" class="difflineplus">+function exportDirectoryToDelimitedText(directory, delimiter) {</span>
<a href="#l3.116"></a><span id="l3.116" class="difflineplus">+  let bundle = Services.strings.createBundle(</span>
<a href="#l3.117"></a><span id="l3.117" class="difflineplus">+    &quot;chrome://messenger/locale/importMsgs.properties&quot;</span>
<a href="#l3.118"></a><span id="l3.118" class="difflineplus">+  );</span>
<a href="#l3.119"></a><span id="l3.119" class="difflineplus">+  let output = &quot;&quot;;</span>
<a href="#l3.120"></a><span id="l3.120" class="difflineplus">+  for (let i = 0; i &lt; exportAttributes.length; i++) {</span>
<a href="#l3.121"></a><span id="l3.121" class="difflineplus">+    let [, plainTextStringID] = exportAttributes[i];</span>
<a href="#l3.122"></a><span id="l3.122" class="difflineplus">+    if (plainTextStringID != 0) {</span>
<a href="#l3.123"></a><span id="l3.123" class="difflineplus">+      if (i != 0) {</span>
<a href="#l3.124"></a><span id="l3.124" class="difflineplus">+        output += delimiter;</span>
<a href="#l3.125"></a><span id="l3.125" class="difflineplus">+      }</span>
<a href="#l3.126"></a><span id="l3.126" class="difflineplus">+      output += bundle.GetStringFromID(plainTextStringID);</span>
<a href="#l3.127"></a><span id="l3.127" class="difflineplus">+    }</span>
<a href="#l3.128"></a><span id="l3.128" class="difflineplus">+  }</span>
<a href="#l3.129"></a><span id="l3.129" class="difflineplus">+  output += LINEBREAK;</span>
<a href="#l3.130"></a><span id="l3.130" class="difflineplus">+  for (let card of directory.childCards) {</span>
<a href="#l3.131"></a><span id="l3.131" class="difflineplus">+    if (card.isMailList) {</span>
<a href="#l3.132"></a><span id="l3.132" class="difflineplus">+      // .tab, .txt and .csv aren't able to export mailing lists.</span>
<a href="#l3.133"></a><span id="l3.133" class="difflineplus">+      // Use LDIF for that.</span>
<a href="#l3.134"></a><span id="l3.134" class="difflineplus">+      continue;</span>
<a href="#l3.135"></a><span id="l3.135" class="difflineplus">+    }</span>
<a href="#l3.136"></a><span id="l3.136" class="difflineplus">+    for (let i = 0; i &lt; exportAttributes.length; i++) {</span>
<a href="#l3.137"></a><span id="l3.137" class="difflineplus">+      let [abPropertyName, plainTextStringID] = exportAttributes[i];</span>
<a href="#l3.138"></a><span id="l3.138" class="difflineplus">+      if (plainTextStringID == 0) {</span>
<a href="#l3.139"></a><span id="l3.139" class="difflineplus">+        continue;</span>
<a href="#l3.140"></a><span id="l3.140" class="difflineplus">+      }</span>
<a href="#l3.141"></a><span id="l3.141" class="difflineplus">+      if (i != 0) {</span>
<a href="#l3.142"></a><span id="l3.142" class="difflineplus">+        output += delimiter;</span>
<a href="#l3.143"></a><span id="l3.143" class="difflineplus">+      }</span>
<a href="#l3.144"></a><span id="l3.144" class="difflineplus">+      let value = card.getProperty(abPropertyName) || &quot;&quot;;</span>
<a href="#l3.145"></a><span id="l3.145" class="difflineplus">+</span>
<a href="#l3.146"></a><span id="l3.146" class="difflineplus">+      // If a string contains at least one comma, tab, double quote or line</span>
<a href="#l3.147"></a><span id="l3.147" class="difflineplus">+      // break then we need to quote the entire string. Also if double quote</span>
<a href="#l3.148"></a><span id="l3.148" class="difflineplus">+      // is part of the string we need to quote the double quote(s) as well.</span>
<a href="#l3.149"></a><span id="l3.149" class="difflineplus">+      let needsQuotes = false;</span>
<a href="#l3.150"></a><span id="l3.150" class="difflineplus">+      if (value.includes('&quot;')) {</span>
<a href="#l3.151"></a><span id="l3.151" class="difflineplus">+        needsQuotes = true;</span>
<a href="#l3.152"></a><span id="l3.152" class="difflineplus">+        value = value.replace(/&quot;/g, '&quot;&quot;');</span>
<a href="#l3.153"></a><span id="l3.153" class="difflineplus">+      } else if (/[,\t\r\n]/.test(value)) {</span>
<a href="#l3.154"></a><span id="l3.154" class="difflineplus">+        needsQuotes = true;</span>
<a href="#l3.155"></a><span id="l3.155" class="difflineplus">+      }</span>
<a href="#l3.156"></a><span id="l3.156" class="difflineplus">+      if (needsQuotes) {</span>
<a href="#l3.157"></a><span id="l3.157" class="difflineplus">+        value = `&quot;${value}&quot;`;</span>
<a href="#l3.158"></a><span id="l3.158" class="difflineplus">+      }</span>
<a href="#l3.159"></a><span id="l3.159" class="difflineplus">+</span>
<a href="#l3.160"></a><span id="l3.160" class="difflineplus">+      output += value;</span>
<a href="#l3.161"></a><span id="l3.161" class="difflineplus">+    }</span>
<a href="#l3.162"></a><span id="l3.162" class="difflineplus">+    output += LINEBREAK;</span>
<a href="#l3.163"></a><span id="l3.163" class="difflineplus">+  }</span>
<a href="#l3.164"></a><span id="l3.164" class="difflineplus">+</span>
<a href="#l3.165"></a><span id="l3.165" class="difflineplus">+  return output;</span>
<a href="#l3.166"></a><span id="l3.166" class="difflineplus">+}</span>
<a href="#l3.167"></a><span id="l3.167" class="difflineplus">+</span>
<a href="#l3.168"></a><span id="l3.168" class="difflineplus">+function exportDirectoryToLDIF(directory) {</span>
<a href="#l3.169"></a><span id="l3.169" class="difflineplus">+  function appendProperty(name, value) {</span>
<a href="#l3.170"></a><span id="l3.170" class="difflineplus">+    if (!value) {</span>
<a href="#l3.171"></a><span id="l3.171" class="difflineplus">+      return;</span>
<a href="#l3.172"></a><span id="l3.172" class="difflineplus">+    }</span>
<a href="#l3.173"></a><span id="l3.173" class="difflineplus">+    // Follow RFC 2849 to determine if something is safe &quot;as is&quot; for LDIF.</span>
<a href="#l3.174"></a><span id="l3.174" class="difflineplus">+    // If not, base 64 encode it as UTF-8.</span>
<a href="#l3.175"></a><span id="l3.175" class="difflineplus">+    if (</span>
<a href="#l3.176"></a><span id="l3.176" class="difflineplus">+      value[0] == &quot; &quot; ||</span>
<a href="#l3.177"></a><span id="l3.177" class="difflineplus">+      value[0] == &quot;:&quot; ||</span>
<a href="#l3.178"></a><span id="l3.178" class="difflineplus">+      value[0] == &quot;&lt;&quot; ||</span>
<a href="#l3.179"></a><span id="l3.179" class="difflineplus">+      /[\0\r\n\u0080-\uffff]/.test(value)</span>
<a href="#l3.180"></a><span id="l3.180" class="difflineplus">+    ) {</span>
<a href="#l3.181"></a><span id="l3.181" class="difflineplus">+      let utf8Bytes = new TextEncoder().encode(value);</span>
<a href="#l3.182"></a><span id="l3.182" class="difflineplus">+      let byteString = String.fromCharCode(...utf8Bytes);</span>
<a href="#l3.183"></a><span id="l3.183" class="difflineplus">+      output += name + &quot;:: &quot; + btoa(byteString) + LINEBREAK;</span>
<a href="#l3.184"></a><span id="l3.184" class="difflineplus">+    } else {</span>
<a href="#l3.185"></a><span id="l3.185" class="difflineplus">+      output += name + &quot;: &quot; + value + LINEBREAK;</span>
<a href="#l3.186"></a><span id="l3.186" class="difflineplus">+    }</span>
<a href="#l3.187"></a><span id="l3.187" class="difflineplus">+  }</span>
<a href="#l3.188"></a><span id="l3.188" class="difflineplus">+</span>
<a href="#l3.189"></a><span id="l3.189" class="difflineplus">+  function appendDNForCard(property, card, attrMap) {</span>
<a href="#l3.190"></a><span id="l3.190" class="difflineplus">+    let value = &quot;&quot;;</span>
<a href="#l3.191"></a><span id="l3.191" class="difflineplus">+    if (card.displayName) {</span>
<a href="#l3.192"></a><span id="l3.192" class="difflineplus">+      value +=</span>
<a href="#l3.193"></a><span id="l3.193" class="difflineplus">+        attrMap.getFirstAttribute(&quot;DisplayName&quot;) + &quot;=&quot; + card.displayName;</span>
<a href="#l3.194"></a><span id="l3.194" class="difflineplus">+    }</span>
<a href="#l3.195"></a><span id="l3.195" class="difflineplus">+    if (card.primaryEmail) {</span>
<a href="#l3.196"></a><span id="l3.196" class="difflineplus">+      if (card.displayName) {</span>
<a href="#l3.197"></a><span id="l3.197" class="difflineplus">+        value += &quot;,&quot;;</span>
<a href="#l3.198"></a><span id="l3.198" class="difflineplus">+      }</span>
<a href="#l3.199"></a><span id="l3.199" class="difflineplus">+      value +=</span>
<a href="#l3.200"></a><span id="l3.200" class="difflineplus">+        attrMap.getFirstAttribute(&quot;PrimaryEmail&quot;) + &quot;=&quot; + card.primaryEmail;</span>
<a href="#l3.201"></a><span id="l3.201" class="difflineplus">+    }</span>
<a href="#l3.202"></a><span id="l3.202" class="difflineplus">+    appendProperty(property, value);</span>
<a href="#l3.203"></a><span id="l3.203" class="difflineplus">+  }</span>
<a href="#l3.204"></a><span id="l3.204" class="difflineplus">+</span>
<a href="#l3.205"></a><span id="l3.205" class="difflineplus">+  let output = &quot;&quot;;</span>
<a href="#l3.206"></a><span id="l3.206" class="difflineplus">+  let attrMap = attrMapService.getMapForPrefBranch(</span>
<a href="#l3.207"></a><span id="l3.207" class="difflineplus">+    &quot;ldap_2.servers.default.attrmap&quot;</span>
<a href="#l3.208"></a><span id="l3.208" class="difflineplus">+  );</span>
<a href="#l3.209"></a><span id="l3.209" class="difflineplus">+</span>
<a href="#l3.210"></a><span id="l3.210" class="difflineplus">+  for (let card of directory.childCards) {</span>
<a href="#l3.211"></a><span id="l3.211" class="difflineplus">+    if (card.isMailList) {</span>
<a href="#l3.212"></a><span id="l3.212" class="difflineplus">+      appendDNForCard(&quot;dn&quot;, card, attrMap);</span>
<a href="#l3.213"></a><span id="l3.213" class="difflineplus">+      appendProperty(&quot;objectclass&quot;, &quot;top&quot;);</span>
<a href="#l3.214"></a><span id="l3.214" class="difflineplus">+      appendProperty(&quot;objectclass&quot;, &quot;groupOfNames&quot;);</span>
<a href="#l3.215"></a><span id="l3.215" class="difflineplus">+      appendProperty(</span>
<a href="#l3.216"></a><span id="l3.216" class="difflineplus">+        attrMap.getFirstAttribute(&quot;DisplayName&quot;),</span>
<a href="#l3.217"></a><span id="l3.217" class="difflineplus">+        card.displayName</span>
<a href="#l3.218"></a><span id="l3.218" class="difflineplus">+      );</span>
<a href="#l3.219"></a><span id="l3.219" class="difflineplus">+      if (card.getProperty(&quot;NickName&quot;)) {</span>
<a href="#l3.220"></a><span id="l3.220" class="difflineplus">+        appendProperty(</span>
<a href="#l3.221"></a><span id="l3.221" class="difflineplus">+          attrMap.getFirstAttribute(&quot;NickName&quot;),</span>
<a href="#l3.222"></a><span id="l3.222" class="difflineplus">+          card.getProperty(&quot;NickName&quot;)</span>
<a href="#l3.223"></a><span id="l3.223" class="difflineplus">+        );</span>
<a href="#l3.224"></a><span id="l3.224" class="difflineplus">+      }</span>
<a href="#l3.225"></a><span id="l3.225" class="difflineplus">+      if (card.getProperty(&quot;Notes&quot;)) {</span>
<a href="#l3.226"></a><span id="l3.226" class="difflineplus">+        appendProperty(</span>
<a href="#l3.227"></a><span id="l3.227" class="difflineplus">+          attrMap.getFirstAttribute(&quot;Notes&quot;),</span>
<a href="#l3.228"></a><span id="l3.228" class="difflineplus">+          card.getProperty(&quot;Notes&quot;)</span>
<a href="#l3.229"></a><span id="l3.229" class="difflineplus">+        );</span>
<a href="#l3.230"></a><span id="l3.230" class="difflineplus">+      }</span>
<a href="#l3.231"></a><span id="l3.231" class="difflineplus">+      let listAsDirectory = MailServices.ab.getDirectory(card.mailListURI);</span>
<a href="#l3.232"></a><span id="l3.232" class="difflineplus">+      for (let childCard of listAsDirectory.childCards) {</span>
<a href="#l3.233"></a><span id="l3.233" class="difflineplus">+        appendDNForCard(&quot;member&quot;, childCard, attrMap);</span>
<a href="#l3.234"></a><span id="l3.234" class="difflineplus">+      }</span>
<a href="#l3.235"></a><span id="l3.235" class="difflineplus">+    } else {</span>
<a href="#l3.236"></a><span id="l3.236" class="difflineplus">+      appendDNForCard(&quot;dn&quot;, card, attrMap);</span>
<a href="#l3.237"></a><span id="l3.237" class="difflineplus">+      appendProperty(&quot;objectclass&quot;, &quot;top&quot;);</span>
<a href="#l3.238"></a><span id="l3.238" class="difflineplus">+      appendProperty(&quot;objectclass&quot;, &quot;person&quot;);</span>
<a href="#l3.239"></a><span id="l3.239" class="difflineplus">+      appendProperty(&quot;objectclass&quot;, &quot;organizationalPerson&quot;);</span>
<a href="#l3.240"></a><span id="l3.240" class="difflineplus">+      appendProperty(&quot;objectclass&quot;, &quot;inetOrgPerson&quot;);</span>
<a href="#l3.241"></a><span id="l3.241" class="difflineplus">+      appendProperty(&quot;objectclass&quot;, &quot;mozillaAbPersonAlpha&quot;);</span>
<a href="#l3.242"></a><span id="l3.242" class="difflineplus">+</span>
<a href="#l3.243"></a><span id="l3.243" class="difflineplus">+      for (let i = 0; i &lt; exportAttributes.length; i++) {</span>
<a href="#l3.244"></a><span id="l3.244" class="difflineplus">+        let [abPropertyName] = exportAttributes[i];</span>
<a href="#l3.245"></a><span id="l3.245" class="difflineplus">+        let attrName = attrMap.getFirstAttribute(abPropertyName);</span>
<a href="#l3.246"></a><span id="l3.246" class="difflineplus">+        if (attrName) {</span>
<a href="#l3.247"></a><span id="l3.247" class="difflineplus">+          let attrValue = card.getProperty(abPropertyName);</span>
<a href="#l3.248"></a><span id="l3.248" class="difflineplus">+          if (abPropertyName == &quot;PreferMailFormat&quot;) {</span>
<a href="#l3.249"></a><span id="l3.249" class="difflineplus">+            if (attrValue == &quot;html&quot;) {</span>
<a href="#l3.250"></a><span id="l3.250" class="difflineplus">+              attrValue = &quot;true&quot;;</span>
<a href="#l3.251"></a><span id="l3.251" class="difflineplus">+            } else if (attrValue == &quot;plaintext&quot;) {</span>
<a href="#l3.252"></a><span id="l3.252" class="difflineplus">+              attrValue = &quot;false&quot;;</span>
<a href="#l3.253"></a><span id="l3.253" class="difflineplus">+            }</span>
<a href="#l3.254"></a><span id="l3.254" class="difflineplus">+            // unknown.</span>
<a href="#l3.255"></a><span id="l3.255" class="difflineplus">+            else {</span>
<a href="#l3.256"></a><span id="l3.256" class="difflineplus">+              attrValue = &quot;&quot;;</span>
<a href="#l3.257"></a><span id="l3.257" class="difflineplus">+            }</span>
<a href="#l3.258"></a><span id="l3.258" class="difflineplus">+          }</span>
<a href="#l3.259"></a><span id="l3.259" class="difflineplus">+</span>
<a href="#l3.260"></a><span id="l3.260" class="difflineplus">+          appendProperty(attrName, attrValue);</span>
<a href="#l3.261"></a><span id="l3.261" class="difflineplus">+        }</span>
<a href="#l3.262"></a><span id="l3.262" class="difflineplus">+      }</span>
<a href="#l3.263"></a><span id="l3.263" class="difflineplus">+    }</span>
<a href="#l3.264"></a><span id="l3.264" class="difflineplus">+    output += LINEBREAK;</span>
<a href="#l3.265"></a><span id="l3.265" class="difflineplus">+  }</span>
<a href="#l3.266"></a><span id="l3.266" class="difflineplus">+</span>
<a href="#l3.267"></a><span id="l3.267" class="difflineplus">+  return output;</span>
<a href="#l3.268"></a><span id="l3.268" class="difflineplus">+}</span>
<a href="#l3.269"></a><span id="l3.269" class="difflineplus">+</span>
<a href="#l3.270"></a><span id="l3.270" class="difflineplus">+function exportDirectoryToVCard(directory) {</span>
<a href="#l3.271"></a><span id="l3.271" class="difflineplus">+  let output = &quot;&quot;;</span>
<a href="#l3.272"></a><span id="l3.272" class="difflineplus">+  for (let card of directory.childCards) {</span>
<a href="#l3.273"></a><span id="l3.273" class="difflineplus">+    if (!card.isMailList) {</span>
<a href="#l3.274"></a><span id="l3.274" class="difflineplus">+      // We don't know how to export mailing lists to vcf.</span>
<a href="#l3.275"></a><span id="l3.275" class="difflineplus">+      // Use LDIF for that.</span>
<a href="#l3.276"></a><span id="l3.276" class="difflineplus">+      output += decodeURIComponent(card.translateTo(&quot;vcard&quot;));</span>
<a href="#l3.277"></a><span id="l3.277" class="difflineplus">+    }</span>
<a href="#l3.278"></a><span id="l3.278" class="difflineplus">+  }</span>
<a href="#l3.279"></a><span id="l3.279" class="difflineplus">+  return output;</span>
<a href="#l3.280"></a><span id="l3.280" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/addrbook/public/nsIAbManager.idl</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/addrbook/public/nsIAbManager.idl</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -63,25 +63,16 @@ interface nsIAbManager : nsISupports</span>
<a href="#l4.4"></a><span id="l4.4">    * Deletes an address book.</span>
<a href="#l4.5"></a><span id="l4.5">    *</span>
<a href="#l4.6"></a><span id="l4.6">    * @param  aURI       The URI for the address book. This is specific to each</span>
<a href="#l4.7"></a><span id="l4.7">    *                    type of address book.</span>
<a href="#l4.8"></a><span id="l4.8">    */</span>
<a href="#l4.9"></a><span id="l4.9">   void deleteAddressBook(in ACString aURI);</span>
<a href="#l4.10"></a><span id="l4.10"> </span>
<a href="#l4.11"></a><span id="l4.11">   /**</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-   * Exports an address book, it will provide a dialog to the user for the</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineminus">-   * location to save the file to and will then save the address book to media.</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineminus">-   *</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineminus">-   * @param  aParentWin Parent Window for the file save dialog to use.</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineminus">-   * @param  aDirectory The directory to export.</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineminus">-   */</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineminus">-  void exportAddressBook(in mozIDOMWindowProxy aParentWin, in nsIAbDirectory aDirectory);</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineminus">-</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineminus">-  /**</span>
<a href="#l4.21"></a><span id="l4.21">    * Adds a nsIAbListener to receive notifications of address book updates</span>
<a href="#l4.22"></a><span id="l4.22">    * according to the specified notifyFlags.</span>
<a href="#l4.23"></a><span id="l4.23">    *</span>
<a href="#l4.24"></a><span id="l4.24">    * @param  aListener      The listener that is to receive updates.</span>
<a href="#l4.25"></a><span id="l4.25">    * @param  aNotifyFlags   A bitwise-or of abListenerNotifyFlagValue items</span>
<a href="#l4.26"></a><span id="l4.26">    *                        specifying which notifications to receive. See</span>
<a href="#l4.27"></a><span id="l4.27">    *                        nsIAbListener for possible values.</span>
<a href="#l4.28"></a><span id="l4.28">    */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1">new file mode 100644</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineminus">--- /dev/null</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineplus">+++ b/mailnews/addrbook/test/unit/data/export.csv</span>
<a href="#l5.4"></a><span id="l5.4" class="difflineat">@@ -0,0 +1,4 @@</span>
<a href="#l5.5"></a><span id="l5.5" class="difflineplus">+First Name,Last Name,Display Name,Nickname,Primary Email,Secondary Email,Screen Name,Work Phone,Home Phone,Fax Number,Pager Number,Mobile Number,Home Address,Home Address 2,Home City,Home State,Home ZipCode,Home Country,Work Address,Work Address 2,Work City,Work State,Work ZipCode,Work Country,Job Title,Department,Organization,Web Page 1,Web Page 2,Birth Year,Birth Month,Birth Day,Custom 1,Custom 2,Custom 3,Custom 4,Notes</span>
<a href="#l5.6"></a><span id="l5.6" class="difflineplus">+contact,one,contact number one,,contact1@invalid,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,</span>
<a href="#l5.7"></a><span id="l5.7" class="difflineplus">+contact,two,contact number two,,contact2@invalid,,,,,,,,,,,,,,,,,,,,&quot;&quot;&quot;worker&quot;&quot;&quot;,,,,,,,,&quot;custom, 1&quot;,&quot;custom	2&quot;,&quot;custom3&quot;,&quot;custom</span>
<a href="#l5.8"></a><span id="l5.8" class="difflineplus">+4&quot;,here's some unicode text…</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1">new file mode 100644</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineminus">--- /dev/null</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineplus">+++ b/mailnews/addrbook/test/unit/data/export.ldif</span>
<a href="#l6.4"></a><span id="l6.4" class="difflineat">@@ -0,0 +1,36 @@</span>
<a href="#l6.5"></a><span id="l6.5" class="difflineplus">+dn: cn=new list</span>
<a href="#l6.6"></a><span id="l6.6" class="difflineplus">+objectclass: top</span>
<a href="#l6.7"></a><span id="l6.7" class="difflineplus">+objectclass: groupOfNames</span>
<a href="#l6.8"></a><span id="l6.8" class="difflineplus">+cn: new list</span>
<a href="#l6.9"></a><span id="l6.9" class="difflineplus">+member: cn=contact number one,mail=contact1@invalid</span>
<a href="#l6.10"></a><span id="l6.10" class="difflineplus">+</span>
<a href="#l6.11"></a><span id="l6.11" class="difflineplus">+dn: cn=contact number one,mail=contact1@invalid</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineplus">+objectclass: top</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+objectclass: person</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+objectclass: organizationalPerson</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineplus">+objectclass: inetOrgPerson</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineplus">+objectclass: mozillaAbPersonAlpha</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineplus">+givenName: contact</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineplus">+sn: one</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineplus">+cn: contact number one</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineplus">+mail: contact1@invalid</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineplus">+modifytimestamp: 0</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineplus">+</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineplus">+dn: cn=contact number two,mail=contact2@invalid</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineplus">+objectclass: top</span>
<a href="#l6.25"></a><span id="l6.25" class="difflineplus">+objectclass: person</span>
<a href="#l6.26"></a><span id="l6.26" class="difflineplus">+objectclass: organizationalPerson</span>
<a href="#l6.27"></a><span id="l6.27" class="difflineplus">+objectclass: inetOrgPerson</span>
<a href="#l6.28"></a><span id="l6.28" class="difflineplus">+objectclass: mozillaAbPersonAlpha</span>
<a href="#l6.29"></a><span id="l6.29" class="difflineplus">+givenName: contact</span>
<a href="#l6.30"></a><span id="l6.30" class="difflineplus">+sn: two</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineplus">+cn: contact number two</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineplus">+mail: contact2@invalid</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineplus">+modifytimestamp: 0</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineplus">+title: &quot;worker&quot;</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineplus">+mozillaCustom1: custom, 1</span>
<a href="#l6.36"></a><span id="l6.36" class="difflineplus">+mozillaCustom2: custom	2</span>
<a href="#l6.37"></a><span id="l6.37" class="difflineplus">+mozillaCustom3:: Y3VzdG9tDTM=</span>
<a href="#l6.38"></a><span id="l6.38" class="difflineplus">+mozillaCustom4:: Y3VzdG9tCjQ=</span>
<a href="#l6.39"></a><span id="l6.39" class="difflineplus">+description:: aGVyZSdzIHNvbWUgdW5pY29kZSB0ZXh04oCm</span>
<a href="#l6.40"></a><span id="l6.40" class="difflineplus">+</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1">new file mode 100644</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineminus">--- /dev/null</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineplus">+++ b/mailnews/addrbook/test/unit/data/export.txt</span>
<a href="#l7.4"></a><span id="l7.4" class="difflineat">@@ -0,0 +1,4 @@</span>
<a href="#l7.5"></a><span id="l7.5" class="difflineplus">+First Name	Last Name	Display Name	Nickname	Primary Email	Secondary Email	Screen Name	Work Phone	Home Phone	Fax Number	Pager Number	Mobile Number	Home Address	Home Address 2	Home City	Home State	Home ZipCode	Home Country	Work Address	Work Address 2	Work City	Work State	Work ZipCode	Work Country	Job Title	Department	Organization	Web Page 1	Web Page 2	Birth Year	Birth Month	Birth Day	Custom 1	Custom 2	Custom 3	Custom 4	Notes</span>
<a href="#l7.6"></a><span id="l7.6" class="difflineplus">+contact	one	contact number one		contact1@invalid																																</span>
<a href="#l7.7"></a><span id="l7.7" class="difflineplus">+contact	two	contact number two		contact2@invalid																				&quot;&quot;&quot;worker&quot;&quot;&quot;								&quot;custom, 1&quot;	&quot;custom	2&quot;	&quot;custom3&quot;	&quot;custom</span>
<a href="#l7.8"></a><span id="l7.8" class="difflineplus">+4&quot;	here's some unicode text…</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1">new file mode 100644</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineminus">--- /dev/null</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineplus">+++ b/mailnews/addrbook/test/unit/data/export.vcf</span>
<a href="#l8.4"></a><span id="l8.4" class="difflineat">@@ -0,0 +1,16 @@</span>
<a href="#l8.5"></a><span id="l8.5" class="difflineplus">+begin:vcard</span>
<a href="#l8.6"></a><span id="l8.6" class="difflineplus">+fn:contact number one</span>
<a href="#l8.7"></a><span id="l8.7" class="difflineplus">+n:one;contact</span>
<a href="#l8.8"></a><span id="l8.8" class="difflineplus">+email;internet:contact1@invalid</span>
<a href="#l8.9"></a><span id="l8.9" class="difflineplus">+version:2.1</span>
<a href="#l8.10"></a><span id="l8.10" class="difflineplus">+end:vcard</span>
<a href="#l8.11"></a><span id="l8.11" class="difflineplus">+</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+begin:vcard</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+fn:contact number two</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineplus">+n:two;contact</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineplus">+email;internet:contact2@invalid</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineplus">+title:&quot;worker&quot;</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineplus">+note;quoted-printable:here's some unicode text=E2=80=A6</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineplus">+version:2.1</span>
<a href="#l8.19"></a><span id="l8.19" class="difflineplus">+end:vcard</span>
<a href="#l8.20"></a><span id="l8.20" class="difflineplus">+</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1">new file mode 100644</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineminus">--- /dev/null</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineplus">+++ b/mailnews/addrbook/test/unit/test_export.js</span>
<a href="#l9.4"></a><span id="l9.4" class="difflineat">@@ -0,0 +1,114 @@</span>
<a href="#l9.5"></a><span id="l9.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l9.6"></a><span id="l9.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l9.7"></a><span id="l9.7" class="difflineplus">+ * file, you can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l9.8"></a><span id="l9.8" class="difflineplus">+</span>
<a href="#l9.9"></a><span id="l9.9" class="difflineplus">+&quot;use strict&quot;;</span>
<a href="#l9.10"></a><span id="l9.10" class="difflineplus">+</span>
<a href="#l9.11"></a><span id="l9.11" class="difflineplus">+var {</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineplus">+  exportDirectoryToDelimitedText,</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+  exportDirectoryToLDIF,</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineplus">+  exportDirectoryToVCard,</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineplus">+} = ChromeUtils.import(&quot;resource:///modules/AddrBookUtils.jsm&quot;);</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineplus">+var { AppConstants } = ChromeUtils.import(</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineplus">+  &quot;resource://gre/modules/AppConstants.jsm&quot;</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineplus">+);</span>
<a href="#l9.19"></a><span id="l9.19" class="difflineplus">+var { MailServices } = ChromeUtils.import(</span>
<a href="#l9.20"></a><span id="l9.20" class="difflineplus">+  &quot;resource:///modules/MailServices.jsm&quot;</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineplus">+);</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineplus">+var { OS } = ChromeUtils.import(&quot;resource://gre/modules/osfile.jsm&quot;);</span>
<a href="#l9.23"></a><span id="l9.23" class="difflineplus">+var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l9.24"></a><span id="l9.24" class="difflineplus">+</span>
<a href="#l9.25"></a><span id="l9.25" class="difflineplus">+add_task(async () =&gt; {</span>
<a href="#l9.26"></a><span id="l9.26" class="difflineplus">+  let dirPrefId = MailServices.ab.newAddressBook(&quot;new book&quot;, &quot;&quot;, 101);</span>
<a href="#l9.27"></a><span id="l9.27" class="difflineplus">+  let book = MailServices.ab.getDirectoryFromId(dirPrefId);</span>
<a href="#l9.28"></a><span id="l9.28" class="difflineplus">+</span>
<a href="#l9.29"></a><span id="l9.29" class="difflineplus">+  let contact1 = Cc[&quot;@mozilla.org/addressbook/cardproperty;1&quot;].createInstance(</span>
<a href="#l9.30"></a><span id="l9.30" class="difflineplus">+    Ci.nsIAbCard</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineplus">+  );</span>
<a href="#l9.32"></a><span id="l9.32" class="difflineplus">+  contact1.displayName = &quot;contact number one&quot;;</span>
<a href="#l9.33"></a><span id="l9.33" class="difflineplus">+  contact1.firstName = &quot;contact&quot;;</span>
<a href="#l9.34"></a><span id="l9.34" class="difflineplus">+  contact1.lastName = &quot;one&quot;;</span>
<a href="#l9.35"></a><span id="l9.35" class="difflineplus">+  contact1.primaryEmail = &quot;contact1@invalid&quot;;</span>
<a href="#l9.36"></a><span id="l9.36" class="difflineplus">+  contact1 = book.addCard(contact1);</span>
<a href="#l9.37"></a><span id="l9.37" class="difflineplus">+</span>
<a href="#l9.38"></a><span id="l9.38" class="difflineplus">+  let contact2 = Cc[&quot;@mozilla.org/addressbook/cardproperty;1&quot;].createInstance(</span>
<a href="#l9.39"></a><span id="l9.39" class="difflineplus">+    Ci.nsIAbCard</span>
<a href="#l9.40"></a><span id="l9.40" class="difflineplus">+  );</span>
<a href="#l9.41"></a><span id="l9.41" class="difflineplus">+  contact2.displayName = &quot;contact number two&quot;;</span>
<a href="#l9.42"></a><span id="l9.42" class="difflineplus">+  contact2.firstName = &quot;contact&quot;;</span>
<a href="#l9.43"></a><span id="l9.43" class="difflineplus">+  contact2.lastName = &quot;two&quot;;</span>
<a href="#l9.44"></a><span id="l9.44" class="difflineplus">+  contact2.primaryEmail = &quot;contact2@invalid&quot;;</span>
<a href="#l9.45"></a><span id="l9.45" class="difflineplus">+  contact2.setProperty(&quot;JobTitle&quot;, `&quot;worker&quot;`);</span>
<a href="#l9.46"></a><span id="l9.46" class="difflineplus">+  contact2.setProperty(&quot;Custom1&quot;, &quot;custom, 1&quot;);</span>
<a href="#l9.47"></a><span id="l9.47" class="difflineplus">+  contact2.setProperty(&quot;Custom2&quot;, &quot;custom\t2&quot;);</span>
<a href="#l9.48"></a><span id="l9.48" class="difflineplus">+  contact2.setProperty(&quot;Custom3&quot;, &quot;custom\r3&quot;);</span>
<a href="#l9.49"></a><span id="l9.49" class="difflineplus">+  contact2.setProperty(&quot;Custom4&quot;, &quot;custom\n4&quot;);</span>
<a href="#l9.50"></a><span id="l9.50" class="difflineplus">+  contact2.setProperty(&quot;Notes&quot;, &quot;here's some unicode text…&quot;);</span>
<a href="#l9.51"></a><span id="l9.51" class="difflineplus">+  contact2 = book.addCard(contact2);</span>
<a href="#l9.52"></a><span id="l9.52" class="difflineplus">+</span>
<a href="#l9.53"></a><span id="l9.53" class="difflineplus">+  let list = Cc[&quot;@mozilla.org/addressbook/directoryproperty;1&quot;].createInstance(</span>
<a href="#l9.54"></a><span id="l9.54" class="difflineplus">+    Ci.nsIAbDirectory</span>
<a href="#l9.55"></a><span id="l9.55" class="difflineplus">+  );</span>
<a href="#l9.56"></a><span id="l9.56" class="difflineplus">+  list.isMailList = true;</span>
<a href="#l9.57"></a><span id="l9.57" class="difflineplus">+  list.dirName = &quot;new list&quot;;</span>
<a href="#l9.58"></a><span id="l9.58" class="difflineplus">+  list = book.addMailList(list);</span>
<a href="#l9.59"></a><span id="l9.59" class="difflineplus">+  list.addCard(contact1);</span>
<a href="#l9.60"></a><span id="l9.60" class="difflineplus">+</span>
<a href="#l9.61"></a><span id="l9.61" class="difflineplus">+  await compareAgainstFile(</span>
<a href="#l9.62"></a><span id="l9.62" class="difflineplus">+    &quot;export.csv&quot;,</span>
<a href="#l9.63"></a><span id="l9.63" class="difflineplus">+    exportDirectoryToDelimitedText(book, &quot;,&quot;)</span>
<a href="#l9.64"></a><span id="l9.64" class="difflineplus">+  );</span>
<a href="#l9.65"></a><span id="l9.65" class="difflineplus">+  await compareAgainstFile(</span>
<a href="#l9.66"></a><span id="l9.66" class="difflineplus">+    &quot;export.txt&quot;,</span>
<a href="#l9.67"></a><span id="l9.67" class="difflineplus">+    exportDirectoryToDelimitedText(book, &quot;\t&quot;)</span>
<a href="#l9.68"></a><span id="l9.68" class="difflineplus">+  );</span>
<a href="#l9.69"></a><span id="l9.69" class="difflineplus">+  await compareAgainstFile(&quot;export.vcf&quot;, exportDirectoryToVCard(book));</span>
<a href="#l9.70"></a><span id="l9.70" class="difflineplus">+  await compareAgainstFile(&quot;export.ldif&quot;, exportDirectoryToLDIF(book));</span>
<a href="#l9.71"></a><span id="l9.71" class="difflineplus">+});</span>
<a href="#l9.72"></a><span id="l9.72" class="difflineplus">+</span>
<a href="#l9.73"></a><span id="l9.73" class="difflineplus">+async function compareAgainstFile(fileName, actual) {</span>
<a href="#l9.74"></a><span id="l9.74" class="difflineplus">+  info(`checking against ${fileName}`);</span>
<a href="#l9.75"></a><span id="l9.75" class="difflineplus">+</span>
<a href="#l9.76"></a><span id="l9.76" class="difflineplus">+  // The test files are UTF-8 encoded and have Windows line endings. The</span>
<a href="#l9.77"></a><span id="l9.77" class="difflineplus">+  // exportDirectoryTo* functions are platform-dependent, except for VCard</span>
<a href="#l9.78"></a><span id="l9.78" class="difflineplus">+  // which always uses Windows line endings.</span>
<a href="#l9.79"></a><span id="l9.79" class="difflineplus">+</span>
<a href="#l9.80"></a><span id="l9.80" class="difflineplus">+  let file = do_get_file(`data/${fileName}`);</span>
<a href="#l9.81"></a><span id="l9.81" class="difflineplus">+  let contentBytes = await OS.File.read(file.path);</span>
<a href="#l9.82"></a><span id="l9.82" class="difflineplus">+  let expected = new TextDecoder(&quot;utf-8&quot;).decode(contentBytes);</span>
<a href="#l9.83"></a><span id="l9.83" class="difflineplus">+</span>
<a href="#l9.84"></a><span id="l9.84" class="difflineplus">+  if (AppConstants.platform != &quot;win&quot; &amp;&amp; fileName != &quot;export.vcf&quot;) {</span>
<a href="#l9.85"></a><span id="l9.85" class="difflineplus">+    expected = expected.replace(/\r\n/g, &quot;\n&quot;);</span>
<a href="#l9.86"></a><span id="l9.86" class="difflineplus">+  }</span>
<a href="#l9.87"></a><span id="l9.87" class="difflineplus">+</span>
<a href="#l9.88"></a><span id="l9.88" class="difflineplus">+  // From here on, \r is just another character. It will be the last character</span>
<a href="#l9.89"></a><span id="l9.89" class="difflineplus">+  // on lines where Windows line endings exist.</span>
<a href="#l9.90"></a><span id="l9.90" class="difflineplus">+  let expectedLines = expected.split(&quot;\n&quot;);</span>
<a href="#l9.91"></a><span id="l9.91" class="difflineplus">+  let actualLines = actual.split(&quot;\n&quot;);</span>
<a href="#l9.92"></a><span id="l9.92" class="difflineplus">+  equal(actualLines.length, expectedLines.length, &quot;correct number of lines&quot;);</span>
<a href="#l9.93"></a><span id="l9.93" class="difflineplus">+</span>
<a href="#l9.94"></a><span id="l9.94" class="difflineplus">+  for (let l = 0; l &lt; expectedLines.length; l++) {</span>
<a href="#l9.95"></a><span id="l9.95" class="difflineplus">+    let expectedLine = expectedLines[l];</span>
<a href="#l9.96"></a><span id="l9.96" class="difflineplus">+    let actualLine = actualLines[l];</span>
<a href="#l9.97"></a><span id="l9.97" class="difflineplus">+    if (actualLine == expectedLine) {</span>
<a href="#l9.98"></a><span id="l9.98" class="difflineplus">+      ok(true, `line ${l + 1} matches`);</span>
<a href="#l9.99"></a><span id="l9.99" class="difflineplus">+    } else {</span>
<a href="#l9.100"></a><span id="l9.100" class="difflineplus">+      for (let c = 0; c &lt; expectedLine.length &amp;&amp; c &lt; actualLine.length; c++) {</span>
<a href="#l9.101"></a><span id="l9.101" class="difflineplus">+        if (actualLine[c] != expectedLine[c]) {</span>
<a href="#l9.102"></a><span id="l9.102" class="difflineplus">+          // This call to equal automatically prints some extra characters of</span>
<a href="#l9.103"></a><span id="l9.103" class="difflineplus">+          // context. Hopefully that helps with debugging.</span>
<a href="#l9.104"></a><span id="l9.104" class="difflineplus">+          equal(</span>
<a href="#l9.105"></a><span id="l9.105" class="difflineplus">+            actualLine.substring(c - 10, c + 10),</span>
<a href="#l9.106"></a><span id="l9.106" class="difflineplus">+            expectedLine.substring(c - 10, c + 10),</span>
<a href="#l9.107"></a><span id="l9.107" class="difflineplus">+            `line ${l + 1} does not match at character ${c + 1}`</span>
<a href="#l9.108"></a><span id="l9.108" class="difflineplus">+          );</span>
<a href="#l9.109"></a><span id="l9.109" class="difflineplus">+        }</span>
<a href="#l9.110"></a><span id="l9.110" class="difflineplus">+      }</span>
<a href="#l9.111"></a><span id="l9.111" class="difflineplus">+      equal(</span>
<a href="#l9.112"></a><span id="l9.112" class="difflineplus">+        expectedLine.length,</span>
<a href="#l9.113"></a><span id="l9.113" class="difflineplus">+        actualLine.length,</span>
<a href="#l9.114"></a><span id="l9.114" class="difflineplus">+        `line ${l + 1} lengths differ`</span>
<a href="#l9.115"></a><span id="l9.115" class="difflineplus">+      );</span>
<a href="#l9.116"></a><span id="l9.116" class="difflineplus">+    }</span>
<a href="#l9.117"></a><span id="l9.117" class="difflineplus">+  }</span>
<a href="#l9.118"></a><span id="l9.118" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/addrbook/test/unit/xpcshell.ini</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/addrbook/test/unit/xpcshell.ini</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -8,16 +8,17 @@ tags = addrbook</span>
<a href="#l10.4"></a><span id="l10.4"> [test_bug387403.js]</span>
<a href="#l10.5"></a><span id="l10.5"> [test_bug448165.js]</span>
<a href="#l10.6"></a><span id="l10.6"> [test_bug534822.js]</span>
<a href="#l10.7"></a><span id="l10.7"> [test_bug1522453.js]</span>
<a href="#l10.8"></a><span id="l10.8"> [test_cardForEmail.js]</span>
<a href="#l10.9"></a><span id="l10.9"> [test_collection.js]</span>
<a href="#l10.10"></a><span id="l10.10"> [test_collection_2.js]</span>
<a href="#l10.11"></a><span id="l10.11"> [test_db_enumerator.js]</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineplus">+[test_export.js]</span>
<a href="#l10.13"></a><span id="l10.13"> [test_jsaddrbook.js]</span>
<a href="#l10.14"></a><span id="l10.14"> [test_jsaddrbook_inner.js]</span>
<a href="#l10.15"></a><span id="l10.15"> [test_ldap1.js]</span>
<a href="#l10.16"></a><span id="l10.16"> [test_ldap2.js]</span>
<a href="#l10.17"></a><span id="l10.17"> [test_ldapOffline.js]</span>
<a href="#l10.18"></a><span id="l10.18"> [test_ldapReplication.js]</span>
<a href="#l10.19"></a><span id="l10.19"> skip-if = debug # Fails for unknown reasons.</span>
<a href="#l10.20"></a><span id="l10.20"> [test_mailList1.js]</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:31Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

