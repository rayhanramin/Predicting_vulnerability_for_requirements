<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 10046:98cb113060ef16415a2c630d3c3648d0ecbefe75</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 98cb113060ef16415a2c630d3c3648d0ecbefe75" />
<meta property="og:url" content="/comm-central/rev/98cb113060ef16415a2c630d3c3648d0ecbefe75" />
<meta property="og:description" content="Bug 721517 - Convert mailnews/extensions/newsblog/content to Services.jsm and mailServices.js. Also fix global scope. r=dbienvenu, neil" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 98cb113060ef16415a2c630d3c3648d0ecbefe75 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/98cb113060ef16415a2c630d3c3648d0ecbefe75">shortlog</a> |
<a href="/comm-central/log/98cb113060ef16415a2c630d3c3648d0ecbefe75">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/98cb113060ef16415a2c630d3c3648d0ecbefe75">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/98cb113060ef16415a2c630d3c3648d0ecbefe75">files</a> |
changeset |
<a href="/comm-central/raw-rev/98cb113060ef16415a2c630d3c3648d0ecbefe75">raw</a>  | <a href="/comm-central/archive/98cb113060ef16415a2c630d3c3648d0ecbefe75.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=721517">Bug 721517</a> - Convert mailnews/extensions/newsblog/content to Services.jsm and mailServices.js. Also fix global scope. r=dbienvenu, neil
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#97;&#108;&#116;&#97;&#56;&#56;&#32;&#60;&#97;&#108;&#116;&#97;&#56;&#56;&#64;&#103;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Wed, 18 Apr 2012 09:00:46 -0600</td></tr>

<tr>
 <td>changeset 10046</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/98cb113060ef16415a2c630d3c3648d0ecbefe75">98cb113060ef16415a2c630d3c3648d0ecbefe75</a></td>
</tr>



<tr>
<td>parent 10045</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/7012a66dc254310f0f8b7e9a01d3b8884f62ccca">7012a66dc254310f0f8b7e9a01d3b8884f62ccca</a>
</td>
</tr>

<tr>
<td>child 10047</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/961effd85cf676819cca0e7f6a656bb1b35690bd">961effd85cf676819cca0e7f6a656bb1b35690bd</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=98cb113060ef16415a2c630d3c3648d0ecbefe75">7647</a></td></tr>
<tr><td>push user</td><td>ryanvm@gmail.com</td></tr>
<tr><td>push date</td><td class="date age">Wed, 02 May 2012 00:57:52 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@961effd85cf6 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=961effd85cf676819cca0e7f6a656bb1b35690bd">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=961effd85cf676819cca0e7f6a656bb1b35690bd&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=961effd85cf676819cca0e7f6a656bb1b35690bd&newProject=comm-central&newRevision=98cb113060ef16415a2c630d3c3648d0ecbefe75&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=961effd85cf676819cca0e7f6a656bb1b35690bd&newProject=comm-central&newRevision=98cb113060ef16415a2c630d3c3648d0ecbefe75&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=961effd85cf676819cca0e7f6a656bb1b35690bd&newProject=comm-central&newRevision=98cb113060ef16415a2c630d3c3648d0ecbefe75&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28dbienvenu%29&revcount=50">dbienvenu</a>, <a href="/comm-central/log?rev=reviewer%28neil%29&revcount=50">neil</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=721517">721517</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=721517">Bug 721517</a> - Convert mailnews/extensions/newsblog/content to Services.jsm and mailServices.js. Also fix global scope. r=dbienvenu, neil</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/98cb113060ef16415a2c630d3c3648d0ecbefe75/mail/base/content/mailWindowOverlay.js">mail/base/content/mailWindowOverlay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/98cb113060ef16415a2c630d3c3648d0ecbefe75/mail/base/content/mailWindowOverlay.js">file</a> |
<a href="/comm-central/annotate/98cb113060ef16415a2c630d3c3648d0ecbefe75/mail/base/content/mailWindowOverlay.js">annotate</a> |
<a href="/comm-central/diff/98cb113060ef16415a2c630d3c3648d0ecbefe75/mail/base/content/mailWindowOverlay.js">diff</a> |
<a href="/comm-central/comparison/98cb113060ef16415a2c630d3c3648d0ecbefe75/mail/base/content/mailWindowOverlay.js">comparison</a> |
<a href="/comm-central/log/98cb113060ef16415a2c630d3c3648d0ecbefe75/mail/base/content/mailWindowOverlay.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/98cb113060ef16415a2c630d3c3648d0ecbefe75/mailnews/extensions/newsblog/content/Feed.js">mailnews/extensions/newsblog/content/Feed.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/98cb113060ef16415a2c630d3c3648d0ecbefe75/mailnews/extensions/newsblog/content/Feed.js">file</a> |
<a href="/comm-central/annotate/98cb113060ef16415a2c630d3c3648d0ecbefe75/mailnews/extensions/newsblog/content/Feed.js">annotate</a> |
<a href="/comm-central/diff/98cb113060ef16415a2c630d3c3648d0ecbefe75/mailnews/extensions/newsblog/content/Feed.js">diff</a> |
<a href="/comm-central/comparison/98cb113060ef16415a2c630d3c3648d0ecbefe75/mailnews/extensions/newsblog/content/Feed.js">comparison</a> |
<a href="/comm-central/log/98cb113060ef16415a2c630d3c3648d0ecbefe75/mailnews/extensions/newsblog/content/Feed.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/98cb113060ef16415a2c630d3c3648d0ecbefe75/mailnews/extensions/newsblog/content/FeedItem.js">mailnews/extensions/newsblog/content/FeedItem.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/98cb113060ef16415a2c630d3c3648d0ecbefe75/mailnews/extensions/newsblog/content/FeedItem.js">file</a> |
<a href="/comm-central/annotate/98cb113060ef16415a2c630d3c3648d0ecbefe75/mailnews/extensions/newsblog/content/FeedItem.js">annotate</a> |
<a href="/comm-central/diff/98cb113060ef16415a2c630d3c3648d0ecbefe75/mailnews/extensions/newsblog/content/FeedItem.js">diff</a> |
<a href="/comm-central/comparison/98cb113060ef16415a2c630d3c3648d0ecbefe75/mailnews/extensions/newsblog/content/FeedItem.js">comparison</a> |
<a href="/comm-central/log/98cb113060ef16415a2c630d3c3648d0ecbefe75/mailnews/extensions/newsblog/content/FeedItem.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/98cb113060ef16415a2c630d3c3648d0ecbefe75/mailnews/extensions/newsblog/content/debug-utils.js">mailnews/extensions/newsblog/content/debug-utils.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/98cb113060ef16415a2c630d3c3648d0ecbefe75/mailnews/extensions/newsblog/content/debug-utils.js">diff</a> |
<a href="/comm-central/comparison/98cb113060ef16415a2c630d3c3648d0ecbefe75/mailnews/extensions/newsblog/content/debug-utils.js">comparison</a> |
<a href="/comm-central/log/98cb113060ef16415a2c630d3c3648d0ecbefe75/mailnews/extensions/newsblog/content/debug-utils.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/98cb113060ef16415a2c630d3c3648d0ecbefe75/mailnews/extensions/newsblog/content/feed-parser.js">mailnews/extensions/newsblog/content/feed-parser.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/98cb113060ef16415a2c630d3c3648d0ecbefe75/mailnews/extensions/newsblog/content/feed-parser.js">file</a> |
<a href="/comm-central/annotate/98cb113060ef16415a2c630d3c3648d0ecbefe75/mailnews/extensions/newsblog/content/feed-parser.js">annotate</a> |
<a href="/comm-central/diff/98cb113060ef16415a2c630d3c3648d0ecbefe75/mailnews/extensions/newsblog/content/feed-parser.js">diff</a> |
<a href="/comm-central/comparison/98cb113060ef16415a2c630d3c3648d0ecbefe75/mailnews/extensions/newsblog/content/feed-parser.js">comparison</a> |
<a href="/comm-central/log/98cb113060ef16415a2c630d3c3648d0ecbefe75/mailnews/extensions/newsblog/content/feed-parser.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/98cb113060ef16415a2c630d3c3648d0ecbefe75/mailnews/extensions/newsblog/content/feed-subscriptions.js">mailnews/extensions/newsblog/content/feed-subscriptions.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/98cb113060ef16415a2c630d3c3648d0ecbefe75/mailnews/extensions/newsblog/content/feed-subscriptions.js">file</a> |
<a href="/comm-central/annotate/98cb113060ef16415a2c630d3c3648d0ecbefe75/mailnews/extensions/newsblog/content/feed-subscriptions.js">annotate</a> |
<a href="/comm-central/diff/98cb113060ef16415a2c630d3c3648d0ecbefe75/mailnews/extensions/newsblog/content/feed-subscriptions.js">diff</a> |
<a href="/comm-central/comparison/98cb113060ef16415a2c630d3c3648d0ecbefe75/mailnews/extensions/newsblog/content/feed-subscriptions.js">comparison</a> |
<a href="/comm-central/log/98cb113060ef16415a2c630d3c3648d0ecbefe75/mailnews/extensions/newsblog/content/feed-subscriptions.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/98cb113060ef16415a2c630d3c3648d0ecbefe75/mailnews/extensions/newsblog/content/feed-subscriptions.xul">mailnews/extensions/newsblog/content/feed-subscriptions.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/98cb113060ef16415a2c630d3c3648d0ecbefe75/mailnews/extensions/newsblog/content/feed-subscriptions.xul">file</a> |
<a href="/comm-central/annotate/98cb113060ef16415a2c630d3c3648d0ecbefe75/mailnews/extensions/newsblog/content/feed-subscriptions.xul">annotate</a> |
<a href="/comm-central/diff/98cb113060ef16415a2c630d3c3648d0ecbefe75/mailnews/extensions/newsblog/content/feed-subscriptions.xul">diff</a> |
<a href="/comm-central/comparison/98cb113060ef16415a2c630d3c3648d0ecbefe75/mailnews/extensions/newsblog/content/feed-subscriptions.xul">comparison</a> |
<a href="/comm-central/log/98cb113060ef16415a2c630d3c3648d0ecbefe75/mailnews/extensions/newsblog/content/feed-subscriptions.xul">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/98cb113060ef16415a2c630d3c3648d0ecbefe75/mailnews/extensions/newsblog/content/utils.js">mailnews/extensions/newsblog/content/utils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/98cb113060ef16415a2c630d3c3648d0ecbefe75/mailnews/extensions/newsblog/content/utils.js">file</a> |
<a href="/comm-central/annotate/98cb113060ef16415a2c630d3c3648d0ecbefe75/mailnews/extensions/newsblog/content/utils.js">annotate</a> |
<a href="/comm-central/diff/98cb113060ef16415a2c630d3c3648d0ecbefe75/mailnews/extensions/newsblog/content/utils.js">diff</a> |
<a href="/comm-central/comparison/98cb113060ef16415a2c630d3c3648d0ecbefe75/mailnews/extensions/newsblog/content/utils.js">comparison</a> |
<a href="/comm-central/log/98cb113060ef16415a2c630d3c3648d0ecbefe75/mailnews/extensions/newsblog/content/utils.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/98cb113060ef16415a2c630d3c3648d0ecbefe75/mailnews/extensions/newsblog/jar.mn">mailnews/extensions/newsblog/jar.mn</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/98cb113060ef16415a2c630d3c3648d0ecbefe75/mailnews/extensions/newsblog/jar.mn">file</a> |
<a href="/comm-central/annotate/98cb113060ef16415a2c630d3c3648d0ecbefe75/mailnews/extensions/newsblog/jar.mn">annotate</a> |
<a href="/comm-central/diff/98cb113060ef16415a2c630d3c3648d0ecbefe75/mailnews/extensions/newsblog/jar.mn">diff</a> |
<a href="/comm-central/comparison/98cb113060ef16415a2c630d3c3648d0ecbefe75/mailnews/extensions/newsblog/jar.mn">comparison</a> |
<a href="/comm-central/log/98cb113060ef16415a2c630d3c3648d0ecbefe75/mailnews/extensions/newsblog/jar.mn">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/98cb113060ef16415a2c630d3c3648d0ecbefe75/mailnews/extensions/newsblog/js/newsblog.js">mailnews/extensions/newsblog/js/newsblog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/98cb113060ef16415a2c630d3c3648d0ecbefe75/mailnews/extensions/newsblog/js/newsblog.js">file</a> |
<a href="/comm-central/annotate/98cb113060ef16415a2c630d3c3648d0ecbefe75/mailnews/extensions/newsblog/js/newsblog.js">annotate</a> |
<a href="/comm-central/diff/98cb113060ef16415a2c630d3c3648d0ecbefe75/mailnews/extensions/newsblog/js/newsblog.js">diff</a> |
<a href="/comm-central/comparison/98cb113060ef16415a2c630d3c3648d0ecbefe75/mailnews/extensions/newsblog/js/newsblog.js">comparison</a> |
<a href="/comm-central/log/98cb113060ef16415a2c630d3c3648d0ecbefe75/mailnews/extensions/newsblog/js/newsblog.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/98cb113060ef16415a2c630d3c3648d0ecbefe75/suite/mailnews/mailWindowOverlay.js">suite/mailnews/mailWindowOverlay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/98cb113060ef16415a2c630d3c3648d0ecbefe75/suite/mailnews/mailWindowOverlay.js">file</a> |
<a href="/comm-central/annotate/98cb113060ef16415a2c630d3c3648d0ecbefe75/suite/mailnews/mailWindowOverlay.js">annotate</a> |
<a href="/comm-central/diff/98cb113060ef16415a2c630d3c3648d0ecbefe75/suite/mailnews/mailWindowOverlay.js">diff</a> |
<a href="/comm-central/comparison/98cb113060ef16415a2c630d3c3648d0ecbefe75/suite/mailnews/mailWindowOverlay.js">comparison</a> |
<a href="/comm-central/log/98cb113060ef16415a2c630d3c3648d0ecbefe75/suite/mailnews/mailWindowOverlay.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/base/content/mailWindowOverlay.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/base/content/mailWindowOverlay.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -3244,26 +3244,24 @@ function FeedSetContentView(val)</span>
<a href="#l1.4"></a><span id="l1.4">       break;</span>
<a href="#l1.5"></a><span id="l1.5">     case 1:</span>
<a href="#l1.6"></a><span id="l1.6">       showSummary = true</span>
<a href="#l1.7"></a><span id="l1.7">       break;</span>
<a href="#l1.8"></a><span id="l1.8">     case 2:</span>
<a href="#l1.9"></a><span id="l1.9">       if (wintype == &quot;mail:3pane&quot;) {</span>
<a href="#l1.10"></a><span id="l1.10">         // Get quickmode per feed pref from feeds.rdf</span>
<a href="#l1.11"></a><span id="l1.11">         var quickMode, targetRes;</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-        var scriptLoader = Components.classes[&quot;@mozilla.org/moz/jssubscript-loader;1&quot;]</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-                           .getService(Components.interfaces.mozIJSSubScriptLoader);</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineminus">-        if (scriptLoader &amp;&amp; typeof FZ_NS == 'undefined')</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineminus">-          scriptLoader.loadSubScript(&quot;chrome://messenger-newsblog/content/utils.js&quot;);</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineplus">+        if (!(&quot;FeedUtils&quot; in window))</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineplus">+          Services.scriptloader.loadSubScript(&quot;chrome://messenger-newsblog/content/utils.js&quot;);</span>
<a href="#l1.18"></a><span id="l1.18">         try</span>
<a href="#l1.19"></a><span id="l1.19">         {</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineminus">-          var targetRes = getParentTargetForChildResource(</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineminus">-                          gFolderDisplay.displayedFolder.URI,</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineminus">-                          FZ_QUICKMODE,</span>
<a href="#l1.23"></a><span id="l1.23" class="difflineminus">-                          gFolderDisplay.displayedFolder.server);</span>
<a href="#l1.24"></a><span id="l1.24" class="difflineplus">+          var targetRes = FeedUtils.getParentTargetForChildResource(</span>
<a href="#l1.25"></a><span id="l1.25" class="difflineplus">+                            gFolderDisplay.displayedFolder.URI,</span>
<a href="#l1.26"></a><span id="l1.26" class="difflineplus">+                            FeedUtils.FZ_QUICKMODE,</span>
<a href="#l1.27"></a><span id="l1.27" class="difflineplus">+                            gFolderDisplay.displayedFolder.server);</span>
<a href="#l1.28"></a><span id="l1.28">         }</span>
<a href="#l1.29"></a><span id="l1.29">         catch (ex) {};</span>
<a href="#l1.30"></a><span id="l1.30"> </span>
<a href="#l1.31"></a><span id="l1.31">         if (targetRes)</span>
<a href="#l1.32"></a><span id="l1.32">         {</span>
<a href="#l1.33"></a><span id="l1.33">           quickMode = targetRes.QueryInterface(Components.interfaces</span>
<a href="#l1.34"></a><span id="l1.34">                                .nsIRDFLiteral);</span>
<a href="#l1.35"></a><span id="l1.35">           quickMode = quickMode.Value;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/extensions/newsblog/content/Feed.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/extensions/newsblog/content/Feed.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -30,46 +30,39 @@</span>
<a href="#l2.4"></a><span id="l2.4"> # use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l2.5"></a><span id="l2.5"> # decision by deleting the provisions above and replace them with the notice</span>
<a href="#l2.6"></a><span id="l2.6"> # and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l2.7"></a><span id="l2.7"> # the provisions above, a recipient may use your version of this file under</span>
<a href="#l2.8"></a><span id="l2.8"> # the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l2.9"></a><span id="l2.9"> #</span>
<a href="#l2.10"></a><span id="l2.10"> # ***** END LICENSE BLOCK ***** */</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-// error codes used to inform the consumer about attempts to download a feed</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineminus">-const kNewsBlogSuccess = 0;</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineminus">-const kNewsBlogInvalidFeed = 1; // usually means there was an error trying to parse the feed...</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineminus">-const kNewsBlogRequestFailure = 2; // generic networking failure when trying to download the feed.</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineminus">-const kNewsBlogFeedIsBusy = 3;</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineminus">-const kNewsBlogNoNewItems = 4; // there are no new articles for this feed</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineminus">-</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineminus">-// Cache for all of the feeds currently being downloaded, indexed by URL, so the load event listener</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineminus">-// can access the Feed objects after it finishes downloading the feed.</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineminus">-var FeedCache = </span>
<a href="#l2.23"></a><span id="l2.23" class="difflineplus">+// Cache for all of the feeds currently being downloaded, indexed by URL,</span>
<a href="#l2.24"></a><span id="l2.24" class="difflineplus">+// so the load event listener can access the Feed objects after it finishes</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineplus">+// downloading the feed.</span>
<a href="#l2.26"></a><span id="l2.26" class="difflineplus">+var FeedCache =</span>
<a href="#l2.27"></a><span id="l2.27"> {</span>
<a href="#l2.28"></a><span id="l2.28">   mFeeds: {},</span>
<a href="#l2.29"></a><span id="l2.29"> </span>
<a href="#l2.30"></a><span id="l2.30">   putFeed: function (aFeed)</span>
<a href="#l2.31"></a><span id="l2.31">   {</span>
<a href="#l2.32"></a><span id="l2.32">     this.mFeeds[this.normalizeHost(aFeed.url)] = aFeed;</span>
<a href="#l2.33"></a><span id="l2.33">   },</span>
<a href="#l2.34"></a><span id="l2.34"> </span>
<a href="#l2.35"></a><span id="l2.35">   getFeed: function (aUrl)</span>
<a href="#l2.36"></a><span id="l2.36">   {</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineminus">-    var index = this.normalizeHost(aUrl);</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineplus">+    let index = this.normalizeHost(aUrl);</span>
<a href="#l2.39"></a><span id="l2.39">     if (index in this.mFeeds)</span>
<a href="#l2.40"></a><span id="l2.40">       return this.mFeeds[index];</span>
<a href="#l2.41"></a><span id="l2.41">     return null;</span>
<a href="#l2.42"></a><span id="l2.42">   },</span>
<a href="#l2.43"></a><span id="l2.43"> </span>
<a href="#l2.44"></a><span id="l2.44">   removeFeed: function (aUrl)</span>
<a href="#l2.45"></a><span id="l2.45">   {</span>
<a href="#l2.46"></a><span id="l2.46" class="difflineminus">-    var index = this.normalizeHost(aUrl);</span>
<a href="#l2.47"></a><span id="l2.47" class="difflineplus">+    let index = this.normalizeHost(aUrl);</span>
<a href="#l2.48"></a><span id="l2.48">     if (index in this.mFeeds)</span>
<a href="#l2.49"></a><span id="l2.49">       delete this.mFeeds[index];</span>
<a href="#l2.50"></a><span id="l2.50">   },</span>
<a href="#l2.51"></a><span id="l2.51"> </span>
<a href="#l2.52"></a><span id="l2.52">   normalizeHost: function (aUrl)</span>
<a href="#l2.53"></a><span id="l2.53">   {</span>
<a href="#l2.54"></a><span id="l2.54">     try</span>
<a href="#l2.55"></a><span id="l2.55">     {</span>
<a href="#l2.56"></a><span id="l2.56" class="difflineat">@@ -79,441 +72,473 @@ var FeedCache =</span>
<a href="#l2.57"></a><span id="l2.57">     }</span>
<a href="#l2.58"></a><span id="l2.58">     catch (ex)</span>
<a href="#l2.59"></a><span id="l2.59">     {</span>
<a href="#l2.60"></a><span id="l2.60">       return aUrl;</span>
<a href="#l2.61"></a><span id="l2.61">     }</span>
<a href="#l2.62"></a><span id="l2.62">   }</span>
<a href="#l2.63"></a><span id="l2.63"> };</span>
<a href="#l2.64"></a><span id="l2.64"> </span>
<a href="#l2.65"></a><span id="l2.65" class="difflineminus">-function Feed(aResource, aRSSServer) </span>
<a href="#l2.66"></a><span id="l2.66" class="difflineplus">+function Feed(aResource, aRSSServer)</span>
<a href="#l2.67"></a><span id="l2.67"> {</span>
<a href="#l2.68"></a><span id="l2.68" class="difflineminus">-  this.resource = aResource.QueryInterface(Components.interfaces.nsIRDFResource);</span>
<a href="#l2.69"></a><span id="l2.69" class="difflineplus">+  this.resource = aResource.QueryInterface(Ci.nsIRDFResource);</span>
<a href="#l2.70"></a><span id="l2.70">   this.server = aRSSServer;</span>
<a href="#l2.71"></a><span id="l2.71"> }</span>
<a href="#l2.72"></a><span id="l2.72"> </span>
<a href="#l2.73"></a><span id="l2.73"> Feed.prototype = </span>
<a href="#l2.74"></a><span id="l2.74"> {</span>
<a href="#l2.75"></a><span id="l2.75">   description: null,</span>
<a href="#l2.76"></a><span id="l2.76">   author: null,</span>
<a href="#l2.77"></a><span id="l2.77">   request: null,</span>
<a href="#l2.78"></a><span id="l2.78">   server: null,</span>
<a href="#l2.79"></a><span id="l2.79">   downloadCallback: null,</span>
<a href="#l2.80"></a><span id="l2.80">   resource: null,</span>
<a href="#l2.81"></a><span id="l2.81">   items: new Array(),</span>
<a href="#l2.82"></a><span id="l2.82">   mFolder: null,</span>
<a href="#l2.83"></a><span id="l2.83">   mInvalidFeed: false,</span>
<a href="#l2.84"></a><span id="l2.84" class="difflineplus">+  mFeedType: null,</span>
<a href="#l2.85"></a><span id="l2.85"> </span>
<a href="#l2.86"></a><span id="l2.86">   get folder()</span>
<a href="#l2.87"></a><span id="l2.87">   {</span>
<a href="#l2.88"></a><span id="l2.88">     if (!this.mFolder)</span>
<a href="#l2.89"></a><span id="l2.89">     {</span>
<a href="#l2.90"></a><span id="l2.90" class="difflineminus">-      try </span>
<a href="#l2.91"></a><span id="l2.91" class="difflineplus">+      try</span>
<a href="#l2.92"></a><span id="l2.92">       {</span>
<a href="#l2.93"></a><span id="l2.93">         this.mFolder = this.server.rootMsgFolder.getChildNamed(this.name);</span>
<a href="#l2.94"></a><span id="l2.94" class="difflineminus">-      } catch (ex) {}</span>
<a href="#l2.95"></a><span id="l2.95" class="difflineplus">+      }</span>
<a href="#l2.96"></a><span id="l2.96" class="difflineplus">+      catch (ex) {}</span>
<a href="#l2.97"></a><span id="l2.97">     }</span>
<a href="#l2.98"></a><span id="l2.98"> </span>
<a href="#l2.99"></a><span id="l2.99">     return this.mFolder;</span>
<a href="#l2.100"></a><span id="l2.100">   },</span>
<a href="#l2.101"></a><span id="l2.101"> </span>
<a href="#l2.102"></a><span id="l2.102" class="difflineminus">-  set folder (aFolder) </span>
<a href="#l2.103"></a><span id="l2.103" class="difflineplus">+  set folder (aFolder)</span>
<a href="#l2.104"></a><span id="l2.104">   {</span>
<a href="#l2.105"></a><span id="l2.105">     this.mFolder = aFolder;</span>
<a href="#l2.106"></a><span id="l2.106">   },</span>
<a href="#l2.107"></a><span id="l2.107"> </span>
<a href="#l2.108"></a><span id="l2.108">   get name()</span>
<a href="#l2.109"></a><span id="l2.109">   {</span>
<a href="#l2.110"></a><span id="l2.110" class="difflineminus">-    var name = this.title || this.description || this.url;</span>
<a href="#l2.111"></a><span id="l2.111" class="difflineplus">+    let name = this.title || this.description || this.url;</span>
<a href="#l2.112"></a><span id="l2.112">     if (!name)</span>
<a href="#l2.113"></a><span id="l2.113" class="difflineminus">-      throw(&quot;couldn't compute feed name, as feed has no title, description, or URL.&quot;);</span>
<a href="#l2.114"></a><span id="l2.114" class="difflineplus">+      throw new Error(&quot;Feed.name: couldn't compute name, as feed has no title, &quot; +</span>
<a href="#l2.115"></a><span id="l2.115" class="difflineplus">+                      &quot;description, or URL.&quot;);</span>
<a href="#l2.116"></a><span id="l2.116"> </span>
<a href="#l2.117"></a><span id="l2.117">     // Make sure the feed name doesn't have any line breaks, since we're going</span>
<a href="#l2.118"></a><span id="l2.118">     // to use it as the name of the folder in the filesystem.  This may not</span>
<a href="#l2.119"></a><span id="l2.119">     // be necessary, since Mozilla's mail code seems to handle other forbidden</span>
<a href="#l2.120"></a><span id="l2.120">     // characters in filenames and can probably handle these as well.</span>
<a href="#l2.121"></a><span id="l2.121">     name = name.replace(/[\n\r\t]+/g, &quot; &quot;);</span>
<a href="#l2.122"></a><span id="l2.122"> </span>
<a href="#l2.123"></a><span id="l2.123">     // Make sure the feed doesn't end in a period to work around bug 117840.</span>
<a href="#l2.124"></a><span id="l2.124">     // Remove leading/trailing spaces for bug 547543.</span>
<a href="#l2.125"></a><span id="l2.125">     name = name.replace(/\.+$/, &quot;&quot;).trim();</span>
<a href="#l2.126"></a><span id="l2.126"> </span>
<a href="#l2.127"></a><span id="l2.127">     return name;</span>
<a href="#l2.128"></a><span id="l2.128">   },</span>
<a href="#l2.129"></a><span id="l2.129"> </span>
<a href="#l2.130"></a><span id="l2.130" class="difflineminus">-  download: function(aParseItems, aCallback) </span>
<a href="#l2.131"></a><span id="l2.131" class="difflineminus">-  { </span>
<a href="#l2.132"></a><span id="l2.132" class="difflineminus">-    this.downloadCallback = aCallback; // may be null </span>
<a href="#l2.133"></a><span id="l2.133" class="difflineplus">+  download: function(aParseItems, aCallback)</span>
<a href="#l2.134"></a><span id="l2.134" class="difflineplus">+  {</span>
<a href="#l2.135"></a><span id="l2.135" class="difflineplus">+     // May be null.</span>
<a href="#l2.136"></a><span id="l2.136" class="difflineplus">+    this.downloadCallback = aCallback;</span>
<a href="#l2.137"></a><span id="l2.137"> </span>
<a href="#l2.138"></a><span id="l2.138">     // Whether or not to parse items when downloading and parsing the feed.</span>
<a href="#l2.139"></a><span id="l2.139">     // Defaults to true, but setting to false is useful for obtaining</span>
<a href="#l2.140"></a><span id="l2.140">     // just the title of the feed when the user subscribes to it.</span>
<a href="#l2.141"></a><span id="l2.141">     this.parseItems = aParseItems == null ? true : aParseItems ? true : false;</span>
<a href="#l2.142"></a><span id="l2.142"> </span>
<a href="#l2.143"></a><span id="l2.143" class="difflineminus">-    // Before we do anything...make sure the url is an http url. This is just a sanity check</span>
<a href="#l2.144"></a><span id="l2.144" class="difflineminus">-    // so we don't try opening mailto urls, imap urls, etc. that the user may have tried to subscribe to </span>
<a href="#l2.145"></a><span id="l2.145" class="difflineminus">-    // as an rss feed..</span>
<a href="#l2.146"></a><span id="l2.146" class="difflineminus">-    var uri = Components.classes[&quot;@mozilla.org/network/standard-url;1&quot;].</span>
<a href="#l2.147"></a><span id="l2.147" class="difflineminus">-                        createInstance(Components.interfaces.nsIURI);</span>
<a href="#l2.148"></a><span id="l2.148" class="difflineplus">+    // Before we do anything, make sure the url is an http url.  This is just</span>
<a href="#l2.149"></a><span id="l2.149" class="difflineplus">+    // a sanity check so we don't try opening mailto urls, imap urls, etc. that</span>
<a href="#l2.150"></a><span id="l2.150" class="difflineplus">+    // the user may have tried to subscribe to as an rss feed.</span>
<a href="#l2.151"></a><span id="l2.151" class="difflineplus">+    let uri = Cc[&quot;@mozilla.org/network/standard-url;1&quot;].</span>
<a href="#l2.152"></a><span id="l2.152" class="difflineplus">+              createInstance(Ci.nsIURI);</span>
<a href="#l2.153"></a><span id="l2.153">     uri.spec = this.url;</span>
<a href="#l2.154"></a><span id="l2.154" class="difflineminus">-    if (!(uri.schemeIs(&quot;http&quot;) || uri.schemeIs(&quot;https&quot;)))</span>
<a href="#l2.155"></a><span id="l2.155" class="difflineplus">+    if (!FeedUtils.isValidScheme(uri))</span>
<a href="#l2.156"></a><span id="l2.156">     {</span>
<a href="#l2.157"></a><span id="l2.157" class="difflineminus">-      this.onParseError(this); // simulate an invalid feed error</span>
<a href="#l2.158"></a><span id="l2.158" class="difflineplus">+       // Simulate an invalid feed error.</span>
<a href="#l2.159"></a><span id="l2.159" class="difflineplus">+      FeedUtils.log.debug(&quot;Feed.download: invalid protocol for - &quot; + uri.spec);</span>
<a href="#l2.160"></a><span id="l2.160" class="difflineplus">+      this.onParseError(this);</span>
<a href="#l2.161"></a><span id="l2.161">       return;</span>
<a href="#l2.162"></a><span id="l2.162">     }</span>
<a href="#l2.163"></a><span id="l2.163"> </span>
<a href="#l2.164"></a><span id="l2.164" class="difflineminus">-    // Before we try to download the feed, make sure we aren't already processing the feed</span>
<a href="#l2.165"></a><span id="l2.165" class="difflineminus">-    // by looking up the url in our feed cache</span>
<a href="#l2.166"></a><span id="l2.166" class="difflineplus">+    // Before we try to download the feed, make sure we aren't already</span>
<a href="#l2.167"></a><span id="l2.167" class="difflineplus">+    // processing the feed by looking up the url in our feed cache.</span>
<a href="#l2.168"></a><span id="l2.168">     if (FeedCache.getFeed(this.url))</span>
<a href="#l2.169"></a><span id="l2.169">     {</span>
<a href="#l2.170"></a><span id="l2.170">       if (this.downloadCallback)</span>
<a href="#l2.171"></a><span id="l2.171" class="difflineminus">-        this.downloadCallback.downloaded(this, kNewsBlogFeedIsBusy);</span>
<a href="#l2.172"></a><span id="l2.172" class="difflineminus">-      return ; // don't do anything, the feed is already in use</span>
<a href="#l2.173"></a><span id="l2.173" class="difflineplus">+        this.downloadCallback.downloaded(this, FeedUtils.kNewsBlogFeedIsBusy);</span>
<a href="#l2.174"></a><span id="l2.174" class="difflineplus">+      // Return, the feed is already in use.</span>
<a href="#l2.175"></a><span id="l2.175" class="difflineplus">+      return;</span>
<a href="#l2.176"></a><span id="l2.176">     }</span>
<a href="#l2.177"></a><span id="l2.177"> </span>
<a href="#l2.178"></a><span id="l2.178" class="difflineminus">-    this.request = Components.classes[&quot;@mozilla.org/xmlextras/xmlhttprequest;1&quot;]</span>
<a href="#l2.179"></a><span id="l2.179" class="difflineminus">-                   .createInstance(Components.interfaces.nsIXMLHttpRequest);</span>
<a href="#l2.180"></a><span id="l2.180" class="difflineminus">-    this.request.onprogress = this.onProgress; // must be set before calling .open</span>
<a href="#l2.181"></a><span id="l2.181" class="difflineplus">+    this.request = Cc[&quot;@mozilla.org/xmlextras/xmlhttprequest;1&quot;].</span>
<a href="#l2.182"></a><span id="l2.182" class="difflineplus">+                   createInstance(Ci.nsIXMLHttpRequest);</span>
<a href="#l2.183"></a><span id="l2.183" class="difflineplus">+    // Must set onProgress before calling open.</span>
<a href="#l2.184"></a><span id="l2.184" class="difflineplus">+    this.request.onprogress = this.onProgress;</span>
<a href="#l2.185"></a><span id="l2.185">     this.request.open(&quot;GET&quot;, this.url, true);</span>
<a href="#l2.186"></a><span id="l2.186"> </span>
<a href="#l2.187"></a><span id="l2.187" class="difflineminus">-    var lastModified = this.lastModified;</span>
<a href="#l2.188"></a><span id="l2.188" class="difflineminus">-    if (lastModified)</span>
<a href="#l2.189"></a><span id="l2.189" class="difflineminus">-      this.request.setRequestHeader(&quot;If-Modified-Since&quot;, lastModified);</span>
<a href="#l2.190"></a><span id="l2.190" class="difflineplus">+    let lastModified = this.lastModified;</span>
<a href="#l2.191"></a><span id="l2.191" class="difflineplus">+    // Some servers, if sent If-Modified-Since, will send 304 if subsequently</span>
<a href="#l2.192"></a><span id="l2.192" class="difflineplus">+    // not sent If-Modified-Since, as in the case of an unsubscribe and new</span>
<a href="#l2.193"></a><span id="l2.193" class="difflineplus">+    // subscribe.  Send 0 to force a download.</span>
<a href="#l2.194"></a><span id="l2.194" class="difflineplus">+    this.request.setRequestHeader(&quot;If-Modified-Since&quot;,</span>
<a href="#l2.195"></a><span id="l2.195" class="difflineplus">+                                  lastModified ? lastModified : 0);</span>
<a href="#l2.196"></a><span id="l2.196"> </span>
<a href="#l2.197"></a><span id="l2.197">     // Only order what you're going to eat...</span>
<a href="#l2.198"></a><span id="l2.198">     this.request.responseType = &quot;document&quot;;</span>
<a href="#l2.199"></a><span id="l2.199">     this.request.overrideMimeType(&quot;text/xml&quot;);</span>
<a href="#l2.200"></a><span id="l2.200">     this.request.onload = this.onDownloaded;</span>
<a href="#l2.201"></a><span id="l2.201">     this.request.onerror = this.onDownloadError;</span>
<a href="#l2.202"></a><span id="l2.202">     FeedCache.putFeed(this);</span>
<a href="#l2.203"></a><span id="l2.203">     this.request.send(null);</span>
<a href="#l2.204"></a><span id="l2.204" class="difflineminus">-  }, </span>
<a href="#l2.205"></a><span id="l2.205" class="difflineplus">+  },</span>
<a href="#l2.206"></a><span id="l2.206"> </span>
<a href="#l2.207"></a><span id="l2.207" class="difflineminus">-  onDownloaded: function(aEvent) </span>
<a href="#l2.208"></a><span id="l2.208" class="difflineplus">+  onDownloaded: function(aEvent)</span>
<a href="#l2.209"></a><span id="l2.209">   {</span>
<a href="#l2.210"></a><span id="l2.210" class="difflineminus">-    var request = aEvent.target;</span>
<a href="#l2.211"></a><span id="l2.211" class="difflineminus">-    var url = request.channel.originalURI.spec;</span>
<a href="#l2.212"></a><span id="l2.212" class="difflineminus">-    debug(url + &quot; downloaded&quot;);</span>
<a href="#l2.213"></a><span id="l2.213" class="difflineminus">-    if (request.status &lt; 200 || request.status &gt;= 300)</span>
<a href="#l2.214"></a><span id="l2.214" class="difflineplus">+    let request = aEvent.target;</span>
<a href="#l2.215"></a><span id="l2.215" class="difflineplus">+    let isHttp = /^http(s?)/.test(request.channel.originalURI.scheme);</span>
<a href="#l2.216"></a><span id="l2.216" class="difflineplus">+    let url = request.channel.originalURI.spec;</span>
<a href="#l2.217"></a><span id="l2.217" class="difflineplus">+    if (isHttp &amp;&amp; (request.status &lt; 200 || request.status &gt;= 300))</span>
<a href="#l2.218"></a><span id="l2.218">     {</span>
<a href="#l2.219"></a><span id="l2.219">       Feed.prototype.onDownloadError(aEvent);</span>
<a href="#l2.220"></a><span id="l2.220">       return;</span>
<a href="#l2.221"></a><span id="l2.221">     }</span>
<a href="#l2.222"></a><span id="l2.222" class="difflineminus">-    var feed = FeedCache.getFeed(url);</span>
<a href="#l2.223"></a><span id="l2.223" class="difflineplus">+</span>
<a href="#l2.224"></a><span id="l2.224" class="difflineplus">+    FeedUtils.log.debug(&quot;Feed.onDownloaded: got a download - &quot; + url);</span>
<a href="#l2.225"></a><span id="l2.225" class="difflineplus">+    let feed = FeedCache.getFeed(url);</span>
<a href="#l2.226"></a><span id="l2.226">     if (!feed)</span>
<a href="#l2.227"></a><span id="l2.227" class="difflineminus">-      throw(&quot;error after downloading &quot; + url + &quot;: couldn't retrieve feed from request&quot;);</span>
<a href="#l2.228"></a><span id="l2.228" class="difflineplus">+      throw new Error(&quot;Feed.onDownloaded: error - couldn't retrieve feed &quot; +</span>
<a href="#l2.229"></a><span id="l2.229" class="difflineplus">+                      &quot;from cache&quot;);</span>
<a href="#l2.230"></a><span id="l2.230"> </span>
<a href="#l2.231"></a><span id="l2.231">     // If the server sends a Last-Modified header, store the property on the</span>
<a href="#l2.232"></a><span id="l2.232">     // feed so we can use it when making future requests, to avoid downloading</span>
<a href="#l2.233"></a><span id="l2.233">     // and parsing feeds that have not changed.</span>
<a href="#l2.234"></a><span id="l2.234" class="difflineminus">-    var lastModifiedHeader = request.getResponseHeader('Last-Modified');</span>
<a href="#l2.235"></a><span id="l2.235" class="difflineplus">+    let lastModifiedHeader = request.getResponseHeader(&quot;Last-Modified&quot;);</span>
<a href="#l2.236"></a><span id="l2.236">     if (lastModifiedHeader)</span>
<a href="#l2.237"></a><span id="l2.237">       feed.lastModified = lastModifiedHeader;</span>
<a href="#l2.238"></a><span id="l2.238"> </span>
<a href="#l2.239"></a><span id="l2.239">     // The download callback is called asynchronously when parse() is done.</span>
<a href="#l2.240"></a><span id="l2.240">     feed.parse();</span>
<a href="#l2.241"></a><span id="l2.241" class="difflineminus">-  }, </span>
<a href="#l2.242"></a><span id="l2.242" class="difflineplus">+  },</span>
<a href="#l2.243"></a><span id="l2.243">   </span>
<a href="#l2.244"></a><span id="l2.244">   onProgress: function(aEvent) </span>
<a href="#l2.245"></a><span id="l2.245">   {</span>
<a href="#l2.246"></a><span id="l2.246" class="difflineminus">-    var request = aEvent.target;</span>
<a href="#l2.247"></a><span id="l2.247" class="difflineminus">-    var url = request.channel.originalURI.spec;</span>
<a href="#l2.248"></a><span id="l2.248" class="difflineminus">-    var feed = FeedCache.getFeed(url);</span>
<a href="#l2.249"></a><span id="l2.249" class="difflineplus">+    let request = aEvent.target;</span>
<a href="#l2.250"></a><span id="l2.250" class="difflineplus">+    let url = request.channel.originalURI.spec;</span>
<a href="#l2.251"></a><span id="l2.251" class="difflineplus">+    let feed = FeedCache.getFeed(url);</span>
<a href="#l2.252"></a><span id="l2.252"> </span>
<a href="#l2.253"></a><span id="l2.253">     if (feed.downloadCallback)</span>
<a href="#l2.254"></a><span id="l2.254" class="difflineminus">-      feed.downloadCallback.onProgress(feed, aEvent.position, aEvent.totalSize);</span>
<a href="#l2.255"></a><span id="l2.255" class="difflineplus">+      feed.downloadCallback.onProgress(feed, aEvent.loaded, aEvent.total,</span>
<a href="#l2.256"></a><span id="l2.256" class="difflineplus">+                                       aEvent.lengthComputable);</span>
<a href="#l2.257"></a><span id="l2.257">   },</span>
<a href="#l2.258"></a><span id="l2.258"> </span>
<a href="#l2.259"></a><span id="l2.259" class="difflineminus">-  onDownloadError: function(aEvent) </span>
<a href="#l2.260"></a><span id="l2.260" class="difflineplus">+  onDownloadError: function(aEvent)</span>
<a href="#l2.261"></a><span id="l2.261">   {</span>
<a href="#l2.262"></a><span id="l2.262" class="difflineminus">-    var request = aEvent.target;</span>
<a href="#l2.263"></a><span id="l2.263" class="difflineminus">-    var url = request.channel.originalURI.spec;</span>
<a href="#l2.264"></a><span id="l2.264" class="difflineminus">-    var feed = FeedCache.getFeed(url);</span>
<a href="#l2.265"></a><span id="l2.265" class="difflineplus">+    let request = aEvent.target;</span>
<a href="#l2.266"></a><span id="l2.266" class="difflineplus">+    let url = request.channel.originalURI.spec;</span>
<a href="#l2.267"></a><span id="l2.267" class="difflineplus">+    let feed = FeedCache.getFeed(url);</span>
<a href="#l2.268"></a><span id="l2.268">     if (feed.downloadCallback) </span>
<a href="#l2.269"></a><span id="l2.269">     {</span>
<a href="#l2.270"></a><span id="l2.270" class="difflineminus">-      var error = kNewsBlogRequestFailure;</span>
<a href="#l2.271"></a><span id="l2.271" class="difflineplus">+      let error = FeedUtils.kNewsBlogRequestFailure;</span>
<a href="#l2.272"></a><span id="l2.272">       try</span>
<a href="#l2.273"></a><span id="l2.273">       {</span>
<a href="#l2.274"></a><span id="l2.274">         if (request.status == 304)</span>
<a href="#l2.275"></a><span id="l2.275">           // If the http status code is 304, the feed has not been modified</span>
<a href="#l2.276"></a><span id="l2.276">           // since we last downloaded it and does not need to be parsed.</span>
<a href="#l2.277"></a><span id="l2.277" class="difflineminus">-          error = kNewsBlogNoNewItems;</span>
<a href="#l2.278"></a><span id="l2.278" class="difflineminus">-      } catch (ex) {}</span>
<a href="#l2.279"></a><span id="l2.279" class="difflineplus">+          error = FeedUtils.kNewsBlogNoNewItems;</span>
<a href="#l2.280"></a><span id="l2.280" class="difflineplus">+      }</span>
<a href="#l2.281"></a><span id="l2.281" class="difflineplus">+      catch (ex) {}</span>
<a href="#l2.282"></a><span id="l2.282" class="difflineplus">+</span>
<a href="#l2.283"></a><span id="l2.283">       feed.downloadCallback.downloaded(feed, error);</span>
<a href="#l2.284"></a><span id="l2.284">     }</span>
<a href="#l2.285"></a><span id="l2.285" class="difflineminus">-    </span>
<a href="#l2.286"></a><span id="l2.286" class="difflineplus">+</span>
<a href="#l2.287"></a><span id="l2.287">     FeedCache.removeFeed(url);</span>
<a href="#l2.288"></a><span id="l2.288">   },</span>
<a href="#l2.289"></a><span id="l2.289"> </span>
<a href="#l2.290"></a><span id="l2.290" class="difflineminus">-  onParseError: function(aFeed) </span>
<a href="#l2.291"></a><span id="l2.291" class="difflineplus">+  onParseError: function(aFeed)</span>
<a href="#l2.292"></a><span id="l2.292">   {</span>
<a href="#l2.293"></a><span id="l2.293" class="difflineminus">-    if (aFeed)</span>
<a href="#l2.294"></a><span id="l2.294" class="difflineminus">-    {</span>
<a href="#l2.295"></a><span id="l2.295" class="difflineminus">-      aFeed.mInvalidFeed = true;</span>
<a href="#l2.296"></a><span id="l2.296" class="difflineminus">-      aFeed.lastModified = &quot;&quot;;</span>
<a href="#l2.297"></a><span id="l2.297" class="difflineplus">+    if (!aFeed)</span>
<a href="#l2.298"></a><span id="l2.298" class="difflineplus">+      return;</span>
<a href="#l2.299"></a><span id="l2.299"> </span>
<a href="#l2.300"></a><span id="l2.300" class="difflineminus">-      if (aFeed.downloadCallback)</span>
<a href="#l2.301"></a><span id="l2.301" class="difflineminus">-        aFeed.downloadCallback.downloaded(aFeed, kNewsBlogInvalidFeed);</span>
<a href="#l2.302"></a><span id="l2.302" class="difflineplus">+    aFeed.mInvalidFeed = true;</span>
<a href="#l2.303"></a><span id="l2.303" class="difflineplus">+    aFeed.lastModified = &quot;&quot;;</span>
<a href="#l2.304"></a><span id="l2.304"> </span>
<a href="#l2.305"></a><span id="l2.305" class="difflineminus">-      FeedCache.removeFeed(aFeed.url);</span>
<a href="#l2.306"></a><span id="l2.306" class="difflineminus">-    }</span>
<a href="#l2.307"></a><span id="l2.307" class="difflineplus">+    if (aFeed.downloadCallback)</span>
<a href="#l2.308"></a><span id="l2.308" class="difflineplus">+      aFeed.downloadCallback.downloaded(aFeed, FeedUtils.kNewsBlogInvalidFeed);</span>
<a href="#l2.309"></a><span id="l2.309" class="difflineplus">+</span>
<a href="#l2.310"></a><span id="l2.310" class="difflineplus">+    FeedCache.removeFeed(aFeed.url);</span>
<a href="#l2.311"></a><span id="l2.311">   },</span>
<a href="#l2.312"></a><span id="l2.312"> </span>
<a href="#l2.313"></a><span id="l2.313">   get url()</span>
<a href="#l2.314"></a><span id="l2.314">   {</span>
<a href="#l2.315"></a><span id="l2.315" class="difflineminus">-    var ds = getSubscriptionsDS(this.server);</span>
<a href="#l2.316"></a><span id="l2.316" class="difflineminus">-    var url = ds.GetTarget(this.resource, DC_IDENTIFIER, true);</span>
<a href="#l2.317"></a><span id="l2.317" class="difflineplus">+    let ds = FeedUtils.getSubscriptionsDS(this.server);</span>
<a href="#l2.318"></a><span id="l2.318" class="difflineplus">+    let url = ds.GetTarget(this.resource, FeedUtils.DC_IDENTIFIER, true);</span>
<a href="#l2.319"></a><span id="l2.319">     if (url)</span>
<a href="#l2.320"></a><span id="l2.320" class="difflineminus">-      url = url.QueryInterface(Components.interfaces.nsIRDFLiteral).Value;</span>
<a href="#l2.321"></a><span id="l2.321" class="difflineplus">+      url = url.QueryInterface(Ci.nsIRDFLiteral).Value;</span>
<a href="#l2.322"></a><span id="l2.322">     else</span>
<a href="#l2.323"></a><span id="l2.323">       url = this.resource.Value;</span>
<a href="#l2.324"></a><span id="l2.324" class="difflineplus">+</span>
<a href="#l2.325"></a><span id="l2.325">     return url;</span>
<a href="#l2.326"></a><span id="l2.326">   },</span>
<a href="#l2.327"></a><span id="l2.327"> </span>
<a href="#l2.328"></a><span id="l2.328">   get title()</span>
<a href="#l2.329"></a><span id="l2.329">   {</span>
<a href="#l2.330"></a><span id="l2.330" class="difflineminus">-    var ds = getSubscriptionsDS(this.server);</span>
<a href="#l2.331"></a><span id="l2.331" class="difflineminus">-    var title = ds.GetTarget(this.resource, DC_TITLE, true);</span>
<a href="#l2.332"></a><span id="l2.332" class="difflineplus">+    let ds = FeedUtils.getSubscriptionsDS(this.server);</span>
<a href="#l2.333"></a><span id="l2.333" class="difflineplus">+    let title = ds.GetTarget(this.resource, FeedUtils.DC_TITLE, true);</span>
<a href="#l2.334"></a><span id="l2.334">     if (title)</span>
<a href="#l2.335"></a><span id="l2.335" class="difflineminus">-      title = title.QueryInterface(Components.interfaces.nsIRDFLiteral).Value;</span>
<a href="#l2.336"></a><span id="l2.336" class="difflineplus">+      title = title.QueryInterface(Ci.nsIRDFLiteral).Value;</span>
<a href="#l2.337"></a><span id="l2.337" class="difflineplus">+</span>
<a href="#l2.338"></a><span id="l2.338">     return title;</span>
<a href="#l2.339"></a><span id="l2.339">   },</span>
<a href="#l2.340"></a><span id="l2.340"> </span>
<a href="#l2.341"></a><span id="l2.341">   set title (aNewTitle)</span>
<a href="#l2.342"></a><span id="l2.342">   {</span>
<a href="#l2.343"></a><span id="l2.343">     if (!aNewTitle)</span>
<a href="#l2.344"></a><span id="l2.344">       return;</span>
<a href="#l2.345"></a><span id="l2.345"> </span>
<a href="#l2.346"></a><span id="l2.346" class="difflineminus">-    var ds = getSubscriptionsDS(this.server);</span>
<a href="#l2.347"></a><span id="l2.347" class="difflineminus">-    aNewTitle = rdf.GetLiteral(aNewTitle);</span>
<a href="#l2.348"></a><span id="l2.348" class="difflineminus">-    var old_title = ds.GetTarget(this.resource, DC_TITLE, true);</span>
<a href="#l2.349"></a><span id="l2.349" class="difflineplus">+    let ds = FeedUtils.getSubscriptionsDS(this.server);</span>
<a href="#l2.350"></a><span id="l2.350" class="difflineplus">+    aNewTitle = FeedUtils.rdf.GetLiteral(aNewTitle);</span>
<a href="#l2.351"></a><span id="l2.351" class="difflineplus">+    let old_title = ds.GetTarget(this.resource, FeedUtils.DC_TITLE, true);</span>
<a href="#l2.352"></a><span id="l2.352">     if (old_title)</span>
<a href="#l2.353"></a><span id="l2.353" class="difflineminus">-        ds.Change(this.resource, DC_TITLE, old_title, aNewTitle);</span>
<a href="#l2.354"></a><span id="l2.354" class="difflineplus">+        ds.Change(this.resource, FeedUtils.DC_TITLE, old_title, aNewTitle);</span>
<a href="#l2.355"></a><span id="l2.355">     else</span>
<a href="#l2.356"></a><span id="l2.356" class="difflineminus">-        ds.Assert(this.resource, DC_TITLE, aNewTitle, true);</span>
<a href="#l2.357"></a><span id="l2.357" class="difflineplus">+        ds.Assert(this.resource, FeedUtils.DC_TITLE, aNewTitle, true);</span>
<a href="#l2.358"></a><span id="l2.358">   },</span>
<a href="#l2.359"></a><span id="l2.359"> </span>
<a href="#l2.360"></a><span id="l2.360">   get lastModified()</span>
<a href="#l2.361"></a><span id="l2.361">   {</span>
<a href="#l2.362"></a><span id="l2.362" class="difflineminus">-    var ds = getSubscriptionsDS(this.server);</span>
<a href="#l2.363"></a><span id="l2.363" class="difflineminus">-    var lastModified = ds.GetTarget(this.resource, DC_LASTMODIFIED, true);</span>
<a href="#l2.364"></a><span id="l2.364" class="difflineplus">+    let ds = FeedUtils.getSubscriptionsDS(this.server);</span>
<a href="#l2.365"></a><span id="l2.365" class="difflineplus">+    let lastModified = ds.GetTarget(this.resource,</span>
<a href="#l2.366"></a><span id="l2.366" class="difflineplus">+                                    FeedUtils.DC_LASTMODIFIED,</span>
<a href="#l2.367"></a><span id="l2.367" class="difflineplus">+                                    true);</span>
<a href="#l2.368"></a><span id="l2.368">     if (lastModified)</span>
<a href="#l2.369"></a><span id="l2.369" class="difflineminus">-      lastModified = lastModified.QueryInterface(Components.interfaces.nsIRDFLiteral).Value;</span>
<a href="#l2.370"></a><span id="l2.370" class="difflineplus">+      lastModified = lastModified.QueryInterface(Ci.nsIRDFLiteral).Value;</span>
<a href="#l2.371"></a><span id="l2.371">     return lastModified;</span>
<a href="#l2.372"></a><span id="l2.372">   },</span>
<a href="#l2.373"></a><span id="l2.373"> </span>
<a href="#l2.374"></a><span id="l2.374">   set lastModified(aLastModified)</span>
<a href="#l2.375"></a><span id="l2.375">   {</span>
<a href="#l2.376"></a><span id="l2.376" class="difflineminus">-    var ds = getSubscriptionsDS(this.server);</span>
<a href="#l2.377"></a><span id="l2.377" class="difflineminus">-    aLastModified = rdf.GetLiteral(aLastModified);</span>
<a href="#l2.378"></a><span id="l2.378" class="difflineminus">-    var old_lastmodified = ds.GetTarget(this.resource, DC_LASTMODIFIED, true);</span>
<a href="#l2.379"></a><span id="l2.379" class="difflineplus">+    let ds = FeedUtils.getSubscriptionsDS(this.server);</span>
<a href="#l2.380"></a><span id="l2.380" class="difflineplus">+    aLastModified = FeedUtils.rdf.GetLiteral(aLastModified);</span>
<a href="#l2.381"></a><span id="l2.381" class="difflineplus">+    let old_lastmodified = ds.GetTarget(this.resource,</span>
<a href="#l2.382"></a><span id="l2.382" class="difflineplus">+                                        FeedUtils.DC_LASTMODIFIED,</span>
<a href="#l2.383"></a><span id="l2.383" class="difflineplus">+                                        true);</span>
<a href="#l2.384"></a><span id="l2.384">     if (old_lastmodified)</span>
<a href="#l2.385"></a><span id="l2.385" class="difflineminus">-        ds.Change(this.resource, DC_LASTMODIFIED, old_lastmodified, aLastModified);</span>
<a href="#l2.386"></a><span id="l2.386" class="difflineplus">+      ds.Change(this.resource, FeedUtils.DC_LASTMODIFIED,</span>
<a href="#l2.387"></a><span id="l2.387" class="difflineplus">+                old_lastmodified, aLastModified);</span>
<a href="#l2.388"></a><span id="l2.388">     else</span>
<a href="#l2.389"></a><span id="l2.389" class="difflineminus">-        ds.Assert(this.resource, DC_LASTMODIFIED, aLastModified, true);  </span>
<a href="#l2.390"></a><span id="l2.390" class="difflineplus">+      ds.Assert(this.resource, FeedUtils.DC_LASTMODIFIED, aLastModified, true);</span>
<a href="#l2.391"></a><span id="l2.391"> </span>
<a href="#l2.392"></a><span id="l2.392" class="difflineminus">-    // do we need to flush every time this property changes? </span>
<a href="#l2.393"></a><span id="l2.393" class="difflineminus">-    ds = ds.QueryInterface(Components.interfaces.nsIRDFRemoteDataSource);    </span>
<a href="#l2.394"></a><span id="l2.394" class="difflineminus">-    ds.Flush();  </span>
<a href="#l2.395"></a><span id="l2.395" class="difflineplus">+    // Do we need to flush every time this property changes?</span>
<a href="#l2.396"></a><span id="l2.396" class="difflineplus">+    ds.QueryInterface(Ci.nsIRDFRemoteDataSource).Flush();</span>
<a href="#l2.397"></a><span id="l2.397">   },</span>
<a href="#l2.398"></a><span id="l2.398"> </span>
<a href="#l2.399"></a><span id="l2.399">   get quickMode ()</span>
<a href="#l2.400"></a><span id="l2.400">   {</span>
<a href="#l2.401"></a><span id="l2.401" class="difflineminus">-    var ds = getSubscriptionsDS(this.server);</span>
<a href="#l2.402"></a><span id="l2.402" class="difflineminus">-    var quickMode = ds.GetTarget(this.resource, FZ_QUICKMODE, true);</span>
<a href="#l2.403"></a><span id="l2.403" class="difflineminus">-    if (quickMode) </span>
<a href="#l2.404"></a><span id="l2.404" class="difflineplus">+    let ds = FeedUtils.getSubscriptionsDS(this.server);</span>
<a href="#l2.405"></a><span id="l2.405" class="difflineplus">+    let quickMode = ds.GetTarget(this.resource, FeedUtils.FZ_QUICKMODE, true);</span>
<a href="#l2.406"></a><span id="l2.406" class="difflineplus">+    if (quickMode)</span>
<a href="#l2.407"></a><span id="l2.407">     {</span>
<a href="#l2.408"></a><span id="l2.408" class="difflineminus">-      quickMode = quickMode.QueryInterface(Components.interfaces.nsIRDFLiteral);</span>
<a href="#l2.409"></a><span id="l2.409" class="difflineminus">-      quickMode = quickMode.Value;</span>
<a href="#l2.410"></a><span id="l2.410" class="difflineminus">-      quickMode = eval(quickMode);</span>
<a href="#l2.411"></a><span id="l2.411" class="difflineminus">-    }    </span>
<a href="#l2.412"></a><span id="l2.412" class="difflineplus">+      quickMode = quickMode.QueryInterface(Ci.nsIRDFLiteral);</span>
<a href="#l2.413"></a><span id="l2.413" class="difflineplus">+      quickMode = quickMode.Value == &quot;true&quot; ? true : false;</span>
<a href="#l2.414"></a><span id="l2.414" class="difflineplus">+    }</span>
<a href="#l2.415"></a><span id="l2.415" class="difflineplus">+</span>
<a href="#l2.416"></a><span id="l2.416">     return quickMode;</span>
<a href="#l2.417"></a><span id="l2.417">   },</span>
<a href="#l2.418"></a><span id="l2.418"> </span>
<a href="#l2.419"></a><span id="l2.419" class="difflineminus">-  set quickMode (aNewQuickMode) </span>
<a href="#l2.420"></a><span id="l2.420" class="difflineplus">+  set quickMode (aNewQuickMode)</span>
<a href="#l2.421"></a><span id="l2.421">   {</span>
<a href="#l2.422"></a><span id="l2.422" class="difflineminus">-    var ds = getSubscriptionsDS(this.server);</span>
<a href="#l2.423"></a><span id="l2.423" class="difflineminus">-    aNewQuickMode = rdf.GetLiteral(aNewQuickMode);</span>
<a href="#l2.424"></a><span id="l2.424" class="difflineminus">-    var old_quickMode = ds.GetTarget(this.resource, FZ_QUICKMODE, true);</span>
<a href="#l2.425"></a><span id="l2.425" class="difflineplus">+    let ds = FeedUtils.getSubscriptionsDS(this.server);</span>
<a href="#l2.426"></a><span id="l2.426" class="difflineplus">+    aNewQuickMode = FeedUtils.rdf.GetLiteral(aNewQuickMode);</span>
<a href="#l2.427"></a><span id="l2.427" class="difflineplus">+    let old_quickMode = ds.GetTarget(this.resource, </span>
<a href="#l2.428"></a><span id="l2.428" class="difflineplus">+                                     FeedUtils.FZ_QUICKMODE,</span>
<a href="#l2.429"></a><span id="l2.429" class="difflineplus">+                                     true);</span>
<a href="#l2.430"></a><span id="l2.430">     if (old_quickMode)</span>
<a href="#l2.431"></a><span id="l2.431" class="difflineminus">-      ds.Change(this.resource, FZ_QUICKMODE, old_quickMode, aNewQuickMode);</span>
<a href="#l2.432"></a><span id="l2.432" class="difflineplus">+      ds.Change(this.resource, FeedUtils.FZ_QUICKMODE,</span>
<a href="#l2.433"></a><span id="l2.433" class="difflineplus">+                old_quickMode, aNewQuickMode);</span>
<a href="#l2.434"></a><span id="l2.434">     else</span>
<a href="#l2.435"></a><span id="l2.435" class="difflineminus">-      ds.Assert(this.resource, FZ_QUICKMODE, aNewQuickMode, true);</span>
<a href="#l2.436"></a><span id="l2.436" class="difflineplus">+      ds.Assert(this.resource, FeedUtils.FZ_QUICKMODE,</span>
<a href="#l2.437"></a><span id="l2.437" class="difflineplus">+                aNewQuickMode, true);</span>
<a href="#l2.438"></a><span id="l2.438">   },</span>
<a href="#l2.439"></a><span id="l2.439"> </span>
<a href="#l2.440"></a><span id="l2.440">   get link ()</span>
<a href="#l2.441"></a><span id="l2.441">   {</span>
<a href="#l2.442"></a><span id="l2.442" class="difflineminus">-    var ds = getSubscriptionsDS(this.server);</span>
<a href="#l2.443"></a><span id="l2.443" class="difflineminus">-    var link = ds.GetTarget(this.resource, RSS_LINK, true);</span>
<a href="#l2.444"></a><span id="l2.444" class="difflineminus">-    if(link)</span>
<a href="#l2.445"></a><span id="l2.445" class="difflineminus">-      link = link.QueryInterface(Components.interfaces.nsIRDFLiteral).Value;</span>
<a href="#l2.446"></a><span id="l2.446" class="difflineplus">+    let ds = FeedUtils.getSubscriptionsDS(this.server);</span>
<a href="#l2.447"></a><span id="l2.447" class="difflineplus">+    let link = ds.GetTarget(this.resource, FeedUtils.RSS_LINK, true);</span>
<a href="#l2.448"></a><span id="l2.448" class="difflineplus">+    if (link)</span>
<a href="#l2.449"></a><span id="l2.449" class="difflineplus">+      link = link.QueryInterface(Ci.nsIRDFLiteral).Value;</span>
<a href="#l2.450"></a><span id="l2.450" class="difflineplus">+</span>
<a href="#l2.451"></a><span id="l2.451">     return link;</span>
<a href="#l2.452"></a><span id="l2.452">   },</span>
<a href="#l2.453"></a><span id="l2.453"> </span>
<a href="#l2.454"></a><span id="l2.454">   set link (aNewLink)</span>
<a href="#l2.455"></a><span id="l2.455">   {</span>
<a href="#l2.456"></a><span id="l2.456">     if (!aNewLink)</span>
<a href="#l2.457"></a><span id="l2.457">       return;</span>
<a href="#l2.458"></a><span id="l2.458"> </span>
<a href="#l2.459"></a><span id="l2.459" class="difflineminus">-    var ds = getSubscriptionsDS(this.server);</span>
<a href="#l2.460"></a><span id="l2.460" class="difflineminus">-    aNewLink = rdf.GetLiteral(aNewLink);</span>
<a href="#l2.461"></a><span id="l2.461" class="difflineminus">-    var old_link = ds.GetTarget(this.resource, RSS_LINK, true);</span>
<a href="#l2.462"></a><span id="l2.462" class="difflineplus">+    let ds = FeedUtils.getSubscriptionsDS(this.server);</span>
<a href="#l2.463"></a><span id="l2.463" class="difflineplus">+    aNewLink = FeedUtils.rdf.GetLiteral(aNewLink);</span>
<a href="#l2.464"></a><span id="l2.464" class="difflineplus">+    let old_link = ds.GetTarget(this.resource, FeedUtils.RSS_LINK, true);</span>
<a href="#l2.465"></a><span id="l2.465">     if (old_link)</span>
<a href="#l2.466"></a><span id="l2.466" class="difflineminus">-      ds.Change(this.resource, RSS_LINK, old_link, aNewLink);</span>
<a href="#l2.467"></a><span id="l2.467" class="difflineplus">+      ds.Change(this.resource, FeedUtils.RSS_LINK, old_link, aNewLink);</span>
<a href="#l2.468"></a><span id="l2.468">     else</span>
<a href="#l2.469"></a><span id="l2.469" class="difflineminus">-      ds.Assert(this.resource, RSS_LINK, aNewLink, true);</span>
<a href="#l2.470"></a><span id="l2.470" class="difflineplus">+      ds.Assert(this.resource, FeedUtils.RSS_LINK, aNewLink, true);</span>
<a href="#l2.471"></a><span id="l2.471">   },</span>
<a href="#l2.472"></a><span id="l2.472"> </span>
<a href="#l2.473"></a><span id="l2.473" class="difflineminus">-  parse: function() </span>
<a href="#l2.474"></a><span id="l2.474" class="difflineplus">+  parse: function()</span>
<a href="#l2.475"></a><span id="l2.475">   {</span>
<a href="#l2.476"></a><span id="l2.476">     // Create a feed parser which will parse the feed.</span>
<a href="#l2.477"></a><span id="l2.477" class="difflineminus">-    var parser = new FeedParser();</span>
<a href="#l2.478"></a><span id="l2.478" class="difflineplus">+    let parser = new FeedParser();</span>
<a href="#l2.479"></a><span id="l2.479">     this.itemsToStore = parser.parseFeed(this,</span>
<a href="#l2.480"></a><span id="l2.480">                                          this.request.responseXML,</span>
<a href="#l2.481"></a><span id="l2.481">                                          this.request.channel.URI);</span>
<a href="#l2.482"></a><span id="l2.482">     if (this.mInvalidFeed)</span>
<a href="#l2.483"></a><span id="l2.483">     {</span>
<a href="#l2.484"></a><span id="l2.484">       this.request = null;</span>
<a href="#l2.485"></a><span id="l2.485">       this.mInvalidFeed = false;</span>
<a href="#l2.486"></a><span id="l2.486">       return;</span>
<a href="#l2.487"></a><span id="l2.487">     }</span>
<a href="#l2.488"></a><span id="l2.488"> </span>
<a href="#l2.489"></a><span id="l2.489" class="difflineminus">-    // storeNextItem will iterate through the parsed items, storing each one.</span>
<a href="#l2.490"></a><span id="l2.490" class="difflineplus">+    // storeNextItem() will iterate through the parsed items, storing each one.</span>
<a href="#l2.491"></a><span id="l2.491">     this.itemsToStoreIndex = 0;</span>
<a href="#l2.492"></a><span id="l2.492">     this.storeNextItem();</span>
<a href="#l2.493"></a><span id="l2.493">   },</span>
<a href="#l2.494"></a><span id="l2.494"> </span>
<a href="#l2.495"></a><span id="l2.495" class="difflineminus">-  invalidateItems: function () </span>
<a href="#l2.496"></a><span id="l2.496" class="difflineplus">+  invalidateItems: function ()</span>
<a href="#l2.497"></a><span id="l2.497">   {</span>
<a href="#l2.498"></a><span id="l2.498" class="difflineminus">-    var ds = getItemsDS(this.server);</span>
<a href="#l2.499"></a><span id="l2.499" class="difflineminus">-    debug(&quot;invalidating items for &quot; + this.url);</span>
<a href="#l2.500"></a><span id="l2.500" class="difflineminus">-    var items = ds.GetSources(FZ_FEED, this.resource, true);</span>
<a href="#l2.501"></a><span id="l2.501" class="difflineminus">-    var item;</span>
<a href="#l2.502"></a><span id="l2.502" class="difflineminus">-  </span>
<a href="#l2.503"></a><span id="l2.503" class="difflineminus">-    while (items.hasMoreElements()) </span>
<a href="#l2.504"></a><span id="l2.504" class="difflineplus">+    let ds = FeedUtils.getItemsDS(this.server);</span>
<a href="#l2.505"></a><span id="l2.505" class="difflineplus">+    FeedUtils.log.debug(&quot;Feed.invalidateItems: for url - &quot; + this.url);</span>
<a href="#l2.506"></a><span id="l2.506" class="difflineplus">+    let items = ds.GetSources(FeedUtils.FZ_FEED, this.resource, true);</span>
<a href="#l2.507"></a><span id="l2.507" class="difflineplus">+    let item;</span>
<a href="#l2.508"></a><span id="l2.508" class="difflineplus">+</span>
<a href="#l2.509"></a><span id="l2.509" class="difflineplus">+    while (items.hasMoreElements())</span>
<a href="#l2.510"></a><span id="l2.510">     {</span>
<a href="#l2.511"></a><span id="l2.511">       item = items.getNext();</span>
<a href="#l2.512"></a><span id="l2.512" class="difflineminus">-      item = item.QueryInterface(Components.interfaces.nsIRDFResource);</span>
<a href="#l2.513"></a><span id="l2.513" class="difflineminus">-      debug(&quot;invalidating &quot; + item.Value);</span>
<a href="#l2.514"></a><span id="l2.514" class="difflineminus">-      var valid = ds.GetTarget(item, FZ_VALID, true);</span>
<a href="#l2.515"></a><span id="l2.515" class="difflineplus">+      item = item.QueryInterface(Ci.nsIRDFResource);</span>
<a href="#l2.516"></a><span id="l2.516" class="difflineplus">+      FeedUtils.log.trace(&quot;Feed.invalidateItems: item - &quot; + item.Value);</span>
<a href="#l2.517"></a><span id="l2.517" class="difflineplus">+      let valid = ds.GetTarget(item, FeedUtils.FZ_VALID, true);</span>
<a href="#l2.518"></a><span id="l2.518">       if (valid)</span>
<a href="#l2.519"></a><span id="l2.519" class="difflineminus">-        ds.Unassert(item, FZ_VALID, valid, true);</span>
<a href="#l2.520"></a><span id="l2.520" class="difflineplus">+        ds.Unassert(item, FeedUtils.FZ_VALID, valid, true);</span>
<a href="#l2.521"></a><span id="l2.521">     }</span>
<a href="#l2.522"></a><span id="l2.522" class="difflineminus">-  }, </span>
<a href="#l2.523"></a><span id="l2.523" class="difflineplus">+  },</span>
<a href="#l2.524"></a><span id="l2.524"> </span>
<a href="#l2.525"></a><span id="l2.525" class="difflineminus">-  removeInvalidItems: function(aDeleteFeed) </span>
<a href="#l2.526"></a><span id="l2.526" class="difflineplus">+  removeInvalidItems: function(aDeleteFeed)</span>
<a href="#l2.527"></a><span id="l2.527">   {</span>
<a href="#l2.528"></a><span id="l2.528" class="difflineminus">-    var ds = getItemsDS(this.server);</span>
<a href="#l2.529"></a><span id="l2.529" class="difflineminus">-    debug(&quot;removing invalid items for &quot; + this.url);</span>
<a href="#l2.530"></a><span id="l2.530" class="difflineminus">-    var items = ds.GetSources(FZ_FEED, this.resource, true);</span>
<a href="#l2.531"></a><span id="l2.531" class="difflineminus">-    var item;</span>
<a href="#l2.532"></a><span id="l2.532" class="difflineminus">-    var currentTime = new Date().getTime();</span>
<a href="#l2.533"></a><span id="l2.533" class="difflineminus">-    while (items.hasMoreElements()) </span>
<a href="#l2.534"></a><span id="l2.534" class="difflineplus">+    let ds = FeedUtils.getItemsDS(this.server);</span>
<a href="#l2.535"></a><span id="l2.535" class="difflineplus">+    FeedUtils.log.debug(&quot;Feed.removeInvalidItems: for url - &quot; + this.url);</span>
<a href="#l2.536"></a><span id="l2.536" class="difflineplus">+    let items = ds.GetSources(FeedUtils.FZ_FEED, this.resource, true);</span>
<a href="#l2.537"></a><span id="l2.537" class="difflineplus">+    let item;</span>
<a href="#l2.538"></a><span id="l2.538" class="difflineplus">+    let currentTime = new Date().getTime();</span>
<a href="#l2.539"></a><span id="l2.539" class="difflineplus">+    while (items.hasMoreElements())</span>
<a href="#l2.540"></a><span id="l2.540">     {</span>
<a href="#l2.541"></a><span id="l2.541">       item = items.getNext();</span>
<a href="#l2.542"></a><span id="l2.542" class="difflineminus">-      item = item.QueryInterface(Components.interfaces.nsIRDFResource);</span>
<a href="#l2.543"></a><span id="l2.543" class="difflineplus">+      item = item.QueryInterface(Ci.nsIRDFResource);</span>
<a href="#l2.544"></a><span id="l2.544"> </span>
<a href="#l2.545"></a><span id="l2.545" class="difflineminus">-      if (ds.HasAssertion(item, FZ_VALID, RDF_LITERAL_TRUE, true))</span>
<a href="#l2.546"></a><span id="l2.546" class="difflineplus">+      if (ds.HasAssertion(item, FeedUtils.FZ_VALID,</span>
<a href="#l2.547"></a><span id="l2.547" class="difflineplus">+                          FeedUtils.RDF_LITERAL_TRUE, true))</span>
<a href="#l2.548"></a><span id="l2.548">         continue;</span>
<a href="#l2.549"></a><span id="l2.549"> </span>
<a href="#l2.550"></a><span id="l2.550" class="difflineminus">-      var lastSeenTime = ds.GetTarget(item, FZ_LAST_SEEN_TIMESTAMP, true);</span>
<a href="#l2.551"></a><span id="l2.551" class="difflineminus">-      lastSeenTime = lastSeenTime ?</span>
<a href="#l2.552"></a><span id="l2.552" class="difflineminus">-                     parseInt(lastSeenTime</span>
<a href="#l2.553"></a><span id="l2.553" class="difflineminus">-                              .QueryInterface(Components.interfaces.nsIRDFLiteral)</span>
<a href="#l2.554"></a><span id="l2.554" class="difflineminus">-                              .Value) : 0;</span>
<a href="#l2.555"></a><span id="l2.555" class="difflineminus">-      if ((currentTime - lastSeenTime) &lt; INVALID_ITEM_PURGE_DELAY &amp;&amp; !aDeleteFeed)</span>
<a href="#l2.556"></a><span id="l2.556" class="difflineplus">+      let lastSeenTime = ds.GetTarget(item, FeedUtils.FZ_LAST_SEEN_TIMESTAMP, true);</span>
<a href="#l2.557"></a><span id="l2.557" class="difflineplus">+      if (lastSeenTime)</span>
<a href="#l2.558"></a><span id="l2.558" class="difflineplus">+        lastSeenTime = parseInt(lastSeenTime.QueryInterface(Ci.nsIRDFLiteral).Value)</span>
<a href="#l2.559"></a><span id="l2.559" class="difflineplus">+      else</span>
<a href="#l2.560"></a><span id="l2.560" class="difflineplus">+        lastSeenTime = 0;</span>
<a href="#l2.561"></a><span id="l2.561" class="difflineplus">+</span>
<a href="#l2.562"></a><span id="l2.562" class="difflineplus">+      if ((currentTime - lastSeenTime) &lt; FeedUtils.INVALID_ITEM_PURGE_DELAY &amp;&amp;</span>
<a href="#l2.563"></a><span id="l2.563" class="difflineplus">+          !aDeleteFeed)</span>
<a href="#l2.564"></a><span id="l2.564">         // Don't immediately purge items in active feeds; do so for deleted feeds.</span>
<a href="#l2.565"></a><span id="l2.565">         continue;</span>
<a href="#l2.566"></a><span id="l2.566"> </span>
<a href="#l2.567"></a><span id="l2.567" class="difflineminus">-      debug(&quot;removing &quot; + item.Value);</span>
<a href="#l2.568"></a><span id="l2.568" class="difflineminus">-      ds.Unassert(item, FZ_FEED, this.resource, true);</span>
<a href="#l2.569"></a><span id="l2.569" class="difflineminus">-      if (ds.hasArcOut(item, FZ_FEED))</span>
<a href="#l2.570"></a><span id="l2.570" class="difflineminus">-        debug(item.Value + &quot; is from more than one feed; only the reference to this feed removed&quot;);</span>
<a href="#l2.571"></a><span id="l2.571" class="difflineplus">+      FeedUtils.log.trace(&quot;Feed.removeInvalidItems: item - &quot; + item.Value);</span>
<a href="#l2.572"></a><span id="l2.572" class="difflineplus">+      ds.Unassert(item, FeedUtils.FZ_FEED, this.resource, true);</span>
<a href="#l2.573"></a><span id="l2.573" class="difflineplus">+      if (ds.hasArcOut(item, FeedUtils.FZ_FEED))</span>
<a href="#l2.574"></a><span id="l2.574" class="difflineplus">+        FeedUtils.log.debug(&quot;Feed.removeInvalidItems: &quot; + item.Value +</span>
<a href="#l2.575"></a><span id="l2.575" class="difflineplus">+                            &quot; is from more than one feed; only the reference to&quot; +</span>
<a href="#l2.576"></a><span id="l2.576" class="difflineplus">+                            &quot; this feed removed&quot;);</span>
<a href="#l2.577"></a><span id="l2.577">       else</span>
<a href="#l2.578"></a><span id="l2.578" class="difflineminus">-        removeAssertions(ds, item);</span>
<a href="#l2.579"></a><span id="l2.579" class="difflineplus">+        FeedUtils.removeAssertions(ds, item);</span>
<a href="#l2.580"></a><span id="l2.580">     }</span>
<a href="#l2.581"></a><span id="l2.581">   },</span>
<a href="#l2.582"></a><span id="l2.582"> </span>
<a href="#l2.583"></a><span id="l2.583">   createFolder: function()</span>
<a href="#l2.584"></a><span id="l2.584" class="difflineminus">-  {   </span>
<a href="#l2.585"></a><span id="l2.585" class="difflineminus">-    if (!this.folder) </span>
<a href="#l2.586"></a><span id="l2.586" class="difflineminus">-      this.server.rootMsgFolder.createSubfolder(this.name, null /* supposed to be a msg window */);      </span>
<a href="#l2.587"></a><span id="l2.587" class="difflineplus">+  {</span>
<a href="#l2.588"></a><span id="l2.588" class="difflineplus">+    if (!this.folder)</span>
<a href="#l2.589"></a><span id="l2.589" class="difflineplus">+      this.server.rootMsgFolder.createSubfolder(this.name, null);</span>
<a href="#l2.590"></a><span id="l2.590">   },</span>
<a href="#l2.591"></a><span id="l2.591"> </span>
<a href="#l2.592"></a><span id="l2.592" class="difflineminus">-  // gets the next item from gItemsToStore and forces that item to be stored</span>
<a href="#l2.593"></a><span id="l2.593" class="difflineminus">-  // to the folder. If more items are left to be stored, fires a timer for the next one.</span>
<a href="#l2.594"></a><span id="l2.594" class="difflineminus">-  // otherwise it triggers a download done notification to the UI</span>
<a href="#l2.595"></a><span id="l2.595" class="difflineplus">+  // Gets the next item from itemsToStore and forces that item to be stored</span>
<a href="#l2.596"></a><span id="l2.596" class="difflineplus">+  // to the folder.  If more items are left to be stored, fires a timer for</span>
<a href="#l2.597"></a><span id="l2.597" class="difflineplus">+  // the next one, otherwise triggers a download done notification to the UI.</span>
<a href="#l2.598"></a><span id="l2.598">   storeNextItem: function()</span>
<a href="#l2.599"></a><span id="l2.599">   {</span>
<a href="#l2.600"></a><span id="l2.600" class="difflineminus">-    if (!this.itemsToStore ||  !this.itemsToStore.length)</span>
<a href="#l2.601"></a><span id="l2.601" class="difflineplus">+    if (!this.itemsToStore || !this.itemsToStore.length)</span>
<a href="#l2.602"></a><span id="l2.602">     {</span>
<a href="#l2.603"></a><span id="l2.603">       this.createFolder();</span>
<a href="#l2.604"></a><span id="l2.604">       this.cleanupParsingState(this);</span>
<a href="#l2.605"></a><span id="l2.605">       return;</span>
<a href="#l2.606"></a><span id="l2.606">     }</span>
<a href="#l2.607"></a><span id="l2.607"> </span>
<a href="#l2.608"></a><span id="l2.608" class="difflineminus">-    var item = this.itemsToStore[this.itemsToStoreIndex]; </span>
<a href="#l2.609"></a><span id="l2.609" class="difflineplus">+    let item = this.itemsToStore[this.itemsToStoreIndex];</span>
<a href="#l2.610"></a><span id="l2.610"> </span>
<a href="#l2.611"></a><span id="l2.611">     item.store();</span>
<a href="#l2.612"></a><span id="l2.612"> </span>
<a href="#l2.613"></a><span id="l2.613">     this.itemsToStoreIndex++;</span>
<a href="#l2.614"></a><span id="l2.614"> </span>
<a href="#l2.615"></a><span id="l2.615" class="difflineminus">-    // if the listener is tracking progress for storing each item, report it here...</span>
<a href="#l2.616"></a><span id="l2.616" class="difflineplus">+    // If the listener is tracking progress for each item, report it here.</span>
<a href="#l2.617"></a><span id="l2.617">     if (item.feed.downloadCallback &amp;&amp; item.feed.downloadCallback.onFeedItemStored)</span>
<a href="#l2.618"></a><span id="l2.618" class="difflineminus">-      item.feed.downloadCallback.onFeedItemStored(item.feed, this.itemsToStoreIndex, this.itemsToStore.length);</span>
<a href="#l2.619"></a><span id="l2.619" class="difflineminus">- </span>
<a href="#l2.620"></a><span id="l2.620" class="difflineminus">-    // eventually we'll report individual progress here....</span>
<a href="#l2.621"></a><span id="l2.621" class="difflineplus">+      item.feed.downloadCallback.onFeedItemStored(item.feed,</span>
<a href="#l2.622"></a><span id="l2.622" class="difflineplus">+                                                  this.itemsToStoreIndex,</span>
<a href="#l2.623"></a><span id="l2.623" class="difflineplus">+                                                  this.itemsToStore.length);</span>
<a href="#l2.624"></a><span id="l2.624" class="difflineplus">+</span>
<a href="#l2.625"></a><span id="l2.625" class="difflineplus">+    // Eventually we'll report individual progress here.</span>
<a href="#l2.626"></a><span id="l2.626"> </span>
<a href="#l2.627"></a><span id="l2.627">     if (this.itemsToStoreIndex &lt; this.itemsToStore.length)</span>
<a href="#l2.628"></a><span id="l2.628">     {</span>
<a href="#l2.629"></a><span id="l2.629">       if (!this.storeItemsTimer)</span>
<a href="#l2.630"></a><span id="l2.630" class="difflineminus">-        this.storeItemsTimer = Components.classes[&quot;@mozilla.org/timer;1&quot;].createInstance(Components.interfaces.nsITimer);</span>
<a href="#l2.631"></a><span id="l2.631" class="difflineminus">-      this.storeItemsTimer.initWithCallback(this, 50, Components.interfaces.nsITimer.TYPE_ONE_SHOT);</span>
<a href="#l2.632"></a><span id="l2.632" class="difflineplus">+        this.storeItemsTimer = Cc[&quot;@mozilla.org/timer;1&quot;].</span>
<a href="#l2.633"></a><span id="l2.633" class="difflineplus">+                               createInstance(Ci.nsITimer);</span>
<a href="#l2.634"></a><span id="l2.634" class="difflineplus">+      this.storeItemsTimer.initWithCallback(this, 50, Ci.nsITimer.TYPE_ONE_SHOT);</span>
<a href="#l2.635"></a><span id="l2.635">     }</span>
<a href="#l2.636"></a><span id="l2.636">     else</span>
<a href="#l2.637"></a><span id="l2.637">     {</span>
<a href="#l2.638"></a><span id="l2.638" class="difflineminus">-      // we have just finished downloading one or more feed items into the destination folder,</span>
<a href="#l2.639"></a><span id="l2.639" class="difflineminus">-      // if the folder is still listed as having new messages in it, then we should set the biff state on the folder</span>
<a href="#l2.640"></a><span id="l2.640" class="difflineminus">-      // so the right RDF UI changes happen in the folder pane to indicate new mail.</span>
<a href="#l2.641"></a><span id="l2.641" class="difflineminus">-</span>
<a href="#l2.642"></a><span id="l2.642" class="difflineplus">+      // We have just finished downloading one or more feed items into the</span>
<a href="#l2.643"></a><span id="l2.643" class="difflineplus">+      // destination folder; if the folder is still listed as having new</span>
<a href="#l2.644"></a><span id="l2.644" class="difflineplus">+      // messages in it, then we should set the biff state on the folder so the</span>
<a href="#l2.645"></a><span id="l2.645" class="difflineplus">+      // right RDF UI changes happen in the folder pane to indicate new mail.</span>
<a href="#l2.646"></a><span id="l2.646">       if (item.feed.folder.hasNewMessages)</span>
<a href="#l2.647"></a><span id="l2.647">       {</span>
<a href="#l2.648"></a><span id="l2.648" class="difflineminus">-        item.feed.folder.biffState = Components.interfaces.nsIMsgFolder.nsMsgBiffState_NewMail;</span>
<a href="#l2.649"></a><span id="l2.649" class="difflineminus">-        // run the bayesian spam filter, if enabled</span>
<a href="#l2.650"></a><span id="l2.650" class="difflineplus">+        item.feed.folder.biffState = Ci.nsIMsgFolder.nsMsgBiffState_NewMail;</span>
<a href="#l2.651"></a><span id="l2.651" class="difflineplus">+        // Run the bayesian spam filter, if enabled.</span>
<a href="#l2.652"></a><span id="l2.652">         item.feed.folder.callFilterPlugins(null);</span>
<a href="#l2.653"></a><span id="l2.653">       }</span>
<a href="#l2.654"></a><span id="l2.654" class="difflineplus">+</span>
<a href="#l2.655"></a><span id="l2.655">       this.cleanupParsingState(item.feed);</span>
<a href="#l2.656"></a><span id="l2.656">     }</span>
<a href="#l2.657"></a><span id="l2.657">   },</span>
<a href="#l2.658"></a><span id="l2.658"> </span>
<a href="#l2.659"></a><span id="l2.659" class="difflineminus">-  cleanupParsingState: function(aFeed) </span>
<a href="#l2.660"></a><span id="l2.660" class="difflineplus">+  cleanupParsingState: function(aFeed)</span>
<a href="#l2.661"></a><span id="l2.661">   {</span>
<a href="#l2.662"></a><span id="l2.662" class="difflineminus">-    // now that we are done parsing the feed, remove the feed from our feed cache</span>
<a href="#l2.663"></a><span id="l2.663" class="difflineplus">+    // Now that we are done parsing the feed, remove the feed from the cache.</span>
<a href="#l2.664"></a><span id="l2.664">     FeedCache.removeFeed(aFeed.url);</span>
<a href="#l2.665"></a><span id="l2.665">     aFeed.removeInvalidItems(false);</span>
<a href="#l2.666"></a><span id="l2.666"> </span>
<a href="#l2.667"></a><span id="l2.667" class="difflineminus">-    // let's be sure to flush any feed item changes back to disk</span>
<a href="#l2.668"></a><span id="l2.668" class="difflineminus">-    var ds = getItemsDS(aFeed.server);</span>
<a href="#l2.669"></a><span id="l2.669" class="difflineminus">-    ds.QueryInterface(Components.interfaces.nsIRDFRemoteDataSource).Flush(); // flush any changes</span>
<a href="#l2.670"></a><span id="l2.670" class="difflineplus">+    // Flush any feed item changes to disk.</span>
<a href="#l2.671"></a><span id="l2.671" class="difflineplus">+    let ds = FeedUtils.getItemsDS(aFeed.server);</span>
<a href="#l2.672"></a><span id="l2.672" class="difflineplus">+    ds.QueryInterface(Ci.nsIRDFRemoteDataSource).Flush();</span>
<a href="#l2.673"></a><span id="l2.673"> </span>
<a href="#l2.674"></a><span id="l2.674">     if (aFeed.downloadCallback)</span>
<a href="#l2.675"></a><span id="l2.675" class="difflineminus">-      aFeed.downloadCallback.downloaded(aFeed, kNewsBlogSuccess);</span>
<a href="#l2.676"></a><span id="l2.676" class="difflineplus">+      aFeed.downloadCallback.downloaded(aFeed, FeedUtils.kNewsBlogSuccess);</span>
<a href="#l2.677"></a><span id="l2.677"> </span>
<a href="#l2.678"></a><span id="l2.678" class="difflineminus">-    this.request = null; // force the xml http request to go away. This helps reduce some nasty assertions on shut down. </span>
<a href="#l2.679"></a><span id="l2.679" class="difflineplus">+    // Force the xml http request to go away.  This helps reduce some nasty</span>
<a href="#l2.680"></a><span id="l2.680" class="difflineplus">+    // assertions on shut down.</span>
<a href="#l2.681"></a><span id="l2.681" class="difflineplus">+    this.request = null;</span>
<a href="#l2.682"></a><span id="l2.682">     this.itemsToStore = &quot;&quot;;</span>
<a href="#l2.683"></a><span id="l2.683">     this.itemsToStoreIndex = 0;</span>
<a href="#l2.684"></a><span id="l2.684">     this.storeItemsTimer = null;</span>
<a href="#l2.685"></a><span id="l2.685" class="difflineminus">-  }, </span>
<a href="#l2.686"></a><span id="l2.686" class="difflineplus">+  },</span>
<a href="#l2.687"></a><span id="l2.687"> </span>
<a href="#l2.688"></a><span id="l2.688" class="difflineminus">-  notify: function(aTimer) </span>
<a href="#l2.689"></a><span id="l2.689" class="difflineplus">+  // nsITimerCallback</span>
<a href="#l2.690"></a><span id="l2.690" class="difflineplus">+  notify: function(aTimer)</span>
<a href="#l2.691"></a><span id="l2.691">   {</span>
<a href="#l2.692"></a><span id="l2.692">     this.storeNextItem();</span>
<a href="#l2.693"></a><span id="l2.693" class="difflineminus">-  }, </span>
<a href="#l2.694"></a><span id="l2.694" class="difflineminus">-</span>
<a href="#l2.695"></a><span id="l2.695" class="difflineminus">-  QueryInterface: function(aIID) </span>
<a href="#l2.696"></a><span id="l2.696" class="difflineminus">-  {</span>
<a href="#l2.697"></a><span id="l2.697" class="difflineminus">-    if (aIID.equals(Components.interfaces.nsITimerCallback) || aIID.equals(Components.interfaces.nsISupports))</span>
<a href="#l2.698"></a><span id="l2.698" class="difflineminus">-      return this;</span>
<a href="#l2.699"></a><span id="l2.699" class="difflineminus">-</span>
<a href="#l2.700"></a><span id="l2.700" class="difflineminus">-    throw Components.results.NS_ERROR_NO_INTERFACE;</span>
<a href="#l2.701"></a><span id="l2.701">   }</span>
<a href="#l2.702"></a><span id="l2.702"> };</span>
<a href="#l2.703"></a><span id="l2.703"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/extensions/newsblog/content/FeedItem.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/extensions/newsblog/content/FeedItem.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -30,74 +30,66 @@</span>
<a href="#l3.4"></a><span id="l3.4"> # use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l3.5"></a><span id="l3.5"> # decision by deleting the provisions above and replace them with the notice</span>
<a href="#l3.6"></a><span id="l3.6"> # and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l3.7"></a><span id="l3.7"> # the provisions above, a recipient may use your version of this file under</span>
<a href="#l3.8"></a><span id="l3.8"> # the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l3.9"></a><span id="l3.9"> #</span>
<a href="#l3.10"></a><span id="l3.10"> # ***** END LICENSE BLOCK ***** */</span>
<a href="#l3.11"></a><span id="l3.11"> </span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-// Handy conversion values.</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-const HOURS_TO_MINUTES = 60;</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineminus">-const MINUTES_TO_SECONDS = 60;</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineminus">-const SECONDS_TO_MILLISECONDS = 1000;</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineminus">-const MINUTES_TO_MILLISECONDS = MINUTES_TO_SECONDS * SECONDS_TO_MILLISECONDS;</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineminus">-const HOURS_TO_MILLISECONDS = HOURS_TO_MINUTES * MINUTES_TO_MILLISECONDS;</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineminus">-const ENCLOSURE_BOUNDARY_PREFIX = &quot;--------------&quot;;  // 14 dashes</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineminus">-const ENCLOSURE_HEADER_BOUNDARY_PREFIX = &quot;------------&quot;; // 12 dashes</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineminus">-</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineminus">-const MESSAGE_TEMPLATE = &quot;\n\</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineminus">-&lt;html&gt;\n\</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineminus">-  &lt;head&gt;\n\</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineminus">-    &lt;title&gt;%TITLE%&lt;/title&gt;\n\</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineminus">-    &lt;base href=\&quot;%BASE%\&quot;&gt;\n\</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineminus">-  &lt;/head&gt;\n\</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineminus">-  &lt;body id=\&quot;msgFeedSummaryBody\&quot; selected=\&quot;false\&quot;&gt;\n\</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineminus">-    %CONTENT%\n\</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineminus">-  &lt;/body&gt;\n\</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineminus">-&lt;/html&gt;\n\</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineminus">-&quot;;</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineminus">-</span>
<a href="#l3.33"></a><span id="l3.33"> function FeedItem()</span>
<a href="#l3.34"></a><span id="l3.34"> {</span>
<a href="#l3.35"></a><span id="l3.35">   this.mDate = new Date().toString();</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineminus">-  this.mUnicodeConverter = Components.classes[&quot;@mozilla.org/intl/scriptableunicodeconverter&quot;]</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineminus">-                                     .createInstance(Components.interfaces.nsIScriptableUnicodeConverter);</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineplus">+  this.mUnicodeConverter = Cc[&quot;@mozilla.org/intl/scriptableunicodeconverter&quot;].</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineplus">+                           createInstance(Ci.nsIScriptableUnicodeConverter);</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineplus">+  this.mUnescapeHTML = Cc[&quot;@mozilla.org/feed-unescapehtml;1&quot;].</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineplus">+                       getService(Ci.nsIScriptableUnescapeHTML);</span>
<a href="#l3.42"></a><span id="l3.42"> }</span>
<a href="#l3.43"></a><span id="l3.43"> </span>
<a href="#l3.44"></a><span id="l3.44"> FeedItem.prototype =</span>
<a href="#l3.45"></a><span id="l3.45"> {</span>
<a href="#l3.46"></a><span id="l3.46" class="difflineminus">-  // Currently only for IETF Atom. RSS2 with GUIDs should do this as too.</span>
<a href="#l3.47"></a><span id="l3.47" class="difflineplus">+  // Currently only for IETF Atom.  RSS2 with GUIDs should do this too.</span>
<a href="#l3.48"></a><span id="l3.48">   isStoredWithId: false,</span>
<a href="#l3.49"></a><span id="l3.49" class="difflineminus">-  // Only for IETF Atom</span>
<a href="#l3.50"></a><span id="l3.50" class="difflineplus">+  // Only for IETF Atom.</span>
<a href="#l3.51"></a><span id="l3.51">   xmlContentBase: null,</span>
<a href="#l3.52"></a><span id="l3.52">   id: null,</span>
<a href="#l3.53"></a><span id="l3.53">   feed: null,</span>
<a href="#l3.54"></a><span id="l3.54">   description: null,</span>
<a href="#l3.55"></a><span id="l3.55">   content: null,</span>
<a href="#l3.56"></a><span id="l3.56" class="difflineminus">-  // Currently only support one enclosure per feed item...</span>
<a href="#l3.57"></a><span id="l3.57" class="difflineplus">+  // Currently only support one enclosure per feed item.</span>
<a href="#l3.58"></a><span id="l3.58">   enclosure: null,</span>
<a href="#l3.59"></a><span id="l3.59" class="difflineminus">-  // TO DO: this needs to be localized</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineplus">+  // TO DO: this needs to be localized.</span>
<a href="#l3.61"></a><span id="l3.61">   title: &quot;(no subject)&quot;,</span>
<a href="#l3.62"></a><span id="l3.62">   author: &quot;anonymous&quot;,</span>
<a href="#l3.63"></a><span id="l3.63">   mURL: null,</span>
<a href="#l3.64"></a><span id="l3.64">   characterSet: &quot;&quot;,</span>
<a href="#l3.65"></a><span id="l3.65"> </span>
<a href="#l3.66"></a><span id="l3.66" class="difflineplus">+  ENCLOSURE_BOUNDARY_PREFIX: &quot;--------------&quot;, // 14 dashes</span>
<a href="#l3.67"></a><span id="l3.67" class="difflineplus">+  ENCLOSURE_HEADER_BOUNDARY_PREFIX: &quot;------------&quot;, // 12 dashes</span>
<a href="#l3.68"></a><span id="l3.68" class="difflineplus">+  MESSAGE_TEMPLATE: '\n' +</span>
<a href="#l3.69"></a><span id="l3.69" class="difflineplus">+    '&lt;html&gt;\n' +</span>
<a href="#l3.70"></a><span id="l3.70" class="difflineplus">+    '  &lt;head&gt;\n' +</span>
<a href="#l3.71"></a><span id="l3.71" class="difflineplus">+    '    &lt;title&gt;%TITLE%&lt;/title&gt;\n' +</span>
<a href="#l3.72"></a><span id="l3.72" class="difflineplus">+    '    &lt;base href=&quot;%BASE%&quot;&gt;\n' +</span>
<a href="#l3.73"></a><span id="l3.73" class="difflineplus">+    '  &lt;/head&gt;\n' +</span>
<a href="#l3.74"></a><span id="l3.74" class="difflineplus">+    '  &lt;body id=&quot;msgFeedSummaryBody&quot; selected=&quot;false&quot;&gt;\n' +</span>
<a href="#l3.75"></a><span id="l3.75" class="difflineplus">+    '    %CONTENT%\n' +</span>
<a href="#l3.76"></a><span id="l3.76" class="difflineplus">+    '  &lt;/body&gt;\n' +</span>
<a href="#l3.77"></a><span id="l3.77" class="difflineplus">+    '&lt;/html&gt;\n',</span>
<a href="#l3.78"></a><span id="l3.78" class="difflineplus">+</span>
<a href="#l3.79"></a><span id="l3.79">   get url()</span>
<a href="#l3.80"></a><span id="l3.80">   {</span>
<a href="#l3.81"></a><span id="l3.81">     return this.mURL;</span>
<a href="#l3.82"></a><span id="l3.82">   },</span>
<a href="#l3.83"></a><span id="l3.83"> </span>
<a href="#l3.84"></a><span id="l3.84">   set url(aVal)</span>
<a href="#l3.85"></a><span id="l3.85">   {</span>
<a href="#l3.86"></a><span id="l3.86">     try</span>
<a href="#l3.87"></a><span id="l3.87">     {</span>
<a href="#l3.88"></a><span id="l3.88" class="difflineminus">-      var ioService = Components.classes[&quot;@mozilla.org/network/io-service;1&quot;]</span>
<a href="#l3.89"></a><span id="l3.89" class="difflineminus">-                                .getService(Components.interfaces.nsIIOService);</span>
<a href="#l3.90"></a><span id="l3.90" class="difflineminus">-      this.mURL = ioService.newURI(aVal, null, null).spec;</span>
<a href="#l3.91"></a><span id="l3.91" class="difflineplus">+      this.mURL = Services.io.newURI(aVal, null, null).spec;</span>
<a href="#l3.92"></a><span id="l3.92">     }</span>
<a href="#l3.93"></a><span id="l3.93">     catch(ex)</span>
<a href="#l3.94"></a><span id="l3.94">     {</span>
<a href="#l3.95"></a><span id="l3.95">       // The url as published or constructed can be a non url.  It's used as a</span>
<a href="#l3.96"></a><span id="l3.96">       // feeditem identifier in feeditems.rdf, as a messageId, and as an href</span>
<a href="#l3.97"></a><span id="l3.97">       // and for the content-base header.  Save as is; ensure not null.</span>
<a href="#l3.98"></a><span id="l3.98">       this.mURL = aVal ? aVal : &quot;&quot;;</span>
<a href="#l3.99"></a><span id="l3.99">     }</span>
<a href="#l3.100"></a><span id="l3.100" class="difflineat">@@ -115,235 +107,248 @@ FeedItem.prototype =</span>
<a href="#l3.101"></a><span id="l3.101"> </span>
<a href="#l3.102"></a><span id="l3.102">   get identity ()</span>
<a href="#l3.103"></a><span id="l3.103">   {</span>
<a href="#l3.104"></a><span id="l3.104">     return this.feed.name + &quot;: &quot; + this.title + &quot; (&quot; + this.id + &quot;)&quot;</span>
<a href="#l3.105"></a><span id="l3.105">   },</span>
<a href="#l3.106"></a><span id="l3.106"> </span>
<a href="#l3.107"></a><span id="l3.107">   get messageID()</span>
<a href="#l3.108"></a><span id="l3.108">   {</span>
<a href="#l3.109"></a><span id="l3.109" class="difflineminus">-    var messageID = this.id || this.mURL || this.title;</span>
<a href="#l3.110"></a><span id="l3.110" class="difflineplus">+    let messageID = this.id || this.mURL || this.title;</span>
<a href="#l3.111"></a><span id="l3.111"> </span>
<a href="#l3.112"></a><span id="l3.112" class="difflineminus">-    debug('messageID - id = ' + this.id);</span>
<a href="#l3.113"></a><span id="l3.113" class="difflineminus">-    debug('messageID - mURL = ' + this.mURL);</span>
<a href="#l3.114"></a><span id="l3.114" class="difflineminus">-    debug('messageID - title = ' + this.title);</span>
<a href="#l3.115"></a><span id="l3.115" class="difflineminus">-    debug('messageID - messageID = ' + messageID);</span>
<a href="#l3.116"></a><span id="l3.116" class="difflineplus">+    FeedUtils.log.trace(&quot;FeedItem.messageID: id - &quot; + this.id);</span>
<a href="#l3.117"></a><span id="l3.117" class="difflineplus">+    FeedUtils.log.trace(&quot;FeedItem.messageID: mURL - &quot; + this.mURL);</span>
<a href="#l3.118"></a><span id="l3.118" class="difflineplus">+    FeedUtils.log.trace(&quot;FeedItem.messageID: title - &quot; + this.title);</span>
<a href="#l3.119"></a><span id="l3.119"> </span>
<a href="#l3.120"></a><span id="l3.120">     // Escape occurrences of message ID meta characters &lt;, &gt;, and @.</span>
<a href="#l3.121"></a><span id="l3.121">     messageID.replace(/&lt;/g, &quot;%3C&quot;);</span>
<a href="#l3.122"></a><span id="l3.122">     messageID.replace(/&gt;/g, &quot;%3E&quot;);</span>
<a href="#l3.123"></a><span id="l3.123">     messageID.replace(/@/g, &quot;%40&quot;);</span>
<a href="#l3.124"></a><span id="l3.124">     messageID = messageID + &quot;@&quot; + &quot;localhost.localdomain&quot;;</span>
<a href="#l3.125"></a><span id="l3.125" class="difflineplus">+</span>
<a href="#l3.126"></a><span id="l3.126" class="difflineplus">+    FeedUtils.log.trace(&quot;FeedItem.messageID: messageID - &quot; + messageID);</span>
<a href="#l3.127"></a><span id="l3.127">     return messageID;</span>
<a href="#l3.128"></a><span id="l3.128">   },</span>
<a href="#l3.129"></a><span id="l3.129"> </span>
<a href="#l3.130"></a><span id="l3.130">   get itemUniqueURI()</span>
<a href="#l3.131"></a><span id="l3.131">   {</span>
<a href="#l3.132"></a><span id="l3.132" class="difflineminus">-    return (this.isStoredWithId &amp;&amp; this.id) ? createURN(this.id) :</span>
<a href="#l3.133"></a><span id="l3.133" class="difflineminus">-           createURN(this.mURL || this.id);</span>
<a href="#l3.134"></a><span id="l3.134" class="difflineplus">+    return this.isStoredWithId &amp;&amp; this.id ? this.createURN(this.id) :</span>
<a href="#l3.135"></a><span id="l3.135" class="difflineplus">+                                            this.createURN(this.mURL || this.id);</span>
<a href="#l3.136"></a><span id="l3.136">   },</span>
<a href="#l3.137"></a><span id="l3.137"> </span>
<a href="#l3.138"></a><span id="l3.138">   get contentBase()</span>
<a href="#l3.139"></a><span id="l3.139">   {</span>
<a href="#l3.140"></a><span id="l3.140">     if(this.xmlContentBase)</span>
<a href="#l3.141"></a><span id="l3.141">       return this.xmlContentBase</span>
<a href="#l3.142"></a><span id="l3.142">     else</span>
<a href="#l3.143"></a><span id="l3.143">       return this.mURL;</span>
<a href="#l3.144"></a><span id="l3.144">   },</span>
<a href="#l3.145"></a><span id="l3.145"> </span>
<a href="#l3.146"></a><span id="l3.146">   store: function()</span>
<a href="#l3.147"></a><span id="l3.147">   {</span>
<a href="#l3.148"></a><span id="l3.148">     this.mUnicodeConverter.charset = this.characterSet;</span>
<a href="#l3.149"></a><span id="l3.149"> </span>
<a href="#l3.150"></a><span id="l3.150" class="difflineminus">-    // this.title and this.content contain HTML</span>
<a href="#l3.151"></a><span id="l3.151" class="difflineminus">-    // this.mUrl and this.contentBase contain plain text</span>
<a href="#l3.152"></a><span id="l3.152" class="difflineplus">+    // this.title and this.content contain HTML.</span>
<a href="#l3.153"></a><span id="l3.153" class="difflineplus">+    // this.mUrl and this.contentBase contain plain text.</span>
<a href="#l3.154"></a><span id="l3.154"> </span>
<a href="#l3.155"></a><span id="l3.155">     let resource = this.findStoredResource();</span>
<a href="#l3.156"></a><span id="l3.156">     if (resource == null)</span>
<a href="#l3.157"></a><span id="l3.157">     {</span>
<a href="#l3.158"></a><span id="l3.158" class="difflineminus">-      resource = rdf.GetResource(this.itemUniqueURI);</span>
<a href="#l3.159"></a><span id="l3.159" class="difflineplus">+      resource = FeedUtils.rdf.GetResource(this.itemUniqueURI);</span>
<a href="#l3.160"></a><span id="l3.160">       if (!this.content)</span>
<a href="#l3.161"></a><span id="l3.161">       {</span>
<a href="#l3.162"></a><span id="l3.162" class="difflineminus">-        debug(this.identity + &quot; no content; storing&quot;);</span>
<a href="#l3.163"></a><span id="l3.163" class="difflineplus">+        FeedUtils.log.trace(&quot;FeedItem.store: &quot; + this.identity +</span>
<a href="#l3.164"></a><span id="l3.164" class="difflineplus">+                            &quot; no content; storing&quot;);</span>
<a href="#l3.165"></a><span id="l3.165">         this.content = this.description || this.title;</span>
<a href="#l3.166"></a><span id="l3.166">       }</span>
<a href="#l3.167"></a><span id="l3.167"> </span>
<a href="#l3.168"></a><span id="l3.168" class="difflineminus">-      debug(this.identity + &quot; store both remote/no content and content items&quot;);</span>
<a href="#l3.169"></a><span id="l3.169" class="difflineminus">-      var content = MESSAGE_TEMPLATE;</span>
<a href="#l3.170"></a><span id="l3.170" class="difflineplus">+      FeedUtils.log.trace(&quot;FeedItem.store: &quot; + this.identity +</span>
<a href="#l3.171"></a><span id="l3.171" class="difflineplus">+                          &quot; store both remote/no content and content items&quot;);</span>
<a href="#l3.172"></a><span id="l3.172" class="difflineplus">+      let content = this.MESSAGE_TEMPLATE;</span>
<a href="#l3.173"></a><span id="l3.173">       content = content.replace(/%TITLE%/, this.title);</span>
<a href="#l3.174"></a><span id="l3.174" class="difflineminus">-      content = content.replace(/%BASE%/, htmlEscape(this.contentBase));</span>
<a href="#l3.175"></a><span id="l3.175" class="difflineplus">+      content = content.replace(/%BASE%/, this.htmlEscape(this.contentBase));</span>
<a href="#l3.176"></a><span id="l3.176">       content = content.replace(/%CONTENT%/, this.content);</span>
<a href="#l3.177"></a><span id="l3.177" class="difflineminus">-      // XXX store it elsewhere, f.e. this.page</span>
<a href="#l3.178"></a><span id="l3.178" class="difflineplus">+      // XXX store it elsewhere, f.e. this.page.</span>
<a href="#l3.179"></a><span id="l3.179">       this.content = content;</span>
<a href="#l3.180"></a><span id="l3.180">       this.writeToFolder();</span>
<a href="#l3.181"></a><span id="l3.181">       this.markStored(resource);</span>
<a href="#l3.182"></a><span id="l3.182">     }</span>
<a href="#l3.183"></a><span id="l3.183">     this.markValid(resource);</span>
<a href="#l3.184"></a><span id="l3.184">   },</span>
<a href="#l3.185"></a><span id="l3.185"> </span>
<a href="#l3.186"></a><span id="l3.186">   findStoredResource: function()</span>
<a href="#l3.187"></a><span id="l3.187">   {</span>
<a href="#l3.188"></a><span id="l3.188" class="difflineminus">-    // Checks to see if the item has already been stored in its feed's message folder.</span>
<a href="#l3.189"></a><span id="l3.189" class="difflineplus">+    // Checks to see if the item has already been stored in its feed's</span>
<a href="#l3.190"></a><span id="l3.190" class="difflineplus">+    // message folder.</span>
<a href="#l3.191"></a><span id="l3.191" class="difflineplus">+    FeedUtils.log.trace(&quot;FeedItem.findStoredResource: &quot; + this.identity +</span>
<a href="#l3.192"></a><span id="l3.192" class="difflineplus">+                        &quot; checking to see if stored&quot;);</span>
<a href="#l3.193"></a><span id="l3.193"> </span>
<a href="#l3.194"></a><span id="l3.194" class="difflineminus">-    debug(this.identity + &quot; checking to see if stored&quot;);</span>
<a href="#l3.195"></a><span id="l3.195" class="difflineminus">-</span>
<a href="#l3.196"></a><span id="l3.196" class="difflineminus">-    var server = this.feed.server;</span>
<a href="#l3.197"></a><span id="l3.197" class="difflineminus">-    var folder = this.feed.folder;</span>
<a href="#l3.198"></a><span id="l3.198" class="difflineplus">+    let server = this.feed.server;</span>
<a href="#l3.199"></a><span id="l3.199" class="difflineplus">+    let folder = this.feed.folder;</span>
<a href="#l3.200"></a><span id="l3.200"> </span>
<a href="#l3.201"></a><span id="l3.201">     if (!folder)</span>
<a href="#l3.202"></a><span id="l3.202">     {</span>
<a href="#l3.203"></a><span id="l3.203" class="difflineminus">-      debug(this.feed.name + &quot; folder doesn't exist; creating&quot;);</span>
<a href="#l3.204"></a><span id="l3.204" class="difflineminus">-      debug(&quot;creating &quot; + this.feed.name + &quot;as child of &quot; +</span>
<a href="#l3.205"></a><span id="l3.205" class="difflineminus">-          server.rootMsgFolder + &quot;\n&quot;);</span>
<a href="#l3.206"></a><span id="l3.206" class="difflineminus">-      server.rootMsgFolder.createSubfolder(this.feed.name, null /* supposed to be a msg window */);</span>
<a href="#l3.207"></a><span id="l3.207" class="difflineplus">+      FeedUtils.log.debug(&quot;FeedItem.findStoredResource: &quot; + this.feed.name +</span>
<a href="#l3.208"></a><span id="l3.208" class="difflineplus">+                          &quot; folder doesn't exist; creating as child of &quot; +</span>
<a href="#l3.209"></a><span id="l3.209" class="difflineplus">+                          server.rootMsgFolder.prettyName + &quot;\n&quot;);</span>
<a href="#l3.210"></a><span id="l3.210" class="difflineplus">+      server.rootMsgFolder.createSubfolder(this.feed.name, null);</span>
<a href="#l3.211"></a><span id="l3.211">       folder = server.rootMsgFolder.findSubFolder(this.feed.name);</span>
<a href="#l3.212"></a><span id="l3.212" class="difflineminus">-      debug(this.identity + &quot; not stored (folder didn't exist)&quot;);</span>
<a href="#l3.213"></a><span id="l3.213" class="difflineplus">+      FeedUtils.log.debug(&quot;FeedItem.findStoredResource: &quot; + this.identity +</span>
<a href="#l3.214"></a><span id="l3.214" class="difflineplus">+                          &quot; not stored (folder didn't exist)&quot;);</span>
<a href="#l3.215"></a><span id="l3.215">       return null;</span>
<a href="#l3.216"></a><span id="l3.216">     }</span>
<a href="#l3.217"></a><span id="l3.217"> </span>
<a href="#l3.218"></a><span id="l3.218" class="difflineminus">-    var ds = getItemsDS(server);</span>
<a href="#l3.219"></a><span id="l3.219" class="difflineminus">-    var itemURI = this.itemUniqueURI;</span>
<a href="#l3.220"></a><span id="l3.220" class="difflineminus">-    var itemResource = rdf.GetResource(itemURI);</span>
<a href="#l3.221"></a><span id="l3.221" class="difflineplus">+    let ds = FeedUtils.getItemsDS(server);</span>
<a href="#l3.222"></a><span id="l3.222" class="difflineplus">+    let itemURI = this.itemUniqueURI;</span>
<a href="#l3.223"></a><span id="l3.223" class="difflineplus">+    let itemResource = FeedUtils.rdf.GetResource(itemURI);</span>
<a href="#l3.224"></a><span id="l3.224"> </span>
<a href="#l3.225"></a><span id="l3.225" class="difflineminus">-    var downloaded = ds.GetTarget(itemResource, FZ_STORED, true);</span>
<a href="#l3.226"></a><span id="l3.226" class="difflineplus">+    let downloaded = ds.GetTarget(itemResource, FeedUtils.FZ_STORED, true);</span>
<a href="#l3.227"></a><span id="l3.227"> </span>
<a href="#l3.228"></a><span id="l3.228">     // Backward compatibility: we might have stored this item before</span>
<a href="#l3.229"></a><span id="l3.229">     // isStoredWithId has been turned on for RSS 2.0 (bug 354345).</span>
<a href="#l3.230"></a><span id="l3.230">     // Check whether this item has been stored with its URL.</span>
<a href="#l3.231"></a><span id="l3.231">     if (!downloaded &amp;&amp; this.mURL &amp;&amp; itemURI != this.mURL)</span>
<a href="#l3.232"></a><span id="l3.232">     {</span>
<a href="#l3.233"></a><span id="l3.233" class="difflineminus">-      itemResource = rdf.GetResource(this.mURL);</span>
<a href="#l3.234"></a><span id="l3.234" class="difflineminus">-      downloaded = ds.GetTarget(itemResource, FZ_STORED, true);</span>
<a href="#l3.235"></a><span id="l3.235" class="difflineplus">+      itemResource = FeedUtils.rdf.GetResource(this.mURL);</span>
<a href="#l3.236"></a><span id="l3.236" class="difflineplus">+      downloaded = ds.GetTarget(itemResource, FeedUtils.FZ_STORED, true);</span>
<a href="#l3.237"></a><span id="l3.237">     }</span>
<a href="#l3.238"></a><span id="l3.238"> </span>
<a href="#l3.239"></a><span id="l3.239">     // Backward compatibility: the item may have been stored</span>
<a href="#l3.240"></a><span id="l3.240">     // using the previous unique URI algorithm.</span>
<a href="#l3.241"></a><span id="l3.241">     // (bug 410842 &amp; bug 461109)</span>
<a href="#l3.242"></a><span id="l3.242">     if (!downloaded)</span>
<a href="#l3.243"></a><span id="l3.243">     {</span>
<a href="#l3.244"></a><span id="l3.244" class="difflineminus">-      itemResource = rdf.GetResource((this.isStoredWithId &amp;&amp; this.id) ?</span>
<a href="#l3.245"></a><span id="l3.245" class="difflineminus">-                                     (&quot;urn:&quot; + this.id) :</span>
<a href="#l3.246"></a><span id="l3.246" class="difflineminus">-                                     (this.mURL || (&quot;urn:&quot; + this.id)));</span>
<a href="#l3.247"></a><span id="l3.247" class="difflineminus">-      downloaded = ds.GetTarget(itemResource, FZ_STORED, true);</span>
<a href="#l3.248"></a><span id="l3.248" class="difflineplus">+      itemResource = FeedUtils.rdf.GetResource((this.isStoredWithId &amp;&amp; this.id) ?</span>
<a href="#l3.249"></a><span id="l3.249" class="difflineplus">+                                               (&quot;urn:&quot; + this.id) :</span>
<a href="#l3.250"></a><span id="l3.250" class="difflineplus">+                                               (this.mURL || (&quot;urn:&quot; + this.id)));</span>
<a href="#l3.251"></a><span id="l3.251" class="difflineplus">+      downloaded = ds.GetTarget(itemResource, FeedUtils.FZ_STORED, true);</span>
<a href="#l3.252"></a><span id="l3.252">     }</span>
<a href="#l3.253"></a><span id="l3.253"> </span>
<a href="#l3.254"></a><span id="l3.254">     if (!downloaded ||</span>
<a href="#l3.255"></a><span id="l3.255" class="difflineminus">-        downloaded.QueryInterface(Components.interfaces.nsIRDFLiteral)</span>
<a href="#l3.256"></a><span id="l3.256" class="difflineminus">-                  .Value == &quot;false&quot;)</span>
<a href="#l3.257"></a><span id="l3.257" class="difflineplus">+        downloaded.QueryInterface(Ci.nsIRDFLiteral).Value == &quot;false&quot;)</span>
<a href="#l3.258"></a><span id="l3.258">     {</span>
<a href="#l3.259"></a><span id="l3.259">       // HACK ALERT: before we give up, try to work around an entity</span>
<a href="#l3.260"></a><span id="l3.260" class="difflineminus">-      // escaping bug in RDF. See Bug #258465 for more details</span>
<a href="#l3.261"></a><span id="l3.261" class="difflineplus">+      // escaping bug in RDF. See Bug #258465 for more details.</span>
<a href="#l3.262"></a><span id="l3.262">       itemURI = itemURI.replace(/&amp;lt;/g, '&lt;');</span>
<a href="#l3.263"></a><span id="l3.263">       itemURI = itemURI.replace(/&amp;gt;/g, '&gt;');</span>
<a href="#l3.264"></a><span id="l3.264">       itemURI = itemURI.replace(/&amp;quot;/g, '&quot;');</span>
<a href="#l3.265"></a><span id="l3.265">       itemURI = itemURI.replace(/&amp;amp;/g, '&amp;');</span>
<a href="#l3.266"></a><span id="l3.266"> </span>
<a href="#l3.267"></a><span id="l3.267" class="difflineminus">-      debug('Failed to find item, trying entity replacement version: '  + itemURI);</span>
<a href="#l3.268"></a><span id="l3.268" class="difflineminus">-      itemResource = rdf.GetResource(itemURI);</span>
<a href="#l3.269"></a><span id="l3.269" class="difflineminus">-      downloaded = ds.GetTarget(itemResource, FZ_STORED, true);</span>
<a href="#l3.270"></a><span id="l3.270" class="difflineplus">+      FeedUtils.log.trace(&quot;FeedItem.findStoredResource: failed to find item,&quot; +</span>
<a href="#l3.271"></a><span id="l3.271" class="difflineplus">+                          &quot; trying entity replacement version - &quot; + itemURI);</span>
<a href="#l3.272"></a><span id="l3.272" class="difflineplus">+      itemResource = FeedUtils.rdf.GetResource(itemURI);</span>
<a href="#l3.273"></a><span id="l3.273" class="difflineplus">+      downloaded = ds.GetTarget(itemResource, FeedUtils.FZ_STORED, true);</span>
<a href="#l3.274"></a><span id="l3.274"> </span>
<a href="#l3.275"></a><span id="l3.275">       if (downloaded)</span>
<a href="#l3.276"></a><span id="l3.276">       {</span>
<a href="#l3.277"></a><span id="l3.277" class="difflineminus">-        debug(this.identity + &quot; stored&quot;);</span>
<a href="#l3.278"></a><span id="l3.278" class="difflineplus">+        FeedUtils.log.trace(&quot;FeedItem.findStoredResource: &quot; + this.identity +</span>
<a href="#l3.279"></a><span id="l3.279" class="difflineplus">+                            &quot; stored&quot;);</span>
<a href="#l3.280"></a><span id="l3.280">         return itemResource;</span>
<a href="#l3.281"></a><span id="l3.281">       }</span>
<a href="#l3.282"></a><span id="l3.282"> </span>
<a href="#l3.283"></a><span id="l3.283" class="difflineminus">-      debug(this.identity + &quot; not stored&quot;);</span>
<a href="#l3.284"></a><span id="l3.284" class="difflineplus">+      FeedUtils.log.trace(&quot;FeedItem.findStoredResource: &quot; + this.identity +</span>
<a href="#l3.285"></a><span id="l3.285" class="difflineplus">+                          &quot; not stored&quot;);</span>
<a href="#l3.286"></a><span id="l3.286">       return null;</span>
<a href="#l3.287"></a><span id="l3.287">     }</span>
<a href="#l3.288"></a><span id="l3.288">     else</span>
<a href="#l3.289"></a><span id="l3.289">     {</span>
<a href="#l3.290"></a><span id="l3.290" class="difflineminus">-      debug(this.identity + &quot; stored&quot;);</span>
<a href="#l3.291"></a><span id="l3.291" class="difflineplus">+      FeedUtils.log.trace(&quot;FeedItem.findStoredResource: &quot; + this.identity +</span>
<a href="#l3.292"></a><span id="l3.292" class="difflineplus">+                          &quot; stored&quot;);</span>
<a href="#l3.293"></a><span id="l3.293">       return itemResource;</span>
<a href="#l3.294"></a><span id="l3.294">     }</span>
<a href="#l3.295"></a><span id="l3.295">   },</span>
<a href="#l3.296"></a><span id="l3.296"> </span>
<a href="#l3.297"></a><span id="l3.297">   markValid: function(resource)</span>
<a href="#l3.298"></a><span id="l3.298">   {</span>
<a href="#l3.299"></a><span id="l3.299" class="difflineminus">-    var ds = getItemsDS(this.feed.server);</span>
<a href="#l3.300"></a><span id="l3.300" class="difflineplus">+    let ds = FeedUtils.getItemsDS(this.feed.server);</span>
<a href="#l3.301"></a><span id="l3.301"> </span>
<a href="#l3.302"></a><span id="l3.302" class="difflineminus">-    var newTimeStamp = rdf.GetLiteral(new Date().getTime());</span>
<a href="#l3.303"></a><span id="l3.303" class="difflineminus">-    var currentTimeStamp = ds.GetTarget(resource, FZ_LAST_SEEN_TIMESTAMP, true);</span>
<a href="#l3.304"></a><span id="l3.304" class="difflineplus">+    let newTimeStamp = FeedUtils.rdf.GetLiteral(new Date().getTime());</span>
<a href="#l3.305"></a><span id="l3.305" class="difflineplus">+    let currentTimeStamp = ds.GetTarget(resource,</span>
<a href="#l3.306"></a><span id="l3.306" class="difflineplus">+                                        FeedUtils.FZ_LAST_SEEN_TIMESTAMP,</span>
<a href="#l3.307"></a><span id="l3.307" class="difflineplus">+                                        true);</span>
<a href="#l3.308"></a><span id="l3.308">     if (currentTimeStamp)</span>
<a href="#l3.309"></a><span id="l3.309" class="difflineminus">-      ds.Change(resource, FZ_LAST_SEEN_TIMESTAMP, currentTimeStamp, newTimeStamp);</span>
<a href="#l3.310"></a><span id="l3.310" class="difflineplus">+      ds.Change(resource, FeedUtils.FZ_LAST_SEEN_TIMESTAMP,</span>
<a href="#l3.311"></a><span id="l3.311" class="difflineplus">+                currentTimeStamp, newTimeStamp);</span>
<a href="#l3.312"></a><span id="l3.312">     else</span>
<a href="#l3.313"></a><span id="l3.313" class="difflineminus">-      ds.Assert(resource, FZ_LAST_SEEN_TIMESTAMP, newTimeStamp, true);</span>
<a href="#l3.314"></a><span id="l3.314" class="difflineminus">-</span>
<a href="#l3.315"></a><span id="l3.315" class="difflineminus">-    if (!ds.HasAssertion(resource, FZ_FEED, rdf.GetResource(this.feed.url), true))</span>
<a href="#l3.316"></a><span id="l3.316" class="difflineminus">-      ds.Assert(resource, FZ_FEED, rdf.GetResource(this.feed.url), true);</span>
<a href="#l3.317"></a><span id="l3.317" class="difflineplus">+      ds.Assert(resource, FeedUtils.FZ_LAST_SEEN_TIMESTAMP,</span>
<a href="#l3.318"></a><span id="l3.318" class="difflineplus">+                newTimeStamp, true);</span>
<a href="#l3.319"></a><span id="l3.319"> </span>
<a href="#l3.320"></a><span id="l3.320" class="difflineminus">-    if (ds.hasArcOut(resource, FZ_VALID))</span>
<a href="#l3.321"></a><span id="l3.321" class="difflineplus">+    if (!ds.HasAssertion(resource, FeedUtils.FZ_FEED,</span>
<a href="#l3.322"></a><span id="l3.322" class="difflineplus">+                         FeedUtils.rdf.GetResource(this.feed.url), true))</span>
<a href="#l3.323"></a><span id="l3.323" class="difflineplus">+      ds.Assert(resource, FeedUtils.FZ_FEED,</span>
<a href="#l3.324"></a><span id="l3.324" class="difflineplus">+                FeedUtils.rdf.GetResource(this.feed.url), true);</span>
<a href="#l3.325"></a><span id="l3.325" class="difflineplus">+</span>
<a href="#l3.326"></a><span id="l3.326" class="difflineplus">+    if (ds.hasArcOut(resource, FeedUtils.FZ_VALID))</span>
<a href="#l3.327"></a><span id="l3.327">     {</span>
<a href="#l3.328"></a><span id="l3.328" class="difflineminus">-      var currentValue = ds.GetTarget(resource, FZ_VALID, true);</span>
<a href="#l3.329"></a><span id="l3.329" class="difflineminus">-      ds.Change(resource, FZ_VALID, currentValue, RDF_LITERAL_TRUE);</span>
<a href="#l3.330"></a><span id="l3.330" class="difflineplus">+      let currentValue = ds.GetTarget(resource, FeedUtils.FZ_VALID, true);</span>
<a href="#l3.331"></a><span id="l3.331" class="difflineplus">+      ds.Change(resource, FeedUtils.FZ_VALID,</span>
<a href="#l3.332"></a><span id="l3.332" class="difflineplus">+                currentValue, FeedUtils.RDF_LITERAL_TRUE);</span>
<a href="#l3.333"></a><span id="l3.333">     }</span>
<a href="#l3.334"></a><span id="l3.334">     else</span>
<a href="#l3.335"></a><span id="l3.335" class="difflineminus">-      ds.Assert(resource, FZ_VALID, RDF_LITERAL_TRUE, true);</span>
<a href="#l3.336"></a><span id="l3.336" class="difflineplus">+      ds.Assert(resource, FeedUtils.FZ_VALID, FeedUtils.RDF_LITERAL_TRUE, true);</span>
<a href="#l3.337"></a><span id="l3.337">   },</span>
<a href="#l3.338"></a><span id="l3.338"> </span>
<a href="#l3.339"></a><span id="l3.339">   markStored: function(resource)</span>
<a href="#l3.340"></a><span id="l3.340">   {</span>
<a href="#l3.341"></a><span id="l3.341" class="difflineminus">-    var ds = getItemsDS(this.feed.server);</span>
<a href="#l3.342"></a><span id="l3.342" class="difflineplus">+    let ds = FeedUtils.getItemsDS(this.feed.server);</span>
<a href="#l3.343"></a><span id="l3.343"> </span>
<a href="#l3.344"></a><span id="l3.344" class="difflineminus">-    if (!ds.HasAssertion(resource, FZ_FEED, rdf.GetResource(this.feed.url), true))</span>
<a href="#l3.345"></a><span id="l3.345" class="difflineminus">-      ds.Assert(resource, FZ_FEED, rdf.GetResource(this.feed.url), true);</span>
<a href="#l3.346"></a><span id="l3.346" class="difflineplus">+    if (!ds.HasAssertion(resource, FeedUtils.FZ_FEED,</span>
<a href="#l3.347"></a><span id="l3.347" class="difflineplus">+                         FeedUtils.rdf.GetResource(this.feed.url), true))</span>
<a href="#l3.348"></a><span id="l3.348" class="difflineplus">+      ds.Assert(resource, FeedUtils.FZ_FEED,</span>
<a href="#l3.349"></a><span id="l3.349" class="difflineplus">+                FeedUtils.rdf.GetResource(this.feed.url), true);</span>
<a href="#l3.350"></a><span id="l3.350"> </span>
<a href="#l3.351"></a><span id="l3.351" class="difflineminus">-    var currentValue;</span>
<a href="#l3.352"></a><span id="l3.352" class="difflineminus">-    if (ds.hasArcOut(resource, FZ_STORED))</span>
<a href="#l3.353"></a><span id="l3.353" class="difflineplus">+    let currentValue;</span>
<a href="#l3.354"></a><span id="l3.354" class="difflineplus">+    if (ds.hasArcOut(resource, FeedUtils.FZ_STORED))</span>
<a href="#l3.355"></a><span id="l3.355">     {</span>
<a href="#l3.356"></a><span id="l3.356" class="difflineminus">-      currentValue = ds.GetTarget(resource, FZ_STORED, true);</span>
<a href="#l3.357"></a><span id="l3.357" class="difflineminus">-      ds.Change(resource, FZ_STORED, currentValue, RDF_LITERAL_TRUE);</span>
<a href="#l3.358"></a><span id="l3.358" class="difflineplus">+      currentValue = ds.GetTarget(resource, FeedUtils.FZ_STORED, true);</span>
<a href="#l3.359"></a><span id="l3.359" class="difflineplus">+      ds.Change(resource, FeedUtils.FZ_STORED, </span>
<a href="#l3.360"></a><span id="l3.360" class="difflineplus">+                currentValue, FeedUtils.RDF_LITERAL_TRUE);</span>
<a href="#l3.361"></a><span id="l3.361">     }</span>
<a href="#l3.362"></a><span id="l3.362">     else</span>
<a href="#l3.363"></a><span id="l3.363" class="difflineminus">-      ds.Assert(resource, FZ_STORED, RDF_LITERAL_TRUE, true);</span>
<a href="#l3.364"></a><span id="l3.364" class="difflineplus">+      ds.Assert(resource, FeedUtils.FZ_STORED,</span>
<a href="#l3.365"></a><span id="l3.365" class="difflineplus">+                FeedUtils.RDF_LITERAL_TRUE, true);</span>
<a href="#l3.366"></a><span id="l3.366">   },</span>
<a href="#l3.367"></a><span id="l3.367"> </span>
<a href="#l3.368"></a><span id="l3.368">   mimeEncodeSubject: function(aSubject, aCharset)</span>
<a href="#l3.369"></a><span id="l3.369">   {</span>
<a href="#l3.370"></a><span id="l3.370" class="difflineminus">-    // Get the mime header encoder service</span>
<a href="#l3.371"></a><span id="l3.371" class="difflineminus">-    var mimeEncoder = Components.classes[&quot;@mozilla.org/messenger/mimeconverter;1&quot;]</span>
<a href="#l3.372"></a><span id="l3.372" class="difflineminus">-                                .getService(Components.interfaces.nsIMimeConverter);</span>
<a href="#l3.373"></a><span id="l3.373" class="difflineminus">-</span>
<a href="#l3.374"></a><span id="l3.374">     // This routine sometimes throws exceptions for mis-encoded data so</span>
<a href="#l3.375"></a><span id="l3.375" class="difflineminus">-    // wrap it with a try catch for now..</span>
<a href="#l3.376"></a><span id="l3.376" class="difflineminus">-    var newSubject;</span>
<a href="#l3.377"></a><span id="l3.377" class="difflineplus">+    // wrap it with a try catch for now.</span>
<a href="#l3.378"></a><span id="l3.378" class="difflineplus">+    let newSubject;</span>
<a href="#l3.379"></a><span id="l3.379">     try</span>
<a href="#l3.380"></a><span id="l3.380">     {</span>
<a href="#l3.381"></a><span id="l3.381" class="difflineminus">-      newSubject = mimeEncoder.encodeMimePartIIStr(</span>
<a href="#l3.382"></a><span id="l3.382" class="difflineminus">-          this.mUnicodeConverter.ConvertFromUnicode(aSubject),</span>
<a href="#l3.383"></a><span id="l3.383" class="difflineminus">-          false, aCharset, 9, 72);</span>
<a href="#l3.384"></a><span id="l3.384" class="difflineplus">+      newSubject = mailServices.mimeConverter.encodeMimePartIIStr(</span>
<a href="#l3.385"></a><span id="l3.385" class="difflineplus">+                     this.mUnicodeConverter.ConvertFromUnicode(aSubject),</span>
<a href="#l3.386"></a><span id="l3.386" class="difflineplus">+                     false,</span>
<a href="#l3.387"></a><span id="l3.387" class="difflineplus">+                     aCharset, 9, 72);</span>
<a href="#l3.388"></a><span id="l3.388">     }</span>
<a href="#l3.389"></a><span id="l3.389">     catch (ex)</span>
<a href="#l3.390"></a><span id="l3.390">     {</span>
<a href="#l3.391"></a><span id="l3.391">       newSubject = aSubject;</span>
<a href="#l3.392"></a><span id="l3.392">     }</span>
<a href="#l3.393"></a><span id="l3.393"> </span>
<a href="#l3.394"></a><span id="l3.394">     return newSubject;</span>
<a href="#l3.395"></a><span id="l3.395">   },</span>
<a href="#l3.396"></a><span id="l3.396"> </span>
<a href="#l3.397"></a><span id="l3.397">   writeToFolder: function()</span>
<a href="#l3.398"></a><span id="l3.398">   {</span>
<a href="#l3.399"></a><span id="l3.399" class="difflineminus">-    debug(this.identity + &quot; writing to message folder&quot; + this.feed.name + &quot;\n&quot;);</span>
<a href="#l3.400"></a><span id="l3.400" class="difflineminus">-</span>
<a href="#l3.401"></a><span id="l3.401" class="difflineminus">-    var server = this.feed.server;</span>
<a href="#l3.402"></a><span id="l3.402" class="difflineplus">+    FeedUtils.log.trace(&quot;FeedItem.writeToFolder: &quot; + this.identity +</span>
<a href="#l3.403"></a><span id="l3.403" class="difflineplus">+                        &quot; writing to message folder &quot; + this.feed.name);</span>
<a href="#l3.404"></a><span id="l3.404">     this.mUnicodeConverter.charset = this.characterSet;</span>
<a href="#l3.405"></a><span id="l3.405"> </span>
<a href="#l3.406"></a><span id="l3.406">     // If the sender isn't a valid email address, quote it so it looks nicer.</span>
<a href="#l3.407"></a><span id="l3.407" class="difflineminus">-    if (this.author &amp;&amp; this.author.indexOf('@') == -1)</span>
<a href="#l3.408"></a><span id="l3.408" class="difflineminus">-      this.author = '&lt;' + this.author + '&gt;';</span>
<a href="#l3.409"></a><span id="l3.409" class="difflineplus">+    if (this.author &amp;&amp; this.author.indexOf(&quot;@&quot;) == -1)</span>
<a href="#l3.410"></a><span id="l3.410" class="difflineplus">+      this.author = &quot;&lt;&quot; + this.author + &quot;&gt;&quot;;</span>
<a href="#l3.411"></a><span id="l3.411"> </span>
<a href="#l3.412"></a><span id="l3.412">     // Convert the title to UTF-16 before performing our HTML entity</span>
<a href="#l3.413"></a><span id="l3.413">     // replacement reg expressions.</span>
<a href="#l3.414"></a><span id="l3.414" class="difflineminus">-    var title = this.title;</span>
<a href="#l3.415"></a><span id="l3.415" class="difflineplus">+    let title = this.title;</span>
<a href="#l3.416"></a><span id="l3.416"> </span>
<a href="#l3.417"></a><span id="l3.417" class="difflineminus">-    // the subject may contain HTML entities.</span>
<a href="#l3.418"></a><span id="l3.418" class="difflineminus">-    // Convert these to their unencoded state. i.e. &amp;amp; becomes '&amp;'</span>
<a href="#l3.419"></a><span id="l3.419" class="difflineminus">-    title = Components.classes[&quot;@mozilla.org/feed-unescapehtml;1&quot;]</span>
<a href="#l3.420"></a><span id="l3.420" class="difflineminus">-                      .getService(Components.interfaces.nsIScriptableUnescapeHTML)</span>
<a href="#l3.421"></a><span id="l3.421" class="difflineminus">-                      .unescape(title);</span>
<a href="#l3.422"></a><span id="l3.422" class="difflineplus">+    // The subject may contain HTML entities.  Convert these to their unencoded</span>
<a href="#l3.423"></a><span id="l3.423" class="difflineplus">+    // state. i.e. &amp;amp; becomes '&amp;'.</span>
<a href="#l3.424"></a><span id="l3.424" class="difflineplus">+    title = this.mUnescapeHTML.unescape(title);</span>
<a href="#l3.425"></a><span id="l3.425"> </span>
<a href="#l3.426"></a><span id="l3.426">     // Compress white space in the subject to make it look better.  Trim</span>
<a href="#l3.427"></a><span id="l3.427">     // leading/trailing spaces to prevent mbox header folding issue at just</span>
<a href="#l3.428"></a><span id="l3.428">     // the right subject length.</span>
<a href="#l3.429"></a><span id="l3.429">     title = title.replace(/[\t\r\n]+/g, &quot; &quot;).trim();</span>
<a href="#l3.430"></a><span id="l3.430"> </span>
<a href="#l3.431"></a><span id="l3.431">     this.title = this.mimeEncodeSubject(title, this.characterSet);</span>
<a href="#l3.432"></a><span id="l3.432"> </span>
<a href="#l3.433"></a><span id="l3.433" class="difflineat">@@ -359,107 +364,134 @@ FeedItem.prototype =</span>
<a href="#l3.434"></a><span id="l3.434">     this.content += &quot;\n&quot;;</span>
<a href="#l3.435"></a><span id="l3.435"> </span>
<a href="#l3.436"></a><span id="l3.436">     // The opening line of the message, mandated by standards to start</span>
<a href="#l3.437"></a><span id="l3.437">     // with &quot;From &quot;.  It's useful to construct this separately because</span>
<a href="#l3.438"></a><span id="l3.438">     // we not only need to write it into the message, we also need to</span>
<a href="#l3.439"></a><span id="l3.439">     // use it to calculate the offset of the X-Mozilla-Status lines from</span>
<a href="#l3.440"></a><span id="l3.440">     // the front of the message for the statusOffset property of the</span>
<a href="#l3.441"></a><span id="l3.441">     // DB header object.</span>
<a href="#l3.442"></a><span id="l3.442" class="difflineminus">-    var openingLine = 'From - ' + this.mDate + '\n';</span>
<a href="#l3.443"></a><span id="l3.443" class="difflineplus">+    let openingLine = 'From - ' + this.mDate + '\n';</span>
<a href="#l3.444"></a><span id="l3.444"> </span>
<a href="#l3.445"></a><span id="l3.445" class="difflineminus">-    var source =</span>
<a href="#l3.446"></a><span id="l3.446" class="difflineplus">+    let source =</span>
<a href="#l3.447"></a><span id="l3.447">       openingLine +</span>
<a href="#l3.448"></a><span id="l3.448">       'X-Mozilla-Status: 0000\n' +</span>
<a href="#l3.449"></a><span id="l3.449">       'X-Mozilla-Status2: 00000000\n' +</span>
<a href="#l3.450"></a><span id="l3.450">       'X-Mozilla-Keys:                                                                                \n' +</span>
<a href="#l3.451"></a><span id="l3.451">       'Date: ' + this.mDate + '\n' +</span>
<a href="#l3.452"></a><span id="l3.452">       'Message-Id: &lt;' + this.messageID + '&gt;\n' +</span>
<a href="#l3.453"></a><span id="l3.453">       'From: ' + this.author + '\n' +</span>
<a href="#l3.454"></a><span id="l3.454">       'MIME-Version: 1.0\n' +</span>
<a href="#l3.455"></a><span id="l3.455">       'Subject: ' + this.title + '\n' +</span>
<a href="#l3.456"></a><span id="l3.456">       'Content-Transfer-Encoding: 8bit\n' +</span>
<a href="#l3.457"></a><span id="l3.457">       'Content-Base: ' + this.mURL + '\n';</span>
<a href="#l3.458"></a><span id="l3.458"> </span>
<a href="#l3.459"></a><span id="l3.459">     if (this.enclosure &amp;&amp; this.enclosure.mFileName)</span>
<a href="#l3.460"></a><span id="l3.460">     {</span>
<a href="#l3.461"></a><span id="l3.461" class="difflineminus">-      var boundaryID = source.length + this.enclosure.mLength;</span>
<a href="#l3.462"></a><span id="l3.462" class="difflineminus">-      source += 'Content-Type: multipart/mixed;\n boundary=&quot;' + ENCLOSURE_HEADER_BOUNDARY_PREFIX + boundaryID + '&quot;' + '\n\n' +</span>
<a href="#l3.463"></a><span id="l3.463" class="difflineminus">-                'This is a multi-part message in MIME format.\n' + ENCLOSURE_BOUNDARY_PREFIX + boundaryID + '\n' +</span>
<a href="#l3.464"></a><span id="l3.464" class="difflineplus">+      let boundaryID = source.length + this.enclosure.mLength;</span>
<a href="#l3.465"></a><span id="l3.465" class="difflineplus">+      source += 'Content-Type: multipart/mixed;\n boundary=&quot;' +</span>
<a href="#l3.466"></a><span id="l3.466" class="difflineplus">+                this.ENCLOSURE_HEADER_BOUNDARY_PREFIX + boundaryID + '&quot;' + '\n\n' +</span>
<a href="#l3.467"></a><span id="l3.467" class="difflineplus">+                'This is a multi-part message in MIME format.\n' +</span>
<a href="#l3.468"></a><span id="l3.468" class="difflineplus">+                this.ENCLOSURE_BOUNDARY_PREFIX + boundaryID + '\n' +</span>
<a href="#l3.469"></a><span id="l3.469">                 'Content-Type: text/html; charset=' + this.characterSet + '\n' +</span>
<a href="#l3.470"></a><span id="l3.470">                 'Content-Transfer-Encoding: 8bit\n' +</span>
<a href="#l3.471"></a><span id="l3.471">                 this.content;</span>
<a href="#l3.472"></a><span id="l3.472">       source += this.enclosure.convertToAttachment(boundaryID);</span>
<a href="#l3.473"></a><span id="l3.473">     }</span>
<a href="#l3.474"></a><span id="l3.474">     else</span>
<a href="#l3.475"></a><span id="l3.475">     {</span>
<a href="#l3.476"></a><span id="l3.476">       source += 'Content-Type: text/html; charset=' + this.characterSet + '\n' +</span>
<a href="#l3.477"></a><span id="l3.477">                 '\n' + this.content;</span>
<a href="#l3.478"></a><span id="l3.478"> </span>
<a href="#l3.479"></a><span id="l3.479">     }</span>
<a href="#l3.480"></a><span id="l3.480"> </span>
<a href="#l3.481"></a><span id="l3.481" class="difflineminus">-    debug(this.identity + &quot; is &quot; + source.length + &quot; characters long&quot;);</span>
<a href="#l3.482"></a><span id="l3.482" class="difflineplus">+    FeedUtils.log.trace(&quot;FeedItem.writeToFolder: &quot; + this.identity +</span>
<a href="#l3.483"></a><span id="l3.483" class="difflineplus">+                        &quot; is &quot; + source.length + &quot; characters long&quot;);</span>
<a href="#l3.484"></a><span id="l3.484"> </span>
<a href="#l3.485"></a><span id="l3.485">     // Get the folder and database storing the feed's messages and headers.</span>
<a href="#l3.486"></a><span id="l3.486" class="difflineminus">-    var folder = this.feed.folder.QueryInterface(Components.interfaces.nsIMsgLocalMailFolder);</span>
<a href="#l3.487"></a><span id="l3.487" class="difflineminus">-    var msgFolder = folder.QueryInterface(Components.interfaces.nsIMsgFolder);</span>
<a href="#l3.488"></a><span id="l3.488" class="difflineplus">+    let folder = this.feed.folder.QueryInterface(Ci.nsIMsgLocalMailFolder);</span>
<a href="#l3.489"></a><span id="l3.489" class="difflineplus">+    let msgFolder = folder.QueryInterface(Ci.nsIMsgFolder);</span>
<a href="#l3.490"></a><span id="l3.490">     msgFolder.gettingNewMessages = true;</span>
<a href="#l3.491"></a><span id="l3.491">     // Source is a unicode string, we want to save a char * string in</span>
<a href="#l3.492"></a><span id="l3.492" class="difflineminus">-    // the original charset. So convert back</span>
<a href="#l3.493"></a><span id="l3.493" class="difflineplus">+    // the original charset. So convert back.</span>
<a href="#l3.494"></a><span id="l3.494">     folder.addMessage(this.mUnicodeConverter.ConvertFromUnicode(source));</span>
<a href="#l3.495"></a><span id="l3.495">     msgFolder.gettingNewMessages = false;</span>
<a href="#l3.496"></a><span id="l3.496" class="difflineplus">+  },</span>
<a href="#l3.497"></a><span id="l3.497" class="difflineplus">+</span>
<a href="#l3.498"></a><span id="l3.498" class="difflineplus">+  htmlEscape: function(s)</span>
<a href="#l3.499"></a><span id="l3.499" class="difflineplus">+  {</span>
<a href="#l3.500"></a><span id="l3.500" class="difflineplus">+    s = s.replace(/&amp;/g, &quot;&amp;amp;&quot;);</span>
<a href="#l3.501"></a><span id="l3.501" class="difflineplus">+    s = s.replace(/&gt;/g, &quot;&amp;gt;&quot;);</span>
<a href="#l3.502"></a><span id="l3.502" class="difflineplus">+    s = s.replace(/&lt;/g, &quot;&amp;lt;&quot;);</span>
<a href="#l3.503"></a><span id="l3.503" class="difflineplus">+    s = s.replace(/'/g, &quot;&amp;#39;&quot;);</span>
<a href="#l3.504"></a><span id="l3.504" class="difflineplus">+    s = s.replace(/&quot;/g, &quot;&amp;quot;&quot;);</span>
<a href="#l3.505"></a><span id="l3.505" class="difflineplus">+    return s;</span>
<a href="#l3.506"></a><span id="l3.506" class="difflineplus">+  },</span>
<a href="#l3.507"></a><span id="l3.507" class="difflineplus">+</span>
<a href="#l3.508"></a><span id="l3.508" class="difflineplus">+  createURN: function(aName)</span>
<a href="#l3.509"></a><span id="l3.509" class="difflineplus">+  {</span>
<a href="#l3.510"></a><span id="l3.510" class="difflineplus">+    // Returns name as a URN in the 'feeditem' namespace. The returned URN is</span>
<a href="#l3.511"></a><span id="l3.511" class="difflineplus">+    // (or is intended to be) RFC2141 compliant.</span>
<a href="#l3.512"></a><span id="l3.512" class="difflineplus">+    // The builtin encodeURI provides nearly the exact encoding functionality</span>
<a href="#l3.513"></a><span id="l3.513" class="difflineplus">+    // required by the RFC.  The exceptions are that NULL characters should not</span>
<a href="#l3.514"></a><span id="l3.514" class="difflineplus">+    // appear, and that #, /, ?, &amp;, and ~ should be escaped.</span>
<a href="#l3.515"></a><span id="l3.515" class="difflineplus">+    // NULL characters are removed before encoding.</span>
<a href="#l3.516"></a><span id="l3.516" class="difflineplus">+</span>
<a href="#l3.517"></a><span id="l3.517" class="difflineplus">+    let name = aName.replace(/\0/g, &quot;&quot;);</span>
<a href="#l3.518"></a><span id="l3.518" class="difflineplus">+    let encoded = encodeURI(name);</span>
<a href="#l3.519"></a><span id="l3.519" class="difflineplus">+    encoded = encoded.replace(/\#/g, &quot;%23&quot;);</span>
<a href="#l3.520"></a><span id="l3.520" class="difflineplus">+    encoded = encoded.replace(/\//g, &quot;%2f&quot;);</span>
<a href="#l3.521"></a><span id="l3.521" class="difflineplus">+    encoded = encoded.replace(/\?/g, &quot;%3f&quot;);</span>
<a href="#l3.522"></a><span id="l3.522" class="difflineplus">+    encoded = encoded.replace(/\&amp;/g, &quot;%26&quot;);</span>
<a href="#l3.523"></a><span id="l3.523" class="difflineplus">+    encoded = encoded.replace(/\~/g, &quot;%7e&quot;);</span>
<a href="#l3.524"></a><span id="l3.524" class="difflineplus">+</span>
<a href="#l3.525"></a><span id="l3.525" class="difflineplus">+    return FeedUtils.FZ_ITEM_NS + encoded;</span>
<a href="#l3.526"></a><span id="l3.526">   }</span>
<a href="#l3.527"></a><span id="l3.527"> };</span>
<a href="#l3.528"></a><span id="l3.528"> </span>
<a href="#l3.529"></a><span id="l3.529"> </span>
<a href="#l3.530"></a><span id="l3.530" class="difflineminus">-// A feed enclosure is to RSS what an attachment is for e-mail. We make enclosures look</span>
<a href="#l3.531"></a><span id="l3.531" class="difflineminus">-// like attachments in the UI.</span>
<a href="#l3.532"></a><span id="l3.532" class="difflineminus">-</span>
<a href="#l3.533"></a><span id="l3.533" class="difflineplus">+// A feed enclosure is to RSS what an attachment is for e-mail.  We make</span>
<a href="#l3.534"></a><span id="l3.534" class="difflineplus">+// enclosures look like attachments in the UI.</span>
<a href="#l3.535"></a><span id="l3.535"> function FeedEnclosure(aURL, aContentType, aLength)</span>
<a href="#l3.536"></a><span id="l3.536"> {</span>
<a href="#l3.537"></a><span id="l3.537">   this.mURL = aURL;</span>
<a href="#l3.538"></a><span id="l3.538">   this.mContentType = aContentType;</span>
<a href="#l3.539"></a><span id="l3.539">   this.mLength = aLength;</span>
<a href="#l3.540"></a><span id="l3.540"> </span>
<a href="#l3.541"></a><span id="l3.541" class="difflineminus">-  // generate a fileName from the URL</span>
<a href="#l3.542"></a><span id="l3.542" class="difflineplus">+  // Generate a fileName from the URL.</span>
<a href="#l3.543"></a><span id="l3.543">   if (this.mURL)</span>
<a href="#l3.544"></a><span id="l3.544">   {</span>
<a href="#l3.545"></a><span id="l3.545" class="difflineminus">-    var ioService = Components.classes[&quot;@mozilla.org/network/io-service;1&quot;]</span>
<a href="#l3.546"></a><span id="l3.546" class="difflineminus">-                              .getService(Components.interfaces.nsIIOService);</span>
<a href="#l3.547"></a><span id="l3.547" class="difflineminus">-    var enclosureURL, fileName;</span>
<a href="#l3.548"></a><span id="l3.548">     try</span>
<a href="#l3.549"></a><span id="l3.549">     {</span>
<a href="#l3.550"></a><span id="l3.550" class="difflineminus">-      enclosureURL  = ioService.newURI(this.mURL, null, null)</span>
<a href="#l3.551"></a><span id="l3.551" class="difflineminus">-                               .QueryInterface(Components.interfaces.nsIURL);</span>
<a href="#l3.552"></a><span id="l3.552" class="difflineminus">-      fileName = enclosureURL.fileName;</span>
<a href="#l3.553"></a><span id="l3.553" class="difflineplus">+      this.mFileName = Services.io.newURI(this.mURL, null, null).</span>
<a href="#l3.554"></a><span id="l3.554" class="difflineplus">+                                   QueryInterface(Ci.nsIURL).</span>
<a href="#l3.555"></a><span id="l3.555" class="difflineplus">+                                   fileName;</span>
<a href="#l3.556"></a><span id="l3.556">     }</span>
<a href="#l3.557"></a><span id="l3.557">     catch(ex)</span>
<a href="#l3.558"></a><span id="l3.558">     {</span>
<a href="#l3.559"></a><span id="l3.559" class="difflineminus">-      fileName = this.mURL;</span>
<a href="#l3.560"></a><span id="l3.560" class="difflineplus">+      this.mFileName = this.mURL;</span>
<a href="#l3.561"></a><span id="l3.561">     }</span>
<a href="#l3.562"></a><span id="l3.562" class="difflineminus">-    if (fileName)</span>
<a href="#l3.563"></a><span id="l3.563" class="difflineminus">-      this.mFileName = fileName;</span>
<a href="#l3.564"></a><span id="l3.564">   }</span>
<a href="#l3.565"></a><span id="l3.565"> }</span>
<a href="#l3.566"></a><span id="l3.566"> </span>
<a href="#l3.567"></a><span id="l3.567"> FeedEnclosure.prototype =</span>
<a href="#l3.568"></a><span id="l3.568"> {</span>
<a href="#l3.569"></a><span id="l3.569">   mURL: &quot;&quot;,</span>
<a href="#l3.570"></a><span id="l3.570">   mContentType: &quot;&quot;,</span>
<a href="#l3.571"></a><span id="l3.571">   mLength: 0,</span>
<a href="#l3.572"></a><span id="l3.572">   mFileName: &quot;&quot;,</span>
<a href="#l3.573"></a><span id="l3.573" class="difflineplus">+  ENCLOSURE_BOUNDARY_PREFIX: &quot;--------------&quot;, // 14 dashes</span>
<a href="#l3.574"></a><span id="l3.574"> </span>
<a href="#l3.575"></a><span id="l3.575" class="difflineminus">-  // Returns a string that looks like an e-mail attachment which</span>
<a href="#l3.576"></a><span id="l3.576" class="difflineminus">-  // represents the enclosure.</span>
<a href="#l3.577"></a><span id="l3.577" class="difflineplus">+  // Returns a string that looks like an e-mail attachment which represents</span>
<a href="#l3.578"></a><span id="l3.578" class="difflineplus">+  // the enclosure.</span>
<a href="#l3.579"></a><span id="l3.579">   convertToAttachment: function(aBoundaryID)</span>
<a href="#l3.580"></a><span id="l3.580">   {</span>
<a href="#l3.581"></a><span id="l3.581">     return '\n' +</span>
<a href="#l3.582"></a><span id="l3.582" class="difflineminus">-                  ENCLOSURE_BOUNDARY_PREFIX + aBoundaryID + '\n' +</span>
<a href="#l3.583"></a><span id="l3.583" class="difflineminus">-                  'Content-Type: ' + this.mContentType +</span>
<a href="#l3.584"></a><span id="l3.584" class="difflineminus">-                                 '; name=&quot;' + this.mFileName +</span>
<a href="#l3.585"></a><span id="l3.585" class="difflineminus">-                                 (this.mLength ? '&quot;; size=' + this.mLength : '&quot;') + '\n' +</span>
<a href="#l3.586"></a><span id="l3.586" class="difflineminus">-                  'X-Mozilla-External-Attachment-URL: ' + this.mURL + '\n' +</span>
<a href="#l3.587"></a><span id="l3.587" class="difflineminus">-                  'Content-Disposition: attachment; filename=&quot;' + this.mFileName + '&quot;\n\n' +</span>
<a href="#l3.588"></a><span id="l3.588" class="difflineminus">-                  'This MIME attachment is stored separately from the message.\n' +</span>
<a href="#l3.589"></a><span id="l3.589" class="difflineminus">-                  ENCLOSURE_BOUNDARY_PREFIX + aBoundaryID + '--' + '\n';</span>
<a href="#l3.590"></a><span id="l3.590" class="difflineminus">-</span>
<a href="#l3.591"></a><span id="l3.591" class="difflineplus">+      this.ENCLOSURE_BOUNDARY_PREFIX + aBoundaryID + '\n' +</span>
<a href="#l3.592"></a><span id="l3.592" class="difflineplus">+      'Content-Type: ' + this.mContentType +</span>
<a href="#l3.593"></a><span id="l3.593" class="difflineplus">+                     '; name=&quot;' + this.mFileName +</span>
<a href="#l3.594"></a><span id="l3.594" class="difflineplus">+                     (this.mLength ? '&quot;; size=' + this.mLength : '&quot;') + '\n' +</span>
<a href="#l3.595"></a><span id="l3.595" class="difflineplus">+      'X-Mozilla-External-Attachment-URL: ' + this.mURL + '\n' +</span>
<a href="#l3.596"></a><span id="l3.596" class="difflineplus">+      'Content-Disposition: attachment; filename=&quot;' + this.mFileName + '&quot;\n\n' +</span>
<a href="#l3.597"></a><span id="l3.597" class="difflineplus">+      'This MIME attachment is stored separately from the message.\n' +</span>
<a href="#l3.598"></a><span id="l3.598" class="difflineplus">+      this.ENCLOSURE_BOUNDARY_PREFIX + aBoundaryID + '--' + '\n';</span>
<a href="#l3.599"></a><span id="l3.599">   }</span>
<a href="#l3.600"></a><span id="l3.600"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1">deleted file mode 100644</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineminus">--- a/mailnews/extensions/newsblog/content/debug-utils.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineplus">+++ /dev/null</span>
<a href="#l4.4"></a><span id="l4.4" class="difflineat">@@ -1,48 +0,0 @@</span>
<a href="#l4.5"></a><span id="l4.5" class="difflineminus">-function enumerateInterfaces(obj)</span>
<a href="#l4.6"></a><span id="l4.6" class="difflineminus">-{</span>
<a href="#l4.7"></a><span id="l4.7" class="difflineminus">-  var interfaces = new Array();</span>
<a href="#l4.8"></a><span id="l4.8" class="difflineminus">-  for (i in Components.interfaces)</span>
<a href="#l4.9"></a><span id="l4.9" class="difflineminus">-  {</span>
<a href="#l4.10"></a><span id="l4.10" class="difflineminus">-    try</span>
<a href="#l4.11"></a><span id="l4.11" class="difflineminus">-    {</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-      obj.QueryInterface(Components.interfaces[i]);</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineminus">-      interfaces.push(i);</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineminus">-    }</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineminus">-    catch(e) {}</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineminus">-  }</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineminus">-  return interfaces;</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineminus">-}</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineminus">-</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineminus">-function enumerateProperties(obj, excludeComplexTypes)</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineminus">-{</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineminus">-  var properties = &quot;&quot;;</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineminus">-  for (p in obj)</span>
<a href="#l4.24"></a><span id="l4.24" class="difflineminus">-  {</span>
<a href="#l4.25"></a><span id="l4.25" class="difflineminus">-    try</span>
<a href="#l4.26"></a><span id="l4.26" class="difflineminus">-    {</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineminus">-      if (excludeComplexTypes</span>
<a href="#l4.28"></a><span id="l4.28" class="difflineminus">-          &amp;&amp; (typeof obj[p] == 'object' || typeof obj[p] == 'function')) next;</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineminus">-      properties += p + &quot; = &quot; + obj[p] + &quot;\n&quot;;</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineminus">-    }</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineminus">-    catch(e) {</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineminus">-      properties += p + &quot; = &quot; + e + &quot;\n&quot;;</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineminus">-    }</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineminus">-  }</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineminus">-  return properties;</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineminus">-}</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineminus">-</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineminus">-// minimal implementation of nsIOutputStream for use by dumpRDF, adapted from</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineminus">-// http://groups.google.com/search?as_umsgid=20011203111618.C1302%40erde.jan.netgaroo.de</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineminus">-var DumpOutputStream = {</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineminus">-  write: function(buf, count) { dump(buf); return count; }</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineminus">-};</span>
<a href="#l4.43"></a><span id="l4.43" class="difflineminus">-</span>
<a href="#l4.44"></a><span id="l4.44" class="difflineminus">-function dumpRDF( aDS ) {</span>
<a href="#l4.45"></a><span id="l4.45" class="difflineminus">-  var serializer = Components.classes[&quot;@mozilla.org/rdf/xml-serializer;1&quot;]</span>
<a href="#l4.46"></a><span id="l4.46" class="difflineminus">-    .createInstance( Components.interfaces.nsIRDFXMLSerializer );</span>
<a href="#l4.47"></a><span id="l4.47" class="difflineminus">-  </span>
<a href="#l4.48"></a><span id="l4.48" class="difflineminus">-  serializer.init( aDS );</span>
<a href="#l4.49"></a><span id="l4.49" class="difflineminus">-  </span>
<a href="#l4.50"></a><span id="l4.50" class="difflineminus">-  serializer.QueryInterface( Components.interfaces.nsIRDFXMLSource )</span>
<a href="#l4.51"></a><span id="l4.51" class="difflineminus">-    .Serialize( DumpOutputStream );</span>
<a href="#l4.52"></a><span id="l4.52" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/extensions/newsblog/content/feed-parser.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/extensions/newsblog/content/feed-parser.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -29,518 +29,677 @@</span>
<a href="#l5.4"></a><span id="l5.4">  * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l5.5"></a><span id="l5.5">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l5.6"></a><span id="l5.6">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l5.7"></a><span id="l5.7">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l5.8"></a><span id="l5.8">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l5.9"></a><span id="l5.9">  * the terms of any one of the MPL, the GPL or the </span>
<a href="#l5.10"></a><span id="l5.10">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l5.11"></a><span id="l5.11"> </span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-// The feed parser depends on FeedItems.js, Feed.js.</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineminus">-</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineminus">-var rdfcontainer =  Components.classes[&quot;@mozilla.org/rdf/container-utils;1&quot;].getService(Components.interfaces.nsIRDFContainerUtils);</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineminus">-var rdfparser = Components.classes[&quot;@mozilla.org/rdf/xml-parser;1&quot;].createInstance(Components.interfaces.nsIRDFXMLParser);</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineminus">-var serializer = Components.classes[&quot;@mozilla.org/xmlextras/xmlserializer;1&quot;].createInstance(Components.interfaces.nsIDOMSerializer);</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineminus">-var gIOService = Components.classes[&quot;@mozilla.org/network/io-service;1&quot;].getService(Components.interfaces.nsIIOService);</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineplus">+// The feed parser depends on FeedItem.js, Feed.js.</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineplus">+function FeedParser() {</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineplus">+  this.mSerializer = Cc[&quot;@mozilla.org/xmlextras/xmlserializer;1&quot;].</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineplus">+                     createInstance(Ci.nsIDOMSerializer);</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineplus">+}</span>
<a href="#l5.23"></a><span id="l5.23"> </span>
<a href="#l5.24"></a><span id="l5.24" class="difflineminus">-function FeedParser() </span>
<a href="#l5.25"></a><span id="l5.25" class="difflineminus">-{}</span>
<a href="#l5.26"></a><span id="l5.26" class="difflineminus">-</span>
<a href="#l5.27"></a><span id="l5.27" class="difflineminus">-FeedParser.prototype = </span>
<a href="#l5.28"></a><span id="l5.28" class="difflineplus">+FeedParser.prototype =</span>
<a href="#l5.29"></a><span id="l5.29"> {</span>
<a href="#l5.30"></a><span id="l5.30" class="difflineminus">-  // parseFeed returns an array of parsed items ready for processing</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineminus">-  // it is currently a synchronous operation. If there was an error parsing the feed, </span>
<a href="#l5.32"></a><span id="l5.32" class="difflineminus">-  // parseFeed returns an empty feed in addition to calling aFeed.onParseError</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineplus">+  // parseFeed() returns an array of parsed items ready for processing.  It is</span>
<a href="#l5.34"></a><span id="l5.34" class="difflineplus">+  // currently a synchronous operation.  If there is an error parsing the feed,</span>
<a href="#l5.35"></a><span id="l5.35" class="difflineplus">+  // parseFeed returns an empty feed in addition to calling aFeed.onParseError.</span>
<a href="#l5.36"></a><span id="l5.36">   parseFeed: function (aFeed, aDOM, aBaseURI)</span>
<a href="#l5.37"></a><span id="l5.37">   {</span>
<a href="#l5.38"></a><span id="l5.38" class="difflineminus">-    if (!(aDOM instanceof Components.interfaces.nsIDOMXMLDocument) ||</span>
<a href="#l5.39"></a><span id="l5.39" class="difflineminus">-        aDOM.documentElement.getElementsByTagNameNS(&quot;http://www.mozilla.org/newlayout/xml/parsererror.xml&quot;, &quot;parsererror&quot;)[0])</span>
<a href="#l5.40"></a><span id="l5.40" class="difflineplus">+    let doc = aDOM.documentElement;</span>
<a href="#l5.41"></a><span id="l5.41" class="difflineplus">+    if (!(aDOM instanceof Ci.nsIDOMXMLDocument) ||</span>
<a href="#l5.42"></a><span id="l5.42" class="difflineplus">+        doc.getElementsByTagNameNS(FeedUtils.MOZ_PARSERERROR_NS, &quot;parsererror&quot;)[0])</span>
<a href="#l5.43"></a><span id="l5.43">     {</span>
<a href="#l5.44"></a><span id="l5.44">       // No xml doc or gecko caught a basic parsing error.</span>
<a href="#l5.45"></a><span id="l5.45">       aFeed.onParseError(aFeed);</span>
<a href="#l5.46"></a><span id="l5.46">       return new Array();</span>
<a href="#l5.47"></a><span id="l5.47">     }</span>
<a href="#l5.48"></a><span id="l5.48" class="difflineminus">-    else if((aDOM.documentElement.namespaceURI == &quot;http://www.w3.org/1999/02/22-rdf-syntax-ns#&quot;)</span>
<a href="#l5.49"></a><span id="l5.49" class="difflineminus">-            &amp;&amp; (aDOM.documentElement.getElementsByTagNameNS(&quot;http://purl.org/rss/1.0/&quot;, &quot;channel&quot;)[0]))</span>
<a href="#l5.50"></a><span id="l5.50" class="difflineplus">+    else if(doc.namespaceURI == FeedUtils.RDF_SYNTAX_NS &amp;&amp;</span>
<a href="#l5.51"></a><span id="l5.51" class="difflineplus">+            doc.getElementsByTagNameNS(FeedUtils.RSS_NS, &quot;channel&quot;)[0])</span>
<a href="#l5.52"></a><span id="l5.52">     {</span>
<a href="#l5.53"></a><span id="l5.53" class="difflineminus">-      debug(aFeed.url + &quot; is an RSS 1.x (RDF-based) feed&quot;);</span>
<a href="#l5.54"></a><span id="l5.54" class="difflineminus">-      // aSource can be misencoded (XMLHttpRequest converts to UTF-8 by default), </span>
<a href="#l5.55"></a><span id="l5.55" class="difflineminus">-      // but the DOM is almost always right because it uses the hints in the XML file.</span>
<a href="#l5.56"></a><span id="l5.56" class="difflineminus">-      // This is slower, but not noticably so. Mozilla doesn't have the </span>
<a href="#l5.57"></a><span id="l5.57" class="difflineminus">-      // XMLHttpRequest.responseBody property that IE has, which provides access </span>
<a href="#l5.58"></a><span id="l5.58" class="difflineminus">-      // to the unencoded response.</span>
<a href="#l5.59"></a><span id="l5.59" class="difflineminus">-      var xmlString=serializer.serializeToString(aDOM.documentElement);</span>
<a href="#l5.60"></a><span id="l5.60" class="difflineplus">+      aFeed.mFeedType = &quot;RSS_1.xRDF&quot;</span>
<a href="#l5.61"></a><span id="l5.61" class="difflineplus">+      FeedUtils.log.debug(&quot;FeedParser.parseFeed: type:url - &quot; +</span>
<a href="#l5.62"></a><span id="l5.62" class="difflineplus">+                          aFeed.mFeedType +&quot; : &quot; +aFeed.url);</span>
<a href="#l5.63"></a><span id="l5.63" class="difflineplus">+      // aSource can be misencoded (XMLHttpRequest converts to UTF-8 by default),</span>
<a href="#l5.64"></a><span id="l5.64" class="difflineplus">+      // but the DOM is almost always right because it uses the hints in the</span>
<a href="#l5.65"></a><span id="l5.65" class="difflineplus">+      // XML file.  This is slower, but not noticably so.  Mozilla doesn't have</span>
<a href="#l5.66"></a><span id="l5.66" class="difflineplus">+      // the XMLHttpRequest.responseBody property that IE has, which provides</span>
<a href="#l5.67"></a><span id="l5.67" class="difflineplus">+      // access to the unencoded response.</span>
<a href="#l5.68"></a><span id="l5.68" class="difflineplus">+      let xmlString = this.mSerializer.serializeToString(doc);</span>
<a href="#l5.69"></a><span id="l5.69">       return this.parseAsRSS1(aFeed, xmlString, aBaseURI);</span>
<a href="#l5.70"></a><span id="l5.70">     }</span>
<a href="#l5.71"></a><span id="l5.71" class="difflineminus">-    else if (aDOM.documentElement.namespaceURI == ATOM_03_NS)</span>
<a href="#l5.72"></a><span id="l5.72" class="difflineplus">+    else if (doc.namespaceURI == FeedUtils.ATOM_03_NS)</span>
<a href="#l5.73"></a><span id="l5.73">     {</span>
<a href="#l5.74"></a><span id="l5.74" class="difflineminus">-      debug(aFeed.url + &quot; is an Atom 0.3 feed&quot;);</span>
<a href="#l5.75"></a><span id="l5.75" class="difflineplus">+      aFeed.mFeedType = &quot;ATOM_0.3&quot;</span>
<a href="#l5.76"></a><span id="l5.76" class="difflineplus">+      FeedUtils.log.debug(&quot;FeedParser.parseFeed: type:url - &quot; +</span>
<a href="#l5.77"></a><span id="l5.77" class="difflineplus">+                          aFeed.mFeedType +&quot; : &quot; +aFeed.url);</span>
<a href="#l5.78"></a><span id="l5.78">       return this.parseAsAtom(aFeed, aDOM);</span>
<a href="#l5.79"></a><span id="l5.79">     }</span>
<a href="#l5.80"></a><span id="l5.80" class="difflineminus">-    else if (aDOM.documentElement.namespaceURI == ATOM_IETF_NS)</span>
<a href="#l5.81"></a><span id="l5.81" class="difflineplus">+    else if (doc.namespaceURI == FeedUtils.ATOM_IETF_NS)</span>
<a href="#l5.82"></a><span id="l5.82">     {</span>
<a href="#l5.83"></a><span id="l5.83" class="difflineminus">-      debug(aFeed.url + &quot; is an IETF Atom feed&quot;);</span>
<a href="#l5.84"></a><span id="l5.84" class="difflineplus">+      aFeed.mFeedType = &quot;ATOM_IETF&quot;</span>
<a href="#l5.85"></a><span id="l5.85" class="difflineplus">+      FeedUtils.log.debug(&quot;FeedParser.parseFeed: type:url - &quot; +</span>
<a href="#l5.86"></a><span id="l5.86" class="difflineplus">+                          aFeed.mFeedType +&quot; : &quot; +aFeed.url);</span>
<a href="#l5.87"></a><span id="l5.87">       return this.parseAsAtomIETF(aFeed, aDOM);</span>
<a href="#l5.88"></a><span id="l5.88">     }</span>
<a href="#l5.89"></a><span id="l5.89" class="difflineminus">-    else if (aDOM.documentElement.getElementsByTagNameNS(&quot;http://my.netscape.com/rdf/simple/0.9/&quot;, &quot;channel&quot;)[0])</span>
<a href="#l5.90"></a><span id="l5.90" class="difflineplus">+    else if (doc.getElementsByTagNameNS(FeedUtils.RSS_090_NS, &quot;channel&quot;)[0])</span>
<a href="#l5.91"></a><span id="l5.91">     {</span>
<a href="#l5.92"></a><span id="l5.92" class="difflineminus">-      debug(aFeed.url + &quot; is an 0.90 feed&quot;);</span>
<a href="#l5.93"></a><span id="l5.93" class="difflineplus">+      aFeed.mFeedType = &quot;RSS_0.90&quot;</span>
<a href="#l5.94"></a><span id="l5.94" class="difflineplus">+      FeedUtils.log.debug(&quot;FeedParser.parseFeed: type:url - &quot; +</span>
<a href="#l5.95"></a><span id="l5.95" class="difflineplus">+                          aFeed.mFeedType +&quot; : &quot; +aFeed.url);</span>
<a href="#l5.96"></a><span id="l5.96">       return this.parseAsRSS2(aFeed, aDOM);</span>
<a href="#l5.97"></a><span id="l5.97">     }</span>
<a href="#l5.98"></a><span id="l5.98" class="difflineminus">-    // XXX Explicitly check for RSS 2.0 instead of letting it be handled by the</span>
<a href="#l5.99"></a><span id="l5.99" class="difflineminus">-    // default behavior (who knows, we may change the default at some point).</span>
<a href="#l5.100"></a><span id="l5.100" class="difflineminus">-    else </span>
<a href="#l5.101"></a><span id="l5.101" class="difflineplus">+    else</span>
<a href="#l5.102"></a><span id="l5.102">     {</span>
<a href="#l5.103"></a><span id="l5.103" class="difflineminus">-      // We don't know what kind of feed this is; let's pretend it's RSS 0.9x</span>
<a href="#l5.104"></a><span id="l5.104" class="difflineminus">-      // and hope things work out for the best.  In theory even RSS 1.0 feeds</span>
<a href="#l5.105"></a><span id="l5.105" class="difflineminus">-      // could be parsed by the 0.9x parser if the RSS namespace was the default.</span>
<a href="#l5.106"></a><span id="l5.106" class="difflineminus">-      debug(aFeed.url + &quot; is of unknown format; assuming an RSS 0.9x feed&quot;);</span>
<a href="#l5.107"></a><span id="l5.107" class="difflineplus">+      // Parse as RSS 0.9x.  In theory even RSS 1.0 feeds could be parsed by</span>
<a href="#l5.108"></a><span id="l5.108" class="difflineplus">+      // the 0.9x parser if the RSS namespace were the default.</span>
<a href="#l5.109"></a><span id="l5.109" class="difflineplus">+      let rssVer = doc.localName == &quot;rss&quot; ? doc.getAttribute(&quot;version&quot;) : null;</span>
<a href="#l5.110"></a><span id="l5.110" class="difflineplus">+      if (rssVer)</span>
<a href="#l5.111"></a><span id="l5.111" class="difflineplus">+        aFeed.mFeedType = &quot;RSS_&quot; + rssVer;</span>
<a href="#l5.112"></a><span id="l5.112" class="difflineplus">+      else</span>
<a href="#l5.113"></a><span id="l5.113" class="difflineplus">+        aFeed.mFeedType = &quot;RSS_0.9x?&quot;;</span>
<a href="#l5.114"></a><span id="l5.114" class="difflineplus">+      FeedUtils.log.debug(&quot;FeedParser.parseFeed: type:url - &quot; +</span>
<a href="#l5.115"></a><span id="l5.115" class="difflineplus">+                          aFeed.mFeedType +&quot; : &quot; +aFeed.url);</span>
<a href="#l5.116"></a><span id="l5.116">       return this.parseAsRSS2(aFeed, aDOM);</span>
<a href="#l5.117"></a><span id="l5.117">     }</span>
<a href="#l5.118"></a><span id="l5.118">   },</span>
<a href="#l5.119"></a><span id="l5.119"> </span>
<a href="#l5.120"></a><span id="l5.120" class="difflineminus">-  parseAsRSS2: function (aFeed, aDOM) </span>
<a href="#l5.121"></a><span id="l5.121" class="difflineplus">+  parseAsRSS2: function (aFeed, aDOM)</span>
<a href="#l5.122"></a><span id="l5.122">   {</span>
<a href="#l5.123"></a><span id="l5.123">     // Get the first channel (assuming there is only one per RSS File).</span>
<a href="#l5.124"></a><span id="l5.124" class="difflineminus">-    var parsedItems = new Array();</span>
<a href="#l5.125"></a><span id="l5.125" class="difflineplus">+    let parsedItems = new Array();</span>
<a href="#l5.126"></a><span id="l5.126"> </span>
<a href="#l5.127"></a><span id="l5.127" class="difflineminus">-    var channel = aDOM.getElementsByTagName(&quot;channel&quot;)[0];</span>
<a href="#l5.128"></a><span id="l5.128" class="difflineplus">+    let channel = aDOM.getElementsByTagName(&quot;channel&quot;)[0];</span>
<a href="#l5.129"></a><span id="l5.129">     if (!channel)</span>
<a href="#l5.130"></a><span id="l5.130">       return aFeed.onParseError(aFeed);</span>
<a href="#l5.131"></a><span id="l5.131"> </span>
<a href="#l5.132"></a><span id="l5.132" class="difflineminus">-    //usually the empty string, unless this is RSS .90</span>
<a href="#l5.133"></a><span id="l5.133" class="difflineminus">-    var nsURI = channel.namespaceURI || &quot;&quot;;</span>
<a href="#l5.134"></a><span id="l5.134" class="difflineminus">-    debug(&quot;channel NS: '&quot; + nsURI +&quot;'&quot;);</span>
<a href="#l5.135"></a><span id="l5.135" class="difflineplus">+    // Usually the empty string, unless this is RSS .90.</span>
<a href="#l5.136"></a><span id="l5.136" class="difflineplus">+    let nsURI = channel.namespaceURI || &quot;&quot;;</span>
<a href="#l5.137"></a><span id="l5.137" class="difflineplus">+    FeedUtils.log.debug(&quot;FeedParser.parseAsRSS2: channel nsURI - &quot; + nsURI);</span>
<a href="#l5.138"></a><span id="l5.138"> </span>
<a href="#l5.139"></a><span id="l5.139" class="difflineminus">-    aFeed.title = aFeed.title || getNodeValue(this.childrenByTagNameNS(channel, nsURI, &quot;title&quot;)[0]);</span>
<a href="#l5.140"></a><span id="l5.140" class="difflineminus">-    aFeed.description = getNodeValue(this.childrenByTagNameNS(channel, nsURI, &quot;description&quot;)[0]);</span>
<a href="#l5.141"></a><span id="l5.141" class="difflineminus">-    aFeed.link = getNodeValue(this.childrenByTagNameNS(channel, nsURI, &quot;link&quot;)[0]);</span>
<a href="#l5.142"></a><span id="l5.142" class="difflineplus">+    let tags = this.childrenByTagNameNS(channel, nsURI, &quot;title&quot;);</span>
<a href="#l5.143"></a><span id="l5.143" class="difflineplus">+    aFeed.title = aFeed.title || this.getNodeValue(tags ? tags[0] : null);</span>
<a href="#l5.144"></a><span id="l5.144" class="difflineplus">+    tags = this.childrenByTagNameNS(channel, nsURI, &quot;description&quot;);</span>
<a href="#l5.145"></a><span id="l5.145" class="difflineplus">+    aFeed.description = this.getNodeValue(tags ? tags[0] : null);</span>
<a href="#l5.146"></a><span id="l5.146" class="difflineplus">+    tags = this.childrenByTagNameNS(channel, nsURI, &quot;link&quot;);</span>
<a href="#l5.147"></a><span id="l5.147" class="difflineplus">+    aFeed.link = this.getNodeValue(tags ? tags[0] : null);</span>
<a href="#l5.148"></a><span id="l5.148"> </span>
<a href="#l5.149"></a><span id="l5.149">     if (!aFeed.parseItems)</span>
<a href="#l5.150"></a><span id="l5.150">       return parsedItems;</span>
<a href="#l5.151"></a><span id="l5.151"> </span>
<a href="#l5.152"></a><span id="l5.152">     aFeed.invalidateItems();</span>
<a href="#l5.153"></a><span id="l5.153" class="difflineminus">-    // XXX use getElementsByTagNameNS for now</span>
<a href="#l5.154"></a><span id="l5.154" class="difflineminus">-    // childrenByTagNameNS would be better, but RSS .90 is still with us</span>
<a href="#l5.155"></a><span id="l5.155" class="difflineminus">-    var itemNodes = aDOM.getElementsByTagNameNS(nsURI,&quot;item&quot;);</span>
<a href="#l5.156"></a><span id="l5.156" class="difflineplus">+    // XXX use getElementsByTagNameNS for now; childrenByTagNameNS would be</span>
<a href="#l5.157"></a><span id="l5.157" class="difflineplus">+    // better, but RSS .90 is still with us.</span>
<a href="#l5.158"></a><span id="l5.158" class="difflineplus">+    let itemNodes = aDOM.getElementsByTagNameNS(nsURI, &quot;item&quot;);</span>
<a href="#l5.159"></a><span id="l5.159" class="difflineplus">+    FeedUtils.log.debug(&quot;FeedParser.parseAsRSS2: items to parse - &quot; +</span>
<a href="#l5.160"></a><span id="l5.160" class="difflineplus">+                        itemNodes.length);</span>
<a href="#l5.161"></a><span id="l5.161"> </span>
<a href="#l5.162"></a><span id="l5.162" class="difflineminus">-    for (var i=0; i &lt; itemNodes.length; i++) </span>
<a href="#l5.163"></a><span id="l5.163" class="difflineplus">+    for (let i = 0; i &lt; itemNodes.length; i++)</span>
<a href="#l5.164"></a><span id="l5.164">     {</span>
<a href="#l5.165"></a><span id="l5.165" class="difflineminus">-      var itemNode = itemNodes[i];</span>
<a href="#l5.166"></a><span id="l5.166" class="difflineminus">-      var item = new FeedItem();</span>
<a href="#l5.167"></a><span id="l5.167" class="difflineplus">+      let itemNode = itemNodes[i];</span>
<a href="#l5.168"></a><span id="l5.168" class="difflineplus">+      let item = new FeedItem();</span>
<a href="#l5.169"></a><span id="l5.169">       item.feed = aFeed;</span>
<a href="#l5.170"></a><span id="l5.170">       item.characterSet = &quot;UTF-8&quot;;</span>
<a href="#l5.171"></a><span id="l5.171"> </span>
<a href="#l5.172"></a><span id="l5.172" class="difflineminus">-      var link = getNodeValue(this.childrenByTagNameNS(itemNode, nsURI, &quot;link&quot;)[0]);</span>
<a href="#l5.173"></a><span id="l5.173" class="difflineminus">-      var guidNode = this.childrenByTagNameNS(itemNode, nsURI, &quot;guid&quot;)[0];</span>
<a href="#l5.174"></a><span id="l5.174" class="difflineminus">-      var guid;</span>
<a href="#l5.175"></a><span id="l5.175" class="difflineminus">-      var isPermaLink = false;</span>
<a href="#l5.176"></a><span id="l5.176" class="difflineminus">-      if (guidNode) </span>
<a href="#l5.177"></a><span id="l5.177" class="difflineplus">+      tags = this.childrenByTagNameNS(itemNode, nsURI, &quot;link&quot;);</span>
<a href="#l5.178"></a><span id="l5.178" class="difflineplus">+      let link = this.getNodeValue(tags ? tags[0] : null);</span>
<a href="#l5.179"></a><span id="l5.179" class="difflineplus">+      tags = this.childrenByTagNameNS(itemNode, nsURI, &quot;guid&quot;);</span>
<a href="#l5.180"></a><span id="l5.180" class="difflineplus">+      let guidNode = tags ? tags[0] : null;</span>
<a href="#l5.181"></a><span id="l5.181" class="difflineplus">+</span>
<a href="#l5.182"></a><span id="l5.182" class="difflineplus">+      let guid;</span>
<a href="#l5.183"></a><span id="l5.183" class="difflineplus">+      let isPermaLink = false;</span>
<a href="#l5.184"></a><span id="l5.184" class="difflineplus">+      if (guidNode)</span>
<a href="#l5.185"></a><span id="l5.185">       {</span>
<a href="#l5.186"></a><span id="l5.186" class="difflineminus">-        guid = getNodeValue(guidNode);</span>
<a href="#l5.187"></a><span id="l5.187" class="difflineplus">+        guid = this.getNodeValue(guidNode);</span>
<a href="#l5.188"></a><span id="l5.188">         // isPermaLink is true if the value is &quot;true&quot; or if the attribute is</span>
<a href="#l5.189"></a><span id="l5.189">         // not present; all other values, including &quot;false&quot; and &quot;False&quot; and</span>
<a href="#l5.190"></a><span id="l5.190">         // for that matter &quot;TRuE&quot; and &quot;meatcake&quot; are false.</span>
<a href="#l5.191"></a><span id="l5.191">         if (!guidNode.hasAttribute(&quot;isPermaLink&quot;) ||</span>
<a href="#l5.192"></a><span id="l5.192">             guidNode.getAttribute(&quot;isPermaLink&quot;) == &quot;true&quot;)</span>
<a href="#l5.193"></a><span id="l5.193">           isPermaLink = true;</span>
<a href="#l5.194"></a><span id="l5.194" class="difflineminus">-        // if attribute isPermaLink is missing, it is good to check the validity</span>
<a href="#l5.195"></a><span id="l5.195" class="difflineminus">-        // of &lt;guid&gt; value as an URL to avoid linking to non-URL strings</span>
<a href="#l5.196"></a><span id="l5.196" class="difflineplus">+        // If attribute isPermaLink is missing, it is good to check the validity</span>
<a href="#l5.197"></a><span id="l5.197" class="difflineplus">+        // of &lt;guid&gt; value as an URL to avoid linking to non-URL strings.</span>
<a href="#l5.198"></a><span id="l5.198">         if (!guidNode.hasAttribute(&quot;isPermaLink&quot;))</span>
<a href="#l5.199"></a><span id="l5.199">         {</span>
<a href="#l5.200"></a><span id="l5.200">           try</span>
<a href="#l5.201"></a><span id="l5.201">           {</span>
<a href="#l5.202"></a><span id="l5.202" class="difflineminus">-            gIOService.newURI(guid, null, null);</span>
<a href="#l5.203"></a><span id="l5.203" class="difflineminus">-            if (gIOService.extractScheme(guid) == &quot;tag&quot;)</span>
<a href="#l5.204"></a><span id="l5.204" class="difflineplus">+            Services.io.newURI(guid, null, null);</span>
<a href="#l5.205"></a><span id="l5.205" class="difflineplus">+            if (Services.io.extractScheme(guid) == &quot;tag&quot;)</span>
<a href="#l5.206"></a><span id="l5.206">               isPermaLink = false;</span>
<a href="#l5.207"></a><span id="l5.207">           }</span>
<a href="#l5.208"></a><span id="l5.208">           catch (ex)</span>
<a href="#l5.209"></a><span id="l5.209">           {</span>
<a href="#l5.210"></a><span id="l5.210">             isPermaLink = false;</span>
<a href="#l5.211"></a><span id="l5.211">           }</span>
<a href="#l5.212"></a><span id="l5.212">         }</span>
<a href="#l5.213"></a><span id="l5.213"> </span>
<a href="#l5.214"></a><span id="l5.214">         item.id = guid;</span>
<a href="#l5.215"></a><span id="l5.215">         item.isStoredWithId = true;</span>
<a href="#l5.216"></a><span id="l5.216">       }</span>
<a href="#l5.217"></a><span id="l5.217"> </span>
<a href="#l5.218"></a><span id="l5.218">       item.url = (guid &amp;&amp; isPermaLink) ? guid : link ? link : null;</span>
<a href="#l5.219"></a><span id="l5.219" class="difflineminus">-      item.description = getNodeValue(this.childrenByTagNameNS(itemNode, nsURI, &quot;description&quot;)[0]);</span>
<a href="#l5.220"></a><span id="l5.220" class="difflineminus">-      item.title = getNodeValue(this.childrenByTagNameNS(itemNode, nsURI, &quot;title&quot;)[0])</span>
<a href="#l5.221"></a><span id="l5.221" class="difflineminus">-                   || (item.description ? (this.stripTags(item.description).substr(0, 150)) : null)</span>
<a href="#l5.222"></a><span id="l5.222" class="difflineminus">-                   || item.title;</span>
<a href="#l5.223"></a><span id="l5.223" class="difflineplus">+      tags = this.childrenByTagNameNS(itemNode, nsURI, &quot;description&quot;);</span>
<a href="#l5.224"></a><span id="l5.224" class="difflineplus">+      item.description = this.getNodeValue(tags ? tags[0] : null);</span>
<a href="#l5.225"></a><span id="l5.225" class="difflineplus">+      tags = this.childrenByTagNameNS(itemNode, nsURI, &quot;title&quot;);</span>
<a href="#l5.226"></a><span id="l5.226" class="difflineplus">+      item.title = this.getNodeValue(tags ? tags[0] : null) ||</span>
<a href="#l5.227"></a><span id="l5.227" class="difflineplus">+                   (item.description ?</span>
<a href="#l5.228"></a><span id="l5.228" class="difflineplus">+                      this.stripTags(item.description).substr(0, 150) : null) ||</span>
<a href="#l5.229"></a><span id="l5.229" class="difflineplus">+                   item.title;</span>
<a href="#l5.230"></a><span id="l5.230"> </span>
<a href="#l5.231"></a><span id="l5.231" class="difflineminus">-      item.author = getNodeValue(this.childrenByTagNameNS(itemNode, nsURI, &quot;author&quot;)[0]</span>
<a href="#l5.232"></a><span id="l5.232" class="difflineminus">-                                 || this.childrenByTagNameNS(itemNode, DC_NS, &quot;creator&quot;)[0])</span>
<a href="#l5.233"></a><span id="l5.233" class="difflineminus">-                                 || aFeed.title</span>
<a href="#l5.234"></a><span id="l5.234" class="difflineminus">-                                 || item.author;</span>
<a href="#l5.235"></a><span id="l5.235" class="difflineminus">-      item.date = getNodeValue(this.childrenByTagNameNS(itemNode, nsURI, &quot;pubDate&quot;)[0]</span>
<a href="#l5.236"></a><span id="l5.236" class="difflineminus">-                               || this.childrenByTagNameNS(itemNode, DC_NS, &quot;date&quot;)[0])</span>
<a href="#l5.237"></a><span id="l5.237" class="difflineminus">-                               || item.date;</span>
<a href="#l5.238"></a><span id="l5.238" class="difflineplus">+      tags = this.childrenByTagNameNS(itemNode, nsURI, &quot;author&quot;);</span>
<a href="#l5.239"></a><span id="l5.239" class="difflineplus">+      if (!tags)</span>
<a href="#l5.240"></a><span id="l5.240" class="difflineplus">+        tags = this.childrenByTagNameNS(itemNode, FeedUtils.DC_NS, &quot;creator&quot;);</span>
<a href="#l5.241"></a><span id="l5.241" class="difflineplus">+      item.author = this.getNodeValue(tags ? tags[0] : null) ||</span>
<a href="#l5.242"></a><span id="l5.242" class="difflineplus">+                    aFeed.title ||</span>
<a href="#l5.243"></a><span id="l5.243" class="difflineplus">+                    item.author;</span>
<a href="#l5.244"></a><span id="l5.244" class="difflineplus">+</span>
<a href="#l5.245"></a><span id="l5.245" class="difflineplus">+      tags = this.childrenByTagNameNS(itemNode, nsURI, &quot;pubDate&quot;);</span>
<a href="#l5.246"></a><span id="l5.246" class="difflineplus">+      if (!tags)</span>
<a href="#l5.247"></a><span id="l5.247" class="difflineplus">+        tags = this.childrenByTagNameNS(itemNode, FeedUtils.DC_NS, &quot;date&quot;);</span>
<a href="#l5.248"></a><span id="l5.248" class="difflineplus">+      item.date = this.getNodeValue(tags ? tags[0] : null) || item.date;</span>
<a href="#l5.249"></a><span id="l5.249"> </span>
<a href="#l5.250"></a><span id="l5.250">       if (!item.id)</span>
<a href="#l5.251"></a><span id="l5.251" class="difflineminus">-        item.id = item.feed.url + '#' + (item.date || item.title);</span>
<a href="#l5.252"></a><span id="l5.252" class="difflineplus">+        item.id = item.feed.url + &quot;#&quot; + (item.date || item.title);</span>
<a href="#l5.253"></a><span id="l5.253"> </span>
<a href="#l5.254"></a><span id="l5.254">       // If the date is invalid, users will see the beginning of the epoch</span>
<a href="#l5.255"></a><span id="l5.255">       // unless we reset it here, so they'll see the current time instead.</span>
<a href="#l5.256"></a><span id="l5.256">       // This is typical aggregator behavior.</span>
<a href="#l5.257"></a><span id="l5.257" class="difflineminus">-      if(item.date)</span>
<a href="#l5.258"></a><span id="l5.258" class="difflineplus">+      if (item.date)</span>
<a href="#l5.259"></a><span id="l5.259">       {</span>
<a href="#l5.260"></a><span id="l5.260">         item.date = item.date.trim();</span>
<a href="#l5.261"></a><span id="l5.261" class="difflineminus">-        if(!isValidRFC822Date(item.date))</span>
<a href="#l5.262"></a><span id="l5.262" class="difflineplus">+        if (!this.isValidRFC822Date(item.date))</span>
<a href="#l5.263"></a><span id="l5.263">         {</span>
<a href="#l5.264"></a><span id="l5.264" class="difflineminus">-          // XXX Use this on the other formats as well</span>
<a href="#l5.265"></a><span id="l5.265" class="difflineminus">-          item.date = dateRescue(item.date);</span>
<a href="#l5.266"></a><span id="l5.266" class="difflineplus">+          // XXX Use this on the other formats as well.</span>
<a href="#l5.267"></a><span id="l5.267" class="difflineplus">+          item.date = this.dateRescue(item.date);</span>
<a href="#l5.268"></a><span id="l5.268">         }</span>
<a href="#l5.269"></a><span id="l5.269">       }</span>
<a href="#l5.270"></a><span id="l5.270"> </span>
<a href="#l5.271"></a><span id="l5.271" class="difflineminus">-      var content = getNodeValue(this.childrenByTagNameNS(itemNode, RSS_CONTENT_NS, &quot;encoded&quot;)[0]);</span>
<a href="#l5.272"></a><span id="l5.272" class="difflineminus">-      if(content)</span>
<a href="#l5.273"></a><span id="l5.273" class="difflineminus">-        item.content = content;</span>
<a href="#l5.274"></a><span id="l5.274" class="difflineplus">+      tags = this.childrenByTagNameNS(itemNode, FeedUtils.RSS_CONTENT_NS, &quot;encoded&quot;);</span>
<a href="#l5.275"></a><span id="l5.275" class="difflineplus">+      item.content = this.getNodeValue(tags ? tags[0] : null);</span>
<a href="#l5.276"></a><span id="l5.276"> </span>
<a href="#l5.277"></a><span id="l5.277" class="difflineminus">-      // Handle an enclosure (if present)</span>
<a href="#l5.278"></a><span id="l5.278" class="difflineminus">-      var enclosureNode = this.childrenByTagNameNS(itemNode, nsURI, &quot;enclosure&quot;)[0];</span>
<a href="#l5.279"></a><span id="l5.279" class="difflineplus">+      // Handle an enclosure (if present).</span>
<a href="#l5.280"></a><span id="l5.280" class="difflineplus">+      tags = this.childrenByTagNameNS(itemNode, nsURI, &quot;enclosure&quot;);</span>
<a href="#l5.281"></a><span id="l5.281" class="difflineplus">+      let enclosureNode = tags ? tags[0] : null;</span>
<a href="#l5.282"></a><span id="l5.282">       if (enclosureNode)</span>
<a href="#l5.283"></a><span id="l5.283" class="difflineminus">-        item.enclosure = new FeedEnclosure(enclosureNode.getAttribute(&quot;url&quot;), </span>
<a href="#l5.284"></a><span id="l5.284" class="difflineminus">-                                          enclosureNode.getAttribute(&quot;type&quot;),</span>
<a href="#l5.285"></a><span id="l5.285" class="difflineminus">-                                          enclosureNode.getAttribute(&quot;length&quot;));</span>
<a href="#l5.286"></a><span id="l5.286" class="difflineplus">+        item.enclosure = new FeedEnclosure(enclosureNode.getAttribute(&quot;url&quot;),</span>
<a href="#l5.287"></a><span id="l5.287" class="difflineplus">+                                           enclosureNode.getAttribute(&quot;type&quot;),</span>
<a href="#l5.288"></a><span id="l5.288" class="difflineplus">+                                           enclosureNode.getAttribute(&quot;length&quot;));</span>
<a href="#l5.289"></a><span id="l5.289">       parsedItems[i] = item;</span>
<a href="#l5.290"></a><span id="l5.290">     }</span>
<a href="#l5.291"></a><span id="l5.291" class="difflineplus">+</span>
<a href="#l5.292"></a><span id="l5.292">     return parsedItems;</span>
<a href="#l5.293"></a><span id="l5.293">   },</span>
<a href="#l5.294"></a><span id="l5.294"> </span>
<a href="#l5.295"></a><span id="l5.295" class="difflineminus">-  parseAsRSS1 : function(aFeed, aSource, aBaseURI) </span>
<a href="#l5.296"></a><span id="l5.296" class="difflineplus">+  parseAsRSS1 : function(aFeed, aSource, aBaseURI)</span>
<a href="#l5.297"></a><span id="l5.297">   {</span>
<a href="#l5.298"></a><span id="l5.298" class="difflineminus">-    var parsedItems = new Array();</span>
<a href="#l5.299"></a><span id="l5.299" class="difflineplus">+    let parsedItems = new Array();</span>
<a href="#l5.300"></a><span id="l5.300"> </span>
<a href="#l5.301"></a><span id="l5.301">     // RSS 1.0 is valid RDF, so use the RDF parser/service to extract data.</span>
<a href="#l5.302"></a><span id="l5.302">     // Create a new RDF data source and parse the feed into it.</span>
<a href="#l5.303"></a><span id="l5.303" class="difflineminus">-    var ds = Components.classes[&quot;@mozilla.org/rdf/datasource;1?name=in-memory-datasource&quot;]</span>
<a href="#l5.304"></a><span id="l5.304" class="difflineminus">-             .createInstance(Components.interfaces.nsIRDFDataSource);</span>
<a href="#l5.305"></a><span id="l5.305" class="difflineplus">+    let ds = Cc[&quot;@mozilla.org/rdf/datasource;1?name=in-memory-datasource&quot;].</span>
<a href="#l5.306"></a><span id="l5.306" class="difflineplus">+             createInstance(Ci.nsIRDFDataSource);</span>
<a href="#l5.307"></a><span id="l5.307"> </span>
<a href="#l5.308"></a><span id="l5.308" class="difflineplus">+    let rdfparser = Cc[&quot;@mozilla.org/rdf/xml-parser;1&quot;].</span>
<a href="#l5.309"></a><span id="l5.309" class="difflineplus">+                    createInstance(Ci.nsIRDFXMLParser);</span>
<a href="#l5.310"></a><span id="l5.310">     rdfparser.parseString(ds, aBaseURI, aSource);</span>
<a href="#l5.311"></a><span id="l5.311" class="difflineminus">-    </span>
<a href="#l5.312"></a><span id="l5.312" class="difflineplus">+</span>
<a href="#l5.313"></a><span id="l5.313">     // Get information about the feed as a whole.</span>
<a href="#l5.314"></a><span id="l5.314" class="difflineminus">-    var channel = ds.GetSource(RDF_TYPE, RSS_CHANNEL, true);</span>
<a href="#l5.315"></a><span id="l5.315" class="difflineminus">-    </span>
<a href="#l5.316"></a><span id="l5.316" class="difflineminus">-    aFeed.title = aFeed.title || getRDFTargetValue(ds, channel, RSS_TITLE) || aFeed.url;</span>
<a href="#l5.317"></a><span id="l5.317" class="difflineminus">-    aFeed.description = getRDFTargetValue(ds, channel, RSS_DESCRIPTION) || &quot;&quot;;</span>
<a href="#l5.318"></a><span id="l5.318" class="difflineminus">-    aFeed.link = getRDFTargetValue(ds, channel, RSS_LINK) || aFeed.url;</span>
<a href="#l5.319"></a><span id="l5.319" class="difflineplus">+    let channel = ds.GetSource(FeedUtils.RDF_TYPE, FeedUtils.RSS_CHANNEL, true);</span>
<a href="#l5.320"></a><span id="l5.320" class="difflineplus">+</span>
<a href="#l5.321"></a><span id="l5.321" class="difflineplus">+    aFeed.title = aFeed.title ||</span>
<a href="#l5.322"></a><span id="l5.322" class="difflineplus">+                  this.getRDFTargetValue(ds, channel, FeedUtils.RSS_TITLE) ||</span>
<a href="#l5.323"></a><span id="l5.323" class="difflineplus">+                  aFeed.url;</span>
<a href="#l5.324"></a><span id="l5.324" class="difflineplus">+    aFeed.description = this.getRDFTargetValue(ds, channel, FeedUtils.RSS_DESCRIPTION) ||</span>
<a href="#l5.325"></a><span id="l5.325" class="difflineplus">+                        &quot;&quot;;</span>
<a href="#l5.326"></a><span id="l5.326" class="difflineplus">+    aFeed.link = this.getRDFTargetValue(ds, channel, FeedUtils.RSS_LINK) ||</span>
<a href="#l5.327"></a><span id="l5.327" class="difflineplus">+                 aFeed.url;</span>
<a href="#l5.328"></a><span id="l5.328"> </span>
<a href="#l5.329"></a><span id="l5.329">     if (!aFeed.parseItems)</span>
<a href="#l5.330"></a><span id="l5.330">       return parsedItems;</span>
<a href="#l5.331"></a><span id="l5.331"> </span>
<a href="#l5.332"></a><span id="l5.332">     aFeed.invalidateItems();</span>
<a href="#l5.333"></a><span id="l5.333"> </span>
<a href="#l5.334"></a><span id="l5.334" class="difflineminus">-    var items = ds.GetTarget(channel, RSS_ITEMS, true);</span>
<a href="#l5.335"></a><span id="l5.335" class="difflineplus">+    let items = ds.GetTarget(channel, FeedUtils.RSS_ITEMS, true);</span>
<a href="#l5.336"></a><span id="l5.336">     if (items)</span>
<a href="#l5.337"></a><span id="l5.337" class="difflineminus">-      items = rdfcontainer.MakeSeq(ds, items).GetElements();</span>
<a href="#l5.338"></a><span id="l5.338" class="difflineminus">-  </span>
<a href="#l5.339"></a><span id="l5.339" class="difflineplus">+      items = FeedUtils.rdfContainerUtils.MakeSeq(ds, items).GetElements();</span>
<a href="#l5.340"></a><span id="l5.340" class="difflineplus">+ </span>
<a href="#l5.341"></a><span id="l5.341">     // If the channel doesn't list any items, look for resources of type &quot;item&quot;</span>
<a href="#l5.342"></a><span id="l5.342">     // (a hacky workaround for some buggy feeds).</span>
<a href="#l5.343"></a><span id="l5.343">     if (!items || !items.hasMoreElements())</span>
<a href="#l5.344"></a><span id="l5.344" class="difflineminus">-      items = ds.GetSources(RDF_TYPE, RSS_ITEM, true);</span>
<a href="#l5.345"></a><span id="l5.345" class="difflineplus">+      items = ds.GetSources(FeedUtils.RDF_TYPE, FeedUtils.RSS_ITEM, true);</span>
<a href="#l5.346"></a><span id="l5.346"> </span>
<a href="#l5.347"></a><span id="l5.347" class="difflineminus">-    var index = 0; </span>
<a href="#l5.348"></a><span id="l5.348" class="difflineminus">-    while (items.hasMoreElements()) </span>
<a href="#l5.349"></a><span id="l5.349" class="difflineplus">+    let index = 0;</span>
<a href="#l5.350"></a><span id="l5.350" class="difflineplus">+    while (items.hasMoreElements())</span>
<a href="#l5.351"></a><span id="l5.351">     {</span>
<a href="#l5.352"></a><span id="l5.352" class="difflineminus">-      var itemResource = items.getNext().QueryInterface(Components.interfaces.nsIRDFResource);</span>
<a href="#l5.353"></a><span id="l5.353" class="difflineminus">-      var item = new FeedItem();</span>
<a href="#l5.354"></a><span id="l5.354" class="difflineplus">+      let itemResource = items.getNext().QueryInterface(Ci.nsIRDFResource);</span>
<a href="#l5.355"></a><span id="l5.355" class="difflineplus">+      let item = new FeedItem();</span>
<a href="#l5.356"></a><span id="l5.356">       item.feed = aFeed;</span>
<a href="#l5.357"></a><span id="l5.357">       item.characterSet = &quot;UTF-8&quot;;</span>
<a href="#l5.358"></a><span id="l5.358"> </span>
<a href="#l5.359"></a><span id="l5.359">       // Prefer the value of the link tag to the item URI since the URI could be</span>
<a href="#l5.360"></a><span id="l5.360">       // a relative URN.</span>
<a href="#l5.361"></a><span id="l5.361" class="difflineminus">-      var uri = itemResource.Value;</span>
<a href="#l5.362"></a><span id="l5.362" class="difflineminus">-      var link = getRDFTargetValue(ds, itemResource, RSS_LINK);</span>
<a href="#l5.363"></a><span id="l5.363" class="difflineplus">+      let uri = itemResource.Value;</span>
<a href="#l5.364"></a><span id="l5.364" class="difflineplus">+      let link = this.getRDFTargetValue(ds, itemResource, FeedUtils.RSS_LINK);</span>
<a href="#l5.365"></a><span id="l5.365"> </span>
<a href="#l5.366"></a><span id="l5.366" class="difflineminus">-      // XXX</span>
<a href="#l5.367"></a><span id="l5.367" class="difflineminus">-      // check for bug258465 -- entities appear escaped </span>
<a href="#l5.368"></a><span id="l5.368" class="difflineminus">-      // in the value returned by getRDFTargetValue when they shouldn't</span>
<a href="#l5.369"></a><span id="l5.369" class="difflineplus">+      // XXX Check for bug258465 - entities appear escaped  in the value</span>
<a href="#l5.370"></a><span id="l5.370" class="difflineplus">+      // returned by getRDFTargetValue when they shouldn't.</span>
<a href="#l5.371"></a><span id="l5.371">       //debug(&quot;link comparison\n&quot; + &quot; uri: &quot; + uri + &quot;\nlink: &quot; + link);</span>
<a href="#l5.372"></a><span id="l5.372"> </span>
<a href="#l5.373"></a><span id="l5.373">       item.url = link || uri;</span>
<a href="#l5.374"></a><span id="l5.374">       item.id = item.url;</span>
<a href="#l5.375"></a><span id="l5.375" class="difflineminus">-      item.description = getRDFTargetValue(ds, itemResource, RSS_DESCRIPTION);</span>
<a href="#l5.376"></a><span id="l5.376" class="difflineminus">-      item.title = getRDFTargetValue(ds, itemResource, RSS_TITLE)</span>
<a href="#l5.377"></a><span id="l5.377" class="difflineminus">-                                     || getRDFTargetValue(ds, itemResource, DC_SUBJECT)</span>
<a href="#l5.378"></a><span id="l5.378" class="difflineminus">-                                     || (item.description ? (this.stripTags(item.description).substr(0, 150)) : null)</span>
<a href="#l5.379"></a><span id="l5.379" class="difflineminus">-                                     || item.title;</span>
<a href="#l5.380"></a><span id="l5.380" class="difflineminus">-      item.author = getRDFTargetValue(ds, itemResource, DC_CREATOR)</span>
<a href="#l5.381"></a><span id="l5.381" class="difflineminus">-                                      || getRDFTargetValue(ds, channel, DC_CREATOR)</span>
<a href="#l5.382"></a><span id="l5.382" class="difflineminus">-                                      || aFeed.title</span>
<a href="#l5.383"></a><span id="l5.383" class="difflineminus">-                                      || item.author;</span>
<a href="#l5.384"></a><span id="l5.384" class="difflineminus">-      </span>
<a href="#l5.385"></a><span id="l5.385" class="difflineminus">-      item.date = getRDFTargetValue(ds, itemResource, DC_DATE) || item.date;</span>
<a href="#l5.386"></a><span id="l5.386" class="difflineminus">-      item.content = getRDFTargetValue(ds, itemResource, RSS_CONTENT_ENCODED);</span>
<a href="#l5.387"></a><span id="l5.387" class="difflineplus">+      item.description = this.getRDFTargetValue(ds, itemResource,</span>
<a href="#l5.388"></a><span id="l5.388" class="difflineplus">+                                                FeedUtils.RSS_DESCRIPTION);</span>
<a href="#l5.389"></a><span id="l5.389" class="difflineplus">+      item.title = this.getRDFTargetValue(ds, itemResource, FeedUtils.RSS_TITLE) ||</span>
<a href="#l5.390"></a><span id="l5.390" class="difflineplus">+                   this.getRDFTargetValue(ds, itemResource, FeedUtils.DC_SUBJECT) ||</span>
<a href="#l5.391"></a><span id="l5.391" class="difflineplus">+                   (item.description ?</span>
<a href="#l5.392"></a><span id="l5.392" class="difflineplus">+                     (this.stripTags(item.description).substr(0, 150)) : null) ||</span>
<a href="#l5.393"></a><span id="l5.393" class="difflineplus">+                   item.title;</span>
<a href="#l5.394"></a><span id="l5.394" class="difflineplus">+      item.author = this.getRDFTargetValue(ds, itemResource, FeedUtils.DC_CREATOR) ||</span>
<a href="#l5.395"></a><span id="l5.395" class="difflineplus">+                    this.getRDFTargetValue(ds, channel, FeedUtils.DC_CREATOR) ||</span>
<a href="#l5.396"></a><span id="l5.396" class="difflineplus">+                    aFeed.title ||</span>
<a href="#l5.397"></a><span id="l5.397" class="difflineplus">+                    item.author;</span>
<a href="#l5.398"></a><span id="l5.398" class="difflineplus">+      item.date = this.getRDFTargetValue(ds, itemResource, FeedUtils.DC_DATE) ||</span>
<a href="#l5.399"></a><span id="l5.399" class="difflineplus">+                  item.date;</span>
<a href="#l5.400"></a><span id="l5.400" class="difflineplus">+      item.content = this.getRDFTargetValue(ds, itemResource,</span>
<a href="#l5.401"></a><span id="l5.401" class="difflineplus">+                                            FeedUtils.RSS_CONTENT_ENCODED);</span>
<a href="#l5.402"></a><span id="l5.402"> </span>
<a href="#l5.403"></a><span id="l5.403">       parsedItems[index++] = item;</span>
<a href="#l5.404"></a><span id="l5.404">     }</span>
<a href="#l5.405"></a><span id="l5.405" class="difflineminus">-  </span>
<a href="#l5.406"></a><span id="l5.406" class="difflineplus">+    FeedUtils.log.debug(&quot;FeedParser.parseAsRSS1: items parsed - &quot; + index);</span>
<a href="#l5.407"></a><span id="l5.407" class="difflineplus">+</span>
<a href="#l5.408"></a><span id="l5.408">     return parsedItems;</span>
<a href="#l5.409"></a><span id="l5.409">   },</span>
<a href="#l5.410"></a><span id="l5.410"> </span>
<a href="#l5.411"></a><span id="l5.411" class="difflineminus">-  parseAsAtom: function(aFeed, aDOM) </span>
<a href="#l5.412"></a><span id="l5.412" class="difflineplus">+  parseAsAtom: function(aFeed, aDOM)</span>
<a href="#l5.413"></a><span id="l5.413">   {</span>
<a href="#l5.414"></a><span id="l5.414" class="difflineminus">-    var parsedItems = new Array();</span>
<a href="#l5.415"></a><span id="l5.415" class="difflineplus">+    let parsedItems = new Array();</span>
<a href="#l5.416"></a><span id="l5.416"> </span>
<a href="#l5.417"></a><span id="l5.417">     // Get the first channel (assuming there is only one per Atom File).</span>
<a href="#l5.418"></a><span id="l5.418" class="difflineminus">-    var channel = aDOM.getElementsByTagName(&quot;feed&quot;)[0];</span>
<a href="#l5.419"></a><span id="l5.419" class="difflineplus">+    let channel = aDOM.getElementsByTagName(&quot;feed&quot;)[0];</span>
<a href="#l5.420"></a><span id="l5.420">     if (!channel)</span>
<a href="#l5.421"></a><span id="l5.421">     {</span>
<a href="#l5.422"></a><span id="l5.422">       aFeed.onParseError(aFeed);</span>
<a href="#l5.423"></a><span id="l5.423">       return parsedItems;</span>
<a href="#l5.424"></a><span id="l5.424">     }</span>
<a href="#l5.425"></a><span id="l5.425"> </span>
<a href="#l5.426"></a><span id="l5.426" class="difflineminus">-    aFeed.title = aFeed.title || this.stripTags(getNodeValue(this.childrenByTagNameNS(channel, ATOM_03_NS, &quot;title&quot;)[0]));</span>
<a href="#l5.427"></a><span id="l5.427" class="difflineminus">-    aFeed.description = getNodeValue(this.childrenByTagNameNS(channel, ATOM_03_NS, &quot;tagline&quot;)[0]);</span>
<a href="#l5.428"></a><span id="l5.428" class="difflineminus">-    aFeed.link = this.findAtomLink(&quot;alternate&quot;,this.childrenByTagNameNS(channel, ATOM_03_NS, &quot;link&quot;));</span>
<a href="#l5.429"></a><span id="l5.429" class="difflineplus">+    let tags = this.childrenByTagNameNS(channel, FeedUtils.ATOM_03_NS, &quot;title&quot;);</span>
<a href="#l5.430"></a><span id="l5.430" class="difflineplus">+    aFeed.title = aFeed.title ||</span>
<a href="#l5.431"></a><span id="l5.431" class="difflineplus">+                  this.stripTags(this.getNodeValue(tags ? tags[0] : null));</span>
<a href="#l5.432"></a><span id="l5.432" class="difflineplus">+    tags = this.childrenByTagNameNS(channel, FeedUtils.ATOM_03_NS, &quot;tagline&quot;);</span>
<a href="#l5.433"></a><span id="l5.433" class="difflineplus">+    aFeed.description = this.getNodeValue(tags ? tags[0] : null);</span>
<a href="#l5.434"></a><span id="l5.434" class="difflineplus">+    tags = this.childrenByTagNameNS(channel, FeedUtils.ATOM_03_NS, &quot;link&quot;);</span>
<a href="#l5.435"></a><span id="l5.435" class="difflineplus">+    aFeed.link = this.findAtomLink(&quot;alternate&quot;, tags);</span>
<a href="#l5.436"></a><span id="l5.436"> </span>
<a href="#l5.437"></a><span id="l5.437">     if (!aFeed.parseItems)</span>
<a href="#l5.438"></a><span id="l5.438">       return parsedItems;</span>
<a href="#l5.439"></a><span id="l5.439"> </span>
<a href="#l5.440"></a><span id="l5.440">     aFeed.invalidateItems();</span>
<a href="#l5.441"></a><span id="l5.441" class="difflineminus">-    var items = this.childrenByTagNameNS(channel, ATOM_03_NS, &quot;entry&quot;);</span>
<a href="#l5.442"></a><span id="l5.442" class="difflineminus">-    debug(&quot;Items to parse: &quot; + items.length);</span>
<a href="#l5.443"></a><span id="l5.443" class="difflineminus">-  </span>
<a href="#l5.444"></a><span id="l5.444" class="difflineminus">-    for (var i=0; i &lt; items.length; i++) </span>
<a href="#l5.445"></a><span id="l5.445" class="difflineplus">+    let items = this.childrenByTagNameNS(channel, FeedUtils.ATOM_03_NS, &quot;entry&quot;);</span>
<a href="#l5.446"></a><span id="l5.446" class="difflineplus">+    FeedUtils.log.debug(&quot;FeedParser.parseAsAtom: items to parse - &quot; +</span>
<a href="#l5.447"></a><span id="l5.447" class="difflineplus">+                        items.length);</span>
<a href="#l5.448"></a><span id="l5.448" class="difflineplus">+</span>
<a href="#l5.449"></a><span id="l5.449" class="difflineplus">+    for (let i = 0; i &lt; items.length; i++)</span>
<a href="#l5.450"></a><span id="l5.450">     {</span>
<a href="#l5.451"></a><span id="l5.451" class="difflineminus">-      var itemNode = items[i];</span>
<a href="#l5.452"></a><span id="l5.452" class="difflineminus">-      var item = new FeedItem();</span>
<a href="#l5.453"></a><span id="l5.453" class="difflineplus">+      let itemNode = items[i];</span>
<a href="#l5.454"></a><span id="l5.454" class="difflineplus">+      let item = new FeedItem();</span>
<a href="#l5.455"></a><span id="l5.455">       item.feed = aFeed;</span>
<a href="#l5.456"></a><span id="l5.456">       item.characterSet = &quot;UTF-8&quot;;</span>
<a href="#l5.457"></a><span id="l5.457"> </span>
<a href="#l5.458"></a><span id="l5.458" class="difflineminus">-      var url;</span>
<a href="#l5.459"></a><span id="l5.459" class="difflineminus">-      url = this.findAtomLink(&quot;alternate&quot;,this.childrenByTagNameNS(itemNode, ATOM_03_NS, &quot;link&quot;));</span>
<a href="#l5.460"></a><span id="l5.460" class="difflineplus">+      tags = this.childrenByTagNameNS(itemNode, FeedUtils.ATOM_03_NS, &quot;link&quot;);</span>
<a href="#l5.461"></a><span id="l5.461" class="difflineplus">+      item.url = this.findAtomLink(&quot;alternate&quot;, tags);</span>
<a href="#l5.462"></a><span id="l5.462"> </span>
<a href="#l5.463"></a><span id="l5.463" class="difflineminus">-      item.url = url;</span>
<a href="#l5.464"></a><span id="l5.464" class="difflineminus">-      item.id = getNodeValue(this.childrenByTagNameNS(itemNode, ATOM_03_NS, &quot;id&quot;)[0]);</span>
<a href="#l5.465"></a><span id="l5.465" class="difflineminus">-      item.description = getNodeValue(this.childrenByTagNameNS(itemNode, ATOM_03_NS, &quot;summary&quot;)[0]);</span>
<a href="#l5.466"></a><span id="l5.466" class="difflineminus">-      item.title = getNodeValue(this.childrenByTagNameNS(itemNode, ATOM_03_NS, &quot;title&quot;)[0])</span>
<a href="#l5.467"></a><span id="l5.467" class="difflineminus">-                                || (item.description ? item.description.substr(0, 150) : null)</span>
<a href="#l5.468"></a><span id="l5.468" class="difflineminus">-                                || item.title;</span>
<a href="#l5.469"></a><span id="l5.469" class="difflineplus">+      tags = this.childrenByTagNameNS(itemNode, FeedUtils.ATOM_03_NS, &quot;id&quot;);</span>
<a href="#l5.470"></a><span id="l5.470" class="difflineplus">+      item.id = this.getNodeValue(tags ? tags[0] : null);</span>
<a href="#l5.471"></a><span id="l5.471" class="difflineplus">+      tags = this.childrenByTagNameNS(itemNode, FeedUtils.ATOM_03_NS, &quot;summary&quot;);</span>
<a href="#l5.472"></a><span id="l5.472" class="difflineplus">+      item.description = this.getNodeValue(tags ? tags[0] : null);</span>
<a href="#l5.473"></a><span id="l5.473" class="difflineplus">+      tags = this.childrenByTagNameNS(itemNode, FeedUtils.ATOM_03_NS, &quot;title&quot;);</span>
<a href="#l5.474"></a><span id="l5.474" class="difflineplus">+      item.title = this.getNodeValue(tags ? tags[0] : null) ||</span>
<a href="#l5.475"></a><span id="l5.475" class="difflineplus">+                   (item.description ? item.description.substr(0, 150) : null) ||</span>
<a href="#l5.476"></a><span id="l5.476" class="difflineplus">+                   item.title;</span>
<a href="#l5.477"></a><span id="l5.477"> </span>
<a href="#l5.478"></a><span id="l5.478" class="difflineminus">-      var authorEl = this.childrenByTagNameNS(itemNode, ATOM_03_NS, &quot;author&quot;)[0]</span>
<a href="#l5.479"></a><span id="l5.479" class="difflineminus">-                     || this.childrenByTagNameNS(itemNode, ATOM_03_NS, &quot;contributor&quot;)[0]</span>
<a href="#l5.480"></a><span id="l5.480" class="difflineminus">-                     || this.childrenByTagNameNS(channel, ATOM_03_NS, &quot;author&quot;)[0];</span>
<a href="#l5.481"></a><span id="l5.481" class="difflineminus">-      var author = &quot;&quot;;</span>
<a href="#l5.482"></a><span id="l5.482" class="difflineplus">+      tags = this.childrenByTagNameNS(itemNode, FeedUtils.ATOM_03_NS, &quot;author&quot;);</span>
<a href="#l5.483"></a><span id="l5.483" class="difflineplus">+      if (!tags)</span>
<a href="#l5.484"></a><span id="l5.484" class="difflineplus">+        tags = this.childrenByTagNameNS(itemNode, FeedUtils.ATOM_03_NS, &quot;contributor&quot;);</span>
<a href="#l5.485"></a><span id="l5.485" class="difflineplus">+      if (!tags)</span>
<a href="#l5.486"></a><span id="l5.486" class="difflineplus">+        tags = this.childrenByTagNameNS(channel, FeedUtils.ATOM_03_NS, &quot;author&quot;);</span>
<a href="#l5.487"></a><span id="l5.487" class="difflineplus">+</span>
<a href="#l5.488"></a><span id="l5.488" class="difflineplus">+      let authorEl = tags ? tags[0] : null;</span>
<a href="#l5.489"></a><span id="l5.489"> </span>
<a href="#l5.490"></a><span id="l5.490" class="difflineminus">-      if (authorEl) </span>
<a href="#l5.491"></a><span id="l5.491" class="difflineplus">+      let author = &quot;&quot;;</span>
<a href="#l5.492"></a><span id="l5.492" class="difflineplus">+      if (authorEl)</span>
<a href="#l5.493"></a><span id="l5.493">       {</span>
<a href="#l5.494"></a><span id="l5.494" class="difflineminus">-        var name = getNodeValue(this.childrenByTagNameNS(authorEl, ATOM_03_NS, &quot;name&quot;)[0]);</span>
<a href="#l5.495"></a><span id="l5.495" class="difflineminus">-        var email = getNodeValue(this.childrenByTagNameNS(authorEl, ATOM_03_NS, &quot;email&quot;)[0]);</span>
<a href="#l5.496"></a><span id="l5.496" class="difflineplus">+        tags = this.childrenByTagNameNS(authorEl, FeedUtils.ATOM_03_NS, &quot;name&quot;);</span>
<a href="#l5.497"></a><span id="l5.497" class="difflineplus">+        let name = this.getNodeValue(tags ? tags[0] : null);</span>
<a href="#l5.498"></a><span id="l5.498" class="difflineplus">+        tags = this.childrenByTagNameNS(authorEl, FeedUtils.ATOM_03_NS, &quot;email&quot;);</span>
<a href="#l5.499"></a><span id="l5.499" class="difflineplus">+        let email = this.getNodeValue(tags ? tags[0] : null);</span>
<a href="#l5.500"></a><span id="l5.500">         if (name)</span>
<a href="#l5.501"></a><span id="l5.501">           author = name + (email ? &quot; &lt;&quot; + email + &quot;&gt;&quot; : &quot;&quot;);</span>
<a href="#l5.502"></a><span id="l5.502">         else if (email)</span>
<a href="#l5.503"></a><span id="l5.503">           author = email;</span>
<a href="#l5.504"></a><span id="l5.504">       }</span>
<a href="#l5.505"></a><span id="l5.505" class="difflineminus">-      </span>
<a href="#l5.506"></a><span id="l5.506" class="difflineplus">+</span>
<a href="#l5.507"></a><span id="l5.507">       item.author = author || item.author || aFeed.title;</span>
<a href="#l5.508"></a><span id="l5.508"> </span>
<a href="#l5.509"></a><span id="l5.509" class="difflineminus">-      item.date = getNodeValue(this.childrenByTagNameNS(itemNode, ATOM_03_NS, &quot;modified&quot;)[0]</span>
<a href="#l5.510"></a><span id="l5.510" class="difflineminus">-                               || this.childrenByTagNameNS(itemNode, ATOM_03_NS, &quot;issued&quot;)[0]</span>
<a href="#l5.511"></a><span id="l5.511" class="difflineminus">-                               || this.childrenByTagNameNS(itemNode, ATOM_03_NS, &quot;created&quot;)[0])</span>
<a href="#l5.512"></a><span id="l5.512" class="difflineminus">-                               || item.date;</span>
<a href="#l5.513"></a><span id="l5.513" class="difflineplus">+      tags = this.childrenByTagNameNS(itemNode, FeedUtils.ATOM_03_NS, &quot;modified&quot;);</span>
<a href="#l5.514"></a><span id="l5.514" class="difflineplus">+      if (!tags)</span>
<a href="#l5.515"></a><span id="l5.515" class="difflineplus">+        tags = this.childrenByTagNameNS(itemNode, FeedUtils.ATOM_03_NS, &quot;issued&quot;);</span>
<a href="#l5.516"></a><span id="l5.516" class="difflineplus">+      if (!tags)</span>
<a href="#l5.517"></a><span id="l5.517" class="difflineplus">+        tags = this.childrenByTagNameNS(channel, FeedUtils.ATOM_03_NS, &quot;created&quot;);</span>
<a href="#l5.518"></a><span id="l5.518" class="difflineplus">+</span>
<a href="#l5.519"></a><span id="l5.519" class="difflineplus">+      item.date = this.getNodeValue(tags ? tags[0] : null) || item.date;</span>
<a href="#l5.520"></a><span id="l5.520"> </span>
<a href="#l5.521"></a><span id="l5.521">       // XXX We should get the xml:base attribute from the content tag as well</span>
<a href="#l5.522"></a><span id="l5.522">       // and use it as the base HREF of the message.</span>
<a href="#l5.523"></a><span id="l5.523">       // XXX Atom feeds can have multiple content elements; we should differentiate</span>
<a href="#l5.524"></a><span id="l5.524">       // between them and pick the best one.</span>
<a href="#l5.525"></a><span id="l5.525">       // Some Atom feeds wrap the content in a CTYPE declaration; others use</span>
<a href="#l5.526"></a><span id="l5.526">       // a namespace to identify the tags as HTML; and a few are buggy and put</span>
<a href="#l5.527"></a><span id="l5.527">       // HTML tags in without declaring their namespace so they look like Atom.</span>
<a href="#l5.528"></a><span id="l5.528">       // We deal with the first two but not the third.</span>
<a href="#l5.529"></a><span id="l5.529" class="difflineminus">-      </span>
<a href="#l5.530"></a><span id="l5.530" class="difflineminus">-      var content;</span>
<a href="#l5.531"></a><span id="l5.531" class="difflineminus">-      var contentNode = this.childrenByTagNameNS(itemNode, ATOM_03_NS, &quot;content&quot;)[0];</span>
<a href="#l5.532"></a><span id="l5.532" class="difflineminus">-      if (contentNode) </span>
<a href="#l5.533"></a><span id="l5.533" class="difflineplus">+      tags = this.childrenByTagNameNS(itemNode, FeedUtils.ATOM_03_NS, &quot;content&quot;);</span>
<a href="#l5.534"></a><span id="l5.534" class="difflineplus">+      let contentNode = tags ? tags[0] : null;</span>
<a href="#l5.535"></a><span id="l5.535" class="difflineplus">+</span>
<a href="#l5.536"></a><span id="l5.536" class="difflineplus">+      let content;</span>
<a href="#l5.537"></a><span id="l5.537" class="difflineplus">+      if (contentNode)</span>
<a href="#l5.538"></a><span id="l5.538">       {</span>
<a href="#l5.539"></a><span id="l5.539">         content = &quot;&quot;;</span>
<a href="#l5.540"></a><span id="l5.540" class="difflineminus">-        for (var j=0; j &lt; contentNode.childNodes.length; j++) </span>
<a href="#l5.541"></a><span id="l5.541" class="difflineplus">+        for (let j = 0; j &lt; contentNode.childNodes.length; j++)</span>
<a href="#l5.542"></a><span id="l5.542">         {</span>
<a href="#l5.543"></a><span id="l5.543" class="difflineminus">-          var node = contentNode.childNodes.item(j);</span>
<a href="#l5.544"></a><span id="l5.544" class="difflineplus">+          let node = contentNode.childNodes.item(j);</span>
<a href="#l5.545"></a><span id="l5.545">           if (node.nodeType == node.CDATA_SECTION_NODE)</span>
<a href="#l5.546"></a><span id="l5.546">             content += node.data;</span>
<a href="#l5.547"></a><span id="l5.547">           else</span>
<a href="#l5.548"></a><span id="l5.548" class="difflineminus">-            content += serializer.serializeToString(node);</span>
<a href="#l5.549"></a><span id="l5.549" class="difflineplus">+            content += this.mSerializer.serializeToString(node);</span>
<a href="#l5.550"></a><span id="l5.550">         }</span>
<a href="#l5.551"></a><span id="l5.551">       </span>
<a href="#l5.552"></a><span id="l5.552" class="difflineminus">-        if (contentNode.getAttribute('mode') == &quot;escaped&quot;) </span>
<a href="#l5.553"></a><span id="l5.553" class="difflineplus">+        if (contentNode.getAttribute(&quot;mode&quot;) == &quot;escaped&quot;)</span>
<a href="#l5.554"></a><span id="l5.554">         {</span>
<a href="#l5.555"></a><span id="l5.555">           content = content.replace(/&amp;lt;/g, &quot;&lt;&quot;);</span>
<a href="#l5.556"></a><span id="l5.556">           content = content.replace(/&amp;gt;/g, &quot;&gt;&quot;);</span>
<a href="#l5.557"></a><span id="l5.557">           content = content.replace(/&amp;amp;/g, &quot;&amp;&quot;);</span>
<a href="#l5.558"></a><span id="l5.558">         }</span>
<a href="#l5.559"></a><span id="l5.559" class="difflineminus">-      </span>
<a href="#l5.560"></a><span id="l5.560" class="difflineplus">+</span>
<a href="#l5.561"></a><span id="l5.561">         if (content == &quot;&quot;)</span>
<a href="#l5.562"></a><span id="l5.562">           content = null;</span>
<a href="#l5.563"></a><span id="l5.563">       }</span>
<a href="#l5.564"></a><span id="l5.564" class="difflineminus">-      </span>
<a href="#l5.565"></a><span id="l5.565" class="difflineplus">+</span>
<a href="#l5.566"></a><span id="l5.566">       item.content = content;</span>
<a href="#l5.567"></a><span id="l5.567">       parsedItems[i] = item;</span>
<a href="#l5.568"></a><span id="l5.568">     }</span>
<a href="#l5.569"></a><span id="l5.569" class="difflineplus">+</span>
<a href="#l5.570"></a><span id="l5.570">     return parsedItems;</span>
<a href="#l5.571"></a><span id="l5.571">   },</span>
<a href="#l5.572"></a><span id="l5.572"> </span>
<a href="#l5.573"></a><span id="l5.573">   parseAsAtomIETF: function(aFeed, aDOM)</span>
<a href="#l5.574"></a><span id="l5.574">   {</span>
<a href="#l5.575"></a><span id="l5.575" class="difflineminus">-    </span>
<a href="#l5.576"></a><span id="l5.576" class="difflineminus">-    var parsedItems = new Array();</span>
<a href="#l5.577"></a><span id="l5.577" class="difflineplus">+    let parsedItems = new Array();</span>
<a href="#l5.578"></a><span id="l5.578"> </span>
<a href="#l5.579"></a><span id="l5.579">     // Get the first channel (assuming there is only one per Atom File).</span>
<a href="#l5.580"></a><span id="l5.580" class="difflineminus">-    var channel = this.childrenByTagNameNS(aDOM,ATOM_IETF_NS,&quot;feed&quot;)[0];</span>
<a href="#l5.581"></a><span id="l5.581" class="difflineplus">+    let channel = this.childrenByTagNameNS(aDOM, FeedUtils.ATOM_IETF_NS, &quot;feed&quot;)[0];</span>
<a href="#l5.582"></a><span id="l5.582">     if (!channel)</span>
<a href="#l5.583"></a><span id="l5.583">     {</span>
<a href="#l5.584"></a><span id="l5.584">       aFeed.onParseError(aFeed);</span>
<a href="#l5.585"></a><span id="l5.585">       return parsedItems;</span>
<a href="#l5.586"></a><span id="l5.586">     }</span>
<a href="#l5.587"></a><span id="l5.587"> </span>
<a href="#l5.588"></a><span id="l5.588" class="difflineminus">-    aFeed.title = aFeed.title || this.stripTags(this.serializeTextConstruct(this.childrenByTagNameNS(channel,ATOM_IETF_NS,&quot;title&quot;)[0]));</span>
<a href="#l5.589"></a><span id="l5.589" class="difflineminus">-    aFeed.description = this.serializeTextConstruct(this.childrenByTagNameNS(channel,ATOM_IETF_NS,&quot;subtitle&quot;)[0]);</span>
<a href="#l5.590"></a><span id="l5.590" class="difflineminus">-    aFeed.link = this.findAtomLink(&quot;alternate&quot;, this.childrenByTagNameNS(channel,ATOM_IETF_NS,&quot;link&quot;));</span>
<a href="#l5.591"></a><span id="l5.591" class="difflineminus">-    </span>
<a href="#l5.592"></a><span id="l5.592" class="difflineplus">+    let tags = this.childrenByTagNameNS(channel, FeedUtils.ATOM_IETF_NS, &quot;title&quot;);</span>
<a href="#l5.593"></a><span id="l5.593" class="difflineplus">+    aFeed.title = aFeed.title ||</span>
<a href="#l5.594"></a><span id="l5.594" class="difflineplus">+                  this.stripTags(this.serializeTextConstruct(tags ? tags[0] : null));</span>
<a href="#l5.595"></a><span id="l5.595" class="difflineplus">+</span>
<a href="#l5.596"></a><span id="l5.596" class="difflineplus">+    tags = this.childrenByTagNameNS(channel, FeedUtils.ATOM_IETF_NS, &quot;subtitle&quot;);</span>
<a href="#l5.597"></a><span id="l5.597" class="difflineplus">+    aFeed.description = this.serializeTextConstruct(tags ? tags[0] : null);</span>
<a href="#l5.598"></a><span id="l5.598" class="difflineplus">+</span>
<a href="#l5.599"></a><span id="l5.599" class="difflineplus">+    tags = this.childrenByTagNameNS(channel, FeedUtils.ATOM_IETF_NS, &quot;link&quot;);</span>
<a href="#l5.600"></a><span id="l5.600" class="difflineplus">+    aFeed.link = this.findAtomLink(&quot;alternate&quot;, tags);</span>
<a href="#l5.601"></a><span id="l5.601" class="difflineplus">+</span>
<a href="#l5.602"></a><span id="l5.602">     if (!aFeed.parseItems)</span>
<a href="#l5.603"></a><span id="l5.603">       return parsedItems;</span>
<a href="#l5.604"></a><span id="l5.604"> </span>
<a href="#l5.605"></a><span id="l5.605">     aFeed.invalidateItems();</span>
<a href="#l5.606"></a><span id="l5.606" class="difflineminus">-    var items = this.childrenByTagNameNS(channel,ATOM_IETF_NS,&quot;entry&quot;);</span>
<a href="#l5.607"></a><span id="l5.607" class="difflineminus">-    debug(&quot;Items to parse: &quot; + items.length);</span>
<a href="#l5.608"></a><span id="l5.608" class="difflineplus">+    let items = this.childrenByTagNameNS(channel, FeedUtils.ATOM_IETF_NS, &quot;entry&quot;);</span>
<a href="#l5.609"></a><span id="l5.609" class="difflineplus">+    FeedUtils.log.debug(&quot;FeedParser.parseAsAtomIETF: items to parse - &quot; +</span>
<a href="#l5.610"></a><span id="l5.610" class="difflineplus">+                        items.length);</span>
<a href="#l5.611"></a><span id="l5.611"> </span>
<a href="#l5.612"></a><span id="l5.612" class="difflineminus">-    for (var i=0; i &lt; items.length; i++) </span>
<a href="#l5.613"></a><span id="l5.613" class="difflineplus">+    for (let i = 0; i &lt; items.length; i++)</span>
<a href="#l5.614"></a><span id="l5.614">     {</span>
<a href="#l5.615"></a><span id="l5.615" class="difflineminus">-      var itemNode = items[i];</span>
<a href="#l5.616"></a><span id="l5.616" class="difflineminus">-      var item = new FeedItem();</span>
<a href="#l5.617"></a><span id="l5.617" class="difflineplus">+      let itemNode = items[i];</span>
<a href="#l5.618"></a><span id="l5.618" class="difflineplus">+      let item = new FeedItem();</span>
<a href="#l5.619"></a><span id="l5.619">       item.feed = aFeed;</span>
<a href="#l5.620"></a><span id="l5.620">       item.characterSet = &quot;UTF-8&quot;;</span>
<a href="#l5.621"></a><span id="l5.621">       item.isStoredWithId = true;</span>
<a href="#l5.622"></a><span id="l5.622" class="difflineminus">-      item.url = this.findAtomLink(&quot;alternate&quot;, this.childrenByTagNameNS(itemNode, ATOM_IETF_NS, &quot;link&quot;)) || aFeed.link;</span>
<a href="#l5.623"></a><span id="l5.623" class="difflineminus">-      item.id = getNodeValue(this.childrenByTagNameNS(itemNode, ATOM_IETF_NS, &quot;id&quot;)[0]);</span>
<a href="#l5.624"></a><span id="l5.624" class="difflineminus">-      item.description = this.serializeTextConstruct(this.childrenByTagNameNS(itemNode, ATOM_IETF_NS, &quot;summary&quot;)[0]);</span>
<a href="#l5.625"></a><span id="l5.625" class="difflineminus">-      item.title = this.stripTags(this.serializeTextConstruct(this.childrenByTagNameNS(itemNode, ATOM_IETF_NS, &quot;title&quot;)[0])</span>
<a href="#l5.626"></a><span id="l5.626" class="difflineminus">-                                  || (item.description ? item.description.substr(0, 150) : null)</span>
<a href="#l5.627"></a><span id="l5.627" class="difflineminus">-                                  || item.title);</span>
<a href="#l5.628"></a><span id="l5.628" class="difflineminus">-      </span>
<a href="#l5.629"></a><span id="l5.629" class="difflineminus">-      // XXX Support multiple authors</span>
<a href="#l5.630"></a><span id="l5.630" class="difflineminus">-      var source = this.childrenByTagNameNS(itemNode, ATOM_IETF_NS, &quot;source&quot;)[0];</span>
<a href="#l5.631"></a><span id="l5.631" class="difflineminus">-      var authorEl = this.childrenByTagNameNS(itemNode, ATOM_IETF_NS, &quot;author&quot;)[0]</span>
<a href="#l5.632"></a><span id="l5.632" class="difflineminus">-                           || (source ? this.childrenByTagNameNS(source, ATOM_IETF_NS, &quot;author&quot;)[0] : null)</span>
<a href="#l5.633"></a><span id="l5.633" class="difflineminus">-                           || this.childrenByTagNameNS(channel, ATOM_IETF_NS, &quot;author&quot;)[0];</span>
<a href="#l5.634"></a><span id="l5.634" class="difflineminus">-      var author = &quot;&quot;;</span>
<a href="#l5.635"></a><span id="l5.635" class="difflineplus">+</span>
<a href="#l5.636"></a><span id="l5.636" class="difflineplus">+      tags = this.childrenByTagNameNS(itemNode, FeedUtils.ATOM_IETF_NS, &quot;link&quot;);</span>
<a href="#l5.637"></a><span id="l5.637" class="difflineplus">+      item.url = this.findAtomLink(&quot;alternate&quot;, tags) || aFeed.link;</span>
<a href="#l5.638"></a><span id="l5.638" class="difflineplus">+      tags = this.childrenByTagNameNS(itemNode, FeedUtils.ATOM_IETF_NS, &quot;id&quot;);</span>
<a href="#l5.639"></a><span id="l5.639" class="difflineplus">+      item.id = this.getNodeValue(tags ? tags[0] : null);</span>
<a href="#l5.640"></a><span id="l5.640" class="difflineplus">+      tags = this.childrenByTagNameNS(itemNode, FeedUtils.ATOM_IETF_NS, &quot;summary&quot;);</span>
<a href="#l5.641"></a><span id="l5.641" class="difflineplus">+      item.description = this.serializeTextConstruct(tags ? tags[0] : null);</span>
<a href="#l5.642"></a><span id="l5.642" class="difflineplus">+      tags = this.childrenByTagNameNS(itemNode, FeedUtils.ATOM_IETF_NS, &quot;title&quot;);</span>
<a href="#l5.643"></a><span id="l5.643" class="difflineplus">+      item.title = this.stripTags(this.serializeTextConstruct(tags ? tags[0] : null) ||</span>
<a href="#l5.644"></a><span id="l5.644" class="difflineplus">+                                  (item.description ?</span>
<a href="#l5.645"></a><span id="l5.645" class="difflineplus">+                                     item.description.substr(0, 150) : null) ||</span>
<a href="#l5.646"></a><span id="l5.646" class="difflineplus">+                                  item.title);</span>
<a href="#l5.647"></a><span id="l5.647"> </span>
<a href="#l5.648"></a><span id="l5.648" class="difflineminus">-      if (authorEl) </span>
<a href="#l5.649"></a><span id="l5.649" class="difflineplus">+      // XXX Support multiple authors.</span>
<a href="#l5.650"></a><span id="l5.650" class="difflineplus">+      tags = this.childrenByTagNameNS(itemNode, FeedUtils.ATOM_IETF_NS, &quot;source&quot;);</span>
<a href="#l5.651"></a><span id="l5.651" class="difflineplus">+      let source = tags ? tags[0] : null;</span>
<a href="#l5.652"></a><span id="l5.652" class="difflineplus">+</span>
<a href="#l5.653"></a><span id="l5.653" class="difflineplus">+      tags = this.childrenByTagNameNS(itemNode, FeedUtils.ATOM_IETF_NS, &quot;author&quot;);</span>
<a href="#l5.654"></a><span id="l5.654" class="difflineplus">+      if (!tags &amp;&amp; source)</span>
<a href="#l5.655"></a><span id="l5.655" class="difflineplus">+        tags = this.childrenByTagNameNS(source, FeedUtils.ATOM_IETF_NS, &quot;author&quot;);</span>
<a href="#l5.656"></a><span id="l5.656" class="difflineplus">+      if (!tags)</span>
<a href="#l5.657"></a><span id="l5.657" class="difflineplus">+        tags = this.childrenByTagNameNS(channel, FeedUtils.ATOM_IETF_NS, &quot;author&quot;);</span>
<a href="#l5.658"></a><span id="l5.658" class="difflineplus">+</span>
<a href="#l5.659"></a><span id="l5.659" class="difflineplus">+      let authorEl = tags ? tags[0] : null;</span>
<a href="#l5.660"></a><span id="l5.660" class="difflineplus">+</span>
<a href="#l5.661"></a><span id="l5.661" class="difflineplus">+      let author = &quot;&quot;;</span>
<a href="#l5.662"></a><span id="l5.662" class="difflineplus">+      if (authorEl)</span>
<a href="#l5.663"></a><span id="l5.663">       {</span>
<a href="#l5.664"></a><span id="l5.664" class="difflineminus">-        var name = getNodeValue(this.childrenByTagNameNS(authorEl, ATOM_IETF_NS, &quot;name&quot;)[0]);</span>
<a href="#l5.665"></a><span id="l5.665" class="difflineminus">-        var email = getNodeValue(this.childrenByTagNameNS(authorEl, ATOM_IETF_NS, &quot;email&quot;)[0]);</span>
<a href="#l5.666"></a><span id="l5.666" class="difflineplus">+        tags = this.childrenByTagNameNS(authorEl, FeedUtils.ATOM_IETF_NS, &quot;name&quot;);</span>
<a href="#l5.667"></a><span id="l5.667" class="difflineplus">+        let name = this.getNodeValue(tags ? tags[0] : null);</span>
<a href="#l5.668"></a><span id="l5.668" class="difflineplus">+        tags = this.childrenByTagNameNS(authorEl, FeedUtils.ATOM_IETF_NS, &quot;email&quot;);</span>
<a href="#l5.669"></a><span id="l5.669" class="difflineplus">+        let email = this.getNodeValue(tags ? tags[0] : null);</span>
<a href="#l5.670"></a><span id="l5.670">         if (name)</span>
<a href="#l5.671"></a><span id="l5.671">           author = name + (email ? &quot; &lt;&quot; + email + &quot;&gt;&quot; : &quot;&quot;);</span>
<a href="#l5.672"></a><span id="l5.672">         else if (email)</span>
<a href="#l5.673"></a><span id="l5.673">           author = email;</span>
<a href="#l5.674"></a><span id="l5.674">       }</span>
<a href="#l5.675"></a><span id="l5.675" class="difflineminus">-      </span>
<a href="#l5.676"></a><span id="l5.676" class="difflineplus">+</span>
<a href="#l5.677"></a><span id="l5.677">       item.author = author || item.author || aFeed.title;</span>
<a href="#l5.678"></a><span id="l5.678" class="difflineminus">-      item.date = getNodeValue(this.childrenByTagNameNS(itemNode, ATOM_IETF_NS, &quot;updated&quot;)[0]</span>
<a href="#l5.679"></a><span id="l5.679" class="difflineminus">-                               || this.childrenByTagNameNS(itemNode, ATOM_IETF_NS, &quot;published&quot;)[0])</span>
<a href="#l5.680"></a><span id="l5.680" class="difflineminus">-                               || item.date;</span>
<a href="#l5.681"></a><span id="l5.681" class="difflineplus">+</span>
<a href="#l5.682"></a><span id="l5.682" class="difflineplus">+      tags = this.childrenByTagNameNS(itemNode, FeedUtils.ATOM_IETF_NS, &quot;updated&quot;);</span>
<a href="#l5.683"></a><span id="l5.683" class="difflineplus">+      if (!tags)</span>
<a href="#l5.684"></a><span id="l5.684" class="difflineplus">+        tags = this.childrenByTagNameNS(source, FeedUtils.ATOM_IETF_NS, &quot;published&quot;);</span>
<a href="#l5.685"></a><span id="l5.685" class="difflineplus">+      item.date = this.getNodeValue(tags ? tags[0] : null) || item.date;</span>
<a href="#l5.686"></a><span id="l5.686"> </span>
<a href="#l5.687"></a><span id="l5.687" class="difflineminus">-      item.content = this.serializeTextConstruct(this.childrenByTagNameNS(itemNode, ATOM_IETF_NS, &quot;content&quot;)[0]);</span>
<a href="#l5.688"></a><span id="l5.688" class="difflineplus">+      tags = this.childrenByTagNameNS(itemNode, FeedUtils.ATOM_IETF_NS, &quot;content&quot;);</span>
<a href="#l5.689"></a><span id="l5.689" class="difflineplus">+      item.content = this.serializeTextConstruct(tags ? tags[0] : null);</span>
<a href="#l5.690"></a><span id="l5.690"> </span>
<a href="#l5.691"></a><span id="l5.691" class="difflineminus">-      if(item.content)</span>
<a href="#l5.692"></a><span id="l5.692" class="difflineminus">-        item.xmlContentBase = this.childrenByTagNameNS(itemNode, ATOM_IETF_NS, &quot;content&quot;)[0].baseURI;</span>
<a href="#l5.693"></a><span id="l5.693" class="difflineminus">-      else if(item.description)</span>
<a href="#l5.694"></a><span id="l5.694" class="difflineminus">-        item.xmlContentBase = this.childrenByTagNameNS(itemNode, ATOM_IETF_NS, &quot;summary&quot;)[0].baseURI;</span>
<a href="#l5.695"></a><span id="l5.695" class="difflineplus">+      if (item.content)</span>
<a href="#l5.696"></a><span id="l5.696" class="difflineplus">+        item.xmlContentBase = tags ? tags[0].baseURI : null;</span>
<a href="#l5.697"></a><span id="l5.697" class="difflineplus">+      else if (item.description)</span>
<a href="#l5.698"></a><span id="l5.698" class="difflineplus">+      {</span>
<a href="#l5.699"></a><span id="l5.699" class="difflineplus">+        tags = this.childrenByTagNameNS(itemNode, FeedUtils.ATOM_IETF_NS, &quot;summary&quot;);</span>
<a href="#l5.700"></a><span id="l5.700" class="difflineplus">+        item.xmlContentBase = tags ? tags[0].baseURI : null;</span>
<a href="#l5.701"></a><span id="l5.701" class="difflineplus">+      }</span>
<a href="#l5.702"></a><span id="l5.702">       else</span>
<a href="#l5.703"></a><span id="l5.703">         item.xmlContentBase = itemNode.baseURI;</span>
<a href="#l5.704"></a><span id="l5.704"> </span>
<a href="#l5.705"></a><span id="l5.705">       parsedItems[i] = item;</span>
<a href="#l5.706"></a><span id="l5.706">     }</span>
<a href="#l5.707"></a><span id="l5.707"> </span>
<a href="#l5.708"></a><span id="l5.708">     return parsedItems;</span>
<a href="#l5.709"></a><span id="l5.709" class="difflineminus">-</span>
<a href="#l5.710"></a><span id="l5.710">   },</span>
<a href="#l5.711"></a><span id="l5.711"> </span>
<a href="#l5.712"></a><span id="l5.712">   serializeTextConstruct: function(textElement)</span>
<a href="#l5.713"></a><span id="l5.713">   {</span>
<a href="#l5.714"></a><span id="l5.714" class="difflineminus">-    var content = &quot;&quot;;</span>
<a href="#l5.715"></a><span id="l5.715" class="difflineminus">-</span>
<a href="#l5.716"></a><span id="l5.716" class="difflineminus">-    if (textElement) </span>
<a href="#l5.717"></a><span id="l5.717" class="difflineplus">+    let content = &quot;&quot;;</span>
<a href="#l5.718"></a><span id="l5.718" class="difflineplus">+    if (textElement)</span>
<a href="#l5.719"></a><span id="l5.719">     {</span>
<a href="#l5.720"></a><span id="l5.720" class="difflineminus">-      var textType = textElement.getAttribute('type');</span>
<a href="#l5.721"></a><span id="l5.721" class="difflineplus">+      let textType = textElement.getAttribute(&quot;type&quot;);</span>
<a href="#l5.722"></a><span id="l5.722"> </span>
<a href="#l5.723"></a><span id="l5.723" class="difflineminus">-      // Atom spec says consider it &quot;text&quot; if not present</span>
<a href="#l5.724"></a><span id="l5.724" class="difflineminus">-      if(!textType)</span>
<a href="#l5.725"></a><span id="l5.725" class="difflineplus">+      // Atom spec says consider it &quot;text&quot; if not present.</span>
<a href="#l5.726"></a><span id="l5.726" class="difflineplus">+      if (!textType)</span>
<a href="#l5.727"></a><span id="l5.727">         textType = &quot;text&quot;;</span>
<a href="#l5.728"></a><span id="l5.728"> </span>
<a href="#l5.729"></a><span id="l5.729" class="difflineminus">-      // There could be some strange content type we don't handle</span>
<a href="#l5.730"></a><span id="l5.730" class="difflineminus">-      if((textType != &quot;text&quot;) &amp;&amp; (textType != &quot;html&quot;) &amp;&amp; (textType != &quot;xhtml&quot;))</span>
<a href="#l5.731"></a><span id="l5.731" class="difflineplus">+      // There could be some strange content type we don't handle.</span>
<a href="#l5.732"></a><span id="l5.732" class="difflineplus">+      if (textType != &quot;text&quot; &amp;&amp; textType != &quot;html&quot; &amp;&amp; textType != &quot;xhtml&quot;)</span>
<a href="#l5.733"></a><span id="l5.733">         return null;</span>
<a href="#l5.734"></a><span id="l5.734"> </span>
<a href="#l5.735"></a><span id="l5.735" class="difflineminus">-      for (var j=0; j &lt; textElement.childNodes.length; j++) </span>
<a href="#l5.736"></a><span id="l5.736" class="difflineplus">+      for (let j = 0; j &lt; textElement.childNodes.length; j++)</span>
<a href="#l5.737"></a><span id="l5.737">       {</span>
<a href="#l5.738"></a><span id="l5.738" class="difflineminus">-        var node = textElement.childNodes.item(j);</span>
<a href="#l5.739"></a><span id="l5.739" class="difflineplus">+        let node = textElement.childNodes.item(j);</span>
<a href="#l5.740"></a><span id="l5.740">         if (node.nodeType == node.CDATA_SECTION_NODE)</span>
<a href="#l5.741"></a><span id="l5.741">           content += this.xmlEscape(node.data);</span>
<a href="#l5.742"></a><span id="l5.742">         else</span>
<a href="#l5.743"></a><span id="l5.743" class="difflineminus">-          content += serializer.serializeToString(node);</span>
<a href="#l5.744"></a><span id="l5.744" class="difflineplus">+          content += this.mSerializer.serializeToString(node);</span>
<a href="#l5.745"></a><span id="l5.745">       }</span>
<a href="#l5.746"></a><span id="l5.746" class="difflineminus">-      if (textType == &quot;html&quot;) </span>
<a href="#l5.747"></a><span id="l5.747" class="difflineplus">+</span>
<a href="#l5.748"></a><span id="l5.748" class="difflineplus">+      if (textType == &quot;html&quot;)</span>
<a href="#l5.749"></a><span id="l5.749">         content = this.xmlUnescape(content);</span>
<a href="#l5.750"></a><span id="l5.750">     }</span>
<a href="#l5.751"></a><span id="l5.751"> </span>
<a href="#l5.752"></a><span id="l5.752" class="difflineminus">-    // other parts of the code depend on this being null</span>
<a href="#l5.753"></a><span id="l5.753" class="difflineminus">-    // if there's no content</span>
<a href="#l5.754"></a><span id="l5.754" class="difflineplus">+    // Other parts of the code depend on this being null if there's no content.</span>
<a href="#l5.755"></a><span id="l5.755">     return content ? content : null;</span>
<a href="#l5.756"></a><span id="l5.756">   },</span>
<a href="#l5.757"></a><span id="l5.757"> </span>
<a href="#l5.758"></a><span id="l5.758" class="difflineminus">-  // finds elements that are direct children of the first arg</span>
<a href="#l5.759"></a><span id="l5.759" class="difflineplus">+  getRDFTargetValue: function(ds, source, property)</span>
<a href="#l5.760"></a><span id="l5.760" class="difflineplus">+  {</span>
<a href="#l5.761"></a><span id="l5.761" class="difflineplus">+    let node = ds.GetTarget(source, property, true);</span>
<a href="#l5.762"></a><span id="l5.762" class="difflineplus">+    if (node)</span>
<a href="#l5.763"></a><span id="l5.763" class="difflineplus">+    {</span>
<a href="#l5.764"></a><span id="l5.764" class="difflineplus">+      try</span>
<a href="#l5.765"></a><span id="l5.765" class="difflineplus">+      {</span>
<a href="#l5.766"></a><span id="l5.766" class="difflineplus">+        node = node.QueryInterface(Ci.nsIRDFLiteral);</span>
<a href="#l5.767"></a><span id="l5.767" class="difflineplus">+        if (node)</span>
<a href="#l5.768"></a><span id="l5.768" class="difflineplus">+          return node.Value;</span>
<a href="#l5.769"></a><span id="l5.769" class="difflineplus">+      }</span>
<a href="#l5.770"></a><span id="l5.770" class="difflineplus">+      catch (e)</span>
<a href="#l5.771"></a><span id="l5.771" class="difflineplus">+      {</span>
<a href="#l5.772"></a><span id="l5.772" class="difflineplus">+        // If the RDF was bogus, do nothing.  Rethrow if it's some other problem.</span>
<a href="#l5.773"></a><span id="l5.773" class="difflineplus">+        if (!((e instanceof Ci.nsIXPCException) &amp;&amp;</span>
<a href="#l5.774"></a><span id="l5.774" class="difflineplus">+              e.result == Cr.NS_ERROR_NO_INTERFACE))</span>
<a href="#l5.775"></a><span id="l5.775" class="difflineplus">+          throw new Error(&quot;FeedParser.getRDFTargetValue: &quot; + e);</span>
<a href="#l5.776"></a><span id="l5.776" class="difflineplus">+      }</span>
<a href="#l5.777"></a><span id="l5.777" class="difflineplus">+    }</span>
<a href="#l5.778"></a><span id="l5.778" class="difflineplus">+</span>
<a href="#l5.779"></a><span id="l5.779" class="difflineplus">+    return null;</span>
<a href="#l5.780"></a><span id="l5.780" class="difflineplus">+  },</span>
<a href="#l5.781"></a><span id="l5.781" class="difflineplus">+</span>
<a href="#l5.782"></a><span id="l5.782" class="difflineplus">+  getNodeValue: function(node)</span>
<a href="#l5.783"></a><span id="l5.783" class="difflineplus">+  {</span>
<a href="#l5.784"></a><span id="l5.784" class="difflineplus">+    if (node &amp;&amp; node.textContent)</span>
<a href="#l5.785"></a><span id="l5.785" class="difflineplus">+      return node.textContent.trim();</span>
<a href="#l5.786"></a><span id="l5.786" class="difflineplus">+    else if (node &amp;&amp; node.firstChild)</span>
<a href="#l5.787"></a><span id="l5.787" class="difflineplus">+    {</span>
<a href="#l5.788"></a><span id="l5.788" class="difflineplus">+      let ret = &quot;&quot;;</span>
<a href="#l5.789"></a><span id="l5.789" class="difflineplus">+      for (let child = node.firstChild; child; child = child.nextSibling)</span>
<a href="#l5.790"></a><span id="l5.790" class="difflineplus">+      {</span>
<a href="#l5.791"></a><span id="l5.791" class="difflineplus">+        let value = this.getNodeValue(child);</span>
<a href="#l5.792"></a><span id="l5.792" class="difflineplus">+        if (value)</span>
<a href="#l5.793"></a><span id="l5.793" class="difflineplus">+          ret += value;</span>
<a href="#l5.794"></a><span id="l5.794" class="difflineplus">+      }</span>
<a href="#l5.795"></a><span id="l5.795" class="difflineplus">+</span>
<a href="#l5.796"></a><span id="l5.796" class="difflineplus">+      if (ret)</span>
<a href="#l5.797"></a><span id="l5.797" class="difflineplus">+        return ret;</span>
<a href="#l5.798"></a><span id="l5.798" class="difflineplus">+    }</span>
<a href="#l5.799"></a><span id="l5.799" class="difflineplus">+</span>
<a href="#l5.800"></a><span id="l5.800" class="difflineplus">+    return null;</span>
<a href="#l5.801"></a><span id="l5.801" class="difflineplus">+  },</span>
<a href="#l5.802"></a><span id="l5.802" class="difflineplus">+</span>
<a href="#l5.803"></a><span id="l5.803" class="difflineplus">+  // Finds elements that are direct children of the first arg.</span>
<a href="#l5.804"></a><span id="l5.804">   childrenByTagNameNS: function(aElement, aNamespace, aTagName)</span>
<a href="#l5.805"></a><span id="l5.805">   {</span>
<a href="#l5.806"></a><span id="l5.806" class="difflineminus">-    var matches = aElement.getElementsByTagNameNS(aNamespace, aTagName);</span>
<a href="#l5.807"></a><span id="l5.807" class="difflineminus">-    var matchingChildren = new Array();</span>
<a href="#l5.808"></a><span id="l5.808" class="difflineminus">-    for (var i = 0; i &lt; matches.length; i++) </span>
<a href="#l5.809"></a><span id="l5.809" class="difflineplus">+    let matches = aElement.getElementsByTagNameNS(aNamespace, aTagName);</span>
<a href="#l5.810"></a><span id="l5.810" class="difflineplus">+    let matchingChildren = new Array();</span>
<a href="#l5.811"></a><span id="l5.811" class="difflineplus">+    for (let i = 0; i &lt; matches.length; i++)</span>
<a href="#l5.812"></a><span id="l5.812">     {</span>
<a href="#l5.813"></a><span id="l5.813" class="difflineminus">-      if(matches[i].parentNode == aElement)</span>
<a href="#l5.814"></a><span id="l5.814" class="difflineplus">+      if (matches[i].parentNode == aElement)</span>
<a href="#l5.815"></a><span id="l5.815">         matchingChildren.push(matches[i])</span>
<a href="#l5.816"></a><span id="l5.816">     }</span>
<a href="#l5.817"></a><span id="l5.817" class="difflineminus">-    return matchingChildren;</span>
<a href="#l5.818"></a><span id="l5.818" class="difflineplus">+</span>
<a href="#l5.819"></a><span id="l5.819" class="difflineplus">+    return matchingChildren.length ? matchingChildren : null;</span>
<a href="#l5.820"></a><span id="l5.820">   },</span>
<a href="#l5.821"></a><span id="l5.821"> </span>
<a href="#l5.822"></a><span id="l5.822">   findAtomLink: function(linkRel, linkElements)</span>
<a href="#l5.823"></a><span id="l5.823">   {</span>
<a href="#l5.824"></a><span id="l5.824" class="difflineminus">-    // XXX Need to check for MIME type and hreflang</span>
<a href="#l5.825"></a><span id="l5.825" class="difflineminus">-    for ( var j=0 ; j&lt;linkElements.length ; j++ ) {</span>
<a href="#l5.826"></a><span id="l5.826" class="difflineminus">-      var alink = linkElements[j];</span>
<a href="#l5.827"></a><span id="l5.827" class="difflineminus">-      if (alink &amp;&amp; </span>
<a href="#l5.828"></a><span id="l5.828" class="difflineminus">-          //if there's a link rel</span>
<a href="#l5.829"></a><span id="l5.829" class="difflineminus">-          ((alink.getAttribute('rel') &amp;&amp; alink.getAttribute('rel') == linkRel) ||</span>
<a href="#l5.830"></a><span id="l5.830" class="difflineminus">-           //if there isn't, assume 'alternate'</span>
<a href="#l5.831"></a><span id="l5.831" class="difflineminus">-           (!alink.getAttribute('rel') &amp;&amp; (linkRel==&quot;alternate&quot;))) </span>
<a href="#l5.832"></a><span id="l5.832" class="difflineminus">-          &amp;&amp; alink.getAttribute('href')) </span>
<a href="#l5.833"></a><span id="l5.833" class="difflineplus">+    // XXX Need to check for MIME type and hreflang.</span>
<a href="#l5.834"></a><span id="l5.834" class="difflineplus">+    for (let j = 0; j &lt; linkElements.length; j++) {</span>
<a href="#l5.835"></a><span id="l5.835" class="difflineplus">+      let alink = linkElements[j];</span>
<a href="#l5.836"></a><span id="l5.836" class="difflineplus">+      if (alink &amp;&amp;</span>
<a href="#l5.837"></a><span id="l5.837" class="difflineplus">+          // If there's a link rel.</span>
<a href="#l5.838"></a><span id="l5.838" class="difflineplus">+          ((alink.getAttribute(&quot;rel&quot;) &amp;&amp; alink.getAttribute(&quot;rel&quot;) == linkRel) ||</span>
<a href="#l5.839"></a><span id="l5.839" class="difflineplus">+           // If there isn't, assume 'alternate'.</span>
<a href="#l5.840"></a><span id="l5.840" class="difflineplus">+           (!alink.getAttribute(&quot;rel&quot;) &amp;&amp; (linkRel == &quot;alternate&quot;))) &amp;&amp;</span>
<a href="#l5.841"></a><span id="l5.841" class="difflineplus">+          alink.getAttribute(&quot;href&quot;))</span>
<a href="#l5.842"></a><span id="l5.842">       {</span>
<a href="#l5.843"></a><span id="l5.843" class="difflineminus">-        // Atom links are interpreted relative to xml:base</span>
<a href="#l5.844"></a><span id="l5.844" class="difflineminus">-        var ioService = Components.classes[&quot;@mozilla.org/network/io-service;1&quot;]</span>
<a href="#l5.845"></a><span id="l5.845" class="difflineminus">-                                   .getService(Components.interfaces.nsIIOService);</span>
<a href="#l5.846"></a><span id="l5.846" class="difflineminus">-        return ioService.newURI(alink.baseURI, null, null).resolve(alink.getAttribute('href'));</span>
<a href="#l5.847"></a><span id="l5.847" class="difflineplus">+        // Atom links are interpreted relative to xml:base.</span>
<a href="#l5.848"></a><span id="l5.848" class="difflineplus">+        try {</span>
<a href="#l5.849"></a><span id="l5.849" class="difflineplus">+          return Services.io.newURI(alink.baseURI, null, null).</span>
<a href="#l5.850"></a><span id="l5.850" class="difflineplus">+                             resolve(alink.getAttribute(&quot;href&quot;));</span>
<a href="#l5.851"></a><span id="l5.851" class="difflineplus">+        }</span>
<a href="#l5.852"></a><span id="l5.852" class="difflineplus">+        catch (ex) {}</span>
<a href="#l5.853"></a><span id="l5.853">       }</span>
<a href="#l5.854"></a><span id="l5.854">     }</span>
<a href="#l5.855"></a><span id="l5.855" class="difflineplus">+</span>
<a href="#l5.856"></a><span id="l5.856">     return null;</span>
<a href="#l5.857"></a><span id="l5.857">   },</span>
<a href="#l5.858"></a><span id="l5.858" class="difflineminus">-  </span>
<a href="#l5.859"></a><span id="l5.859" class="difflineplus">+</span>
<a href="#l5.860"></a><span id="l5.860">   stripTags: function(someHTML)</span>
<a href="#l5.861"></a><span id="l5.861">   {</span>
<a href="#l5.862"></a><span id="l5.862" class="difflineminus">-    return someHTML ? someHTML.replace(/&lt;[^&gt;]+&gt;/g,&quot;&quot;) : someHTML;</span>
<a href="#l5.863"></a><span id="l5.863" class="difflineplus">+    return someHTML ? someHTML.replace(/&lt;[^&gt;]+&gt;/g, &quot;&quot;) : someHTML;</span>
<a href="#l5.864"></a><span id="l5.864">   },</span>
<a href="#l5.865"></a><span id="l5.865"> </span>
<a href="#l5.866"></a><span id="l5.866">   xmlUnescape: function(s)</span>
<a href="#l5.867"></a><span id="l5.867">   {</span>
<a href="#l5.868"></a><span id="l5.868">     s = s.replace(/&amp;lt;/g, &quot;&lt;&quot;);</span>
<a href="#l5.869"></a><span id="l5.869">     s = s.replace(/&amp;gt;/g, &quot;&gt;&quot;);</span>
<a href="#l5.870"></a><span id="l5.870">     s = s.replace(/&amp;amp;/g, &quot;&amp;&quot;);</span>
<a href="#l5.871"></a><span id="l5.871">     return s;</span>
<a href="#l5.872"></a><span id="l5.872">   },</span>
<a href="#l5.873"></a><span id="l5.873"> </span>
<a href="#l5.874"></a><span id="l5.874">   xmlEscape: function(s)</span>
<a href="#l5.875"></a><span id="l5.875">   {</span>
<a href="#l5.876"></a><span id="l5.876">     s = s.replace(/&amp;/g, &quot;&amp;amp;&quot;);</span>
<a href="#l5.877"></a><span id="l5.877">     s = s.replace(/&gt;/g, &quot;&amp;gt;&quot;);</span>
<a href="#l5.878"></a><span id="l5.878">     s = s.replace(/&lt;/g, &quot;&amp;lt;&quot;);</span>
<a href="#l5.879"></a><span id="l5.879">     return s;</span>
<a href="#l5.880"></a><span id="l5.880" class="difflineminus">-   }</span>
<a href="#l5.881"></a><span id="l5.881" class="difflineplus">+  },</span>
<a href="#l5.882"></a><span id="l5.882" class="difflineplus">+</span>
<a href="#l5.883"></a><span id="l5.883" class="difflineplus">+  // Date validator for RSS feeds</span>
<a href="#l5.884"></a><span id="l5.884" class="difflineplus">+  FZ_RFC822_RE: &quot;^(((Mon)|(Tue)|(Wed)|(Thu)|(Fri)|(Sat)|(Sun)), *)?\\d\\d?&quot; +</span>
<a href="#l5.885"></a><span id="l5.885" class="difflineplus">+    &quot; +((Jan)|(Feb)|(Mar)|(Apr)|(May)|(Jun)|(Jul)|(Aug)|(Sep)|(Oct)|(Nov)|(Dec))&quot; +</span>
<a href="#l5.886"></a><span id="l5.886" class="difflineplus">+    &quot; +\\d\\d(\\d\\d)? +\\d\\d:\\d\\d(:\\d\\d)? +(([+-]?\\d\\d\\d\\d)|(UT)|(GMT)&quot; +</span>
<a href="#l5.887"></a><span id="l5.887" class="difflineplus">+    &quot;|(EST)|(EDT)|(CST)|(CDT)|(MST)|(MDT)|(PST)|(PDT)|\\w)$&quot;,</span>
<a href="#l5.888"></a><span id="l5.888" class="difflineplus">+</span>
<a href="#l5.889"></a><span id="l5.889" class="difflineplus">+  isValidRFC822Date: function(pubDate)</span>
<a href="#l5.890"></a><span id="l5.890" class="difflineplus">+  {</span>
<a href="#l5.891"></a><span id="l5.891" class="difflineplus">+    let regex = new RegExp(this.FZ_RFC822_RE);</span>
<a href="#l5.892"></a><span id="l5.892" class="difflineplus">+    return regex.test(pubDate);</span>
<a href="#l5.893"></a><span id="l5.893" class="difflineplus">+  },</span>
<a href="#l5.894"></a><span id="l5.894" class="difflineplus">+</span>
<a href="#l5.895"></a><span id="l5.895" class="difflineplus">+  dateRescue: function(dateString)</span>
<a href="#l5.896"></a><span id="l5.896" class="difflineplus">+  {</span>
<a href="#l5.897"></a><span id="l5.897" class="difflineplus">+    // Deal with various kinds of invalid dates.</span>
<a href="#l5.898"></a><span id="l5.898" class="difflineplus">+    if (!isNaN(parseInt(dateString)))</span>
<a href="#l5.899"></a><span id="l5.899" class="difflineplus">+    {</span>
<a href="#l5.900"></a><span id="l5.900" class="difflineplus">+      // It's an integer, so maybe it's a timestamp.</span>
<a href="#l5.901"></a><span id="l5.901" class="difflineplus">+      let d = new Date(parseInt(dateString) * 1000);</span>
<a href="#l5.902"></a><span id="l5.902" class="difflineplus">+      let now = new Date();</span>
<a href="#l5.903"></a><span id="l5.903" class="difflineplus">+      let yeardiff = now.getFullYear() - d.getFullYear();</span>
<a href="#l5.904"></a><span id="l5.904" class="difflineplus">+      FeedUtils.log.trace(&quot;FeedParser.dateRescue: Rescue Timestamp date - &quot; +</span>
<a href="#l5.905"></a><span id="l5.905" class="difflineplus">+                          d.toString() + &quot; ,year diff - &quot; + yeardiff);</span>
<a href="#l5.906"></a><span id="l5.906" class="difflineplus">+      if (yeardiff &gt;= 0 &amp;&amp; yeardiff &lt; 3)</span>
<a href="#l5.907"></a><span id="l5.907" class="difflineplus">+        // It's quite likely the correct date.</span>
<a href="#l5.908"></a><span id="l5.908" class="difflineplus">+        return d.toString();</span>
<a href="#l5.909"></a><span id="l5.909" class="difflineplus">+    }</span>
<a href="#l5.910"></a><span id="l5.910" class="difflineplus">+</span>
<a href="#l5.911"></a><span id="l5.911" class="difflineplus">+    if (dateString.search(/^\d\d\d\d/) != -1)</span>
<a href="#l5.912"></a><span id="l5.912" class="difflineplus">+      //Could be an ISO8601/W3C date.</span>
<a href="#l5.913"></a><span id="l5.913" class="difflineplus">+      return new Date(dateString).toUTCString();</span>
<a href="#l5.914"></a><span id="l5.914" class="difflineplus">+</span>
<a href="#l5.915"></a><span id="l5.915" class="difflineplus">+    // Can't help.  Set to current time.</span>
<a href="#l5.916"></a><span id="l5.916" class="difflineplus">+    return (new Date()).toString();</span>
<a href="#l5.917"></a><span id="l5.917" class="difflineplus">+  }</span>
<a href="#l5.918"></a><span id="l5.918"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/extensions/newsblog/content/feed-subscriptions.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/extensions/newsblog/content/feed-subscriptions.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -132,19 +132,19 @@ var gFeedSubscriptionsWindow = {</span>
<a href="#l6.4"></a><span id="l6.4">             // The item no longer exists, an ancestor folder was deleted or</span>
<a href="#l6.5"></a><span id="l6.5">             // renamed/moved.</span>
<a href="#l6.6"></a><span id="l6.6">             this.selectFolder(item.folder.rootFolder);</span>
<a href="#l6.7"></a><span id="l6.7">         }</span>
<a href="#l6.8"></a><span id="l6.8">         else</span>
<a href="#l6.9"></a><span id="l6.9">         {</span>
<a href="#l6.10"></a><span id="l6.10">           // If selecting a prior selected feed, get its folder from the db</span>
<a href="#l6.11"></a><span id="l6.11">           // in case an ancestor folder was renamed/moved.</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-          let itemResource = rdf.GetResource(item.url);</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">-          let ds = getSubscriptionsDS(item.parentFolder.server);</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineminus">-          let itemFolder = ds.GetTarget(itemResource, FZ_DESTFOLDER, true);</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineplus">+          let itemResource = FeedUtils.rdf.GetResource(item.url);</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineplus">+          let ds = FeedUtils.getSubscriptionsDS(item.parentFolder.server);</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineplus">+          let itemFolder = ds.GetTarget(itemResource, FeedUtils.FZ_DESTFOLDER, true);</span>
<a href="#l6.18"></a><span id="l6.18">           if (itemFolder)</span>
<a href="#l6.19"></a><span id="l6.19">           {</span>
<a href="#l6.20"></a><span id="l6.20">             itemFolder = itemFolder.QueryInterface(Ci.nsIMsgFolder);</span>
<a href="#l6.21"></a><span id="l6.21">             this.selectFeed({folder: itemFolder, url: item.url}, null);</span>
<a href="#l6.22"></a><span id="l6.22">           }</span>
<a href="#l6.23"></a><span id="l6.23">           else</span>
<a href="#l6.24"></a><span id="l6.24">             // The item no longer exists, an ancestor folder was deleted.</span>
<a href="#l6.25"></a><span id="l6.25">             this.selectFolder(item.parentFolder.rootFolder);</span>
<a href="#l6.26"></a><span id="l6.26" class="difflineat">@@ -577,35 +577,35 @@ var gFeedSubscriptionsWindow = {</span>
<a href="#l6.27"></a><span id="l6.27">       folderObject.children.push(this.makeFeedObject(feeds[feed],</span>
<a href="#l6.28"></a><span id="l6.28">                                                      aFolder,</span>
<a href="#l6.29"></a><span id="l6.29">                                                      aCurrentLevel + 1));</span>
<a href="#l6.30"></a><span id="l6.30">     }</span>
<a href="#l6.31"></a><span id="l6.31"> </span>
<a href="#l6.32"></a><span id="l6.32">     // Finally, set the folder's quickMode based on the its first feed's</span>
<a href="#l6.33"></a><span id="l6.33">     // quickMode, since that is how the view determines summary mode, and now</span>
<a href="#l6.34"></a><span id="l6.34">     // quickMode is updated to be the same for all feeds in a folder.</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineminus">-    if (feeds)</span>
<a href="#l6.36"></a><span id="l6.36" class="difflineplus">+    if (feeds &amp;&amp; feeds[0])</span>
<a href="#l6.37"></a><span id="l6.37">       folderObject.quickMode = feeds[0].quickMode;</span>
<a href="#l6.38"></a><span id="l6.38"> </span>
<a href="#l6.39"></a><span id="l6.39">     return folderObject;</span>
<a href="#l6.40"></a><span id="l6.40">   },</span>
<a href="#l6.41"></a><span id="l6.41"> </span>
<a href="#l6.42"></a><span id="l6.42">   getFeedsInFolder: function (aFolder)</span>
<a href="#l6.43"></a><span id="l6.43">   {</span>
<a href="#l6.44"></a><span id="l6.44">     let feeds = new Array();</span>
<a href="#l6.45"></a><span id="l6.45" class="difflineminus">-    let feedUrlArray = getFeedUrlsInFolder(aFolder);</span>
<a href="#l6.46"></a><span id="l6.46" class="difflineplus">+    let feedUrlArray = FeedUtils.getFeedUrlsInFolder(aFolder);</span>
<a href="#l6.47"></a><span id="l6.47">     if (!feedUrlArray)</span>
<a href="#l6.48"></a><span id="l6.48">       // No feedUrls in this folder.</span>
<a href="#l6.49"></a><span id="l6.49" class="difflineminus">-      return;</span>
<a href="#l6.50"></a><span id="l6.50" class="difflineplus">+      return feeds;</span>
<a href="#l6.51"></a><span id="l6.51"> </span>
<a href="#l6.52"></a><span id="l6.52">     for (let url in feedUrlArray)</span>
<a href="#l6.53"></a><span id="l6.53">     {</span>
<a href="#l6.54"></a><span id="l6.54">       if (!feedUrlArray[url])</span>
<a href="#l6.55"></a><span id="l6.55">         continue;</span>
<a href="#l6.56"></a><span id="l6.56" class="difflineminus">-      let feedResource = rdf.GetResource(feedUrlArray[url]);</span>
<a href="#l6.57"></a><span id="l6.57" class="difflineplus">+      let feedResource = FeedUtils.rdf.GetResource(feedUrlArray[url]);</span>
<a href="#l6.58"></a><span id="l6.58">       let feed = new Feed(feedResource, aFolder.server);</span>
<a href="#l6.59"></a><span id="l6.59">       feeds.push(feed);</span>
<a href="#l6.60"></a><span id="l6.60">     }</span>
<a href="#l6.61"></a><span id="l6.61"> </span>
<a href="#l6.62"></a><span id="l6.62">     return feeds;</span>
<a href="#l6.63"></a><span id="l6.63">   },</span>
<a href="#l6.64"></a><span id="l6.64"> </span>
<a href="#l6.65"></a><span id="l6.65">   makeFeedObject: function (aFeed, aFolder, aLevel)</span>
<a href="#l6.66"></a><span id="l6.66" class="difflineat">@@ -882,17 +882,17 @@ var gFeedSubscriptionsWindow = {</span>
<a href="#l6.67"></a><span id="l6.67">         // Intent is to add a feed/folder to the account, so return.</span>
<a href="#l6.68"></a><span id="l6.68">         return;</span>
<a href="#l6.69"></a><span id="l6.69"> </span>
<a href="#l6.70"></a><span id="l6.70">       // An account folder.  If it changes, all non feed containing subfolders</span>
<a href="#l6.71"></a><span id="l6.71">       // need to be updated with the new default.</span>
<a href="#l6.72"></a><span id="l6.72">       item.folder.server.setBoolValue(&quot;quickMode&quot;, aChecked);</span>
<a href="#l6.73"></a><span id="l6.73">       this.refreshSubscriptionView();</span>
<a href="#l6.74"></a><span id="l6.74">     }</span>
<a href="#l6.75"></a><span id="l6.75" class="difflineminus">-    else if (!getFeedUrlsInFolder(item.folder))</span>
<a href="#l6.76"></a><span id="l6.76" class="difflineplus">+    else if (!FeedUtils.getFeedUrlsInFolder(item.folder))</span>
<a href="#l6.77"></a><span id="l6.77">       // Not a folder with feeds.</span>
<a href="#l6.78"></a><span id="l6.78">       return;</span>
<a href="#l6.79"></a><span id="l6.79">     else</span>
<a href="#l6.80"></a><span id="l6.80">     {</span>
<a href="#l6.81"></a><span id="l6.81">       let feedsInFolder = this.getFeedsInFolder(item.folder);</span>
<a href="#l6.82"></a><span id="l6.82">       // Update the feeds database, for each feed in the folder.</span>
<a href="#l6.83"></a><span id="l6.83">       feedsInFolder.forEach(function(feed) { feed.quickMode = aChecked; });</span>
<a href="#l6.84"></a><span id="l6.84">       // Update the folder's feeds properties in the tree map.</span>
<a href="#l6.85"></a><span id="l6.85" class="difflineat">@@ -940,17 +940,17 @@ var gFeedSubscriptionsWindow = {</span>
<a href="#l6.86"></a><span id="l6.86">   setSummaryFocus: function ()</span>
<a href="#l6.87"></a><span id="l6.87">   {</span>
<a href="#l6.88"></a><span id="l6.88">     let item = this.mView.currentItem;</span>
<a href="#l6.89"></a><span id="l6.89">     let locationValue = document.getElementById(&quot;locationValue&quot;);</span>
<a href="#l6.90"></a><span id="l6.90">     let quickMode = document.getElementById(&quot;quickMode&quot;);</span>
<a href="#l6.91"></a><span id="l6.91"> </span>
<a href="#l6.92"></a><span id="l6.92">     if (item &amp;&amp; item.folder &amp;&amp;</span>
<a href="#l6.93"></a><span id="l6.93">         (locationValue.hasAttribute(&quot;focused&quot;) || locationValue.value ||</span>
<a href="#l6.94"></a><span id="l6.94" class="difflineminus">-         item.folder.isServer || getFeedUrlsInFolder(item.folder)))</span>
<a href="#l6.95"></a><span id="l6.95" class="difflineplus">+         item.folder.isServer || FeedUtils.getFeedUrlsInFolder(item.folder)))</span>
<a href="#l6.96"></a><span id="l6.96">     {</span>
<a href="#l6.97"></a><span id="l6.97">       // Enable summary for account folder or folder with feeds or focus/value</span>
<a href="#l6.98"></a><span id="l6.98">       // in the feed url field of empty folders prior to add.</span>
<a href="#l6.99"></a><span id="l6.99">       quickMode.disabled = false;</span>
<a href="#l6.100"></a><span id="l6.100">     }</span>
<a href="#l6.101"></a><span id="l6.101">     else</span>
<a href="#l6.102"></a><span id="l6.102">     {</span>
<a href="#l6.103"></a><span id="l6.103">       quickMode.disabled = true;</span>
<a href="#l6.104"></a><span id="l6.104" class="difflineat">@@ -976,19 +976,19 @@ var gFeedSubscriptionsWindow = {</span>
<a href="#l6.105"></a><span id="l6.105">       let pMessage = FeedUtils.strings.formatStringFromName(</span>
<a href="#l6.106"></a><span id="l6.106">                        &quot;subscribe-confirmFeedDeletion&quot;, [itemToRemove.name], 1);</span>
<a href="#l6.107"></a><span id="l6.107">       if (Services.prompt.confirmEx(window, pTitle, pMessage,</span>
<a href="#l6.108"></a><span id="l6.108">                                     Ci.nsIPromptService.STD_YES_NO_BUTTONS,</span>
<a href="#l6.109"></a><span id="l6.109">                                     null, null, null, null, { }))</span>
<a href="#l6.110"></a><span id="l6.110">         return;</span>
<a href="#l6.111"></a><span id="l6.111">     }</span>
<a href="#l6.112"></a><span id="l6.112"> </span>
<a href="#l6.113"></a><span id="l6.113" class="difflineminus">-    deleteFeed(rdf.GetResource(itemToRemove.url),</span>
<a href="#l6.114"></a><span id="l6.114" class="difflineminus">-               itemToRemove.parentFolder.server,</span>
<a href="#l6.115"></a><span id="l6.115" class="difflineminus">-               itemToRemove.parentFolder);</span>
<a href="#l6.116"></a><span id="l6.116" class="difflineplus">+    FeedUtils.deleteFeed(FeedUtils.rdf.GetResource(itemToRemove.url),</span>
<a href="#l6.117"></a><span id="l6.117" class="difflineplus">+                         itemToRemove.parentFolder.server,</span>
<a href="#l6.118"></a><span id="l6.118" class="difflineplus">+                         itemToRemove.parentFolder);</span>
<a href="#l6.119"></a><span id="l6.119"> </span>
<a href="#l6.120"></a><span id="l6.120">     // Now that we have removed the feed from the datasource, it is time to</span>
<a href="#l6.121"></a><span id="l6.121">     // update our view layer.  Update parent folder's quickMode if necessary</span>
<a href="#l6.122"></a><span id="l6.122">     // and remove the child from its parent folder object.</span>
<a href="#l6.123"></a><span id="l6.123">     let parentIndex = this.mView.getParentIndex(seln.currentIndex);</span>
<a href="#l6.124"></a><span id="l6.124">     let parentItem = this.mView.getItemAtIndex(parentIndex);</span>
<a href="#l6.125"></a><span id="l6.125">     this.updateFolderQuickModeInView(itemToRemove, parentItem, true);</span>
<a href="#l6.126"></a><span id="l6.126">     this.mView.removeItemAtIndex(seln.currentIndex, false);</span>
<a href="#l6.127"></a><span id="l6.127" class="difflineat">@@ -1056,17 +1056,17 @@ var gFeedSubscriptionsWindow = {</span>
<a href="#l6.128"></a><span id="l6.128">     }</span>
<a href="#l6.129"></a><span id="l6.129"> </span>
<a href="#l6.130"></a><span id="l6.130">     // Shouldn't happen.  Or else not passed an nsIMsgFolder.</span>
<a href="#l6.131"></a><span id="l6.131">     if (!addFolder)</span>
<a href="#l6.132"></a><span id="l6.132">       return false;</span>
<a href="#l6.133"></a><span id="l6.133"> </span>
<a href="#l6.134"></a><span id="l6.134">     // Before we go any further, make sure the user is not already subscribed</span>
<a href="#l6.135"></a><span id="l6.135">     // to this feed.</span>
<a href="#l6.136"></a><span id="l6.136" class="difflineminus">-    if (feedAlreadyExists(feedLocation, addFolder.server))</span>
<a href="#l6.137"></a><span id="l6.137" class="difflineplus">+    if (FeedUtils.feedAlreadyExists(feedLocation, addFolder.server))</span>
<a href="#l6.138"></a><span id="l6.138">     {</span>
<a href="#l6.139"></a><span id="l6.139">       message = FeedUtils.strings.GetStringFromName(</span>
<a href="#l6.140"></a><span id="l6.140">                   &quot;subscribe-feedAlreadySubscribed&quot;);</span>
<a href="#l6.141"></a><span id="l6.141">       this.updateStatusItem(&quot;statusText&quot;, message);</span>
<a href="#l6.142"></a><span id="l6.142">       return false;</span>
<a href="#l6.143"></a><span id="l6.143">     }</span>
<a href="#l6.144"></a><span id="l6.144"> </span>
<a href="#l6.145"></a><span id="l6.145">     let name = document.getElementById(&quot;nameValue&quot;).value;</span>
<a href="#l6.146"></a><span id="l6.146" class="difflineat">@@ -1089,23 +1089,23 @@ var gFeedSubscriptionsWindow = {</span>
<a href="#l6.147"></a><span id="l6.147">     this.mActionMode = mode;</span>
<a href="#l6.148"></a><span id="l6.148">     feed.download(parse, this.mFeedDownloadCallback);</span>
<a href="#l6.149"></a><span id="l6.149">     return true;</span>
<a href="#l6.150"></a><span id="l6.150">   },</span>
<a href="#l6.151"></a><span id="l6.151"> </span>
<a href="#l6.152"></a><span id="l6.152">   // Helper routine used by addFeed and importOPMLFile.</span>
<a href="#l6.153"></a><span id="l6.153">   storeFeed: function(feedProperties)</span>
<a href="#l6.154"></a><span id="l6.154">   {</span>
<a href="#l6.155"></a><span id="l6.155" class="difflineminus">-    let itemResource = rdf.GetResource(feedProperties.feedLocation);</span>
<a href="#l6.156"></a><span id="l6.156" class="difflineplus">+    let itemResource = FeedUtils.rdf.GetResource(feedProperties.feedLocation);</span>
<a href="#l6.157"></a><span id="l6.157">     let feed = new Feed(itemResource, feedProperties.server);</span>
<a href="#l6.158"></a><span id="l6.158"> </span>
<a href="#l6.159"></a><span id="l6.159">     // If the user specified a folder to add the feed to, then set it here.</span>
<a href="#l6.160"></a><span id="l6.160">     if (feedProperties.folderURI)</span>
<a href="#l6.161"></a><span id="l6.161">     {</span>
<a href="#l6.162"></a><span id="l6.162" class="difflineminus">-      let folderResource = rdf.GetResource(feedProperties.folderURI);</span>
<a href="#l6.163"></a><span id="l6.163" class="difflineplus">+      let folderResource = FeedUtils.rdf.GetResource(feedProperties.folderURI);</span>
<a href="#l6.164"></a><span id="l6.164">       if (folderResource)</span>
<a href="#l6.165"></a><span id="l6.165">       {</span>
<a href="#l6.166"></a><span id="l6.166">         let folder = folderResource.QueryInterface(Ci.nsIMsgFolder);</span>
<a href="#l6.167"></a><span id="l6.167">         if (folder &amp;&amp; !folder.isServer)</span>
<a href="#l6.168"></a><span id="l6.168">           feed.folder = folder;</span>
<a href="#l6.169"></a><span id="l6.169">       }</span>
<a href="#l6.170"></a><span id="l6.170">     }</span>
<a href="#l6.171"></a><span id="l6.171"> </span>
<a href="#l6.172"></a><span id="l6.172" class="difflineat">@@ -1119,20 +1119,20 @@ var gFeedSubscriptionsWindow = {</span>
<a href="#l6.173"></a><span id="l6.173">     let seln = this.mView.selection;</span>
<a href="#l6.174"></a><span id="l6.174">     if (seln.count != 1)</span>
<a href="#l6.175"></a><span id="l6.175">       return;</span>
<a href="#l6.176"></a><span id="l6.176"> </span>
<a href="#l6.177"></a><span id="l6.177">     let itemToEdit = this.mView.getItemAtIndex(seln.currentIndex);</span>
<a href="#l6.178"></a><span id="l6.178">     if (!itemToEdit || itemToEdit.container || !itemToEdit.parentFolder)</span>
<a href="#l6.179"></a><span id="l6.179">       return;</span>
<a href="#l6.180"></a><span id="l6.180"> </span>
<a href="#l6.181"></a><span id="l6.181" class="difflineminus">-    let resource = rdf.GetResource(itemToEdit.url);</span>
<a href="#l6.182"></a><span id="l6.182" class="difflineplus">+    let resource = FeedUtils.rdf.GetResource(itemToEdit.url);</span>
<a href="#l6.183"></a><span id="l6.183">     let currentFolderServer = itemToEdit.parentFolder.server;</span>
<a href="#l6.184"></a><span id="l6.184" class="difflineminus">-    let ds = getSubscriptionsDS(currentFolderServer);</span>
<a href="#l6.185"></a><span id="l6.185" class="difflineminus">-    let currentFolder = ds.GetTarget(resource, FZ_DESTFOLDER, true);</span>
<a href="#l6.186"></a><span id="l6.186" class="difflineplus">+    let ds = FeedUtils.getSubscriptionsDS(currentFolderServer);</span>
<a href="#l6.187"></a><span id="l6.187" class="difflineplus">+    let currentFolder = ds.GetTarget(resource, FeedUtils.FZ_DESTFOLDER, true);</span>
<a href="#l6.188"></a><span id="l6.188">     let currentFolderURI = currentFolder.QueryInterface(Ci.nsIRDFResource).Value;</span>
<a href="#l6.189"></a><span id="l6.189">     let feed = new Feed(resource, currentFolderServer);</span>
<a href="#l6.190"></a><span id="l6.190">     feed.folder = itemToEdit.parentFolder;</span>
<a href="#l6.191"></a><span id="l6.191"> </span>
<a href="#l6.192"></a><span id="l6.192">     let editNameValue = document.getElementById(&quot;nameValue&quot;).value;</span>
<a href="#l6.193"></a><span id="l6.193">     let editFeedLocation = document.getElementById(&quot;locationValue&quot;).value.trim();</span>
<a href="#l6.194"></a><span id="l6.194">     let selectFolder = document.getElementById(&quot;selectFolder&quot;);</span>
<a href="#l6.195"></a><span id="l6.195">     let editQuickMode = document.getElementById(&quot;quickMode&quot;).checked;</span>
<a href="#l6.196"></a><span id="l6.196" class="difflineat">@@ -1208,62 +1208,62 @@ var gFeedSubscriptionsWindow = {</span>
<a href="#l6.197"></a><span id="l6.197">     let currentItem = this.mView.getItemAtIndex(aOldFeedIndex);</span>
<a href="#l6.198"></a><span id="l6.198">     if (!currentItem ||</span>
<a href="#l6.199"></a><span id="l6.199">         this.mView.getParentIndex(aOldFeedIndex) == aNewParentIndex)</span>
<a href="#l6.200"></a><span id="l6.200">       // If the new parent is the same as the current parent, then do nothing.</span>
<a href="#l6.201"></a><span id="l6.201">       return;</span>
<a href="#l6.202"></a><span id="l6.202"> </span>
<a href="#l6.203"></a><span id="l6.203">     let currentParentIndex = this.mView.getParentIndex(aOldFeedIndex);</span>
<a href="#l6.204"></a><span id="l6.204">     let currentParentItem = this.mView.getItemAtIndex(currentParentIndex);</span>
<a href="#l6.205"></a><span id="l6.205" class="difflineminus">-    let currentParentResource = rdf.GetResource(currentParentItem.url);</span>
<a href="#l6.206"></a><span id="l6.206" class="difflineplus">+    let currentParentResource = FeedUtils.rdf.GetResource(currentParentItem.url);</span>
<a href="#l6.207"></a><span id="l6.207">     let currentFolder = currentParentResource.QueryInterface(Ci.nsIMsgFolder);</span>
<a href="#l6.208"></a><span id="l6.208"> </span>
<a href="#l6.209"></a><span id="l6.209">     let newParentItem = this.mView.getItemAtIndex(aNewParentIndex);</span>
<a href="#l6.210"></a><span id="l6.210" class="difflineminus">-    let newParentResource = rdf.GetResource(newParentItem.url);</span>
<a href="#l6.211"></a><span id="l6.211" class="difflineplus">+    let newParentResource = FeedUtils.rdf.GetResource(newParentItem.url);</span>
<a href="#l6.212"></a><span id="l6.212">     let newFolder = newParentResource.QueryInterface(Ci.nsIMsgFolder);</span>
<a href="#l6.213"></a><span id="l6.213"> </span>
<a href="#l6.214"></a><span id="l6.214" class="difflineminus">-    let ds = getSubscriptionsDS(currentItem.parentFolder.server);</span>
<a href="#l6.215"></a><span id="l6.215" class="difflineminus">-    let resource = rdf.GetResource(currentItem.url);</span>
<a href="#l6.216"></a><span id="l6.216" class="difflineplus">+    let ds = FeedUtils.getSubscriptionsDS(currentItem.parentFolder.server);</span>
<a href="#l6.217"></a><span id="l6.217" class="difflineplus">+    let resource = FeedUtils.rdf.GetResource(currentItem.url);</span>
<a href="#l6.218"></a><span id="l6.218"> </span>
<a href="#l6.219"></a><span id="l6.219">     let accountMoveCopy = false;</span>
<a href="#l6.220"></a><span id="l6.220">     if (currentFolder.rootFolder.URI == newFolder.rootFolder.URI)</span>
<a href="#l6.221"></a><span id="l6.221">     {</span>
<a href="#l6.222"></a><span id="l6.222">       // Moving within the same account/feeds db.</span>
<a href="#l6.223"></a><span id="l6.223">       if (newFolder.isServer || !moveFeed)</span>
<a href="#l6.224"></a><span id="l6.224">         // No moving to account folder if already in the account; can only move,</span>
<a href="#l6.225"></a><span id="l6.225">         // not copy, to folder in the same account.</span>
<a href="#l6.226"></a><span id="l6.226">         return;</span>
<a href="#l6.227"></a><span id="l6.227"> </span>
<a href="#l6.228"></a><span id="l6.228">       // Unassert the older URI, add an assertion for the new parent URI.</span>
<a href="#l6.229"></a><span id="l6.229" class="difflineminus">-      ds.Change(resource, FZ_DESTFOLDER,</span>
<a href="#l6.230"></a><span id="l6.230" class="difflineplus">+      ds.Change(resource, FeedUtils.FZ_DESTFOLDER,</span>
<a href="#l6.231"></a><span id="l6.231">                 currentParentResource, newParentResource);</span>
<a href="#l6.232"></a><span id="l6.232">       ds.QueryInterface(Ci.nsIRDFRemoteDataSource).Flush();</span>
<a href="#l6.233"></a><span id="l6.233">       // Update the feed url attributes on the databases for each folder:</span>
<a href="#l6.234"></a><span id="l6.234">       // Remove our feed url property from the current folder.</span>
<a href="#l6.235"></a><span id="l6.235" class="difflineminus">-      updateFolderFeedUrl(currentFolder, currentItem.url, true);</span>
<a href="#l6.236"></a><span id="l6.236" class="difflineplus">+      FeedUtils.updateFolderFeedUrl(currentFolder, currentItem.url, true);</span>
<a href="#l6.237"></a><span id="l6.237">       // Add our feed url property to the new folder.</span>
<a href="#l6.238"></a><span id="l6.238" class="difflineminus">-      updateFolderFeedUrl(newFolder, currentItem.url, false);</span>
<a href="#l6.239"></a><span id="l6.239" class="difflineplus">+      FeedUtils.updateFolderFeedUrl(newFolder, currentItem.url, false);</span>
<a href="#l6.240"></a><span id="l6.240">     }</span>
<a href="#l6.241"></a><span id="l6.241">     else</span>
<a href="#l6.242"></a><span id="l6.242">     {</span>
<a href="#l6.243"></a><span id="l6.243">       // Moving/copying to a new account.  If dropping on the account folder,</span>
<a href="#l6.244"></a><span id="l6.244">       // a new subfolder is created if necessary.</span>
<a href="#l6.245"></a><span id="l6.245">       accountMoveCopy = true;</span>
<a href="#l6.246"></a><span id="l6.246">       let mode = moveFeed ? this.kMoveMode : this.kCopyMode;</span>
<a href="#l6.247"></a><span id="l6.247">       let params = {quickMode: currentItem.quickMode};</span>
<a href="#l6.248"></a><span id="l6.248">       // Subscribe to the new folder first.  If it already exists in the</span>
<a href="#l6.249"></a><span id="l6.249">       // account or on error, return.</span>
<a href="#l6.250"></a><span id="l6.250">       if (!this.addFeed(currentItem.url, newFolder, false, params, mode))</span>
<a href="#l6.251"></a><span id="l6.251">         return;</span>
<a href="#l6.252"></a><span id="l6.252">       // Unsubscribe the feed from the old folder, if add to the new folder</span>
<a href="#l6.253"></a><span id="l6.253">       // is successfull, and doing a move.</span>
<a href="#l6.254"></a><span id="l6.254">       if (moveFeed)</span>
<a href="#l6.255"></a><span id="l6.255" class="difflineminus">-        deleteFeed(rdf.GetResource(currentItem.url),</span>
<a href="#l6.256"></a><span id="l6.256" class="difflineminus">-                   currentItem.parentFolder.server,</span>
<a href="#l6.257"></a><span id="l6.257" class="difflineminus">-                   currentItem.parentFolder);</span>
<a href="#l6.258"></a><span id="l6.258" class="difflineplus">+        FeedUtils.deleteFeed(FeedUtils.rdf.GetResource(currentItem.url),</span>
<a href="#l6.259"></a><span id="l6.259" class="difflineplus">+                             currentItem.parentFolder.server,</span>
<a href="#l6.260"></a><span id="l6.260" class="difflineplus">+                             currentItem.parentFolder);</span>
<a href="#l6.261"></a><span id="l6.261">     }</span>
<a href="#l6.262"></a><span id="l6.262"> </span>
<a href="#l6.263"></a><span id="l6.263">     // Finally, update our view layer.  Update old parent folder's quickMode</span>
<a href="#l6.264"></a><span id="l6.264">     // and remove the old row, if move.  Otherwise no change to the view.</span>
<a href="#l6.265"></a><span id="l6.265">     if (moveFeed)</span>
<a href="#l6.266"></a><span id="l6.266">     {</span>
<a href="#l6.267"></a><span id="l6.267">       this.updateFolderQuickModeInView(currentItem, currentParentItem, true);</span>
<a href="#l6.268"></a><span id="l6.268">       this.mView.removeItemAtIndex(aOldFeedIndex, true);</span>
<a href="#l6.269"></a><span id="l6.269" class="difflineat">@@ -1295,31 +1295,31 @@ var gFeedSubscriptionsWindow = {</span>
<a href="#l6.270"></a><span id="l6.270">     let message = FeedUtils.strings.GetStringFromName(&quot;subscribe-feedMoved&quot;);</span>
<a href="#l6.271"></a><span id="l6.271">     this.updateStatusItem(&quot;statusText&quot;, message);</span>
<a href="#l6.272"></a><span id="l6.272">   },</span>
<a href="#l6.273"></a><span id="l6.273"> </span>
<a href="#l6.274"></a><span id="l6.274">   updateFolderQuickModeInView: function (aFeedItem, aParentItem, aRemove)</span>
<a href="#l6.275"></a><span id="l6.275">   {</span>
<a href="#l6.276"></a><span id="l6.276">     let feedItem = aFeedItem;</span>
<a href="#l6.277"></a><span id="l6.277">     let parentItem = aParentItem;</span>
<a href="#l6.278"></a><span id="l6.278" class="difflineminus">-    let feedUrlArray = getFeedUrlsInFolder(feedItem.parentFolder);</span>
<a href="#l6.279"></a><span id="l6.279" class="difflineplus">+    let feedUrlArray = FeedUtils.getFeedUrlsInFolder(feedItem.parentFolder);</span>
<a href="#l6.280"></a><span id="l6.280">     let feedsInFolder = feedUrlArray ? feedUrlArray.length : 0;</span>
<a href="#l6.281"></a><span id="l6.281"> </span>
<a href="#l6.282"></a><span id="l6.282">     if (aRemove &amp;&amp; feedsInFolder &lt; 1)</span>
<a href="#l6.283"></a><span id="l6.283">       // Removed only feed in folder; set quickMode to server default.</span>
<a href="#l6.284"></a><span id="l6.284">       parentItem.quickMode = parentItem.folder.server.getBoolValue(&quot;quickMode&quot;);</span>
<a href="#l6.285"></a><span id="l6.285"> </span>
<a href="#l6.286"></a><span id="l6.286">     if (!aRemove)</span>
<a href="#l6.287"></a><span id="l6.287">     {</span>
<a href="#l6.288"></a><span id="l6.288">       // Just added a feed to a folder.  If there are already feeds in the</span>
<a href="#l6.289"></a><span id="l6.289">       // folder, the feed must reflect the parent's quickMode.  If it is the</span>
<a href="#l6.290"></a><span id="l6.290">       // only feed, update the parent folder to the feed's quickMode.</span>
<a href="#l6.291"></a><span id="l6.291">       if (feedsInFolder &gt; 1)</span>
<a href="#l6.292"></a><span id="l6.292">       {</span>
<a href="#l6.293"></a><span id="l6.293" class="difflineminus">-        let feedResource = rdf.GetResource(feedItem.url);</span>
<a href="#l6.294"></a><span id="l6.294" class="difflineplus">+        let feedResource = FeedUtils.rdf.GetResource(feedItem.url);</span>
<a href="#l6.295"></a><span id="l6.295">         let feed = new Feed(feedResource, feedItem.parentFolder.server);</span>
<a href="#l6.296"></a><span id="l6.296">         feed.quickMode = parentItem.quickMode;</span>
<a href="#l6.297"></a><span id="l6.297">         feedItem.quickMode = parentItem.quickMode;</span>
<a href="#l6.298"></a><span id="l6.298">       }</span>
<a href="#l6.299"></a><span id="l6.299">       else</span>
<a href="#l6.300"></a><span id="l6.300">         parentItem.quickMode = feedItem.quickMode;</span>
<a href="#l6.301"></a><span id="l6.301">     }</span>
<a href="#l6.302"></a><span id="l6.302">   },</span>
<a href="#l6.303"></a><span id="l6.303" class="difflineat">@@ -1353,21 +1353,21 @@ var gFeedSubscriptionsWindow = {</span>
<a href="#l6.304"></a><span id="l6.304">       let message = &quot;&quot;;</span>
<a href="#l6.305"></a><span id="l6.305">       let win = gFeedSubscriptionsWindow;</span>
<a href="#l6.306"></a><span id="l6.306">       if (aErrorCode == FeedUtils.kNewsBlogSuccess)</span>
<a href="#l6.307"></a><span id="l6.307">       {</span>
<a href="#l6.308"></a><span id="l6.308">         win.updateStatusItem(&quot;progressMeter&quot;, 100);</span>
<a href="#l6.309"></a><span id="l6.309"> </span>
<a href="#l6.310"></a><span id="l6.310">         // If we get here we should always have a folder by now, either in</span>
<a href="#l6.311"></a><span id="l6.311">         // feed.folder or FeedItems created the folder for us.</span>
<a href="#l6.312"></a><span id="l6.312" class="difflineminus">-        updateFolderFeedUrl(feed.folder, feed.url, false);</span>
<a href="#l6.313"></a><span id="l6.313" class="difflineplus">+        FeedUtils.updateFolderFeedUrl(feed.folder, feed.url, false);</span>
<a href="#l6.314"></a><span id="l6.314"> </span>
<a href="#l6.315"></a><span id="l6.315">         // Add feed adds the feed to the subscriptions db and flushes the</span>
<a href="#l6.316"></a><span id="l6.316">         // datasource.</span>
<a href="#l6.317"></a><span id="l6.317" class="difflineminus">-        addFeed(feed.url, feed.name, feed.folder); </span>
<a href="#l6.318"></a><span id="l6.318" class="difflineplus">+        FeedUtils.addFeed(feed.url, feed.name, feed.folder); </span>
<a href="#l6.319"></a><span id="l6.319"> </span>
<a href="#l6.320"></a><span id="l6.320">         // Now add the feed to our view.  If adding, the current selection will</span>
<a href="#l6.321"></a><span id="l6.321">         // be a folder; if updating it will be a feed.  No need to rebuild the</span>
<a href="#l6.322"></a><span id="l6.322">         // entire view, that is too jarring.</span>
<a href="#l6.323"></a><span id="l6.323">         let curIndex = win.mView.selection.currentIndex;</span>
<a href="#l6.324"></a><span id="l6.324">         let curItem = win.mView.getItemAtIndex(curIndex);</span>
<a href="#l6.325"></a><span id="l6.325">         if (curItem)</span>
<a href="#l6.326"></a><span id="l6.326">         {</span>
<a href="#l6.327"></a><span id="l6.327" class="difflineat">@@ -1427,19 +1427,19 @@ var gFeedSubscriptionsWindow = {</span>
<a href="#l6.328"></a><span id="l6.328"> </span>
<a href="#l6.329"></a><span id="l6.329">           win.selectFeed(feed, parentIndex);</span>
<a href="#l6.330"></a><span id="l6.330">         }</span>
<a href="#l6.331"></a><span id="l6.331">       }</span>
<a href="#l6.332"></a><span id="l6.332">       else</span>
<a href="#l6.333"></a><span id="l6.333">       {</span>
<a href="#l6.334"></a><span id="l6.334">         // Non success.  Remove intermediate traces from the feeds database.</span>
<a href="#l6.335"></a><span id="l6.335">         if (feed &amp;&amp; feed.url &amp;&amp; feed.server)</span>
<a href="#l6.336"></a><span id="l6.336" class="difflineminus">-          deleteFeed(rdf.GetResource(feed.url),</span>
<a href="#l6.337"></a><span id="l6.337" class="difflineminus">-                     feed.server,</span>
<a href="#l6.338"></a><span id="l6.338" class="difflineminus">-                     feed.server.rootFolder);</span>
<a href="#l6.339"></a><span id="l6.339" class="difflineplus">+          FeedUtils.deleteFeed(FeedUtils.rdf.GetResource(feed.url),</span>
<a href="#l6.340"></a><span id="l6.340" class="difflineplus">+                               feed.server,</span>
<a href="#l6.341"></a><span id="l6.341" class="difflineplus">+                               feed.server.rootFolder);</span>
<a href="#l6.342"></a><span id="l6.342"> </span>
<a href="#l6.343"></a><span id="l6.343">         if (aErrorCode == FeedUtils.kNewsBlogInvalidFeed)</span>
<a href="#l6.344"></a><span id="l6.344">           message = FeedUtils.strings.GetStringFromName(</span>
<a href="#l6.345"></a><span id="l6.345">                       &quot;subscribe-feedNotValid&quot;);</span>
<a href="#l6.346"></a><span id="l6.346">         if (aErrorCode == FeedUtils.kNewsBlogRequestFailure)</span>
<a href="#l6.347"></a><span id="l6.347">           message = FeedUtils.strings.GetStringFromName(</span>
<a href="#l6.348"></a><span id="l6.348">                       &quot;subscribe-networkError&quot;);</span>
<a href="#l6.349"></a><span id="l6.349"> </span>
<a href="#l6.350"></a><span id="l6.350" class="difflineat">@@ -1461,17 +1461,17 @@ var gFeedSubscriptionsWindow = {</span>
<a href="#l6.351"></a><span id="l6.351">     {</span>
<a href="#l6.352"></a><span id="l6.352">       let message = FeedUtils.strings.formatStringFromName(</span>
<a href="#l6.353"></a><span id="l6.353">                       &quot;subscribe-gettingFeedItems&quot;,</span>
<a href="#l6.354"></a><span id="l6.354">                       [aCurrentFeedItems, aMaxFeedItems], 2);</span>
<a href="#l6.355"></a><span id="l6.355">       gFeedSubscriptionsWindow.updateStatusItem(&quot;statusText&quot;, message);</span>
<a href="#l6.356"></a><span id="l6.356">       this.onProgress(feed, aCurrentFeedItems, aMaxFeedItems);</span>
<a href="#l6.357"></a><span id="l6.357">     },</span>
<a href="#l6.358"></a><span id="l6.358"> </span>
<a href="#l6.359"></a><span id="l6.359" class="difflineminus">-    onProgress: function(feed, aProgress, aProgressMax)</span>
<a href="#l6.360"></a><span id="l6.360" class="difflineplus">+    onProgress: function(feed, aProgress, aProgressMax, aLengthComputable)</span>
<a href="#l6.361"></a><span id="l6.361">     {</span>
<a href="#l6.362"></a><span id="l6.362">       gFeedSubscriptionsWindow.updateStatusItem(&quot;progressMeter&quot;,</span>
<a href="#l6.363"></a><span id="l6.363">                                                 (aProgress * 100) / aProgressMax);</span>
<a href="#l6.364"></a><span id="l6.364">     }</span>
<a href="#l6.365"></a><span id="l6.365">   },</span>
<a href="#l6.366"></a><span id="l6.366"> </span>
<a href="#l6.367"></a><span id="l6.367">   // Status routines.</span>
<a href="#l6.368"></a><span id="l6.368">   updateStatusItem: function(aID, aValue, aErrorCode)</span>
<a href="#l6.369"></a><span id="l6.369" class="difflineat">@@ -1583,17 +1583,20 @@ var gFeedSubscriptionsWindow = {</span>
<a href="#l6.370"></a><span id="l6.370">     {</span>
<a href="#l6.371"></a><span id="l6.371">       if (aDestFolder.server.type != &quot;rss&quot;)</span>
<a href="#l6.372"></a><span id="l6.372">         return;</span>
<a href="#l6.373"></a><span id="l6.373">       FeedUtils.log.debug(&quot;folderMoveCopyCompleted: move:src:dest - &quot;+</span>
<a href="#l6.374"></a><span id="l6.374">                           aMove+&quot;:&quot;+aSrcFolder.name+&quot;:&quot;+aDestFolder.name);</span>
<a href="#l6.375"></a><span id="l6.375">       let curSelItem = this.currentSelectedItem;</span>
<a href="#l6.376"></a><span id="l6.376">       let feedWindow = this.feedWindow;</span>
<a href="#l6.377"></a><span id="l6.377">       if (aMove &amp;&amp; aDestFolder.getFlag(Ci.nsMsgFolderFlags.Trash))</span>
<a href="#l6.378"></a><span id="l6.378" class="difflineminus">-        return this.folderDeleted(aSrcFolder);</span>
<a href="#l6.379"></a><span id="l6.379" class="difflineplus">+      {</span>
<a href="#l6.380"></a><span id="l6.380" class="difflineplus">+        this.folderDeleted(aSrcFolder);</span>
<a href="#l6.381"></a><span id="l6.381" class="difflineplus">+        return</span>
<a href="#l6.382"></a><span id="l6.382" class="difflineplus">+      }</span>
<a href="#l6.383"></a><span id="l6.383"> </span>
<a href="#l6.384"></a><span id="l6.384">       setTimeout(function() {</span>
<a href="#l6.385"></a><span id="l6.385">         feedWindow.refreshSubscriptionView();</span>
<a href="#l6.386"></a><span id="l6.386">         if (curSelItem &amp;&amp; curSelItem.container &amp;&amp;</span>
<a href="#l6.387"></a><span id="l6.387">             curSelItem.folder == aSrcFolder)</span>
<a href="#l6.388"></a><span id="l6.388">           feedWindow.selectFolder(aDestFolder);</span>
<a href="#l6.389"></a><span id="l6.389">       }, 20);</span>
<a href="#l6.390"></a><span id="l6.390">     }</span>
<a href="#l6.391"></a><span id="l6.391" class="difflineat">@@ -1814,17 +1817,17 @@ var gFeedSubscriptionsWindow = {</span>
<a href="#l6.392"></a><span id="l6.392">     // XXX only dealing with flat OPML files for now.</span>
<a href="#l6.393"></a><span id="l6.393">     // We still need to add support for grouped files.</span>
<a href="#l6.394"></a><span id="l6.394">     let newFeedUrl = aOutline.getAttribute(&quot;xmlUrl&quot;) ||</span>
<a href="#l6.395"></a><span id="l6.395">                      aOutline.getAttribute(&quot;url&quot;);</span>
<a href="#l6.396"></a><span id="l6.396">     if (!newFeedUrl)</span>
<a href="#l6.397"></a><span id="l6.397">       return -1;</span>
<a href="#l6.398"></a><span id="l6.398"> </span>
<a href="#l6.399"></a><span id="l6.399">     // Silently skip feeds that are already subscribed.</span>
<a href="#l6.400"></a><span id="l6.400" class="difflineminus">-    if (feedAlreadyExists(newFeedUrl, this.mRSSServer))</span>
<a href="#l6.401"></a><span id="l6.401" class="difflineplus">+    if (FeedUtils.feedAlreadyExists(newFeedUrl, this.mRSSServer))</span>
<a href="#l6.402"></a><span id="l6.402">     {</span>
<a href="#l6.403"></a><span id="l6.403">       FeedUtils.log.debug(&quot;importOutline: already subscribed in account &quot;+</span>
<a href="#l6.404"></a><span id="l6.404">                           this.mRSSServer.prettyName+&quot;, url - &quot;+ newFeedUrl);</span>
<a href="#l6.405"></a><span id="l6.405">       return 0;</span>
<a href="#l6.406"></a><span id="l6.406">     }</span>
<a href="#l6.407"></a><span id="l6.407"> </span>
<a href="#l6.408"></a><span id="l6.408">     let feedName = aOutline.getAttribute(&quot;text&quot;) ||</span>
<a href="#l6.409"></a><span id="l6.409">                    aOutline.getAttribute(&quot;title&quot;) ||</span>
<a href="#l6.410"></a><span id="l6.410" class="difflineat">@@ -1841,17 +1844,17 @@ var gFeedSubscriptionsWindow = {</span>
<a href="#l6.411"></a><span id="l6.411">                         feedName+&quot;, &quot;+newFeedUrl);</span>
<a href="#l6.412"></a><span id="l6.412"> </span>
<a href="#l6.413"></a><span id="l6.413">     let feed = this.storeFeed(feedProperties);</span>
<a href="#l6.414"></a><span id="l6.414">     feed.title = feedProperties.feedName;</span>
<a href="#l6.415"></a><span id="l6.415">     if (aOutline.hasAttribute(&quot;htmlUrl&quot;))</span>
<a href="#l6.416"></a><span id="l6.416">       feed.link = aOutline.getAttribute(&quot;htmlUrl&quot;);</span>
<a href="#l6.417"></a><span id="l6.417"> </span>
<a href="#l6.418"></a><span id="l6.418">     feed.createFolder();</span>
<a href="#l6.419"></a><span id="l6.419" class="difflineminus">-    updateFolderFeedUrl(feed.folder, feed.url, false);</span>
<a href="#l6.420"></a><span id="l6.420" class="difflineplus">+    FeedUtils.updateFolderFeedUrl(feed.folder, feed.url, false);</span>
<a href="#l6.421"></a><span id="l6.421"> </span>
<a href="#l6.422"></a><span id="l6.422">     // addFeed adds the feed we have validated and downloaded to</span>
<a href="#l6.423"></a><span id="l6.423">     // our datasource, it also flushes the subscription datasource.</span>
<a href="#l6.424"></a><span id="l6.424" class="difflineminus">-    addFeed(feed.url, feed.name, feed.folder);</span>
<a href="#l6.425"></a><span id="l6.425" class="difflineplus">+    FeedUtils.addFeed(feed.url, feed.name, feed.folder);</span>
<a href="#l6.426"></a><span id="l6.426">     // Feed correctly added.</span>
<a href="#l6.427"></a><span id="l6.427">     return 1;</span>
<a href="#l6.428"></a><span id="l6.428">   }</span>
<a href="#l6.429"></a><span id="l6.429"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/extensions/newsblog/content/feed-subscriptions.xul</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/extensions/newsblog/content/feed-subscriptions.xul</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -58,18 +58,16 @@</span>
<a href="#l7.4"></a><span id="l7.4">         onkeypress=&quot;gFeedSubscriptionsWindow.onKeyPress(event);&quot;</span>
<a href="#l7.5"></a><span id="l7.5">         onmousedown=&quot;gFeedSubscriptionsWindow.onMouseDown(event);&quot;&gt;</span>
<a href="#l7.6"></a><span id="l7.6"> </span>
<a href="#l7.7"></a><span id="l7.7">   &lt;script type=&quot;application/javascript&quot;</span>
<a href="#l7.8"></a><span id="l7.8">           src=&quot;chrome://messenger-newsblog/content/utils.js&quot;/&gt;</span>
<a href="#l7.9"></a><span id="l7.9">   &lt;script type=&quot;application/javascript&quot;</span>
<a href="#l7.10"></a><span id="l7.10">           src=&quot;chrome://messenger-newsblog/content/file-utils.js&quot;/&gt;</span>
<a href="#l7.11"></a><span id="l7.11">   &lt;script type=&quot;application/javascript&quot;</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-          src=&quot;chrome://messenger-newsblog/content/debug-utils.js&quot;/&gt;</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineminus">-  &lt;script type=&quot;application/javascript&quot;</span>
<a href="#l7.14"></a><span id="l7.14">           src=&quot;chrome://messenger-newsblog/content/feed-subscriptions.js&quot;/&gt;</span>
<a href="#l7.15"></a><span id="l7.15">   &lt;script type=&quot;application/javascript&quot;</span>
<a href="#l7.16"></a><span id="l7.16">           src=&quot;chrome://messenger-newsblog/content/Feed.js&quot;/&gt;</span>
<a href="#l7.17"></a><span id="l7.17">   &lt;script type=&quot;application/javascript&quot;</span>
<a href="#l7.18"></a><span id="l7.18">           src=&quot;chrome://messenger-newsblog/content/FeedItem.js&quot;/&gt;</span>
<a href="#l7.19"></a><span id="l7.19">   &lt;script type=&quot;application/javascript&quot;</span>
<a href="#l7.20"></a><span id="l7.20">           src=&quot;chrome://messenger-newsblog/content/feed-parser.js&quot;/&gt;</span>
<a href="#l7.21"></a><span id="l7.21">   &lt;script type=&quot;application/javascript&quot;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/extensions/newsblog/content/utils.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/extensions/newsblog/content/utils.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -40,31 +40,463 @@</span>
<a href="#l8.4"></a><span id="l8.4"> </span>
<a href="#l8.5"></a><span id="l8.5"> var Cc = Components.classes;</span>
<a href="#l8.6"></a><span id="l8.6"> var Ci = Components.interfaces;</span>
<a href="#l8.7"></a><span id="l8.7"> var Cr = Components.results;</span>
<a href="#l8.8"></a><span id="l8.8"> var Cu = Components.utils;</span>
<a href="#l8.9"></a><span id="l8.9"> </span>
<a href="#l8.10"></a><span id="l8.10"> Cu.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l8.11"></a><span id="l8.11"> Cu.import(&quot;resource:///modules/gloda/log4moz.js&quot;);</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+Cu.import(&quot;resource:///modules/MailUtils.js&quot;);</span>
<a href="#l8.13"></a><span id="l8.13"> Cu.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l8.14"></a><span id="l8.14"> Cu.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l8.15"></a><span id="l8.15"> </span>
<a href="#l8.16"></a><span id="l8.16"> var FeedUtils = {</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineplus">+  MOZ_PARSERERROR_NS: &quot;http://www.mozilla.org/newlayout/xml/parsererror.xml&quot;,</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineplus">+</span>
<a href="#l8.19"></a><span id="l8.19" class="difflineplus">+  RDF_SYNTAX_NS: &quot;http://www.w3.org/1999/02/22-rdf-syntax-ns#&quot;,</span>
<a href="#l8.20"></a><span id="l8.20" class="difflineplus">+  RDF_SYNTAX_TYPE: &quot;http://www.w3.org/1999/02/22-rdf-syntax-ns#type&quot;,</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineplus">+  get RDF_TYPE() { return this.rdf.GetResource(this.RDF_SYNTAX_TYPE) },</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineplus">+</span>
<a href="#l8.23"></a><span id="l8.23" class="difflineplus">+  RSS_090_NS: &quot;http://my.netscape.com/rdf/simple/0.9/&quot;,</span>
<a href="#l8.24"></a><span id="l8.24" class="difflineplus">+</span>
<a href="#l8.25"></a><span id="l8.25" class="difflineplus">+  RSS_NS: &quot;http://purl.org/rss/1.0/&quot;,</span>
<a href="#l8.26"></a><span id="l8.26" class="difflineplus">+  get RSS_CHANNEL()     { return this.rdf.GetResource(this.RSS_NS + &quot;channel&quot;) },</span>
<a href="#l8.27"></a><span id="l8.27" class="difflineplus">+  get RSS_TITLE()       { return this.rdf.GetResource(this.RSS_NS + &quot;title&quot;) },</span>
<a href="#l8.28"></a><span id="l8.28" class="difflineplus">+  get RSS_DESCRIPTION() { return this.rdf.GetResource(this.RSS_NS + &quot;description&quot;) },</span>
<a href="#l8.29"></a><span id="l8.29" class="difflineplus">+  get RSS_ITEMS()       { return this.rdf.GetResource(this.RSS_NS + &quot;items&quot;) },</span>
<a href="#l8.30"></a><span id="l8.30" class="difflineplus">+  get RSS_ITEM()        { return this.rdf.GetResource(this.RSS_NS + &quot;item&quot;) },</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineplus">+  get RSS_LINK()        { return this.rdf.GetResource(this.RSS_NS + &quot;link&quot;) },</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineplus">+</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineplus">+  RSS_CONTENT_NS: &quot;http://purl.org/rss/1.0/modules/content/&quot;,</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineplus">+  get RSS_CONTENT_ENCODED() {</span>
<a href="#l8.35"></a><span id="l8.35" class="difflineplus">+    return this.rdf.GetResource(this.RSS_CONTENT_NS + &quot;encoded&quot;);</span>
<a href="#l8.36"></a><span id="l8.36" class="difflineplus">+  },</span>
<a href="#l8.37"></a><span id="l8.37" class="difflineplus">+</span>
<a href="#l8.38"></a><span id="l8.38" class="difflineplus">+  DC_NS: &quot;http://purl.org/dc/elements/1.1/&quot;,</span>
<a href="#l8.39"></a><span id="l8.39" class="difflineplus">+  get DC_CREATOR()      { return this.rdf.GetResource(this.DC_NS + &quot;creator&quot;) },</span>
<a href="#l8.40"></a><span id="l8.40" class="difflineplus">+  get DC_SUBJECT()      { return this.rdf.GetResource(this.DC_NS + &quot;subject&quot;) },</span>
<a href="#l8.41"></a><span id="l8.41" class="difflineplus">+  get DC_DATE()         { return this.rdf.GetResource(this.DC_NS + &quot;date&quot;) },</span>
<a href="#l8.42"></a><span id="l8.42" class="difflineplus">+  get DC_TITLE()        { return this.rdf.GetResource(this.DC_NS + &quot;title&quot;) },</span>
<a href="#l8.43"></a><span id="l8.43" class="difflineplus">+  get DC_LASTMODIFIED() { return this.rdf.GetResource(this.DC_NS + &quot;lastModified&quot;) },</span>
<a href="#l8.44"></a><span id="l8.44" class="difflineplus">+  get DC_IDENTIFIER()   { return this.rdf.GetResource(this.DC_NS + &quot;identifier&quot;) },</span>
<a href="#l8.45"></a><span id="l8.45" class="difflineplus">+</span>
<a href="#l8.46"></a><span id="l8.46" class="difflineplus">+  FZ_NS: &quot;urn:forumzilla:&quot;,</span>
<a href="#l8.47"></a><span id="l8.47" class="difflineplus">+  FZ_ITEM_NS: &quot;urn:feeditem:&quot;,</span>
<a href="#l8.48"></a><span id="l8.48" class="difflineplus">+  get FZ_ROOT()       { return this.rdf.GetResource(this.FZ_NS + &quot;root&quot;) },</span>
<a href="#l8.49"></a><span id="l8.49" class="difflineplus">+  get FZ_FEEDS()      { return this.rdf.GetResource(this.FZ_NS + &quot;feeds&quot;) },</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineplus">+  get FZ_FEED()       { return this.rdf.GetResource(this.FZ_NS + &quot;feed&quot;) },</span>
<a href="#l8.51"></a><span id="l8.51" class="difflineplus">+  get FZ_QUICKMODE()  { return this.rdf.GetResource(this.FZ_NS + &quot;quickMode&quot;) },</span>
<a href="#l8.52"></a><span id="l8.52" class="difflineplus">+  get FZ_DESTFOLDER() { return this.rdf.GetResource(this.FZ_NS + &quot;destFolder&quot;) },</span>
<a href="#l8.53"></a><span id="l8.53" class="difflineplus">+  get FZ_STORED()     { return this.rdf.GetResource(this.FZ_NS + &quot;stored&quot;) },</span>
<a href="#l8.54"></a><span id="l8.54" class="difflineplus">+  get FZ_VALID()      { return this.rdf.GetResource(this.FZ_NS + &quot;valid&quot;) },</span>
<a href="#l8.55"></a><span id="l8.55" class="difflineplus">+  get FZ_LAST_SEEN_TIMESTAMP() {</span>
<a href="#l8.56"></a><span id="l8.56" class="difflineplus">+    return this.rdf.GetResource(this.FZ_NS + &quot;last-seen-timestamp&quot;);</span>
<a href="#l8.57"></a><span id="l8.57" class="difflineplus">+  },</span>
<a href="#l8.58"></a><span id="l8.58" class="difflineplus">+</span>
<a href="#l8.59"></a><span id="l8.59" class="difflineplus">+  get RDF_LITERAL_TRUE()  { return this.rdf.GetLiteral(&quot;true&quot;) },</span>
<a href="#l8.60"></a><span id="l8.60" class="difflineplus">+  get RDF_LITERAL_FALSE() { return this.rdf.GetLiteral(&quot;false&quot;) },</span>
<a href="#l8.61"></a><span id="l8.61" class="difflineplus">+</span>
<a href="#l8.62"></a><span id="l8.62" class="difflineplus">+  // Atom constants</span>
<a href="#l8.63"></a><span id="l8.63" class="difflineplus">+  ATOM_03_NS: &quot;http://purl.org/atom/ns#&quot;,</span>
<a href="#l8.64"></a><span id="l8.64" class="difflineplus">+  ATOM_IETF_NS: &quot;http://www.w3.org/2005/Atom&quot;,</span>
<a href="#l8.65"></a><span id="l8.65" class="difflineplus">+</span>
<a href="#l8.66"></a><span id="l8.66" class="difflineplus">+  // The approximate amount of time, specified in milliseconds, to leave an</span>
<a href="#l8.67"></a><span id="l8.67" class="difflineplus">+  // item in the RDF cache after the item has dissappeared from feeds.</span>
<a href="#l8.68"></a><span id="l8.68" class="difflineplus">+  // The delay is currently one day.</span>
<a href="#l8.69"></a><span id="l8.69" class="difflineplus">+  INVALID_ITEM_PURGE_DELAY: 24 * 60 * 60 * 1000,</span>
<a href="#l8.70"></a><span id="l8.70" class="difflineplus">+</span>
<a href="#l8.71"></a><span id="l8.71" class="difflineplus">+  // The delimiter used to delimit feed urls in the folder's &quot;feedUrl&quot; property.</span>
<a href="#l8.72"></a><span id="l8.72" class="difflineplus">+  kFeedUrlDelimiter: &quot;|&quot;,</span>
<a href="#l8.73"></a><span id="l8.73">   kBiffMinutesDefault: 100,</span>
<a href="#l8.74"></a><span id="l8.74">   kNewsBlogSuccess: 0,</span>
<a href="#l8.75"></a><span id="l8.75">   // Usually means there was an error trying to parse the feed.</span>
<a href="#l8.76"></a><span id="l8.76">   kNewsBlogInvalidFeed: 1,</span>
<a href="#l8.77"></a><span id="l8.77">   // Generic networking failure when trying to download the feed.</span>
<a href="#l8.78"></a><span id="l8.78">   kNewsBlogRequestFailure: 2,</span>
<a href="#l8.79"></a><span id="l8.79">   kNewsBlogFeedIsBusy: 3,</span>
<a href="#l8.80"></a><span id="l8.80">   // There are no new articles for this feed</span>
<a href="#l8.81"></a><span id="l8.81">   kNewsBlogNoNewItems: 4,</span>
<a href="#l8.82"></a><span id="l8.82"> </span>
<a href="#l8.83"></a><span id="l8.83"> /**</span>
<a href="#l8.84"></a><span id="l8.84" class="difflineplus">+ * Helper routine that checks our subscriptions list array and returns</span>
<a href="#l8.85"></a><span id="l8.85" class="difflineplus">+ * true if the url is already in our list.  This is used to prevent the</span>
<a href="#l8.86"></a><span id="l8.86" class="difflineplus">+ * user from subscribing to the same feed multiple times for the same server.</span>
<a href="#l8.87"></a><span id="l8.87" class="difflineplus">+ * </span>
<a href="#l8.88"></a><span id="l8.88" class="difflineplus">+ * @param  string aUrl                  - the url.</span>
<a href="#l8.89"></a><span id="l8.89" class="difflineplus">+ * @param  nsIMsgIncomingServer aServer - account server.</span>
<a href="#l8.90"></a><span id="l8.90" class="difflineplus">+ * @return boolean                      - true if exists else false.</span>
<a href="#l8.91"></a><span id="l8.91" class="difflineplus">+ */</span>
<a href="#l8.92"></a><span id="l8.92" class="difflineplus">+  feedAlreadyExists: function(aUrl, aServer) {</span>
<a href="#l8.93"></a><span id="l8.93" class="difflineplus">+    let ds = this.getSubscriptionsDS(aServer);</span>
<a href="#l8.94"></a><span id="l8.94" class="difflineplus">+    let feeds = this.getSubscriptionsList(ds);</span>
<a href="#l8.95"></a><span id="l8.95" class="difflineplus">+    return feeds.IndexOf(this.rdf.GetResource(aUrl)) != -1;</span>
<a href="#l8.96"></a><span id="l8.96" class="difflineplus">+  },</span>
<a href="#l8.97"></a><span id="l8.97" class="difflineplus">+</span>
<a href="#l8.98"></a><span id="l8.98" class="difflineplus">+/**</span>
<a href="#l8.99"></a><span id="l8.99" class="difflineplus">+ * Add a feed record to the feeds.rdf database.</span>
<a href="#l8.100"></a><span id="l8.100" class="difflineplus">+ * </span>
<a href="#l8.101"></a><span id="l8.101" class="difflineplus">+ * @param  string aUrl              - feed url.</span>
<a href="#l8.102"></a><span id="l8.102" class="difflineplus">+ * @param  string aTitle            - feed title.</span>
<a href="#l8.103"></a><span id="l8.103" class="difflineplus">+ * @param  nsIMsgFolder aDestFolder - owning folder.</span>
<a href="#l8.104"></a><span id="l8.104" class="difflineplus">+ */</span>
<a href="#l8.105"></a><span id="l8.105" class="difflineplus">+  addFeed: function(aUrl, aTitle, aDestFolder) {</span>
<a href="#l8.106"></a><span id="l8.106" class="difflineplus">+    let ds = this.getSubscriptionsDS(aDestFolder.server);</span>
<a href="#l8.107"></a><span id="l8.107" class="difflineplus">+    let feeds = this.getSubscriptionsList(ds);</span>
<a href="#l8.108"></a><span id="l8.108" class="difflineplus">+</span>
<a href="#l8.109"></a><span id="l8.109" class="difflineplus">+    // Generate a unique ID for the feed.</span>
<a href="#l8.110"></a><span id="l8.110" class="difflineplus">+    let id = aUrl;</span>
<a href="#l8.111"></a><span id="l8.111" class="difflineplus">+    let i = 1;</span>
<a href="#l8.112"></a><span id="l8.112" class="difflineplus">+    while (feeds.IndexOf(this.rdf.GetResource(id)) != -1 &amp;&amp; ++i &lt; 1000)</span>
<a href="#l8.113"></a><span id="l8.113" class="difflineplus">+      id = aUrl + i;</span>
<a href="#l8.114"></a><span id="l8.114" class="difflineplus">+    if (id == 1000)</span>
<a href="#l8.115"></a><span id="l8.115" class="difflineplus">+      throw new Error(&quot;FeedUtils.addFeed: couldn't generate a unique ID &quot; +</span>
<a href="#l8.116"></a><span id="l8.116" class="difflineplus">+                      &quot;for feed &quot; + aUrl);</span>
<a href="#l8.117"></a><span id="l8.117" class="difflineplus">+</span>
<a href="#l8.118"></a><span id="l8.118" class="difflineplus">+    // Add the feed to the list.</span>
<a href="#l8.119"></a><span id="l8.119" class="difflineplus">+    id = this.rdf.GetResource(id);</span>
<a href="#l8.120"></a><span id="l8.120" class="difflineplus">+    feeds.AppendElement(id);</span>
<a href="#l8.121"></a><span id="l8.121" class="difflineplus">+    ds.Assert(id, this.RDF_TYPE, this.FZ_FEED, true);</span>
<a href="#l8.122"></a><span id="l8.122" class="difflineplus">+    ds.Assert(id, this.DC_IDENTIFIER, this.rdf.GetLiteral(aUrl), true);</span>
<a href="#l8.123"></a><span id="l8.123" class="difflineplus">+    if (aTitle)</span>
<a href="#l8.124"></a><span id="l8.124" class="difflineplus">+      ds.Assert(id, this.DC_TITLE, this.rdf.GetLiteral(aTitle), true);</span>
<a href="#l8.125"></a><span id="l8.125" class="difflineplus">+    ds.Assert(id, this.FZ_DESTFOLDER, aDestFolder, true);</span>
<a href="#l8.126"></a><span id="l8.126" class="difflineplus">+    ds.QueryInterface(Ci.nsIRDFRemoteDataSource).Flush();</span>
<a href="#l8.127"></a><span id="l8.127" class="difflineplus">+  },</span>
<a href="#l8.128"></a><span id="l8.128" class="difflineplus">+</span>
<a href="#l8.129"></a><span id="l8.129" class="difflineplus">+/**</span>
<a href="#l8.130"></a><span id="l8.130" class="difflineplus">+ * Delete a feed record from the feeds.rdf database.</span>
<a href="#l8.131"></a><span id="l8.131" class="difflineplus">+ * </span>
<a href="#l8.132"></a><span id="l8.132" class="difflineplus">+ * @param  nsIRDFResource aId           - feed url as rdf resource.</span>
<a href="#l8.133"></a><span id="l8.133" class="difflineplus">+ * @param  nsIMsgIncomingServer aServer - folder's account server.</span>
<a href="#l8.134"></a><span id="l8.134" class="difflineplus">+ * @param  nsIMsgFolder aParentFolder   - owning folder.</span>
<a href="#l8.135"></a><span id="l8.135" class="difflineplus">+ */</span>
<a href="#l8.136"></a><span id="l8.136" class="difflineplus">+  deleteFeed: function(aId, aServer, aParentFolder) {</span>
<a href="#l8.137"></a><span id="l8.137" class="difflineplus">+    let feed = new Feed(aId, aServer);</span>
<a href="#l8.138"></a><span id="l8.138" class="difflineplus">+    let ds = this.getSubscriptionsDS(aServer);</span>
<a href="#l8.139"></a><span id="l8.139" class="difflineplus">+</span>
<a href="#l8.140"></a><span id="l8.140" class="difflineplus">+    if (feed &amp;&amp; ds)</span>
<a href="#l8.141"></a><span id="l8.141" class="difflineplus">+    {</span>
<a href="#l8.142"></a><span id="l8.142" class="difflineplus">+      // Remove the feed from the subscriptions ds.</span>
<a href="#l8.143"></a><span id="l8.143" class="difflineplus">+      let feeds = this.getSubscriptionsList(ds);</span>
<a href="#l8.144"></a><span id="l8.144" class="difflineplus">+      let index = feeds.IndexOf(aId);</span>
<a href="#l8.145"></a><span id="l8.145" class="difflineplus">+      if (index != -1)</span>
<a href="#l8.146"></a><span id="l8.146" class="difflineplus">+        feeds.RemoveElementAt(index, false);</span>
<a href="#l8.147"></a><span id="l8.147" class="difflineplus">+</span>
<a href="#l8.148"></a><span id="l8.148" class="difflineplus">+      // Remove all assertions about the feed from the subscriptions database.</span>
<a href="#l8.149"></a><span id="l8.149" class="difflineplus">+      this.removeAssertions(ds, aId);</span>
<a href="#l8.150"></a><span id="l8.150" class="difflineplus">+      ds.QueryInterface(Ci.nsIRDFRemoteDataSource).Flush();</span>
<a href="#l8.151"></a><span id="l8.151" class="difflineplus">+</span>
<a href="#l8.152"></a><span id="l8.152" class="difflineplus">+      // Remove all assertions about items in the feed from the items database.</span>
<a href="#l8.153"></a><span id="l8.153" class="difflineplus">+      let itemds = this.getItemsDS(aServer);</span>
<a href="#l8.154"></a><span id="l8.154" class="difflineplus">+      feed.invalidateItems();</span>
<a href="#l8.155"></a><span id="l8.155" class="difflineplus">+      feed.removeInvalidItems(true);</span>
<a href="#l8.156"></a><span id="l8.156" class="difflineplus">+      itemds.QueryInterface(Ci.nsIRDFRemoteDataSource).Flush();</span>
<a href="#l8.157"></a><span id="l8.157" class="difflineplus">+  </span>
<a href="#l8.158"></a><span id="l8.158" class="difflineplus">+      // Finally, make sure to remove the url from the folder's feedUrl</span>
<a href="#l8.159"></a><span id="l8.159" class="difflineplus">+      // property.  The correct folder is passed in by the Subscribe dialog or</span>
<a href="#l8.160"></a><span id="l8.160" class="difflineplus">+      // a folder pane folder delete.  The correct current folder cannot be</span>
<a href="#l8.161"></a><span id="l8.161" class="difflineplus">+      // currently determined from the feed's destFolder in the db, as it is not</span>
<a href="#l8.162"></a><span id="l8.162" class="difflineplus">+      // synced with folder pane moves.  Do this at the very end.</span>
<a href="#l8.163"></a><span id="l8.163" class="difflineplus">+      let feedUrl = aId.ValueUTF8;</span>
<a href="#l8.164"></a><span id="l8.164" class="difflineplus">+      this.updateFolderFeedUrl(aParentFolder, feedUrl, true);</span>
<a href="#l8.165"></a><span id="l8.165" class="difflineplus">+    }</span>
<a href="#l8.166"></a><span id="l8.166" class="difflineplus">+  },</span>
<a href="#l8.167"></a><span id="l8.167" class="difflineplus">+</span>
<a href="#l8.168"></a><span id="l8.168" class="difflineplus">+/**</span>
<a href="#l8.169"></a><span id="l8.169" class="difflineplus">+ * Get the list of feed urls for a folder.  For legacy reasons, we try</span>
<a href="#l8.170"></a><span id="l8.170" class="difflineplus">+ * 1) getStringProperty on the folder;</span>
<a href="#l8.171"></a><span id="l8.171" class="difflineplus">+ * 2) getCharProperty on the folder's msgDatabase.dBFolderInfo;</span>
<a href="#l8.172"></a><span id="l8.172" class="difflineplus">+ * 3) directly from the feeds.rdf subscriptions database, as identified by</span>
<a href="#l8.173"></a><span id="l8.173" class="difflineplus">+ *    the destFolder tag (currently not synced on folder moves in folder pane).</span>
<a href="#l8.174"></a><span id="l8.174" class="difflineplus">+ * </span>
<a href="#l8.175"></a><span id="l8.175" class="difflineplus">+ * If folder move/renames are fixed, remove msgDatabase accesses and get the</span>
<a href="#l8.176"></a><span id="l8.176" class="difflineplus">+ * list directly from the feeds db.</span>
<a href="#l8.177"></a><span id="l8.177" class="difflineplus">+ * </span>
<a href="#l8.178"></a><span id="l8.178" class="difflineplus">+ * @param  nsIMsgFolder - the folder.</span>
<a href="#l8.179"></a><span id="l8.179" class="difflineplus">+ * @return array of urls, or null if none.</span>
<a href="#l8.180"></a><span id="l8.180" class="difflineplus">+ */</span>
<a href="#l8.181"></a><span id="l8.181" class="difflineplus">+  getFeedUrlsInFolder: function(aFolder) {</span>
<a href="#l8.182"></a><span id="l8.182" class="difflineplus">+    if (aFolder.isServer || aFolder.getFlag(Ci.nsMsgFolderFlags.Trash))</span>
<a href="#l8.183"></a><span id="l8.183" class="difflineplus">+      // There are never any feedUrls in the account folder or trash folder.</span>
<a href="#l8.184"></a><span id="l8.184" class="difflineplus">+      return null;</span>
<a href="#l8.185"></a><span id="l8.185" class="difflineplus">+</span>
<a href="#l8.186"></a><span id="l8.186" class="difflineplus">+    let feedUrlArray = [];</span>
<a href="#l8.187"></a><span id="l8.187" class="difflineplus">+</span>
<a href="#l8.188"></a><span id="l8.188" class="difflineplus">+    let feedurls = aFolder.getStringProperty(&quot;feedUrl&quot;);</span>
<a href="#l8.189"></a><span id="l8.189" class="difflineplus">+    if (feedurls)</span>
<a href="#l8.190"></a><span id="l8.190" class="difflineplus">+      return feedurls.split(this.kFeedUrlDelimiter);</span>
<a href="#l8.191"></a><span id="l8.191" class="difflineplus">+</span>
<a href="#l8.192"></a><span id="l8.192" class="difflineplus">+    // Go to msgDatabase for the property, make sure to handle errors.</span>
<a href="#l8.193"></a><span id="l8.193" class="difflineplus">+    let msgDb;</span>
<a href="#l8.194"></a><span id="l8.194" class="difflineplus">+    try {</span>
<a href="#l8.195"></a><span id="l8.195" class="difflineplus">+      msgDb = aFolder.msgDatabase;</span>
<a href="#l8.196"></a><span id="l8.196" class="difflineplus">+    }</span>
<a href="#l8.197"></a><span id="l8.197" class="difflineplus">+    catch (ex) {}</span>
<a href="#l8.198"></a><span id="l8.198" class="difflineplus">+    if (msgDb &amp;&amp; msgDb.dBFolderInfo) {</span>
<a href="#l8.199"></a><span id="l8.199" class="difflineplus">+      feedurls = msgDb.dBFolderInfo.getCharProperty(&quot;feedUrl&quot;);</span>
<a href="#l8.200"></a><span id="l8.200" class="difflineplus">+      // Clean up the feedUrl string.</span>
<a href="#l8.201"></a><span id="l8.201" class="difflineplus">+      feedurls.split(this.kFeedUrlDelimiter).forEach(</span>
<a href="#l8.202"></a><span id="l8.202" class="difflineplus">+        function(url) {</span>
<a href="#l8.203"></a><span id="l8.203" class="difflineplus">+          if (url &amp;&amp; feedUrlArray.indexOf(url) == -1)</span>
<a href="#l8.204"></a><span id="l8.204" class="difflineplus">+            feedUrlArray.push(url);</span>
<a href="#l8.205"></a><span id="l8.205" class="difflineplus">+        });</span>
<a href="#l8.206"></a><span id="l8.206" class="difflineplus">+</span>
<a href="#l8.207"></a><span id="l8.207" class="difflineplus">+      feedurls = feedUrlArray.join(this.kFeedUrlDelimiter);</span>
<a href="#l8.208"></a><span id="l8.208" class="difflineplus">+      if (feedurls) {</span>
<a href="#l8.209"></a><span id="l8.209" class="difflineplus">+        // Do a onetime per folder re-sync of the feeds db here based on the</span>
<a href="#l8.210"></a><span id="l8.210" class="difflineplus">+        // urls in the feedUrl property.</span>
<a href="#l8.211"></a><span id="l8.211" class="difflineplus">+        let ds = this.getSubscriptionsDS(aFolder.server);</span>
<a href="#l8.212"></a><span id="l8.212" class="difflineplus">+        let resource = this.rdf.GetResource(aFolder.URI);</span>
<a href="#l8.213"></a><span id="l8.213" class="difflineplus">+        feedUrlArray.forEach(</span>
<a href="#l8.214"></a><span id="l8.214" class="difflineplus">+          function(url) {</span>
<a href="#l8.215"></a><span id="l8.215" class="difflineplus">+            try {</span>
<a href="#l8.216"></a><span id="l8.216" class="difflineplus">+              let id = this.rdf.GetResource(url);</span>
<a href="#l8.217"></a><span id="l8.217" class="difflineplus">+              // Get the node for the current folder URI.</span>
<a href="#l8.218"></a><span id="l8.218" class="difflineplus">+              let node = ds.GetTarget(id, this.FZ_DESTFOLDER, true);</span>
<a href="#l8.219"></a><span id="l8.219" class="difflineplus">+              if (node)</span>
<a href="#l8.220"></a><span id="l8.220" class="difflineplus">+              {</span>
<a href="#l8.221"></a><span id="l8.221" class="difflineplus">+                ds.Change(id, this.FZ_DESTFOLDER, node, resource);</span>
<a href="#l8.222"></a><span id="l8.222" class="difflineplus">+                this.log.debug(&quot;getFeedUrlsInFolder: sync update folder:url - &quot; +</span>
<a href="#l8.223"></a><span id="l8.223" class="difflineplus">+                               aFolder.filePath.path+&quot; : &quot;+url);</span>
<a href="#l8.224"></a><span id="l8.224" class="difflineplus">+              }</span>
<a href="#l8.225"></a><span id="l8.225" class="difflineplus">+              else</span>
<a href="#l8.226"></a><span id="l8.226" class="difflineplus">+              {</span>
<a href="#l8.227"></a><span id="l8.227" class="difflineplus">+                this.addFeed(url, null, aFolder);</span>
<a href="#l8.228"></a><span id="l8.228" class="difflineplus">+                this.log.debug(&quot;getFeedUrlsInFolder: sync add folder:url - &quot; +</span>
<a href="#l8.229"></a><span id="l8.229" class="difflineplus">+                               aFolder.filePath.path+&quot; : &quot;+url);</span>
<a href="#l8.230"></a><span id="l8.230" class="difflineplus">+              }</span>
<a href="#l8.231"></a><span id="l8.231" class="difflineplus">+            }</span>
<a href="#l8.232"></a><span id="l8.232" class="difflineplus">+            catch (ex) {</span>
<a href="#l8.233"></a><span id="l8.233" class="difflineplus">+              this.log.debug(&quot;getFeedUrlsInFolder: error - &quot; + ex);</span>
<a href="#l8.234"></a><span id="l8.234" class="difflineplus">+              this.log.debug(&quot;getFeedUrlsInFolder: sync failed for folder:url - &quot; +</span>
<a href="#l8.235"></a><span id="l8.235" class="difflineplus">+                             aFolder.filePath.path+&quot; : &quot;+url);</span>
<a href="#l8.236"></a><span id="l8.236" class="difflineplus">+            }</span>
<a href="#l8.237"></a><span id="l8.237" class="difflineplus">+        }, this);</span>
<a href="#l8.238"></a><span id="l8.238" class="difflineplus">+        ds.QueryInterface(Ci.nsIRDFRemoteDataSource).Flush();</span>
<a href="#l8.239"></a><span id="l8.239" class="difflineplus">+  </span>
<a href="#l8.240"></a><span id="l8.240" class="difflineplus">+        // Set property on folder so we don't come here ever again.</span>
<a href="#l8.241"></a><span id="l8.241" class="difflineplus">+        aFolder.setStringProperty(&quot;feedUrl&quot;, feedurls);</span>
<a href="#l8.242"></a><span id="l8.242" class="difflineplus">+        aFolder.msgDatabase = null;</span>
<a href="#l8.243"></a><span id="l8.243" class="difflineplus">+  </span>
<a href="#l8.244"></a><span id="l8.244" class="difflineplus">+        return feedUrlArray.length ? feedUrlArray : null;</span>
<a href="#l8.245"></a><span id="l8.245" class="difflineplus">+      }</span>
<a href="#l8.246"></a><span id="l8.246" class="difflineplus">+    }</span>
<a href="#l8.247"></a><span id="l8.247" class="difflineplus">+    else {</span>
<a href="#l8.248"></a><span id="l8.248" class="difflineplus">+      // Forcing a reparse with listener here is the last resort.  Not implemented</span>
<a href="#l8.249"></a><span id="l8.249" class="difflineplus">+      // as it may be unnecessary once feedUrl is property set on folder and not</span>
<a href="#l8.250"></a><span id="l8.250" class="difflineplus">+      // msgDatabase, and if eventually feedUrls are derived from the feeds db</span>
<a href="#l8.251"></a><span id="l8.251" class="difflineplus">+      // directly.</span>
<a href="#l8.252"></a><span id="l8.252" class="difflineplus">+    }</span>
<a href="#l8.253"></a><span id="l8.253" class="difflineplus">+  </span>
<a href="#l8.254"></a><span id="l8.254" class="difflineplus">+    // Get the list from the feeds database.</span>
<a href="#l8.255"></a><span id="l8.255" class="difflineplus">+    try {</span>
<a href="#l8.256"></a><span id="l8.256" class="difflineplus">+      let ds = this.getSubscriptionsDS(aFolder.server);</span>
<a href="#l8.257"></a><span id="l8.257" class="difflineplus">+      let enumerator = ds.GetSources(this.FZ_DESTFOLDER, aFolder, true);</span>
<a href="#l8.258"></a><span id="l8.258" class="difflineplus">+      while (enumerator.hasMoreElements())</span>
<a href="#l8.259"></a><span id="l8.259" class="difflineplus">+      {</span>
<a href="#l8.260"></a><span id="l8.260" class="difflineplus">+        let containerArc = enumerator.getNext();</span>
<a href="#l8.261"></a><span id="l8.261" class="difflineplus">+        let uri = containerArc.QueryInterface(Ci.nsIRDFResource).Value;</span>
<a href="#l8.262"></a><span id="l8.262" class="difflineplus">+        feedUrlArray.push(uri);</span>
<a href="#l8.263"></a><span id="l8.263" class="difflineplus">+      }</span>
<a href="#l8.264"></a><span id="l8.264" class="difflineplus">+    }</span>
<a href="#l8.265"></a><span id="l8.265" class="difflineplus">+    catch(ex)</span>
<a href="#l8.266"></a><span id="l8.266" class="difflineplus">+    {</span>
<a href="#l8.267"></a><span id="l8.267" class="difflineplus">+      this.log.debug(&quot;getFeedUrlsInFolder: feeds db error - &quot; + ex);</span>
<a href="#l8.268"></a><span id="l8.268" class="difflineplus">+      this.log.debug(&quot;getFeedUrlsInFolder: feeds db error for folder - &quot; +</span>
<a href="#l8.269"></a><span id="l8.269" class="difflineplus">+                     aFolder.filePath.path);</span>
<a href="#l8.270"></a><span id="l8.270" class="difflineplus">+    }</span>
<a href="#l8.271"></a><span id="l8.271" class="difflineplus">+  </span>
<a href="#l8.272"></a><span id="l8.272" class="difflineplus">+    feedurls = feedUrlArray.join(this.kFeedUrlDelimiter);</span>
<a href="#l8.273"></a><span id="l8.273" class="difflineplus">+    if (feedurls)</span>
<a href="#l8.274"></a><span id="l8.274" class="difflineplus">+    {</span>
<a href="#l8.275"></a><span id="l8.275" class="difflineplus">+      aFolder.setStringProperty(&quot;feedUrl&quot;, feedurls);</span>
<a href="#l8.276"></a><span id="l8.276" class="difflineplus">+      this.log.debug(&quot;getFeedUrlsInFolder: got urls from db, folder:feedUrl - &quot; +</span>
<a href="#l8.277"></a><span id="l8.277" class="difflineplus">+                     aFolder.filePath.path+&quot; : &quot;+feedurls);</span>
<a href="#l8.278"></a><span id="l8.278" class="difflineplus">+    }</span>
<a href="#l8.279"></a><span id="l8.279" class="difflineplus">+    else</span>
<a href="#l8.280"></a><span id="l8.280" class="difflineplus">+      this.log.trace(&quot;getFeedUrlsInFolder: no urls from db, folder - &quot; +</span>
<a href="#l8.281"></a><span id="l8.281" class="difflineplus">+                     aFolder.filePath.path);</span>
<a href="#l8.282"></a><span id="l8.282" class="difflineplus">+  </span>
<a href="#l8.283"></a><span id="l8.283" class="difflineplus">+    return feedUrlArray.length ? feedUrlArray : null;</span>
<a href="#l8.284"></a><span id="l8.284" class="difflineplus">+  },</span>
<a href="#l8.285"></a><span id="l8.285" class="difflineplus">+</span>
<a href="#l8.286"></a><span id="l8.286" class="difflineplus">+/**</span>
<a href="#l8.287"></a><span id="l8.287" class="difflineplus">+ * Add or remove urls from feedUrl folder property.  Property is used for</span>
<a href="#l8.288"></a><span id="l8.288" class="difflineplus">+ * access to a folder's feeds in Subscribe dialog and when doing downloadFeed</span>
<a href="#l8.289"></a><span id="l8.289" class="difflineplus">+ * on a folder.  Ensure no dupes.</span>
<a href="#l8.290"></a><span id="l8.290" class="difflineplus">+ * </span>
<a href="#l8.291"></a><span id="l8.291" class="difflineplus">+ * @param  nsIMsgFolder - the folder.</span>
<a href="#l8.292"></a><span id="l8.292" class="difflineplus">+ * @param  string       - the feed's url.</span>
<a href="#l8.293"></a><span id="l8.293" class="difflineplus">+ * @param  boolean      - true if removing the url.</span>
<a href="#l8.294"></a><span id="l8.294" class="difflineplus">+ */</span>
<a href="#l8.295"></a><span id="l8.295" class="difflineplus">+  updateFolderFeedUrl: function(aFolder, aFeedUrl, aRemoveUrl) {</span>
<a href="#l8.296"></a><span id="l8.296" class="difflineplus">+    if (!aFeedUrl)</span>
<a href="#l8.297"></a><span id="l8.297" class="difflineplus">+      return;</span>
<a href="#l8.298"></a><span id="l8.298" class="difflineplus">+</span>
<a href="#l8.299"></a><span id="l8.299" class="difflineplus">+    let curFeedUrls = aFolder.getStringProperty(&quot;feedUrl&quot;);</span>
<a href="#l8.300"></a><span id="l8.300" class="difflineplus">+    curFeedUrls = curFeedUrls ? curFeedUrls.split(this.kFeedUrlDelimiter) : [];</span>
<a href="#l8.301"></a><span id="l8.301" class="difflineplus">+    let index = curFeedUrls.indexOf(aFeedUrl);</span>
<a href="#l8.302"></a><span id="l8.302" class="difflineplus">+</span>
<a href="#l8.303"></a><span id="l8.303" class="difflineplus">+    if (aRemoveUrl)</span>
<a href="#l8.304"></a><span id="l8.304" class="difflineplus">+    {</span>
<a href="#l8.305"></a><span id="l8.305" class="difflineplus">+      if (index == -1)</span>
<a href="#l8.306"></a><span id="l8.306" class="difflineplus">+        return;</span>
<a href="#l8.307"></a><span id="l8.307" class="difflineplus">+      curFeedUrls.splice(index, 1);</span>
<a href="#l8.308"></a><span id="l8.308" class="difflineplus">+    }</span>
<a href="#l8.309"></a><span id="l8.309" class="difflineplus">+    else {</span>
<a href="#l8.310"></a><span id="l8.310" class="difflineplus">+      if (index != -1)</span>
<a href="#l8.311"></a><span id="l8.311" class="difflineplus">+        return;</span>
<a href="#l8.312"></a><span id="l8.312" class="difflineplus">+      curFeedUrls.push(aFeedUrl);</span>
<a href="#l8.313"></a><span id="l8.313" class="difflineplus">+    }</span>
<a href="#l8.314"></a><span id="l8.314" class="difflineplus">+</span>
<a href="#l8.315"></a><span id="l8.315" class="difflineplus">+    let newFeedUrls = curFeedUrls.join(this.kFeedUrlDelimiter);</span>
<a href="#l8.316"></a><span id="l8.316" class="difflineplus">+    aFolder.setStringProperty(&quot;feedUrl&quot;, newFeedUrls);</span>
<a href="#l8.317"></a><span id="l8.317" class="difflineplus">+  },</span>
<a href="#l8.318"></a><span id="l8.318" class="difflineplus">+</span>
<a href="#l8.319"></a><span id="l8.319" class="difflineplus">+  getSubscriptionsDS: function(aServer) {</span>
<a href="#l8.320"></a><span id="l8.320" class="difflineplus">+    let file = this.getSubscriptionsFile(aServer);</span>
<a href="#l8.321"></a><span id="l8.321" class="difflineplus">+    let url = Services.io.getProtocolHandler(&quot;file&quot;).</span>
<a href="#l8.322"></a><span id="l8.322" class="difflineplus">+                          QueryInterface(Ci.nsIFileProtocolHandler).</span>
<a href="#l8.323"></a><span id="l8.323" class="difflineplus">+                          getURLSpecFromFile(file);</span>
<a href="#l8.324"></a><span id="l8.324" class="difflineplus">+</span>
<a href="#l8.325"></a><span id="l8.325" class="difflineplus">+    // GetDataSourceBlocking has a cache, so it's cheap to do this again</span>
<a href="#l8.326"></a><span id="l8.326" class="difflineplus">+    // once we've already done it once.</span>
<a href="#l8.327"></a><span id="l8.327" class="difflineplus">+    let ds = this.rdf.GetDataSourceBlocking(url);</span>
<a href="#l8.328"></a><span id="l8.328" class="difflineplus">+</span>
<a href="#l8.329"></a><span id="l8.329" class="difflineplus">+    if (!ds)</span>
<a href="#l8.330"></a><span id="l8.330" class="difflineplus">+      throw new Error(&quot;FeedUtils.getSubscriptionsDS: can't get feed &quot; +</span>
<a href="#l8.331"></a><span id="l8.331" class="difflineplus">+                      &quot;subscriptions data source - &quot; + url);</span>
<a href="#l8.332"></a><span id="l8.332" class="difflineplus">+</span>
<a href="#l8.333"></a><span id="l8.333" class="difflineplus">+    return ds;</span>
<a href="#l8.334"></a><span id="l8.334" class="difflineplus">+  },</span>
<a href="#l8.335"></a><span id="l8.335" class="difflineplus">+</span>
<a href="#l8.336"></a><span id="l8.336" class="difflineplus">+  getSubscriptionsList: function(aDataSource) {</span>
<a href="#l8.337"></a><span id="l8.337" class="difflineplus">+    let list = aDataSource.GetTarget(this.FZ_ROOT, this.FZ_FEEDS, true);</span>
<a href="#l8.338"></a><span id="l8.338" class="difflineplus">+    list = list.QueryInterface(Ci.nsIRDFResource);</span>
<a href="#l8.339"></a><span id="l8.339" class="difflineplus">+    list = this.rdfContainerUtils.MakeSeq(aDataSource, list);</span>
<a href="#l8.340"></a><span id="l8.340" class="difflineplus">+    return list;</span>
<a href="#l8.341"></a><span id="l8.341" class="difflineplus">+  },</span>
<a href="#l8.342"></a><span id="l8.342" class="difflineplus">+</span>
<a href="#l8.343"></a><span id="l8.343" class="difflineplus">+  getSubscriptionsFile: function(aServer) {</span>
<a href="#l8.344"></a><span id="l8.344" class="difflineplus">+    aServer.QueryInterface(Ci.nsIRssIncomingServer);</span>
<a href="#l8.345"></a><span id="l8.345" class="difflineplus">+    let file = aServer.subscriptionsDataSourcePath;</span>
<a href="#l8.346"></a><span id="l8.346" class="difflineplus">+</span>
<a href="#l8.347"></a><span id="l8.347" class="difflineplus">+    // If the file doesn't exist, create it.</span>
<a href="#l8.348"></a><span id="l8.348" class="difflineplus">+    if (!file.exists())</span>
<a href="#l8.349"></a><span id="l8.349" class="difflineplus">+      this.createSubscriptionsFile(file);</span>
<a href="#l8.350"></a><span id="l8.350" class="difflineplus">+</span>
<a href="#l8.351"></a><span id="l8.351" class="difflineplus">+    return file;</span>
<a href="#l8.352"></a><span id="l8.352" class="difflineplus">+  },</span>
<a href="#l8.353"></a><span id="l8.353" class="difflineplus">+</span>
<a href="#l8.354"></a><span id="l8.354" class="difflineplus">+  FEEDS_TEMPLATE: '&lt;?xml version=&quot;1.0&quot;?&gt;\n' +</span>
<a href="#l8.355"></a><span id="l8.355" class="difflineplus">+    '&lt;RDF:RDF xmlns:dc=&quot;http://purl.org/dc/elements/1.1/&quot;\n' +</span>
<a href="#l8.356"></a><span id="l8.356" class="difflineplus">+    '         xmlns:fz=&quot;urn:forumzilla:&quot;\n' +</span>
<a href="#l8.357"></a><span id="l8.357" class="difflineplus">+    '         xmlns:RDF=&quot;http://www.w3.org/1999/02/22-rdf-syntax-ns#&quot;&gt;\n' +</span>
<a href="#l8.358"></a><span id="l8.358" class="difflineplus">+    '  &lt;RDF:Description about=&quot;urn:forumzilla:root&quot;&gt;\n' +</span>
<a href="#l8.359"></a><span id="l8.359" class="difflineplus">+    '    &lt;fz:feeds&gt;\n' +</span>
<a href="#l8.360"></a><span id="l8.360" class="difflineplus">+    '      &lt;RDF:Seq&gt;\n' +</span>
<a href="#l8.361"></a><span id="l8.361" class="difflineplus">+    '      &lt;/RDF:Seq&gt;\n' +</span>
<a href="#l8.362"></a><span id="l8.362" class="difflineplus">+    '    &lt;/fz:feeds&gt;\n' +</span>
<a href="#l8.363"></a><span id="l8.363" class="difflineplus">+    '  &lt;/RDF:Description&gt;\n' +</span>
<a href="#l8.364"></a><span id="l8.364" class="difflineplus">+    '&lt;/RDF:RDF&gt;\n',</span>
<a href="#l8.365"></a><span id="l8.365" class="difflineplus">+</span>
<a href="#l8.366"></a><span id="l8.366" class="difflineplus">+  createSubscriptionsFile: function(aFile) {</span>
<a href="#l8.367"></a><span id="l8.367" class="difflineplus">+    let file = new LocalFile(aFile, MODE_WRONLY | MODE_CREATE);</span>
<a href="#l8.368"></a><span id="l8.368" class="difflineplus">+    file.write(this.FEEDS_TEMPLATE);</span>
<a href="#l8.369"></a><span id="l8.369" class="difflineplus">+    file.close();</span>
<a href="#l8.370"></a><span id="l8.370" class="difflineplus">+  },</span>
<a href="#l8.371"></a><span id="l8.371" class="difflineplus">+</span>
<a href="#l8.372"></a><span id="l8.372" class="difflineplus">+  getItemsDS: function(aServer) {</span>
<a href="#l8.373"></a><span id="l8.373" class="difflineplus">+    let file = this.getItemsFile(aServer);</span>
<a href="#l8.374"></a><span id="l8.374" class="difflineplus">+    let url = Services.io.getProtocolHandler(&quot;file&quot;).</span>
<a href="#l8.375"></a><span id="l8.375" class="difflineplus">+                          QueryInterface(Ci.nsIFileProtocolHandler).</span>
<a href="#l8.376"></a><span id="l8.376" class="difflineplus">+                          getURLSpecFromFile(file);</span>
<a href="#l8.377"></a><span id="l8.377" class="difflineplus">+</span>
<a href="#l8.378"></a><span id="l8.378" class="difflineplus">+    // GetDataSourceBlocking has a cache, so it's cheap to do this again</span>
<a href="#l8.379"></a><span id="l8.379" class="difflineplus">+    // once we've already done it once.</span>
<a href="#l8.380"></a><span id="l8.380" class="difflineplus">+    let ds = this.rdf.GetDataSourceBlocking(url);</span>
<a href="#l8.381"></a><span id="l8.381" class="difflineplus">+    if (!ds)</span>
<a href="#l8.382"></a><span id="l8.382" class="difflineplus">+      throw new Error(&quot;FeedUtils.getItemsDS: can't get feed items &quot; +</span>
<a href="#l8.383"></a><span id="l8.383" class="difflineplus">+                      &quot;data source - &quot; + url);</span>
<a href="#l8.384"></a><span id="l8.384" class="difflineplus">+</span>
<a href="#l8.385"></a><span id="l8.385" class="difflineplus">+    // Note that it this point the datasource may not be loaded yet.</span>
<a href="#l8.386"></a><span id="l8.386" class="difflineplus">+    // You have to QueryInterface it to nsIRDFRemoteDataSource and check</span>
<a href="#l8.387"></a><span id="l8.387" class="difflineplus">+    // its &quot;loaded&quot; property to be sure.  You can also attach an observer</span>
<a href="#l8.388"></a><span id="l8.388" class="difflineplus">+    // which will get notified when the load is complete.</span>
<a href="#l8.389"></a><span id="l8.389" class="difflineplus">+    return ds;</span>
<a href="#l8.390"></a><span id="l8.390" class="difflineplus">+  },</span>
<a href="#l8.391"></a><span id="l8.391" class="difflineplus">+</span>
<a href="#l8.392"></a><span id="l8.392" class="difflineplus">+  FEEDITEMS_TEMPLATE: '&lt;?xml version=&quot;1.0&quot;?&gt;\n' +</span>
<a href="#l8.393"></a><span id="l8.393" class="difflineplus">+    '&lt;RDF:RDF xmlns:dc=&quot;http://purl.org/dc/elements/1.1/&quot;\n' +</span>
<a href="#l8.394"></a><span id="l8.394" class="difflineplus">+    '         xmlns:fz=&quot;urn:forumzilla:&quot;\n' +</span>
<a href="#l8.395"></a><span id="l8.395" class="difflineplus">+    '         xmlns:RDF=&quot;http://www.w3.org/1999/02/22-rdf-syntax-ns#&quot;&gt;\n' +</span>
<a href="#l8.396"></a><span id="l8.396" class="difflineplus">+    '&lt;/RDF:RDF&gt;\n',</span>
<a href="#l8.397"></a><span id="l8.397" class="difflineplus">+</span>
<a href="#l8.398"></a><span id="l8.398" class="difflineplus">+  getItemsFile: function(aServer) {</span>
<a href="#l8.399"></a><span id="l8.399" class="difflineplus">+    aServer.QueryInterface(Ci.nsIRssIncomingServer);</span>
<a href="#l8.400"></a><span id="l8.400" class="difflineplus">+    let file = aServer.feedItemsDataSourcePath;</span>
<a href="#l8.401"></a><span id="l8.401" class="difflineplus">+</span>
<a href="#l8.402"></a><span id="l8.402" class="difflineplus">+    // If the file doesn't exist, create it.</span>
<a href="#l8.403"></a><span id="l8.403" class="difflineplus">+    if (!file.exists())</span>
<a href="#l8.404"></a><span id="l8.404" class="difflineplus">+    {</span>
<a href="#l8.405"></a><span id="l8.405" class="difflineplus">+      let newfile = new LocalFile(file, MODE_WRONLY | MODE_CREATE);</span>
<a href="#l8.406"></a><span id="l8.406" class="difflineplus">+      newfile.write(this.FEEDITEMS_TEMPLATE);</span>
<a href="#l8.407"></a><span id="l8.407" class="difflineplus">+      newfile.close();</span>
<a href="#l8.408"></a><span id="l8.408" class="difflineplus">+    }</span>
<a href="#l8.409"></a><span id="l8.409" class="difflineplus">+</span>
<a href="#l8.410"></a><span id="l8.410" class="difflineplus">+    return file;</span>
<a href="#l8.411"></a><span id="l8.411" class="difflineplus">+  },</span>
<a href="#l8.412"></a><span id="l8.412" class="difflineplus">+</span>
<a href="#l8.413"></a><span id="l8.413" class="difflineplus">+  getParentTargetForChildResource: function(aChildResource, aParentTarget,</span>
<a href="#l8.414"></a><span id="l8.414" class="difflineplus">+                                            aServer) {</span>
<a href="#l8.415"></a><span id="l8.415" class="difflineplus">+    // Generic get feed property, based on child value. Assumes 1 unique</span>
<a href="#l8.416"></a><span id="l8.416" class="difflineplus">+    // child value with 1 unique parent, valid for feeds.rdf structure.</span>
<a href="#l8.417"></a><span id="l8.417" class="difflineplus">+    let ds = this.getSubscriptionsDS(aServer);</span>
<a href="#l8.418"></a><span id="l8.418" class="difflineplus">+    let childRes = this.rdf.GetResource(aChildResource);</span>
<a href="#l8.419"></a><span id="l8.419" class="difflineplus">+    let parent = null;</span>
<a href="#l8.420"></a><span id="l8.420" class="difflineplus">+</span>
<a href="#l8.421"></a><span id="l8.421" class="difflineplus">+    let arcsIn = ds.ArcLabelsIn(childRes);</span>
<a href="#l8.422"></a><span id="l8.422" class="difflineplus">+    while (arcsIn.hasMoreElements())</span>
<a href="#l8.423"></a><span id="l8.423" class="difflineplus">+    {</span>
<a href="#l8.424"></a><span id="l8.424" class="difflineplus">+      let arc = arcsIn.getNext();</span>
<a href="#l8.425"></a><span id="l8.425" class="difflineplus">+      if (arc instanceof Ci.nsIRDFResource)</span>
<a href="#l8.426"></a><span id="l8.426" class="difflineplus">+      {</span>
<a href="#l8.427"></a><span id="l8.427" class="difflineplus">+        parent = ds.GetSource(arc, childRes, true);</span>
<a href="#l8.428"></a><span id="l8.428" class="difflineplus">+        parent = parent.QueryInterface(Ci.nsIRDFResource);</span>
<a href="#l8.429"></a><span id="l8.429" class="difflineplus">+        break;</span>
<a href="#l8.430"></a><span id="l8.430" class="difflineplus">+      }</span>
<a href="#l8.431"></a><span id="l8.431" class="difflineplus">+    }</span>
<a href="#l8.432"></a><span id="l8.432" class="difflineplus">+</span>
<a href="#l8.433"></a><span id="l8.433" class="difflineplus">+    if (parent)</span>
<a href="#l8.434"></a><span id="l8.434" class="difflineplus">+    {</span>
<a href="#l8.435"></a><span id="l8.435" class="difflineplus">+      let resource = this.rdf.GetResource(parent.Value);</span>
<a href="#l8.436"></a><span id="l8.436" class="difflineplus">+      return ds.GetTarget(resource, aParentTarget, true);</span>
<a href="#l8.437"></a><span id="l8.437" class="difflineplus">+    }</span>
<a href="#l8.438"></a><span id="l8.438" class="difflineplus">+</span>
<a href="#l8.439"></a><span id="l8.439" class="difflineplus">+    return null;</span>
<a href="#l8.440"></a><span id="l8.440" class="difflineplus">+  },</span>
<a href="#l8.441"></a><span id="l8.441" class="difflineplus">+</span>
<a href="#l8.442"></a><span id="l8.442" class="difflineplus">+  removeAssertions: function(aDataSource, aResource) {</span>
<a href="#l8.443"></a><span id="l8.443" class="difflineplus">+    let properties = aDataSource.ArcLabelsOut(aResource);</span>
<a href="#l8.444"></a><span id="l8.444" class="difflineplus">+    let property;</span>
<a href="#l8.445"></a><span id="l8.445" class="difflineplus">+    while (properties.hasMoreElements())</span>
<a href="#l8.446"></a><span id="l8.446" class="difflineplus">+    {</span>
<a href="#l8.447"></a><span id="l8.447" class="difflineplus">+      property = properties.getNext();</span>
<a href="#l8.448"></a><span id="l8.448" class="difflineplus">+      let values = aDataSource.GetTargets(aResource, property, true);</span>
<a href="#l8.449"></a><span id="l8.449" class="difflineplus">+      let value;</span>
<a href="#l8.450"></a><span id="l8.450" class="difflineplus">+      while (values.hasMoreElements())</span>
<a href="#l8.451"></a><span id="l8.451" class="difflineplus">+      {</span>
<a href="#l8.452"></a><span id="l8.452" class="difflineplus">+        value = values.getNext();</span>
<a href="#l8.453"></a><span id="l8.453" class="difflineplus">+        aDataSource.Unassert(aResource, property, value, true);</span>
<a href="#l8.454"></a><span id="l8.454" class="difflineplus">+      }</span>
<a href="#l8.455"></a><span id="l8.455" class="difflineplus">+    }</span>
<a href="#l8.456"></a><span id="l8.456" class="difflineplus">+  },</span>
<a href="#l8.457"></a><span id="l8.457" class="difflineplus">+</span>
<a href="#l8.458"></a><span id="l8.458" class="difflineplus">+/**</span>
<a href="#l8.459"></a><span id="l8.459">  * Dragging something from somewhere.  It may be a nice x-moz-url or from a</span>
<a href="#l8.460"></a><span id="l8.460">  * browser or app that provides a less nice dataTransfer object in the event.</span>
<a href="#l8.461"></a><span id="l8.461">  * Extract the url and if it passes the scheme test, try to subscribe.</span>
<a href="#l8.462"></a><span id="l8.462">  * </span>
<a href="#l8.463"></a><span id="l8.463">  * @param  nsIDOMDataTransfer aDataTransfer  - the dnd event's dataTransfer.</span>
<a href="#l8.464"></a><span id="l8.464">  * @return nsIURI uri                        - a uri if valid, null if none.</span>
<a href="#l8.465"></a><span id="l8.465">  */</span>
<a href="#l8.466"></a><span id="l8.466">   getFeedUriFromDataTransfer: function(aDataTransfer) {</span>
<a href="#l8.467"></a><span id="l8.467" class="difflineat">@@ -74,34 +506,34 @@ var FeedUtils = {</span>
<a href="#l8.468"></a><span id="l8.468">     let uri = Cc[&quot;@mozilla.org/network/standard-url;1&quot;].</span>
<a href="#l8.469"></a><span id="l8.469">               createInstance(Ci.nsIURI);</span>
<a href="#l8.470"></a><span id="l8.470"> </span>
<a href="#l8.471"></a><span id="l8.471">     if (dt.getData(types[0]))</span>
<a href="#l8.472"></a><span id="l8.472">     {</span>
<a href="#l8.473"></a><span id="l8.473">       // The url is the data.</span>
<a href="#l8.474"></a><span id="l8.474">       uri.spec = dt.mozGetDataAt(types[0], 0);</span>
<a href="#l8.475"></a><span id="l8.475">       validUri = this.isValidScheme(uri);</span>
<a href="#l8.476"></a><span id="l8.476" class="difflineminus">-      FeedUtils.log.trace(&quot;getFeedUriFromDataTransfer: dropEffect:type:value - &quot;+</span>
<a href="#l8.477"></a><span id="l8.477" class="difflineminus">-                          dt.dropEffect+&quot; : &quot;+types[0]+&quot; : &quot;+uri.spec);</span>
<a href="#l8.478"></a><span id="l8.478" class="difflineplus">+      this.log.trace(&quot;getFeedUriFromDataTransfer: dropEffect:type:value - &quot;+</span>
<a href="#l8.479"></a><span id="l8.479" class="difflineplus">+                     dt.dropEffect+&quot; : &quot;+types[0]+&quot; : &quot;+uri.spec);</span>
<a href="#l8.480"></a><span id="l8.480">     }</span>
<a href="#l8.481"></a><span id="l8.481">     else if (dt.getData(types[1]))</span>
<a href="#l8.482"></a><span id="l8.482">     {</span>
<a href="#l8.483"></a><span id="l8.483">       // The url is the first part of the data, the second part is random.</span>
<a href="#l8.484"></a><span id="l8.484">       uri.spec = dt.mozGetDataAt(types[1], 0).split(&quot;\n&quot;)[0];</span>
<a href="#l8.485"></a><span id="l8.485">       validUri = this.isValidScheme(uri);</span>
<a href="#l8.486"></a><span id="l8.486" class="difflineminus">-      FeedUtils.log.trace(&quot;getFeedUriFromDataTransfer: dropEffect:type:value - &quot;+</span>
<a href="#l8.487"></a><span id="l8.487" class="difflineminus">-                          dt.dropEffect+&quot; : &quot;+types[0]+&quot; : &quot;+uri.spec);</span>
<a href="#l8.488"></a><span id="l8.488" class="difflineplus">+      this.log.trace(&quot;getFeedUriFromDataTransfer: dropEffect:type:value - &quot;+</span>
<a href="#l8.489"></a><span id="l8.489" class="difflineplus">+                     dt.dropEffect+&quot; : &quot;+types[0]+&quot; : &quot;+uri.spec);</span>
<a href="#l8.490"></a><span id="l8.490">     }</span>
<a href="#l8.491"></a><span id="l8.491">     else</span>
<a href="#l8.492"></a><span id="l8.492">     {</span>
<a href="#l8.493"></a><span id="l8.493">       // Go through the types and see if there's a url; get the first one.</span>
<a href="#l8.494"></a><span id="l8.494">       for (let i = 0; i &lt; dt.types.length; i++) {</span>
<a href="#l8.495"></a><span id="l8.495">         let spec = dt.mozGetDataAt(dt.types[i], 0);</span>
<a href="#l8.496"></a><span id="l8.496" class="difflineminus">-        FeedUtils.log.trace(&quot;getFeedUriFromDataTransfer: dropEffect:index:type:value - &quot;+</span>
<a href="#l8.497"></a><span id="l8.497" class="difflineminus">-                            dt.dropEffect+&quot; : &quot;+i+&quot; : &quot;+dt.types[i]+&quot; : &quot;+spec);</span>
<a href="#l8.498"></a><span id="l8.498" class="difflineplus">+        this.log.trace(&quot;getFeedUriFromDataTransfer: dropEffect:index:type:value - &quot;+</span>
<a href="#l8.499"></a><span id="l8.499" class="difflineplus">+                       dt.dropEffect+&quot; : &quot;+i+&quot; : &quot;+dt.types[i]+&quot; : &quot;+spec);</span>
<a href="#l8.500"></a><span id="l8.500">         try {</span>
<a href="#l8.501"></a><span id="l8.501">           uri.spec = spec;</span>
<a href="#l8.502"></a><span id="l8.502">           validUri = this.isValidScheme(uri);</span>
<a href="#l8.503"></a><span id="l8.503">         }</span>
<a href="#l8.504"></a><span id="l8.504">         catch(ex) {}</span>
<a href="#l8.505"></a><span id="l8.505"> </span>
<a href="#l8.506"></a><span id="l8.506">         if (validUri)</span>
<a href="#l8.507"></a><span id="l8.507">           break;</span>
<a href="#l8.508"></a><span id="l8.508" class="difflineat">@@ -140,40 +572,40 @@ var FeedUtils = {</span>
<a href="#l8.509"></a><span id="l8.509"> /**</span>
<a href="#l8.510"></a><span id="l8.510">  * Return a folder path string constructed from individual folder UTF8 names</span>
<a href="#l8.511"></a><span id="l8.511">  * stored as properties (not possible hashes used to construct disk foldername).</span>
<a href="#l8.512"></a><span id="l8.512">  * </span>
<a href="#l8.513"></a><span id="l8.513">  * @param  nsIMsgFolder aFolder     - the folder.</span>
<a href="#l8.514"></a><span id="l8.514">  * @return string prettyName | null - name or null if not a disk folder.</span>
<a href="#l8.515"></a><span id="l8.515">  */</span>
<a href="#l8.516"></a><span id="l8.516">   getFolderPrettyPath: function(aFolder) {</span>
<a href="#l8.517"></a><span id="l8.517" class="difflineminus">-    let msgFolder = GetMsgFolderFromUri(aFolder.URI, true);</span>
<a href="#l8.518"></a><span id="l8.518" class="difflineplus">+    let msgFolder = MailUtils.getFolderForURI(aFolder.URI, true);</span>
<a href="#l8.519"></a><span id="l8.519">     if (!msgFolder)</span>
<a href="#l8.520"></a><span id="l8.520">       // Not a real folder uri.</span>
<a href="#l8.521"></a><span id="l8.521">       return null;</span>
<a href="#l8.522"></a><span id="l8.522"> </span>
<a href="#l8.523"></a><span id="l8.523">     if (msgFolder.URI == msgFolder.server.serverURI)</span>
<a href="#l8.524"></a><span id="l8.524">       return msgFolder.server.prettyName;</span>
<a href="#l8.525"></a><span id="l8.525"> </span>
<a href="#l8.526"></a><span id="l8.526">     // Server part first.</span>
<a href="#l8.527"></a><span id="l8.527">     let pathParts = [msgFolder.server.prettyName];</span>
<a href="#l8.528"></a><span id="l8.528">     let rawPathParts = msgFolder.URI.split(msgFolder.server.serverURI + &quot;/&quot;);</span>
<a href="#l8.529"></a><span id="l8.529">     let folderURI = msgFolder.server.serverURI;</span>
<a href="#l8.530"></a><span id="l8.530">     rawPathParts = rawPathParts[1].split(&quot;/&quot;);</span>
<a href="#l8.531"></a><span id="l8.531">     for (let i = 0; i &lt; rawPathParts.length - 1; i++)</span>
<a href="#l8.532"></a><span id="l8.532">     {</span>
<a href="#l8.533"></a><span id="l8.533">       // Two or more folders deep parts here.</span>
<a href="#l8.534"></a><span id="l8.534">       folderURI += &quot;/&quot; + rawPathParts[i];</span>
<a href="#l8.535"></a><span id="l8.535" class="difflineminus">-      msgFolder = GetMsgFolderFromUri(folderURI, true);</span>
<a href="#l8.536"></a><span id="l8.536" class="difflineplus">+      msgFolder = MailUtils.getFolderForURI(folderURI, true);</span>
<a href="#l8.537"></a><span id="l8.537">       pathParts.push(msgFolder.name);</span>
<a href="#l8.538"></a><span id="l8.538">     }</span>
<a href="#l8.539"></a><span id="l8.539"> </span>
<a href="#l8.540"></a><span id="l8.540">     // Leaf folder last.</span>
<a href="#l8.541"></a><span id="l8.541">     pathParts.push(aFolder.name);</span>
<a href="#l8.542"></a><span id="l8.542" class="difflineminus">-    return decodeURI(pathParts.join(&quot; / &quot;));</span>
<a href="#l8.543"></a><span id="l8.543" class="difflineplus">+    return decodeURI(pathParts.join(&quot;/&quot;));</span>
<a href="#l8.544"></a><span id="l8.544">   },</span>
<a href="#l8.545"></a><span id="l8.545"> </span>
<a href="#l8.546"></a><span id="l8.546">   // Progress glue code.  Acts as a go between the RSS back end and the mail</span>
<a href="#l8.547"></a><span id="l8.547">   // window front end determined by the aMsgWindow parameter passed into</span>
<a href="#l8.548"></a><span id="l8.548">   // nsINewsBlogFeedDownloader.</span>
<a href="#l8.549"></a><span id="l8.549">   progressNotifier: {</span>
<a href="#l8.550"></a><span id="l8.550">     mSubscribeMode: false,</span>
<a href="#l8.551"></a><span id="l8.551">     mMsgWindow: null,</span>
<a href="#l8.552"></a><span id="l8.552" class="difflineat">@@ -201,63 +633,66 @@ var FeedUtils = {</span>
<a href="#l8.553"></a><span id="l8.553">               aSubscribeMode ? &quot;subscribe-validating-feed&quot; :</span>
<a href="#l8.554"></a><span id="l8.554">                                &quot;newsblog-getNewMsgsCheck&quot;));</span>
<a href="#l8.555"></a><span id="l8.555">         }</span>
<a href="#l8.556"></a><span id="l8.556">       }</span>
<a href="#l8.557"></a><span id="l8.557">     },</span>
<a href="#l8.558"></a><span id="l8.558"> </span>
<a href="#l8.559"></a><span id="l8.559">     downloaded: function(feed, aErrorCode)</span>
<a href="#l8.560"></a><span id="l8.560">     {</span>
<a href="#l8.561"></a><span id="l8.561" class="difflineplus">+      let location = feed.folder ? feed.folder.filePath.path : &quot;&quot;;</span>
<a href="#l8.562"></a><span id="l8.562">       FeedUtils.log.debug(&quot;downloaded: &quot;+</span>
<a href="#l8.563"></a><span id="l8.563">                           (this.mSubscribeMode ? &quot;Subscribe &quot; : &quot;Update &quot;) +</span>
<a href="#l8.564"></a><span id="l8.564" class="difflineminus">-                          &quot;errorCode:feed:folder - &quot; +</span>
<a href="#l8.565"></a><span id="l8.565" class="difflineminus">-                          aErrorCode+&quot; : &quot;+feed.name+&quot; : &quot;+</span>
<a href="#l8.566"></a><span id="l8.566" class="difflineminus">-                          (feed.folder ? feed.folder.filePath.path : &quot;null&quot;));</span>
<a href="#l8.567"></a><span id="l8.567" class="difflineplus">+                          &quot;errorCode:feedName:folder - &quot; +</span>
<a href="#l8.568"></a><span id="l8.568" class="difflineplus">+                          aErrorCode+&quot; : &quot;+feed.name+&quot; : &quot;+location);</span>
<a href="#l8.569"></a><span id="l8.569">       if (this.mSubscribeMode)</span>
<a href="#l8.570"></a><span id="l8.570">       {</span>
<a href="#l8.571"></a><span id="l8.571">         if (aErrorCode == FeedUtils.kNewsBlogSuccess)</span>
<a href="#l8.572"></a><span id="l8.572">         {</span>
<a href="#l8.573"></a><span id="l8.573">           // If we get here we should always have a folder by now, either in</span>
<a href="#l8.574"></a><span id="l8.574">           // feed.folder or FeedItems created the folder for us.</span>
<a href="#l8.575"></a><span id="l8.575" class="difflineminus">-          updateFolderFeedUrl(feed.folder, feed.url, false);</span>
<a href="#l8.576"></a><span id="l8.576" class="difflineplus">+          FeedUtils.updateFolderFeedUrl(feed.folder, feed.url, false);</span>
<a href="#l8.577"></a><span id="l8.577"> </span>
<a href="#l8.578"></a><span id="l8.578">           // Add feed just adds the feed to the subscription UI and flushes the</span>
<a href="#l8.579"></a><span id="l8.579">           // datasource.</span>
<a href="#l8.580"></a><span id="l8.580" class="difflineminus">-          addFeed(feed.url, feed.name, feed.folder);</span>
<a href="#l8.581"></a><span id="l8.581" class="difflineplus">+          FeedUtils.addFeed(feed.url, feed.name, feed.folder);</span>
<a href="#l8.582"></a><span id="l8.582"> </span>
<a href="#l8.583"></a><span id="l8.583">           // Nice touch: select the folder that now contains the newly subscribed</span>
<a href="#l8.584"></a><span id="l8.584">           // feed.  This is particularly nice if we just finished subscribing</span>
<a href="#l8.585"></a><span id="l8.585">           // to a feed URL that the operating system gave us.</span>
<a href="#l8.586"></a><span id="l8.586">           this.mMsgWindow.windowCommands.selectFolder(feed.folder.URI);</span>
<a href="#l8.587"></a><span id="l8.587"> </span>
<a href="#l8.588"></a><span id="l8.588">           // Check for an existing feed subscriptions window and update it.</span>
<a href="#l8.589"></a><span id="l8.589">           let subscriptionsWindow =</span>
<a href="#l8.590"></a><span id="l8.590">               Services.wm.getMostRecentWindow(&quot;Mail:News-BlogSubscriptions&quot;);</span>
<a href="#l8.591"></a><span id="l8.591">           if (subscriptionsWindow)</span>
<a href="#l8.592"></a><span id="l8.592">             subscriptionsWindow.gFeedSubscriptionsWindow.refreshSubscriptionView();</span>
<a href="#l8.593"></a><span id="l8.593">         }</span>
<a href="#l8.594"></a><span id="l8.594">         else</span>
<a href="#l8.595"></a><span id="l8.595">         {</span>
<a href="#l8.596"></a><span id="l8.596">           // Non success.  Remove intermediate traces from the feeds database.</span>
<a href="#l8.597"></a><span id="l8.597">           if (feed &amp;&amp; feed.url &amp;&amp; feed.server)</span>
<a href="#l8.598"></a><span id="l8.598" class="difflineminus">-            deleteFeed(rdf.GetResource(feed.url),</span>
<a href="#l8.599"></a><span id="l8.599" class="difflineminus">-                       feed.server,</span>
<a href="#l8.600"></a><span id="l8.600" class="difflineminus">-                       feed.server.rootFolder);</span>
<a href="#l8.601"></a><span id="l8.601" class="difflineplus">+            FeedUtils.deleteFeed(FeedUtils.rdf.GetResource(feed.url),</span>
<a href="#l8.602"></a><span id="l8.602" class="difflineplus">+                                 feed.server,</span>
<a href="#l8.603"></a><span id="l8.603" class="difflineplus">+                                 feed.server.rootFolder);</span>
<a href="#l8.604"></a><span id="l8.604">         }</span>
<a href="#l8.605"></a><span id="l8.605">       }</span>
<a href="#l8.606"></a><span id="l8.606"> </span>
<a href="#l8.607"></a><span id="l8.607">       if (feed.folder &amp;&amp; aErrorCode != FeedUtils.kNewsBlogFeedIsBusy)</span>
<a href="#l8.608"></a><span id="l8.608">         // Free msgDatabase after new mail biff is set; if busy let the next</span>
<a href="#l8.609"></a><span id="l8.609">         // result do the freeing.  Otherwise new messages won't be indicated.</span>
<a href="#l8.610"></a><span id="l8.610">         feed.folder.msgDatabase = null;</span>
<a href="#l8.611"></a><span id="l8.611"> </span>
<a href="#l8.612"></a><span id="l8.612">       let message = &quot;&quot;;</span>
<a href="#l8.613"></a><span id="l8.613" class="difflineplus">+      if (feed.folder)</span>
<a href="#l8.614"></a><span id="l8.614" class="difflineplus">+        location = FeedUtils.getFolderPrettyPath(feed.folder) + &quot; -&gt; &quot;;</span>
<a href="#l8.615"></a><span id="l8.615">       switch (aErrorCode) {</span>
<a href="#l8.616"></a><span id="l8.616">         case FeedUtils.kNewsBlogSuccess:</span>
<a href="#l8.617"></a><span id="l8.617">         case FeedUtils.kNewsBlogFeedIsBusy:</span>
<a href="#l8.618"></a><span id="l8.618" class="difflineplus">+          message = &quot;&quot;;</span>
<a href="#l8.619"></a><span id="l8.619">           break;</span>
<a href="#l8.620"></a><span id="l8.620">         case FeedUtils.kNewsBlogNoNewItems:</span>
<a href="#l8.621"></a><span id="l8.621">           message = feed.url+&quot;. &quot; +</span>
<a href="#l8.622"></a><span id="l8.622">                     FeedUtils.strings.GetStringFromName(</span>
<a href="#l8.623"></a><span id="l8.623">                       &quot;newsblog-noNewArticlesForFeed&quot;);</span>
<a href="#l8.624"></a><span id="l8.624">           break;</span>
<a href="#l8.625"></a><span id="l8.625">         case FeedUtils.kNewsBlogInvalidFeed:</span>
<a href="#l8.626"></a><span id="l8.626">           message = FeedUtils.strings.formatStringFromName(</span>
<a href="#l8.627"></a><span id="l8.627" class="difflineat">@@ -265,18 +700,18 @@ var FeedUtils = {</span>
<a href="#l8.628"></a><span id="l8.628">           break;</span>
<a href="#l8.629"></a><span id="l8.629">         case FeedUtils.kNewsBlogRequestFailure:</span>
<a href="#l8.630"></a><span id="l8.630">           message = FeedUtils.strings.formatStringFromName(</span>
<a href="#l8.631"></a><span id="l8.631">                       &quot;newsblog-networkError&quot;, [feed.url], 1);</span>
<a href="#l8.632"></a><span id="l8.632">           break;</span>
<a href="#l8.633"></a><span id="l8.633">       }</span>
<a href="#l8.634"></a><span id="l8.634">       if (message)</span>
<a href="#l8.635"></a><span id="l8.635">         FeedUtils.log.info(&quot;downloaded: &quot;+</span>
<a href="#l8.636"></a><span id="l8.636" class="difflineminus">-                           (this.mSubscribeMode ? &quot;Subscribe &quot; : &quot;Update &quot;) +</span>
<a href="#l8.637"></a><span id="l8.637" class="difflineminus">-                           message);</span>
<a href="#l8.638"></a><span id="l8.638" class="difflineplus">+                           (this.mSubscribeMode ? &quot;Subscribe: &quot; : &quot;Update: &quot;) +</span>
<a href="#l8.639"></a><span id="l8.639" class="difflineplus">+                           location + message);</span>
<a href="#l8.640"></a><span id="l8.640"> </span>
<a href="#l8.641"></a><span id="l8.641">       if (this.mStatusFeedback)</span>
<a href="#l8.642"></a><span id="l8.642">       {</span>
<a href="#l8.643"></a><span id="l8.643">         this.mStatusFeedback.showStatusString(message);</span>
<a href="#l8.644"></a><span id="l8.644">         this.mStatusFeedback.stopMeteors();</span>
<a href="#l8.645"></a><span id="l8.645">       }</span>
<a href="#l8.646"></a><span id="l8.646"> </span>
<a href="#l8.647"></a><span id="l8.647">       if (!--this.mNumPendingFeedDownloads)</span>
<a href="#l8.648"></a><span id="l8.648" class="difflineat">@@ -307,32 +742,32 @@ var FeedUtils = {</span>
<a href="#l8.649"></a><span id="l8.649">         // If we are subscribing to a feed, show feed download progress.</span>
<a href="#l8.650"></a><span id="l8.650">         this.mStatusFeedback.showStatusString(</span>
<a href="#l8.651"></a><span id="l8.651">           FeedUtils.strings.formatStringFromName(&quot;subscribe-gettingFeedItems&quot;,</span>
<a href="#l8.652"></a><span id="l8.652">                                                  [aCurrentFeedItems, aMaxFeedItems], 2));</span>
<a href="#l8.653"></a><span id="l8.653">         this.onProgress(feed, aCurrentFeedItems, aMaxFeedItems);</span>
<a href="#l8.654"></a><span id="l8.654">       }</span>
<a href="#l8.655"></a><span id="l8.655">     },</span>
<a href="#l8.656"></a><span id="l8.656"> </span>
<a href="#l8.657"></a><span id="l8.657" class="difflineminus">-    onProgress: function(feed, aProgress, aProgressMax)</span>
<a href="#l8.658"></a><span id="l8.658" class="difflineplus">+    onProgress: function(feed, aProgress, aProgressMax, aLengthComputable)</span>
<a href="#l8.659"></a><span id="l8.659">     {</span>
<a href="#l8.660"></a><span id="l8.660">       if (feed.url in this.mFeeds)</span>
<a href="#l8.661"></a><span id="l8.661">         // Have we already seen this feed?</span>
<a href="#l8.662"></a><span id="l8.662">         this.mFeeds[feed.url].currentProgress = aProgress;</span>
<a href="#l8.663"></a><span id="l8.663">       else</span>
<a href="#l8.664"></a><span id="l8.664">         this.mFeeds[feed.url] = {currentProgress: aProgress,</span>
<a href="#l8.665"></a><span id="l8.665">                                  maxProgress: aProgressMax};</span>
<a href="#l8.666"></a><span id="l8.666"> </span>
<a href="#l8.667"></a><span id="l8.667">       this.updateProgressBar();</span>
<a href="#l8.668"></a><span id="l8.668">     },</span>
<a href="#l8.669"></a><span id="l8.669"> </span>
<a href="#l8.670"></a><span id="l8.670">     updateProgressBar: function()</span>
<a href="#l8.671"></a><span id="l8.671">     {</span>
<a href="#l8.672"></a><span id="l8.672" class="difflineminus">-      var currentProgress = 0;</span>
<a href="#l8.673"></a><span id="l8.673" class="difflineminus">-      var maxProgress = 0;</span>
<a href="#l8.674"></a><span id="l8.674" class="difflineplus">+      let currentProgress = 0;</span>
<a href="#l8.675"></a><span id="l8.675" class="difflineplus">+      let maxProgress = 0;</span>
<a href="#l8.676"></a><span id="l8.676">       for (let index in this.mFeeds)</span>
<a href="#l8.677"></a><span id="l8.677">       {</span>
<a href="#l8.678"></a><span id="l8.678">         currentProgress += this.mFeeds[index].currentProgress;</span>
<a href="#l8.679"></a><span id="l8.679">         maxProgress += this.mFeeds[index].maxProgress;</span>
<a href="#l8.680"></a><span id="l8.680">       }</span>
<a href="#l8.681"></a><span id="l8.681"> </span>
<a href="#l8.682"></a><span id="l8.682">       // If we start seeing weird &quot;jumping&quot; behavior where the progress bar</span>
<a href="#l8.683"></a><span id="l8.683">       // goes below a threshold then above it again, then we can factor a</span>
<a href="#l8.684"></a><span id="l8.684" class="difflineat">@@ -354,546 +789,17 @@ XPCOMUtils.defineLazyGetter(FeedUtils, &quot;</span>
<a href="#l8.685"></a><span id="l8.685">   return Log4Moz.getConfiguredLogger(&quot;Feeds&quot;);</span>
<a href="#l8.686"></a><span id="l8.686"> });</span>
<a href="#l8.687"></a><span id="l8.687"> </span>
<a href="#l8.688"></a><span id="l8.688"> XPCOMUtils.defineLazyGetter(FeedUtils, &quot;strings&quot;, function() {</span>
<a href="#l8.689"></a><span id="l8.689">   return Services.strings.createBundle(</span>
<a href="#l8.690"></a><span id="l8.690">     &quot;chrome://messenger-newsblog/locale/newsblog.properties&quot;);</span>
<a href="#l8.691"></a><span id="l8.691"> });</span>
<a href="#l8.692"></a><span id="l8.692"> </span>
<a href="#l8.693"></a><span id="l8.693" class="difflineminus">-// Whether or not to dump debugging messages to the console.</span>
<a href="#l8.694"></a><span id="l8.694" class="difflineminus">-const DEBUG = false;</span>
<a href="#l8.695"></a><span id="l8.695" class="difflineminus">-var debug;</span>
<a href="#l8.696"></a><span id="l8.696" class="difflineminus">-if (DEBUG)</span>
<a href="#l8.697"></a><span id="l8.697" class="difflineminus">-  debug = function(msg) { dump(' -- FZ -- : ' + msg + '\n'); }</span>
<a href="#l8.698"></a><span id="l8.698" class="difflineminus">-else</span>
<a href="#l8.699"></a><span id="l8.699" class="difflineminus">-  debug = function() {}</span>
<a href="#l8.700"></a><span id="l8.700" class="difflineminus">-</span>
<a href="#l8.701"></a><span id="l8.701" class="difflineminus">-var rdf = Components.classes[&quot;@mozilla.org/rdf/rdf-service;1&quot;]</span>
<a href="#l8.702"></a><span id="l8.702" class="difflineminus">-                    .getService(Components.interfaces.nsIRDFService);</span>
<a href="#l8.703"></a><span id="l8.703" class="difflineminus">-var rsspref = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l8.704"></a><span id="l8.704" class="difflineminus">-                        .getService(Components.interfaces.nsIPrefBranch);</span>
<a href="#l8.705"></a><span id="l8.705" class="difflineminus">-</span>
<a href="#l8.706"></a><span id="l8.706" class="difflineminus">-const RDF_TYPE = rdf.GetResource(&quot;http://www.w3.org/1999/02/22-rdf-syntax-ns#type&quot;);</span>
<a href="#l8.707"></a><span id="l8.707" class="difflineminus">-</span>
<a href="#l8.708"></a><span id="l8.708" class="difflineminus">-const RSS_NS = &quot;http://purl.org/rss/1.0/&quot;;</span>
<a href="#l8.709"></a><span id="l8.709" class="difflineminus">-const RSS_CHANNEL = rdf.GetResource(RSS_NS + &quot;channel&quot;);</span>
<a href="#l8.710"></a><span id="l8.710" class="difflineminus">-const RSS_TITLE = rdf.GetResource(RSS_NS + &quot;title&quot;);</span>
<a href="#l8.711"></a><span id="l8.711" class="difflineminus">-const RSS_DESCRIPTION = rdf.GetResource(RSS_NS + &quot;description&quot;);</span>
<a href="#l8.712"></a><span id="l8.712" class="difflineminus">-const RSS_ITEMS = rdf.GetResource(RSS_NS + &quot;items&quot;);</span>
<a href="#l8.713"></a><span id="l8.713" class="difflineminus">-const RSS_ITEM = rdf.GetResource(RSS_NS + &quot;item&quot;);</span>
<a href="#l8.714"></a><span id="l8.714" class="difflineminus">-const RSS_LINK = rdf.GetResource(RSS_NS + &quot;link&quot;);</span>
<a href="#l8.715"></a><span id="l8.715" class="difflineminus">-</span>
<a href="#l8.716"></a><span id="l8.716" class="difflineminus">-const RSS_CONTENT_NS = &quot;http://purl.org/rss/1.0/modules/content/&quot;;</span>
<a href="#l8.717"></a><span id="l8.717" class="difflineminus">-const RSS_CONTENT_ENCODED = rdf.GetResource(RSS_CONTENT_NS + &quot;encoded&quot;);</span>
<a href="#l8.718"></a><span id="l8.718" class="difflineminus">-</span>
<a href="#l8.719"></a><span id="l8.719" class="difflineminus">-const DC_NS = &quot;http://purl.org/dc/elements/1.1/&quot;;</span>
<a href="#l8.720"></a><span id="l8.720" class="difflineminus">-const DC_CREATOR = rdf.GetResource(DC_NS + &quot;creator&quot;);</span>
<a href="#l8.721"></a><span id="l8.721" class="difflineminus">-const DC_SUBJECT = rdf.GetResource(DC_NS + &quot;subject&quot;);</span>
<a href="#l8.722"></a><span id="l8.722" class="difflineminus">-const DC_DATE = rdf.GetResource(DC_NS + &quot;date&quot;);</span>
<a href="#l8.723"></a><span id="l8.723" class="difflineminus">-const DC_TITLE = rdf.GetResource(DC_NS + &quot;title&quot;);</span>
<a href="#l8.724"></a><span id="l8.724" class="difflineminus">-const DC_LASTMODIFIED = rdf.GetResource(DC_NS + &quot;lastModified&quot;);</span>
<a href="#l8.725"></a><span id="l8.725" class="difflineminus">-const DC_IDENTIFIER = rdf.GetResource(DC_NS + &quot;identifier&quot;);</span>
<a href="#l8.726"></a><span id="l8.726" class="difflineminus">-</span>
<a href="#l8.727"></a><span id="l8.727" class="difflineminus">-const FZ_NS = &quot;urn:forumzilla:&quot;;</span>
<a href="#l8.728"></a><span id="l8.728" class="difflineminus">-const FZ_ITEM_NS = &quot;urn:feeditem:&quot;;</span>
<a href="#l8.729"></a><span id="l8.729" class="difflineminus">-const FZ_ROOT = rdf.GetResource(FZ_NS + &quot;root&quot;);</span>
<a href="#l8.730"></a><span id="l8.730" class="difflineminus">-const FZ_FEEDS = rdf.GetResource(FZ_NS + &quot;feeds&quot;);</span>
<a href="#l8.731"></a><span id="l8.731" class="difflineminus">-const FZ_FEED = rdf.GetResource(FZ_NS + &quot;feed&quot;);</span>
<a href="#l8.732"></a><span id="l8.732" class="difflineminus">-const FZ_QUICKMODE = rdf.GetResource(FZ_NS + &quot;quickMode&quot;);</span>
<a href="#l8.733"></a><span id="l8.733" class="difflineminus">-const FZ_DESTFOLDER = rdf.GetResource(FZ_NS + &quot;destFolder&quot;);</span>
<a href="#l8.734"></a><span id="l8.734" class="difflineminus">-const FZ_STORED = rdf.GetResource(FZ_NS + &quot;stored&quot;);</span>
<a href="#l8.735"></a><span id="l8.735" class="difflineminus">-const FZ_VALID = rdf.GetResource(FZ_NS + &quot;valid&quot;);</span>
<a href="#l8.736"></a><span id="l8.736" class="difflineminus">-const FZ_LAST_SEEN_TIMESTAMP = rdf.GetResource(FZ_NS + &quot;last-seen-timestamp&quot;);</span>
<a href="#l8.737"></a><span id="l8.737" class="difflineminus">-</span>
<a href="#l8.738"></a><span id="l8.738" class="difflineminus">-const RDF_LITERAL_TRUE = rdf.GetLiteral(&quot;true&quot;);</span>
<a href="#l8.739"></a><span id="l8.739" class="difflineminus">-const RDF_LITERAL_FALSE = rdf.GetLiteral(&quot;false&quot;);</span>
<a href="#l8.740"></a><span id="l8.740" class="difflineminus">-</span>
<a href="#l8.741"></a><span id="l8.741" class="difflineminus">-// Atom constants</span>
<a href="#l8.742"></a><span id="l8.742" class="difflineminus">-const ATOM_03_NS = &quot;http://purl.org/atom/ns#&quot;;</span>
<a href="#l8.743"></a><span id="l8.743" class="difflineminus">-const ATOM_IETF_NS = &quot;http://www.w3.org/2005/Atom&quot;;</span>
<a href="#l8.744"></a><span id="l8.744" class="difflineminus">-</span>
<a href="#l8.745"></a><span id="l8.745" class="difflineminus">-// The approximate amount of time, specified in milliseconds, to leave an item in the</span>
<a href="#l8.746"></a><span id="l8.746" class="difflineminus">-// RDF cache after the item has dissappeared from feeds.</span>
<a href="#l8.747"></a><span id="l8.747" class="difflineminus">-// The delay is currently one day.</span>
<a href="#l8.748"></a><span id="l8.748" class="difflineminus">-const INVALID_ITEM_PURGE_DELAY = 24 * 60 * 60 * 1000;</span>
<a href="#l8.749"></a><span id="l8.749" class="difflineminus">-</span>
<a href="#l8.750"></a><span id="l8.750" class="difflineminus">-// The delimiter used to delimit feed urls in the folder's &quot;feedUrl&quot; property.</span>
<a href="#l8.751"></a><span id="l8.751" class="difflineminus">-const kFeedUrlDelimiter = &quot;|&quot;;</span>
<a href="#l8.752"></a><span id="l8.752" class="difflineminus">-</span>
<a href="#l8.753"></a><span id="l8.753" class="difflineminus">-// XXX There's a containerutils in forumzilla.js that this should be merged with.</span>
<a href="#l8.754"></a><span id="l8.754" class="difflineminus">-var containerUtils = Components.classes[&quot;@mozilla.org/rdf/container-utils;1&quot;]</span>
<a href="#l8.755"></a><span id="l8.755" class="difflineminus">-                               .getService(Components.interfaces.nsIRDFContainerUtils);</span>
<a href="#l8.756"></a><span id="l8.756" class="difflineminus">-</span>
<a href="#l8.757"></a><span id="l8.757" class="difflineminus">-var fileHandler = Components.classes[&quot;@mozilla.org/network/io-service;1&quot;]</span>
<a href="#l8.758"></a><span id="l8.758" class="difflineminus">-                            .getService(Components.interfaces.nsIIOService)</span>
<a href="#l8.759"></a><span id="l8.759" class="difflineminus">-                            .getProtocolHandler(&quot;file&quot;)</span>
<a href="#l8.760"></a><span id="l8.760" class="difflineminus">-                            .QueryInterface(Components.interfaces.nsIFileProtocolHandler);</span>
<a href="#l8.761"></a><span id="l8.761" class="difflineminus">-</span>
<a href="#l8.762"></a><span id="l8.762" class="difflineminus">-// Helper routine that checks our subscriptions list array and returns</span>
<a href="#l8.763"></a><span id="l8.763" class="difflineminus">-// true if the url is already in our list. This is used to prevent the</span>
<a href="#l8.764"></a><span id="l8.764" class="difflineminus">-// user from subscribing to the same feed multiple times for the same server...</span>
<a href="#l8.765"></a><span id="l8.765" class="difflineminus">-function feedAlreadyExists(aUrl, aServer)</span>
<a href="#l8.766"></a><span id="l8.766" class="difflineminus">-{</span>
<a href="#l8.767"></a><span id="l8.767" class="difflineminus">-  var ds = getSubscriptionsDS(aServer);</span>
<a href="#l8.768"></a><span id="l8.768" class="difflineminus">-  var feeds = getSubscriptionsList(aServer, ds);</span>
<a href="#l8.769"></a><span id="l8.769" class="difflineminus">-  return feeds.IndexOf(rdf.GetResource(aUrl)) != -1;</span>
<a href="#l8.770"></a><span id="l8.770" class="difflineminus">-}</span>
<a href="#l8.771"></a><span id="l8.771" class="difflineminus">-</span>
<a href="#l8.772"></a><span id="l8.772" class="difflineminus">-function addFeed(url, title, destFolder)</span>
<a href="#l8.773"></a><span id="l8.773" class="difflineminus">-{</span>
<a href="#l8.774"></a><span id="l8.774" class="difflineminus">-  var ds = getSubscriptionsDS(destFolder.server);</span>
<a href="#l8.775"></a><span id="l8.775" class="difflineminus">-  var feeds = getSubscriptionsList(destFolder.server, ds);</span>
<a href="#l8.776"></a><span id="l8.776" class="difflineminus">-</span>
<a href="#l8.777"></a><span id="l8.777" class="difflineminus">-  // Generate a unique ID for the feed.</span>
<a href="#l8.778"></a><span id="l8.778" class="difflineminus">-  var id = url;</span>
<a href="#l8.779"></a><span id="l8.779" class="difflineminus">-  var i = 1;</span>
<a href="#l8.780"></a><span id="l8.780" class="difflineminus">-  while (feeds.IndexOf(rdf.GetResource(id)) != -1 &amp;&amp; ++i &lt; 1000)</span>
<a href="#l8.781"></a><span id="l8.781" class="difflineminus">-    id = url + i;</span>
<a href="#l8.782"></a><span id="l8.782" class="difflineminus">-  if (id == 1000)</span>
<a href="#l8.783"></a><span id="l8.783" class="difflineminus">-    throw(&quot;couldn't generate a unique ID for feed &quot; + url);</span>
<a href="#l8.784"></a><span id="l8.784" class="difflineminus">-</span>
<a href="#l8.785"></a><span id="l8.785" class="difflineminus">-  // Add the feed to the list.</span>
<a href="#l8.786"></a><span id="l8.786" class="difflineminus">-  id = rdf.GetResource(id);</span>
<a href="#l8.787"></a><span id="l8.787" class="difflineminus">-  feeds.AppendElement(id);</span>
<a href="#l8.788"></a><span id="l8.788" class="difflineminus">-  ds.Assert(id, RDF_TYPE, FZ_FEED, true);</span>
<a href="#l8.789"></a><span id="l8.789" class="difflineminus">-  ds.Assert(id, DC_IDENTIFIER, rdf.GetLiteral(url), true);</span>
<a href="#l8.790"></a><span id="l8.790" class="difflineminus">-  if (title)</span>
<a href="#l8.791"></a><span id="l8.791" class="difflineminus">-    ds.Assert(id, DC_TITLE, rdf.GetLiteral(title), true);</span>
<a href="#l8.792"></a><span id="l8.792" class="difflineminus">-  ds.Assert(id, FZ_DESTFOLDER, destFolder, true);</span>
<a href="#l8.793"></a><span id="l8.793" class="difflineminus">-  ds = ds.QueryInterface(Components.interfaces.nsIRDFRemoteDataSource);</span>
<a href="#l8.794"></a><span id="l8.794" class="difflineminus">-  ds.Flush();</span>
<a href="#l8.795"></a><span id="l8.795" class="difflineminus">-}</span>
<a href="#l8.796"></a><span id="l8.796" class="difflineminus">-</span>
<a href="#l8.797"></a><span id="l8.797" class="difflineminus">-function deleteFeed(aId, aServer, aParentFolder)</span>
<a href="#l8.798"></a><span id="l8.798" class="difflineminus">-{</span>
<a href="#l8.799"></a><span id="l8.799" class="difflineminus">-  let feed = new Feed(aId, aServer);</span>
<a href="#l8.800"></a><span id="l8.800" class="difflineminus">-  let ds = getSubscriptionsDS(aServer);</span>
<a href="#l8.801"></a><span id="l8.801" class="difflineminus">-</span>
<a href="#l8.802"></a><span id="l8.802" class="difflineminus">-  if (feed &amp;&amp; ds)</span>
<a href="#l8.803"></a><span id="l8.803" class="difflineminus">-  {</span>
<a href="#l8.804"></a><span id="l8.804" class="difflineminus">-    // Remove the feed from the subscriptions ds.</span>
<a href="#l8.805"></a><span id="l8.805" class="difflineminus">-    let feeds = getSubscriptionsList(aServer, ds);</span>
<a href="#l8.806"></a><span id="l8.806" class="difflineminus">-    let index = feeds.IndexOf(aId);</span>
<a href="#l8.807"></a><span id="l8.807" class="difflineminus">-    if (index != -1)</span>
<a href="#l8.808"></a><span id="l8.808" class="difflineminus">-      feeds.RemoveElementAt(index, false);</span>
<a href="#l8.809"></a><span id="l8.809" class="difflineminus">-</span>
<a href="#l8.810"></a><span id="l8.810" class="difflineminus">-    // Remove all assertions about the feed from the subscriptions database.</span>
<a href="#l8.811"></a><span id="l8.811" class="difflineminus">-    removeAssertions(ds, aId);</span>
<a href="#l8.812"></a><span id="l8.812" class="difflineminus">-    ds.QueryInterface(Components.interfaces.nsIRDFRemoteDataSource).Flush();</span>
<a href="#l8.813"></a><span id="l8.813" class="difflineminus">-</span>
<a href="#l8.814"></a><span id="l8.814" class="difflineminus">-    // Remove all assertions about items in the feed from the items database.</span>
<a href="#l8.815"></a><span id="l8.815" class="difflineminus">-    let itemds = getItemsDS(aServer);</span>
<a href="#l8.816"></a><span id="l8.816" class="difflineminus">-    feed.invalidateItems();</span>
<a href="#l8.817"></a><span id="l8.817" class="difflineminus">-    feed.removeInvalidItems(true);</span>
<a href="#l8.818"></a><span id="l8.818" class="difflineminus">-    itemds.QueryInterface(Components.interfaces.nsIRDFRemoteDataSource).Flush();</span>
<a href="#l8.819"></a><span id="l8.819" class="difflineminus">-</span>
<a href="#l8.820"></a><span id="l8.820" class="difflineminus">-    // Finally, make sure to remove the url from the folder's feedUrl</span>
<a href="#l8.821"></a><span id="l8.821" class="difflineminus">-    // property.  The correct folder is passed in by the Subscribe dialog or</span>
<a href="#l8.822"></a><span id="l8.822" class="difflineminus">-    // a folder pane folder delete.  The correct current folder cannot be</span>
<a href="#l8.823"></a><span id="l8.823" class="difflineminus">-    // currently determined from the feed's destFolder in the db, as it is not</span>
<a href="#l8.824"></a><span id="l8.824" class="difflineminus">-    // synced with folder pane moves.  Do this at the very end.</span>
<a href="#l8.825"></a><span id="l8.825" class="difflineminus">-    let feedUrl = aId.ValueUTF8;</span>
<a href="#l8.826"></a><span id="l8.826" class="difflineminus">-    updateFolderFeedUrl(aParentFolder, feedUrl, true);</span>
<a href="#l8.827"></a><span id="l8.827" class="difflineminus">-  }</span>
<a href="#l8.828"></a><span id="l8.828" class="difflineminus">-}</span>
<a href="#l8.829"></a><span id="l8.829" class="difflineminus">-</span>
<a href="#l8.830"></a><span id="l8.830" class="difflineminus">-/**</span>
<a href="#l8.831"></a><span id="l8.831" class="difflineminus">- * Get the list of feed urls for a folder.  For legacy reasons, we try</span>
<a href="#l8.832"></a><span id="l8.832" class="difflineminus">- * 1) getStringProperty on the folder;</span>
<a href="#l8.833"></a><span id="l8.833" class="difflineminus">- * 2) getCharProperty on the folder's msgDatabase.dBFolderInfo;</span>
<a href="#l8.834"></a><span id="l8.834" class="difflineminus">- * 3) directly from the feeds.rdf subscriptions database, as identified by</span>
<a href="#l8.835"></a><span id="l8.835" class="difflineminus">- *    the destFolder tag (currently not synced on folder moves in folder pane).</span>
<a href="#l8.836"></a><span id="l8.836" class="difflineminus">- * </span>
<a href="#l8.837"></a><span id="l8.837" class="difflineminus">- * If folder move/renames are fixed, remove msgDatabase accesses and get the</span>
<a href="#l8.838"></a><span id="l8.838" class="difflineminus">- * list directly from the feeds db.</span>
<a href="#l8.839"></a><span id="l8.839" class="difflineminus">- * </span>
<a href="#l8.840"></a><span id="l8.840" class="difflineminus">- * @param  nsIMsgFolder - the folder.</span>
<a href="#l8.841"></a><span id="l8.841" class="difflineminus">- * @return array of urls, or null if none.</span>
<a href="#l8.842"></a><span id="l8.842" class="difflineminus">- */</span>
<a href="#l8.843"></a><span id="l8.843" class="difflineminus">-function getFeedUrlsInFolder(aFolder)</span>
<a href="#l8.844"></a><span id="l8.844" class="difflineminus">-{</span>
<a href="#l8.845"></a><span id="l8.845" class="difflineminus">-  if (aFolder.isServer || aFolder.getFlag(Ci.nsMsgFolderFlags.Trash))</span>
<a href="#l8.846"></a><span id="l8.846" class="difflineminus">-    // Never get any feedUrls in the account folder or trash folder.</span>
<a href="#l8.847"></a><span id="l8.847" class="difflineminus">-    return null;</span>
<a href="#l8.848"></a><span id="l8.848" class="difflineminus">-</span>
<a href="#l8.849"></a><span id="l8.849" class="difflineminus">-  let feedUrlArray = [];</span>
<a href="#l8.850"></a><span id="l8.850" class="difflineminus">-</span>
<a href="#l8.851"></a><span id="l8.851" class="difflineminus">-  let feedurls = aFolder.getStringProperty(&quot;feedUrl&quot;);</span>
<a href="#l8.852"></a><span id="l8.852" class="difflineminus">-  if (feedurls)</span>
<a href="#l8.853"></a><span id="l8.853" class="difflineminus">-    return feedurls.split(kFeedUrlDelimiter);</span>
<a href="#l8.854"></a><span id="l8.854" class="difflineminus">-</span>
<a href="#l8.855"></a><span id="l8.855" class="difflineminus">-  // Go to msgDatabase for the property, make sure to handle errors.</span>
<a href="#l8.856"></a><span id="l8.856" class="difflineminus">-  let msgDb;</span>
<a href="#l8.857"></a><span id="l8.857" class="difflineminus">-  try {</span>
<a href="#l8.858"></a><span id="l8.858" class="difflineminus">-    msgDb = aFolder.msgDatabase;</span>
<a href="#l8.859"></a><span id="l8.859" class="difflineminus">-  }</span>
<a href="#l8.860"></a><span id="l8.860" class="difflineminus">-  catch (ex) {}</span>
<a href="#l8.861"></a><span id="l8.861" class="difflineminus">-  if (msgDb &amp;&amp; msgDb.dBFolderInfo) {</span>
<a href="#l8.862"></a><span id="l8.862" class="difflineminus">-    feedurls = msgDb.dBFolderInfo.getCharProperty(&quot;feedUrl&quot;);</span>
<a href="#l8.863"></a><span id="l8.863" class="difflineminus">-    // Clean up the feedUrl string.</span>
<a href="#l8.864"></a><span id="l8.864" class="difflineminus">-    feedurls.split(kFeedUrlDelimiter).forEach(</span>
<a href="#l8.865"></a><span id="l8.865" class="difflineminus">-      function(url) {</span>
<a href="#l8.866"></a><span id="l8.866" class="difflineminus">-        if (url &amp;&amp; feedUrlArray.indexOf(url) == -1)</span>
<a href="#l8.867"></a><span id="l8.867" class="difflineminus">-          feedUrlArray.push(url);</span>
<a href="#l8.868"></a><span id="l8.868" class="difflineminus">-      });</span>
<a href="#l8.869"></a><span id="l8.869" class="difflineminus">-</span>
<a href="#l8.870"></a><span id="l8.870" class="difflineminus">-    feedurls = feedUrlArray.join(kFeedUrlDelimiter);</span>
<a href="#l8.871"></a><span id="l8.871" class="difflineminus">-    if (feedurls) {</span>
<a href="#l8.872"></a><span id="l8.872" class="difflineminus">-      // Do a onetime per folder re-sync of the feeds db here based on the</span>
<a href="#l8.873"></a><span id="l8.873" class="difflineminus">-      // urls in the feedUrl property.</span>
<a href="#l8.874"></a><span id="l8.874" class="difflineminus">-      let ds = getSubscriptionsDS(aFolder.server);</span>
<a href="#l8.875"></a><span id="l8.875" class="difflineminus">-      let resource = rdf.GetResource(aFolder.URI);</span>
<a href="#l8.876"></a><span id="l8.876" class="difflineminus">-      feedUrlArray.forEach(</span>
<a href="#l8.877"></a><span id="l8.877" class="difflineminus">-        function(url) {</span>
<a href="#l8.878"></a><span id="l8.878" class="difflineminus">-          try {</span>
<a href="#l8.879"></a><span id="l8.879" class="difflineminus">-            let id = rdf.GetResource(url);</span>
<a href="#l8.880"></a><span id="l8.880" class="difflineminus">-            // Get the node for the current folder URI.</span>
<a href="#l8.881"></a><span id="l8.881" class="difflineminus">-            let node = ds.GetTarget(id, FZ_DESTFOLDER, true);</span>
<a href="#l8.882"></a><span id="l8.882" class="difflineminus">-            if (node)</span>
<a href="#l8.883"></a><span id="l8.883" class="difflineminus">-            {</span>
<a href="#l8.884"></a><span id="l8.884" class="difflineminus">-              ds.Change(id, FZ_DESTFOLDER, node, resource);</span>
<a href="#l8.885"></a><span id="l8.885" class="difflineminus">-              FeedUtils.log.debug(&quot;getFeedUrlsInFolder: sync update folder:url - &quot; +</span>
<a href="#l8.886"></a><span id="l8.886" class="difflineminus">-                                  aFolder.filePath.path+&quot; : &quot;+url);</span>
<a href="#l8.887"></a><span id="l8.887" class="difflineminus">-            }</span>
<a href="#l8.888"></a><span id="l8.888" class="difflineminus">-            else</span>
<a href="#l8.889"></a><span id="l8.889" class="difflineminus">-            {</span>
<a href="#l8.890"></a><span id="l8.890" class="difflineminus">-              addFeed(url, null, aFolder);</span>
<a href="#l8.891"></a><span id="l8.891" class="difflineminus">-              FeedUtils.log.debug(&quot;getFeedUrlsInFolder: sync add folder:url - &quot; +</span>
<a href="#l8.892"></a><span id="l8.892" class="difflineminus">-                                  aFolder.filePath.path+&quot; : &quot;+url);</span>
<a href="#l8.893"></a><span id="l8.893" class="difflineminus">-            }</span>
<a href="#l8.894"></a><span id="l8.894" class="difflineminus">-          }</span>
<a href="#l8.895"></a><span id="l8.895" class="difflineminus">-          catch (ex) {</span>
<a href="#l8.896"></a><span id="l8.896" class="difflineminus">-            FeedUtils.log.debug(&quot;getFeedUrlsInFolder: error - &quot; + ex);</span>
<a href="#l8.897"></a><span id="l8.897" class="difflineminus">-            FeedUtils.log.debug(&quot;getFeedUrlsInFolder: sync failed for folder:url - &quot; +</span>
<a href="#l8.898"></a><span id="l8.898" class="difflineminus">-                                aFolder.filePath.path+&quot; : &quot;+url);</span>
<a href="#l8.899"></a><span id="l8.899" class="difflineminus">-          }</span>
<a href="#l8.900"></a><span id="l8.900" class="difflineminus">-      });</span>
<a href="#l8.901"></a><span id="l8.901" class="difflineminus">-      ds.QueryInterface(Ci.nsIRDFRemoteDataSource).Flush();</span>
<a href="#l8.902"></a><span id="l8.902" class="difflineminus">-</span>
<a href="#l8.903"></a><span id="l8.903" class="difflineminus">-      // Set property on folder so we don't come here ever again.</span>
<a href="#l8.904"></a><span id="l8.904" class="difflineminus">-      aFolder.setStringProperty(&quot;feedUrl&quot;, feedurls);</span>
<a href="#l8.905"></a><span id="l8.905" class="difflineminus">-      aFolder.msgDatabase = null;</span>
<a href="#l8.906"></a><span id="l8.906" class="difflineminus">-</span>
<a href="#l8.907"></a><span id="l8.907" class="difflineminus">-      return feedUrlArray.length ? feedUrlArray : null;</span>
<a href="#l8.908"></a><span id="l8.908" class="difflineminus">-    }</span>
<a href="#l8.909"></a><span id="l8.909" class="difflineminus">-  }</span>
<a href="#l8.910"></a><span id="l8.910" class="difflineminus">-  else {</span>
<a href="#l8.911"></a><span id="l8.911" class="difflineminus">-    // Forcing a reparse with listener here is the last resort.  Not implemented</span>
<a href="#l8.912"></a><span id="l8.912" class="difflineminus">-    // as it may be unnecessary once feedUrl is property set on folder and not</span>
<a href="#l8.913"></a><span id="l8.913" class="difflineminus">-    // msgDatabase, and if eventually feedUrls are derived from the feeds db</span>
<a href="#l8.914"></a><span id="l8.914" class="difflineminus">-    // directly.</span>
<a href="#l8.915"></a><span id="l8.915" class="difflineminus">-  }</span>
<a href="#l8.916"></a><span id="l8.916" class="difflineminus">-</span>
<a href="#l8.917"></a><span id="l8.917" class="difflineminus">-  // Get the list from the feeds database.</span>
<a href="#l8.918"></a><span id="l8.918" class="difflineminus">-  try {</span>
<a href="#l8.919"></a><span id="l8.919" class="difflineminus">-    let ds = getSubscriptionsDS(aFolder.server);</span>
<a href="#l8.920"></a><span id="l8.920" class="difflineminus">-    let enumerator = ds.GetSources(FZ_DESTFOLDER, aFolder, true);</span>
<a href="#l8.921"></a><span id="l8.921" class="difflineminus">-    while (enumerator.hasMoreElements())</span>
<a href="#l8.922"></a><span id="l8.922" class="difflineminus">-    {</span>
<a href="#l8.923"></a><span id="l8.923" class="difflineminus">-      let containerArc = enumerator.getNext();</span>
<a href="#l8.924"></a><span id="l8.924" class="difflineminus">-      let uri = containerArc.QueryInterface(Ci.nsIRDFResource).Value;</span>
<a href="#l8.925"></a><span id="l8.925" class="difflineminus">-      feedUrlArray.push(uri);</span>
<a href="#l8.926"></a><span id="l8.926" class="difflineminus">-    }</span>
<a href="#l8.927"></a><span id="l8.927" class="difflineminus">-  }</span>
<a href="#l8.928"></a><span id="l8.928" class="difflineminus">-  catch(ex)</span>
<a href="#l8.929"></a><span id="l8.929" class="difflineminus">-  {</span>
<a href="#l8.930"></a><span id="l8.930" class="difflineminus">-    FeedUtils.log.debug(&quot;getFeedUrlsInFolder: feeds db error - &quot; + ex);</span>
<a href="#l8.931"></a><span id="l8.931" class="difflineminus">-    FeedUtils.log.debug(&quot;getFeedUrlsInFolder: feeds db error for folder - &quot; +</span>
<a href="#l8.932"></a><span id="l8.932" class="difflineminus">-                        aFolder.filePath.path);</span>
<a href="#l8.933"></a><span id="l8.933" class="difflineminus">-  }</span>
<a href="#l8.934"></a><span id="l8.934" class="difflineminus">-</span>
<a href="#l8.935"></a><span id="l8.935" class="difflineminus">-  feedurls = feedUrlArray.join(kFeedUrlDelimiter);</span>
<a href="#l8.936"></a><span id="l8.936" class="difflineminus">-  if (feedurls)</span>
<a href="#l8.937"></a><span id="l8.937" class="difflineminus">-  {</span>
<a href="#l8.938"></a><span id="l8.938" class="difflineminus">-    aFolder.setStringProperty(&quot;feedUrl&quot;, feedurls);</span>
<a href="#l8.939"></a><span id="l8.939" class="difflineminus">-    FeedUtils.log.debug(&quot;getFeedUrlsInFolder: got urls from db, folder:feedUrl - &quot; +</span>
<a href="#l8.940"></a><span id="l8.940" class="difflineminus">-                        aFolder.filePath.path+&quot; : &quot;+feedurls);</span>
<a href="#l8.941"></a><span id="l8.941" class="difflineminus">-  }</span>
<a href="#l8.942"></a><span id="l8.942" class="difflineminus">-  else</span>
<a href="#l8.943"></a><span id="l8.943" class="difflineminus">-    FeedUtils.log.debug(&quot;getFeedUrlsInFolder: no urls from db, folder - &quot; +</span>
<a href="#l8.944"></a><span id="l8.944" class="difflineminus">-                        aFolder.filePath.path);</span>
<a href="#l8.945"></a><span id="l8.945" class="difflineminus">-</span>
<a href="#l8.946"></a><span id="l8.946" class="difflineminus">-  return feedUrlArray.length ? feedUrlArray : null;</span>
<a href="#l8.947"></a><span id="l8.947" class="difflineminus">-}</span>
<a href="#l8.948"></a><span id="l8.948" class="difflineplus">+XPCOMUtils.defineLazyGetter(FeedUtils, &quot;rdf&quot;, function() {</span>
<a href="#l8.949"></a><span id="l8.949" class="difflineplus">+  return Cc[&quot;@mozilla.org/rdf/rdf-service;1&quot;].</span>
<a href="#l8.950"></a><span id="l8.950" class="difflineplus">+         getService(Ci.nsIRDFService);</span>
<a href="#l8.951"></a><span id="l8.951" class="difflineplus">+});</span>
<a href="#l8.952"></a><span id="l8.952"> </span>
<a href="#l8.953"></a><span id="l8.953" class="difflineminus">-/**</span>
<a href="#l8.954"></a><span id="l8.954" class="difflineminus">- * Add or remove urls from feedUrl folder property.  Property is used for</span>
<a href="#l8.955"></a><span id="l8.955" class="difflineminus">- * access to a folder's feeds in Subscribe dialog and when doing downloadFeed</span>
<a href="#l8.956"></a><span id="l8.956" class="difflineminus">- * on a folder.  Ensure no dupes.</span>
<a href="#l8.957"></a><span id="l8.957" class="difflineminus">- * </span>
<a href="#l8.958"></a><span id="l8.958" class="difflineminus">- * @param  nsIMsgFolder - the folder.</span>
<a href="#l8.959"></a><span id="l8.959" class="difflineminus">- * @param  string       - the feed's url.</span>
<a href="#l8.960"></a><span id="l8.960" class="difflineminus">- * @param  boolean      - true if removing the url.</span>
<a href="#l8.961"></a><span id="l8.961" class="difflineminus">- */</span>
<a href="#l8.962"></a><span id="l8.962" class="difflineminus">-function updateFolderFeedUrl(aFolder, aFeedUrl, aRemoveUrl)</span>
<a href="#l8.963"></a><span id="l8.963" class="difflineminus">-{</span>
<a href="#l8.964"></a><span id="l8.964" class="difflineminus">-  if (!aFeedUrl)</span>
<a href="#l8.965"></a><span id="l8.965" class="difflineminus">-    return;</span>
<a href="#l8.966"></a><span id="l8.966" class="difflineminus">-</span>
<a href="#l8.967"></a><span id="l8.967" class="difflineminus">-  let curFeedUrls = aFolder.getStringProperty(&quot;feedUrl&quot;);</span>
<a href="#l8.968"></a><span id="l8.968" class="difflineminus">-  curFeedUrls = curFeedUrls ? curFeedUrls.split(kFeedUrlDelimiter) : [];</span>
<a href="#l8.969"></a><span id="l8.969" class="difflineminus">-  let index = curFeedUrls.indexOf(aFeedUrl);</span>
<a href="#l8.970"></a><span id="l8.970" class="difflineminus">-</span>
<a href="#l8.971"></a><span id="l8.971" class="difflineminus">-  if (aRemoveUrl)</span>
<a href="#l8.972"></a><span id="l8.972" class="difflineminus">-  {</span>
<a href="#l8.973"></a><span id="l8.973" class="difflineminus">-    if (index == -1)</span>
<a href="#l8.974"></a><span id="l8.974" class="difflineminus">-      return;</span>
<a href="#l8.975"></a><span id="l8.975" class="difflineminus">-    curFeedUrls.splice(index, 1);</span>
<a href="#l8.976"></a><span id="l8.976" class="difflineminus">-  }</span>
<a href="#l8.977"></a><span id="l8.977" class="difflineminus">-  else {</span>
<a href="#l8.978"></a><span id="l8.978" class="difflineminus">-    if (index != -1)</span>
<a href="#l8.979"></a><span id="l8.979" class="difflineminus">-      return;</span>
<a href="#l8.980"></a><span id="l8.980" class="difflineminus">-    curFeedUrls.push(aFeedUrl);</span>
<a href="#l8.981"></a><span id="l8.981" class="difflineminus">-  }</span>
<a href="#l8.982"></a><span id="l8.982" class="difflineminus">-</span>
<a href="#l8.983"></a><span id="l8.983" class="difflineminus">-  let newFeedUrls = curFeedUrls.join(kFeedUrlDelimiter);</span>
<a href="#l8.984"></a><span id="l8.984" class="difflineminus">-  aFolder.setStringProperty(&quot;feedUrl&quot;, newFeedUrls);</span>
<a href="#l8.985"></a><span id="l8.985" class="difflineminus">-}</span>
<a href="#l8.986"></a><span id="l8.986" class="difflineminus">-</span>
<a href="#l8.987"></a><span id="l8.987" class="difflineminus">-function getNodeValue(node)</span>
<a href="#l8.988"></a><span id="l8.988" class="difflineminus">-{</span>
<a href="#l8.989"></a><span id="l8.989" class="difflineminus">-  if (node &amp;&amp; node.textContent)</span>
<a href="#l8.990"></a><span id="l8.990" class="difflineminus">-    return node.textContent;</span>
<a href="#l8.991"></a><span id="l8.991" class="difflineminus">-  else if (node &amp;&amp; node.firstChild)</span>
<a href="#l8.992"></a><span id="l8.992" class="difflineminus">-  {</span>
<a href="#l8.993"></a><span id="l8.993" class="difflineminus">-    var ret = &quot;&quot;;</span>
<a href="#l8.994"></a><span id="l8.994" class="difflineminus">-    for (var child = node.firstChild; child; child = child.nextSibling)</span>
<a href="#l8.995"></a><span id="l8.995" class="difflineminus">-    {</span>
<a href="#l8.996"></a><span id="l8.996" class="difflineminus">-      var value = getNodeValue(child);</span>
<a href="#l8.997"></a><span id="l8.997" class="difflineminus">-      if (value)</span>
<a href="#l8.998"></a><span id="l8.998" class="difflineminus">-        ret += value;</span>
<a href="#l8.999"></a><span id="l8.999" class="difflineminus">-    }</span>
<a href="#l8.1000"></a><span id="l8.1000" class="difflineminus">-</span>
<a href="#l8.1001"></a><span id="l8.1001" class="difflineminus">-    if (ret)</span>
<a href="#l8.1002"></a><span id="l8.1002" class="difflineminus">-      return ret;</span>
<a href="#l8.1003"></a><span id="l8.1003" class="difflineminus">-  }</span>
<a href="#l8.1004"></a><span id="l8.1004" class="difflineminus">-</span>
<a href="#l8.1005"></a><span id="l8.1005" class="difflineminus">-  return null;</span>
<a href="#l8.1006"></a><span id="l8.1006" class="difflineminus">-}</span>
<a href="#l8.1007"></a><span id="l8.1007" class="difflineminus">-</span>
<a href="#l8.1008"></a><span id="l8.1008" class="difflineminus">-function getRDFTargetValue(ds, source, property)</span>
<a href="#l8.1009"></a><span id="l8.1009" class="difflineminus">-{</span>
<a href="#l8.1010"></a><span id="l8.1010" class="difflineminus">-  var node = ds.GetTarget(source, property, true);</span>
<a href="#l8.1011"></a><span id="l8.1011" class="difflineminus">-  if (node)</span>
<a href="#l8.1012"></a><span id="l8.1012" class="difflineminus">-  {</span>
<a href="#l8.1013"></a><span id="l8.1013" class="difflineminus">-    try{</span>
<a href="#l8.1014"></a><span id="l8.1014" class="difflineminus">-      node = node.QueryInterface(Components.interfaces.nsIRDFLiteral);</span>
<a href="#l8.1015"></a><span id="l8.1015" class="difflineminus">-      if (node)</span>
<a href="#l8.1016"></a><span id="l8.1016" class="difflineminus">-        return node.Value;</span>
<a href="#l8.1017"></a><span id="l8.1017" class="difflineminus">-    }catch(e){</span>
<a href="#l8.1018"></a><span id="l8.1018" class="difflineminus">-      // If the RDF was bogus, do nothing. Rethrow if it's some other problem</span>
<a href="#l8.1019"></a><span id="l8.1019" class="difflineminus">-      if (!((e instanceof Components.interfaces.nsIXPCException) &amp;&amp;</span>
<a href="#l8.1020"></a><span id="l8.1020" class="difflineminus">-            (e.result==Components.results.NS_ERROR_NO_INTERFACE)))</span>
<a href="#l8.1021"></a><span id="l8.1021" class="difflineminus">-        throw e;</span>
<a href="#l8.1022"></a><span id="l8.1022" class="difflineminus">-    }</span>
<a href="#l8.1023"></a><span id="l8.1023" class="difflineminus">-</span>
<a href="#l8.1024"></a><span id="l8.1024" class="difflineminus">-  }</span>
<a href="#l8.1025"></a><span id="l8.1025" class="difflineminus">-  return null;</span>
<a href="#l8.1026"></a><span id="l8.1026" class="difflineminus">-}</span>
<a href="#l8.1027"></a><span id="l8.1027" class="difflineminus">-</span>
<a href="#l8.1028"></a><span id="l8.1028" class="difflineminus">-function getSubscriptionsDS(server)</span>
<a href="#l8.1029"></a><span id="l8.1029" class="difflineminus">-{</span>
<a href="#l8.1030"></a><span id="l8.1030" class="difflineminus">-  var file = getSubscriptionsFile(server);</span>
<a href="#l8.1031"></a><span id="l8.1031" class="difflineminus">-  var url = fileHandler.getURLSpecFromFile(file);</span>
<a href="#l8.1032"></a><span id="l8.1032" class="difflineminus">-</span>
<a href="#l8.1033"></a><span id="l8.1033" class="difflineminus">-  // GetDataSourceBlocking has a cache, so it's cheap to do this again</span>
<a href="#l8.1034"></a><span id="l8.1034" class="difflineminus">-  // once we've already done it once.</span>
<a href="#l8.1035"></a><span id="l8.1035" class="difflineminus">-  var ds = rdf.GetDataSourceBlocking(url);</span>
<a href="#l8.1036"></a><span id="l8.1036" class="difflineminus">-</span>
<a href="#l8.1037"></a><span id="l8.1037" class="difflineminus">-  if (!ds)</span>
<a href="#l8.1038"></a><span id="l8.1038" class="difflineminus">-    throw(&quot;can't get subscriptions data source&quot;);</span>
<a href="#l8.1039"></a><span id="l8.1039" class="difflineminus">-</span>
<a href="#l8.1040"></a><span id="l8.1040" class="difflineminus">-  return ds;</span>
<a href="#l8.1041"></a><span id="l8.1041" class="difflineminus">-}</span>
<a href="#l8.1042"></a><span id="l8.1042" class="difflineminus">-</span>
<a href="#l8.1043"></a><span id="l8.1043" class="difflineminus">-function getSubscriptionsList(server, ds)</span>
<a href="#l8.1044"></a><span id="l8.1044" class="difflineminus">-{</span>
<a href="#l8.1045"></a><span id="l8.1045" class="difflineminus">-  var list = ds.GetTarget(FZ_ROOT, FZ_FEEDS, true);</span>
<a href="#l8.1046"></a><span id="l8.1046" class="difflineminus">-  //list = feeds.QueryInterface(Components.interfaces.nsIRDFContainer);</span>
<a href="#l8.1047"></a><span id="l8.1047" class="difflineminus">-  list = list.QueryInterface(Components.interfaces.nsIRDFResource);</span>
<a href="#l8.1048"></a><span id="l8.1048" class="difflineminus">-  list = containerUtils.MakeSeq(ds, list);</span>
<a href="#l8.1049"></a><span id="l8.1049" class="difflineminus">-  return list;</span>
<a href="#l8.1050"></a><span id="l8.1050" class="difflineminus">-}</span>
<a href="#l8.1051"></a><span id="l8.1051" class="difflineminus">-</span>
<a href="#l8.1052"></a><span id="l8.1052" class="difflineminus">-function getSubscriptionsFile(server)</span>
<a href="#l8.1053"></a><span id="l8.1053" class="difflineminus">-{</span>
<a href="#l8.1054"></a><span id="l8.1054" class="difflineminus">-  server.QueryInterface(Components.interfaces.nsIRssIncomingServer);</span>
<a href="#l8.1055"></a><span id="l8.1055" class="difflineminus">-  var file = server.subscriptionsDataSourcePath;</span>
<a href="#l8.1056"></a><span id="l8.1056" class="difflineminus">-</span>
<a href="#l8.1057"></a><span id="l8.1057" class="difflineminus">-  // If the file doesn't exist, create it.</span>
<a href="#l8.1058"></a><span id="l8.1058" class="difflineminus">-  if (!file.exists())</span>
<a href="#l8.1059"></a><span id="l8.1059" class="difflineminus">-    createSubscriptionsFile(file);</span>
<a href="#l8.1060"></a><span id="l8.1060" class="difflineminus">-</span>
<a href="#l8.1061"></a><span id="l8.1061" class="difflineminus">-  return file;</span>
<a href="#l8.1062"></a><span id="l8.1062" class="difflineminus">-}</span>
<a href="#l8.1063"></a><span id="l8.1063" class="difflineminus">-</span>
<a href="#l8.1064"></a><span id="l8.1064" class="difflineminus">-// Generic get feed property, based on child value. Assumes 1 unique</span>
<a href="#l8.1065"></a><span id="l8.1065" class="difflineminus">-// child value with 1 unique parent, valid for feeds.rdf structure.</span>
<a href="#l8.1066"></a><span id="l8.1066" class="difflineminus">-function getParentTargetForChildResource(childResource, parentTarget, server)</span>
<a href="#l8.1067"></a><span id="l8.1067" class="difflineminus">-{</span>
<a href="#l8.1068"></a><span id="l8.1068" class="difflineminus">-  var ds = getSubscriptionsDS(server);</span>
<a href="#l8.1069"></a><span id="l8.1069" class="difflineminus">-  var childRes = rdf.GetResource(childResource);</span>
<a href="#l8.1070"></a><span id="l8.1070" class="difflineminus">-  var parent = null;</span>
<a href="#l8.1071"></a><span id="l8.1071" class="difflineminus">-</span>
<a href="#l8.1072"></a><span id="l8.1072" class="difflineminus">-  var arcsIn = ds.ArcLabelsIn(childRes);</span>
<a href="#l8.1073"></a><span id="l8.1073" class="difflineminus">-  while (arcsIn.hasMoreElements()){</span>
<a href="#l8.1074"></a><span id="l8.1074" class="difflineminus">-    var arc = arcsIn.getNext();</span>
<a href="#l8.1075"></a><span id="l8.1075" class="difflineminus">-    if (arc instanceof Components.interfaces.nsIRDFResource){</span>
<a href="#l8.1076"></a><span id="l8.1076" class="difflineminus">-      parent = ds.GetSource(arc, childRes, true);</span>
<a href="#l8.1077"></a><span id="l8.1077" class="difflineminus">-      parent = parent.QueryInterface(Components.interfaces.nsIRDFResource);</span>
<a href="#l8.1078"></a><span id="l8.1078" class="difflineminus">-      break;</span>
<a href="#l8.1079"></a><span id="l8.1079" class="difflineminus">-    }</span>
<a href="#l8.1080"></a><span id="l8.1080" class="difflineminus">-  }</span>
<a href="#l8.1081"></a><span id="l8.1081" class="difflineminus">-</span>
<a href="#l8.1082"></a><span id="l8.1082" class="difflineminus">-  if (parent) {</span>
<a href="#l8.1083"></a><span id="l8.1083" class="difflineminus">-    var resource = rdf.GetResource(parent.Value);</span>
<a href="#l8.1084"></a><span id="l8.1084" class="difflineminus">-    return ds.GetTarget(resource, parentTarget, true);</span>
<a href="#l8.1085"></a><span id="l8.1085" class="difflineminus">-  }</span>
<a href="#l8.1086"></a><span id="l8.1086" class="difflineminus">-</span>
<a href="#l8.1087"></a><span id="l8.1087" class="difflineminus">-  return null;</span>
<a href="#l8.1088"></a><span id="l8.1088" class="difflineminus">-}</span>
<a href="#l8.1089"></a><span id="l8.1089" class="difflineminus">-</span>
<a href="#l8.1090"></a><span id="l8.1090" class="difflineminus">-function createSubscriptionsFile(file)</span>
<a href="#l8.1091"></a><span id="l8.1091" class="difflineminus">-{</span>
<a href="#l8.1092"></a><span id="l8.1092" class="difflineminus">-  file = new LocalFile(file, MODE_WRONLY | MODE_CREATE);</span>
<a href="#l8.1093"></a><span id="l8.1093" class="difflineminus">-  file.write('\</span>
<a href="#l8.1094"></a><span id="l8.1094" class="difflineminus">-&lt;?xml version=&quot;1.0&quot;?&gt;\n\</span>
<a href="#l8.1095"></a><span id="l8.1095" class="difflineminus">-&lt;RDF:RDF xmlns:dc=&quot;http://purl.org/dc/elements/1.1/&quot;\n\</span>
<a href="#l8.1096"></a><span id="l8.1096" class="difflineminus">-         xmlns:fz=&quot;' + FZ_NS + '&quot;\n\</span>
<a href="#l8.1097"></a><span id="l8.1097" class="difflineminus">-         xmlns:RDF=&quot;http://www.w3.org/1999/02/22-rdf-syntax-ns#&quot;&gt;\n\</span>
<a href="#l8.1098"></a><span id="l8.1098" class="difflineminus">-  &lt;RDF:Description about=&quot;' + FZ_ROOT.Value + '&quot;&gt;\n\</span>
<a href="#l8.1099"></a><span id="l8.1099" class="difflineminus">-    &lt;fz:feeds&gt;\n\</span>
<a href="#l8.1100"></a><span id="l8.1100" class="difflineminus">-      &lt;RDF:Seq&gt;\n\</span>
<a href="#l8.1101"></a><span id="l8.1101" class="difflineminus">-      &lt;/RDF:Seq&gt;\n\</span>
<a href="#l8.1102"></a><span id="l8.1102" class="difflineminus">-    &lt;/fz:feeds&gt;\n\</span>
<a href="#l8.1103"></a><span id="l8.1103" class="difflineminus">-  &lt;/RDF:Description&gt;\n\</span>
<a href="#l8.1104"></a><span id="l8.1104" class="difflineminus">-&lt;/RDF:RDF&gt;\n\</span>
<a href="#l8.1105"></a><span id="l8.1105" class="difflineminus">-');</span>
<a href="#l8.1106"></a><span id="l8.1106" class="difflineminus">-  file.close();</span>
<a href="#l8.1107"></a><span id="l8.1107" class="difflineminus">-}</span>
<a href="#l8.1108"></a><span id="l8.1108" class="difflineminus">-</span>
<a href="#l8.1109"></a><span id="l8.1109" class="difflineminus">-function getItemsDS(server)</span>
<a href="#l8.1110"></a><span id="l8.1110" class="difflineminus">-{</span>
<a href="#l8.1111"></a><span id="l8.1111" class="difflineminus">-  var file = getItemsFile(server);</span>
<a href="#l8.1112"></a><span id="l8.1112" class="difflineminus">-  var url = fileHandler.getURLSpecFromFile(file);</span>
<a href="#l8.1113"></a><span id="l8.1113" class="difflineminus">-</span>
<a href="#l8.1114"></a><span id="l8.1114" class="difflineminus">-  // GetDataSourceBlocking has a cache, so it's cheap to do this again</span>
<a href="#l8.1115"></a><span id="l8.1115" class="difflineminus">-  // once we've already done it once.</span>
<a href="#l8.1116"></a><span id="l8.1116" class="difflineminus">-  var ds = rdf.GetDataSourceBlocking(url);</span>
<a href="#l8.1117"></a><span id="l8.1117" class="difflineminus">-  if (!ds)</span>
<a href="#l8.1118"></a><span id="l8.1118" class="difflineminus">-    throw(&quot;can't get subscriptions data source&quot;);</span>
<a href="#l8.1119"></a><span id="l8.1119" class="difflineminus">-</span>
<a href="#l8.1120"></a><span id="l8.1120" class="difflineminus">-  // Note that it this point the datasource may not be loaded yet.</span>
<a href="#l8.1121"></a><span id="l8.1121" class="difflineminus">-  // You have to QueryInterface it to nsIRDFRemoteDataSource and check</span>
<a href="#l8.1122"></a><span id="l8.1122" class="difflineminus">-  // its &quot;loaded&quot; property to be sure.  You can also attach an observer</span>
<a href="#l8.1123"></a><span id="l8.1123" class="difflineminus">-  // which will get notified when the load is complete.</span>
<a href="#l8.1124"></a><span id="l8.1124" class="difflineminus">-  return ds;</span>
<a href="#l8.1125"></a><span id="l8.1125" class="difflineminus">-}</span>
<a href="#l8.1126"></a><span id="l8.1126" class="difflineminus">-</span>
<a href="#l8.1127"></a><span id="l8.1127" class="difflineminus">-function getItemsFile(server)</span>
<a href="#l8.1128"></a><span id="l8.1128" class="difflineminus">-{</span>
<a href="#l8.1129"></a><span id="l8.1129" class="difflineminus">-  server.QueryInterface(Components.interfaces.nsIRssIncomingServer);</span>
<a href="#l8.1130"></a><span id="l8.1130" class="difflineminus">-  var file = server.feedItemsDataSourcePath;</span>
<a href="#l8.1131"></a><span id="l8.1131" class="difflineminus">-</span>
<a href="#l8.1132"></a><span id="l8.1132" class="difflineminus">-  // If the file doesn't exist, create it.</span>
<a href="#l8.1133"></a><span id="l8.1133" class="difflineminus">-  if (!file.exists())</span>
<a href="#l8.1134"></a><span id="l8.1134" class="difflineminus">-  {</span>
<a href="#l8.1135"></a><span id="l8.1135" class="difflineminus">-    var newfile = new LocalFile(file, MODE_WRONLY | MODE_CREATE);</span>
<a href="#l8.1136"></a><span id="l8.1136" class="difflineminus">-    newfile.write('\</span>
<a href="#l8.1137"></a><span id="l8.1137" class="difflineminus">-&lt;?xml version=&quot;1.0&quot;?&gt;\n\</span>
<a href="#l8.1138"></a><span id="l8.1138" class="difflineminus">-&lt;RDF:RDF xmlns:dc=&quot;http://purl.org/dc/elements/1.1/&quot;\n\</span>
<a href="#l8.1139"></a><span id="l8.1139" class="difflineminus">-         xmlns:fz=&quot;' + FZ_NS + '&quot;\n\</span>
<a href="#l8.1140"></a><span id="l8.1140" class="difflineminus">-         xmlns:RDF=&quot;http://www.w3.org/1999/02/22-rdf-syntax-ns#&quot;&gt;\n\</span>
<a href="#l8.1141"></a><span id="l8.1141" class="difflineminus">-&lt;/RDF:RDF&gt;\n\</span>
<a href="#l8.1142"></a><span id="l8.1142" class="difflineminus">-');</span>
<a href="#l8.1143"></a><span id="l8.1143" class="difflineminus">-    newfile.close();</span>
<a href="#l8.1144"></a><span id="l8.1144" class="difflineminus">-  }</span>
<a href="#l8.1145"></a><span id="l8.1145" class="difflineminus">-  return file;</span>
<a href="#l8.1146"></a><span id="l8.1146" class="difflineminus">-}</span>
<a href="#l8.1147"></a><span id="l8.1147" class="difflineminus">-</span>
<a href="#l8.1148"></a><span id="l8.1148" class="difflineminus">-function removeAssertions(ds, resource)</span>
<a href="#l8.1149"></a><span id="l8.1149" class="difflineminus">-{</span>
<a href="#l8.1150"></a><span id="l8.1150" class="difflineminus">-  var properties = ds.ArcLabelsOut(resource);</span>
<a href="#l8.1151"></a><span id="l8.1151" class="difflineminus">-  var property;</span>
<a href="#l8.1152"></a><span id="l8.1152" class="difflineminus">-  while (properties.hasMoreElements())</span>
<a href="#l8.1153"></a><span id="l8.1153" class="difflineminus">-  {</span>
<a href="#l8.1154"></a><span id="l8.1154" class="difflineminus">-    property = properties.getNext();</span>
<a href="#l8.1155"></a><span id="l8.1155" class="difflineminus">-    var values = ds.GetTargets(resource, property, true);</span>
<a href="#l8.1156"></a><span id="l8.1156" class="difflineminus">-    var value;</span>
<a href="#l8.1157"></a><span id="l8.1157" class="difflineminus">-    while (values.hasMoreElements())</span>
<a href="#l8.1158"></a><span id="l8.1158" class="difflineminus">-    {</span>
<a href="#l8.1159"></a><span id="l8.1159" class="difflineminus">-      value = values.getNext();</span>
<a href="#l8.1160"></a><span id="l8.1160" class="difflineminus">-      ds.Unassert(resource, property, value, true);</span>
<a href="#l8.1161"></a><span id="l8.1161" class="difflineminus">-    }</span>
<a href="#l8.1162"></a><span id="l8.1162" class="difflineminus">-  }</span>
<a href="#l8.1163"></a><span id="l8.1163" class="difflineminus">-}</span>
<a href="#l8.1164"></a><span id="l8.1164" class="difflineminus">-</span>
<a href="#l8.1165"></a><span id="l8.1165" class="difflineminus">-// Date validator for RSS feeds</span>
<a href="#l8.1166"></a><span id="l8.1166" class="difflineminus">-const FZ_RFC822_RE = &quot;^(((Mon)|(Tue)|(Wed)|(Thu)|(Fri)|(Sat)|(Sun)), *)?\\d\\d?&quot;</span>
<a href="#l8.1167"></a><span id="l8.1167" class="difflineminus">-+ &quot; +((Jan)|(Feb)|(Mar)|(Apr)|(May)|(Jun)|(Jul)|(Aug)|(Sep)|(Oct)|(Nov)|(Dec))&quot;</span>
<a href="#l8.1168"></a><span id="l8.1168" class="difflineminus">-+ &quot; +\\d\\d(\\d\\d)? +\\d\\d:\\d\\d(:\\d\\d)? +(([+-]?\\d\\d\\d\\d)|(UT)|(GMT)&quot;</span>
<a href="#l8.1169"></a><span id="l8.1169" class="difflineminus">-+ &quot;|(EST)|(EDT)|(CST)|(CDT)|(MST)|(MDT)|(PST)|(PDT)|\\w)$&quot;;</span>
<a href="#l8.1170"></a><span id="l8.1170" class="difflineminus">-</span>
<a href="#l8.1171"></a><span id="l8.1171" class="difflineminus">-function isValidRFC822Date(pubDate)</span>
<a href="#l8.1172"></a><span id="l8.1172" class="difflineminus">-{</span>
<a href="#l8.1173"></a><span id="l8.1173" class="difflineminus">-  var regex = new RegExp(FZ_RFC822_RE);</span>
<a href="#l8.1174"></a><span id="l8.1174" class="difflineminus">-  return regex.test(pubDate);</span>
<a href="#l8.1175"></a><span id="l8.1175" class="difflineminus">-}</span>
<a href="#l8.1176"></a><span id="l8.1176" class="difflineminus">-</span>
<a href="#l8.1177"></a><span id="l8.1177" class="difflineminus">-function dateRescue(dateString)</span>
<a href="#l8.1178"></a><span id="l8.1178" class="difflineminus">-{</span>
<a href="#l8.1179"></a><span id="l8.1179" class="difflineminus">-  // Deal with various kinds of invalid dates</span>
<a href="#l8.1180"></a><span id="l8.1180" class="difflineminus">-  if(!isNaN(parseInt(dateString)))</span>
<a href="#l8.1181"></a><span id="l8.1181" class="difflineminus">-  {</span>
<a href="#l8.1182"></a><span id="l8.1182" class="difflineminus">-    // It's an integer, so maybe it's a timestamp</span>
<a href="#l8.1183"></a><span id="l8.1183" class="difflineminus">-    var d = new Date(parseInt(dateString)*1000);</span>
<a href="#l8.1184"></a><span id="l8.1184" class="difflineminus">-    var now = new Date();</span>
<a href="#l8.1185"></a><span id="l8.1185" class="difflineminus">-    var yeardiff = now.getFullYear()-d.getFullYear();</span>
<a href="#l8.1186"></a><span id="l8.1186" class="difflineminus">-    debug(&quot;Rescue Timestamp date: &quot; + d.toString() + &quot;\nYear diff:&quot;</span>
<a href="#l8.1187"></a><span id="l8.1187" class="difflineminus">-        + yeardiff + &quot;\n&quot;);</span>
<a href="#l8.1188"></a><span id="l8.1188" class="difflineminus">-    if((yeardiff &gt;= 0) &amp;&amp; (yeardiff&lt;3))</span>
<a href="#l8.1189"></a><span id="l8.1189" class="difflineminus">-    {</span>
<a href="#l8.1190"></a><span id="l8.1190" class="difflineminus">-      // It's quite likely the correct date</span>
<a href="#l8.1191"></a><span id="l8.1191" class="difflineminus">-      return d.toString();</span>
<a href="#l8.1192"></a><span id="l8.1192" class="difflineminus">-    }</span>
<a href="#l8.1193"></a><span id="l8.1193" class="difflineminus">-  }</span>
<a href="#l8.1194"></a><span id="l8.1194" class="difflineminus">-  if(dateString.search(/^\d\d\d\d/) != -1)</span>
<a href="#l8.1195"></a><span id="l8.1195" class="difflineminus">-    //Could be a ISO8601/W3C date</span>
<a href="#l8.1196"></a><span id="l8.1196" class="difflineminus">-    return new Date(dateString).toUTCString();</span>
<a href="#l8.1197"></a><span id="l8.1197" class="difflineminus">-</span>
<a href="#l8.1198"></a><span id="l8.1198" class="difflineminus">-  // Can't help. Set to current time.</span>
<a href="#l8.1199"></a><span id="l8.1199" class="difflineminus">-  return (new Date()).toString();</span>
<a href="#l8.1200"></a><span id="l8.1200" class="difflineminus">-}</span>
<a href="#l8.1201"></a><span id="l8.1201" class="difflineminus">-</span>
<a href="#l8.1202"></a><span id="l8.1202" class="difflineminus">-function htmlEscape(s)</span>
<a href="#l8.1203"></a><span id="l8.1203" class="difflineminus">-{</span>
<a href="#l8.1204"></a><span id="l8.1204" class="difflineminus">-  s = s.replace(/&amp;/g, &quot;&amp;amp;&quot;);</span>
<a href="#l8.1205"></a><span id="l8.1205" class="difflineminus">-  s = s.replace(/&gt;/g, &quot;&amp;gt;&quot;);</span>
<a href="#l8.1206"></a><span id="l8.1206" class="difflineminus">-  s = s.replace(/&lt;/g, &quot;&amp;lt;&quot;);</span>
<a href="#l8.1207"></a><span id="l8.1207" class="difflineminus">-  s = s.replace(/'/g, &quot;&amp;#39;&quot;);</span>
<a href="#l8.1208"></a><span id="l8.1208" class="difflineminus">-  s = s.replace(/&quot;/g, &quot;&amp;quot;&quot;);</span>
<a href="#l8.1209"></a><span id="l8.1209" class="difflineminus">-  return s;</span>
<a href="#l8.1210"></a><span id="l8.1210" class="difflineminus">-}</span>
<a href="#l8.1211"></a><span id="l8.1211" class="difflineminus">-</span>
<a href="#l8.1212"></a><span id="l8.1212" class="difflineminus">-// Returns name as a URN in the 'feeditem' namespace. The</span>
<a href="#l8.1213"></a><span id="l8.1213" class="difflineminus">-// returned URN is (or intended to be) RFC2141 compliant. </span>
<a href="#l8.1214"></a><span id="l8.1214" class="difflineminus">-function createURN(name)</span>
<a href="#l8.1215"></a><span id="l8.1215" class="difflineminus">-{</span>
<a href="#l8.1216"></a><span id="l8.1216" class="difflineminus">-  // The builtin encodeURI provides nearly the exact</span>
<a href="#l8.1217"></a><span id="l8.1217" class="difflineminus">-  // encoding functionality required by the RFC.  The</span>
<a href="#l8.1218"></a><span id="l8.1218" class="difflineminus">-  // exceptions are that NULL characters should not</span>
<a href="#l8.1219"></a><span id="l8.1219" class="difflineminus">-  // appear, and that #, /, ?, &amp;, and ~ should be</span>
<a href="#l8.1220"></a><span id="l8.1220" class="difflineminus">-  // escaped.</span>
<a href="#l8.1221"></a><span id="l8.1221" class="difflineminus">-  // NULL characters are removed before encoding.</span>
<a href="#l8.1222"></a><span id="l8.1222" class="difflineminus">-</span>
<a href="#l8.1223"></a><span id="l8.1223" class="difflineminus">-  name = name.replace(/\0/g, &quot;&quot;);</span>
<a href="#l8.1224"></a><span id="l8.1224" class="difflineminus">-</span>
<a href="#l8.1225"></a><span id="l8.1225" class="difflineminus">-  var encoded = encodeURI(name);</span>
<a href="#l8.1226"></a><span id="l8.1226" class="difflineminus">-</span>
<a href="#l8.1227"></a><span id="l8.1227" class="difflineminus">-  encoded = encoded.replace(/\#/g, &quot;%23&quot;);</span>
<a href="#l8.1228"></a><span id="l8.1228" class="difflineminus">-  encoded = encoded.replace(/\//g, &quot;%2f&quot;);</span>
<a href="#l8.1229"></a><span id="l8.1229" class="difflineminus">-  encoded = encoded.replace(/\?/g, &quot;%3f&quot;);</span>
<a href="#l8.1230"></a><span id="l8.1230" class="difflineminus">-  encoded = encoded.replace(/\&amp;/g, &quot;%26&quot;);</span>
<a href="#l8.1231"></a><span id="l8.1231" class="difflineminus">-  encoded = encoded.replace(/\~/g, &quot;%7e&quot;);</span>
<a href="#l8.1232"></a><span id="l8.1232" class="difflineminus">-</span>
<a href="#l8.1233"></a><span id="l8.1233" class="difflineminus">-  return FZ_ITEM_NS + encoded;</span>
<a href="#l8.1234"></a><span id="l8.1234" class="difflineminus">-}</span>
<a href="#l8.1235"></a><span id="l8.1235" class="difflineplus">+XPCOMUtils.defineLazyGetter(FeedUtils, &quot;rdfContainerUtils&quot;, function() {</span>
<a href="#l8.1236"></a><span id="l8.1236" class="difflineplus">+  return Cc[&quot;@mozilla.org/rdf/container-utils;1&quot;].</span>
<a href="#l8.1237"></a><span id="l8.1237" class="difflineplus">+         getService(Ci.nsIRDFContainerUtils);</span>
<a href="#l8.1238"></a><span id="l8.1238" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/extensions/newsblog/jar.mn</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/extensions/newsblog/jar.mn</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -1,12 +1,11 @@</span>
<a href="#l9.4"></a><span id="l9.4"> newsblog.jar:</span>
<a href="#l9.5"></a><span id="l9.5"> % content messenger-newsblog %content/messenger-newsblog/</span>
<a href="#l9.6"></a><span id="l9.6"> *  content/messenger-newsblog/newsblogOverlay.js                (content/newsblogOverlay.js)</span>
<a href="#l9.7"></a><span id="l9.7" class="difflineminus">-*  content/messenger-newsblog/debug-utils.js                    (content/debug-utils.js)</span>
<a href="#l9.8"></a><span id="l9.8"> *  content/messenger-newsblog/Feed.js                           (content/Feed.js)</span>
<a href="#l9.9"></a><span id="l9.9"> *  content/messenger-newsblog/FeedItem.js                       (content/FeedItem.js)</span>
<a href="#l9.10"></a><span id="l9.10"> *  content/messenger-newsblog/feed-parser.js                    (content/feed-parser.js)</span>
<a href="#l9.11"></a><span id="l9.11"> *  content/messenger-newsblog/file-utils.js                     (content/file-utils.js)</span>
<a href="#l9.12"></a><span id="l9.12"> *  content/messenger-newsblog/utils.js                          (content/utils.js)</span>
<a href="#l9.13"></a><span id="l9.13"> *  content/messenger-newsblog/feed-subscriptions.js             (content/feed-subscriptions.js)</span>
<a href="#l9.14"></a><span id="l9.14"> *  content/messenger-newsblog/feed-subscriptions.xul            (content/feed-subscriptions.xul)</span>
<a href="#l9.15"></a><span id="l9.15"> *  content/messenger-newsblog/am-newsblog.xul                   (content/am-newsblog.xul)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/extensions/newsblog/js/newsblog.js</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/extensions/newsblog/js/newsblog.js</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -18,16 +18,17 @@</span>
<a href="#l10.4"></a><span id="l10.4">  * The Mozilla Foundation.</span>
<a href="#l10.5"></a><span id="l10.5">  * Portions created by the Initial Developer are Copyright (C) 2004</span>
<a href="#l10.6"></a><span id="l10.6">  * the Initial Developer. All Rights Reserved.</span>
<a href="#l10.7"></a><span id="l10.7">  *</span>
<a href="#l10.8"></a><span id="l10.8">  * Contributor(s):</span>
<a href="#l10.9"></a><span id="l10.9">  *  Myk Melez &lt;myk@mozilla.org) (Original Author)</span>
<a href="#l10.10"></a><span id="l10.10">  *  David Bienvenu &lt;bienvenu@nventure.com&gt; </span>
<a href="#l10.11"></a><span id="l10.11">  *  Ian Neal &lt;iann_bugzilla@blueyonder.co.uk&gt;</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineplus">+ *  alta88 &lt;alta88@gmail.com&gt;</span>
<a href="#l10.13"></a><span id="l10.13">  *</span>
<a href="#l10.14"></a><span id="l10.14">  * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l10.15"></a><span id="l10.15">  * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l10.16"></a><span id="l10.16">  * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l10.17"></a><span id="l10.17">  * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l10.18"></a><span id="l10.18">  * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l10.19"></a><span id="l10.19">  * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l10.20"></a><span id="l10.20">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l10.21"></a><span id="l10.21" class="difflineat">@@ -54,24 +55,16 @@ var nsNewsBlogFeedDownloader =</span>
<a href="#l10.22"></a><span id="l10.22">     // new feeds.</span>
<a href="#l10.23"></a><span id="l10.23">     if (FeedUtils.progressNotifier.mSubscribeMode)</span>
<a href="#l10.24"></a><span id="l10.24">     {</span>
<a href="#l10.25"></a><span id="l10.25">       FeedUtils.log.warn(&quot;downloadFeed: Aborting RSS New Mail Check. &quot; +</span>
<a href="#l10.26"></a><span id="l10.26">                          &quot;Feed subscription in progress\n&quot;);</span>
<a href="#l10.27"></a><span id="l10.27">       return;</span>
<a href="#l10.28"></a><span id="l10.28">     }</span>
<a href="#l10.29"></a><span id="l10.29"> </span>
<a href="#l10.30"></a><span id="l10.30" class="difflineminus">-    let feedUrlArray = getFeedUrlsInFolder(aFolder);</span>
<a href="#l10.31"></a><span id="l10.31" class="difflineminus">-</span>
<a href="#l10.32"></a><span id="l10.32" class="difflineminus">-    // Return if there are no feedUrls for the base folder in the feeds</span>
<a href="#l10.33"></a><span id="l10.33" class="difflineminus">-    // database, the base folder has no subfolders, or the folder is in Trash.</span>
<a href="#l10.34"></a><span id="l10.34" class="difflineminus">-    if ((!feedUrlArray &amp;&amp; !aFolder.hasSubFolders) ||</span>
<a href="#l10.35"></a><span id="l10.35" class="difflineminus">-        aFolder.isSpecialFolder(Ci.nsMsgFolderFlags.Trash, true))</span>
<a href="#l10.36"></a><span id="l10.36" class="difflineminus">-      return;</span>
<a href="#l10.37"></a><span id="l10.37" class="difflineminus">-</span>
<a href="#l10.38"></a><span id="l10.38">     let allFolders = Cc[&quot;@mozilla.org/supports-array;1&quot;].</span>
<a href="#l10.39"></a><span id="l10.39">                      createInstance(Ci.nsISupportsArray);</span>
<a href="#l10.40"></a><span id="l10.40">     // Add the base folder; it does not get added by ListDescendents.</span>
<a href="#l10.41"></a><span id="l10.41">     allFolders.AppendElement(aFolder);</span>
<a href="#l10.42"></a><span id="l10.42">     aFolder.ListDescendents(allFolders);</span>
<a href="#l10.43"></a><span id="l10.43">     let numFolders = allFolders.Count();</span>
<a href="#l10.44"></a><span id="l10.44">     let trashFolder =</span>
<a href="#l10.45"></a><span id="l10.45">         aFolder.rootFolder.getFolderWithFlags(Ci.nsMsgFolderFlags.Trash);</span>
<a href="#l10.46"></a><span id="l10.46" class="difflineat">@@ -102,17 +95,17 @@ var nsNewsBlogFeedDownloader =</span>
<a href="#l10.47"></a><span id="l10.47">             // Ignore error returns.</span>
<a href="#l10.48"></a><span id="l10.48">             folder.QueryInterface(Ci.nsIMsgLocalMailFolder).</span>
<a href="#l10.49"></a><span id="l10.49">                    getDatabaseWithReparse(null, null);</span>
<a href="#l10.50"></a><span id="l10.50">           }</span>
<a href="#l10.51"></a><span id="l10.51">           catch (ex) {}</span>
<a href="#l10.52"></a><span id="l10.52">           continue;</span>
<a href="#l10.53"></a><span id="l10.53">         }</span>
<a href="#l10.54"></a><span id="l10.54"> </span>
<a href="#l10.55"></a><span id="l10.55" class="difflineminus">-        let feedUrlArray = getFeedUrlsInFolder(folder);</span>
<a href="#l10.56"></a><span id="l10.56" class="difflineplus">+        let feedUrlArray = FeedUtils.getFeedUrlsInFolder(folder);</span>
<a href="#l10.57"></a><span id="l10.57">         // Continue if there are no feedUrls for the folder in the feeds</span>
<a href="#l10.58"></a><span id="l10.58">         // database.  All folders in Trash are now unsubscribed, so perhaps</span>
<a href="#l10.59"></a><span id="l10.59">         // we may not want to check that here each biff each folder.</span>
<a href="#l10.60"></a><span id="l10.60">         if (!feedUrlArray ||</span>
<a href="#l10.61"></a><span id="l10.61">             (aFolder.isServer &amp;&amp; trashFolder &amp;&amp; trashFolder.isAncestorOf(folder)))</span>
<a href="#l10.62"></a><span id="l10.62">           continue;</span>
<a href="#l10.63"></a><span id="l10.63"> </span>
<a href="#l10.64"></a><span id="l10.64">         FeedUtils.log.debug(&quot;downloadFeed: CONTINUE foldername:urlArray - &quot;+</span>
<a href="#l10.65"></a><span id="l10.65" class="difflineat">@@ -121,17 +114,17 @@ var nsNewsBlogFeedDownloader =</span>
<a href="#l10.66"></a><span id="l10.66">         FeedUtils.progressNotifier.init(aMsgWindow, false);</span>
<a href="#l10.67"></a><span id="l10.67"> </span>
<a href="#l10.68"></a><span id="l10.68">         // We need to kick off a download for each feed.</span>
<a href="#l10.69"></a><span id="l10.69">         let id, feed;</span>
<a href="#l10.70"></a><span id="l10.70">         for (let url in feedUrlArray)</span>
<a href="#l10.71"></a><span id="l10.71">         {</span>
<a href="#l10.72"></a><span id="l10.72">           if (feedUrlArray[url])</span>
<a href="#l10.73"></a><span id="l10.73">           {</span>
<a href="#l10.74"></a><span id="l10.74" class="difflineminus">-            id = rdf.GetResource(feedUrlArray[url]);</span>
<a href="#l10.75"></a><span id="l10.75" class="difflineplus">+            id = FeedUtils.rdf.GetResource(feedUrlArray[url]);</span>
<a href="#l10.76"></a><span id="l10.76">             feed = new Feed(id, folder.server);</span>
<a href="#l10.77"></a><span id="l10.77">             feed.folder = folder;</span>
<a href="#l10.78"></a><span id="l10.78">             // Bump our pending feed download count.</span>
<a href="#l10.79"></a><span id="l10.79">             FeedUtils.progressNotifier.mNumPendingFeedDownloads++;</span>
<a href="#l10.80"></a><span id="l10.80">             feed.download(true, FeedUtils.progressNotifier);</span>
<a href="#l10.81"></a><span id="l10.81">             FeedUtils.log.debug(&quot;downloadFeed: DOWNLOAD feed url - &quot;+</span>
<a href="#l10.82"></a><span id="l10.82">                                 feedUrlArray[url]);</span>
<a href="#l10.83"></a><span id="l10.83">           }</span>
<a href="#l10.84"></a><span id="l10.84" class="difflineat">@@ -192,17 +185,17 @@ var nsNewsBlogFeedDownloader =</span>
<a href="#l10.85"></a><span id="l10.85"> </span>
<a href="#l10.86"></a><span id="l10.86">     // If aFolder is null, then use the root folder for the first RSS account.</span>
<a href="#l10.87"></a><span id="l10.87">     if (!aFolder)</span>
<a href="#l10.88"></a><span id="l10.88">     {</span>
<a href="#l10.89"></a><span id="l10.89">       let allServers = MailServices.accounts.allServers;</span>
<a href="#l10.90"></a><span id="l10.90">       for (let i = 0; i &lt; allServers.Count() &amp;&amp; !aFolder; i++)</span>
<a href="#l10.91"></a><span id="l10.91">       {</span>
<a href="#l10.92"></a><span id="l10.92">         let currentServer = allServers.QueryElementAt(i, Ci.nsIMsgIncomingServer);</span>
<a href="#l10.93"></a><span id="l10.93" class="difflineminus">-        if (currentServer &amp;&amp; currentServer.type == 'rss')</span>
<a href="#l10.94"></a><span id="l10.94" class="difflineplus">+        if (currentServer &amp;&amp; currentServer.type == &quot;rss&quot;)</span>
<a href="#l10.95"></a><span id="l10.95">           aFolder = currentServer.rootFolder;</span>
<a href="#l10.96"></a><span id="l10.96">       }</span>
<a href="#l10.97"></a><span id="l10.97">     }</span>
<a href="#l10.98"></a><span id="l10.98"> </span>
<a href="#l10.99"></a><span id="l10.99">     // If the user has no RSS account yet, create one; also check then if</span>
<a href="#l10.100"></a><span id="l10.100">     // the &quot;Local Folders&quot; exist yet and create if necessary.</span>
<a href="#l10.101"></a><span id="l10.101">     if (!aFolder)</span>
<a href="#l10.102"></a><span id="l10.102">     {</span>
<a href="#l10.103"></a><span id="l10.103" class="difflineat">@@ -260,26 +253,26 @@ var nsNewsBlogFeedDownloader =</span>
<a href="#l10.104"></a><span id="l10.104">     // feed://example.org/feed.xml or feed:https://example.org/feed.xml.</span>
<a href="#l10.105"></a><span id="l10.105">     // Replace feed:// with http:// per the spec, then strip off feed:</span>
<a href="#l10.106"></a><span id="l10.106">     // for the second case.</span>
<a href="#l10.107"></a><span id="l10.107">     aUrl = aUrl.replace(/^feed:\x2f\x2f/i, &quot;http://&quot;);</span>
<a href="#l10.108"></a><span id="l10.108">     aUrl = aUrl.replace(/^feed:/i, &quot;&quot;);</span>
<a href="#l10.109"></a><span id="l10.109"> </span>
<a href="#l10.110"></a><span id="l10.110">     // Make sure we aren't already subscribed to this feed before we attempt</span>
<a href="#l10.111"></a><span id="l10.111">     // to subscribe to it.</span>
<a href="#l10.112"></a><span id="l10.112" class="difflineminus">-    if (feedAlreadyExists(aUrl, aFolder.server))</span>
<a href="#l10.113"></a><span id="l10.113" class="difflineplus">+    if (FeedUtils.feedAlreadyExists(aUrl, aFolder.server))</span>
<a href="#l10.114"></a><span id="l10.114">     {</span>
<a href="#l10.115"></a><span id="l10.115">       aMsgWindow.statusFeedback.showStatusString(</span>
<a href="#l10.116"></a><span id="l10.116" class="difflineminus">-        FeedUtils.strings.GetStringFromName('subscribe-feedAlreadySubscribed'));</span>
<a href="#l10.117"></a><span id="l10.117" class="difflineplus">+        FeedUtils.strings.GetStringFromName(&quot;subscribe-feedAlreadySubscribed&quot;));</span>
<a href="#l10.118"></a><span id="l10.118">       return;</span>
<a href="#l10.119"></a><span id="l10.119">     }</span>
<a href="#l10.120"></a><span id="l10.120"> </span>
<a href="#l10.121"></a><span id="l10.121" class="difflineminus">-    let itemResource = rdf.GetResource(aUrl);</span>
<a href="#l10.122"></a><span id="l10.122" class="difflineplus">+    let itemResource = FeedUtils.rdf.GetResource(aUrl);</span>
<a href="#l10.123"></a><span id="l10.123">     let feed = new Feed(itemResource, aFolder.server);</span>
<a href="#l10.124"></a><span id="l10.124" class="difflineminus">-    feed.quickMode = feed.server.getBoolValue('quickMode');</span>
<a href="#l10.125"></a><span id="l10.125" class="difflineplus">+    feed.quickMode = feed.server.getBoolValue(&quot;quickMode&quot;);</span>
<a href="#l10.126"></a><span id="l10.126"> </span>
<a href="#l10.127"></a><span id="l10.127">     // If the root server, create a new folder for the feed.  The user must</span>
<a href="#l10.128"></a><span id="l10.128">     // want us to add this subscription url to an existing RSS folder.</span>
<a href="#l10.129"></a><span id="l10.129">     if (!aFolder.isServer)</span>
<a href="#l10.130"></a><span id="l10.130">       feed.folder = aFolder;</span>
<a href="#l10.131"></a><span id="l10.131"> </span>
<a href="#l10.132"></a><span id="l10.132">     FeedUtils.progressNotifier.init(aMsgWindow, true);</span>
<a href="#l10.133"></a><span id="l10.133">     FeedUtils.progressNotifier.mNumPendingFeedDownloads++;</span>
<a href="#l10.134"></a><span id="l10.134" class="difflineat">@@ -288,46 +281,46 @@ var nsNewsBlogFeedDownloader =</span>
<a href="#l10.135"></a><span id="l10.135"> </span>
<a href="#l10.136"></a><span id="l10.136">   updateSubscriptionsDS: function(aFolder, aUnsubscribe)</span>
<a href="#l10.137"></a><span id="l10.137">   {</span>
<a href="#l10.138"></a><span id="l10.138">     if (!gExternalScriptsLoaded)</span>
<a href="#l10.139"></a><span id="l10.139">       loadScripts();</span>
<a href="#l10.140"></a><span id="l10.140"> </span>
<a href="#l10.141"></a><span id="l10.141">     // An rss folder was just changed, get the folder's feedUrls and update</span>
<a href="#l10.142"></a><span id="l10.142">     // our feed data source.</span>
<a href="#l10.143"></a><span id="l10.143" class="difflineminus">-    let feedUrlArray = getFeedUrlsInFolder(aFolder);</span>
<a href="#l10.144"></a><span id="l10.144" class="difflineplus">+    let feedUrlArray = FeedUtils.getFeedUrlsInFolder(aFolder);</span>
<a href="#l10.145"></a><span id="l10.145">     if (!feedUrlArray)</span>
<a href="#l10.146"></a><span id="l10.146">       // No feedUrls in this folder.</span>
<a href="#l10.147"></a><span id="l10.147">       return;</span>
<a href="#l10.148"></a><span id="l10.148"> </span>
<a href="#l10.149"></a><span id="l10.149">     let newFeedUrl, id, resource, node;</span>
<a href="#l10.150"></a><span id="l10.150" class="difflineminus">-    let ds = getSubscriptionsDS(aFolder.server);</span>
<a href="#l10.151"></a><span id="l10.151" class="difflineplus">+    let ds = FeedUtils.getSubscriptionsDS(aFolder.server);</span>
<a href="#l10.152"></a><span id="l10.152">     let trashFolder =</span>
<a href="#l10.153"></a><span id="l10.153">         aFolder.rootFolder.getFolderWithFlags(Ci.nsMsgFolderFlags.Trash);</span>
<a href="#l10.154"></a><span id="l10.154">     for (let url in feedUrlArray)</span>
<a href="#l10.155"></a><span id="l10.155">     {</span>
<a href="#l10.156"></a><span id="l10.156">       newFeedUrl = feedUrlArray[url];</span>
<a href="#l10.157"></a><span id="l10.157">       if (newFeedUrl)</span>
<a href="#l10.158"></a><span id="l10.158">       {</span>
<a href="#l10.159"></a><span id="l10.159" class="difflineminus">-        id = rdf.GetResource(newFeedUrl);</span>
<a href="#l10.160"></a><span id="l10.160" class="difflineplus">+        id = FeedUtils.rdf.GetResource(newFeedUrl);</span>
<a href="#l10.161"></a><span id="l10.161">         // If explicit delete or move to trash, unsubscribe.</span>
<a href="#l10.162"></a><span id="l10.162">         if (aUnsubscribe ||</span>
<a href="#l10.163"></a><span id="l10.163">             (trashFolder &amp;&amp; trashFolder.isAncestorOf(aFolder)))</span>
<a href="#l10.164"></a><span id="l10.164">         {</span>
<a href="#l10.165"></a><span id="l10.165" class="difflineminus">-          deleteFeed(id, aFolder.server, aFolder);</span>
<a href="#l10.166"></a><span id="l10.166" class="difflineplus">+          FeedUtils.deleteFeed(id, aFolder.server, aFolder);</span>
<a href="#l10.167"></a><span id="l10.167">         }</span>
<a href="#l10.168"></a><span id="l10.168">         else</span>
<a href="#l10.169"></a><span id="l10.169">         {</span>
<a href="#l10.170"></a><span id="l10.170" class="difflineminus">-          resource = rdf.GetResource(aFolder.URI);</span>
<a href="#l10.171"></a><span id="l10.171" class="difflineplus">+          resource = FeedUtils.rdf.GetResource(aFolder.URI);</span>
<a href="#l10.172"></a><span id="l10.172">           // Get the node for the current folder URI.</span>
<a href="#l10.173"></a><span id="l10.173" class="difflineminus">-          node = ds.GetTarget(id, FZ_DESTFOLDER, true);</span>
<a href="#l10.174"></a><span id="l10.174" class="difflineplus">+          node = ds.GetTarget(id, FeedUtils.FZ_DESTFOLDER, true);</span>
<a href="#l10.175"></a><span id="l10.175">           if (node)</span>
<a href="#l10.176"></a><span id="l10.176" class="difflineminus">-            ds.Change(id, FZ_DESTFOLDER, node, resource);</span>
<a href="#l10.177"></a><span id="l10.177" class="difflineplus">+            ds.Change(id, FeedUtils.FZ_DESTFOLDER, node, resource);</span>
<a href="#l10.178"></a><span id="l10.178">           else</span>
<a href="#l10.179"></a><span id="l10.179" class="difflineminus">-            addFeed(newFeedUrl, resource.name, resource);</span>
<a href="#l10.180"></a><span id="l10.180" class="difflineplus">+            FeedUtils.addFeed(newFeedUrl, resource.name, resource);</span>
<a href="#l10.181"></a><span id="l10.181">         }</span>
<a href="#l10.182"></a><span id="l10.182">       }</span>
<a href="#l10.183"></a><span id="l10.183">     } // for each feed url in the folder property</span>
<a href="#l10.184"></a><span id="l10.184"> </span>
<a href="#l10.185"></a><span id="l10.185">     ds.QueryInterface(Ci.nsIRDFRemoteDataSource).Flush();</span>
<a href="#l10.186"></a><span id="l10.186">   },</span>
<a href="#l10.187"></a><span id="l10.187"> </span>
<a href="#l10.188"></a><span id="l10.188">   QueryInterface: function(aIID)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/suite/mailnews/mailWindowOverlay.js</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/suite/mailnews/mailWindowOverlay.js</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -3097,24 +3097,24 @@ function FeedSetContentView(val)</span>
<a href="#l11.4"></a><span id="l11.4">       break;</span>
<a href="#l11.5"></a><span id="l11.5">     case 1:</span>
<a href="#l11.6"></a><span id="l11.6">       showSummary = true</span>
<a href="#l11.7"></a><span id="l11.7">       break;</span>
<a href="#l11.8"></a><span id="l11.8">     case 2:</span>
<a href="#l11.9"></a><span id="l11.9">       if (wintype == &quot;mail:3pane&quot;) {</span>
<a href="#l11.10"></a><span id="l11.10">         // Get quickmode per feed pref from feeds.rdf</span>
<a href="#l11.11"></a><span id="l11.11">         var quickMode, targetRes;</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-        if (typeof FZ_NS == 'undefined')</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+        if (!(&quot;FeedUtils&quot; in window))</span>
<a href="#l11.14"></a><span id="l11.14">           Services.scriptloader.loadSubScript(&quot;chrome://messenger-newsblog/content/utils.js&quot;);</span>
<a href="#l11.15"></a><span id="l11.15">         try</span>
<a href="#l11.16"></a><span id="l11.16">         {</span>
<a href="#l11.17"></a><span id="l11.17" class="difflineminus">-          var targetRes = getParentTargetForChildResource(</span>
<a href="#l11.18"></a><span id="l11.18" class="difflineminus">-                          gMsgFolderSelected.URI,</span>
<a href="#l11.19"></a><span id="l11.19" class="difflineminus">-                          FZ_QUICKMODE,</span>
<a href="#l11.20"></a><span id="l11.20" class="difflineminus">-                          gMsgFolderSelected.server);</span>
<a href="#l11.21"></a><span id="l11.21" class="difflineplus">+          var targetRes = FeedUtils.getParentTargetForChildResource(</span>
<a href="#l11.22"></a><span id="l11.22" class="difflineplus">+                            gFolderDisplay.displayedFolder.URI,</span>
<a href="#l11.23"></a><span id="l11.23" class="difflineplus">+                            FeedUtils.FZ_QUICKMODE,</span>
<a href="#l11.24"></a><span id="l11.24" class="difflineplus">+                            gFolderDisplay.displayedFolder.server);</span>
<a href="#l11.25"></a><span id="l11.25">         }</span>
<a href="#l11.26"></a><span id="l11.26">         catch (ex) {};</span>
<a href="#l11.27"></a><span id="l11.27"> </span>
<a href="#l11.28"></a><span id="l11.28">         if (targetRes)</span>
<a href="#l11.29"></a><span id="l11.29">         {</span>
<a href="#l11.30"></a><span id="l11.30">           quickMode = targetRes.QueryInterface(Components.interfaces</span>
<a href="#l11.31"></a><span id="l11.31">                                .nsIRDFLiteral);</span>
<a href="#l11.32"></a><span id="l11.32">           quickMode = quickMode.Value;</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

