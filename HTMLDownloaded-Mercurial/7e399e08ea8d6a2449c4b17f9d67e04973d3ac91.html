<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 5580:7e399e08ea8d6a2449c4b17f9d67e04973d3ac91</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 7e399e08ea8d6a2449c4b17f9d67e04973d3ac91" />
<meta property="og:url" content="/comm-central/rev/7e399e08ea8d6a2449c4b17f9d67e04973d3ac91" />
<meta property="og:description" content="Use DNS MX in autoconfig ISPDB looksups, webservice version. Bug 551519, r=bwinton" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 7e399e08ea8d6a2449c4b17f9d67e04973d3ac91 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/7e399e08ea8d6a2449c4b17f9d67e04973d3ac91">shortlog</a> |
<a href="/comm-central/log/7e399e08ea8d6a2449c4b17f9d67e04973d3ac91">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/7e399e08ea8d6a2449c4b17f9d67e04973d3ac91">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/7e399e08ea8d6a2449c4b17f9d67e04973d3ac91">files</a> |
changeset |
<a href="/comm-central/raw-rev/7e399e08ea8d6a2449c4b17f9d67e04973d3ac91">raw</a>  | <a href="/comm-central/archive/7e399e08ea8d6a2449c4b17f9d67e04973d3ac91.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
Use DNS MX in autoconfig ISPDB looksups, webservice version. <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=551519">Bug 551519</a>, r=bwinton
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#66;&#101;&#110;&#32;&#66;&#117;&#99;&#107;&#115;&#99;&#104;&#32;&#60;&#98;&#101;&#110;&#46;&#98;&#117;&#99;&#107;&#115;&#99;&#104;&#64;&#98;&#101;&#111;&#110;&#101;&#120;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Wed, 05 May 2010 18:04:14 +0200</td></tr>

<tr>
 <td>changeset 5580</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/7e399e08ea8d6a2449c4b17f9d67e04973d3ac91">7e399e08ea8d6a2449c4b17f9d67e04973d3ac91</a></td>
</tr>



<tr>
<td>parent 5579</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/af343bba709b971c9db772bd5d99aa9cfb1b3daa">af343bba709b971c9db772bd5d99aa9cfb1b3daa</a>
</td>
</tr>

<tr>
<td>child 5581</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/bb4bbf27ff43842db4497226ddc57d49918b4edf">bb4bbf27ff43842db4497226ddc57d49918b4edf</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=7e399e08ea8d6a2449c4b17f9d67e04973d3ac91">4324</a></td></tr>
<tr><td>push user</td><td>mozilla.BenB@bucksch.org</td></tr>
<tr><td>push date</td><td class="date age">Wed, 05 May 2010 16:05:33 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@7e399e08ea8d [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=7e399e08ea8d6a2449c4b17f9d67e04973d3ac91">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=7e399e08ea8d6a2449c4b17f9d67e04973d3ac91&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=7e399e08ea8d6a2449c4b17f9d67e04973d3ac91&newProject=comm-central&newRevision=7e399e08ea8d6a2449c4b17f9d67e04973d3ac91&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=7e399e08ea8d6a2449c4b17f9d67e04973d3ac91&newProject=comm-central&newRevision=7e399e08ea8d6a2449c4b17f9d67e04973d3ac91&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=7e399e08ea8d6a2449c4b17f9d67e04973d3ac91&newProject=comm-central&newRevision=7e399e08ea8d6a2449c4b17f9d67e04973d3ac91&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28bwinton%29&revcount=50">bwinton</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=551519">551519</a>, <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=545866">545866</a></td></tr>




</table></div>

<div class="page_body description">Use DNS MX in autoconfig ISPDB looksups, webservice version. <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=551519">Bug 551519</a>, r=bwinton
To help domains (e.g. company domains) hosted by a bigger web hoster, we look up
DNS MX (the receiving mail server) to find the hoster, take the domain, and
do another lookup in the ISPDB with that domain.
Because Mozilla doesn't support arbitrary DNS lookups (<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=545866">bug 545866</a>), we use another
webservice (also on momo servers) to do that. This should change to a client-only
solution as soon as <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=545866">bug 545866</a> is fixed.
Also, I am avoiding string changes, due to the 3.1 string freeze.</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7e399e08ea8d6a2449c4b17f9d67e04973d3ac91/mailnews/base/prefs/content/accountcreation/emailWizard.js">mailnews/base/prefs/content/accountcreation/emailWizard.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7e399e08ea8d6a2449c4b17f9d67e04973d3ac91/mailnews/base/prefs/content/accountcreation/emailWizard.js">file</a> |
<a href="/comm-central/annotate/7e399e08ea8d6a2449c4b17f9d67e04973d3ac91/mailnews/base/prefs/content/accountcreation/emailWizard.js">annotate</a> |
<a href="/comm-central/diff/7e399e08ea8d6a2449c4b17f9d67e04973d3ac91/mailnews/base/prefs/content/accountcreation/emailWizard.js">diff</a> |
<a href="/comm-central/comparison/7e399e08ea8d6a2449c4b17f9d67e04973d3ac91/mailnews/base/prefs/content/accountcreation/emailWizard.js">comparison</a> |
<a href="/comm-central/log/7e399e08ea8d6a2449c4b17f9d67e04973d3ac91/mailnews/base/prefs/content/accountcreation/emailWizard.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7e399e08ea8d6a2449c4b17f9d67e04973d3ac91/mailnews/base/prefs/content/accountcreation/fetchConfig.js">mailnews/base/prefs/content/accountcreation/fetchConfig.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7e399e08ea8d6a2449c4b17f9d67e04973d3ac91/mailnews/base/prefs/content/accountcreation/fetchConfig.js">file</a> |
<a href="/comm-central/annotate/7e399e08ea8d6a2449c4b17f9d67e04973d3ac91/mailnews/base/prefs/content/accountcreation/fetchConfig.js">annotate</a> |
<a href="/comm-central/diff/7e399e08ea8d6a2449c4b17f9d67e04973d3ac91/mailnews/base/prefs/content/accountcreation/fetchConfig.js">diff</a> |
<a href="/comm-central/comparison/7e399e08ea8d6a2449c4b17f9d67e04973d3ac91/mailnews/base/prefs/content/accountcreation/fetchConfig.js">comparison</a> |
<a href="/comm-central/log/7e399e08ea8d6a2449c4b17f9d67e04973d3ac91/mailnews/base/prefs/content/accountcreation/fetchConfig.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7e399e08ea8d6a2449c4b17f9d67e04973d3ac91/mailnews/mailnews.js">mailnews/mailnews.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7e399e08ea8d6a2449c4b17f9d67e04973d3ac91/mailnews/mailnews.js">file</a> |
<a href="/comm-central/annotate/7e399e08ea8d6a2449c4b17f9d67e04973d3ac91/mailnews/mailnews.js">annotate</a> |
<a href="/comm-central/diff/7e399e08ea8d6a2449c4b17f9d67e04973d3ac91/mailnews/mailnews.js">diff</a> |
<a href="/comm-central/comparison/7e399e08ea8d6a2449c4b17f9d67e04973d3ac91/mailnews/mailnews.js">comparison</a> |
<a href="/comm-central/log/7e399e08ea8d6a2449c4b17f9d67e04973d3ac91/mailnews/mailnews.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/base/prefs/content/accountcreation/emailWizard.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/base/prefs/content/accountcreation/emailWizard.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -485,20 +485,33 @@ EmailConfigWizard.prototype =</span>
<a href="#l1.4"></a><span id="l1.4">                 me.foundConfig(config);</span>
<a href="#l1.5"></a><span id="l1.5">                 me.stopSpinner(&quot;found_settings_db&quot;);</span>
<a href="#l1.6"></a><span id="l1.6">                 me.showEditButton();</span>
<a href="#l1.7"></a><span id="l1.7">                 me._probeAbortable = null;</span>
<a href="#l1.8"></a><span id="l1.8">               },</span>
<a href="#l1.9"></a><span id="l1.9">               function(e) // fetchConfigFromDB failed</span>
<a href="#l1.10"></a><span id="l1.10">               {</span>
<a href="#l1.11"></a><span id="l1.11">                 gEmailWizardLogger.info(&quot;fetchConfigFromDB failed: &quot; + e);</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-                var initialConfig = new AccountConfig();</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-                me._prefillConfig(initialConfig);</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineminus">-                me.startSpinner(&quot;all&quot;, &quot;looking_up_settings_guess&quot;)</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineminus">-                me._guessConfig(domain, initialConfig, &quot;both&quot;);</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineplus">+                me.startSpinner(&quot;all&quot;, &quot;looking_up_settings_db&quot;);</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineplus">+                me._probeAbortable = fetchConfigForMX(domain,</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineplus">+                  function(config) // success</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineplus">+                  {</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineplus">+                    me.foundConfig(config);</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineplus">+                    me.stopSpinner(&quot;found_settings_db&quot;);</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineplus">+                    me.showEditButton();</span>
<a href="#l1.23"></a><span id="l1.23" class="difflineplus">+                    me._probeAbortable = null;</span>
<a href="#l1.24"></a><span id="l1.24" class="difflineplus">+                  },</span>
<a href="#l1.25"></a><span id="l1.25" class="difflineplus">+                  function(e) // fetchConfigForMX failed</span>
<a href="#l1.26"></a><span id="l1.26" class="difflineplus">+                  {</span>
<a href="#l1.27"></a><span id="l1.27" class="difflineplus">+                    gEmailWizardLogger.info(&quot;fetchConfigForMX failed: &quot; + e);</span>
<a href="#l1.28"></a><span id="l1.28" class="difflineplus">+                    var initialConfig = new AccountConfig();</span>
<a href="#l1.29"></a><span id="l1.29" class="difflineplus">+                    me._prefillConfig(initialConfig);</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineplus">+                    me.startSpinner(&quot;all&quot;, &quot;looking_up_settings_guess&quot;)</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineplus">+                    me._guessConfig(domain, initialConfig, &quot;both&quot;);</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineplus">+                  });</span>
<a href="#l1.33"></a><span id="l1.33">               });</span>
<a href="#l1.34"></a><span id="l1.34">           });</span>
<a href="#l1.35"></a><span id="l1.35">       });</span>
<a href="#l1.36"></a><span id="l1.36">   },</span>
<a href="#l1.37"></a><span id="l1.37"> </span>
<a href="#l1.38"></a><span id="l1.38">   _guessConfig : function(domain, initialConfig, which)</span>
<a href="#l1.39"></a><span id="l1.39">   {</span>
<a href="#l1.40"></a><span id="l1.40">     let me = this;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/base/prefs/content/accountcreation/fetchConfig.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/base/prefs/content/accountcreation/fetchConfig.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -54,16 +54,21 @@ function fetchConfigFromDisk(domain, suc</span>
<a href="#l2.4"></a><span id="l2.4">       successCallback(readFromXML(new XML(contents)));</span>
<a href="#l2.5"></a><span id="l2.5">     } catch (e) { errorCallback(e); }</span>
<a href="#l2.6"></a><span id="l2.6">   }));</span>
<a href="#l2.7"></a><span id="l2.7"> }</span>
<a href="#l2.8"></a><span id="l2.8"> </span>
<a href="#l2.9"></a><span id="l2.9"> /**</span>
<a href="#l2.10"></a><span id="l2.10">  * Tries to get a configuration from the ISP / mail provider directly.</span>
<a href="#l2.11"></a><span id="l2.11">  *</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+ * Disclaimers:</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+ * - To support domain hosters, we cannot use SSL. That means we</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+ *   rely on insecure DNS and http, which means the results may be</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+ *   forged when under attack. The same is true for guessConfig(), though.</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineplus">+ *</span>
<a href="#l2.17"></a><span id="l2.17">  * @param domain {String}   The domain part of the user's email address</span>
<a href="#l2.18"></a><span id="l2.18">  * @param emailAddress {String}   The user's email address</span>
<a href="#l2.19"></a><span id="l2.19">  * @param successCallback {Function(config {AccountConfig}})}   A callback that</span>
<a href="#l2.20"></a><span id="l2.20">  *         will be called when we could retrieve a configuration.</span>
<a href="#l2.21"></a><span id="l2.21">  *         The AccountConfig object will be passed in as first parameter.</span>
<a href="#l2.22"></a><span id="l2.22">  * @param errorCallback {Function(ex)}   A callback that</span>
<a href="#l2.23"></a><span id="l2.23">  *         will be called when we could not retrieve a configuration,</span>
<a href="#l2.24"></a><span id="l2.24">  *         for whatever reason. This is expected (e.g. when there's no config</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineat">@@ -137,8 +142,109 @@ function fetchConfigFromDB(domain, succe</span>
<a href="#l2.26"></a><span id="l2.26">                             function(result)</span>
<a href="#l2.27"></a><span id="l2.27">                             {</span>
<a href="#l2.28"></a><span id="l2.28">                               successCallback(readFromXML(result));</span>
<a href="#l2.29"></a><span id="l2.29">                             },</span>
<a href="#l2.30"></a><span id="l2.30">                             errorCallback);</span>
<a href="#l2.31"></a><span id="l2.31">   fetch.start();</span>
<a href="#l2.32"></a><span id="l2.32">   return fetch;</span>
<a href="#l2.33"></a><span id="l2.33"> }</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineplus">+</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineplus">+/**</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineplus">+ * Does a lookup of DNS MX, to get the server who is responsible for</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineplus">+ * recieving mail for this domain. Then it takes the domain of that</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineplus">+ * server, and does another lookup (in ISPDB and possible at ISP autoconfig</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineplus">+ * server) and if such a config is found, returns that.</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineplus">+ *</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineplus">+ * Disclaimers:</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineplus">+ * - DNS is unprotected, meaning the results could be forged.</span>
<a href="#l2.43"></a><span id="l2.43" class="difflineplus">+ *   The same is true for fetchConfigFromISP() and guessConfig(), though.</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineplus">+ * - DNS MX tells us the incoming server, not the mailbox (IMAP) server.</span>
<a href="#l2.45"></a><span id="l2.45" class="difflineplus">+ *   They are different. This mechnism is only an approximation</span>
<a href="#l2.46"></a><span id="l2.46" class="difflineplus">+ *   for hosted domains (yourname.com is served by mx.hoster.com and</span>
<a href="#l2.47"></a><span id="l2.47" class="difflineplus">+ *   therefore imap.hoster.com - that &quot;therefore&quot; is exactly the</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineplus">+ *   conclusional jump we make here.) and alternative domains</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineplus">+ *   (e.g. yahoo.de -&gt; yahoo.com).</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineplus">+ * - We make a look up for the base domain. E.g. if MX is</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineplus">+ *   mx1.incoming.servers.hoster.com, we look up hoster.com.</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineplus">+ *   Thanks to nsIEffectiveTLDService, we also get bbc.co.uk right.</span>
<a href="#l2.53"></a><span id="l2.53" class="difflineplus">+ *</span>
<a href="#l2.54"></a><span id="l2.54" class="difflineplus">+ * Params @see fetchConfigFromISP()</span>
<a href="#l2.55"></a><span id="l2.55" class="difflineplus">+ */</span>
<a href="#l2.56"></a><span id="l2.56" class="difflineplus">+function fetchConfigForMX(domain, successCallback, errorCallback)</span>
<a href="#l2.57"></a><span id="l2.57" class="difflineplus">+{</span>
<a href="#l2.58"></a><span id="l2.58" class="difflineplus">+  var domain = sanitize.hostname(domain);</span>
<a href="#l2.59"></a><span id="l2.59" class="difflineplus">+</span>
<a href="#l2.60"></a><span id="l2.60" class="difflineplus">+  var sucAbortable = new SuccessiveAbortable();</span>
<a href="#l2.61"></a><span id="l2.61" class="difflineplus">+  var time = Date.now();</span>
<a href="#l2.62"></a><span id="l2.62" class="difflineplus">+  sucAbortable.current = getMX(domain,</span>
<a href="#l2.63"></a><span id="l2.63" class="difflineplus">+    function(mxHostname) // success</span>
<a href="#l2.64"></a><span id="l2.64" class="difflineplus">+    {</span>
<a href="#l2.65"></a><span id="l2.65" class="difflineplus">+      ddump(&quot;getmx took &quot; + (Date.now() - time) + &quot;ms&quot;);</span>
<a href="#l2.66"></a><span id="l2.66" class="difflineplus">+      var tldServ = Cc[&quot;@mozilla.org/network/effective-tld-service;1&quot;]</span>
<a href="#l2.67"></a><span id="l2.67" class="difflineplus">+                      .getService(Ci.nsIEffectiveTLDService);</span>
<a href="#l2.68"></a><span id="l2.68" class="difflineplus">+      var sld = tldServ.getBaseDomainFromHost(mxHostname);</span>
<a href="#l2.69"></a><span id="l2.69" class="difflineplus">+      ddump(&quot;base domain &quot; + sld + &quot; for &quot; + mxHostname);</span>
<a href="#l2.70"></a><span id="l2.70" class="difflineplus">+      if (sld == domain)</span>
<a href="#l2.71"></a><span id="l2.71" class="difflineplus">+      {</span>
<a href="#l2.72"></a><span id="l2.72" class="difflineplus">+        errorCallback(&quot;MX lookup would be no different from domain&quot;);</span>
<a href="#l2.73"></a><span id="l2.73" class="difflineplus">+        return;</span>
<a href="#l2.74"></a><span id="l2.74" class="difflineplus">+      }</span>
<a href="#l2.75"></a><span id="l2.75" class="difflineplus">+      sucAbortable.current = fetchConfigFromDB(sld, successCallback,</span>
<a href="#l2.76"></a><span id="l2.76" class="difflineplus">+                                               errorCallback);</span>
<a href="#l2.77"></a><span id="l2.77" class="difflineplus">+    },</span>
<a href="#l2.78"></a><span id="l2.78" class="difflineplus">+    errorCallback);</span>
<a href="#l2.79"></a><span id="l2.79" class="difflineplus">+  return sucAbortable;</span>
<a href="#l2.80"></a><span id="l2.80" class="difflineplus">+}</span>
<a href="#l2.81"></a><span id="l2.81" class="difflineplus">+</span>
<a href="#l2.82"></a><span id="l2.82" class="difflineplus">+/**</span>
<a href="#l2.83"></a><span id="l2.83" class="difflineplus">+ * Queries the DNS MX for the domain</span>
<a href="#l2.84"></a><span id="l2.84" class="difflineplus">+ *</span>
<a href="#l2.85"></a><span id="l2.85" class="difflineplus">+ * The current implementation goes to a web service to do the</span>
<a href="#l2.86"></a><span id="l2.86" class="difflineplus">+ * DNS resolve for us, because Mozilla unfortunately has no implementation</span>
<a href="#l2.87"></a><span id="l2.87" class="difflineplus">+ * to do it. That's just a workaround. Once bug 545866 is fixed, we make</span>
<a href="#l2.88"></a><span id="l2.88" class="difflineplus">+ * the DNS query directly on the client. The API of this function should not</span>
<a href="#l2.89"></a><span id="l2.89" class="difflineplus">+ * change then.</span>
<a href="#l2.90"></a><span id="l2.90" class="difflineplus">+ *</span>
<a href="#l2.91"></a><span id="l2.91" class="difflineplus">+ * Returns (in successCallback) the hostname of the MX server.</span>
<a href="#l2.92"></a><span id="l2.92" class="difflineplus">+ * If there are several entires with different preference values,</span>
<a href="#l2.93"></a><span id="l2.93" class="difflineplus">+ * only the most preferred (i.e. those with the lowest value)</span>
<a href="#l2.94"></a><span id="l2.94" class="difflineplus">+ * is returned. If there are several most preferred servers (i.e.</span>
<a href="#l2.95"></a><span id="l2.95" class="difflineplus">+ * round robin), only one of them is returned.</span>
<a href="#l2.96"></a><span id="l2.96" class="difflineplus">+ *</span>
<a href="#l2.97"></a><span id="l2.97" class="difflineplus">+ * @param domain @see fetchConfigFromISP()</span>
<a href="#l2.98"></a><span id="l2.98" class="difflineplus">+ * @param successCallback {function(hostname {String})</span>
<a href="#l2.99"></a><span id="l2.99" class="difflineplus">+ *   Called when we found an MX for the domain.</span>
<a href="#l2.100"></a><span id="l2.100" class="difflineplus">+ *   For |hostname|, see description above.</span>
<a href="#l2.101"></a><span id="l2.101" class="difflineplus">+ * @param errorCallback @see fetchConfigFromISP()</span>
<a href="#l2.102"></a><span id="l2.102" class="difflineplus">+ * @returns @see fetchConfigFromISP()</span>
<a href="#l2.103"></a><span id="l2.103" class="difflineplus">+ */</span>
<a href="#l2.104"></a><span id="l2.104" class="difflineplus">+function getMX(domain, successCallback, errorCallback)</span>
<a href="#l2.105"></a><span id="l2.105" class="difflineplus">+{</span>
<a href="#l2.106"></a><span id="l2.106" class="difflineplus">+  let domain = sanitize.hostname(domain);</span>
<a href="#l2.107"></a><span id="l2.107" class="difflineplus">+</span>
<a href="#l2.108"></a><span id="l2.108" class="difflineplus">+  let pref = Cc[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l2.109"></a><span id="l2.109" class="difflineplus">+               .getService(Ci.nsIPrefBranch);</span>
<a href="#l2.110"></a><span id="l2.110" class="difflineplus">+  let url = pref.getCharPref(&quot;mailnews.mx_service_url&quot;);</span>
<a href="#l2.111"></a><span id="l2.111" class="difflineplus">+  if (!url)</span>
<a href="#l2.112"></a><span id="l2.112" class="difflineplus">+    errorCallback(&quot;no URL for MX service configured&quot;);</span>
<a href="#l2.113"></a><span id="l2.113" class="difflineplus">+  url += domain;</span>
<a href="#l2.114"></a><span id="l2.114" class="difflineplus">+</span>
<a href="#l2.115"></a><span id="l2.115" class="difflineplus">+  let fetch = new FetchHTTP(url, null, false,</span>
<a href="#l2.116"></a><span id="l2.116" class="difflineplus">+    function(result)</span>
<a href="#l2.117"></a><span id="l2.117" class="difflineplus">+    {</span>
<a href="#l2.118"></a><span id="l2.118" class="difflineplus">+      // result is plain text, with one line per server.</span>
<a href="#l2.119"></a><span id="l2.119" class="difflineplus">+      // So just take the first line</span>
<a href="#l2.120"></a><span id="l2.120" class="difflineplus">+      ddump(&quot;MX query result: \n&quot; + result + &quot;(end)&quot;);</span>
<a href="#l2.121"></a><span id="l2.121" class="difflineplus">+      assert(typeof(result) == &quot;string&quot;);</span>
<a href="#l2.122"></a><span id="l2.122" class="difflineplus">+      let first = result.split(&quot;\n&quot;)[0];</span>
<a href="#l2.123"></a><span id="l2.123" class="difflineplus">+      first.toLowerCase().replace(/[^a-z0-9\-_\.]*/g, &quot;&quot;);</span>
<a href="#l2.124"></a><span id="l2.124" class="difflineplus">+      if (first.length == 0)</span>
<a href="#l2.125"></a><span id="l2.125" class="difflineplus">+      {</span>
<a href="#l2.126"></a><span id="l2.126" class="difflineplus">+        errorCallback(&quot;no MX found&quot;);</span>
<a href="#l2.127"></a><span id="l2.127" class="difflineplus">+        return;</span>
<a href="#l2.128"></a><span id="l2.128" class="difflineplus">+      }</span>
<a href="#l2.129"></a><span id="l2.129" class="difflineplus">+      successCallback(first);</span>
<a href="#l2.130"></a><span id="l2.130" class="difflineplus">+    },</span>
<a href="#l2.131"></a><span id="l2.131" class="difflineplus">+    errorCallback);</span>
<a href="#l2.132"></a><span id="l2.132" class="difflineplus">+  fetch.start();</span>
<a href="#l2.133"></a><span id="l2.133" class="difflineplus">+  return fetch;</span>
<a href="#l2.134"></a><span id="l2.134" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/mailnews.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/mailnews.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -843,16 +843,18 @@ pref(&quot;mail.compose.max_recycled_windows&quot;</span>
<a href="#l3.4"></a><span id="l3.4"> #endif</span>
<a href="#l3.5"></a><span id="l3.5"> </span>
<a href="#l3.6"></a><span id="l3.6"> // For the Empty Junk/Trash confirmation dialogs.</span>
<a href="#l3.7"></a><span id="l3.7"> pref(&quot;mailnews.emptyJunk.dontAskAgain&quot;, false);</span>
<a href="#l3.8"></a><span id="l3.8"> pref(&quot;mailnews.emptyTrash.dontAskAgain&quot;, false);</span>
<a href="#l3.9"></a><span id="l3.9"> </span>
<a href="#l3.10"></a><span id="l3.10"> // where to fetch auto config information from.</span>
<a href="#l3.11"></a><span id="l3.11"> pref(&quot;mailnews.auto_config_url&quot;, &quot;https://live.mozillamessaging.com/autoconfig/v1.1/&quot;);</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+// Added in bug 551519. Remove when bug 545866 is fixed.</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+pref(&quot;mailnews.mx_service_url&quot;, &quot;https://live.mozillamessaging.com/dns/mx/&quot;);</span>
<a href="#l3.14"></a><span id="l3.14"> </span>
<a href="#l3.15"></a><span id="l3.15"> // -- Summary Database options</span>
<a href="#l3.16"></a><span id="l3.16"> // dontPreserveOnCopy: a space separated list of properties that are not</span>
<a href="#l3.17"></a><span id="l3.17"> //                     copied to the new nsIMsgHdr when a message is copied.</span>
<a href="#l3.18"></a><span id="l3.18"> //                     Allows extensions to control preservation of properties.</span>
<a href="#l3.19"></a><span id="l3.19"> pref(&quot;mailnews.database.summary.dontPreserveOnCopy&quot;,</span>
<a href="#l3.20"></a><span id="l3.20">   &quot;account msgOffset threadParent msgThreadId statusOfset flags size numLines ProtoThreadFlags label gloda-id gloda-dirty&quot;);</span>
<a href="#l3.21"></a><span id="l3.21"> </span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

