<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 22187:e08911b56e26b2d7dbfd4d0cd4b1380555e70625</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ e08911b56e26b2d7dbfd4d0cd4b1380555e70625" />
<meta property="og:url" content="/comm-central/rev/e08911b56e26b2d7dbfd4d0cd4b1380555e70625" />
<meta property="og:description" content="Bug 1399756 - remove trailing spaces in mailnews/compose. rs=white-space-only" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / e08911b56e26b2d7dbfd4d0cd4b1380555e70625 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/e08911b56e26b2d7dbfd4d0cd4b1380555e70625">shortlog</a> |
<a href="/comm-central/log/e08911b56e26b2d7dbfd4d0cd4b1380555e70625">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/e08911b56e26b2d7dbfd4d0cd4b1380555e70625">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/e08911b56e26b2d7dbfd4d0cd4b1380555e70625">files</a> |
changeset |
<a href="/comm-central/raw-rev/e08911b56e26b2d7dbfd4d0cd4b1380555e70625">raw</a>  | <a href="/comm-central/archive/e08911b56e26b2d7dbfd4d0cd4b1380555e70625.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1399756">Bug 1399756</a> - remove trailing spaces in mailnews/compose. rs=white-space-only
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#74;&#111;&#114;&#103;&#32;&#75;&#32;&#60;&#106;&#111;&#114;&#103;&#107;&#64;&#106;&#111;&#114;&#103;&#107;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Fri, 22 Sep 2017 00:02:26 +0200</td></tr>

<tr>
 <td>changeset 22187</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/e08911b56e26b2d7dbfd4d0cd4b1380555e70625">e08911b56e26b2d7dbfd4d0cd4b1380555e70625</a></td>
</tr>



<tr>
<td>parent 22186</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/153b971fbc2120fe61da0fe75181a69ba51dabc7">153b971fbc2120fe61da0fe75181a69ba51dabc7</a>
</td>
</tr>

<tr>
<td>child 22188</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/cc49055e5926dbdc2c04ed42decccfcf0db0f716">cc49055e5926dbdc2c04ed42decccfcf0db0f716</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=e08911b56e26b2d7dbfd4d0cd4b1380555e70625">13541</a></td></tr>
<tr><td>push user</td><td>mozilla@jorgk.com</td></tr>
<tr><td>push date</td><td class="date age">Thu, 21 Sep 2017 23:36:07 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@e08911b56e26 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=e08911b56e26b2d7dbfd4d0cd4b1380555e70625">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=e08911b56e26b2d7dbfd4d0cd4b1380555e70625&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=e08911b56e26b2d7dbfd4d0cd4b1380555e70625&newProject=comm-central&newRevision=e08911b56e26b2d7dbfd4d0cd4b1380555e70625&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=e08911b56e26b2d7dbfd4d0cd4b1380555e70625&newProject=comm-central&newRevision=e08911b56e26b2d7dbfd4d0cd4b1380555e70625&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=e08911b56e26b2d7dbfd4d0cd4b1380555e70625&newProject=comm-central&newRevision=e08911b56e26b2d7dbfd4d0cd4b1380555e70625&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28white-space-only%29&revcount=50">white-space-only</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1399756">1399756</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1399756">Bug 1399756</a> - remove trailing spaces in mailnews/compose. rs=white-space-only</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/public/nsMsgAttachmentData.h">mailnews/compose/public/nsMsgAttachmentData.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/public/nsMsgAttachmentData.h">file</a> |
<a href="/comm-central/annotate/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/public/nsMsgAttachmentData.h">annotate</a> |
<a href="/comm-central/diff/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/public/nsMsgAttachmentData.h">diff</a> |
<a href="/comm-central/comparison/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/public/nsMsgAttachmentData.h">comparison</a> |
<a href="/comm-central/log/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/public/nsMsgAttachmentData.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsComposeStrings.h">mailnews/compose/src/nsComposeStrings.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsComposeStrings.h">file</a> |
<a href="/comm-central/annotate/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsComposeStrings.h">annotate</a> |
<a href="/comm-central/diff/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsComposeStrings.h">diff</a> |
<a href="/comm-central/comparison/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsComposeStrings.h">comparison</a> |
<a href="/comm-central/log/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsComposeStrings.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgAppleCodes.h">mailnews/compose/src/nsMsgAppleCodes.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgAppleCodes.h">file</a> |
<a href="/comm-central/annotate/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgAppleCodes.h">annotate</a> |
<a href="/comm-central/diff/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgAppleCodes.h">diff</a> |
<a href="/comm-central/comparison/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgAppleCodes.h">comparison</a> |
<a href="/comm-central/log/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgAppleCodes.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgAppleDouble.h">mailnews/compose/src/nsMsgAppleDouble.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgAppleDouble.h">file</a> |
<a href="/comm-central/annotate/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgAppleDouble.h">annotate</a> |
<a href="/comm-central/diff/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgAppleDouble.h">diff</a> |
<a href="/comm-central/comparison/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgAppleDouble.h">comparison</a> |
<a href="/comm-central/log/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgAppleDouble.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgAppleDoubleEncode.cpp">mailnews/compose/src/nsMsgAppleDoubleEncode.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgAppleDoubleEncode.cpp">file</a> |
<a href="/comm-central/annotate/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgAppleDoubleEncode.cpp">annotate</a> |
<a href="/comm-central/diff/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgAppleDoubleEncode.cpp">diff</a> |
<a href="/comm-central/comparison/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgAppleDoubleEncode.cpp">comparison</a> |
<a href="/comm-central/log/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgAppleDoubleEncode.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgAppleEncode.cpp">mailnews/compose/src/nsMsgAppleEncode.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgAppleEncode.cpp">file</a> |
<a href="/comm-central/annotate/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgAppleEncode.cpp">annotate</a> |
<a href="/comm-central/diff/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgAppleEncode.cpp">diff</a> |
<a href="/comm-central/comparison/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgAppleEncode.cpp">comparison</a> |
<a href="/comm-central/log/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgAppleEncode.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgAttachment.cpp">mailnews/compose/src/nsMsgAttachment.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgAttachment.cpp">file</a> |
<a href="/comm-central/annotate/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgAttachment.cpp">annotate</a> |
<a href="/comm-central/diff/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgAttachment.cpp">diff</a> |
<a href="/comm-central/comparison/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgAttachment.cpp">comparison</a> |
<a href="/comm-central/log/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgAttachment.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgAttachmentHandler.cpp">mailnews/compose/src/nsMsgAttachmentHandler.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgAttachmentHandler.cpp">file</a> |
<a href="/comm-central/annotate/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgAttachmentHandler.cpp">annotate</a> |
<a href="/comm-central/diff/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgAttachmentHandler.cpp">diff</a> |
<a href="/comm-central/comparison/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgAttachmentHandler.cpp">comparison</a> |
<a href="/comm-central/log/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgAttachmentHandler.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgAttachmentHandler.h">mailnews/compose/src/nsMsgAttachmentHandler.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgAttachmentHandler.h">file</a> |
<a href="/comm-central/annotate/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgAttachmentHandler.h">annotate</a> |
<a href="/comm-central/diff/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgAttachmentHandler.h">diff</a> |
<a href="/comm-central/comparison/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgAttachmentHandler.h">comparison</a> |
<a href="/comm-central/log/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgAttachmentHandler.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgCompFields.cpp">mailnews/compose/src/nsMsgCompFields.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgCompFields.cpp">file</a> |
<a href="/comm-central/annotate/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgCompFields.cpp">annotate</a> |
<a href="/comm-central/diff/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgCompFields.cpp">diff</a> |
<a href="/comm-central/comparison/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgCompFields.cpp">comparison</a> |
<a href="/comm-central/log/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgCompFields.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgCompUtils.h">mailnews/compose/src/nsMsgCompUtils.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgCompUtils.h">file</a> |
<a href="/comm-central/annotate/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgCompUtils.h">annotate</a> |
<a href="/comm-central/diff/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgCompUtils.h">diff</a> |
<a href="/comm-central/comparison/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgCompUtils.h">comparison</a> |
<a href="/comm-central/log/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgCompUtils.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgCompose.h">mailnews/compose/src/nsMsgCompose.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgCompose.h">file</a> |
<a href="/comm-central/annotate/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgCompose.h">annotate</a> |
<a href="/comm-central/diff/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgCompose.h">diff</a> |
<a href="/comm-central/comparison/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgCompose.h">comparison</a> |
<a href="/comm-central/log/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgCompose.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgComposeContentHandler.cpp">mailnews/compose/src/nsMsgComposeContentHandler.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgComposeContentHandler.cpp">file</a> |
<a href="/comm-central/annotate/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgComposeContentHandler.cpp">annotate</a> |
<a href="/comm-central/diff/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgComposeContentHandler.cpp">diff</a> |
<a href="/comm-central/comparison/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgComposeContentHandler.cpp">comparison</a> |
<a href="/comm-central/log/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgComposeContentHandler.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgComposeContentHandler.h">mailnews/compose/src/nsMsgComposeContentHandler.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgComposeContentHandler.h">file</a> |
<a href="/comm-central/annotate/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgComposeContentHandler.h">annotate</a> |
<a href="/comm-central/diff/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgComposeContentHandler.h">diff</a> |
<a href="/comm-central/comparison/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgComposeContentHandler.h">comparison</a> |
<a href="/comm-central/log/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgComposeContentHandler.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgComposeParams.cpp">mailnews/compose/src/nsMsgComposeParams.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgComposeParams.cpp">file</a> |
<a href="/comm-central/annotate/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgComposeParams.cpp">annotate</a> |
<a href="/comm-central/diff/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgComposeParams.cpp">diff</a> |
<a href="/comm-central/comparison/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgComposeParams.cpp">comparison</a> |
<a href="/comm-central/log/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgComposeParams.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgComposeParams.h">mailnews/compose/src/nsMsgComposeParams.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgComposeParams.h">file</a> |
<a href="/comm-central/annotate/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgComposeParams.h">annotate</a> |
<a href="/comm-central/diff/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgComposeParams.h">diff</a> |
<a href="/comm-central/comparison/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgComposeParams.h">comparison</a> |
<a href="/comm-central/log/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgComposeParams.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgComposeProgressParams.cpp">mailnews/compose/src/nsMsgComposeProgressParams.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgComposeProgressParams.cpp">file</a> |
<a href="/comm-central/annotate/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgComposeProgressParams.cpp">annotate</a> |
<a href="/comm-central/diff/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgComposeProgressParams.cpp">diff</a> |
<a href="/comm-central/comparison/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgComposeProgressParams.cpp">comparison</a> |
<a href="/comm-central/log/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgComposeProgressParams.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgComposeProgressParams.h">mailnews/compose/src/nsMsgComposeProgressParams.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgComposeProgressParams.h">file</a> |
<a href="/comm-central/annotate/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgComposeProgressParams.h">annotate</a> |
<a href="/comm-central/diff/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgComposeProgressParams.h">diff</a> |
<a href="/comm-central/comparison/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgComposeProgressParams.h">comparison</a> |
<a href="/comm-central/log/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgComposeProgressParams.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgComposeService.h">mailnews/compose/src/nsMsgComposeService.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgComposeService.h">file</a> |
<a href="/comm-central/annotate/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgComposeService.h">annotate</a> |
<a href="/comm-central/diff/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgComposeService.h">diff</a> |
<a href="/comm-central/comparison/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgComposeService.h">comparison</a> |
<a href="/comm-central/log/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgComposeService.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgCopy.h">mailnews/compose/src/nsMsgCopy.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgCopy.h">file</a> |
<a href="/comm-central/annotate/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgCopy.h">annotate</a> |
<a href="/comm-central/diff/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgCopy.h">diff</a> |
<a href="/comm-central/comparison/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgCopy.h">comparison</a> |
<a href="/comm-central/log/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgCopy.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgQuote.cpp">mailnews/compose/src/nsMsgQuote.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgQuote.cpp">file</a> |
<a href="/comm-central/annotate/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgQuote.cpp">annotate</a> |
<a href="/comm-central/diff/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgQuote.cpp">diff</a> |
<a href="/comm-central/comparison/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgQuote.cpp">comparison</a> |
<a href="/comm-central/log/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgQuote.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgQuote.h">mailnews/compose/src/nsMsgQuote.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgQuote.h">file</a> |
<a href="/comm-central/annotate/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgQuote.h">annotate</a> |
<a href="/comm-central/diff/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgQuote.h">diff</a> |
<a href="/comm-central/comparison/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgQuote.h">comparison</a> |
<a href="/comm-central/log/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgQuote.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgSendLater.cpp">mailnews/compose/src/nsMsgSendLater.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgSendLater.cpp">file</a> |
<a href="/comm-central/annotate/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgSendLater.cpp">annotate</a> |
<a href="/comm-central/diff/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgSendLater.cpp">diff</a> |
<a href="/comm-central/comparison/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgSendLater.cpp">comparison</a> |
<a href="/comm-central/log/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgSendLater.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgSendLater.h">mailnews/compose/src/nsMsgSendLater.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgSendLater.h">file</a> |
<a href="/comm-central/annotate/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgSendLater.h">annotate</a> |
<a href="/comm-central/diff/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgSendLater.h">diff</a> |
<a href="/comm-central/comparison/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgSendLater.h">comparison</a> |
<a href="/comm-central/log/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgSendLater.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgSendPart.cpp">mailnews/compose/src/nsMsgSendPart.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgSendPart.cpp">file</a> |
<a href="/comm-central/annotate/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgSendPart.cpp">annotate</a> |
<a href="/comm-central/diff/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgSendPart.cpp">diff</a> |
<a href="/comm-central/comparison/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgSendPart.cpp">comparison</a> |
<a href="/comm-central/log/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgSendPart.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgSendPart.h">mailnews/compose/src/nsMsgSendPart.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgSendPart.h">file</a> |
<a href="/comm-central/annotate/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgSendPart.h">annotate</a> |
<a href="/comm-central/diff/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgSendPart.h">diff</a> |
<a href="/comm-central/comparison/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgSendPart.h">comparison</a> |
<a href="/comm-central/log/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgSendPart.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgSendReport.cpp">mailnews/compose/src/nsMsgSendReport.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgSendReport.cpp">file</a> |
<a href="/comm-central/annotate/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgSendReport.cpp">annotate</a> |
<a href="/comm-central/diff/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgSendReport.cpp">diff</a> |
<a href="/comm-central/comparison/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgSendReport.cpp">comparison</a> |
<a href="/comm-central/log/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsMsgSendReport.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsSmtpProtocol.h">mailnews/compose/src/nsSmtpProtocol.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsSmtpProtocol.h">file</a> |
<a href="/comm-central/annotate/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsSmtpProtocol.h">annotate</a> |
<a href="/comm-central/diff/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsSmtpProtocol.h">diff</a> |
<a href="/comm-central/comparison/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsSmtpProtocol.h">comparison</a> |
<a href="/comm-central/log/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsSmtpProtocol.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsSmtpServer.h">mailnews/compose/src/nsSmtpServer.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsSmtpServer.h">file</a> |
<a href="/comm-central/annotate/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsSmtpServer.h">annotate</a> |
<a href="/comm-central/diff/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsSmtpServer.h">diff</a> |
<a href="/comm-central/comparison/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsSmtpServer.h">comparison</a> |
<a href="/comm-central/log/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsSmtpServer.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsSmtpService.cpp">mailnews/compose/src/nsSmtpService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsSmtpService.cpp">file</a> |
<a href="/comm-central/annotate/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsSmtpService.cpp">annotate</a> |
<a href="/comm-central/diff/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsSmtpService.cpp">diff</a> |
<a href="/comm-central/comparison/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsSmtpService.cpp">comparison</a> |
<a href="/comm-central/log/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsSmtpService.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsSmtpService.h">mailnews/compose/src/nsSmtpService.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsSmtpService.h">file</a> |
<a href="/comm-central/annotate/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsSmtpService.h">annotate</a> |
<a href="/comm-central/diff/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsSmtpService.h">diff</a> |
<a href="/comm-central/comparison/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsSmtpService.h">comparison</a> |
<a href="/comm-central/log/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsSmtpService.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsSmtpUrl.h">mailnews/compose/src/nsSmtpUrl.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsSmtpUrl.h">file</a> |
<a href="/comm-central/annotate/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsSmtpUrl.h">annotate</a> |
<a href="/comm-central/diff/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsSmtpUrl.h">diff</a> |
<a href="/comm-central/comparison/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsSmtpUrl.h">comparison</a> |
<a href="/comm-central/log/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsSmtpUrl.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsURLFetcher.cpp">mailnews/compose/src/nsURLFetcher.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsURLFetcher.cpp">file</a> |
<a href="/comm-central/annotate/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsURLFetcher.cpp">annotate</a> |
<a href="/comm-central/diff/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsURLFetcher.cpp">diff</a> |
<a href="/comm-central/comparison/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsURLFetcher.cpp">comparison</a> |
<a href="/comm-central/log/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsURLFetcher.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsURLFetcher.h">mailnews/compose/src/nsURLFetcher.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsURLFetcher.h">file</a> |
<a href="/comm-central/annotate/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsURLFetcher.h">annotate</a> |
<a href="/comm-central/diff/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsURLFetcher.h">diff</a> |
<a href="/comm-central/comparison/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsURLFetcher.h">comparison</a> |
<a href="/comm-central/log/e08911b56e26b2d7dbfd4d0cd4b1380555e70625/mailnews/compose/src/nsURLFetcher.h">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/compose/public/nsMsgAttachmentData.h</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/compose/public/nsMsgAttachmentData.h</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -22,29 +22,29 @@ public:</span>
<a href="#l1.4"></a><span id="l1.4"> </span>
<a href="#l1.5"></a><span id="l1.5">   nsCOMPtr&lt;nsIURI&gt; m_url;   // The URL to attach.</span>
<a href="#l1.6"></a><span id="l1.6"> </span>
<a href="#l1.7"></a><span id="l1.7">   nsCString m_desiredType;  // The type to which this document should be</span>
<a href="#l1.8"></a><span id="l1.8">                             // converted.  Legal values are NULL, TEXT_PLAIN</span>
<a href="#l1.9"></a><span id="l1.9">                             // and APPLICATION_POSTSCRIPT (which are macros</span>
<a href="#l1.10"></a><span id="l1.10">                             // defined in net.h); other values are ignored.</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-  nsCString m_realType;     // The type of the URL if known, otherwise NULL. For example, if </span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-                            // you were attaching a temp file which was known to contain HTML data, </span>
<a href="#l1.14"></a><span id="l1.14" class="difflineminus">-                            // you would pass in TEXT_HTML as the real_type, to override whatever type </span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+  nsCString m_realType;     // The type of the URL if known, otherwise NULL. For example, if</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineplus">+                            // you were attaching a temp file which was known to contain HTML data,</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineplus">+                            // you would pass in TEXT_HTML as the real_type, to override whatever type</span>
<a href="#l1.18"></a><span id="l1.18">                             // the name of the tmp file might otherwise indicate.</span>
<a href="#l1.19"></a><span id="l1.19"> </span>
<a href="#l1.20"></a><span id="l1.20">   nsCString m_realEncoding; // Goes along with real_type</span>
<a href="#l1.21"></a><span id="l1.21"> </span>
<a href="#l1.22"></a><span id="l1.22" class="difflineminus">-  nsCString m_realName;     // The original name of this document, which will eventually show up in the </span>
<a href="#l1.23"></a><span id="l1.23" class="difflineminus">-                            // Content-Disposition header. For example, if you had copied a document to a </span>
<a href="#l1.24"></a><span id="l1.24" class="difflineplus">+  nsCString m_realName;     // The original name of this document, which will eventually show up in the</span>
<a href="#l1.25"></a><span id="l1.25" class="difflineplus">+                            // Content-Disposition header. For example, if you had copied a document to a</span>
<a href="#l1.26"></a><span id="l1.26">                             // tmp file, this would be the original, human-readable name of the document.</span>
<a href="#l1.27"></a><span id="l1.27"> </span>
<a href="#l1.28"></a><span id="l1.28" class="difflineminus">-  nsCString m_description;  // If you put a string here, it will show up as the Content-Description header.  </span>
<a href="#l1.29"></a><span id="l1.29" class="difflineminus">-                            // This can be any explanatory text; it's not a file name.             </span>
<a href="#l1.30"></a><span id="l1.30" class="difflineplus">+  nsCString m_description;  // If you put a string here, it will show up as the Content-Description header.</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineplus">+                            // This can be any explanatory text; it's not a file name.</span>
<a href="#l1.32"></a><span id="l1.32"> </span>
<a href="#l1.33"></a><span id="l1.33">   nsCString m_disposition;  // The Content-Disposition header (if any). a</span>
<a href="#l1.34"></a><span id="l1.34">                             // nsMsgAttachmentData can very well have</span>
<a href="#l1.35"></a><span id="l1.35">                             // Content-Disposition: inline value, instead of</span>
<a href="#l1.36"></a><span id="l1.36">                             // &quot;attachment&quot;.</span>
<a href="#l1.37"></a><span id="l1.37">   nsCString m_cloudPartInfo; // For X-Mozilla-Cloud-Part header, if any</span>
<a href="#l1.38"></a><span id="l1.38"> </span>
<a href="#l1.39"></a><span id="l1.39">   // Mac-specific data that should show up as optional parameters</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineat">@@ -71,26 +71,26 @@ public:</span>
<a href="#l1.41"></a><span id="l1.41">   virtual ~nsMsgAttachedFile();</span>
<a href="#l1.42"></a><span id="l1.42"> </span>
<a href="#l1.43"></a><span id="l1.43">   nsCOMPtr&lt;nsIURI&gt; m_origUrl; // Where it came from on the network (or even elsewhere on the local disk.)</span>
<a href="#l1.44"></a><span id="l1.44"> </span>
<a href="#l1.45"></a><span id="l1.45">   nsCOMPtr&lt;nsIFile&gt;  m_tmpFile;    // The tmp file in which the (possibly converted) data now resides.</span>
<a href="#l1.46"></a><span id="l1.46"> </span>
<a href="#l1.47"></a><span id="l1.47">   nsCString m_type;        // The type of the data in file_name (not necessarily the same as the type of orig_url.)</span>
<a href="#l1.48"></a><span id="l1.48"> </span>
<a href="#l1.49"></a><span id="l1.49" class="difflineminus">-  nsCString m_encoding;    // Likewise, the encoding of the tmp file. This will be set only if the original </span>
<a href="#l1.50"></a><span id="l1.50" class="difflineminus">-                            // document had an encoding already; we don't do base64 encoding and so forth until </span>
<a href="#l1.51"></a><span id="l1.51" class="difflineplus">+  nsCString m_encoding;    // Likewise, the encoding of the tmp file. This will be set only if the original</span>
<a href="#l1.52"></a><span id="l1.52" class="difflineplus">+                            // document had an encoding already; we don't do base64 encoding and so forth until</span>
<a href="#l1.53"></a><span id="l1.53">                             // it's time to assemble a full MIME message of all parts.</span>
<a href="#l1.54"></a><span id="l1.54"> </span>
<a href="#l1.55"></a><span id="l1.55"> </span>
<a href="#l1.56"></a><span id="l1.56">   nsCString m_description;    // For Content-Description header</span>
<a href="#l1.57"></a><span id="l1.57">   nsCString m_cloudPartInfo; // For X-Mozilla-Cloud-Part header, if any</span>
<a href="#l1.58"></a><span id="l1.58" class="difflineminus">-  nsCString m_xMacType;    // mac-specific info </span>
<a href="#l1.59"></a><span id="l1.59" class="difflineminus">-  nsCString m_xMacCreator; // mac-specific info </span>
<a href="#l1.60"></a><span id="l1.60" class="difflineminus">-  nsCString m_realName;      // The real name of the file. </span>
<a href="#l1.61"></a><span id="l1.61" class="difflineplus">+  nsCString m_xMacType;    // mac-specific info</span>
<a href="#l1.62"></a><span id="l1.62" class="difflineplus">+  nsCString m_xMacCreator; // mac-specific info</span>
<a href="#l1.63"></a><span id="l1.63" class="difflineplus">+  nsCString m_realName;      // The real name of the file.</span>
<a href="#l1.64"></a><span id="l1.64"> </span>
<a href="#l1.65"></a><span id="l1.65">   // Some statistics about the data that was written to the file, so that when</span>
<a href="#l1.66"></a><span id="l1.66">   // it comes time to compose a MIME message, we can make an informed decision</span>
<a href="#l1.67"></a><span id="l1.67">   // about what Content-Transfer-Encoding would be best for this attachment.</span>
<a href="#l1.68"></a><span id="l1.68">   // (If it's encoded already, we ignore this information and ship it as-is.)</span>
<a href="#l1.69"></a><span id="l1.69">   uint32_t    m_size;</span>
<a href="#l1.70"></a><span id="l1.70">   uint32_t    m_unprintableCount;</span>
<a href="#l1.71"></a><span id="l1.71">   uint32_t    m_highbitCount;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/compose/src/nsComposeStrings.h</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/compose/src/nsComposeStrings.h</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -1,17 +1,17 @@</span>
<a href="#l2.4"></a><span id="l2.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l2.5"></a><span id="l2.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l2.6"></a><span id="l2.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l2.7"></a><span id="l2.7"> </span>
<a href="#l2.8"></a><span id="l2.8"> /**</span>
<a href="#l2.9"></a><span id="l2.9">   String Ids used by mailnews\compose</span>
<a href="#l2.10"></a><span id="l2.10">   To Do: Convert the callers to use names instead of ids and then make this file obsolete.</span>
<a href="#l2.11"></a><span id="l2.11">  */</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">- </span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+</span>
<a href="#l2.14"></a><span id="l2.14"> #ifndef _nsComposeStrings_H__</span>
<a href="#l2.15"></a><span id="l2.15"> #define _nsComposeStrings_H__</span>
<a href="#l2.16"></a><span id="l2.16"> </span>
<a href="#l2.17"></a><span id="l2.17"> #include &quot;msgCore.h&quot;</span>
<a href="#l2.18"></a><span id="l2.18"> </span>
<a href="#l2.19"></a><span id="l2.19"> #define NS_MSG_UNABLE_TO_OPEN_FILE                  NS_MSG_GENERATE_FAILURE(12500)</span>
<a href="#l2.20"></a><span id="l2.20"> #define NS_MSG_UNABLE_TO_OPEN_TMP_FILE              NS_MSG_GENERATE_FAILURE(12501)</span>
<a href="#l2.21"></a><span id="l2.21"> #define NS_MSG_UNABLE_TO_SAVE_TEMPLATE              NS_MSG_GENERATE_FAILURE(12502)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgAppleCodes.h</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgAppleCodes.h</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -13,17 +13,17 @@</span>
<a href="#l3.4"></a><span id="l3.4"> **</span>
<a href="#l3.5"></a><span id="l3.5"> **</span>
<a href="#l3.6"></a><span id="l3.6"> */</span>
<a href="#l3.7"></a><span id="l3.7"> </span>
<a href="#l3.8"></a><span id="l3.8"> #ifndef ad_codes_h</span>
<a href="#l3.9"></a><span id="l3.9"> #define ad_codes_h</span>
<a href="#l3.10"></a><span id="l3.10"> </span>
<a href="#l3.11"></a><span id="l3.11"> /*</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-** applefile definitions used </span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+** applefile definitions used</span>
<a href="#l3.14"></a><span id="l3.14"> */</span>
<a href="#l3.15"></a><span id="l3.15"> #if PRAGMA_STRUCT_ALIGN</span>
<a href="#l3.16"></a><span id="l3.16">   #pragma options align=mac68k</span>
<a href="#l3.17"></a><span id="l3.17"> #endif</span>
<a href="#l3.18"></a><span id="l3.18"> </span>
<a href="#l3.19"></a><span id="l3.19"> #define APPLESINGLE_MAGIC	0x00051600L</span>
<a href="#l3.20"></a><span id="l3.20"> #define APPLEDOUBLE_MAGIC 	0x00051607L</span>
<a href="#l3.21"></a><span id="l3.21"> #define VERSION 			0x00020000</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineat">@@ -36,34 +36,34 @@</span>
<a href="#l3.23"></a><span id="l3.23"> #define ENT_COMMENT 		4L</span>
<a href="#l3.24"></a><span id="l3.24"> #define ENT_DATES   		8L</span>
<a href="#l3.25"></a><span id="l3.25"> #define ENT_FINFO   		9L</span>
<a href="#l3.26"></a><span id="l3.26"> #define CONVERT_TIME 		1265437696L</span>
<a href="#l3.27"></a><span id="l3.27"> </span>
<a href="#l3.28"></a><span id="l3.28"> /*</span>
<a href="#l3.29"></a><span id="l3.29"> ** data type used in the encoder/decoder.</span>
<a href="#l3.30"></a><span id="l3.30"> */</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineminus">-typedef struct ap_header </span>
<a href="#l3.32"></a><span id="l3.32" class="difflineplus">+typedef struct ap_header</span>
<a href="#l3.33"></a><span id="l3.33"> {</span>
<a href="#l3.34"></a><span id="l3.34"> 	int32_t 	magic;</span>
<a href="#l3.35"></a><span id="l3.35"> 	int32_t	version;</span>
<a href="#l3.36"></a><span id="l3.36"> 	char 	fill[16];</span>
<a href="#l3.37"></a><span id="l3.37"> 	int16_t 	entries;</span>
<a href="#l3.38"></a><span id="l3.38"> </span>
<a href="#l3.39"></a><span id="l3.39"> } ap_header;</span>
<a href="#l3.40"></a><span id="l3.40"> </span>
<a href="#l3.41"></a><span id="l3.41" class="difflineminus">-typedef struct ap_entry </span>
<a href="#l3.42"></a><span id="l3.42" class="difflineplus">+typedef struct ap_entry</span>
<a href="#l3.43"></a><span id="l3.43"> {</span>
<a href="#l3.44"></a><span id="l3.44"> 	int32_t  id;</span>
<a href="#l3.45"></a><span id="l3.45"> 	int32_t	offset;</span>
<a href="#l3.46"></a><span id="l3.46"> 	int32_t	length;</span>
<a href="#l3.47"></a><span id="l3.47"> 	</span>
<a href="#l3.48"></a><span id="l3.48"> } ap_entry;</span>
<a href="#l3.49"></a><span id="l3.49"> </span>
<a href="#l3.50"></a><span id="l3.50" class="difflineminus">-typedef struct ap_dates </span>
<a href="#l3.51"></a><span id="l3.51" class="difflineplus">+typedef struct ap_dates</span>
<a href="#l3.52"></a><span id="l3.52"> {</span>
<a href="#l3.53"></a><span id="l3.53"> 	int32_t create, modify, backup, access;</span>
<a href="#l3.54"></a><span id="l3.54"> </span>
<a href="#l3.55"></a><span id="l3.55"> } ap_dates;</span>
<a href="#l3.56"></a><span id="l3.56"> </span>
<a href="#l3.57"></a><span id="l3.57"> typedef struct myFInfo			/* the mac FInfo structure for the cross platform. */</span>
<a href="#l3.58"></a><span id="l3.58"> {	</span>
<a href="#l3.59"></a><span id="l3.59"> 	int32_t	fdType, fdCreator;</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineat">@@ -93,14 +93,14 @@ int  ap_seek_part_start(appledouble_deco</span>
<a href="#l3.61"></a><span id="l3.61"> void parse_param(char *p, char **param, char**define, char **np);</span>
<a href="#l3.62"></a><span id="l3.62"> int  ap_seek_to_boundary(appledouble_decode_object* p_ap_decode_obj, bool firstime);</span>
<a href="#l3.63"></a><span id="l3.63"> int  ap_parse_header(appledouble_decode_object* p_ap_decode_obj,bool firstime);</span>
<a href="#l3.64"></a><span id="l3.64"> int  ap_decode_file_infor(appledouble_decode_object* p_ap_decode_obj);</span>
<a href="#l3.65"></a><span id="l3.65"> int  ap_decode_process_header(appledouble_decode_object* p_ap_decode_obj, bool firstime);</span>
<a href="#l3.66"></a><span id="l3.66"> int  ap_decode_process_data(  appledouble_decode_object* p_ap_decode_obj, bool firstime);</span>
<a href="#l3.67"></a><span id="l3.67"> </span>
<a href="#l3.68"></a><span id="l3.68"> PR_END_EXTERN_C</span>
<a href="#l3.69"></a><span id="l3.69" class="difflineminus">- </span>
<a href="#l3.70"></a><span id="l3.70" class="difflineplus">+</span>
<a href="#l3.71"></a><span id="l3.71"> #if PRAGMA_STRUCT_ALIGN</span>
<a href="#l3.72"></a><span id="l3.72">   #pragma options align=reset</span>
<a href="#l3.73"></a><span id="l3.73"> #endif</span>
<a href="#l3.74"></a><span id="l3.74"> </span>
<a href="#l3.75"></a><span id="l3.75"> #endif /* ad_codes_h */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgAppleDouble.h</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgAppleDouble.h</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -1,15 +1,15 @@</span>
<a href="#l4.4"></a><span id="l4.4"> /* -*- Mode: C; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l4.5"></a><span id="l4.5">  *</span>
<a href="#l4.6"></a><span id="l4.6">  * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l4.7"></a><span id="l4.7">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l4.8"></a><span id="l4.8">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l4.9"></a><span id="l4.9"> </span>
<a href="#l4.10"></a><span id="l4.10" class="difflineminus">-/* </span>
<a href="#l4.11"></a><span id="l4.11" class="difflineplus">+/*</span>
<a href="#l4.12"></a><span id="l4.12"> *   AppleDouble.h</span>
<a href="#l4.13"></a><span id="l4.13"> *	-------------</span>
<a href="#l4.14"></a><span id="l4.14"> *</span>
<a href="#l4.15"></a><span id="l4.15"> *  	  The header file for a stream based apple single/double encodor/decodor.</span>
<a href="#l4.16"></a><span id="l4.16"> *		</span>
<a href="#l4.17"></a><span id="l4.17"> *		2aug95	mym		</span>
<a href="#l4.18"></a><span id="l4.18"> *		</span>
<a href="#l4.19"></a><span id="l4.19"> */</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineat">@@ -35,28 +35,28 @@</span>
<a href="#l4.21"></a><span id="l4.21"> </span>
<a href="#l4.22"></a><span id="l4.22"> 					</span>
<a href="#l4.23"></a><span id="l4.23"> #define errFileOpen	NS_ERROR_GET_CODE(NS_MSG_UNABLE_TO_OPEN_TMP_FILE)</span>
<a href="#l4.24"></a><span id="l4.24"> #define errFileWrite	-202 /*Error writing temporary file.*/</span>
<a href="#l4.25"></a><span id="l4.25"> #define errUsrCancel	-2  /*MK_INTERRUPTED */</span>
<a href="#l4.26"></a><span id="l4.26"> #define errDecoding		-1</span>
<a href="#l4.27"></a><span id="l4.27"> </span>
<a href="#l4.28"></a><span id="l4.28"> /*</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineminus">-** The envirment block data type. </span>
<a href="#l4.30"></a><span id="l4.30" class="difflineplus">+** The envirment block data type.</span>
<a href="#l4.31"></a><span id="l4.31"> */</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineminus">-enum </span>
<a href="#l4.33"></a><span id="l4.33" class="difflineminus">-{ </span>
<a href="#l4.34"></a><span id="l4.34" class="difflineminus">-	kInit, </span>
<a href="#l4.35"></a><span id="l4.35" class="difflineminus">-	kDoingHeaderPortion, </span>
<a href="#l4.36"></a><span id="l4.36" class="difflineminus">-	kDoneHeaderPortion, </span>
<a href="#l4.37"></a><span id="l4.37" class="difflineminus">-	kDoingDataPortion, </span>
<a href="#l4.38"></a><span id="l4.38" class="difflineminus">-	kDoneDataPortion </span>
<a href="#l4.39"></a><span id="l4.39" class="difflineplus">+enum</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineplus">+{</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineplus">+	kInit,</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineplus">+	kDoingHeaderPortion,</span>
<a href="#l4.43"></a><span id="l4.43" class="difflineplus">+	kDoneHeaderPortion,</span>
<a href="#l4.44"></a><span id="l4.44" class="difflineplus">+	kDoingDataPortion,</span>
<a href="#l4.45"></a><span id="l4.45" class="difflineplus">+	kDoneDataPortion</span>
<a href="#l4.46"></a><span id="l4.46"> };</span>
<a href="#l4.47"></a><span id="l4.47"> </span>
<a href="#l4.48"></a><span id="l4.48" class="difflineminus">-typedef struct _appledouble_encode_object </span>
<a href="#l4.49"></a><span id="l4.49" class="difflineplus">+typedef struct _appledouble_encode_object</span>
<a href="#l4.50"></a><span id="l4.50"> {</span>
<a href="#l4.51"></a><span id="l4.51">     char    fname[256];</span>
<a href="#l4.52"></a><span id="l4.52">     FSIORefNum fileId;				/* the id for the open file (data/resource fork) */</span>
<a href="#l4.53"></a><span id="l4.53"> </span>
<a href="#l4.54"></a><span id="l4.54"> 	int 	state;</span>
<a href="#l4.55"></a><span id="l4.55"> 	int		text_file_type;		/* if the file has a text file type with it.	*/</span>
<a href="#l4.56"></a><span id="l4.56"> 	char	*boundary;			/* the boundary string.							*/</span>
<a href="#l4.57"></a><span id="l4.57"> </span>
<a href="#l4.58"></a><span id="l4.58" class="difflineat">@@ -65,73 +65,73 @@ typedef struct _appledouble_encode_objec</span>
<a href="#l4.59"></a><span id="l4.59"> 	int		s_overflow;</span>
<a href="#l4.60"></a><span id="l4.60"> 	</span>
<a href="#l4.61"></a><span id="l4.61"> 	int		state64;			/* the left over state of base64 enocding 		*/</span>
<a href="#l4.62"></a><span id="l4.62"> 	int		ct;					/* the character count of base64 encoding		*/</span>
<a href="#l4.63"></a><span id="l4.63"> 	int 	c1, c2;				/* the left of the last base64 encoding 		*/		</span>
<a href="#l4.64"></a><span id="l4.64"> </span>
<a href="#l4.65"></a><span id="l4.65"> 	char 	*outbuff;			/* the outbuff by the caller.           		*/</span>
<a href="#l4.66"></a><span id="l4.66"> 	int		s_outbuff;			/* the size of the buffer.						*/</span>
<a href="#l4.67"></a><span id="l4.67" class="difflineminus">-	int		pos_outbuff;		/* the offset in the current buffer.			*/ </span>
<a href="#l4.68"></a><span id="l4.68" class="difflineplus">+	int		pos_outbuff;		/* the offset in the current buffer.			*/</span>
<a href="#l4.69"></a><span id="l4.69"> </span>
<a href="#l4.70"></a><span id="l4.70"> } appledouble_encode_object;</span>
<a href="#l4.71"></a><span id="l4.71"> </span>
<a href="#l4.72"></a><span id="l4.72"> /* The possible content transfer encodings */</span>
<a href="#l4.73"></a><span id="l4.73"> </span>
<a href="#l4.74"></a><span id="l4.74" class="difflineminus">-enum </span>
<a href="#l4.75"></a><span id="l4.75" class="difflineminus">-{ </span>
<a href="#l4.76"></a><span id="l4.76" class="difflineplus">+enum</span>
<a href="#l4.77"></a><span id="l4.77" class="difflineplus">+{</span>
<a href="#l4.78"></a><span id="l4.78"> 	kEncodeNone,</span>
<a href="#l4.79"></a><span id="l4.79"> 	kEncodeQP,</span>
<a href="#l4.80"></a><span id="l4.80"> 	kEncodeBase64,</span>
<a href="#l4.81"></a><span id="l4.81"> 	kEncodeUU</span>
<a href="#l4.82"></a><span id="l4.82"> };</span>
<a href="#l4.83"></a><span id="l4.83"> </span>
<a href="#l4.84"></a><span id="l4.84" class="difflineminus">-enum </span>
<a href="#l4.85"></a><span id="l4.85" class="difflineminus">-{ </span>
<a href="#l4.86"></a><span id="l4.86" class="difflineplus">+enum</span>
<a href="#l4.87"></a><span id="l4.87" class="difflineplus">+{</span>
<a href="#l4.88"></a><span id="l4.88"> 	kGeneralMine,</span>
<a href="#l4.89"></a><span id="l4.89"> 	kAppleDouble,</span>
<a href="#l4.90"></a><span id="l4.90"> 	kAppleSingle</span>
<a href="#l4.91"></a><span id="l4.91"> };</span>
<a href="#l4.92"></a><span id="l4.92"> </span>
<a href="#l4.93"></a><span id="l4.93" class="difflineminus">-enum </span>
<a href="#l4.94"></a><span id="l4.94" class="difflineminus">-{ </span>
<a href="#l4.95"></a><span id="l4.95" class="difflineplus">+enum</span>
<a href="#l4.96"></a><span id="l4.96" class="difflineplus">+{</span>
<a href="#l4.97"></a><span id="l4.97"> 	kInline,</span>
<a href="#l4.98"></a><span id="l4.98"> 	kDontCare</span>
<a href="#l4.99"></a><span id="l4.99"> };</span>
<a href="#l4.100"></a><span id="l4.100"> </span>
<a href="#l4.101"></a><span id="l4.101" class="difflineminus">-enum </span>
<a href="#l4.102"></a><span id="l4.102" class="difflineminus">-{ </span>
<a href="#l4.103"></a><span id="l4.103" class="difflineplus">+enum</span>
<a href="#l4.104"></a><span id="l4.104" class="difflineplus">+{</span>
<a href="#l4.105"></a><span id="l4.105"> 	kHeaderPortion,</span>
<a href="#l4.106"></a><span id="l4.106"> 	kDataPortion</span>
<a href="#l4.107"></a><span id="l4.107"> };</span>
<a href="#l4.108"></a><span id="l4.108"> </span>
<a href="#l4.109"></a><span id="l4.109"> /* the decode states.	*/</span>
<a href="#l4.110"></a><span id="l4.110" class="difflineminus">-enum </span>
<a href="#l4.111"></a><span id="l4.111" class="difflineminus">-{ </span>
<a href="#l4.112"></a><span id="l4.112" class="difflineplus">+enum</span>
<a href="#l4.113"></a><span id="l4.113" class="difflineplus">+{</span>
<a href="#l4.114"></a><span id="l4.114"> 	kBeginParseHeader = 3,</span>
<a href="#l4.115"></a><span id="l4.115"> 	kParsingHeader,</span>
<a href="#l4.116"></a><span id="l4.116"> 	kBeginSeekBoundary,</span>
<a href="#l4.117"></a><span id="l4.117"> 	kSeekingBoundary,</span>
<a href="#l4.118"></a><span id="l4.118" class="difflineminus">-	kBeginHeaderPortion, </span>
<a href="#l4.119"></a><span id="l4.119" class="difflineminus">-	kProcessingHeaderPortion, </span>
<a href="#l4.120"></a><span id="l4.120" class="difflineminus">-	kBeginDataPortion, </span>
<a href="#l4.121"></a><span id="l4.121" class="difflineminus">-	kProcessingDataPortion, </span>
<a href="#l4.122"></a><span id="l4.122" class="difflineplus">+	kBeginHeaderPortion,</span>
<a href="#l4.123"></a><span id="l4.123" class="difflineplus">+	kProcessingHeaderPortion,</span>
<a href="#l4.124"></a><span id="l4.124" class="difflineplus">+	kBeginDataPortion,</span>
<a href="#l4.125"></a><span id="l4.125" class="difflineplus">+	kProcessingDataPortion,</span>
<a href="#l4.126"></a><span id="l4.126"> 	kFinishing</span>
<a href="#l4.127"></a><span id="l4.127"> };</span>
<a href="#l4.128"></a><span id="l4.128"> </span>
<a href="#l4.129"></a><span id="l4.129"> /* uuencode states */</span>
<a href="#l4.130"></a><span id="l4.130"> enum</span>
<a href="#l4.131"></a><span id="l4.131"> {</span>
<a href="#l4.132"></a><span id="l4.132"> 	kWaitingForBegin = (int) 0,</span>
<a href="#l4.133"></a><span id="l4.133"> 	kBegin,</span>
<a href="#l4.134"></a><span id="l4.134"> 	kMainBody,</span>
<a href="#l4.135"></a><span id="l4.135"> 	kEnd</span>
<a href="#l4.136"></a><span id="l4.136"> };</span>
<a href="#l4.137"></a><span id="l4.137"> </span>
<a href="#l4.138"></a><span id="l4.138" class="difflineminus">-typedef struct _appledouble_decode_object </span>
<a href="#l4.139"></a><span id="l4.139" class="difflineplus">+typedef struct _appledouble_decode_object</span>
<a href="#l4.140"></a><span id="l4.140"> {</span>
<a href="#l4.141"></a><span id="l4.141"> 	int		is_binary;</span>
<a href="#l4.142"></a><span id="l4.142"> 	int		is_apple_single;	/* if the object encoded is in apple single		*/</span>
<a href="#l4.143"></a><span id="l4.143"> 	int		write_as_binhex;</span>
<a href="#l4.144"></a><span id="l4.144"> 	</span>
<a href="#l4.145"></a><span id="l4.145"> 	int		messagetype;</span>
<a href="#l4.146"></a><span id="l4.146"> 	char*	boundary0;			/* the boundary for the enclosure.				*/</span>
<a href="#l4.147"></a><span id="l4.147"> 	int		deposition;			/* the deposition.								*/</span>
<a href="#l4.148"></a><span id="l4.148" class="difflineat">@@ -140,68 +140,68 @@ typedef struct _appledouble_decode_objec</span>
<a href="#l4.149"></a><span id="l4.149"> 	</span>
<a href="#l4.150"></a><span id="l4.150"> 	char	fname[256];</span>
<a href="#l4.151"></a><span id="l4.151"> 	// nsIOFileStream *fileSpec;					/* the stream for data fork work.					 */</span>
<a href="#l4.152"></a><span id="l4.152"> </span>
<a href="#l4.153"></a><span id="l4.153"> 	int 	state;</span>
<a href="#l4.154"></a><span id="l4.154"> 	</span>
<a href="#l4.155"></a><span id="l4.155"> 	int		rksize;				/* the resource fork size count.				*/</span>
<a href="#l4.156"></a><span id="l4.156"> 	int		dksize;				/* the data fork size count.					*/</span>
<a href="#l4.157"></a><span id="l4.157" class="difflineminus">-	 </span>
<a href="#l4.158"></a><span id="l4.158" class="difflineplus">+	</span>
<a href="#l4.159"></a><span id="l4.159"> 	int		status;				/* the error code if anyerror happens.			*/</span>
<a href="#l4.160"></a><span id="l4.160"> 	char 	b_leftover[256];</span>
<a href="#l4.161"></a><span id="l4.161"> 	int		s_leftover;</span>
<a href="#l4.162"></a><span id="l4.162"> 	</span>
<a href="#l4.163"></a><span id="l4.163"> 	int		encode;				/* the encode type of the message.				*/</span>
<a href="#l4.164"></a><span id="l4.164"> 	int		state64;			/* the left over state of base64 enocding 		*/</span>
<a href="#l4.165"></a><span id="l4.165"> 	int		left;				/* the character count of base64 encoding		*/</span>
<a href="#l4.166"></a><span id="l4.166"> 	int 	c[4];				/* the left of the last base64 encoding 		*/		</span>
<a href="#l4.167"></a><span id="l4.167"> 	int		uu_starts_line;		/* is decoder at the start of a line? (uuencode)	*/</span>
<a href="#l4.168"></a><span id="l4.168"> 	int		uu_state;			/* state w/r/t the uuencode body */</span>
<a href="#l4.169"></a><span id="l4.169"> 	int		uu_bytes_written;	/* bytes written from the current tuple (uuencode) */</span>
<a href="#l4.170"></a><span id="l4.170"> 	int		uu_line_bytes;		/* encoded bytes remaining in the current line (uuencode) */</span>
<a href="#l4.171"></a><span id="l4.171"> </span>
<a href="#l4.172"></a><span id="l4.172"> 	char 	*inbuff;			/* the outbuff by the caller.           		*/</span>
<a href="#l4.173"></a><span id="l4.173"> 	int		s_inbuff;			/* the size of the buffer.						*/</span>
<a href="#l4.174"></a><span id="l4.174" class="difflineminus">-	int		pos_inbuff;			/* the offset in the current buffer.			*/ </span>
<a href="#l4.175"></a><span id="l4.175" class="difflineplus">+	int		pos_inbuff;			/* the offset in the current buffer.			*/</span>
<a href="#l4.176"></a><span id="l4.176"> </span>
<a href="#l4.177"></a><span id="l4.177"> </span>
<a href="#l4.178"></a><span id="l4.178"> 	nsCOMPtr &lt;nsIFile&gt; tmpFile;		/* the temp file to hold the decode data fork 	*/</span>
<a href="#l4.179"></a><span id="l4.179"> 								                      /* when doing the binhex exporting.				*/</span>
<a href="#l4.180"></a><span id="l4.180">   nsCOMPtr &lt;nsIOutputStream&gt; tmpFileStream; /* The output File Stream */</span>
<a href="#l4.181"></a><span id="l4.181"> 	int32_t	            data_size;			/* the size of the data in the tmp file.		*/</span>
<a href="#l4.182"></a><span id="l4.182"> </span>
<a href="#l4.183"></a><span id="l4.183"> } appledouble_decode_object;</span>
<a href="#l4.184"></a><span id="l4.184"> </span>
<a href="#l4.185"></a><span id="l4.185"> </span>
<a href="#l4.186"></a><span id="l4.186"> /*</span>
<a href="#l4.187"></a><span id="l4.187"> **	The protypes.</span>
<a href="#l4.188"></a><span id="l4.188"> */</span>
<a href="#l4.189"></a><span id="l4.189"> </span>
<a href="#l4.190"></a><span id="l4.190"> PR_BEGIN_EXTERN_C</span>
<a href="#l4.191"></a><span id="l4.191"> </span>
<a href="#l4.192"></a><span id="l4.192" class="difflineminus">-int ap_encode_init(appledouble_encode_object *p_ap_encode_obj, </span>
<a href="#l4.193"></a><span id="l4.193" class="difflineplus">+int ap_encode_init(appledouble_encode_object *p_ap_encode_obj,</span>
<a href="#l4.194"></a><span id="l4.194"> 					const char* fname,</span>
<a href="#l4.195"></a><span id="l4.195"> 					char* separator);</span>
<a href="#l4.196"></a><span id="l4.196"> </span>
<a href="#l4.197"></a><span id="l4.197" class="difflineminus">-int ap_encode_next(appledouble_encode_object* p_ap_encode_obj, </span>
<a href="#l4.198"></a><span id="l4.198" class="difflineplus">+int ap_encode_next(appledouble_encode_object* p_ap_encode_obj,</span>
<a href="#l4.199"></a><span id="l4.199"> 					char 	*to_buff,</span>
<a href="#l4.200"></a><span id="l4.200"> 					int32_t 	buff_size,</span>
<a href="#l4.201"></a><span id="l4.201"> 					int32_t*	real_size);</span>
<a href="#l4.202"></a><span id="l4.202"> </span>
<a href="#l4.203"></a><span id="l4.203"> int ap_encode_end(appledouble_encode_object* p_ap_encode_obj,</span>
<a href="#l4.204"></a><span id="l4.204"> 					bool	is_aborting);</span>
<a href="#l4.205"></a><span id="l4.205"> </span>
<a href="#l4.206"></a><span id="l4.206"> int ap_decode_init(appledouble_decode_object* p_ap_decode_obj,</span>
<a href="#l4.207"></a><span id="l4.207"> 					bool	is_apple_single,</span>
<a href="#l4.208"></a><span id="l4.208"> 					bool	write_as_bin_hex,</span>
<a href="#l4.209"></a><span id="l4.209"> 					void  	*closure);</span>
<a href="#l4.210"></a><span id="l4.210"> </span>
<a href="#l4.211"></a><span id="l4.211" class="difflineminus">-int ap_decode_next(appledouble_decode_object* p_ap_decode_obj, </span>
<a href="#l4.212"></a><span id="l4.212" class="difflineminus">-					char 	*in_buff, </span>
<a href="#l4.213"></a><span id="l4.213" class="difflineplus">+int ap_decode_next(appledouble_decode_object* p_ap_decode_obj,</span>
<a href="#l4.214"></a><span id="l4.214" class="difflineplus">+					char 	*in_buff,</span>
<a href="#l4.215"></a><span id="l4.215"> 					int32_t 	buff_size);</span>
<a href="#l4.216"></a><span id="l4.216"> </span>
<a href="#l4.217"></a><span id="l4.217" class="difflineminus">-int ap_decode_end(appledouble_decode_object* p_ap_decode_obj, </span>
<a href="#l4.218"></a><span id="l4.218" class="difflineplus">+int ap_decode_end(appledouble_decode_object* p_ap_decode_obj,</span>
<a href="#l4.219"></a><span id="l4.219"> 				 	bool is_aborting);</span>
<a href="#l4.220"></a><span id="l4.220"> </span>
<a href="#l4.221"></a><span id="l4.221"> PR_END_EXTERN_C</span>
<a href="#l4.222"></a><span id="l4.222"> </span>
<a href="#l4.223"></a><span id="l4.223"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgAppleDoubleEncode.cpp</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgAppleDoubleEncode.cpp</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -23,19 +23,19 @@</span>
<a href="#l5.4"></a><span id="l5.4"> #include &quot;nsCExternalHandlerService.h&quot;</span>
<a href="#l5.5"></a><span id="l5.5"> #include &quot;nsIMIMEService.h&quot;</span>
<a href="#l5.6"></a><span id="l5.6"> #include &quot;nsMimeTypes.h&quot;</span>
<a href="#l5.7"></a><span id="l5.7"> #include &quot;prmem.h&quot;</span>
<a href="#l5.8"></a><span id="l5.8"> #include &quot;nsNetUtil.h&quot;</span>
<a href="#l5.9"></a><span id="l5.9"> </span>
<a href="#l5.10"></a><span id="l5.10"> </span>
<a href="#l5.11"></a><span id="l5.11"> void	</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-MacGetFileType(nsIFile   *fs, </span>
<a href="#l5.13"></a><span id="l5.13" class="difflineminus">-               bool         *useDefault, </span>
<a href="#l5.14"></a><span id="l5.14" class="difflineminus">-               char         **fileType, </span>
<a href="#l5.15"></a><span id="l5.15" class="difflineplus">+MacGetFileType(nsIFile   *fs,</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineplus">+               bool         *useDefault,</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineplus">+               char         **fileType,</span>
<a href="#l5.18"></a><span id="l5.18">                char         **encoding)</span>
<a href="#l5.19"></a><span id="l5.19"> {</span>
<a href="#l5.20"></a><span id="l5.20"> 	if ((fs == NULL) || (fileType == NULL) || (encoding == NULL))</span>
<a href="#l5.21"></a><span id="l5.21"> 		return;</span>
<a href="#l5.22"></a><span id="l5.22"> </span>
<a href="#l5.23"></a><span id="l5.23">   bool exists = false;</span>
<a href="#l5.24"></a><span id="l5.24">   fs-&gt;Exists(&amp;exists);</span>
<a href="#l5.25"></a><span id="l5.25">   if (!exists)</span>
<a href="#l5.26"></a><span id="l5.26" class="difflineat">@@ -58,25 +58,25 @@ MacGetFileType(nsIFile   *fs,</span>
<a href="#l5.27"></a><span id="l5.27">   {</span>
<a href="#l5.28"></a><span id="l5.28">     // At this point, we should call the mime service and</span>
<a href="#l5.29"></a><span id="l5.29">     // see what we can find out?</span>
<a href="#l5.30"></a><span id="l5.30">     nsresult      rv;</span>
<a href="#l5.31"></a><span id="l5.31">     nsCOMPtr &lt;nsIURI&gt; tURI;</span>
<a href="#l5.32"></a><span id="l5.32">     if (NS_SUCCEEDED(NS_NewFileURI(getter_AddRefs(tURI), fs)) &amp;&amp; tURI)</span>
<a href="#l5.33"></a><span id="l5.33">     {</span>
<a href="#l5.34"></a><span id="l5.34">       nsCOMPtr&lt;nsIMIMEService&gt; mimeFinder (do_GetService(NS_MIMESERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l5.35"></a><span id="l5.35" class="difflineminus">-      if (NS_SUCCEEDED(rv) &amp;&amp; mimeFinder) </span>
<a href="#l5.36"></a><span id="l5.36" class="difflineplus">+      if (NS_SUCCEEDED(rv) &amp;&amp; mimeFinder)</span>
<a href="#l5.37"></a><span id="l5.37">       {</span>
<a href="#l5.38"></a><span id="l5.38">         nsAutoCString mimeType;</span>
<a href="#l5.39"></a><span id="l5.39">         rv = mimeFinder-&gt;GetTypeFromURI(tURI, mimeType);</span>
<a href="#l5.40"></a><span id="l5.40" class="difflineminus">-        if (NS_SUCCEEDED(rv)) </span>
<a href="#l5.41"></a><span id="l5.41" class="difflineplus">+        if (NS_SUCCEEDED(rv))</span>
<a href="#l5.42"></a><span id="l5.42">         {</span>
<a href="#l5.43"></a><span id="l5.43">           *fileType = ToNewCString(mimeType);</span>
<a href="#l5.44"></a><span id="l5.44">           return;</span>
<a href="#l5.45"></a><span id="l5.45" class="difflineminus">-        }        </span>
<a href="#l5.46"></a><span id="l5.46" class="difflineplus">+        }</span>
<a href="#l5.47"></a><span id="l5.47">       }</span>
<a href="#l5.48"></a><span id="l5.48">     }</span>
<a href="#l5.49"></a><span id="l5.49"> </span>
<a href="#l5.50"></a><span id="l5.50">     // If we hit here, return something...default to this...</span>
<a href="#l5.51"></a><span id="l5.51">     *fileType = strdup(APPLICATION_OCTET_STREAM);</span>
<a href="#l5.52"></a><span id="l5.52">   }</span>
<a href="#l5.53"></a><span id="l5.53"> }</span>
<a href="#l5.54"></a><span id="l5.54"> </span>
<a href="#l5.55"></a><span id="l5.55" class="difflineat">@@ -120,59 +120,59 @@ int ap_encode_init( appledouble_encode_o</span>
<a href="#l5.56"></a><span id="l5.56"> **	--------------</span>
<a href="#l5.57"></a><span id="l5.57"> **		</span>
<a href="#l5.58"></a><span id="l5.58"> **		return :</span>
<a href="#l5.59"></a><span id="l5.59"> **			noErr	:	everything is ok</span>
<a href="#l5.60"></a><span id="l5.60"> **			errDone	:	when encoding is done.</span>
<a href="#l5.61"></a><span id="l5.61"> **			errors	:	otherwise.</span>
<a href="#l5.62"></a><span id="l5.62"> */</span>
<a href="#l5.63"></a><span id="l5.63"> int ap_encode_next(</span>
<a href="#l5.64"></a><span id="l5.64" class="difflineminus">-	appledouble_encode_object* p_ap_encode_obj, </span>
<a href="#l5.65"></a><span id="l5.65" class="difflineminus">-	char 	*to_buff, </span>
<a href="#l5.66"></a><span id="l5.66" class="difflineminus">-	int32_t 	buff_size, </span>
<a href="#l5.67"></a><span id="l5.67" class="difflineplus">+	appledouble_encode_object* p_ap_encode_obj,</span>
<a href="#l5.68"></a><span id="l5.68" class="difflineplus">+	char 	*to_buff,</span>
<a href="#l5.69"></a><span id="l5.69" class="difflineplus">+	int32_t 	buff_size,</span>
<a href="#l5.70"></a><span id="l5.70"> 	int32_t* 	real_size)</span>
<a href="#l5.71"></a><span id="l5.71"> {</span>
<a href="#l5.72"></a><span id="l5.72"> 	int status;</span>
<a href="#l5.73"></a><span id="l5.73"> 	</span>
<a href="#l5.74"></a><span id="l5.74"> 	/*</span>
<a href="#l5.75"></a><span id="l5.75"> 	** 	install the out buff now.</span>
<a href="#l5.76"></a><span id="l5.76"> 	*/</span>
<a href="#l5.77"></a><span id="l5.77"> 	p_ap_encode_obj-&gt;outbuff     = to_buff;</span>
<a href="#l5.78"></a><span id="l5.78"> 	p_ap_encode_obj-&gt;s_outbuff 	 = buff_size;</span>
<a href="#l5.79"></a><span id="l5.79"> 	p_ap_encode_obj-&gt;pos_outbuff = 0;</span>
<a href="#l5.80"></a><span id="l5.80"> 	</span>
<a href="#l5.81"></a><span id="l5.81"> 	/*</span>
<a href="#l5.82"></a><span id="l5.82" class="difflineminus">-	**	first copy the outstandind data in the overflow buff to the out buffer. </span>
<a href="#l5.83"></a><span id="l5.83" class="difflineplus">+	**	first copy the outstandind data in the overflow buff to the out buffer.</span>
<a href="#l5.84"></a><span id="l5.84"> 	*/</span>
<a href="#l5.85"></a><span id="l5.85"> 	if (p_ap_encode_obj-&gt;s_overflow)</span>
<a href="#l5.86"></a><span id="l5.86"> 	{</span>
<a href="#l5.87"></a><span id="l5.87"> 		status = write_stream(p_ap_encode_obj,</span>
<a href="#l5.88"></a><span id="l5.88"> 		                      (const char*)(p_ap_encode_obj-&gt;b_overflow),</span>
<a href="#l5.89"></a><span id="l5.89"> 		                      p_ap_encode_obj-&gt;s_overflow);</span>
<a href="#l5.90"></a><span id="l5.90"> 		if (status != noErr)</span>
<a href="#l5.91"></a><span id="l5.91"> 			return status;</span>
<a href="#l5.92"></a><span id="l5.92"> 				</span>
<a href="#l5.93"></a><span id="l5.93"> 		p_ap_encode_obj-&gt;s_overflow = 0;</span>
<a href="#l5.94"></a><span id="l5.94"> 	}</span>
<a href="#l5.95"></a><span id="l5.95"> </span>
<a href="#l5.96"></a><span id="l5.96"> 	/*</span>
<a href="#l5.97"></a><span id="l5.97" class="difflineminus">-	** go the next processing stage based on the current state. </span>
<a href="#l5.98"></a><span id="l5.98" class="difflineplus">+	** go the next processing stage based on the current state.</span>
<a href="#l5.99"></a><span id="l5.99"> 	*/</span>
<a href="#l5.100"></a><span id="l5.100"> 	switch (p_ap_encode_obj-&gt;state)</span>
<a href="#l5.101"></a><span id="l5.101"> 	{</span>
<a href="#l5.102"></a><span id="l5.102"> 		case kInit:</span>
<a href="#l5.103"></a><span id="l5.103"> 			/*</span>
<a href="#l5.104"></a><span id="l5.104"> 			** We are in the  starting position, fill out the header.</span>
<a href="#l5.105"></a><span id="l5.105"> 			*/</span>
<a href="#l5.106"></a><span id="l5.106" class="difflineminus">-			status = fill_apple_mime_header(p_ap_encode_obj); </span>
<a href="#l5.107"></a><span id="l5.107" class="difflineplus">+			status = fill_apple_mime_header(p_ap_encode_obj);</span>
<a href="#l5.108"></a><span id="l5.108"> 			if (status != noErr)</span>
<a href="#l5.109"></a><span id="l5.109"> 				break;					/* some error happens */</span>
<a href="#l5.110"></a><span id="l5.110"> 				</span>
<a href="#l5.111"></a><span id="l5.111"> 			p_ap_encode_obj-&gt;state = kDoingHeaderPortion;</span>
<a href="#l5.112"></a><span id="l5.112" class="difflineminus">-			status = ap_encode_header(p_ap_encode_obj, true); </span>
<a href="#l5.113"></a><span id="l5.113" class="difflineplus">+			status = ap_encode_header(p_ap_encode_obj, true);</span>
<a href="#l5.114"></a><span id="l5.114"> 										/* it is the first time to calling 		*/							</span>
<a href="#l5.115"></a><span id="l5.115"> 			if (status == errDone)</span>
<a href="#l5.116"></a><span id="l5.116"> 			{</span>
<a href="#l5.117"></a><span id="l5.117"> 				p_ap_encode_obj-&gt;state = kDoneHeaderPortion;</span>
<a href="#l5.118"></a><span id="l5.118"> 			}</span>
<a href="#l5.119"></a><span id="l5.119"> 			else</span>
<a href="#l5.120"></a><span id="l5.120"> 			{</span>
<a href="#l5.121"></a><span id="l5.121"> 				break;					/* we need more work on header portion.	*/</span>
<a href="#l5.122"></a><span id="l5.122" class="difflineat">@@ -243,17 +243,17 @@ int ap_encode_next(</span>
<a href="#l5.123"></a><span id="l5.123"> /*</span>
<a href="#l5.124"></a><span id="l5.124"> **	ap_encode_end</span>
<a href="#l5.125"></a><span id="l5.125"> **	-------------</span>
<a href="#l5.126"></a><span id="l5.126"> **</span>
<a href="#l5.127"></a><span id="l5.127"> **	clear the apple encoding.</span>
<a href="#l5.128"></a><span id="l5.128"> */</span>
<a href="#l5.129"></a><span id="l5.129"> </span>
<a href="#l5.130"></a><span id="l5.130"> int ap_encode_end(</span>
<a href="#l5.131"></a><span id="l5.131" class="difflineminus">-	appledouble_encode_object *p_ap_encode_obj, </span>
<a href="#l5.132"></a><span id="l5.132" class="difflineplus">+	appledouble_encode_object *p_ap_encode_obj,</span>
<a href="#l5.133"></a><span id="l5.133"> 	bool is_aborting)</span>
<a href="#l5.134"></a><span id="l5.134"> {</span>
<a href="#l5.135"></a><span id="l5.135"> 	/*</span>
<a href="#l5.136"></a><span id="l5.136"> 	** clear up the apple doubler.</span>
<a href="#l5.137"></a><span id="l5.137"> 	*/</span>
<a href="#l5.138"></a><span id="l5.138"> 	if (p_ap_encode_obj == NULL)</span>
<a href="#l5.139"></a><span id="l5.139"> 		return noErr;</span>
<a href="#l5.140"></a><span id="l5.140"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgAppleEncode.cpp</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgAppleEncode.cpp</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -22,53 +22,53 @@</span>
<a href="#l6.4"></a><span id="l6.4"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l6.5"></a><span id="l6.5"> #include &quot;nsMsgAppleDouble.h&quot;</span>
<a href="#l6.6"></a><span id="l6.6"> #include &quot;nsMsgAppleCodes.h&quot;</span>
<a href="#l6.7"></a><span id="l6.7"> #include &quot;nsILocalFileMac.h&quot;</span>
<a href="#l6.8"></a><span id="l6.8"> </span>
<a href="#l6.9"></a><span id="l6.9"> /*</span>
<a href="#l6.10"></a><span id="l6.10"> **	Local Functions prototypes.</span>
<a href="#l6.11"></a><span id="l6.11"> */</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-static int output64chunk( appledouble_encode_object* p_ap_encode_obj, </span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+static int output64chunk( appledouble_encode_object* p_ap_encode_obj,</span>
<a href="#l6.14"></a><span id="l6.14"> 				int c1, int c2, int c3, int pads);</span>
<a href="#l6.15"></a><span id="l6.15"> 				</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineminus">-static int to64(appledouble_encode_object* p_ap_encode_obj, </span>
<a href="#l6.17"></a><span id="l6.17" class="difflineminus">-				char	*p, </span>
<a href="#l6.18"></a><span id="l6.18" class="difflineplus">+static int to64(appledouble_encode_object* p_ap_encode_obj,</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineplus">+				char	*p,</span>
<a href="#l6.20"></a><span id="l6.20"> 				int 	in_size);</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineminus">- </span>
<a href="#l6.22"></a><span id="l6.22" class="difflineplus">+</span>
<a href="#l6.23"></a><span id="l6.23"> static int finish64(appledouble_encode_object* p_ap_encode_obj);</span>
<a href="#l6.24"></a><span id="l6.24"> </span>
<a href="#l6.25"></a><span id="l6.25"> </span>
<a href="#l6.26"></a><span id="l6.26"> #define BUFF_LEFT(p)	((p)-&gt;s_outbuff - (p)-&gt;pos_outbuff)	</span>
<a href="#l6.27"></a><span id="l6.27"> </span>
<a href="#l6.28"></a><span id="l6.28"> /*</span>
<a href="#l6.29"></a><span id="l6.29"> **	write_stream.</span>
<a href="#l6.30"></a><span id="l6.30"> */</span>
<a href="#l6.31"></a><span id="l6.31"> int write_stream(</span>
<a href="#l6.32"></a><span id="l6.32"> 	appledouble_encode_object *p_ap_encode_obj,</span>
<a href="#l6.33"></a><span id="l6.33"> 	const char *out_string,</span>
<a href="#l6.34"></a><span id="l6.34"> 	int len)</span>
<a href="#l6.35"></a><span id="l6.35"> {	</span>
<a href="#l6.36"></a><span id="l6.36"> 	if (p_ap_encode_obj-&gt;pos_outbuff + len &lt; p_ap_encode_obj-&gt;s_outbuff)</span>
<a href="#l6.37"></a><span id="l6.37"> 	{</span>
<a href="#l6.38"></a><span id="l6.38" class="difflineminus">-		memcpy(p_ap_encode_obj-&gt;outbuff + p_ap_encode_obj-&gt;pos_outbuff, </span>
<a href="#l6.39"></a><span id="l6.39" class="difflineminus">-		       out_string, </span>
<a href="#l6.40"></a><span id="l6.40" class="difflineplus">+		memcpy(p_ap_encode_obj-&gt;outbuff + p_ap_encode_obj-&gt;pos_outbuff,</span>
<a href="#l6.41"></a><span id="l6.41" class="difflineplus">+		       out_string,</span>
<a href="#l6.42"></a><span id="l6.42"> 		       len);</span>
<a href="#l6.43"></a><span id="l6.43"> 		p_ap_encode_obj-&gt;pos_outbuff += len;</span>
<a href="#l6.44"></a><span id="l6.44"> 		return noErr;</span>
<a href="#l6.45"></a><span id="l6.45"> 	}</span>
<a href="#l6.46"></a><span id="l6.46"> 	else</span>
<a href="#l6.47"></a><span id="l6.47"> 	{</span>
<a href="#l6.48"></a><span id="l6.48"> 		/*</span>
<a href="#l6.49"></a><span id="l6.49"> 		**	If the buff doesn't have enough space, use the overflow buffer then.</span>
<a href="#l6.50"></a><span id="l6.50"> 		*/</span>
<a href="#l6.51"></a><span id="l6.51"> 		int s_len = p_ap_encode_obj-&gt;s_outbuff - p_ap_encode_obj-&gt;pos_outbuff;</span>
<a href="#l6.52"></a><span id="l6.52"> 		</span>
<a href="#l6.53"></a><span id="l6.53" class="difflineminus">-		memcpy(p_ap_encode_obj-&gt;outbuff + p_ap_encode_obj-&gt;pos_outbuff, </span>
<a href="#l6.54"></a><span id="l6.54" class="difflineminus">-		       out_string, </span>
<a href="#l6.55"></a><span id="l6.55" class="difflineplus">+		memcpy(p_ap_encode_obj-&gt;outbuff + p_ap_encode_obj-&gt;pos_outbuff,</span>
<a href="#l6.56"></a><span id="l6.56" class="difflineplus">+		       out_string,</span>
<a href="#l6.57"></a><span id="l6.57"> 		       s_len);</span>
<a href="#l6.58"></a><span id="l6.58"> 		memcpy(p_ap_encode_obj-&gt;b_overflow + p_ap_encode_obj-&gt;s_overflow,</span>
<a href="#l6.59"></a><span id="l6.59"> 		       out_string + s_len,</span>
<a href="#l6.60"></a><span id="l6.60"> 		       p_ap_encode_obj-&gt;s_overflow += (len - s_len));</span>
<a href="#l6.61"></a><span id="l6.61"> 		p_ap_encode_obj-&gt;pos_outbuff += s_len;</span>
<a href="#l6.62"></a><span id="l6.62"> 		return errEOB;</span>
<a href="#l6.63"></a><span id="l6.63"> 	}</span>
<a href="#l6.64"></a><span id="l6.64"> }</span>
<a href="#l6.65"></a><span id="l6.65" class="difflineat">@@ -77,17 +77,17 @@ int fill_apple_mime_header(</span>
<a href="#l6.66"></a><span id="l6.66"> 	appledouble_encode_object *p_ap_encode_obj)</span>
<a href="#l6.67"></a><span id="l6.67"> {</span>
<a href="#l6.68"></a><span id="l6.68"> 	int  status;</span>
<a href="#l6.69"></a><span id="l6.69"> 	</span>
<a href="#l6.70"></a><span id="l6.70"> 	char tmpstr[266];</span>
<a href="#l6.71"></a><span id="l6.71"> 	</span>
<a href="#l6.72"></a><span id="l6.72"> #if 0	</span>
<a href="#l6.73"></a><span id="l6.73"> //	strcpy(tmpstr, &quot;Content-Type: multipart/mixed; boundary=\&quot;-\&quot;\n\n---\n&quot;);</span>
<a href="#l6.74"></a><span id="l6.74" class="difflineminus">-//	status = write_stream(p_ap_encode_env, </span>
<a href="#l6.75"></a><span id="l6.75" class="difflineplus">+//	status = write_stream(p_ap_encode_env,</span>
<a href="#l6.76"></a><span id="l6.76"> //						tmpstr,</span>
<a href="#l6.77"></a><span id="l6.77"> //						strlen(tmpstr));</span>
<a href="#l6.78"></a><span id="l6.78"> //	if (status != noErr)</span>
<a href="#l6.79"></a><span id="l6.79"> //		return status;</span>
<a href="#l6.80"></a><span id="l6.80"> </span>
<a href="#l6.81"></a><span id="l6.81"> 	PR_snprintf(tmpstr, sizeof(tmpstr),</span>
<a href="#l6.82"></a><span id="l6.82"> 			&quot;Content-Type: multipart/appledouble; boundary=\&quot;=\&quot;; name=\&quot;&quot;);</span>
<a href="#l6.83"></a><span id="l6.83"> 	status = write_stream(p_ap_encode_obj, (const char*)tmpstr, strlen(tmpstr));</span>
<a href="#l6.84"></a><span id="l6.84" class="difflineat">@@ -102,29 +102,29 @@ int fill_apple_mime_header(</span>
<a href="#l6.85"></a><span id="l6.85"> 		</span>
<a href="#l6.86"></a><span id="l6.86"> 	PR_snprintf(tmpstr, sizeof(tmpstr),</span>
<a href="#l6.87"></a><span id="l6.87"> 			&quot;\&quot;\r\nContent-Disposition: inline; filename=\&quot;%s\&quot;\r\n\r\n\r\n--=\r\n&quot;,</span>
<a href="#l6.88"></a><span id="l6.88"> 			p_ap_encode_obj-&gt;fname);</span>
<a href="#l6.89"></a><span id="l6.89"> #endif /* 0 */</span>
<a href="#l6.90"></a><span id="l6.90"> 	PR_snprintf(tmpstr, sizeof(tmpstr), &quot;--%s&quot; CRLF, p_ap_encode_obj-&gt;boundary);</span>
<a href="#l6.91"></a><span id="l6.91"> 	status = write_stream(p_ap_encode_obj, (const char*)tmpstr, strlen(tmpstr));</span>
<a href="#l6.92"></a><span id="l6.92"> 	return status;</span>
<a href="#l6.93"></a><span id="l6.93" class="difflineminus">-} </span>
<a href="#l6.94"></a><span id="l6.94" class="difflineplus">+}</span>
<a href="#l6.95"></a><span id="l6.95"> </span>
<a href="#l6.96"></a><span id="l6.96"> int ap_encode_file_infor(</span>
<a href="#l6.97"></a><span id="l6.97"> 	appledouble_encode_object *p_ap_encode_obj)</span>
<a href="#l6.98"></a><span id="l6.98"> {</span>
<a href="#l6.99"></a><span id="l6.99"> 	ap_header	head;</span>
<a href="#l6.100"></a><span id="l6.100"> 	ap_entry 	entries[NUM_ENTRIES];</span>
<a href="#l6.101"></a><span id="l6.101"> 	ap_dates 	dates;</span>
<a href="#l6.102"></a><span id="l6.102"> 	short 		i;</span>
<a href="#l6.103"></a><span id="l6.103"> 	long 		comlen;</span>
<a href="#l6.104"></a><span id="l6.104"> 	char 		comment[256];</span>
<a href="#l6.105"></a><span id="l6.105"> 	int	 		status;</span>
<a href="#l6.106"></a><span id="l6.106" class="difflineminus">-    </span>
<a href="#l6.107"></a><span id="l6.107" class="difflineplus">+</span>
<a href="#l6.108"></a><span id="l6.108">     nsCOMPtr &lt;nsIFile&gt; resFile;</span>
<a href="#l6.109"></a><span id="l6.109">     NS_NewNativeLocalFile(nsDependentCString(p_ap_encode_obj-&gt;fname), true,</span>
<a href="#l6.110"></a><span id="l6.110">                           getter_AddRefs(resFile));</span>
<a href="#l6.111"></a><span id="l6.111">     if (!resFile)</span>
<a href="#l6.112"></a><span id="l6.112">         return errFileOpen;</span>
<a href="#l6.113"></a><span id="l6.113"> </span>
<a href="#l6.114"></a><span id="l6.114">     FSRef ref;</span>
<a href="#l6.115"></a><span id="l6.115">     nsCOMPtr &lt;nsILocalFileMac&gt; macFile = do_QueryInterface(resFile);</span>
<a href="#l6.116"></a><span id="l6.116" class="difflineat">@@ -151,28 +151,28 @@ int ap_encode_file_infor(</span>
<a href="#l6.117"></a><span id="l6.117"> 	memset((void *) &amp;vinfo, '\0', sizeof (vinfo));</span>
<a href="#l6.118"></a><span id="l6.118"> 	GetVolParmsInfoBuffer vp;</span>
<a href="#l6.119"></a><span id="l6.119"> 	vinfo.ioCompletion  = nil;</span>
<a href="#l6.120"></a><span id="l6.120"> 	vinfo.ioVRefNum 	= fpb-&gt;ioVRefNum;</span>
<a href="#l6.121"></a><span id="l6.121"> 	vinfo.ioBuffer 		= (Ptr) &amp;vp;</span>
<a href="#l6.122"></a><span id="l6.122"> 	vinfo.ioReqCount 	= sizeof (vp);</span>
<a href="#l6.123"></a><span id="l6.123"> 	comlen = 0;</span>
<a href="#l6.124"></a><span id="l6.124"> 	if (PBHGetVolParmsSync((HParmBlkPtr) &amp;vinfo) == noErr &amp;&amp;</span>
<a href="#l6.125"></a><span id="l6.125" class="difflineminus">-		((vp.vMAttrib &gt;&gt; bHasDesktopMgr) &amp; 1)) </span>
<a href="#l6.126"></a><span id="l6.126" class="difflineplus">+		((vp.vMAttrib &gt;&gt; bHasDesktopMgr) &amp; 1))</span>
<a href="#l6.127"></a><span id="l6.127"> 	{</span>
<a href="#l6.128"></a><span id="l6.128"> 		DTPBRec 	dtp;</span>
<a href="#l6.129"></a><span id="l6.129"> 		memset((void *) &amp;dtp, '\0', sizeof (dtp));</span>
<a href="#l6.130"></a><span id="l6.130"> 		dtp.ioVRefNum = fpb-&gt;ioVRefNum;</span>
<a href="#l6.131"></a><span id="l6.131" class="difflineminus">-		if (PBDTGetPath(&amp;dtp) == noErr) </span>
<a href="#l6.132"></a><span id="l6.132" class="difflineplus">+		if (PBDTGetPath(&amp;dtp) == noErr)</span>
<a href="#l6.133"></a><span id="l6.133"> 		{</span>
<a href="#l6.134"></a><span id="l6.134"> 			dtp.ioCompletion = nil;</span>
<a href="#l6.135"></a><span id="l6.135"> 			dtp.ioDTBuffer = (Ptr) comment;</span>
<a href="#l6.136"></a><span id="l6.136"> 			dtp.ioNamePtr  = fpb-&gt;ioNamePtr;</span>
<a href="#l6.137"></a><span id="l6.137"> 			dtp.ioDirID    = fpb-&gt;ioFlParID;</span>
<a href="#l6.138"></a><span id="l6.138" class="difflineminus">-			if (PBDTGetCommentSync(&amp;dtp) == noErr) </span>
<a href="#l6.139"></a><span id="l6.139" class="difflineplus">+			if (PBDTGetCommentSync(&amp;dtp) == noErr)</span>
<a href="#l6.140"></a><span id="l6.140"> 				comlen = dtp.ioDTActCount;</span>
<a href="#l6.141"></a><span id="l6.141"> 		}</span>
<a href="#l6.142"></a><span id="l6.142"> 	}</span>
<a href="#l6.143"></a><span id="l6.143"> #endif /* ! 1 */</span>
<a href="#l6.144"></a><span id="l6.144"> 	</span>
<a href="#l6.145"></a><span id="l6.145"> 	/* write header */</span>
<a href="#l6.146"></a><span id="l6.146"> //	head.magic = dfork ? APPLESINGLE_MAGIC : APPLEDOUBLE_MAGIC;</span>
<a href="#l6.147"></a><span id="l6.147"> 	head.magic   = APPLEDOUBLE_MAGIC;		/* always do apple double */</span>
<a href="#l6.148"></a><span id="l6.148" class="difflineat">@@ -198,54 +198,54 @@ int ap_encode_file_infor(</span>
<a href="#l6.149"></a><span id="l6.149"> 	entries[3].id 	= ENT_COMMENT;</span>
<a href="#l6.150"></a><span id="l6.150"> 	entries[3].length = comlen;</span>
<a href="#l6.151"></a><span id="l6.151"> 	entries[4].id 	= ENT_RFORK;</span>
<a href="#l6.152"></a><span id="l6.152">     entries[4].length = catalogInfo.rsrcLogicalSize;</span>
<a href="#l6.153"></a><span id="l6.153"> 	entries[5].id 	= ENT_DFORK;</span>
<a href="#l6.154"></a><span id="l6.154">     entries[5].length = catalogInfo.dataLogicalSize;</span>
<a href="#l6.155"></a><span id="l6.155"> </span>
<a href="#l6.156"></a><span id="l6.156"> 	/* correct the link in the entries. */</span>
<a href="#l6.157"></a><span id="l6.157" class="difflineminus">-	for (i = 1; i &lt; NUM_ENTRIES; ++i) </span>
<a href="#l6.158"></a><span id="l6.158" class="difflineplus">+	for (i = 1; i &lt; NUM_ENTRIES; ++i)</span>
<a href="#l6.159"></a><span id="l6.159"> 	{</span>
<a href="#l6.160"></a><span id="l6.160"> 		entries[i].offset = entries[i-1].offset + entries[i-1].length;</span>
<a href="#l6.161"></a><span id="l6.161"> 	}</span>
<a href="#l6.162"></a><span id="l6.162"> 	status = to64(p_ap_encode_obj,</span>
<a href="#l6.163"></a><span id="l6.163"> 					(char *) entries,</span>
<a href="#l6.164"></a><span id="l6.164" class="difflineminus">-					sizeof (ap_entry) * head.entries); </span>
<a href="#l6.165"></a><span id="l6.165" class="difflineplus">+					sizeof (ap_entry) * head.entries);</span>
<a href="#l6.166"></a><span id="l6.166"> 	if (status != noErr)</span>
<a href="#l6.167"></a><span id="l6.167"> 		return status;</span>
<a href="#l6.168"></a><span id="l6.168"> </span>
<a href="#l6.169"></a><span id="l6.169"> 	/* write name */</span>
<a href="#l6.170"></a><span id="l6.170"> 	status = to64(p_ap_encode_obj,</span>
<a href="#l6.171"></a><span id="l6.171"> 					(char *) leafname.get(),</span>
<a href="#l6.172"></a><span id="l6.172" class="difflineminus">-					leafname.Length()); </span>
<a href="#l6.173"></a><span id="l6.173" class="difflineplus">+					leafname.Length());</span>
<a href="#l6.174"></a><span id="l6.174"> 	if (status != noErr)</span>
<a href="#l6.175"></a><span id="l6.175"> 		return status;</span>
<a href="#l6.176"></a><span id="l6.176"> 	</span>
<a href="#l6.177"></a><span id="l6.177"> 	/* write finder info */</span>
<a href="#l6.178"></a><span id="l6.178"> 	status = to64(p_ap_encode_obj,</span>
<a href="#l6.179"></a><span id="l6.179"> 					(char *) &amp;catalogInfo.finderInfo,</span>
<a href="#l6.180"></a><span id="l6.180"> 					sizeof (FInfo));</span>
<a href="#l6.181"></a><span id="l6.181"> 	if (status != noErr)</span>
<a href="#l6.182"></a><span id="l6.182"> 		return status;</span>
<a href="#l6.183"></a><span id="l6.183" class="difflineminus">-					  </span>
<a href="#l6.184"></a><span id="l6.184" class="difflineplus">+					</span>
<a href="#l6.185"></a><span id="l6.185"> 	status = to64(p_ap_encode_obj,</span>
<a href="#l6.186"></a><span id="l6.186"> 					(char *) &amp;catalogInfo.extFinderInfo,</span>
<a href="#l6.187"></a><span id="l6.187"> 					sizeof (FXInfo));</span>
<a href="#l6.188"></a><span id="l6.188"> 	if (status != noErr)</span>
<a href="#l6.189"></a><span id="l6.189"> 		return status;</span>
<a href="#l6.190"></a><span id="l6.190"> </span>
<a href="#l6.191"></a><span id="l6.191"> 	/* write dates */</span>
<a href="#l6.192"></a><span id="l6.192">     dates.create = catalogInfo.createDate.lowSeconds + CONVERT_TIME;</span>
<a href="#l6.193"></a><span id="l6.193">     dates.modify = catalogInfo.contentModDate.lowSeconds + CONVERT_TIME;</span>
<a href="#l6.194"></a><span id="l6.194">     dates.backup = catalogInfo.backupDate.lowSeconds + CONVERT_TIME;</span>
<a href="#l6.195"></a><span id="l6.195">     dates.access = catalogInfo.accessDate.lowSeconds + CONVERT_TIME;</span>
<a href="#l6.196"></a><span id="l6.196"> 	status = to64(p_ap_encode_obj,</span>
<a href="#l6.197"></a><span id="l6.197"> 					(char *) &amp;dates,</span>
<a href="#l6.198"></a><span id="l6.198" class="difflineminus">-					sizeof (ap_dates)); </span>
<a href="#l6.199"></a><span id="l6.199" class="difflineplus">+					sizeof (ap_dates));</span>
<a href="#l6.200"></a><span id="l6.200"> 	if (status != noErr)</span>
<a href="#l6.201"></a><span id="l6.201"> 		return status;</span>
<a href="#l6.202"></a><span id="l6.202"> 	</span>
<a href="#l6.203"></a><span id="l6.203"> 	/* write comment */</span>
<a href="#l6.204"></a><span id="l6.204"> 	if (comlen)</span>
<a href="#l6.205"></a><span id="l6.205"> 	{</span>
<a href="#l6.206"></a><span id="l6.206"> 		status = to64(p_ap_encode_obj,</span>
<a href="#l6.207"></a><span id="l6.207"> 					comment,</span>
<a href="#l6.208"></a><span id="l6.208" class="difflineat">@@ -264,34 +264,34 @@ int ap_encode_file_infor(</span>
<a href="#l6.209"></a><span id="l6.209"> }</span>
<a href="#l6.210"></a><span id="l6.210"> /*</span>
<a href="#l6.211"></a><span id="l6.211"> **	ap_encode_header</span>
<a href="#l6.212"></a><span id="l6.212"> **</span>
<a href="#l6.213"></a><span id="l6.213"> **		encode the file header and the resource fork.</span>
<a href="#l6.214"></a><span id="l6.214"> **</span>
<a href="#l6.215"></a><span id="l6.215"> */</span>
<a href="#l6.216"></a><span id="l6.216"> int ap_encode_header(</span>
<a href="#l6.217"></a><span id="l6.217" class="difflineminus">-	appledouble_encode_object* p_ap_encode_obj, </span>
<a href="#l6.218"></a><span id="l6.218" class="difflineplus">+	appledouble_encode_object* p_ap_encode_obj,</span>
<a href="#l6.219"></a><span id="l6.219"> 	bool    firstime)</span>
<a href="#l6.220"></a><span id="l6.220"> {</span>
<a href="#l6.221"></a><span id="l6.221"> 	char   	rd_buff[256];</span>
<a href="#l6.222"></a><span id="l6.222">     FSIORefNum fileId;</span>
<a href="#l6.223"></a><span id="l6.223"> 	OSErr	retval = noErr;</span>
<a href="#l6.224"></a><span id="l6.224"> 	int    	status;</span>
<a href="#l6.225"></a><span id="l6.225">     ByteCount inCount;</span>
<a href="#l6.226"></a><span id="l6.226"> 	</span>
<a href="#l6.227"></a><span id="l6.227"> 	if (firstime)</span>
<a href="#l6.228"></a><span id="l6.228"> 	{</span>
<a href="#l6.229"></a><span id="l6.229" class="difflineminus">-    PL_strcpy(rd_buff, </span>
<a href="#l6.230"></a><span id="l6.230" class="difflineplus">+    PL_strcpy(rd_buff,</span>
<a href="#l6.231"></a><span id="l6.231"> 			&quot;Content-Type: application/applefile\r\nContent-Transfer-Encoding: base64\r\n\r\n&quot;);</span>
<a href="#l6.232"></a><span id="l6.232"> 		status = write_stream(p_ap_encode_obj, (const char*)rd_buff, strlen(rd_buff));</span>
<a href="#l6.233"></a><span id="l6.233"> 		if (status != noErr)</span>
<a href="#l6.234"></a><span id="l6.234"> 			return status;</span>
<a href="#l6.235"></a><span id="l6.235"> 			</span>
<a href="#l6.236"></a><span id="l6.236" class="difflineminus">-		status = ap_encode_file_infor(p_ap_encode_obj); </span>
<a href="#l6.237"></a><span id="l6.237" class="difflineplus">+		status = ap_encode_file_infor(p_ap_encode_obj);</span>
<a href="#l6.238"></a><span id="l6.238"> 		if (status != noErr)</span>
<a href="#l6.239"></a><span id="l6.239"> 			return status;</span>
<a href="#l6.240"></a><span id="l6.240"> 		</span>
<a href="#l6.241"></a><span id="l6.241"> 		/*</span>
<a href="#l6.242"></a><span id="l6.242"> 		** preparing to encode the resource fork.</span>
<a href="#l6.243"></a><span id="l6.243"> 		*/</span>
<a href="#l6.244"></a><span id="l6.244">         nsCOMPtr &lt;nsIFile&gt; myFile;</span>
<a href="#l6.245"></a><span id="l6.245">         NS_NewNativeLocalFile(nsDependentCString(p_ap_encode_obj-&gt;fname), true, getter_AddRefs(myFile));</span>
<a href="#l6.246"></a><span id="l6.246" class="difflineat">@@ -333,20 +333,20 @@ int ap_encode_header(</span>
<a href="#l6.247"></a><span id="l6.247">         ::FSCloseFork(fileId);</span>
<a href="#l6.248"></a><span id="l6.248">         p_ap_encode_obj-&gt;fileId = 0;</span>
<a href="#l6.249"></a><span id="l6.249"> </span>
<a href="#l6.250"></a><span id="l6.250"> 		status = finish64(p_ap_encode_obj);</span>
<a href="#l6.251"></a><span id="l6.251"> 		if (status != noErr)</span>
<a href="#l6.252"></a><span id="l6.252"> 			return status;</span>
<a href="#l6.253"></a><span id="l6.253"> 		</span>
<a href="#l6.254"></a><span id="l6.254"> 		/*</span>
<a href="#l6.255"></a><span id="l6.255" class="difflineminus">-		** write out the boundary </span>
<a href="#l6.256"></a><span id="l6.256" class="difflineplus">+		** write out the boundary</span>
<a href="#l6.257"></a><span id="l6.257"> 		*/</span>
<a href="#l6.258"></a><span id="l6.258"> 		PR_snprintf(rd_buff, sizeof(rd_buff),</span>
<a href="#l6.259"></a><span id="l6.259" class="difflineminus">-						CRLF &quot;--%s&quot; CRLF, </span>
<a href="#l6.260"></a><span id="l6.260" class="difflineplus">+						CRLF &quot;--%s&quot; CRLF,</span>
<a href="#l6.261"></a><span id="l6.261"> 						p_ap_encode_obj-&gt;boundary);</span>
<a href="#l6.262"></a><span id="l6.262"> 					</span>
<a href="#l6.263"></a><span id="l6.263"> 		status = write_stream(p_ap_encode_obj, (const char*)rd_buff, strlen(rd_buff));</span>
<a href="#l6.264"></a><span id="l6.264"> 		if (status == noErr)</span>
<a href="#l6.265"></a><span id="l6.265"> 			status = errDone;</span>
<a href="#l6.266"></a><span id="l6.266"> 	}</span>
<a href="#l6.267"></a><span id="l6.267"> 	return status;</span>
<a href="#l6.268"></a><span id="l6.268"> }</span>
<a href="#l6.269"></a><span id="l6.269" class="difflineat">@@ -385,48 +385,48 @@ static const char *default_type = APPLIC</span>
<a href="#l6.270"></a><span id="l6.270"> /*</span>
<a href="#l6.271"></a><span id="l6.271">  * Determins the format of the file &quot;inputf&quot;.  The name</span>
<a href="#l6.272"></a><span id="l6.272">  * of the file format (or NULL on error) is returned.</span>
<a href="#l6.273"></a><span id="l6.273">  */</span>
<a href="#l6.274"></a><span id="l6.274"> static const char *magic_look(char *inbuff, int numread)</span>
<a href="#l6.275"></a><span id="l6.275"> {</span>
<a href="#l6.276"></a><span id="l6.276">     int i, j;</span>
<a href="#l6.277"></a><span id="l6.277"> </span>
<a href="#l6.278"></a><span id="l6.278" class="difflineminus">-	for (i=0; i&lt;num_magic; i++) </span>
<a href="#l6.279"></a><span id="l6.279" class="difflineplus">+	for (i=0; i&lt;num_magic; i++)</span>
<a href="#l6.280"></a><span id="l6.280"> 	{</span>
<a href="#l6.281"></a><span id="l6.281" class="difflineminus">-	   	if (magic[i].len == 0) </span>
<a href="#l6.282"></a><span id="l6.282" class="difflineplus">+	   	if (magic[i].len == 0)</span>
<a href="#l6.283"></a><span id="l6.283"> 	   		magic[i].len = strlen(magic[i].num);</span>
<a href="#l6.284"></a><span id="l6.284"> 	}</span>
<a href="#l6.285"></a><span id="l6.285"> </span>
<a href="#l6.286"></a><span id="l6.286" class="difflineminus">-    for (i=0; i&lt;num_magic; i++) </span>
<a href="#l6.287"></a><span id="l6.287" class="difflineplus">+    for (i=0; i&lt;num_magic; i++)</span>
<a href="#l6.288"></a><span id="l6.288">     {</span>
<a href="#l6.289"></a><span id="l6.289" class="difflineminus">-		if (numread &gt;= magic[i].len) </span>
<a href="#l6.290"></a><span id="l6.290" class="difflineplus">+		if (numread &gt;= magic[i].len)</span>
<a href="#l6.291"></a><span id="l6.291"> 		{</span>
<a href="#l6.292"></a><span id="l6.292" class="difflineminus">-	    	for (j=0; j&lt;magic[i].len; j++) </span>
<a href="#l6.293"></a><span id="l6.293" class="difflineplus">+	    	for (j=0; j&lt;magic[i].len; j++)</span>
<a href="#l6.294"></a><span id="l6.294"> 	    	{</span>
<a href="#l6.295"></a><span id="l6.295"> 				if (inbuff[j] != magic[i].num[j]) break;</span>
<a href="#l6.296"></a><span id="l6.296"> 	    	}</span>
<a href="#l6.297"></a><span id="l6.297"> 	    	</span>
<a href="#l6.298"></a><span id="l6.298" class="difflineminus">-	    	if (j == magic[i].len) </span>
<a href="#l6.299"></a><span id="l6.299" class="difflineplus">+	    	if (j == magic[i].len)</span>
<a href="#l6.300"></a><span id="l6.300"> 	    		return magic[i].name;</span>
<a href="#l6.301"></a><span id="l6.301"> 		}</span>
<a href="#l6.302"></a><span id="l6.302">     }</span>
<a href="#l6.303"></a><span id="l6.303"> </span>
<a href="#l6.304"></a><span id="l6.304">     return default_type;</span>
<a href="#l6.305"></a><span id="l6.305"> }</span>
<a href="#l6.306"></a><span id="l6.306"> /*</span>
<a href="#l6.307"></a><span id="l6.307"> **	ap_encode_data</span>
<a href="#l6.308"></a><span id="l6.308"> **</span>
<a href="#l6.309"></a><span id="l6.309"> **	---------------</span>
<a href="#l6.310"></a><span id="l6.310"> **</span>
<a href="#l6.311"></a><span id="l6.311"> **		encode on the data fork.</span>
<a href="#l6.312"></a><span id="l6.312"> **</span>
<a href="#l6.313"></a><span id="l6.313"> */</span>
<a href="#l6.314"></a><span id="l6.314"> int ap_encode_data(</span>
<a href="#l6.315"></a><span id="l6.315" class="difflineminus">-	appledouble_encode_object* p_ap_encode_obj, </span>
<a href="#l6.316"></a><span id="l6.316" class="difflineplus">+	appledouble_encode_object* p_ap_encode_obj,</span>
<a href="#l6.317"></a><span id="l6.317"> 	bool firstime)</span>
<a href="#l6.318"></a><span id="l6.318"> {</span>
<a href="#l6.319"></a><span id="l6.319"> 	char   		rd_buff[256];</span>
<a href="#l6.320"></a><span id="l6.320">     FSIORefNum fileId;</span>
<a href="#l6.321"></a><span id="l6.321"> 	OSErr		retval = noErr;</span>
<a href="#l6.322"></a><span id="l6.322">     ByteCount in_count;</span>
<a href="#l6.323"></a><span id="l6.323"> 	int			status;</span>
<a href="#l6.324"></a><span id="l6.324"> 	</span>
<a href="#l6.325"></a><span id="l6.325" class="difflineat">@@ -460,18 +460,18 @@ int ap_encode_data(</span>
<a href="#l6.326"></a><span id="l6.326"> 		if (!p_ap_encode_obj-&gt;text_file_type)</span>
<a href="#l6.327"></a><span id="l6.327"> 		{	</span>
<a href="#l6.328"></a><span id="l6.328">       /*</span>
<a href="#l6.329"></a><span id="l6.329">       **	do a smart check for the file type.</span>
<a href="#l6.330"></a><span id="l6.330">       */</span>
<a href="#l6.331"></a><span id="l6.331">       in_count = 0;</span>
<a href="#l6.332"></a><span id="l6.332">       retval = ::FSReadFork(fileId, fsFromStart, 0, 256, rd_buff, &amp;in_count);</span>
<a href="#l6.333"></a><span id="l6.333">       magic_type = magic_look(rd_buff, in_count);</span>
<a href="#l6.334"></a><span id="l6.334" class="difflineminus">-      </span>
<a href="#l6.335"></a><span id="l6.335" class="difflineminus">-      /* don't forget to rewind the index to start point. */ </span>
<a href="#l6.336"></a><span id="l6.336" class="difflineplus">+</span>
<a href="#l6.337"></a><span id="l6.337" class="difflineplus">+      /* don't forget to rewind the index to start point. */</span>
<a href="#l6.338"></a><span id="l6.338">       ::FSSetForkPosition(fileId, fsFromStart, 0);</span>
<a href="#l6.339"></a><span id="l6.339">       /* and reset retVal just in case... */</span>
<a href="#l6.340"></a><span id="l6.340">       if (retval == eofErr)</span>
<a href="#l6.341"></a><span id="l6.341">         retval = noErr;</span>
<a href="#l6.342"></a><span id="l6.342"> 		}</span>
<a href="#l6.343"></a><span id="l6.343"> 		else</span>
<a href="#l6.344"></a><span id="l6.344"> 		{</span>
<a href="#l6.345"></a><span id="l6.345"> 			magic_type = text_type;		/* we already know it is a text type.	*/</span>
<a href="#l6.346"></a><span id="l6.346" class="difflineat">@@ -521,43 +521,43 @@ int ap_encode_data(</span>
<a href="#l6.347"></a><span id="l6.347"> </span>
<a href="#l6.348"></a><span id="l6.348"> 		status = finish64(p_ap_encode_obj);</span>
<a href="#l6.349"></a><span id="l6.349"> 		if (status != noErr)</span>
<a href="#l6.350"></a><span id="l6.350"> 			return status;</span>
<a href="#l6.351"></a><span id="l6.351"> 		</span>
<a href="#l6.352"></a><span id="l6.352"> 		/* write out the boundary 	*/</span>
<a href="#l6.353"></a><span id="l6.353"> 		</span>
<a href="#l6.354"></a><span id="l6.354"> 		PR_snprintf(rd_buff, sizeof(rd_buff),</span>
<a href="#l6.355"></a><span id="l6.355" class="difflineminus">-						CRLF &quot;--%s--&quot; CRLF CRLF, </span>
<a href="#l6.356"></a><span id="l6.356" class="difflineplus">+						CRLF &quot;--%s--&quot; CRLF CRLF,</span>
<a href="#l6.357"></a><span id="l6.357"> 						p_ap_encode_obj-&gt;boundary);</span>
<a href="#l6.358"></a><span id="l6.358"> 	</span>
<a href="#l6.359"></a><span id="l6.359"> 		status = write_stream(p_ap_encode_obj, (const char*)rd_buff, strlen(rd_buff));</span>
<a href="#l6.360"></a><span id="l6.360"> 	</span>
<a href="#l6.361"></a><span id="l6.361"> 		if (status == noErr)				</span>
<a href="#l6.362"></a><span id="l6.362"> 			status = errDone;</span>
<a href="#l6.363"></a><span id="l6.363"> 	}</span>
<a href="#l6.364"></a><span id="l6.364"> 	return status;</span>
<a href="#l6.365"></a><span id="l6.365"> }</span>
<a href="#l6.366"></a><span id="l6.366"> </span>
<a href="#l6.367"></a><span id="l6.367"> static char basis_64[] =</span>
<a href="#l6.368"></a><span id="l6.368">    &quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/&quot;;</span>
<a href="#l6.369"></a><span id="l6.369"> </span>
<a href="#l6.370"></a><span id="l6.370" class="difflineminus">-/* </span>
<a href="#l6.371"></a><span id="l6.371" class="difflineplus">+/*</span>
<a href="#l6.372"></a><span id="l6.372"> **	convert the stream in the inbuff to 64 format and put it in the out buff.</span>
<a href="#l6.373"></a><span id="l6.373"> **  To make the life easier, the caller will responcable of the cheking of the outbuff's bundary.</span>
<a href="#l6.374"></a><span id="l6.374"> */</span>
<a href="#l6.375"></a><span id="l6.375" class="difflineminus">-static int </span>
<a href="#l6.376"></a><span id="l6.376" class="difflineminus">-to64(appledouble_encode_object* p_ap_encode_obj, </span>
<a href="#l6.377"></a><span id="l6.377" class="difflineminus">-	char	*p, </span>
<a href="#l6.378"></a><span id="l6.378" class="difflineminus">-	int 	in_size) </span>
<a href="#l6.379"></a><span id="l6.379" class="difflineplus">+static int</span>
<a href="#l6.380"></a><span id="l6.380" class="difflineplus">+to64(appledouble_encode_object* p_ap_encode_obj,</span>
<a href="#l6.381"></a><span id="l6.381" class="difflineplus">+	char	*p,</span>
<a href="#l6.382"></a><span id="l6.382" class="difflineplus">+	int 	in_size)</span>
<a href="#l6.383"></a><span id="l6.383"> {</span>
<a href="#l6.384"></a><span id="l6.384"> 	int 	status;</span>
<a href="#l6.385"></a><span id="l6.385">     int c1, c2, c3, ct;</span>
<a href="#l6.386"></a><span id="l6.386">     unsigned char *inbuff = (unsigned char*)p;</span>
<a href="#l6.387"></a><span id="l6.387" class="difflineminus">-    </span>
<a href="#l6.388"></a><span id="l6.388" class="difflineplus">+</span>
<a href="#l6.389"></a><span id="l6.389"> 	ct = p_ap_encode_obj-&gt;ct;			/* the char count left last time. */</span>
<a href="#l6.390"></a><span id="l6.390"> 	</span>
<a href="#l6.391"></a><span id="l6.391"> 	/*</span>
<a href="#l6.392"></a><span id="l6.392"> 	**	 resume the left state of the last conversion.</span>
<a href="#l6.393"></a><span id="l6.393"> 	*/</span>
<a href="#l6.394"></a><span id="l6.394"> 	switch (p_ap_encode_obj-&gt;state64)</span>
<a href="#l6.395"></a><span id="l6.395"> 	{</span>
<a href="#l6.396"></a><span id="l6.396"> 		case 0:</span>
<a href="#l6.397"></a><span id="l6.397" class="difflineat">@@ -587,31 +587,31 @@ to64(appledouble_encode_object* p_ap_enc</span>
<a href="#l6.398"></a><span id="l6.398"> 			break;</span>
<a href="#l6.399"></a><span id="l6.399"> 		case 2:</span>
<a href="#l6.400"></a><span id="l6.400"> 			c1 = p_ap_encode_obj-&gt;c1;</span>
<a href="#l6.401"></a><span id="l6.401"> 			c2 = p_ap_encode_obj-&gt;c2;</span>
<a href="#l6.402"></a><span id="l6.402"> 			c3 = *inbuff ++;		--in_size;</span>
<a href="#l6.403"></a><span id="l6.403"> 			break;</span>
<a href="#l6.404"></a><span id="l6.404"> 	}</span>
<a href="#l6.405"></a><span id="l6.405"> 	</span>
<a href="#l6.406"></a><span id="l6.406" class="difflineminus">-    while (in_size &gt;= 0) </span>
<a href="#l6.407"></a><span id="l6.407" class="difflineplus">+    while (in_size &gt;= 0)</span>
<a href="#l6.408"></a><span id="l6.408">     {</span>
<a href="#l6.409"></a><span id="l6.409" class="difflineminus">-    	status = output64chunk(p_ap_encode_obj, </span>
<a href="#l6.410"></a><span id="l6.410" class="difflineminus">-    							c1, </span>
<a href="#l6.411"></a><span id="l6.411" class="difflineminus">-    							c2, </span>
<a href="#l6.412"></a><span id="l6.412" class="difflineminus">-    							c3, </span>
<a href="#l6.413"></a><span id="l6.413" class="difflineplus">+    	status = output64chunk(p_ap_encode_obj,</span>
<a href="#l6.414"></a><span id="l6.414" class="difflineplus">+    							c1,</span>
<a href="#l6.415"></a><span id="l6.415" class="difflineplus">+    							c2,</span>
<a href="#l6.416"></a><span id="l6.416" class="difflineplus">+    							c3,</span>
<a href="#l6.417"></a><span id="l6.417">     							0);</span>
<a href="#l6.418"></a><span id="l6.418">     	if (status != noErr)</span>
<a href="#l6.419"></a><span id="l6.419">     		return status;</span>
<a href="#l6.420"></a><span id="l6.420">     		</span>
<a href="#l6.421"></a><span id="l6.421">     	ct += 4;</span>
<a href="#l6.422"></a><span id="l6.422" class="difflineminus">-        if (ct &gt; 71) </span>
<a href="#l6.423"></a><span id="l6.423" class="difflineminus">-        { </span>
<a href="#l6.424"></a><span id="l6.424" class="difflineminus">-        	status = write_stream(p_ap_encode_obj, </span>
<a href="#l6.425"></a><span id="l6.425" class="difflineminus">-        						CRLF, </span>
<a href="#l6.426"></a><span id="l6.426" class="difflineplus">+        if (ct &gt; 71)</span>
<a href="#l6.427"></a><span id="l6.427" class="difflineplus">+        {</span>
<a href="#l6.428"></a><span id="l6.428" class="difflineplus">+        	status = write_stream(p_ap_encode_obj,</span>
<a href="#l6.429"></a><span id="l6.429" class="difflineplus">+        						CRLF,</span>
<a href="#l6.430"></a><span id="l6.430">         						2);</span>
<a href="#l6.431"></a><span id="l6.431">         	if (status != noErr)</span>
<a href="#l6.432"></a><span id="l6.432">         		return status;</span>
<a href="#l6.433"></a><span id="l6.433">         		</span>
<a href="#l6.434"></a><span id="l6.434">             ct = 0;</span>
<a href="#l6.435"></a><span id="l6.435">         }</span>
<a href="#l6.436"></a><span id="l6.436"> </span>
<a href="#l6.437"></a><span id="l6.437"> 		if (in_size &lt;= 0)</span>
<a href="#l6.438"></a><span id="l6.438" class="difflineat">@@ -640,64 +640,64 @@ to64(appledouble_encode_object* p_ap_enc</span>
<a href="#l6.439"></a><span id="l6.439">     }</span>
<a href="#l6.440"></a><span id="l6.440">     p_ap_encode_obj-&gt;ct = ct;</span>
<a href="#l6.441"></a><span id="l6.441">     return status;</span>
<a href="#l6.442"></a><span id="l6.442"> }</span>
<a href="#l6.443"></a><span id="l6.443"> </span>
<a href="#l6.444"></a><span id="l6.444"> /*</span>
<a href="#l6.445"></a><span id="l6.445"> ** clear the left base64 encodes.</span>
<a href="#l6.446"></a><span id="l6.446"> */</span>
<a href="#l6.447"></a><span id="l6.447" class="difflineminus">-static int </span>
<a href="#l6.448"></a><span id="l6.448" class="difflineplus">+static int</span>
<a href="#l6.449"></a><span id="l6.449"> finish64(appledouble_encode_object* p_ap_encode_obj)</span>
<a href="#l6.450"></a><span id="l6.450"> {</span>
<a href="#l6.451"></a><span id="l6.451"> 	int status;</span>
<a href="#l6.452"></a><span id="l6.452"> 	</span>
<a href="#l6.453"></a><span id="l6.453"> 	switch (p_ap_encode_obj-&gt;state64)</span>
<a href="#l6.454"></a><span id="l6.454"> 	{</span>
<a href="#l6.455"></a><span id="l6.455"> 		case 0:</span>
<a href="#l6.456"></a><span id="l6.456"> 			break;</span>
<a href="#l6.457"></a><span id="l6.457"> 		case 1:</span>
<a href="#l6.458"></a><span id="l6.458" class="difflineminus">-			status = output64chunk(p_ap_encode_obj, </span>
<a href="#l6.459"></a><span id="l6.459" class="difflineminus">-									p_ap_encode_obj-&gt;c1, </span>
<a href="#l6.460"></a><span id="l6.460" class="difflineminus">-									0, </span>
<a href="#l6.461"></a><span id="l6.461" class="difflineminus">-									0, </span>
<a href="#l6.462"></a><span id="l6.462" class="difflineplus">+			status = output64chunk(p_ap_encode_obj,</span>
<a href="#l6.463"></a><span id="l6.463" class="difflineplus">+									p_ap_encode_obj-&gt;c1,</span>
<a href="#l6.464"></a><span id="l6.464" class="difflineplus">+									0,</span>
<a href="#l6.465"></a><span id="l6.465" class="difflineplus">+									0,</span>
<a href="#l6.466"></a><span id="l6.466"> 									2);</span>
<a href="#l6.467"></a><span id="l6.467"> 			break;</span>
<a href="#l6.468"></a><span id="l6.468"> 		case 2:</span>
<a href="#l6.469"></a><span id="l6.469" class="difflineminus">-			status = output64chunk(p_ap_encode_obj, </span>
<a href="#l6.470"></a><span id="l6.470" class="difflineminus">-									p_ap_encode_obj-&gt;c1, </span>
<a href="#l6.471"></a><span id="l6.471" class="difflineminus">-									p_ap_encode_obj-&gt;c2, </span>
<a href="#l6.472"></a><span id="l6.472" class="difflineminus">-									0, </span>
<a href="#l6.473"></a><span id="l6.473" class="difflineplus">+			status = output64chunk(p_ap_encode_obj,</span>
<a href="#l6.474"></a><span id="l6.474" class="difflineplus">+									p_ap_encode_obj-&gt;c1,</span>
<a href="#l6.475"></a><span id="l6.475" class="difflineplus">+									p_ap_encode_obj-&gt;c2,</span>
<a href="#l6.476"></a><span id="l6.476" class="difflineplus">+									0,</span>
<a href="#l6.477"></a><span id="l6.477"> 									1);</span>
<a href="#l6.478"></a><span id="l6.478"> 			break;</span>
<a href="#l6.479"></a><span id="l6.479"> 	}</span>
<a href="#l6.480"></a><span id="l6.480"> 	status = write_stream(p_ap_encode_obj, CRLF, 2);</span>
<a href="#l6.481"></a><span id="l6.481"> 	p_ap_encode_obj-&gt;state64 = 0;</span>
<a href="#l6.482"></a><span id="l6.482"> 	p_ap_encode_obj-&gt;ct	  	 = 0;</span>
<a href="#l6.483"></a><span id="l6.483"> 	return status;</span>
<a href="#l6.484"></a><span id="l6.484"> }</span>
<a href="#l6.485"></a><span id="l6.485"> </span>
<a href="#l6.486"></a><span id="l6.486"> static int output64chunk(</span>
<a href="#l6.487"></a><span id="l6.487" class="difflineminus">-	appledouble_encode_object* p_ap_encode_obj, </span>
<a href="#l6.488"></a><span id="l6.488" class="difflineplus">+	appledouble_encode_object* p_ap_encode_obj,</span>
<a href="#l6.489"></a><span id="l6.489"> 	int c1, int c2, int c3, int pads)</span>
<a href="#l6.490"></a><span id="l6.490"> {</span>
<a href="#l6.491"></a><span id="l6.491"> 	char tmpstr[32];</span>
<a href="#l6.492"></a><span id="l6.492"> 	char *p = tmpstr;</span>
<a href="#l6.493"></a><span id="l6.493"> 	</span>
<a href="#l6.494"></a><span id="l6.494">     *p++ = basis_64[c1&gt;&gt;2];</span>
<a href="#l6.495"></a><span id="l6.495">     *p++ = basis_64[((c1 &amp; 0x3)&lt;&lt; 4) | ((c2 &amp; 0xF0) &gt;&gt; 4)];</span>
<a href="#l6.496"></a><span id="l6.496" class="difflineminus">-    if (pads == 2) </span>
<a href="#l6.497"></a><span id="l6.497" class="difflineplus">+    if (pads == 2)</span>
<a href="#l6.498"></a><span id="l6.498">     {</span>
<a href="#l6.499"></a><span id="l6.499">         *p++ = '=';</span>
<a href="#l6.500"></a><span id="l6.500">         *p++ = '=';</span>
<a href="#l6.501"></a><span id="l6.501" class="difflineminus">-    } </span>
<a href="#l6.502"></a><span id="l6.502" class="difflineminus">-    else if (pads) </span>
<a href="#l6.503"></a><span id="l6.503" class="difflineplus">+    }</span>
<a href="#l6.504"></a><span id="l6.504" class="difflineplus">+    else if (pads)</span>
<a href="#l6.505"></a><span id="l6.505">     {</span>
<a href="#l6.506"></a><span id="l6.506">         *p++ = basis_64[((c2 &amp; 0xF) &lt;&lt; 2) | ((c3 &amp; 0xC0) &gt;&gt;6)];</span>
<a href="#l6.507"></a><span id="l6.507">         *p++ = '=';</span>
<a href="#l6.508"></a><span id="l6.508" class="difflineminus">-    } </span>
<a href="#l6.509"></a><span id="l6.509" class="difflineminus">-    else </span>
<a href="#l6.510"></a><span id="l6.510" class="difflineplus">+    }</span>
<a href="#l6.511"></a><span id="l6.511" class="difflineplus">+    else</span>
<a href="#l6.512"></a><span id="l6.512">     {</span>
<a href="#l6.513"></a><span id="l6.513">         *p++ = basis_64[((c2 &amp; 0xF) &lt;&lt; 2) | ((c3 &amp; 0xC0) &gt;&gt;6)];</span>
<a href="#l6.514"></a><span id="l6.514">         *p++ = basis_64[c3 &amp; 0x3F];</span>
<a href="#l6.515"></a><span id="l6.515">     }</span>
<a href="#l6.516"></a><span id="l6.516">     return write_stream(p_ap_encode_obj, (const char*) tmpstr, p-tmpstr);</span>
<a href="#l6.517"></a><span id="l6.517"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgAttachment.cpp</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgAttachment.cpp</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -251,12 +251,12 @@ nsresult nsMsgAttachment::DeleteAttachme</span>
<a href="#l7.4"></a><span id="l7.4">     {</span>
<a href="#l7.5"></a><span id="l7.5">       rv = urlFile-&gt;IsFile(&amp;isAFile);</span>
<a href="#l7.6"></a><span id="l7.6">       NS_ASSERTION(NS_SUCCEEDED(rv), &quot;IsFile() call failed!&quot;);</span>
<a href="#l7.7"></a><span id="l7.7">     }</span>
<a href="#l7.8"></a><span id="l7.8">   }</span>
<a href="#l7.9"></a><span id="l7.9"> </span>
<a href="#l7.10"></a><span id="l7.10">   // remove it if it's a valid file</span>
<a href="#l7.11"></a><span id="l7.11">   if (isAFile)</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-	  rv = urlFile-&gt;Remove(false); </span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+	  rv = urlFile-&gt;Remove(false);</span>
<a href="#l7.14"></a><span id="l7.14"> </span>
<a href="#l7.15"></a><span id="l7.15">   return rv;</span>
<a href="#l7.16"></a><span id="l7.16"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgAttachmentHandler.cpp</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgAttachmentHandler.cpp</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -49,65 +49,65 @@ extern void         MacGetFileType(nsIFi</span>
<a href="#l8.4"></a><span id="l8.4"> </span>
<a href="#l8.5"></a><span id="l8.5"> /* static */</span>
<a href="#l8.6"></a><span id="l8.6"> nsresult nsSimpleZipper::Zip(nsIFile *aInputFile, nsIFile *aOutputFile)</span>
<a href="#l8.7"></a><span id="l8.7"> {</span>
<a href="#l8.8"></a><span id="l8.8">   // create zipwriter object</span>
<a href="#l8.9"></a><span id="l8.9">   nsresult rv;</span>
<a href="#l8.10"></a><span id="l8.10">   nsCOMPtr&lt;nsIZipWriter&gt; zipWriter = do_CreateInstance(&quot;@mozilla.org/zipwriter;1&quot;, &amp;rv);</span>
<a href="#l8.11"></a><span id="l8.11">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-  </span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+</span>
<a href="#l8.14"></a><span id="l8.14">   rv = zipWriter-&gt;Open(aOutputFile, PR_RDWR | PR_CREATE_FILE | PR_TRUNCATE);</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv); </span>
<a href="#l8.16"></a><span id="l8.16" class="difflineminus">-  </span>
<a href="#l8.17"></a><span id="l8.17" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineplus">+</span>
<a href="#l8.19"></a><span id="l8.19">   rv = AddToZip(zipWriter, aInputFile, EmptyCString());</span>
<a href="#l8.20"></a><span id="l8.20">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.21"></a><span id="l8.21"> </span>
<a href="#l8.22"></a><span id="l8.22">   // we're done.</span>
<a href="#l8.23"></a><span id="l8.23">   zipWriter-&gt;Close();</span>
<a href="#l8.24"></a><span id="l8.24">   return rv;</span>
<a href="#l8.25"></a><span id="l8.25"> }</span>
<a href="#l8.26"></a><span id="l8.26"> </span>
<a href="#l8.27"></a><span id="l8.27"> /* static */</span>
<a href="#l8.28"></a><span id="l8.28" class="difflineminus">-nsresult nsSimpleZipper::AddToZip(nsIZipWriter *aZipWriter, </span>
<a href="#l8.29"></a><span id="l8.29" class="difflineplus">+nsresult nsSimpleZipper::AddToZip(nsIZipWriter *aZipWriter,</span>
<a href="#l8.30"></a><span id="l8.30">                                   nsIFile *aFile,</span>
<a href="#l8.31"></a><span id="l8.31">                                   const nsACString &amp;aPath)</span>
<a href="#l8.32"></a><span id="l8.32"> {</span>
<a href="#l8.33"></a><span id="l8.33">   // find out the path this file/dir should have in the zip</span>
<a href="#l8.34"></a><span id="l8.34">   nsCString leafName;</span>
<a href="#l8.35"></a><span id="l8.35">   aFile-&gt;GetNativeLeafName(leafName);</span>
<a href="#l8.36"></a><span id="l8.36">   nsCString currentPath(aPath);</span>
<a href="#l8.37"></a><span id="l8.37">   currentPath += leafName;</span>
<a href="#l8.38"></a><span id="l8.38" class="difflineminus">-    </span>
<a href="#l8.39"></a><span id="l8.39" class="difflineplus">+</span>
<a href="#l8.40"></a><span id="l8.40">   bool isDirectory;</span>
<a href="#l8.41"></a><span id="l8.41">   aFile-&gt;IsDirectory(&amp;isDirectory);</span>
<a href="#l8.42"></a><span id="l8.42">   // append slash for a directory entry</span>
<a href="#l8.43"></a><span id="l8.43">   if (isDirectory)</span>
<a href="#l8.44"></a><span id="l8.44">     currentPath.Append('/');</span>
<a href="#l8.45"></a><span id="l8.45" class="difflineminus">-  </span>
<a href="#l8.46"></a><span id="l8.46" class="difflineplus">+</span>
<a href="#l8.47"></a><span id="l8.47">   // add the file or directory entry to the zip</span>
<a href="#l8.48"></a><span id="l8.48">   nsresult rv = aZipWriter-&gt;AddEntryFile(currentPath, nsIZipWriter::COMPRESSION_DEFAULT, aFile, false);</span>
<a href="#l8.49"></a><span id="l8.49">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineminus">-  </span>
<a href="#l8.51"></a><span id="l8.51" class="difflineplus">+</span>
<a href="#l8.52"></a><span id="l8.52">   // if it's a directory, add all its contents too</span>
<a href="#l8.53"></a><span id="l8.53">   if (isDirectory) {</span>
<a href="#l8.54"></a><span id="l8.54">     nsCOMPtr&lt;nsISimpleEnumerator&gt; e;</span>
<a href="#l8.55"></a><span id="l8.55">     nsresult rv = aFile-&gt;GetDirectoryEntries(getter_AddRefs(e));</span>
<a href="#l8.56"></a><span id="l8.56">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.57"></a><span id="l8.57"> </span>
<a href="#l8.58"></a><span id="l8.58">     nsCOMPtr&lt;nsIDirectoryEnumerator&gt; dirEnumerator = do_QueryInterface(e, &amp;rv);</span>
<a href="#l8.59"></a><span id="l8.59">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.60"></a><span id="l8.60"> </span>
<a href="#l8.61"></a><span id="l8.61">     nsCOMPtr&lt;nsIFile&gt; currentFile;</span>
<a href="#l8.62"></a><span id="l8.62">     while (NS_SUCCEEDED(dirEnumerator-&gt;GetNextFile(getter_AddRefs(currentFile))) &amp;&amp; currentFile) {</span>
<a href="#l8.63"></a><span id="l8.63">       rv = AddToZip(aZipWriter, currentFile, currentPath);</span>
<a href="#l8.64"></a><span id="l8.64">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.65"></a><span id="l8.65">     }</span>
<a href="#l8.66"></a><span id="l8.66">   }</span>
<a href="#l8.67"></a><span id="l8.67" class="difflineminus">-  </span>
<a href="#l8.68"></a><span id="l8.68" class="difflineplus">+</span>
<a href="#l8.69"></a><span id="l8.69">   return NS_OK;</span>
<a href="#l8.70"></a><span id="l8.70"> }</span>
<a href="#l8.71"></a><span id="l8.71"> #endif // XP_MACOSX</span>
<a href="#l8.72"></a><span id="l8.72"> </span>
<a href="#l8.73"></a><span id="l8.73"> //</span>
<a href="#l8.74"></a><span id="l8.74"> // Class implementation...</span>
<a href="#l8.75"></a><span id="l8.75"> //</span>
<a href="#l8.76"></a><span id="l8.76"> nsMsgAttachmentHandler::nsMsgAttachmentHandler() :</span>
<a href="#l8.77"></a><span id="l8.77" class="difflineat">@@ -124,18 +124,18 @@ nsMsgAttachmentHandler::nsMsgAttachmentH</span>
<a href="#l8.78"></a><span id="l8.78">   mSendViaCloud(false),</span>
<a href="#l8.79"></a><span id="l8.79">   mNodeIndex(-1),</span>
<a href="#l8.80"></a><span id="l8.80">   // For analyzing the attachment file...</span>
<a href="#l8.81"></a><span id="l8.81">   m_size(0),</span>
<a href="#l8.82"></a><span id="l8.82">   m_unprintable_count(0),</span>
<a href="#l8.83"></a><span id="l8.83">   m_highbit_count(0),</span>
<a href="#l8.84"></a><span id="l8.84">   m_ctl_count(0),</span>
<a href="#l8.85"></a><span id="l8.85">   m_null_count(0),</span>
<a href="#l8.86"></a><span id="l8.86" class="difflineminus">-  m_have_cr(0), </span>
<a href="#l8.87"></a><span id="l8.87" class="difflineminus">-  m_have_lf(0), </span>
<a href="#l8.88"></a><span id="l8.88" class="difflineplus">+  m_have_cr(0),</span>
<a href="#l8.89"></a><span id="l8.89" class="difflineplus">+  m_have_lf(0),</span>
<a href="#l8.90"></a><span id="l8.90">   m_have_crlf(0),</span>
<a href="#l8.91"></a><span id="l8.91">   m_prev_char_was_cr(false),</span>
<a href="#l8.92"></a><span id="l8.92">   m_current_column(0),</span>
<a href="#l8.93"></a><span id="l8.93">   m_max_column(0),</span>
<a href="#l8.94"></a><span id="l8.94">   m_lines(0),</span>
<a href="#l8.95"></a><span id="l8.95">   m_file_analyzed(false),</span>
<a href="#l8.96"></a><span id="l8.96"> </span>
<a href="#l8.97"></a><span id="l8.97">   // Mime</span>
<a href="#l8.98"></a><span id="l8.98" class="difflineat">@@ -524,20 +524,20 @@ nsMsgAttachmentHandler::PickCharset()</span>
<a href="#l8.99"></a><span id="l8.99"> {</span>
<a href="#l8.100"></a><span id="l8.100">   if (!m_charset.IsEmpty() || !m_type.LowerCaseEqualsLiteral(TEXT_PLAIN))</span>
<a href="#l8.101"></a><span id="l8.101">     return NS_OK;</span>
<a href="#l8.102"></a><span id="l8.102"> </span>
<a href="#l8.103"></a><span id="l8.103">   nsCOMPtr&lt;nsIFile&gt; tmpFile =</span>
<a href="#l8.104"></a><span id="l8.104">     do_QueryInterface(mTmpFile);</span>
<a href="#l8.105"></a><span id="l8.105">   if (!tmpFile)</span>
<a href="#l8.106"></a><span id="l8.106">     return NS_OK;</span>
<a href="#l8.107"></a><span id="l8.107" class="difflineminus">-  </span>
<a href="#l8.108"></a><span id="l8.108" class="difflineplus">+</span>
<a href="#l8.109"></a><span id="l8.109">   return MsgDetectCharsetFromFile(tmpFile, m_charset);</span>
<a href="#l8.110"></a><span id="l8.110"> }</span>
<a href="#l8.111"></a><span id="l8.111" class="difflineminus">-    </span>
<a href="#l8.112"></a><span id="l8.112" class="difflineplus">+</span>
<a href="#l8.113"></a><span id="l8.113"> static nsresult</span>
<a href="#l8.114"></a><span id="l8.114"> FetcherURLDoneCallback(nsresult aStatus,</span>
<a href="#l8.115"></a><span id="l8.115">                        const nsACString &amp;aContentType,</span>
<a href="#l8.116"></a><span id="l8.116">                        const nsACString &amp;aCharset,</span>
<a href="#l8.117"></a><span id="l8.117">                        int32_t totalSize,</span>
<a href="#l8.118"></a><span id="l8.118">                        const char16_t* aMsg, void *tagData)</span>
<a href="#l8.119"></a><span id="l8.119"> {</span>
<a href="#l8.120"></a><span id="l8.120">   nsMsgAttachmentHandler *ma = (nsMsgAttachmentHandler *) tagData;</span>
<a href="#l8.121"></a><span id="l8.121" class="difflineat">@@ -753,37 +753,37 @@ nsMsgAttachmentHandler::SnarfAttachment(</span>
<a href="#l8.122"></a><span id="l8.122">     filePath.Adopt(nsMsgGetLocalFileFromURL(sourceURISpec.get()));</span>
<a href="#l8.123"></a><span id="l8.123">     nsAutoCString unescapedFilePath;</span>
<a href="#l8.124"></a><span id="l8.124">     MsgUnescapeString(filePath, 0, unescapedFilePath);</span>
<a href="#l8.125"></a><span id="l8.125"> </span>
<a href="#l8.126"></a><span id="l8.126">     nsCOMPtr&lt;nsIFile&gt; sourceFile;</span>
<a href="#l8.127"></a><span id="l8.127">     NS_NewNativeLocalFile(unescapedFilePath, true, getter_AddRefs(sourceFile));</span>
<a href="#l8.128"></a><span id="l8.128">     if (!sourceFile)</span>
<a href="#l8.129"></a><span id="l8.129">       return NS_ERROR_FAILURE;</span>
<a href="#l8.130"></a><span id="l8.130" class="difflineminus">-      </span>
<a href="#l8.131"></a><span id="l8.131" class="difflineminus">-    // check if it is a bundle. if it is, we'll zip it. </span>
<a href="#l8.132"></a><span id="l8.132" class="difflineplus">+</span>
<a href="#l8.133"></a><span id="l8.133" class="difflineplus">+    // check if it is a bundle. if it is, we'll zip it.</span>
<a href="#l8.134"></a><span id="l8.134">     // if not, we'll apple encode it (applesingle or appledouble)</span>
<a href="#l8.135"></a><span id="l8.135">     nsCOMPtr&lt;nsILocalFileMac&gt; macFile(do_QueryInterface(sourceFile));</span>
<a href="#l8.136"></a><span id="l8.136">     bool isPackage;</span>
<a href="#l8.137"></a><span id="l8.137">     macFile-&gt;IsPackage(&amp;isPackage);</span>
<a href="#l8.138"></a><span id="l8.138">     if (isPackage)</span>
<a href="#l8.139"></a><span id="l8.139">       rv = ConvertToZipFile(macFile);</span>
<a href="#l8.140"></a><span id="l8.140">     else</span>
<a href="#l8.141"></a><span id="l8.141">       rv = ConvertToAppleEncoding(sourceURISpec, unescapedFilePath, macFile);</span>
<a href="#l8.142"></a><span id="l8.142" class="difflineminus">-    </span>
<a href="#l8.143"></a><span id="l8.143" class="difflineplus">+</span>
<a href="#l8.144"></a><span id="l8.144">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.145"></a><span id="l8.145">   }</span>
<a href="#l8.146"></a><span id="l8.146"> #endif /* XP_MACOSX */</span>
<a href="#l8.147"></a><span id="l8.147"> </span>
<a href="#l8.148"></a><span id="l8.148">   //</span>
<a href="#l8.149"></a><span id="l8.149">   // Ok, here we are, we need to fire the URL off and get the data</span>
<a href="#l8.150"></a><span id="l8.150">   // in the temp file</span>
<a href="#l8.151"></a><span id="l8.151">   //</span>
<a href="#l8.152"></a><span id="l8.152">   // Create a fetcher for the URL attachment...</span>
<a href="#l8.153"></a><span id="l8.153" class="difflineminus">-  </span>
<a href="#l8.154"></a><span id="l8.154" class="difflineplus">+</span>
<a href="#l8.155"></a><span id="l8.155">   nsCOMPtr&lt;nsIURLFetcher&gt; fetcher = do_CreateInstance(NS_URLFETCHER_CONTRACTID, &amp;rv);</span>
<a href="#l8.156"></a><span id="l8.156">   if (NS_FAILED(rv) || !fetcher)</span>
<a href="#l8.157"></a><span id="l8.157">   {</span>
<a href="#l8.158"></a><span id="l8.158">     if (NS_SUCCEEDED(rv))</span>
<a href="#l8.159"></a><span id="l8.159">       return NS_ERROR_UNEXPECTED;</span>
<a href="#l8.160"></a><span id="l8.160">     else</span>
<a href="#l8.161"></a><span id="l8.161">       return rv;</span>
<a href="#l8.162"></a><span id="l8.162">   }</span>
<a href="#l8.163"></a><span id="l8.163" class="difflineat">@@ -817,23 +817,23 @@ nsMsgAttachmentHandler::ConvertToZipFile</span>
<a href="#l8.164"></a><span id="l8.164">   // set some metadata for this attachment, that will affect the MIME headers.</span>
<a href="#l8.165"></a><span id="l8.165">   m_type = APPLICATION_ZIP;</span>
<a href="#l8.166"></a><span id="l8.166">   m_realName = zippedName.get();</span>
<a href="#l8.167"></a><span id="l8.167"> </span>
<a href="#l8.168"></a><span id="l8.168">   return NS_OK;</span>
<a href="#l8.169"></a><span id="l8.169"> }</span>
<a href="#l8.170"></a><span id="l8.170"> </span>
<a href="#l8.171"></a><span id="l8.171"> nsresult</span>
<a href="#l8.172"></a><span id="l8.172" class="difflineminus">-nsMsgAttachmentHandler::ConvertToAppleEncoding(const nsCString &amp;aFileURI, </span>
<a href="#l8.173"></a><span id="l8.173" class="difflineminus">-                                               const nsCString &amp;aFilePath, </span>
<a href="#l8.174"></a><span id="l8.174" class="difflineplus">+nsMsgAttachmentHandler::ConvertToAppleEncoding(const nsCString &amp;aFileURI,</span>
<a href="#l8.175"></a><span id="l8.175" class="difflineplus">+                                               const nsCString &amp;aFilePath,</span>
<a href="#l8.176"></a><span id="l8.176">                                                nsILocalFileMac *aSourceFile)</span>
<a href="#l8.177"></a><span id="l8.177"> {</span>
<a href="#l8.178"></a><span id="l8.178">   // convert the apple file to AppleDouble first, and then patch the</span>
<a href="#l8.179"></a><span id="l8.179">   // address in the url.</span>
<a href="#l8.180"></a><span id="l8.180" class="difflineminus">-  </span>
<a href="#l8.181"></a><span id="l8.181" class="difflineplus">+</span>
<a href="#l8.182"></a><span id="l8.182">   //We need to retrieve the file type and creator...</span>
<a href="#l8.183"></a><span id="l8.183"> </span>
<a href="#l8.184"></a><span id="l8.184">   char fileInfo[32];</span>
<a href="#l8.185"></a><span id="l8.185">   OSType type, creator;</span>
<a href="#l8.186"></a><span id="l8.186"> </span>
<a href="#l8.187"></a><span id="l8.187">   nsresult rv = aSourceFile-&gt;GetFileType(&amp;type);</span>
<a href="#l8.188"></a><span id="l8.188">   if (NS_FAILED(rv))</span>
<a href="#l8.189"></a><span id="l8.189">     return rv;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgAttachmentHandler.h</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgAttachmentHandler.h</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -28,28 +28,28 @@ public:</span>
<a href="#l9.4"></a><span id="l9.4">   char                        *buff;          // the working buff</span>
<a href="#l9.5"></a><span id="l9.5">   int32_t                     s_buff;         // the working buff size</span>
<a href="#l9.6"></a><span id="l9.6">   nsCOMPtr &lt;nsIOutputStream&gt;  fileStream;    // file to hold the encoding</span>
<a href="#l9.7"></a><span id="l9.7"> };</span>
<a href="#l9.8"></a><span id="l9.8"> </span>
<a href="#l9.9"></a><span id="l9.9"> class nsILocalFileMac;</span>
<a href="#l9.10"></a><span id="l9.10"> class nsIZipWriter;</span>
<a href="#l9.11"></a><span id="l9.11"> </span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-/* Simple utility class that will synchronously zip any file </span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+/* Simple utility class that will synchronously zip any file</span>
<a href="#l9.14"></a><span id="l9.14">    (or folder hierarchy) you give it. */</span>
<a href="#l9.15"></a><span id="l9.15"> class nsSimpleZipper</span>
<a href="#l9.16"></a><span id="l9.16"> {</span>
<a href="#l9.17"></a><span id="l9.17">   public:</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineminus">-    </span>
<a href="#l9.19"></a><span id="l9.19" class="difflineplus">+</span>
<a href="#l9.20"></a><span id="l9.20">     // Synchronously zips the input file/folder and writes all</span>
<a href="#l9.21"></a><span id="l9.21">     // data to the output file.</span>
<a href="#l9.22"></a><span id="l9.22">     static nsresult Zip(nsIFile *aInputFile, nsIFile *aOutputFile);</span>
<a href="#l9.23"></a><span id="l9.23" class="difflineminus">-  </span>
<a href="#l9.24"></a><span id="l9.24" class="difflineplus">+</span>
<a href="#l9.25"></a><span id="l9.25">   private:</span>
<a href="#l9.26"></a><span id="l9.26" class="difflineminus">-    </span>
<a href="#l9.27"></a><span id="l9.27" class="difflineplus">+</span>
<a href="#l9.28"></a><span id="l9.28">     // Recursively adds the file or folder to aZipWriter.</span>
<a href="#l9.29"></a><span id="l9.29">     static nsresult AddToZip(nsIZipWriter *aZipWriter,</span>
<a href="#l9.30"></a><span id="l9.30">                              nsIFile *aFile,</span>
<a href="#l9.31"></a><span id="l9.31">                              const nsACString &amp;aPath);</span>
<a href="#l9.32"></a><span id="l9.32"> };</span>
<a href="#l9.33"></a><span id="l9.33"> #endif  // XP_MACOSX</span>
<a href="#l9.34"></a><span id="l9.34"> </span>
<a href="#l9.35"></a><span id="l9.35"> namespace mozilla {</span>
<a href="#l9.36"></a><span id="l9.36" class="difflineat">@@ -72,90 +72,90 @@ public:</span>
<a href="#l9.37"></a><span id="l9.37"> </span>
<a href="#l9.38"></a><span id="l9.38">   nsMsgAttachmentHandler();</span>
<a href="#l9.39"></a><span id="l9.39"> public:</span>
<a href="#l9.40"></a><span id="l9.40">   nsresult              SnarfAttachment(nsMsgCompFields *compFields);</span>
<a href="#l9.41"></a><span id="l9.41">   nsresult              PickEncoding(const char *charset, nsIMsgSend* mime_delivery_state);</span>
<a href="#l9.42"></a><span id="l9.42">   nsresult              PickCharset();</span>
<a href="#l9.43"></a><span id="l9.43">   void                  AnalyzeSnarfedFile ();      // Analyze a previously-snarfed file.</span>
<a href="#l9.44"></a><span id="l9.44">                                                     // (Currently only used for plaintext</span>
<a href="#l9.45"></a><span id="l9.45" class="difflineminus">-                                                    // converted from HTML.) </span>
<a href="#l9.46"></a><span id="l9.46" class="difflineplus">+                                                    // converted from HTML.)</span>
<a href="#l9.47"></a><span id="l9.47">   nsresult              Abort();</span>
<a href="#l9.48"></a><span id="l9.48">   nsresult              UrlExit(nsresult status, const char16_t* aMsg);</span>
<a href="#l9.49"></a><span id="l9.49" class="difflineminus">-  </span>
<a href="#l9.50"></a><span id="l9.50" class="difflineplus">+</span>
<a href="#l9.51"></a><span id="l9.51">   // if there's an intermediate temp file left, takes care to remove it from disk.</span>
<a href="#l9.52"></a><span id="l9.52">   //</span>
<a href="#l9.53"></a><span id="l9.53">   // NOTE: this takes care of the mEncodedWorkingFile temp file, but not mTmpFile which seems</span>
<a href="#l9.54"></a><span id="l9.54">   // to be used by lots of other classes at the moment.</span>
<a href="#l9.55"></a><span id="l9.55">   void                  CleanupTempFile();</span>
<a href="#l9.56"></a><span id="l9.56"> </span>
<a href="#l9.57"></a><span id="l9.57"> private:</span>
<a href="#l9.58"></a><span id="l9.58">   virtual ~nsMsgAttachmentHandler();</span>
<a href="#l9.59"></a><span id="l9.59"> </span>
<a href="#l9.60"></a><span id="l9.60">   // use when a message (e.g. original message in a reply) is attached as a rfc822 attachment.</span>
<a href="#l9.61"></a><span id="l9.61">   nsresult              SnarfMsgAttachment(nsMsgCompFields *compFields);</span>
<a href="#l9.62"></a><span id="l9.62">   bool                  UseUUEncode_p(void);</span>
<a href="#l9.63"></a><span id="l9.63">   void                  AnalyzeDataChunk (const char *chunk, int32_t chunkSize);</span>
<a href="#l9.64"></a><span id="l9.64">   nsresult              LoadDataFromFile(nsIFile *file, nsString &amp;sigData, bool charsetConversion); //A similar function already exist in nsMsgCompose!</span>
<a href="#l9.65"></a><span id="l9.65"> #ifdef XP_MACOSX</span>
<a href="#l9.66"></a><span id="l9.66" class="difflineminus">-  nsresult              ConvertToAppleEncoding(const nsCString &amp;aFileSpecURI, </span>
<a href="#l9.67"></a><span id="l9.67" class="difflineminus">-                                               const nsCString &amp;aFilePath, </span>
<a href="#l9.68"></a><span id="l9.68" class="difflineplus">+  nsresult              ConvertToAppleEncoding(const nsCString &amp;aFileSpecURI,</span>
<a href="#l9.69"></a><span id="l9.69" class="difflineplus">+                                               const nsCString &amp;aFilePath,</span>
<a href="#l9.70"></a><span id="l9.70">                                                nsILocalFileMac *aSourceFile);</span>
<a href="#l9.71"></a><span id="l9.71">   // zips this attachment and does the work to make this attachment handler handle it properly.</span>
<a href="#l9.72"></a><span id="l9.72">   nsresult ConvertToZipFile(nsILocalFileMac *aSourceFile);</span>
<a href="#l9.73"></a><span id="l9.73">   bool HasResourceFork(FSRef *fsRef);</span>
<a href="#l9.74"></a><span id="l9.74"> #endif</span>
<a href="#l9.75"></a><span id="l9.75"> </span>
<a href="#l9.76"></a><span id="l9.76">   //</span>
<a href="#l9.77"></a><span id="l9.77"> public:</span>
<a href="#l9.78"></a><span id="l9.78">   nsCOMPtr&lt;nsIURI&gt; mURL;</span>
<a href="#l9.79"></a><span id="l9.79" class="difflineminus">-  nsCOMPtr&lt;nsIFile&gt;        mTmpFile;         // The temp file to which we save it </span>
<a href="#l9.80"></a><span id="l9.80" class="difflineminus">-  nsCOMPtr&lt;nsIOutputStream&gt;  mOutFile;          </span>
<a href="#l9.81"></a><span id="l9.81" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt;        mTmpFile;         // The temp file to which we save it</span>
<a href="#l9.82"></a><span id="l9.82" class="difflineplus">+  nsCOMPtr&lt;nsIOutputStream&gt;  mOutFile;</span>
<a href="#l9.83"></a><span id="l9.83">   nsCOMPtr&lt;nsIRequest&gt; mRequest; // The live request used while fetching an attachment</span>
<a href="#l9.84"></a><span id="l9.84">   nsMsgCompFields       *mCompFields;       // Message composition fields for the sender</span>
<a href="#l9.85"></a><span id="l9.85">   bool                  m_bogus_attachment; // This is to catch problem children...</span>
<a href="#l9.86"></a><span id="l9.86" class="difflineminus">-  </span>
<a href="#l9.87"></a><span id="l9.87" class="difflineplus">+</span>
<a href="#l9.88"></a><span id="l9.88"> #ifdef XP_MACOSX</span>
<a href="#l9.89"></a><span id="l9.89">   // if we need to encode this file into for example an appledouble, or zip file,</span>
<a href="#l9.90"></a><span id="l9.90">   // this file is our working file. currently only needed on mac.</span>
<a href="#l9.91"></a><span id="l9.91">   nsCOMPtr&lt;nsIFile&gt; mEncodedWorkingFile;</span>
<a href="#l9.92"></a><span id="l9.92"> #endif</span>
<a href="#l9.93"></a><span id="l9.93"> </span>
<a href="#l9.94"></a><span id="l9.94">   nsCString m_xMacType;      // Mac file type</span>
<a href="#l9.95"></a><span id="l9.95">   nsCString m_xMacCreator;   // Mac file creator</span>
<a href="#l9.96"></a><span id="l9.96"> </span>
<a href="#l9.97"></a><span id="l9.97">   bool m_done;</span>
<a href="#l9.98"></a><span id="l9.98" class="difflineminus">-  nsCString m_charset;         // charset name </span>
<a href="#l9.99"></a><span id="l9.99" class="difflineplus">+  nsCString m_charset;         // charset name</span>
<a href="#l9.100"></a><span id="l9.100">   nsCString m_contentId;      // This is for mutipart/related Content-ID's</span>
<a href="#l9.101"></a><span id="l9.101">   nsCString m_type;            // The real type, once we know it.</span>
<a href="#l9.102"></a><span id="l9.102">   nsCString m_typeParam;      // Any addition parameters to add to the content-type (other than charset, macType and maccreator)</span>
<a href="#l9.103"></a><span id="l9.103">   nsCString m_overrideType;   // The type we should assume it to be</span>
<a href="#l9.104"></a><span id="l9.104">                                             // or 0, if we should get it from the</span>
<a href="#l9.105"></a><span id="l9.105">                                             // server)</span>
<a href="#l9.106"></a><span id="l9.106" class="difflineminus">-  nsCString m_overrideEncoding; // Goes along with override_type </span>
<a href="#l9.107"></a><span id="l9.107" class="difflineplus">+  nsCString m_overrideEncoding; // Goes along with override_type</span>
<a href="#l9.108"></a><span id="l9.108"> </span>
<a href="#l9.109"></a><span id="l9.109" class="difflineminus">-  nsCString m_desiredType;    // The type it should be converted to. </span>
<a href="#l9.110"></a><span id="l9.110" class="difflineplus">+  nsCString m_desiredType;    // The type it should be converted to.</span>
<a href="#l9.111"></a><span id="l9.111">   nsCString m_description;     // For Content-Description header</span>
<a href="#l9.112"></a><span id="l9.112">   nsCString m_realName;       // The name for the headers, if different</span>
<a href="#l9.113"></a><span id="l9.113" class="difflineminus">-                                            // from the URL. </span>
<a href="#l9.114"></a><span id="l9.114" class="difflineplus">+                                            // from the URL.</span>
<a href="#l9.115"></a><span id="l9.115">   nsCString m_encoding;        // The encoding, once we've decided. */</span>
<a href="#l9.116"></a><span id="l9.116">   bool                  m_already_encoded_p; // If we attach a document that is already</span>
<a href="#l9.117"></a><span id="l9.117">                                              // encoded, we just pass it through.</span>
<a href="#l9.118"></a><span id="l9.118"> </span>
<a href="#l9.119"></a><span id="l9.119">   bool                  m_decrypted_p;  /* S/MIME -- when attaching a message that was</span>
<a href="#l9.120"></a><span id="l9.120">                                            encrypted, it's necessary to decrypt it first</span>
<a href="#l9.121"></a><span id="l9.121">                                            (since nobody but the original recipient can</span>
<a href="#l9.122"></a><span id="l9.122">                                            read it -- if you forward it to someone in the</span>
<a href="#l9.123"></a><span id="l9.123">                                            raw, it will be useless to them.)  This flag</span>
<a href="#l9.124"></a><span id="l9.124">                                            indicates whether decryption occurred, so that</span>
<a href="#l9.125"></a><span id="l9.125">                                            libmsg can issue appropriate warnings about</span>
<a href="#l9.126"></a><span id="l9.126">                                            doing a cleartext forward of a message that was</span>
<a href="#l9.127"></a><span id="l9.127">                                            originally encrypted. */</span>
<a href="#l9.128"></a><span id="l9.128"> </span>
<a href="#l9.129"></a><span id="l9.129" class="difflineminus">-  bool                  mDeleteFile;      // If this is true, Delete the file...its </span>
<a href="#l9.130"></a><span id="l9.130" class="difflineplus">+  bool                  mDeleteFile;      // If this is true, Delete the file...its</span>
<a href="#l9.131"></a><span id="l9.131">                                           // NOT the original file!</span>
<a href="#l9.132"></a><span id="l9.132"> </span>
<a href="#l9.133"></a><span id="l9.133">   bool                  mMHTMLPart;           // This is true if its an MHTML part, otherwise, false</span>
<a href="#l9.134"></a><span id="l9.134">   bool                  mPartUserOmissionOverride;  // This is true if the user send send the email without this part</span>
<a href="#l9.135"></a><span id="l9.135">   bool                  mMainBody;            // True if this is a main body.</span>
<a href="#l9.136"></a><span id="l9.136">    // true if this should be sent as a link to a file.</span>
<a href="#l9.137"></a><span id="l9.137">   bool                  mSendViaCloud;</span>
<a href="#l9.138"></a><span id="l9.138">   nsString              mHtmlAnnotation;</span>
<a href="#l9.139"></a><span id="l9.139" class="difflineat">@@ -167,17 +167,17 @@ public:</span>
<a href="#l9.140"></a><span id="l9.140">   //</span>
<a href="#l9.141"></a><span id="l9.141">   // Vars for analyzing file data...</span>
<a href="#l9.142"></a><span id="l9.142">   //</span>
<a href="#l9.143"></a><span id="l9.143">   uint32_t              m_size;         /* Some state used while filtering it */</span>
<a href="#l9.144"></a><span id="l9.144">   uint32_t              m_unprintable_count;</span>
<a href="#l9.145"></a><span id="l9.145">   uint32_t              m_highbit_count;</span>
<a href="#l9.146"></a><span id="l9.146">   uint32_t              m_ctl_count;</span>
<a href="#l9.147"></a><span id="l9.147">   uint32_t              m_null_count;</span>
<a href="#l9.148"></a><span id="l9.148" class="difflineminus">-  uint8_t               m_have_cr, m_have_lf, m_have_crlf; </span>
<a href="#l9.149"></a><span id="l9.149" class="difflineplus">+  uint8_t               m_have_cr, m_have_lf, m_have_crlf;</span>
<a href="#l9.150"></a><span id="l9.150">   bool                  m_prev_char_was_cr;</span>
<a href="#l9.151"></a><span id="l9.151">   uint32_t              m_current_column;</span>
<a href="#l9.152"></a><span id="l9.152">   uint32_t              m_max_column;</span>
<a href="#l9.153"></a><span id="l9.153">   uint32_t              m_lines;</span>
<a href="#l9.154"></a><span id="l9.154">   bool                  m_file_analyzed;</span>
<a href="#l9.155"></a><span id="l9.155"> </span>
<a href="#l9.156"></a><span id="l9.156">   nsAutoPtr&lt;MimeEncoder&gt; m_encoder;</span>
<a href="#l9.157"></a><span id="l9.157">   nsCString             m_uri; // original uri string</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgCompFields.cpp</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgCompFields.cpp</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -55,17 +55,17 @@ static HeaderInfo kHeaders[] = {</span>
<a href="#l10.4"></a><span id="l10.4"> };</span>
<a href="#l10.5"></a><span id="l10.5"> </span>
<a href="#l10.6"></a><span id="l10.6"> static_assert(MOZ_ARRAY_LENGTH(kHeaders) ==</span>
<a href="#l10.7"></a><span id="l10.7">     nsMsgCompFields::MSG_MAX_HEADERS,</span>
<a href="#l10.8"></a><span id="l10.8">   &quot;These two arrays need to be kept in sync or bad things will happen!&quot;);</span>
<a href="#l10.9"></a><span id="l10.9"> </span>
<a href="#l10.10"></a><span id="l10.10"> NS_IMPL_ISUPPORTS(nsMsgCompFields, nsIMsgCompFields, msgIStructuredHeaders,</span>
<a href="#l10.11"></a><span id="l10.11">   msgIWritableStructuredHeaders)</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">- </span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+</span>
<a href="#l10.14"></a><span id="l10.14"> nsMsgCompFields::nsMsgCompFields()</span>
<a href="#l10.15"></a><span id="l10.15"> : mStructuredHeaders(do_CreateInstance(NS_ISTRUCTUREDHEADERS_CONTRACTID))</span>
<a href="#l10.16"></a><span id="l10.16"> {</span>
<a href="#l10.17"></a><span id="l10.17">   m_body.Truncate();</span>
<a href="#l10.18"></a><span id="l10.18"> </span>
<a href="#l10.19"></a><span id="l10.19">   m_attachVCard = false;</span>
<a href="#l10.20"></a><span id="l10.20">   m_forcePlainText = false;</span>
<a href="#l10.21"></a><span id="l10.21">   m_useMultipartAlternative = false;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgCompUtils.h</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgCompUtils.h</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -7,17 +7,17 @@</span>
<a href="#l11.4"></a><span id="l11.4"> #define _nsMsgCompUtils_H_</span>
<a href="#l11.5"></a><span id="l11.5"> </span>
<a href="#l11.6"></a><span id="l11.6"> #include &quot;nscore.h&quot;</span>
<a href="#l11.7"></a><span id="l11.7"> #include &quot;nsMsgSend.h&quot;</span>
<a href="#l11.8"></a><span id="l11.8"> #include &quot;nsMsgCompFields.h&quot;</span>
<a href="#l11.9"></a><span id="l11.9"> #include &quot;nsIMsgSend.h&quot;</span>
<a href="#l11.10"></a><span id="l11.10"> #include &quot;nsIMsgCompUtils.h&quot;</span>
<a href="#l11.11"></a><span id="l11.11"> </span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-class nsIPrompt; </span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+class nsIPrompt;</span>
<a href="#l11.14"></a><span id="l11.14"> </span>
<a href="#l11.15"></a><span id="l11.15"> #define ANY_SERVER &quot;anyfolder://&quot;</span>
<a href="#l11.16"></a><span id="l11.16"> </span>
<a href="#l11.17"></a><span id="l11.17"> // these are msg hdr property names for storing the original</span>
<a href="#l11.18"></a><span id="l11.18"> // msg uri's and disposition(replied/forwarded) when queuing</span>
<a href="#l11.19"></a><span id="l11.19"> // messages to send later.</span>
<a href="#l11.20"></a><span id="l11.20"> #define ORIG_URI_PROPERTY &quot;origURIs&quot;</span>
<a href="#l11.21"></a><span id="l11.21"> #define QUEUED_DISPOSITION_PROPERTY &quot;queuedDisposition&quot;</span>
<a href="#l11.22"></a><span id="l11.22" class="difflineat">@@ -40,17 +40,17 @@ PR_BEGIN_EXTERN_C</span>
<a href="#l11.23"></a><span id="l11.23"> // Create a file spec or file name using the name passed</span>
<a href="#l11.24"></a><span id="l11.24"> // in as a template</span>
<a href="#l11.25"></a><span id="l11.25"> //</span>
<a href="#l11.26"></a><span id="l11.26"> nsresult    nsMsgCreateTempFile(const char *tFileName, nsIFile **tFile);</span>
<a href="#l11.27"></a><span id="l11.27"> char        *nsMsgCreateTempFileName(const char *tFileName);</span>
<a href="#l11.28"></a><span id="l11.28"> </span>
<a href="#l11.29"></a><span id="l11.29"> </span>
<a href="#l11.30"></a><span id="l11.30"> //</span>
<a href="#l11.31"></a><span id="l11.31" class="difflineminus">-// Various utilities for building parts of MIME encoded </span>
<a href="#l11.32"></a><span id="l11.32" class="difflineplus">+// Various utilities for building parts of MIME encoded</span>
<a href="#l11.33"></a><span id="l11.33"> // messages during message composition</span>
<a href="#l11.34"></a><span id="l11.34"> //</span>
<a href="#l11.35"></a><span id="l11.35"> </span>
<a href="#l11.36"></a><span id="l11.36"> nsresult    mime_sanity_check_fields_recipients (</span>
<a href="#l11.37"></a><span id="l11.37">                             const char *to,</span>
<a href="#l11.38"></a><span id="l11.38">                             const char *cc,</span>
<a href="#l11.39"></a><span id="l11.39">                             const char *bcc,</span>
<a href="#l11.40"></a><span id="l11.40">                             const char *newsgroups);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgCompose.h</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgCompose.h</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -27,17 +27,17 @@ class QuotingOutputStreamListener;</span>
<a href="#l12.4"></a><span id="l12.4"> class nsMsgComposeSendListener;</span>
<a href="#l12.5"></a><span id="l12.5"> class nsIEditorMailSupport;</span>
<a href="#l12.6"></a><span id="l12.6"> class nsIRDFService;</span>
<a href="#l12.7"></a><span id="l12.7"> class nsIArray;</span>
<a href="#l12.8"></a><span id="l12.8"> struct nsMsgMailList;</span>
<a href="#l12.9"></a><span id="l12.9"> </span>
<a href="#l12.10"></a><span id="l12.10"> class nsMsgCompose : public nsIMsgCompose, public nsSupportsWeakReference</span>
<a href="#l12.11"></a><span id="l12.11"> {</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">- public: </span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+ public:</span>
<a href="#l12.14"></a><span id="l12.14"> </span>
<a href="#l12.15"></a><span id="l12.15">   nsMsgCompose();</span>
<a href="#l12.16"></a><span id="l12.16"> </span>
<a href="#l12.17"></a><span id="l12.17">   /* this macro defines QueryInterface, AddRef and Release for this class */</span>
<a href="#l12.18"></a><span id="l12.18">   NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l12.19"></a><span id="l12.19"> </span>
<a href="#l12.20"></a><span id="l12.20">   /*** nsIMsgCompose pure virtual functions */</span>
<a href="#l12.21"></a><span id="l12.21">   NS_DECL_NSIMSGCOMPOSE</span>
<a href="#l12.22"></a><span id="l12.22" class="difflineat">@@ -99,20 +99,20 @@ protected:</span>
<a href="#l12.23"></a><span id="l12.23"> #define MAX_OF_RECIPIENT_ARRAY 3</span>
<a href="#l12.24"></a><span id="l12.24">   typedef nsTArray&lt;nsMsgRecipient&gt; RecipientsArray[MAX_OF_RECIPIENT_ARRAY];</span>
<a href="#l12.25"></a><span id="l12.25">   /**</span>
<a href="#l12.26"></a><span id="l12.26">    * This method parses the compose fields and associates email addresses with</span>
<a href="#l12.27"></a><span id="l12.27">    * the relevant cards from the address books.</span>
<a href="#l12.28"></a><span id="l12.28">    */</span>
<a href="#l12.29"></a><span id="l12.29">   nsresult LookupAddressBook(RecipientsArray &amp;recipientList);</span>
<a href="#l12.30"></a><span id="l12.30">   bool IsLastWindow();</span>
<a href="#l12.31"></a><span id="l12.31" class="difflineminus">- </span>
<a href="#l12.32"></a><span id="l12.32" class="difflineplus">+</span>
<a href="#l12.33"></a><span id="l12.33">        // Helper function. Parameters are not checked.</span>
<a href="#l12.34"></a><span id="l12.34">   bool                                      mConvertStructs;    // for TagConvertible</span>
<a href="#l12.35"></a><span id="l12.35" class="difflineminus">-  </span>
<a href="#l12.36"></a><span id="l12.36" class="difflineplus">+</span>
<a href="#l12.37"></a><span id="l12.37">   nsCOMPtr&lt;nsIEditor&gt;                       m_editor;</span>
<a href="#l12.38"></a><span id="l12.38">   mozIDOMWindowProxy                        *m_window;</span>
<a href="#l12.39"></a><span id="l12.39">   nsCOMPtr&lt;nsIDocShell&gt;                     mDocShell;</span>
<a href="#l12.40"></a><span id="l12.40">   nsCOMPtr&lt;nsIBaseWindow&gt;                   m_baseWindow;</span>
<a href="#l12.41"></a><span id="l12.41">   RefPtr&lt;nsMsgCompFields&gt;                   m_compFields;</span>
<a href="#l12.42"></a><span id="l12.42">   nsCOMPtr&lt;nsIMsgIdentity&gt;                  m_identity;</span>
<a href="#l12.43"></a><span id="l12.43">   bool                                      m_composeHTML;</span>
<a href="#l12.44"></a><span id="l12.44">   RefPtr&lt;QuotingOutputStreamListener&gt;       mQuoteStreamListener;</span>
<a href="#l12.45"></a><span id="l12.45" class="difflineat">@@ -191,36 +191,36 @@ private:</span>
<a href="#l12.46"></a><span id="l12.46">     nsString                    mCiteReference;</span>
<a href="#l12.47"></a><span id="l12.47">     nsCOMPtr&lt;nsIMimeConverter&gt;  mMimeConverter;</span>
<a href="#l12.48"></a><span id="l12.48">     int32_t                     mUnicodeBufferCharacterLength;</span>
<a href="#l12.49"></a><span id="l12.49">     bool                        mQuoteOriginal;</span>
<a href="#l12.50"></a><span id="l12.50">     nsCString                   mHtmlToQuote;</span>
<a href="#l12.51"></a><span id="l12.51"> };</span>
<a href="#l12.52"></a><span id="l12.52"> </span>
<a href="#l12.53"></a><span id="l12.53"> ////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l12.54"></a><span id="l12.54" class="difflineminus">-// This is the listener class for the send operation. We have to create this class </span>
<a href="#l12.55"></a><span id="l12.55" class="difflineplus">+// This is the listener class for the send operation. We have to create this class</span>
<a href="#l12.56"></a><span id="l12.56"> // to listen for message send completion and eventually notify the caller</span>
<a href="#l12.57"></a><span id="l12.57"> ////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l12.58"></a><span id="l12.58"> class nsMsgComposeSendListener : public nsIMsgComposeSendListener, public nsIMsgSendListener, public nsIMsgCopyServiceListener, public nsIWebProgressListener</span>
<a href="#l12.59"></a><span id="l12.59"> {</span>
<a href="#l12.60"></a><span id="l12.60"> public:</span>
<a href="#l12.61"></a><span id="l12.61">   nsMsgComposeSendListener(void);</span>
<a href="#l12.62"></a><span id="l12.62"> </span>
<a href="#l12.63"></a><span id="l12.63">   // nsISupports interface</span>
<a href="#l12.64"></a><span id="l12.64">   NS_DECL_ISUPPORTS</span>
<a href="#l12.65"></a><span id="l12.65"> </span>
<a href="#l12.66"></a><span id="l12.66">   // nsIMsgComposeSendListener interface</span>
<a href="#l12.67"></a><span id="l12.67">   NS_DECL_NSIMSGCOMPOSESENDLISTENER</span>
<a href="#l12.68"></a><span id="l12.68"> </span>
<a href="#l12.69"></a><span id="l12.69">   // nsIMsgSendListener interface</span>
<a href="#l12.70"></a><span id="l12.70">   NS_DECL_NSIMSGSENDLISTENER</span>
<a href="#l12.71"></a><span id="l12.71" class="difflineminus">-  </span>
<a href="#l12.72"></a><span id="l12.72" class="difflineplus">+</span>
<a href="#l12.73"></a><span id="l12.73">   // nsIMsgCopyServiceListener interface</span>
<a href="#l12.74"></a><span id="l12.74">   NS_DECL_NSIMSGCOPYSERVICELISTENER</span>
<a href="#l12.75"></a><span id="l12.75" class="difflineminus">-  </span>
<a href="#l12.76"></a><span id="l12.76" class="difflineplus">+</span>
<a href="#l12.77"></a><span id="l12.77">   // nsIWebProgressListener interface</span>
<a href="#l12.78"></a><span id="l12.78">   NS_DECL_NSIWEBPROGRESSLISTENER</span>
<a href="#l12.79"></a><span id="l12.79"> </span>
<a href="#l12.80"></a><span id="l12.80">   nsresult    RemoveCurrentDraftMessage(nsIMsgCompose *compObj, bool calledByCopy);</span>
<a href="#l12.81"></a><span id="l12.81">   nsresult    GetMsgFolder(nsIMsgCompose *compObj, nsIMsgFolder **msgFolder);</span>
<a href="#l12.82"></a><span id="l12.82"> </span>
<a href="#l12.83"></a><span id="l12.83"> private:</span>
<a href="#l12.84"></a><span id="l12.84">   virtual ~nsMsgComposeSendListener();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgComposeContentHandler.cpp</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgComposeContentHandler.cpp</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -106,17 +106,17 @@ NS_IMETHODIMP nsMsgComposeContentHandler</span>
<a href="#l13.4"></a><span id="l13.4"> </span>
<a href="#l13.5"></a><span id="l13.5">     nsCOMPtr&lt;nsIURI&gt; aUri;</span>
<a href="#l13.6"></a><span id="l13.6">     nsCOMPtr&lt;nsIChannel&gt; aChannel = do_QueryInterface(request);</span>
<a href="#l13.7"></a><span id="l13.7">     if(!aChannel) return NS_ERROR_FAILURE;</span>
<a href="#l13.8"></a><span id="l13.8"> </span>
<a href="#l13.9"></a><span id="l13.9">     rv = aChannel-&gt;GetURI(getter_AddRefs(aUri));</span>
<a href="#l13.10"></a><span id="l13.10">     if (aUri)</span>
<a href="#l13.11"></a><span id="l13.11">     {</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-      nsCOMPtr&lt;nsIMsgComposeService&gt; composeService = </span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+      nsCOMPtr&lt;nsIMsgComposeService&gt; composeService =</span>
<a href="#l13.14"></a><span id="l13.14">                do_GetService(kMsgComposeServiceCID, &amp;rv);</span>
<a href="#l13.15"></a><span id="l13.15">       if (NS_SUCCEEDED(rv))</span>
<a href="#l13.16"></a><span id="l13.16">         rv = composeService-&gt;OpenComposeWindowWithURI(nullptr, aUri, identity);</span>
<a href="#l13.17"></a><span id="l13.17">     }</span>
<a href="#l13.18"></a><span id="l13.18">   } else {</span>
<a href="#l13.19"></a><span id="l13.19">     // The content-type was not application/x-mailto...</span>
<a href="#l13.20"></a><span id="l13.20">     return NS_ERROR_WONT_HANDLE_CONTENT;</span>
<a href="#l13.21"></a><span id="l13.21">   }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgComposeContentHandler.h</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgComposeContentHandler.h</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -3,17 +3,17 @@</span>
<a href="#l14.4"></a><span id="l14.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l14.5"></a><span id="l14.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l14.6"></a><span id="l14.6"> </span>
<a href="#l14.7"></a><span id="l14.7"> #include &quot;nsIContentHandler.h&quot;</span>
<a href="#l14.8"></a><span id="l14.8"> #include &quot;nsIMsgIdentity.h&quot;</span>
<a href="#l14.9"></a><span id="l14.9"> </span>
<a href="#l14.10"></a><span id="l14.10"> class nsMsgComposeContentHandler : public nsIContentHandler</span>
<a href="#l14.11"></a><span id="l14.11"> {</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-public: </span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+public:</span>
<a href="#l14.14"></a><span id="l14.14"> 	nsMsgComposeContentHandler();</span>
<a href="#l14.15"></a><span id="l14.15"> </span>
<a href="#l14.16"></a><span id="l14.16"> 	NS_DECL_ISUPPORTS</span>
<a href="#l14.17"></a><span id="l14.17">   NS_DECL_NSICONTENTHANDLER</span>
<a href="#l14.18"></a><span id="l14.18"> private:</span>
<a href="#l14.19"></a><span id="l14.19"> 	virtual ~nsMsgComposeContentHandler();</span>
<a href="#l14.20"></a><span id="l14.20">   nsresult GetBestIdentity(nsIInterfaceRequestor* aWindowContext,</span>
<a href="#l14.21"></a><span id="l14.21">                            nsIMsgIdentity **identity);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgComposeParams.cpp</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgComposeParams.cpp</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -18,45 +18,45 @@ NS_IMPL_ISUPPORTS(nsMsgComposeParams, ns</span>
<a href="#l15.4"></a><span id="l15.4"> nsMsgComposeParams::~nsMsgComposeParams()</span>
<a href="#l15.5"></a><span id="l15.5"> {</span>
<a href="#l15.6"></a><span id="l15.6"> }</span>
<a href="#l15.7"></a><span id="l15.7"> </span>
<a href="#l15.8"></a><span id="l15.8"> /* attribute MSG_ComposeType type; */</span>
<a href="#l15.9"></a><span id="l15.9"> NS_IMETHODIMP nsMsgComposeParams::GetType(MSG_ComposeType *aType)</span>
<a href="#l15.10"></a><span id="l15.10"> {</span>
<a href="#l15.11"></a><span id="l15.11">   NS_ENSURE_ARG_POINTER(aType);</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-  </span>
<a href="#l15.13"></a><span id="l15.13" class="difflineplus">+</span>
<a href="#l15.14"></a><span id="l15.14">   *aType = mType;</span>
<a href="#l15.15"></a><span id="l15.15">   return NS_OK;</span>
<a href="#l15.16"></a><span id="l15.16"> }</span>
<a href="#l15.17"></a><span id="l15.17"> NS_IMETHODIMP nsMsgComposeParams::SetType(MSG_ComposeType aType)</span>
<a href="#l15.18"></a><span id="l15.18"> {</span>
<a href="#l15.19"></a><span id="l15.19">   mType = aType;</span>
<a href="#l15.20"></a><span id="l15.20">   return NS_OK;</span>
<a href="#l15.21"></a><span id="l15.21"> }</span>
<a href="#l15.22"></a><span id="l15.22"> </span>
<a href="#l15.23"></a><span id="l15.23"> /* attribute MSG_ComposeFormat format; */</span>
<a href="#l15.24"></a><span id="l15.24"> NS_IMETHODIMP nsMsgComposeParams::GetFormat(MSG_ComposeFormat *aFormat)</span>
<a href="#l15.25"></a><span id="l15.25"> {</span>
<a href="#l15.26"></a><span id="l15.26">   NS_ENSURE_ARG_POINTER(aFormat);</span>
<a href="#l15.27"></a><span id="l15.27" class="difflineminus">-  </span>
<a href="#l15.28"></a><span id="l15.28" class="difflineplus">+</span>
<a href="#l15.29"></a><span id="l15.29">   *aFormat = mFormat;</span>
<a href="#l15.30"></a><span id="l15.30">   return NS_OK;</span>
<a href="#l15.31"></a><span id="l15.31"> }</span>
<a href="#l15.32"></a><span id="l15.32"> NS_IMETHODIMP nsMsgComposeParams::SetFormat(MSG_ComposeFormat aFormat)</span>
<a href="#l15.33"></a><span id="l15.33"> {</span>
<a href="#l15.34"></a><span id="l15.34">   mFormat = aFormat;</span>
<a href="#l15.35"></a><span id="l15.35">   return NS_OK;</span>
<a href="#l15.36"></a><span id="l15.36"> }</span>
<a href="#l15.37"></a><span id="l15.37"> </span>
<a href="#l15.38"></a><span id="l15.38"> /* attribute string originalMsgURI; */</span>
<a href="#l15.39"></a><span id="l15.39"> NS_IMETHODIMP nsMsgComposeParams::GetOriginalMsgURI(char * *aOriginalMsgURI)</span>
<a href="#l15.40"></a><span id="l15.40"> {</span>
<a href="#l15.41"></a><span id="l15.41">   NS_ENSURE_ARG_POINTER(aOriginalMsgURI);</span>
<a href="#l15.42"></a><span id="l15.42" class="difflineminus">-  </span>
<a href="#l15.43"></a><span id="l15.43" class="difflineplus">+</span>
<a href="#l15.44"></a><span id="l15.44">   *aOriginalMsgURI = ToNewCString(mOriginalMsgUri);</span>
<a href="#l15.45"></a><span id="l15.45">   return NS_OK;</span>
<a href="#l15.46"></a><span id="l15.46"> }</span>
<a href="#l15.47"></a><span id="l15.47"> NS_IMETHODIMP nsMsgComposeParams::SetOriginalMsgURI(const char * aOriginalMsgURI)</span>
<a href="#l15.48"></a><span id="l15.48"> {</span>
<a href="#l15.49"></a><span id="l15.49">   mOriginalMsgUri = aOriginalMsgURI;</span>
<a href="#l15.50"></a><span id="l15.50">   return NS_OK;</span>
<a href="#l15.51"></a><span id="l15.51"> }</span>
<a href="#l15.52"></a><span id="l15.52" class="difflineat">@@ -99,17 +99,17 @@ NS_IMETHODIMP nsMsgComposeParams::SetHtm</span>
<a href="#l15.53"></a><span id="l15.53">   mHtmlToQuote = aHtmlToQuote;</span>
<a href="#l15.54"></a><span id="l15.54">   return NS_OK;</span>
<a href="#l15.55"></a><span id="l15.55"> }</span>
<a href="#l15.56"></a><span id="l15.56"> </span>
<a href="#l15.57"></a><span id="l15.57"> /* attribute nsIMsgCompFields composeFields; */</span>
<a href="#l15.58"></a><span id="l15.58"> NS_IMETHODIMP nsMsgComposeParams::GetComposeFields(nsIMsgCompFields * *aComposeFields)</span>
<a href="#l15.59"></a><span id="l15.59"> {</span>
<a href="#l15.60"></a><span id="l15.60">   NS_ENSURE_ARG_POINTER(aComposeFields);</span>
<a href="#l15.61"></a><span id="l15.61" class="difflineminus">-  </span>
<a href="#l15.62"></a><span id="l15.62" class="difflineplus">+</span>
<a href="#l15.63"></a><span id="l15.63">   if (mComposeFields)</span>
<a href="#l15.64"></a><span id="l15.64">   {</span>
<a href="#l15.65"></a><span id="l15.65">      NS_ADDREF(*aComposeFields = mComposeFields);</span>
<a href="#l15.66"></a><span id="l15.66">   }</span>
<a href="#l15.67"></a><span id="l15.67">   else</span>
<a href="#l15.68"></a><span id="l15.68">     *aComposeFields = nullptr;</span>
<a href="#l15.69"></a><span id="l15.69">   return NS_OK;</span>
<a href="#l15.70"></a><span id="l15.70"> }</span>
<a href="#l15.71"></a><span id="l15.71" class="difflineat">@@ -118,31 +118,31 @@ NS_IMETHODIMP nsMsgComposeParams::SetCom</span>
<a href="#l15.72"></a><span id="l15.72">   mComposeFields = aComposeFields;</span>
<a href="#l15.73"></a><span id="l15.73">   return NS_OK;</span>
<a href="#l15.74"></a><span id="l15.74"> }</span>
<a href="#l15.75"></a><span id="l15.75"> </span>
<a href="#l15.76"></a><span id="l15.76"> /* attribute boolean bodyIsLink; */</span>
<a href="#l15.77"></a><span id="l15.77"> NS_IMETHODIMP nsMsgComposeParams::GetBodyIsLink(bool *aBodyIsLink)</span>
<a href="#l15.78"></a><span id="l15.78"> {</span>
<a href="#l15.79"></a><span id="l15.79">   NS_ENSURE_ARG_POINTER(aBodyIsLink);</span>
<a href="#l15.80"></a><span id="l15.80" class="difflineminus">-  </span>
<a href="#l15.81"></a><span id="l15.81" class="difflineplus">+</span>
<a href="#l15.82"></a><span id="l15.82">   *aBodyIsLink = mBodyIsLink;</span>
<a href="#l15.83"></a><span id="l15.83">   return NS_OK;</span>
<a href="#l15.84"></a><span id="l15.84"> }</span>
<a href="#l15.85"></a><span id="l15.85"> NS_IMETHODIMP nsMsgComposeParams::SetBodyIsLink(bool aBodyIsLink)</span>
<a href="#l15.86"></a><span id="l15.86"> {</span>
<a href="#l15.87"></a><span id="l15.87">   mBodyIsLink = aBodyIsLink;</span>
<a href="#l15.88"></a><span id="l15.88">   return NS_OK;</span>
<a href="#l15.89"></a><span id="l15.89"> }</span>
<a href="#l15.90"></a><span id="l15.90"> </span>
<a href="#l15.91"></a><span id="l15.91"> /* attribute nsIMsgSendLisneter sendListener; */</span>
<a href="#l15.92"></a><span id="l15.92"> NS_IMETHODIMP nsMsgComposeParams::GetSendListener(nsIMsgSendListener * *aSendListener)</span>
<a href="#l15.93"></a><span id="l15.93"> {</span>
<a href="#l15.94"></a><span id="l15.94">   NS_ENSURE_ARG_POINTER(aSendListener);</span>
<a href="#l15.95"></a><span id="l15.95" class="difflineminus">-  </span>
<a href="#l15.96"></a><span id="l15.96" class="difflineplus">+</span>
<a href="#l15.97"></a><span id="l15.97">   if (mSendListener)</span>
<a href="#l15.98"></a><span id="l15.98">   {</span>
<a href="#l15.99"></a><span id="l15.99">      NS_ADDREF(*aSendListener = mSendListener);</span>
<a href="#l15.100"></a><span id="l15.100">   }</span>
<a href="#l15.101"></a><span id="l15.101">   else</span>
<a href="#l15.102"></a><span id="l15.102">     *aSendListener = nullptr;</span>
<a href="#l15.103"></a><span id="l15.103">   return NS_OK;</span>
<a href="#l15.104"></a><span id="l15.104"> }</span>
<a href="#l15.105"></a><span id="l15.105" class="difflineat">@@ -151,17 +151,17 @@ NS_IMETHODIMP nsMsgComposeParams::SetSen</span>
<a href="#l15.106"></a><span id="l15.106">   mSendListener = aSendListener;</span>
<a href="#l15.107"></a><span id="l15.107">   return NS_OK;</span>
<a href="#l15.108"></a><span id="l15.108"> }</span>
<a href="#l15.109"></a><span id="l15.109"> </span>
<a href="#l15.110"></a><span id="l15.110"> /* attribute string smtpPassword; */</span>
<a href="#l15.111"></a><span id="l15.111"> NS_IMETHODIMP nsMsgComposeParams::GetSmtpPassword(char * *aSmtpPassword)</span>
<a href="#l15.112"></a><span id="l15.112"> {</span>
<a href="#l15.113"></a><span id="l15.113">   NS_ENSURE_ARG_POINTER(aSmtpPassword);</span>
<a href="#l15.114"></a><span id="l15.114" class="difflineminus">-  </span>
<a href="#l15.115"></a><span id="l15.115" class="difflineplus">+</span>
<a href="#l15.116"></a><span id="l15.116">   *aSmtpPassword = ToNewCString(mSMTPPassword);</span>
<a href="#l15.117"></a><span id="l15.117">   return NS_OK;</span>
<a href="#l15.118"></a><span id="l15.118"> }</span>
<a href="#l15.119"></a><span id="l15.119"> NS_IMETHODIMP nsMsgComposeParams::SetSmtpPassword(const char * aSmtpPassword)</span>
<a href="#l15.120"></a><span id="l15.120"> {</span>
<a href="#l15.121"></a><span id="l15.121">   mSMTPPassword = aSmtpPassword;</span>
<a href="#l15.122"></a><span id="l15.122">   return NS_OK;</span>
<a href="#l15.123"></a><span id="l15.123"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgComposeParams.h</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgComposeParams.h</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -4,22 +4,22 @@</span>
<a href="#l16.4"></a><span id="l16.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l16.5"></a><span id="l16.5"> </span>
<a href="#l16.6"></a><span id="l16.6"> #include &quot;nsIMsgComposeParams.h&quot;</span>
<a href="#l16.7"></a><span id="l16.7"> #include &quot;nsString.h&quot;</span>
<a href="#l16.8"></a><span id="l16.8"> #include &quot;nsIMsgHdr.h&quot;</span>
<a href="#l16.9"></a><span id="l16.9"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l16.10"></a><span id="l16.10"> class nsMsgComposeParams : public nsIMsgComposeParams</span>
<a href="#l16.11"></a><span id="l16.11"> {</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-public: </span>
<a href="#l16.13"></a><span id="l16.13" class="difflineplus">+public:</span>
<a href="#l16.14"></a><span id="l16.14">   nsMsgComposeParams();</span>
<a href="#l16.15"></a><span id="l16.15"> </span>
<a href="#l16.16"></a><span id="l16.16">   NS_DECL_ISUPPORTS</span>
<a href="#l16.17"></a><span id="l16.17">   NS_DECL_NSIMSGCOMPOSEPARAMS</span>
<a href="#l16.18"></a><span id="l16.18" class="difflineminus">-  </span>
<a href="#l16.19"></a><span id="l16.19" class="difflineplus">+</span>
<a href="#l16.20"></a><span id="l16.20"> private:</span>
<a href="#l16.21"></a><span id="l16.21">   virtual ~nsMsgComposeParams();</span>
<a href="#l16.22"></a><span id="l16.22">   MSG_ComposeType               mType;</span>
<a href="#l16.23"></a><span id="l16.23">   MSG_ComposeFormat             mFormat;</span>
<a href="#l16.24"></a><span id="l16.24">   nsCString                     mOriginalMsgUri;</span>
<a href="#l16.25"></a><span id="l16.25">   nsCOMPtr&lt;nsIMsgIdentity&gt;      mIdentity;</span>
<a href="#l16.26"></a><span id="l16.26">   nsCOMPtr&lt;nsIMsgCompFields&gt;    mComposeFields;</span>
<a href="#l16.27"></a><span id="l16.27">   bool                          mBodyIsLink;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgComposeProgressParams.cpp</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgComposeProgressParams.cpp</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -16,31 +16,31 @@ nsMsgComposeProgressParams::nsMsgCompose</span>
<a href="#l17.4"></a><span id="l17.4"> nsMsgComposeProgressParams::~nsMsgComposeProgressParams()</span>
<a href="#l17.5"></a><span id="l17.5"> {</span>
<a href="#l17.6"></a><span id="l17.6"> }</span>
<a href="#l17.7"></a><span id="l17.7"> </span>
<a href="#l17.8"></a><span id="l17.8"> /* attribute wstring subject; */</span>
<a href="#l17.9"></a><span id="l17.9"> NS_IMETHODIMP nsMsgComposeProgressParams::GetSubject(char16_t * *aSubject)</span>
<a href="#l17.10"></a><span id="l17.10"> {</span>
<a href="#l17.11"></a><span id="l17.11">   NS_ENSURE_ARG(aSubject);</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-  </span>
<a href="#l17.13"></a><span id="l17.13" class="difflineplus">+</span>
<a href="#l17.14"></a><span id="l17.14">   *aSubject = ToNewUnicode(m_subject);</span>
<a href="#l17.15"></a><span id="l17.15">   return NS_OK;</span>
<a href="#l17.16"></a><span id="l17.16"> }</span>
<a href="#l17.17"></a><span id="l17.17"> NS_IMETHODIMP nsMsgComposeProgressParams::SetSubject(const char16_t * aSubject)</span>
<a href="#l17.18"></a><span id="l17.18"> {</span>
<a href="#l17.19"></a><span id="l17.19">   m_subject = aSubject;</span>
<a href="#l17.20"></a><span id="l17.20">   return NS_OK;</span>
<a href="#l17.21"></a><span id="l17.21"> }</span>
<a href="#l17.22"></a><span id="l17.22"> </span>
<a href="#l17.23"></a><span id="l17.23"> /* attribute MSG_DeliverMode deliveryMode; */</span>
<a href="#l17.24"></a><span id="l17.24"> NS_IMETHODIMP nsMsgComposeProgressParams::GetDeliveryMode(MSG_DeliverMode *aDeliveryMode)</span>
<a href="#l17.25"></a><span id="l17.25"> {</span>
<a href="#l17.26"></a><span id="l17.26">   NS_ENSURE_ARG(aDeliveryMode);</span>
<a href="#l17.27"></a><span id="l17.27" class="difflineminus">-  </span>
<a href="#l17.28"></a><span id="l17.28" class="difflineplus">+</span>
<a href="#l17.29"></a><span id="l17.29">   *aDeliveryMode = m_deliveryMode;</span>
<a href="#l17.30"></a><span id="l17.30">   return NS_OK;</span>
<a href="#l17.31"></a><span id="l17.31"> }</span>
<a href="#l17.32"></a><span id="l17.32"> NS_IMETHODIMP nsMsgComposeProgressParams::SetDeliveryMode(MSG_DeliverMode aDeliveryMode)</span>
<a href="#l17.33"></a><span id="l17.33"> {</span>
<a href="#l17.34"></a><span id="l17.34">   m_deliveryMode = aDeliveryMode;</span>
<a href="#l17.35"></a><span id="l17.35">   return NS_OK;</span>
<a href="#l17.36"></a><span id="l17.36"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgComposeProgressParams.h</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgComposeProgressParams.h</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -2,17 +2,17 @@</span>
<a href="#l18.4"></a><span id="l18.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l18.5"></a><span id="l18.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l18.6"></a><span id="l18.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l18.7"></a><span id="l18.7"> </span>
<a href="#l18.8"></a><span id="l18.8"> #include &quot;nsIMsgComposeProgressParams.h&quot;</span>
<a href="#l18.9"></a><span id="l18.9"> </span>
<a href="#l18.10"></a><span id="l18.10"> class nsMsgComposeProgressParams : public nsIMsgComposeProgressParams</span>
<a href="#l18.11"></a><span id="l18.11"> {</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-public: </span>
<a href="#l18.13"></a><span id="l18.13" class="difflineplus">+public:</span>
<a href="#l18.14"></a><span id="l18.14"> 	NS_DECL_ISUPPORTS</span>
<a href="#l18.15"></a><span id="l18.15">   NS_DECL_NSIMSGCOMPOSEPROGRESSPARAMS</span>
<a href="#l18.16"></a><span id="l18.16"> </span>
<a href="#l18.17"></a><span id="l18.17"> 	nsMsgComposeProgressParams();</span>
<a href="#l18.18"></a><span id="l18.18"> </span>
<a href="#l18.19"></a><span id="l18.19"> private:</span>
<a href="#l18.20"></a><span id="l18.20"> 	virtual ~nsMsgComposeProgressParams();</span>
<a href="#l18.21"></a><span id="l18.21">   nsString                          m_subject;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgComposeService.h</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgComposeService.h</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -12,39 +12,39 @@</span>
<a href="#l19.4"></a><span id="l19.4"> #include &quot;nsIObserver.h&quot;</span>
<a href="#l19.5"></a><span id="l19.5"> #include &quot;nsWeakReference.h&quot;</span>
<a href="#l19.6"></a><span id="l19.6"> #include &quot;nsIMimeStreamConverter.h&quot;</span>
<a href="#l19.7"></a><span id="l19.7"> #include &quot;nsInterfaceHashtable.h&quot;</span>
<a href="#l19.8"></a><span id="l19.8"> </span>
<a href="#l19.9"></a><span id="l19.9"> #include &quot;nsICommandLineHandler.h&quot;</span>
<a href="#l19.10"></a><span id="l19.10"> #define ICOMMANDLINEHANDLER nsICommandLineHandler</span>
<a href="#l19.11"></a><span id="l19.11"> </span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-class nsMsgComposeService : </span>
<a href="#l19.13"></a><span id="l19.13" class="difflineplus">+class nsMsgComposeService :</span>
<a href="#l19.14"></a><span id="l19.14">   public nsIMsgComposeService,</span>
<a href="#l19.15"></a><span id="l19.15">   public ICOMMANDLINEHANDLER,</span>
<a href="#l19.16"></a><span id="l19.16">   public nsSupportsWeakReference</span>
<a href="#l19.17"></a><span id="l19.17"> {</span>
<a href="#l19.18"></a><span id="l19.18" class="difflineminus">-public: </span>
<a href="#l19.19"></a><span id="l19.19" class="difflineplus">+public:</span>
<a href="#l19.20"></a><span id="l19.20"> 	nsMsgComposeService();</span>
<a href="#l19.21"></a><span id="l19.21"> </span>
<a href="#l19.22"></a><span id="l19.22"> 	NS_DECL_ISUPPORTS</span>
<a href="#l19.23"></a><span id="l19.23">   NS_DECL_NSIMSGCOMPOSESERVICE</span>
<a href="#l19.24"></a><span id="l19.24">   NS_DECL_NSICOMMANDLINEHANDLER</span>
<a href="#l19.25"></a><span id="l19.25"> </span>
<a href="#l19.26"></a><span id="l19.26">   nsresult Init();</span>
<a href="#l19.27"></a><span id="l19.27">   void Reset();</span>
<a href="#l19.28"></a><span id="l19.28">   void DeleteCachedWindows();</span>
<a href="#l19.29"></a><span id="l19.29">   nsresult AddGlobalHtmlDomains();</span>
<a href="#l19.30"></a><span id="l19.30"> </span>
<a href="#l19.31"></a><span id="l19.31"> private:</span>
<a href="#l19.32"></a><span id="l19.32"> 	virtual ~nsMsgComposeService();</span>
<a href="#l19.33"></a><span id="l19.33">   bool mLogComposePerformance;</span>
<a href="#l19.34"></a><span id="l19.34"> </span>
<a href="#l19.35"></a><span id="l19.35" class="difflineminus">-  nsresult LoadDraftOrTemplate(const nsACString&amp; aMsgURI, nsMimeOutputType aOutType, </span>
<a href="#l19.36"></a><span id="l19.36" class="difflineminus">-                               nsIMsgIdentity * aIdentity, const char * aOriginalMsgURI, </span>
<a href="#l19.37"></a><span id="l19.37" class="difflineplus">+  nsresult LoadDraftOrTemplate(const nsACString&amp; aMsgURI, nsMimeOutputType aOutType,</span>
<a href="#l19.38"></a><span id="l19.38" class="difflineplus">+                               nsIMsgIdentity * aIdentity, const char * aOriginalMsgURI,</span>
<a href="#l19.39"></a><span id="l19.39">                                nsIMsgDBHdr * aOrigMsgHdr, bool aForwardInline,</span>
<a href="#l19.40"></a><span id="l19.40">                                bool overrideComposeFormat,</span>
<a href="#l19.41"></a><span id="l19.41">                                nsIMsgWindow *aMsgWindow);</span>
<a href="#l19.42"></a><span id="l19.42"> </span>
<a href="#l19.43"></a><span id="l19.43">   nsresult RunMessageThroughMimeDraft(const nsACString&amp; aMsgURI,</span>
<a href="#l19.44"></a><span id="l19.44">                                       nsMimeOutputType aOutType,</span>
<a href="#l19.45"></a><span id="l19.45">                                       nsIMsgIdentity * aIdentity,</span>
<a href="#l19.46"></a><span id="l19.46">                                       const char * aOriginalMsgURI,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgCopy.h</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgCopy.h</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -19,39 +19,39 @@</span>
<a href="#l20.4"></a><span id="l20.4"> #define NS_IMSGCOPY_IID           \</span>
<a href="#l20.5"></a><span id="l20.5"> { 0x874c3b5, 0x317d, 0x11d3,      \</span>
<a href="#l20.6"></a><span id="l20.6"> { 0x8e, 0xfb, 0x0, 0xa0, 0x24, 0xa7, 0xd1, 0x44 } };</span>
<a href="#l20.7"></a><span id="l20.7"> </span>
<a href="#l20.8"></a><span id="l20.8"> // Forward declarations...</span>
<a href="#l20.9"></a><span id="l20.9"> class   nsMsgCopy;</span>
<a href="#l20.10"></a><span id="l20.10"> </span>
<a href="#l20.11"></a><span id="l20.11"> ////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l20.12"></a><span id="l20.12" class="difflineminus">-// This is the listener class for the copy operation. We have to create this class </span>
<a href="#l20.13"></a><span id="l20.13" class="difflineplus">+// This is the listener class for the copy operation. We have to create this class</span>
<a href="#l20.14"></a><span id="l20.14"> // to listen for message copy completion and eventually notify the caller</span>
<a href="#l20.15"></a><span id="l20.15"> ////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l20.16"></a><span id="l20.16"> class CopyListener : public nsIMsgCopyServiceListener</span>
<a href="#l20.17"></a><span id="l20.17"> {</span>
<a href="#l20.18"></a><span id="l20.18"> public:</span>
<a href="#l20.19"></a><span id="l20.19">   CopyListener(void);</span>
<a href="#l20.20"></a><span id="l20.20"> </span>
<a href="#l20.21"></a><span id="l20.21">   // nsISupports interface</span>
<a href="#l20.22"></a><span id="l20.22">   NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l20.23"></a><span id="l20.23"> </span>
<a href="#l20.24"></a><span id="l20.24">   NS_IMETHOD OnStartCopy() override;</span>
<a href="#l20.25"></a><span id="l20.25" class="difflineminus">-  </span>
<a href="#l20.26"></a><span id="l20.26" class="difflineplus">+</span>
<a href="#l20.27"></a><span id="l20.27">   NS_IMETHOD OnProgress(uint32_t aProgress, uint32_t aProgressMax) override;</span>
<a href="#l20.28"></a><span id="l20.28"> </span>
<a href="#l20.29"></a><span id="l20.29">   NS_IMETHOD SetMessageKey(nsMsgKey aMessageKey) override;</span>
<a href="#l20.30"></a><span id="l20.30"> </span>
<a href="#l20.31"></a><span id="l20.31">   NS_IMETHOD GetMessageId(nsACString&amp; aMessageId) override;</span>
<a href="#l20.32"></a><span id="l20.32" class="difflineminus">-  </span>
<a href="#l20.33"></a><span id="l20.33" class="difflineplus">+</span>
<a href="#l20.34"></a><span id="l20.34">   NS_IMETHOD OnStopCopy(nsresult aStatus) override;</span>
<a href="#l20.35"></a><span id="l20.35"> </span>
<a href="#l20.36"></a><span id="l20.36">   NS_IMETHOD SetMsgComposeAndSendObject(nsIMsgSend *obj);</span>
<a href="#l20.37"></a><span id="l20.37" class="difflineminus">-  </span>
<a href="#l20.38"></a><span id="l20.38" class="difflineplus">+</span>
<a href="#l20.39"></a><span id="l20.39">   bool                            mCopyInProgress;</span>
<a href="#l20.40"></a><span id="l20.40"> </span>
<a href="#l20.41"></a><span id="l20.41"> private:</span>
<a href="#l20.42"></a><span id="l20.42">   virtual ~CopyListener();</span>
<a href="#l20.43"></a><span id="l20.43">   nsCOMPtr&lt;nsIMsgSend&gt;       mComposeAndSend;</span>
<a href="#l20.44"></a><span id="l20.44"> };</span>
<a href="#l20.45"></a><span id="l20.45"> </span>
<a href="#l20.46"></a><span id="l20.46"> //</span>
<a href="#l20.47"></a><span id="l20.47" class="difflineat">@@ -68,53 +68,53 @@ public:</span>
<a href="#l20.48"></a><span id="l20.48">   NS_DECL_NSIURLLISTENER</span>
<a href="#l20.49"></a><span id="l20.49"> </span>
<a href="#l20.50"></a><span id="l20.50"> </span>
<a href="#l20.51"></a><span id="l20.51">   //////////////////////////////////////////////////////////////////////</span>
<a href="#l20.52"></a><span id="l20.52">   // Object methods...</span>
<a href="#l20.53"></a><span id="l20.53">   //////////////////////////////////////////////////////////////////////</span>
<a href="#l20.54"></a><span id="l20.54">   //</span>
<a href="#l20.55"></a><span id="l20.55">   nsresult              StartCopyOperation(nsIMsgIdentity       *aUserIdentity,</span>
<a href="#l20.56"></a><span id="l20.56" class="difflineminus">-                                           nsIFile          *aFile, </span>
<a href="#l20.57"></a><span id="l20.57" class="difflineplus">+                                           nsIFile          *aFile,</span>
<a href="#l20.58"></a><span id="l20.58">                                            nsMsgDeliverMode     aMode,</span>
<a href="#l20.59"></a><span id="l20.59">                                            nsIMsgSend           *aMsgSendObj,</span>
<a href="#l20.60"></a><span id="l20.60">                                            const char           *aSavePref,</span>
<a href="#l20.61"></a><span id="l20.61">                                            nsIMsgDBHdr          *aMsgToReplace);</span>
<a href="#l20.62"></a><span id="l20.62"> </span>
<a href="#l20.63"></a><span id="l20.63">   nsresult              DoCopy(nsIFile *aDiskFile, nsIMsgFolder *dstFolder,</span>
<a href="#l20.64"></a><span id="l20.64">                                nsIMsgDBHdr *aMsgToReplace, bool aIsDraft,</span>
<a href="#l20.65"></a><span id="l20.65">                                nsIMsgWindow *msgWindow,</span>
<a href="#l20.66"></a><span id="l20.66">                                nsIMsgSend   *aMsgSendObj);</span>
<a href="#l20.67"></a><span id="l20.67"> </span>
<a href="#l20.68"></a><span id="l20.68">   nsresult	GetUnsentMessagesFolder(nsIMsgIdentity *userIdentity, nsIMsgFolder **msgFolder, bool *waitForUrl);</span>
<a href="#l20.69"></a><span id="l20.69">   nsresult	GetDraftsFolder(nsIMsgIdentity *userIdentity, nsIMsgFolder **msgFolder, bool *waitForUrl);</span>
<a href="#l20.70"></a><span id="l20.70">   nsresult	GetTemplatesFolder(nsIMsgIdentity *userIdentity, nsIMsgFolder **msgFolder, bool *waitForUrl);</span>
<a href="#l20.71"></a><span id="l20.71">   nsresult	GetSentFolder(nsIMsgIdentity *userIdentity,  nsIMsgFolder **msgFolder, bool *waitForUrl);</span>
<a href="#l20.72"></a><span id="l20.72">   nsresult   CreateIfMissing(nsIMsgFolder **folder, bool *waitForUrl);</span>
<a href="#l20.73"></a><span id="l20.73"> </span>
<a href="#l20.74"></a><span id="l20.74" class="difflineminus">-  </span>
<a href="#l20.75"></a><span id="l20.75" class="difflineplus">+</span>
<a href="#l20.76"></a><span id="l20.76">   //</span>
<a href="#l20.77"></a><span id="l20.77">   // Vars for implementation...</span>
<a href="#l20.78"></a><span id="l20.78">   //</span>
<a href="#l20.79"></a><span id="l20.79">   nsIFile                     *mFile;     // the file we are sending...</span>
<a href="#l20.80"></a><span id="l20.80">   nsMsgDeliverMode                mMode;</span>
<a href="#l20.81"></a><span id="l20.81">   nsCOMPtr&lt;nsIMsgFolder&gt;          mDstFolder;</span>
<a href="#l20.82"></a><span id="l20.82">   nsCOMPtr&lt;nsIMsgDBHdr&gt;           mMsgToReplace;</span>
<a href="#l20.83"></a><span id="l20.83">   bool                            mIsDraft;</span>
<a href="#l20.84"></a><span id="l20.84">   nsCOMPtr&lt;nsIMsgSend&gt;            mMsgSendObj;</span>
<a href="#l20.85"></a><span id="l20.85">   char                            *mSavePref;</span>
<a href="#l20.86"></a><span id="l20.86"> </span>
<a href="#l20.87"></a><span id="l20.87"> private:</span>
<a href="#l20.88"></a><span id="l20.88">   virtual ~nsMsgCopy();</span>
<a href="#l20.89"></a><span id="l20.89"> };</span>
<a href="#l20.90"></a><span id="l20.90"> </span>
<a href="#l20.91"></a><span id="l20.91"> // Useful function for the back end...</span>
<a href="#l20.92"></a><span id="l20.92" class="difflineminus">-nsresult	LocateMessageFolder(nsIMsgIdentity   *userIdentity, </span>
<a href="#l20.93"></a><span id="l20.93" class="difflineplus">+nsresult	LocateMessageFolder(nsIMsgIdentity   *userIdentity,</span>
<a href="#l20.94"></a><span id="l20.94">                                        nsMsgDeliverMode aFolderType,</span>
<a href="#l20.95"></a><span id="l20.95">                                        const char       *aSaveURI,</span>
<a href="#l20.96"></a><span id="l20.96"> 				       nsIMsgFolder **msgFolder);</span>
<a href="#l20.97"></a><span id="l20.97"> </span>
<a href="#l20.98"></a><span id="l20.98" class="difflineminus">-nsresult	MessageFolderIsLocal(nsIMsgIdentity   *userIdentity, </span>
<a href="#l20.99"></a><span id="l20.99" class="difflineplus">+nsresult	MessageFolderIsLocal(nsIMsgIdentity   *userIdentity,</span>
<a href="#l20.100"></a><span id="l20.100">                                        nsMsgDeliverMode aFolderType,</span>
<a href="#l20.101"></a><span id="l20.101">                                        const char       *aSaveURI,</span>
<a href="#l20.102"></a><span id="l20.102"> 				       bool		*aResult);</span>
<a href="#l20.103"></a><span id="l20.103"> </span>
<a href="#l20.104"></a><span id="l20.104"> #endif /* _nsMsgCopy_H_ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgQuote.cpp</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgQuote.cpp</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -9,17 +9,17 @@</span>
<a href="#l21.4"></a><span id="l21.4"> #include &quot;nsIServiceManager.h&quot;</span>
<a href="#l21.5"></a><span id="l21.5"> #include &quot;nsIStreamListener.h&quot;</span>
<a href="#l21.6"></a><span id="l21.6"> #include &quot;nsIStreamConverter.h&quot;</span>
<a href="#l21.7"></a><span id="l21.7"> #include &quot;nsIStreamConverterService.h&quot;</span>
<a href="#l21.8"></a><span id="l21.8"> #include &quot;nsIMimeStreamConverter.h&quot;</span>
<a href="#l21.9"></a><span id="l21.9"> #include &quot;nsMimeTypes.h&quot;</span>
<a href="#l21.10"></a><span id="l21.10"> #include &quot;nsICharsetConverterManager.h&quot;</span>
<a href="#l21.11"></a><span id="l21.11"> #include &quot;prprf.h&quot;</span>
<a href="#l21.12"></a><span id="l21.12" class="difflineminus">-#include &quot;nsMsgQuote.h&quot; </span>
<a href="#l21.13"></a><span id="l21.13" class="difflineplus">+#include &quot;nsMsgQuote.h&quot;</span>
<a href="#l21.14"></a><span id="l21.14"> #include &quot;nsMsgCompUtils.h&quot;</span>
<a href="#l21.15"></a><span id="l21.15"> #include &quot;nsIMsgMessageService.h&quot;</span>
<a href="#l21.16"></a><span id="l21.16"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l21.17"></a><span id="l21.17"> #include &quot;nsNetUtil.h&quot;</span>
<a href="#l21.18"></a><span id="l21.18"> #include &quot;nsMsgMimeCID.h&quot;</span>
<a href="#l21.19"></a><span id="l21.19"> #include &quot;nsMsgCompCID.h&quot;</span>
<a href="#l21.20"></a><span id="l21.20"> #include &quot;nsMsgCompose.h&quot;</span>
<a href="#l21.21"></a><span id="l21.21"> #include &quot;nsMsgMailNewsUrl.h&quot;</span>
<a href="#l21.22"></a><span id="l21.22" class="difflineat">@@ -180,29 +180,29 @@ nsMsgQuote::QuoteMessage(const char *msg</span>
<a href="#l21.23"></a><span id="l21.23">                                       nullptr,</span>
<a href="#l21.24"></a><span id="l21.24">                                       nsILoadInfo::SEC_ALLOW_CROSS_ORIGIN_DATA_IS_NULL,</span>
<a href="#l21.25"></a><span id="l21.25">                                       nsIContentPolicy::TYPE_OTHER,</span>
<a href="#l21.26"></a><span id="l21.26">                                       getter_AddRefs(mQuoteChannel));</span>
<a href="#l21.27"></a><span id="l21.27"> </span>
<a href="#l21.28"></a><span id="l21.28">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l21.29"></a><span id="l21.29">   nsCOMPtr&lt;nsISupports&gt; ctxt = do_QueryInterface(aURL);</span>
<a href="#l21.30"></a><span id="l21.30"> </span>
<a href="#l21.31"></a><span id="l21.31" class="difflineminus">-  nsCOMPtr&lt;nsIStreamConverterService&gt; streamConverterService = </span>
<a href="#l21.32"></a><span id="l21.32" class="difflineplus">+  nsCOMPtr&lt;nsIStreamConverterService&gt; streamConverterService =</span>
<a href="#l21.33"></a><span id="l21.33">            do_GetService(&quot;@mozilla.org/streamConverters;1&quot;, &amp;rv);</span>
<a href="#l21.34"></a><span id="l21.34">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l21.35"></a><span id="l21.35"> </span>
<a href="#l21.36"></a><span id="l21.36">   nsCOMPtr&lt;nsIStreamListener&gt; convertedListener;</span>
<a href="#l21.37"></a><span id="l21.37">   rv = streamConverterService-&gt;AsyncConvertData(&quot;message/rfc822&quot;,</span>
<a href="#l21.38"></a><span id="l21.38">                                                 &quot;application/vnd.mozilla.xul+xml&quot;,</span>
<a href="#l21.39"></a><span id="l21.39">                                                 mStreamListener,</span>
<a href="#l21.40"></a><span id="l21.40">                                                 quoteSupport,</span>
<a href="#l21.41"></a><span id="l21.41">                                                 getter_AddRefs(convertedListener));</span>
<a href="#l21.42"></a><span id="l21.42">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l21.43"></a><span id="l21.43"> </span>
<a href="#l21.44"></a><span id="l21.44" class="difflineminus">-  //  now try to open the channel passing in our display consumer as the listener </span>
<a href="#l21.45"></a><span id="l21.45" class="difflineplus">+  //  now try to open the channel passing in our display consumer as the listener</span>
<a href="#l21.46"></a><span id="l21.46">   rv = mQuoteChannel-&gt;AsyncOpen(convertedListener, ctxt);</span>
<a href="#l21.47"></a><span id="l21.47">   return rv;</span>
<a href="#l21.48"></a><span id="l21.48"> }</span>
<a href="#l21.49"></a><span id="l21.49"> </span>
<a href="#l21.50"></a><span id="l21.50"> NS_IMETHODIMP</span>
<a href="#l21.51"></a><span id="l21.51"> nsMsgQuote::GetQuoteListener(nsIMimeStreamConverterListener** aQuoteListener)</span>
<a href="#l21.52"></a><span id="l21.52"> {</span>
<a href="#l21.53"></a><span id="l21.53">     if (!aQuoteListener || !mQuoteListener)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgQuote.h</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgQuote.h</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -1,16 +1,16 @@</span>
<a href="#l22.4"></a><span id="l22.4"> /* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l22.5"></a><span id="l22.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l22.6"></a><span id="l22.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l22.7"></a><span id="l22.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l22.8"></a><span id="l22.8"> #ifndef __nsMsgQuote_h__</span>
<a href="#l22.9"></a><span id="l22.9"> #define __nsMsgQuote_h__</span>
<a href="#l22.10"></a><span id="l22.10"> </span>
<a href="#l22.11"></a><span id="l22.11" class="difflineminus">-#include &quot;nsIMsgQuote.h&quot; </span>
<a href="#l22.12"></a><span id="l22.12" class="difflineplus">+#include &quot;nsIMsgQuote.h&quot;</span>
<a href="#l22.13"></a><span id="l22.13"> #include &quot;nsIMsgMessageService.h&quot;</span>
<a href="#l22.14"></a><span id="l22.14"> #include &quot;nsIStreamListener.h&quot;</span>
<a href="#l22.15"></a><span id="l22.15"> #include &quot;nsIMimeStreamConverter.h&quot;</span>
<a href="#l22.16"></a><span id="l22.16"> #include &quot;nsIChannel.h&quot;</span>
<a href="#l22.17"></a><span id="l22.17"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l22.18"></a><span id="l22.18"> #include &quot;nsWeakReference.h&quot;</span>
<a href="#l22.19"></a><span id="l22.19"> </span>
<a href="#l22.20"></a><span id="l22.20"> class nsMsgQuote;</span>
<a href="#l22.21"></a><span id="l22.21" class="difflineat">@@ -27,25 +27,25 @@ public:</span>
<a href="#l22.22"></a><span id="l22.22">   NS_DECL_NSIMSGQUOTELISTENER</span>
<a href="#l22.23"></a><span id="l22.23"> </span>
<a href="#l22.24"></a><span id="l22.24"> private:</span>
<a href="#l22.25"></a><span id="l22.25"> 	virtual ~nsMsgQuoteListener();</span>
<a href="#l22.26"></a><span id="l22.26">   nsWeakPtr mMsgQuote;</span>
<a href="#l22.27"></a><span id="l22.27"> };</span>
<a href="#l22.28"></a><span id="l22.28"> </span>
<a href="#l22.29"></a><span id="l22.29"> class nsMsgQuote: public nsIMsgQuote, public nsSupportsWeakReference {</span>
<a href="#l22.30"></a><span id="l22.30" class="difflineminus">-public: </span>
<a href="#l22.31"></a><span id="l22.31" class="difflineplus">+public:</span>
<a href="#l22.32"></a><span id="l22.32">   nsMsgQuote();</span>
<a href="#l22.33"></a><span id="l22.33"> </span>
<a href="#l22.34"></a><span id="l22.34">   NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l22.35"></a><span id="l22.35">   NS_DECL_NSIMSGQUOTE</span>
<a href="#l22.36"></a><span id="l22.36"> </span>
<a href="#l22.37"></a><span id="l22.37"> private:</span>
<a href="#l22.38"></a><span id="l22.38">   virtual ~nsMsgQuote();</span>
<a href="#l22.39"></a><span id="l22.39" class="difflineminus">-  // </span>
<a href="#l22.40"></a><span id="l22.40" class="difflineplus">+  //</span>
<a href="#l22.41"></a><span id="l22.41">   // Implementation data...</span>
<a href="#l22.42"></a><span id="l22.42">   //</span>
<a href="#l22.43"></a><span id="l22.43">   nsCOMPtr&lt;nsIMsgQuotingOutputStreamListener&gt; mStreamListener;</span>
<a href="#l22.44"></a><span id="l22.44">   bool			mQuoteHeaders;</span>
<a href="#l22.45"></a><span id="l22.45">   nsCOMPtr&lt;nsIMsgQuoteListener&gt; mQuoteListener;</span>
<a href="#l22.46"></a><span id="l22.46">   nsCOMPtr&lt;nsIChannel&gt; mQuoteChannel;</span>
<a href="#l22.47"></a><span id="l22.47"> };</span>
<a href="#l22.48"></a><span id="l22.48"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgSendLater.cpp</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgSendLater.cpp</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -222,32 +222,32 @@ nsMsgSendLater::OnStopRequest(nsIRequest</span>
<a href="#l23.4"></a><span id="l23.4">   if (NS_SUCCEEDED(status))</span>
<a href="#l23.5"></a><span id="l23.5">   {</span>
<a href="#l23.6"></a><span id="l23.6">     // Message is done...send it!</span>
<a href="#l23.7"></a><span id="l23.7">     rv = CompleteMailFileSend();</span>
<a href="#l23.8"></a><span id="l23.8"> </span>
<a href="#l23.9"></a><span id="l23.9"> #ifdef NS_DEBUG</span>
<a href="#l23.10"></a><span id="l23.10">     printf(&quot;nsMsgSendLater: Success on getting message...\n&quot;);</span>
<a href="#l23.11"></a><span id="l23.11"> #endif</span>
<a href="#l23.12"></a><span id="l23.12" class="difflineminus">-    </span>
<a href="#l23.13"></a><span id="l23.13" class="difflineplus">+</span>
<a href="#l23.14"></a><span id="l23.14">     // If the send operation failed..try the next one...</span>
<a href="#l23.15"></a><span id="l23.15">     if (NS_FAILED(rv))</span>
<a href="#l23.16"></a><span id="l23.16">     {</span>
<a href="#l23.17"></a><span id="l23.17">       rv = StartNextMailFileSend(rv);</span>
<a href="#l23.18"></a><span id="l23.18">       if (NS_FAILED(rv))</span>
<a href="#l23.19"></a><span id="l23.19">         EndSendMessages(rv, nullptr, mTotalSendCount, mTotalSentSuccessfully);</span>
<a href="#l23.20"></a><span id="l23.20">     }</span>
<a href="#l23.21"></a><span id="l23.21">   }</span>
<a href="#l23.22"></a><span id="l23.22">   else</span>
<a href="#l23.23"></a><span id="l23.23">   {</span>
<a href="#l23.24"></a><span id="l23.24">     nsCOMPtr&lt;nsIChannel&gt; channel = do_QueryInterface(request);</span>
<a href="#l23.25"></a><span id="l23.25">     if(!channel) return NS_ERROR_FAILURE;</span>
<a href="#l23.26"></a><span id="l23.26"> </span>
<a href="#l23.27"></a><span id="l23.27">     // extract the prompt object to use for the alert from the url....</span>
<a href="#l23.28"></a><span id="l23.28" class="difflineminus">-    nsCOMPtr&lt;nsIURI&gt; uri; </span>
<a href="#l23.29"></a><span id="l23.29" class="difflineplus">+    nsCOMPtr&lt;nsIURI&gt; uri;</span>
<a href="#l23.30"></a><span id="l23.30">     nsCOMPtr&lt;nsIPrompt&gt; promptObject;</span>
<a href="#l23.31"></a><span id="l23.31">     if (channel)</span>
<a href="#l23.32"></a><span id="l23.32">     {</span>
<a href="#l23.33"></a><span id="l23.33">       channel-&gt;GetURI(getter_AddRefs(uri));</span>
<a href="#l23.34"></a><span id="l23.34">       nsCOMPtr&lt;nsISmtpUrl&gt; smtpUrl (do_QueryInterface(uri));</span>
<a href="#l23.35"></a><span id="l23.35">       if (smtpUrl)</span>
<a href="#l23.36"></a><span id="l23.36">         smtpUrl-&gt;GetPrompt(getter_AddRefs(promptObject));</span>
<a href="#l23.37"></a><span id="l23.37">     }</span>
<a href="#l23.38"></a><span id="l23.38" class="difflineat">@@ -264,34 +264,34 @@ nsMsgSendLater::OnStopRequest(nsIRequest</span>
<a href="#l23.39"></a><span id="l23.39"> </span>
<a href="#l23.40"></a><span id="l23.40"> char *</span>
<a href="#l23.41"></a><span id="l23.41"> FindEOL(char *inBuf, char *buf_end)</span>
<a href="#l23.42"></a><span id="l23.42"> {</span>
<a href="#l23.43"></a><span id="l23.43">   char *buf = inBuf;</span>
<a href="#l23.44"></a><span id="l23.44">   char *findLoc = nullptr;</span>
<a href="#l23.45"></a><span id="l23.45"> </span>
<a href="#l23.46"></a><span id="l23.46">   while (buf &lt;= buf_end)</span>
<a href="#l23.47"></a><span id="l23.47" class="difflineminus">-    if (*buf == 0) </span>
<a href="#l23.48"></a><span id="l23.48" class="difflineplus">+    if (*buf == 0)</span>
<a href="#l23.49"></a><span id="l23.49">       return buf;</span>
<a href="#l23.50"></a><span id="l23.50">     else if ( (*buf == '\n') || (*buf == '\r') )</span>
<a href="#l23.51"></a><span id="l23.51">     {</span>
<a href="#l23.52"></a><span id="l23.52">       findLoc = buf;</span>
<a href="#l23.53"></a><span id="l23.53">       break;</span>
<a href="#l23.54"></a><span id="l23.54">     }</span>
<a href="#l23.55"></a><span id="l23.55">     else</span>
<a href="#l23.56"></a><span id="l23.56">       ++buf;</span>
<a href="#l23.57"></a><span id="l23.57"> </span>
<a href="#l23.58"></a><span id="l23.58">   if (!findLoc)</span>
<a href="#l23.59"></a><span id="l23.59">     return nullptr;</span>
<a href="#l23.60"></a><span id="l23.60">   else if ((findLoc + 1) &gt; buf_end)</span>
<a href="#l23.61"></a><span id="l23.61">     return buf;</span>
<a href="#l23.62"></a><span id="l23.62"> </span>
<a href="#l23.63"></a><span id="l23.63" class="difflineminus">-  if ( (*findLoc == '\n' &amp;&amp; *(findLoc+1) == '\r') || </span>
<a href="#l23.64"></a><span id="l23.64" class="difflineplus">+  if ( (*findLoc == '\n' &amp;&amp; *(findLoc+1) == '\r') ||</span>
<a href="#l23.65"></a><span id="l23.65">        (*findLoc == '\r' &amp;&amp; *(findLoc+1) == '\n'))</span>
<a href="#l23.66"></a><span id="l23.66" class="difflineminus">-    findLoc++; // possibly a pair.       </span>
<a href="#l23.67"></a><span id="l23.67" class="difflineplus">+    findLoc++; // possibly a pair.</span>
<a href="#l23.68"></a><span id="l23.68">   return findLoc;</span>
<a href="#l23.69"></a><span id="l23.69"> }</span>
<a href="#l23.70"></a><span id="l23.70"> </span>
<a href="#l23.71"></a><span id="l23.71"> nsresult</span>
<a href="#l23.72"></a><span id="l23.72"> nsMsgSendLater::RebufferLeftovers(char *startBuf, uint32_t aLen)</span>
<a href="#l23.73"></a><span id="l23.73"> {</span>
<a href="#l23.74"></a><span id="l23.74">   PR_FREEIF(mLeftoverBuffer);</span>
<a href="#l23.75"></a><span id="l23.75">   mLeftoverBuffer = (char *)PR_Malloc(aLen + 1);</span>
<a href="#l23.76"></a><span id="l23.76" class="difflineat">@@ -320,17 +320,17 @@ nsMsgSendLater::BuildNewBuffer(const cha</span>
<a href="#l23.77"></a><span id="l23.77"> }</span>
<a href="#l23.78"></a><span id="l23.78"> </span>
<a href="#l23.79"></a><span id="l23.79"> // Got data?</span>
<a href="#l23.80"></a><span id="l23.80"> NS_IMETHODIMP</span>
<a href="#l23.81"></a><span id="l23.81"> nsMsgSendLater::OnDataAvailable(nsIRequest *request, nsISupports *ctxt, nsIInputStream *inStr, uint64_t sourceOffset, uint32_t count)</span>
<a href="#l23.82"></a><span id="l23.82"> {</span>
<a href="#l23.83"></a><span id="l23.83">   NS_ENSURE_ARG_POINTER(inStr);</span>
<a href="#l23.84"></a><span id="l23.84"> </span>
<a href="#l23.85"></a><span id="l23.85" class="difflineminus">-  // This is a little bit tricky since we have to chop random </span>
<a href="#l23.86"></a><span id="l23.86" class="difflineplus">+  // This is a little bit tricky since we have to chop random</span>
<a href="#l23.87"></a><span id="l23.87">   // buffers into lines and deliver the lines...plus keeping the</span>
<a href="#l23.88"></a><span id="l23.88">   // leftovers for next time...some fun, eh?</span>
<a href="#l23.89"></a><span id="l23.89">   //</span>
<a href="#l23.90"></a><span id="l23.90">   nsresult    rv = NS_OK;</span>
<a href="#l23.91"></a><span id="l23.91">   char        *startBuf;</span>
<a href="#l23.92"></a><span id="l23.92">   char        *endBuf;</span>
<a href="#l23.93"></a><span id="l23.93">   char        *lineEnd;</span>
<a href="#l23.94"></a><span id="l23.94">   char        *newbuf = nullptr;</span>
<a href="#l23.95"></a><span id="l23.95" class="difflineat">@@ -392,46 +392,46 @@ nsMsgSendLater::OnStopRunningUrl(nsIURI </span>
<a href="#l23.96"></a><span id="l23.96"> </span>
<a href="#l23.97"></a><span id="l23.97"> NS_IMETHODIMP</span>
<a href="#l23.98"></a><span id="l23.98"> nsMsgSendLater::OnStartRequest(nsIRequest *request, nsISupports *ctxt)</span>
<a href="#l23.99"></a><span id="l23.99"> {</span>
<a href="#l23.100"></a><span id="l23.100">   return NS_OK;</span>
<a href="#l23.101"></a><span id="l23.101"> }</span>
<a href="#l23.102"></a><span id="l23.102"> </span>
<a href="#l23.103"></a><span id="l23.103"> ////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l23.104"></a><span id="l23.104" class="difflineminus">-// This is the listener class for the send operation. We have to create this class </span>
<a href="#l23.105"></a><span id="l23.105" class="difflineplus">+// This is the listener class for the send operation. We have to create this class</span>
<a href="#l23.106"></a><span id="l23.106"> // to listen for message send completion and eventually notify the caller</span>
<a href="#l23.107"></a><span id="l23.107"> ////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l23.108"></a><span id="l23.108"> NS_IMPL_ISUPPORTS(SendOperationListener, nsIMsgSendListener,</span>
<a href="#l23.109"></a><span id="l23.109">                    nsIMsgCopyServiceListener)</span>
<a href="#l23.110"></a><span id="l23.110"> </span>
<a href="#l23.111"></a><span id="l23.111"> SendOperationListener::SendOperationListener(nsMsgSendLater *aSendLater)</span>
<a href="#l23.112"></a><span id="l23.112"> : mSendLater(aSendLater)</span>
<a href="#l23.113"></a><span id="l23.113"> {</span>
<a href="#l23.114"></a><span id="l23.114"> }</span>
<a href="#l23.115"></a><span id="l23.115"> </span>
<a href="#l23.116"></a><span id="l23.116" class="difflineminus">-SendOperationListener::~SendOperationListener(void) </span>
<a href="#l23.117"></a><span id="l23.117" class="difflineplus">+SendOperationListener::~SendOperationListener(void)</span>
<a href="#l23.118"></a><span id="l23.118"> {</span>
<a href="#l23.119"></a><span id="l23.119"> }</span>
<a href="#l23.120"></a><span id="l23.120"> </span>
<a href="#l23.121"></a><span id="l23.121"> NS_IMETHODIMP</span>
<a href="#l23.122"></a><span id="l23.122"> SendOperationListener::OnGetDraftFolderURI(const char *aFolderURI)</span>
<a href="#l23.123"></a><span id="l23.123"> {</span>
<a href="#l23.124"></a><span id="l23.124">   return NS_OK;</span>
<a href="#l23.125"></a><span id="l23.125"> }</span>
<a href="#l23.126"></a><span id="l23.126" class="difflineminus">-  </span>
<a href="#l23.127"></a><span id="l23.127" class="difflineplus">+</span>
<a href="#l23.128"></a><span id="l23.128"> NS_IMETHODIMP</span>
<a href="#l23.129"></a><span id="l23.129"> SendOperationListener::OnStartSending(const char *aMsgID, uint32_t aMsgSize)</span>
<a href="#l23.130"></a><span id="l23.130"> {</span>
<a href="#l23.131"></a><span id="l23.131"> #ifdef NS_DEBUG</span>
<a href="#l23.132"></a><span id="l23.132">   printf(&quot;SendOperationListener::OnStartSending()\n&quot;);</span>
<a href="#l23.133"></a><span id="l23.133"> #endif</span>
<a href="#l23.134"></a><span id="l23.134">   return NS_OK;</span>
<a href="#l23.135"></a><span id="l23.135"> }</span>
<a href="#l23.136"></a><span id="l23.136" class="difflineminus">-  </span>
<a href="#l23.137"></a><span id="l23.137" class="difflineplus">+</span>
<a href="#l23.138"></a><span id="l23.138"> NS_IMETHODIMP</span>
<a href="#l23.139"></a><span id="l23.139"> SendOperationListener::OnProgress(const char *aMsgID, uint32_t aProgress, uint32_t aProgressMax)</span>
<a href="#l23.140"></a><span id="l23.140"> {</span>
<a href="#l23.141"></a><span id="l23.141"> #ifdef NS_DEBUG</span>
<a href="#l23.142"></a><span id="l23.142">   printf(&quot;SendOperationListener::OnProgress()\n&quot;);</span>
<a href="#l23.143"></a><span id="l23.143"> #endif</span>
<a href="#l23.144"></a><span id="l23.144">   return NS_OK;</span>
<a href="#l23.145"></a><span id="l23.145"> }</span>
<a href="#l23.146"></a><span id="l23.146" class="difflineat">@@ -446,19 +446,19 @@ SendOperationListener::OnStatus(const ch</span>
<a href="#l23.147"></a><span id="l23.147">   return NS_OK;</span>
<a href="#l23.148"></a><span id="l23.148"> }</span>
<a href="#l23.149"></a><span id="l23.149"> </span>
<a href="#l23.150"></a><span id="l23.150"> NS_IMETHODIMP</span>
<a href="#l23.151"></a><span id="l23.151"> SendOperationListener::OnSendNotPerformed(const char *aMsgID, nsresult aStatus)</span>
<a href="#l23.152"></a><span id="l23.152"> {</span>
<a href="#l23.153"></a><span id="l23.153">   return NS_OK;</span>
<a href="#l23.154"></a><span id="l23.154"> }</span>
<a href="#l23.155"></a><span id="l23.155" class="difflineminus">-  </span>
<a href="#l23.156"></a><span id="l23.156" class="difflineplus">+</span>
<a href="#l23.157"></a><span id="l23.157"> NS_IMETHODIMP</span>
<a href="#l23.158"></a><span id="l23.158" class="difflineminus">-SendOperationListener::OnStopSending(const char *aMsgID, nsresult aStatus, const char16_t *aMsg, </span>
<a href="#l23.159"></a><span id="l23.159" class="difflineplus">+SendOperationListener::OnStopSending(const char *aMsgID, nsresult aStatus, const char16_t *aMsg,</span>
<a href="#l23.160"></a><span id="l23.160">                                      nsIFile *returnFile)</span>
<a href="#l23.161"></a><span id="l23.161"> {</span>
<a href="#l23.162"></a><span id="l23.162">   if (mSendLater &amp;&amp; !mSendLater-&gt;OnSendStepFinished(aStatus))</span>
<a href="#l23.163"></a><span id="l23.163">     mSendLater = nullptr;</span>
<a href="#l23.164"></a><span id="l23.164"> </span>
<a href="#l23.165"></a><span id="l23.165">   return NS_OK;</span>
<a href="#l23.166"></a><span id="l23.166"> }</span>
<a href="#l23.167"></a><span id="l23.167"> </span>
<a href="#l23.168"></a><span id="l23.168" class="difflineat">@@ -562,20 +562,20 @@ nsMsgSendLater::CompleteMailFileSend()</span>
<a href="#l23.169"></a><span id="l23.169"> </span>
<a href="#l23.170"></a><span id="l23.170">   rv = pMsgSend-&gt;SendMessageFile(identity,</span>
<a href="#l23.171"></a><span id="l23.171">                                  mAccountKey,</span>
<a href="#l23.172"></a><span id="l23.172">                                  compFields, // nsIMsgCompFields *fields,</span>
<a href="#l23.173"></a><span id="l23.173">                                  mTempFile, // nsIFile *sendFile,</span>
<a href="#l23.174"></a><span id="l23.174">                                  true, // bool deleteSendFileOnCompletion,</span>
<a href="#l23.175"></a><span id="l23.175">                                  false, // bool digest_p,</span>
<a href="#l23.176"></a><span id="l23.176">                                  nsIMsgSend::nsMsgSendUnsent, // nsMsgDeliverMode mode,</span>
<a href="#l23.177"></a><span id="l23.177" class="difflineminus">-                                 nullptr, // nsIMsgDBHdr *msgToReplace, </span>
<a href="#l23.178"></a><span id="l23.178" class="difflineplus">+                                 nullptr, // nsIMsgDBHdr *msgToReplace,</span>
<a href="#l23.179"></a><span id="l23.179">                                  sendListener,</span>
<a href="#l23.180"></a><span id="l23.180">                                  mFeedback,</span>
<a href="#l23.181"></a><span id="l23.181" class="difflineminus">-                                 nullptr); </span>
<a href="#l23.182"></a><span id="l23.182" class="difflineplus">+                                 nullptr);</span>
<a href="#l23.183"></a><span id="l23.183">   return rv;</span>
<a href="#l23.184"></a><span id="l23.184"> }</span>
<a href="#l23.185"></a><span id="l23.185"> </span>
<a href="#l23.186"></a><span id="l23.186"> nsresult</span>
<a href="#l23.187"></a><span id="l23.187"> nsMsgSendLater::StartNextMailFileSend(nsresult prevStatus)</span>
<a href="#l23.188"></a><span id="l23.188"> {</span>
<a href="#l23.189"></a><span id="l23.189">   bool hasMoreElements = false;</span>
<a href="#l23.190"></a><span id="l23.190">   if ((!mEnumerator) ||</span>
<a href="#l23.191"></a><span id="l23.191" class="difflineat">@@ -597,27 +597,27 @@ nsMsgSendLater::StartNextMailFileSend(ns</span>
<a href="#l23.192"></a><span id="l23.192">   // update with 100% for both send and copy as we must have finished by now.</span>
<a href="#l23.193"></a><span id="l23.193">   if (mTotalSendCount)</span>
<a href="#l23.194"></a><span id="l23.194">     NotifyListenersOnProgress(mTotalSendCount, mMessagesToSend.Count(), 100, 100);</span>
<a href="#l23.195"></a><span id="l23.195"> </span>
<a href="#l23.196"></a><span id="l23.196">   nsCOMPtr&lt;nsISupports&gt; currentItem;</span>
<a href="#l23.197"></a><span id="l23.197">   nsresult rv = mEnumerator-&gt;GetNext(getter_AddRefs(currentItem));</span>
<a href="#l23.198"></a><span id="l23.198">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.199"></a><span id="l23.199"> </span>
<a href="#l23.200"></a><span id="l23.200" class="difflineminus">-  mMessage = do_QueryInterface(currentItem); </span>
<a href="#l23.201"></a><span id="l23.201" class="difflineplus">+  mMessage = do_QueryInterface(currentItem);</span>
<a href="#l23.202"></a><span id="l23.202">   if (!mMessage)</span>
<a href="#l23.203"></a><span id="l23.203">     return NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l23.204"></a><span id="l23.204"> </span>
<a href="#l23.205"></a><span id="l23.205">   if (!mMessageFolder)</span>
<a href="#l23.206"></a><span id="l23.206">     return NS_ERROR_UNEXPECTED;</span>
<a href="#l23.207"></a><span id="l23.207"> </span>
<a href="#l23.208"></a><span id="l23.208">   nsCString messageURI;</span>
<a href="#l23.209"></a><span id="l23.209">   mMessageFolder-&gt;GetUriForMsg(mMessage, messageURI);</span>
<a href="#l23.210"></a><span id="l23.210"> </span>
<a href="#l23.211"></a><span id="l23.211" class="difflineminus">-  rv = nsMsgCreateTempFile(&quot;nsqmail.tmp&quot;, getter_AddRefs(mTempFile)); </span>
<a href="#l23.212"></a><span id="l23.212" class="difflineplus">+  rv = nsMsgCreateTempFile(&quot;nsqmail.tmp&quot;, getter_AddRefs(mTempFile));</span>
<a href="#l23.213"></a><span id="l23.213">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.214"></a><span id="l23.214"> </span>
<a href="#l23.215"></a><span id="l23.215">   nsCOMPtr&lt;nsIMsgMessageService&gt; messageService;</span>
<a href="#l23.216"></a><span id="l23.216">   rv = GetMessageServiceFromURI(messageURI, getter_AddRefs(messageService));</span>
<a href="#l23.217"></a><span id="l23.217">   if (NS_FAILED(rv) &amp;&amp; !messageService)</span>
<a href="#l23.218"></a><span id="l23.218">     return NS_ERROR_FACTORY_NOT_LOADED;</span>
<a href="#l23.219"></a><span id="l23.219"> </span>
<a href="#l23.220"></a><span id="l23.220">   ++mTotalSendCount;</span>
<a href="#l23.221"></a><span id="l23.221" class="difflineat">@@ -651,17 +651,17 @@ nsMsgSendLater::StartNextMailFileSend(ns</span>
<a href="#l23.222"></a><span id="l23.222">   rv = messageService-&gt;DisplayMessage(messageURI.get(),</span>
<a href="#l23.223"></a><span id="l23.223">                                       static_cast&lt;nsIStreamListener*&gt;(this),</span>
<a href="#l23.224"></a><span id="l23.224">                                       nullptr, nullptr, nullptr,</span>
<a href="#l23.225"></a><span id="l23.225">                                       getter_AddRefs(dummyNull));</span>
<a href="#l23.226"></a><span id="l23.226"> </span>
<a href="#l23.227"></a><span id="l23.227">   return rv;</span>
<a href="#l23.228"></a><span id="l23.228"> }</span>
<a href="#l23.229"></a><span id="l23.229"> </span>
<a href="#l23.230"></a><span id="l23.230" class="difflineminus">-NS_IMETHODIMP </span>
<a href="#l23.231"></a><span id="l23.231" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l23.232"></a><span id="l23.232"> nsMsgSendLater::GetUnsentMessagesFolder(nsIMsgIdentity *aIdentity, nsIMsgFolder **folder)</span>
<a href="#l23.233"></a><span id="l23.233"> {</span>
<a href="#l23.234"></a><span id="l23.234">   nsCString uri;</span>
<a href="#l23.235"></a><span id="l23.235">   GetFolderURIFromUserPrefs(nsIMsgSend::nsMsgQueueForLater, aIdentity, uri);</span>
<a href="#l23.236"></a><span id="l23.236">   return LocateMessageFolder(aIdentity, nsIMsgSend::nsMsgQueueForLater,</span>
<a href="#l23.237"></a><span id="l23.237">                              uri.get(), folder);</span>
<a href="#l23.238"></a><span id="l23.238"> }</span>
<a href="#l23.239"></a><span id="l23.239"> </span>
<a href="#l23.240"></a><span id="l23.240" class="difflineat">@@ -702,17 +702,17 @@ nsMsgSendLater::HasUnsentMessages(nsIMsg</span>
<a href="#l23.241"></a><span id="l23.241">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.242"></a><span id="l23.242"> </span>
<a href="#l23.243"></a><span id="l23.243">   *aResult = totalMessages &gt; 0;</span>
<a href="#l23.244"></a><span id="l23.244">   return NS_OK;</span>
<a href="#l23.245"></a><span id="l23.245"> }</span>
<a href="#l23.246"></a><span id="l23.246"> </span>
<a href="#l23.247"></a><span id="l23.247"> //</span>
<a href="#l23.248"></a><span id="l23.248"> // To really finalize this capability, we need to have the ability to get</span>
<a href="#l23.249"></a><span id="l23.249" class="difflineminus">-// the message from the mail store in a stream for processing. The flow </span>
<a href="#l23.250"></a><span id="l23.250" class="difflineplus">+// the message from the mail store in a stream for processing. The flow</span>
<a href="#l23.251"></a><span id="l23.251"> // would be something like this:</span>
<a href="#l23.252"></a><span id="l23.252"> //</span>
<a href="#l23.253"></a><span id="l23.253"> //      foreach (message in Outbox folder)</span>
<a href="#l23.254"></a><span id="l23.254"> //         get stream of Nth message</span>
<a href="#l23.255"></a><span id="l23.255"> //         if (not done with headers)</span>
<a href="#l23.256"></a><span id="l23.256"> //            Tack on to current buffer of headers</span>
<a href="#l23.257"></a><span id="l23.257"> //         when done with headers</span>
<a href="#l23.258"></a><span id="l23.258"> //            BuildHeaders()</span>
<a href="#l23.259"></a><span id="l23.259" class="difflineat">@@ -723,17 +723,17 @@ nsMsgSendLater::HasUnsentMessages(nsIMsg</span>
<a href="#l23.260"></a><span id="l23.260"> //          when done with the message</span>
<a href="#l23.261"></a><span id="l23.261"> //            do send operation</span>
<a href="#l23.262"></a><span id="l23.262"> //</span>
<a href="#l23.263"></a><span id="l23.263"> //          when send is complete</span>
<a href="#l23.264"></a><span id="l23.264"> //            Copy from Outbox to FCC folder</span>
<a href="#l23.265"></a><span id="l23.265"> //            Delete from Outbox folder</span>
<a href="#l23.266"></a><span id="l23.266"> //</span>
<a href="#l23.267"></a><span id="l23.267"> //</span>
<a href="#l23.268"></a><span id="l23.268" class="difflineminus">-NS_IMETHODIMP </span>
<a href="#l23.269"></a><span id="l23.269" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l23.270"></a><span id="l23.270"> nsMsgSendLater::SendUnsentMessages(nsIMsgIdentity *aIdentity)</span>
<a href="#l23.271"></a><span id="l23.271"> {</span>
<a href="#l23.272"></a><span id="l23.272">   return InternalSendMessages(true, aIdentity);</span>
<a href="#l23.273"></a><span id="l23.273"> }</span>
<a href="#l23.274"></a><span id="l23.274"> </span>
<a href="#l23.275"></a><span id="l23.275"> // Returns NS_OK if the db is OK, an error otherwise, e.g., we had to reparse.</span>
<a href="#l23.276"></a><span id="l23.276"> nsresult nsMsgSendLater::ReparseDBIfNeeded(nsIUrlListener *aListener)</span>
<a href="#l23.277"></a><span id="l23.277"> {</span>
<a href="#l23.278"></a><span id="l23.278" class="difflineat">@@ -801,17 +801,17 @@ nsMsgSendLater::InternalSendMessages(boo</span>
<a href="#l23.279"></a><span id="l23.279">           mMessagesToSend.AppendObject(messageHeader);</span>
<a href="#l23.280"></a><span id="l23.280">         else</span>
<a href="#l23.281"></a><span id="l23.281">         {</span>
<a href="#l23.282"></a><span id="l23.282">           // Else just send those that are NOT marked as Queued.</span>
<a href="#l23.283"></a><span id="l23.283">           uint32_t flags;</span>
<a href="#l23.284"></a><span id="l23.284">           rv = messageHeader-&gt;GetFlags(&amp;flags);</span>
<a href="#l23.285"></a><span id="l23.285">           if (NS_SUCCEEDED(rv) &amp;&amp; !(flags &amp; nsMsgMessageFlags::Queued))</span>
<a href="#l23.286"></a><span id="l23.286">             mMessagesToSend.AppendObject(messageHeader);</span>
<a href="#l23.287"></a><span id="l23.287" class="difflineminus">-        }  </span>
<a href="#l23.288"></a><span id="l23.288" class="difflineplus">+        }</span>
<a href="#l23.289"></a><span id="l23.289">       }</span>
<a href="#l23.290"></a><span id="l23.290">     }</span>
<a href="#l23.291"></a><span id="l23.291">   }</span>
<a href="#l23.292"></a><span id="l23.292"> </span>
<a href="#l23.293"></a><span id="l23.293">   // Now get an enumerator for our array.</span>
<a href="#l23.294"></a><span id="l23.294">   rv = NS_NewArrayEnumerator(getter_AddRefs(mEnumerator), mMessagesToSend);</span>
<a href="#l23.295"></a><span id="l23.295">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.296"></a><span id="l23.296"> </span>
<a href="#l23.297"></a><span id="l23.297" class="difflineat">@@ -826,17 +826,17 @@ nsMsgSendLater::InternalSendMessages(boo</span>
<a href="#l23.298"></a><span id="l23.298">   return StartNextMailFileSend(NS_OK);</span>
<a href="#l23.299"></a><span id="l23.299"> }</span>
<a href="#l23.300"></a><span id="l23.300"> </span>
<a href="#l23.301"></a><span id="l23.301"> nsresult nsMsgSendLater::SetOrigMsgDisposition()</span>
<a href="#l23.302"></a><span id="l23.302"> {</span>
<a href="#l23.303"></a><span id="l23.303">   if (!mMessage)</span>
<a href="#l23.304"></a><span id="l23.304">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l23.305"></a><span id="l23.305"> </span>
<a href="#l23.306"></a><span id="l23.306" class="difflineminus">-  // We're finished sending a queued message. We need to look at mMessage </span>
<a href="#l23.307"></a><span id="l23.307" class="difflineplus">+  // We're finished sending a queued message. We need to look at mMessage</span>
<a href="#l23.308"></a><span id="l23.308">   // and see if we need to set replied/forwarded</span>
<a href="#l23.309"></a><span id="l23.309">   // flags for the original message that this message might be a reply to</span>
<a href="#l23.310"></a><span id="l23.310">   // or forward of.</span>
<a href="#l23.311"></a><span id="l23.311">   nsCString originalMsgURIs;</span>
<a href="#l23.312"></a><span id="l23.312">   nsCString queuedDisposition;</span>
<a href="#l23.313"></a><span id="l23.313">   mMessage-&gt;GetStringProperty(ORIG_URI_PROPERTY, getter_Copies(originalMsgURIs));</span>
<a href="#l23.314"></a><span id="l23.314">   mMessage-&gt;GetStringProperty(QUEUED_DISPOSITION_PROPERTY, getter_Copies(queuedDisposition));</span>
<a href="#l23.315"></a><span id="l23.315">   if (!queuedDisposition.IsEmpty())</span>
<a href="#l23.316"></a><span id="l23.316" class="difflineat">@@ -853,17 +853,17 @@ nsresult nsMsgSendLater::SetOrigMsgDispo</span>
<a href="#l23.317"></a><span id="l23.317">         // get the folder for the message resource</span>
<a href="#l23.318"></a><span id="l23.318">         nsCOMPtr&lt;nsIMsgFolder&gt; msgFolder;</span>
<a href="#l23.319"></a><span id="l23.319">         msgHdr-&gt;GetFolder(getter_AddRefs(msgFolder));</span>
<a href="#l23.320"></a><span id="l23.320">         if (msgFolder)</span>
<a href="#l23.321"></a><span id="l23.321">         {</span>
<a href="#l23.322"></a><span id="l23.322">           nsMsgDispositionState dispositionSetting = nsIMsgFolder::nsMsgDispositionState_Replied;</span>
<a href="#l23.323"></a><span id="l23.323">           if (queuedDisposition.Equals(&quot;forwarded&quot;))</span>
<a href="#l23.324"></a><span id="l23.324">             dispositionSetting = nsIMsgFolder::nsMsgDispositionState_Forwarded;</span>
<a href="#l23.325"></a><span id="l23.325" class="difflineminus">-          </span>
<a href="#l23.326"></a><span id="l23.326" class="difflineplus">+</span>
<a href="#l23.327"></a><span id="l23.327">           msgFolder-&gt;AddMessageDispositionState(msgHdr, dispositionSetting);</span>
<a href="#l23.328"></a><span id="l23.328">         }</span>
<a href="#l23.329"></a><span id="l23.329">       }</span>
<a href="#l23.330"></a><span id="l23.330">     }</span>
<a href="#l23.331"></a><span id="l23.331">   }</span>
<a href="#l23.332"></a><span id="l23.332">   return NS_OK;</span>
<a href="#l23.333"></a><span id="l23.333"> }</span>
<a href="#l23.334"></a><span id="l23.334"> </span>
<a href="#l23.335"></a><span id="l23.335" class="difflineat">@@ -1023,17 +1023,17 @@ SEARCH_NEWLINE:</span>
<a href="#l23.336"></a><span id="l23.336">     else if (buf+2 &lt; buf_end &amp;&amp;</span>
<a href="#l23.337"></a><span id="l23.337">          (buf[0] == '\r'  &amp;&amp; buf[1] == '\n') &amp;&amp;</span>
<a href="#l23.338"></a><span id="l23.338">          (buf[2] == ' ' || buf[2] == '\t'))</span>
<a href="#l23.339"></a><span id="l23.339">     {</span>
<a href="#l23.340"></a><span id="l23.340">       buf += 3;</span>
<a href="#l23.341"></a><span id="l23.341">       goto SEARCH_NEWLINE;</span>
<a href="#l23.342"></a><span id="l23.342">     }</span>
<a href="#l23.343"></a><span id="l23.343">     // If &quot;\r &quot; or &quot;\r\t&quot; or &quot;\n &quot; or &quot;\n\t&quot; is next, that doesn't terminate</span>
<a href="#l23.344"></a><span id="l23.344" class="difflineminus">-    // the header either. </span>
<a href="#l23.345"></a><span id="l23.345" class="difflineplus">+    // the header either.</span>
<a href="#l23.346"></a><span id="l23.346">     else if ((buf[0] == '\r'  || buf[0] == '\n') &amp;&amp;</span>
<a href="#l23.347"></a><span id="l23.347">          (buf[1] == ' ' || buf[1] == '\t'))</span>
<a href="#l23.348"></a><span id="l23.348">     {</span>
<a href="#l23.349"></a><span id="l23.349">       buf += 2;</span>
<a href="#l23.350"></a><span id="l23.350">       goto SEARCH_NEWLINE;</span>
<a href="#l23.351"></a><span id="l23.351">     }</span>
<a href="#l23.352"></a><span id="l23.352"> </span>
<a href="#l23.353"></a><span id="l23.353">     if (header)</span>
<a href="#l23.354"></a><span id="l23.354" class="difflineat">@@ -1084,32 +1084,32 @@ SEARCH_NEWLINE:</span>
<a href="#l23.355"></a><span id="l23.355">       buf_end = to;</span>
<a href="#l23.356"></a><span id="l23.356">       m_headersFP = buf_end - m_headers;</span>
<a href="#l23.357"></a><span id="l23.357">     }</span>
<a href="#l23.358"></a><span id="l23.358">   }</span>
<a href="#l23.359"></a><span id="l23.359"> </span>
<a href="#l23.360"></a><span id="l23.360">   m_headers[m_headersFP++] = '\r';</span>
<a href="#l23.361"></a><span id="l23.361">   m_headers[m_headersFP++] = '\n';</span>
<a href="#l23.362"></a><span id="l23.362"> </span>
<a href="#l23.363"></a><span id="l23.363" class="difflineminus">-  // Now we have parsed out all of the headers we need and we </span>
<a href="#l23.364"></a><span id="l23.364" class="difflineplus">+  // Now we have parsed out all of the headers we need and we</span>
<a href="#l23.365"></a><span id="l23.365">   // can proceed.</span>
<a href="#l23.366"></a><span id="l23.366">   return NS_OK;</span>
<a href="#l23.367"></a><span id="l23.367"> }</span>
<a href="#l23.368"></a><span id="l23.368"> </span>
<a href="#l23.369"></a><span id="l23.369"> nsresult</span>
<a href="#l23.370"></a><span id="l23.370"> DoGrowBuffer(int32_t desired_size, int32_t element_size, int32_t quantum,</span>
<a href="#l23.371"></a><span id="l23.371">             char **buffer, int32_t *size)</span>
<a href="#l23.372"></a><span id="l23.372"> {</span>
<a href="#l23.373"></a><span id="l23.373">   if (*size &lt;= desired_size)</span>
<a href="#l23.374"></a><span id="l23.374">   {</span>
<a href="#l23.375"></a><span id="l23.375">     char *new_buf;</span>
<a href="#l23.376"></a><span id="l23.376">     int32_t increment = desired_size - *size;</span>
<a href="#l23.377"></a><span id="l23.377" class="difflineminus">-    if (increment &lt; quantum) // always grow by a minimum of N bytes </span>
<a href="#l23.378"></a><span id="l23.378" class="difflineplus">+    if (increment &lt; quantum) // always grow by a minimum of N bytes</span>
<a href="#l23.379"></a><span id="l23.379">       increment = quantum;</span>
<a href="#l23.380"></a><span id="l23.380" class="difflineminus">-    </span>
<a href="#l23.381"></a><span id="l23.381" class="difflineplus">+</span>
<a href="#l23.382"></a><span id="l23.382">     new_buf = (*buffer</span>
<a href="#l23.383"></a><span id="l23.383">                 ? (char *) PR_Realloc (*buffer, (*size + increment)</span>
<a href="#l23.384"></a><span id="l23.384">                 * (element_size / sizeof(char)))</span>
<a href="#l23.385"></a><span id="l23.385">                 : (char *) PR_Malloc ((*size + increment)</span>
<a href="#l23.386"></a><span id="l23.386">                 * (element_size / sizeof(char))));</span>
<a href="#l23.387"></a><span id="l23.387">     if (! new_buf)</span>
<a href="#l23.388"></a><span id="l23.388">       return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l23.389"></a><span id="l23.389">     *buffer = new_buf;</span>
<a href="#l23.390"></a><span id="l23.390" class="difflineat">@@ -1123,66 +1123,66 @@ DoGrowBuffer(int32_t desired_size, int32</span>
<a href="#l23.391"></a><span id="l23.391">    DoGrowBuffer ((desired_size), sizeof(char), 1024, \</span>
<a href="#l23.392"></a><span id="l23.392">            &amp;m_headers, &amp;m_headersSize) \</span>
<a href="#l23.393"></a><span id="l23.393">    : NS_OK)</span>
<a href="#l23.394"></a><span id="l23.394"> </span>
<a href="#l23.395"></a><span id="l23.395"> nsresult</span>
<a href="#l23.396"></a><span id="l23.396"> nsMsgSendLater::DeliverQueuedLine(char *line, int32_t length)</span>
<a href="#l23.397"></a><span id="l23.397"> {</span>
<a href="#l23.398"></a><span id="l23.398">   int32_t flength = length;</span>
<a href="#l23.399"></a><span id="l23.399" class="difflineminus">-  </span>
<a href="#l23.400"></a><span id="l23.400" class="difflineplus">+</span>
<a href="#l23.401"></a><span id="l23.401">   m_bytesRead += length;</span>
<a href="#l23.402"></a><span id="l23.402" class="difflineminus">-  </span>
<a href="#l23.403"></a><span id="l23.403" class="difflineminus">-// convert existing newline to CRLF </span>
<a href="#l23.404"></a><span id="l23.404" class="difflineplus">+</span>
<a href="#l23.405"></a><span id="l23.405" class="difflineplus">+// convert existing newline to CRLF</span>
<a href="#l23.406"></a><span id="l23.406"> // Don't need this because the calling routine is taking care of it.</span>
<a href="#l23.407"></a><span id="l23.407" class="difflineminus">-//  if (length &gt; 0 &amp;&amp; (line[length-1] == '\r' || </span>
<a href="#l23.408"></a><span id="l23.408" class="difflineplus">+//  if (length &gt; 0 &amp;&amp; (line[length-1] == '\r' ||</span>
<a href="#l23.409"></a><span id="l23.409"> //     (line[length-1] == '\n' &amp;&amp; (length &lt; 2 || line[length-2] != '\r'))))</span>
<a href="#l23.410"></a><span id="l23.410"> //  {</span>
<a href="#l23.411"></a><span id="l23.411"> //    line[length-1] = '\r';</span>
<a href="#l23.412"></a><span id="l23.412"> //    line[length++] = '\n';</span>
<a href="#l23.413"></a><span id="l23.413"> //  }</span>
<a href="#l23.414"></a><span id="l23.414"> //</span>
<a href="#l23.415"></a><span id="l23.415">   //</span>
<a href="#l23.416"></a><span id="l23.416" class="difflineminus">-  // We are going to check if we are looking at a &quot;From - &quot; line. If so, </span>
<a href="#l23.417"></a><span id="l23.417" class="difflineplus">+  // We are going to check if we are looking at a &quot;From - &quot; line. If so,</span>
<a href="#l23.418"></a><span id="l23.418">   // then just eat it and return NS_OK</span>
<a href="#l23.419"></a><span id="l23.419">   //</span>
<a href="#l23.420"></a><span id="l23.420">   if (!PL_strncasecmp(line, &quot;From - &quot;, 7))</span>
<a href="#l23.421"></a><span id="l23.421">     return NS_OK;</span>
<a href="#l23.422"></a><span id="l23.422"> </span>
<a href="#l23.423"></a><span id="l23.423">   if (m_inhead)</span>
<a href="#l23.424"></a><span id="l23.424">   {</span>
<a href="#l23.425"></a><span id="l23.425">     if (m_headersPosition == 0)</span>
<a href="#l23.426"></a><span id="l23.426">     {</span>
<a href="#l23.427"></a><span id="l23.427">       // This line is the first line in a header block.</span>
<a href="#l23.428"></a><span id="l23.428">       // Remember its position.</span>
<a href="#l23.429"></a><span id="l23.429">       m_headersPosition = m_position;</span>
<a href="#l23.430"></a><span id="l23.430" class="difflineminus">-      </span>
<a href="#l23.431"></a><span id="l23.431" class="difflineplus">+</span>
<a href="#l23.432"></a><span id="l23.432">       // Also, since we're now processing the headers, clear out the</span>
<a href="#l23.433"></a><span id="l23.433">       // slots which we will parse data into, so that the values that</span>
<a href="#l23.434"></a><span id="l23.434">       // were used the last time around do not persist.</span>
<a href="#l23.435"></a><span id="l23.435" class="difflineminus">-      </span>
<a href="#l23.436"></a><span id="l23.436" class="difflineplus">+</span>
<a href="#l23.437"></a><span id="l23.437">       // We must do that here, and not in the previous clause of this</span>
<a href="#l23.438"></a><span id="l23.438">       // `else' (the &quot;I've just seen a `From ' line clause&quot;) because</span>
<a href="#l23.439"></a><span id="l23.439">       // that clause happens before delivery of the previous message is</span>
<a href="#l23.440"></a><span id="l23.440">       // complete, whereas this clause happens after the previous msg</span>
<a href="#l23.441"></a><span id="l23.441">       // has been delivered.  If we did this up there, then only the</span>
<a href="#l23.442"></a><span id="l23.442">       // last message in the folder would ever be able to be both</span>
<a href="#l23.443"></a><span id="l23.443">       // mailed and posted (or fcc'ed.)</span>
<a href="#l23.444"></a><span id="l23.444">       PR_FREEIF(m_to);</span>
<a href="#l23.445"></a><span id="l23.445">       PR_FREEIF(m_bcc);</span>
<a href="#l23.446"></a><span id="l23.446">       PR_FREEIF(m_newsgroups);</span>
<a href="#l23.447"></a><span id="l23.447">       PR_FREEIF(m_newshost);</span>
<a href="#l23.448"></a><span id="l23.448">       PR_FREEIF(m_fcc);</span>
<a href="#l23.449"></a><span id="l23.449">       PR_FREEIF(mIdentityKey);</span>
<a href="#l23.450"></a><span id="l23.450">     }</span>
<a href="#l23.451"></a><span id="l23.451" class="difflineminus">-    </span>
<a href="#l23.452"></a><span id="l23.452" class="difflineplus">+</span>
<a href="#l23.453"></a><span id="l23.453">     if (line[0] == '\r' || line[0] == '\n' || line[0] == 0)</span>
<a href="#l23.454"></a><span id="l23.454">     {</span>
<a href="#l23.455"></a><span id="l23.455">       // End of headers.  Now parse them; open the temp file;</span>
<a href="#l23.456"></a><span id="l23.456" class="difflineminus">-      // and write the appropriate subset of the headers out. </span>
<a href="#l23.457"></a><span id="l23.457" class="difflineplus">+      // and write the appropriate subset of the headers out.</span>
<a href="#l23.458"></a><span id="l23.458">       m_inhead = false;</span>
<a href="#l23.459"></a><span id="l23.459"> </span>
<a href="#l23.460"></a><span id="l23.460">       nsresult rv = MsgNewBufferedFileOutputStream(getter_AddRefs(mOutFile), mTempFile, -1, 00600);</span>
<a href="#l23.461"></a><span id="l23.461">       if (NS_FAILED(rv))</span>
<a href="#l23.462"></a><span id="l23.462">         return NS_MSG_ERROR_WRITING_FILE;</span>
<a href="#l23.463"></a><span id="l23.463"> </span>
<a href="#l23.464"></a><span id="l23.464">       nsresult status = BuildHeaders();</span>
<a href="#l23.465"></a><span id="l23.465">       if (NS_FAILED(status))</span>
<a href="#l23.466"></a><span id="l23.466" class="difflineat">@@ -1192,44 +1192,44 @@ nsMsgSendLater::DeliverQueuedLine(char *</span>
<a href="#l23.467"></a><span id="l23.467">       rv = mOutFile-&gt;Write(m_headers, m_headersFP, &amp;n);</span>
<a href="#l23.468"></a><span id="l23.468">       if (NS_FAILED(rv) || n != (uint32_t)m_headersFP)</span>
<a href="#l23.469"></a><span id="l23.469">         return NS_MSG_ERROR_WRITING_FILE;</span>
<a href="#l23.470"></a><span id="l23.470">     }</span>
<a href="#l23.471"></a><span id="l23.471">     else</span>
<a href="#l23.472"></a><span id="l23.472">     {</span>
<a href="#l23.473"></a><span id="l23.473">       // Otherwise, this line belongs to a header.  So append it to the</span>
<a href="#l23.474"></a><span id="l23.474">       // header data.</span>
<a href="#l23.475"></a><span id="l23.475" class="difflineminus">-      </span>
<a href="#l23.476"></a><span id="l23.476" class="difflineplus">+</span>
<a href="#l23.477"></a><span id="l23.477">       if (!PL_strncasecmp (line, HEADER_X_MOZILLA_STATUS, PL_strlen(HEADER_X_MOZILLA_STATUS)))</span>
<a href="#l23.478"></a><span id="l23.478">         // Notice the position of the flags.</span>
<a href="#l23.479"></a><span id="l23.479">         m_flagsPosition = m_position;</span>
<a href="#l23.480"></a><span id="l23.480">       else if (m_headersFP == 0)</span>
<a href="#l23.481"></a><span id="l23.481">         m_flagsPosition = 0;</span>
<a href="#l23.482"></a><span id="l23.482" class="difflineminus">-      </span>
<a href="#l23.483"></a><span id="l23.483" class="difflineplus">+</span>
<a href="#l23.484"></a><span id="l23.484">       nsresult status = do_grow_headers (length + m_headersFP + 10);</span>
<a href="#l23.485"></a><span id="l23.485" class="difflineminus">-      if (NS_FAILED(status)) </span>
<a href="#l23.486"></a><span id="l23.486" class="difflineplus">+      if (NS_FAILED(status))</span>
<a href="#l23.487"></a><span id="l23.487">         return status;</span>
<a href="#l23.488"></a><span id="l23.488" class="difflineminus">-      </span>
<a href="#l23.489"></a><span id="l23.489" class="difflineplus">+</span>
<a href="#l23.490"></a><span id="l23.490">       memcpy(m_headers + m_headersFP, line, length);</span>
<a href="#l23.491"></a><span id="l23.491">       m_headersFP += length;</span>
<a href="#l23.492"></a><span id="l23.492">     }</span>
<a href="#l23.493"></a><span id="l23.493">   }</span>
<a href="#l23.494"></a><span id="l23.494">   else</span>
<a href="#l23.495"></a><span id="l23.495">   {</span>
<a href="#l23.496"></a><span id="l23.496">     // This is a body line.  Write it to the file.</span>
<a href="#l23.497"></a><span id="l23.497">     PR_ASSERT(mOutFile);</span>
<a href="#l23.498"></a><span id="l23.498">     if (mOutFile)</span>
<a href="#l23.499"></a><span id="l23.499">     {</span>
<a href="#l23.500"></a><span id="l23.500">       uint32_t wrote;</span>
<a href="#l23.501"></a><span id="l23.501">       nsresult rv = mOutFile-&gt;Write(line, length, &amp;wrote);</span>
<a href="#l23.502"></a><span id="l23.502" class="difflineminus">-      if (NS_FAILED(rv) || wrote &lt; (uint32_t) length) </span>
<a href="#l23.503"></a><span id="l23.503" class="difflineplus">+      if (NS_FAILED(rv) || wrote &lt; (uint32_t) length)</span>
<a href="#l23.504"></a><span id="l23.504">         return NS_MSG_ERROR_WRITING_FILE;</span>
<a href="#l23.505"></a><span id="l23.505">     }</span>
<a href="#l23.506"></a><span id="l23.506">   }</span>
<a href="#l23.507"></a><span id="l23.507" class="difflineminus">-  </span>
<a href="#l23.508"></a><span id="l23.508" class="difflineplus">+</span>
<a href="#l23.509"></a><span id="l23.509">   m_position += flength;</span>
<a href="#l23.510"></a><span id="l23.510">   return NS_OK;</span>
<a href="#l23.511"></a><span id="l23.511"> }</span>
<a href="#l23.512"></a><span id="l23.512"> </span>
<a href="#l23.513"></a><span id="l23.513"> NS_IMETHODIMP</span>
<a href="#l23.514"></a><span id="l23.514"> nsMsgSendLater::AddListener(nsIMsgSendLaterListener *aListener)</span>
<a href="#l23.515"></a><span id="l23.515"> {</span>
<a href="#l23.516"></a><span id="l23.516">   NS_ENSURE_ARG_POINTER(aListener);</span>
<a href="#l23.517"></a><span id="l23.517" class="difflineat">@@ -1314,17 +1314,17 @@ nsMsgSendLater::EndSendMessages(nsresult</span>
<a href="#l23.518"></a><span id="l23.518">   mMessagesToSend.Clear();</span>
<a href="#l23.519"></a><span id="l23.519"> </span>
<a href="#l23.520"></a><span id="l23.520">   // We don't need to keep hold of the database now we've finished sending.</span>
<a href="#l23.521"></a><span id="l23.521">   (void)mMessageFolder-&gt;SetMsgDatabase(nullptr);</span>
<a href="#l23.522"></a><span id="l23.522"> </span>
<a href="#l23.523"></a><span id="l23.523">   // or the enumerator, temp file or output stream</span>
<a href="#l23.524"></a><span id="l23.524">   mEnumerator = nullptr;</span>
<a href="#l23.525"></a><span id="l23.525">   mTempFile = nullptr;</span>
<a href="#l23.526"></a><span id="l23.526" class="difflineminus">-  mOutFile = nullptr;  </span>
<a href="#l23.527"></a><span id="l23.527" class="difflineplus">+  mOutFile = nullptr;</span>
<a href="#l23.528"></a><span id="l23.528"> </span>
<a href="#l23.529"></a><span id="l23.529">   NOTIFY_LISTENERS(OnStopSending, (aStatus, aMsg, aTotalTried, aSuccessful));</span>
<a href="#l23.530"></a><span id="l23.530"> </span>
<a href="#l23.531"></a><span id="l23.531">   // If we've got a shutdown listener, notify it that we've finished.</span>
<a href="#l23.532"></a><span id="l23.532">   if (mShutdownListener)</span>
<a href="#l23.533"></a><span id="l23.533">   {</span>
<a href="#l23.534"></a><span id="l23.534">     mShutdownListener-&gt;OnStopRunningUrl(nullptr, NS_OK);</span>
<a href="#l23.535"></a><span id="l23.535">     mShutdownListener = nullptr;</span>
<a href="#l23.536"></a><span id="l23.536" class="difflineat">@@ -1384,17 +1384,17 @@ nsMsgSendLater::OnCopyStepFinished(nsres</span>
<a href="#l23.537"></a><span id="l23.537"> // XXX todo</span>
<a href="#l23.538"></a><span id="l23.538"> // maybe this should just live in the account manager?</span>
<a href="#l23.539"></a><span id="l23.539"> nsresult</span>
<a href="#l23.540"></a><span id="l23.540"> nsMsgSendLater::GetIdentityFromKey(const char *aKey, nsIMsgIdentity  **aIdentity)</span>
<a href="#l23.541"></a><span id="l23.541"> {</span>
<a href="#l23.542"></a><span id="l23.542">   NS_ENSURE_ARG_POINTER(aIdentity);</span>
<a href="#l23.543"></a><span id="l23.543"> </span>
<a href="#l23.544"></a><span id="l23.544">   nsresult rv;</span>
<a href="#l23.545"></a><span id="l23.545" class="difflineminus">-  nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager = </span>
<a href="#l23.546"></a><span id="l23.546" class="difflineplus">+  nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l23.547"></a><span id="l23.547">     do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l23.548"></a><span id="l23.548">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l23.549"></a><span id="l23.549"> </span>
<a href="#l23.550"></a><span id="l23.550">   if (aKey)</span>
<a href="#l23.551"></a><span id="l23.551">   {</span>
<a href="#l23.552"></a><span id="l23.552">     nsCOMPtr&lt;nsIArray&gt; identities;</span>
<a href="#l23.553"></a><span id="l23.553">     if (NS_SUCCEEDED(accountManager-&gt;GetAllIdentities(getter_AddRefs(identities))))</span>
<a href="#l23.554"></a><span id="l23.554">     {</span>
<a href="#l23.555"></a><span id="l23.555" class="difflineat">@@ -1419,17 +1419,17 @@ nsMsgSendLater::GetIdentityFromKey(const</span>
<a href="#l23.556"></a><span id="l23.556">     }</span>
<a href="#l23.557"></a><span id="l23.557">   }</span>
<a href="#l23.558"></a><span id="l23.558"> </span>
<a href="#l23.559"></a><span id="l23.559">   // if no aKey, or we failed to find the identity from the key</span>
<a href="#l23.560"></a><span id="l23.560">   // use the identity from the default account.</span>
<a href="#l23.561"></a><span id="l23.561">   nsCOMPtr&lt;nsIMsgAccount&gt; defaultAccount;</span>
<a href="#l23.562"></a><span id="l23.562">   rv = accountManager-&gt;GetDefaultAccount(getter_AddRefs(defaultAccount));</span>
<a href="#l23.563"></a><span id="l23.563">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l23.564"></a><span id="l23.564" class="difflineminus">-  </span>
<a href="#l23.565"></a><span id="l23.565" class="difflineplus">+</span>
<a href="#l23.566"></a><span id="l23.566">   rv = defaultAccount-&gt;GetDefaultIdentity(aIdentity);</span>
<a href="#l23.567"></a><span id="l23.567">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l23.568"></a><span id="l23.568">   return rv;</span>
<a href="#l23.569"></a><span id="l23.569"> }</span>
<a href="#l23.570"></a><span id="l23.570"> </span>
<a href="#l23.571"></a><span id="l23.571"> NS_IMETHODIMP</span>
<a href="#l23.572"></a><span id="l23.572"> nsMsgSendLater::OnItemAdded(nsIMsgFolder *aParentItem, nsISupports *aItem)</span>
<a href="#l23.573"></a><span id="l23.573"> {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgSendLater.h</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgSendLater.h</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineat">@@ -14,17 +14,17 @@</span>
<a href="#l24.4"></a><span id="l24.4"> #include &quot;nsIMsgStatusFeedback.h&quot;</span>
<a href="#l24.5"></a><span id="l24.5"> #include &quot;nsTObserverArray.h&quot;</span>
<a href="#l24.6"></a><span id="l24.6"> #include &quot;nsIObserver.h&quot;</span>
<a href="#l24.7"></a><span id="l24.7"> #include &quot;nsITimer.h&quot;</span>
<a href="#l24.8"></a><span id="l24.8"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l24.9"></a><span id="l24.9"> #include &quot;nsIMsgShutdown.h&quot;</span>
<a href="#l24.10"></a><span id="l24.10"> </span>
<a href="#l24.11"></a><span id="l24.11"> ////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l24.12"></a><span id="l24.12" class="difflineminus">-// This is the listener class for the send operation. We have to create this class </span>
<a href="#l24.13"></a><span id="l24.13" class="difflineplus">+// This is the listener class for the send operation. We have to create this class</span>
<a href="#l24.14"></a><span id="l24.14"> // to listen for message send completion and eventually notify the caller</span>
<a href="#l24.15"></a><span id="l24.15"> ////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l24.16"></a><span id="l24.16"> class nsMsgSendLater;</span>
<a href="#l24.17"></a><span id="l24.17"> </span>
<a href="#l24.18"></a><span id="l24.18"> class SendOperationListener : public nsIMsgSendListener,</span>
<a href="#l24.19"></a><span id="l24.19">                               public nsIMsgCopyServiceListener</span>
<a href="#l24.20"></a><span id="l24.20"> {</span>
<a href="#l24.21"></a><span id="l24.21"> public:</span>
<a href="#l24.22"></a><span id="l24.22" class="difflineat">@@ -78,30 +78,30 @@ public:</span>
<a href="#l24.23"></a><span id="l24.23">                                             nsIMsgIdentity *aIdentity);</span>
<a href="#l24.24"></a><span id="l24.24">   void NotifyListenersOnProgress(uint32_t aCurrentMessage,</span>
<a href="#l24.25"></a><span id="l24.25">                                  uint32_t aTotalMessage,</span>
<a href="#l24.26"></a><span id="l24.26">                                  uint32_t aSendPercent,</span>
<a href="#l24.27"></a><span id="l24.27">                                  uint32_t aCopyPercent);</span>
<a href="#l24.28"></a><span id="l24.28">   void NotifyListenersOnMessageSendError(uint32_t aCurrentMessage,</span>
<a href="#l24.29"></a><span id="l24.29">                                          nsresult aStatus,</span>
<a href="#l24.30"></a><span id="l24.30">                                          const char16_t *aMsg);</span>
<a href="#l24.31"></a><span id="l24.31" class="difflineminus">-  void EndSendMessages(nsresult aStatus, const char16_t *aMsg, </span>
<a href="#l24.32"></a><span id="l24.32" class="difflineplus">+  void EndSendMessages(nsresult aStatus, const char16_t *aMsg,</span>
<a href="#l24.33"></a><span id="l24.33">                        uint32_t aTotalTried, uint32_t aSuccessful);</span>
<a href="#l24.34"></a><span id="l24.34"> </span>
<a href="#l24.35"></a><span id="l24.35">   bool OnSendStepFinished(nsresult aStatus);</span>
<a href="#l24.36"></a><span id="l24.36">   void OnCopyStepFinished(nsresult aStatus);</span>
<a href="#l24.37"></a><span id="l24.37"> </span>
<a href="#l24.38"></a><span id="l24.38" class="difflineminus">-  // counters and things for enumeration </span>
<a href="#l24.39"></a><span id="l24.39" class="difflineplus">+  // counters and things for enumeration</span>
<a href="#l24.40"></a><span id="l24.40">   uint32_t                  mTotalSentSuccessfully;</span>
<a href="#l24.41"></a><span id="l24.41">   uint32_t                  mTotalSendCount;</span>
<a href="#l24.42"></a><span id="l24.42">   nsCOMArray&lt;nsIMsgDBHdr&gt; mMessagesToSend;</span>
<a href="#l24.43"></a><span id="l24.43">   nsCOMPtr&lt;nsISimpleEnumerator&gt; mEnumerator;</span>
<a href="#l24.44"></a><span id="l24.44">   nsCOMPtr&lt;nsIMsgFolder&gt;    mMessageFolder;</span>
<a href="#l24.45"></a><span id="l24.45">   nsCOMPtr&lt;nsIMsgStatusFeedback&gt; mFeedback;</span>
<a href="#l24.46"></a><span id="l24.46" class="difflineminus">- </span>
<a href="#l24.47"></a><span id="l24.47" class="difflineplus">+</span>
<a href="#l24.48"></a><span id="l24.48">   // Private Information</span>
<a href="#l24.49"></a><span id="l24.49"> private:</span>
<a href="#l24.50"></a><span id="l24.50">   virtual ~nsMsgSendLater();</span>
<a href="#l24.51"></a><span id="l24.51">   nsresult GetIdentityFromKey(const char *aKey, nsIMsgIdentity **aIdentity);</span>
<a href="#l24.52"></a><span id="l24.52">   nsresult ReparseDBIfNeeded(nsIUrlListener *aListener);</span>
<a href="#l24.53"></a><span id="l24.53">   nsresult InternalSendMessages(bool aUserInitiated,</span>
<a href="#l24.54"></a><span id="l24.54">                                 nsIMsgIdentity *aIdentity);</span>
<a href="#l24.55"></a><span id="l24.55"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgSendPart.cpp</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgSendPart.cpp</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineat">@@ -36,20 +36,20 @@ nsMsgSendPart::nsMsgSendPart(nsIMsgSend*</span>
<a href="#l25.4"></a><span id="l25.4">   m_partNum = &quot;1&quot;;</span>
<a href="#l25.5"></a><span id="l25.5">   SetMimeDeliveryState(state);</span>
<a href="#l25.6"></a><span id="l25.6"> </span>
<a href="#l25.7"></a><span id="l25.7">   m_parent = nullptr;</span>
<a href="#l25.8"></a><span id="l25.8">   m_buffer = nullptr;</span>
<a href="#l25.9"></a><span id="l25.9">   m_type = nullptr;</span>
<a href="#l25.10"></a><span id="l25.10">   m_other = nullptr;</span>
<a href="#l25.11"></a><span id="l25.11">   m_strip_sensitive_headers = false;</span>
<a href="#l25.12"></a><span id="l25.12" class="difflineminus">-  </span>
<a href="#l25.13"></a><span id="l25.13" class="difflineplus">+</span>
<a href="#l25.14"></a><span id="l25.14">   m_firstBlock = false;</span>
<a href="#l25.15"></a><span id="l25.15">   m_needIntlConversion = false;</span>
<a href="#l25.16"></a><span id="l25.16" class="difflineminus">-  </span>
<a href="#l25.17"></a><span id="l25.17" class="difflineplus">+</span>
<a href="#l25.18"></a><span id="l25.18">   m_mainpart = false;</span>
<a href="#l25.19"></a><span id="l25.19">   m_just_hit_CR = false;</span>
<a href="#l25.20"></a><span id="l25.20"> }</span>
<a href="#l25.21"></a><span id="l25.21"> </span>
<a href="#l25.22"></a><span id="l25.22"> </span>
<a href="#l25.23"></a><span id="l25.23"> nsMsgSendPart::~nsMsgSendPart()</span>
<a href="#l25.24"></a><span id="l25.24"> {</span>
<a href="#l25.25"></a><span id="l25.25">   for (int i=0 ; i &lt; m_numchildren; i++)</span>
<a href="#l25.26"></a><span id="l25.26" class="difflineat">@@ -59,23 +59,23 @@ nsMsgSendPart::~nsMsgSendPart()</span>
<a href="#l25.27"></a><span id="l25.27">     PR_FREEIF(m_buffer);</span>
<a href="#l25.28"></a><span id="l25.28">   PR_FREEIF(m_other);</span>
<a href="#l25.29"></a><span id="l25.29">   PR_FREEIF(m_type);</span>
<a href="#l25.30"></a><span id="l25.30"> }</span>
<a href="#l25.31"></a><span id="l25.31"> </span>
<a href="#l25.32"></a><span id="l25.32"> nsresult nsMsgSendPart::CopyString(char** dest, const char* src)</span>
<a href="#l25.33"></a><span id="l25.33"> {</span>
<a href="#l25.34"></a><span id="l25.34">   NS_ASSERTION(src, &quot;src null&quot;);</span>
<a href="#l25.35"></a><span id="l25.35" class="difflineminus">-  </span>
<a href="#l25.36"></a><span id="l25.36" class="difflineplus">+</span>
<a href="#l25.37"></a><span id="l25.37">   PR_FREEIF(*dest);</span>
<a href="#l25.38"></a><span id="l25.38">   if (!src)</span>
<a href="#l25.39"></a><span id="l25.39">     *dest = PL_strdup(&quot;&quot;);</span>
<a href="#l25.40"></a><span id="l25.40">   else</span>
<a href="#l25.41"></a><span id="l25.41">     *dest = PL_strdup(src);</span>
<a href="#l25.42"></a><span id="l25.42" class="difflineminus">-  </span>
<a href="#l25.43"></a><span id="l25.43" class="difflineplus">+</span>
<a href="#l25.44"></a><span id="l25.44">   return *dest? NS_OK : NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l25.45"></a><span id="l25.45"> }</span>
<a href="#l25.46"></a><span id="l25.46"> </span>
<a href="#l25.47"></a><span id="l25.47"> </span>
<a href="#l25.48"></a><span id="l25.48"> nsresult nsMsgSendPart::SetFile(nsIFile *file)</span>
<a href="#l25.49"></a><span id="l25.49"> {</span>
<a href="#l25.50"></a><span id="l25.50">   m_file = file;</span>
<a href="#l25.51"></a><span id="l25.51">   return NS_OK;</span>
<a href="#l25.52"></a><span id="l25.52" class="difflineat">@@ -105,17 +105,17 @@ nsresult nsMsgSendPart::SetOtherHeaders(</span>
<a href="#l25.53"></a><span id="l25.53"> nsresult nsMsgSendPart::SetMimeDeliveryState(nsIMsgSend *state)</span>
<a href="#l25.54"></a><span id="l25.54"> {</span>
<a href="#l25.55"></a><span id="l25.55">   m_state = state;</span>
<a href="#l25.56"></a><span id="l25.56">   if (GetNumChildren() &gt; 0)</span>
<a href="#l25.57"></a><span id="l25.57">   {</span>
<a href="#l25.58"></a><span id="l25.58">     for (int i = 0; i &lt; GetNumChildren(); i++)</span>
<a href="#l25.59"></a><span id="l25.59">     {</span>
<a href="#l25.60"></a><span id="l25.60">       nsMsgSendPart *part = GetChild(i);</span>
<a href="#l25.61"></a><span id="l25.61" class="difflineminus">-      if (part) </span>
<a href="#l25.62"></a><span id="l25.62" class="difflineplus">+      if (part)</span>
<a href="#l25.63"></a><span id="l25.63">         part-&gt;SetMimeDeliveryState(state);</span>
<a href="#l25.64"></a><span id="l25.64">     }</span>
<a href="#l25.65"></a><span id="l25.65">   }</span>
<a href="#l25.66"></a><span id="l25.66">   return NS_OK;</span>
<a href="#l25.67"></a><span id="l25.67"> }</span>
<a href="#l25.68"></a><span id="l25.68"> </span>
<a href="#l25.69"></a><span id="l25.69"> nsresult nsMsgSendPart::AppendOtherHeaders(const char* more)</span>
<a href="#l25.70"></a><span id="l25.70"> {</span>
<a href="#l25.71"></a><span id="l25.71" class="difflineat">@@ -161,51 +161,51 @@ nsresult nsMsgSendPart::AddChild(nsMsgSe</span>
<a href="#l25.72"></a><span id="l25.72">   partNum.AppendInt(m_numchildren);</span>
<a href="#l25.73"></a><span id="l25.73">   child-&gt;m_partNum = partNum;</span>
<a href="#l25.74"></a><span id="l25.74">   return NS_OK;</span>
<a href="#l25.75"></a><span id="l25.75"> }</span>
<a href="#l25.76"></a><span id="l25.76"> </span>
<a href="#l25.77"></a><span id="l25.77"> nsMsgSendPart * nsMsgSendPart::DetachChild(int32_t whichOne)</span>
<a href="#l25.78"></a><span id="l25.78"> {</span>
<a href="#l25.79"></a><span id="l25.79">   nsMsgSendPart *returnValue = nullptr;</span>
<a href="#l25.80"></a><span id="l25.80" class="difflineminus">-  </span>
<a href="#l25.81"></a><span id="l25.81" class="difflineplus">+</span>
<a href="#l25.82"></a><span id="l25.82">   NS_ASSERTION(whichOne &gt;= 0 &amp;&amp; whichOne &lt; m_numchildren, &quot;parameter out of range&quot;);</span>
<a href="#l25.83"></a><span id="l25.83" class="difflineminus">-  if (whichOne &gt;= 0 &amp;&amp; whichOne &lt; m_numchildren) </span>
<a href="#l25.84"></a><span id="l25.84" class="difflineplus">+  if (whichOne &gt;= 0 &amp;&amp; whichOne &lt; m_numchildren)</span>
<a href="#l25.85"></a><span id="l25.85">   {</span>
<a href="#l25.86"></a><span id="l25.86">     returnValue = m_children[whichOne];</span>
<a href="#l25.87"></a><span id="l25.87" class="difflineminus">-    </span>
<a href="#l25.88"></a><span id="l25.88" class="difflineplus">+</span>
<a href="#l25.89"></a><span id="l25.89">     if (m_numchildren &gt; 1)</span>
<a href="#l25.90"></a><span id="l25.90">     {</span>
<a href="#l25.91"></a><span id="l25.91">       nsMsgSendPart** tmp = new nsMsgSendPart* [m_numchildren-1];</span>
<a href="#l25.92"></a><span id="l25.92" class="difflineminus">-      if (tmp != nullptr) </span>
<a href="#l25.93"></a><span id="l25.93" class="difflineplus">+      if (tmp != nullptr)</span>
<a href="#l25.94"></a><span id="l25.94">       {</span>
<a href="#l25.95"></a><span id="l25.95">         // move all the other kids over</span>
<a href="#l25.96"></a><span id="l25.96" class="difflineminus">-        for (int i=0 ; i&lt;m_numchildren-1 ; i++) </span>
<a href="#l25.97"></a><span id="l25.97" class="difflineplus">+        for (int i=0 ; i&lt;m_numchildren-1 ; i++)</span>
<a href="#l25.98"></a><span id="l25.98">         {</span>
<a href="#l25.99"></a><span id="l25.99">           if (i &gt;= whichOne)</span>
<a href="#l25.100"></a><span id="l25.100">             tmp[i] = m_children[i+1];</span>
<a href="#l25.101"></a><span id="l25.101">           else</span>
<a href="#l25.102"></a><span id="l25.102">             tmp[i] = m_children[i];</span>
<a href="#l25.103"></a><span id="l25.103">         }</span>
<a href="#l25.104"></a><span id="l25.104">         delete [] m_children;</span>
<a href="#l25.105"></a><span id="l25.105">         m_children = tmp;</span>
<a href="#l25.106"></a><span id="l25.106">         m_numchildren--;</span>
<a href="#l25.107"></a><span id="l25.107">       }</span>
<a href="#l25.108"></a><span id="l25.108">     }</span>
<a href="#l25.109"></a><span id="l25.109" class="difflineminus">-    else </span>
<a href="#l25.110"></a><span id="l25.110" class="difflineplus">+    else</span>
<a href="#l25.111"></a><span id="l25.111">     {</span>
<a href="#l25.112"></a><span id="l25.112">       delete [] m_children;</span>
<a href="#l25.113"></a><span id="l25.113">       m_children = nullptr;</span>
<a href="#l25.114"></a><span id="l25.114">       m_numchildren = 0;</span>
<a href="#l25.115"></a><span id="l25.115">     }</span>
<a href="#l25.116"></a><span id="l25.116">   }</span>
<a href="#l25.117"></a><span id="l25.117" class="difflineminus">-  </span>
<a href="#l25.118"></a><span id="l25.118" class="difflineplus">+</span>
<a href="#l25.119"></a><span id="l25.119">   if (returnValue)</span>
<a href="#l25.120"></a><span id="l25.120">     returnValue-&gt;m_parent = nullptr;</span>
<a href="#l25.121"></a><span id="l25.121" class="difflineminus">-  </span>
<a href="#l25.122"></a><span id="l25.122" class="difflineplus">+</span>
<a href="#l25.123"></a><span id="l25.123">   return returnValue;</span>
<a href="#l25.124"></a><span id="l25.124"> }</span>
<a href="#l25.125"></a><span id="l25.125"> </span>
<a href="#l25.126"></a><span id="l25.126"> nsMsgSendPart* nsMsgSendPart::GetChild(int32_t which)</span>
<a href="#l25.127"></a><span id="l25.127"> {</span>
<a href="#l25.128"></a><span id="l25.128">   NS_ASSERTION(which &gt;= 0 &amp;&amp; which &lt; m_numchildren, &quot;parameter out of range&quot;);</span>
<a href="#l25.129"></a><span id="l25.129">   if (which &gt;= 0 &amp;&amp; which &lt; m_numchildren) {</span>
<a href="#l25.130"></a><span id="l25.130">     return m_children[which];</span>
<a href="#l25.131"></a><span id="l25.131" class="difflineat">@@ -248,57 +248,57 @@ nsresult nsMsgSendPart::PushBody(const c</span>
<a href="#l25.132"></a><span id="l25.132">           // we want to ignore it.</span>
<a href="#l25.133"></a><span id="l25.133">           continue;</span>
<a href="#l25.134"></a><span id="l25.134">         }</span>
<a href="#l25.135"></a><span id="l25.135">       }</span>
<a href="#l25.136"></a><span id="l25.136">       if (*in == '\r' || *in == '\n') {</span>
<a href="#l25.137"></a><span id="l25.137">         /* Write out the newline. */</span>
<a href="#l25.138"></a><span id="l25.138">         *out++ = '\r';</span>
<a href="#l25.139"></a><span id="l25.139">         *out++ = '\n';</span>
<a href="#l25.140"></a><span id="l25.140" class="difflineminus">-        </span>
<a href="#l25.141"></a><span id="l25.141" class="difflineplus">+</span>
<a href="#l25.142"></a><span id="l25.142">         status = mime_write_message_body(m_state, buffer,</span>
<a href="#l25.143"></a><span id="l25.143">           out - buffer);</span>
<a href="#l25.144"></a><span id="l25.144">         if (NS_FAILED(status)) return status;</span>
<a href="#l25.145"></a><span id="l25.145">         out = buffer;</span>
<a href="#l25.146"></a><span id="l25.146" class="difflineminus">-        </span>
<a href="#l25.147"></a><span id="l25.147" class="difflineplus">+</span>
<a href="#l25.148"></a><span id="l25.148">         if (*in == '\r') {</span>
<a href="#l25.149"></a><span id="l25.149">           m_just_hit_CR = true;</span>
<a href="#l25.150"></a><span id="l25.150">         }</span>
<a href="#l25.151"></a><span id="l25.151" class="difflineminus">-        </span>
<a href="#l25.152"></a><span id="l25.152" class="difflineplus">+</span>
<a href="#l25.153"></a><span id="l25.153">         out = buffer;</span>
<a href="#l25.154"></a><span id="l25.154">       } else {</span>
<a href="#l25.155"></a><span id="l25.155" class="difflineminus">-        </span>
<a href="#l25.156"></a><span id="l25.156" class="difflineplus">+</span>
<a href="#l25.157"></a><span id="l25.157">       /*  Fix for bug #95985. We can't assume that all lines are shorter</span>
<a href="#l25.158"></a><span id="l25.158">       than 4096 chars (MIME_BUFFER_SIZE), so we need to test</span>
<a href="#l25.159"></a><span id="l25.159">       for this here. sfraser.</span>
<a href="#l25.160"></a><span id="l25.160">         */</span>
<a href="#l25.161"></a><span id="l25.161">         if (out - buffer &gt;= MIME_BUFFER_SIZE)</span>
<a href="#l25.162"></a><span id="l25.162">         {</span>
<a href="#l25.163"></a><span id="l25.163">           status = mime_write_message_body(m_state, buffer, out - buffer);</span>
<a href="#l25.164"></a><span id="l25.164">           if (NS_FAILED(status)) return status;</span>
<a href="#l25.165"></a><span id="l25.165" class="difflineminus">-          </span>
<a href="#l25.166"></a><span id="l25.166" class="difflineplus">+</span>
<a href="#l25.167"></a><span id="l25.167">           out = buffer;</span>
<a href="#l25.168"></a><span id="l25.168">         }</span>
<a href="#l25.169"></a><span id="l25.169" class="difflineminus">-        </span>
<a href="#l25.170"></a><span id="l25.170" class="difflineplus">+</span>
<a href="#l25.171"></a><span id="l25.171">         *out++ = *in;</span>
<a href="#l25.172"></a><span id="l25.172">       }</span>
<a href="#l25.173"></a><span id="l25.173">     }</span>
<a href="#l25.174"></a><span id="l25.174" class="difflineminus">-    </span>
<a href="#l25.175"></a><span id="l25.175" class="difflineplus">+</span>
<a href="#l25.176"></a><span id="l25.176">     /* Flush the last line. */</span>
<a href="#l25.177"></a><span id="l25.177">     if (out &gt; buffer) {</span>
<a href="#l25.178"></a><span id="l25.178">       status = mime_write_message_body(m_state, buffer, out - buffer);</span>
<a href="#l25.179"></a><span id="l25.179">       if (NS_FAILED(status)) return status;</span>
<a href="#l25.180"></a><span id="l25.180">       out = buffer;</span>
<a href="#l25.181"></a><span id="l25.181">     }</span>
<a href="#l25.182"></a><span id="l25.182">   }</span>
<a href="#l25.183"></a><span id="l25.183" class="difflineminus">-  </span>
<a href="#l25.184"></a><span id="l25.184" class="difflineplus">+</span>
<a href="#l25.185"></a><span id="l25.185">   if (encoded_data &amp;&amp; encoded_data != buffer) {</span>
<a href="#l25.186"></a><span id="l25.186">     PR_Free((char *) encoded_data);</span>
<a href="#l25.187"></a><span id="l25.187">   }</span>
<a href="#l25.188"></a><span id="l25.188" class="difflineminus">-  </span>
<a href="#l25.189"></a><span id="l25.189" class="difflineplus">+</span>
<a href="#l25.190"></a><span id="l25.190">   return status;</span>
<a href="#l25.191"></a><span id="l25.191"> }</span>
<a href="#l25.192"></a><span id="l25.192"> </span>
<a href="#l25.193"></a><span id="l25.193"> </span>
<a href="#l25.194"></a><span id="l25.194"> /* Partition the headers into those which apply to the message as a whole;</span>
<a href="#l25.195"></a><span id="l25.195"> those which apply to the message's contents; and the Content-Type header</span>
<a href="#l25.196"></a><span id="l25.196"> itself.  (This relies on the fact that all body-related headers begin with</span>
<a href="#l25.197"></a><span id="l25.197"> &quot;Content-&quot;.)</span>
<a href="#l25.198"></a><span id="l25.198" class="difflineat">@@ -311,42 +311,42 @@ divide_content_headers(const char *heade</span>
<a href="#l25.199"></a><span id="l25.199">                         char **content_headers,</span>
<a href="#l25.200"></a><span id="l25.200">                         char **content_type_header)</span>
<a href="#l25.201"></a><span id="l25.201"> {</span>
<a href="#l25.202"></a><span id="l25.202">     const char *tail;</span>
<a href="#l25.203"></a><span id="l25.203">     char *message_tail, *content_tail, *type_tail;</span>
<a href="#l25.204"></a><span id="l25.204">     int L = 0;</span>
<a href="#l25.205"></a><span id="l25.205">     if (headers)</span>
<a href="#l25.206"></a><span id="l25.206">       L = PL_strlen(headers);</span>
<a href="#l25.207"></a><span id="l25.207" class="difflineminus">-    </span>
<a href="#l25.208"></a><span id="l25.208" class="difflineplus">+</span>
<a href="#l25.209"></a><span id="l25.209">     if (L == 0)</span>
<a href="#l25.210"></a><span id="l25.210">       return NS_OK;</span>
<a href="#l25.211"></a><span id="l25.211" class="difflineminus">-    </span>
<a href="#l25.212"></a><span id="l25.212" class="difflineplus">+</span>
<a href="#l25.213"></a><span id="l25.213">     *message_headers = (char *)PR_Malloc(L+1);</span>
<a href="#l25.214"></a><span id="l25.214">     if (!*message_headers)</span>
<a href="#l25.215"></a><span id="l25.215">       return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l25.216"></a><span id="l25.216" class="difflineminus">-    </span>
<a href="#l25.217"></a><span id="l25.217" class="difflineplus">+</span>
<a href="#l25.218"></a><span id="l25.218">     *content_headers = (char *)PR_Malloc(L+1);</span>
<a href="#l25.219"></a><span id="l25.219">     if (!*content_headers) {</span>
<a href="#l25.220"></a><span id="l25.220">       PR_Free(*message_headers);</span>
<a href="#l25.221"></a><span id="l25.221">       return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l25.222"></a><span id="l25.222">     }</span>
<a href="#l25.223"></a><span id="l25.223" class="difflineminus">-    </span>
<a href="#l25.224"></a><span id="l25.224" class="difflineplus">+</span>
<a href="#l25.225"></a><span id="l25.225">     *content_type_header = (char *)PR_Malloc(L+1);</span>
<a href="#l25.226"></a><span id="l25.226">     if (!*content_type_header) {</span>
<a href="#l25.227"></a><span id="l25.227">       PR_Free(*message_headers);</span>
<a href="#l25.228"></a><span id="l25.228">       PR_Free(*content_headers);</span>
<a href="#l25.229"></a><span id="l25.229">       return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l25.230"></a><span id="l25.230">     }</span>
<a href="#l25.231"></a><span id="l25.231" class="difflineminus">-    </span>
<a href="#l25.232"></a><span id="l25.232" class="difflineplus">+</span>
<a href="#l25.233"></a><span id="l25.233">     message_tail = *message_headers;</span>
<a href="#l25.234"></a><span id="l25.234">     content_tail = *content_headers;</span>
<a href="#l25.235"></a><span id="l25.235">     type_tail    = *content_type_header;</span>
<a href="#l25.236"></a><span id="l25.236">     tail = headers;</span>
<a href="#l25.237"></a><span id="l25.237" class="difflineminus">-    </span>
<a href="#l25.238"></a><span id="l25.238" class="difflineplus">+</span>
<a href="#l25.239"></a><span id="l25.239">     while (*tail)</span>
<a href="#l25.240"></a><span id="l25.240">     {</span>
<a href="#l25.241"></a><span id="l25.241">       const char *head = tail;</span>
<a href="#l25.242"></a><span id="l25.242">       char **out;</span>
<a href="#l25.243"></a><span id="l25.243">       while(true) {</span>
<a href="#l25.244"></a><span id="l25.244">       /* Loop until we reach a newline that is not followed by whitespace.</span>
<a href="#l25.245"></a><span id="l25.245">         */</span>
<a href="#l25.246"></a><span id="l25.246">         if (tail[0] == 0 ||</span>
<a href="#l25.247"></a><span id="l25.247" class="difflineat">@@ -357,74 +357,74 @@ divide_content_headers(const char *heade</span>
<a href="#l25.248"></a><span id="l25.248">           if (tail[0] == '\r' &amp;&amp; tail[1] == '\n')</span>
<a href="#l25.249"></a><span id="l25.249">             tail++;</span>
<a href="#l25.250"></a><span id="l25.250">           if (*tail)</span>
<a href="#l25.251"></a><span id="l25.251">             tail++;</span>
<a href="#l25.252"></a><span id="l25.252">           break;</span>
<a href="#l25.253"></a><span id="l25.253">         }</span>
<a href="#l25.254"></a><span id="l25.254">         tail++;</span>
<a href="#l25.255"></a><span id="l25.255">       }</span>
<a href="#l25.256"></a><span id="l25.256" class="difflineminus">-      </span>
<a href="#l25.257"></a><span id="l25.257" class="difflineplus">+</span>
<a href="#l25.258"></a><span id="l25.258">       /* Decide which block this header goes into.</span>
<a href="#l25.259"></a><span id="l25.259">       */</span>
<a href="#l25.260"></a><span id="l25.260">       if (!PL_strncasecmp(head, &quot;Content-Type:&quot;, 13))</span>
<a href="#l25.261"></a><span id="l25.261">         out = &amp;type_tail;</span>
<a href="#l25.262"></a><span id="l25.262">       else</span>
<a href="#l25.263"></a><span id="l25.263">         if (!PL_strncasecmp(head, &quot;Content-&quot;, 8))</span>
<a href="#l25.264"></a><span id="l25.264">           out = &amp;content_tail;</span>
<a href="#l25.265"></a><span id="l25.265">         else</span>
<a href="#l25.266"></a><span id="l25.266">           out = &amp;message_tail;</span>
<a href="#l25.267"></a><span id="l25.267"> </span>
<a href="#l25.268"></a><span id="l25.268">       memcpy(*out, head, (tail-head));</span>
<a href="#l25.269"></a><span id="l25.269">       *out += (tail-head);</span>
<a href="#l25.270"></a><span id="l25.270">     }</span>
<a href="#l25.271"></a><span id="l25.271" class="difflineminus">-    </span>
<a href="#l25.272"></a><span id="l25.272" class="difflineplus">+</span>
<a href="#l25.273"></a><span id="l25.273">     *message_tail = 0;</span>
<a href="#l25.274"></a><span id="l25.274">     *content_tail = 0;</span>
<a href="#l25.275"></a><span id="l25.275">     *type_tail = 0;</span>
<a href="#l25.276"></a><span id="l25.276" class="difflineminus">-    </span>
<a href="#l25.277"></a><span id="l25.277" class="difflineplus">+</span>
<a href="#l25.278"></a><span id="l25.278">     if (!**message_headers) {</span>
<a href="#l25.279"></a><span id="l25.279">       PR_Free(*message_headers);</span>
<a href="#l25.280"></a><span id="l25.280">       *message_headers = 0;</span>
<a href="#l25.281"></a><span id="l25.281">     }</span>
<a href="#l25.282"></a><span id="l25.282" class="difflineminus">-    </span>
<a href="#l25.283"></a><span id="l25.283" class="difflineplus">+</span>
<a href="#l25.284"></a><span id="l25.284">     if (!**content_headers) {</span>
<a href="#l25.285"></a><span id="l25.285">       PR_Free(*content_headers);</span>
<a href="#l25.286"></a><span id="l25.286">       *content_headers = 0;</span>
<a href="#l25.287"></a><span id="l25.287">     }</span>
<a href="#l25.288"></a><span id="l25.288" class="difflineminus">-    </span>
<a href="#l25.289"></a><span id="l25.289" class="difflineplus">+</span>
<a href="#l25.290"></a><span id="l25.290">     if (!**content_type_header) {</span>
<a href="#l25.291"></a><span id="l25.291">       PR_Free(*content_type_header);</span>
<a href="#l25.292"></a><span id="l25.292">       *content_type_header = 0;</span>
<a href="#l25.293"></a><span id="l25.293">     }</span>
<a href="#l25.294"></a><span id="l25.294" class="difflineminus">-    </span>
<a href="#l25.295"></a><span id="l25.295" class="difflineplus">+</span>
<a href="#l25.296"></a><span id="l25.296"> #ifdef DEBUG</span>
<a href="#l25.297"></a><span id="l25.297">     // ### mwelch Because of the extreme difficulty we've had with</span>
<a href="#l25.298"></a><span id="l25.298">     //      duplicate part headers, I'm going to put in an</span>
<a href="#l25.299"></a><span id="l25.299">     //      ASSERT here which makes sure that no duplicate</span>
<a href="#l25.300"></a><span id="l25.300">     //      Content-Type or Content-Transfer-Encoding headers</span>
<a href="#l25.301"></a><span id="l25.301">     //      leave here undetected.</span>
<a href="#l25.302"></a><span id="l25.302">     const char* tmp;</span>
<a href="#l25.303"></a><span id="l25.303">     if (*content_type_header) {</span>
<a href="#l25.304"></a><span id="l25.304">       tmp = PL_strstr(*content_type_header, &quot;Content-Type&quot;);</span>
<a href="#l25.305"></a><span id="l25.305">       if (tmp) {</span>
<a href="#l25.306"></a><span id="l25.306">         tmp++; // get past the first occurrence</span>
<a href="#l25.307"></a><span id="l25.307">         NS_ASSERTION(!PL_strstr(tmp, &quot;Content-Type&quot;), &quot;Content-part already present&quot;);</span>
<a href="#l25.308"></a><span id="l25.308">       }</span>
<a href="#l25.309"></a><span id="l25.309">     }</span>
<a href="#l25.310"></a><span id="l25.310" class="difflineminus">-    </span>
<a href="#l25.311"></a><span id="l25.311" class="difflineplus">+</span>
<a href="#l25.312"></a><span id="l25.312">     if (*content_headers) {</span>
<a href="#l25.313"></a><span id="l25.313">       tmp = PL_strstr(*content_headers, &quot;Content-Transfer-Encoding&quot;);</span>
<a href="#l25.314"></a><span id="l25.314">       if (tmp) {</span>
<a href="#l25.315"></a><span id="l25.315">         tmp++; // get past the first occurrence</span>
<a href="#l25.316"></a><span id="l25.316">         NS_ASSERTION(!PL_strstr(tmp, &quot;Content-Transfer-Encoding&quot;), &quot;Content-Transfert already present&quot;);</span>
<a href="#l25.317"></a><span id="l25.317">       }</span>
<a href="#l25.318"></a><span id="l25.318">     }</span>
<a href="#l25.319"></a><span id="l25.319"> #endif // DEBUG</span>
<a href="#l25.320"></a><span id="l25.320" class="difflineminus">-    </span>
<a href="#l25.321"></a><span id="l25.321" class="difflineplus">+</span>
<a href="#l25.322"></a><span id="l25.322">     return NS_OK;</span>
<a href="#l25.323"></a><span id="l25.323"> }</span>
<a href="#l25.324"></a><span id="l25.324"> </span>
<a href="#l25.325"></a><span id="l25.325"> #define     SKIP_EMPTY_PART   1966</span>
<a href="#l25.326"></a><span id="l25.326"> </span>
<a href="#l25.327"></a><span id="l25.327"> nsresult</span>
<a href="#l25.328"></a><span id="l25.328"> nsMsgSendPart::Write()</span>
<a href="#l25.329"></a><span id="l25.329"> {</span>
<a href="#l25.330"></a><span id="l25.330" class="difflineat">@@ -444,108 +444,108 @@ nsMsgSendPart::Write()</span>
<a href="#l25.331"></a><span id="l25.331">   if ( (m_parent) &amp;&amp;</span>
<a href="#l25.332"></a><span id="l25.332">        (m_numchildren == 0) &amp;&amp;</span>
<a href="#l25.333"></a><span id="l25.333">        ( (!m_buffer) || (!*m_buffer) ) &amp;&amp;</span>
<a href="#l25.334"></a><span id="l25.334">        (!m_file) &amp;&amp;</span>
<a href="#l25.335"></a><span id="l25.335">        (!m_mainpart) )</span>
<a href="#l25.336"></a><span id="l25.336">     // XXX SKIP_EMPTY_PART (= 1966) is not a valid nsresult</span>
<a href="#l25.337"></a><span id="l25.337">     return static_cast&lt;nsresult&gt;(SKIP_EMPTY_PART);</span>
<a href="#l25.338"></a><span id="l25.338"> </span>
<a href="#l25.339"></a><span id="l25.339" class="difflineminus">-  if (m_mainpart &amp;&amp; m_type &amp;&amp; PL_strcmp(m_type, TEXT_HTML) == 0) </span>
<a href="#l25.340"></a><span id="l25.340" class="difflineminus">-  {     </span>
<a href="#l25.341"></a><span id="l25.341" class="difflineminus">-    if (m_file) </span>
<a href="#l25.342"></a><span id="l25.342" class="difflineplus">+  if (m_mainpart &amp;&amp; m_type &amp;&amp; PL_strcmp(m_type, TEXT_HTML) == 0)</span>
<a href="#l25.343"></a><span id="l25.343" class="difflineplus">+  {</span>
<a href="#l25.344"></a><span id="l25.344" class="difflineplus">+    if (m_file)</span>
<a href="#l25.345"></a><span id="l25.345">     {</span>
<a href="#l25.346"></a><span id="l25.346">       // The &quot;insert HTML links&quot; code requires a memory buffer,</span>
<a href="#l25.347"></a><span id="l25.347">       // so read the file into memory.</span>
<a href="#l25.348"></a><span id="l25.348">       NS_ASSERTION(m_buffer == nullptr, &quot;not-null buffer&quot;);</span>
<a href="#l25.349"></a><span id="l25.349">       int32_t           length = 0;</span>
<a href="#l25.350"></a><span id="l25.350">       int64_t fileSize;</span>
<a href="#l25.351"></a><span id="l25.351">       if (NS_SUCCEEDED(m_file-&gt;GetFileSize(&amp;fileSize)))</span>
<a href="#l25.352"></a><span id="l25.352">           length = fileSize;</span>
<a href="#l25.353"></a><span id="l25.353" class="difflineminus">-      </span>
<a href="#l25.354"></a><span id="l25.354" class="difflineplus">+</span>
<a href="#l25.355"></a><span id="l25.355">       m_buffer = (char *) PR_Malloc(sizeof(char) * (length + 1));</span>
<a href="#l25.356"></a><span id="l25.356" class="difflineminus">-      if (m_buffer) </span>
<a href="#l25.357"></a><span id="l25.357" class="difflineplus">+      if (m_buffer)</span>
<a href="#l25.358"></a><span id="l25.358">       {</span>
<a href="#l25.359"></a><span id="l25.359">         nsCOMPtr&lt;nsIInputStream&gt; inputFile;</span>
<a href="#l25.360"></a><span id="l25.360">         nsresult rv = NS_NewLocalFileInputStream(getter_AddRefs(inputFile), m_file);</span>
<a href="#l25.361"></a><span id="l25.361" class="difflineminus">-        if (NS_SUCCEEDED(rv)) </span>
<a href="#l25.362"></a><span id="l25.362" class="difflineplus">+        if (NS_SUCCEEDED(rv))</span>
<a href="#l25.363"></a><span id="l25.363">         {</span>
<a href="#l25.364"></a><span id="l25.364">           uint32_t bytesRead;</span>
<a href="#l25.365"></a><span id="l25.365">           rv = inputFile-&gt;Read(m_buffer, length, &amp;bytesRead);</span>
<a href="#l25.366"></a><span id="l25.366">           inputFile-&gt;Close();</span>
<a href="#l25.367"></a><span id="l25.367">           m_buffer[length] = '\0';</span>
<a href="#l25.368"></a><span id="l25.368">         }</span>
<a href="#l25.369"></a><span id="l25.369" class="difflineminus">-        else </span>
<a href="#l25.370"></a><span id="l25.370" class="difflineplus">+        else</span>
<a href="#l25.371"></a><span id="l25.371">           PR_Free(m_buffer);</span>
<a href="#l25.372"></a><span id="l25.372">       }</span>
<a href="#l25.373"></a><span id="l25.373">     }</span>
<a href="#l25.374"></a><span id="l25.374">   }</span>
<a href="#l25.375"></a><span id="l25.375" class="difflineminus">-  </span>
<a href="#l25.376"></a><span id="l25.376" class="difflineplus">+</span>
<a href="#l25.377"></a><span id="l25.377">   if (m_parent &amp;&amp; m_parent-&gt;m_type &amp;&amp;</span>
<a href="#l25.378"></a><span id="l25.378">         !PL_strcasecmp(m_parent-&gt;m_type, MULTIPART_DIGEST) &amp;&amp;</span>
<a href="#l25.379"></a><span id="l25.379">         m_type &amp;&amp;</span>
<a href="#l25.380"></a><span id="l25.380">         (!PL_strcasecmp(m_type, MESSAGE_RFC822) ||</span>
<a href="#l25.381"></a><span id="l25.381" class="difflineminus">-        !PL_strcasecmp(m_type, MESSAGE_NEWS))) </span>
<a href="#l25.382"></a><span id="l25.382" class="difflineplus">+        !PL_strcasecmp(m_type, MESSAGE_NEWS)))</span>
<a href="#l25.383"></a><span id="l25.383">   {</span>
<a href="#l25.384"></a><span id="l25.384">     // If we're in a multipart/digest, and this document is of type</span>
<a href="#l25.385"></a><span id="l25.385">     // message/rfc822, then it's appropriate to emit no headers.</span>
<a href="#l25.386"></a><span id="l25.386">     //</span>
<a href="#l25.387"></a><span id="l25.387">   }</span>
<a href="#l25.388"></a><span id="l25.388" class="difflineminus">-  else </span>
<a href="#l25.389"></a><span id="l25.389" class="difflineplus">+  else</span>
<a href="#l25.390"></a><span id="l25.390">   {</span>
<a href="#l25.391"></a><span id="l25.391">     char *message_headers = 0;</span>
<a href="#l25.392"></a><span id="l25.392">     char *content_headers = 0;</span>
<a href="#l25.393"></a><span id="l25.393">     char *content_type_header = 0;</span>
<a href="#l25.394"></a><span id="l25.394">     status = divide_content_headers(m_other,</span>
<a href="#l25.395"></a><span id="l25.395">                                     &amp;message_headers,</span>
<a href="#l25.396"></a><span id="l25.396">                                     &amp;content_headers,</span>
<a href="#l25.397"></a><span id="l25.397">                                     &amp;content_type_header);</span>
<a href="#l25.398"></a><span id="l25.398">     if (NS_FAILED(status))</span>
<a href="#l25.399"></a><span id="l25.399">       goto FAIL;</span>
<a href="#l25.400"></a><span id="l25.400" class="difflineminus">-    </span>
<a href="#l25.401"></a><span id="l25.401" class="difflineplus">+</span>
<a href="#l25.402"></a><span id="l25.402">       /* First, write out all of the headers that refer to the message</span>
<a href="#l25.403"></a><span id="l25.403">       itself (From, Subject, MIME-Version, etc.)</span>
<a href="#l25.404"></a><span id="l25.404">     */</span>
<a href="#l25.405"></a><span id="l25.405" class="difflineminus">-    if (message_headers) </span>
<a href="#l25.406"></a><span id="l25.406" class="difflineplus">+    if (message_headers)</span>
<a href="#l25.407"></a><span id="l25.407">     {</span>
<a href="#l25.408"></a><span id="l25.408">       PUSH(message_headers);</span>
<a href="#l25.409"></a><span id="l25.409">       PR_Free(message_headers);</span>
<a href="#l25.410"></a><span id="l25.410">       message_headers = 0;</span>
<a href="#l25.411"></a><span id="l25.411">     }</span>
<a href="#l25.412"></a><span id="l25.412"> </span>
<a href="#l25.413"></a><span id="l25.413">     /* Now allow the crypto library to (potentially) insert some text</span>
<a href="#l25.414"></a><span id="l25.414">        (it may want to wrap the body in an envelope.)           */</span>
<a href="#l25.415"></a><span id="l25.415">     if (!m_parent) {</span>
<a href="#l25.416"></a><span id="l25.416">       status = m_state-&gt;BeginCryptoEncapsulation();</span>
<a href="#l25.417"></a><span id="l25.417">       if (NS_FAILED(status)) goto FAIL;</span>
<a href="#l25.418"></a><span id="l25.418">     }</span>
<a href="#l25.419"></a><span id="l25.419" class="difflineminus">-          </span>
<a href="#l25.420"></a><span id="l25.420" class="difflineplus">+</span>
<a href="#l25.421"></a><span id="l25.421">     /* Now make sure there's a Content-Type header.</span>
<a href="#l25.422"></a><span id="l25.422">     */</span>
<a href="#l25.423"></a><span id="l25.423" class="difflineminus">-    if (!content_type_header) </span>
<a href="#l25.424"></a><span id="l25.424" class="difflineplus">+    if (!content_type_header)</span>
<a href="#l25.425"></a><span id="l25.425">     {</span>
<a href="#l25.426"></a><span id="l25.426">       NS_ASSERTION(m_type &amp;&amp; *m_type, &quot;null ptr&quot;);</span>
<a href="#l25.427"></a><span id="l25.427">       bool needsCharset = mime_type_needs_charset(m_type ? m_type : TEXT_PLAIN);</span>
<a href="#l25.428"></a><span id="l25.428" class="difflineminus">-      if (needsCharset) </span>
<a href="#l25.429"></a><span id="l25.429" class="difflineplus">+      if (needsCharset)</span>
<a href="#l25.430"></a><span id="l25.430">       {</span>
<a href="#l25.431"></a><span id="l25.431">         content_type_header = PR_smprintf(&quot;Content-Type: %s; charset=%s&quot; CRLF,</span>
<a href="#l25.432"></a><span id="l25.432">                                           (m_type ? m_type : TEXT_PLAIN), m_charset_name);</span>
<a href="#l25.433"></a><span id="l25.433">       }</span>
<a href="#l25.434"></a><span id="l25.434">       else</span>
<a href="#l25.435"></a><span id="l25.435">         content_type_header = PR_smprintf(&quot;Content-Type: %s&quot; CRLF,</span>
<a href="#l25.436"></a><span id="l25.436">                                           (m_type ? m_type : TEXT_PLAIN));</span>
<a href="#l25.437"></a><span id="l25.437" class="difflineminus">-      if (!content_type_header) </span>
<a href="#l25.438"></a><span id="l25.438" class="difflineplus">+      if (!content_type_header)</span>
<a href="#l25.439"></a><span id="l25.439">       {</span>
<a href="#l25.440"></a><span id="l25.440">         if (content_headers)</span>
<a href="#l25.441"></a><span id="l25.441">           PR_Free(content_headers);</span>
<a href="#l25.442"></a><span id="l25.442">         status = NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l25.443"></a><span id="l25.443">         goto FAIL;</span>
<a href="#l25.444"></a><span id="l25.444">       }</span>
<a href="#l25.445"></a><span id="l25.445">     }</span>
<a href="#l25.446"></a><span id="l25.446" class="difflineminus">-    </span>
<a href="#l25.447"></a><span id="l25.447" class="difflineplus">+</span>
<a href="#l25.448"></a><span id="l25.448">     /* If this is a compound object, tack a boundary string onto the</span>
<a href="#l25.449"></a><span id="l25.449">     Content-Type header. this</span>
<a href="#l25.450"></a><span id="l25.450">     */</span>
<a href="#l25.451"></a><span id="l25.451">     if (m_numchildren &gt; 0)</span>
<a href="#l25.452"></a><span id="l25.452">     {</span>
<a href="#l25.453"></a><span id="l25.453">       int L;</span>
<a href="#l25.454"></a><span id="l25.454">       char *ct2;</span>
<a href="#l25.455"></a><span id="l25.455">       NS_ASSERTION(m_type, &quot;null ptr&quot;);</span>
<a href="#l25.456"></a><span id="l25.456" class="difflineat">@@ -556,65 +556,65 @@ nsMsgSendPart::Write()</span>
<a href="#l25.457"></a><span id="l25.457">         if (!separator)</span>
<a href="#l25.458"></a><span id="l25.458">         {</span>
<a href="#l25.459"></a><span id="l25.459">           status = NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l25.460"></a><span id="l25.460">           goto FAIL;</span>
<a href="#l25.461"></a><span id="l25.461">         }</span>
<a href="#l25.462"></a><span id="l25.462">       }</span>
<a href="#l25.463"></a><span id="l25.463"> </span>
<a href="#l25.464"></a><span id="l25.464">       L = PL_strlen(content_type_header);</span>
<a href="#l25.465"></a><span id="l25.465" class="difflineminus">-      </span>
<a href="#l25.466"></a><span id="l25.466" class="difflineplus">+</span>
<a href="#l25.467"></a><span id="l25.467">       if (content_type_header[L-1] == '\n')</span>
<a href="#l25.468"></a><span id="l25.468">         content_type_header[--L] = 0;</span>
<a href="#l25.469"></a><span id="l25.469">       if (content_type_header[L-1] == '\r')</span>
<a href="#l25.470"></a><span id="l25.470">         content_type_header[--L] = 0;</span>
<a href="#l25.471"></a><span id="l25.471" class="difflineminus">-      </span>
<a href="#l25.472"></a><span id="l25.472" class="difflineplus">+</span>
<a href="#l25.473"></a><span id="l25.473">       ct2 = PR_smprintf(&quot;%s;\r\n boundary=\&quot;%s\&quot;&quot; CRLF, content_type_header, separator);</span>
<a href="#l25.474"></a><span id="l25.474">       PR_Free(content_type_header);</span>
<a href="#l25.475"></a><span id="l25.475" class="difflineminus">-      if (!ct2) </span>
<a href="#l25.476"></a><span id="l25.476" class="difflineplus">+      if (!ct2)</span>
<a href="#l25.477"></a><span id="l25.477">       {</span>
<a href="#l25.478"></a><span id="l25.478">         if (content_headers)</span>
<a href="#l25.479"></a><span id="l25.479">           PR_Free(content_headers);</span>
<a href="#l25.480"></a><span id="l25.480">         status = NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l25.481"></a><span id="l25.481">         goto FAIL;</span>
<a href="#l25.482"></a><span id="l25.482">       }</span>
<a href="#l25.483"></a><span id="l25.483" class="difflineminus">-      </span>
<a href="#l25.484"></a><span id="l25.484" class="difflineplus">+</span>
<a href="#l25.485"></a><span id="l25.485">       content_type_header = ct2;</span>
<a href="#l25.486"></a><span id="l25.486">     }</span>
<a href="#l25.487"></a><span id="l25.487" class="difflineminus">-    </span>
<a href="#l25.488"></a><span id="l25.488" class="difflineplus">+</span>
<a href="#l25.489"></a><span id="l25.489">     // Now write out the Content-Type header...</span>
<a href="#l25.490"></a><span id="l25.490">     NS_ASSERTION(content_type_header &amp;&amp; *content_type_header, &quot;null ptr&quot;);</span>
<a href="#l25.491"></a><span id="l25.491">     PUSH(content_type_header);</span>
<a href="#l25.492"></a><span id="l25.492">     PR_Free(content_type_header);</span>
<a href="#l25.493"></a><span id="l25.493">     content_type_header = 0;</span>
<a href="#l25.494"></a><span id="l25.494" class="difflineminus">-    </span>
<a href="#l25.495"></a><span id="l25.495" class="difflineplus">+</span>
<a href="#l25.496"></a><span id="l25.496">     /* ...followed by all of the other headers that refer to the body of</span>
<a href="#l25.497"></a><span id="l25.497">     the message (Content-Transfer-Encoding, Content-Dispositon, etc.)</span>
<a href="#l25.498"></a><span id="l25.498">     */</span>
<a href="#l25.499"></a><span id="l25.499" class="difflineminus">-    if (content_headers) </span>
<a href="#l25.500"></a><span id="l25.500" class="difflineplus">+    if (content_headers)</span>
<a href="#l25.501"></a><span id="l25.501">     {</span>
<a href="#l25.502"></a><span id="l25.502">       PUSH(content_headers);</span>
<a href="#l25.503"></a><span id="l25.503">       PR_Free(content_headers);</span>
<a href="#l25.504"></a><span id="l25.504">       content_headers = 0;</span>
<a href="#l25.505"></a><span id="l25.505">     }</span>
<a href="#l25.506"></a><span id="l25.506">   }</span>
<a href="#l25.507"></a><span id="l25.507"> </span>
<a href="#l25.508"></a><span id="l25.508">   PUSH(CRLF);         // A blank line, to mark the end of headers.</span>
<a href="#l25.509"></a><span id="l25.509"> </span>
<a href="#l25.510"></a><span id="l25.510">   m_firstBlock = true;</span>
<a href="#l25.511"></a><span id="l25.511">   /* only convert if we need to tag charset */</span>
<a href="#l25.512"></a><span id="l25.512">   m_needIntlConversion = mime_type_needs_charset(m_type);</span>
<a href="#l25.513"></a><span id="l25.513" class="difflineminus">-  </span>
<a href="#l25.514"></a><span id="l25.514" class="difflineminus">-  if (m_buffer) </span>
<a href="#l25.515"></a><span id="l25.515" class="difflineplus">+</span>
<a href="#l25.516"></a><span id="l25.516" class="difflineplus">+  if (m_buffer)</span>
<a href="#l25.517"></a><span id="l25.517">   {</span>
<a href="#l25.518"></a><span id="l25.518">     status = PushBody(m_buffer, PL_strlen(m_buffer));</span>
<a href="#l25.519"></a><span id="l25.519">     if (NS_FAILED(status))</span>
<a href="#l25.520"></a><span id="l25.520">       goto FAIL;</span>
<a href="#l25.521"></a><span id="l25.521">   }</span>
<a href="#l25.522"></a><span id="l25.522" class="difflineminus">-  else if (m_file) </span>
<a href="#l25.523"></a><span id="l25.523" class="difflineplus">+  else if (m_file)</span>
<a href="#l25.524"></a><span id="l25.524">   {</span>
<a href="#l25.525"></a><span id="l25.525">     nsCOMPtr&lt;nsIInputStream&gt; inputStream;</span>
<a href="#l25.526"></a><span id="l25.526">     nsresult rv = NS_NewLocalFileInputStream(getter_AddRefs(inputStream), m_file);</span>
<a href="#l25.527"></a><span id="l25.527">     if (NS_FAILED(rv))</span>
<a href="#l25.528"></a><span id="l25.528">     {</span>
<a href="#l25.529"></a><span id="l25.529">       // mysteriously disappearing?</span>
<a href="#l25.530"></a><span id="l25.530">       nsCOMPtr&lt;nsIMsgSendReport&gt; sendReport;</span>
<a href="#l25.531"></a><span id="l25.531">       m_state-&gt;GetSendReport(getter_AddRefs(sendReport));</span>
<a href="#l25.532"></a><span id="l25.532" class="difflineat">@@ -627,28 +627,28 @@ nsMsgSendPart::Write()</span>
<a href="#l25.533"></a><span id="l25.533">       status = NS_MSG_UNABLE_TO_OPEN_TMP_FILE;</span>
<a href="#l25.534"></a><span id="l25.534">       goto FAIL;</span>
<a href="#l25.535"></a><span id="l25.535">     }</span>
<a href="#l25.536"></a><span id="l25.536"> </span>
<a href="#l25.537"></a><span id="l25.537">     nsCString curLine;</span>
<a href="#l25.538"></a><span id="l25.538">     bool more = true;</span>
<a href="#l25.539"></a><span id="l25.539"> </span>
<a href="#l25.540"></a><span id="l25.540">     /* Kludge to avoid having to allocate memory on the toy computers... */</span>
<a href="#l25.541"></a><span id="l25.541" class="difflineminus">-    if (!mime_mailto_stream_read_buffer) </span>
<a href="#l25.542"></a><span id="l25.542" class="difflineplus">+    if (!mime_mailto_stream_read_buffer)</span>
<a href="#l25.543"></a><span id="l25.543">     {</span>
<a href="#l25.544"></a><span id="l25.544">       mime_mailto_stream_read_buffer = (char *) PR_Malloc(MIME_BUFFER_SIZE);</span>
<a href="#l25.545"></a><span id="l25.545" class="difflineminus">-      if (!mime_mailto_stream_read_buffer) </span>
<a href="#l25.546"></a><span id="l25.546" class="difflineplus">+      if (!mime_mailto_stream_read_buffer)</span>
<a href="#l25.547"></a><span id="l25.547">       {</span>
<a href="#l25.548"></a><span id="l25.548">         status = NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l25.549"></a><span id="l25.549">         goto FAIL;</span>
<a href="#l25.550"></a><span id="l25.550">       }</span>
<a href="#l25.551"></a><span id="l25.551">     }</span>
<a href="#l25.552"></a><span id="l25.552"> </span>
<a href="#l25.553"></a><span id="l25.553">     char    *buffer = mime_mailto_stream_read_buffer;</span>
<a href="#l25.554"></a><span id="l25.554" class="difflineminus">-    if (m_strip_sensitive_headers) </span>
<a href="#l25.555"></a><span id="l25.555" class="difflineplus">+    if (m_strip_sensitive_headers)</span>
<a href="#l25.556"></a><span id="l25.556">     {</span>
<a href="#l25.557"></a><span id="l25.557">       // We are attaching a message, so we should be careful to</span>
<a href="#l25.558"></a><span id="l25.558">       // strip out certain sensitive internal header fields.</span>
<a href="#l25.559"></a><span id="l25.559">       bool skipping = false;</span>
<a href="#l25.560"></a><span id="l25.560">       nsAutoPtr&lt;nsLineBuffer&lt;char&gt; &gt; lineBuffer(new nsLineBuffer&lt;char&gt;);</span>
<a href="#l25.561"></a><span id="l25.561">       NS_ENSURE_TRUE(lineBuffer, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l25.562"></a><span id="l25.562"> </span>
<a href="#l25.563"></a><span id="l25.563">       while (more)</span>
<a href="#l25.564"></a><span id="l25.564" class="difflineat">@@ -660,52 +660,52 @@ nsMsgSendPart::Write()</span>
<a href="#l25.565"></a><span id="l25.565"> </span>
<a href="#l25.566"></a><span id="l25.566">         char *line = (char *) curLine.get();</span>
<a href="#l25.567"></a><span id="l25.567">         if (skipping) {</span>
<a href="#l25.568"></a><span id="l25.568">           if (*line == ' ' || *line == '\t')</span>
<a href="#l25.569"></a><span id="l25.569">             continue;</span>
<a href="#l25.570"></a><span id="l25.570">           else</span>
<a href="#l25.571"></a><span id="l25.571">             skipping = false;</span>
<a href="#l25.572"></a><span id="l25.572">         }</span>
<a href="#l25.573"></a><span id="l25.573" class="difflineminus">-                </span>
<a href="#l25.574"></a><span id="l25.574" class="difflineplus">+</span>
<a href="#l25.575"></a><span id="l25.575">         if (!PL_strncasecmp(line, &quot;From -&quot;, 6) ||</span>
<a href="#l25.576"></a><span id="l25.576">             !PL_strncasecmp(line, &quot;BCC:&quot;, 4) ||</span>
<a href="#l25.577"></a><span id="l25.577">             !PL_strncasecmp(line, &quot;FCC:&quot;, 4) ||</span>
<a href="#l25.578"></a><span id="l25.578">             !PL_strncasecmp(line, CONTENT_LENGTH &quot;:&quot;, CONTENT_LENGTH_LEN+1) ||</span>
<a href="#l25.579"></a><span id="l25.579">             !PL_strncasecmp(line, &quot;Lines:&quot;, 6) ||</span>
<a href="#l25.580"></a><span id="l25.580">             !PL_strncasecmp(line, &quot;Status:&quot;, 7) ||</span>
<a href="#l25.581"></a><span id="l25.581">             !PL_strncasecmp(line, X_MOZILLA_STATUS &quot;:&quot;, X_MOZILLA_STATUS_LEN+1) ||</span>
<a href="#l25.582"></a><span id="l25.582">             !PL_strncasecmp(line, X_MOZILLA_STATUS2 &quot;:&quot;, X_MOZILLA_STATUS2_LEN+1) ||</span>
<a href="#l25.583"></a><span id="l25.583">             !PL_strncasecmp(line, X_MOZILLA_DRAFT_INFO &quot;:&quot;, X_MOZILLA_DRAFT_INFO_LEN+1) ||</span>
<a href="#l25.584"></a><span id="l25.584">             !PL_strncasecmp(line, X_MOZILLA_NEWSHOST &quot;:&quot;, X_MOZILLA_NEWSHOST_LEN+1) ||</span>
<a href="#l25.585"></a><span id="l25.585">             !PL_strncasecmp(line, X_UIDL &quot;:&quot;, X_UIDL_LEN+1) ||</span>
<a href="#l25.586"></a><span id="l25.586">             !PL_strncasecmp(line, &quot;X-VM-&quot;, 5)) /* hi Kyle */</span>
<a href="#l25.587"></a><span id="l25.587">         {</span>
<a href="#l25.588"></a><span id="l25.588">           skipping = true;</span>
<a href="#l25.589"></a><span id="l25.589">           continue;</span>
<a href="#l25.590"></a><span id="l25.590">         }</span>
<a href="#l25.591"></a><span id="l25.591" class="difflineminus">-        </span>
<a href="#l25.592"></a><span id="l25.592" class="difflineplus">+</span>
<a href="#l25.593"></a><span id="l25.593">         PUSH(line);</span>
<a href="#l25.594"></a><span id="l25.594" class="difflineminus">-        </span>
<a href="#l25.595"></a><span id="l25.595" class="difflineplus">+</span>
<a href="#l25.596"></a><span id="l25.596">         if (curLine.Length() == 2) {</span>
<a href="#l25.597"></a><span id="l25.597">           nsCOMPtr &lt;nsISeekableStream&gt; seekableStream = do_QueryInterface(inputStream);</span>
<a href="#l25.598"></a><span id="l25.598">           // seek back the amount of data left in the line buffer...</span>
<a href="#l25.599"></a><span id="l25.599">           seekableStream-&gt;Seek(nsISeekableStream::NS_SEEK_CUR, lineBuffer-&gt;start - lineBuffer-&gt;end);</span>
<a href="#l25.600"></a><span id="l25.600">           break;  // Now can do normal reads for the body.</span>
<a href="#l25.601"></a><span id="l25.601">         }</span>
<a href="#l25.602"></a><span id="l25.602">       }</span>
<a href="#l25.603"></a><span id="l25.603">       lineBuffer = nullptr;</span>
<a href="#l25.604"></a><span id="l25.604">     }</span>
<a href="#l25.605"></a><span id="l25.605"> </span>
<a href="#l25.606"></a><span id="l25.606">     while (NS_SUCCEEDED(status))</span>
<a href="#l25.607"></a><span id="l25.607">     {</span>
<a href="#l25.608"></a><span id="l25.608">       uint32_t bytesRead;</span>
<a href="#l25.609"></a><span id="l25.609">       nsresult rv = inputStream-&gt;Read(buffer, MIME_BUFFER_SIZE, &amp;bytesRead);</span>
<a href="#l25.610"></a><span id="l25.610">       if (NS_FAILED(rv))</span>
<a href="#l25.611"></a><span id="l25.611" class="difflineminus">-      {  </span>
<a href="#l25.612"></a><span id="l25.612" class="difflineplus">+      {</span>
<a href="#l25.613"></a><span id="l25.613">         nsCOMPtr&lt;nsIMsgSendReport&gt; sendReport;</span>
<a href="#l25.614"></a><span id="l25.614">         m_state-&gt;GetSendReport(getter_AddRefs(sendReport));</span>
<a href="#l25.615"></a><span id="l25.615">         if (sendReport)</span>
<a href="#l25.616"></a><span id="l25.616">         {</span>
<a href="#l25.617"></a><span id="l25.617">           nsAutoString error_msg;</span>
<a href="#l25.618"></a><span id="l25.618">           nsMsgBuildMessageWithFile(m_file, error_msg);</span>
<a href="#l25.619"></a><span id="l25.619">           sendReport-&gt;SetMessage(nsIMsgSendReport::process_Current, error_msg.get(), false);</span>
<a href="#l25.620"></a><span id="l25.620">           status = NS_MSG_UNABLE_TO_OPEN_FILE;</span>
<a href="#l25.621"></a><span id="l25.621" class="difflineat">@@ -729,24 +729,24 @@ nsMsgSendPart::Write()</span>
<a href="#l25.622"></a><span id="l25.622">     {</span>
<a href="#l25.623"></a><span id="l25.623">       // XXX -1 is not a valid nsresult</span>
<a href="#l25.624"></a><span id="l25.624">       status = static_cast&lt;nsresult&gt;(-1);</span>
<a href="#l25.625"></a><span id="l25.625">       goto FAIL;</span>
<a href="#l25.626"></a><span id="l25.626">     }</span>
<a href="#l25.627"></a><span id="l25.627">   }</span>
<a href="#l25.628"></a><span id="l25.628"> </span>
<a href="#l25.629"></a><span id="l25.629">   //</span>
<a href="#l25.630"></a><span id="l25.630" class="difflineminus">-  // Ok, from here we loop and drive the the output of all children </span>
<a href="#l25.631"></a><span id="l25.631" class="difflineplus">+  // Ok, from here we loop and drive the the output of all children</span>
<a href="#l25.632"></a><span id="l25.632">   // for this message.</span>
<a href="#l25.633"></a><span id="l25.633">   //</span>
<a href="#l25.634"></a><span id="l25.634" class="difflineminus">-  if (m_numchildren &gt; 0) </span>
<a href="#l25.635"></a><span id="l25.635" class="difflineplus">+  if (m_numchildren &gt; 0)</span>
<a href="#l25.636"></a><span id="l25.636">   {</span>
<a href="#l25.637"></a><span id="l25.637">     bool    writeSeparator = true;</span>
<a href="#l25.638"></a><span id="l25.638"> </span>
<a href="#l25.639"></a><span id="l25.639" class="difflineminus">-    for (int i = 0 ; i &lt; m_numchildren ; i ++) </span>
<a href="#l25.640"></a><span id="l25.640" class="difflineplus">+    for (int i = 0 ; i &lt; m_numchildren ; i ++)</span>
<a href="#l25.641"></a><span id="l25.641">     {</span>
<a href="#l25.642"></a><span id="l25.642">       if (writeSeparator)</span>
<a href="#l25.643"></a><span id="l25.643">       {</span>
<a href="#l25.644"></a><span id="l25.644">         PUSH(CRLF);</span>
<a href="#l25.645"></a><span id="l25.645">         PUSH(&quot;--&quot;);</span>
<a href="#l25.646"></a><span id="l25.646"> </span>
<a href="#l25.647"></a><span id="l25.647">         PUSH(separator);</span>
<a href="#l25.648"></a><span id="l25.648">         PUSH(CRLF);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgSendPart.h</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgSendPart.h</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineat">@@ -31,17 +31,17 @@ public:</span>
<a href="#l26.4"></a><span id="l26.4">     virtual nsresult    SetFile(nsIFile *filename);</span>
<a href="#l26.5"></a><span id="l26.5">     const nsIFile  *GetFile() {return m_file;}</span>
<a href="#l26.6"></a><span id="l26.6"> </span>
<a href="#l26.7"></a><span id="l26.7">     virtual nsresult  SetBuffer(const char* buffer);</span>
<a href="#l26.8"></a><span id="l26.8">     const char        *GetBuffer() {return m_buffer;}</span>
<a href="#l26.9"></a><span id="l26.9"> </span>
<a href="#l26.10"></a><span id="l26.10">     virtual nsresult  SetType(const char* type);</span>
<a href="#l26.11"></a><span id="l26.11">     const char        *GetType() {return m_type;}</span>
<a href="#l26.12"></a><span id="l26.12" class="difflineminus">-    </span>
<a href="#l26.13"></a><span id="l26.13" class="difflineplus">+</span>
<a href="#l26.14"></a><span id="l26.14">     const char        *GetCharsetName() {return m_charset_name;}</span>
<a href="#l26.15"></a><span id="l26.15"> </span>
<a href="#l26.16"></a><span id="l26.16">     virtual nsresult  SetOtherHeaders(const char* other);</span>
<a href="#l26.17"></a><span id="l26.17">     const char        *SetOtherHeaders() {return m_other;}</span>
<a href="#l26.18"></a><span id="l26.18"> 	  virtual nsresult  AppendOtherHeaders(const char* moreother);</span>
<a href="#l26.19"></a><span id="l26.19"> </span>
<a href="#l26.20"></a><span id="l26.20"> 	  virtual nsresult  SetMimeDeliveryState(nsIMsgSend* state);</span>
<a href="#l26.21"></a><span id="l26.21"> </span>
<a href="#l26.22"></a><span id="l26.22" class="difflineat">@@ -60,17 +60,17 @@ public:</span>
<a href="#l26.23"></a><span id="l26.23"> </span>
<a href="#l26.24"></a><span id="l26.24">   virtual nsresult    AddChild(nsMsgSendPart* child);</span>
<a href="#l26.25"></a><span id="l26.25"> </span>
<a href="#l26.26"></a><span id="l26.26"> 	int32_t             GetNumChildren() {return m_numchildren;}</span>
<a href="#l26.27"></a><span id="l26.27"> 	nsMsgSendPart       *GetChild(int32_t which);</span>
<a href="#l26.28"></a><span id="l26.28"> 	nsMsgSendPart       *DetachChild(int32_t which);</span>
<a href="#l26.29"></a><span id="l26.29"> </span>
<a href="#l26.30"></a><span id="l26.30"> 	virtual nsresult    SetMainPart(bool value);</span>
<a href="#l26.31"></a><span id="l26.31" class="difflineminus">-	bool                IsMainPart() </span>
<a href="#l26.32"></a><span id="l26.32" class="difflineplus">+	bool                IsMainPart()</span>
<a href="#l26.33"></a><span id="l26.33">                       {</span>
<a href="#l26.34"></a><span id="l26.34">                         return m_mainpart;</span>
<a href="#l26.35"></a><span id="l26.35">                       }</span>
<a href="#l26.36"></a><span id="l26.36">   nsCString           m_partNum;</span>
<a href="#l26.37"></a><span id="l26.37"> protected:</span>
<a href="#l26.38"></a><span id="l26.38"> 	nsresult            CopyString(char** dest, const char* src);</span>
<a href="#l26.39"></a><span id="l26.39"> 	nsresult            PushBody(const char* buffer, int32_t length);</span>
<a href="#l26.40"></a><span id="l26.40"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l27.1"></a><span id="l27.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgSendReport.cpp</span>
<a href="#l27.2"></a><span id="l27.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgSendReport.cpp</span>
<a href="#l27.3"></a><span id="l27.3" class="difflineat">@@ -79,17 +79,17 @@ NS_IMETHODIMP nsMsgProcessReport::Reset(</span>
<a href="#l27.4"></a><span id="l27.4"> NS_IMPL_ISUPPORTS(nsMsgSendReport, nsIMsgSendReport)</span>
<a href="#l27.5"></a><span id="l27.5"> </span>
<a href="#l27.6"></a><span id="l27.6"> nsMsgSendReport::nsMsgSendReport()</span>
<a href="#l27.7"></a><span id="l27.7"> {</span>
<a href="#l27.8"></a><span id="l27.8">   uint32_t i;</span>
<a href="#l27.9"></a><span id="l27.9">   for (i = 0; i &lt;= SEND_LAST_PROCESS; i ++)</span>
<a href="#l27.10"></a><span id="l27.10">     mProcessReport[i] = new nsMsgProcessReport();</span>
<a href="#l27.11"></a><span id="l27.11"> </span>
<a href="#l27.12"></a><span id="l27.12" class="difflineminus">-  Reset(); </span>
<a href="#l27.13"></a><span id="l27.13" class="difflineplus">+  Reset();</span>
<a href="#l27.14"></a><span id="l27.14"> }</span>
<a href="#l27.15"></a><span id="l27.15"> </span>
<a href="#l27.16"></a><span id="l27.16"> nsMsgSendReport::~nsMsgSendReport()</span>
<a href="#l27.17"></a><span id="l27.17"> {</span>
<a href="#l27.18"></a><span id="l27.18">   uint32_t i;</span>
<a href="#l27.19"></a><span id="l27.19">   for (i = 0; i &lt;= SEND_LAST_PROCESS; i ++)</span>
<a href="#l27.20"></a><span id="l27.20">     mProcessReport[i] = nullptr;</span>
<a href="#l27.21"></a><span id="l27.21"> }</span>
<a href="#l27.22"></a><span id="l27.22" class="difflineat">@@ -254,17 +254,17 @@ NS_IMETHODIMP nsMsgSendReport::DisplayRe</span>
<a href="#l27.23"></a><span id="l27.23">     mozilla::services::GetStringBundleService();</span>
<a href="#l27.24"></a><span id="l27.24">   NS_ENSURE_TRUE(bundleService, NS_ERROR_UNEXPECTED);</span>
<a href="#l27.25"></a><span id="l27.25">   nsCOMPtr&lt;nsIStringBundle&gt; bundle;</span>
<a href="#l27.26"></a><span id="l27.26">   rv = bundleService-&gt;CreateBundle(&quot;chrome://messenger/locale/messengercompose/composeMsgs.properties&quot;, getter_AddRefs(bundle));</span>
<a href="#l27.27"></a><span id="l27.27">   if (NS_FAILED(rv))</span>
<a href="#l27.28"></a><span id="l27.28">   {</span>
<a href="#l27.29"></a><span id="l27.29">     //TODO need to display a generic hardcoded message</span>
<a href="#l27.30"></a><span id="l27.30">     mAlreadyDisplayReport = true;</span>
<a href="#l27.31"></a><span id="l27.31" class="difflineminus">-    return NS_OK;  </span>
<a href="#l27.32"></a><span id="l27.32" class="difflineplus">+    return NS_OK;</span>
<a href="#l27.33"></a><span id="l27.33">   }</span>
<a href="#l27.34"></a><span id="l27.34"> </span>
<a href="#l27.35"></a><span id="l27.35">   nsString dialogTitle;</span>
<a href="#l27.36"></a><span id="l27.36">   nsString dialogMessage;</span>
<a href="#l27.37"></a><span id="l27.37"> </span>
<a href="#l27.38"></a><span id="l27.38">   if (NS_SUCCEEDED(currError))</span>
<a href="#l27.39"></a><span id="l27.39">   {</span>
<a href="#l27.40"></a><span id="l27.40">     //TODO display a success error message</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l28.1"></a><span id="l28.1" class="difflineminus">--- a/mailnews/compose/src/nsSmtpProtocol.h</span>
<a href="#l28.2"></a><span id="l28.2" class="difflineplus">+++ b/mailnews/compose/src/nsSmtpProtocol.h</span>
<a href="#l28.3"></a><span id="l28.3" class="difflineat">@@ -51,17 +51,17 @@ SMTP_AUTH_PROCESS_STATE,                </span>
<a href="#l28.4"></a><span id="l28.4"> SMTP_AUTH_CRAM_MD5_CHALLENGE_RESPONSE,              // 22</span>
<a href="#l28.5"></a><span id="l28.5"> SMTP_SEND_AUTH_GSSAPI_FIRST,                        // 23</span>
<a href="#l28.6"></a><span id="l28.6"> SMTP_SEND_AUTH_GSSAPI_STEP,                         // 24</span>
<a href="#l28.7"></a><span id="l28.7"> SMTP_SUSPENDED,                                     // 25</span>
<a href="#l28.8"></a><span id="l28.8"> SMTP_AUTH_OAUTH2_STEP,                              // 26</span>
<a href="#l28.9"></a><span id="l28.9"> SMTP_AUTH_OAUTH2_RESPONSE,                          // 27</span>
<a href="#l28.10"></a><span id="l28.10"> } SmtpState;</span>
<a href="#l28.11"></a><span id="l28.11"> </span>
<a href="#l28.12"></a><span id="l28.12" class="difflineminus">-// State Flags (Note, I use the word state in terms of storing </span>
<a href="#l28.13"></a><span id="l28.13" class="difflineplus">+// State Flags (Note, I use the word state in terms of storing</span>
<a href="#l28.14"></a><span id="l28.14"> // state information about the connection (authentication, have we sent</span>
<a href="#l28.15"></a><span id="l28.15"> // commands, etc. I do not intend it to refer to protocol state)</span>
<a href="#l28.16"></a><span id="l28.16"> #define SMTP_PAUSE_FOR_READ             0x00000001  /* should we pause for the next read */</span>
<a href="#l28.17"></a><span id="l28.17"> #define SMTP_ESMTP_SERVER               0x00000002</span>
<a href="#l28.18"></a><span id="l28.18"> #define SMTP_EHLO_DSN_ENABLED           0x00000004</span>
<a href="#l28.19"></a><span id="l28.19"> #define SMTP_EHLO_STARTTLS_ENABLED      0x00000008</span>
<a href="#l28.20"></a><span id="l28.20"> #define SMTP_EHLO_SIZE_ENABLED          0x00000010</span>
<a href="#l28.21"></a><span id="l28.21"> #define SMTP_EHLO_8BIT_ENABLED          0x00000020</span>
<a href="#l28.22"></a><span id="l28.22" class="difflineat">@@ -95,20 +95,20 @@ public:</span>
<a href="#l28.23"></a><span id="l28.23"> </span>
<a href="#l28.24"></a><span id="l28.24">     // Creating a protocol instance requires the URL which needs to be run.</span>
<a href="#l28.25"></a><span id="l28.25">     nsSmtpProtocol(nsIURI * aURL);</span>
<a href="#l28.26"></a><span id="l28.26"> </span>
<a href="#l28.27"></a><span id="l28.27">     virtual nsresult LoadUrl(nsIURI * aURL, nsISupports * aConsumer = nullptr) override;</span>
<a href="#l28.28"></a><span id="l28.28">     virtual nsresult SendData(const char * dataBuffer, bool aSuppressLogging = false) override;</span>
<a href="#l28.29"></a><span id="l28.29"> </span>
<a href="#l28.30"></a><span id="l28.30">     ////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l28.31"></a><span id="l28.31" class="difflineminus">-    // we suppport the nsIStreamListener interface </span>
<a href="#l28.32"></a><span id="l28.32" class="difflineplus">+    // we suppport the nsIStreamListener interface</span>
<a href="#l28.33"></a><span id="l28.33">     ////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l28.34"></a><span id="l28.34"> </span>
<a href="#l28.35"></a><span id="l28.35" class="difflineminus">-    // stop binding is a &quot;notification&quot; informing us that the stream associated with aURL is going away. </span>
<a href="#l28.36"></a><span id="l28.36" class="difflineplus">+    // stop binding is a &quot;notification&quot; informing us that the stream associated with aURL is going away.</span>
<a href="#l28.37"></a><span id="l28.37">     NS_IMETHOD OnStopRequest(nsIRequest *request, nsISupports *ctxt, nsresult status) override;</span>
<a href="#l28.38"></a><span id="l28.38"> </span>
<a href="#l28.39"></a><span id="l28.39"> private:</span>
<a href="#l28.40"></a><span id="l28.40">     virtual ~nsSmtpProtocol();</span>
<a href="#l28.41"></a><span id="l28.41">     // if we are asked to load a url while we are blocked waiting for redirection information,</span>
<a href="#l28.42"></a><span id="l28.42">     // then we'll store the url consumer in mPendingConsumer until we can actually load</span>
<a href="#l28.43"></a><span id="l28.43">     // the url.</span>
<a href="#l28.44"></a><span id="l28.44">     nsCOMPtr&lt;nsISupports&gt; mPendingConsumer;</span>
<a href="#l28.45"></a><span id="l28.45" class="difflineat">@@ -116,21 +116,21 @@ private:</span>
<a href="#l28.46"></a><span id="l28.46">     // the nsISmtpURL that is currently running</span>
<a href="#l28.47"></a><span id="l28.47">     nsCOMPtr&lt;nsISmtpUrl&gt; m_runningURL;</span>
<a href="#l28.48"></a><span id="l28.48"> </span>
<a href="#l28.49"></a><span id="l28.49">     // the error state we want to set on the url</span>
<a href="#l28.50"></a><span id="l28.50">     nsresult m_urlErrorState;</span>
<a href="#l28.51"></a><span id="l28.51">     nsCOMPtr&lt;nsIMsgStatusFeedback&gt; m_statusFeedback;</span>
<a href="#l28.52"></a><span id="l28.52"> </span>
<a href="#l28.53"></a><span id="l28.53">     // Generic state information -- What state are we in? What state do we want to go to</span>
<a href="#l28.54"></a><span id="l28.54" class="difflineminus">-    // after the next response? What was the last response code? etc. </span>
<a href="#l28.55"></a><span id="l28.55" class="difflineplus">+    // after the next response? What was the last response code? etc.</span>
<a href="#l28.56"></a><span id="l28.56">     SmtpState m_nextState;</span>
<a href="#l28.57"></a><span id="l28.57">     SmtpState m_nextStateAfterResponse;</span>
<a href="#l28.58"></a><span id="l28.58">     int32_t m_responseCode;    /* code returned from Smtp server */</span>
<a href="#l28.59"></a><span id="l28.59" class="difflineminus">-    int32_t m_previousResponseCode; </span>
<a href="#l28.60"></a><span id="l28.60" class="difflineplus">+    int32_t m_previousResponseCode;</span>
<a href="#l28.61"></a><span id="l28.61">     int32_t m_continuationResponse;</span>
<a href="#l28.62"></a><span id="l28.62">     nsCString m_responseText;   /* text returned from Smtp server */</span>
<a href="#l28.63"></a><span id="l28.63">     nsMsgLineStreamBuffer *m_lineStreamBuffer; // used to efficiently extract lines from the incoming data stream</span>
<a href="#l28.64"></a><span id="l28.64"> </span>
<a href="#l28.65"></a><span id="l28.65">     nsTArray&lt;nsCString&gt; m_addresses;</span>
<a href="#l28.66"></a><span id="l28.66">     uint32_t       m_addressesLeft;</span>
<a href="#l28.67"></a><span id="l28.67">     nsCString m_mailAddr;</span>
<a href="#l28.68"></a><span id="l28.68">     nsCString m_helloArgument;</span>
<a href="#l28.69"></a><span id="l28.69" class="difflineat">@@ -153,33 +153,33 @@ private:</span>
<a href="#l28.70"></a><span id="l28.70">     uint32_t m_dataBufSize;</span>
<a href="#l28.71"></a><span id="l28.71"> </span>
<a href="#l28.72"></a><span id="l28.72">     int32_t   m_originalContentLength; /* the content length at the time of calling graph progress */</span>
<a href="#l28.73"></a><span id="l28.73"> </span>
<a href="#l28.74"></a><span id="l28.74">     // initialization function given a new url and transport layer</span>
<a href="#l28.75"></a><span id="l28.75">     nsresult Initialize(nsIURI * aURL);</span>
<a href="#l28.76"></a><span id="l28.76">     nsresult InitializeInternal(nsIProxyInfo* proxyInfo);</span>
<a href="#l28.77"></a><span id="l28.77">     nsresult LoadUrlInternal(nsIURI *aURL, nsISupports *aConsumer);</span>
<a href="#l28.78"></a><span id="l28.78" class="difflineminus">-    virtual nsresult ProcessProtocolState(nsIURI * url, nsIInputStream * inputStream, </span>
<a href="#l28.79"></a><span id="l28.79" class="difflineplus">+    virtual nsresult ProcessProtocolState(nsIURI * url, nsIInputStream * inputStream,</span>
<a href="#l28.80"></a><span id="l28.80">                                           uint64_t sourceOffset, uint32_t length) override;</span>
<a href="#l28.81"></a><span id="l28.81"> </span>
<a href="#l28.82"></a><span id="l28.82">     ////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l28.83"></a><span id="l28.83">     // Communication methods --&gt; Reading and writing protocol</span>
<a href="#l28.84"></a><span id="l28.84">     ////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l28.85"></a><span id="l28.85"> </span>
<a href="#l28.86"></a><span id="l28.86">     void UpdateStatus(const char* aStatusName);</span>
<a href="#l28.87"></a><span id="l28.87">     void UpdateStatusWithString(const char16_t * aStatusString);</span>
<a href="#l28.88"></a><span id="l28.88"> </span>
<a href="#l28.89"></a><span id="l28.89">     ////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l28.90"></a><span id="l28.90" class="difflineminus">-    // Protocol Methods --&gt; This protocol is state driven so each protocol method is </span>
<a href="#l28.91"></a><span id="l28.91" class="difflineminus">-    //						designed to re-act to the current &quot;state&quot;. I've attempted to </span>
<a href="#l28.92"></a><span id="l28.92" class="difflineminus">-    //						group them together based on functionality. </span>
<a href="#l28.93"></a><span id="l28.93" class="difflineplus">+    // Protocol Methods --&gt; This protocol is state driven so each protocol method is</span>
<a href="#l28.94"></a><span id="l28.94" class="difflineplus">+    //						designed to re-act to the current &quot;state&quot;. I've attempted to</span>
<a href="#l28.95"></a><span id="l28.95" class="difflineplus">+    //						group them together based on functionality.</span>
<a href="#l28.96"></a><span id="l28.96">     ////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l28.97"></a><span id="l28.97"> </span>
<a href="#l28.98"></a><span id="l28.98" class="difflineminus">-    nsresult SmtpResponse(nsIInputStream * inputStream, uint32_t length); </span>
<a href="#l28.99"></a><span id="l28.99" class="difflineplus">+    nsresult SmtpResponse(nsIInputStream * inputStream, uint32_t length);</span>
<a href="#l28.100"></a><span id="l28.100">     nsresult ExtensionLoginResponse(nsIInputStream * inputStream, uint32_t length);</span>
<a href="#l28.101"></a><span id="l28.101">     nsresult SendHeloResponse(nsIInputStream * inputStream, uint32_t length);</span>
<a href="#l28.102"></a><span id="l28.102">     nsresult SendEhloResponse(nsIInputStream * inputStream, uint32_t length);	</span>
<a href="#l28.103"></a><span id="l28.103">     nsresult SendQuit(SmtpState aNextStateAfterResponse = SMTP_DONE);</span>
<a href="#l28.104"></a><span id="l28.104"> </span>
<a href="#l28.105"></a><span id="l28.105">     nsresult AuthGSSAPIFirst();</span>
<a href="#l28.106"></a><span id="l28.106">     nsresult AuthGSSAPIStep();</span>
<a href="#l28.107"></a><span id="l28.107">     nsresult AuthLoginStep0();</span>
<a href="#l28.108"></a><span id="l28.108" class="difflineat">@@ -202,18 +202,18 @@ private:</span>
<a href="#l28.109"></a><span id="l28.109">     // End of Protocol Methods</span>
<a href="#l28.110"></a><span id="l28.110">     ////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l28.111"></a><span id="l28.111"> </span>
<a href="#l28.112"></a><span id="l28.112">     void SendMessageInFile();</span>
<a href="#l28.113"></a><span id="l28.113"> </span>
<a href="#l28.114"></a><span id="l28.114">     void AppendHelloArgument(nsACString&amp; aResult);</span>
<a href="#l28.115"></a><span id="l28.115">     nsresult GetPassword(nsCString &amp;aPassword);</span>
<a href="#l28.116"></a><span id="l28.116">     nsresult GetUsernamePassword(nsACString &amp;aUsername, nsACString &amp;aPassword);</span>
<a href="#l28.117"></a><span id="l28.117" class="difflineminus">-    nsresult PromptForPassword(nsISmtpServer *aSmtpServer, nsISmtpUrl *aSmtpUrl, </span>
<a href="#l28.118"></a><span id="l28.118" class="difflineminus">-                               const char16_t **formatStrings, </span>
<a href="#l28.119"></a><span id="l28.119" class="difflineplus">+    nsresult PromptForPassword(nsISmtpServer *aSmtpServer, nsISmtpUrl *aSmtpUrl,</span>
<a href="#l28.120"></a><span id="l28.120" class="difflineplus">+                               const char16_t **formatStrings,</span>
<a href="#l28.121"></a><span id="l28.121">                                nsACString &amp;aPassword);</span>
<a href="#l28.122"></a><span id="l28.122"> </span>
<a href="#l28.123"></a><span id="l28.123">     void    InitPrefAuthMethods(int32_t authMethodPrefValue);</span>
<a href="#l28.124"></a><span id="l28.124">     nsresult ChooseAuthMethod();</span>
<a href="#l28.125"></a><span id="l28.125">     void    MarkAuthMethodAsFailed(int32_t failedAuthMethod);</span>
<a href="#l28.126"></a><span id="l28.126">     void    ResetAuthMethods();</span>
<a href="#l28.127"></a><span id="l28.127"> </span>
<a href="#l28.128"></a><span id="l28.128">     virtual const char* GetType() override {return &quot;smtp&quot;;}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l29.1"></a><span id="l29.1" class="difflineminus">--- a/mailnews/compose/src/nsSmtpServer.h</span>
<a href="#l29.2"></a><span id="l29.2" class="difflineplus">+++ b/mailnews/compose/src/nsSmtpServer.h</span>
<a href="#l29.3"></a><span id="l29.3" class="difflineat">@@ -12,26 +12,26 @@</span>
<a href="#l29.4"></a><span id="l29.4"> #include &quot;nsIPrefBranch.h&quot;</span>
<a href="#l29.5"></a><span id="l29.5"> #include &quot;nsWeakReference.h&quot;</span>
<a href="#l29.6"></a><span id="l29.6"> </span>
<a href="#l29.7"></a><span id="l29.7"> class nsSmtpServer : public nsISmtpServer,</span>
<a href="#l29.8"></a><span id="l29.8">                      public nsSupportsWeakReference</span>
<a href="#l29.9"></a><span id="l29.9"> {</span>
<a href="#l29.10"></a><span id="l29.10"> public:</span>
<a href="#l29.11"></a><span id="l29.11">     nsSmtpServer();</span>
<a href="#l29.12"></a><span id="l29.12" class="difflineminus">-    </span>
<a href="#l29.13"></a><span id="l29.13" class="difflineplus">+</span>
<a href="#l29.14"></a><span id="l29.14">     NS_DECL_ISUPPORTS</span>
<a href="#l29.15"></a><span id="l29.15">     NS_DECL_NSISMTPSERVER</span>
<a href="#l29.16"></a><span id="l29.16"> </span>
<a href="#l29.17"></a><span id="l29.17"> private:</span>
<a href="#l29.18"></a><span id="l29.18">     virtual ~nsSmtpServer();</span>
<a href="#l29.19"></a><span id="l29.19">     nsCString mKey;</span>
<a href="#l29.20"></a><span id="l29.20">     nsCOMPtr&lt;nsIPrefBranch&gt; mPrefBranch;</span>
<a href="#l29.21"></a><span id="l29.21">     nsCOMPtr&lt;nsIPrefBranch&gt; mDefPrefBranch;</span>
<a href="#l29.22"></a><span id="l29.22" class="difflineminus">-                                                                                                                                               </span>
<a href="#l29.23"></a><span id="l29.23" class="difflineplus">+</span>
<a href="#l29.24"></a><span id="l29.24">     nsresult getPrefs();</span>
<a href="#l29.25"></a><span id="l29.25">     void getIntPrefWithDefault(const char *prefName, int32_t *val,</span>
<a href="#l29.26"></a><span id="l29.26">                                int32_t defval);</span>
<a href="#l29.27"></a><span id="l29.27">     nsresult GetPasswordWithoutUI();</span>
<a href="#l29.28"></a><span id="l29.28">     nsCString GetServerURIInternal(const bool aIncludeUsername);</span>
<a href="#l29.29"></a><span id="l29.29"> </span>
<a href="#l29.30"></a><span id="l29.30">     nsCString m_password;</span>
<a href="#l29.31"></a><span id="l29.31">     bool m_logonFailed;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l30.1"></a><span id="l30.1" class="difflineminus">--- a/mailnews/compose/src/nsSmtpService.cpp</span>
<a href="#l30.2"></a><span id="l30.2" class="difflineplus">+++ b/mailnews/compose/src/nsSmtpService.cpp</span>
<a href="#l30.3"></a><span id="l30.3" class="difflineat">@@ -48,17 +48,17 @@ typedef struct _findServerByHostnameEntr</span>
<a href="#l30.4"></a><span id="l30.4"> </span>
<a href="#l30.5"></a><span id="l30.5"> static NS_DEFINE_CID(kCSmtpUrlCID, NS_SMTPURL_CID);</span>
<a href="#l30.6"></a><span id="l30.6"> static NS_DEFINE_CID(kCMailtoUrlCID, NS_MAILTOURL_CID);</span>
<a href="#l30.7"></a><span id="l30.7"> </span>
<a href="#l30.8"></a><span id="l30.8"> // foward declarations...</span>
<a href="#l30.9"></a><span id="l30.9"> nsresult</span>
<a href="#l30.10"></a><span id="l30.10"> NS_MsgBuildSmtpUrl(nsIFile * aFilePath,</span>
<a href="#l30.11"></a><span id="l30.11">                    nsISmtpServer *aServer,</span>
<a href="#l30.12"></a><span id="l30.12" class="difflineminus">-                   const char* aRecipients, </span>
<a href="#l30.13"></a><span id="l30.13" class="difflineplus">+                   const char* aRecipients,</span>
<a href="#l30.14"></a><span id="l30.14">                    nsIMsgIdentity * aSenderIdentity,</span>
<a href="#l30.15"></a><span id="l30.15">                    nsIUrlListener * aUrlListener,</span>
<a href="#l30.16"></a><span id="l30.16">                    nsIMsgStatusFeedback *aStatusFeedback,</span>
<a href="#l30.17"></a><span id="l30.17">                    nsIInterfaceRequestor* aNotificationCallbacks,</span>
<a href="#l30.18"></a><span id="l30.18">                    nsIURI ** aUrl,</span>
<a href="#l30.19"></a><span id="l30.19">                    bool aRequestDSN);</span>
<a href="#l30.20"></a><span id="l30.20"> </span>
<a href="#l30.21"></a><span id="l30.21"> nsresult NS_MsgLoadSmtpUrl(nsIURI * aUrl, nsISupports * aConsumer, nsIRequest ** aRequest);</span>
<a href="#l30.22"></a><span id="l30.22" class="difflineat">@@ -73,20 +73,20 @@ nsSmtpService::~nsSmtpService()</span>
<a href="#l30.23"></a><span id="l30.23">     // save the SMTP servers to disk</span>
<a href="#l30.24"></a><span id="l30.24"> </span>
<a href="#l30.25"></a><span id="l30.25"> }</span>
<a href="#l30.26"></a><span id="l30.26"> </span>
<a href="#l30.27"></a><span id="l30.27"> NS_IMPL_ISUPPORTS(nsSmtpService, nsISmtpService, nsIProtocolHandler)</span>
<a href="#l30.28"></a><span id="l30.28"> </span>
<a href="#l30.29"></a><span id="l30.29"> </span>
<a href="#l30.30"></a><span id="l30.30"> NS_IMETHODIMP nsSmtpService::SendMailMessage(nsIFile * aFilePath,</span>
<a href="#l30.31"></a><span id="l30.31" class="difflineminus">-                                        const char * aRecipients, </span>
<a href="#l30.32"></a><span id="l30.32" class="difflineplus">+                                        const char * aRecipients,</span>
<a href="#l30.33"></a><span id="l30.33">                                         nsIMsgIdentity * aSenderIdentity,</span>
<a href="#l30.34"></a><span id="l30.34">                                         const char * aPassword,</span>
<a href="#l30.35"></a><span id="l30.35" class="difflineminus">-                                        nsIUrlListener * aUrlListener, </span>
<a href="#l30.36"></a><span id="l30.36" class="difflineplus">+                                        nsIUrlListener * aUrlListener,</span>
<a href="#l30.37"></a><span id="l30.37">                                         nsIMsgStatusFeedback *aStatusFeedback,</span>
<a href="#l30.38"></a><span id="l30.38">                                         nsIInterfaceRequestor* aNotificationCallbacks,</span>
<a href="#l30.39"></a><span id="l30.39">                                         bool aRequestDSN,</span>
<a href="#l30.40"></a><span id="l30.40">                                         nsIURI ** aURL,</span>
<a href="#l30.41"></a><span id="l30.41">                                         nsIRequest ** aRequest)</span>
<a href="#l30.42"></a><span id="l30.42"> {</span>
<a href="#l30.43"></a><span id="l30.43">   nsIURI * urlToRun = nullptr;</span>
<a href="#l30.44"></a><span id="l30.44">   nsresult rv = NS_OK;</span>
<a href="#l30.45"></a><span id="l30.45" class="difflineat">@@ -96,17 +96,17 @@ NS_IMETHODIMP nsSmtpService::SendMailMes</span>
<a href="#l30.46"></a><span id="l30.46"> </span>
<a href="#l30.47"></a><span id="l30.47">   if (NS_SUCCEEDED(rv) &amp;&amp; smtpServer)</span>
<a href="#l30.48"></a><span id="l30.48">   {</span>
<a href="#l30.49"></a><span id="l30.49">     if (aPassword &amp;&amp; *aPassword)</span>
<a href="#l30.50"></a><span id="l30.50">       smtpServer-&gt;SetPassword(nsDependentCString(aPassword));</span>
<a href="#l30.51"></a><span id="l30.51"> </span>
<a href="#l30.52"></a><span id="l30.52">     // this ref counts urlToRun</span>
<a href="#l30.53"></a><span id="l30.53">     rv = NS_MsgBuildSmtpUrl(aFilePath, smtpServer, aRecipients, aSenderIdentity,</span>
<a href="#l30.54"></a><span id="l30.54" class="difflineminus">-                            aUrlListener, aStatusFeedback, </span>
<a href="#l30.55"></a><span id="l30.55" class="difflineplus">+                            aUrlListener, aStatusFeedback,</span>
<a href="#l30.56"></a><span id="l30.56">                             aNotificationCallbacks, &amp;urlToRun, aRequestDSN);</span>
<a href="#l30.57"></a><span id="l30.57">     if (NS_SUCCEEDED(rv) &amp;&amp; urlToRun)	</span>
<a href="#l30.58"></a><span id="l30.58">       rv = NS_MsgLoadSmtpUrl(urlToRun, nullptr, aRequest);</span>
<a href="#l30.59"></a><span id="l30.59"> </span>
<a href="#l30.60"></a><span id="l30.60">     if (aURL) // does the caller want a handle on the url?</span>
<a href="#l30.61"></a><span id="l30.61">       *aURL = urlToRun; // transfer our ref count to the caller....</span>
<a href="#l30.62"></a><span id="l30.62">     else</span>
<a href="#l30.63"></a><span id="l30.63">       NS_IF_RELEASE(urlToRun);</span>
<a href="#l30.64"></a><span id="l30.64" class="difflineat">@@ -116,19 +116,19 @@ NS_IMETHODIMP nsSmtpService::SendMailMes</span>
<a href="#l30.65"></a><span id="l30.65"> }</span>
<a href="#l30.66"></a><span id="l30.66"> </span>
<a href="#l30.67"></a><span id="l30.67"> </span>
<a href="#l30.68"></a><span id="l30.68"> // The following are two convience functions I'm using to help expedite building and running a mail to url...</span>
<a href="#l30.69"></a><span id="l30.69"> </span>
<a href="#l30.70"></a><span id="l30.70"> // short cut function for creating a mailto url...</span>
<a href="#l30.71"></a><span id="l30.71"> nsresult NS_MsgBuildSmtpUrl(nsIFile * aFilePath,</span>
<a href="#l30.72"></a><span id="l30.72">                             nsISmtpServer *aSmtpServer,</span>
<a href="#l30.73"></a><span id="l30.73" class="difflineminus">-                            const char * aRecipients, </span>
<a href="#l30.74"></a><span id="l30.74" class="difflineplus">+                            const char * aRecipients,</span>
<a href="#l30.75"></a><span id="l30.75">                             nsIMsgIdentity * aSenderIdentity,</span>
<a href="#l30.76"></a><span id="l30.76" class="difflineminus">-                            nsIUrlListener * aUrlListener, </span>
<a href="#l30.77"></a><span id="l30.77" class="difflineplus">+                            nsIUrlListener * aUrlListener,</span>
<a href="#l30.78"></a><span id="l30.78">                             nsIMsgStatusFeedback *aStatusFeedback,</span>
<a href="#l30.79"></a><span id="l30.79">                             nsIInterfaceRequestor* aNotificationCallbacks,</span>
<a href="#l30.80"></a><span id="l30.80">                             nsIURI ** aUrl,</span>
<a href="#l30.81"></a><span id="l30.81">                             bool aRequestDSN)</span>
<a href="#l30.82"></a><span id="l30.82"> {</span>
<a href="#l30.83"></a><span id="l30.83">   // mscott: this function is a convience hack until netlib actually dispatches</span>
<a href="#l30.84"></a><span id="l30.84">   // smtp urls. in addition until we have a session to get a password, host and</span>
<a href="#l30.85"></a><span id="l30.85">   // other stuff from, we need to use default values....</span>
<a href="#l30.86"></a><span id="l30.86" class="difflineat">@@ -192,17 +192,17 @@ nsresult NS_MsgBuildSmtpUrl(nsIFile * aF</span>
<a href="#l30.87"></a><span id="l30.87">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.88"></a><span id="l30.88"> </span>
<a href="#l30.89"></a><span id="l30.89">     if (!smtpPrompt)</span>
<a href="#l30.90"></a><span id="l30.90">       wwatch-&gt;GetNewPrompter(0, getter_AddRefs(smtpPrompt));</span>
<a href="#l30.91"></a><span id="l30.91">     if (!smtpAuthPrompt)</span>
<a href="#l30.92"></a><span id="l30.92">       wwatch-&gt;GetNewAuthPrompter(0, getter_AddRefs(smtpAuthPrompt));</span>
<a href="#l30.93"></a><span id="l30.93">   }</span>
<a href="#l30.94"></a><span id="l30.94"> </span>
<a href="#l30.95"></a><span id="l30.95" class="difflineminus">-  smtpUrl-&gt;SetPrompt(smtpPrompt);            </span>
<a href="#l30.96"></a><span id="l30.96" class="difflineplus">+  smtpUrl-&gt;SetPrompt(smtpPrompt);</span>
<a href="#l30.97"></a><span id="l30.97">   smtpUrl-&gt;SetAuthPrompt(smtpAuthPrompt);</span>
<a href="#l30.98"></a><span id="l30.98"> </span>
<a href="#l30.99"></a><span id="l30.99">   if (aUrlListener)</span>
<a href="#l30.100"></a><span id="l30.100">     url-&gt;RegisterListener(aUrlListener);</span>
<a href="#l30.101"></a><span id="l30.101">   if (aStatusFeedback)</span>
<a href="#l30.102"></a><span id="l30.102">     url-&gt;SetStatusFeedback(aStatusFeedback);</span>
<a href="#l30.103"></a><span id="l30.103"> </span>
<a href="#l30.104"></a><span id="l30.104">   return CallQueryInterface(smtpUrl, aUrl);</span>
<a href="#l30.105"></a><span id="l30.105" class="difflineat">@@ -252,30 +252,30 @@ NS_IMETHODIMP nsSmtpService::VerifyLogon</span>
<a href="#l30.106"></a><span id="l30.106">       urlToRun.forget(aURL);</span>
<a href="#l30.107"></a><span id="l30.107">   }</span>
<a href="#l30.108"></a><span id="l30.108">   return rv;</span>
<a href="#l30.109"></a><span id="l30.109"> }</span>
<a href="#l30.110"></a><span id="l30.110"> </span>
<a href="#l30.111"></a><span id="l30.111"> NS_IMETHODIMP nsSmtpService::GetScheme(nsACString &amp;aScheme)</span>
<a href="#l30.112"></a><span id="l30.112"> {</span>
<a href="#l30.113"></a><span id="l30.113">     aScheme = &quot;mailto&quot;;</span>
<a href="#l30.114"></a><span id="l30.114" class="difflineminus">-    return NS_OK; </span>
<a href="#l30.115"></a><span id="l30.115" class="difflineplus">+    return NS_OK;</span>
<a href="#l30.116"></a><span id="l30.116"> }</span>
<a href="#l30.117"></a><span id="l30.117"> </span>
<a href="#l30.118"></a><span id="l30.118"> NS_IMETHODIMP nsSmtpService::GetDefaultPort(int32_t *aDefaultPort)</span>
<a href="#l30.119"></a><span id="l30.119"> {</span>
<a href="#l30.120"></a><span id="l30.120">     nsresult rv = NS_OK;</span>
<a href="#l30.121"></a><span id="l30.121">     if (aDefaultPort)</span>
<a href="#l30.122"></a><span id="l30.122">         *aDefaultPort = nsISmtpUrl::DEFAULT_SMTP_PORT;</span>
<a href="#l30.123"></a><span id="l30.123">     else</span>
<a href="#l30.124"></a><span id="l30.124">         rv = NS_ERROR_NULL_POINTER;</span>
<a href="#l30.125"></a><span id="l30.125">     return rv;</span>
<a href="#l30.126"></a><span id="l30.126"> }</span>
<a href="#l30.127"></a><span id="l30.127"> </span>
<a href="#l30.128"></a><span id="l30.128" class="difflineminus">-NS_IMETHODIMP </span>
<a href="#l30.129"></a><span id="l30.129" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l30.130"></a><span id="l30.130"> nsSmtpService::AllowPort(int32_t port, const char *scheme, bool *_retval)</span>
<a href="#l30.131"></a><span id="l30.131"> {</span>
<a href="#l30.132"></a><span id="l30.132">     // allow smtp to run on any port</span>
<a href="#l30.133"></a><span id="l30.133">     *_retval = true;</span>
<a href="#l30.134"></a><span id="l30.134">     return NS_OK;</span>
<a href="#l30.135"></a><span id="l30.135"> }</span>
<a href="#l30.136"></a><span id="l30.136"> </span>
<a href="#l30.137"></a><span id="l30.137"> NS_IMETHODIMP nsSmtpService::GetProtocolFlags(uint32_t *result)</span>
<a href="#l30.138"></a><span id="l30.138" class="difflineat">@@ -380,17 +380,17 @@ nsSmtpService::GetServers(nsISimpleEnume</span>
<a href="#l30.139"></a><span id="l30.139">   return NS_NewArrayEnumerator(aResult, mSmtpServers);</span>
<a href="#l30.140"></a><span id="l30.140"> }</span>
<a href="#l30.141"></a><span id="l30.141"> </span>
<a href="#l30.142"></a><span id="l30.142"> nsresult</span>
<a href="#l30.143"></a><span id="l30.143"> nsSmtpService::loadSmtpServers()</span>
<a href="#l30.144"></a><span id="l30.144"> {</span>
<a href="#l30.145"></a><span id="l30.145">   if (mSmtpServersLoaded)</span>
<a href="#l30.146"></a><span id="l30.146">     return NS_OK;</span>
<a href="#l30.147"></a><span id="l30.147" class="difflineminus">-    </span>
<a href="#l30.148"></a><span id="l30.148" class="difflineplus">+</span>
<a href="#l30.149"></a><span id="l30.149">   nsresult rv;</span>
<a href="#l30.150"></a><span id="l30.150">   nsCOMPtr&lt;nsIPrefService&gt; prefService(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l30.151"></a><span id="l30.151">   if (NS_FAILED(rv))</span>
<a href="#l30.152"></a><span id="l30.152">     return rv;</span>
<a href="#l30.153"></a><span id="l30.153">   nsCOMPtr&lt;nsIPrefBranch&gt; prefRootBranch;</span>
<a href="#l30.154"></a><span id="l30.154">   prefService-&gt;GetBranch(nullptr, getter_AddRefs(prefRootBranch));</span>
<a href="#l30.155"></a><span id="l30.155">   if (NS_FAILED(rv))</span>
<a href="#l30.156"></a><span id="l30.156">     return rv;</span>
<a href="#l30.157"></a><span id="l30.157" class="difflineat">@@ -461,50 +461,50 @@ nsSmtpService::loadSmtpServers()</span>
<a href="#l30.158"></a><span id="l30.158"> </span>
<a href="#l30.159"></a><span id="l30.159"> // save the list of keys</span>
<a href="#l30.160"></a><span id="l30.160"> nsresult</span>
<a href="#l30.161"></a><span id="l30.161"> nsSmtpService::saveKeyList()</span>
<a href="#l30.162"></a><span id="l30.162"> {</span>
<a href="#l30.163"></a><span id="l30.163">     nsresult rv;</span>
<a href="#l30.164"></a><span id="l30.164">     nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l30.165"></a><span id="l30.165">     if (NS_FAILED(rv)) return rv;</span>
<a href="#l30.166"></a><span id="l30.166" class="difflineminus">-    </span>
<a href="#l30.167"></a><span id="l30.167" class="difflineplus">+</span>
<a href="#l30.168"></a><span id="l30.168">     return prefBranch-&gt;SetCharPref(PREF_MAIL_SMTPSERVERS, mServerKeyList.get());</span>
<a href="#l30.169"></a><span id="l30.169"> }</span>
<a href="#l30.170"></a><span id="l30.170"> </span>
<a href="#l30.171"></a><span id="l30.171"> nsresult</span>
<a href="#l30.172"></a><span id="l30.172"> nsSmtpService::createKeyedServer(const char *key, nsISmtpServer** aResult)</span>
<a href="#l30.173"></a><span id="l30.173"> {</span>
<a href="#l30.174"></a><span id="l30.174">     if (!key) return NS_ERROR_NULL_POINTER;</span>
<a href="#l30.175"></a><span id="l30.175" class="difflineminus">-    </span>
<a href="#l30.176"></a><span id="l30.176" class="difflineplus">+</span>
<a href="#l30.177"></a><span id="l30.177">     nsresult rv;</span>
<a href="#l30.178"></a><span id="l30.178">     nsCOMPtr&lt;nsISmtpServer&gt; server = do_CreateInstance(NS_SMTPSERVER_CONTRACTID, &amp;rv);</span>
<a href="#l30.179"></a><span id="l30.179">     if (NS_FAILED(rv)) return rv;</span>
<a href="#l30.180"></a><span id="l30.180" class="difflineminus">-    </span>
<a href="#l30.181"></a><span id="l30.181" class="difflineplus">+</span>
<a href="#l30.182"></a><span id="l30.182">     server-&gt;SetKey(key);</span>
<a href="#l30.183"></a><span id="l30.183">     mSmtpServers.AppendObject(server);</span>
<a href="#l30.184"></a><span id="l30.184"> </span>
<a href="#l30.185"></a><span id="l30.185">     if (mServerKeyList.IsEmpty())</span>
<a href="#l30.186"></a><span id="l30.186">         mServerKeyList = key;</span>
<a href="#l30.187"></a><span id="l30.187">     else {</span>
<a href="#l30.188"></a><span id="l30.188">         mServerKeyList.Append(',');</span>
<a href="#l30.189"></a><span id="l30.189">         mServerKeyList += key;</span>
<a href="#l30.190"></a><span id="l30.190">     }</span>
<a href="#l30.191"></a><span id="l30.191"> </span>
<a href="#l30.192"></a><span id="l30.192" class="difflineminus">-    if (aResult) </span>
<a href="#l30.193"></a><span id="l30.193" class="difflineplus">+    if (aResult)</span>
<a href="#l30.194"></a><span id="l30.194">        server.forget(aResult);</span>
<a href="#l30.195"></a><span id="l30.195" class="difflineminus">-    </span>
<a href="#l30.196"></a><span id="l30.196" class="difflineplus">+</span>
<a href="#l30.197"></a><span id="l30.197">     return NS_OK;</span>
<a href="#l30.198"></a><span id="l30.198"> }</span>
<a href="#l30.199"></a><span id="l30.199"> </span>
<a href="#l30.200"></a><span id="l30.200"> NS_IMETHODIMP</span>
<a href="#l30.201"></a><span id="l30.201"> nsSmtpService::GetSessionDefaultServer(nsISmtpServer **aServer)</span>
<a href="#l30.202"></a><span id="l30.202"> {</span>
<a href="#l30.203"></a><span id="l30.203">     NS_ENSURE_ARG_POINTER(aServer);</span>
<a href="#l30.204"></a><span id="l30.204" class="difflineminus">-    </span>
<a href="#l30.205"></a><span id="l30.205" class="difflineplus">+</span>
<a href="#l30.206"></a><span id="l30.206">     if (!mSessionDefaultServer)</span>
<a href="#l30.207"></a><span id="l30.207">         return GetDefaultServer(aServer);</span>
<a href="#l30.208"></a><span id="l30.208"> </span>
<a href="#l30.209"></a><span id="l30.209">     NS_ADDREF(*aServer = mSessionDefaultServer);</span>
<a href="#l30.210"></a><span id="l30.210">     return NS_OK;</span>
<a href="#l30.211"></a><span id="l30.211"> }</span>
<a href="#l30.212"></a><span id="l30.212"> </span>
<a href="#l30.213"></a><span id="l30.213"> NS_IMETHODIMP</span>
<a href="#l30.214"></a><span id="l30.214" class="difflineat">@@ -515,17 +515,17 @@ nsSmtpService::SetSessionDefaultServer(n</span>
<a href="#l30.215"></a><span id="l30.215"> }</span>
<a href="#l30.216"></a><span id="l30.216"> </span>
<a href="#l30.217"></a><span id="l30.217"> NS_IMETHODIMP</span>
<a href="#l30.218"></a><span id="l30.218"> nsSmtpService::GetDefaultServer(nsISmtpServer **aServer)</span>
<a href="#l30.219"></a><span id="l30.219"> {</span>
<a href="#l30.220"></a><span id="l30.220">   NS_ENSURE_ARG_POINTER(aServer);</span>
<a href="#l30.221"></a><span id="l30.221"> </span>
<a href="#l30.222"></a><span id="l30.222">   loadSmtpServers();</span>
<a href="#l30.223"></a><span id="l30.223" class="difflineminus">-  </span>
<a href="#l30.224"></a><span id="l30.224" class="difflineplus">+</span>
<a href="#l30.225"></a><span id="l30.225">   *aServer = nullptr;</span>
<a href="#l30.226"></a><span id="l30.226">   // always returns NS_OK, just leaving *aServer at nullptr</span>
<a href="#l30.227"></a><span id="l30.227">   if (!mDefaultSmtpServer) {</span>
<a href="#l30.228"></a><span id="l30.228">       nsresult rv;</span>
<a href="#l30.229"></a><span id="l30.229">       nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l30.230"></a><span id="l30.230">       if (NS_FAILED(rv)) return rv;</span>
<a href="#l30.231"></a><span id="l30.231"> </span>
<a href="#l30.232"></a><span id="l30.232">       // try to get it from the prefs</span>
<a href="#l30.233"></a><span id="l30.233" class="difflineat">@@ -546,67 +546,67 @@ nsSmtpService::GetDefaultServer(nsISmtpS</span>
<a href="#l30.234"></a><span id="l30.234">         // nothing in the array, we had better create a new server</span>
<a href="#l30.235"></a><span id="l30.235">         // (which will add it to the array &amp; prefs anyway)</span>
<a href="#l30.236"></a><span id="l30.236">         if (mSmtpServers.Count() == 0)</span>
<a href="#l30.237"></a><span id="l30.237">           // if there are no smtp servers then don't create one for the default.</span>
<a href="#l30.238"></a><span id="l30.238">           return NS_OK;</span>
<a href="#l30.239"></a><span id="l30.239"> </span>
<a href="#l30.240"></a><span id="l30.240">         mDefaultSmtpServer = mSmtpServers[0];</span>
<a href="#l30.241"></a><span id="l30.241">         NS_ENSURE_TRUE(mDefaultSmtpServer, NS_ERROR_NULL_POINTER);</span>
<a href="#l30.242"></a><span id="l30.242" class="difflineminus">-          </span>
<a href="#l30.243"></a><span id="l30.243" class="difflineplus">+</span>
<a href="#l30.244"></a><span id="l30.244">         // now we have a default server, set the prefs correctly</span>
<a href="#l30.245"></a><span id="l30.245">         nsCString serverKey;</span>
<a href="#l30.246"></a><span id="l30.246">         mDefaultSmtpServer-&gt;GetKey(getter_Copies(serverKey));</span>
<a href="#l30.247"></a><span id="l30.247">         if (NS_SUCCEEDED(rv))</span>
<a href="#l30.248"></a><span id="l30.248">           prefBranch-&gt;SetCharPref(PREF_MAIL_SMTP_DEFAULTSERVER, serverKey.get());</span>
<a href="#l30.249"></a><span id="l30.249">       }</span>
<a href="#l30.250"></a><span id="l30.250">   }</span>
<a href="#l30.251"></a><span id="l30.251"> </span>
<a href="#l30.252"></a><span id="l30.252">   // at this point:</span>
<a href="#l30.253"></a><span id="l30.253">   // * mDefaultSmtpServer has a valid server</span>
<a href="#l30.254"></a><span id="l30.254">   // * the key has been set in the prefs</span>
<a href="#l30.255"></a><span id="l30.255" class="difflineminus">-    </span>
<a href="#l30.256"></a><span id="l30.256" class="difflineplus">+</span>
<a href="#l30.257"></a><span id="l30.257">   NS_IF_ADDREF(*aServer = mDefaultSmtpServer);</span>
<a href="#l30.258"></a><span id="l30.258"> </span>
<a href="#l30.259"></a><span id="l30.259">   return NS_OK;</span>
<a href="#l30.260"></a><span id="l30.260"> }</span>
<a href="#l30.261"></a><span id="l30.261"> </span>
<a href="#l30.262"></a><span id="l30.262"> NS_IMETHODIMP</span>
<a href="#l30.263"></a><span id="l30.263"> nsSmtpService::SetDefaultServer(nsISmtpServer *aServer)</span>
<a href="#l30.264"></a><span id="l30.264"> {</span>
<a href="#l30.265"></a><span id="l30.265">     NS_ENSURE_ARG_POINTER(aServer);</span>
<a href="#l30.266"></a><span id="l30.266"> </span>
<a href="#l30.267"></a><span id="l30.267">     mDefaultSmtpServer = aServer;</span>
<a href="#l30.268"></a><span id="l30.268"> </span>
<a href="#l30.269"></a><span id="l30.269">     nsCString serverKey;</span>
<a href="#l30.270"></a><span id="l30.270">     nsresult rv = aServer-&gt;GetKey(getter_Copies(serverKey));</span>
<a href="#l30.271"></a><span id="l30.271">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l30.272"></a><span id="l30.272" class="difflineminus">-    </span>
<a href="#l30.273"></a><span id="l30.273" class="difflineplus">+</span>
<a href="#l30.274"></a><span id="l30.274">     nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l30.275"></a><span id="l30.275">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l30.276"></a><span id="l30.276">     prefBranch-&gt;SetCharPref(PREF_MAIL_SMTP_DEFAULTSERVER, serverKey.get());</span>
<a href="#l30.277"></a><span id="l30.277">     return NS_OK;</span>
<a href="#l30.278"></a><span id="l30.278"> }</span>
<a href="#l30.279"></a><span id="l30.279"> </span>
<a href="#l30.280"></a><span id="l30.280"> bool</span>
<a href="#l30.281"></a><span id="l30.281"> nsSmtpService::findServerByKey(nsISmtpServer *aServer, void *aData)</span>
<a href="#l30.282"></a><span id="l30.282"> {</span>
<a href="#l30.283"></a><span id="l30.283">   findServerByKeyEntry *entry = (findServerByKeyEntry*) aData;</span>
<a href="#l30.284"></a><span id="l30.284"> </span>
<a href="#l30.285"></a><span id="l30.285">   nsCString key;</span>
<a href="#l30.286"></a><span id="l30.286">   nsresult rv = aServer-&gt;GetKey(getter_Copies(key));</span>
<a href="#l30.287"></a><span id="l30.287">   if (NS_FAILED(rv))</span>
<a href="#l30.288"></a><span id="l30.288">     return true;</span>
<a href="#l30.289"></a><span id="l30.289"> </span>
<a href="#l30.290"></a><span id="l30.290" class="difflineminus">-  if (key.Equals(entry-&gt;key)) </span>
<a href="#l30.291"></a><span id="l30.291" class="difflineplus">+  if (key.Equals(entry-&gt;key))</span>
<a href="#l30.292"></a><span id="l30.292">   {</span>
<a href="#l30.293"></a><span id="l30.293">     entry-&gt;server = aServer;</span>
<a href="#l30.294"></a><span id="l30.294">     return false;</span>
<a href="#l30.295"></a><span id="l30.295">   }</span>
<a href="#l30.296"></a><span id="l30.296" class="difflineminus">-    </span>
<a href="#l30.297"></a><span id="l30.297" class="difflineplus">+</span>
<a href="#l30.298"></a><span id="l30.298">   return true;</span>
<a href="#l30.299"></a><span id="l30.299"> }</span>
<a href="#l30.300"></a><span id="l30.300"> </span>
<a href="#l30.301"></a><span id="l30.301"> NS_IMETHODIMP</span>
<a href="#l30.302"></a><span id="l30.302"> nsSmtpService::CreateServer(nsISmtpServer **aResult)</span>
<a href="#l30.303"></a><span id="l30.303"> {</span>
<a href="#l30.304"></a><span id="l30.304">     if (!aResult) return NS_ERROR_NULL_POINTER;</span>
<a href="#l30.305"></a><span id="l30.305"> </span>
<a href="#l30.306"></a><span id="l30.306" class="difflineat">@@ -667,24 +667,24 @@ nsSmtpService::DeleteServer(nsISmtpServe</span>
<a href="#l30.307"></a><span id="l30.307">     if (!aServer) return NS_OK;</span>
<a href="#l30.308"></a><span id="l30.308"> </span>
<a href="#l30.309"></a><span id="l30.309">     int32_t idx = mSmtpServers.IndexOf(aServer);</span>
<a href="#l30.310"></a><span id="l30.310">     if (idx == -1)</span>
<a href="#l30.311"></a><span id="l30.311">       return NS_OK;</span>
<a href="#l30.312"></a><span id="l30.312"> </span>
<a href="#l30.313"></a><span id="l30.313">     nsCString serverKey;</span>
<a href="#l30.314"></a><span id="l30.314">     aServer-&gt;GetKey(getter_Copies(serverKey));</span>
<a href="#l30.315"></a><span id="l30.315" class="difflineminus">-    </span>
<a href="#l30.316"></a><span id="l30.316" class="difflineplus">+</span>
<a href="#l30.317"></a><span id="l30.317">     mSmtpServers.RemoveObjectAt(idx);</span>
<a href="#l30.318"></a><span id="l30.318"> </span>
<a href="#l30.319"></a><span id="l30.319">     if (mDefaultSmtpServer.get() == aServer)</span>
<a href="#l30.320"></a><span id="l30.320">         mDefaultSmtpServer = nullptr;</span>
<a href="#l30.321"></a><span id="l30.321">     if (mSessionDefaultServer.get() == aServer)</span>
<a href="#l30.322"></a><span id="l30.322">         mSessionDefaultServer = nullptr;</span>
<a href="#l30.323"></a><span id="l30.323" class="difflineminus">-    </span>
<a href="#l30.324"></a><span id="l30.324" class="difflineplus">+</span>
<a href="#l30.325"></a><span id="l30.325">     nsAutoCString newServerList;</span>
<a href="#l30.326"></a><span id="l30.326">     nsCString tmpStr = mServerKeyList;</span>
<a href="#l30.327"></a><span id="l30.327">     char *newStr = tmpStr.BeginWriting();</span>
<a href="#l30.328"></a><span id="l30.328">     char *token = NS_strtok(&quot;,&quot;, &amp;newStr);</span>
<a href="#l30.329"></a><span id="l30.329">     while (token) {</span>
<a href="#l30.330"></a><span id="l30.330">       // only re-add the string if it's not the key</span>
<a href="#l30.331"></a><span id="l30.331">       if (strcmp(token, serverKey.get()) != 0) {</span>
<a href="#l30.332"></a><span id="l30.332">           if (newServerList.IsEmpty())</span>
<a href="#l30.333"></a><span id="l30.333" class="difflineat">@@ -717,17 +717,17 @@ nsSmtpService::findServerByHostname(nsIS</span>
<a href="#l30.334"></a><span id="l30.334"> </span>
<a href="#l30.335"></a><span id="l30.335">   nsCString username;</span>
<a href="#l30.336"></a><span id="l30.336">   rv = aServer-&gt;GetUsername(username);</span>
<a href="#l30.337"></a><span id="l30.337">   if (NS_FAILED(rv))</span>
<a href="#l30.338"></a><span id="l30.338">     return true;</span>
<a href="#l30.339"></a><span id="l30.339"> </span>
<a href="#l30.340"></a><span id="l30.340">   bool checkHostname = !entry-&gt;hostname.IsEmpty();</span>
<a href="#l30.341"></a><span id="l30.341">   bool checkUsername = !entry-&gt;username.IsEmpty();</span>
<a href="#l30.342"></a><span id="l30.342" class="difflineminus">-    </span>
<a href="#l30.343"></a><span id="l30.343" class="difflineplus">+</span>
<a href="#l30.344"></a><span id="l30.344">   if ((!checkHostname ||</span>
<a href="#l30.345"></a><span id="l30.345">        (entry-&gt;hostname.Equals(hostname, nsCaseInsensitiveCStringComparator()))) &amp;&amp;</span>
<a href="#l30.346"></a><span id="l30.346">        (!checkUsername ||</span>
<a href="#l30.347"></a><span id="l30.347">         entry-&gt;username.Equals(username, nsCaseInsensitiveCStringComparator())))</span>
<a href="#l30.348"></a><span id="l30.348">   {</span>
<a href="#l30.349"></a><span id="l30.349">     entry-&gt;server = aServer;</span>
<a href="#l30.350"></a><span id="l30.350">     return false;        // stop when found</span>
<a href="#l30.351"></a><span id="l30.351">   }</span>
<a href="#l30.352"></a><span id="l30.352" class="difflineat">@@ -746,29 +746,29 @@ nsSmtpService::FindServer(const char *aU</span>
<a href="#l30.353"></a><span id="l30.353">     entry.username = aUsername;</span>
<a href="#l30.354"></a><span id="l30.354"> </span>
<a href="#l30.355"></a><span id="l30.355">     for (nsISmtpServer* s : mSmtpServers)</span>
<a href="#l30.356"></a><span id="l30.356">       findServerByHostname(s, (void *)&amp;entry);</span>
<a href="#l30.357"></a><span id="l30.357"> </span>
<a href="#l30.358"></a><span id="l30.358">     // entry.server may be null, but that's ok.</span>
<a href="#l30.359"></a><span id="l30.359">     // just return null if no server is found</span>
<a href="#l30.360"></a><span id="l30.360">     NS_IF_ADDREF(*aResult = entry.server);</span>
<a href="#l30.361"></a><span id="l30.361" class="difflineminus">-    </span>
<a href="#l30.362"></a><span id="l30.362" class="difflineplus">+</span>
<a href="#l30.363"></a><span id="l30.363">     return NS_OK;</span>
<a href="#l30.364"></a><span id="l30.364"> }</span>
<a href="#l30.365"></a><span id="l30.365"> </span>
<a href="#l30.366"></a><span id="l30.366"> NS_IMETHODIMP</span>
<a href="#l30.367"></a><span id="l30.367"> nsSmtpService::GetServerByIdentity(nsIMsgIdentity *aSenderIdentity,</span>
<a href="#l30.368"></a><span id="l30.368">                                    nsISmtpServer **aSmtpServer)</span>
<a href="#l30.369"></a><span id="l30.369"> {</span>
<a href="#l30.370"></a><span id="l30.370">   NS_ENSURE_ARG_POINTER(aSmtpServer);</span>
<a href="#l30.371"></a><span id="l30.371">   nsresult rv = NS_ERROR_FAILURE;</span>
<a href="#l30.372"></a><span id="l30.372"> </span>
<a href="#l30.373"></a><span id="l30.373">   // First try the identity's preferred server</span>
<a href="#l30.374"></a><span id="l30.374" class="difflineminus">-  if (aSenderIdentity) </span>
<a href="#l30.375"></a><span id="l30.375" class="difflineplus">+  if (aSenderIdentity)</span>
<a href="#l30.376"></a><span id="l30.376">   {</span>
<a href="#l30.377"></a><span id="l30.377">       nsCString smtpServerKey;</span>
<a href="#l30.378"></a><span id="l30.378">       rv = aSenderIdentity-&gt;GetSmtpServerKey(smtpServerKey);</span>
<a href="#l30.379"></a><span id="l30.379">       if (NS_SUCCEEDED(rv) &amp;&amp; !(smtpServerKey.IsEmpty()))</span>
<a href="#l30.380"></a><span id="l30.380">           rv = GetServerByKey(smtpServerKey.get(), aSmtpServer);</span>
<a href="#l30.381"></a><span id="l30.381">   }</span>
<a href="#l30.382"></a><span id="l30.382"> </span>
<a href="#l30.383"></a><span id="l30.383">   // Fallback to the default</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l31.1"></a><span id="l31.1" class="difflineminus">--- a/mailnews/compose/src/nsSmtpService.h</span>
<a href="#l31.2"></a><span id="l31.2" class="difflineplus">+++ b/mailnews/compose/src/nsSmtpService.h</span>
<a href="#l31.3"></a><span id="l31.3" class="difflineat">@@ -24,38 +24,38 @@ class nsSmtpService : public nsISmtpServ</span>
<a href="#l31.4"></a><span id="l31.4"> {</span>
<a href="#l31.5"></a><span id="l31.5"> public:</span>
<a href="#l31.6"></a><span id="l31.6"> </span>
<a href="#l31.7"></a><span id="l31.7"> 	nsSmtpService();</span>
<a href="#l31.8"></a><span id="l31.8"> 	</span>
<a href="#l31.9"></a><span id="l31.9"> 	NS_DECL_ISUPPORTS</span>
<a href="#l31.10"></a><span id="l31.10"> </span>
<a href="#l31.11"></a><span id="l31.11"> 	////////////////////////////////////////////////////////////////////////</span>
<a href="#l31.12"></a><span id="l31.12" class="difflineminus">-	// we suppport the nsISmtpService interface </span>
<a href="#l31.13"></a><span id="l31.13" class="difflineminus">-	////////////////////////////////////////////////////////////////////////    </span>
<a href="#l31.14"></a><span id="l31.14" class="difflineplus">+	// we suppport the nsISmtpService interface</span>
<a href="#l31.15"></a><span id="l31.15" class="difflineplus">+	////////////////////////////////////////////////////////////////////////</span>
<a href="#l31.16"></a><span id="l31.16"> 	NS_DECL_NSISMTPSERVICE</span>
<a href="#l31.17"></a><span id="l31.17"> </span>
<a href="#l31.18"></a><span id="l31.18"> 	//////////////////////////////////////////////////////////////////////////</span>
<a href="#l31.19"></a><span id="l31.19" class="difflineminus">-	// we suppport the nsIProtocolHandler interface </span>
<a href="#l31.20"></a><span id="l31.20" class="difflineplus">+	// we suppport the nsIProtocolHandler interface</span>
<a href="#l31.21"></a><span id="l31.21"> 	//////////////////////////////////////////////////////////////////////////</span>
<a href="#l31.22"></a><span id="l31.22">   NS_DECL_NSIPROTOCOLHANDLER</span>
<a href="#l31.23"></a><span id="l31.23"> </span>
<a href="#l31.24"></a><span id="l31.24"> protected:</span>
<a href="#l31.25"></a><span id="l31.25">     nsresult loadSmtpServers();</span>
<a href="#l31.26"></a><span id="l31.26"> </span>
<a href="#l31.27"></a><span id="l31.27" class="difflineminus">-    </span>
<a href="#l31.28"></a><span id="l31.28" class="difflineplus">+</span>
<a href="#l31.29"></a><span id="l31.29"> private:</span>
<a href="#l31.30"></a><span id="l31.30"> 	virtual ~nsSmtpService();</span>
<a href="#l31.31"></a><span id="l31.31">     static bool findServerByKey(nsISmtpServer *aServer, void *aData);</span>
<a href="#l31.32"></a><span id="l31.32">     static bool findServerByHostname(nsISmtpServer *aServer, void *aData);</span>
<a href="#l31.33"></a><span id="l31.33" class="difflineminus">-    </span>
<a href="#l31.34"></a><span id="l31.34" class="difflineplus">+</span>
<a href="#l31.35"></a><span id="l31.35">     nsresult createKeyedServer(const char* key,</span>
<a href="#l31.36"></a><span id="l31.36">                                nsISmtpServer **aResult = nullptr);</span>
<a href="#l31.37"></a><span id="l31.37">     nsresult saveKeyList();</span>
<a href="#l31.38"></a><span id="l31.38" class="difflineminus">-    </span>
<a href="#l31.39"></a><span id="l31.39" class="difflineplus">+</span>
<a href="#l31.40"></a><span id="l31.40">     nsCOMArray&lt;nsISmtpServer&gt; mSmtpServers;</span>
<a href="#l31.41"></a><span id="l31.41">     nsCOMPtr&lt;nsISmtpServer&gt; mDefaultSmtpServer;</span>
<a href="#l31.42"></a><span id="l31.42">     nsCOMPtr&lt;nsISmtpServer&gt; mSessionDefaultServer;</span>
<a href="#l31.43"></a><span id="l31.43"> </span>
<a href="#l31.44"></a><span id="l31.44">     nsCString mServerKeyList;</span>
<a href="#l31.45"></a><span id="l31.45"> </span>
<a href="#l31.46"></a><span id="l31.46">     bool mSmtpServersLoaded;</span>
<a href="#l31.47"></a><span id="l31.47"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l32.1"></a><span id="l32.1" class="difflineminus">--- a/mailnews/compose/src/nsSmtpUrl.h</span>
<a href="#l32.2"></a><span id="l32.2" class="difflineplus">+++ b/mailnews/compose/src/nsSmtpUrl.h</span>
<a href="#l32.3"></a><span id="l32.3" class="difflineat">@@ -35,17 +35,17 @@ protected:</span>
<a href="#l32.4"></a><span id="l32.4">   virtual ~nsMailtoUrl();</span>
<a href="#l32.5"></a><span id="l32.5">   nsresult ParseUrl();</span>
<a href="#l32.6"></a><span id="l32.6">   nsresult CleanupMailtoState();</span>
<a href="#l32.7"></a><span id="l32.7">   nsresult ParseMailtoUrl(char * searchPart);</span>
<a href="#l32.8"></a><span id="l32.8">   nsresult CloneInternal(RefHandlingEnum aRefHandlingMode,</span>
<a href="#l32.9"></a><span id="l32.9">                          const nsACString&amp; newRef, nsIURI** _retval);</span>
<a href="#l32.10"></a><span id="l32.10"> </span>
<a href="#l32.11"></a><span id="l32.11">   nsCOMPtr&lt;nsIURI&gt; m_baseURL;</span>
<a href="#l32.12"></a><span id="l32.12" class="difflineminus">-    </span>
<a href="#l32.13"></a><span id="l32.13" class="difflineplus">+</span>
<a href="#l32.14"></a><span id="l32.14">   // data retrieved from parsing the url: (Note the url could be a post from file or it could be in the url)</span>
<a href="#l32.15"></a><span id="l32.15">   nsCString m_toPart;</span>
<a href="#l32.16"></a><span id="l32.16">   nsCString m_ccPart;</span>
<a href="#l32.17"></a><span id="l32.17">   nsCString m_subjectPart;</span>
<a href="#l32.18"></a><span id="l32.18">   nsCString m_newsgroupPart;</span>
<a href="#l32.19"></a><span id="l32.19">   nsCString m_newsHostPart;</span>
<a href="#l32.20"></a><span id="l32.20">   nsCString m_referencePart;</span>
<a href="#l32.21"></a><span id="l32.21">   nsCString m_bodyPart;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l33.1"></a><span id="l33.1" class="difflineminus">--- a/mailnews/compose/src/nsURLFetcher.cpp</span>
<a href="#l33.2"></a><span id="l33.2" class="difflineplus">+++ b/mailnews/compose/src/nsURLFetcher.cpp</span>
<a href="#l33.3"></a><span id="l33.3" class="difflineat">@@ -34,17 +34,17 @@ NS_IMPL_ISUPPORTS(nsURLFetcher,</span>
<a href="#l33.4"></a><span id="l33.4">                    nsIStreamListener,</span>
<a href="#l33.5"></a><span id="l33.5">                    nsIRequestObserver,</span>
<a href="#l33.6"></a><span id="l33.6">                    nsIURIContentListener,</span>
<a href="#l33.7"></a><span id="l33.7">                    nsIInterfaceRequestor,</span>
<a href="#l33.8"></a><span id="l33.8">                    nsIWebProgressListener,</span>
<a href="#l33.9"></a><span id="l33.9">                    nsISupportsWeakReference)</span>
<a href="#l33.10"></a><span id="l33.10"> </span>
<a href="#l33.11"></a><span id="l33.11"> </span>
<a href="#l33.12"></a><span id="l33.12" class="difflineminus">-/* </span>
<a href="#l33.13"></a><span id="l33.13" class="difflineplus">+/*</span>
<a href="#l33.14"></a><span id="l33.14">  * Inherited methods for nsMimeConverter</span>
<a href="#l33.15"></a><span id="l33.15">  */</span>
<a href="#l33.16"></a><span id="l33.16"> nsURLFetcher::nsURLFetcher()</span>
<a href="#l33.17"></a><span id="l33.17"> {</span>
<a href="#l33.18"></a><span id="l33.18">   // Init member variables...</span>
<a href="#l33.19"></a><span id="l33.19">   mTotalWritten = 0;</span>
<a href="#l33.20"></a><span id="l33.20">   mBuffer = nullptr;</span>
<a href="#l33.21"></a><span id="l33.21">   mBufferSize = 0;</span>
<a href="#l33.22"></a><span id="l33.22" class="difflineat">@@ -54,67 +54,67 @@ nsURLFetcher::nsURLFetcher()</span>
<a href="#l33.23"></a><span id="l33.23">   mIsFile=false;</span>
<a href="#l33.24"></a><span id="l33.24">   nsURLFetcherStreamConsumer *consumer = new nsURLFetcherStreamConsumer(this);</span>
<a href="#l33.25"></a><span id="l33.25">   mConverter = do_QueryInterface(consumer);</span>
<a href="#l33.26"></a><span id="l33.26"> }</span>
<a href="#l33.27"></a><span id="l33.27"> </span>
<a href="#l33.28"></a><span id="l33.28"> nsURLFetcher::~nsURLFetcher()</span>
<a href="#l33.29"></a><span id="l33.29"> {</span>
<a href="#l33.30"></a><span id="l33.30">   mStillRunning = false;</span>
<a href="#l33.31"></a><span id="l33.31" class="difflineminus">-  </span>
<a href="#l33.32"></a><span id="l33.32" class="difflineplus">+</span>
<a href="#l33.33"></a><span id="l33.33">   PR_FREEIF(mBuffer);</span>
<a href="#l33.34"></a><span id="l33.34">   // Remove the DocShell as a listener of the old WebProgress...</span>
<a href="#l33.35"></a><span id="l33.35" class="difflineminus">-  if (mLoadCookie) </span>
<a href="#l33.36"></a><span id="l33.36" class="difflineplus">+  if (mLoadCookie)</span>
<a href="#l33.37"></a><span id="l33.37">   {</span>
<a href="#l33.38"></a><span id="l33.38">     nsCOMPtr&lt;nsIWebProgress&gt; webProgress(do_QueryInterface(mLoadCookie));</span>
<a href="#l33.39"></a><span id="l33.39"> </span>
<a href="#l33.40"></a><span id="l33.40">     if (webProgress)</span>
<a href="#l33.41"></a><span id="l33.41">       webProgress-&gt;RemoveProgressListener(this);</span>
<a href="#l33.42"></a><span id="l33.42">   }</span>
<a href="#l33.43"></a><span id="l33.43"> }</span>
<a href="#l33.44"></a><span id="l33.44"> </span>
<a href="#l33.45"></a><span id="l33.45"> NS_IMETHODIMP nsURLFetcher::GetInterface(const nsIID &amp; aIID, void * *aInstancePtr)</span>
<a href="#l33.46"></a><span id="l33.46"> {</span>
<a href="#l33.47"></a><span id="l33.47">    NS_ENSURE_ARG_POINTER(aInstancePtr);</span>
<a href="#l33.48"></a><span id="l33.48">    return QueryInterface(aIID, aInstancePtr);</span>
<a href="#l33.49"></a><span id="l33.49"> }</span>
<a href="#l33.50"></a><span id="l33.50"> </span>
<a href="#l33.51"></a><span id="l33.51"> // nsIURIContentListener support</span>
<a href="#l33.52"></a><span id="l33.52" class="difflineminus">-NS_IMETHODIMP </span>
<a href="#l33.53"></a><span id="l33.53" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l33.54"></a><span id="l33.54"> nsURLFetcher::OnStartURIOpen(nsIURI* aURI, bool* aAbortOpen)</span>
<a href="#l33.55"></a><span id="l33.55"> {</span>
<a href="#l33.56"></a><span id="l33.56">    return NS_OK;</span>
<a href="#l33.57"></a><span id="l33.57"> }</span>
<a href="#l33.58"></a><span id="l33.58"> </span>
<a href="#l33.59"></a><span id="l33.59" class="difflineminus">-NS_IMETHODIMP </span>
<a href="#l33.60"></a><span id="l33.60" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l33.61"></a><span id="l33.61"> nsURLFetcher::IsPreferred(const char * aContentType,</span>
<a href="#l33.62"></a><span id="l33.62">                                 char ** aDesiredContentType,</span>
<a href="#l33.63"></a><span id="l33.63">                                 bool * aCanHandleContent)</span>
<a href="#l33.64"></a><span id="l33.64"> </span>
<a href="#l33.65"></a><span id="l33.65"> {</span>
<a href="#l33.66"></a><span id="l33.66">   return CanHandleContent(aContentType, true, aDesiredContentType,</span>
<a href="#l33.67"></a><span id="l33.67">                           aCanHandleContent);</span>
<a href="#l33.68"></a><span id="l33.68"> }</span>
<a href="#l33.69"></a><span id="l33.69"> </span>
<a href="#l33.70"></a><span id="l33.70" class="difflineminus">-NS_IMETHODIMP </span>
<a href="#l33.71"></a><span id="l33.71" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l33.72"></a><span id="l33.72"> nsURLFetcher::CanHandleContent(const char * aContentType,</span>
<a href="#l33.73"></a><span id="l33.73">                                 bool aIsContentPreferred,</span>
<a href="#l33.74"></a><span id="l33.74">                                 char ** aDesiredContentType,</span>
<a href="#l33.75"></a><span id="l33.75">                                 bool * aCanHandleContent)</span>
<a href="#l33.76"></a><span id="l33.76"> </span>
<a href="#l33.77"></a><span id="l33.77"> {</span>
<a href="#l33.78"></a><span id="l33.78">     if (!mIsFile &amp;&amp; PL_strcasecmp(aContentType, MESSAGE_RFC822) == 0)</span>
<a href="#l33.79"></a><span id="l33.79">       *aDesiredContentType = strdup(&quot;text/html&quot;);</span>
<a href="#l33.80"></a><span id="l33.80"> </span>
<a href="#l33.81"></a><span id="l33.81">     // since we explicilty loaded the url, we always want to handle it!</span>
<a href="#l33.82"></a><span id="l33.82">     *aCanHandleContent = true;</span>
<a href="#l33.83"></a><span id="l33.83">   return NS_OK;</span>
<a href="#l33.84"></a><span id="l33.84" class="difflineminus">-} </span>
<a href="#l33.85"></a><span id="l33.85" class="difflineplus">+}</span>
<a href="#l33.86"></a><span id="l33.86"> </span>
<a href="#l33.87"></a><span id="l33.87" class="difflineminus">-NS_IMETHODIMP </span>
<a href="#l33.88"></a><span id="l33.88" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l33.89"></a><span id="l33.89"> nsURLFetcher::DoContent(const nsACString&amp; aContentType,</span>
<a href="#l33.90"></a><span id="l33.90">                       bool aIsContentPreferred,</span>
<a href="#l33.91"></a><span id="l33.91">                       nsIRequest *request,</span>
<a href="#l33.92"></a><span id="l33.92">                       nsIStreamListener ** aContentHandler,</span>
<a href="#l33.93"></a><span id="l33.93">                       bool * aAbortProcess)</span>
<a href="#l33.94"></a><span id="l33.94"> {</span>
<a href="#l33.95"></a><span id="l33.95">   nsresult rv = NS_OK;</span>
<a href="#l33.96"></a><span id="l33.96"> </span>
<a href="#l33.97"></a><span id="l33.97" class="difflineat">@@ -133,84 +133,84 @@ nsURLFetcher::DoContent(const nsACString</span>
<a href="#l33.98"></a><span id="l33.98">     rv = InsertConverter(PromiseFlatCString(aContentType).get());</span>
<a href="#l33.99"></a><span id="l33.99">     if (NS_SUCCEEDED(rv))</span>
<a href="#l33.100"></a><span id="l33.100">       mConverterContentType = PromiseFlatCString(aContentType).get();</span>
<a href="#l33.101"></a><span id="l33.101">   }</span>
<a href="#l33.102"></a><span id="l33.102"> </span>
<a href="#l33.103"></a><span id="l33.103">   return rv;</span>
<a href="#l33.104"></a><span id="l33.104"> }</span>
<a href="#l33.105"></a><span id="l33.105"> </span>
<a href="#l33.106"></a><span id="l33.106" class="difflineminus">-NS_IMETHODIMP </span>
<a href="#l33.107"></a><span id="l33.107" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l33.108"></a><span id="l33.108"> nsURLFetcher::GetParentContentListener(nsIURIContentListener** aParent)</span>
<a href="#l33.109"></a><span id="l33.109"> {</span>
<a href="#l33.110"></a><span id="l33.110">   *aParent = nullptr;</span>
<a href="#l33.111"></a><span id="l33.111">   return NS_OK;</span>
<a href="#l33.112"></a><span id="l33.112"> }</span>
<a href="#l33.113"></a><span id="l33.113"> </span>
<a href="#l33.114"></a><span id="l33.114" class="difflineminus">-NS_IMETHODIMP </span>
<a href="#l33.115"></a><span id="l33.115" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l33.116"></a><span id="l33.116"> nsURLFetcher::SetParentContentListener(nsIURIContentListener* aParent)</span>
<a href="#l33.117"></a><span id="l33.117"> {</span>
<a href="#l33.118"></a><span id="l33.118">   return NS_OK;</span>
<a href="#l33.119"></a><span id="l33.119"> }</span>
<a href="#l33.120"></a><span id="l33.120"> </span>
<a href="#l33.121"></a><span id="l33.121" class="difflineminus">-NS_IMETHODIMP </span>
<a href="#l33.122"></a><span id="l33.122" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l33.123"></a><span id="l33.123"> nsURLFetcher::GetLoadCookie(nsISupports ** aLoadCookie)</span>
<a href="#l33.124"></a><span id="l33.124"> {</span>
<a href="#l33.125"></a><span id="l33.125">   NS_IF_ADDREF(*aLoadCookie = mLoadCookie);</span>
<a href="#l33.126"></a><span id="l33.126">   return NS_OK;</span>
<a href="#l33.127"></a><span id="l33.127"> }</span>
<a href="#l33.128"></a><span id="l33.128"> </span>
<a href="#l33.129"></a><span id="l33.129" class="difflineminus">-NS_IMETHODIMP </span>
<a href="#l33.130"></a><span id="l33.130" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l33.131"></a><span id="l33.131"> nsURLFetcher::SetLoadCookie(nsISupports * aLoadCookie)</span>
<a href="#l33.132"></a><span id="l33.132"> {</span>
<a href="#l33.133"></a><span id="l33.133">   // Remove the DocShell as a listener of the old WebProgress...</span>
<a href="#l33.134"></a><span id="l33.134" class="difflineminus">-  if (mLoadCookie) </span>
<a href="#l33.135"></a><span id="l33.135" class="difflineplus">+  if (mLoadCookie)</span>
<a href="#l33.136"></a><span id="l33.136">   {</span>
<a href="#l33.137"></a><span id="l33.137">     nsCOMPtr&lt;nsIWebProgress&gt; webProgress(do_QueryInterface(mLoadCookie));</span>
<a href="#l33.138"></a><span id="l33.138"> </span>
<a href="#l33.139"></a><span id="l33.139">     if (webProgress)</span>
<a href="#l33.140"></a><span id="l33.140">       webProgress-&gt;RemoveProgressListener(this);</span>
<a href="#l33.141"></a><span id="l33.141">   }</span>
<a href="#l33.142"></a><span id="l33.142"> </span>
<a href="#l33.143"></a><span id="l33.143">   mLoadCookie = aLoadCookie;</span>
<a href="#l33.144"></a><span id="l33.144"> </span>
<a href="#l33.145"></a><span id="l33.145">   // Add the DocShell as a listener to the new WebProgress...</span>
<a href="#l33.146"></a><span id="l33.146" class="difflineminus">-  if (mLoadCookie) </span>
<a href="#l33.147"></a><span id="l33.147" class="difflineplus">+  if (mLoadCookie)</span>
<a href="#l33.148"></a><span id="l33.148">   {</span>
<a href="#l33.149"></a><span id="l33.149">     nsCOMPtr&lt;nsIWebProgress&gt; webProgress(do_QueryInterface(mLoadCookie));</span>
<a href="#l33.150"></a><span id="l33.150"> </span>
<a href="#l33.151"></a><span id="l33.151" class="difflineminus">-    if (webProgress) </span>
<a href="#l33.152"></a><span id="l33.152" class="difflineplus">+    if (webProgress)</span>
<a href="#l33.153"></a><span id="l33.153">       webProgress-&gt;AddProgressListener(this, nsIWebProgress::NOTIFY_STATE_ALL);</span>
<a href="#l33.154"></a><span id="l33.154">   }</span>
<a href="#l33.155"></a><span id="l33.155">   return NS_OK;</span>
<a href="#l33.156"></a><span id="l33.156"> </span>
<a href="#l33.157"></a><span id="l33.157"> }</span>
<a href="#l33.158"></a><span id="l33.158"> </span>
<a href="#l33.159"></a><span id="l33.159"> nsresult</span>
<a href="#l33.160"></a><span id="l33.160"> nsURLFetcher::StillRunning(bool *running)</span>
<a href="#l33.161"></a><span id="l33.161"> {</span>
<a href="#l33.162"></a><span id="l33.162">   *running = mStillRunning;</span>
<a href="#l33.163"></a><span id="l33.163">   return NS_OK;</span>
<a href="#l33.164"></a><span id="l33.164"> }</span>
<a href="#l33.165"></a><span id="l33.165"> </span>
<a href="#l33.166"></a><span id="l33.166"> </span>
<a href="#l33.167"></a><span id="l33.167"> // Methods for nsIStreamListener...</span>
<a href="#l33.168"></a><span id="l33.168"> nsresult</span>
<a href="#l33.169"></a><span id="l33.169" class="difflineminus">-nsURLFetcher::OnDataAvailable(nsIRequest *request, nsISupports * ctxt, nsIInputStream *aIStream, </span>
<a href="#l33.170"></a><span id="l33.170" class="difflineplus">+nsURLFetcher::OnDataAvailable(nsIRequest *request, nsISupports * ctxt, nsIInputStream *aIStream,</span>
<a href="#l33.171"></a><span id="l33.171">                               uint64_t sourceOffset, uint32_t aLength)</span>
<a href="#l33.172"></a><span id="l33.172"> {</span>
<a href="#l33.173"></a><span id="l33.173">   /* let our converter or consumer process the data */</span>
<a href="#l33.174"></a><span id="l33.174">   if (!mConverter)</span>
<a href="#l33.175"></a><span id="l33.175">     return NS_ERROR_FAILURE;</span>
<a href="#l33.176"></a><span id="l33.176"> </span>
<a href="#l33.177"></a><span id="l33.177">   return mConverter-&gt;OnDataAvailable(request, ctxt, aIStream, sourceOffset, aLength);</span>
<a href="#l33.178"></a><span id="l33.178"> }</span>
<a href="#l33.179"></a><span id="l33.179"> </span>
<a href="#l33.180"></a><span id="l33.180"> </span>
<a href="#l33.181"></a><span id="l33.181" class="difflineminus">-// Methods for nsIStreamObserver </span>
<a href="#l33.182"></a><span id="l33.182" class="difflineplus">+// Methods for nsIStreamObserver</span>
<a href="#l33.183"></a><span id="l33.183"> nsresult</span>
<a href="#l33.184"></a><span id="l33.184"> nsURLFetcher::OnStartRequest(nsIRequest *request, nsISupports *ctxt)</span>
<a href="#l33.185"></a><span id="l33.185"> {</span>
<a href="#l33.186"></a><span id="l33.186">   /* check if the user has canceld the operation */</span>
<a href="#l33.187"></a><span id="l33.187">   if (mTagData)</span>
<a href="#l33.188"></a><span id="l33.188">   {</span>
<a href="#l33.189"></a><span id="l33.189">     nsCOMPtr&lt;nsIMsgSend&gt; sendPtr;</span>
<a href="#l33.190"></a><span id="l33.190">     mTagData-&gt;GetMimeDeliveryState(getter_AddRefs(sendPtr));</span>
<a href="#l33.191"></a><span id="l33.191" class="difflineat">@@ -260,60 +260,60 @@ nsURLFetcher::OnStopRequest(nsIRequest *</span>
<a href="#l33.192"></a><span id="l33.192">   //</span>
<a href="#l33.193"></a><span id="l33.193">   mStillRunning = false;</span>
<a href="#l33.194"></a><span id="l33.194"> </span>
<a href="#l33.195"></a><span id="l33.195">   // time to close the output stream...</span>
<a href="#l33.196"></a><span id="l33.196">   if (mOutStream)</span>
<a href="#l33.197"></a><span id="l33.197">   {</span>
<a href="#l33.198"></a><span id="l33.198">     mOutStream-&gt;Close();</span>
<a href="#l33.199"></a><span id="l33.199">     mOutStream = nullptr;</span>
<a href="#l33.200"></a><span id="l33.200" class="difflineminus">-  </span>
<a href="#l33.201"></a><span id="l33.201" class="difflineplus">+</span>
<a href="#l33.202"></a><span id="l33.202">     /* In case of multipart/x-mixed-replace, we need to truncate the file to the current part size */</span>
<a href="#l33.203"></a><span id="l33.203">     if (MsgLowerCaseEqualsLiteral(mConverterContentType, MULTIPART_MIXED_REPLACE))</span>
<a href="#l33.204"></a><span id="l33.204">     {</span>
<a href="#l33.205"></a><span id="l33.205">       mLocalFile-&gt;SetFileSize(mTotalWritten);</span>
<a href="#l33.206"></a><span id="l33.206">     }</span>
<a href="#l33.207"></a><span id="l33.207">   }</span>
<a href="#l33.208"></a><span id="l33.208"> </span>
<a href="#l33.209"></a><span id="l33.209">   // Now if there is a callback, we need to call it...</span>
<a href="#l33.210"></a><span id="l33.210">   if (mCallback)</span>
<a href="#l33.211"></a><span id="l33.211">     mCallback (aStatus, mContentType, mCharset, mTotalWritten, nullptr, mTagData);</span>
<a href="#l33.212"></a><span id="l33.212"> </span>
<a href="#l33.213"></a><span id="l33.213">   // Time to return...</span>
<a href="#l33.214"></a><span id="l33.214">   return NS_OK;</span>
<a href="#l33.215"></a><span id="l33.215"> }</span>
<a href="#l33.216"></a><span id="l33.216"> </span>
<a href="#l33.217"></a><span id="l33.217" class="difflineminus">-nsresult </span>
<a href="#l33.218"></a><span id="l33.218" class="difflineminus">-nsURLFetcher::Initialize(nsIFile *localFile, </span>
<a href="#l33.219"></a><span id="l33.219" class="difflineplus">+nsresult</span>
<a href="#l33.220"></a><span id="l33.220" class="difflineplus">+nsURLFetcher::Initialize(nsIFile *localFile,</span>
<a href="#l33.221"></a><span id="l33.221">                          nsIOutputStream *outputStream,</span>
<a href="#l33.222"></a><span id="l33.222" class="difflineminus">-                         nsAttachSaveCompletionCallback cb, </span>
<a href="#l33.223"></a><span id="l33.223" class="difflineplus">+                         nsAttachSaveCompletionCallback cb,</span>
<a href="#l33.224"></a><span id="l33.224">                          nsMsgAttachmentHandler *tagData)</span>
<a href="#l33.225"></a><span id="l33.225"> {</span>
<a href="#l33.226"></a><span id="l33.226">   if (!outputStream || !localFile)</span>
<a href="#l33.227"></a><span id="l33.227">     return NS_ERROR_INVALID_ARG;</span>
<a href="#l33.228"></a><span id="l33.228"> </span>
<a href="#l33.229"></a><span id="l33.229">   mOutStream = outputStream;</span>
<a href="#l33.230"></a><span id="l33.230">   mLocalFile = localFile;</span>
<a href="#l33.231"></a><span id="l33.231">   mCallback = cb;     //JFD: Please, no more callback, use a listener...</span>
<a href="#l33.232"></a><span id="l33.232">   mTagData = tagData;</span>
<a href="#l33.233"></a><span id="l33.233">   return NS_OK;</span>
<a href="#l33.234"></a><span id="l33.234"> }</span>
<a href="#l33.235"></a><span id="l33.235"> </span>
<a href="#l33.236"></a><span id="l33.236"> nsresult</span>
<a href="#l33.237"></a><span id="l33.237" class="difflineminus">-nsURLFetcher::FireURLRequest(nsIURI *aURL, nsIFile *localFile, nsIOutputStream *outputStream, </span>
<a href="#l33.238"></a><span id="l33.238" class="difflineplus">+nsURLFetcher::FireURLRequest(nsIURI *aURL, nsIFile *localFile, nsIOutputStream *outputStream,</span>
<a href="#l33.239"></a><span id="l33.239">                              nsAttachSaveCompletionCallback cb, nsMsgAttachmentHandler *tagData)</span>
<a href="#l33.240"></a><span id="l33.240"> {</span>
<a href="#l33.241"></a><span id="l33.241">   nsresult rv;</span>
<a href="#l33.242"></a><span id="l33.242"> </span>
<a href="#l33.243"></a><span id="l33.243">   rv = Initialize(localFile, outputStream, cb, tagData);</span>
<a href="#l33.244"></a><span id="l33.244">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l33.245"></a><span id="l33.245"> </span>
<a href="#l33.246"></a><span id="l33.246">   //check to see if aURL is a local file or not</span>
<a href="#l33.247"></a><span id="l33.247">   aURL-&gt;SchemeIs(&quot;file&quot;, &amp;mIsFile);</span>
<a href="#l33.248"></a><span id="l33.248" class="difflineminus">-  </span>
<a href="#l33.249"></a><span id="l33.249" class="difflineplus">+</span>
<a href="#l33.250"></a><span id="l33.250">   // we're about to fire a new url request so make sure the on stop request flag is cleared...</span>
<a href="#l33.251"></a><span id="l33.251">   mOnStopRequestProcessed = false;</span>
<a href="#l33.252"></a><span id="l33.252"> </span>
<a href="#l33.253"></a><span id="l33.253">   // let's try uri dispatching...</span>
<a href="#l33.254"></a><span id="l33.254">   nsCOMPtr&lt;nsIURILoader&gt; pURILoader (do_GetService(NS_URI_LOADER_CONTRACTID));</span>
<a href="#l33.255"></a><span id="l33.255">   NS_ENSURE_TRUE(pURILoader, NS_ERROR_FAILURE);</span>
<a href="#l33.256"></a><span id="l33.256"> </span>
<a href="#l33.257"></a><span id="l33.257">   nsCOMPtr&lt;nsIChannel&gt; channel;</span>
<a href="#l33.258"></a><span id="l33.258" class="difflineat">@@ -380,29 +380,29 @@ nsURLFetcher::OnLocationChange(nsIWebPro</span>
<a href="#l33.259"></a><span id="l33.259">                                nsIRequest* aRequest,</span>
<a href="#l33.260"></a><span id="l33.260">                                nsIURI *aURI,</span>
<a href="#l33.261"></a><span id="l33.261">                                uint32_t aFlags)</span>
<a href="#l33.262"></a><span id="l33.262"> {</span>
<a href="#l33.263"></a><span id="l33.263">   NS_NOTREACHED(&quot;notification excluded in AddProgressListener(...)&quot;);</span>
<a href="#l33.264"></a><span id="l33.264">   return NS_OK;</span>
<a href="#l33.265"></a><span id="l33.265"> }</span>
<a href="#l33.266"></a><span id="l33.266"> </span>
<a href="#l33.267"></a><span id="l33.267" class="difflineminus">-NS_IMETHODIMP </span>
<a href="#l33.268"></a><span id="l33.268" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l33.269"></a><span id="l33.269"> nsURLFetcher::OnStatusChange(nsIWebProgress* aWebProgress,</span>
<a href="#l33.270"></a><span id="l33.270">                              nsIRequest* aRequest,</span>
<a href="#l33.271"></a><span id="l33.271">                              nsresult aStatus,</span>
<a href="#l33.272"></a><span id="l33.272">                              const char16_t* aMessage)</span>
<a href="#l33.273"></a><span id="l33.273"> {</span>
<a href="#l33.274"></a><span id="l33.274">   NS_NOTREACHED(&quot;notification excluded in AddProgressListener(...)&quot;);</span>
<a href="#l33.275"></a><span id="l33.275">   return NS_OK;</span>
<a href="#l33.276"></a><span id="l33.276"> }</span>
<a href="#l33.277"></a><span id="l33.277"> </span>
<a href="#l33.278"></a><span id="l33.278" class="difflineminus">-NS_IMETHODIMP </span>
<a href="#l33.279"></a><span id="l33.279" class="difflineminus">-nsURLFetcher::OnSecurityChange(nsIWebProgress *aWebProgress, </span>
<a href="#l33.280"></a><span id="l33.280" class="difflineminus">-                               nsIRequest *aRequest, </span>
<a href="#l33.281"></a><span id="l33.281" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l33.282"></a><span id="l33.282" class="difflineplus">+nsURLFetcher::OnSecurityChange(nsIWebProgress *aWebProgress,</span>
<a href="#l33.283"></a><span id="l33.283" class="difflineplus">+                               nsIRequest *aRequest,</span>
<a href="#l33.284"></a><span id="l33.284">                                uint32_t state)</span>
<a href="#l33.285"></a><span id="l33.285"> {</span>
<a href="#l33.286"></a><span id="l33.286">   NS_NOTREACHED(&quot;notification excluded in AddProgressListener(...)&quot;);</span>
<a href="#l33.287"></a><span id="l33.287">   return NS_OK;</span>
<a href="#l33.288"></a><span id="l33.288"> }</span>
<a href="#l33.289"></a><span id="l33.289"> </span>
<a href="#l33.290"></a><span id="l33.290"> </span>
<a href="#l33.291"></a><span id="l33.291"> /**</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l34.1"></a><span id="l34.1" class="difflineminus">--- a/mailnews/compose/src/nsURLFetcher.h</span>
<a href="#l34.2"></a><span id="l34.2" class="difflineplus">+++ b/mailnews/compose/src/nsURLFetcher.h</span>
<a href="#l34.3"></a><span id="l34.3" class="difflineat">@@ -19,36 +19,36 @@</span>
<a href="#l34.4"></a><span id="l34.4"> #include &quot;nsIWebProgressListener.h&quot;</span>
<a href="#l34.5"></a><span id="l34.5"> #include &quot;nsWeakReference.h&quot;</span>
<a href="#l34.6"></a><span id="l34.6"> #include &quot;nsString.h&quot;</span>
<a href="#l34.7"></a><span id="l34.7"> </span>
<a href="#l34.8"></a><span id="l34.8"> class nsMsgAttachmentHandler;</span>
<a href="#l34.9"></a><span id="l34.9"> </span>
<a href="#l34.10"></a><span id="l34.10"> class nsURLFetcher : public nsIURLFetcher,</span>
<a href="#l34.11"></a><span id="l34.11">                      public nsIStreamListener,</span>
<a href="#l34.12"></a><span id="l34.12" class="difflineminus">-                     public nsIURIContentListener, </span>
<a href="#l34.13"></a><span id="l34.13" class="difflineplus">+                     public nsIURIContentListener,</span>
<a href="#l34.14"></a><span id="l34.14">                      public nsIInterfaceRequestor,</span>
<a href="#l34.15"></a><span id="l34.15">                      public nsIWebProgressListener,</span>
<a href="#l34.16"></a><span id="l34.16">                      public nsSupportsWeakReference</span>
<a href="#l34.17"></a><span id="l34.17" class="difflineminus">-{ </span>
<a href="#l34.18"></a><span id="l34.18" class="difflineminus">-public: </span>
<a href="#l34.19"></a><span id="l34.19" class="difflineplus">+{</span>
<a href="#l34.20"></a><span id="l34.20" class="difflineplus">+public:</span>
<a href="#l34.21"></a><span id="l34.21">   nsURLFetcher();</span>
<a href="#l34.22"></a><span id="l34.22"> </span>
<a href="#l34.23"></a><span id="l34.23">   /* this macro defines QueryInterface, AddRef and Release for this class */</span>
<a href="#l34.24"></a><span id="l34.24">   NS_DECL_ISUPPORTS</span>
<a href="#l34.25"></a><span id="l34.25"> </span>
<a href="#l34.26"></a><span id="l34.26">   // Methods for nsIURLFetcher</span>
<a href="#l34.27"></a><span id="l34.27">   NS_DECL_NSIURLFETCHER</span>
<a href="#l34.28"></a><span id="l34.28"> </span>
<a href="#l34.29"></a><span id="l34.29">   // Methods for nsIStreamListener</span>
<a href="#l34.30"></a><span id="l34.30">   NS_DECL_NSISTREAMLISTENER</span>
<a href="#l34.31"></a><span id="l34.31"> </span>
<a href="#l34.32"></a><span id="l34.32">   // Methods for nsIRequestObserver</span>
<a href="#l34.33"></a><span id="l34.33">   NS_DECL_NSIREQUESTOBSERVER</span>
<a href="#l34.34"></a><span id="l34.34" class="difflineminus">-  </span>
<a href="#l34.35"></a><span id="l34.35" class="difflineplus">+</span>
<a href="#l34.36"></a><span id="l34.36">   // Methods for nsIURICOntentListener</span>
<a href="#l34.37"></a><span id="l34.37">   NS_DECL_NSIURICONTENTLISTENER</span>
<a href="#l34.38"></a><span id="l34.38"> </span>
<a href="#l34.39"></a><span id="l34.39">   // Methods for nsIInterfaceRequestor</span>
<a href="#l34.40"></a><span id="l34.40">   NS_DECL_NSIINTERFACEREQUESTOR</span>
<a href="#l34.41"></a><span id="l34.41"> </span>
<a href="#l34.42"></a><span id="l34.42">   // Methods for nsIWebProgressListener</span>
<a href="#l34.43"></a><span id="l34.43">   NS_DECL_NSIWEBPROGRESSLISTENER</span>
<a href="#l34.44"></a><span id="l34.44" class="difflineat">@@ -70,17 +70,17 @@ private:</span>
<a href="#l34.45"></a><span id="l34.45">   nsCString                  mCharset;                 // The charset retrieved from the server</span>
<a href="#l34.46"></a><span id="l34.46">   RefPtr&lt;nsMsgAttachmentHandler&gt; mTagData;      // Tag data for callback...</span>
<a href="#l34.47"></a><span id="l34.47">   nsAttachSaveCompletionCallback  mCallback;      // Callback to call once the file is saved...</span>
<a href="#l34.48"></a><span id="l34.48">   nsCOMPtr&lt;nsISupports&gt;           mLoadCookie;    // load cookie used by the uri loader when we fetch the url</span>
<a href="#l34.49"></a><span id="l34.49">   bool                            mOnStopRequestProcessed; // used to prevent calling OnStopRequest multiple times</span>
<a href="#l34.50"></a><span id="l34.50">   bool                            mIsFile;        // This is used to check whether the URI is a local file.</span>
<a href="#l34.51"></a><span id="l34.51"> </span>
<a href="#l34.52"></a><span id="l34.52">   friend class nsURLFetcherStreamConsumer;</span>
<a href="#l34.53"></a><span id="l34.53" class="difflineminus">-}; </span>
<a href="#l34.54"></a><span id="l34.54" class="difflineplus">+};</span>
<a href="#l34.55"></a><span id="l34.55"> </span>
<a href="#l34.56"></a><span id="l34.56"> </span>
<a href="#l34.57"></a><span id="l34.57"> /**</span>
<a href="#l34.58"></a><span id="l34.58">  * Stream consumer used for handling special content type like multipart/x-mixed-replace</span>
<a href="#l34.59"></a><span id="l34.59">  */</span>
<a href="#l34.60"></a><span id="l34.60"> </span>
<a href="#l34.61"></a><span id="l34.61"> class nsURLFetcherStreamConsumer : public nsIStreamListener</span>
<a href="#l34.62"></a><span id="l34.62"> {</span>
<a href="#l34.63"></a><span id="l34.63" class="difflineat">@@ -90,12 +90,12 @@ public:</span>
<a href="#l34.64"></a><span id="l34.64">   /* additional members */</span>
<a href="#l34.65"></a><span id="l34.65">   NS_DECL_ISUPPORTS</span>
<a href="#l34.66"></a><span id="l34.66">   NS_DECL_NSISTREAMLISTENER</span>
<a href="#l34.67"></a><span id="l34.67">   NS_DECL_NSIREQUESTOBSERVER</span>
<a href="#l34.68"></a><span id="l34.68"> </span>
<a href="#l34.69"></a><span id="l34.69"> private:</span>
<a href="#l34.70"></a><span id="l34.70">   virtual ~nsURLFetcherStreamConsumer();</span>
<a href="#l34.71"></a><span id="l34.71">   nsURLFetcher* mURLFetcher;</span>
<a href="#l34.72"></a><span id="l34.72" class="difflineminus">-}; </span>
<a href="#l34.73"></a><span id="l34.73" class="difflineplus">+};</span>
<a href="#l34.74"></a><span id="l34.74"> </span>
<a href="#l34.75"></a><span id="l34.75"> </span>
<a href="#l34.76"></a><span id="l34.76"> #endif /* nsURLFetcher_h_ */</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

