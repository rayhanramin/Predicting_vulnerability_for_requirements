<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 28834:a144a25e51915e9d91761340c0e1b62969769d6a</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ a144a25e51915e9d91761340c0e1b62969769d6a" />
<meta property="og:url" content="/comm-central/rev/a144a25e51915e9d91761340c0e1b62969769d6a" />
<meta property="og:description" content="Bug 1617514 - Give tab info and click info to *Action API events. r=mkmelin" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / a144a25e51915e9d91761340c0e1b62969769d6a 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/a144a25e51915e9d91761340c0e1b62969769d6a">shortlog</a> |
<a href="/comm-central/log/a144a25e51915e9d91761340c0e1b62969769d6a">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/a144a25e51915e9d91761340c0e1b62969769d6a">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/a144a25e51915e9d91761340c0e1b62969769d6a">files</a> |
changeset |
<a href="/comm-central/raw-rev/a144a25e51915e9d91761340c0e1b62969769d6a">raw</a>  | <a href="/comm-central/archive/a144a25e51915e9d91761340c0e1b62969769d6a.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1617514">Bug 1617514</a> - Give tab info and click info to *Action API events. r=mkmelin
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#71;&#101;&#111;&#102;&#102;&#32;&#76;&#97;&#110;&#107;&#111;&#119;&#32;&#60;&#103;&#101;&#111;&#102;&#102;&#64;&#100;&#97;&#114;&#107;&#116;&#114;&#111;&#106;&#97;&#110;&#46;&#110;&#101;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Mon, 24 Feb 2020 11:56:46 +0200</td></tr>

<tr>
 <td>changeset 28834</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/a144a25e51915e9d91761340c0e1b62969769d6a">a144a25e51915e9d91761340c0e1b62969769d6a</a></td>
</tr>



<tr>
<td>parent 28833</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/ebcd40d4aaab9cb72e0fd963bcc7bc520d00b803">ebcd40d4aaab9cb72e0fd963bcc7bc520d00b803</a>
</td>
</tr>

<tr>
<td>child 28835</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/bb6db0e80a06f4550e6bc9f1c80b3faf15763340">bb6db0e80a06f4550e6bc9f1c80b3faf15763340</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=a144a25e51915e9d91761340c0e1b62969769d6a">17064</a></td></tr>
<tr><td>push user</td><td>mkmelin@iki.fi</td></tr>
<tr><td>push date</td><td class="date age">Mon, 24 Feb 2020 10:01:55 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@bb6db0e80a06 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=bb6db0e80a06f4550e6bc9f1c80b3faf15763340">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=bb6db0e80a06f4550e6bc9f1c80b3faf15763340&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=bb6db0e80a06f4550e6bc9f1c80b3faf15763340&newProject=comm-central&newRevision=947de04af434eda6e08ea381a7a8747fdb762cb8&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=bb6db0e80a06f4550e6bc9f1c80b3faf15763340&newProject=comm-central&newRevision=947de04af434eda6e08ea381a7a8747fdb762cb8&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=bb6db0e80a06f4550e6bc9f1c80b3faf15763340&newProject=comm-central&newRevision=947de04af434eda6e08ea381a7a8747fdb762cb8&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28mkmelin%29&revcount=50">mkmelin</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1617514">1617514</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1617514">Bug 1617514</a> - Give tab info and click info to *Action API events. r=mkmelin</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/a144a25e51915e9d91761340c0e1b62969769d6a/mail/components/extensions/ExtensionToolbarButtons.jsm">mail/components/extensions/ExtensionToolbarButtons.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a144a25e51915e9d91761340c0e1b62969769d6a/mail/components/extensions/ExtensionToolbarButtons.jsm">file</a> |
<a href="/comm-central/annotate/a144a25e51915e9d91761340c0e1b62969769d6a/mail/components/extensions/ExtensionToolbarButtons.jsm">annotate</a> |
<a href="/comm-central/diff/a144a25e51915e9d91761340c0e1b62969769d6a/mail/components/extensions/ExtensionToolbarButtons.jsm">diff</a> |
<a href="/comm-central/comparison/a144a25e51915e9d91761340c0e1b62969769d6a/mail/components/extensions/ExtensionToolbarButtons.jsm">comparison</a> |
<a href="/comm-central/log/a144a25e51915e9d91761340c0e1b62969769d6a/mail/components/extensions/ExtensionToolbarButtons.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/a144a25e51915e9d91761340c0e1b62969769d6a/mail/components/extensions/parent/ext-compose.js">mail/components/extensions/parent/ext-compose.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a144a25e51915e9d91761340c0e1b62969769d6a/mail/components/extensions/parent/ext-compose.js">file</a> |
<a href="/comm-central/annotate/a144a25e51915e9d91761340c0e1b62969769d6a/mail/components/extensions/parent/ext-compose.js">annotate</a> |
<a href="/comm-central/diff/a144a25e51915e9d91761340c0e1b62969769d6a/mail/components/extensions/parent/ext-compose.js">diff</a> |
<a href="/comm-central/comparison/a144a25e51915e9d91761340c0e1b62969769d6a/mail/components/extensions/parent/ext-compose.js">comparison</a> |
<a href="/comm-central/log/a144a25e51915e9d91761340c0e1b62969769d6a/mail/components/extensions/parent/ext-compose.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/a144a25e51915e9d91761340c0e1b62969769d6a/mail/components/extensions/parent/ext-composeAction.js">mail/components/extensions/parent/ext-composeAction.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a144a25e51915e9d91761340c0e1b62969769d6a/mail/components/extensions/parent/ext-composeAction.js">file</a> |
<a href="/comm-central/annotate/a144a25e51915e9d91761340c0e1b62969769d6a/mail/components/extensions/parent/ext-composeAction.js">annotate</a> |
<a href="/comm-central/diff/a144a25e51915e9d91761340c0e1b62969769d6a/mail/components/extensions/parent/ext-composeAction.js">diff</a> |
<a href="/comm-central/comparison/a144a25e51915e9d91761340c0e1b62969769d6a/mail/components/extensions/parent/ext-composeAction.js">comparison</a> |
<a href="/comm-central/log/a144a25e51915e9d91761340c0e1b62969769d6a/mail/components/extensions/parent/ext-composeAction.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/a144a25e51915e9d91761340c0e1b62969769d6a/mail/components/extensions/parent/ext-messageDisplayAction.js">mail/components/extensions/parent/ext-messageDisplayAction.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a144a25e51915e9d91761340c0e1b62969769d6a/mail/components/extensions/parent/ext-messageDisplayAction.js">file</a> |
<a href="/comm-central/annotate/a144a25e51915e9d91761340c0e1b62969769d6a/mail/components/extensions/parent/ext-messageDisplayAction.js">annotate</a> |
<a href="/comm-central/diff/a144a25e51915e9d91761340c0e1b62969769d6a/mail/components/extensions/parent/ext-messageDisplayAction.js">diff</a> |
<a href="/comm-central/comparison/a144a25e51915e9d91761340c0e1b62969769d6a/mail/components/extensions/parent/ext-messageDisplayAction.js">comparison</a> |
<a href="/comm-central/log/a144a25e51915e9d91761340c0e1b62969769d6a/mail/components/extensions/parent/ext-messageDisplayAction.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/a144a25e51915e9d91761340c0e1b62969769d6a/mail/components/extensions/schemas/browserAction.json">mail/components/extensions/schemas/browserAction.json</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a144a25e51915e9d91761340c0e1b62969769d6a/mail/components/extensions/schemas/browserAction.json">file</a> |
<a href="/comm-central/annotate/a144a25e51915e9d91761340c0e1b62969769d6a/mail/components/extensions/schemas/browserAction.json">annotate</a> |
<a href="/comm-central/diff/a144a25e51915e9d91761340c0e1b62969769d6a/mail/components/extensions/schemas/browserAction.json">diff</a> |
<a href="/comm-central/comparison/a144a25e51915e9d91761340c0e1b62969769d6a/mail/components/extensions/schemas/browserAction.json">comparison</a> |
<a href="/comm-central/log/a144a25e51915e9d91761340c0e1b62969769d6a/mail/components/extensions/schemas/browserAction.json">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/a144a25e51915e9d91761340c0e1b62969769d6a/mail/components/extensions/schemas/compose.json">mail/components/extensions/schemas/compose.json</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a144a25e51915e9d91761340c0e1b62969769d6a/mail/components/extensions/schemas/compose.json">file</a> |
<a href="/comm-central/annotate/a144a25e51915e9d91761340c0e1b62969769d6a/mail/components/extensions/schemas/compose.json">annotate</a> |
<a href="/comm-central/diff/a144a25e51915e9d91761340c0e1b62969769d6a/mail/components/extensions/schemas/compose.json">diff</a> |
<a href="/comm-central/comparison/a144a25e51915e9d91761340c0e1b62969769d6a/mail/components/extensions/schemas/compose.json">comparison</a> |
<a href="/comm-central/log/a144a25e51915e9d91761340c0e1b62969769d6a/mail/components/extensions/schemas/compose.json">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/a144a25e51915e9d91761340c0e1b62969769d6a/mail/components/extensions/schemas/composeAction.json">mail/components/extensions/schemas/composeAction.json</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a144a25e51915e9d91761340c0e1b62969769d6a/mail/components/extensions/schemas/composeAction.json">file</a> |
<a href="/comm-central/annotate/a144a25e51915e9d91761340c0e1b62969769d6a/mail/components/extensions/schemas/composeAction.json">annotate</a> |
<a href="/comm-central/diff/a144a25e51915e9d91761340c0e1b62969769d6a/mail/components/extensions/schemas/composeAction.json">diff</a> |
<a href="/comm-central/comparison/a144a25e51915e9d91761340c0e1b62969769d6a/mail/components/extensions/schemas/composeAction.json">comparison</a> |
<a href="/comm-central/log/a144a25e51915e9d91761340c0e1b62969769d6a/mail/components/extensions/schemas/composeAction.json">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/a144a25e51915e9d91761340c0e1b62969769d6a/mail/components/extensions/schemas/messageDisplayAction.json">mail/components/extensions/schemas/messageDisplayAction.json</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a144a25e51915e9d91761340c0e1b62969769d6a/mail/components/extensions/schemas/messageDisplayAction.json">file</a> |
<a href="/comm-central/annotate/a144a25e51915e9d91761340c0e1b62969769d6a/mail/components/extensions/schemas/messageDisplayAction.json">annotate</a> |
<a href="/comm-central/diff/a144a25e51915e9d91761340c0e1b62969769d6a/mail/components/extensions/schemas/messageDisplayAction.json">diff</a> |
<a href="/comm-central/comparison/a144a25e51915e9d91761340c0e1b62969769d6a/mail/components/extensions/schemas/messageDisplayAction.json">comparison</a> |
<a href="/comm-central/log/a144a25e51915e9d91761340c0e1b62969769d6a/mail/components/extensions/schemas/messageDisplayAction.json">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/a144a25e51915e9d91761340c0e1b62969769d6a/mail/components/extensions/test/browser/browser_ext_browserAction.js">mail/components/extensions/test/browser/browser_ext_browserAction.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a144a25e51915e9d91761340c0e1b62969769d6a/mail/components/extensions/test/browser/browser_ext_browserAction.js">file</a> |
<a href="/comm-central/annotate/a144a25e51915e9d91761340c0e1b62969769d6a/mail/components/extensions/test/browser/browser_ext_browserAction.js">annotate</a> |
<a href="/comm-central/diff/a144a25e51915e9d91761340c0e1b62969769d6a/mail/components/extensions/test/browser/browser_ext_browserAction.js">diff</a> |
<a href="/comm-central/comparison/a144a25e51915e9d91761340c0e1b62969769d6a/mail/components/extensions/test/browser/browser_ext_browserAction.js">comparison</a> |
<a href="/comm-central/log/a144a25e51915e9d91761340c0e1b62969769d6a/mail/components/extensions/test/browser/browser_ext_browserAction.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/a144a25e51915e9d91761340c0e1b62969769d6a/mail/components/extensions/test/browser/browser_ext_composeAction.js">mail/components/extensions/test/browser/browser_ext_composeAction.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a144a25e51915e9d91761340c0e1b62969769d6a/mail/components/extensions/test/browser/browser_ext_composeAction.js">file</a> |
<a href="/comm-central/annotate/a144a25e51915e9d91761340c0e1b62969769d6a/mail/components/extensions/test/browser/browser_ext_composeAction.js">annotate</a> |
<a href="/comm-central/diff/a144a25e51915e9d91761340c0e1b62969769d6a/mail/components/extensions/test/browser/browser_ext_composeAction.js">diff</a> |
<a href="/comm-central/comparison/a144a25e51915e9d91761340c0e1b62969769d6a/mail/components/extensions/test/browser/browser_ext_composeAction.js">comparison</a> |
<a href="/comm-central/log/a144a25e51915e9d91761340c0e1b62969769d6a/mail/components/extensions/test/browser/browser_ext_composeAction.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/a144a25e51915e9d91761340c0e1b62969769d6a/mail/components/extensions/test/browser/browser_ext_compose_onBeforeSend.js">mail/components/extensions/test/browser/browser_ext_compose_onBeforeSend.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a144a25e51915e9d91761340c0e1b62969769d6a/mail/components/extensions/test/browser/browser_ext_compose_onBeforeSend.js">file</a> |
<a href="/comm-central/annotate/a144a25e51915e9d91761340c0e1b62969769d6a/mail/components/extensions/test/browser/browser_ext_compose_onBeforeSend.js">annotate</a> |
<a href="/comm-central/diff/a144a25e51915e9d91761340c0e1b62969769d6a/mail/components/extensions/test/browser/browser_ext_compose_onBeforeSend.js">diff</a> |
<a href="/comm-central/comparison/a144a25e51915e9d91761340c0e1b62969769d6a/mail/components/extensions/test/browser/browser_ext_compose_onBeforeSend.js">comparison</a> |
<a href="/comm-central/log/a144a25e51915e9d91761340c0e1b62969769d6a/mail/components/extensions/test/browser/browser_ext_compose_onBeforeSend.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/a144a25e51915e9d91761340c0e1b62969769d6a/mail/components/extensions/test/browser/browser_ext_messageDisplayAction.js">mail/components/extensions/test/browser/browser_ext_messageDisplayAction.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a144a25e51915e9d91761340c0e1b62969769d6a/mail/components/extensions/test/browser/browser_ext_messageDisplayAction.js">file</a> |
<a href="/comm-central/annotate/a144a25e51915e9d91761340c0e1b62969769d6a/mail/components/extensions/test/browser/browser_ext_messageDisplayAction.js">annotate</a> |
<a href="/comm-central/diff/a144a25e51915e9d91761340c0e1b62969769d6a/mail/components/extensions/test/browser/browser_ext_messageDisplayAction.js">diff</a> |
<a href="/comm-central/comparison/a144a25e51915e9d91761340c0e1b62969769d6a/mail/components/extensions/test/browser/browser_ext_messageDisplayAction.js">comparison</a> |
<a href="/comm-central/log/a144a25e51915e9d91761340c0e1b62969769d6a/mail/components/extensions/test/browser/browser_ext_messageDisplayAction.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/components/extensions/ExtensionToolbarButtons.jsm</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/components/extensions/ExtensionToolbarButtons.jsm</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -248,31 +248,39 @@ this.ToolbarButtonAPI = class extends Ex</span>
<a href="#l1.4"></a><span id="l1.4">     );</span>
<a href="#l1.5"></a><span id="l1.5"> </span>
<a href="#l1.6"></a><span id="l1.6">     if (button &amp;&amp; popupURL &amp;&amp; enabled) {</span>
<a href="#l1.7"></a><span id="l1.7">       let popup =</span>
<a href="#l1.8"></a><span id="l1.8">         ViewPopup.for(this.extension, window) ||</span>
<a href="#l1.9"></a><span id="l1.9">         this.getPopup(window, popupURL);</span>
<a href="#l1.10"></a><span id="l1.10">       popup.viewNode.openPopup(button, &quot;bottomcenter topleft&quot;, 0, 0);</span>
<a href="#l1.11"></a><span id="l1.11">     } else {</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+      if (!this.lastClickInfo) {</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+        this.lastClickInfo = { button: 0, modifiers: [] };</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+      }</span>
<a href="#l1.15"></a><span id="l1.15">       this.emit(&quot;click&quot;, window);</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineplus">+      delete this.lastClickInfo;</span>
<a href="#l1.17"></a><span id="l1.17">     }</span>
<a href="#l1.18"></a><span id="l1.18">   }</span>
<a href="#l1.19"></a><span id="l1.19"> </span>
<a href="#l1.20"></a><span id="l1.20">   /**</span>
<a href="#l1.21"></a><span id="l1.21">    * Event listener.</span>
<a href="#l1.22"></a><span id="l1.22">    *</span>
<a href="#l1.23"></a><span id="l1.23">    * @param {Event} event</span>
<a href="#l1.24"></a><span id="l1.24">    */</span>
<a href="#l1.25"></a><span id="l1.25">   handleEvent(event) {</span>
<a href="#l1.26"></a><span id="l1.26">     let window = event.target.ownerGlobal;</span>
<a href="#l1.27"></a><span id="l1.27"> </span>
<a href="#l1.28"></a><span id="l1.28">     switch (event.type) {</span>
<a href="#l1.29"></a><span id="l1.29">       case &quot;mousedown&quot;:</span>
<a href="#l1.30"></a><span id="l1.30">         if (event.button == 0) {</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineplus">+          this.lastClickInfo = {</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineplus">+            button: 0,</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineplus">+            modifiers: this.global.clickModifiersFromEvent(event),</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineplus">+          };</span>
<a href="#l1.35"></a><span id="l1.35">           this.triggerAction(window);</span>
<a href="#l1.36"></a><span id="l1.36">         }</span>
<a href="#l1.37"></a><span id="l1.37">         break;</span>
<a href="#l1.38"></a><span id="l1.38">       case &quot;TabSelect&quot;:</span>
<a href="#l1.39"></a><span id="l1.39">         this.updateWindow(window);</span>
<a href="#l1.40"></a><span id="l1.40">         break;</span>
<a href="#l1.41"></a><span id="l1.41">     }</span>
<a href="#l1.42"></a><span id="l1.42">   }</span>
<a href="#l1.43"></a><span id="l1.43" class="difflineat">@@ -566,28 +574,33 @@ this.ToolbarButtonAPI = class extends Ex</span>
<a href="#l1.44"></a><span id="l1.44"> </span>
<a href="#l1.45"></a><span id="l1.45">   /**</span>
<a href="#l1.46"></a><span id="l1.46">    * WebExtension API.</span>
<a href="#l1.47"></a><span id="l1.47">    *</span>
<a href="#l1.48"></a><span id="l1.48">    * @param {Object} context</span>
<a href="#l1.49"></a><span id="l1.49">    */</span>
<a href="#l1.50"></a><span id="l1.50">   getAPI(context) {</span>
<a href="#l1.51"></a><span id="l1.51">     let { extension } = context;</span>
<a href="#l1.52"></a><span id="l1.52" class="difflineplus">+    let { tabManager, windowManager } = extension;</span>
<a href="#l1.53"></a><span id="l1.53"> </span>
<a href="#l1.54"></a><span id="l1.54">     let action = this;</span>
<a href="#l1.55"></a><span id="l1.55"> </span>
<a href="#l1.56"></a><span id="l1.56">     return {</span>
<a href="#l1.57"></a><span id="l1.57">       [this.manifestName]: {</span>
<a href="#l1.58"></a><span id="l1.58">         onClicked: new EventManager({</span>
<a href="#l1.59"></a><span id="l1.59">           context,</span>
<a href="#l1.60"></a><span id="l1.60">           name: `${this.manifestName}.onClicked`,</span>
<a href="#l1.61"></a><span id="l1.61">           inputHandling: true,</span>
<a href="#l1.62"></a><span id="l1.62">           register: fire =&gt; {</span>
<a href="#l1.63"></a><span id="l1.63" class="difflineminus">-            let listener = event =&gt; {</span>
<a href="#l1.64"></a><span id="l1.64" class="difflineminus">-              fire.sync();</span>
<a href="#l1.65"></a><span id="l1.65" class="difflineplus">+            let listener = (event, window) =&gt; {</span>
<a href="#l1.66"></a><span id="l1.66" class="difflineplus">+              let win = windowManager.wrapWindow(window);</span>
<a href="#l1.67"></a><span id="l1.67" class="difflineplus">+              fire.sync(</span>
<a href="#l1.68"></a><span id="l1.68" class="difflineplus">+                tabManager.convert(win.activeTab.nativeTab),</span>
<a href="#l1.69"></a><span id="l1.69" class="difflineplus">+                this.lastClickInfo</span>
<a href="#l1.70"></a><span id="l1.70" class="difflineplus">+              );</span>
<a href="#l1.71"></a><span id="l1.71">             };</span>
<a href="#l1.72"></a><span id="l1.72">             action.on(&quot;click&quot;, listener);</span>
<a href="#l1.73"></a><span id="l1.73">             return () =&gt; {</span>
<a href="#l1.74"></a><span id="l1.74">               action.off(&quot;click&quot;, listener);</span>
<a href="#l1.75"></a><span id="l1.75">             };</span>
<a href="#l1.76"></a><span id="l1.76">           },</span>
<a href="#l1.77"></a><span id="l1.77">         }).api(),</span>
<a href="#l1.78"></a><span id="l1.78"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/components/extensions/parent/ext-compose.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/components/extensions/parent/ext-compose.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -176,17 +176,17 @@ var composeEventTracker = new (class ext</span>
<a href="#l2.4"></a><span id="l2.4"> </span>
<a href="#l2.5"></a><span id="l2.5">     let msgType = event.detail;</span>
<a href="#l2.6"></a><span id="l2.6">     let composeWindow = event.target;</span>
<a href="#l2.7"></a><span id="l2.7"> </span>
<a href="#l2.8"></a><span id="l2.8">     composeWindow.ToggleWindowLock(true);</span>
<a href="#l2.9"></a><span id="l2.9"> </span>
<a href="#l2.10"></a><span id="l2.10">     let results = await this.emit(</span>
<a href="#l2.11"></a><span id="l2.11">       &quot;compose-before-send&quot;,</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-      tabTracker.getId(composeWindow),</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+      composeWindow,</span>
<a href="#l2.14"></a><span id="l2.14">       getComposeDetails(composeWindow)</span>
<a href="#l2.15"></a><span id="l2.15">     );</span>
<a href="#l2.16"></a><span id="l2.16">     if (results) {</span>
<a href="#l2.17"></a><span id="l2.17">       for (let result of results) {</span>
<a href="#l2.18"></a><span id="l2.18">         if (!result) {</span>
<a href="#l2.19"></a><span id="l2.19">           continue;</span>
<a href="#l2.20"></a><span id="l2.20">         }</span>
<a href="#l2.21"></a><span id="l2.21">         if (result.cancel) {</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineat">@@ -218,25 +218,29 @@ this.compose = class extends ExtensionAP</span>
<a href="#l2.23"></a><span id="l2.23">         &quot;chrome://messenger/content/messengercompose/messengercompose.xhtml&quot;</span>
<a href="#l2.24"></a><span id="l2.24">       ) {</span>
<a href="#l2.25"></a><span id="l2.25">         throw new ExtensionError(`Not a valid compose window: ${location}`);</span>
<a href="#l2.26"></a><span id="l2.26">       }</span>
<a href="#l2.27"></a><span id="l2.27">       return tab;</span>
<a href="#l2.28"></a><span id="l2.28">     }</span>
<a href="#l2.29"></a><span id="l2.29"> </span>
<a href="#l2.30"></a><span id="l2.30">     let { extension } = context;</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineminus">-    let { tabManager } = extension;</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineplus">+    let { tabManager, windowManager } = extension;</span>
<a href="#l2.33"></a><span id="l2.33">     return {</span>
<a href="#l2.34"></a><span id="l2.34">       compose: {</span>
<a href="#l2.35"></a><span id="l2.35">         onBeforeSend: new EventManager({</span>
<a href="#l2.36"></a><span id="l2.36">           context,</span>
<a href="#l2.37"></a><span id="l2.37">           name: &quot;compose.onBeforeSend&quot;,</span>
<a href="#l2.38"></a><span id="l2.38">           register: fire =&gt; {</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineminus">-            let listener = (event, tabId, details) =&gt; {</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineminus">-              return fire.async(tabId, details);</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineplus">+            let listener = (event, window, details) =&gt; {</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineplus">+              let win = windowManager.wrapWindow(window);</span>
<a href="#l2.43"></a><span id="l2.43" class="difflineplus">+              return fire.async(</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineplus">+                tabManager.convert(win.activeTab.nativeTab),</span>
<a href="#l2.45"></a><span id="l2.45" class="difflineplus">+                details</span>
<a href="#l2.46"></a><span id="l2.46" class="difflineplus">+              );</span>
<a href="#l2.47"></a><span id="l2.47">             };</span>
<a href="#l2.48"></a><span id="l2.48"> </span>
<a href="#l2.49"></a><span id="l2.49">             composeEventTracker.on(&quot;compose-before-send&quot;, listener);</span>
<a href="#l2.50"></a><span id="l2.50">             return () =&gt; {</span>
<a href="#l2.51"></a><span id="l2.51">               composeEventTracker.off(&quot;compose-before-send&quot;, listener);</span>
<a href="#l2.52"></a><span id="l2.52">             };</span>
<a href="#l2.53"></a><span id="l2.53">           },</span>
<a href="#l2.54"></a><span id="l2.54">         }).api(),</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/components/extensions/parent/ext-composeAction.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/components/extensions/parent/ext-composeAction.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -60,33 +60,9 @@ this.composeAction = class extends Toolb</span>
<a href="#l3.4"></a><span id="l3.4">       Services.xulStore.setValue(</span>
<a href="#l3.5"></a><span id="l3.5">         windowURL,</span>
<a href="#l3.6"></a><span id="l3.6">         &quot;composeToolbar2&quot;,</span>
<a href="#l3.7"></a><span id="l3.7">         &quot;currentset&quot;,</span>
<a href="#l3.8"></a><span id="l3.8">         currentSet.join(&quot;,&quot;)</span>
<a href="#l3.9"></a><span id="l3.9">       );</span>
<a href="#l3.10"></a><span id="l3.10">     }</span>
<a href="#l3.11"></a><span id="l3.11">   }</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-  getAPI(context) {</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineminus">-    let { extension } = context;</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineminus">-    let { windowManager } = extension;</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineminus">-</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineminus">-    let action = this;</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineminus">-    let api = super.getAPI(context);</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineminus">-    api.composeAction.onClicked = new EventManager({</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineminus">-      context,</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineminus">-      name: &quot;composeAction.onClicked&quot;,</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineminus">-      inputHandling: true,</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineminus">-      register: fire =&gt; {</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineminus">-        let listener = (event, window) =&gt; {</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineminus">-          let win = windowManager.wrapWindow(window);</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineminus">-          fire.sync(win.activeTab.id);</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineminus">-        };</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineminus">-        action.on(&quot;click&quot;, listener);</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineminus">-        return () =&gt; {</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineminus">-          action.off(&quot;click&quot;, listener);</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineminus">-        };</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineminus">-      },</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineminus">-    }).api();</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineminus">-    return api;</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineminus">-  }</span>
<a href="#l3.36"></a><span id="l3.36"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mail/components/extensions/parent/ext-messageDisplayAction.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mail/components/extensions/parent/ext-messageDisplayAction.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -43,35 +43,11 @@ this.messageDisplayAction = class extend</span>
<a href="#l4.4"></a><span id="l4.4">   }</span>
<a href="#l4.5"></a><span id="l4.5"> </span>
<a href="#l4.6"></a><span id="l4.6">   makeButton(window) {</span>
<a href="#l4.7"></a><span id="l4.7">     let button = super.makeButton(window);</span>
<a href="#l4.8"></a><span id="l4.8">     button.classList.add(&quot;msgHeaderView-button&quot;);</span>
<a href="#l4.9"></a><span id="l4.9">     button.style.listStyleImage = &quot;var(--webextension-menupanel-image)&quot;;</span>
<a href="#l4.10"></a><span id="l4.10">     return button;</span>
<a href="#l4.11"></a><span id="l4.11">   }</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineminus">-  getAPI(context) {</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineminus">-    let { extension } = context;</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineminus">-    let { windowManager } = extension;</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineminus">-</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineminus">-    let action = this;</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineminus">-    let api = super.getAPI(context);</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineminus">-    api[this.manifestName].onClicked = new EventManager({</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineminus">-      context,</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineminus">-      name: `${this.manifestName}.onClicked`,</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineminus">-      inputHandling: true,</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineminus">-      register: fire =&gt; {</span>
<a href="#l4.24"></a><span id="l4.24" class="difflineminus">-        let listener = (event, window) =&gt; {</span>
<a href="#l4.25"></a><span id="l4.25" class="difflineminus">-          let win = windowManager.wrapWindow(window);</span>
<a href="#l4.26"></a><span id="l4.26" class="difflineminus">-          fire.sync(win.activeTab.id);</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineminus">-        };</span>
<a href="#l4.28"></a><span id="l4.28" class="difflineminus">-        action.on(&quot;click&quot;, listener);</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineminus">-        return () =&gt; {</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineminus">-          action.off(&quot;click&quot;, listener);</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineminus">-        };</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineminus">-      },</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineminus">-    }).api();</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineminus">-    return api;</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineminus">-  }</span>
<a href="#l4.36"></a><span id="l4.36"> };</span>
<a href="#l4.37"></a><span id="l4.37"> </span>
<a href="#l4.38"></a><span id="l4.38"> global.messageDisplayActionFor = this.messageDisplayAction.for;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mail/components/extensions/schemas/browserAction.json</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mail/components/extensions/schemas/browserAction.json</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -85,16 +85,36 @@</span>
<a href="#l5.4"></a><span id="l5.4">       },</span>
<a href="#l5.5"></a><span id="l5.5">       {</span>
<a href="#l5.6"></a><span id="l5.6">         &quot;id&quot;: &quot;ImageDataType&quot;,</span>
<a href="#l5.7"></a><span id="l5.7">         &quot;type&quot;: &quot;object&quot;,</span>
<a href="#l5.8"></a><span id="l5.8">         &quot;isInstanceOf&quot;: &quot;ImageData&quot;,</span>
<a href="#l5.9"></a><span id="l5.9">         &quot;additionalProperties&quot;: { &quot;type&quot;: &quot;any&quot; },</span>
<a href="#l5.10"></a><span id="l5.10">         &quot;postprocess&quot;: &quot;convertImageDataToURL&quot;,</span>
<a href="#l5.11"></a><span id="l5.11">         &quot;description&quot;: &quot;Pixel data for an image. Must be an ImageData object (for example, from a &lt;code&gt;canvas&lt;/code&gt; element).&quot;</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+      },</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+      {</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+        &quot;id&quot;: &quot;OnClickData&quot;,</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineplus">+        &quot;type&quot;: &quot;object&quot;,</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineplus">+        &quot;description&quot;: &quot;Information sent when a browser action is clicked.&quot;,</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineplus">+        &quot;properties&quot;: {</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineplus">+          &quot;modifiers&quot;: {</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineplus">+            &quot;type&quot;: &quot;array&quot;,</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineplus">+            &quot;items&quot;: {</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineplus">+              &quot;type&quot;: &quot;string&quot;,</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineplus">+              &quot;enum&quot;: [&quot;Shift&quot;, &quot;Alt&quot;, &quot;Command&quot;, &quot;Ctrl&quot;, &quot;MacCtrl&quot;]</span>
<a href="#l5.23"></a><span id="l5.23" class="difflineplus">+            },</span>
<a href="#l5.24"></a><span id="l5.24" class="difflineplus">+            &quot;description&quot;: &quot;An array of keyboard modifiers that were held while the menu item was clicked.&quot;</span>
<a href="#l5.25"></a><span id="l5.25" class="difflineplus">+          },</span>
<a href="#l5.26"></a><span id="l5.26" class="difflineplus">+          &quot;button&quot;: {</span>
<a href="#l5.27"></a><span id="l5.27" class="difflineplus">+            &quot;type&quot;: &quot;integer&quot;,</span>
<a href="#l5.28"></a><span id="l5.28" class="difflineplus">+            &quot;optional&quot;: true,</span>
<a href="#l5.29"></a><span id="l5.29" class="difflineplus">+            &quot;description&quot;: &quot;An integer value of button by which menu item was clicked.&quot;</span>
<a href="#l5.30"></a><span id="l5.30" class="difflineplus">+          }</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineplus">+        }</span>
<a href="#l5.32"></a><span id="l5.32">       }</span>
<a href="#l5.33"></a><span id="l5.33">     ],</span>
<a href="#l5.34"></a><span id="l5.34">     &quot;functions&quot;: [</span>
<a href="#l5.35"></a><span id="l5.35">       {</span>
<a href="#l5.36"></a><span id="l5.36">         &quot;name&quot;: &quot;setTitle&quot;,</span>
<a href="#l5.37"></a><span id="l5.37">         &quot;type&quot;: &quot;function&quot;,</span>
<a href="#l5.38"></a><span id="l5.38">         &quot;description&quot;: &quot;Sets the title of the toolbar action. This shows up in the tooltip.&quot;,</span>
<a href="#l5.39"></a><span id="l5.39">         &quot;async&quot;: &quot;callback&quot;,</span>
<a href="#l5.40"></a><span id="l5.40" class="difflineat">@@ -405,13 +425,22 @@</span>
<a href="#l5.41"></a><span id="l5.41">       }</span>
<a href="#l5.42"></a><span id="l5.42">     ],</span>
<a href="#l5.43"></a><span id="l5.43">     &quot;events&quot;: [</span>
<a href="#l5.44"></a><span id="l5.44">       {</span>
<a href="#l5.45"></a><span id="l5.45">         &quot;name&quot;: &quot;onClicked&quot;,</span>
<a href="#l5.46"></a><span id="l5.46">         &quot;type&quot;: &quot;function&quot;,</span>
<a href="#l5.47"></a><span id="l5.47">         &quot;description&quot;: &quot;Fired when a toolbar action icon is clicked.  This event will not fire if the toolbar action has a popup.&quot;,</span>
<a href="#l5.48"></a><span id="l5.48">         &quot;parameters&quot;: [</span>
<a href="#l5.49"></a><span id="l5.49" class="difflineplus">+          {</span>
<a href="#l5.50"></a><span id="l5.50" class="difflineplus">+            &quot;name&quot;: &quot;tab&quot;,</span>
<a href="#l5.51"></a><span id="l5.51" class="difflineplus">+            &quot;$ref&quot;: &quot;tabs.Tab&quot;</span>
<a href="#l5.52"></a><span id="l5.52" class="difflineplus">+          },</span>
<a href="#l5.53"></a><span id="l5.53" class="difflineplus">+          {</span>
<a href="#l5.54"></a><span id="l5.54" class="difflineplus">+            &quot;name&quot;: &quot;info&quot;,</span>
<a href="#l5.55"></a><span id="l5.55" class="difflineplus">+            &quot;$ref&quot;: &quot;OnClickData&quot;,</span>
<a href="#l5.56"></a><span id="l5.56" class="difflineplus">+            &quot;optional&quot;: true</span>
<a href="#l5.57"></a><span id="l5.57" class="difflineplus">+          }</span>
<a href="#l5.58"></a><span id="l5.58">         ]</span>
<a href="#l5.59"></a><span id="l5.59">       }</span>
<a href="#l5.60"></a><span id="l5.60">     ]</span>
<a href="#l5.61"></a><span id="l5.61">   }</span>
<a href="#l5.62"></a><span id="l5.62"> ]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mail/components/extensions/schemas/compose.json</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mail/components/extensions/schemas/compose.json</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -116,19 +116,18 @@</span>
<a href="#l6.4"></a><span id="l6.4">         &quot;name&quot;: &quot;onBeforeSend&quot;,</span>
<a href="#l6.5"></a><span id="l6.5">         &quot;type&quot;: &quot;function&quot;,</span>
<a href="#l6.6"></a><span id="l6.6">         &quot;description&quot;: &quot;Fired when a message is about to be sent from the compose window.&quot;,</span>
<a href="#l6.7"></a><span id="l6.7">         &quot;permissions&quot;: [</span>
<a href="#l6.8"></a><span id="l6.8">           &quot;compose&quot;</span>
<a href="#l6.9"></a><span id="l6.9">         ],</span>
<a href="#l6.10"></a><span id="l6.10">         &quot;parameters&quot;: [</span>
<a href="#l6.11"></a><span id="l6.11">           {</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-            &quot;type&quot;: &quot;integer&quot;,</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">-            &quot;name&quot;: &quot;tabId&quot;,</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineminus">-            &quot;minimum&quot;: 0</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineplus">+            &quot;name&quot;: &quot;tab&quot;,</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineplus">+            &quot;$ref&quot;: &quot;tabs.Tab&quot;</span>
<a href="#l6.17"></a><span id="l6.17">           },</span>
<a href="#l6.18"></a><span id="l6.18">           {</span>
<a href="#l6.19"></a><span id="l6.19">             &quot;name&quot;: &quot;details&quot;,</span>
<a href="#l6.20"></a><span id="l6.20">             &quot;$ref&quot;: &quot;ComposeDetails&quot;,</span>
<a href="#l6.21"></a><span id="l6.21">             &quot;description&quot;: &quot;The current state of the compose window. This is functionally the same as the :ref:`compose.getComposeDetails` function.&quot;</span>
<a href="#l6.22"></a><span id="l6.22">           }</span>
<a href="#l6.23"></a><span id="l6.23">         ],</span>
<a href="#l6.24"></a><span id="l6.24">         &quot;returns&quot;: {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mail/components/extensions/schemas/composeAction.json</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mail/components/extensions/schemas/composeAction.json</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -86,16 +86,36 @@</span>
<a href="#l7.4"></a><span id="l7.4">       },</span>
<a href="#l7.5"></a><span id="l7.5">       {</span>
<a href="#l7.6"></a><span id="l7.6">         &quot;id&quot;: &quot;ImageDataType&quot;,</span>
<a href="#l7.7"></a><span id="l7.7">         &quot;type&quot;: &quot;object&quot;,</span>
<a href="#l7.8"></a><span id="l7.8">         &quot;isInstanceOf&quot;: &quot;ImageData&quot;,</span>
<a href="#l7.9"></a><span id="l7.9">         &quot;additionalProperties&quot;: { &quot;type&quot;: &quot;any&quot; },</span>
<a href="#l7.10"></a><span id="l7.10">         &quot;postprocess&quot;: &quot;convertImageDataToURL&quot;,</span>
<a href="#l7.11"></a><span id="l7.11">         &quot;description&quot;: &quot;Pixel data for an image. Must be an ImageData object (for example, from a &lt;code&gt;canvas&lt;/code&gt; element).&quot;</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineplus">+      },</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+      {</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+        &quot;id&quot;: &quot;OnClickData&quot;,</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+        &quot;type&quot;: &quot;object&quot;,</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineplus">+        &quot;description&quot;: &quot;Information sent when a compose action is clicked.&quot;,</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineplus">+        &quot;properties&quot;: {</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineplus">+          &quot;modifiers&quot;: {</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineplus">+            &quot;type&quot;: &quot;array&quot;,</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineplus">+            &quot;items&quot;: {</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineplus">+              &quot;type&quot;: &quot;string&quot;,</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineplus">+              &quot;enum&quot;: [&quot;Shift&quot;, &quot;Alt&quot;, &quot;Command&quot;, &quot;Ctrl&quot;, &quot;MacCtrl&quot;]</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineplus">+            },</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineplus">+            &quot;description&quot;: &quot;An array of keyboard modifiers that were held while the menu item was clicked.&quot;</span>
<a href="#l7.25"></a><span id="l7.25" class="difflineplus">+          },</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineplus">+          &quot;button&quot;: {</span>
<a href="#l7.27"></a><span id="l7.27" class="difflineplus">+            &quot;type&quot;: &quot;integer&quot;,</span>
<a href="#l7.28"></a><span id="l7.28" class="difflineplus">+            &quot;optional&quot;: true,</span>
<a href="#l7.29"></a><span id="l7.29" class="difflineplus">+            &quot;description&quot;: &quot;An integer value of button by which menu item was clicked.&quot;</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineplus">+          }</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineplus">+        }</span>
<a href="#l7.32"></a><span id="l7.32">       }</span>
<a href="#l7.33"></a><span id="l7.33">     ],</span>
<a href="#l7.34"></a><span id="l7.34">     &quot;functions&quot;: [</span>
<a href="#l7.35"></a><span id="l7.35">       {</span>
<a href="#l7.36"></a><span id="l7.36">         &quot;name&quot;: &quot;setTitle&quot;,</span>
<a href="#l7.37"></a><span id="l7.37">         &quot;type&quot;: &quot;function&quot;,</span>
<a href="#l7.38"></a><span id="l7.38">         &quot;description&quot;: &quot;Sets the title of the toolbar action. This shows up in the tooltip.&quot;,</span>
<a href="#l7.39"></a><span id="l7.39">         &quot;async&quot;: &quot;callback&quot;,</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineat">@@ -407,17 +427,21 @@</span>
<a href="#l7.41"></a><span id="l7.41">     ],</span>
<a href="#l7.42"></a><span id="l7.42">     &quot;events&quot;: [</span>
<a href="#l7.43"></a><span id="l7.43">       {</span>
<a href="#l7.44"></a><span id="l7.44">         &quot;name&quot;: &quot;onClicked&quot;,</span>
<a href="#l7.45"></a><span id="l7.45">         &quot;type&quot;: &quot;function&quot;,</span>
<a href="#l7.46"></a><span id="l7.46">         &quot;description&quot;: &quot;Fired when a toolbar action icon is clicked.  This event will not fire if the toolbar action has a popup.&quot;,</span>
<a href="#l7.47"></a><span id="l7.47">         &quot;parameters&quot;: [</span>
<a href="#l7.48"></a><span id="l7.48">           {</span>
<a href="#l7.49"></a><span id="l7.49" class="difflineminus">-            &quot;name&quot;: &quot;tabId&quot;,</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineminus">-            &quot;type&quot;: &quot;integer&quot;,</span>
<a href="#l7.51"></a><span id="l7.51" class="difflineminus">-            &quot;minimum&quot;: 1</span>
<a href="#l7.52"></a><span id="l7.52" class="difflineplus">+            &quot;name&quot;: &quot;tab&quot;,</span>
<a href="#l7.53"></a><span id="l7.53" class="difflineplus">+            &quot;$ref&quot;: &quot;tabs.Tab&quot;</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineplus">+          },</span>
<a href="#l7.55"></a><span id="l7.55" class="difflineplus">+          {</span>
<a href="#l7.56"></a><span id="l7.56" class="difflineplus">+            &quot;name&quot;: &quot;info&quot;,</span>
<a href="#l7.57"></a><span id="l7.57" class="difflineplus">+            &quot;$ref&quot;: &quot;OnClickData&quot;,</span>
<a href="#l7.58"></a><span id="l7.58" class="difflineplus">+            &quot;optional&quot;: true</span>
<a href="#l7.59"></a><span id="l7.59">           }</span>
<a href="#l7.60"></a><span id="l7.60">         ]</span>
<a href="#l7.61"></a><span id="l7.61">       }</span>
<a href="#l7.62"></a><span id="l7.62">     ]</span>
<a href="#l7.63"></a><span id="l7.63">   }</span>
<a href="#l7.64"></a><span id="l7.64"> ]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mail/components/extensions/schemas/messageDisplayAction.json</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mail/components/extensions/schemas/messageDisplayAction.json</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -45,17 +45,17 @@</span>
<a href="#l8.4"></a><span id="l8.4">             &quot;optional&quot;: true</span>
<a href="#l8.5"></a><span id="l8.5">           }</span>
<a href="#l8.6"></a><span id="l8.6">         }</span>
<a href="#l8.7"></a><span id="l8.7">       }</span>
<a href="#l8.8"></a><span id="l8.8">     ]</span>
<a href="#l8.9"></a><span id="l8.9">   },</span>
<a href="#l8.10"></a><span id="l8.10">   {</span>
<a href="#l8.11"></a><span id="l8.11">     &quot;namespace&quot;: &quot;messageDisplayAction&quot;,</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-    &quot;description&quot;: &quot;Use toolbar actions to put icons in the mail window toolbar. In addition to its icon, a toolbar action can also have a tooltip, a badge, and a popup. This namespace is called browserAction for compatibility with browser WebExtensions.&quot;,</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+    &quot;description&quot;: &quot;Use toolbar actions to put icons in the message display toolbar. In addition to its icon, a toolbar action can also have a tooltip, a badge, and a popup.&quot;,</span>
<a href="#l8.14"></a><span id="l8.14">     &quot;permissions&quot;: [&quot;manifest:message_display_action&quot;],</span>
<a href="#l8.15"></a><span id="l8.15">     &quot;types&quot;: [</span>
<a href="#l8.16"></a><span id="l8.16">       {</span>
<a href="#l8.17"></a><span id="l8.17">         &quot;id&quot;: &quot;Details&quot;,</span>
<a href="#l8.18"></a><span id="l8.18">         &quot;type&quot;: &quot;object&quot;,</span>
<a href="#l8.19"></a><span id="l8.19">         &quot;description&quot;: &quot;Specifies to which tab or window the value should be set, or from which one it should be retrieved. If no tab nor window is specified, the global value is set or retrieved.&quot;,</span>
<a href="#l8.20"></a><span id="l8.20">         &quot;properties&quot;: {</span>
<a href="#l8.21"></a><span id="l8.21">           &quot;tabId&quot;: {</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineat">@@ -85,16 +85,36 @@</span>
<a href="#l8.23"></a><span id="l8.23">       },</span>
<a href="#l8.24"></a><span id="l8.24">       {</span>
<a href="#l8.25"></a><span id="l8.25">         &quot;id&quot;: &quot;ImageDataType&quot;,</span>
<a href="#l8.26"></a><span id="l8.26">         &quot;type&quot;: &quot;object&quot;,</span>
<a href="#l8.27"></a><span id="l8.27">         &quot;isInstanceOf&quot;: &quot;ImageData&quot;,</span>
<a href="#l8.28"></a><span id="l8.28">         &quot;additionalProperties&quot;: { &quot;type&quot;: &quot;any&quot; },</span>
<a href="#l8.29"></a><span id="l8.29">         &quot;postprocess&quot;: &quot;convertImageDataToURL&quot;,</span>
<a href="#l8.30"></a><span id="l8.30">         &quot;description&quot;: &quot;Pixel data for an image. Must be an ImageData object (for example, from a &lt;code&gt;canvas&lt;/code&gt; element).&quot;</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineplus">+      },</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineplus">+      {</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineplus">+        &quot;id&quot;: &quot;OnClickData&quot;,</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineplus">+        &quot;type&quot;: &quot;object&quot;,</span>
<a href="#l8.35"></a><span id="l8.35" class="difflineplus">+        &quot;description&quot;: &quot;Information sent when a message display action is clicked.&quot;,</span>
<a href="#l8.36"></a><span id="l8.36" class="difflineplus">+        &quot;properties&quot;: {</span>
<a href="#l8.37"></a><span id="l8.37" class="difflineplus">+          &quot;modifiers&quot;: {</span>
<a href="#l8.38"></a><span id="l8.38" class="difflineplus">+            &quot;type&quot;: &quot;array&quot;,</span>
<a href="#l8.39"></a><span id="l8.39" class="difflineplus">+            &quot;items&quot;: {</span>
<a href="#l8.40"></a><span id="l8.40" class="difflineplus">+              &quot;type&quot;: &quot;string&quot;,</span>
<a href="#l8.41"></a><span id="l8.41" class="difflineplus">+              &quot;enum&quot;: [&quot;Shift&quot;, &quot;Alt&quot;, &quot;Command&quot;, &quot;Ctrl&quot;, &quot;MacCtrl&quot;]</span>
<a href="#l8.42"></a><span id="l8.42" class="difflineplus">+            },</span>
<a href="#l8.43"></a><span id="l8.43" class="difflineplus">+            &quot;description&quot;: &quot;An array of keyboard modifiers that were held while the menu item was clicked.&quot;</span>
<a href="#l8.44"></a><span id="l8.44" class="difflineplus">+          },</span>
<a href="#l8.45"></a><span id="l8.45" class="difflineplus">+          &quot;button&quot;: {</span>
<a href="#l8.46"></a><span id="l8.46" class="difflineplus">+            &quot;type&quot;: &quot;integer&quot;,</span>
<a href="#l8.47"></a><span id="l8.47" class="difflineplus">+            &quot;optional&quot;: true,</span>
<a href="#l8.48"></a><span id="l8.48" class="difflineplus">+            &quot;description&quot;: &quot;An integer value of button by which menu item was clicked.&quot;</span>
<a href="#l8.49"></a><span id="l8.49" class="difflineplus">+          }</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineplus">+        }</span>
<a href="#l8.51"></a><span id="l8.51">       }</span>
<a href="#l8.52"></a><span id="l8.52">     ],</span>
<a href="#l8.53"></a><span id="l8.53">     &quot;functions&quot;: [</span>
<a href="#l8.54"></a><span id="l8.54">       {</span>
<a href="#l8.55"></a><span id="l8.55">         &quot;name&quot;: &quot;setTitle&quot;,</span>
<a href="#l8.56"></a><span id="l8.56">         &quot;type&quot;: &quot;function&quot;,</span>
<a href="#l8.57"></a><span id="l8.57">         &quot;description&quot;: &quot;Sets the title of the toolbar action. This shows up in the tooltip.&quot;,</span>
<a href="#l8.58"></a><span id="l8.58">         &quot;async&quot;: &quot;callback&quot;,</span>
<a href="#l8.59"></a><span id="l8.59" class="difflineat">@@ -406,17 +426,21 @@</span>
<a href="#l8.60"></a><span id="l8.60">     ],</span>
<a href="#l8.61"></a><span id="l8.61">     &quot;events&quot;: [</span>
<a href="#l8.62"></a><span id="l8.62">       {</span>
<a href="#l8.63"></a><span id="l8.63">         &quot;name&quot;: &quot;onClicked&quot;,</span>
<a href="#l8.64"></a><span id="l8.64">         &quot;type&quot;: &quot;function&quot;,</span>
<a href="#l8.65"></a><span id="l8.65">         &quot;description&quot;: &quot;Fired when a toolbar action icon is clicked.  This event will not fire if the toolbar action has a popup.&quot;,</span>
<a href="#l8.66"></a><span id="l8.66">         &quot;parameters&quot;: [</span>
<a href="#l8.67"></a><span id="l8.67">           {</span>
<a href="#l8.68"></a><span id="l8.68" class="difflineminus">-            &quot;name&quot;: &quot;tabId&quot;,</span>
<a href="#l8.69"></a><span id="l8.69" class="difflineminus">-            &quot;type&quot;: &quot;integer&quot;,</span>
<a href="#l8.70"></a><span id="l8.70" class="difflineminus">-            &quot;minimum&quot;: 1</span>
<a href="#l8.71"></a><span id="l8.71" class="difflineplus">+            &quot;name&quot;: &quot;tab&quot;,</span>
<a href="#l8.72"></a><span id="l8.72" class="difflineplus">+            &quot;$ref&quot;: &quot;tabs.Tab&quot;</span>
<a href="#l8.73"></a><span id="l8.73" class="difflineplus">+          },</span>
<a href="#l8.74"></a><span id="l8.74" class="difflineplus">+          {</span>
<a href="#l8.75"></a><span id="l8.75" class="difflineplus">+            &quot;name&quot;: &quot;info&quot;,</span>
<a href="#l8.76"></a><span id="l8.76" class="difflineplus">+            &quot;$ref&quot;: &quot;OnClickData&quot;,</span>
<a href="#l8.77"></a><span id="l8.77" class="difflineplus">+            &quot;optional&quot;: true</span>
<a href="#l8.78"></a><span id="l8.78">           }</span>
<a href="#l8.79"></a><span id="l8.79">         ]</span>
<a href="#l8.80"></a><span id="l8.80">       }</span>
<a href="#l8.81"></a><span id="l8.81">     ]</span>
<a href="#l8.82"></a><span id="l8.82">   }</span>
<a href="#l8.83"></a><span id="l8.83"> ]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mail/components/extensions/test/browser/browser_ext_browserAction.js</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mail/components/extensions/test/browser/browser_ext_browserAction.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -61,17 +61,23 @@ add_task(async () =&gt; {</span>
<a href="#l9.4"></a><span id="l9.4">         .getValue(location.href, &quot;mail-bar3&quot;, &quot;currentset&quot;)</span>
<a href="#l9.5"></a><span id="l9.5">         .split(&quot;,&quot;)</span>
<a href="#l9.6"></a><span id="l9.6">         .includes(buttonId),</span>
<a href="#l9.7"></a><span id="l9.7">       &quot;Button removed from toolbar current set persistence&quot;</span>
<a href="#l9.8"></a><span id="l9.8">     );</span>
<a href="#l9.9"></a><span id="l9.9">   }</span>
<a href="#l9.10"></a><span id="l9.10"> </span>
<a href="#l9.11"></a><span id="l9.11">   async function background_nopopup() {</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-    browser.browserAction.onClicked.addListener(async () =&gt; {</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+    browser.browserAction.onClicked.addListener(async (tab, info) =&gt; {</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineplus">+      browser.test.assertEq(&quot;object&quot;, typeof tab);</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineplus">+      browser.test.assertEq(&quot;object&quot;, typeof info);</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineplus">+      browser.test.assertEq(0, info.button);</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineplus">+      browser.test.assertTrue(Array.isArray(info.modifiers));</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineplus">+      browser.test.assertEq(0, info.modifiers.length);</span>
<a href="#l9.19"></a><span id="l9.19" class="difflineplus">+      browser.test.log(`Tab ID is ${tab.id}`);</span>
<a href="#l9.20"></a><span id="l9.20">       await browser.browserAction.setTitle({ title: &quot;New title&quot; });</span>
<a href="#l9.21"></a><span id="l9.21">       browser.test.sendMessage(&quot;browserAction&quot;);</span>
<a href="#l9.22"></a><span id="l9.22">     });</span>
<a href="#l9.23"></a><span id="l9.23">   }</span>
<a href="#l9.24"></a><span id="l9.24"> </span>
<a href="#l9.25"></a><span id="l9.25">   async function background_popup() {</span>
<a href="#l9.26"></a><span id="l9.26">     browser.runtime.onMessage.addListener(async msg =&gt; {</span>
<a href="#l9.27"></a><span id="l9.27">       browser.test.assertEq(&quot;popup.html&quot;, msg);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mail/components/extensions/test/browser/browser_ext_composeAction.js</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mail/components/extensions/test/browser/browser_ext_composeAction.js</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -123,18 +123,23 @@ add_task(async function setup() {</span>
<a href="#l10.4"></a><span id="l10.4"> </span>
<a href="#l10.5"></a><span id="l10.5">   window.gFolderTreeView.selectFolder(rootFolder);</span>
<a href="#l10.6"></a><span id="l10.6">   await new Promise(resolve =&gt; executeSoon(resolve));</span>
<a href="#l10.7"></a><span id="l10.7"> });</span>
<a href="#l10.8"></a><span id="l10.8"> </span>
<a href="#l10.9"></a><span id="l10.9"> add_task(async function the_test() {</span>
<a href="#l10.10"></a><span id="l10.10">   async function background_nopopup() {</span>
<a href="#l10.11"></a><span id="l10.11">     browser.test.log(&quot;nopopup background script ran&quot;);</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-    browser.composeAction.onClicked.addListener(async tabId =&gt; {</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineminus">-      browser.test.log(`tabId is ${tabId}`);</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineplus">+    browser.composeAction.onClicked.addListener(async (tab, info) =&gt; {</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineplus">+      browser.test.assertEq(&quot;object&quot;, typeof tab);</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineplus">+      browser.test.assertEq(&quot;object&quot;, typeof info);</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineplus">+      browser.test.assertEq(0, info.button);</span>
<a href="#l10.18"></a><span id="l10.18" class="difflineplus">+      browser.test.assertTrue(Array.isArray(info.modifiers));</span>
<a href="#l10.19"></a><span id="l10.19" class="difflineplus">+      browser.test.assertEq(0, info.modifiers.length);</span>
<a href="#l10.20"></a><span id="l10.20" class="difflineplus">+      browser.test.log(`Tab ID is ${tab.id}`);</span>
<a href="#l10.21"></a><span id="l10.21">       await browser.composeAction.setTitle({ title: &quot;New title&quot; });</span>
<a href="#l10.22"></a><span id="l10.22">       await new Promise(setTimeout);</span>
<a href="#l10.23"></a><span id="l10.23">       browser.test.sendMessage(&quot;composeAction&quot;);</span>
<a href="#l10.24"></a><span id="l10.24">     });</span>
<a href="#l10.25"></a><span id="l10.25"> </span>
<a href="#l10.26"></a><span id="l10.26">     browser.test.sendMessage();</span>
<a href="#l10.27"></a><span id="l10.27">   }</span>
<a href="#l10.28"></a><span id="l10.28"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mail/components/extensions/test/browser/browser_ext_compose_onBeforeSend.js</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mail/components/extensions/test/browser/browser_ext_compose_onBeforeSend.js</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -70,65 +70,65 @@ add_task(async function testCancel() {</span>
<a href="#l11.4"></a><span id="l11.4">       let [tab] = await browser.tabs.query({ windowId: createdWindow.id });</span>
<a href="#l11.5"></a><span id="l11.5"> </span>
<a href="#l11.6"></a><span id="l11.6">       // Send the message. No listeners exist, so sending should continue.</span>
<a href="#l11.7"></a><span id="l11.7"> </span>
<a href="#l11.8"></a><span id="l11.8">       await beginSend(true);</span>
<a href="#l11.9"></a><span id="l11.9"> </span>
<a href="#l11.10"></a><span id="l11.10">       // Add a non-cancelling listener. Sending should continue.</span>
<a href="#l11.11"></a><span id="l11.11"> </span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-      let listener1 = tabId =&gt; {</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineminus">-        listener1.tabId = tabId;</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineplus">+      let listener1 = tab =&gt; {</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineplus">+        listener1.tab = tab;</span>
<a href="#l11.16"></a><span id="l11.16">         return {};</span>
<a href="#l11.17"></a><span id="l11.17">       };</span>
<a href="#l11.18"></a><span id="l11.18">       browser.compose.onBeforeSend.addListener(listener1);</span>
<a href="#l11.19"></a><span id="l11.19">       await beginSend(true);</span>
<a href="#l11.20"></a><span id="l11.20" class="difflineminus">-      browser.test.assertEq(tab.id, listener1.tabId, &quot;listener1 was fired&quot;);</span>
<a href="#l11.21"></a><span id="l11.21" class="difflineplus">+      browser.test.assertEq(tab.id, listener1.tab.id, &quot;listener1 was fired&quot;);</span>
<a href="#l11.22"></a><span id="l11.22">       browser.compose.onBeforeSend.removeListener(listener1);</span>
<a href="#l11.23"></a><span id="l11.23"> </span>
<a href="#l11.24"></a><span id="l11.24">       // Add a cancelling listener. Sending should not continue.</span>
<a href="#l11.25"></a><span id="l11.25"> </span>
<a href="#l11.26"></a><span id="l11.26" class="difflineminus">-      let listener2 = tabId =&gt; {</span>
<a href="#l11.27"></a><span id="l11.27" class="difflineminus">-        listener2.tabId = tabId;</span>
<a href="#l11.28"></a><span id="l11.28" class="difflineplus">+      let listener2 = tab =&gt; {</span>
<a href="#l11.29"></a><span id="l11.29" class="difflineplus">+        listener2.tab = tab;</span>
<a href="#l11.30"></a><span id="l11.30">         return { cancel: true };</span>
<a href="#l11.31"></a><span id="l11.31">       };</span>
<a href="#l11.32"></a><span id="l11.32">       browser.compose.onBeforeSend.addListener(listener2);</span>
<a href="#l11.33"></a><span id="l11.33">       await beginSend(false, false);</span>
<a href="#l11.34"></a><span id="l11.34" class="difflineminus">-      browser.test.assertEq(tab.id, listener2.tabId, &quot;listener2 was fired&quot;);</span>
<a href="#l11.35"></a><span id="l11.35" class="difflineplus">+      browser.test.assertEq(tab.id, listener2.tab.id, &quot;listener2 was fired&quot;);</span>
<a href="#l11.36"></a><span id="l11.36">       browser.compose.onBeforeSend.removeListener(listener2);</span>
<a href="#l11.37"></a><span id="l11.37">       await beginSend(true); // Removing the listener worked.</span>
<a href="#l11.38"></a><span id="l11.38"> </span>
<a href="#l11.39"></a><span id="l11.39">       // Add a listener returning a Promise. Resolve the Promise to unblock.</span>
<a href="#l11.40"></a><span id="l11.40">       // Sending should continue.</span>
<a href="#l11.41"></a><span id="l11.41"> </span>
<a href="#l11.42"></a><span id="l11.42" class="difflineminus">-      let listener3 = tabId =&gt; {</span>
<a href="#l11.43"></a><span id="l11.43" class="difflineminus">-        listener3.tabId = tabId;</span>
<a href="#l11.44"></a><span id="l11.44" class="difflineplus">+      let listener3 = tab =&gt; {</span>
<a href="#l11.45"></a><span id="l11.45" class="difflineplus">+        listener3.tab = tab;</span>
<a href="#l11.46"></a><span id="l11.46">         return new Promise(resolve =&gt; {</span>
<a href="#l11.47"></a><span id="l11.47">           listener3.resolve = resolve;</span>
<a href="#l11.48"></a><span id="l11.48">         });</span>
<a href="#l11.49"></a><span id="l11.49">       };</span>
<a href="#l11.50"></a><span id="l11.50">       browser.compose.onBeforeSend.addListener(listener3);</span>
<a href="#l11.51"></a><span id="l11.51">       await beginSend(false, true);</span>
<a href="#l11.52"></a><span id="l11.52" class="difflineminus">-      browser.test.assertEq(tab.id, listener3.tabId, &quot;listener3 was fired&quot;);</span>
<a href="#l11.53"></a><span id="l11.53" class="difflineplus">+      browser.test.assertEq(tab.id, listener3.tab.id, &quot;listener3 was fired&quot;);</span>
<a href="#l11.54"></a><span id="l11.54">       listener3.resolve({ cancel: false });</span>
<a href="#l11.55"></a><span id="l11.55">       await checkIfSent(true);</span>
<a href="#l11.56"></a><span id="l11.56">       browser.compose.onBeforeSend.removeListener(listener3);</span>
<a href="#l11.57"></a><span id="l11.57"> </span>
<a href="#l11.58"></a><span id="l11.58">       // Add a listener returning a Promise. Resolve the Promise to cancel.</span>
<a href="#l11.59"></a><span id="l11.59">       // Sending should not continue.</span>
<a href="#l11.60"></a><span id="l11.60"> </span>
<a href="#l11.61"></a><span id="l11.61" class="difflineminus">-      let listener4 = tabId =&gt; {</span>
<a href="#l11.62"></a><span id="l11.62" class="difflineminus">-        listener4.tabId = tabId;</span>
<a href="#l11.63"></a><span id="l11.63" class="difflineplus">+      let listener4 = tab =&gt; {</span>
<a href="#l11.64"></a><span id="l11.64" class="difflineplus">+        listener4.tab = tab;</span>
<a href="#l11.65"></a><span id="l11.65">         return new Promise(resolve =&gt; {</span>
<a href="#l11.66"></a><span id="l11.66">           listener4.resolve = resolve;</span>
<a href="#l11.67"></a><span id="l11.67">         });</span>
<a href="#l11.68"></a><span id="l11.68">       };</span>
<a href="#l11.69"></a><span id="l11.69">       browser.compose.onBeforeSend.addListener(listener4);</span>
<a href="#l11.70"></a><span id="l11.70">       await beginSend(false, true);</span>
<a href="#l11.71"></a><span id="l11.71" class="difflineminus">-      browser.test.assertEq(tab.id, listener4.tabId, &quot;listener4 was fired&quot;);</span>
<a href="#l11.72"></a><span id="l11.72" class="difflineplus">+      browser.test.assertEq(tab.id, listener4.tab.id, &quot;listener4 was fired&quot;);</span>
<a href="#l11.73"></a><span id="l11.73">       listener4.resolve({ cancel: true });</span>
<a href="#l11.74"></a><span id="l11.74">       await checkIfSent(false, false);</span>
<a href="#l11.75"></a><span id="l11.75">       browser.compose.onBeforeSend.removeListener(listener4);</span>
<a href="#l11.76"></a><span id="l11.76">       await beginSend(true); // Removing the listener worked.</span>
<a href="#l11.77"></a><span id="l11.77"> </span>
<a href="#l11.78"></a><span id="l11.78">       // Clean up.</span>
<a href="#l11.79"></a><span id="l11.79"> </span>
<a href="#l11.80"></a><span id="l11.80">       let removedWindowPromise = waitForEvent(&quot;onRemoved&quot;);</span>
<a href="#l11.81"></a><span id="l11.81" class="difflineat">@@ -239,30 +239,30 @@ add_task(async function testChangeDetail</span>
<a href="#l11.82"></a><span id="l11.82">       });</span>
<a href="#l11.83"></a><span id="l11.83">       let createdWindow = await createdWindowPromise;</span>
<a href="#l11.84"></a><span id="l11.84">       browser.test.assertEq(&quot;messageCompose&quot;, createdWindow.type);</span>
<a href="#l11.85"></a><span id="l11.85"> </span>
<a href="#l11.86"></a><span id="l11.86">       await checkWindow({ to: [&quot;test@test.invalid&quot;], subject: &quot;Test&quot; });</span>
<a href="#l11.87"></a><span id="l11.87"> </span>
<a href="#l11.88"></a><span id="l11.88">       let [tab] = await browser.tabs.query({ windowId: createdWindow.id });</span>
<a href="#l11.89"></a><span id="l11.89"> </span>
<a href="#l11.90"></a><span id="l11.90" class="difflineminus">-      let listener5 = (tabId, details) =&gt; {</span>
<a href="#l11.91"></a><span id="l11.91" class="difflineminus">-        listener5.tabId = tabId;</span>
<a href="#l11.92"></a><span id="l11.92" class="difflineplus">+      let listener5 = (tab, details) =&gt; {</span>
<a href="#l11.93"></a><span id="l11.93" class="difflineplus">+        listener5.tab = tab;</span>
<a href="#l11.94"></a><span id="l11.94">         listener5.details = details;</span>
<a href="#l11.95"></a><span id="l11.95">         return {</span>
<a href="#l11.96"></a><span id="l11.96">           details: {</span>
<a href="#l11.97"></a><span id="l11.97">             to: [&quot;to@test5.invalid&quot;],</span>
<a href="#l11.98"></a><span id="l11.98">             cc: [&quot;cc@test5.invalid&quot;],</span>
<a href="#l11.99"></a><span id="l11.99">             subject: &quot;Changed by listener5&quot;,</span>
<a href="#l11.100"></a><span id="l11.100">           },</span>
<a href="#l11.101"></a><span id="l11.101">         };</span>
<a href="#l11.102"></a><span id="l11.102">       };</span>
<a href="#l11.103"></a><span id="l11.103">       browser.compose.onBeforeSend.addListener(listener5);</span>
<a href="#l11.104"></a><span id="l11.104">       await beginSend();</span>
<a href="#l11.105"></a><span id="l11.105" class="difflineminus">-      browser.test.assertEq(tab.id, listener5.tabId, &quot;listener5 was fired&quot;);</span>
<a href="#l11.106"></a><span id="l11.106" class="difflineplus">+      browser.test.assertEq(tab.id, listener5.tab.id, &quot;listener5 was fired&quot;);</span>
<a href="#l11.107"></a><span id="l11.107">       browser.test.assertEq(1, listener5.details.to.length);</span>
<a href="#l11.108"></a><span id="l11.108">       browser.test.assertEq(</span>
<a href="#l11.109"></a><span id="l11.109">         &quot;test@test.invalid&quot;,</span>
<a href="#l11.110"></a><span id="l11.110">         listener5.details.to[0],</span>
<a href="#l11.111"></a><span id="l11.111">         &quot;listener5 recipient correct&quot;</span>
<a href="#l11.112"></a><span id="l11.112">       );</span>
<a href="#l11.113"></a><span id="l11.113">       browser.test.assertEq(</span>
<a href="#l11.114"></a><span id="l11.114">         &quot;Test&quot;,</span>
<a href="#l11.115"></a><span id="l11.115" class="difflineat">@@ -280,26 +280,26 @@ add_task(async function testChangeDetail</span>
<a href="#l11.116"></a><span id="l11.116">       });</span>
<a href="#l11.117"></a><span id="l11.117">       createdWindow = await createdWindowPromise;</span>
<a href="#l11.118"></a><span id="l11.118">       browser.test.assertEq(&quot;messageCompose&quot;, createdWindow.type);</span>
<a href="#l11.119"></a><span id="l11.119"> </span>
<a href="#l11.120"></a><span id="l11.120">       await checkWindow({ to: [&quot;test@test.invalid&quot;], subject: &quot;Test&quot; });</span>
<a href="#l11.121"></a><span id="l11.121"> </span>
<a href="#l11.122"></a><span id="l11.122">       [tab] = await browser.tabs.query({ windowId: createdWindow.id });</span>
<a href="#l11.123"></a><span id="l11.123"> </span>
<a href="#l11.124"></a><span id="l11.124" class="difflineminus">-      let listener6 = (tabId, details) =&gt; {</span>
<a href="#l11.125"></a><span id="l11.125" class="difflineminus">-        listener6.tabId = tabId;</span>
<a href="#l11.126"></a><span id="l11.126" class="difflineplus">+      let listener6 = (tab, details) =&gt; {</span>
<a href="#l11.127"></a><span id="l11.127" class="difflineplus">+        listener6.tab = tab;</span>
<a href="#l11.128"></a><span id="l11.128">         listener6.details = details;</span>
<a href="#l11.129"></a><span id="l11.129">         return new Promise(resolve =&gt; {</span>
<a href="#l11.130"></a><span id="l11.130">           listener6.resolve = resolve;</span>
<a href="#l11.131"></a><span id="l11.131">         });</span>
<a href="#l11.132"></a><span id="l11.132">       };</span>
<a href="#l11.133"></a><span id="l11.133">       browser.compose.onBeforeSend.addListener(listener6);</span>
<a href="#l11.134"></a><span id="l11.134">       await beginSend();</span>
<a href="#l11.135"></a><span id="l11.135" class="difflineminus">-      browser.test.assertEq(tab.id, listener6.tabId, &quot;listener6 was fired&quot;);</span>
<a href="#l11.136"></a><span id="l11.136" class="difflineplus">+      browser.test.assertEq(tab.id, listener6.tab.id, &quot;listener6 was fired&quot;);</span>
<a href="#l11.137"></a><span id="l11.137">       browser.test.assertEq(1, listener6.details.to.length);</span>
<a href="#l11.138"></a><span id="l11.138">       browser.test.assertEq(</span>
<a href="#l11.139"></a><span id="l11.139">         &quot;test@test.invalid&quot;,</span>
<a href="#l11.140"></a><span id="l11.140">         listener6.details.to[0],</span>
<a href="#l11.141"></a><span id="l11.141">         &quot;listener6 recipient correct&quot;</span>
<a href="#l11.142"></a><span id="l11.142">       );</span>
<a href="#l11.143"></a><span id="l11.143">       browser.test.assertEq(</span>
<a href="#l11.144"></a><span id="l11.144">         &quot;Test&quot;,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mail/components/extensions/test/browser/browser_ext_messageDisplayAction.js</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mail/components/extensions/test/browser/browser_ext_messageDisplayAction.js</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -67,18 +67,23 @@ add_task(async () =&gt; {</span>
<a href="#l12.4"></a><span id="l12.4">     await extension.unload();</span>
<a href="#l12.5"></a><span id="l12.5">     await promiseAnimationFrame(win);</span>
<a href="#l12.6"></a><span id="l12.6">     await new Promise(resolve =&gt; win.setTimeout(resolve));</span>
<a href="#l12.7"></a><span id="l12.7"> </span>
<a href="#l12.8"></a><span id="l12.8">     ok(!doc.getElementById(buttonId), &quot;Button destroyed&quot;);</span>
<a href="#l12.9"></a><span id="l12.9">   }</span>
<a href="#l12.10"></a><span id="l12.10"> </span>
<a href="#l12.11"></a><span id="l12.11">   async function background_nopopup() {</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-    browser.messageDisplayAction.onClicked.addListener(async tabId =&gt; {</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineminus">-      browser.test.log(`tabId is ${tabId}`);</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineplus">+    browser.messageDisplayAction.onClicked.addListener(async (tab, info) =&gt; {</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineplus">+      browser.test.assertEq(&quot;object&quot;, typeof tab);</span>
<a href="#l12.16"></a><span id="l12.16" class="difflineplus">+      browser.test.assertEq(&quot;object&quot;, typeof info);</span>
<a href="#l12.17"></a><span id="l12.17" class="difflineplus">+      browser.test.assertEq(0, info.button);</span>
<a href="#l12.18"></a><span id="l12.18" class="difflineplus">+      browser.test.assertTrue(Array.isArray(info.modifiers));</span>
<a href="#l12.19"></a><span id="l12.19" class="difflineplus">+      browser.test.assertEq(0, info.modifiers.length);</span>
<a href="#l12.20"></a><span id="l12.20" class="difflineplus">+      browser.test.log(`Tab ID is ${tab.id}`);</span>
<a href="#l12.21"></a><span id="l12.21">       await browser.messageDisplayAction.setTitle({ title: &quot;New title&quot; });</span>
<a href="#l12.22"></a><span id="l12.22">       browser.test.sendMessage(&quot;messageDisplayAction&quot;);</span>
<a href="#l12.23"></a><span id="l12.23">     });</span>
<a href="#l12.24"></a><span id="l12.24">   }</span>
<a href="#l12.25"></a><span id="l12.25"> </span>
<a href="#l12.26"></a><span id="l12.26">   async function background_popup() {</span>
<a href="#l12.27"></a><span id="l12.27">     browser.runtime.onMessage.addListener(async msg =&gt; {</span>
<a href="#l12.28"></a><span id="l12.28">       browser.test.assertEq(&quot;popup.html&quot;, msg);</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:33Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

