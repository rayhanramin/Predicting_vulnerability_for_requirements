<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 4365:12ceaa786d23d06d76eaf71e79d74ec4e7e712e6</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 12ceaa786d23d06d76eaf71e79d74ec4e7e712e6" />
<meta property="og:url" content="/comm-central/rev/12ceaa786d23d06d76eaf71e79d74ec4e7e712e6" />
<meta property="og:description" content="Bug 527687 - msgsClassified event may fire multiple times for a single message. r+sr=bienvenu, a=blocking-thunderbird3." />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 12ceaa786d23d06d76eaf71e79d74ec4e7e712e6 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/12ceaa786d23d06d76eaf71e79d74ec4e7e712e6">shortlog</a> |
<a href="/comm-central/log/12ceaa786d23d06d76eaf71e79d74ec4e7e712e6">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/12ceaa786d23d06d76eaf71e79d74ec4e7e712e6">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/12ceaa786d23d06d76eaf71e79d74ec4e7e712e6">files</a> |
changeset |
<a href="/comm-central/raw-rev/12ceaa786d23d06d76eaf71e79d74ec4e7e712e6">raw</a>  | <a href="/comm-central/archive/12ceaa786d23d06d76eaf71e79d74ec4e7e712e6.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=527687">Bug 527687</a> - msgsClassified event may fire multiple times for a single message. r+sr=bienvenu, a=blocking-thunderbird3.
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#65;&#110;&#100;&#114;&#101;&#119;&#32;&#83;&#117;&#116;&#104;&#101;&#114;&#108;&#97;&#110;&#100;&#32;&#60;&#97;&#115;&#117;&#116;&#104;&#101;&#114;&#108;&#97;&#110;&#100;&#64;&#97;&#115;&#117;&#116;&#104;&#101;&#114;&#108;&#97;&#110;&#100;&#46;&#111;&#114;&#103;&#62;</td></tr>
<tr><td></td><td class="date age">Tue, 10 Nov 2009 23:01:12 -0800</td></tr>

<tr>
 <td>changeset 4365</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/12ceaa786d23d06d76eaf71e79d74ec4e7e712e6">12ceaa786d23d06d76eaf71e79d74ec4e7e712e6</a></td>
</tr>



<tr>
<td>parent 4364</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/3249e23056336af61e246dab125dcfb5a056c163">3249e23056336af61e246dab125dcfb5a056c163</a>
</td>
</tr>

<tr>
<td>child 4366</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/8d6e1f1fd0a520aef802598d595181185885236a">8d6e1f1fd0a520aef802598d595181185885236a</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=12ceaa786d23d06d76eaf71e79d74ec4e7e712e6">3411</a></td></tr>
<tr><td>push user</td><td>bugmail@asutherland.org</td></tr>
<tr><td>push date</td><td class="date age">Wed, 11 Nov 2009 07:02:04 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@12ceaa786d23 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=12ceaa786d23d06d76eaf71e79d74ec4e7e712e6">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=12ceaa786d23d06d76eaf71e79d74ec4e7e712e6&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=12ceaa786d23d06d76eaf71e79d74ec4e7e712e6&newProject=comm-central&newRevision=12ceaa786d23d06d76eaf71e79d74ec4e7e712e6&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=12ceaa786d23d06d76eaf71e79d74ec4e7e712e6&newProject=comm-central&newRevision=12ceaa786d23d06d76eaf71e79d74ec4e7e712e6&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=12ceaa786d23d06d76eaf71e79d74ec4e7e712e6&newProject=comm-central&newRevision=12ceaa786d23d06d76eaf71e79d74ec4e7e712e6&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28blocking-thunderbird3%29&revcount=50">blocking-thunderbird3</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=527687">527687</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=527687">Bug 527687</a> - msgsClassified event may fire multiple times for a single message. r+sr=bienvenu, a=blocking-thunderbird3.</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/12ceaa786d23d06d76eaf71e79d74ec4e7e712e6/mailnews/base/public/nsIMsgFolderListener.idl">mailnews/base/public/nsIMsgFolderListener.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/12ceaa786d23d06d76eaf71e79d74ec4e7e712e6/mailnews/base/public/nsIMsgFolderListener.idl">file</a> |
<a href="/comm-central/annotate/12ceaa786d23d06d76eaf71e79d74ec4e7e712e6/mailnews/base/public/nsIMsgFolderListener.idl">annotate</a> |
<a href="/comm-central/diff/12ceaa786d23d06d76eaf71e79d74ec4e7e712e6/mailnews/base/public/nsIMsgFolderListener.idl">diff</a> |
<a href="/comm-central/comparison/12ceaa786d23d06d76eaf71e79d74ec4e7e712e6/mailnews/base/public/nsIMsgFolderListener.idl">comparison</a> |
<a href="/comm-central/log/12ceaa786d23d06d76eaf71e79d74ec4e7e712e6/mailnews/base/public/nsIMsgFolderListener.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/12ceaa786d23d06d76eaf71e79d74ec4e7e712e6/mailnews/base/public/nsMsgMessageFlags.idl">mailnews/base/public/nsMsgMessageFlags.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/12ceaa786d23d06d76eaf71e79d74ec4e7e712e6/mailnews/base/public/nsMsgMessageFlags.idl">file</a> |
<a href="/comm-central/annotate/12ceaa786d23d06d76eaf71e79d74ec4e7e712e6/mailnews/base/public/nsMsgMessageFlags.idl">annotate</a> |
<a href="/comm-central/diff/12ceaa786d23d06d76eaf71e79d74ec4e7e712e6/mailnews/base/public/nsMsgMessageFlags.idl">diff</a> |
<a href="/comm-central/comparison/12ceaa786d23d06d76eaf71e79d74ec4e7e712e6/mailnews/base/public/nsMsgMessageFlags.idl">comparison</a> |
<a href="/comm-central/log/12ceaa786d23d06d76eaf71e79d74ec4e7e712e6/mailnews/base/public/nsMsgMessageFlags.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/12ceaa786d23d06d76eaf71e79d74ec4e7e712e6/mailnews/base/util/nsMsgDBFolder.cpp">mailnews/base/util/nsMsgDBFolder.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/12ceaa786d23d06d76eaf71e79d74ec4e7e712e6/mailnews/base/util/nsMsgDBFolder.cpp">file</a> |
<a href="/comm-central/annotate/12ceaa786d23d06d76eaf71e79d74ec4e7e712e6/mailnews/base/util/nsMsgDBFolder.cpp">annotate</a> |
<a href="/comm-central/diff/12ceaa786d23d06d76eaf71e79d74ec4e7e712e6/mailnews/base/util/nsMsgDBFolder.cpp">diff</a> |
<a href="/comm-central/comparison/12ceaa786d23d06d76eaf71e79d74ec4e7e712e6/mailnews/base/util/nsMsgDBFolder.cpp">comparison</a> |
<a href="/comm-central/log/12ceaa786d23d06d76eaf71e79d74ec4e7e712e6/mailnews/base/util/nsMsgDBFolder.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/12ceaa786d23d06d76eaf71e79d74ec4e7e712e6/mailnews/base/util/nsMsgDBFolder.h">mailnews/base/util/nsMsgDBFolder.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/12ceaa786d23d06d76eaf71e79d74ec4e7e712e6/mailnews/base/util/nsMsgDBFolder.h">file</a> |
<a href="/comm-central/annotate/12ceaa786d23d06d76eaf71e79d74ec4e7e712e6/mailnews/base/util/nsMsgDBFolder.h">annotate</a> |
<a href="/comm-central/diff/12ceaa786d23d06d76eaf71e79d74ec4e7e712e6/mailnews/base/util/nsMsgDBFolder.h">diff</a> |
<a href="/comm-central/comparison/12ceaa786d23d06d76eaf71e79d74ec4e7e712e6/mailnews/base/util/nsMsgDBFolder.h">comparison</a> |
<a href="/comm-central/log/12ceaa786d23d06d76eaf71e79d74ec4e7e712e6/mailnews/base/util/nsMsgDBFolder.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/12ceaa786d23d06d76eaf71e79d74ec4e7e712e6/mailnews/imap/src/nsImapMailFolder.cpp">mailnews/imap/src/nsImapMailFolder.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/12ceaa786d23d06d76eaf71e79d74ec4e7e712e6/mailnews/imap/src/nsImapMailFolder.cpp">file</a> |
<a href="/comm-central/annotate/12ceaa786d23d06d76eaf71e79d74ec4e7e712e6/mailnews/imap/src/nsImapMailFolder.cpp">annotate</a> |
<a href="/comm-central/diff/12ceaa786d23d06d76eaf71e79d74ec4e7e712e6/mailnews/imap/src/nsImapMailFolder.cpp">diff</a> |
<a href="/comm-central/comparison/12ceaa786d23d06d76eaf71e79d74ec4e7e712e6/mailnews/imap/src/nsImapMailFolder.cpp">comparison</a> |
<a href="/comm-central/log/12ceaa786d23d06d76eaf71e79d74ec4e7e712e6/mailnews/imap/src/nsImapMailFolder.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/12ceaa786d23d06d76eaf71e79d74ec4e7e712e6/mailnews/local/src/nsLocalMailFolder.cpp">mailnews/local/src/nsLocalMailFolder.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/12ceaa786d23d06d76eaf71e79d74ec4e7e712e6/mailnews/local/src/nsLocalMailFolder.cpp">file</a> |
<a href="/comm-central/annotate/12ceaa786d23d06d76eaf71e79d74ec4e7e712e6/mailnews/local/src/nsLocalMailFolder.cpp">annotate</a> |
<a href="/comm-central/diff/12ceaa786d23d06d76eaf71e79d74ec4e7e712e6/mailnews/local/src/nsLocalMailFolder.cpp">diff</a> |
<a href="/comm-central/comparison/12ceaa786d23d06d76eaf71e79d74ec4e7e712e6/mailnews/local/src/nsLocalMailFolder.cpp">comparison</a> |
<a href="/comm-central/log/12ceaa786d23d06d76eaf71e79d74ec4e7e712e6/mailnews/local/src/nsLocalMailFolder.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/12ceaa786d23d06d76eaf71e79d74ec4e7e712e6/mailnews/local/src/nsParseMailbox.cpp">mailnews/local/src/nsParseMailbox.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/12ceaa786d23d06d76eaf71e79d74ec4e7e712e6/mailnews/local/src/nsParseMailbox.cpp">file</a> |
<a href="/comm-central/annotate/12ceaa786d23d06d76eaf71e79d74ec4e7e712e6/mailnews/local/src/nsParseMailbox.cpp">annotate</a> |
<a href="/comm-central/diff/12ceaa786d23d06d76eaf71e79d74ec4e7e712e6/mailnews/local/src/nsParseMailbox.cpp">diff</a> |
<a href="/comm-central/comparison/12ceaa786d23d06d76eaf71e79d74ec4e7e712e6/mailnews/local/src/nsParseMailbox.cpp">comparison</a> |
<a href="/comm-central/log/12ceaa786d23d06d76eaf71e79d74ec4e7e712e6/mailnews/local/src/nsParseMailbox.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/12ceaa786d23d06d76eaf71e79d74ec4e7e712e6/mailnews/local/src/nsPop3Sink.cpp">mailnews/local/src/nsPop3Sink.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/12ceaa786d23d06d76eaf71e79d74ec4e7e712e6/mailnews/local/src/nsPop3Sink.cpp">file</a> |
<a href="/comm-central/annotate/12ceaa786d23d06d76eaf71e79d74ec4e7e712e6/mailnews/local/src/nsPop3Sink.cpp">annotate</a> |
<a href="/comm-central/diff/12ceaa786d23d06d76eaf71e79d74ec4e7e712e6/mailnews/local/src/nsPop3Sink.cpp">diff</a> |
<a href="/comm-central/comparison/12ceaa786d23d06d76eaf71e79d74ec4e7e712e6/mailnews/local/src/nsPop3Sink.cpp">comparison</a> |
<a href="/comm-central/log/12ceaa786d23d06d76eaf71e79d74ec4e7e712e6/mailnews/local/src/nsPop3Sink.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/12ceaa786d23d06d76eaf71e79d74ec4e7e712e6/mailnews/news/src/nsNNTPNewsgroupList.cpp">mailnews/news/src/nsNNTPNewsgroupList.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/12ceaa786d23d06d76eaf71e79d74ec4e7e712e6/mailnews/news/src/nsNNTPNewsgroupList.cpp">file</a> |
<a href="/comm-central/annotate/12ceaa786d23d06d76eaf71e79d74ec4e7e712e6/mailnews/news/src/nsNNTPNewsgroupList.cpp">annotate</a> |
<a href="/comm-central/diff/12ceaa786d23d06d76eaf71e79d74ec4e7e712e6/mailnews/news/src/nsNNTPNewsgroupList.cpp">diff</a> |
<a href="/comm-central/comparison/12ceaa786d23d06d76eaf71e79d74ec4e7e712e6/mailnews/news/src/nsNNTPNewsgroupList.cpp">comparison</a> |
<a href="/comm-central/log/12ceaa786d23d06d76eaf71e79d74ec4e7e712e6/mailnews/news/src/nsNNTPNewsgroupList.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/12ceaa786d23d06d76eaf71e79d74ec4e7e712e6/mailnews/test/resources/messageInjection.js">mailnews/test/resources/messageInjection.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/12ceaa786d23d06d76eaf71e79d74ec4e7e712e6/mailnews/test/resources/messageInjection.js">file</a> |
<a href="/comm-central/annotate/12ceaa786d23d06d76eaf71e79d74ec4e7e712e6/mailnews/test/resources/messageInjection.js">annotate</a> |
<a href="/comm-central/diff/12ceaa786d23d06d76eaf71e79d74ec4e7e712e6/mailnews/test/resources/messageInjection.js">diff</a> |
<a href="/comm-central/comparison/12ceaa786d23d06d76eaf71e79d74ec4e7e712e6/mailnews/test/resources/messageInjection.js">comparison</a> |
<a href="/comm-central/log/12ceaa786d23d06d76eaf71e79d74ec4e7e712e6/mailnews/test/resources/messageInjection.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/base/public/nsIMsgFolderListener.idl</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/base/public/nsIMsgFolderListener.idl</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -82,19 +82,16 @@ interface nsIMsgFolderListener : nsISupp</span>
<a href="#l1.4"></a><span id="l1.4">    * after their existence is revealed by msgAdded.</span>
<a href="#l1.5"></a><span id="l1.5">    *</span>
<a href="#l1.6"></a><span id="l1.6">    * Because junk classification does not run if no messages have ever been</span>
<a href="#l1.7"></a><span id="l1.7">    * marked as junk by the user, it is possible to receive this message without</span>
<a href="#l1.8"></a><span id="l1.8">    * any classification having actually been performed.  We still generate the</span>
<a href="#l1.9"></a><span id="l1.9">    * notification in this case so that code is reliably notified about the</span>
<a href="#l1.10"></a><span id="l1.10">    * existence of the new message headers.</span>
<a href="#l1.11"></a><span id="l1.11">    *</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-   * IMPORTANT! You may receive a notification for a message more than once</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-   * because of deficiencies in our treatment of new messages.</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineminus">-   *</span>
<a href="#l1.15"></a><span id="l1.15">    * @param aMsgs The message headers that have been classified or were</span>
<a href="#l1.16"></a><span id="l1.16">    *     intentionally not classified.</span>
<a href="#l1.17"></a><span id="l1.17">    * @param aJunkProcessed Were the messages processed for junk classification?</span>
<a href="#l1.18"></a><span id="l1.18">    * @param aTraitProcessed Were the messages processed for trait</span>
<a href="#l1.19"></a><span id="l1.19">    *     classification?</span>
<a href="#l1.20"></a><span id="l1.20">    */</span>
<a href="#l1.21"></a><span id="l1.21">   void msgsClassified(in nsIArray aMsgs, in boolean aJunkProcessed,</span>
<a href="#l1.22"></a><span id="l1.22">                       in boolean aTraitProcessed);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/base/public/nsMsgMessageFlags.idl</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/base/public/nsMsgMessageFlags.idl</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -171,11 +171,33 @@ interface nsMsgProcessingFlags</span>
<a href="#l2.4"></a><span id="l2.4">   const nsMsgProcessingFlagType TraitsDone     = 0x00000004;</span>
<a href="#l2.5"></a><span id="l2.5"> </span>
<a href="#l2.6"></a><span id="l2.6">   /// This message has completed any needed postPlugin filtering</span>
<a href="#l2.7"></a><span id="l2.7">   const nsMsgProcessingFlagType FiltersDone    = 0x00000008;</span>
<a href="#l2.8"></a><span id="l2.8"> </span>
<a href="#l2.9"></a><span id="l2.9">   /// This message has a move scheduled by filters</span>
<a href="#l2.10"></a><span id="l2.10">   const nsMsgProcessingFlagType FilterToMove   = 0x00000010;</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+  /**</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+   * This message is new to the folder and has yet to be reported via the</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+   *  msgsClassified notification. This flag is required because the previously</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+   *  used mechanism relied on the database's list of new messages and its</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineplus">+   *  concept of 'new' is overloaded and has user-visible ramifications.  This</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineplus">+   *  led to messages potentially being considered multiple times.</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineplus">+   *</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineplus">+   * Unfortunately none of the Done processing flags above are suitable for our</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineplus">+   *  needs because they are not consistently applied and basically constitute</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineplus">+   *  memory leaks (which makes the not consistently applied thing a good</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineplus">+   *  thing.)</span>
<a href="#l2.23"></a><span id="l2.23" class="difflineplus">+   *</span>
<a href="#l2.24"></a><span id="l2.24" class="difflineplus">+   * I suspect we cannot reliably convert the Done flags above to our use case</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineplus">+   *  either because of the situation where the user quits the program after the</span>
<a href="#l2.26"></a><span id="l2.26" class="difflineplus">+   *  messages are added but before the messages are processed.  Since the</span>
<a href="#l2.27"></a><span id="l2.27" class="difflineplus">+   *  processing flags are suppression flags, assuming the 'new' status is</span>
<a href="#l2.28"></a><span id="l2.28" class="difflineplus">+   *  persisted to the next time we are run, then this would represent a</span>
<a href="#l2.29"></a><span id="l2.29" class="difflineplus">+   *  change in behaviour.  I would need to exactly understand the new semantics</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineplus">+   *  to know for sure though.</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineplus">+   */</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineplus">+  const nsMsgProcessingFlagType NotReportedClassified = 0x00000020;</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineplus">+</span>
<a href="#l2.34"></a><span id="l2.34">   /// Number of processing flags</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineminus">-  const nsMsgProcessingFlagType NumberOfFlags  = 5;</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineplus">+  const nsMsgProcessingFlagType NumberOfFlags  = 6;</span>
<a href="#l2.37"></a><span id="l2.37"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/base/util/nsMsgDBFolder.cpp</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgDBFolder.cpp</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -211,16 +211,17 @@ nsMsgDBFolder::nsMsgDBFolder(void)</span>
<a href="#l3.4"></a><span id="l3.4">     LL_I2L(gtimeOfLastPurgeCheck, 0);</span>
<a href="#l3.5"></a><span id="l3.5">   }</span>
<a href="#l3.6"></a><span id="l3.6"> </span>
<a href="#l3.7"></a><span id="l3.7">   mProcessingFlag[0].bit = nsMsgProcessingFlags::ClassifyJunk;</span>
<a href="#l3.8"></a><span id="l3.8">   mProcessingFlag[1].bit = nsMsgProcessingFlags::ClassifyTraits;</span>
<a href="#l3.9"></a><span id="l3.9">   mProcessingFlag[2].bit = nsMsgProcessingFlags::TraitsDone;</span>
<a href="#l3.10"></a><span id="l3.10">   mProcessingFlag[3].bit = nsMsgProcessingFlags::FiltersDone;</span>
<a href="#l3.11"></a><span id="l3.11">   mProcessingFlag[4].bit = nsMsgProcessingFlags::FilterToMove;</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+  mProcessingFlag[5].bit = nsMsgProcessingFlags::NotReportedClassified;</span>
<a href="#l3.13"></a><span id="l3.13">   for (PRUint32 i = 0; i &lt; nsMsgProcessingFlags::NumberOfFlags; i++)</span>
<a href="#l3.14"></a><span id="l3.14">     mProcessingFlag[i].keys = nsMsgKeySetU::Create();</span>
<a href="#l3.15"></a><span id="l3.15"> }</span>
<a href="#l3.16"></a><span id="l3.16"> </span>
<a href="#l3.17"></a><span id="l3.17"> nsMsgDBFolder::~nsMsgDBFolder(void)</span>
<a href="#l3.18"></a><span id="l3.18"> {</span>
<a href="#l3.19"></a><span id="l3.19">   for (PRUint32 i = 0; i &lt; nsMsgProcessingFlags::NumberOfFlags; i++)</span>
<a href="#l3.20"></a><span id="l3.20">     delete mProcessingFlag[i].keys;</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineat">@@ -1062,16 +1063,21 @@ nsresult nsMsgDBFolder::CheckWithNewMess</span>
<a href="#l3.22"></a><span id="l3.22"> //     When we lose a new message we need to check if there are still new messages</span>
<a href="#l3.23"></a><span id="l3.23"> NS_IMETHODIMP nsMsgDBFolder::OnHdrDeleted(nsIMsgDBHdr *aHdrChanged, nsMsgKey  aParentKey, PRInt32 aFlags,</span>
<a href="#l3.24"></a><span id="l3.24">                           nsIDBChangeListener * aInstigator)</span>
<a href="#l3.25"></a><span id="l3.25"> {</span>
<a href="#l3.26"></a><span id="l3.26">   // check to see if a new message is being deleted</span>
<a href="#l3.27"></a><span id="l3.27">   // as in this case, if there is only one new message and it's being deleted</span>
<a href="#l3.28"></a><span id="l3.28">   // the folder newness has to be cleared.</span>
<a href="#l3.29"></a><span id="l3.29">   CheckWithNewMessagesStatus(PR_FALSE);</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineplus">+  // Remove all processing flags.  This is generally a good thing although</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineplus">+  // undo-ing a message back into position will not re-gain the flags.</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineplus">+  nsMsgKey msgKey;</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineplus">+  aHdrChanged-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineplus">+  AndProcessingFlags(msgKey, 0);</span>
<a href="#l3.35"></a><span id="l3.35">   return OnHdrAddedOrDeleted(aHdrChanged, PR_FALSE);</span>
<a href="#l3.36"></a><span id="l3.36"> }</span>
<a href="#l3.37"></a><span id="l3.37"> </span>
<a href="#l3.38"></a><span id="l3.38"> // 2.  When a new messages gets added, we need to see if it's new.</span>
<a href="#l3.39"></a><span id="l3.39"> NS_IMETHODIMP nsMsgDBFolder::OnHdrAdded(nsIMsgDBHdr *aHdrChanged, nsMsgKey  aParentKey , PRInt32 aFlags,</span>
<a href="#l3.40"></a><span id="l3.40">                         nsIDBChangeListener * aInstigator)</span>
<a href="#l3.41"></a><span id="l3.41"> {</span>
<a href="#l3.42"></a><span id="l3.42">   if(aFlags &amp; nsMsgMessageFlags::New)</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineat">@@ -2197,23 +2203,31 @@ nsMsgDBFolder::OnMessageClassified(const</span>
<a href="#l3.44"></a><span id="l3.44"> </span>
<a href="#l3.45"></a><span id="l3.45">     nsCOMPtr &lt;nsIMutableArray&gt; classifiedMsgHdrs =</span>
<a href="#l3.46"></a><span id="l3.46">       do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l3.47"></a><span id="l3.47">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.48"></a><span id="l3.48"> </span>
<a href="#l3.49"></a><span id="l3.49">     PRUint32 numKeys = mBayesMsgKeys.Length();</span>
<a href="#l3.50"></a><span id="l3.50">     for (PRUint32 i = 0 ; i &lt; numKeys ; ++i)</span>
<a href="#l3.51"></a><span id="l3.51">     {</span>
<a href="#l3.52"></a><span id="l3.52" class="difflineminus">-      nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l3.53"></a><span id="l3.53" class="difflineplus">+      nsMsgKey msgKey = mBayesMsgKeys[i];</span>
<a href="#l3.54"></a><span id="l3.54">       PRBool hasKey;</span>
<a href="#l3.55"></a><span id="l3.55">       // It is very possible for a message header to no longer be around because</span>
<a href="#l3.56"></a><span id="l3.56">       // a filter moved it.</span>
<a href="#l3.57"></a><span id="l3.57" class="difflineminus">-      rv = mDatabase-&gt;ContainsKey(mBayesMsgKeys[i], &amp;hasKey);</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineplus">+      rv = mDatabase-&gt;ContainsKey(msgKey, &amp;hasKey);</span>
<a href="#l3.59"></a><span id="l3.59">       if (!NS_SUCCEEDED(rv) || !hasKey)</span>
<a href="#l3.60"></a><span id="l3.60">         continue;</span>
<a href="#l3.61"></a><span id="l3.61" class="difflineplus">+      // Ignore headers that have already been reported.</span>
<a href="#l3.62"></a><span id="l3.62" class="difflineplus">+      PRUint32 processingFlags;</span>
<a href="#l3.63"></a><span id="l3.63" class="difflineplus">+      GetProcessingFlags(msgKey, &amp;processingFlags);</span>
<a href="#l3.64"></a><span id="l3.64" class="difflineplus">+      if (!(processingFlags &amp; nsMsgProcessingFlags::NotReportedClassified))</span>
<a href="#l3.65"></a><span id="l3.65" class="difflineplus">+        continue;</span>
<a href="#l3.66"></a><span id="l3.66" class="difflineplus">+      // Now the message will have been reported.  Hooray.</span>
<a href="#l3.67"></a><span id="l3.67" class="difflineplus">+      AndProcessingFlags(msgKey, ~nsMsgProcessingFlags::NotReportedClassified);</span>
<a href="#l3.68"></a><span id="l3.68" class="difflineplus">+      nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l3.69"></a><span id="l3.69">       rv = mDatabase-&gt;GetMsgHdrForKey(mBayesMsgKeys[i],</span>
<a href="#l3.70"></a><span id="l3.70">                                       getter_AddRefs(msgHdr));</span>
<a href="#l3.71"></a><span id="l3.71">       if (!NS_SUCCEEDED(rv))</span>
<a href="#l3.72"></a><span id="l3.72">         continue;</span>
<a href="#l3.73"></a><span id="l3.73">       classifiedMsgHdrs-&gt;AppendElement(msgHdr, PR_FALSE);</span>
<a href="#l3.74"></a><span id="l3.74">     }</span>
<a href="#l3.75"></a><span id="l3.75"> </span>
<a href="#l3.76"></a><span id="l3.76">     notifier-&gt;NotifyMsgsClassified(classifiedMsgHdrs,</span>
<a href="#l3.77"></a><span id="l3.77" class="difflineat">@@ -2516,21 +2530,29 @@ nsMsgDBFolder::CallFilterPlugins(nsIMsgW</span>
<a href="#l3.78"></a><span id="l3.78">     {</span>
<a href="#l3.79"></a><span id="l3.79">       nsCOMPtr &lt;nsIMutableArray&gt; newMsgHdrs =</span>
<a href="#l3.80"></a><span id="l3.80">         do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l3.81"></a><span id="l3.81">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.82"></a><span id="l3.82"> </span>
<a href="#l3.83"></a><span id="l3.83">       PRUint32 numNewMessages = newMessageKeys.Length();</span>
<a href="#l3.84"></a><span id="l3.84">       for (PRUint32 i = 0 ; i &lt; numNewMessages ; ++i)</span>
<a href="#l3.85"></a><span id="l3.85">       {</span>
<a href="#l3.86"></a><span id="l3.86" class="difflineminus">-        nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l3.87"></a><span id="l3.87" class="difflineplus">+        nsMsgKey msgKey = newMessageKeys[i];</span>
<a href="#l3.88"></a><span id="l3.88" class="difflineplus">+        // Ignore headers that have already been reported.</span>
<a href="#l3.89"></a><span id="l3.89" class="difflineplus">+        PRUint32 processingFlags;</span>
<a href="#l3.90"></a><span id="l3.90" class="difflineplus">+        GetProcessingFlags(msgKey, &amp;processingFlags);</span>
<a href="#l3.91"></a><span id="l3.91" class="difflineplus">+        if (!(processingFlags &amp; nsMsgProcessingFlags::NotReportedClassified))</span>
<a href="#l3.92"></a><span id="l3.92" class="difflineplus">+          continue;</span>
<a href="#l3.93"></a><span id="l3.93" class="difflineplus">+        // Now the message will have been reported.  Hooray.</span>
<a href="#l3.94"></a><span id="l3.94" class="difflineplus">+        AndProcessingFlags(msgKey, ~nsMsgProcessingFlags::NotReportedClassified);</span>
<a href="#l3.95"></a><span id="l3.95" class="difflineplus">+</span>
<a href="#l3.96"></a><span id="l3.96">         // We do not need to do a ContainsKey check here; nothing could have</span>
<a href="#l3.97"></a><span id="l3.97">         // changed yet.</span>
<a href="#l3.98"></a><span id="l3.98" class="difflineminus">-        rv = mDatabase-&gt;GetMsgHdrForKey(newMessageKeys[i],</span>
<a href="#l3.99"></a><span id="l3.99" class="difflineminus">-                                        getter_AddRefs(msgHdr));</span>
<a href="#l3.100"></a><span id="l3.100" class="difflineplus">+        nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l3.101"></a><span id="l3.101" class="difflineplus">+        rv = mDatabase-&gt;GetMsgHdrForKey(msgKey, getter_AddRefs(msgHdr));</span>
<a href="#l3.102"></a><span id="l3.102">         if (!NS_SUCCEEDED(rv))</span>
<a href="#l3.103"></a><span id="l3.103">           continue;</span>
<a href="#l3.104"></a><span id="l3.104">         newMsgHdrs-&gt;AppendElement(msgHdr, PR_FALSE);</span>
<a href="#l3.105"></a><span id="l3.105">       }</span>
<a href="#l3.106"></a><span id="l3.106">       // we need to build up a list of message headers for this notification</span>
<a href="#l3.107"></a><span id="l3.107">       notifier-&gt;NotifyMsgsClassified(newMsgHdrs, filterForJunk, filterForOther);</span>
<a href="#l3.108"></a><span id="l3.108">     }</span>
<a href="#l3.109"></a><span id="l3.109">     return NS_OK;</span>
<a href="#l3.110"></a><span id="l3.110" class="difflineat">@@ -2589,24 +2611,27 @@ nsMsgDBFolder::CallFilterPlugins(nsIMsgW</span>
<a href="#l3.111"></a><span id="l3.111">     if (filterMessageForJunk || filterMessageForOther)</span>
<a href="#l3.112"></a><span id="l3.112">     {</span>
<a href="#l3.113"></a><span id="l3.113">       mBayesMsgKeys.AppendElement(newMessageKeys[i]);</span>
<a href="#l3.114"></a><span id="l3.114">       if (filterMessageForJunk)</span>
<a href="#l3.115"></a><span id="l3.115">         OrProcessingFlags(msgKey, nsMsgProcessingFlags::ClassifyJunk);</span>
<a href="#l3.116"></a><span id="l3.116">       if (filterMessageForOther)</span>
<a href="#l3.117"></a><span id="l3.117">         OrProcessingFlags(msgKey, nsMsgProcessingFlags::ClassifyTraits);</span>
<a href="#l3.118"></a><span id="l3.118">     }</span>
<a href="#l3.119"></a><span id="l3.119" class="difflineminus">-    else</span>
<a href="#l3.120"></a><span id="l3.120" class="difflineplus">+    // Accumulate the message header for immediate classified notification</span>
<a href="#l3.121"></a><span id="l3.121" class="difflineplus">+    // that we are not classifying it if it has not already been reported.</span>
<a href="#l3.122"></a><span id="l3.122" class="difflineplus">+    else if (processingFlags &amp; nsMsgProcessingFlags::NotReportedClassified)</span>
<a href="#l3.123"></a><span id="l3.123">     {</span>
<a href="#l3.124"></a><span id="l3.124" class="difflineplus">+      // Now the message will have been reported.  Hooray.</span>
<a href="#l3.125"></a><span id="l3.125" class="difflineplus">+      AndProcessingFlags(msgKey, ~nsMsgProcessingFlags::NotReportedClassified);</span>
<a href="#l3.126"></a><span id="l3.126">       if (!msgHdrsNotBeingClassified)</span>
<a href="#l3.127"></a><span id="l3.127">         msgHdrsNotBeingClassified = do_CreateInstance(NS_ARRAY_CONTRACTID);</span>
<a href="#l3.128"></a><span id="l3.128">       if (!msgHdrsNotBeingClassified)</span>
<a href="#l3.129"></a><span id="l3.129">         return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l3.130"></a><span id="l3.130" class="difflineminus">-      // Accumulate the message header for immediate classified notification</span>
<a href="#l3.131"></a><span id="l3.131" class="difflineminus">-      // that we are not classifying it.</span>
<a href="#l3.132"></a><span id="l3.132" class="difflineplus">+</span>
<a href="#l3.133"></a><span id="l3.133">       msgHdrsNotBeingClassified-&gt;AppendElement(msgHdr, PR_FALSE);</span>
<a href="#l3.134"></a><span id="l3.134">     }</span>
<a href="#l3.135"></a><span id="l3.135"> </span>
<a href="#l3.136"></a><span id="l3.136">     // Set messages to filter post-bayes.</span>
<a href="#l3.137"></a><span id="l3.137">     // Have we already filtered this message?</span>
<a href="#l3.138"></a><span id="l3.138">     if (!(processingFlags &amp; nsMsgProcessingFlags::FiltersDone))</span>
<a href="#l3.139"></a><span id="l3.139">     {</span>
<a href="#l3.140"></a><span id="l3.140">       // Don't do filters on this message again.</span>
<a href="#l3.141"></a><span id="l3.141" class="difflineat">@@ -5822,16 +5847,26 @@ NS_IMETHODIMP nsMsgDBFolder::OrProcessin</span>
<a href="#l3.142"></a><span id="l3.142"> NS_IMETHODIMP nsMsgDBFolder::AndProcessingFlags(nsMsgKey aKey, PRUint32 mask)</span>
<a href="#l3.143"></a><span id="l3.143"> {</span>
<a href="#l3.144"></a><span id="l3.144">   for (PRUint32 i = 0; i &lt; nsMsgProcessingFlags::NumberOfFlags; i++)</span>
<a href="#l3.145"></a><span id="l3.145">     if (!(mProcessingFlag[i].bit &amp; mask) &amp;&amp; mProcessingFlag[i].keys)</span>
<a href="#l3.146"></a><span id="l3.146">       mProcessingFlag[i].keys-&gt;Remove(aKey);</span>
<a href="#l3.147"></a><span id="l3.147">   return NS_OK;</span>
<a href="#l3.148"></a><span id="l3.148"> }</span>
<a href="#l3.149"></a><span id="l3.149"> </span>
<a href="#l3.150"></a><span id="l3.150" class="difflineplus">+void nsMsgDBFolder::ClearProcessingFlags()</span>
<a href="#l3.151"></a><span id="l3.151" class="difflineplus">+{</span>
<a href="#l3.152"></a><span id="l3.152" class="difflineplus">+  for (PRUint32 i = 0; i &lt; nsMsgProcessingFlags::NumberOfFlags; i++)</span>
<a href="#l3.153"></a><span id="l3.153" class="difflineplus">+  {</span>
<a href="#l3.154"></a><span id="l3.154" class="difflineplus">+    // There is no clear method so we need to delete and re-create.</span>
<a href="#l3.155"></a><span id="l3.155" class="difflineplus">+    delete mProcessingFlag[i].keys;</span>
<a href="#l3.156"></a><span id="l3.156" class="difflineplus">+    mProcessingFlag[i].keys = nsMsgKeySetU::Create();</span>
<a href="#l3.157"></a><span id="l3.157" class="difflineplus">+  }</span>
<a href="#l3.158"></a><span id="l3.158" class="difflineplus">+}</span>
<a href="#l3.159"></a><span id="l3.159" class="difflineplus">+</span>
<a href="#l3.160"></a><span id="l3.160"> /* static */ nsMsgKeySetU* nsMsgKeySetU::Create()</span>
<a href="#l3.161"></a><span id="l3.161"> {</span>
<a href="#l3.162"></a><span id="l3.162">   nsMsgKeySetU* set = new nsMsgKeySetU;</span>
<a href="#l3.163"></a><span id="l3.163">   if (set)</span>
<a href="#l3.164"></a><span id="l3.164">   {</span>
<a href="#l3.165"></a><span id="l3.165">     set-&gt;loKeySet = nsMsgKeySet::Create();</span>
<a href="#l3.166"></a><span id="l3.166">     set-&gt;hiKeySet = nsMsgKeySet::Create();</span>
<a href="#l3.167"></a><span id="l3.167">   }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/base/util/nsMsgDBFolder.h</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgDBFolder.h</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -171,16 +171,22 @@ protected:</span>
<a href="#l4.4"></a><span id="l4.4"> </span>
<a href="#l4.5"></a><span id="l4.5">   nsresult PerformBiffNotifications(void); // if there are new, non spam messages, do biff</span>
<a href="#l4.6"></a><span id="l4.6">   nsresult CloseDBIfFolderNotOpen();</span>
<a href="#l4.7"></a><span id="l4.7"> </span>
<a href="#l4.8"></a><span id="l4.8">   virtual nsresult SpamFilterClassifyMessage(const char *aURI, nsIMsgWindow *aMsgWindow, nsIJunkMailPlugin *aJunkMailPlugin);</span>
<a href="#l4.9"></a><span id="l4.9">   virtual nsresult SpamFilterClassifyMessages(const char **aURIArray, PRUint32 aURICount, nsIMsgWindow *aMsgWindow, nsIJunkMailPlugin *aJunkMailPlugin);</span>
<a href="#l4.10"></a><span id="l4.10">   void    SetMRUTime();</span>
<a href="#l4.11"></a><span id="l4.11"> </span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+  /**</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+   * Clear all processing flags, presumably because message keys are no longer</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+   * valid.</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+   */</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineplus">+  void ClearProcessingFlags();</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineplus">+</span>
<a href="#l4.18"></a><span id="l4.18"> protected:</span>
<a href="#l4.19"></a><span id="l4.19">   nsCOMPtr&lt;nsIMsgDatabase&gt; mDatabase;</span>
<a href="#l4.20"></a><span id="l4.20">   nsCOMPtr&lt;nsIMsgDatabase&gt; mBackupDatabase;</span>
<a href="#l4.21"></a><span id="l4.21">   nsCString mCharset;</span>
<a href="#l4.22"></a><span id="l4.22">   PRBool mCharsetOverride;</span>
<a href="#l4.23"></a><span id="l4.23">   PRBool mAddListener;</span>
<a href="#l4.24"></a><span id="l4.24">   PRBool mNewMessages;</span>
<a href="#l4.25"></a><span id="l4.25">   PRBool mGettingNewMessages;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/imap/src/nsImapMailFolder.cpp</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapMailFolder.cpp</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -3142,16 +3142,18 @@ nsresult nsImapMailFolder::NormalEndHead</span>
<a href="#l5.4"></a><span id="l5.4">   }</span>
<a href="#l5.5"></a><span id="l5.5">   // here we need to tweak flags from uid state..</span>
<a href="#l5.6"></a><span id="l5.6">   if (mDatabase &amp;&amp; (!m_msgMovedByFilter || ShowDeletedMessages()))</span>
<a href="#l5.7"></a><span id="l5.7">   {</span>
<a href="#l5.8"></a><span id="l5.8">     mDatabase-&gt;AddNewHdrToDB(newMsgHdr, PR_TRUE);</span>
<a href="#l5.9"></a><span id="l5.9">     nsCOMPtr&lt;nsIMsgFolderNotificationService&gt; notifier(do_GetService(NS_MSGNOTIFICATIONSERVICE_CONTRACTID));</span>
<a href="#l5.10"></a><span id="l5.10">     if (notifier)</span>
<a href="#l5.11"></a><span id="l5.11">       notifier-&gt;NotifyMsgAdded(newMsgHdr);</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+    // mark the header as not yet reported classified</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+    OrProcessingFlags(m_curMsgUid, nsMsgProcessingFlags::NotReportedClassified);</span>
<a href="#l5.14"></a><span id="l5.14">   }</span>
<a href="#l5.15"></a><span id="l5.15">   // adjust highestRecordedUID</span>
<a href="#l5.16"></a><span id="l5.16">   if (mDatabase)</span>
<a href="#l5.17"></a><span id="l5.17">   {</span>
<a href="#l5.18"></a><span id="l5.18">     nsCOMPtr &lt;nsIDBFolderInfo&gt; dbFolderInfo;</span>
<a href="#l5.19"></a><span id="l5.19">     nsMsgKey highestUID;</span>
<a href="#l5.20"></a><span id="l5.20">     mDatabase-&gt;GetDBFolderInfo(getter_AddRefs(dbFolderInfo));</span>
<a href="#l5.21"></a><span id="l5.21">     dbFolderInfo-&gt;GetUint32Property(kHighestRecordedUIDPropertyName, 0, &amp;highestUID);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/local/src/nsLocalMailFolder.cpp</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/local/src/nsLocalMailFolder.cpp</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -2779,16 +2779,18 @@ NS_IMETHODIMP nsMsgLocalMailFolder::EndC</span>
<a href="#l6.4"></a><span id="l6.4">       {</span>
<a href="#l6.5"></a><span id="l6.5">         notifier-&gt;NotifyMsgAdded(newHdr);</span>
<a href="#l6.6"></a><span id="l6.6">         // We do not appear to trigger classification in this case, so let's</span>
<a href="#l6.7"></a><span id="l6.7">         // paper over the abyss by just sending the classification notification.</span>
<a href="#l6.8"></a><span id="l6.8">         nsCOMPtr &lt;nsIMutableArray&gt; oneHeaderArray =</span>
<a href="#l6.9"></a><span id="l6.9">           do_CreateInstance(NS_ARRAY_CONTRACTID);</span>
<a href="#l6.10"></a><span id="l6.10">         oneHeaderArray-&gt;AppendElement(newHdr, PR_FALSE);</span>
<a href="#l6.11"></a><span id="l6.11">         notifier-&gt;NotifyMsgsClassified(oneHeaderArray, PR_FALSE, PR_FALSE);</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineplus">+        // (We do not add the NotReportedClassified processing flag since we</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+        // just reported it!)</span>
<a href="#l6.14"></a><span id="l6.14">       }</span>
<a href="#l6.15"></a><span id="l6.15">     }</span>
<a href="#l6.16"></a><span id="l6.16">   }</span>
<a href="#l6.17"></a><span id="l6.17">   return rv;</span>
<a href="#l6.18"></a><span id="l6.18"> }</span>
<a href="#l6.19"></a><span id="l6.19"> </span>
<a href="#l6.20"></a><span id="l6.20"> static PRBool gGotGlobalPrefs;</span>
<a href="#l6.21"></a><span id="l6.21"> static PRBool gDeleteFromServerOnMove;</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineat">@@ -3590,16 +3592,18 @@ nsMsgLocalMailFolder::SetCheckForNewMess</span>
<a href="#l6.23"></a><span id="l6.23">   return NS_OK;</span>
<a href="#l6.24"></a><span id="l6.24"> }</span>
<a href="#l6.25"></a><span id="l6.25"> </span>
<a href="#l6.26"></a><span id="l6.26"> NS_IMETHODIMP</span>
<a href="#l6.27"></a><span id="l6.27"> nsMsgLocalMailFolder::NotifyCompactCompleted()</span>
<a href="#l6.28"></a><span id="l6.28"> {</span>
<a href="#l6.29"></a><span id="l6.29">   mExpungedBytes = 0;</span>
<a href="#l6.30"></a><span id="l6.30">   m_newMsgs.Clear(); // if compacted, m_newMsgs probably aren't valid.</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineplus">+  // if compacted, processing flags probably also aren't valid.</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineplus">+  ClearProcessingFlags();</span>
<a href="#l6.33"></a><span id="l6.33">   (void) RefreshSizeOnDisk();</span>
<a href="#l6.34"></a><span id="l6.34">   (void) CloseDBIfFolderNotOpen();</span>
<a href="#l6.35"></a><span id="l6.35">   nsCOMPtr &lt;nsIAtom&gt; compactCompletedAtom;</span>
<a href="#l6.36"></a><span id="l6.36">   compactCompletedAtom = do_GetAtom(&quot;CompactCompleted&quot;);</span>
<a href="#l6.37"></a><span id="l6.37">   NotifyFolderEvent(compactCompletedAtom);</span>
<a href="#l6.38"></a><span id="l6.38">   return NS_OK;</span>
<a href="#l6.39"></a><span id="l6.39"> }</span>
<a href="#l6.40"></a><span id="l6.40"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/local/src/nsParseMailbox.cpp</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/local/src/nsParseMailbox.cpp</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -1880,16 +1880,21 @@ PRInt32 nsParseNewMailState::PublishMsgH</span>
<a href="#l7.4"></a><span id="l7.4">     if (!moved)</span>
<a href="#l7.5"></a><span id="l7.5">     {</span>
<a href="#l7.6"></a><span id="l7.6">       if (m_mailDB)</span>
<a href="#l7.7"></a><span id="l7.7">       {</span>
<a href="#l7.8"></a><span id="l7.8">         m_mailDB-&gt;AddNewHdrToDB(m_newMsgHdr, PR_TRUE);</span>
<a href="#l7.9"></a><span id="l7.9">         nsCOMPtr&lt;nsIMsgFolderNotificationService&gt; notifier(do_GetService(NS_MSGNOTIFICATIONSERVICE_CONTRACTID));</span>
<a href="#l7.10"></a><span id="l7.10">         if (notifier)</span>
<a href="#l7.11"></a><span id="l7.11">           notifier-&gt;NotifyMsgAdded(m_newMsgHdr);</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineplus">+        // mark the header as not yet reported classified</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+        nsMsgKey msgKey;</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+        m_newMsgHdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+        m_downloadFolder-&gt;OrProcessingFlags(</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineplus">+           msgKey, nsMsgProcessingFlags::NotReportedClassified);</span>
<a href="#l7.17"></a><span id="l7.17">       }</span>
<a href="#l7.18"></a><span id="l7.18">     } // if it was moved by imap filter, m_parseMsgState-&gt;m_newMsgHdr == nsnull</span>
<a href="#l7.19"></a><span id="l7.19">     m_newMsgHdr = nsnull;</span>
<a href="#l7.20"></a><span id="l7.20">   }</span>
<a href="#l7.21"></a><span id="l7.21">   return 0;</span>
<a href="#l7.22"></a><span id="l7.22"> }</span>
<a href="#l7.23"></a><span id="l7.23"> </span>
<a href="#l7.24"></a><span id="l7.24"> nsresult nsParseNewMailState::GetTrashFolder(nsIMsgFolder **pTrashFolder)</span>
<a href="#l7.25"></a><span id="l7.25" class="difflineat">@@ -2530,16 +2535,19 @@ nsresult nsParseNewMailState::MoveIncorp</span>
<a href="#l7.26"></a><span id="l7.26">           destMailDB-&gt;AddToNewList(newMsgPos);</span>
<a href="#l7.27"></a><span id="l7.27">           movedMsgIsNew = PR_TRUE;</span>
<a href="#l7.28"></a><span id="l7.28">         }</span>
<a href="#l7.29"></a><span id="l7.29">       }</span>
<a href="#l7.30"></a><span id="l7.30">       destMailDB-&gt;AddNewHdrToDB(newHdr, PR_TRUE);</span>
<a href="#l7.31"></a><span id="l7.31">       nsCOMPtr&lt;nsIMsgFolderNotificationService&gt; notifier(do_GetService(NS_MSGNOTIFICATIONSERVICE_CONTRACTID));</span>
<a href="#l7.32"></a><span id="l7.32">       if (notifier)</span>
<a href="#l7.33"></a><span id="l7.33">         notifier-&gt;NotifyMsgAdded(newHdr);</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineplus">+      // mark the header as not yet reported classified</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineplus">+      destIFolder-&gt;OrProcessingFlags(</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineplus">+        newMsgPos, nsMsgProcessingFlags::NotReportedClassified);</span>
<a href="#l7.37"></a><span id="l7.37">       m_msgToForwardOrReply = newHdr;</span>
<a href="#l7.38"></a><span id="l7.38">     }</span>
<a href="#l7.39"></a><span id="l7.39">   }</span>
<a href="#l7.40"></a><span id="l7.40">   else</span>
<a href="#l7.41"></a><span id="l7.41">   {</span>
<a href="#l7.42"></a><span id="l7.42">     if (destMailDB)</span>
<a href="#l7.43"></a><span id="l7.43">       destMailDB = nsnull;</span>
<a href="#l7.44"></a><span id="l7.44">   }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/local/src/nsPop3Sink.cpp</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/local/src/nsPop3Sink.cpp</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -890,16 +890,18 @@ nsPop3Sink::IncorporateComplete(nsIMsgWi</span>
<a href="#l8.4"></a><span id="l8.4">                 hdr-&gt;OrFlags(nsMsgMessageFlags::New, &amp;newFlags);</span>
<a href="#l8.5"></a><span id="l8.5">                 m_newMailParser-&gt;m_mailDB-&gt;AddToNewList(newMsgPos);</span>
<a href="#l8.6"></a><span id="l8.6">               }</span>
<a href="#l8.7"></a><span id="l8.7">             }</span>
<a href="#l8.8"></a><span id="l8.8">             m_newMailParser-&gt;m_mailDB-&gt;AddNewHdrToDB(hdr, PR_TRUE);</span>
<a href="#l8.9"></a><span id="l8.9">             nsCOMPtr&lt;nsIMsgFolderNotificationService&gt; notifier(do_GetService(NS_MSGNOTIFICATIONSERVICE_CONTRACTID));</span>
<a href="#l8.10"></a><span id="l8.10">             if (notifier)</span>
<a href="#l8.11"></a><span id="l8.11">               notifier-&gt;NotifyMsgAdded(hdr);</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+            m_folder-&gt;OrProcessingFlags(</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+              newMsgPos, nsMsgProcessingFlags::NotReportedClassified);</span>
<a href="#l8.14"></a><span id="l8.14">           }</span>
<a href="#l8.15"></a><span id="l8.15">         }</span>
<a href="#l8.16"></a><span id="l8.16">         else</span>
<a href="#l8.17"></a><span id="l8.17">         {</span>
<a href="#l8.18"></a><span id="l8.18">             return HandleTempDownloadFailed(aMsgWindow);</span>
<a href="#l8.19"></a><span id="l8.19">           // need to give an error here.</span>
<a href="#l8.20"></a><span id="l8.20">         }</span>
<a href="#l8.21"></a><span id="l8.21">       }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/news/src/nsNNTPNewsgroupList.cpp</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/news/src/nsNNTPNewsgroupList.cpp</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -1145,27 +1145,32 @@ nsNNTPNewsgroupList::CallFilters()</span>
<a href="#l9.4"></a><span id="l9.4"> </span>
<a href="#l9.5"></a><span id="l9.5">   PRUint32 count = m_newHeaders.Count();</span>
<a href="#l9.6"></a><span id="l9.6"> </span>
<a href="#l9.7"></a><span id="l9.7">   // Notify MsgFolderListeners of message adds</span>
<a href="#l9.8"></a><span id="l9.8">   nsCOMPtr&lt;nsIMsgFolderNotificationService&gt; notifier(do_GetService(NS_MSGNOTIFICATIONSERVICE_CONTRACTID));</span>
<a href="#l9.9"></a><span id="l9.9"> </span>
<a href="#l9.10"></a><span id="l9.10">   for (PRUint32 i = 0; i &lt; count; i++)</span>
<a href="#l9.11"></a><span id="l9.11">   {</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineplus">+    m_newMsgHdr = m_newHeaders[i];</span>
<a href="#l9.13"></a><span id="l9.13">     if (!filterCount &amp;&amp; !serverFilterCount)</span>
<a href="#l9.14"></a><span id="l9.14">     {</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineminus">-      m_newsDB-&gt;AddNewHdrToDB(m_newHeaders[i], PR_TRUE);</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineplus">+      m_newsDB-&gt;AddNewHdrToDB(m_newMsgHdr, PR_TRUE);</span>
<a href="#l9.17"></a><span id="l9.17"> </span>
<a href="#l9.18"></a><span id="l9.18">       if (notifier)</span>
<a href="#l9.19"></a><span id="l9.19" class="difflineminus">-        notifier-&gt;NotifyMsgAdded(m_newHeaders[i]);</span>
<a href="#l9.20"></a><span id="l9.20" class="difflineplus">+        notifier-&gt;NotifyMsgAdded(m_newMsgHdr);</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineplus">+      // mark the header as not yet reported classified</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineplus">+      nsMsgKey msgKey;</span>
<a href="#l9.23"></a><span id="l9.23" class="difflineplus">+      m_newMsgHdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l9.24"></a><span id="l9.24" class="difflineplus">+      folder-&gt;OrProcessingFlags(msgKey,</span>
<a href="#l9.25"></a><span id="l9.25" class="difflineplus">+                                nsMsgProcessingFlags::NotReportedClassified);</span>
<a href="#l9.26"></a><span id="l9.26"> </span>
<a href="#l9.27"></a><span id="l9.27">       continue;</span>
<a href="#l9.28"></a><span id="l9.28">     }</span>
<a href="#l9.29"></a><span id="l9.29">     m_addHdrToDB = PR_TRUE;</span>
<a href="#l9.30"></a><span id="l9.30" class="difflineminus">-    m_newMsgHdr = m_newHeaders[i];</span>
<a href="#l9.31"></a><span id="l9.31"> </span>
<a href="#l9.32"></a><span id="l9.32">     // build up a &quot;headers&quot; for filter code</span>
<a href="#l9.33"></a><span id="l9.33">     nsCString subject, author, date;</span>
<a href="#l9.34"></a><span id="l9.34">     rv = m_newMsgHdr-&gt;GetSubject(getter_Copies(subject));</span>
<a href="#l9.35"></a><span id="l9.35">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l9.36"></a><span id="l9.36">     rv = m_newMsgHdr-&gt;GetAuthor(getter_Copies(author));</span>
<a href="#l9.37"></a><span id="l9.37">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l9.38"></a><span id="l9.38"> </span>
<a href="#l9.39"></a><span id="l9.39" class="difflineat">@@ -1216,16 +1221,21 @@ nsNNTPNewsgroupList::CallFilters()</span>
<a href="#l9.40"></a><span id="l9.40"> </span>
<a href="#l9.41"></a><span id="l9.41">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l9.42"></a><span id="l9.42"> </span>
<a href="#l9.43"></a><span id="l9.43">     if (m_addHdrToDB)</span>
<a href="#l9.44"></a><span id="l9.44">     {</span>
<a href="#l9.45"></a><span id="l9.45">       m_newsDB-&gt;AddNewHdrToDB(m_newMsgHdr, PR_TRUE);</span>
<a href="#l9.46"></a><span id="l9.46">       if (notifier)</span>
<a href="#l9.47"></a><span id="l9.47">         notifier-&gt;NotifyMsgAdded(m_newMsgHdr);</span>
<a href="#l9.48"></a><span id="l9.48" class="difflineplus">+      // mark the header as not yet reported classified</span>
<a href="#l9.49"></a><span id="l9.49" class="difflineplus">+      nsMsgKey msgKey;</span>
<a href="#l9.50"></a><span id="l9.50" class="difflineplus">+      m_newMsgHdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l9.51"></a><span id="l9.51" class="difflineplus">+      folder-&gt;OrProcessingFlags(msgKey,</span>
<a href="#l9.52"></a><span id="l9.52" class="difflineplus">+                                nsMsgProcessingFlags::NotReportedClassified);</span>
<a href="#l9.53"></a><span id="l9.53">     }</span>
<a href="#l9.54"></a><span id="l9.54">   }</span>
<a href="#l9.55"></a><span id="l9.55">   m_newHeaders.Clear();</span>
<a href="#l9.56"></a><span id="l9.56">   return NS_OK;</span>
<a href="#l9.57"></a><span id="l9.57"> }</span>
<a href="#l9.58"></a><span id="l9.58"> </span>
<a href="#l9.59"></a><span id="l9.59"> void</span>
<a href="#l9.60"></a><span id="l9.60"> nsNNTPNewsgroupList::SetProgressBarPercent(PRInt32 percent)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/test/resources/messageInjection.js</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/test/resources/messageInjection.js</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -536,73 +536,16 @@ function _looperator(aList) {</span>
<a href="#l10.4"></a><span id="l10.4">   let i = 0, length = aList.length;</span>
<a href="#l10.5"></a><span id="l10.5">   while (true) {</span>
<a href="#l10.6"></a><span id="l10.6">     yield aList[i];</span>
<a href="#l10.7"></a><span id="l10.7">     i = (i + 1) % length;</span>
<a href="#l10.8"></a><span id="l10.8">   }</span>
<a href="#l10.9"></a><span id="l10.9"> }</span>
<a href="#l10.10"></a><span id="l10.10"> </span>
<a href="#l10.11"></a><span id="l10.11"> /**</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">- * This mechanism works around limitations in the new-handling logic that can</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineminus">- *  cause the msgsClassified event to be produced for messages multiple times.</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineminus">- *  We can generally avoid this problem in the local case, but it is harder</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineminus">- *  to workaround in the IMAP case because so many events are out of our</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineminus">- *  control.  By using the msgAdded notification we can trickily interpose</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineminus">- *  ourselves, however.</span>
<a href="#l10.18"></a><span id="l10.18" class="difflineminus">- */</span>
<a href="#l10.19"></a><span id="l10.19" class="difflineminus">-let _imapNewMessagesWorkaround = {</span>
<a href="#l10.20"></a><span id="l10.20" class="difflineminus">-  _registered: false,</span>
<a href="#l10.21"></a><span id="l10.21" class="difflineminus">-  _register: function i_am_one_of_jacks_organs_with_a_bad_attitude() {</span>
<a href="#l10.22"></a><span id="l10.22" class="difflineminus">-    let notificationService =</span>
<a href="#l10.23"></a><span id="l10.23" class="difflineminus">-      Cc[&quot;@mozilla.org/messenger/msgnotificationservice;1&quot;]</span>
<a href="#l10.24"></a><span id="l10.24" class="difflineminus">-        .getService(Ci.nsIMsgFolderNotificationService);</span>
<a href="#l10.25"></a><span id="l10.25" class="difflineminus">-    notificationService.addListener(this,</span>
<a href="#l10.26"></a><span id="l10.26" class="difflineminus">-      Ci.nsIMsgFolderNotificationService.msgAdded);</span>
<a href="#l10.27"></a><span id="l10.27" class="difflineminus">-</span>
<a href="#l10.28"></a><span id="l10.28" class="difflineminus">-    this._registered = true;</span>
<a href="#l10.29"></a><span id="l10.29" class="difflineminus">-  },</span>
<a href="#l10.30"></a><span id="l10.30" class="difflineminus">-</span>
<a href="#l10.31"></a><span id="l10.31" class="difflineminus">-  _numberOfMessagesToGoPerFolder: {},</span>
<a href="#l10.32"></a><span id="l10.32" class="difflineminus">-</span>
<a href="#l10.33"></a><span id="l10.33" class="difflineminus">-  msgAdded: function that_last_function_name_was_a_fight_club_reference(</span>
<a href="#l10.34"></a><span id="l10.34" class="difflineminus">-              aMsgHdr) {</span>
<a href="#l10.35"></a><span id="l10.35" class="difflineminus">-    let folder = aMsgHdr.folder;</span>
<a href="#l10.36"></a><span id="l10.36" class="difflineminus">-    let uri = folder.URI;</span>
<a href="#l10.37"></a><span id="l10.37" class="difflineminus">-    if (uri in this._numberOfMessagesToGoPerFolder) {</span>
<a href="#l10.38"></a><span id="l10.38" class="difflineminus">-      if (--this._numberOfMessagesToGoPerFolder[uri] == 0) {</span>
<a href="#l10.39"></a><span id="l10.39" class="difflineminus">-        delete this._numberOfMessagesToGoPerFolder[uri];</span>
<a href="#l10.40"></a><span id="l10.40" class="difflineminus">-        mark_action(&quot;messageInjection&quot;,</span>
<a href="#l10.41"></a><span id="l10.41" class="difflineminus">-                    &quot;clearing new messages to avoid classified problems&quot;,</span>
<a href="#l10.42"></a><span id="l10.42" class="difflineminus">-                    [folder]);</span>
<a href="#l10.43"></a><span id="l10.43" class="difflineminus">-        folder.clearNewMessages();</span>
<a href="#l10.44"></a><span id="l10.44" class="difflineminus">-      }</span>
<a href="#l10.45"></a><span id="l10.45" class="difflineminus">-    }</span>
<a href="#l10.46"></a><span id="l10.46" class="difflineminus">-  },</span>
<a href="#l10.47"></a><span id="l10.47" class="difflineminus">-</span>
<a href="#l10.48"></a><span id="l10.48" class="difflineminus">-  /**</span>
<a href="#l10.49"></a><span id="l10.49" class="difflineminus">-   * Log that one or more messages are expected to be added in the given folder</span>
<a href="#l10.50"></a><span id="l10.50" class="difflineminus">-   *  so that we have an accurate count.  We need to generate the</span>
<a href="#l10.51"></a><span id="l10.51" class="difflineminus">-   *  clearNewMessages call when the last message gets msgAdded.</span>
<a href="#l10.52"></a><span id="l10.52" class="difflineminus">-   */</span>
<a href="#l10.53"></a><span id="l10.53" class="difflineminus">-  expectMessageInFolder:</span>
<a href="#l10.54"></a><span id="l10.54" class="difflineminus">-      function you_see_the_workaround_makes_me_feel_many_complex_emotions(</span>
<a href="#l10.55"></a><span id="l10.55" class="difflineminus">-        aFolder, aCount) {</span>
<a href="#l10.56"></a><span id="l10.56" class="difflineminus">-    if (!this._registered)</span>
<a href="#l10.57"></a><span id="l10.57" class="difflineminus">-        this._register();</span>
<a href="#l10.58"></a><span id="l10.58" class="difflineminus">-    if (aCount == undefined)</span>
<a href="#l10.59"></a><span id="l10.59" class="difflineminus">-      aCount = 1;</span>
<a href="#l10.60"></a><span id="l10.60" class="difflineminus">-    let uri = aFolder.URI;</span>
<a href="#l10.61"></a><span id="l10.61" class="difflineminus">-    if (uri in this._numberOfMessagesToGoPerFolder)</span>
<a href="#l10.62"></a><span id="l10.62" class="difflineminus">-      this._numberOfMessagesToGoPerFolder[uri] += aCount;</span>
<a href="#l10.63"></a><span id="l10.63" class="difflineminus">-    else</span>
<a href="#l10.64"></a><span id="l10.64" class="difflineminus">-      this._numberOfMessagesToGoPerFolder[uri] = aCount;</span>
<a href="#l10.65"></a><span id="l10.65" class="difflineminus">-  },</span>
<a href="#l10.66"></a><span id="l10.66" class="difflineminus">-};</span>
<a href="#l10.67"></a><span id="l10.67" class="difflineminus">-</span>
<a href="#l10.68"></a><span id="l10.68" class="difflineminus">-/**</span>
<a href="#l10.69"></a><span id="l10.69">  * Spreads the messages in aMessageSets across the folders in aMsgFolders.  Each</span>
<a href="#l10.70"></a><span id="l10.70">  *  message set is spread in a round-robin fashion across all folders.  At the</span>
<a href="#l10.71"></a><span id="l10.71">  *  same time, each message-sets insertion is interleaved with the other message</span>
<a href="#l10.72"></a><span id="l10.72">  *  sets.  This distributes message across multiple folders for useful</span>
<a href="#l10.73"></a><span id="l10.73">  *  cross-folder threading testing (via the round robin) while also hopefully</span>
<a href="#l10.74"></a><span id="l10.74">  *  avoiding making things pathologically easy for the code under test (by way</span>
<a href="#l10.75"></a><span id="l10.75">  *  of the interleaving.)</span>
<a href="#l10.76"></a><span id="l10.76">  *</span>
<a href="#l10.77"></a><span id="l10.77" class="difflineat">@@ -696,25 +639,16 @@ function add_sets_to_folders(aMsgFolders</span>
<a href="#l10.78"></a><span id="l10.78">       folder = iterFolders.next();</span>
<a href="#l10.79"></a><span id="l10.79">     } while (didSomething);</span>
<a href="#l10.80"></a><span id="l10.80"> </span>
<a href="#l10.81"></a><span id="l10.81">     // make sure that junk filtering gets a turn</span>
<a href="#l10.82"></a><span id="l10.82">     // XXX we probably need to be doing more in terms of filters here,</span>
<a href="#l10.83"></a><span id="l10.83">     //  although since filters really want to be run on the inbox, there</span>
<a href="#l10.84"></a><span id="l10.84">     //  are separate potential semantic issues involved.</span>
<a href="#l10.85"></a><span id="l10.85">     for each (let [, folder] in Iterator(aMsgFolders)) {</span>
<a href="#l10.86"></a><span id="l10.86" class="difflineminus">-      // XXX Pretend we live in an ideal world by clearing the new list before</span>
<a href="#l10.87"></a><span id="l10.87" class="difflineminus">-      //  invoking callFilterPlugins.  Because it processes the union of the</span>
<a href="#l10.88"></a><span id="l10.88" class="difflineminus">-      //  new list and the saved new list (which is populated when you call</span>
<a href="#l10.89"></a><span id="l10.89" class="difflineminus">-      //  clearNewMessages and cleared by callFilterPlugins), by calling</span>
<a href="#l10.90"></a><span id="l10.90" class="difflineminus">-      //  clearNewMessages before callFilterPlugins we ensure that the message</span>
<a href="#l10.91"></a><span id="l10.91" class="difflineminus">-      //  only gets seen by the method once.</span>
<a href="#l10.92"></a><span id="l10.92" class="difflineminus">-      // The downside is that code in reality can be disappointed to get the</span>
<a href="#l10.93"></a><span id="l10.93" class="difflineminus">-      //  notification more than once.</span>
<a href="#l10.94"></a><span id="l10.94" class="difflineminus">-      folder.clearNewMessages();</span>
<a href="#l10.95"></a><span id="l10.95">       folder.callFilterPlugins(null);</span>
<a href="#l10.96"></a><span id="l10.96">     }</span>
<a href="#l10.97"></a><span id="l10.97">   }</span>
<a href="#l10.98"></a><span id="l10.98">   else if (mis.injectionConfig.mode == &quot;imap&quot;) {</span>
<a href="#l10.99"></a><span id="l10.99">     // we need to call updateFolder on all the folders, not just the first</span>
<a href="#l10.100"></a><span id="l10.100">     //  one...</span>
<a href="#l10.101"></a><span id="l10.101">     return async_run({func: function() {</span>
<a href="#l10.102"></a><span id="l10.102">       yield wait_for_async_promises();</span>
<a href="#l10.103"></a><span id="l10.103" class="difflineat">@@ -737,38 +671,29 @@ function add_sets_to_folders(aMsgFolders</span>
<a href="#l10.104"></a><span id="l10.104">             let imapMsg = new imapMessage(msgURI.spec, fakeFolder.uidnext++, []);</span>
<a href="#l10.105"></a><span id="l10.105">             // If the message's meta-state indicates it is junk, set that flag.</span>
<a href="#l10.106"></a><span id="l10.106">             // There is also a NotJunk flag, but we're not playing with that</span>
<a href="#l10.107"></a><span id="l10.107">             //  right now; as long as nothing is ever marked as junk, the junk</span>
<a href="#l10.108"></a><span id="l10.108">             //  classifier won't run, so it's moot for now.</span>
<a href="#l10.109"></a><span id="l10.109">             if (synMsg.metaState.junk)</span>
<a href="#l10.110"></a><span id="l10.110">               imapMsg.setFlag(&quot;Junk&quot;);</span>
<a href="#l10.111"></a><span id="l10.111">             fakeFolder.addMessage(imapMsg);</span>
<a href="#l10.112"></a><span id="l10.112" class="difflineminus">-            _imapNewMessagesWorkaround.expectMessageInFolder(realFolder);</span>
<a href="#l10.113"></a><span id="l10.113">           }</span>
<a href="#l10.114"></a><span id="l10.114">         }</span>
<a href="#l10.115"></a><span id="l10.115">         iPerSet++;</span>
<a href="#l10.116"></a><span id="l10.116">         folder = iterFolders.next();</span>
<a href="#l10.117"></a><span id="l10.117">       } while (didSomething);</span>
<a href="#l10.118"></a><span id="l10.118"> </span>
<a href="#l10.119"></a><span id="l10.119">       for (let iFolder = 0; iFolder &lt; aMsgFolders.length; iFolder++) {</span>
<a href="#l10.120"></a><span id="l10.120">         let realFolder = mis.handleUriToRealFolder[aMsgFolders[iFolder]];</span>
<a href="#l10.121"></a><span id="l10.121">         mark_action(&quot;messageInjection&quot;, &quot;forcing update of folder&quot;,</span>
<a href="#l10.122"></a><span id="l10.122">                     [realFolder]);</span>
<a href="#l10.123"></a><span id="l10.123">         updateFolderAndNotify(realFolder, async_driver);</span>
<a href="#l10.124"></a><span id="l10.124">         yield false;</span>
<a href="#l10.125"></a><span id="l10.125"> </span>
<a href="#l10.126"></a><span id="l10.126" class="difflineminus">-        // XXX Ideal-world-pretending just like the local case for problems with</span>
<a href="#l10.127"></a><span id="l10.127" class="difflineminus">-        //  the new list and callFilterPlugins.  We do this after updateFolder</span>
<a href="#l10.128"></a><span id="l10.128" class="difflineminus">-        //  because the new headers aren't known until this point.  For this</span>
<a href="#l10.129"></a><span id="l10.129" class="difflineminus">-        //  to work (which it appears to do), we must be doing this before</span>
<a href="#l10.130"></a><span id="l10.130" class="difflineminus">-        //  callFilterPlugins happens.  Not sure of exactly how that is managing</span>
<a href="#l10.131"></a><span id="l10.131" class="difflineminus">-        //  to happen, but I guess it is.</span>
<a href="#l10.132"></a><span id="l10.132" class="difflineminus">-        realFolder.clearNewMessages();</span>
<a href="#l10.133"></a><span id="l10.133" class="difflineminus">-</span>
<a href="#l10.134"></a><span id="l10.134">         // compel download of the messages if appropriate</span>
<a href="#l10.135"></a><span id="l10.135">         if (realFolder.flags &amp; Ci.nsMsgFolderFlags.Offline) {</span>
<a href="#l10.136"></a><span id="l10.136">           mark_action(&quot;messageInjection&quot;, &quot;offlining messages&quot;, [realFolder]);</span>
<a href="#l10.137"></a><span id="l10.137">           realFolder.downloadAllForOffline(asyncUrlListener, null);</span>
<a href="#l10.138"></a><span id="l10.138">           yield false;</span>
<a href="#l10.139"></a><span id="l10.139">         }</span>
<a href="#l10.140"></a><span id="l10.140">       }</span>
<a href="#l10.141"></a><span id="l10.141">     }});</span>
<a href="#l10.142"></a><span id="l10.142" class="difflineat">@@ -841,18 +766,16 @@ function async_move_messages(aSynMessage</span>
<a href="#l10.143"></a><span id="l10.143"> </span>
<a href="#l10.144"></a><span id="l10.144">       let copyService = Cc[&quot;@mozilla.org/messenger/messagecopyservice;1&quot;]</span>
<a href="#l10.145"></a><span id="l10.145">                           .getService(Ci.nsIMsgCopyService);</span>
<a href="#l10.146"></a><span id="l10.146">       for (let [folder, xpcomHdrArray] in</span>
<a href="#l10.147"></a><span id="l10.147">            aSynMessageSet.foldersWithXpcomHdrArrays) {</span>
<a href="#l10.148"></a><span id="l10.148">         mark_action(&quot;messageInjection&quot;,</span>
<a href="#l10.149"></a><span id="l10.149">                     &quot;moving messages&quot;,</span>
<a href="#l10.150"></a><span id="l10.150">                     [&quot;from&quot;, folder, &quot;to&quot;, realDestFolder]);</span>
<a href="#l10.151"></a><span id="l10.151" class="difflineminus">-        _imapNewMessagesWorkaround.expectMessageInFolder(realDestFolder,</span>
<a href="#l10.152"></a><span id="l10.152" class="difflineminus">-                                                         xpcomHdrArray.length);</span>
<a href="#l10.153"></a><span id="l10.153">         copyService.CopyMessages(folder, xpcomHdrArray,</span>
<a href="#l10.154"></a><span id="l10.154">                                  realDestFolder, /* move */ true,</span>
<a href="#l10.155"></a><span id="l10.155">                                  asyncCopyListener, null,</span>
<a href="#l10.156"></a><span id="l10.156">                                  /* do not allow undo, leaks */ false);</span>
<a href="#l10.157"></a><span id="l10.157">         // update the synthetic message set's folder entry...</span>
<a href="#l10.158"></a><span id="l10.158">         aSynMessageSet._folderSwap(folder, realDestFolder);</span>
<a href="#l10.159"></a><span id="l10.159">         yield false;</span>
<a href="#l10.160"></a><span id="l10.160"> </span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

