<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 27984:d31d845ea41e096fba0c805591e1a122c5c319ed</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ d31d845ea41e096fba0c805591e1a122c5c319ed" />
<meta property="og:url" content="/comm-central/rev/d31d845ea41e096fba0c805591e1a122c5c319ed" />
<meta property="og:description" content="Bug 1533872 - Add shims for some of the dependencies of the matrix-js-sdk. r=florian" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / d31d845ea41e096fba0c805591e1a122c5c319ed 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/d31d845ea41e096fba0c805591e1a122c5c319ed">shortlog</a> |
<a href="/comm-central/log/d31d845ea41e096fba0c805591e1a122c5c319ed">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/d31d845ea41e096fba0c805591e1a122c5c319ed">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/d31d845ea41e096fba0c805591e1a122c5c319ed">files</a> |
changeset |
<a href="/comm-central/raw-rev/d31d845ea41e096fba0c805591e1a122c5c319ed">raw</a>  | <a href="/comm-central/archive/d31d845ea41e096fba0c805591e1a122c5c319ed.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1533872">Bug 1533872</a> - Add shims for some of the dependencies of the matrix-js-sdk. r=florian
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#80;&#97;&#116;&#114;&#105;&#99;&#107;&#32;&#67;&#108;&#111;&#107;&#101;&#32;&#60;&#99;&#108;&#111;&#107;&#101;&#112;&#64;&#103;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Tue, 22 Oct 2019 12:07:16 -0400</td></tr>

<tr>
 <td>changeset 27984</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/d31d845ea41e096fba0c805591e1a122c5c319ed">d31d845ea41e096fba0c805591e1a122c5c319ed</a></td>
</tr>



<tr>
<td>parent 27983</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/d296be7570aebc76856d3539c51a698ce199b1ef">d296be7570aebc76856d3539c51a698ce199b1ef</a>
</td>
</tr>

<tr>
<td>child 27985</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/251e48e6fcd084a3ade7c5006cbb246c2666c685">251e48e6fcd084a3ade7c5006cbb246c2666c685</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=d31d845ea41e096fba0c805591e1a122c5c319ed">16594</a></td></tr>
<tr><td>push user</td><td>clokep@gmail.com</td></tr>
<tr><td>push date</td><td class="date age">Tue, 22 Oct 2019 16:08:26 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@40da1ce45af3 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=40da1ce45af38afd5cfddd5a4e8a61a92d2a0250">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=40da1ce45af38afd5cfddd5a4e8a61a92d2a0250&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=40da1ce45af38afd5cfddd5a4e8a61a92d2a0250&newProject=comm-central&newRevision=64c4bc07ed19f7f358fc2e8a8805977d6c0d73e8&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=40da1ce45af38afd5cfddd5a4e8a61a92d2a0250&newProject=comm-central&newRevision=64c4bc07ed19f7f358fc2e8a8805977d6c0d73e8&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=40da1ce45af38afd5cfddd5a4e8a61a92d2a0250&newProject=comm-central&newRevision=64c4bc07ed19f7f358fc2e8a8805977d6c0d73e8&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28florian%29&revcount=50">florian</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1533872">1533872</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1533872">Bug 1533872</a> - Add shims for some of the dependencies of the matrix-js-sdk. r=florian</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d31d845ea41e096fba0c805591e1a122c5c319ed/chat/modules/imXPCOMUtils.jsm">chat/modules/imXPCOMUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d31d845ea41e096fba0c805591e1a122c5c319ed/chat/modules/imXPCOMUtils.jsm">file</a> |
<a href="/comm-central/annotate/d31d845ea41e096fba0c805591e1a122c5c319ed/chat/modules/imXPCOMUtils.jsm">annotate</a> |
<a href="/comm-central/diff/d31d845ea41e096fba0c805591e1a122c5c319ed/chat/modules/imXPCOMUtils.jsm">diff</a> |
<a href="/comm-central/comparison/d31d845ea41e096fba0c805591e1a122c5c319ed/chat/modules/imXPCOMUtils.jsm">comparison</a> |
<a href="/comm-central/log/d31d845ea41e096fba0c805591e1a122c5c319ed/chat/modules/imXPCOMUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d31d845ea41e096fba0c805591e1a122c5c319ed/chat/protocols/matrix/lib/moz.build">chat/protocols/matrix/lib/moz.build</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d31d845ea41e096fba0c805591e1a122c5c319ed/chat/protocols/matrix/lib/moz.build">file</a> |
<a href="/comm-central/annotate/d31d845ea41e096fba0c805591e1a122c5c319ed/chat/protocols/matrix/lib/moz.build">annotate</a> |
<a href="/comm-central/diff/d31d845ea41e096fba0c805591e1a122c5c319ed/chat/protocols/matrix/lib/moz.build">diff</a> |
<a href="/comm-central/comparison/d31d845ea41e096fba0c805591e1a122c5c319ed/chat/protocols/matrix/lib/moz.build">comparison</a> |
<a href="/comm-central/log/d31d845ea41e096fba0c805591e1a122c5c319ed/chat/protocols/matrix/lib/moz.build">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d31d845ea41e096fba0c805591e1a122c5c319ed/chat/protocols/matrix/lib/url/url.js">chat/protocols/matrix/lib/url/url.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/d31d845ea41e096fba0c805591e1a122c5c319ed/chat/protocols/matrix/lib/url/url.js">diff</a> |
<a href="/comm-central/comparison/d31d845ea41e096fba0c805591e1a122c5c319ed/chat/protocols/matrix/lib/url/url.js">comparison</a> |
<a href="/comm-central/log/d31d845ea41e096fba0c805591e1a122c5c319ed/chat/protocols/matrix/lib/url/url.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d31d845ea41e096fba0c805591e1a122c5c319ed/chat/protocols/matrix/matrix-sdk.jsm">chat/protocols/matrix/matrix-sdk.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d31d845ea41e096fba0c805591e1a122c5c319ed/chat/protocols/matrix/matrix-sdk.jsm">file</a> |
<a href="/comm-central/annotate/d31d845ea41e096fba0c805591e1a122c5c319ed/chat/protocols/matrix/matrix-sdk.jsm">annotate</a> |
<a href="/comm-central/diff/d31d845ea41e096fba0c805591e1a122c5c319ed/chat/protocols/matrix/matrix-sdk.jsm">diff</a> |
<a href="/comm-central/comparison/d31d845ea41e096fba0c805591e1a122c5c319ed/chat/protocols/matrix/matrix-sdk.jsm">comparison</a> |
<a href="/comm-central/log/d31d845ea41e096fba0c805591e1a122c5c319ed/chat/protocols/matrix/matrix-sdk.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d31d845ea41e096fba0c805591e1a122c5c319ed/chat/protocols/matrix/moz.build">chat/protocols/matrix/moz.build</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d31d845ea41e096fba0c805591e1a122c5c319ed/chat/protocols/matrix/moz.build">file</a> |
<a href="/comm-central/annotate/d31d845ea41e096fba0c805591e1a122c5c319ed/chat/protocols/matrix/moz.build">annotate</a> |
<a href="/comm-central/diff/d31d845ea41e096fba0c805591e1a122c5c319ed/chat/protocols/matrix/moz.build">diff</a> |
<a href="/comm-central/comparison/d31d845ea41e096fba0c805591e1a122c5c319ed/chat/protocols/matrix/moz.build">comparison</a> |
<a href="/comm-central/log/d31d845ea41e096fba0c805591e1a122c5c319ed/chat/protocols/matrix/moz.build">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d31d845ea41e096fba0c805591e1a122c5c319ed/chat/protocols/matrix/shims/loglevel.js">chat/protocols/matrix/shims/loglevel.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d31d845ea41e096fba0c805591e1a122c5c319ed/chat/protocols/matrix/shims/loglevel.js">file</a> |
<a href="/comm-central/annotate/d31d845ea41e096fba0c805591e1a122c5c319ed/chat/protocols/matrix/shims/loglevel.js">annotate</a> |
<a href="/comm-central/diff/d31d845ea41e096fba0c805591e1a122c5c319ed/chat/protocols/matrix/shims/loglevel.js">diff</a> |
<a href="/comm-central/comparison/d31d845ea41e096fba0c805591e1a122c5c319ed/chat/protocols/matrix/shims/loglevel.js">comparison</a> |
<a href="/comm-central/log/d31d845ea41e096fba0c805591e1a122c5c319ed/chat/protocols/matrix/shims/loglevel.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d31d845ea41e096fba0c805591e1a122c5c319ed/chat/protocols/matrix/shims/moz.build">chat/protocols/matrix/shims/moz.build</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d31d845ea41e096fba0c805591e1a122c5c319ed/chat/protocols/matrix/shims/moz.build">file</a> |
<a href="/comm-central/annotate/d31d845ea41e096fba0c805591e1a122c5c319ed/chat/protocols/matrix/shims/moz.build">annotate</a> |
<a href="/comm-central/diff/d31d845ea41e096fba0c805591e1a122c5c319ed/chat/protocols/matrix/shims/moz.build">diff</a> |
<a href="/comm-central/comparison/d31d845ea41e096fba0c805591e1a122c5c319ed/chat/protocols/matrix/shims/moz.build">comparison</a> |
<a href="/comm-central/log/d31d845ea41e096fba0c805591e1a122c5c319ed/chat/protocols/matrix/shims/moz.build">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d31d845ea41e096fba0c805591e1a122c5c319ed/chat/protocols/matrix/shims/safe-buffer.js">chat/protocols/matrix/shims/safe-buffer.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d31d845ea41e096fba0c805591e1a122c5c319ed/chat/protocols/matrix/shims/safe-buffer.js">file</a> |
<a href="/comm-central/annotate/d31d845ea41e096fba0c805591e1a122c5c319ed/chat/protocols/matrix/shims/safe-buffer.js">annotate</a> |
<a href="/comm-central/diff/d31d845ea41e096fba0c805591e1a122c5c319ed/chat/protocols/matrix/shims/safe-buffer.js">diff</a> |
<a href="/comm-central/comparison/d31d845ea41e096fba0c805591e1a122c5c319ed/chat/protocols/matrix/shims/safe-buffer.js">comparison</a> |
<a href="/comm-central/log/d31d845ea41e096fba0c805591e1a122c5c319ed/chat/protocols/matrix/shims/safe-buffer.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d31d845ea41e096fba0c805591e1a122c5c319ed/chat/protocols/matrix/shims/url.js">chat/protocols/matrix/shims/url.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d31d845ea41e096fba0c805591e1a122c5c319ed/chat/protocols/matrix/shims/url.js">file</a> |
<a href="/comm-central/annotate/d31d845ea41e096fba0c805591e1a122c5c319ed/chat/protocols/matrix/shims/url.js">annotate</a> |
<a href="/comm-central/diff/d31d845ea41e096fba0c805591e1a122c5c319ed/chat/protocols/matrix/shims/url.js">diff</a> |
<a href="/comm-central/comparison/d31d845ea41e096fba0c805591e1a122c5c319ed/chat/protocols/matrix/shims/url.js">comparison</a> |
<a href="/comm-central/log/d31d845ea41e096fba0c805591e1a122c5c319ed/chat/protocols/matrix/shims/url.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/chat/modules/imXPCOMUtils.jsm</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/chat/modules/imXPCOMUtils.jsm</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -7,16 +7,17 @@ this.EXPORTED_SYMBOLS = [</span>
<a href="#l1.4"></a><span id="l1.4">   &quot;setTimeout&quot;,</span>
<a href="#l1.5"></a><span id="l1.5">   &quot;clearTimeout&quot;,</span>
<a href="#l1.6"></a><span id="l1.6">   &quot;executeSoon&quot;,</span>
<a href="#l1.7"></a><span id="l1.7">   &quot;nsSimpleEnumerator&quot;,</span>
<a href="#l1.8"></a><span id="l1.8">   &quot;EmptyEnumerator&quot;,</span>
<a href="#l1.9"></a><span id="l1.9">   &quot;ClassInfo&quot;,</span>
<a href="#l1.10"></a><span id="l1.10">   &quot;l10nHelper&quot;,</span>
<a href="#l1.11"></a><span id="l1.11">   &quot;initLogModule&quot;,</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+  &quot;scriptError&quot;,</span>
<a href="#l1.13"></a><span id="l1.13"> ];</span>
<a href="#l1.14"></a><span id="l1.14"> </span>
<a href="#l1.15"></a><span id="l1.15"> const { XPCOMUtils } = ChromeUtils.import(</span>
<a href="#l1.16"></a><span id="l1.16">   &quot;resource://gre/modules/XPCOMUtils.jsm&quot;</span>
<a href="#l1.17"></a><span id="l1.17"> );</span>
<a href="#l1.18"></a><span id="l1.18"> const { Services } = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l1.19"></a><span id="l1.19"> </span>
<a href="#l1.20"></a><span id="l1.20"> var kLogLevelPref = &quot;purple.debug.loglevel&quot;;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/chat/protocols/matrix/lib/moz.build</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/chat/protocols/matrix/lib/moz.build</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -100,17 +100,16 @@ EXTRA_JS_MODULES.matrix.matrix_sdk.webrt</span>
<a href="#l2.4"></a><span id="l2.4"> # Dependencies of the Matrix SDK.</span>
<a href="#l2.5"></a><span id="l2.5"> </span>
<a href="#l2.6"></a><span id="l2.6"> # Single file dependencies (with good names) are just added to the top-level</span>
<a href="#l2.7"></a><span id="l2.7"> # matrix module.</span>
<a href="#l2.8"></a><span id="l2.8"> EXTRA_JS_MODULES.matrix += [</span>
<a href="#l2.9"></a><span id="l2.9">     'another-json/another-json.js',</span>
<a href="#l2.10"></a><span id="l2.10">     'events/events.js',</span>
<a href="#l2.11"></a><span id="l2.11">     'punycode/punycode.js',</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-    'url/url.js',</span>
<a href="#l2.13"></a><span id="l2.13"> ]</span>
<a href="#l2.14"></a><span id="l2.14"> </span>
<a href="#l2.15"></a><span id="l2.15"> EXTRA_JS_MODULES.matrix.querystring += [</span>
<a href="#l2.16"></a><span id="l2.16">     'querystring/decode.js',</span>
<a href="#l2.17"></a><span id="l2.17">     'querystring/encode.js',</span>
<a href="#l2.18"></a><span id="l2.18">     'querystring/index.js',</span>
<a href="#l2.19"></a><span id="l2.19"> ]</span>
<a href="#l2.20"></a><span id="l2.20"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1">deleted file mode 100644</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineminus">--- a/chat/protocols/matrix/lib/url/url.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineplus">+++ /dev/null</span>
<a href="#l3.4"></a><span id="l3.4" class="difflineat">@@ -1,707 +0,0 @@</span>
<a href="#l3.5"></a><span id="l3.5" class="difflineminus">-// Copyright Joyent, Inc. and other Node contributors.</span>
<a href="#l3.6"></a><span id="l3.6" class="difflineminus">-//</span>
<a href="#l3.7"></a><span id="l3.7" class="difflineminus">-// Permission is hereby granted, free of charge, to any person obtaining a</span>
<a href="#l3.8"></a><span id="l3.8" class="difflineminus">-// copy of this software and associated documentation files (the</span>
<a href="#l3.9"></a><span id="l3.9" class="difflineminus">-// &quot;Software&quot;), to deal in the Software without restriction, including</span>
<a href="#l3.10"></a><span id="l3.10" class="difflineminus">-// without limitation the rights to use, copy, modify, merge, publish,</span>
<a href="#l3.11"></a><span id="l3.11" class="difflineminus">-// distribute, sublicense, and/or sell copies of the Software, and to permit</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-// persons to whom the Software is furnished to do so, subject to the</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-// following conditions:</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineminus">-//</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineminus">-// The above copyright notice and this permission notice shall be included</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineminus">-// in all copies or substantial portions of the Software.</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineminus">-//</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineminus">-// THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineminus">-// OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineminus">-// MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineminus">-// NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineminus">-// DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineminus">-// OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineminus">-// USE OR OTHER DEALINGS IN THE SOFTWARE.</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineminus">-</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineminus">-var punycode = require('punycode');</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineminus">-</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineminus">-exports.parse = urlParse;</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineminus">-exports.resolve = urlResolve;</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineminus">-exports.resolveObject = urlResolveObject;</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineminus">-exports.format = urlFormat;</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineminus">-</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineminus">-exports.Url = Url;</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineminus">-</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineminus">-function Url() {</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineminus">-  this.protocol = null;</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineminus">-  this.slashes = null;</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineminus">-  this.auth = null;</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineminus">-  this.host = null;</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineminus">-  this.port = null;</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineminus">-  this.hostname = null;</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineminus">-  this.hash = null;</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineminus">-  this.search = null;</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineminus">-  this.query = null;</span>
<a href="#l3.45"></a><span id="l3.45" class="difflineminus">-  this.pathname = null;</span>
<a href="#l3.46"></a><span id="l3.46" class="difflineminus">-  this.path = null;</span>
<a href="#l3.47"></a><span id="l3.47" class="difflineminus">-  this.href = null;</span>
<a href="#l3.48"></a><span id="l3.48" class="difflineminus">-}</span>
<a href="#l3.49"></a><span id="l3.49" class="difflineminus">-</span>
<a href="#l3.50"></a><span id="l3.50" class="difflineminus">-// Reference: RFC 3986, RFC 1808, RFC 2396</span>
<a href="#l3.51"></a><span id="l3.51" class="difflineminus">-</span>
<a href="#l3.52"></a><span id="l3.52" class="difflineminus">-// define these here so at least they only have to be</span>
<a href="#l3.53"></a><span id="l3.53" class="difflineminus">-// compiled once on the first module load.</span>
<a href="#l3.54"></a><span id="l3.54" class="difflineminus">-var protocolPattern = /^([a-z0-9.+-]+:)/i,</span>
<a href="#l3.55"></a><span id="l3.55" class="difflineminus">-    portPattern = /:[0-9]*$/,</span>
<a href="#l3.56"></a><span id="l3.56" class="difflineminus">-</span>
<a href="#l3.57"></a><span id="l3.57" class="difflineminus">-    // RFC 2396: characters reserved for delimiting URLs.</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineminus">-    // We actually just auto-escape these.</span>
<a href="#l3.59"></a><span id="l3.59" class="difflineminus">-    delims = ['&lt;', '&gt;', '&quot;', '`', ' ', '\r', '\n', '\t'],</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineminus">-</span>
<a href="#l3.61"></a><span id="l3.61" class="difflineminus">-    // RFC 2396: characters not allowed for various reasons.</span>
<a href="#l3.62"></a><span id="l3.62" class="difflineminus">-    unwise = ['{', '}', '|', '\\', '^', '`'].concat(delims),</span>
<a href="#l3.63"></a><span id="l3.63" class="difflineminus">-</span>
<a href="#l3.64"></a><span id="l3.64" class="difflineminus">-    // Allowed by RFCs, but cause of XSS attacks.  Always escape these.</span>
<a href="#l3.65"></a><span id="l3.65" class="difflineminus">-    autoEscape = ['\''].concat(unwise),</span>
<a href="#l3.66"></a><span id="l3.66" class="difflineminus">-    // Characters that are never ever allowed in a hostname.</span>
<a href="#l3.67"></a><span id="l3.67" class="difflineminus">-    // Note that any invalid chars are also handled, but these</span>
<a href="#l3.68"></a><span id="l3.68" class="difflineminus">-    // are the ones that are *expected* to be seen, so we fast-path</span>
<a href="#l3.69"></a><span id="l3.69" class="difflineminus">-    // them.</span>
<a href="#l3.70"></a><span id="l3.70" class="difflineminus">-    nonHostChars = ['%', '/', '?', ';', '#'].concat(autoEscape),</span>
<a href="#l3.71"></a><span id="l3.71" class="difflineminus">-    hostEndingChars = ['/', '?', '#'],</span>
<a href="#l3.72"></a><span id="l3.72" class="difflineminus">-    hostnameMaxLen = 255,</span>
<a href="#l3.73"></a><span id="l3.73" class="difflineminus">-    hostnamePartPattern = /^[a-z0-9A-Z_-]{0,63}$/,</span>
<a href="#l3.74"></a><span id="l3.74" class="difflineminus">-    hostnamePartStart = /^([a-z0-9A-Z_-]{0,63})(.*)$/,</span>
<a href="#l3.75"></a><span id="l3.75" class="difflineminus">-    // protocols that can allow &quot;unsafe&quot; and &quot;unwise&quot; chars.</span>
<a href="#l3.76"></a><span id="l3.76" class="difflineminus">-    unsafeProtocol = {</span>
<a href="#l3.77"></a><span id="l3.77" class="difflineminus">-      'javascript': true,</span>
<a href="#l3.78"></a><span id="l3.78" class="difflineminus">-      'javascript:': true</span>
<a href="#l3.79"></a><span id="l3.79" class="difflineminus">-    },</span>
<a href="#l3.80"></a><span id="l3.80" class="difflineminus">-    // protocols that never have a hostname.</span>
<a href="#l3.81"></a><span id="l3.81" class="difflineminus">-    hostlessProtocol = {</span>
<a href="#l3.82"></a><span id="l3.82" class="difflineminus">-      'javascript': true,</span>
<a href="#l3.83"></a><span id="l3.83" class="difflineminus">-      'javascript:': true</span>
<a href="#l3.84"></a><span id="l3.84" class="difflineminus">-    },</span>
<a href="#l3.85"></a><span id="l3.85" class="difflineminus">-    // protocols that always contain a // bit.</span>
<a href="#l3.86"></a><span id="l3.86" class="difflineminus">-    slashedProtocol = {</span>
<a href="#l3.87"></a><span id="l3.87" class="difflineminus">-      'http': true,</span>
<a href="#l3.88"></a><span id="l3.88" class="difflineminus">-      'https': true,</span>
<a href="#l3.89"></a><span id="l3.89" class="difflineminus">-      'ftp': true,</span>
<a href="#l3.90"></a><span id="l3.90" class="difflineminus">-      'gopher': true,</span>
<a href="#l3.91"></a><span id="l3.91" class="difflineminus">-      'file': true,</span>
<a href="#l3.92"></a><span id="l3.92" class="difflineminus">-      'http:': true,</span>
<a href="#l3.93"></a><span id="l3.93" class="difflineminus">-      'https:': true,</span>
<a href="#l3.94"></a><span id="l3.94" class="difflineminus">-      'ftp:': true,</span>
<a href="#l3.95"></a><span id="l3.95" class="difflineminus">-      'gopher:': true,</span>
<a href="#l3.96"></a><span id="l3.96" class="difflineminus">-      'file:': true</span>
<a href="#l3.97"></a><span id="l3.97" class="difflineminus">-    },</span>
<a href="#l3.98"></a><span id="l3.98" class="difflineminus">-    querystring = require('querystring');</span>
<a href="#l3.99"></a><span id="l3.99" class="difflineminus">-</span>
<a href="#l3.100"></a><span id="l3.100" class="difflineminus">-function urlParse(url, parseQueryString, slashesDenoteHost) {</span>
<a href="#l3.101"></a><span id="l3.101" class="difflineminus">-  if (url &amp;&amp; isObject(url) &amp;&amp; url instanceof Url) return url;</span>
<a href="#l3.102"></a><span id="l3.102" class="difflineminus">-</span>
<a href="#l3.103"></a><span id="l3.103" class="difflineminus">-  var u = new Url;</span>
<a href="#l3.104"></a><span id="l3.104" class="difflineminus">-  u.parse(url, parseQueryString, slashesDenoteHost);</span>
<a href="#l3.105"></a><span id="l3.105" class="difflineminus">-  return u;</span>
<a href="#l3.106"></a><span id="l3.106" class="difflineminus">-}</span>
<a href="#l3.107"></a><span id="l3.107" class="difflineminus">-</span>
<a href="#l3.108"></a><span id="l3.108" class="difflineminus">-Url.prototype.parse = function(url, parseQueryString, slashesDenoteHost) {</span>
<a href="#l3.109"></a><span id="l3.109" class="difflineminus">-  if (!isString(url)) {</span>
<a href="#l3.110"></a><span id="l3.110" class="difflineminus">-    throw new TypeError(&quot;Parameter 'url' must be a string, not &quot; + typeof url);</span>
<a href="#l3.111"></a><span id="l3.111" class="difflineminus">-  }</span>
<a href="#l3.112"></a><span id="l3.112" class="difflineminus">-</span>
<a href="#l3.113"></a><span id="l3.113" class="difflineminus">-  var rest = url;</span>
<a href="#l3.114"></a><span id="l3.114" class="difflineminus">-</span>
<a href="#l3.115"></a><span id="l3.115" class="difflineminus">-  // trim before proceeding.</span>
<a href="#l3.116"></a><span id="l3.116" class="difflineminus">-  // This is to support parse stuff like &quot;  http://foo.com  \n&quot;</span>
<a href="#l3.117"></a><span id="l3.117" class="difflineminus">-  rest = rest.trim();</span>
<a href="#l3.118"></a><span id="l3.118" class="difflineminus">-</span>
<a href="#l3.119"></a><span id="l3.119" class="difflineminus">-  var proto = protocolPattern.exec(rest);</span>
<a href="#l3.120"></a><span id="l3.120" class="difflineminus">-  if (proto) {</span>
<a href="#l3.121"></a><span id="l3.121" class="difflineminus">-    proto = proto[0];</span>
<a href="#l3.122"></a><span id="l3.122" class="difflineminus">-    var lowerProto = proto.toLowerCase();</span>
<a href="#l3.123"></a><span id="l3.123" class="difflineminus">-    this.protocol = lowerProto;</span>
<a href="#l3.124"></a><span id="l3.124" class="difflineminus">-    rest = rest.substr(proto.length);</span>
<a href="#l3.125"></a><span id="l3.125" class="difflineminus">-  }</span>
<a href="#l3.126"></a><span id="l3.126" class="difflineminus">-</span>
<a href="#l3.127"></a><span id="l3.127" class="difflineminus">-  // figure out if it's got a host</span>
<a href="#l3.128"></a><span id="l3.128" class="difflineminus">-  // user@server is *always* interpreted as a hostname, and url</span>
<a href="#l3.129"></a><span id="l3.129" class="difflineminus">-  // resolution will treat //foo/bar as host=foo,path=bar because that's</span>
<a href="#l3.130"></a><span id="l3.130" class="difflineminus">-  // how the browser resolves relative URLs.</span>
<a href="#l3.131"></a><span id="l3.131" class="difflineminus">-  if (slashesDenoteHost || proto || rest.match(/^\/\/[^@\/]+@[^@\/]+/)) {</span>
<a href="#l3.132"></a><span id="l3.132" class="difflineminus">-    var slashes = rest.substr(0, 2) === '//';</span>
<a href="#l3.133"></a><span id="l3.133" class="difflineminus">-    if (slashes &amp;&amp; !(proto &amp;&amp; hostlessProtocol[proto])) {</span>
<a href="#l3.134"></a><span id="l3.134" class="difflineminus">-      rest = rest.substr(2);</span>
<a href="#l3.135"></a><span id="l3.135" class="difflineminus">-      this.slashes = true;</span>
<a href="#l3.136"></a><span id="l3.136" class="difflineminus">-    }</span>
<a href="#l3.137"></a><span id="l3.137" class="difflineminus">-  }</span>
<a href="#l3.138"></a><span id="l3.138" class="difflineminus">-</span>
<a href="#l3.139"></a><span id="l3.139" class="difflineminus">-  if (!hostlessProtocol[proto] &amp;&amp;</span>
<a href="#l3.140"></a><span id="l3.140" class="difflineminus">-      (slashes || (proto &amp;&amp; !slashedProtocol[proto]))) {</span>
<a href="#l3.141"></a><span id="l3.141" class="difflineminus">-</span>
<a href="#l3.142"></a><span id="l3.142" class="difflineminus">-    // there's a hostname.</span>
<a href="#l3.143"></a><span id="l3.143" class="difflineminus">-    // the first instance of /, ?, ;, or # ends the host.</span>
<a href="#l3.144"></a><span id="l3.144" class="difflineminus">-    //</span>
<a href="#l3.145"></a><span id="l3.145" class="difflineminus">-    // If there is an @ in the hostname, then non-host chars *are* allowed</span>
<a href="#l3.146"></a><span id="l3.146" class="difflineminus">-    // to the left of the last @ sign, unless some host-ending character</span>
<a href="#l3.147"></a><span id="l3.147" class="difflineminus">-    // comes *before* the @-sign.</span>
<a href="#l3.148"></a><span id="l3.148" class="difflineminus">-    // URLs are obnoxious.</span>
<a href="#l3.149"></a><span id="l3.149" class="difflineminus">-    //</span>
<a href="#l3.150"></a><span id="l3.150" class="difflineminus">-    // ex:</span>
<a href="#l3.151"></a><span id="l3.151" class="difflineminus">-    // http://a@b@c/ =&gt; user:a@b host:c</span>
<a href="#l3.152"></a><span id="l3.152" class="difflineminus">-    // http://a@b?@c =&gt; user:a host:c path:/?@c</span>
<a href="#l3.153"></a><span id="l3.153" class="difflineminus">-</span>
<a href="#l3.154"></a><span id="l3.154" class="difflineminus">-    // v0.12 TODO(isaacs): This is not quite how Chrome does things.</span>
<a href="#l3.155"></a><span id="l3.155" class="difflineminus">-    // Review our test case against browsers more comprehensively.</span>
<a href="#l3.156"></a><span id="l3.156" class="difflineminus">-</span>
<a href="#l3.157"></a><span id="l3.157" class="difflineminus">-    // find the first instance of any hostEndingChars</span>
<a href="#l3.158"></a><span id="l3.158" class="difflineminus">-    var hostEnd = -1;</span>
<a href="#l3.159"></a><span id="l3.159" class="difflineminus">-    for (var i = 0; i &lt; hostEndingChars.length; i++) {</span>
<a href="#l3.160"></a><span id="l3.160" class="difflineminus">-      var hec = rest.indexOf(hostEndingChars[i]);</span>
<a href="#l3.161"></a><span id="l3.161" class="difflineminus">-      if (hec !== -1 &amp;&amp; (hostEnd === -1 || hec &lt; hostEnd))</span>
<a href="#l3.162"></a><span id="l3.162" class="difflineminus">-        hostEnd = hec;</span>
<a href="#l3.163"></a><span id="l3.163" class="difflineminus">-    }</span>
<a href="#l3.164"></a><span id="l3.164" class="difflineminus">-</span>
<a href="#l3.165"></a><span id="l3.165" class="difflineminus">-    // at this point, either we have an explicit point where the</span>
<a href="#l3.166"></a><span id="l3.166" class="difflineminus">-    // auth portion cannot go past, or the last @ char is the decider.</span>
<a href="#l3.167"></a><span id="l3.167" class="difflineminus">-    var auth, atSign;</span>
<a href="#l3.168"></a><span id="l3.168" class="difflineminus">-    if (hostEnd === -1) {</span>
<a href="#l3.169"></a><span id="l3.169" class="difflineminus">-      // atSign can be anywhere.</span>
<a href="#l3.170"></a><span id="l3.170" class="difflineminus">-      atSign = rest.lastIndexOf('@');</span>
<a href="#l3.171"></a><span id="l3.171" class="difflineminus">-    } else {</span>
<a href="#l3.172"></a><span id="l3.172" class="difflineminus">-      // atSign must be in auth portion.</span>
<a href="#l3.173"></a><span id="l3.173" class="difflineminus">-      // http://a@b/c@d =&gt; host:b auth:a path:/c@d</span>
<a href="#l3.174"></a><span id="l3.174" class="difflineminus">-      atSign = rest.lastIndexOf('@', hostEnd);</span>
<a href="#l3.175"></a><span id="l3.175" class="difflineminus">-    }</span>
<a href="#l3.176"></a><span id="l3.176" class="difflineminus">-</span>
<a href="#l3.177"></a><span id="l3.177" class="difflineminus">-    // Now we have a portion which is definitely the auth.</span>
<a href="#l3.178"></a><span id="l3.178" class="difflineminus">-    // Pull that off.</span>
<a href="#l3.179"></a><span id="l3.179" class="difflineminus">-    if (atSign !== -1) {</span>
<a href="#l3.180"></a><span id="l3.180" class="difflineminus">-      auth = rest.slice(0, atSign);</span>
<a href="#l3.181"></a><span id="l3.181" class="difflineminus">-      rest = rest.slice(atSign + 1);</span>
<a href="#l3.182"></a><span id="l3.182" class="difflineminus">-      this.auth = decodeURIComponent(auth);</span>
<a href="#l3.183"></a><span id="l3.183" class="difflineminus">-    }</span>
<a href="#l3.184"></a><span id="l3.184" class="difflineminus">-</span>
<a href="#l3.185"></a><span id="l3.185" class="difflineminus">-    // the host is the remaining to the left of the first non-host char</span>
<a href="#l3.186"></a><span id="l3.186" class="difflineminus">-    hostEnd = -1;</span>
<a href="#l3.187"></a><span id="l3.187" class="difflineminus">-    for (var i = 0; i &lt; nonHostChars.length; i++) {</span>
<a href="#l3.188"></a><span id="l3.188" class="difflineminus">-      var hec = rest.indexOf(nonHostChars[i]);</span>
<a href="#l3.189"></a><span id="l3.189" class="difflineminus">-      if (hec !== -1 &amp;&amp; (hostEnd === -1 || hec &lt; hostEnd))</span>
<a href="#l3.190"></a><span id="l3.190" class="difflineminus">-        hostEnd = hec;</span>
<a href="#l3.191"></a><span id="l3.191" class="difflineminus">-    }</span>
<a href="#l3.192"></a><span id="l3.192" class="difflineminus">-    // if we still have not hit it, then the entire thing is a host.</span>
<a href="#l3.193"></a><span id="l3.193" class="difflineminus">-    if (hostEnd === -1)</span>
<a href="#l3.194"></a><span id="l3.194" class="difflineminus">-      hostEnd = rest.length;</span>
<a href="#l3.195"></a><span id="l3.195" class="difflineminus">-</span>
<a href="#l3.196"></a><span id="l3.196" class="difflineminus">-    this.host = rest.slice(0, hostEnd);</span>
<a href="#l3.197"></a><span id="l3.197" class="difflineminus">-    rest = rest.slice(hostEnd);</span>
<a href="#l3.198"></a><span id="l3.198" class="difflineminus">-</span>
<a href="#l3.199"></a><span id="l3.199" class="difflineminus">-    // pull out port.</span>
<a href="#l3.200"></a><span id="l3.200" class="difflineminus">-    this.parseHost();</span>
<a href="#l3.201"></a><span id="l3.201" class="difflineminus">-</span>
<a href="#l3.202"></a><span id="l3.202" class="difflineminus">-    // we've indicated that there is a hostname,</span>
<a href="#l3.203"></a><span id="l3.203" class="difflineminus">-    // so even if it's empty, it has to be present.</span>
<a href="#l3.204"></a><span id="l3.204" class="difflineminus">-    this.hostname = this.hostname || '';</span>
<a href="#l3.205"></a><span id="l3.205" class="difflineminus">-</span>
<a href="#l3.206"></a><span id="l3.206" class="difflineminus">-    // if hostname begins with [ and ends with ]</span>
<a href="#l3.207"></a><span id="l3.207" class="difflineminus">-    // assume that it's an IPv6 address.</span>
<a href="#l3.208"></a><span id="l3.208" class="difflineminus">-    var ipv6Hostname = this.hostname[0] === '[' &amp;&amp;</span>
<a href="#l3.209"></a><span id="l3.209" class="difflineminus">-        this.hostname[this.hostname.length - 1] === ']';</span>
<a href="#l3.210"></a><span id="l3.210" class="difflineminus">-</span>
<a href="#l3.211"></a><span id="l3.211" class="difflineminus">-    // validate a little.</span>
<a href="#l3.212"></a><span id="l3.212" class="difflineminus">-    if (!ipv6Hostname) {</span>
<a href="#l3.213"></a><span id="l3.213" class="difflineminus">-      var hostparts = this.hostname.split(/\./);</span>
<a href="#l3.214"></a><span id="l3.214" class="difflineminus">-      for (var i = 0, l = hostparts.length; i &lt; l; i++) {</span>
<a href="#l3.215"></a><span id="l3.215" class="difflineminus">-        var part = hostparts[i];</span>
<a href="#l3.216"></a><span id="l3.216" class="difflineminus">-        if (!part) continue;</span>
<a href="#l3.217"></a><span id="l3.217" class="difflineminus">-        if (!part.match(hostnamePartPattern)) {</span>
<a href="#l3.218"></a><span id="l3.218" class="difflineminus">-          var newpart = '';</span>
<a href="#l3.219"></a><span id="l3.219" class="difflineminus">-          for (var j = 0, k = part.length; j &lt; k; j++) {</span>
<a href="#l3.220"></a><span id="l3.220" class="difflineminus">-            if (part.charCodeAt(j) &gt; 127) {</span>
<a href="#l3.221"></a><span id="l3.221" class="difflineminus">-              // we replace non-ASCII char with a temporary placeholder</span>
<a href="#l3.222"></a><span id="l3.222" class="difflineminus">-              // we need this to make sure size of hostname is not</span>
<a href="#l3.223"></a><span id="l3.223" class="difflineminus">-              // broken by replacing non-ASCII by nothing</span>
<a href="#l3.224"></a><span id="l3.224" class="difflineminus">-              newpart += 'x';</span>
<a href="#l3.225"></a><span id="l3.225" class="difflineminus">-            } else {</span>
<a href="#l3.226"></a><span id="l3.226" class="difflineminus">-              newpart += part[j];</span>
<a href="#l3.227"></a><span id="l3.227" class="difflineminus">-            }</span>
<a href="#l3.228"></a><span id="l3.228" class="difflineminus">-          }</span>
<a href="#l3.229"></a><span id="l3.229" class="difflineminus">-          // we test again with ASCII char only</span>
<a href="#l3.230"></a><span id="l3.230" class="difflineminus">-          if (!newpart.match(hostnamePartPattern)) {</span>
<a href="#l3.231"></a><span id="l3.231" class="difflineminus">-            var validParts = hostparts.slice(0, i);</span>
<a href="#l3.232"></a><span id="l3.232" class="difflineminus">-            var notHost = hostparts.slice(i + 1);</span>
<a href="#l3.233"></a><span id="l3.233" class="difflineminus">-            var bit = part.match(hostnamePartStart);</span>
<a href="#l3.234"></a><span id="l3.234" class="difflineminus">-            if (bit) {</span>
<a href="#l3.235"></a><span id="l3.235" class="difflineminus">-              validParts.push(bit[1]);</span>
<a href="#l3.236"></a><span id="l3.236" class="difflineminus">-              notHost.unshift(bit[2]);</span>
<a href="#l3.237"></a><span id="l3.237" class="difflineminus">-            }</span>
<a href="#l3.238"></a><span id="l3.238" class="difflineminus">-            if (notHost.length) {</span>
<a href="#l3.239"></a><span id="l3.239" class="difflineminus">-              rest = '/' + notHost.join('.') + rest;</span>
<a href="#l3.240"></a><span id="l3.240" class="difflineminus">-            }</span>
<a href="#l3.241"></a><span id="l3.241" class="difflineminus">-            this.hostname = validParts.join('.');</span>
<a href="#l3.242"></a><span id="l3.242" class="difflineminus">-            break;</span>
<a href="#l3.243"></a><span id="l3.243" class="difflineminus">-          }</span>
<a href="#l3.244"></a><span id="l3.244" class="difflineminus">-        }</span>
<a href="#l3.245"></a><span id="l3.245" class="difflineminus">-      }</span>
<a href="#l3.246"></a><span id="l3.246" class="difflineminus">-    }</span>
<a href="#l3.247"></a><span id="l3.247" class="difflineminus">-</span>
<a href="#l3.248"></a><span id="l3.248" class="difflineminus">-    if (this.hostname.length &gt; hostnameMaxLen) {</span>
<a href="#l3.249"></a><span id="l3.249" class="difflineminus">-      this.hostname = '';</span>
<a href="#l3.250"></a><span id="l3.250" class="difflineminus">-    } else {</span>
<a href="#l3.251"></a><span id="l3.251" class="difflineminus">-      // hostnames are always lower case.</span>
<a href="#l3.252"></a><span id="l3.252" class="difflineminus">-      this.hostname = this.hostname.toLowerCase();</span>
<a href="#l3.253"></a><span id="l3.253" class="difflineminus">-    }</span>
<a href="#l3.254"></a><span id="l3.254" class="difflineminus">-</span>
<a href="#l3.255"></a><span id="l3.255" class="difflineminus">-    if (!ipv6Hostname) {</span>
<a href="#l3.256"></a><span id="l3.256" class="difflineminus">-      // IDNA Support: Returns a puny coded representation of &quot;domain&quot;.</span>
<a href="#l3.257"></a><span id="l3.257" class="difflineminus">-      // It only converts the part of the domain name that</span>
<a href="#l3.258"></a><span id="l3.258" class="difflineminus">-      // has non ASCII characters. I.e. it dosent matter if</span>
<a href="#l3.259"></a><span id="l3.259" class="difflineminus">-      // you call it with a domain that already is in ASCII.</span>
<a href="#l3.260"></a><span id="l3.260" class="difflineminus">-      var domainArray = this.hostname.split('.');</span>
<a href="#l3.261"></a><span id="l3.261" class="difflineminus">-      var newOut = [];</span>
<a href="#l3.262"></a><span id="l3.262" class="difflineminus">-      for (var i = 0; i &lt; domainArray.length; ++i) {</span>
<a href="#l3.263"></a><span id="l3.263" class="difflineminus">-        var s = domainArray[i];</span>
<a href="#l3.264"></a><span id="l3.264" class="difflineminus">-        newOut.push(s.match(/[^A-Za-z0-9_-]/) ?</span>
<a href="#l3.265"></a><span id="l3.265" class="difflineminus">-            'xn--' + punycode.encode(s) : s);</span>
<a href="#l3.266"></a><span id="l3.266" class="difflineminus">-      }</span>
<a href="#l3.267"></a><span id="l3.267" class="difflineminus">-      this.hostname = newOut.join('.');</span>
<a href="#l3.268"></a><span id="l3.268" class="difflineminus">-    }</span>
<a href="#l3.269"></a><span id="l3.269" class="difflineminus">-</span>
<a href="#l3.270"></a><span id="l3.270" class="difflineminus">-    var p = this.port ? ':' + this.port : '';</span>
<a href="#l3.271"></a><span id="l3.271" class="difflineminus">-    var h = this.hostname || '';</span>
<a href="#l3.272"></a><span id="l3.272" class="difflineminus">-    this.host = h + p;</span>
<a href="#l3.273"></a><span id="l3.273" class="difflineminus">-    this.href += this.host;</span>
<a href="#l3.274"></a><span id="l3.274" class="difflineminus">-</span>
<a href="#l3.275"></a><span id="l3.275" class="difflineminus">-    // strip [ and ] from the hostname</span>
<a href="#l3.276"></a><span id="l3.276" class="difflineminus">-    // the host field still retains them, though</span>
<a href="#l3.277"></a><span id="l3.277" class="difflineminus">-    if (ipv6Hostname) {</span>
<a href="#l3.278"></a><span id="l3.278" class="difflineminus">-      this.hostname = this.hostname.substr(1, this.hostname.length - 2);</span>
<a href="#l3.279"></a><span id="l3.279" class="difflineminus">-      if (rest[0] !== '/') {</span>
<a href="#l3.280"></a><span id="l3.280" class="difflineminus">-        rest = '/' + rest;</span>
<a href="#l3.281"></a><span id="l3.281" class="difflineminus">-      }</span>
<a href="#l3.282"></a><span id="l3.282" class="difflineminus">-    }</span>
<a href="#l3.283"></a><span id="l3.283" class="difflineminus">-  }</span>
<a href="#l3.284"></a><span id="l3.284" class="difflineminus">-</span>
<a href="#l3.285"></a><span id="l3.285" class="difflineminus">-  // now rest is set to the post-host stuff.</span>
<a href="#l3.286"></a><span id="l3.286" class="difflineminus">-  // chop off any delim chars.</span>
<a href="#l3.287"></a><span id="l3.287" class="difflineminus">-  if (!unsafeProtocol[lowerProto]) {</span>
<a href="#l3.288"></a><span id="l3.288" class="difflineminus">-</span>
<a href="#l3.289"></a><span id="l3.289" class="difflineminus">-    // First, make 100% sure that any &quot;autoEscape&quot; chars get</span>
<a href="#l3.290"></a><span id="l3.290" class="difflineminus">-    // escaped, even if encodeURIComponent doesn't think they</span>
<a href="#l3.291"></a><span id="l3.291" class="difflineminus">-    // need to be.</span>
<a href="#l3.292"></a><span id="l3.292" class="difflineminus">-    for (var i = 0, l = autoEscape.length; i &lt; l; i++) {</span>
<a href="#l3.293"></a><span id="l3.293" class="difflineminus">-      var ae = autoEscape[i];</span>
<a href="#l3.294"></a><span id="l3.294" class="difflineminus">-      var esc = encodeURIComponent(ae);</span>
<a href="#l3.295"></a><span id="l3.295" class="difflineminus">-      if (esc === ae) {</span>
<a href="#l3.296"></a><span id="l3.296" class="difflineminus">-        esc = escape(ae);</span>
<a href="#l3.297"></a><span id="l3.297" class="difflineminus">-      }</span>
<a href="#l3.298"></a><span id="l3.298" class="difflineminus">-      rest = rest.split(ae).join(esc);</span>
<a href="#l3.299"></a><span id="l3.299" class="difflineminus">-    }</span>
<a href="#l3.300"></a><span id="l3.300" class="difflineminus">-  }</span>
<a href="#l3.301"></a><span id="l3.301" class="difflineminus">-</span>
<a href="#l3.302"></a><span id="l3.302" class="difflineminus">-</span>
<a href="#l3.303"></a><span id="l3.303" class="difflineminus">-  // chop off from the tail first.</span>
<a href="#l3.304"></a><span id="l3.304" class="difflineminus">-  var hash = rest.indexOf('#');</span>
<a href="#l3.305"></a><span id="l3.305" class="difflineminus">-  if (hash !== -1) {</span>
<a href="#l3.306"></a><span id="l3.306" class="difflineminus">-    // got a fragment string.</span>
<a href="#l3.307"></a><span id="l3.307" class="difflineminus">-    this.hash = rest.substr(hash);</span>
<a href="#l3.308"></a><span id="l3.308" class="difflineminus">-    rest = rest.slice(0, hash);</span>
<a href="#l3.309"></a><span id="l3.309" class="difflineminus">-  }</span>
<a href="#l3.310"></a><span id="l3.310" class="difflineminus">-  var qm = rest.indexOf('?');</span>
<a href="#l3.311"></a><span id="l3.311" class="difflineminus">-  if (qm !== -1) {</span>
<a href="#l3.312"></a><span id="l3.312" class="difflineminus">-    this.search = rest.substr(qm);</span>
<a href="#l3.313"></a><span id="l3.313" class="difflineminus">-    this.query = rest.substr(qm + 1);</span>
<a href="#l3.314"></a><span id="l3.314" class="difflineminus">-    if (parseQueryString) {</span>
<a href="#l3.315"></a><span id="l3.315" class="difflineminus">-      this.query = querystring.parse(this.query);</span>
<a href="#l3.316"></a><span id="l3.316" class="difflineminus">-    }</span>
<a href="#l3.317"></a><span id="l3.317" class="difflineminus">-    rest = rest.slice(0, qm);</span>
<a href="#l3.318"></a><span id="l3.318" class="difflineminus">-  } else if (parseQueryString) {</span>
<a href="#l3.319"></a><span id="l3.319" class="difflineminus">-    // no query string, but parseQueryString still requested</span>
<a href="#l3.320"></a><span id="l3.320" class="difflineminus">-    this.search = '';</span>
<a href="#l3.321"></a><span id="l3.321" class="difflineminus">-    this.query = {};</span>
<a href="#l3.322"></a><span id="l3.322" class="difflineminus">-  }</span>
<a href="#l3.323"></a><span id="l3.323" class="difflineminus">-  if (rest) this.pathname = rest;</span>
<a href="#l3.324"></a><span id="l3.324" class="difflineminus">-  if (slashedProtocol[lowerProto] &amp;&amp;</span>
<a href="#l3.325"></a><span id="l3.325" class="difflineminus">-      this.hostname &amp;&amp; !this.pathname) {</span>
<a href="#l3.326"></a><span id="l3.326" class="difflineminus">-    this.pathname = '/';</span>
<a href="#l3.327"></a><span id="l3.327" class="difflineminus">-  }</span>
<a href="#l3.328"></a><span id="l3.328" class="difflineminus">-</span>
<a href="#l3.329"></a><span id="l3.329" class="difflineminus">-  //to support http.request</span>
<a href="#l3.330"></a><span id="l3.330" class="difflineminus">-  if (this.pathname || this.search) {</span>
<a href="#l3.331"></a><span id="l3.331" class="difflineminus">-    var p = this.pathname || '';</span>
<a href="#l3.332"></a><span id="l3.332" class="difflineminus">-    var s = this.search || '';</span>
<a href="#l3.333"></a><span id="l3.333" class="difflineminus">-    this.path = p + s;</span>
<a href="#l3.334"></a><span id="l3.334" class="difflineminus">-  }</span>
<a href="#l3.335"></a><span id="l3.335" class="difflineminus">-</span>
<a href="#l3.336"></a><span id="l3.336" class="difflineminus">-  // finally, reconstruct the href based on what has been validated.</span>
<a href="#l3.337"></a><span id="l3.337" class="difflineminus">-  this.href = this.format();</span>
<a href="#l3.338"></a><span id="l3.338" class="difflineminus">-  return this;</span>
<a href="#l3.339"></a><span id="l3.339" class="difflineminus">-};</span>
<a href="#l3.340"></a><span id="l3.340" class="difflineminus">-</span>
<a href="#l3.341"></a><span id="l3.341" class="difflineminus">-// format a parsed object into a url string</span>
<a href="#l3.342"></a><span id="l3.342" class="difflineminus">-function urlFormat(obj) {</span>
<a href="#l3.343"></a><span id="l3.343" class="difflineminus">-  // ensure it's an object, and not a string url.</span>
<a href="#l3.344"></a><span id="l3.344" class="difflineminus">-  // If it's an obj, this is a no-op.</span>
<a href="#l3.345"></a><span id="l3.345" class="difflineminus">-  // this way, you can call url_format() on strings</span>
<a href="#l3.346"></a><span id="l3.346" class="difflineminus">-  // to clean up potentially wonky urls.</span>
<a href="#l3.347"></a><span id="l3.347" class="difflineminus">-  if (isString(obj)) obj = urlParse(obj);</span>
<a href="#l3.348"></a><span id="l3.348" class="difflineminus">-  if (!(obj instanceof Url)) return Url.prototype.format.call(obj);</span>
<a href="#l3.349"></a><span id="l3.349" class="difflineminus">-  return obj.format();</span>
<a href="#l3.350"></a><span id="l3.350" class="difflineminus">-}</span>
<a href="#l3.351"></a><span id="l3.351" class="difflineminus">-</span>
<a href="#l3.352"></a><span id="l3.352" class="difflineminus">-Url.prototype.format = function() {</span>
<a href="#l3.353"></a><span id="l3.353" class="difflineminus">-  var auth = this.auth || '';</span>
<a href="#l3.354"></a><span id="l3.354" class="difflineminus">-  if (auth) {</span>
<a href="#l3.355"></a><span id="l3.355" class="difflineminus">-    auth = encodeURIComponent(auth);</span>
<a href="#l3.356"></a><span id="l3.356" class="difflineminus">-    auth = auth.replace(/%3A/i, ':');</span>
<a href="#l3.357"></a><span id="l3.357" class="difflineminus">-    auth += '@';</span>
<a href="#l3.358"></a><span id="l3.358" class="difflineminus">-  }</span>
<a href="#l3.359"></a><span id="l3.359" class="difflineminus">-</span>
<a href="#l3.360"></a><span id="l3.360" class="difflineminus">-  var protocol = this.protocol || '',</span>
<a href="#l3.361"></a><span id="l3.361" class="difflineminus">-      pathname = this.pathname || '',</span>
<a href="#l3.362"></a><span id="l3.362" class="difflineminus">-      hash = this.hash || '',</span>
<a href="#l3.363"></a><span id="l3.363" class="difflineminus">-      host = false,</span>
<a href="#l3.364"></a><span id="l3.364" class="difflineminus">-      query = '';</span>
<a href="#l3.365"></a><span id="l3.365" class="difflineminus">-</span>
<a href="#l3.366"></a><span id="l3.366" class="difflineminus">-  if (this.host) {</span>
<a href="#l3.367"></a><span id="l3.367" class="difflineminus">-    host = auth + this.host;</span>
<a href="#l3.368"></a><span id="l3.368" class="difflineminus">-  } else if (this.hostname) {</span>
<a href="#l3.369"></a><span id="l3.369" class="difflineminus">-    host = auth + (this.hostname.indexOf(':') === -1 ?</span>
<a href="#l3.370"></a><span id="l3.370" class="difflineminus">-        this.hostname :</span>
<a href="#l3.371"></a><span id="l3.371" class="difflineminus">-        '[' + this.hostname + ']');</span>
<a href="#l3.372"></a><span id="l3.372" class="difflineminus">-    if (this.port) {</span>
<a href="#l3.373"></a><span id="l3.373" class="difflineminus">-      host += ':' + this.port;</span>
<a href="#l3.374"></a><span id="l3.374" class="difflineminus">-    }</span>
<a href="#l3.375"></a><span id="l3.375" class="difflineminus">-  }</span>
<a href="#l3.376"></a><span id="l3.376" class="difflineminus">-</span>
<a href="#l3.377"></a><span id="l3.377" class="difflineminus">-  if (this.query &amp;&amp;</span>
<a href="#l3.378"></a><span id="l3.378" class="difflineminus">-      isObject(this.query) &amp;&amp;</span>
<a href="#l3.379"></a><span id="l3.379" class="difflineminus">-      Object.keys(this.query).length) {</span>
<a href="#l3.380"></a><span id="l3.380" class="difflineminus">-    query = querystring.stringify(this.query);</span>
<a href="#l3.381"></a><span id="l3.381" class="difflineminus">-  }</span>
<a href="#l3.382"></a><span id="l3.382" class="difflineminus">-</span>
<a href="#l3.383"></a><span id="l3.383" class="difflineminus">-  var search = this.search || (query &amp;&amp; ('?' + query)) || '';</span>
<a href="#l3.384"></a><span id="l3.384" class="difflineminus">-</span>
<a href="#l3.385"></a><span id="l3.385" class="difflineminus">-  if (protocol &amp;&amp; protocol.substr(-1) !== ':') protocol += ':';</span>
<a href="#l3.386"></a><span id="l3.386" class="difflineminus">-</span>
<a href="#l3.387"></a><span id="l3.387" class="difflineminus">-  // only the slashedProtocols get the //.  Not mailto:, xmpp:, etc.</span>
<a href="#l3.388"></a><span id="l3.388" class="difflineminus">-  // unless they had them to begin with.</span>
<a href="#l3.389"></a><span id="l3.389" class="difflineminus">-  if (this.slashes ||</span>
<a href="#l3.390"></a><span id="l3.390" class="difflineminus">-      (!protocol || slashedProtocol[protocol]) &amp;&amp; host !== false) {</span>
<a href="#l3.391"></a><span id="l3.391" class="difflineminus">-    host = '//' + (host || '');</span>
<a href="#l3.392"></a><span id="l3.392" class="difflineminus">-    if (pathname &amp;&amp; pathname.charAt(0) !== '/') pathname = '/' + pathname;</span>
<a href="#l3.393"></a><span id="l3.393" class="difflineminus">-  } else if (!host) {</span>
<a href="#l3.394"></a><span id="l3.394" class="difflineminus">-    host = '';</span>
<a href="#l3.395"></a><span id="l3.395" class="difflineminus">-  }</span>
<a href="#l3.396"></a><span id="l3.396" class="difflineminus">-</span>
<a href="#l3.397"></a><span id="l3.397" class="difflineminus">-  if (hash &amp;&amp; hash.charAt(0) !== '#') hash = '#' + hash;</span>
<a href="#l3.398"></a><span id="l3.398" class="difflineminus">-  if (search &amp;&amp; search.charAt(0) !== '?') search = '?' + search;</span>
<a href="#l3.399"></a><span id="l3.399" class="difflineminus">-</span>
<a href="#l3.400"></a><span id="l3.400" class="difflineminus">-  pathname = pathname.replace(/[?#]/g, function(match) {</span>
<a href="#l3.401"></a><span id="l3.401" class="difflineminus">-    return encodeURIComponent(match);</span>
<a href="#l3.402"></a><span id="l3.402" class="difflineminus">-  });</span>
<a href="#l3.403"></a><span id="l3.403" class="difflineminus">-  search = search.replace('#', '%23');</span>
<a href="#l3.404"></a><span id="l3.404" class="difflineminus">-</span>
<a href="#l3.405"></a><span id="l3.405" class="difflineminus">-  return protocol + host + pathname + search + hash;</span>
<a href="#l3.406"></a><span id="l3.406" class="difflineminus">-};</span>
<a href="#l3.407"></a><span id="l3.407" class="difflineminus">-</span>
<a href="#l3.408"></a><span id="l3.408" class="difflineminus">-function urlResolve(source, relative) {</span>
<a href="#l3.409"></a><span id="l3.409" class="difflineminus">-  return urlParse(source, false, true).resolve(relative);</span>
<a href="#l3.410"></a><span id="l3.410" class="difflineminus">-}</span>
<a href="#l3.411"></a><span id="l3.411" class="difflineminus">-</span>
<a href="#l3.412"></a><span id="l3.412" class="difflineminus">-Url.prototype.resolve = function(relative) {</span>
<a href="#l3.413"></a><span id="l3.413" class="difflineminus">-  return this.resolveObject(urlParse(relative, false, true)).format();</span>
<a href="#l3.414"></a><span id="l3.414" class="difflineminus">-};</span>
<a href="#l3.415"></a><span id="l3.415" class="difflineminus">-</span>
<a href="#l3.416"></a><span id="l3.416" class="difflineminus">-function urlResolveObject(source, relative) {</span>
<a href="#l3.417"></a><span id="l3.417" class="difflineminus">-  if (!source) return relative;</span>
<a href="#l3.418"></a><span id="l3.418" class="difflineminus">-  return urlParse(source, false, true).resolveObject(relative);</span>
<a href="#l3.419"></a><span id="l3.419" class="difflineminus">-}</span>
<a href="#l3.420"></a><span id="l3.420" class="difflineminus">-</span>
<a href="#l3.421"></a><span id="l3.421" class="difflineminus">-Url.prototype.resolveObject = function(relative) {</span>
<a href="#l3.422"></a><span id="l3.422" class="difflineminus">-  if (isString(relative)) {</span>
<a href="#l3.423"></a><span id="l3.423" class="difflineminus">-    var rel = new Url();</span>
<a href="#l3.424"></a><span id="l3.424" class="difflineminus">-    rel.parse(relative, false, true);</span>
<a href="#l3.425"></a><span id="l3.425" class="difflineminus">-    relative = rel;</span>
<a href="#l3.426"></a><span id="l3.426" class="difflineminus">-  }</span>
<a href="#l3.427"></a><span id="l3.427" class="difflineminus">-</span>
<a href="#l3.428"></a><span id="l3.428" class="difflineminus">-  var result = new Url();</span>
<a href="#l3.429"></a><span id="l3.429" class="difflineminus">-  Object.keys(this).forEach(function(k) {</span>
<a href="#l3.430"></a><span id="l3.430" class="difflineminus">-    result[k] = this[k];</span>
<a href="#l3.431"></a><span id="l3.431" class="difflineminus">-  }, this);</span>
<a href="#l3.432"></a><span id="l3.432" class="difflineminus">-</span>
<a href="#l3.433"></a><span id="l3.433" class="difflineminus">-  // hash is always overridden, no matter what.</span>
<a href="#l3.434"></a><span id="l3.434" class="difflineminus">-  // even href=&quot;&quot; will remove it.</span>
<a href="#l3.435"></a><span id="l3.435" class="difflineminus">-  result.hash = relative.hash;</span>
<a href="#l3.436"></a><span id="l3.436" class="difflineminus">-</span>
<a href="#l3.437"></a><span id="l3.437" class="difflineminus">-  // if the relative url is empty, then there's nothing left to do here.</span>
<a href="#l3.438"></a><span id="l3.438" class="difflineminus">-  if (relative.href === '') {</span>
<a href="#l3.439"></a><span id="l3.439" class="difflineminus">-    result.href = result.format();</span>
<a href="#l3.440"></a><span id="l3.440" class="difflineminus">-    return result;</span>
<a href="#l3.441"></a><span id="l3.441" class="difflineminus">-  }</span>
<a href="#l3.442"></a><span id="l3.442" class="difflineminus">-</span>
<a href="#l3.443"></a><span id="l3.443" class="difflineminus">-  // hrefs like //foo/bar always cut to the protocol.</span>
<a href="#l3.444"></a><span id="l3.444" class="difflineminus">-  if (relative.slashes &amp;&amp; !relative.protocol) {</span>
<a href="#l3.445"></a><span id="l3.445" class="difflineminus">-    // take everything except the protocol from relative</span>
<a href="#l3.446"></a><span id="l3.446" class="difflineminus">-    Object.keys(relative).forEach(function(k) {</span>
<a href="#l3.447"></a><span id="l3.447" class="difflineminus">-      if (k !== 'protocol')</span>
<a href="#l3.448"></a><span id="l3.448" class="difflineminus">-        result[k] = relative[k];</span>
<a href="#l3.449"></a><span id="l3.449" class="difflineminus">-    });</span>
<a href="#l3.450"></a><span id="l3.450" class="difflineminus">-</span>
<a href="#l3.451"></a><span id="l3.451" class="difflineminus">-    //urlParse appends trailing / to urls like http://www.example.com</span>
<a href="#l3.452"></a><span id="l3.452" class="difflineminus">-    if (slashedProtocol[result.protocol] &amp;&amp;</span>
<a href="#l3.453"></a><span id="l3.453" class="difflineminus">-        result.hostname &amp;&amp; !result.pathname) {</span>
<a href="#l3.454"></a><span id="l3.454" class="difflineminus">-      result.path = result.pathname = '/';</span>
<a href="#l3.455"></a><span id="l3.455" class="difflineminus">-    }</span>
<a href="#l3.456"></a><span id="l3.456" class="difflineminus">-</span>
<a href="#l3.457"></a><span id="l3.457" class="difflineminus">-    result.href = result.format();</span>
<a href="#l3.458"></a><span id="l3.458" class="difflineminus">-    return result;</span>
<a href="#l3.459"></a><span id="l3.459" class="difflineminus">-  }</span>
<a href="#l3.460"></a><span id="l3.460" class="difflineminus">-</span>
<a href="#l3.461"></a><span id="l3.461" class="difflineminus">-  if (relative.protocol &amp;&amp; relative.protocol !== result.protocol) {</span>
<a href="#l3.462"></a><span id="l3.462" class="difflineminus">-    // if it's a known url protocol, then changing</span>
<a href="#l3.463"></a><span id="l3.463" class="difflineminus">-    // the protocol does weird things</span>
<a href="#l3.464"></a><span id="l3.464" class="difflineminus">-    // first, if it's not file:, then we MUST have a host,</span>
<a href="#l3.465"></a><span id="l3.465" class="difflineminus">-    // and if there was a path</span>
<a href="#l3.466"></a><span id="l3.466" class="difflineminus">-    // to begin with, then we MUST have a path.</span>
<a href="#l3.467"></a><span id="l3.467" class="difflineminus">-    // if it is file:, then the host is dropped,</span>
<a href="#l3.468"></a><span id="l3.468" class="difflineminus">-    // because that's known to be hostless.</span>
<a href="#l3.469"></a><span id="l3.469" class="difflineminus">-    // anything else is assumed to be absolute.</span>
<a href="#l3.470"></a><span id="l3.470" class="difflineminus">-    if (!slashedProtocol[relative.protocol]) {</span>
<a href="#l3.471"></a><span id="l3.471" class="difflineminus">-      Object.keys(relative).forEach(function(k) {</span>
<a href="#l3.472"></a><span id="l3.472" class="difflineminus">-        result[k] = relative[k];</span>
<a href="#l3.473"></a><span id="l3.473" class="difflineminus">-      });</span>
<a href="#l3.474"></a><span id="l3.474" class="difflineminus">-      result.href = result.format();</span>
<a href="#l3.475"></a><span id="l3.475" class="difflineminus">-      return result;</span>
<a href="#l3.476"></a><span id="l3.476" class="difflineminus">-    }</span>
<a href="#l3.477"></a><span id="l3.477" class="difflineminus">-</span>
<a href="#l3.478"></a><span id="l3.478" class="difflineminus">-    result.protocol = relative.protocol;</span>
<a href="#l3.479"></a><span id="l3.479" class="difflineminus">-    if (!relative.host &amp;&amp; !hostlessProtocol[relative.protocol]) {</span>
<a href="#l3.480"></a><span id="l3.480" class="difflineminus">-      var relPath = (relative.pathname || '').split('/');</span>
<a href="#l3.481"></a><span id="l3.481" class="difflineminus">-      while (relPath.length &amp;&amp; !(relative.host = relPath.shift()));</span>
<a href="#l3.482"></a><span id="l3.482" class="difflineminus">-      if (!relative.host) relative.host = '';</span>
<a href="#l3.483"></a><span id="l3.483" class="difflineminus">-      if (!relative.hostname) relative.hostname = '';</span>
<a href="#l3.484"></a><span id="l3.484" class="difflineminus">-      if (relPath[0] !== '') relPath.unshift('');</span>
<a href="#l3.485"></a><span id="l3.485" class="difflineminus">-      if (relPath.length &lt; 2) relPath.unshift('');</span>
<a href="#l3.486"></a><span id="l3.486" class="difflineminus">-      result.pathname = relPath.join('/');</span>
<a href="#l3.487"></a><span id="l3.487" class="difflineminus">-    } else {</span>
<a href="#l3.488"></a><span id="l3.488" class="difflineminus">-      result.pathname = relative.pathname;</span>
<a href="#l3.489"></a><span id="l3.489" class="difflineminus">-    }</span>
<a href="#l3.490"></a><span id="l3.490" class="difflineminus">-    result.search = relative.search;</span>
<a href="#l3.491"></a><span id="l3.491" class="difflineminus">-    result.query = relative.query;</span>
<a href="#l3.492"></a><span id="l3.492" class="difflineminus">-    result.host = relative.host || '';</span>
<a href="#l3.493"></a><span id="l3.493" class="difflineminus">-    result.auth = relative.auth;</span>
<a href="#l3.494"></a><span id="l3.494" class="difflineminus">-    result.hostname = relative.hostname || relative.host;</span>
<a href="#l3.495"></a><span id="l3.495" class="difflineminus">-    result.port = relative.port;</span>
<a href="#l3.496"></a><span id="l3.496" class="difflineminus">-    // to support http.request</span>
<a href="#l3.497"></a><span id="l3.497" class="difflineminus">-    if (result.pathname || result.search) {</span>
<a href="#l3.498"></a><span id="l3.498" class="difflineminus">-      var p = result.pathname || '';</span>
<a href="#l3.499"></a><span id="l3.499" class="difflineminus">-      var s = result.search || '';</span>
<a href="#l3.500"></a><span id="l3.500" class="difflineminus">-      result.path = p + s;</span>
<a href="#l3.501"></a><span id="l3.501" class="difflineminus">-    }</span>
<a href="#l3.502"></a><span id="l3.502" class="difflineminus">-    result.slashes = result.slashes || relative.slashes;</span>
<a href="#l3.503"></a><span id="l3.503" class="difflineminus">-    result.href = result.format();</span>
<a href="#l3.504"></a><span id="l3.504" class="difflineminus">-    return result;</span>
<a href="#l3.505"></a><span id="l3.505" class="difflineminus">-  }</span>
<a href="#l3.506"></a><span id="l3.506" class="difflineminus">-</span>
<a href="#l3.507"></a><span id="l3.507" class="difflineminus">-  var isSourceAbs = (result.pathname &amp;&amp; result.pathname.charAt(0) === '/'),</span>
<a href="#l3.508"></a><span id="l3.508" class="difflineminus">-      isRelAbs = (</span>
<a href="#l3.509"></a><span id="l3.509" class="difflineminus">-          relative.host ||</span>
<a href="#l3.510"></a><span id="l3.510" class="difflineminus">-          relative.pathname &amp;&amp; relative.pathname.charAt(0) === '/'</span>
<a href="#l3.511"></a><span id="l3.511" class="difflineminus">-      ),</span>
<a href="#l3.512"></a><span id="l3.512" class="difflineminus">-      mustEndAbs = (isRelAbs || isSourceAbs ||</span>
<a href="#l3.513"></a><span id="l3.513" class="difflineminus">-                    (result.host &amp;&amp; relative.pathname)),</span>
<a href="#l3.514"></a><span id="l3.514" class="difflineminus">-      removeAllDots = mustEndAbs,</span>
<a href="#l3.515"></a><span id="l3.515" class="difflineminus">-      srcPath = result.pathname &amp;&amp; result.pathname.split('/') || [],</span>
<a href="#l3.516"></a><span id="l3.516" class="difflineminus">-      relPath = relative.pathname &amp;&amp; relative.pathname.split('/') || [],</span>
<a href="#l3.517"></a><span id="l3.517" class="difflineminus">-      psychotic = result.protocol &amp;&amp; !slashedProtocol[result.protocol];</span>
<a href="#l3.518"></a><span id="l3.518" class="difflineminus">-</span>
<a href="#l3.519"></a><span id="l3.519" class="difflineminus">-  // if the url is a non-slashed url, then relative</span>
<a href="#l3.520"></a><span id="l3.520" class="difflineminus">-  // links like ../.. should be able</span>
<a href="#l3.521"></a><span id="l3.521" class="difflineminus">-  // to crawl up to the hostname, as well.  This is strange.</span>
<a href="#l3.522"></a><span id="l3.522" class="difflineminus">-  // result.protocol has already been set by now.</span>
<a href="#l3.523"></a><span id="l3.523" class="difflineminus">-  // Later on, put the first path part into the host field.</span>
<a href="#l3.524"></a><span id="l3.524" class="difflineminus">-  if (psychotic) {</span>
<a href="#l3.525"></a><span id="l3.525" class="difflineminus">-    result.hostname = '';</span>
<a href="#l3.526"></a><span id="l3.526" class="difflineminus">-    result.port = null;</span>
<a href="#l3.527"></a><span id="l3.527" class="difflineminus">-    if (result.host) {</span>
<a href="#l3.528"></a><span id="l3.528" class="difflineminus">-      if (srcPath[0] === '') srcPath[0] = result.host;</span>
<a href="#l3.529"></a><span id="l3.529" class="difflineminus">-      else srcPath.unshift(result.host);</span>
<a href="#l3.530"></a><span id="l3.530" class="difflineminus">-    }</span>
<a href="#l3.531"></a><span id="l3.531" class="difflineminus">-    result.host = '';</span>
<a href="#l3.532"></a><span id="l3.532" class="difflineminus">-    if (relative.protocol) {</span>
<a href="#l3.533"></a><span id="l3.533" class="difflineminus">-      relative.hostname = null;</span>
<a href="#l3.534"></a><span id="l3.534" class="difflineminus">-      relative.port = null;</span>
<a href="#l3.535"></a><span id="l3.535" class="difflineminus">-      if (relative.host) {</span>
<a href="#l3.536"></a><span id="l3.536" class="difflineminus">-        if (relPath[0] === '') relPath[0] = relative.host;</span>
<a href="#l3.537"></a><span id="l3.537" class="difflineminus">-        else relPath.unshift(relative.host);</span>
<a href="#l3.538"></a><span id="l3.538" class="difflineminus">-      }</span>
<a href="#l3.539"></a><span id="l3.539" class="difflineminus">-      relative.host = null;</span>
<a href="#l3.540"></a><span id="l3.540" class="difflineminus">-    }</span>
<a href="#l3.541"></a><span id="l3.541" class="difflineminus">-    mustEndAbs = mustEndAbs &amp;&amp; (relPath[0] === '' || srcPath[0] === '');</span>
<a href="#l3.542"></a><span id="l3.542" class="difflineminus">-  }</span>
<a href="#l3.543"></a><span id="l3.543" class="difflineminus">-</span>
<a href="#l3.544"></a><span id="l3.544" class="difflineminus">-  if (isRelAbs) {</span>
<a href="#l3.545"></a><span id="l3.545" class="difflineminus">-    // it's absolute.</span>
<a href="#l3.546"></a><span id="l3.546" class="difflineminus">-    result.host = (relative.host || relative.host === '') ?</span>
<a href="#l3.547"></a><span id="l3.547" class="difflineminus">-                  relative.host : result.host;</span>
<a href="#l3.548"></a><span id="l3.548" class="difflineminus">-    result.hostname = (relative.hostname || relative.hostname === '') ?</span>
<a href="#l3.549"></a><span id="l3.549" class="difflineminus">-                      relative.hostname : result.hostname;</span>
<a href="#l3.550"></a><span id="l3.550" class="difflineminus">-    result.search = relative.search;</span>
<a href="#l3.551"></a><span id="l3.551" class="difflineminus">-    result.query = relative.query;</span>
<a href="#l3.552"></a><span id="l3.552" class="difflineminus">-    srcPath = relPath;</span>
<a href="#l3.553"></a><span id="l3.553" class="difflineminus">-    // fall through to the dot-handling below.</span>
<a href="#l3.554"></a><span id="l3.554" class="difflineminus">-  } else if (relPath.length) {</span>
<a href="#l3.555"></a><span id="l3.555" class="difflineminus">-    // it's relative</span>
<a href="#l3.556"></a><span id="l3.556" class="difflineminus">-    // throw away the existing file, and take the new path instead.</span>
<a href="#l3.557"></a><span id="l3.557" class="difflineminus">-    if (!srcPath) srcPath = [];</span>
<a href="#l3.558"></a><span id="l3.558" class="difflineminus">-    srcPath.pop();</span>
<a href="#l3.559"></a><span id="l3.559" class="difflineminus">-    srcPath = srcPath.concat(relPath);</span>
<a href="#l3.560"></a><span id="l3.560" class="difflineminus">-    result.search = relative.search;</span>
<a href="#l3.561"></a><span id="l3.561" class="difflineminus">-    result.query = relative.query;</span>
<a href="#l3.562"></a><span id="l3.562" class="difflineminus">-  } else if (!isNullOrUndefined(relative.search)) {</span>
<a href="#l3.563"></a><span id="l3.563" class="difflineminus">-    // just pull out the search.</span>
<a href="#l3.564"></a><span id="l3.564" class="difflineminus">-    // like href='?foo'.</span>
<a href="#l3.565"></a><span id="l3.565" class="difflineminus">-    // Put this after the other two cases because it simplifies the booleans</span>
<a href="#l3.566"></a><span id="l3.566" class="difflineminus">-    if (psychotic) {</span>
<a href="#l3.567"></a><span id="l3.567" class="difflineminus">-      result.hostname = result.host = srcPath.shift();</span>
<a href="#l3.568"></a><span id="l3.568" class="difflineminus">-      //occationaly the auth can get stuck only in host</span>
<a href="#l3.569"></a><span id="l3.569" class="difflineminus">-      //this especialy happens in cases like</span>
<a href="#l3.570"></a><span id="l3.570" class="difflineminus">-      //url.resolveObject('mailto:local1@domain1', 'local2@domain2')</span>
<a href="#l3.571"></a><span id="l3.571" class="difflineminus">-      var authInHost = result.host &amp;&amp; result.host.indexOf('@') &gt; 0 ?</span>
<a href="#l3.572"></a><span id="l3.572" class="difflineminus">-                       result.host.split('@') : false;</span>
<a href="#l3.573"></a><span id="l3.573" class="difflineminus">-      if (authInHost) {</span>
<a href="#l3.574"></a><span id="l3.574" class="difflineminus">-        result.auth = authInHost.shift();</span>
<a href="#l3.575"></a><span id="l3.575" class="difflineminus">-        result.host = result.hostname = authInHost.shift();</span>
<a href="#l3.576"></a><span id="l3.576" class="difflineminus">-      }</span>
<a href="#l3.577"></a><span id="l3.577" class="difflineminus">-    }</span>
<a href="#l3.578"></a><span id="l3.578" class="difflineminus">-    result.search = relative.search;</span>
<a href="#l3.579"></a><span id="l3.579" class="difflineminus">-    result.query = relative.query;</span>
<a href="#l3.580"></a><span id="l3.580" class="difflineminus">-    //to support http.request</span>
<a href="#l3.581"></a><span id="l3.581" class="difflineminus">-    if (!isNull(result.pathname) || !isNull(result.search)) {</span>
<a href="#l3.582"></a><span id="l3.582" class="difflineminus">-      result.path = (result.pathname ? result.pathname : '') +</span>
<a href="#l3.583"></a><span id="l3.583" class="difflineminus">-                    (result.search ? result.search : '');</span>
<a href="#l3.584"></a><span id="l3.584" class="difflineminus">-    }</span>
<a href="#l3.585"></a><span id="l3.585" class="difflineminus">-    result.href = result.format();</span>
<a href="#l3.586"></a><span id="l3.586" class="difflineminus">-    return result;</span>
<a href="#l3.587"></a><span id="l3.587" class="difflineminus">-  }</span>
<a href="#l3.588"></a><span id="l3.588" class="difflineminus">-</span>
<a href="#l3.589"></a><span id="l3.589" class="difflineminus">-  if (!srcPath.length) {</span>
<a href="#l3.590"></a><span id="l3.590" class="difflineminus">-    // no path at all.  easy.</span>
<a href="#l3.591"></a><span id="l3.591" class="difflineminus">-    // we've already handled the other stuff above.</span>
<a href="#l3.592"></a><span id="l3.592" class="difflineminus">-    result.pathname = null;</span>
<a href="#l3.593"></a><span id="l3.593" class="difflineminus">-    //to support http.request</span>
<a href="#l3.594"></a><span id="l3.594" class="difflineminus">-    if (result.search) {</span>
<a href="#l3.595"></a><span id="l3.595" class="difflineminus">-      result.path = '/' + result.search;</span>
<a href="#l3.596"></a><span id="l3.596" class="difflineminus">-    } else {</span>
<a href="#l3.597"></a><span id="l3.597" class="difflineminus">-      result.path = null;</span>
<a href="#l3.598"></a><span id="l3.598" class="difflineminus">-    }</span>
<a href="#l3.599"></a><span id="l3.599" class="difflineminus">-    result.href = result.format();</span>
<a href="#l3.600"></a><span id="l3.600" class="difflineminus">-    return result;</span>
<a href="#l3.601"></a><span id="l3.601" class="difflineminus">-  }</span>
<a href="#l3.602"></a><span id="l3.602" class="difflineminus">-</span>
<a href="#l3.603"></a><span id="l3.603" class="difflineminus">-  // if a url ENDs in . or .., then it must get a trailing slash.</span>
<a href="#l3.604"></a><span id="l3.604" class="difflineminus">-  // however, if it ends in anything else non-slashy,</span>
<a href="#l3.605"></a><span id="l3.605" class="difflineminus">-  // then it must NOT get a trailing slash.</span>
<a href="#l3.606"></a><span id="l3.606" class="difflineminus">-  var last = srcPath.slice(-1)[0];</span>
<a href="#l3.607"></a><span id="l3.607" class="difflineminus">-  var hasTrailingSlash = (</span>
<a href="#l3.608"></a><span id="l3.608" class="difflineminus">-      (result.host || relative.host) &amp;&amp; (last === '.' || last === '..') ||</span>
<a href="#l3.609"></a><span id="l3.609" class="difflineminus">-      last === '');</span>
<a href="#l3.610"></a><span id="l3.610" class="difflineminus">-</span>
<a href="#l3.611"></a><span id="l3.611" class="difflineminus">-  // strip single dots, resolve double dots to parent dir</span>
<a href="#l3.612"></a><span id="l3.612" class="difflineminus">-  // if the path tries to go above the root, `up` ends up &gt; 0</span>
<a href="#l3.613"></a><span id="l3.613" class="difflineminus">-  var up = 0;</span>
<a href="#l3.614"></a><span id="l3.614" class="difflineminus">-  for (var i = srcPath.length; i &gt;= 0; i--) {</span>
<a href="#l3.615"></a><span id="l3.615" class="difflineminus">-    last = srcPath[i];</span>
<a href="#l3.616"></a><span id="l3.616" class="difflineminus">-    if (last == '.') {</span>
<a href="#l3.617"></a><span id="l3.617" class="difflineminus">-      srcPath.splice(i, 1);</span>
<a href="#l3.618"></a><span id="l3.618" class="difflineminus">-    } else if (last === '..') {</span>
<a href="#l3.619"></a><span id="l3.619" class="difflineminus">-      srcPath.splice(i, 1);</span>
<a href="#l3.620"></a><span id="l3.620" class="difflineminus">-      up++;</span>
<a href="#l3.621"></a><span id="l3.621" class="difflineminus">-    } else if (up) {</span>
<a href="#l3.622"></a><span id="l3.622" class="difflineminus">-      srcPath.splice(i, 1);</span>
<a href="#l3.623"></a><span id="l3.623" class="difflineminus">-      up--;</span>
<a href="#l3.624"></a><span id="l3.624" class="difflineminus">-    }</span>
<a href="#l3.625"></a><span id="l3.625" class="difflineminus">-  }</span>
<a href="#l3.626"></a><span id="l3.626" class="difflineminus">-</span>
<a href="#l3.627"></a><span id="l3.627" class="difflineminus">-  // if the path is allowed to go above the root, restore leading ..s</span>
<a href="#l3.628"></a><span id="l3.628" class="difflineminus">-  if (!mustEndAbs &amp;&amp; !removeAllDots) {</span>
<a href="#l3.629"></a><span id="l3.629" class="difflineminus">-    for (; up--; up) {</span>
<a href="#l3.630"></a><span id="l3.630" class="difflineminus">-      srcPath.unshift('..');</span>
<a href="#l3.631"></a><span id="l3.631" class="difflineminus">-    }</span>
<a href="#l3.632"></a><span id="l3.632" class="difflineminus">-  }</span>
<a href="#l3.633"></a><span id="l3.633" class="difflineminus">-</span>
<a href="#l3.634"></a><span id="l3.634" class="difflineminus">-  if (mustEndAbs &amp;&amp; srcPath[0] !== '' &amp;&amp;</span>
<a href="#l3.635"></a><span id="l3.635" class="difflineminus">-      (!srcPath[0] || srcPath[0].charAt(0) !== '/')) {</span>
<a href="#l3.636"></a><span id="l3.636" class="difflineminus">-    srcPath.unshift('');</span>
<a href="#l3.637"></a><span id="l3.637" class="difflineminus">-  }</span>
<a href="#l3.638"></a><span id="l3.638" class="difflineminus">-</span>
<a href="#l3.639"></a><span id="l3.639" class="difflineminus">-  if (hasTrailingSlash &amp;&amp; (srcPath.join('/').substr(-1) !== '/')) {</span>
<a href="#l3.640"></a><span id="l3.640" class="difflineminus">-    srcPath.push('');</span>
<a href="#l3.641"></a><span id="l3.641" class="difflineminus">-  }</span>
<a href="#l3.642"></a><span id="l3.642" class="difflineminus">-</span>
<a href="#l3.643"></a><span id="l3.643" class="difflineminus">-  var isAbsolute = srcPath[0] === '' ||</span>
<a href="#l3.644"></a><span id="l3.644" class="difflineminus">-      (srcPath[0] &amp;&amp; srcPath[0].charAt(0) === '/');</span>
<a href="#l3.645"></a><span id="l3.645" class="difflineminus">-</span>
<a href="#l3.646"></a><span id="l3.646" class="difflineminus">-  // put the host back</span>
<a href="#l3.647"></a><span id="l3.647" class="difflineminus">-  if (psychotic) {</span>
<a href="#l3.648"></a><span id="l3.648" class="difflineminus">-    result.hostname = result.host = isAbsolute ? '' :</span>
<a href="#l3.649"></a><span id="l3.649" class="difflineminus">-                                    srcPath.length ? srcPath.shift() : '';</span>
<a href="#l3.650"></a><span id="l3.650" class="difflineminus">-    //occationaly the auth can get stuck only in host</span>
<a href="#l3.651"></a><span id="l3.651" class="difflineminus">-    //this especialy happens in cases like</span>
<a href="#l3.652"></a><span id="l3.652" class="difflineminus">-    //url.resolveObject('mailto:local1@domain1', 'local2@domain2')</span>
<a href="#l3.653"></a><span id="l3.653" class="difflineminus">-    var authInHost = result.host &amp;&amp; result.host.indexOf('@') &gt; 0 ?</span>
<a href="#l3.654"></a><span id="l3.654" class="difflineminus">-                     result.host.split('@') : false;</span>
<a href="#l3.655"></a><span id="l3.655" class="difflineminus">-    if (authInHost) {</span>
<a href="#l3.656"></a><span id="l3.656" class="difflineminus">-      result.auth = authInHost.shift();</span>
<a href="#l3.657"></a><span id="l3.657" class="difflineminus">-      result.host = result.hostname = authInHost.shift();</span>
<a href="#l3.658"></a><span id="l3.658" class="difflineminus">-    }</span>
<a href="#l3.659"></a><span id="l3.659" class="difflineminus">-  }</span>
<a href="#l3.660"></a><span id="l3.660" class="difflineminus">-</span>
<a href="#l3.661"></a><span id="l3.661" class="difflineminus">-  mustEndAbs = mustEndAbs || (result.host &amp;&amp; srcPath.length);</span>
<a href="#l3.662"></a><span id="l3.662" class="difflineminus">-</span>
<a href="#l3.663"></a><span id="l3.663" class="difflineminus">-  if (mustEndAbs &amp;&amp; !isAbsolute) {</span>
<a href="#l3.664"></a><span id="l3.664" class="difflineminus">-    srcPath.unshift('');</span>
<a href="#l3.665"></a><span id="l3.665" class="difflineminus">-  }</span>
<a href="#l3.666"></a><span id="l3.666" class="difflineminus">-</span>
<a href="#l3.667"></a><span id="l3.667" class="difflineminus">-  if (!srcPath.length) {</span>
<a href="#l3.668"></a><span id="l3.668" class="difflineminus">-    result.pathname = null;</span>
<a href="#l3.669"></a><span id="l3.669" class="difflineminus">-    result.path = null;</span>
<a href="#l3.670"></a><span id="l3.670" class="difflineminus">-  } else {</span>
<a href="#l3.671"></a><span id="l3.671" class="difflineminus">-    result.pathname = srcPath.join('/');</span>
<a href="#l3.672"></a><span id="l3.672" class="difflineminus">-  }</span>
<a href="#l3.673"></a><span id="l3.673" class="difflineminus">-</span>
<a href="#l3.674"></a><span id="l3.674" class="difflineminus">-  //to support request.http</span>
<a href="#l3.675"></a><span id="l3.675" class="difflineminus">-  if (!isNull(result.pathname) || !isNull(result.search)) {</span>
<a href="#l3.676"></a><span id="l3.676" class="difflineminus">-    result.path = (result.pathname ? result.pathname : '') +</span>
<a href="#l3.677"></a><span id="l3.677" class="difflineminus">-                  (result.search ? result.search : '');</span>
<a href="#l3.678"></a><span id="l3.678" class="difflineminus">-  }</span>
<a href="#l3.679"></a><span id="l3.679" class="difflineminus">-  result.auth = relative.auth || result.auth;</span>
<a href="#l3.680"></a><span id="l3.680" class="difflineminus">-  result.slashes = result.slashes || relative.slashes;</span>
<a href="#l3.681"></a><span id="l3.681" class="difflineminus">-  result.href = result.format();</span>
<a href="#l3.682"></a><span id="l3.682" class="difflineminus">-  return result;</span>
<a href="#l3.683"></a><span id="l3.683" class="difflineminus">-};</span>
<a href="#l3.684"></a><span id="l3.684" class="difflineminus">-</span>
<a href="#l3.685"></a><span id="l3.685" class="difflineminus">-Url.prototype.parseHost = function() {</span>
<a href="#l3.686"></a><span id="l3.686" class="difflineminus">-  var host = this.host;</span>
<a href="#l3.687"></a><span id="l3.687" class="difflineminus">-  var port = portPattern.exec(host);</span>
<a href="#l3.688"></a><span id="l3.688" class="difflineminus">-  if (port) {</span>
<a href="#l3.689"></a><span id="l3.689" class="difflineminus">-    port = port[0];</span>
<a href="#l3.690"></a><span id="l3.690" class="difflineminus">-    if (port !== ':') {</span>
<a href="#l3.691"></a><span id="l3.691" class="difflineminus">-      this.port = port.substr(1);</span>
<a href="#l3.692"></a><span id="l3.692" class="difflineminus">-    }</span>
<a href="#l3.693"></a><span id="l3.693" class="difflineminus">-    host = host.substr(0, host.length - port.length);</span>
<a href="#l3.694"></a><span id="l3.694" class="difflineminus">-  }</span>
<a href="#l3.695"></a><span id="l3.695" class="difflineminus">-  if (host) this.hostname = host;</span>
<a href="#l3.696"></a><span id="l3.696" class="difflineminus">-};</span>
<a href="#l3.697"></a><span id="l3.697" class="difflineminus">-</span>
<a href="#l3.698"></a><span id="l3.698" class="difflineminus">-function isString(arg) {</span>
<a href="#l3.699"></a><span id="l3.699" class="difflineminus">-  return typeof arg === &quot;string&quot;;</span>
<a href="#l3.700"></a><span id="l3.700" class="difflineminus">-}</span>
<a href="#l3.701"></a><span id="l3.701" class="difflineminus">-</span>
<a href="#l3.702"></a><span id="l3.702" class="difflineminus">-function isObject(arg) {</span>
<a href="#l3.703"></a><span id="l3.703" class="difflineminus">-  return typeof arg === 'object' &amp;&amp; arg !== null;</span>
<a href="#l3.704"></a><span id="l3.704" class="difflineminus">-}</span>
<a href="#l3.705"></a><span id="l3.705" class="difflineminus">-</span>
<a href="#l3.706"></a><span id="l3.706" class="difflineminus">-function isNull(arg) {</span>
<a href="#l3.707"></a><span id="l3.707" class="difflineminus">-  return arg === null;</span>
<a href="#l3.708"></a><span id="l3.708" class="difflineminus">-}</span>
<a href="#l3.709"></a><span id="l3.709" class="difflineminus">-function isNullOrUndefined(arg) {</span>
<a href="#l3.710"></a><span id="l3.710" class="difflineminus">-  return  arg == null;</span>
<a href="#l3.711"></a><span id="l3.711" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/chat/protocols/matrix/matrix-sdk.jsm</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/chat/protocols/matrix/matrix-sdk.jsm</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -4,16 +4,19 @@</span>
<a href="#l4.4"></a><span id="l4.4"> </span>
<a href="#l4.5"></a><span id="l4.5"> const { console } = ChromeUtils.import(&quot;resource://gre/modules/Console.jsm&quot;);</span>
<a href="#l4.6"></a><span id="l4.6"> const {</span>
<a href="#l4.7"></a><span id="l4.7">   clearInterval,</span>
<a href="#l4.8"></a><span id="l4.8">   clearTimeout,</span>
<a href="#l4.9"></a><span id="l4.9">   setInterval,</span>
<a href="#l4.10"></a><span id="l4.10">   setTimeout,</span>
<a href="#l4.11"></a><span id="l4.11"> } = ChromeUtils.import(&quot;resource://gre/modules/Timer.jsm&quot;);</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+const { scriptError } = ChromeUtils.import(</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+  &quot;resource:///modules/imXPCOMUtils.jsm&quot;</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+);</span>
<a href="#l4.15"></a><span id="l4.15"> </span>
<a href="#l4.16"></a><span id="l4.16"> const { Loader, Require, Module } = ChromeUtils.import(</span>
<a href="#l4.17"></a><span id="l4.17">   &quot;resource://devtools/shared/base-loader.js&quot;</span>
<a href="#l4.18"></a><span id="l4.18"> );</span>
<a href="#l4.19"></a><span id="l4.19"> </span>
<a href="#l4.20"></a><span id="l4.20"> this.EXPORTED_SYMBOLS = [&quot;MatrixSDK&quot;];</span>
<a href="#l4.21"></a><span id="l4.21"> </span>
<a href="#l4.22"></a><span id="l4.22"> // Set-up loading so require works properly in CommonJS modules.</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineat">@@ -41,86 +44,103 @@ let loader = Loader({</span>
<a href="#l4.24"></a><span id="l4.24">     &quot;../randomstring&quot;: matrixPath + &quot;matrix_sdk/randomstring.js&quot;,</span>
<a href="#l4.25"></a><span id="l4.25">     &quot;../ReEmitter&quot;: matrixPath + &quot;matrix_sdk/ReEmitter.js&quot;,</span>
<a href="#l4.26"></a><span id="l4.26">     &quot;../sync-accumulator&quot;: matrixPath + &quot;matrix_sdk/sync-accumulator.js&quot;,</span>
<a href="#l4.27"></a><span id="l4.27">     &quot;../utils&quot;: matrixPath + &quot;matrix_sdk/utils.js&quot;,</span>
<a href="#l4.28"></a><span id="l4.28">     &quot;../utils.js&quot;: matrixPath + &quot;matrix_sdk/utils.js&quot;,</span>
<a href="#l4.29"></a><span id="l4.29">     &quot;../../utils&quot;: matrixPath + &quot;matrix_sdk/utils.js&quot;,</span>
<a href="#l4.30"></a><span id="l4.30"> </span>
<a href="#l4.31"></a><span id="l4.31">     // crypto</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineminus">-    &quot;crypto/backup_password&quot;: matrixPath + &quot;matrix_sdk/crypto/backup_password.js&quot;,</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineplus">+    &quot;crypto/backup_password&quot;:</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineplus">+      matrixPath + &quot;matrix_sdk/crypto/backup_password.js&quot;,</span>
<a href="#l4.35"></a><span id="l4.35">     deviceinfo: matrixPath + &quot;matrix_sdk/crypto/deviceinfo.js&quot;,</span>
<a href="#l4.36"></a><span id="l4.36">     &quot;../deviceinfo&quot;: matrixPath + &quot;matrix_sdk/crypto/deviceinfo.js&quot;,</span>
<a href="#l4.37"></a><span id="l4.37">     DeviceList: matrixPath + &quot;matrix_sdk/crypto/DeviceList.js&quot;,</span>
<a href="#l4.38"></a><span id="l4.38">     &quot;../DeviceList&quot;: matrixPath + &quot;matrix_sdk/crypto/DeviceList.js&quot;,</span>
<a href="#l4.39"></a><span id="l4.39">     crypto: matrixPath + &quot;matrix_sdk/crypto/index.js&quot;,</span>
<a href="#l4.40"></a><span id="l4.40">     olmlib: matrixPath + &quot;matrix_sdk/crypto/olmlib.js&quot;,</span>
<a href="#l4.41"></a><span id="l4.41">     &quot;../olmlib&quot;: matrixPath + &quot;matrix_sdk/crypto/olmlib.js&quot;,</span>
<a href="#l4.42"></a><span id="l4.42">     &quot;crypto/olmlib&quot;: matrixPath + &quot;matrix_sdk/crypto/olmlib.js&quot;,</span>
<a href="#l4.43"></a><span id="l4.43">     OlmDevice: matrixPath + &quot;matrix_sdk/crypto/OlmDevice.js&quot;,</span>
<a href="#l4.44"></a><span id="l4.44">     &quot;crypto/recoverykey&quot;: matrixPath + &quot;matrix_sdk/crypto/recoverykey.js&quot;,</span>
<a href="#l4.45"></a><span id="l4.45" class="difflineminus">-    OutgoingRoomKeyRequestManager: matrixPath + &quot;matrix_sdk/crypto/OutgoingRoomKeyRequestManager.js&quot;,</span>
<a href="#l4.46"></a><span id="l4.46" class="difflineplus">+    OutgoingRoomKeyRequestManager:</span>
<a href="#l4.47"></a><span id="l4.47" class="difflineplus">+      matrixPath + &quot;matrix_sdk/crypto/OutgoingRoomKeyRequestManager.js&quot;,</span>
<a href="#l4.48"></a><span id="l4.48">     &quot;crypto/RoomList&quot;: matrixPath + &quot;matrix_sdk/crypto/RoomList.js&quot;,</span>
<a href="#l4.49"></a><span id="l4.49"> </span>
<a href="#l4.50"></a><span id="l4.50">     // crypto/algorithms</span>
<a href="#l4.51"></a><span id="l4.51">     base: matrixPath + &quot;matrix_sdk/crypto/algorithms/base.js&quot;,</span>
<a href="#l4.52"></a><span id="l4.52">     algorithms: matrixPath + &quot;matrix_sdk/crypto/algorithms/index.js&quot;,</span>
<a href="#l4.53"></a><span id="l4.53">     megolm: matrixPath + &quot;matrix_sdk/crypto/algorithms/megolm.js&quot;,</span>
<a href="#l4.54"></a><span id="l4.54">     olm: matrixPath + &quot;matrix_sdk/crypto/algorithms/olm.js&quot;,</span>
<a href="#l4.55"></a><span id="l4.55"> </span>
<a href="#l4.56"></a><span id="l4.56">     // crypto/store</span>
<a href="#l4.57"></a><span id="l4.57" class="difflineminus">-    &quot;store/indexeddb-crypto-store&quot;: matrixPath + &quot;matrix_sdk/crypto/store/indexeddb-crypto-store.js&quot;,</span>
<a href="#l4.58"></a><span id="l4.58" class="difflineminus">-    &quot;crypto/store/indexeddb-crypto-store&quot;: matrixPath + &quot;matrix_sdk/crypto/store/indexeddb-crypto-store.js&quot;,</span>
<a href="#l4.59"></a><span id="l4.59" class="difflineminus">-    &quot;crypto/store/indexeddb-crypto-store-backend&quot;: matrixPath + &quot;matrix_sdk/crypto/store/indexeddb-crypto-store-backend.js&quot;,</span>
<a href="#l4.60"></a><span id="l4.60" class="difflineminus">-    &quot;crypto/store/localStorage-crypto-store&quot;: matrixPath + &quot;matrix_sdk/crypto/store/localStorage-crypto-store.js&quot;,</span>
<a href="#l4.61"></a><span id="l4.61" class="difflineminus">-    &quot;crypto/store/memory-crypto-store&quot;: matrixPath + &quot;matrix_sdk/crypto/store/memory-crypto-store.js&quot;,</span>
<a href="#l4.62"></a><span id="l4.62" class="difflineplus">+    &quot;store/indexeddb-crypto-store&quot;:</span>
<a href="#l4.63"></a><span id="l4.63" class="difflineplus">+      matrixPath + &quot;matrix_sdk/crypto/store/indexeddb-crypto-store.js&quot;,</span>
<a href="#l4.64"></a><span id="l4.64" class="difflineplus">+    &quot;crypto/store/indexeddb-crypto-store&quot;:</span>
<a href="#l4.65"></a><span id="l4.65" class="difflineplus">+      matrixPath + &quot;matrix_sdk/crypto/store/indexeddb-crypto-store.js&quot;,</span>
<a href="#l4.66"></a><span id="l4.66" class="difflineplus">+    &quot;crypto/store/indexeddb-crypto-store-backend&quot;:</span>
<a href="#l4.67"></a><span id="l4.67" class="difflineplus">+      matrixPath + &quot;matrix_sdk/crypto/store/indexeddb-crypto-store-backend.js&quot;,</span>
<a href="#l4.68"></a><span id="l4.68" class="difflineplus">+    &quot;crypto/store/localStorage-crypto-store&quot;:</span>
<a href="#l4.69"></a><span id="l4.69" class="difflineplus">+      matrixPath + &quot;matrix_sdk/crypto/store/localStorage-crypto-store.js&quot;,</span>
<a href="#l4.70"></a><span id="l4.70" class="difflineplus">+    &quot;crypto/store/memory-crypto-store&quot;:</span>
<a href="#l4.71"></a><span id="l4.71" class="difflineplus">+      matrixPath + &quot;matrix_sdk/crypto/store/memory-crypto-store.js&quot;,</span>
<a href="#l4.72"></a><span id="l4.72"> </span>
<a href="#l4.73"></a><span id="l4.73">     // crypto/verification</span>
<a href="#l4.74"></a><span id="l4.74">     Base: matrixPath + &quot;matrix_sdk/crypto/verification/Base.js&quot;,</span>
<a href="#l4.75"></a><span id="l4.75">     Error: matrixPath + &quot;matrix_sdk/crypto/verification/Error.js&quot;,</span>
<a href="#l4.76"></a><span id="l4.76">     &quot;verification/Base&quot;: matrixPath + &quot;matrix_sdk/crypto/verification/Base.js&quot;,</span>
<a href="#l4.77"></a><span id="l4.77" class="difflineminus">-    &quot;verification/Error&quot;: matrixPath + &quot;matrix_sdk/crypto/verification/Error.js&quot;,</span>
<a href="#l4.78"></a><span id="l4.78" class="difflineminus">-    &quot;verification/QRCode&quot;: matrixPath + &quot;matrix_sdk/crypto/verification/QRCode.js&quot;,</span>
<a href="#l4.79"></a><span id="l4.79" class="difflineplus">+    &quot;verification/Error&quot;:</span>
<a href="#l4.80"></a><span id="l4.80" class="difflineplus">+      matrixPath + &quot;matrix_sdk/crypto/verification/Error.js&quot;,</span>
<a href="#l4.81"></a><span id="l4.81" class="difflineplus">+    &quot;verification/QRCode&quot;:</span>
<a href="#l4.82"></a><span id="l4.82" class="difflineplus">+      matrixPath + &quot;matrix_sdk/crypto/verification/QRCode.js&quot;,</span>
<a href="#l4.83"></a><span id="l4.83">     &quot;verification/SAS&quot;: matrixPath + &quot;matrix_sdk/crypto/verification/SAS.js&quot;,</span>
<a href="#l4.84"></a><span id="l4.84"> </span>
<a href="#l4.85"></a><span id="l4.85">     // models</span>
<a href="#l4.86"></a><span id="l4.86">     &quot;../models/event&quot;: matrixPath + &quot;matrix_sdk/models/event.js&quot;,</span>
<a href="#l4.87"></a><span id="l4.87">     &quot;../../models/event&quot;: matrixPath + &quot;matrix_sdk/models/event.js&quot;,</span>
<a href="#l4.88"></a><span id="l4.88">     &quot;../lib/models/event&quot;: matrixPath + &quot;matrix_sdk/models/event.js&quot;,</span>
<a href="#l4.89"></a><span id="l4.89">     &quot;../../lib/models/event&quot;: matrixPath + &quot;matrix_sdk/models/event.js&quot;,</span>
<a href="#l4.90"></a><span id="l4.90">     &quot;../models/user&quot;: matrixPath + &quot;matrix_sdk/models/user.js&quot;,</span>
<a href="#l4.91"></a><span id="l4.91"> </span>
<a href="#l4.92"></a><span id="l4.92">     // Simple (one-file) dependencies.</span>
<a href="#l4.93"></a><span id="l4.93">     &quot;another-json&quot;: matrixPath + &quot;another-json.js&quot;,</span>
<a href="#l4.94"></a><span id="l4.94">     events: matrixPath + &quot;events.js&quot;,</span>
<a href="#l4.95"></a><span id="l4.95">     punycode: matrixPath + &quot;punycode.js&quot;,</span>
<a href="#l4.96"></a><span id="l4.96" class="difflineminus">-    url: matrixPath + &quot;url.js&quot;,</span>
<a href="#l4.97"></a><span id="l4.97"> </span>
<a href="#l4.98"></a><span id="l4.98">     // Browser Request.</span>
<a href="#l4.99"></a><span id="l4.99">     &quot;browser-request&quot;: matrixPath + &quot;browser_request/index.js&quot;,</span>
<a href="#l4.100"></a><span id="l4.100"> </span>
<a href="#l4.101"></a><span id="l4.101">     // q</span>
<a href="#l4.102"></a><span id="l4.102">     q: matrixPath + &quot;q/q.js&quot;,</span>
<a href="#l4.103"></a><span id="l4.103"> </span>
<a href="#l4.104"></a><span id="l4.104">     // querystring</span>
<a href="#l4.105"></a><span id="l4.105">     decode: matrixPath + &quot;querystring/decode.js&quot;,</span>
<a href="#l4.106"></a><span id="l4.106">     encode: matrixPath + &quot;querystring/encode.js&quot;,</span>
<a href="#l4.107"></a><span id="l4.107">     querystring: matrixPath + &quot;querystring/index.js&quot;,</span>
<a href="#l4.108"></a><span id="l4.108" class="difflineplus">+</span>
<a href="#l4.109"></a><span id="l4.109" class="difflineplus">+    // Packages that are not included, but an alternate implementation is given.</span>
<a href="#l4.110"></a><span id="l4.110" class="difflineplus">+    loglevel: matrixPath + &quot;loglevel.js&quot;,</span>
<a href="#l4.111"></a><span id="l4.111" class="difflineplus">+    &quot;safe-buffer&quot;: matrixPath + &quot;safe-buffer.js&quot;,</span>
<a href="#l4.112"></a><span id="l4.112" class="difflineplus">+    url: matrixPath + &quot;url.js&quot;,</span>
<a href="#l4.113"></a><span id="l4.113">   },</span>
<a href="#l4.114"></a><span id="l4.114">   globals: {</span>
<a href="#l4.115"></a><span id="l4.115">     global: {</span>
<a href="#l4.116"></a><span id="l4.116">       setInterval,</span>
<a href="#l4.117"></a><span id="l4.117">       clearInterval,</span>
<a href="#l4.118"></a><span id="l4.118">       setTimeout,</span>
<a href="#l4.119"></a><span id="l4.119">       clearTimeout,</span>
<a href="#l4.120"></a><span id="l4.120">     },</span>
<a href="#l4.121"></a><span id="l4.121">     console,</span>
<a href="#l4.122"></a><span id="l4.122">     XMLHttpRequest,</span>
<a href="#l4.123"></a><span id="l4.123">     setTimeout,</span>
<a href="#l4.124"></a><span id="l4.124">     clearTimeout,</span>
<a href="#l4.125"></a><span id="l4.125">     location: { href: &quot;&quot; }, // workaround for browser-request's is_crossDomain</span>
<a href="#l4.126"></a><span id="l4.126" class="difflineplus">+</span>
<a href="#l4.127"></a><span id="l4.127" class="difflineplus">+    // Necessary for interacting with the logging framework.</span>
<a href="#l4.128"></a><span id="l4.128" class="difflineplus">+    scriptError,</span>
<a href="#l4.129"></a><span id="l4.129" class="difflineplus">+    imIDebugMessage: Ci.imIDebugMessage,</span>
<a href="#l4.130"></a><span id="l4.130">   },</span>
<a href="#l4.131"></a><span id="l4.131"> });</span>
<a href="#l4.132"></a><span id="l4.132"> </span>
<a href="#l4.133"></a><span id="l4.133"> let requirer = Module(&quot;matrix-module&quot;, &quot;&quot;);</span>
<a href="#l4.134"></a><span id="l4.134"> let require = Require(loader, requirer);</span>
<a href="#l4.135"></a><span id="l4.135"> let MatrixSDK = require(&quot;matrix.js&quot;);</span>
<a href="#l4.136"></a><span id="l4.136"> MatrixSDK.request(require(&quot;browser-request&quot;));</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/chat/protocols/matrix/moz.build</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/chat/protocols/matrix/moz.build</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -2,16 +2,17 @@</span>
<a href="#l5.4"></a><span id="l5.4"> # This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l5.5"></a><span id="l5.5"> # License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l5.6"></a><span id="l5.6"> # file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l5.7"></a><span id="l5.7"> </span>
<a href="#l5.8"></a><span id="l5.8"> # XPCSHELL_TESTS_MANIFESTS += []</span>
<a href="#l5.9"></a><span id="l5.9"> </span>
<a href="#l5.10"></a><span id="l5.10"> DIRS += [</span>
<a href="#l5.11"></a><span id="l5.11">     'lib',</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+    'shims',</span>
<a href="#l5.13"></a><span id="l5.13"> ]</span>
<a href="#l5.14"></a><span id="l5.14"> </span>
<a href="#l5.15"></a><span id="l5.15"> EXTRA_COMPONENTS += [</span>
<a href="#l5.16"></a><span id="l5.16">     'matrix.js',</span>
<a href="#l5.17"></a><span id="l5.17">     'matrix.manifest',</span>
<a href="#l5.18"></a><span id="l5.18"> ]</span>
<a href="#l5.19"></a><span id="l5.19"> </span>
<a href="#l5.20"></a><span id="l5.20"> EXTRA_JS_MODULES += [</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1">new file mode 100644</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineminus">--- /dev/null</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineplus">+++ b/chat/protocols/matrix/shims/loglevel.js</span>
<a href="#l6.4"></a><span id="l6.4" class="difflineat">@@ -0,0 +1,73 @@</span>
<a href="#l6.5"></a><span id="l6.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l6.6"></a><span id="l6.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l6.7"></a><span id="l6.7" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l6.8"></a><span id="l6.8" class="difflineplus">+</span>
<a href="#l6.9"></a><span id="l6.9" class="difflineplus">+&quot;use strict&quot;;</span>
<a href="#l6.10"></a><span id="l6.10" class="difflineplus">+</span>
<a href="#l6.11"></a><span id="l6.11" class="difflineplus">+/* globals scriptError, imIDebugMessage, module */</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineplus">+</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+let _loggers = {};</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineplus">+/*</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineplus">+ * Implement a custom logger to to hook the Matrix logging up to the chat</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineplus">+ * logging framework.</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineplus">+ *</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineplus">+ * This unfortunately does not enable account specific logging.</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineplus">+ */</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineplus">+function getLogger(loggerName) {</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineplus">+  let moduleName = &quot;prpl-matrix.&quot; + loggerName;</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineplus">+</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineplus">+  let logger = _loggers[moduleName];</span>
<a href="#l6.25"></a><span id="l6.25" class="difflineplus">+</span>
<a href="#l6.26"></a><span id="l6.26" class="difflineplus">+  // If the logger was previously created, return it.</span>
<a href="#l6.27"></a><span id="l6.27" class="difflineplus">+  if (logger) {</span>
<a href="#l6.28"></a><span id="l6.28" class="difflineplus">+    return logger;</span>
<a href="#l6.29"></a><span id="l6.29" class="difflineplus">+  }</span>
<a href="#l6.30"></a><span id="l6.30" class="difflineplus">+</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineplus">+  // Otherwise, build a new logger.</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineplus">+  logger = {};</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineplus">+  logger.trace = scriptError.bind(</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineplus">+    logger,</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineplus">+    moduleName,</span>
<a href="#l6.36"></a><span id="l6.36" class="difflineplus">+    imIDebugMessage.LEVEL_DEBUG</span>
<a href="#l6.37"></a><span id="l6.37" class="difflineplus">+  );</span>
<a href="#l6.38"></a><span id="l6.38" class="difflineplus">+  logger.debug = scriptError.bind(</span>
<a href="#l6.39"></a><span id="l6.39" class="difflineplus">+    logger,</span>
<a href="#l6.40"></a><span id="l6.40" class="difflineplus">+    moduleName,</span>
<a href="#l6.41"></a><span id="l6.41" class="difflineplus">+    imIDebugMessage.LEVEL_DEBUG</span>
<a href="#l6.42"></a><span id="l6.42" class="difflineplus">+  );</span>
<a href="#l6.43"></a><span id="l6.43" class="difflineplus">+  logger.log = scriptError.bind(</span>
<a href="#l6.44"></a><span id="l6.44" class="difflineplus">+    logger,</span>
<a href="#l6.45"></a><span id="l6.45" class="difflineplus">+    moduleName,</span>
<a href="#l6.46"></a><span id="l6.46" class="difflineplus">+    imIDebugMessage.LEVEL_DEBUG</span>
<a href="#l6.47"></a><span id="l6.47" class="difflineplus">+  );</span>
<a href="#l6.48"></a><span id="l6.48" class="difflineplus">+  logger.info = scriptError.bind(logger, moduleName, imIDebugMessage.LEVEL_LOG);</span>
<a href="#l6.49"></a><span id="l6.49" class="difflineplus">+  logger.warn = scriptError.bind(</span>
<a href="#l6.50"></a><span id="l6.50" class="difflineplus">+    logger,</span>
<a href="#l6.51"></a><span id="l6.51" class="difflineplus">+    moduleName,</span>
<a href="#l6.52"></a><span id="l6.52" class="difflineplus">+    imIDebugMessage.LEVEL_WARNING</span>
<a href="#l6.53"></a><span id="l6.53" class="difflineplus">+  );</span>
<a href="#l6.54"></a><span id="l6.54" class="difflineplus">+  logger.error = scriptError.bind(</span>
<a href="#l6.55"></a><span id="l6.55" class="difflineplus">+    logger,</span>
<a href="#l6.56"></a><span id="l6.56" class="difflineplus">+    moduleName,</span>
<a href="#l6.57"></a><span id="l6.57" class="difflineplus">+    imIDebugMessage.LEVEL_ERROR</span>
<a href="#l6.58"></a><span id="l6.58" class="difflineplus">+  );</span>
<a href="#l6.59"></a><span id="l6.59" class="difflineplus">+</span>
<a href="#l6.60"></a><span id="l6.60" class="difflineplus">+  // This is a no-op since log levels are configured via preferences.</span>
<a href="#l6.61"></a><span id="l6.61" class="difflineplus">+  logger.setLevel = function(level) {};</span>
<a href="#l6.62"></a><span id="l6.62" class="difflineplus">+</span>
<a href="#l6.63"></a><span id="l6.63" class="difflineplus">+  _loggers[moduleName] = logger;</span>
<a href="#l6.64"></a><span id="l6.64" class="difflineplus">+</span>
<a href="#l6.65"></a><span id="l6.65" class="difflineplus">+  return logger;</span>
<a href="#l6.66"></a><span id="l6.66" class="difflineplus">+}</span>
<a href="#l6.67"></a><span id="l6.67" class="difflineplus">+</span>
<a href="#l6.68"></a><span id="l6.68" class="difflineplus">+module.exports = {</span>
<a href="#l6.69"></a><span id="l6.69" class="difflineplus">+  getLogger,</span>
<a href="#l6.70"></a><span id="l6.70" class="difflineplus">+  levels: {</span>
<a href="#l6.71"></a><span id="l6.71" class="difflineplus">+    TRACE: imIDebugMessage.LEVEL_DEBUG,</span>
<a href="#l6.72"></a><span id="l6.72" class="difflineplus">+    DEBUG: imIDebugMessage.LEVEL_DEBUG,</span>
<a href="#l6.73"></a><span id="l6.73" class="difflineplus">+    INFO: imIDebugMessage.LEVEL_LOG,</span>
<a href="#l6.74"></a><span id="l6.74" class="difflineplus">+    WARN: imIDebugMessage.LEVEL_WARNING,</span>
<a href="#l6.75"></a><span id="l6.75" class="difflineplus">+    ERROR: imIDebugMessage.LEVEL_ERROR,</span>
<a href="#l6.76"></a><span id="l6.76" class="difflineplus">+  },</span>
<a href="#l6.77"></a><span id="l6.77" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1">new file mode 100644</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineminus">--- /dev/null</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineplus">+++ b/chat/protocols/matrix/shims/moz.build</span>
<a href="#l7.4"></a><span id="l7.4" class="difflineat">@@ -0,0 +1,13 @@</span>
<a href="#l7.5"></a><span id="l7.5" class="difflineplus">+# vim: set filetype=python:</span>
<a href="#l7.6"></a><span id="l7.6" class="difflineplus">+# This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l7.7"></a><span id="l7.7" class="difflineplus">+# License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l7.8"></a><span id="l7.8" class="difflineplus">+# file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l7.9"></a><span id="l7.9" class="difflineplus">+</span>
<a href="#l7.10"></a><span id="l7.10" class="difflineplus">+# Shimmed dependencies of the matrix-js-sdk that we can provide through direct</span>
<a href="#l7.11"></a><span id="l7.11" class="difflineplus">+# implementation instead of through npm package.s</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineplus">+</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+EXTRA_JS_MODULES.matrix += [</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+    'loglevel.js',</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+    'safe-buffer.js',</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineplus">+    'url.js',</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineplus">+]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1">new file mode 100644</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineminus">--- /dev/null</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineplus">+++ b/chat/protocols/matrix/shims/safe-buffer.js</span>
<a href="#l8.4"></a><span id="l8.4" class="difflineat">@@ -0,0 +1,33 @@</span>
<a href="#l8.5"></a><span id="l8.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l8.6"></a><span id="l8.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l8.7"></a><span id="l8.7" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l8.8"></a><span id="l8.8" class="difflineplus">+</span>
<a href="#l8.9"></a><span id="l8.9" class="difflineplus">+&quot;use strict&quot;;</span>
<a href="#l8.10"></a><span id="l8.10" class="difflineplus">+</span>
<a href="#l8.11"></a><span id="l8.11" class="difflineplus">+/* globals module */</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+/*</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineplus">+ * Per the Node.js documentation, a Buffer is an instance of Uint8Array, but</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineplus">+ * additional class methods are missing for it.</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineplus">+ *</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineplus">+ * https://nodejs.org/docs/latest/api/buffer.html#buffer_buffers_and_typedarray</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineplus">+ */</span>
<a href="#l8.19"></a><span id="l8.19" class="difflineplus">+var Buffer = {</span>
<a href="#l8.20"></a><span id="l8.20" class="difflineplus">+  isBuffer(obj) {</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineplus">+    return obj.constructor == Uint8Array;</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineplus">+  },</span>
<a href="#l8.23"></a><span id="l8.23" class="difflineplus">+</span>
<a href="#l8.24"></a><span id="l8.24" class="difflineplus">+  // Note that this doesn't fully implement allocate, only enough is implemented</span>
<a href="#l8.25"></a><span id="l8.25" class="difflineplus">+  // for the base-x package to function properly.</span>
<a href="#l8.26"></a><span id="l8.26" class="difflineplus">+  alloc(size, fill, encoding) {</span>
<a href="#l8.27"></a><span id="l8.27" class="difflineplus">+    return new Uint8Array(size);</span>
<a href="#l8.28"></a><span id="l8.28" class="difflineplus">+  },</span>
<a href="#l8.29"></a><span id="l8.29" class="difflineplus">+</span>
<a href="#l8.30"></a><span id="l8.30" class="difflineplus">+  allocUnsafe(size) {</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineplus">+    return new Uint8Array(size);</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineplus">+  },</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineplus">+};</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineplus">+</span>
<a href="#l8.35"></a><span id="l8.35" class="difflineplus">+module.exports = {</span>
<a href="#l8.36"></a><span id="l8.36" class="difflineplus">+  Buffer,</span>
<a href="#l8.37"></a><span id="l8.37" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1">new file mode 100644</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineminus">--- /dev/null</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineplus">+++ b/chat/protocols/matrix/shims/url.js</span>
<a href="#l9.4"></a><span id="l9.4" class="difflineat">@@ -0,0 +1,15 @@</span>
<a href="#l9.5"></a><span id="l9.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l9.6"></a><span id="l9.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l9.7"></a><span id="l9.7" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l9.8"></a><span id="l9.8" class="difflineplus">+</span>
<a href="#l9.9"></a><span id="l9.9" class="difflineplus">+&quot;use strict&quot;;</span>
<a href="#l9.10"></a><span id="l9.10" class="difflineplus">+</span>
<a href="#l9.11"></a><span id="l9.11" class="difflineplus">+/* globals module */</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineplus">+</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+function parse(u) {</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineplus">+  return new URL(u);</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineplus">+}</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineplus">+</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineplus">+module.exports = {</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineplus">+  parse,</span>
<a href="#l9.19"></a><span id="l9.19" class="difflineplus">+};</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:32Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

