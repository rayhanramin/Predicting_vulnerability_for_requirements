<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 29160:c3a2ed94fe276a125838a24edc43b215f90da865</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ c3a2ed94fe276a125838a24edc43b215f90da865" />
<meta property="og:url" content="/comm-central/rev/c3a2ed94fe276a125838a24edc43b215f90da865" />
<meta property="og:description" content="Bug 1614846 - Remove nsIArray use in nsIMsgAccountManager.getIdentitiesForServer(). r=mkmelin" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / c3a2ed94fe276a125838a24edc43b215f90da865 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/c3a2ed94fe276a125838a24edc43b215f90da865">shortlog</a> |
<a href="/comm-central/log/c3a2ed94fe276a125838a24edc43b215f90da865">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/c3a2ed94fe276a125838a24edc43b215f90da865">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/c3a2ed94fe276a125838a24edc43b215f90da865">files</a> |
changeset |
<a href="/comm-central/raw-rev/c3a2ed94fe276a125838a24edc43b215f90da865">raw</a>  | <a href="/comm-central/archive/c3a2ed94fe276a125838a24edc43b215f90da865.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1614846">Bug 1614846</a> - Remove nsIArray use in nsIMsgAccountManager.getIdentitiesForServer(). r=mkmelin
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#66;&#101;&#110;&#32;&#67;&#97;&#109;&#112;&#98;&#101;&#108;&#108;&#32;&#60;&#98;&#101;&#110;&#99;&#64;&#116;&#104;&#117;&#110;&#100;&#101;&#114;&#98;&#105;&#114;&#100;&#46;&#110;&#101;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Thu, 02 Apr 2020 13:39:46 +0300</td></tr>

<tr>
 <td>changeset 29160</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/c3a2ed94fe276a125838a24edc43b215f90da865">c3a2ed94fe276a125838a24edc43b215f90da865</a></td>
</tr>



<tr>
<td>parent 29159</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/43a129b74441061e812b31cf0b40fa59205f5dee">43a129b74441061e812b31cf0b40fa59205f5dee</a>
</td>
</tr>

<tr>
<td>child 29161</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/c368a253924a4515cb915d17715a0a154bf685f9">c368a253924a4515cb915d17715a0a154bf685f9</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=c3a2ed94fe276a125838a24edc43b215f90da865">17231</a></td></tr>
<tr><td>push user</td><td>mkmelin@iki.fi</td></tr>
<tr><td>push date</td><td class="date age">Thu, 02 Apr 2020 10:45:36 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@0c36d6c1e2e9 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=0c36d6c1e2e922266833edeb49ca1f77b30a2012">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=0c36d6c1e2e922266833edeb49ca1f77b30a2012&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=0c36d6c1e2e922266833edeb49ca1f77b30a2012&newProject=comm-central&newRevision=43a129b74441061e812b31cf0b40fa59205f5dee&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=0c36d6c1e2e922266833edeb49ca1f77b30a2012&newProject=comm-central&newRevision=43a129b74441061e812b31cf0b40fa59205f5dee&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=0c36d6c1e2e922266833edeb49ca1f77b30a2012&newProject=comm-central&newRevision=43a129b74441061e812b31cf0b40fa59205f5dee&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28mkmelin%29&revcount=50">mkmelin</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1614846">1614846</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1614846">Bug 1614846</a> - Remove nsIArray use in nsIMsgAccountManager.getIdentitiesForServer(). r=mkmelin</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c3a2ed94fe276a125838a24edc43b215f90da865/calendar/base/modules/utils/calItipUtils.jsm">calendar/base/modules/utils/calItipUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c3a2ed94fe276a125838a24edc43b215f90da865/calendar/base/modules/utils/calItipUtils.jsm">file</a> |
<a href="/comm-central/annotate/c3a2ed94fe276a125838a24edc43b215f90da865/calendar/base/modules/utils/calItipUtils.jsm">annotate</a> |
<a href="/comm-central/diff/c3a2ed94fe276a125838a24edc43b215f90da865/calendar/base/modules/utils/calItipUtils.jsm">diff</a> |
<a href="/comm-central/comparison/c3a2ed94fe276a125838a24edc43b215f90da865/calendar/base/modules/utils/calItipUtils.jsm">comparison</a> |
<a href="/comm-central/log/c3a2ed94fe276a125838a24edc43b215f90da865/calendar/base/modules/utils/calItipUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c3a2ed94fe276a125838a24edc43b215f90da865/mail/base/content/folderDisplay.js">mail/base/content/folderDisplay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c3a2ed94fe276a125838a24edc43b215f90da865/mail/base/content/folderDisplay.js">file</a> |
<a href="/comm-central/annotate/c3a2ed94fe276a125838a24edc43b215f90da865/mail/base/content/folderDisplay.js">annotate</a> |
<a href="/comm-central/diff/c3a2ed94fe276a125838a24edc43b215f90da865/mail/base/content/folderDisplay.js">diff</a> |
<a href="/comm-central/comparison/c3a2ed94fe276a125838a24edc43b215f90da865/mail/base/content/folderDisplay.js">comparison</a> |
<a href="/comm-central/log/c3a2ed94fe276a125838a24edc43b215f90da865/mail/base/content/folderDisplay.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c3a2ed94fe276a125838a24edc43b215f90da865/mail/base/modules/MailUtils.jsm">mail/base/modules/MailUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c3a2ed94fe276a125838a24edc43b215f90da865/mail/base/modules/MailUtils.jsm">file</a> |
<a href="/comm-central/annotate/c3a2ed94fe276a125838a24edc43b215f90da865/mail/base/modules/MailUtils.jsm">annotate</a> |
<a href="/comm-central/diff/c3a2ed94fe276a125838a24edc43b215f90da865/mail/base/modules/MailUtils.jsm">diff</a> |
<a href="/comm-central/comparison/c3a2ed94fe276a125838a24edc43b215f90da865/mail/base/modules/MailUtils.jsm">comparison</a> |
<a href="/comm-central/log/c3a2ed94fe276a125838a24edc43b215f90da865/mail/base/modules/MailUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c3a2ed94fe276a125838a24edc43b215f90da865/mail/extensions/openpgp/content/modules/filters.jsm">mail/extensions/openpgp/content/modules/filters.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c3a2ed94fe276a125838a24edc43b215f90da865/mail/extensions/openpgp/content/modules/filters.jsm">file</a> |
<a href="/comm-central/annotate/c3a2ed94fe276a125838a24edc43b215f90da865/mail/extensions/openpgp/content/modules/filters.jsm">annotate</a> |
<a href="/comm-central/diff/c3a2ed94fe276a125838a24edc43b215f90da865/mail/extensions/openpgp/content/modules/filters.jsm">diff</a> |
<a href="/comm-central/comparison/c3a2ed94fe276a125838a24edc43b215f90da865/mail/extensions/openpgp/content/modules/filters.jsm">comparison</a> |
<a href="/comm-central/log/c3a2ed94fe276a125838a24edc43b215f90da865/mail/extensions/openpgp/content/modules/filters.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c3a2ed94fe276a125838a24edc43b215f90da865/mailnews/base/public/nsIMsgAccountManager.idl">mailnews/base/public/nsIMsgAccountManager.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c3a2ed94fe276a125838a24edc43b215f90da865/mailnews/base/public/nsIMsgAccountManager.idl">file</a> |
<a href="/comm-central/annotate/c3a2ed94fe276a125838a24edc43b215f90da865/mailnews/base/public/nsIMsgAccountManager.idl">annotate</a> |
<a href="/comm-central/diff/c3a2ed94fe276a125838a24edc43b215f90da865/mailnews/base/public/nsIMsgAccountManager.idl">diff</a> |
<a href="/comm-central/comparison/c3a2ed94fe276a125838a24edc43b215f90da865/mailnews/base/public/nsIMsgAccountManager.idl">comparison</a> |
<a href="/comm-central/log/c3a2ed94fe276a125838a24edc43b215f90da865/mailnews/base/public/nsIMsgAccountManager.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c3a2ed94fe276a125838a24edc43b215f90da865/mailnews/base/search/content/searchWidgets.js">mailnews/base/search/content/searchWidgets.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c3a2ed94fe276a125838a24edc43b215f90da865/mailnews/base/search/content/searchWidgets.js">file</a> |
<a href="/comm-central/annotate/c3a2ed94fe276a125838a24edc43b215f90da865/mailnews/base/search/content/searchWidgets.js">annotate</a> |
<a href="/comm-central/diff/c3a2ed94fe276a125838a24edc43b215f90da865/mailnews/base/search/content/searchWidgets.js">diff</a> |
<a href="/comm-central/comparison/c3a2ed94fe276a125838a24edc43b215f90da865/mailnews/base/search/content/searchWidgets.js">comparison</a> |
<a href="/comm-central/log/c3a2ed94fe276a125838a24edc43b215f90da865/mailnews/base/search/content/searchWidgets.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c3a2ed94fe276a125838a24edc43b215f90da865/mailnews/base/src/nsMsgAccountManager.cpp">mailnews/base/src/nsMsgAccountManager.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c3a2ed94fe276a125838a24edc43b215f90da865/mailnews/base/src/nsMsgAccountManager.cpp">file</a> |
<a href="/comm-central/annotate/c3a2ed94fe276a125838a24edc43b215f90da865/mailnews/base/src/nsMsgAccountManager.cpp">annotate</a> |
<a href="/comm-central/diff/c3a2ed94fe276a125838a24edc43b215f90da865/mailnews/base/src/nsMsgAccountManager.cpp">diff</a> |
<a href="/comm-central/comparison/c3a2ed94fe276a125838a24edc43b215f90da865/mailnews/base/src/nsMsgAccountManager.cpp">comparison</a> |
<a href="/comm-central/log/c3a2ed94fe276a125838a24edc43b215f90da865/mailnews/base/src/nsMsgAccountManager.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c3a2ed94fe276a125838a24edc43b215f90da865/mailnews/base/src/nsMsgAccountManager.h">mailnews/base/src/nsMsgAccountManager.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c3a2ed94fe276a125838a24edc43b215f90da865/mailnews/base/src/nsMsgAccountManager.h">file</a> |
<a href="/comm-central/annotate/c3a2ed94fe276a125838a24edc43b215f90da865/mailnews/base/src/nsMsgAccountManager.h">annotate</a> |
<a href="/comm-central/diff/c3a2ed94fe276a125838a24edc43b215f90da865/mailnews/base/src/nsMsgAccountManager.h">diff</a> |
<a href="/comm-central/comparison/c3a2ed94fe276a125838a24edc43b215f90da865/mailnews/base/src/nsMsgAccountManager.h">comparison</a> |
<a href="/comm-central/log/c3a2ed94fe276a125838a24edc43b215f90da865/mailnews/base/src/nsMsgAccountManager.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c3a2ed94fe276a125838a24edc43b215f90da865/mailnews/base/test/unit/test_accountMgr2.js">mailnews/base/test/unit/test_accountMgr2.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c3a2ed94fe276a125838a24edc43b215f90da865/mailnews/base/test/unit/test_accountMgr2.js">file</a> |
<a href="/comm-central/annotate/c3a2ed94fe276a125838a24edc43b215f90da865/mailnews/base/test/unit/test_accountMgr2.js">annotate</a> |
<a href="/comm-central/diff/c3a2ed94fe276a125838a24edc43b215f90da865/mailnews/base/test/unit/test_accountMgr2.js">diff</a> |
<a href="/comm-central/comparison/c3a2ed94fe276a125838a24edc43b215f90da865/mailnews/base/test/unit/test_accountMgr2.js">comparison</a> |
<a href="/comm-central/log/c3a2ed94fe276a125838a24edc43b215f90da865/mailnews/base/test/unit/test_accountMgr2.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c3a2ed94fe276a125838a24edc43b215f90da865/mailnews/compose/src/nsMsgCompose.cpp">mailnews/compose/src/nsMsgCompose.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c3a2ed94fe276a125838a24edc43b215f90da865/mailnews/compose/src/nsMsgCompose.cpp">file</a> |
<a href="/comm-central/annotate/c3a2ed94fe276a125838a24edc43b215f90da865/mailnews/compose/src/nsMsgCompose.cpp">annotate</a> |
<a href="/comm-central/diff/c3a2ed94fe276a125838a24edc43b215f90da865/mailnews/compose/src/nsMsgCompose.cpp">diff</a> |
<a href="/comm-central/comparison/c3a2ed94fe276a125838a24edc43b215f90da865/mailnews/compose/src/nsMsgCompose.cpp">comparison</a> |
<a href="/comm-central/log/c3a2ed94fe276a125838a24edc43b215f90da865/mailnews/compose/src/nsMsgCompose.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c3a2ed94fe276a125838a24edc43b215f90da865/mailnews/extensions/mdn/src/nsMsgMdnGenerator.cpp">mailnews/extensions/mdn/src/nsMsgMdnGenerator.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c3a2ed94fe276a125838a24edc43b215f90da865/mailnews/extensions/mdn/src/nsMsgMdnGenerator.cpp">file</a> |
<a href="/comm-central/annotate/c3a2ed94fe276a125838a24edc43b215f90da865/mailnews/extensions/mdn/src/nsMsgMdnGenerator.cpp">annotate</a> |
<a href="/comm-central/diff/c3a2ed94fe276a125838a24edc43b215f90da865/mailnews/extensions/mdn/src/nsMsgMdnGenerator.cpp">diff</a> |
<a href="/comm-central/comparison/c3a2ed94fe276a125838a24edc43b215f90da865/mailnews/extensions/mdn/src/nsMsgMdnGenerator.cpp">comparison</a> |
<a href="/comm-central/log/c3a2ed94fe276a125838a24edc43b215f90da865/mailnews/extensions/mdn/src/nsMsgMdnGenerator.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c3a2ed94fe276a125838a24edc43b215f90da865/mailnews/imap/src/nsImapMailFolder.cpp">mailnews/imap/src/nsImapMailFolder.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c3a2ed94fe276a125838a24edc43b215f90da865/mailnews/imap/src/nsImapMailFolder.cpp">file</a> |
<a href="/comm-central/annotate/c3a2ed94fe276a125838a24edc43b215f90da865/mailnews/imap/src/nsImapMailFolder.cpp">annotate</a> |
<a href="/comm-central/diff/c3a2ed94fe276a125838a24edc43b215f90da865/mailnews/imap/src/nsImapMailFolder.cpp">diff</a> |
<a href="/comm-central/comparison/c3a2ed94fe276a125838a24edc43b215f90da865/mailnews/imap/src/nsImapMailFolder.cpp">comparison</a> |
<a href="/comm-central/log/c3a2ed94fe276a125838a24edc43b215f90da865/mailnews/imap/src/nsImapMailFolder.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c3a2ed94fe276a125838a24edc43b215f90da865/suite/mailnews/content/mailCommands.js">suite/mailnews/content/mailCommands.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c3a2ed94fe276a125838a24edc43b215f90da865/suite/mailnews/content/mailCommands.js">file</a> |
<a href="/comm-central/annotate/c3a2ed94fe276a125838a24edc43b215f90da865/suite/mailnews/content/mailCommands.js">annotate</a> |
<a href="/comm-central/diff/c3a2ed94fe276a125838a24edc43b215f90da865/suite/mailnews/content/mailCommands.js">diff</a> |
<a href="/comm-central/comparison/c3a2ed94fe276a125838a24edc43b215f90da865/suite/mailnews/content/mailCommands.js">comparison</a> |
<a href="/comm-central/log/c3a2ed94fe276a125838a24edc43b215f90da865/suite/mailnews/content/mailCommands.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/calendar/base/modules/utils/calItipUtils.jsm</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/calendar/base/modules/utils/calItipUtils.jsm</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -2,16 +2,17 @@</span>
<a href="#l1.4"></a><span id="l1.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l1.5"></a><span id="l1.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l1.6"></a><span id="l1.6"> </span>
<a href="#l1.7"></a><span id="l1.7"> var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l1.8"></a><span id="l1.8"> var { MailServices } = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l1.9"></a><span id="l1.9"> var { calendarDeactivator } = ChromeUtils.import(</span>
<a href="#l1.10"></a><span id="l1.10">   &quot;resource:///modules/calendar/calCalendarDeactivator.jsm&quot;</span>
<a href="#l1.11"></a><span id="l1.11"> );</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+const { fixIterator } = ChromeUtils.import(&quot;resource:///modules/iteratorUtils.jsm&quot;);</span>
<a href="#l1.13"></a><span id="l1.13"> </span>
<a href="#l1.14"></a><span id="l1.14"> ChromeUtils.defineModuleGetter(this, &quot;cal&quot;, &quot;resource:///modules/calendar/calUtils.jsm&quot;);</span>
<a href="#l1.15"></a><span id="l1.15"> </span>
<a href="#l1.16"></a><span id="l1.16"> /*</span>
<a href="#l1.17"></a><span id="l1.17">  * Scheduling and iTIP helper code</span>
<a href="#l1.18"></a><span id="l1.18">  */</span>
<a href="#l1.19"></a><span id="l1.19"> </span>
<a href="#l1.20"></a><span id="l1.20"> // NOTE: This module should not be loaded directly, it is available when</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineat">@@ -507,17 +508,20 @@ var calitip = {</span>
<a href="#l1.22"></a><span id="l1.22">       return null;</span>
<a href="#l1.23"></a><span id="l1.23">     }</span>
<a href="#l1.24"></a><span id="l1.24"> </span>
<a href="#l1.25"></a><span id="l1.25">     let identities;</span>
<a href="#l1.26"></a><span id="l1.26">     let actMgr = MailServices.accounts;</span>
<a href="#l1.27"></a><span id="l1.27">     if (aMsgHdr.accountKey) {</span>
<a href="#l1.28"></a><span id="l1.28">       // First, check if the message has an account key. If so, we can use the</span>
<a href="#l1.29"></a><span id="l1.29">       // account identities to find the correct recipient</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineminus">-      identities = actMgr.getAccount(aMsgHdr.accountKey).identities;</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineplus">+      // Note: fixIterator here is a stopgap, to be removed (see Bug 1612239).</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineplus">+      identities = [</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineplus">+        ...fixIterator(actMgr.getAccount(aMsgHdr.accountKey).identities, Ci.nsIMsgIdentity),</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineplus">+      ];</span>
<a href="#l1.35"></a><span id="l1.35">     } else if (aMsgHdr.folder) {</span>
<a href="#l1.36"></a><span id="l1.36">       // Without an account key, we have to revert back to using the server</span>
<a href="#l1.37"></a><span id="l1.37">       identities = actMgr.getIdentitiesForServer(aMsgHdr.folder.server);</span>
<a href="#l1.38"></a><span id="l1.38">     }</span>
<a href="#l1.39"></a><span id="l1.39"> </span>
<a href="#l1.40"></a><span id="l1.40">     let emailMap = {};</span>
<a href="#l1.41"></a><span id="l1.41">     if (!identities || identities.length == 0) {</span>
<a href="#l1.42"></a><span id="l1.42">       let identity;</span>
<a href="#l1.43"></a><span id="l1.43" class="difflineat">@@ -537,18 +541,17 @@ var calitip = {</span>
<a href="#l1.44"></a><span id="l1.44">         } else {</span>
<a href="#l1.45"></a><span id="l1.45">           // If there are no identities at all, we cannot get a recipient.</span>
<a href="#l1.46"></a><span id="l1.46">           return null;</span>
<a href="#l1.47"></a><span id="l1.47">         }</span>
<a href="#l1.48"></a><span id="l1.48">       }</span>
<a href="#l1.49"></a><span id="l1.49">       emailMap[identity.email.toLowerCase()] = true;</span>
<a href="#l1.50"></a><span id="l1.50">     } else {</span>
<a href="#l1.51"></a><span id="l1.51">       // Build a map of usable email addresses</span>
<a href="#l1.52"></a><span id="l1.52" class="difflineminus">-      for (let i = 0; i &lt; identities.length; i++) {</span>
<a href="#l1.53"></a><span id="l1.53" class="difflineminus">-        let identity = identities.queryElementAt(i, Ci.nsIMsgIdentity);</span>
<a href="#l1.54"></a><span id="l1.54" class="difflineplus">+      for (let identity of identities) {</span>
<a href="#l1.55"></a><span id="l1.55">         emailMap[identity.email.toLowerCase()] = true;</span>
<a href="#l1.56"></a><span id="l1.56">       }</span>
<a href="#l1.57"></a><span id="l1.57">     }</span>
<a href="#l1.58"></a><span id="l1.58"> </span>
<a href="#l1.59"></a><span id="l1.59">     // First check the recipient list</span>
<a href="#l1.60"></a><span id="l1.60">     let toList = MailServices.headerParser.makeFromDisplayAddress(aMsgHdr.recipients || &quot;&quot;);</span>
<a href="#l1.61"></a><span id="l1.61">     for (let recipient of toList) {</span>
<a href="#l1.62"></a><span id="l1.62">       if (recipient.email.toLowerCase() in emailMap) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/base/content/folderDisplay.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/base/content/folderDisplay.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -2272,29 +2272,24 @@ FolderDisplayWidget.prototype = {</span>
<a href="#l2.4"></a><span id="l2.4">         return folderIdentity.archiveEnabled;</span>
<a href="#l2.5"></a><span id="l2.5">       }</span>
<a href="#l2.6"></a><span id="l2.6"> </span>
<a href="#l2.7"></a><span id="l2.7">       if (this.displayedFolder.server) {</span>
<a href="#l2.8"></a><span id="l2.8">         let serverIdentities = MailServices.accounts.getIdentitiesForServer(</span>
<a href="#l2.9"></a><span id="l2.9">           this.displayedFolder.server</span>
<a href="#l2.10"></a><span id="l2.10">         );</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-        const nsIMsgIdentity = Ci.nsIMsgIdentity;</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-        let allEnabled = undefined;</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineminus">-        for (let identity of fixIterator(serverIdentities, nsIMsgIdentity)) {</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineminus">-          if (allEnabled === undefined) {</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineminus">-            allEnabled = identity.archiveEnabled;</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineminus">-          } else if (identity.archiveEnabled != allEnabled) {</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineminus">-            allEnabled = undefined;</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineminus">-            break;</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineminus">-          }</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineplus">+        // Do all identities have the same archiveEnabled setting?</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineplus">+        if (serverIdentities.every(id =&gt; id.archiveEnabled)) {</span>
<a href="#l2.23"></a><span id="l2.23" class="difflineplus">+          return true;</span>
<a href="#l2.24"></a><span id="l2.24">         }</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineminus">-        if (allEnabled !== undefined) {</span>
<a href="#l2.26"></a><span id="l2.26" class="difflineminus">-          return allEnabled;</span>
<a href="#l2.27"></a><span id="l2.27" class="difflineplus">+        if (serverIdentities.every(id =&gt; !id.archiveEnabled)) {</span>
<a href="#l2.28"></a><span id="l2.28" class="difflineplus">+          return false;</span>
<a href="#l2.29"></a><span id="l2.29">         }</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineplus">+        // If we get here it's a mixture, so have to examine all the messages.</span>
<a href="#l2.31"></a><span id="l2.31">       }</span>
<a href="#l2.32"></a><span id="l2.32">     }</span>
<a href="#l2.33"></a><span id="l2.33"> </span>
<a href="#l2.34"></a><span id="l2.34">     // Either we've selected a small number of messages or we just can't</span>
<a href="#l2.35"></a><span id="l2.35">     // fast-path the result; examine all the messages.</span>
<a href="#l2.36"></a><span id="l2.36">     return this.selectedMessages.every(function(msg) {</span>
<a href="#l2.37"></a><span id="l2.37">       let identity = MailUtils.getIdentityForHeader(msg);</span>
<a href="#l2.38"></a><span id="l2.38">       return Boolean(identity &amp;&amp; identity.archiveEnabled);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/base/modules/MailUtils.jsm</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/base/modules/MailUtils.jsm</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -458,21 +458,18 @@ var MailUtils = {</span>
<a href="#l3.4"></a><span id="l3.4">         return defaultAccount.defaultIdentity;</span>
<a href="#l3.5"></a><span id="l3.5">       }</span>
<a href="#l3.6"></a><span id="l3.6">     }</span>
<a href="#l3.7"></a><span id="l3.7"> </span>
<a href="#l3.8"></a><span id="l3.8">     return identities[0];</span>
<a href="#l3.9"></a><span id="l3.9">   },</span>
<a href="#l3.10"></a><span id="l3.10"> </span>
<a href="#l3.11"></a><span id="l3.11">   getIdentityForServer(server, optionalHint) {</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-    var identities = MailServices.accounts.getIdentitiesForServer(server);</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-    return this.getBestIdentity(</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineminus">-      [...fixIterator(identities, Ci.nsIMsgIdentity)],</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineminus">-      optionalHint</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineminus">-    );</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineplus">+    let identities = MailServices.accounts.getIdentitiesForServer(server);</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineplus">+    return this.getBestIdentity(identities, optionalHint);</span>
<a href="#l3.19"></a><span id="l3.19">   },</span>
<a href="#l3.20"></a><span id="l3.20"> </span>
<a href="#l3.21"></a><span id="l3.21">   /**</span>
<a href="#l3.22"></a><span id="l3.22">    * Get the identity for the given header.</span>
<a href="#l3.23"></a><span id="l3.23">    * @param hdr nsIMsgHdr message header</span>
<a href="#l3.24"></a><span id="l3.24">    * @param type nsIMsgCompType compose type the identity is used for.</span>
<a href="#l3.25"></a><span id="l3.25">    */</span>
<a href="#l3.26"></a><span id="l3.26">   getIdentityForHeader(hdr, type, hint = &quot;&quot;) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/filters.jsm</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/modules/filters.jsm</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -369,25 +369,19 @@ function shutdownNewMailListener() {</span>
<a href="#l4.4"></a><span id="l4.4">     ].getService(Ci.nsIMsgFolderNotificationService);</span>
<a href="#l4.5"></a><span id="l4.5">     notificationService.removeListener(newMailListener);</span>
<a href="#l4.6"></a><span id="l4.6">     gNewMailListenerInitiated = false;</span>
<a href="#l4.7"></a><span id="l4.7">   }</span>
<a href="#l4.8"></a><span id="l4.8"> }</span>
<a href="#l4.9"></a><span id="l4.9"> </span>
<a href="#l4.10"></a><span id="l4.10"> function getIdentityForSender(senderEmail, msgServer) {</span>
<a href="#l4.11"></a><span id="l4.11">   let identities = MailServices.accounts.getIdentitiesForServer(msgServer);</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineminus">-  for (let i = 0; i &lt; identities.length; i++) {</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineminus">-    let id = identities.queryElementAt(i, Ci.nsIMsgIdentity);</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineminus">-    if (id.email.toLowerCase() === senderEmail.toLowerCase()) {</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineminus">-      return id;</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineminus">-    }</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineminus">-  }</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineminus">-</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineminus">-  return null;</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineplus">+  return identities.find(</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineplus">+    id =&gt; id.email.toLowerCase() === senderEmail.toLowerCase()</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineplus">+  );</span>
<a href="#l4.24"></a><span id="l4.24"> }</span>
<a href="#l4.25"></a><span id="l4.25"> </span>
<a href="#l4.26"></a><span id="l4.26"> var consumerList = [];</span>
<a href="#l4.27"></a><span id="l4.27"> </span>
<a href="#l4.28"></a><span id="l4.28"> function JsmimeEmitter(requireBody) {</span>
<a href="#l4.29"></a><span id="l4.29">   this.requireBody = requireBody;</span>
<a href="#l4.30"></a><span id="l4.30">   this.mimeTree = {</span>
<a href="#l4.31"></a><span id="l4.31">     partNum: &quot;&quot;,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/base/public/nsIMsgAccountManager.idl</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/base/public/nsIMsgAccountManager.idl</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -143,17 +143,17 @@ interface nsIMsgAccountManager : nsISupp</span>
<a href="#l5.4"></a><span id="l5.4">    * @return        If found, the nsIMsgAccount representing the account found.</span>
<a href="#l5.5"></a><span id="l5.5">    *                Otherwise returns null.</span>
<a href="#l5.6"></a><span id="l5.6">    */</span>
<a href="#l5.7"></a><span id="l5.7">   nsIMsgAccount FindAccountForServer(in nsIMsgIncomingServer server);</span>
<a href="#l5.8"></a><span id="l5.8"> </span>
<a href="#l5.9"></a><span id="l5.9">   /* given a server, return all identities in accounts that have this server</span>
<a href="#l5.10"></a><span id="l5.10">    * returns an array of nsIMsgIdentity</span>
<a href="#l5.11"></a><span id="l5.11">    */</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-  nsIArray getIdentitiesForServer(in nsIMsgIncomingServer server);</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+  Array&lt;nsIMsgIdentity&gt; getIdentitiesForServer(in nsIMsgIncomingServer server);</span>
<a href="#l5.14"></a><span id="l5.14"> </span>
<a href="#l5.15"></a><span id="l5.15">   /**</span>
<a href="#l5.16"></a><span id="l5.16">    * given a server, return the first identity in accounts that have this server</span>
<a href="#l5.17"></a><span id="l5.17">    */</span>
<a href="#l5.18"></a><span id="l5.18">   nsIMsgIdentity getFirstIdentityForServer(in nsIMsgIncomingServer server);</span>
<a href="#l5.19"></a><span id="l5.19"> </span>
<a href="#l5.20"></a><span id="l5.20">   /* given an identity, return all servers in accounts that have</span>
<a href="#l5.21"></a><span id="l5.21">    * this identity</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/base/search/content/searchWidgets.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/base/search/content/searchWidgets.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -1385,22 +1385,19 @@</span>
<a href="#l6.4"></a><span id="l6.4">       }</span>
<a href="#l6.5"></a><span id="l6.5"> </span>
<a href="#l6.6"></a><span id="l6.6">       /**</span>
<a href="#l6.7"></a><span id="l6.7">        * Check if there exist any templates in this account.</span>
<a href="#l6.8"></a><span id="l6.8">        * @return {Object[]} - An array of template headers: each has a label and</span>
<a href="#l6.9"></a><span id="l6.9">        *                      a value.</span>
<a href="#l6.10"></a><span id="l6.10">        */</span>
<a href="#l6.11"></a><span id="l6.11">       findTemplates() {</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-        let identitiesRaw = MailServices.accounts.getIdentitiesForServer(</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+        let identities = MailServices.accounts.getIdentitiesForServer(</span>
<a href="#l6.14"></a><span id="l6.14">           gFilterList.folder.server</span>
<a href="#l6.15"></a><span id="l6.15">         );</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineminus">-        let identities = Array.from(</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineminus">-          fixIterator(identitiesRaw, Ci.nsIMsgIdentity)</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineminus">-        );</span>
<a href="#l6.19"></a><span id="l6.19">         // Typically if this is Local Folders.</span>
<a href="#l6.20"></a><span id="l6.20">         if (identities.length == 0) {</span>
<a href="#l6.21"></a><span id="l6.21">           if (MailServices.accounts.defaultAccount) {</span>
<a href="#l6.22"></a><span id="l6.22">             identities.push(</span>
<a href="#l6.23"></a><span id="l6.23">               MailServices.accounts.defaultAccount.defaultIdentity</span>
<a href="#l6.24"></a><span id="l6.24">             );</span>
<a href="#l6.25"></a><span id="l6.25">           }</span>
<a href="#l6.26"></a><span id="l6.26">         }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/base/src/nsMsgAccountManager.cpp</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgAccountManager.cpp</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -1857,78 +1857,67 @@ nsMsgAccountManager::FindAccountForServe</span>
<a href="#l7.4"></a><span id="l7.4"> }</span>
<a href="#l7.5"></a><span id="l7.5"> </span>
<a href="#l7.6"></a><span id="l7.6"> NS_IMETHODIMP</span>
<a href="#l7.7"></a><span id="l7.7"> nsMsgAccountManager::GetFirstIdentityForServer(nsIMsgIncomingServer *aServer,</span>
<a href="#l7.8"></a><span id="l7.8">                                                nsIMsgIdentity **aIdentity) {</span>
<a href="#l7.9"></a><span id="l7.9">   NS_ENSURE_ARG_POINTER(aServer);</span>
<a href="#l7.10"></a><span id="l7.10">   NS_ENSURE_ARG_POINTER(aIdentity);</span>
<a href="#l7.11"></a><span id="l7.11"> </span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-  nsCOMPtr&lt;nsIArray&gt; identities;</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineminus">-  nsresult rv = GetIdentitiesForServer(aServer, getter_AddRefs(identities));</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+  nsTArray&lt;RefPtr&lt;nsIMsgIdentity&gt;&gt; identities;</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+  nsresult rv = GetIdentitiesForServer(aServer, identities);</span>
<a href="#l7.16"></a><span id="l7.16">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.17"></a><span id="l7.17"> </span>
<a href="#l7.18"></a><span id="l7.18">   // not all servers have identities</span>
<a href="#l7.19"></a><span id="l7.19">   // for example, Local Folders</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineminus">-  uint32_t numIdentities;</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineminus">-  rv = identities-&gt;GetLength(&amp;numIdentities);</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineminus">-</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineminus">-  if (numIdentities &gt; 0) {</span>
<a href="#l7.25"></a><span id="l7.25" class="difflineminus">-    nsCOMPtr&lt;nsIMsgIdentity&gt; identity(do_QueryElementAt(identities, 0, &amp;rv));</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.27"></a><span id="l7.27" class="difflineminus">-    identity.forget(aIdentity);</span>
<a href="#l7.28"></a><span id="l7.28" class="difflineminus">-  } else</span>
<a href="#l7.29"></a><span id="l7.29" class="difflineplus">+  if (identities.IsEmpty()) {</span>
<a href="#l7.30"></a><span id="l7.30">     *aIdentity = nullptr;</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineplus">+  } else {</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineplus">+    NS_IF_ADDREF(*aIdentity = identities[0]);</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineplus">+  }</span>
<a href="#l7.34"></a><span id="l7.34">   return rv;</span>
<a href="#l7.35"></a><span id="l7.35"> }</span>
<a href="#l7.36"></a><span id="l7.36"> </span>
<a href="#l7.37"></a><span id="l7.37"> NS_IMETHODIMP</span>
<a href="#l7.38"></a><span id="l7.38" class="difflineminus">-nsMsgAccountManager::GetIdentitiesForServer(nsIMsgIncomingServer *server,</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineminus">-                                            nsIArray **_retval) {</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineplus">+nsMsgAccountManager::GetIdentitiesForServer(</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineplus">+    nsIMsgIncomingServer *server,</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineplus">+    nsTArray&lt;RefPtr&lt;nsIMsgIdentity&gt;&gt; &amp;identities) {</span>
<a href="#l7.43"></a><span id="l7.43">   NS_ENSURE_ARG_POINTER(server);</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineminus">-  NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l7.45"></a><span id="l7.45">   nsresult rv = LoadAccounts();</span>
<a href="#l7.46"></a><span id="l7.46">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.47"></a><span id="l7.47"> </span>
<a href="#l7.48"></a><span id="l7.48" class="difflineminus">-  nsCOMPtr&lt;nsIMutableArray&gt; identities(</span>
<a href="#l7.49"></a><span id="l7.49" class="difflineminus">-      do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.51"></a><span id="l7.51" class="difflineplus">+  identities.Clear();</span>
<a href="#l7.52"></a><span id="l7.52"> </span>
<a href="#l7.53"></a><span id="l7.53">   nsAutoCString serverKey;</span>
<a href="#l7.54"></a><span id="l7.54">   rv = server-&gt;GetKey(serverKey);</span>
<a href="#l7.55"></a><span id="l7.55">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.56"></a><span id="l7.56"> </span>
<a href="#l7.57"></a><span id="l7.57" class="difflineminus">-  for (uint32_t i = 0; i &lt; m_accounts.Length(); ++i) {</span>
<a href="#l7.58"></a><span id="l7.58" class="difflineminus">-    nsCOMPtr&lt;nsIMsgAccount&gt; account(m_accounts[i]);</span>
<a href="#l7.59"></a><span id="l7.59" class="difflineminus">-</span>
<a href="#l7.60"></a><span id="l7.60" class="difflineplus">+  for (auto account : m_accounts) {</span>
<a href="#l7.61"></a><span id="l7.61">     nsCOMPtr&lt;nsIMsgIncomingServer&gt; thisServer;</span>
<a href="#l7.62"></a><span id="l7.62">     rv = account-&gt;GetIncomingServer(getter_AddRefs(thisServer));</span>
<a href="#l7.63"></a><span id="l7.63">     if (NS_FAILED(rv) || !thisServer) continue;</span>
<a href="#l7.64"></a><span id="l7.64"> </span>
<a href="#l7.65"></a><span id="l7.65">     nsAutoCString thisServerKey;</span>
<a href="#l7.66"></a><span id="l7.66">     rv = thisServer-&gt;GetKey(thisServerKey);</span>
<a href="#l7.67"></a><span id="l7.67">     if (serverKey.Equals(thisServerKey)) {</span>
<a href="#l7.68"></a><span id="l7.68">       nsCOMPtr&lt;nsIArray&gt; theseIdentities;</span>
<a href="#l7.69"></a><span id="l7.69">       rv = account-&gt;GetIdentities(getter_AddRefs(theseIdentities));</span>
<a href="#l7.70"></a><span id="l7.70">       if (NS_SUCCEEDED(rv)) {</span>
<a href="#l7.71"></a><span id="l7.71">         uint32_t theseLength;</span>
<a href="#l7.72"></a><span id="l7.72">         rv = theseIdentities-&gt;GetLength(&amp;theseLength);</span>
<a href="#l7.73"></a><span id="l7.73">         if (NS_SUCCEEDED(rv)) {</span>
<a href="#l7.74"></a><span id="l7.74">           for (uint32_t j = 0; j &lt; theseLength; ++j) {</span>
<a href="#l7.75"></a><span id="l7.75" class="difflineminus">-            nsCOMPtr&lt;nsISupports&gt; id(</span>
<a href="#l7.76"></a><span id="l7.76" class="difflineplus">+            nsCOMPtr&lt;nsIMsgIdentity&gt; id(</span>
<a href="#l7.77"></a><span id="l7.77">                 do_QueryElementAt(theseIdentities, j, &amp;rv));</span>
<a href="#l7.78"></a><span id="l7.78" class="difflineminus">-            if (NS_SUCCEEDED(rv)) identities-&gt;AppendElement(id);</span>
<a href="#l7.79"></a><span id="l7.79" class="difflineplus">+            if (NS_SUCCEEDED(rv)) identities.AppendElement(id);</span>
<a href="#l7.80"></a><span id="l7.80">           }</span>
<a href="#l7.81"></a><span id="l7.81">         }</span>
<a href="#l7.82"></a><span id="l7.82">       }</span>
<a href="#l7.83"></a><span id="l7.83">     }</span>
<a href="#l7.84"></a><span id="l7.84">   }</span>
<a href="#l7.85"></a><span id="l7.85" class="difflineminus">-</span>
<a href="#l7.86"></a><span id="l7.86" class="difflineminus">-  identities.forget(_retval);</span>
<a href="#l7.87"></a><span id="l7.87">   return NS_OK;</span>
<a href="#l7.88"></a><span id="l7.88"> }</span>
<a href="#l7.89"></a><span id="l7.89"> </span>
<a href="#l7.90"></a><span id="l7.90"> NS_IMETHODIMP</span>
<a href="#l7.91"></a><span id="l7.91"> nsMsgAccountManager::GetServersForIdentity(nsIMsgIdentity *aIdentity,</span>
<a href="#l7.92"></a><span id="l7.92">                                            nsIArray **_retval) {</span>
<a href="#l7.93"></a><span id="l7.93">   NS_ENSURE_ARG_POINTER(aIdentity);</span>
<a href="#l7.94"></a><span id="l7.94"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/base/src/nsMsgAccountManager.h</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgAccountManager.h</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -81,23 +81,23 @@ class nsMsgAccountManager : public nsIMs</span>
<a href="#l8.4"></a><span id="l8.4">   nsresult Shutdown();</span>
<a href="#l8.5"></a><span id="l8.5">   void LogoutOfServer(nsIMsgIncomingServer *aServer);</span>
<a href="#l8.6"></a><span id="l8.6"> </span>
<a href="#l8.7"></a><span id="l8.7">  private:</span>
<a href="#l8.8"></a><span id="l8.8">   virtual ~nsMsgAccountManager();</span>
<a href="#l8.9"></a><span id="l8.9"> </span>
<a href="#l8.10"></a><span id="l8.10">   bool m_accountsLoaded;</span>
<a href="#l8.11"></a><span id="l8.11">   nsCOMPtr&lt;nsIMsgFolderCache&gt; m_msgFolderCache;</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-  nsTArray&lt;nsCOMPtr&lt;nsIMsgAccount&gt; &gt; m_accounts;</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+  nsTArray&lt;nsCOMPtr&lt;nsIMsgAccount&gt;&gt; m_accounts;</span>
<a href="#l8.14"></a><span id="l8.14">   nsInterfaceHashtable&lt;nsCStringHashKey, nsIMsgIdentity&gt; m_identities;</span>
<a href="#l8.15"></a><span id="l8.15">   nsInterfaceHashtable&lt;nsCStringHashKey, nsIMsgIncomingServer&gt;</span>
<a href="#l8.16"></a><span id="l8.16">       m_incomingServers;</span>
<a href="#l8.17"></a><span id="l8.17">   nsCOMPtr&lt;nsIMsgAccount&gt; m_defaultAccount;</span>
<a href="#l8.18"></a><span id="l8.18">   nsCOMArray&lt;nsIIncomingServerListener&gt; m_incomingServerListeners;</span>
<a href="#l8.19"></a><span id="l8.19" class="difflineminus">-  nsTObserverArray&lt;RefPtr&lt;VirtualFolderChangeListener&gt; &gt;</span>
<a href="#l8.20"></a><span id="l8.20" class="difflineplus">+  nsTObserverArray&lt;RefPtr&lt;VirtualFolderChangeListener&gt;&gt;</span>
<a href="#l8.21"></a><span id="l8.21">       m_virtualFolderListeners;</span>
<a href="#l8.22"></a><span id="l8.22">   nsCOMPtr&lt;nsIMsgFolder&gt; m_folderDoingEmptyTrash;</span>
<a href="#l8.23"></a><span id="l8.23">   nsCOMPtr&lt;nsIMsgFolder&gt; m_folderDoingCleanupInbox;</span>
<a href="#l8.24"></a><span id="l8.24">   bool m_emptyTrashInProgress;</span>
<a href="#l8.25"></a><span id="l8.25">   bool m_cleanupInboxInProgress;</span>
<a href="#l8.26"></a><span id="l8.26"> </span>
<a href="#l8.27"></a><span id="l8.27">   nsCString mAccountKeyList;</span>
<a href="#l8.28"></a><span id="l8.28"> </span>
<a href="#l8.29"></a><span id="l8.29" class="difflineat">@@ -205,12 +205,12 @@ class nsMsgAccountManager : public nsIMs</span>
<a href="#l8.30"></a><span id="l8.30">   //</span>
<a href="#l8.31"></a><span id="l8.31"> </span>
<a href="#l8.32"></a><span id="l8.32">   // this array is for folder listeners that are supposed to be listening</span>
<a href="#l8.33"></a><span id="l8.33">   // on the root folders.</span>
<a href="#l8.34"></a><span id="l8.34">   // When a new server is created, all of the the folder listeners</span>
<a href="#l8.35"></a><span id="l8.35">   //    should be added to the new server</span>
<a href="#l8.36"></a><span id="l8.36">   // When a new listener is added, it should be added to all root folders.</span>
<a href="#l8.37"></a><span id="l8.37">   // similar for when servers are deleted or listeners removed</span>
<a href="#l8.38"></a><span id="l8.38" class="difflineminus">-  nsTObserverArray&lt;nsCOMPtr&lt;nsIFolderListener&gt; &gt; mFolderListeners;</span>
<a href="#l8.39"></a><span id="l8.39" class="difflineplus">+  nsTObserverArray&lt;nsCOMPtr&lt;nsIFolderListener&gt;&gt; mFolderListeners;</span>
<a href="#l8.40"></a><span id="l8.40"> </span>
<a href="#l8.41"></a><span id="l8.41">   void removeListenersFromFolder(nsIMsgFolder *aFolder);</span>
<a href="#l8.42"></a><span id="l8.42"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/base/test/unit/test_accountMgr2.js</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_accountMgr2.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -49,9 +49,14 @@ add_task(async function() {</span>
<a href="#l9.4"></a><span id="l9.4">   // Setup done. Now check that things are as we expect.</span>
<a href="#l9.5"></a><span id="l9.5"> </span>
<a href="#l9.6"></a><span id="l9.6">   // At this point we should have 3 accounts and servers (imap, pop, local).</span>
<a href="#l9.7"></a><span id="l9.7">   Assert.equal(mgr.accounts.length, 3);</span>
<a href="#l9.8"></a><span id="l9.8">   Assert.equal(mgr.allServers.length, 3);</span>
<a href="#l9.9"></a><span id="l9.9"> </span>
<a href="#l9.10"></a><span id="l9.10">   // The identities we explicitly created.</span>
<a href="#l9.11"></a><span id="l9.11">   Assert.equal(mgr.allIdentities.length, 3);</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineplus">+</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+  // Check we find the right number of identities associated with each server.</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineplus">+  Assert.equal(mgr.getIdentitiesForServer(acc1.incomingServer).length, 2);</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineplus">+  Assert.equal(mgr.getIdentitiesForServer(acc2.incomingServer).length, 2);</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineplus">+  Assert.equal(mgr.getIdentitiesForServer(mgr.localFoldersServer).length, 0);</span>
<a href="#l9.17"></a><span id="l9.17"> });</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgCompose.cpp</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgCompose.cpp</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -2477,41 +2477,28 @@ QuotingOutputStreamListener::OnStopReque</span>
<a href="#l10.4"></a><span id="l10.4">         nsCOMPtr&lt;nsIMsgFolder&gt; msgFolder;</span>
<a href="#l10.5"></a><span id="l10.5">         rv = mOrigMsgHdr-&gt;GetFolder(getter_AddRefs(msgFolder));</span>
<a href="#l10.6"></a><span id="l10.6"> </span>
<a href="#l10.7"></a><span id="l10.7">         if (NS_SUCCEEDED(rv) &amp;&amp; msgFolder) {</span>
<a href="#l10.8"></a><span id="l10.8">           nsCOMPtr&lt;nsIMsgIncomingServer&gt; nsIMsgIncomingServer;</span>
<a href="#l10.9"></a><span id="l10.9">           rv = msgFolder-&gt;GetServer(getter_AddRefs(nsIMsgIncomingServer));</span>
<a href="#l10.10"></a><span id="l10.10"> </span>
<a href="#l10.11"></a><span id="l10.11">           if (NS_SUCCEEDED(rv) &amp;&amp; nsIMsgIncomingServer) {</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-            // TODO: Bug 1614846 - stopgap until</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineminus">-            // nsIAccountManager.getIdentitiesForServer(). takes nsTArray&lt;&gt;.</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineminus">-            nsCOMPtr&lt;nsIArray&gt; tmp;</span>
<a href="#l10.15"></a><span id="l10.15">             rv = accountManager-&gt;GetIdentitiesForServer(nsIMsgIncomingServer,</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineminus">-                                                        getter_AddRefs(tmp));</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineplus">+                                                        identities);</span>
<a href="#l10.18"></a><span id="l10.18">             NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.19"></a><span id="l10.19" class="difflineminus">-            uint32_t numElements;</span>
<a href="#l10.20"></a><span id="l10.20" class="difflineminus">-            rv = tmp-&gt;GetLength(&amp;numElements);</span>
<a href="#l10.21"></a><span id="l10.21" class="difflineminus">-            NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.22"></a><span id="l10.22" class="difflineminus">-            for (uint32_t i = 0; i &lt; numElements; i++) {</span>
<a href="#l10.23"></a><span id="l10.23" class="difflineminus">-              nsCOMPtr&lt;nsIMsgIdentity&gt; ident = do_QueryElementAt(tmp, i, &amp;rv);</span>
<a href="#l10.24"></a><span id="l10.24" class="difflineminus">-              NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.25"></a><span id="l10.25" class="difflineminus">-              identities.AppendElement(ident);</span>
<a href="#l10.26"></a><span id="l10.26" class="difflineminus">-            }</span>
<a href="#l10.27"></a><span id="l10.27">           }</span>
<a href="#l10.28"></a><span id="l10.28">         }</span>
<a href="#l10.29"></a><span id="l10.29">       }</span>
<a href="#l10.30"></a><span id="l10.30"> </span>
<a href="#l10.31"></a><span id="l10.31">       bool isReplyToSelf = false;</span>
<a href="#l10.32"></a><span id="l10.32">       nsCOMPtr&lt;nsIMsgIdentity&gt; selfIdentity;</span>
<a href="#l10.33"></a><span id="l10.33">       if (!identities.IsEmpty()) {</span>
<a href="#l10.34"></a><span id="l10.34">         // Go through the identities to see if any of them is the author of</span>
<a href="#l10.35"></a><span id="l10.35">         // the email.</span>
<a href="#l10.36"></a><span id="l10.36" class="difflineminus">-        nsCOMPtr&lt;nsIMsgIdentity&gt; lookupIdentity;</span>
<a href="#l10.37"></a><span id="l10.37" class="difflineminus">-</span>
<a href="#l10.38"></a><span id="l10.38">         for (auto lookupIdentity : identities) {</span>
<a href="#l10.39"></a><span id="l10.39">           selfIdentity = lookupIdentity;</span>
<a href="#l10.40"></a><span id="l10.40"> </span>
<a href="#l10.41"></a><span id="l10.41">           nsCString curIdentityEmail;</span>
<a href="#l10.42"></a><span id="l10.42">           lookupIdentity-&gt;GetEmail(curIdentityEmail);</span>
<a href="#l10.43"></a><span id="l10.43"> </span>
<a href="#l10.44"></a><span id="l10.44">           // See if it's a reply to own message, but not a reply between</span>
<a href="#l10.45"></a><span id="l10.45">           // identities.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mailnews/extensions/mdn/src/nsMsgMdnGenerator.cpp</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mailnews/extensions/mdn/src/nsMsgMdnGenerator.cpp</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -787,55 +787,47 @@ nsresult nsMsgMdnGenerator::InitAndProce</span>
<a href="#l11.4"></a><span id="l11.4">       if (account) account-&gt;GetIncomingServer(getter_AddRefs(m_server));</span>
<a href="#l11.5"></a><span id="l11.5"> </span>
<a href="#l11.6"></a><span id="l11.6">       if (m_server) {</span>
<a href="#l11.7"></a><span id="l11.7">         // Find the correct identity based on the &quot;To:&quot; and &quot;Cc:&quot; header</span>
<a href="#l11.8"></a><span id="l11.8">         nsCString mailTo;</span>
<a href="#l11.9"></a><span id="l11.9">         nsCString mailCC;</span>
<a href="#l11.10"></a><span id="l11.10">         m_headers-&gt;ExtractHeader(HEADER_TO, true, mailTo);</span>
<a href="#l11.11"></a><span id="l11.11">         m_headers-&gt;ExtractHeader(HEADER_CC, true, mailCC);</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-        nsCOMPtr&lt;nsIArray&gt; servIdentities;</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineminus">-        accountManager-&gt;GetIdentitiesForServer(m_server,</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineminus">-                                               getter_AddRefs(servIdentities));</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineminus">-        if (servIdentities) {</span>
<a href="#l11.16"></a><span id="l11.16" class="difflineminus">-          nsCOMPtr&lt;nsIMsgIdentity&gt; ident;</span>
<a href="#l11.17"></a><span id="l11.17" class="difflineplus">+        nsTArray&lt;RefPtr&lt;nsIMsgIdentity&gt;&gt; servIdentities;</span>
<a href="#l11.18"></a><span id="l11.18" class="difflineplus">+        accountManager-&gt;GetIdentitiesForServer(m_server, servIdentities);</span>
<a href="#l11.19"></a><span id="l11.19" class="difflineplus">+</span>
<a href="#l11.20"></a><span id="l11.20" class="difflineplus">+        // First check in the &quot;To:&quot; header</span>
<a href="#l11.21"></a><span id="l11.21" class="difflineplus">+        for (auto ident : servIdentities) {</span>
<a href="#l11.22"></a><span id="l11.22">           nsCString identEmail;</span>
<a href="#l11.23"></a><span id="l11.23" class="difflineminus">-          uint32_t count = 0;</span>
<a href="#l11.24"></a><span id="l11.24" class="difflineminus">-          servIdentities-&gt;GetLength(&amp;count);</span>
<a href="#l11.25"></a><span id="l11.25" class="difflineminus">-          // First check in the &quot;To:&quot; header</span>
<a href="#l11.26"></a><span id="l11.26" class="difflineminus">-          for (uint32_t i = 0; i &lt; count; i++) {</span>
<a href="#l11.27"></a><span id="l11.27" class="difflineminus">-            ident = do_QueryElementAt(servIdentities, i, &amp;rv);</span>
<a href="#l11.28"></a><span id="l11.28" class="difflineminus">-            if (NS_FAILED(rv)) continue;</span>
<a href="#l11.29"></a><span id="l11.29" class="difflineplus">+          ident-&gt;GetEmail(identEmail);</span>
<a href="#l11.30"></a><span id="l11.30" class="difflineplus">+          if (!mailTo.IsEmpty() &amp;&amp; !identEmail.IsEmpty() &amp;&amp;</span>
<a href="#l11.31"></a><span id="l11.31" class="difflineplus">+              mailTo.Find(identEmail, /* ignoreCase = */ true) != kNotFound) {</span>
<a href="#l11.32"></a><span id="l11.32" class="difflineplus">+            m_identity = ident;</span>
<a href="#l11.33"></a><span id="l11.33" class="difflineplus">+            break;</span>
<a href="#l11.34"></a><span id="l11.34" class="difflineplus">+          }</span>
<a href="#l11.35"></a><span id="l11.35" class="difflineplus">+        }</span>
<a href="#l11.36"></a><span id="l11.36" class="difflineplus">+        // If no match, check the &quot;Cc:&quot; header</span>
<a href="#l11.37"></a><span id="l11.37" class="difflineplus">+        if (!m_identity) {</span>
<a href="#l11.38"></a><span id="l11.38" class="difflineplus">+          for (auto ident : servIdentities) {</span>
<a href="#l11.39"></a><span id="l11.39" class="difflineplus">+            nsCString identEmail;</span>
<a href="#l11.40"></a><span id="l11.40">             ident-&gt;GetEmail(identEmail);</span>
<a href="#l11.41"></a><span id="l11.41" class="difflineminus">-            if (!mailTo.IsEmpty() &amp;&amp; !identEmail.IsEmpty() &amp;&amp;</span>
<a href="#l11.42"></a><span id="l11.42" class="difflineminus">-                mailTo.Find(identEmail, /* ignoreCase = */ true) != kNotFound) {</span>
<a href="#l11.43"></a><span id="l11.43" class="difflineplus">+            if (!mailCC.IsEmpty() &amp;&amp; !identEmail.IsEmpty() &amp;&amp;</span>
<a href="#l11.44"></a><span id="l11.44" class="difflineplus">+                mailCC.Find(identEmail, /* ignoreCase = */ true) != kNotFound) {</span>
<a href="#l11.45"></a><span id="l11.45">               m_identity = ident;</span>
<a href="#l11.46"></a><span id="l11.46">               break;</span>
<a href="#l11.47"></a><span id="l11.47">             }</span>
<a href="#l11.48"></a><span id="l11.48">           }</span>
<a href="#l11.49"></a><span id="l11.49" class="difflineminus">-          // If no match, check the &quot;Cc:&quot; header</span>
<a href="#l11.50"></a><span id="l11.50" class="difflineminus">-          if (!m_identity) {</span>
<a href="#l11.51"></a><span id="l11.51" class="difflineminus">-            for (uint32_t i = 0; i &lt; count; i++) {</span>
<a href="#l11.52"></a><span id="l11.52" class="difflineminus">-              ident = do_QueryElementAt(servIdentities, i, &amp;rv);</span>
<a href="#l11.53"></a><span id="l11.53" class="difflineminus">-              if (NS_FAILED(rv)) continue;</span>
<a href="#l11.54"></a><span id="l11.54" class="difflineminus">-              ident-&gt;GetEmail(identEmail);</span>
<a href="#l11.55"></a><span id="l11.55" class="difflineminus">-              if (!mailCC.IsEmpty() &amp;&amp; !identEmail.IsEmpty() &amp;&amp;</span>
<a href="#l11.56"></a><span id="l11.56" class="difflineminus">-                  mailCC.Find(identEmail, /* ignoreCase = */ true) !=</span>
<a href="#l11.57"></a><span id="l11.57" class="difflineminus">-                      kNotFound) {</span>
<a href="#l11.58"></a><span id="l11.58" class="difflineminus">-                m_identity = ident;</span>
<a href="#l11.59"></a><span id="l11.59" class="difflineminus">-                break;</span>
<a href="#l11.60"></a><span id="l11.60" class="difflineminus">-              }</span>
<a href="#l11.61"></a><span id="l11.61" class="difflineminus">-            }</span>
<a href="#l11.62"></a><span id="l11.62" class="difflineminus">-          }</span>
<a href="#l11.63"></a><span id="l11.63">         }</span>
<a href="#l11.64"></a><span id="l11.64"> </span>
<a href="#l11.65"></a><span id="l11.65" class="difflineminus">-        // If no match again, use the first identity</span>
<a href="#l11.66"></a><span id="l11.66" class="difflineminus">-        if (!m_identity)</span>
<a href="#l11.67"></a><span id="l11.67" class="difflineplus">+        // If still no match, use the first identity</span>
<a href="#l11.68"></a><span id="l11.68" class="difflineplus">+        if (!m_identity) {</span>
<a href="#l11.69"></a><span id="l11.69">           rv = accountManager-&gt;GetFirstIdentityForServer(</span>
<a href="#l11.70"></a><span id="l11.70">               m_server, getter_AddRefs(m_identity));</span>
<a href="#l11.71"></a><span id="l11.71" class="difflineplus">+        }</span>
<a href="#l11.72"></a><span id="l11.72">       }</span>
<a href="#l11.73"></a><span id="l11.73">     }</span>
<a href="#l11.74"></a><span id="l11.74">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.75"></a><span id="l11.75"> </span>
<a href="#l11.76"></a><span id="l11.76">     if (m_identity) {</span>
<a href="#l11.77"></a><span id="l11.77">       bool useCustomPrefs = false;</span>
<a href="#l11.78"></a><span id="l11.78">       m_identity-&gt;GetBoolAttribute(&quot;use_custom_prefs&quot;, &amp;useCustomPrefs);</span>
<a href="#l11.79"></a><span id="l11.79">       if (useCustomPrefs) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mailnews/imap/src/nsImapMailFolder.cpp</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapMailFolder.cpp</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -8696,33 +8696,26 @@ NS_IMETHODIMP nsImapMailFolder::GetCusto</span>
<a href="#l12.4"></a><span id="l12.4">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.5"></a><span id="l12.5">       ourIdentity-&gt;GetEmail(ourEmailAddress);</span>
<a href="#l12.6"></a><span id="l12.6">       int32_t atPos = ourEmailAddress.FindChar('@');</span>
<a href="#l12.7"></a><span id="l12.7">       if (atPos != kNotFound) {</span>
<a href="#l12.8"></a><span id="l12.8">         nsCString otherUsersEmailAddress;</span>
<a href="#l12.9"></a><span id="l12.9">         GetFolderOwnerUserName(otherUsersEmailAddress);</span>
<a href="#l12.10"></a><span id="l12.10">         otherUsersEmailAddress.Append(</span>
<a href="#l12.11"></a><span id="l12.11">             Substring(ourEmailAddress, atPos, ourEmailAddress.Length()));</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-        nsCOMPtr&lt;nsIArray&gt; identities;</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineminus">-        rv = accountManager-&gt;GetIdentitiesForServer(server,</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineminus">-                                                    getter_AddRefs(identities));</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineplus">+        nsTArray&lt;RefPtr&lt;nsIMsgIdentity&gt;&gt; identities;</span>
<a href="#l12.16"></a><span id="l12.16" class="difflineplus">+        rv = accountManager-&gt;GetIdentitiesForServer(server, identities);</span>
<a href="#l12.17"></a><span id="l12.17">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.18"></a><span id="l12.18" class="difflineminus">-        uint32_t numIdentities;</span>
<a href="#l12.19"></a><span id="l12.19" class="difflineminus">-        rv = identities-&gt;GetLength(&amp;numIdentities);</span>
<a href="#l12.20"></a><span id="l12.20" class="difflineminus">-        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.21"></a><span id="l12.21" class="difflineminus">-        for (uint32_t identityIndex = 0; identityIndex &lt; numIdentities;</span>
<a href="#l12.22"></a><span id="l12.22" class="difflineminus">-             identityIndex++) {</span>
<a href="#l12.23"></a><span id="l12.23" class="difflineminus">-          nsCOMPtr&lt;nsIMsgIdentity&gt; identity =</span>
<a href="#l12.24"></a><span id="l12.24" class="difflineminus">-              do_QueryElementAt(identities, identityIndex);</span>
<a href="#l12.25"></a><span id="l12.25" class="difflineplus">+</span>
<a href="#l12.26"></a><span id="l12.26" class="difflineplus">+        for (auto identity : identities) {</span>
<a href="#l12.27"></a><span id="l12.27">           if (!identity) continue;</span>
<a href="#l12.28"></a><span id="l12.28">           nsCString identityEmail;</span>
<a href="#l12.29"></a><span id="l12.29">           identity-&gt;GetEmail(identityEmail);</span>
<a href="#l12.30"></a><span id="l12.30">           if (identityEmail.Equals(otherUsersEmailAddress)) {</span>
<a href="#l12.31"></a><span id="l12.31">             retIdentity = identity;</span>
<a href="#l12.32"></a><span id="l12.32" class="difflineminus">-            ;</span>
<a href="#l12.33"></a><span id="l12.33">             break;</span>
<a href="#l12.34"></a><span id="l12.34">           }</span>
<a href="#l12.35"></a><span id="l12.35">         }</span>
<a href="#l12.36"></a><span id="l12.36">         if (!retIdentity) {</span>
<a href="#l12.37"></a><span id="l12.37">           // create the identity</span>
<a href="#l12.38"></a><span id="l12.38">           rv = accountManager-&gt;CreateIdentity(getter_AddRefs(retIdentity));</span>
<a href="#l12.39"></a><span id="l12.39">           NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.40"></a><span id="l12.40">           retIdentity-&gt;SetEmail(otherUsersEmailAddress);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/suite/mailnews/content/mailCommands.js</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/suite/mailnews/content/mailCommands.js</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -50,18 +50,18 @@ function getBestIdentity(identities, opt</span>
<a href="#l13.4"></a><span id="l13.4">     }</span>
<a href="#l13.5"></a><span id="l13.5">   }</span>
<a href="#l13.6"></a><span id="l13.6">   // Return only found identity or pick the first one from list if no matches found.</span>
<a href="#l13.7"></a><span id="l13.7">   return identities[0];</span>
<a href="#l13.8"></a><span id="l13.8"> }</span>
<a href="#l13.9"></a><span id="l13.9"> </span>
<a href="#l13.10"></a><span id="l13.10"> function getIdentityForServer(server, optionalHint)</span>
<a href="#l13.11"></a><span id="l13.11"> {</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-  var identities = accountManager.getIdentitiesForServer(server);</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineminus">-  return getBestIdentity(fixIterator(identities, nsIMsgAccount), optionalHint);</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineplus">+  let identities = accountManager.getIdentitiesForServer(server);</span>
<a href="#l13.15"></a><span id="l13.15" class="difflineplus">+  return getBestIdentity(identities, optionalHint);</span>
<a href="#l13.16"></a><span id="l13.16"> }</span>
<a href="#l13.17"></a><span id="l13.17"> </span>
<a href="#l13.18"></a><span id="l13.18"> /**</span>
<a href="#l13.19"></a><span id="l13.19">  * Get the identity for the given header.</span>
<a href="#l13.20"></a><span id="l13.20">  * @param hdr nsIMsgHdr message header</span>
<a href="#l13.21"></a><span id="l13.21">  * @param type nsIMsgCompType compose type the identity ise used for.</span>
<a href="#l13.22"></a><span id="l13.22">  */</span>
<a href="#l13.23"></a><span id="l13.23"> </span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:32Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

