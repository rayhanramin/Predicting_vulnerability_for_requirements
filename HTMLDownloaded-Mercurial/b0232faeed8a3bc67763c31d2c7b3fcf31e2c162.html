<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 29015:b0232faeed8a3bc67763c31d2c7b3fcf31e2c162</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ b0232faeed8a3bc67763c31d2c7b3fcf31e2c162" />
<meta property="og:url" content="/comm-central/rev/b0232faeed8a3bc67763c31d2c7b3fcf31e2c162" />
<meta property="og:description" content="Bug 1621128 - Change OpenPGP to use the configured key. r=PatrickBrunschwig" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / b0232faeed8a3bc67763c31d2c7b3fcf31e2c162 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/b0232faeed8a3bc67763c31d2c7b3fcf31e2c162">shortlog</a> |
<a href="/comm-central/log/b0232faeed8a3bc67763c31d2c7b3fcf31e2c162">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/b0232faeed8a3bc67763c31d2c7b3fcf31e2c162">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/b0232faeed8a3bc67763c31d2c7b3fcf31e2c162">files</a> |
changeset |
<a href="/comm-central/raw-rev/b0232faeed8a3bc67763c31d2c7b3fcf31e2c162">raw</a>  | <a href="/comm-central/archive/b0232faeed8a3bc67763c31d2c7b3fcf31e2c162.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1621128">Bug 1621128</a> - Change OpenPGP to use the configured key. r=PatrickBrunschwig
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#75;&#97;&#105;&#32;&#69;&#110;&#103;&#101;&#114;&#116;&#32;&#60;&#107;&#97;&#105;&#101;&#64;&#107;&#117;&#105;&#120;&#46;&#100;&#101;&#62;</td></tr>
<tr><td></td><td class="date age">Mon, 09 Mar 2020 21:41:09 +0100</td></tr>

<tr>
 <td>changeset 29015</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/b0232faeed8a3bc67763c31d2c7b3fcf31e2c162">b0232faeed8a3bc67763c31d2c7b3fcf31e2c162</a></td>
</tr>



<tr>
<td>parent 29014</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/586f1686ac4ba992fb059603fef073850926e39b">586f1686ac4ba992fb059603fef073850926e39b</a>
</td>
</tr>

<tr>
<td>child 29016</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/88ed189e636041ce222a2767664c3bfdc833ead8">88ed189e636041ce222a2767664c3bfdc833ead8</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=b0232faeed8a3bc67763c31d2c7b3fcf31e2c162">17157</a></td></tr>
<tr><td>push user</td><td>kaie@kuix.de</td></tr>
<tr><td>push date</td><td class="date age">Wed, 18 Mar 2020 20:25:15 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@1b32eca4d77c [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=1b32eca4d77c757ef20f83bfd54f5d0f3c830a9f">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=1b32eca4d77c757ef20f83bfd54f5d0f3c830a9f&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=1b32eca4d77c757ef20f83bfd54f5d0f3c830a9f&newProject=comm-central&newRevision=586f1686ac4ba992fb059603fef073850926e39b&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=1b32eca4d77c757ef20f83bfd54f5d0f3c830a9f&newProject=comm-central&newRevision=586f1686ac4ba992fb059603fef073850926e39b&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=1b32eca4d77c757ef20f83bfd54f5d0f3c830a9f&newProject=comm-central&newRevision=586f1686ac4ba992fb059603fef073850926e39b&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28PatrickBrunschwig%29&revcount=50">PatrickBrunschwig</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1621128">1621128</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1621128">Bug 1621128</a> - Change OpenPGP to use the configured key. r=PatrickBrunschwig

Differential Revision: <a href="https://phabricator.services.mozilla.com/D66661">https://phabricator.services.mozilla.com/D66661</a></div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b0232faeed8a3bc67763c31d2c7b3fcf31e2c162/mail/extensions/am-e2e/prefs/e2e-prefs.js">mail/extensions/am-e2e/prefs/e2e-prefs.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b0232faeed8a3bc67763c31d2c7b3fcf31e2c162/mail/extensions/am-e2e/prefs/e2e-prefs.js">file</a> |
<a href="/comm-central/annotate/b0232faeed8a3bc67763c31d2c7b3fcf31e2c162/mail/extensions/am-e2e/prefs/e2e-prefs.js">annotate</a> |
<a href="/comm-central/diff/b0232faeed8a3bc67763c31d2c7b3fcf31e2c162/mail/extensions/am-e2e/prefs/e2e-prefs.js">diff</a> |
<a href="/comm-central/comparison/b0232faeed8a3bc67763c31d2c7b3fcf31e2c162/mail/extensions/am-e2e/prefs/e2e-prefs.js">comparison</a> |
<a href="/comm-central/log/b0232faeed8a3bc67763c31d2c7b3fcf31e2c162/mail/extensions/am-e2e/prefs/e2e-prefs.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b0232faeed8a3bc67763c31d2c7b3fcf31e2c162/mail/extensions/openpgp/content/BondOpenPGP.jsm">mail/extensions/openpgp/content/BondOpenPGP.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b0232faeed8a3bc67763c31d2c7b3fcf31e2c162/mail/extensions/openpgp/content/BondOpenPGP.jsm">file</a> |
<a href="/comm-central/annotate/b0232faeed8a3bc67763c31d2c7b3fcf31e2c162/mail/extensions/openpgp/content/BondOpenPGP.jsm">annotate</a> |
<a href="/comm-central/diff/b0232faeed8a3bc67763c31d2c7b3fcf31e2c162/mail/extensions/openpgp/content/BondOpenPGP.jsm">diff</a> |
<a href="/comm-central/comparison/b0232faeed8a3bc67763c31d2c7b3fcf31e2c162/mail/extensions/openpgp/content/BondOpenPGP.jsm">comparison</a> |
<a href="/comm-central/log/b0232faeed8a3bc67763c31d2c7b3fcf31e2c162/mail/extensions/openpgp/content/BondOpenPGP.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b0232faeed8a3bc67763c31d2c7b3fcf31e2c162/mail/extensions/openpgp/content/modules/core.jsm">mail/extensions/openpgp/content/modules/core.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b0232faeed8a3bc67763c31d2c7b3fcf31e2c162/mail/extensions/openpgp/content/modules/core.jsm">file</a> |
<a href="/comm-central/annotate/b0232faeed8a3bc67763c31d2c7b3fcf31e2c162/mail/extensions/openpgp/content/modules/core.jsm">annotate</a> |
<a href="/comm-central/diff/b0232faeed8a3bc67763c31d2c7b3fcf31e2c162/mail/extensions/openpgp/content/modules/core.jsm">diff</a> |
<a href="/comm-central/comparison/b0232faeed8a3bc67763c31d2c7b3fcf31e2c162/mail/extensions/openpgp/content/modules/core.jsm">comparison</a> |
<a href="/comm-central/log/b0232faeed8a3bc67763c31d2c7b3fcf31e2c162/mail/extensions/openpgp/content/modules/core.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b0232faeed8a3bc67763c31d2c7b3fcf31e2c162/mail/extensions/openpgp/content/modules/encryption.jsm">mail/extensions/openpgp/content/modules/encryption.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b0232faeed8a3bc67763c31d2c7b3fcf31e2c162/mail/extensions/openpgp/content/modules/encryption.jsm">file</a> |
<a href="/comm-central/annotate/b0232faeed8a3bc67763c31d2c7b3fcf31e2c162/mail/extensions/openpgp/content/modules/encryption.jsm">annotate</a> |
<a href="/comm-central/diff/b0232faeed8a3bc67763c31d2c7b3fcf31e2c162/mail/extensions/openpgp/content/modules/encryption.jsm">diff</a> |
<a href="/comm-central/comparison/b0232faeed8a3bc67763c31d2c7b3fcf31e2c162/mail/extensions/openpgp/content/modules/encryption.jsm">comparison</a> |
<a href="/comm-central/log/b0232faeed8a3bc67763c31d2c7b3fcf31e2c162/mail/extensions/openpgp/content/modules/encryption.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b0232faeed8a3bc67763c31d2c7b3fcf31e2c162/mail/extensions/openpgp/content/modules/hash.jsm">mail/extensions/openpgp/content/modules/hash.jsm</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/b0232faeed8a3bc67763c31d2c7b3fcf31e2c162/mail/extensions/openpgp/content/modules/hash.jsm">diff</a> |
<a href="/comm-central/comparison/b0232faeed8a3bc67763c31d2c7b3fcf31e2c162/mail/extensions/openpgp/content/modules/hash.jsm">comparison</a> |
<a href="/comm-central/log/b0232faeed8a3bc67763c31d2c7b3fcf31e2c162/mail/extensions/openpgp/content/modules/hash.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b0232faeed8a3bc67763c31d2c7b3fcf31e2c162/mail/extensions/openpgp/content/modules/keyRing.jsm">mail/extensions/openpgp/content/modules/keyRing.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b0232faeed8a3bc67763c31d2c7b3fcf31e2c162/mail/extensions/openpgp/content/modules/keyRing.jsm">file</a> |
<a href="/comm-central/annotate/b0232faeed8a3bc67763c31d2c7b3fcf31e2c162/mail/extensions/openpgp/content/modules/keyRing.jsm">annotate</a> |
<a href="/comm-central/diff/b0232faeed8a3bc67763c31d2c7b3fcf31e2c162/mail/extensions/openpgp/content/modules/keyRing.jsm">diff</a> |
<a href="/comm-central/comparison/b0232faeed8a3bc67763c31d2c7b3fcf31e2c162/mail/extensions/openpgp/content/modules/keyRing.jsm">comparison</a> |
<a href="/comm-central/log/b0232faeed8a3bc67763c31d2c7b3fcf31e2c162/mail/extensions/openpgp/content/modules/keyRing.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b0232faeed8a3bc67763c31d2c7b3fcf31e2c162/mail/extensions/openpgp/content/modules/mimeEncrypt.jsm">mail/extensions/openpgp/content/modules/mimeEncrypt.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b0232faeed8a3bc67763c31d2c7b3fcf31e2c162/mail/extensions/openpgp/content/modules/mimeEncrypt.jsm">file</a> |
<a href="/comm-central/annotate/b0232faeed8a3bc67763c31d2c7b3fcf31e2c162/mail/extensions/openpgp/content/modules/mimeEncrypt.jsm">annotate</a> |
<a href="/comm-central/diff/b0232faeed8a3bc67763c31d2c7b3fcf31e2c162/mail/extensions/openpgp/content/modules/mimeEncrypt.jsm">diff</a> |
<a href="/comm-central/comparison/b0232faeed8a3bc67763c31d2c7b3fcf31e2c162/mail/extensions/openpgp/content/modules/mimeEncrypt.jsm">comparison</a> |
<a href="/comm-central/log/b0232faeed8a3bc67763c31d2c7b3fcf31e2c162/mail/extensions/openpgp/content/modules/mimeEncrypt.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b0232faeed8a3bc67763c31d2c7b3fcf31e2c162/mail/extensions/openpgp/content/modules/rnp.jsm">mail/extensions/openpgp/content/modules/rnp.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b0232faeed8a3bc67763c31d2c7b3fcf31e2c162/mail/extensions/openpgp/content/modules/rnp.jsm">file</a> |
<a href="/comm-central/annotate/b0232faeed8a3bc67763c31d2c7b3fcf31e2c162/mail/extensions/openpgp/content/modules/rnp.jsm">annotate</a> |
<a href="/comm-central/diff/b0232faeed8a3bc67763c31d2c7b3fcf31e2c162/mail/extensions/openpgp/content/modules/rnp.jsm">diff</a> |
<a href="/comm-central/comparison/b0232faeed8a3bc67763c31d2c7b3fcf31e2c162/mail/extensions/openpgp/content/modules/rnp.jsm">comparison</a> |
<a href="/comm-central/log/b0232faeed8a3bc67763c31d2c7b3fcf31e2c162/mail/extensions/openpgp/content/modules/rnp.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b0232faeed8a3bc67763c31d2c7b3fcf31e2c162/mail/extensions/openpgp/content/modules/rnpLib.jsm">mail/extensions/openpgp/content/modules/rnpLib.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b0232faeed8a3bc67763c31d2c7b3fcf31e2c162/mail/extensions/openpgp/content/modules/rnpLib.jsm">file</a> |
<a href="/comm-central/annotate/b0232faeed8a3bc67763c31d2c7b3fcf31e2c162/mail/extensions/openpgp/content/modules/rnpLib.jsm">annotate</a> |
<a href="/comm-central/diff/b0232faeed8a3bc67763c31d2c7b3fcf31e2c162/mail/extensions/openpgp/content/modules/rnpLib.jsm">diff</a> |
<a href="/comm-central/comparison/b0232faeed8a3bc67763c31d2c7b3fcf31e2c162/mail/extensions/openpgp/content/modules/rnpLib.jsm">comparison</a> |
<a href="/comm-central/log/b0232faeed8a3bc67763c31d2c7b3fcf31e2c162/mail/extensions/openpgp/content/modules/rnpLib.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b0232faeed8a3bc67763c31d2c7b3fcf31e2c162/mail/extensions/openpgp/content/strings/enigmail.dtd">mail/extensions/openpgp/content/strings/enigmail.dtd</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b0232faeed8a3bc67763c31d2c7b3fcf31e2c162/mail/extensions/openpgp/content/strings/enigmail.dtd">file</a> |
<a href="/comm-central/annotate/b0232faeed8a3bc67763c31d2c7b3fcf31e2c162/mail/extensions/openpgp/content/strings/enigmail.dtd">annotate</a> |
<a href="/comm-central/diff/b0232faeed8a3bc67763c31d2c7b3fcf31e2c162/mail/extensions/openpgp/content/strings/enigmail.dtd">diff</a> |
<a href="/comm-central/comparison/b0232faeed8a3bc67763c31d2c7b3fcf31e2c162/mail/extensions/openpgp/content/strings/enigmail.dtd">comparison</a> |
<a href="/comm-central/log/b0232faeed8a3bc67763c31d2c7b3fcf31e2c162/mail/extensions/openpgp/content/strings/enigmail.dtd">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b0232faeed8a3bc67763c31d2c7b3fcf31e2c162/mail/extensions/openpgp/content/ui/enigmailEditIdentity.js">mail/extensions/openpgp/content/ui/enigmailEditIdentity.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/b0232faeed8a3bc67763c31d2c7b3fcf31e2c162/mail/extensions/openpgp/content/ui/enigmailEditIdentity.js">diff</a> |
<a href="/comm-central/comparison/b0232faeed8a3bc67763c31d2c7b3fcf31e2c162/mail/extensions/openpgp/content/ui/enigmailEditIdentity.js">comparison</a> |
<a href="/comm-central/log/b0232faeed8a3bc67763c31d2c7b3fcf31e2c162/mail/extensions/openpgp/content/ui/enigmailEditIdentity.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b0232faeed8a3bc67763c31d2c7b3fcf31e2c162/mail/extensions/openpgp/content/ui/enigmailKeygen.js">mail/extensions/openpgp/content/ui/enigmailKeygen.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b0232faeed8a3bc67763c31d2c7b3fcf31e2c162/mail/extensions/openpgp/content/ui/enigmailKeygen.js">file</a> |
<a href="/comm-central/annotate/b0232faeed8a3bc67763c31d2c7b3fcf31e2c162/mail/extensions/openpgp/content/ui/enigmailKeygen.js">annotate</a> |
<a href="/comm-central/diff/b0232faeed8a3bc67763c31d2c7b3fcf31e2c162/mail/extensions/openpgp/content/ui/enigmailKeygen.js">diff</a> |
<a href="/comm-central/comparison/b0232faeed8a3bc67763c31d2c7b3fcf31e2c162/mail/extensions/openpgp/content/ui/enigmailKeygen.js">comparison</a> |
<a href="/comm-central/log/b0232faeed8a3bc67763c31d2c7b3fcf31e2c162/mail/extensions/openpgp/content/ui/enigmailKeygen.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b0232faeed8a3bc67763c31d2c7b3fcf31e2c162/mail/extensions/openpgp/content/ui/enigmailKeygen.xhtml">mail/extensions/openpgp/content/ui/enigmailKeygen.xhtml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b0232faeed8a3bc67763c31d2c7b3fcf31e2c162/mail/extensions/openpgp/content/ui/enigmailKeygen.xhtml">file</a> |
<a href="/comm-central/annotate/b0232faeed8a3bc67763c31d2c7b3fcf31e2c162/mail/extensions/openpgp/content/ui/enigmailKeygen.xhtml">annotate</a> |
<a href="/comm-central/diff/b0232faeed8a3bc67763c31d2c7b3fcf31e2c162/mail/extensions/openpgp/content/ui/enigmailKeygen.xhtml">diff</a> |
<a href="/comm-central/comparison/b0232faeed8a3bc67763c31d2c7b3fcf31e2c162/mail/extensions/openpgp/content/ui/enigmailKeygen.xhtml">comparison</a> |
<a href="/comm-central/log/b0232faeed8a3bc67763c31d2c7b3fcf31e2c162/mail/extensions/openpgp/content/ui/enigmailKeygen.xhtml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b0232faeed8a3bc67763c31d2c7b3fcf31e2c162/mail/extensions/openpgp/content/ui/enigmailMessengerOverlay.js">mail/extensions/openpgp/content/ui/enigmailMessengerOverlay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b0232faeed8a3bc67763c31d2c7b3fcf31e2c162/mail/extensions/openpgp/content/ui/enigmailMessengerOverlay.js">file</a> |
<a href="/comm-central/annotate/b0232faeed8a3bc67763c31d2c7b3fcf31e2c162/mail/extensions/openpgp/content/ui/enigmailMessengerOverlay.js">annotate</a> |
<a href="/comm-central/diff/b0232faeed8a3bc67763c31d2c7b3fcf31e2c162/mail/extensions/openpgp/content/ui/enigmailMessengerOverlay.js">diff</a> |
<a href="/comm-central/comparison/b0232faeed8a3bc67763c31d2c7b3fcf31e2c162/mail/extensions/openpgp/content/ui/enigmailMessengerOverlay.js">comparison</a> |
<a href="/comm-central/log/b0232faeed8a3bc67763c31d2c7b3fcf31e2c162/mail/extensions/openpgp/content/ui/enigmailMessengerOverlay.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b0232faeed8a3bc67763c31d2c7b3fcf31e2c162/mail/extensions/openpgp/content/ui/enigmailMsgComposeOverlay.js">mail/extensions/openpgp/content/ui/enigmailMsgComposeOverlay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b0232faeed8a3bc67763c31d2c7b3fcf31e2c162/mail/extensions/openpgp/content/ui/enigmailMsgComposeOverlay.js">file</a> |
<a href="/comm-central/annotate/b0232faeed8a3bc67763c31d2c7b3fcf31e2c162/mail/extensions/openpgp/content/ui/enigmailMsgComposeOverlay.js">annotate</a> |
<a href="/comm-central/diff/b0232faeed8a3bc67763c31d2c7b3fcf31e2c162/mail/extensions/openpgp/content/ui/enigmailMsgComposeOverlay.js">diff</a> |
<a href="/comm-central/comparison/b0232faeed8a3bc67763c31d2c7b3fcf31e2c162/mail/extensions/openpgp/content/ui/enigmailMsgComposeOverlay.js">comparison</a> |
<a href="/comm-central/log/b0232faeed8a3bc67763c31d2c7b3fcf31e2c162/mail/extensions/openpgp/content/ui/enigmailMsgComposeOverlay.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/extensions/am-e2e/prefs/e2e-prefs.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/extensions/am-e2e/prefs/e2e-prefs.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -249,18 +249,16 @@ pref(&quot;temp.openpgp.keyRefreshOn&quot;, false)</span>
<a href="#l1.4"></a><span id="l1.4"> pref(&quot;temp.openpgp.enableExperiments&quot;, false);</span>
<a href="#l1.5"></a><span id="l1.5"> </span>
<a href="#l1.6"></a><span id="l1.6"> </span>
<a href="#l1.7"></a><span id="l1.7"> /*</span>
<a href="#l1.8"></a><span id="l1.8">    Default pref values for the enigmail per-identity</span>
<a href="#l1.9"></a><span id="l1.9">    settings</span>
<a href="#l1.10"></a><span id="l1.10"> */</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-pref(&quot;mail.identity.default.pgpkeyId&quot;, &quot;&quot;);</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-pref(&quot;mail.identity.default.pgpKeyMode&quot;, 0);</span>
<a href="#l1.14"></a><span id="l1.14"> pref(&quot;mail.identity.default.defaultSigningPolicy&quot;, 0);</span>
<a href="#l1.15"></a><span id="l1.15"> pref(&quot;mail.identity.default.defaultEncryptionPolicy&quot;, 0);</span>
<a href="#l1.16"></a><span id="l1.16"> pref(&quot;mail.identity.default.openPgpUrlName&quot;, &quot;&quot;);</span>
<a href="#l1.17"></a><span id="l1.17"> pref(&quot;mail.identity.default.pgpMimeMode&quot;, true);</span>
<a href="#l1.18"></a><span id="l1.18"> pref(&quot;mail.identity.default.attachPgpKey&quot;, false);</span>
<a href="#l1.19"></a><span id="l1.19"> pref(&quot;mail.identity.default.autoEncryptDrafts&quot;, true);</span>
<a href="#l1.20"></a><span id="l1.20"> pref(&quot;mail.identity.default.protectSubject&quot;, true);</span>
<a href="#l1.21"></a><span id="l1.21"> pref(&quot;mail.identity.default.warnWeakReply&quot;, false);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/extensions/openpgp/content/BondOpenPGP.jsm</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/BondOpenPGP.jsm</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -14,25 +14,20 @@ var { Services } = ChromeUtils.import(&quot;r</span>
<a href="#l2.4"></a><span id="l2.4"> var { MailConstants } = ChromeUtils.import(</span>
<a href="#l2.5"></a><span id="l2.5">   &quot;resource:///modules/MailConstants.jsm&quot;</span>
<a href="#l2.6"></a><span id="l2.6"> );</span>
<a href="#l2.7"></a><span id="l2.7"> </span>
<a href="#l2.8"></a><span id="l2.8"> const { EnigmailLazy } = ChromeUtils.import(</span>
<a href="#l2.9"></a><span id="l2.9">   &quot;chrome://openpgp/content/modules/lazy.jsm&quot;</span>
<a href="#l2.10"></a><span id="l2.10"> );</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-const getEnigmailApp = EnigmailLazy.loader(&quot;enigmail/app.jsm&quot;, &quot;EnigmailApp&quot;);</span>
<a href="#l2.13"></a><span id="l2.13"> const getEnigmailCore = EnigmailLazy.loader(</span>
<a href="#l2.14"></a><span id="l2.14">   &quot;enigmail/core.jsm&quot;,</span>
<a href="#l2.15"></a><span id="l2.15">   &quot;EnigmailCore&quot;</span>
<a href="#l2.16"></a><span id="l2.16"> );</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineminus">-const getEnigmailPgpmimeHander = EnigmailLazy.loader(</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineminus">-  &quot;enigmail/pgpmimeHandler.jsm&quot;,</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineminus">-  &quot;EnigmailPgpmimeHander&quot;</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineminus">-);</span>
<a href="#l2.21"></a><span id="l2.21"> const getRNP = EnigmailLazy.loader(&quot;enigmail/rnp.jsm&quot;, &quot;RNP&quot;);</span>
<a href="#l2.22"></a><span id="l2.22"> const getEnigmailWindows = EnigmailLazy.loader(</span>
<a href="#l2.23"></a><span id="l2.23">   &quot;enigmail/windows.jsm&quot;,</span>
<a href="#l2.24"></a><span id="l2.24">   &quot;EnigmailWindows&quot;</span>
<a href="#l2.25"></a><span id="l2.25"> );</span>
<a href="#l2.26"></a><span id="l2.26"> </span>
<a href="#l2.27"></a><span id="l2.27"> var BondOpenPGP = {</span>
<a href="#l2.28"></a><span id="l2.28">   logException(exc) {</span>
<a href="#l2.29"></a><span id="l2.29" class="difflineat">@@ -51,19 +46,18 @@ var BondOpenPGP = {</span>
<a href="#l2.30"></a><span id="l2.30">       return;</span>
<a href="#l2.31"></a><span id="l2.31">     }</span>
<a href="#l2.32"></a><span id="l2.32">     this.initDone = true;</span>
<a href="#l2.33"></a><span id="l2.33">     console.log(&quot;loading OpenPGP&quot;);</span>
<a href="#l2.34"></a><span id="l2.34">     try {</span>
<a href="#l2.35"></a><span id="l2.35">       getRNP().init({});</span>
<a href="#l2.36"></a><span id="l2.36">       //TODO: check RNP.libLoaded</span>
<a href="#l2.37"></a><span id="l2.37"> </span>
<a href="#l2.38"></a><span id="l2.38" class="difflineminus">-      getEnigmailApp().initAddon();</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineminus">-      getEnigmailCore().startup(0);</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineminus">-      getEnigmailPgpmimeHander().startup(0);</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineplus">+      // trigger service init</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineplus">+      getEnigmailCore().getService();</span>
<a href="#l2.43"></a><span id="l2.43"> </span>
<a href="#l2.44"></a><span id="l2.44">       Services.console.logStringMessage(&quot;OpenPGP bootstrap completed&quot;);</span>
<a href="#l2.45"></a><span id="l2.45">     } catch (ex) {</span>
<a href="#l2.46"></a><span id="l2.46">       this.logException(ex);</span>
<a href="#l2.47"></a><span id="l2.47">     }</span>
<a href="#l2.48"></a><span id="l2.48">   },</span>
<a href="#l2.49"></a><span id="l2.49"> </span>
<a href="#l2.50"></a><span id="l2.50">   openKeyManager(window) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/core.jsm</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/modules/core.jsm</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -59,16 +59,20 @@ const getEnigmailConfigure = EnigmailLaz</span>
<a href="#l3.4"></a><span id="l3.4">   &quot;enigmail/configure.jsm&quot;,</span>
<a href="#l3.5"></a><span id="l3.5">   &quot;EnigmailConfigure&quot;</span>
<a href="#l3.6"></a><span id="l3.6"> );</span>
<a href="#l3.7"></a><span id="l3.7"> const getEnigmailApp = EnigmailLazy.loader(&quot;enigmail/app.jsm&quot;, &quot;EnigmailApp&quot;);</span>
<a href="#l3.8"></a><span id="l3.8"> const getEnigmailWksMimeHandler = EnigmailLazy.loader(</span>
<a href="#l3.9"></a><span id="l3.9">   &quot;enigmail/wksMimeHandler.jsm&quot;,</span>
<a href="#l3.10"></a><span id="l3.10">   &quot;EnigmailWksMimeHandler&quot;</span>
<a href="#l3.11"></a><span id="l3.11"> );</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+const getEnigmailPgpmimeHander = EnigmailLazy.loader(</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+  &quot;enigmail/pgpmimeHandler.jsm&quot;,</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+  &quot;EnigmailPgpmimeHander&quot;</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+);</span>
<a href="#l3.16"></a><span id="l3.16"> //const getEnigmailOverlays = EnigmailLazy.loader(&quot;enigmail/enigmailOverlays.jsm&quot;, &quot;EnigmailOverlays&quot;);</span>
<a href="#l3.17"></a><span id="l3.17"> const getEnigmailSqlite = EnigmailLazy.loader(</span>
<a href="#l3.18"></a><span id="l3.18">   &quot;enigmail/sqliteDb.jsm&quot;,</span>
<a href="#l3.19"></a><span id="l3.19">   &quot;EnigmailSqliteDb&quot;</span>
<a href="#l3.20"></a><span id="l3.20"> );</span>
<a href="#l3.21"></a><span id="l3.21"> const getOpenPGPMasterpass = EnigmailLazy.loader(</span>
<a href="#l3.22"></a><span id="l3.22">   &quot;enigmail/masterpass.jsm&quot;,</span>
<a href="#l3.23"></a><span id="l3.23">   &quot;OpenPGPMasterpass&quot;</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineat">@@ -455,18 +459,20 @@ Enigmail.prototype = {</span>
<a href="#l3.25"></a><span id="l3.25"> </span>
<a href="#l3.26"></a><span id="l3.26">     getEnigmailLog().DEBUG(&quot;core.jsm: svc = &quot; + this + &quot;\n&quot;);</span>
<a href="#l3.27"></a><span id="l3.27"> </span>
<a href="#l3.28"></a><span id="l3.28">     if (!this.initialized) {</span>
<a href="#l3.29"></a><span id="l3.29">       const firstInitialization = !this.initializationAttempted;</span>
<a href="#l3.30"></a><span id="l3.30"> </span>
<a href="#l3.31"></a><span id="l3.31">       try {</span>
<a href="#l3.32"></a><span id="l3.32">         // Initialize enigmail</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineminus">-        EnigmailCore.init(getEnigmailApp().getVersion());</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineminus">-        this.initialize(win, getEnigmailApp().getVersion());</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineplus">+        let app = getEnigmailApp();</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineplus">+        app.initAddon();</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineplus">+        EnigmailCore.init(app.getVersion());</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineplus">+        this.initialize(win, app.getVersion());</span>
<a href="#l3.39"></a><span id="l3.39"> </span>
<a href="#l3.40"></a><span id="l3.40">         try {</span>
<a href="#l3.41"></a><span id="l3.41">           // Reset alert count to default value</span>
<a href="#l3.42"></a><span id="l3.42">           getEnigmailPrefs()</span>
<a href="#l3.43"></a><span id="l3.43">             .getPrefBranch()</span>
<a href="#l3.44"></a><span id="l3.44">             .clearUserPref(&quot;initAlert&quot;);</span>
<a href="#l3.45"></a><span id="l3.45">         } catch (ex) {}</span>
<a href="#l3.46"></a><span id="l3.46">       } catch (ex) {</span>
<a href="#l3.47"></a><span id="l3.47" class="difflineat">@@ -519,16 +525,18 @@ Enigmail.prototype = {</span>
<a href="#l3.48"></a><span id="l3.48">       if (</span>
<a href="#l3.49"></a><span id="l3.49">         this.initialized &amp;&amp;</span>
<a href="#l3.50"></a><span id="l3.50">         getEnigmailApp().getVersion() != configuredVersion</span>
<a href="#l3.51"></a><span id="l3.51">       ) {</span>
<a href="#l3.52"></a><span id="l3.52">         getEnigmailConfigure().configureEnigmail(win, startingPreferences);</span>
<a href="#l3.53"></a><span id="l3.53">       }</span>
<a href="#l3.54"></a><span id="l3.54">     }</span>
<a href="#l3.55"></a><span id="l3.55"> </span>
<a href="#l3.56"></a><span id="l3.56" class="difflineplus">+    EnigmailCore.startup(0);</span>
<a href="#l3.57"></a><span id="l3.57" class="difflineplus">+    getEnigmailPgpmimeHander().startup(0);</span>
<a href="#l3.58"></a><span id="l3.58">     return this.initialized ? this : null;</span>
<a href="#l3.59"></a><span id="l3.59">   },</span>
<a href="#l3.60"></a><span id="l3.60"> }; // Enigmail.prototype</span>
<a href="#l3.61"></a><span id="l3.61"> </span>
<a href="#l3.62"></a><span id="l3.62"> class Factory {</span>
<a href="#l3.63"></a><span id="l3.63">   constructor(component) {</span>
<a href="#l3.64"></a><span id="l3.64">     this.component = component;</span>
<a href="#l3.65"></a><span id="l3.65">     this.register();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/encryption.jsm</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/modules/encryption.jsm</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -600,16 +600,17 @@ var EnigmailEncryption = {</span>
<a href="#l4.4"></a><span id="l4.4">     }</span>
<a href="#l4.5"></a><span id="l4.5"> </span>
<a href="#l4.6"></a><span id="l4.6">     EnigmailLog.DEBUG(</span>
<a href="#l4.7"></a><span id="l4.7">       &quot;encryption.jsm: encryptMessageEnd: command execution exit code: &quot; +</span>
<a href="#l4.8"></a><span id="l4.8">         exitCode +</span>
<a href="#l4.9"></a><span id="l4.9">         &quot;\n&quot;</span>
<a href="#l4.10"></a><span id="l4.10">     );</span>
<a href="#l4.11"></a><span id="l4.11"> </span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+    /*</span>
<a href="#l4.13"></a><span id="l4.13">     if (retStatusObj.statusFlags &amp; EnigmailConstants.DISPLAY_MESSAGE) {</span>
<a href="#l4.14"></a><span id="l4.14">       if (retStatusObj.extendedStatus.search(/\bdisp:/) &gt;= 0) {</span>
<a href="#l4.15"></a><span id="l4.15">         retStatusObj.errorMsg = retStatusObj.statusMsg;</span>
<a href="#l4.16"></a><span id="l4.16">       } else {</span>
<a href="#l4.17"></a><span id="l4.17">         if (fromMailAddr.search(/^0x/) === 0) {</span>
<a href="#l4.18"></a><span id="l4.18">           fromMailAddr = fromMailAddr.substr(2);</span>
<a href="#l4.19"></a><span id="l4.19">         }</span>
<a href="#l4.20"></a><span id="l4.20">         if (fromMailAddr.search(/^[A-F0-9]{8,40}$/i) === 0) {</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineat">@@ -629,16 +630,17 @@ var EnigmailEncryption = {</span>
<a href="#l4.22"></a><span id="l4.22">           retStatusObj.errorMsg = retStatusObj.statusMsg;</span>
<a href="#l4.23"></a><span id="l4.23">         }</span>
<a href="#l4.24"></a><span id="l4.24">       }</span>
<a href="#l4.25"></a><span id="l4.25">     } else if (retStatusObj.statusFlags &amp; EnigmailConstants.INVALID_RECIPIENT) {</span>
<a href="#l4.26"></a><span id="l4.26">       retStatusObj.errorMsg = retStatusObj.statusMsg;</span>
<a href="#l4.27"></a><span id="l4.27">     } else if (exitCode !== 0) {</span>
<a href="#l4.28"></a><span id="l4.28">       retStatusObj.errorMsg = EnigmailLocale.getString(&quot;badCommand&quot;);</span>
<a href="#l4.29"></a><span id="l4.29">     }</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineplus">+    */</span>
<a href="#l4.31"></a><span id="l4.31"> </span>
<a href="#l4.32"></a><span id="l4.32">     return exitCode;</span>
<a href="#l4.33"></a><span id="l4.33">   },</span>
<a href="#l4.34"></a><span id="l4.34"> </span>
<a href="#l4.35"></a><span id="l4.35">   encryptMessage(</span>
<a href="#l4.36"></a><span id="l4.36">     parent,</span>
<a href="#l4.37"></a><span id="l4.37">     uiFlags,</span>
<a href="#l4.38"></a><span id="l4.38">     plainText,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1">deleted file mode 100644</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/hash.jsm</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineplus">+++ /dev/null</span>
<a href="#l5.4"></a><span id="l5.4" class="difflineat">@@ -1,172 +0,0 @@</span>
<a href="#l5.5"></a><span id="l5.5" class="difflineminus">-/*</span>
<a href="#l5.6"></a><span id="l5.6" class="difflineminus">- * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l5.7"></a><span id="l5.7" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l5.8"></a><span id="l5.8" class="difflineminus">- * file, You can obtain one at https://mozilla.org/MPL/2.0/.</span>
<a href="#l5.9"></a><span id="l5.9" class="difflineminus">- */</span>
<a href="#l5.10"></a><span id="l5.10" class="difflineminus">-</span>
<a href="#l5.11"></a><span id="l5.11" class="difflineminus">-&quot;use strict&quot;;</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineminus">-var EXPORTED_SYMBOLS = [&quot;EnigmailHash&quot;];</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineminus">-</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineminus">-const { EnigmailLog } = ChromeUtils.import(</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineminus">-  &quot;chrome://openpgp/content/modules/log.jsm&quot;</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineminus">-);</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineminus">-const { EnigmailWindows } = ChromeUtils.import(</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineminus">-  &quot;chrome://openpgp/content/modules/windows.jsm&quot;</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineminus">-);</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineminus">-const { EnigmailLocale } = ChromeUtils.import(</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineminus">-  &quot;chrome://openpgp/content/modules/locale.jsm&quot;</span>
<a href="#l5.23"></a><span id="l5.23" class="difflineminus">-);</span>
<a href="#l5.24"></a><span id="l5.24" class="difflineminus">-const { EnigmailPrefs } = ChromeUtils.import(</span>
<a href="#l5.25"></a><span id="l5.25" class="difflineminus">-  &quot;chrome://openpgp/content/modules/prefs.jsm&quot;</span>
<a href="#l5.26"></a><span id="l5.26" class="difflineminus">-);</span>
<a href="#l5.27"></a><span id="l5.27" class="difflineminus">-const { EnigmailEncryption } = ChromeUtils.import(</span>
<a href="#l5.28"></a><span id="l5.28" class="difflineminus">-  &quot;chrome://openpgp/content/modules/encryption.jsm&quot;</span>
<a href="#l5.29"></a><span id="l5.29" class="difflineminus">-);</span>
<a href="#l5.30"></a><span id="l5.30" class="difflineminus">-const { EnigmailDialog } = ChromeUtils.import(</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineminus">-  &quot;chrome://openpgp/content/modules/dialog.jsm&quot;</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineminus">-);</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineminus">-const { EnigmailConstants } = ChromeUtils.import(</span>
<a href="#l5.34"></a><span id="l5.34" class="difflineminus">-  &quot;chrome://openpgp/content/modules/constants.jsm&quot;</span>
<a href="#l5.35"></a><span id="l5.35" class="difflineminus">-);</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineminus">-</span>
<a href="#l5.37"></a><span id="l5.37" class="difflineminus">-const keyAlgorithms = [];</span>
<a href="#l5.38"></a><span id="l5.38" class="difflineminus">-const mimeHashAlgorithms = [</span>
<a href="#l5.39"></a><span id="l5.39" class="difflineminus">-  null,</span>
<a href="#l5.40"></a><span id="l5.40" class="difflineminus">-  &quot;sha1&quot;,</span>
<a href="#l5.41"></a><span id="l5.41" class="difflineminus">-  &quot;ripemd160&quot;,</span>
<a href="#l5.42"></a><span id="l5.42" class="difflineminus">-  &quot;sha256&quot;,</span>
<a href="#l5.43"></a><span id="l5.43" class="difflineminus">-  &quot;sha384&quot;,</span>
<a href="#l5.44"></a><span id="l5.44" class="difflineminus">-  &quot;sha512&quot;,</span>
<a href="#l5.45"></a><span id="l5.45" class="difflineminus">-  &quot;sha224&quot;,</span>
<a href="#l5.46"></a><span id="l5.46" class="difflineminus">-  &quot;md5&quot;,</span>
<a href="#l5.47"></a><span id="l5.47" class="difflineminus">-];</span>
<a href="#l5.48"></a><span id="l5.48" class="difflineminus">-</span>
<a href="#l5.49"></a><span id="l5.49" class="difflineminus">-var EnigmailHash = {</span>
<a href="#l5.50"></a><span id="l5.50" class="difflineminus">-  determineAlgorithm(win, uiFlags, fromMailAddr, hashAlgoObj) {</span>
<a href="#l5.51"></a><span id="l5.51" class="difflineminus">-    EnigmailLog.DEBUG(&quot;hash.jsm: determineAlgorithm\n&quot;);</span>
<a href="#l5.52"></a><span id="l5.52" class="difflineminus">-</span>
<a href="#l5.53"></a><span id="l5.53" class="difflineminus">-    if (!win) {</span>
<a href="#l5.54"></a><span id="l5.54" class="difflineminus">-      win = EnigmailWindows.getMostRecentWindow();</span>
<a href="#l5.55"></a><span id="l5.55" class="difflineminus">-    }</span>
<a href="#l5.56"></a><span id="l5.56" class="difflineminus">-</span>
<a href="#l5.57"></a><span id="l5.57" class="difflineminus">-    const sendFlags =</span>
<a href="#l5.58"></a><span id="l5.58" class="difflineminus">-      EnigmailConstants.SEND_TEST | EnigmailConstants.SEND_SIGNED;</span>
<a href="#l5.59"></a><span id="l5.59" class="difflineminus">-    const hashAlgo =</span>
<a href="#l5.60"></a><span id="l5.60" class="difflineminus">-      mimeHashAlgorithms[EnigmailPrefs.getPref(&quot;mimeHashAlgorithm&quot;)];</span>
<a href="#l5.61"></a><span id="l5.61" class="difflineminus">-</span>
<a href="#l5.62"></a><span id="l5.62" class="difflineminus">-    if (typeof keyAlgorithms[fromMailAddr] != &quot;string&quot;) {</span>
<a href="#l5.63"></a><span id="l5.63" class="difflineminus">-      // hash algorithm not yet known</span>
<a href="#l5.64"></a><span id="l5.64" class="difflineminus">-</span>
<a href="#l5.65"></a><span id="l5.65" class="difflineminus">-      const testUiFlags = EnigmailConstants.UI_TEST;</span>
<a href="#l5.66"></a><span id="l5.66" class="difflineminus">-      const listener = {</span>
<a href="#l5.67"></a><span id="l5.67" class="difflineminus">-        stdoutData: &quot;&quot;,</span>
<a href="#l5.68"></a><span id="l5.68" class="difflineminus">-        stderrData: &quot;&quot;,</span>
<a href="#l5.69"></a><span id="l5.69" class="difflineminus">-        exitCode: -1,</span>
<a href="#l5.70"></a><span id="l5.70" class="difflineminus">-        stdin(pipe) {</span>
<a href="#l5.71"></a><span id="l5.71" class="difflineminus">-          pipe.write(&quot;Dummy Test&quot;);</span>
<a href="#l5.72"></a><span id="l5.72" class="difflineminus">-          pipe.close();</span>
<a href="#l5.73"></a><span id="l5.73" class="difflineminus">-        },</span>
<a href="#l5.74"></a><span id="l5.74" class="difflineminus">-        stdout(data) {</span>
<a href="#l5.75"></a><span id="l5.75" class="difflineminus">-          this.stdoutData += data;</span>
<a href="#l5.76"></a><span id="l5.76" class="difflineminus">-        },</span>
<a href="#l5.77"></a><span id="l5.77" class="difflineminus">-        stderr(data) {</span>
<a href="#l5.78"></a><span id="l5.78" class="difflineminus">-          this.stderrData += data;</span>
<a href="#l5.79"></a><span id="l5.79" class="difflineminus">-        },</span>
<a href="#l5.80"></a><span id="l5.80" class="difflineminus">-        done(exitCode) {</span>
<a href="#l5.81"></a><span id="l5.81" class="difflineminus">-          this.exitCode = exitCode;</span>
<a href="#l5.82"></a><span id="l5.82" class="difflineminus">-        },</span>
<a href="#l5.83"></a><span id="l5.83" class="difflineminus">-      };</span>
<a href="#l5.84"></a><span id="l5.84" class="difflineminus">-</span>
<a href="#l5.85"></a><span id="l5.85" class="difflineminus">-      let errorMsgObj = {};</span>
<a href="#l5.86"></a><span id="l5.86" class="difflineminus">-      let statusFlagsObj = {};</span>
<a href="#l5.87"></a><span id="l5.87" class="difflineminus">-      const proc = EnigmailEncryption.encryptMessageStart(</span>
<a href="#l5.88"></a><span id="l5.88" class="difflineminus">-        win,</span>
<a href="#l5.89"></a><span id="l5.89" class="difflineminus">-        testUiFlags,</span>
<a href="#l5.90"></a><span id="l5.90" class="difflineminus">-        fromMailAddr,</span>
<a href="#l5.91"></a><span id="l5.91" class="difflineminus">-        &quot;&quot;,</span>
<a href="#l5.92"></a><span id="l5.92" class="difflineminus">-        &quot;&quot;,</span>
<a href="#l5.93"></a><span id="l5.93" class="difflineminus">-        hashAlgo,</span>
<a href="#l5.94"></a><span id="l5.94" class="difflineminus">-        sendFlags,</span>
<a href="#l5.95"></a><span id="l5.95" class="difflineminus">-        listener,</span>
<a href="#l5.96"></a><span id="l5.96" class="difflineminus">-        statusFlagsObj,</span>
<a href="#l5.97"></a><span id="l5.97" class="difflineminus">-        errorMsgObj</span>
<a href="#l5.98"></a><span id="l5.98" class="difflineminus">-      );</span>
<a href="#l5.99"></a><span id="l5.99" class="difflineminus">-</span>
<a href="#l5.100"></a><span id="l5.100" class="difflineminus">-      if (!proc) {</span>
<a href="#l5.101"></a><span id="l5.101" class="difflineminus">-        hashAlgoObj.errorMsg = errorMsgObj.value;</span>
<a href="#l5.102"></a><span id="l5.102" class="difflineminus">-        hashAlgoObj.statusFlags = statusFlagsObj.value;</span>
<a href="#l5.103"></a><span id="l5.103" class="difflineminus">-        return 1;</span>
<a href="#l5.104"></a><span id="l5.104" class="difflineminus">-      }</span>
<a href="#l5.105"></a><span id="l5.105" class="difflineminus">-</span>
<a href="#l5.106"></a><span id="l5.106" class="difflineminus">-      proc.wait();</span>
<a href="#l5.107"></a><span id="l5.107" class="difflineminus">-</span>
<a href="#l5.108"></a><span id="l5.108" class="difflineminus">-      const msgText = listener.stdoutData;</span>
<a href="#l5.109"></a><span id="l5.109" class="difflineminus">-      const exitCode = listener.exitCode;</span>
<a href="#l5.110"></a><span id="l5.110" class="difflineminus">-</span>
<a href="#l5.111"></a><span id="l5.111" class="difflineminus">-      const retStatusObj = {};</span>
<a href="#l5.112"></a><span id="l5.112" class="difflineminus">-      let exitCode2 = EnigmailEncryption.encryptMessageEnd(</span>
<a href="#l5.113"></a><span id="l5.113" class="difflineminus">-        fromMailAddr,</span>
<a href="#l5.114"></a><span id="l5.114" class="difflineminus">-        listener.stderrData,</span>
<a href="#l5.115"></a><span id="l5.115" class="difflineminus">-        exitCode,</span>
<a href="#l5.116"></a><span id="l5.116" class="difflineminus">-        testUiFlags,</span>
<a href="#l5.117"></a><span id="l5.117" class="difflineminus">-        sendFlags,</span>
<a href="#l5.118"></a><span id="l5.118" class="difflineminus">-        10,</span>
<a href="#l5.119"></a><span id="l5.119" class="difflineminus">-        retStatusObj</span>
<a href="#l5.120"></a><span id="l5.120" class="difflineminus">-      );</span>
<a href="#l5.121"></a><span id="l5.121" class="difflineminus">-</span>
<a href="#l5.122"></a><span id="l5.122" class="difflineminus">-      if (exitCode2 === 0 &amp;&amp; !msgText) {</span>
<a href="#l5.123"></a><span id="l5.123" class="difflineminus">-        exitCode2 = 1;</span>
<a href="#l5.124"></a><span id="l5.124" class="difflineminus">-      }</span>
<a href="#l5.125"></a><span id="l5.125" class="difflineminus">-      // if (exitCode2 &gt; 0) exitCode2 = -exitCode2;</span>
<a href="#l5.126"></a><span id="l5.126" class="difflineminus">-</span>
<a href="#l5.127"></a><span id="l5.127" class="difflineminus">-      if (exitCode2 !== 0) {</span>
<a href="#l5.128"></a><span id="l5.128" class="difflineminus">-        // Abormal return</span>
<a href="#l5.129"></a><span id="l5.129" class="difflineminus">-        if (retStatusObj.statusFlags &amp; EnigmailConstants.BAD_PASSPHRASE) {</span>
<a href="#l5.130"></a><span id="l5.130" class="difflineminus">-          // &quot;Unremember&quot; passphrase on error return</span>
<a href="#l5.131"></a><span id="l5.131" class="difflineminus">-          retStatusObj.errorMsg = EnigmailLocale.getString(&quot;badPhrase&quot;);</span>
<a href="#l5.132"></a><span id="l5.132" class="difflineminus">-        }</span>
<a href="#l5.133"></a><span id="l5.133" class="difflineminus">-        EnigmailDialog.alert(win, retStatusObj.errorMsg);</span>
<a href="#l5.134"></a><span id="l5.134" class="difflineminus">-        return exitCode2;</span>
<a href="#l5.135"></a><span id="l5.135" class="difflineminus">-      }</span>
<a href="#l5.136"></a><span id="l5.136" class="difflineminus">-</span>
<a href="#l5.137"></a><span id="l5.137" class="difflineminus">-      let hashAlgorithm = &quot;sha1&quot;; // default as defined in RFC 4880, section 7 is MD5 -- but that's outdated</span>
<a href="#l5.138"></a><span id="l5.138" class="difflineminus">-</span>
<a href="#l5.139"></a><span id="l5.139" class="difflineminus">-      const m = msgText.match(/^(Hash: )(.*)$/m);</span>
<a href="#l5.140"></a><span id="l5.140" class="difflineminus">-      if (m &amp;&amp; m.length &gt; 2 &amp;&amp; m[1] == &quot;Hash: &quot;) {</span>
<a href="#l5.141"></a><span id="l5.141" class="difflineminus">-        hashAlgorithm = m[2].toLowerCase();</span>
<a href="#l5.142"></a><span id="l5.142" class="difflineminus">-      } else {</span>
<a href="#l5.143"></a><span id="l5.143" class="difflineminus">-        EnigmailLog.DEBUG(</span>
<a href="#l5.144"></a><span id="l5.144" class="difflineminus">-          &quot;hash.jsm: determineAlgorithm: no hashAlgorithm specified - using MD5\n&quot;</span>
<a href="#l5.145"></a><span id="l5.145" class="difflineminus">-        );</span>
<a href="#l5.146"></a><span id="l5.146" class="difflineminus">-      }</span>
<a href="#l5.147"></a><span id="l5.147" class="difflineminus">-</span>
<a href="#l5.148"></a><span id="l5.148" class="difflineminus">-      for (let i = 1; i &lt; mimeHashAlgorithms.length; i++) {</span>
<a href="#l5.149"></a><span id="l5.149" class="difflineminus">-        if (mimeHashAlgorithms[i] === hashAlgorithm) {</span>
<a href="#l5.150"></a><span id="l5.150" class="difflineminus">-          EnigmailLog.DEBUG(</span>
<a href="#l5.151"></a><span id="l5.151" class="difflineminus">-            &quot;hash.jsm: determineAlgorithm: found hashAlgorithm &quot; +</span>
<a href="#l5.152"></a><span id="l5.152" class="difflineminus">-              hashAlgorithm +</span>
<a href="#l5.153"></a><span id="l5.153" class="difflineminus">-              &quot;\n&quot;</span>
<a href="#l5.154"></a><span id="l5.154" class="difflineminus">-          );</span>
<a href="#l5.155"></a><span id="l5.155" class="difflineminus">-          keyAlgorithms[fromMailAddr] = hashAlgorithm;</span>
<a href="#l5.156"></a><span id="l5.156" class="difflineminus">-          hashAlgoObj.value = hashAlgorithm;</span>
<a href="#l5.157"></a><span id="l5.157" class="difflineminus">-          return 0;</span>
<a href="#l5.158"></a><span id="l5.158" class="difflineminus">-        }</span>
<a href="#l5.159"></a><span id="l5.159" class="difflineminus">-      }</span>
<a href="#l5.160"></a><span id="l5.160" class="difflineminus">-</span>
<a href="#l5.161"></a><span id="l5.161" class="difflineminus">-      EnigmailLog.ERROR(</span>
<a href="#l5.162"></a><span id="l5.162" class="difflineminus">-        &quot;hash.jsm: determineAlgorithm: no hashAlgorithm found\n&quot;</span>
<a href="#l5.163"></a><span id="l5.163" class="difflineminus">-      );</span>
<a href="#l5.164"></a><span id="l5.164" class="difflineminus">-      return 2;</span>
<a href="#l5.165"></a><span id="l5.165" class="difflineminus">-    }</span>
<a href="#l5.166"></a><span id="l5.166" class="difflineminus">-</span>
<a href="#l5.167"></a><span id="l5.167" class="difflineminus">-    EnigmailLog.DEBUG(</span>
<a href="#l5.168"></a><span id="l5.168" class="difflineminus">-      &quot;hash.jsm: determineAlgorithm: hashAlgorithm &quot; +</span>
<a href="#l5.169"></a><span id="l5.169" class="difflineminus">-        keyAlgorithms[fromMailAddr] +</span>
<a href="#l5.170"></a><span id="l5.170" class="difflineminus">-        &quot; is cached\n&quot;</span>
<a href="#l5.171"></a><span id="l5.171" class="difflineminus">-    );</span>
<a href="#l5.172"></a><span id="l5.172" class="difflineminus">-    hashAlgoObj.value = keyAlgorithms[fromMailAddr];</span>
<a href="#l5.173"></a><span id="l5.173" class="difflineminus">-</span>
<a href="#l5.174"></a><span id="l5.174" class="difflineminus">-    return 0;</span>
<a href="#l5.175"></a><span id="l5.175" class="difflineminus">-  },</span>
<a href="#l5.176"></a><span id="l5.176" class="difflineminus">-};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/keyRing.jsm</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/modules/keyRing.jsm</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -259,22 +259,28 @@ var EnigmailKeyRing = {</span>
<a href="#l6.4"></a><span id="l6.4">     EnigmailLog.DEBUG(</span>
<a href="#l6.5"></a><span id="l6.5">       &quot;keyRing.jsm: getSecretKeyByUserId: '&quot; + searchTerm + &quot;'\n&quot;</span>
<a href="#l6.6"></a><span id="l6.6">     );</span>
<a href="#l6.7"></a><span id="l6.7">     let keyList = this.getKeysByUserId(searchTerm, true);</span>
<a href="#l6.8"></a><span id="l6.8"> </span>
<a href="#l6.9"></a><span id="l6.9">     result.all = [];</span>
<a href="#l6.10"></a><span id="l6.10">     result.best = null;</span>
<a href="#l6.11"></a><span id="l6.11"> </span>
<a href="#l6.12"></a><span id="l6.12" class="difflineplus">+    var nowDate = new Date();</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+    var nowSecondsSinceEpoch = nowDate.valueOf() / 1000;</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+</span>
<a href="#l6.15"></a><span id="l6.15">     for (let key of keyList) {</span>
<a href="#l6.16"></a><span id="l6.16">       if (</span>
<a href="#l6.17"></a><span id="l6.17">         key.secretAvailable &amp;&amp;</span>
<a href="#l6.18"></a><span id="l6.18">         key.getEncryptionValidity().keyValid &amp;&amp;</span>
<a href="#l6.19"></a><span id="l6.19">         key.getSigningValidity().keyValid</span>
<a href="#l6.20"></a><span id="l6.20">       ) {</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineplus">+        if (key.expiryTime &lt; nowSecondsSinceEpoch) {</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineplus">+          continue;</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineplus">+        }</span>
<a href="#l6.24"></a><span id="l6.24">         result.all.push(key);</span>
<a href="#l6.25"></a><span id="l6.25">         if (!result.best) {</span>
<a href="#l6.26"></a><span id="l6.26">           result.best = key;</span>
<a href="#l6.27"></a><span id="l6.27">         } else if (</span>
<a href="#l6.28"></a><span id="l6.28">           result.best.algoSym === key.algoSym &amp;&amp;</span>
<a href="#l6.29"></a><span id="l6.29">           result.best.keySize === key.keySize</span>
<a href="#l6.30"></a><span id="l6.30">         ) {</span>
<a href="#l6.31"></a><span id="l6.31">           if (key.expiryTime &gt; result.best.expiryTime) {</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineat">@@ -440,36 +446,38 @@ var EnigmailKeyRing = {</span>
<a href="#l6.33"></a><span id="l6.33">    * @param userId            String   - space or comma separated list of keys to export. Specification by</span>
<a href="#l6.34"></a><span id="l6.34">    *                                     key ID, fingerprint, or userId</span>
<a href="#l6.35"></a><span id="l6.35">    * @param outputFile        String or nsIFile - output file name or Object - or NULL</span>
<a href="#l6.36"></a><span id="l6.36">    * @param exitCodeObj       Object   - o.value will contain exit code</span>
<a href="#l6.37"></a><span id="l6.37">    * @param errorMsgObj       Object   - o.value will contain error message from GnuPG</span>
<a href="#l6.38"></a><span id="l6.38">    *</span>
<a href="#l6.39"></a><span id="l6.39">    * @return String - if outputFile is NULL, the key block data; &quot;&quot; if a file is written</span>
<a href="#l6.40"></a><span id="l6.40">    */</span>
<a href="#l6.41"></a><span id="l6.41" class="difflineminus">-  extractKey(includeSecretKey, id, outputFile, exitCodeObj, errorMsgObj) {</span>
<a href="#l6.42"></a><span id="l6.42" class="difflineminus">-    EnigmailLog.DEBUG(&quot;keyRing.jsm: EnigmailKeyRing.extractKey: &quot; + id + &quot;\n&quot;);</span>
<a href="#l6.43"></a><span id="l6.43" class="difflineplus">+  extractKey(includeSecretKey, idArray, outputFile, exitCodeObj, errorMsgObj) {</span>
<a href="#l6.44"></a><span id="l6.44" class="difflineplus">+    EnigmailLog.DEBUG(</span>
<a href="#l6.45"></a><span id="l6.45" class="difflineplus">+      &quot;keyRing.jsm: EnigmailKeyRing.extractKey: &quot; + idArray + &quot;\n&quot;</span>
<a href="#l6.46"></a><span id="l6.46" class="difflineplus">+    );</span>
<a href="#l6.47"></a><span id="l6.47">     exitCodeObj.value = -1;</span>
<a href="#l6.48"></a><span id="l6.48"> </span>
<a href="#l6.49"></a><span id="l6.49">     if (includeSecretKey) {</span>
<a href="#l6.50"></a><span id="l6.50">       throw new Error(&quot;extractKey with secret key not implemented&quot;);</span>
<a href="#l6.51"></a><span id="l6.51">     }</span>
<a href="#l6.52"></a><span id="l6.52"> </span>
<a href="#l6.53"></a><span id="l6.53" class="difflineminus">-    if (!id.length) {</span>
<a href="#l6.54"></a><span id="l6.54" class="difflineplus">+    if (!idArray.length) {</span>
<a href="#l6.55"></a><span id="l6.55">       return &quot;&quot;;</span>
<a href="#l6.56"></a><span id="l6.56">     }</span>
<a href="#l6.57"></a><span id="l6.57"> </span>
<a href="#l6.58"></a><span id="l6.58" class="difflineminus">-    if (id.includes(&quot; &quot;)) {</span>
<a href="#l6.59"></a><span id="l6.59" class="difflineplus">+    if (idArray.length &gt; 1) {</span>
<a href="#l6.60"></a><span id="l6.60">       throw new Error(</span>
<a href="#l6.61"></a><span id="l6.61">         &quot;keyRing.jsm: EnigmailKeyRing.extractKey: multiple IDs not yet implemented&quot;</span>
<a href="#l6.62"></a><span id="l6.62">       );</span>
<a href="#l6.63"></a><span id="l6.63">     }</span>
<a href="#l6.64"></a><span id="l6.64"> </span>
<a href="#l6.65"></a><span id="l6.65">     const cApi = EnigmailCryptoAPI();</span>
<a href="#l6.66"></a><span id="l6.66" class="difflineminus">-    let keyBlock = cApi.sync(cApi.getPublicKey(id));</span>
<a href="#l6.67"></a><span id="l6.67" class="difflineplus">+    let keyBlock = cApi.sync(cApi.getPublicKey(idArray[0]));</span>
<a href="#l6.68"></a><span id="l6.68">     if (!keyBlock) {</span>
<a href="#l6.69"></a><span id="l6.69">       errorMsgObj.value = EnigmailLocale.getString(&quot;failKeyExtract&quot;);</span>
<a href="#l6.70"></a><span id="l6.70">       return &quot;&quot;;</span>
<a href="#l6.71"></a><span id="l6.71">     }</span>
<a href="#l6.72"></a><span id="l6.72"> </span>
<a href="#l6.73"></a><span id="l6.73">     exitCodeObj.value = 0;</span>
<a href="#l6.74"></a><span id="l6.74">     if (outputFile) {</span>
<a href="#l6.75"></a><span id="l6.75">       if (</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/mimeEncrypt.jsm</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/modules/mimeEncrypt.jsm</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -230,40 +230,16 @@ PgpMimeEncrypt.prototype = {</span>
<a href="#l7.4"></a><span id="l7.4"> </span>
<a href="#l7.5"></a><span id="l7.5">       if (this.sendFlags &amp; EnigmailConstants.SEND_PGP_MIME) {</span>
<a href="#l7.6"></a><span id="l7.6">         if (this.sendFlags &amp; EnigmailConstants.SEND_ENCRYPTED) {</span>
<a href="#l7.7"></a><span id="l7.7">           // applies to encrypted and signed &amp; encrypted</span>
<a href="#l7.8"></a><span id="l7.8">           this.cryptoMode = MIME_ENCRYPTED;</span>
<a href="#l7.9"></a><span id="l7.9">         } else if (this.sendFlags &amp; EnigmailConstants.SEND_SIGNED) {</span>
<a href="#l7.10"></a><span id="l7.10">           this.cryptoMode = MIME_SIGNED;</span>
<a href="#l7.11"></a><span id="l7.11">           this.hashAlgorithm = &quot;SHA256&quot;; // TODO: coordinate with RNP.jsm</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineminus">-          /*</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineminus">-          let hashAlgoObj = {};</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineminus">-          if (</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineminus">-            EnigmailHash.determineAlgorithm(</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineminus">-              this.win,</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineminus">-              this.UIFlags,</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineminus">-              this.senderEmailAddr,</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineminus">-              hashAlgoObj</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineminus">-            ) === 0</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineminus">-          ) {</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineminus">-            this.hashAlgorithm = hashAlgoObj.value;</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineminus">-          } else {</span>
<a href="#l7.25"></a><span id="l7.25" class="difflineminus">-            if (</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineminus">-              &quot;statusFlags&quot; in hashAlgoObj &amp;&amp;</span>
<a href="#l7.27"></a><span id="l7.27" class="difflineminus">-              hashAlgoObj.statusFlags !== 0 &amp;&amp;</span>
<a href="#l7.28"></a><span id="l7.28" class="difflineminus">-              hashAlgoObj.errorMsg</span>
<a href="#l7.29"></a><span id="l7.29" class="difflineminus">-            ) {</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineminus">-              EnigmailDialog.alert(this.win, hashAlgoObj.errorMsg);</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineminus">-            }</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineminus">-</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineminus">-            throw Cr.NS_ERROR_FAILURE;</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineminus">-          }</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineminus">-          */</span>
<a href="#l7.36"></a><span id="l7.36">         }</span>
<a href="#l7.37"></a><span id="l7.37">       } else {</span>
<a href="#l7.38"></a><span id="l7.38">         throw Cr.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l7.39"></a><span id="l7.39">       }</span>
<a href="#l7.40"></a><span id="l7.40"> </span>
<a href="#l7.41"></a><span id="l7.41">       this.cryptoBoundary = EnigmailMime.createBoundary();</span>
<a href="#l7.42"></a><span id="l7.42">       this.startCryptoHeaders();</span>
<a href="#l7.43"></a><span id="l7.43">     } catch (ex) {</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineat">@@ -525,17 +501,16 @@ PgpMimeEncrypt.prototype = {</span>
<a href="#l7.45"></a><span id="l7.45">       this.writeToPipe(&quot;\r\n--&quot; + this.encHeader + &quot;--\r\n&quot;);</span>
<a href="#l7.46"></a><span id="l7.46">       if (this.cryptoMode == MIME_SIGNED) {</span>
<a href="#l7.47"></a><span id="l7.47">         this.writeOut(&quot;\r\n--&quot; + this.encHeader + &quot;--\r\n&quot;);</span>
<a href="#l7.48"></a><span id="l7.48">       }</span>
<a href="#l7.49"></a><span id="l7.49">     }</span>
<a href="#l7.50"></a><span id="l7.50"> </span>
<a href="#l7.51"></a><span id="l7.51">     let statusFlagsObj = {};</span>
<a href="#l7.52"></a><span id="l7.52">     let errorMsgObj = {};</span>
<a href="#l7.53"></a><span id="l7.53" class="difflineminus">-    //let proc =</span>
<a href="#l7.54"></a><span id="l7.54">     EnigmailEncryption.encryptMessageStart(</span>
<a href="#l7.55"></a><span id="l7.55">       this.win,</span>
<a href="#l7.56"></a><span id="l7.56">       this.UIFlags,</span>
<a href="#l7.57"></a><span id="l7.57">       this.senderEmailAddr,</span>
<a href="#l7.58"></a><span id="l7.58">       this.recipients,</span>
<a href="#l7.59"></a><span id="l7.59">       this.bccRecipients,</span>
<a href="#l7.60"></a><span id="l7.60">       this.hashAlgorithm,</span>
<a href="#l7.61"></a><span id="l7.61">       this.sendFlags,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/rnp.jsm</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/modules/rnp.jsm</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -1366,13 +1366,78 @@ var RNP = {</span>
<a href="#l8.4"></a><span id="l8.4"> </span>
<a href="#l8.5"></a><span id="l8.5">       result = char_array.readString();</span>
<a href="#l8.6"></a><span id="l8.6">     }</span>
<a href="#l8.7"></a><span id="l8.7"> </span>
<a href="#l8.8"></a><span id="l8.8">     RNPLib.rnp_output_destroy(output_to_memory);</span>
<a href="#l8.9"></a><span id="l8.9">     RNPLib.rnp_key_handle_destroy(key);</span>
<a href="#l8.10"></a><span id="l8.10">     return result;</span>
<a href="#l8.11"></a><span id="l8.11">   },</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+  getNewRevocation(id) {</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineplus">+    let result = &quot;&quot;;</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineplus">+    let key = this.getKeyHandleByIdentifier(RNPLib.ffi, id);</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineplus">+</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineplus">+    if (key.isNull()) {</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineplus">+      return result;</span>
<a href="#l8.19"></a><span id="l8.19" class="difflineplus">+    }</span>
<a href="#l8.20"></a><span id="l8.20" class="difflineplus">+</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineplus">+    let out_final = new RNPLib.rnp_output_t();</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineplus">+    RNPLib.rnp_output_to_memory(out_final.address(), 0);</span>
<a href="#l8.23"></a><span id="l8.23" class="difflineplus">+</span>
<a href="#l8.24"></a><span id="l8.24" class="difflineplus">+    let out_binary = new RNPLib.rnp_output_t();</span>
<a href="#l8.25"></a><span id="l8.25" class="difflineplus">+    let rv;</span>
<a href="#l8.26"></a><span id="l8.26" class="difflineplus">+    if (</span>
<a href="#l8.27"></a><span id="l8.27" class="difflineplus">+      (rv = RNPLib.rnp_output_to_armor(</span>
<a href="#l8.28"></a><span id="l8.28" class="difflineplus">+        out_final,</span>
<a href="#l8.29"></a><span id="l8.29" class="difflineplus">+        out_binary.address(),</span>
<a href="#l8.30"></a><span id="l8.30" class="difflineplus">+        &quot;public key&quot;</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineplus">+      ))</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineplus">+    ) {</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineplus">+      throw new Error(&quot;rnp_output_to_armor failed:&quot; + rv);</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineplus">+    }</span>
<a href="#l8.35"></a><span id="l8.35" class="difflineplus">+</span>
<a href="#l8.36"></a><span id="l8.36" class="difflineplus">+    if (</span>
<a href="#l8.37"></a><span id="l8.37" class="difflineplus">+      (rv = RNPLib.rnp_key_export_revocation(</span>
<a href="#l8.38"></a><span id="l8.38" class="difflineplus">+        key,</span>
<a href="#l8.39"></a><span id="l8.39" class="difflineplus">+        out_binary,</span>
<a href="#l8.40"></a><span id="l8.40" class="difflineplus">+        0,</span>
<a href="#l8.41"></a><span id="l8.41" class="difflineplus">+        null,</span>
<a href="#l8.42"></a><span id="l8.42" class="difflineplus">+        null,</span>
<a href="#l8.43"></a><span id="l8.43" class="difflineplus">+        null</span>
<a href="#l8.44"></a><span id="l8.44" class="difflineplus">+      ))</span>
<a href="#l8.45"></a><span id="l8.45" class="difflineplus">+    ) {</span>
<a href="#l8.46"></a><span id="l8.46" class="difflineplus">+      throw new Error(&quot;rnp_key_export_revocation failed: &quot; + rv);</span>
<a href="#l8.47"></a><span id="l8.47" class="difflineplus">+    }</span>
<a href="#l8.48"></a><span id="l8.48" class="difflineplus">+</span>
<a href="#l8.49"></a><span id="l8.49" class="difflineplus">+    if ((rv = RNPLib.rnp_output_finish(out_binary))) {</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineplus">+      throw new Error(&quot;rnp_output_finish failed: &quot; + rv);</span>
<a href="#l8.51"></a><span id="l8.51" class="difflineplus">+    }</span>
<a href="#l8.52"></a><span id="l8.52" class="difflineplus">+</span>
<a href="#l8.53"></a><span id="l8.53" class="difflineplus">+    let result_buf = new ctypes.uint8_t.ptr();</span>
<a href="#l8.54"></a><span id="l8.54" class="difflineplus">+    let result_len = new ctypes.size_t();</span>
<a href="#l8.55"></a><span id="l8.55" class="difflineplus">+    let exitCode = RNPLib.rnp_output_memory_get_buf(</span>
<a href="#l8.56"></a><span id="l8.56" class="difflineplus">+      out_final,</span>
<a href="#l8.57"></a><span id="l8.57" class="difflineplus">+      result_buf.address(),</span>
<a href="#l8.58"></a><span id="l8.58" class="difflineplus">+      result_len.address(),</span>
<a href="#l8.59"></a><span id="l8.59" class="difflineplus">+      false</span>
<a href="#l8.60"></a><span id="l8.60" class="difflineplus">+    );</span>
<a href="#l8.61"></a><span id="l8.61" class="difflineplus">+</span>
<a href="#l8.62"></a><span id="l8.62" class="difflineplus">+    console.debug(exitCode);</span>
<a href="#l8.63"></a><span id="l8.63" class="difflineplus">+</span>
<a href="#l8.64"></a><span id="l8.64" class="difflineplus">+    if (!exitCode) {</span>
<a href="#l8.65"></a><span id="l8.65" class="difflineplus">+      let char_array = ctypes.cast(</span>
<a href="#l8.66"></a><span id="l8.66" class="difflineplus">+        result_buf,</span>
<a href="#l8.67"></a><span id="l8.67" class="difflineplus">+        ctypes.char.array(result_len.value).ptr</span>
<a href="#l8.68"></a><span id="l8.68" class="difflineplus">+      ).contents;</span>
<a href="#l8.69"></a><span id="l8.69" class="difflineplus">+      result = char_array.readString();</span>
<a href="#l8.70"></a><span id="l8.70" class="difflineplus">+    }</span>
<a href="#l8.71"></a><span id="l8.71" class="difflineplus">+</span>
<a href="#l8.72"></a><span id="l8.72" class="difflineplus">+    RNPLib.rnp_output_destroy(out_binary);</span>
<a href="#l8.73"></a><span id="l8.73" class="difflineplus">+    RNPLib.rnp_output_destroy(out_final);</span>
<a href="#l8.74"></a><span id="l8.74" class="difflineplus">+    RNPLib.rnp_key_handle_destroy(key);</span>
<a href="#l8.75"></a><span id="l8.75" class="difflineplus">+    return result;</span>
<a href="#l8.76"></a><span id="l8.76" class="difflineplus">+  },</span>
<a href="#l8.77"></a><span id="l8.77"> };</span>
<a href="#l8.78"></a><span id="l8.78"> </span>
<a href="#l8.79"></a><span id="l8.79"> // exports</span>
<a href="#l8.80"></a><span id="l8.80"> </span>
<a href="#l8.81"></a><span id="l8.81"> const EXPORTED_SYMBOLS = [&quot;RNP&quot;];</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/rnpLib.jsm</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/modules/rnpLib.jsm</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -872,16 +872,44 @@ function enableRNPLibJS() {</span>
<a href="#l9.4"></a><span id="l9.4">       &quot;rnp_key_export&quot;,</span>
<a href="#l9.5"></a><span id="l9.5">       abi,</span>
<a href="#l9.6"></a><span id="l9.6">       rnp_result_t,</span>
<a href="#l9.7"></a><span id="l9.7">       rnp_key_handle_t,</span>
<a href="#l9.8"></a><span id="l9.8">       rnp_output_t,</span>
<a href="#l9.9"></a><span id="l9.9">       ctypes.uint32_t</span>
<a href="#l9.10"></a><span id="l9.10">     ),</span>
<a href="#l9.11"></a><span id="l9.11"> </span>
<a href="#l9.12"></a><span id="l9.12" class="difflineplus">+    rnp_key_export_revocation: librnp.declare(</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+      &quot;rnp_key_export_revocation&quot;,</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineplus">+      abi,</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineplus">+      rnp_result_t,</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineplus">+      rnp_key_handle_t,</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineplus">+      rnp_output_t,</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineplus">+      ctypes.uint32_t,</span>
<a href="#l9.19"></a><span id="l9.19" class="difflineplus">+      ctypes.char.ptr,</span>
<a href="#l9.20"></a><span id="l9.20" class="difflineplus">+      ctypes.char.ptr,</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineplus">+      ctypes.char.ptr</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineplus">+    ),</span>
<a href="#l9.23"></a><span id="l9.23" class="difflineplus">+</span>
<a href="#l9.24"></a><span id="l9.24" class="difflineplus">+    rnp_output_to_armor: librnp.declare(</span>
<a href="#l9.25"></a><span id="l9.25" class="difflineplus">+      &quot;rnp_output_to_armor&quot;,</span>
<a href="#l9.26"></a><span id="l9.26" class="difflineplus">+      abi,</span>
<a href="#l9.27"></a><span id="l9.27" class="difflineplus">+      rnp_result_t,</span>
<a href="#l9.28"></a><span id="l9.28" class="difflineplus">+      rnp_output_t,</span>
<a href="#l9.29"></a><span id="l9.29" class="difflineplus">+      rnp_output_t.ptr,</span>
<a href="#l9.30"></a><span id="l9.30" class="difflineplus">+      ctypes.char.ptr</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineplus">+    ),</span>
<a href="#l9.32"></a><span id="l9.32" class="difflineplus">+</span>
<a href="#l9.33"></a><span id="l9.33" class="difflineplus">+    rnp_output_finish: librnp.declare(</span>
<a href="#l9.34"></a><span id="l9.34" class="difflineplus">+      &quot;rnp_output_finish&quot;,</span>
<a href="#l9.35"></a><span id="l9.35" class="difflineplus">+      abi,</span>
<a href="#l9.36"></a><span id="l9.36" class="difflineplus">+      rnp_result_t,</span>
<a href="#l9.37"></a><span id="l9.37" class="difflineplus">+      rnp_output_t</span>
<a href="#l9.38"></a><span id="l9.38" class="difflineplus">+    ),</span>
<a href="#l9.39"></a><span id="l9.39" class="difflineplus">+</span>
<a href="#l9.40"></a><span id="l9.40">     rnp_result_t,</span>
<a href="#l9.41"></a><span id="l9.41">     rnp_ffi_t,</span>
<a href="#l9.42"></a><span id="l9.42">     rnp_password_cb_t,</span>
<a href="#l9.43"></a><span id="l9.43">     rnp_input_t,</span>
<a href="#l9.44"></a><span id="l9.44">     rnp_output_t,</span>
<a href="#l9.45"></a><span id="l9.45">     rnp_key_handle_t,</span>
<a href="#l9.46"></a><span id="l9.46">     rnp_uid_handle_t,</span>
<a href="#l9.47"></a><span id="l9.47">     rnp_identifier_iterator_t,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mail/extensions/openpgp/content/strings/enigmail.dtd</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/strings/enigmail.dtd</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -1,14 +1,13 @@</span>
<a href="#l10.4"></a><span id="l10.4"> &lt;!ENTITY enigmail.label                   &quot;Gine-Liam&quot;&gt;</span>
<a href="#l10.5"></a><span id="l10.5"> &lt;!ENTITY enigmail.autocrypt.label         &quot;Autocrypt&quot;&gt;</span>
<a href="#l10.6"></a><span id="l10.6"> </span>
<a href="#l10.7"></a><span id="l10.7"> &lt;!ENTITY enigmail.keyUserId.label         &quot;Account / User ID&quot;&gt;</span>
<a href="#l10.8"></a><span id="l10.8"> &lt;!ENTITY enigmail.keygenTitle.label       &quot;Generate OpenPGP Key&quot;&gt;</span>
<a href="#l10.9"></a><span id="l10.9" class="difflineminus">-&lt;!ENTITY enigmail.useForSigning.label     &quot;Use generated key for the selected identity&quot;&gt;</span>
<a href="#l10.10"></a><span id="l10.10"> &lt;!ENTITY enigmail.keyNoPassphrase.label   &quot;No passphrase&quot;&gt;</span>
<a href="#l10.11"></a><span id="l10.11"> &lt;!ENTITY enigmail.keyPassphrase.label     &quot;Passphrase&quot;&gt;</span>
<a href="#l10.12"></a><span id="l10.12"> &lt;!ENTITY enigmail.keyPassphraseRepeat.label &quot;Passphrase (repeat)&quot;&gt;</span>
<a href="#l10.13"></a><span id="l10.13"> &lt;!ENTITY enigmail.generateKey.tooltip     &quot;Generates a new OpenPGP compliant key for encryption and/or signing&quot;&gt;</span>
<a href="#l10.14"></a><span id="l10.14"> &lt;!ENTITY enigmail.cancelKey.label         &quot;Cancel&quot;&gt;</span>
<a href="#l10.15"></a><span id="l10.15"> &lt;!ENTITY enigmail.cancelKey.tooltip       &quot;Cancel Key Generation&quot;&gt;</span>
<a href="#l10.16"></a><span id="l10.16"> &lt;!ENTITY enigmail.keyGen.expiry.title     &quot;Key expiry&quot;&gt;</span>
<a href="#l10.17"></a><span id="l10.17"> &lt;!ENTITY enigmail.keyGen.expire.label     &quot;Key expires in&quot;&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1">deleted file mode 100644</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineminus">--- a/mail/extensions/openpgp/content/ui/enigmailEditIdentity.js</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineplus">+++ /dev/null</span>
<a href="#l11.4"></a><span id="l11.4" class="difflineat">@@ -1,285 +0,0 @@</span>
<a href="#l11.5"></a><span id="l11.5" class="difflineminus">-/*</span>
<a href="#l11.6"></a><span id="l11.6" class="difflineminus">- * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l11.7"></a><span id="l11.7" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l11.8"></a><span id="l11.8" class="difflineminus">- * file, You can obtain one at https://mozilla.org/MPL/2.0/.</span>
<a href="#l11.9"></a><span id="l11.9" class="difflineminus">- */</span>
<a href="#l11.10"></a><span id="l11.10" class="difflineminus">-</span>
<a href="#l11.11"></a><span id="l11.11" class="difflineminus">-/* global gAccount: false, gIdentity: false, onOk: false, smimeOnAcceptEditor: false */</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineminus">-&quot;use strict&quot;;</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineminus">-</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineminus">-var EnigmailFuncs = ChromeUtils.import(</span>
<a href="#l11.16"></a><span id="l11.16" class="difflineminus">-  &quot;chrome://openpgp/content/modules/funcs.jsm&quot;</span>
<a href="#l11.17"></a><span id="l11.17" class="difflineminus">-).EnigmailFuncs;</span>
<a href="#l11.18"></a><span id="l11.18" class="difflineminus">-var EnigmailLocale = ChromeUtils.import(</span>
<a href="#l11.19"></a><span id="l11.19" class="difflineminus">-  &quot;chrome://openpgp/content/modules/locale.jsm&quot;</span>
<a href="#l11.20"></a><span id="l11.20" class="difflineminus">-).EnigmailLocale;</span>
<a href="#l11.21"></a><span id="l11.21" class="difflineminus">-var EnigmailWindows = ChromeUtils.import(</span>
<a href="#l11.22"></a><span id="l11.22" class="difflineminus">-  &quot;chrome://openpgp/content/modules/windows.jsm&quot;</span>
<a href="#l11.23"></a><span id="l11.23" class="difflineminus">-).EnigmailWindows;</span>
<a href="#l11.24"></a><span id="l11.24" class="difflineminus">-var EnigmailDialog = ChromeUtils.import(</span>
<a href="#l11.25"></a><span id="l11.25" class="difflineminus">-  &quot;chrome://openpgp/content/modules/dialog.jsm&quot;</span>
<a href="#l11.26"></a><span id="l11.26" class="difflineminus">-).EnigmailDialog;</span>
<a href="#l11.27"></a><span id="l11.27" class="difflineminus">-</span>
<a href="#l11.28"></a><span id="l11.28" class="difflineminus">-if (!Enigmail) {</span>
<a href="#l11.29"></a><span id="l11.29" class="difflineminus">-  var Enigmail = {};</span>
<a href="#l11.30"></a><span id="l11.30" class="difflineminus">-}</span>
<a href="#l11.31"></a><span id="l11.31" class="difflineminus">-</span>
<a href="#l11.32"></a><span id="l11.32" class="difflineminus">-Enigmail.edit = {</span>
<a href="#l11.33"></a><span id="l11.33" class="difflineminus">-  account: null,</span>
<a href="#l11.34"></a><span id="l11.34" class="difflineminus">-  identity: null,</span>
<a href="#l11.35"></a><span id="l11.35" class="difflineminus">-  enablePgp: null,</span>
<a href="#l11.36"></a><span id="l11.36" class="difflineminus">-  pgpKeyMode: null,</span>
<a href="#l11.37"></a><span id="l11.37" class="difflineminus">-  pgpKeyId: null,</span>
<a href="#l11.38"></a><span id="l11.38" class="difflineminus">-  cryptoChoicesEnabled: null,</span>
<a href="#l11.39"></a><span id="l11.39" class="difflineminus">-  signingPolicy: null, // account specific: by default sign</span>
<a href="#l11.40"></a><span id="l11.40" class="difflineminus">-  encryptionPolicy: null, // account specific: by default encrypt</span>
<a href="#l11.41"></a><span id="l11.41" class="difflineminus">-  pgpMimeMode: null, // account specific: by default pgp/mime</span>
<a href="#l11.42"></a><span id="l11.42" class="difflineminus">-  pgpSignPlainPolicy: null,</span>
<a href="#l11.43"></a><span id="l11.43" class="difflineminus">-  pgpSignEncPolicy: null,</span>
<a href="#l11.44"></a><span id="l11.44" class="difflineminus">-  autoEncryptDrafts: null,</span>
<a href="#l11.45"></a><span id="l11.45" class="difflineminus">-  openPgpSendKeyWithMsg: null,</span>
<a href="#l11.46"></a><span id="l11.46" class="difflineminus">-</span>
<a href="#l11.47"></a><span id="l11.47" class="difflineminus">-  onInit() {</span>
<a href="#l11.48"></a><span id="l11.48" class="difflineminus">-    // initialize all of our elements based on the current identity values....</span>
<a href="#l11.49"></a><span id="l11.49" class="difflineminus">-    EnigmailFuncs.collapseAdvanced(</span>
<a href="#l11.50"></a><span id="l11.50" class="difflineminus">-      document.getElementById(&quot;enigmail_PrefsBox&quot;),</span>
<a href="#l11.51"></a><span id="l11.51" class="difflineminus">-      &quot;hidden&quot;</span>
<a href="#l11.52"></a><span id="l11.52" class="difflineminus">-    );</span>
<a href="#l11.53"></a><span id="l11.53" class="difflineminus">-</span>
<a href="#l11.54"></a><span id="l11.54" class="difflineminus">-    this.enablePgp = document.getElementById(&quot;enigmail_enablePgp&quot;);</span>
<a href="#l11.55"></a><span id="l11.55" class="difflineminus">-    this.pgpKeyMode = document.getElementById(&quot;enigmail_pgpKeyMode&quot;);</span>
<a href="#l11.56"></a><span id="l11.56" class="difflineminus">-    this.pgpKeyId = document.getElementById(&quot;enigmail_identity.pgpkeyId&quot;);</span>
<a href="#l11.57"></a><span id="l11.57" class="difflineminus">-    this.signingPolicy = document.getElementById(&quot;enigmail_sign_ifPossible&quot;);</span>
<a href="#l11.58"></a><span id="l11.58" class="difflineminus">-    this.encryptionPolicy = document.getElementById(</span>
<a href="#l11.59"></a><span id="l11.59" class="difflineminus">-      &quot;enigmail_encrypt_ifPossible&quot;</span>
<a href="#l11.60"></a><span id="l11.60" class="difflineminus">-    );</span>
<a href="#l11.61"></a><span id="l11.61" class="difflineminus">-    this.pgpMimeMode = document.getElementById(&quot;enigmail_pgpMimeMode&quot;);</span>
<a href="#l11.62"></a><span id="l11.62" class="difflineminus">-    this.autoEncryptDrafts = document.getElementById(</span>
<a href="#l11.63"></a><span id="l11.63" class="difflineminus">-      &quot;enigmail_autoEncryptDrafts&quot;</span>
<a href="#l11.64"></a><span id="l11.64" class="difflineminus">-    );</span>
<a href="#l11.65"></a><span id="l11.65" class="difflineminus">-    this.mimePreferOpenPGP = document.getElementById(</span>
<a href="#l11.66"></a><span id="l11.66" class="difflineminus">-      &quot;enigmail_mimePreferOpenPGP&quot;</span>
<a href="#l11.67"></a><span id="l11.67" class="difflineminus">-    );</span>
<a href="#l11.68"></a><span id="l11.68" class="difflineminus">-    this.isSingleIdEditor = !!document.getElementById(&quot;enigmail_singleId&quot;);</span>
<a href="#l11.69"></a><span id="l11.69" class="difflineminus">-    this.openPgpSendKeyWithMsg = document.getElementById(</span>
<a href="#l11.70"></a><span id="l11.70" class="difflineminus">-      &quot;openpgp.sendKeyWithMsg&quot;</span>
<a href="#l11.71"></a><span id="l11.71" class="difflineminus">-    );</span>
<a href="#l11.72"></a><span id="l11.72" class="difflineminus">-</span>
<a href="#l11.73"></a><span id="l11.73" class="difflineminus">-    if (this.identity) {</span>
<a href="#l11.74"></a><span id="l11.74" class="difflineminus">-      this.enablePgp.checked = this.identity.getBoolAttribute(&quot;enablePgp&quot;);</span>
<a href="#l11.75"></a><span id="l11.75" class="difflineminus">-      this.cryptoChoicesEnabled = this.enablePgp.checked;</span>
<a href="#l11.76"></a><span id="l11.76" class="difflineminus">-</span>
<a href="#l11.77"></a><span id="l11.77" class="difflineminus">-      var selectedItemId = null;</span>
<a href="#l11.78"></a><span id="l11.78" class="difflineminus">-      var keyPolicy = this.identity.getIntAttribute(&quot;pgpKeyMode&quot;);</span>
<a href="#l11.79"></a><span id="l11.79" class="difflineminus">-      switch (keyPolicy) {</span>
<a href="#l11.80"></a><span id="l11.80" class="difflineminus">-        case 1:</span>
<a href="#l11.81"></a><span id="l11.81" class="difflineminus">-          selectedItemId = &quot;enigmail_keymode_usePgpkeyId&quot;;</span>
<a href="#l11.82"></a><span id="l11.82" class="difflineminus">-          break;</span>
<a href="#l11.83"></a><span id="l11.83" class="difflineminus">-        default:</span>
<a href="#l11.84"></a><span id="l11.84" class="difflineminus">-          selectedItemId = &quot;enigmail_keymode_useFromAddress&quot;;</span>
<a href="#l11.85"></a><span id="l11.85" class="difflineminus">-          break;</span>
<a href="#l11.86"></a><span id="l11.86" class="difflineminus">-      }</span>
<a href="#l11.87"></a><span id="l11.87" class="difflineminus">-      this.pgpKeyMode.selectedItem = document.getElementById(selectedItemId);</span>
<a href="#l11.88"></a><span id="l11.88" class="difflineminus">-</span>
<a href="#l11.89"></a><span id="l11.89" class="difflineminus">-      var mimePolicy = this.identity.getIntAttribute(&quot;mimePreferOpenPGP&quot;);</span>
<a href="#l11.90"></a><span id="l11.90" class="difflineminus">-      switch (mimePolicy) {</span>
<a href="#l11.91"></a><span id="l11.91" class="difflineminus">-        case 1:</span>
<a href="#l11.92"></a><span id="l11.92" class="difflineminus">-          selectedItemId = &quot;enigmail_mime_preferEnigmail&quot;;</span>
<a href="#l11.93"></a><span id="l11.93" class="difflineminus">-          break;</span>
<a href="#l11.94"></a><span id="l11.94" class="difflineminus">-        default:</span>
<a href="#l11.95"></a><span id="l11.95" class="difflineminus">-          selectedItemId = &quot;enigmail_mime_preferSMime&quot;;</span>
<a href="#l11.96"></a><span id="l11.96" class="difflineminus">-          break;</span>
<a href="#l11.97"></a><span id="l11.97" class="difflineminus">-      }</span>
<a href="#l11.98"></a><span id="l11.98" class="difflineminus">-      this.mimePreferOpenPGP.selectedItem = document.getElementById(</span>
<a href="#l11.99"></a><span id="l11.99" class="difflineminus">-        selectedItemId</span>
<a href="#l11.100"></a><span id="l11.100" class="difflineminus">-      );</span>
<a href="#l11.101"></a><span id="l11.101" class="difflineminus">-</span>
<a href="#l11.102"></a><span id="l11.102" class="difflineminus">-      this.pgpKeyId.value = this.identity.getCharAttribute(&quot;pgpkeyId&quot;);</span>
<a href="#l11.103"></a><span id="l11.103" class="difflineminus">-      this.signingPolicy.checked =</span>
<a href="#l11.104"></a><span id="l11.104" class="difflineminus">-        this.identity.getIntAttribute(&quot;defaultSigningPolicy&quot;) &gt; 0;</span>
<a href="#l11.105"></a><span id="l11.105" class="difflineminus">-      this.encryptionPolicy.checked =</span>
<a href="#l11.106"></a><span id="l11.106" class="difflineminus">-        this.identity.getIntAttribute(&quot;defaultEncryptionPolicy&quot;) &gt; 0;</span>
<a href="#l11.107"></a><span id="l11.107" class="difflineminus">-      this.pgpMimeMode.checked = this.identity.getBoolAttribute(&quot;pgpMimeMode&quot;);</span>
<a href="#l11.108"></a><span id="l11.108" class="difflineminus">-      this.pgpSignEncPolicy.checked = this.identity.getBoolAttribute(</span>
<a href="#l11.109"></a><span id="l11.109" class="difflineminus">-        &quot;pgpSignEncrypted&quot;</span>
<a href="#l11.110"></a><span id="l11.110" class="difflineminus">-      );</span>
<a href="#l11.111"></a><span id="l11.111" class="difflineminus">-      this.pgpSignPlainPolicy.checked = this.identity.getBoolAttribute(</span>
<a href="#l11.112"></a><span id="l11.112" class="difflineminus">-        &quot;pgpSignPlain&quot;</span>
<a href="#l11.113"></a><span id="l11.113" class="difflineminus">-      );</span>
<a href="#l11.114"></a><span id="l11.114" class="difflineminus">-      this.autoEncryptDrafts.checked = this.identity.getBoolAttribute(</span>
<a href="#l11.115"></a><span id="l11.115" class="difflineminus">-        &quot;autoEncryptDrafts&quot;</span>
<a href="#l11.116"></a><span id="l11.116" class="difflineminus">-      );</span>
<a href="#l11.117"></a><span id="l11.117" class="difflineminus">-    } else {</span>
<a href="#l11.118"></a><span id="l11.118" class="difflineminus">-      this.enablePgp.checked = false;</span>
<a href="#l11.119"></a><span id="l11.119" class="difflineminus">-      this.cryptoChoicesEnabled = false;</span>
<a href="#l11.120"></a><span id="l11.120" class="difflineminus">-      this.pgpMimeMode.checked = true;</span>
<a href="#l11.121"></a><span id="l11.121" class="difflineminus">-      this.pgpSignEncPolicy.checked = true;</span>
<a href="#l11.122"></a><span id="l11.122" class="difflineminus">-      this.autoEncryptDrafts.checked = true;</span>
<a href="#l11.123"></a><span id="l11.123" class="difflineminus">-    }</span>
<a href="#l11.124"></a><span id="l11.124" class="difflineminus">-</span>
<a href="#l11.125"></a><span id="l11.125" class="difflineminus">-    // Disable all locked elements on the panel</span>
<a href="#l11.126"></a><span id="l11.126" class="difflineminus">-    //onLockPreference();</span>
<a href="#l11.127"></a><span id="l11.127" class="difflineminus">-    this.enableAllPrefs();</span>
<a href="#l11.128"></a><span id="l11.128" class="difflineminus">-  },</span>
<a href="#l11.129"></a><span id="l11.129" class="difflineminus">-</span>
<a href="#l11.130"></a><span id="l11.130" class="difflineminus">-  onLoadEditor() {</span>
<a href="#l11.131"></a><span id="l11.131" class="difflineminus">-    if (typeof gAccount == &quot;object&quot;) {</span>
<a href="#l11.132"></a><span id="l11.132" class="difflineminus">-      this.account = gAccount;</span>
<a href="#l11.133"></a><span id="l11.133" class="difflineminus">-      this.identity = gIdentity;</span>
<a href="#l11.134"></a><span id="l11.134" class="difflineminus">-    } else if (&quot;arguments&quot; in window) {</span>
<a href="#l11.135"></a><span id="l11.135" class="difflineminus">-      this.identity = window.arguments[0].identity;</span>
<a href="#l11.136"></a><span id="l11.136" class="difflineminus">-      this.account = window.arguments[0].account;</span>
<a href="#l11.137"></a><span id="l11.137" class="difflineminus">-    }</span>
<a href="#l11.138"></a><span id="l11.138" class="difflineminus">-</span>
<a href="#l11.139"></a><span id="l11.139" class="difflineminus">-    if (this.identity) {</span>
<a href="#l11.140"></a><span id="l11.140" class="difflineminus">-      var idLabel = EnigmailLocale.getString(&quot;identityName&quot;, [</span>
<a href="#l11.141"></a><span id="l11.141" class="difflineminus">-        this.identity.identityName,</span>
<a href="#l11.142"></a><span id="l11.142" class="difflineminus">-      ]);</span>
<a href="#l11.143"></a><span id="l11.143" class="difflineminus">-      document.getElementById(&quot;enigmail_identityName&quot;).value = idLabel;</span>
<a href="#l11.144"></a><span id="l11.144" class="difflineminus">-    }</span>
<a href="#l11.145"></a><span id="l11.145" class="difflineminus">-</span>
<a href="#l11.146"></a><span id="l11.146" class="difflineminus">-    var dlg = document.getElementsByTagName(&quot;dialog&quot;)[0];</span>
<a href="#l11.147"></a><span id="l11.147" class="difflineminus">-    dlg.setAttribute(</span>
<a href="#l11.148"></a><span id="l11.148" class="difflineminus">-      &quot;ondialogaccept&quot;,</span>
<a href="#l11.149"></a><span id="l11.149" class="difflineminus">-      &quot;return Enigmail.edit.onAcceptEditor();&quot;</span>
<a href="#l11.150"></a><span id="l11.150" class="difflineminus">-    );</span>
<a href="#l11.151"></a><span id="l11.151" class="difflineminus">-</span>
<a href="#l11.152"></a><span id="l11.152" class="difflineminus">-    this.onInit();</span>
<a href="#l11.153"></a><span id="l11.153" class="difflineminus">-  },</span>
<a href="#l11.154"></a><span id="l11.154" class="difflineminus">-</span>
<a href="#l11.155"></a><span id="l11.155" class="difflineminus">-  onAcceptEditor() {</span>
<a href="#l11.156"></a><span id="l11.156" class="difflineminus">-    try {</span>
<a href="#l11.157"></a><span id="l11.157" class="difflineminus">-      if (onOk() === false) {</span>
<a href="#l11.158"></a><span id="l11.158" class="difflineminus">-        return false;</span>
<a href="#l11.159"></a><span id="l11.159" class="difflineminus">-      }</span>
<a href="#l11.160"></a><span id="l11.160" class="difflineminus">-    } catch (ex) {}</span>
<a href="#l11.161"></a><span id="l11.161" class="difflineminus">-    this.onSave();</span>
<a href="#l11.162"></a><span id="l11.162" class="difflineminus">-    if (typeof smimeOnAcceptEditor == &quot;function&quot;) {</span>
<a href="#l11.163"></a><span id="l11.163" class="difflineminus">-      return smimeOnAcceptEditor();</span>
<a href="#l11.164"></a><span id="l11.164" class="difflineminus">-    }</span>
<a href="#l11.165"></a><span id="l11.165" class="difflineminus">-    return true;</span>
<a href="#l11.166"></a><span id="l11.166" class="difflineminus">-  },</span>
<a href="#l11.167"></a><span id="l11.167" class="difflineminus">-</span>
<a href="#l11.168"></a><span id="l11.168" class="difflineminus">-  onSave() {</span>
<a href="#l11.169"></a><span id="l11.169" class="difflineminus">-    if (!this.identity) {</span>
<a href="#l11.170"></a><span id="l11.170" class="difflineminus">-      this.identity = gIdentity;</span>
<a href="#l11.171"></a><span id="l11.171" class="difflineminus">-    }</span>
<a href="#l11.172"></a><span id="l11.172" class="difflineminus">-    this.identity.setBoolAttribute(&quot;enablePgp&quot;, this.enablePgp.checked);</span>
<a href="#l11.173"></a><span id="l11.173" class="difflineminus">-    //To attach OpenPGP Key with the mail</span>
<a href="#l11.174"></a><span id="l11.174" class="difflineminus">-    this.identity.setBoolAttribute(</span>
<a href="#l11.175"></a><span id="l11.175" class="difflineminus">-      &quot;attachPgpKey&quot;,</span>
<a href="#l11.176"></a><span id="l11.176" class="difflineminus">-      this.openPgpSendKeyWithMsg.checked</span>
<a href="#l11.177"></a><span id="l11.177" class="difflineminus">-    );</span>
<a href="#l11.178"></a><span id="l11.178" class="difflineminus">-</span>
<a href="#l11.179"></a><span id="l11.179" class="difflineminus">-    if (this.enablePgp.checked) {</span>
<a href="#l11.180"></a><span id="l11.180" class="difflineminus">-      // PGP is enabled</span>
<a href="#l11.181"></a><span id="l11.181" class="difflineminus">-      this.identity.setIntAttribute(</span>
<a href="#l11.182"></a><span id="l11.182" class="difflineminus">-        &quot;pgpKeyMode&quot;,</span>
<a href="#l11.183"></a><span id="l11.183" class="difflineminus">-        this.pgpKeyMode.selectedItem.value</span>
<a href="#l11.184"></a><span id="l11.184" class="difflineminus">-      );</span>
<a href="#l11.185"></a><span id="l11.185" class="difflineminus">-      this.identity.setIntAttribute(</span>
<a href="#l11.186"></a><span id="l11.186" class="difflineminus">-        &quot;mimePreferOpenPGP&quot;,</span>
<a href="#l11.187"></a><span id="l11.187" class="difflineminus">-        this.mimePreferOpenPGP.selectedItem.value</span>
<a href="#l11.188"></a><span id="l11.188" class="difflineminus">-      );</span>
<a href="#l11.189"></a><span id="l11.189" class="difflineminus">-      this.identity.setCharAttribute(&quot;pgpkeyId&quot;, this.pgpKeyId.value);</span>
<a href="#l11.190"></a><span id="l11.190" class="difflineminus">-      this.identity.setIntAttribute(</span>
<a href="#l11.191"></a><span id="l11.191" class="difflineminus">-        &quot;defaultSigningPolicy&quot;,</span>
<a href="#l11.192"></a><span id="l11.192" class="difflineminus">-        this.signingPolicy.checked ? 1 : 0</span>
<a href="#l11.193"></a><span id="l11.193" class="difflineminus">-      );</span>
<a href="#l11.194"></a><span id="l11.194" class="difflineminus">-      this.identity.setIntAttribute(</span>
<a href="#l11.195"></a><span id="l11.195" class="difflineminus">-        &quot;defaultEncryptionPolicy&quot;,</span>
<a href="#l11.196"></a><span id="l11.196" class="difflineminus">-        this.encryptionPolicy.checked ? 1 : 0</span>
<a href="#l11.197"></a><span id="l11.197" class="difflineminus">-      );</span>
<a href="#l11.198"></a><span id="l11.198" class="difflineminus">-      this.identity.setBoolAttribute(&quot;pgpMimeMode&quot;, this.pgpMimeMode.checked);</span>
<a href="#l11.199"></a><span id="l11.199" class="difflineminus">-      this.identity.setBoolAttribute(</span>
<a href="#l11.200"></a><span id="l11.200" class="difflineminus">-        &quot;pgpSignEncrypted&quot;,</span>
<a href="#l11.201"></a><span id="l11.201" class="difflineminus">-        this.pgpSignEncPolicy.checked</span>
<a href="#l11.202"></a><span id="l11.202" class="difflineminus">-      );</span>
<a href="#l11.203"></a><span id="l11.203" class="difflineminus">-      this.identity.setBoolAttribute(</span>
<a href="#l11.204"></a><span id="l11.204" class="difflineminus">-        &quot;pgpSignPlain&quot;,</span>
<a href="#l11.205"></a><span id="l11.205" class="difflineminus">-        this.pgpSignPlainPolicy.checked</span>
<a href="#l11.206"></a><span id="l11.206" class="difflineminus">-      );</span>
<a href="#l11.207"></a><span id="l11.207" class="difflineminus">-      this.identity.setBoolAttribute(</span>
<a href="#l11.208"></a><span id="l11.208" class="difflineminus">-        &quot;autoEncryptDrafts&quot;,</span>
<a href="#l11.209"></a><span id="l11.209" class="difflineminus">-        this.autoEncryptDrafts.checked</span>
<a href="#l11.210"></a><span id="l11.210" class="difflineminus">-      );</span>
<a href="#l11.211"></a><span id="l11.211" class="difflineminus">-    }</span>
<a href="#l11.212"></a><span id="l11.212" class="difflineminus">-  },</span>
<a href="#l11.213"></a><span id="l11.213" class="difflineminus">-</span>
<a href="#l11.214"></a><span id="l11.214" class="difflineminus">-  toggleEnable() {</span>
<a href="#l11.215"></a><span id="l11.215" class="difflineminus">-    let newCryptoEnabled = !this.cryptoChoicesEnabled;</span>
<a href="#l11.216"></a><span id="l11.216" class="difflineminus">-</span>
<a href="#l11.217"></a><span id="l11.217" class="difflineminus">-    this.cryptoChoicesEnabled = newCryptoEnabled;</span>
<a href="#l11.218"></a><span id="l11.218" class="difflineminus">-    this.enableAllPrefs();</span>
<a href="#l11.219"></a><span id="l11.219" class="difflineminus">-  },</span>
<a href="#l11.220"></a><span id="l11.220" class="difflineminus">-</span>
<a href="#l11.221"></a><span id="l11.221" class="difflineminus">-  enableAllPrefs() {</span>
<a href="#l11.222"></a><span id="l11.222" class="difflineminus">-    var elem = document.getElementById(&quot;enigmail_bcEnablePgp&quot;);</span>
<a href="#l11.223"></a><span id="l11.223" class="difflineminus">-    if (this.cryptoChoicesEnabled) {</span>
<a href="#l11.224"></a><span id="l11.224" class="difflineminus">-      if (elem) {</span>
<a href="#l11.225"></a><span id="l11.225" class="difflineminus">-        elem.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l11.226"></a><span id="l11.226" class="difflineminus">-      }</span>
<a href="#l11.227"></a><span id="l11.227" class="difflineminus">-    } else if (elem) {</span>
<a href="#l11.228"></a><span id="l11.228" class="difflineminus">-      elem.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l11.229"></a><span id="l11.229" class="difflineminus">-    }</span>
<a href="#l11.230"></a><span id="l11.230" class="difflineminus">-</span>
<a href="#l11.231"></a><span id="l11.231" class="difflineminus">-    this.enableKeySel(this.cryptoChoicesEnabled &amp;&amp; this.pgpKeyMode.value == 1);</span>
<a href="#l11.232"></a><span id="l11.232" class="difflineminus">-  },</span>
<a href="#l11.233"></a><span id="l11.233" class="difflineminus">-</span>
<a href="#l11.234"></a><span id="l11.234" class="difflineminus">-  enableKeySel(enable) {</span>
<a href="#l11.235"></a><span id="l11.235" class="difflineminus">-    if (enable) {</span>
<a href="#l11.236"></a><span id="l11.236" class="difflineminus">-      document</span>
<a href="#l11.237"></a><span id="l11.237" class="difflineminus">-        .getElementById(&quot;enigmail_bcUseKeyId&quot;)</span>
<a href="#l11.238"></a><span id="l11.238" class="difflineminus">-        .removeAttribute(&quot;disabled&quot;);</span>
<a href="#l11.239"></a><span id="l11.239" class="difflineminus">-    } else {</span>
<a href="#l11.240"></a><span id="l11.240" class="difflineminus">-      document</span>
<a href="#l11.241"></a><span id="l11.241" class="difflineminus">-        .getElementById(&quot;enigmail_bcUseKeyId&quot;)</span>
<a href="#l11.242"></a><span id="l11.242" class="difflineminus">-        .setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l11.243"></a><span id="l11.243" class="difflineminus">-    }</span>
<a href="#l11.244"></a><span id="l11.244" class="difflineminus">-  },</span>
<a href="#l11.245"></a><span id="l11.245" class="difflineminus">-</span>
<a href="#l11.246"></a><span id="l11.246" class="difflineminus">-  handleClick(event) {</span>
<a href="#l11.247"></a><span id="l11.247" class="difflineminus">-    if (event.target.hasAttribute(&quot;href&quot;)) {</span>
<a href="#l11.248"></a><span id="l11.248" class="difflineminus">-      EnigmailWindows.openMailTab(event.target.getAttribute(&quot;href&quot;));</span>
<a href="#l11.249"></a><span id="l11.249" class="difflineminus">-    }</span>
<a href="#l11.250"></a><span id="l11.250" class="difflineminus">-  },</span>
<a href="#l11.251"></a><span id="l11.251" class="difflineminus">-</span>
<a href="#l11.252"></a><span id="l11.252" class="difflineminus">-  selectKeyId() {</span>
<a href="#l11.253"></a><span id="l11.253" class="difflineminus">-    var resultObj = {};</span>
<a href="#l11.254"></a><span id="l11.254" class="difflineminus">-    var inputObj = {};</span>
<a href="#l11.255"></a><span id="l11.255" class="difflineminus">-    inputObj.dialogHeader = EnigmailLocale.getString(&quot;encryptKeyHeader&quot;);</span>
<a href="#l11.256"></a><span id="l11.256" class="difflineminus">-    inputObj.options = &quot;single,hidexpired,private,nosending&quot;;</span>
<a href="#l11.257"></a><span id="l11.257" class="difflineminus">-    var button = document.getElementById(&quot;enigmail_selectPgpKey&quot;);</span>
<a href="#l11.258"></a><span id="l11.258" class="difflineminus">-    var label = button.getAttribute(&quot;label&quot;);</span>
<a href="#l11.259"></a><span id="l11.259" class="difflineminus">-    inputObj.options += &quot;,sendlabel=&quot; + label;</span>
<a href="#l11.260"></a><span id="l11.260" class="difflineminus">-    inputObj.options += &quot;,&quot;;</span>
<a href="#l11.261"></a><span id="l11.261" class="difflineminus">-</span>
<a href="#l11.262"></a><span id="l11.262" class="difflineminus">-    window.openDialog(</span>
<a href="#l11.263"></a><span id="l11.263" class="difflineminus">-      &quot;chrome://openpgp/content/ui/enigmailKeySelection.xhtml&quot;,</span>
<a href="#l11.264"></a><span id="l11.264" class="difflineminus">-      &quot;&quot;,</span>
<a href="#l11.265"></a><span id="l11.265" class="difflineminus">-      &quot;dialog,modal,centerscreen,resizable&quot;,</span>
<a href="#l11.266"></a><span id="l11.266" class="difflineminus">-      inputObj,</span>
<a href="#l11.267"></a><span id="l11.267" class="difflineminus">-      resultObj</span>
<a href="#l11.268"></a><span id="l11.268" class="difflineminus">-    );</span>
<a href="#l11.269"></a><span id="l11.269" class="difflineminus">-    try {</span>
<a href="#l11.270"></a><span id="l11.270" class="difflineminus">-      if (resultObj.cancelled) {</span>
<a href="#l11.271"></a><span id="l11.271" class="difflineminus">-        return;</span>
<a href="#l11.272"></a><span id="l11.272" class="difflineminus">-      }</span>
<a href="#l11.273"></a><span id="l11.273" class="difflineminus">-      var selKey = resultObj.userList[0];</span>
<a href="#l11.274"></a><span id="l11.274" class="difflineminus">-      //selKey = &quot;0x&quot;+selKey.substring(10,18);</span>
<a href="#l11.275"></a><span id="l11.275" class="difflineminus">-      this.pgpKeyId.value = selKey;</span>
<a href="#l11.276"></a><span id="l11.276" class="difflineminus">-    } catch (ex) {</span>
<a href="#l11.277"></a><span id="l11.277" class="difflineminus">-      // cancel pressed -&gt; don't send mail</span>
<a href="#l11.278"></a><span id="l11.278" class="difflineminus">-    }</span>
<a href="#l11.279"></a><span id="l11.279" class="difflineminus">-  },</span>
<a href="#l11.280"></a><span id="l11.280" class="difflineminus">-};</span>
<a href="#l11.281"></a><span id="l11.281" class="difflineminus">-</span>
<a href="#l11.282"></a><span id="l11.282" class="difflineminus">-window.addEventListener(</span>
<a href="#l11.283"></a><span id="l11.283" class="difflineminus">-  &quot;load-enigmail&quot;,</span>
<a href="#l11.284"></a><span id="l11.284" class="difflineminus">-  Enigmail.edit.onLoadEditor.bind(Enigmail.edit)</span>
<a href="#l11.285"></a><span id="l11.285" class="difflineminus">-);</span>
<a href="#l11.286"></a><span id="l11.286" class="difflineminus">-</span>
<a href="#l11.287"></a><span id="l11.287" class="difflineminus">-document.addEventListener(&quot;dialogaccept&quot;, function(event) {</span>
<a href="#l11.288"></a><span id="l11.288" class="difflineminus">-  Enigmail.edit.onAcceptEditor();</span>
<a href="#l11.289"></a><span id="l11.289" class="difflineminus">-});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mail/extensions/openpgp/content/ui/enigmailKeygen.js</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/ui/enigmailKeygen.js</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -24,37 +24,56 @@ EnigInitCommon(&quot;enigmailKeygen&quot;);</span>
<a href="#l12.4"></a><span id="l12.4"> </span>
<a href="#l12.5"></a><span id="l12.5"> var gAccountManager = Cc[ENIG_ACCOUNT_MANAGER_CONTRACTID].getService(</span>
<a href="#l12.6"></a><span id="l12.6">   Ci.nsIMsgAccountManager</span>
<a href="#l12.7"></a><span id="l12.7"> );</span>
<a href="#l12.8"></a><span id="l12.8"> </span>
<a href="#l12.9"></a><span id="l12.9"> var EnigmailCryptoAPI = ChromeUtils.import(</span>
<a href="#l12.10"></a><span id="l12.10">   &quot;chrome://openpgp/content/modules/cryptoAPI.jsm&quot;</span>
<a href="#l12.11"></a><span id="l12.11"> ).EnigmailCryptoAPI;</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineplus">+var { EnigmailFiles } = ChromeUtils.import(</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+  &quot;chrome://openpgp/content/modules/files.jsm&quot;</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineplus">+);</span>
<a href="#l12.15"></a><span id="l12.15"> var OpenPGPMasterpass = ChromeUtils.import(</span>
<a href="#l12.16"></a><span id="l12.16">   &quot;chrome://openpgp/content/modules/masterpass.jsm&quot;</span>
<a href="#l12.17"></a><span id="l12.17"> ).OpenPGPMasterpass;</span>
<a href="#l12.18"></a><span id="l12.18" class="difflineplus">+var { RNP } = ChromeUtils.import(&quot;chrome://openpgp/content/modules/rnp.jsm&quot;);</span>
<a href="#l12.19"></a><span id="l12.19"> </span>
<a href="#l12.20"></a><span id="l12.20"> var gUserIdentityList;</span>
<a href="#l12.21"></a><span id="l12.21"> var gUserIdentityListPopup;</span>
<a href="#l12.22"></a><span id="l12.22" class="difflineminus">-var gUseForSigning;</span>
<a href="#l12.23"></a><span id="l12.23"> </span>
<a href="#l12.24"></a><span id="l12.24"> var gKeygenRequest;</span>
<a href="#l12.25"></a><span id="l12.25"> var gAllData = &quot;&quot;;</span>
<a href="#l12.26"></a><span id="l12.26"> var gGeneratedKey = null;</span>
<a href="#l12.27"></a><span id="l12.27"> var gUsedId;</span>
<a href="#l12.28"></a><span id="l12.28"> </span>
<a href="#l12.29"></a><span id="l12.29"> const KEYGEN_CANCELLED = &quot;cancelled&quot;;</span>
<a href="#l12.30"></a><span id="l12.30" class="difflineplus">+const DEFAULT_FILE_PERMS = 0o600;</span>
<a href="#l12.31"></a><span id="l12.31" class="difflineplus">+</span>
<a href="#l12.32"></a><span id="l12.32" class="difflineplus">+let revocationFilePrefix1 =</span>
<a href="#l12.33"></a><span id="l12.33" class="difflineplus">+  &quot;This is a revocation certificate for the OpenPGP key:&quot;;</span>
<a href="#l12.34"></a><span id="l12.34" class="difflineplus">+let revocationFilePrefix2 = `</span>
<a href="#l12.35"></a><span id="l12.35" class="difflineplus">+A revocation certificate is a kind of &quot;kill switch&quot; to publicly</span>
<a href="#l12.36"></a><span id="l12.36" class="difflineplus">+declare that a key shall no longer be used.  It is not possible</span>
<a href="#l12.37"></a><span id="l12.37" class="difflineplus">+to retract such a revocation certificate once it has been published.</span>
<a href="#l12.38"></a><span id="l12.38" class="difflineplus">+</span>
<a href="#l12.39"></a><span id="l12.39" class="difflineplus">+Use it to revoke this key in case of a secret key compromise, or loss of</span>
<a href="#l12.40"></a><span id="l12.40" class="difflineplus">+the secret key, or loss of passphrase of the secret key.</span>
<a href="#l12.41"></a><span id="l12.41" class="difflineplus">+</span>
<a href="#l12.42"></a><span id="l12.42" class="difflineplus">+To avoid an accidental use of this file, a colon has been inserted</span>
<a href="#l12.43"></a><span id="l12.43" class="difflineplus">+before the 5 dashes below.  Remove this colon with a text editor</span>
<a href="#l12.44"></a><span id="l12.44" class="difflineplus">+before importing and publishing this revocation certificate.</span>
<a href="#l12.45"></a><span id="l12.45" class="difflineplus">+</span>
<a href="#l12.46"></a><span id="l12.46" class="difflineplus">+:`;</span>
<a href="#l12.47"></a><span id="l12.47"> </span>
<a href="#l12.48"></a><span id="l12.48"> function enigmailKeygenLoad() {</span>
<a href="#l12.49"></a><span id="l12.49">   EnigmailLog.DEBUG(&quot;enigmailKeygen.js: Load\n&quot;);</span>
<a href="#l12.50"></a><span id="l12.50"> </span>
<a href="#l12.51"></a><span id="l12.51">   gUserIdentityList = document.getElementById(&quot;userIdentity&quot;);</span>
<a href="#l12.52"></a><span id="l12.52">   gUserIdentityListPopup = document.getElementById(&quot;userIdentityPopup&quot;);</span>
<a href="#l12.53"></a><span id="l12.53" class="difflineminus">-  gUseForSigning = document.getElementById(&quot;useForSigning&quot;);</span>
<a href="#l12.54"></a><span id="l12.54"> </span>
<a href="#l12.55"></a><span id="l12.55">   //if (EnigmailGpg.getGpgFeature(&quot;supports-ecc-keys&quot;))</span>
<a href="#l12.56"></a><span id="l12.56">   let eccElem = document.getElementById(&quot;keyType_ecc&quot;);</span>
<a href="#l12.57"></a><span id="l12.57">   eccElem.removeAttribute(&quot;hidden&quot;);</span>
<a href="#l12.58"></a><span id="l12.58">   updateKeySizeSel(eccElem);</span>
<a href="#l12.59"></a><span id="l12.59">   //document.getElementById(&quot;keyType&quot;).selectedItem = eccElem;</span>
<a href="#l12.60"></a><span id="l12.60"> </span>
<a href="#l12.61"></a><span id="l12.61">   if (gUserIdentityListPopup) {</span>
<a href="#l12.62"></a><span id="l12.62" class="difflineat">@@ -98,92 +117,16 @@ function enigmailOnClose() {</span>
<a href="#l12.63"></a><span id="l12.63"> }</span>
<a href="#l12.64"></a><span id="l12.64"> </span>
<a href="#l12.65"></a><span id="l12.65"> function enigmailKeygenUnload() {</span>
<a href="#l12.66"></a><span id="l12.66">   EnigmailLog.DEBUG(&quot;enigmailKeygen.js: Unload\n&quot;);</span>
<a href="#l12.67"></a><span id="l12.67"> </span>
<a href="#l12.68"></a><span id="l12.68">   enigmailKeygenCloseRequest();</span>
<a href="#l12.69"></a><span id="l12.69"> }</span>
<a href="#l12.70"></a><span id="l12.70"> </span>
<a href="#l12.71"></a><span id="l12.71" class="difflineminus">-function enigmailKeygenTerminate(exitCode) {</span>
<a href="#l12.72"></a><span id="l12.72" class="difflineminus">-  EnigmailLog.DEBUG(&quot;enigmailKeygen.js: Terminate:\n&quot;);</span>
<a href="#l12.73"></a><span id="l12.73" class="difflineminus">-</span>
<a href="#l12.74"></a><span id="l12.74" class="difflineminus">-  var curId = gUsedId;</span>
<a href="#l12.75"></a><span id="l12.75" class="difflineminus">-</span>
<a href="#l12.76"></a><span id="l12.76" class="difflineminus">-  gKeygenRequest = null;</span>
<a href="#l12.77"></a><span id="l12.77" class="difflineminus">-</span>
<a href="#l12.78"></a><span id="l12.78" class="difflineminus">-  if (!gGeneratedKey || gGeneratedKey == KEYGEN_CANCELLED) {</span>
<a href="#l12.79"></a><span id="l12.79" class="difflineminus">-    if (!gGeneratedKey) {</span>
<a href="#l12.80"></a><span id="l12.80" class="difflineminus">-      EnigAlert(EnigGetString(&quot;keyGenFailed&quot;));</span>
<a href="#l12.81"></a><span id="l12.81" class="difflineminus">-    }</span>
<a href="#l12.82"></a><span id="l12.82" class="difflineminus">-    return;</span>
<a href="#l12.83"></a><span id="l12.83" class="difflineminus">-  }</span>
<a href="#l12.84"></a><span id="l12.84" class="difflineminus">-</span>
<a href="#l12.85"></a><span id="l12.85" class="difflineminus">-  var progMeter = document.getElementById(&quot;keygenProgress&quot;);</span>
<a href="#l12.86"></a><span id="l12.86" class="difflineminus">-  progMeter.setAttribute(&quot;value&quot;, 100);</span>
<a href="#l12.87"></a><span id="l12.87" class="difflineminus">-</span>
<a href="#l12.88"></a><span id="l12.88" class="difflineminus">-  if (gGeneratedKey) {</span>
<a href="#l12.89"></a><span id="l12.89" class="difflineminus">-    if (gUseForSigning.checked) {</span>
<a href="#l12.90"></a><span id="l12.90" class="difflineminus">-      curId.setBoolAttribute(&quot;enablePgp&quot;, true);</span>
<a href="#l12.91"></a><span id="l12.91" class="difflineminus">-      curId.setIntAttribute(&quot;pgpKeyMode&quot;, 1);</span>
<a href="#l12.92"></a><span id="l12.92" class="difflineminus">-      curId.setCharAttribute(&quot;pgpkeyId&quot;, &quot;0x&quot; + gGeneratedKey);</span>
<a href="#l12.93"></a><span id="l12.93" class="difflineminus">-</span>
<a href="#l12.94"></a><span id="l12.94" class="difflineminus">-      EnigSavePrefs();</span>
<a href="#l12.95"></a><span id="l12.95" class="difflineminus">-</span>
<a href="#l12.96"></a><span id="l12.96" class="difflineminus">-      EnigmailWindows.keyManReloadKeys();</span>
<a href="#l12.97"></a><span id="l12.97" class="difflineminus">-</span>
<a href="#l12.98"></a><span id="l12.98" class="difflineminus">-      if (</span>
<a href="#l12.99"></a><span id="l12.99" class="difflineminus">-        EnigConfirm(</span>
<a href="#l12.100"></a><span id="l12.100" class="difflineminus">-          EnigGetString(&quot;keygenComplete&quot;, curId.email) +</span>
<a href="#l12.101"></a><span id="l12.101" class="difflineminus">-            &quot;\n\n&quot; +</span>
<a href="#l12.102"></a><span id="l12.102" class="difflineminus">-            EnigGetString(&quot;revokeCertRecommended&quot;),</span>
<a href="#l12.103"></a><span id="l12.103" class="difflineminus">-          EnigGetString(&quot;keyMan.button.generateCert&quot;)</span>
<a href="#l12.104"></a><span id="l12.104" class="difflineminus">-        )</span>
<a href="#l12.105"></a><span id="l12.105" class="difflineminus">-      ) {</span>
<a href="#l12.106"></a><span id="l12.106" class="difflineminus">-        EnigCreateRevokeCert(gGeneratedKey, curId.email, closeAndReset);</span>
<a href="#l12.107"></a><span id="l12.107" class="difflineminus">-      } else {</span>
<a href="#l12.108"></a><span id="l12.108" class="difflineminus">-        closeAndReset();</span>
<a href="#l12.109"></a><span id="l12.109" class="difflineminus">-      }</span>
<a href="#l12.110"></a><span id="l12.110" class="difflineminus">-    } else if (</span>
<a href="#l12.111"></a><span id="l12.111" class="difflineminus">-      EnigConfirm(</span>
<a href="#l12.112"></a><span id="l12.112" class="difflineminus">-        EnigGetString(&quot;genCompleteNoSign&quot;) +</span>
<a href="#l12.113"></a><span id="l12.113" class="difflineminus">-          &quot;\n\n&quot; +</span>
<a href="#l12.114"></a><span id="l12.114" class="difflineminus">-          EnigGetString(&quot;revokeCertRecommended&quot;),</span>
<a href="#l12.115"></a><span id="l12.115" class="difflineminus">-        EnigGetString(&quot;keyMan.button.generateCert&quot;)</span>
<a href="#l12.116"></a><span id="l12.116" class="difflineminus">-      )</span>
<a href="#l12.117"></a><span id="l12.117" class="difflineminus">-    ) {</span>
<a href="#l12.118"></a><span id="l12.118" class="difflineminus">-      EnigCreateRevokeCert(gGeneratedKey, curId.email, closeAndReset);</span>
<a href="#l12.119"></a><span id="l12.119" class="difflineminus">-      genAndSaveRevCert(gGeneratedKey, curId.email).then(</span>
<a href="#l12.120"></a><span id="l12.120" class="difflineminus">-        function() {</span>
<a href="#l12.121"></a><span id="l12.121" class="difflineminus">-          closeAndReset();</span>
<a href="#l12.122"></a><span id="l12.122" class="difflineminus">-        },</span>
<a href="#l12.123"></a><span id="l12.123" class="difflineminus">-        function() {</span>
<a href="#l12.124"></a><span id="l12.124" class="difflineminus">-          // do nothing</span>
<a href="#l12.125"></a><span id="l12.125" class="difflineminus">-        }</span>
<a href="#l12.126"></a><span id="l12.126" class="difflineminus">-      );</span>
<a href="#l12.127"></a><span id="l12.127" class="difflineminus">-    } else {</span>
<a href="#l12.128"></a><span id="l12.128" class="difflineminus">-      closeAndReset();</span>
<a href="#l12.129"></a><span id="l12.129" class="difflineminus">-    }</span>
<a href="#l12.130"></a><span id="l12.130" class="difflineminus">-  } else {</span>
<a href="#l12.131"></a><span id="l12.131" class="difflineminus">-    EnigAlert(EnigGetString(&quot;keyGenFailed&quot;));</span>
<a href="#l12.132"></a><span id="l12.132" class="difflineminus">-    window.close();</span>
<a href="#l12.133"></a><span id="l12.133" class="difflineminus">-  }</span>
<a href="#l12.134"></a><span id="l12.134" class="difflineminus">-}</span>
<a href="#l12.135"></a><span id="l12.135" class="difflineminus">-</span>
<a href="#l12.136"></a><span id="l12.136" class="difflineminus">-/**</span>
<a href="#l12.137"></a><span id="l12.137" class="difflineminus">- * generate and save a revokation certificate.</span>
<a href="#l12.138"></a><span id="l12.138" class="difflineminus">- *</span>
<a href="#l12.139"></a><span id="l12.139" class="difflineminus">- * return: Promise object</span>
<a href="#l12.140"></a><span id="l12.140" class="difflineminus">- */</span>
<a href="#l12.141"></a><span id="l12.141" class="difflineminus">-</span>
<a href="#l12.142"></a><span id="l12.142" class="difflineminus">-function genAndSaveRevCert(keyId, uid) {</span>
<a href="#l12.143"></a><span id="l12.143" class="difflineminus">-  EnigmailLog.DEBUG(&quot;enigmailKeygen.js: genAndSaveRevCert\n&quot;);</span>
<a href="#l12.144"></a><span id="l12.144" class="difflineminus">-  throw new Error(&quot;Not implemented&quot;);</span>
<a href="#l12.145"></a><span id="l12.145" class="difflineminus">-}</span>
<a href="#l12.146"></a><span id="l12.146" class="difflineminus">-</span>
<a href="#l12.147"></a><span id="l12.147"> /**</span>
<a href="#l12.148"></a><span id="l12.148">  *  create a copy of the revokation cert at a user defined location</span>
<a href="#l12.149"></a><span id="l12.149">  */</span>
<a href="#l12.150"></a><span id="l12.150"> function saveRevCert(inputKeyFile, keyId, uid, resolve, reject) {</span>
<a href="#l12.151"></a><span id="l12.151">   let defaultFileName = uid.replace(/[\\/&lt;&gt;]/g, &quot;&quot;);</span>
<a href="#l12.152"></a><span id="l12.152">   defaultFileName += &quot; (0x&quot; + keyId + &quot;) rev.asc&quot;;</span>
<a href="#l12.153"></a><span id="l12.153"> </span>
<a href="#l12.154"></a><span id="l12.154">   let outFile = EnigFilePicker(</span>
<a href="#l12.155"></a><span id="l12.155" class="difflineat">@@ -279,81 +222,68 @@ function enigmailKeygenStart() {</span>
<a href="#l12.156"></a><span id="l12.156"> </span>
<a href="#l12.157"></a><span id="l12.157">   var confirmMsg = EnigGetString(&quot;keyConfirm&quot;, idString);</span>
<a href="#l12.158"></a><span id="l12.158"> </span>
<a href="#l12.159"></a><span id="l12.159">   if (!EnigConfirm(confirmMsg, EnigGetString(&quot;keyMan.button.generateKey&quot;))) {</span>
<a href="#l12.160"></a><span id="l12.160">     return;</span>
<a href="#l12.161"></a><span id="l12.161">   }</span>
<a href="#l12.162"></a><span id="l12.162"> </span>
<a href="#l12.163"></a><span id="l12.163">   try {</span>
<a href="#l12.164"></a><span id="l12.164" class="difflineplus">+    let newId = null;</span>
<a href="#l12.165"></a><span id="l12.165">     const cApi = EnigmailCryptoAPI();</span>
<a href="#l12.166"></a><span id="l12.166" class="difflineminus">-    let newId = cApi.sync(</span>
<a href="#l12.167"></a><span id="l12.167" class="difflineplus">+    newId = cApi.sync(</span>
<a href="#l12.168"></a><span id="l12.168">       cApi.genKey(</span>
<a href="#l12.169"></a><span id="l12.169">         idString,</span>
<a href="#l12.170"></a><span id="l12.170">         keyType,</span>
<a href="#l12.171"></a><span id="l12.171">         keySize,</span>
<a href="#l12.172"></a><span id="l12.172">         expiryTime,</span>
<a href="#l12.173"></a><span id="l12.173">         OpenPGPMasterpass.retrieveOpenPGPPassword()</span>
<a href="#l12.174"></a><span id="l12.174">       )</span>
<a href="#l12.175"></a><span id="l12.175">     );</span>
<a href="#l12.176"></a><span id="l12.176">     console.log(&quot;created new key with id: &quot; + newId);</span>
<a href="#l12.177"></a><span id="l12.177" class="difflineplus">+    gGeneratedKey = newId;</span>
<a href="#l12.178"></a><span id="l12.178">   } catch (ex) {</span>
<a href="#l12.179"></a><span id="l12.179">     console.log(ex);</span>
<a href="#l12.180"></a><span id="l12.180">   }</span>
<a href="#l12.181"></a><span id="l12.181"> </span>
<a href="#l12.182"></a><span id="l12.182">   EnigmailWindows.keyManReloadKeys();</span>
<a href="#l12.183"></a><span id="l12.183" class="difflineplus">+</span>
<a href="#l12.184"></a><span id="l12.184" class="difflineplus">+  gKeygenRequest = null;</span>
<a href="#l12.185"></a><span id="l12.185" class="difflineplus">+</span>
<a href="#l12.186"></a><span id="l12.186" class="difflineplus">+  var progMeter = document.getElementById(&quot;keygenProgress&quot;);</span>
<a href="#l12.187"></a><span id="l12.187" class="difflineplus">+  progMeter.setAttribute(&quot;value&quot;, 100);</span>
<a href="#l12.188"></a><span id="l12.188" class="difflineplus">+</span>
<a href="#l12.189"></a><span id="l12.189" class="difflineplus">+  if (!gGeneratedKey || gGeneratedKey == KEYGEN_CANCELLED) {</span>
<a href="#l12.190"></a><span id="l12.190" class="difflineplus">+    EnigAlert(EnigGetString(&quot;keyGenFailed&quot;));</span>
<a href="#l12.191"></a><span id="l12.191" class="difflineplus">+  } else {</span>
<a href="#l12.192"></a><span id="l12.192" class="difflineplus">+    console.debug(&quot;saving new key id &quot; + gGeneratedKey);</span>
<a href="#l12.193"></a><span id="l12.193" class="difflineplus">+    curId.setCharAttribute(&quot;openpgp_key_id&quot;, gGeneratedKey);</span>
<a href="#l12.194"></a><span id="l12.194" class="difflineplus">+    EnigSavePrefs();</span>
<a href="#l12.195"></a><span id="l12.195" class="difflineplus">+  }</span>
<a href="#l12.196"></a><span id="l12.196" class="difflineplus">+</span>
<a href="#l12.197"></a><span id="l12.197">   closeAndReset();</span>
<a href="#l12.198"></a><span id="l12.198"> </span>
<a href="#l12.199"></a><span id="l12.199" class="difflineminus">-  /*</span>
<a href="#l12.200"></a><span id="l12.200" class="difflineminus">-  var proc = null;</span>
<a href="#l12.201"></a><span id="l12.201" class="difflineminus">-</span>
<a href="#l12.202"></a><span id="l12.202" class="difflineminus">-  var listener = {</span>
<a href="#l12.203"></a><span id="l12.203" class="difflineminus">-    onStartRequest: function() {},</span>
<a href="#l12.204"></a><span id="l12.204" class="difflineminus">-    onStopRequest: function(status) {</span>
<a href="#l12.205"></a><span id="l12.205" class="difflineminus">-      enigmailKeygenTerminate(status);</span>
<a href="#l12.206"></a><span id="l12.206" class="difflineminus">-    },</span>
<a href="#l12.207"></a><span id="l12.207" class="difflineminus">-    onDataAvailable: function(data) {</span>
<a href="#l12.208"></a><span id="l12.208" class="difflineminus">-      EnigmailLog.DEBUG(&quot;enigmailKeygen.js: onDataAvailable() &quot; + data + &quot;\n&quot;);</span>
<a href="#l12.209"></a><span id="l12.209" class="difflineminus">-</span>
<a href="#l12.210"></a><span id="l12.210" class="difflineminus">-      gAllData += data;</span>
<a href="#l12.211"></a><span id="l12.211" class="difflineminus">-      var keyCreatedIndex = gAllData.indexOf(&quot;[GNUPG:] KEY_CREATED&quot;);</span>
<a href="#l12.212"></a><span id="l12.212" class="difflineminus">-      if (keyCreatedIndex &gt; 0) {</span>
<a href="#l12.213"></a><span id="l12.213" class="difflineminus">-        gGeneratedKey = gAllData.substr(keyCreatedIndex);</span>
<a href="#l12.214"></a><span id="l12.214" class="difflineminus">-        gGeneratedKey = gGeneratedKey.replace(/(.*\[GNUPG:\] KEY_CREATED . )([a-fA-F0-9]+)([\n\r].*)* /{{{remove-space-between-*-and-/-to-unconfuse-syntax-highlighting-editor}}}, &quot;$2&quot;);</span>
<a href="#l12.215"></a><span id="l12.215" class="difflineminus">-        gAllData = gAllData.replace(/\[GNUPG:\] KEY_CREATED . [a-fA-F0-9]+[\n\r]/, &quot;&quot;);</span>
<a href="#l12.216"></a><span id="l12.216" class="difflineminus">-      }</span>
<a href="#l12.217"></a><span id="l12.217" class="difflineminus">-      gAllData = gAllData.replace(/[\r\n]*\[GNUPG:\] GOOD_PASSPHRASE/g, &quot;&quot;).replace(/([\r\n]*\[GNUPG:\] PROGRESS primegen )(.)( \d+ \d+)/g, &quot;$2&quot;);</span>
<a href="#l12.218"></a><span id="l12.218" class="difflineminus">-      var progMeter = document.getElementById(&quot;keygenProgress&quot;);</span>
<a href="#l12.219"></a><span id="l12.219" class="difflineminus">-      var progValue = Number(progMeter.value);</span>
<a href="#l12.220"></a><span id="l12.220" class="difflineminus">-      progValue += (1 + (100 - progValue) / 200);</span>
<a href="#l12.221"></a><span id="l12.221" class="difflineminus">-      if (progValue &gt;= 95) progValue = 10;</span>
<a href="#l12.222"></a><span id="l12.222" class="difflineminus">-      progMeter.setAttribute(&quot;value&quot;, progValue);</span>
<a href="#l12.223"></a><span id="l12.223" class="difflineminus">-    }</span>
<a href="#l12.224"></a><span id="l12.224" class="difflineminus">-  };</span>
<a href="#l12.225"></a><span id="l12.225" class="difflineminus">-</span>
<a href="#l12.226"></a><span id="l12.226" class="difflineminus">-  try {</span>
<a href="#l12.227"></a><span id="l12.227" class="difflineminus">-    gKeygenRequest = EnigmailKeyRing.generateKey(</span>
<a href="#l12.228"></a><span id="l12.228" class="difflineminus">-      EnigmailData.convertFromUnicode(userName),</span>
<a href="#l12.229"></a><span id="l12.229" class="difflineminus">-      &quot;&quot;, // user id comment</span>
<a href="#l12.230"></a><span id="l12.230" class="difflineminus">-      EnigmailData.convertFromUnicode(userEmail),</span>
<a href="#l12.231"></a><span id="l12.231" class="difflineminus">-      expiryTime,</span>
<a href="#l12.232"></a><span id="l12.232" class="difflineminus">-      keySize,</span>
<a href="#l12.233"></a><span id="l12.233" class="difflineminus">-      keyType,</span>
<a href="#l12.234"></a><span id="l12.234" class="difflineminus">-      EnigmailData.convertFromUnicode(passphrase),</span>
<a href="#l12.235"></a><span id="l12.235" class="difflineminus">-      listener);</span>
<a href="#l12.236"></a><span id="l12.236" class="difflineminus">-  } catch (ex) {</span>
<a href="#l12.237"></a><span id="l12.237" class="difflineminus">-    EnigmailLog.DEBUG(&quot;enigmailKeygen.js: generateKey() failed with &quot; + ex.toString() + &quot;\n&quot; + ex.stack + &quot;\n&quot;);</span>
<a href="#l12.238"></a><span id="l12.238" class="difflineplus">+  let rev = RNP.getNewRevocation(&quot;0x&quot; + gGeneratedKey);</span>
<a href="#l12.239"></a><span id="l12.239" class="difflineplus">+  if (!rev) {</span>
<a href="#l12.240"></a><span id="l12.240" class="difflineplus">+    throw new Error(&quot;failed to obtain revocation for key &quot; + gGeneratedKey);</span>
<a href="#l12.241"></a><span id="l12.241">   }</span>
<a href="#l12.242"></a><span id="l12.242"> </span>
<a href="#l12.243"></a><span id="l12.243" class="difflineminus">-  if (!gKeygenRequest) {</span>
<a href="#l12.244"></a><span id="l12.244" class="difflineminus">-    EnigAlert(EnigGetString(&quot;keyGenFailed&quot;));</span>
<a href="#l12.245"></a><span id="l12.245" class="difflineminus">-  }</span>
<a href="#l12.246"></a><span id="l12.246" class="difflineplus">+  let revFull =</span>
<a href="#l12.247"></a><span id="l12.247" class="difflineplus">+    revocationFilePrefix1 +</span>
<a href="#l12.248"></a><span id="l12.248" class="difflineplus">+    &quot;\n\n&quot; +</span>
<a href="#l12.249"></a><span id="l12.249" class="difflineplus">+    gGeneratedKey +</span>
<a href="#l12.250"></a><span id="l12.250" class="difflineplus">+    &quot;\n&quot; +</span>
<a href="#l12.251"></a><span id="l12.251" class="difflineplus">+    revocationFilePrefix2 +</span>
<a href="#l12.252"></a><span id="l12.252" class="difflineplus">+    rev;</span>
<a href="#l12.253"></a><span id="l12.253"> </span>
<a href="#l12.254"></a><span id="l12.254" class="difflineminus">-  EnigmailLog.WRITE(&quot;enigmailKeygen.js: Start: gKeygenRequest = &quot; + gKeygenRequest + &quot;\n&quot;);</span>
<a href="#l12.255"></a><span id="l12.255" class="difflineminus">-  */</span>
<a href="#l12.256"></a><span id="l12.256" class="difflineplus">+  let revFile = EnigmailApp.getProfileDirectory();</span>
<a href="#l12.257"></a><span id="l12.257" class="difflineplus">+  revFile.append(&quot;0x&quot; + gGeneratedKey + &quot;_rev.asc&quot;);</span>
<a href="#l12.258"></a><span id="l12.258" class="difflineplus">+</span>
<a href="#l12.259"></a><span id="l12.259" class="difflineplus">+  // create a revokation cert in the TB profile directoy</span>
<a href="#l12.260"></a><span id="l12.260" class="difflineplus">+  EnigmailFiles.writeFileContents(revFile, revFull, DEFAULT_FILE_PERMS);</span>
<a href="#l12.261"></a><span id="l12.261"> }</span>
<a href="#l12.262"></a><span id="l12.262"> </span>
<a href="#l12.263"></a><span id="l12.263"> function abortKeyGeneration() {</span>
<a href="#l12.264"></a><span id="l12.264">   gGeneratedKey = KEYGEN_CANCELLED;</span>
<a href="#l12.265"></a><span id="l12.265">   enigmailKeygenCloseRequest();</span>
<a href="#l12.266"></a><span id="l12.266"> }</span>
<a href="#l12.267"></a><span id="l12.267"> </span>
<a href="#l12.268"></a><span id="l12.268"> function enigmailKeygenCancel() {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mail/extensions/openpgp/content/ui/enigmailKeygen.xhtml</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/ui/enigmailKeygen.xhtml</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -32,20 +32,16 @@</span>
<a href="#l13.4"></a><span id="l13.4"> </span>
<a href="#l13.5"></a><span id="l13.5"> &lt;vbox class=&quot;enigmailGroupbox&quot; id=&quot;userIdBox&quot;&gt;</span>
<a href="#l13.6"></a><span id="l13.6">   &lt;hbox orient=&quot;horizontal&quot; align=&quot;center&quot;&gt;</span>
<a href="#l13.7"></a><span id="l13.7">     &lt;label value=&quot;&amp;enigmail.keyUserId.label;&quot; control=&quot;userIdentity&quot;/&gt;</span>
<a href="#l13.8"></a><span id="l13.8">     &lt;menulist id=&quot;userIdentity&quot; label=&quot;...&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l13.9"></a><span id="l13.9">       &lt;menupopup id=&quot;userIdentityPopup&quot;/&gt;</span>
<a href="#l13.10"></a><span id="l13.10">     &lt;/menulist&gt;</span>
<a href="#l13.11"></a><span id="l13.11">   &lt;/hbox&gt;</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineminus">-  &lt;checkbox id=&quot;useForSigning&quot;</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineminus">-            label=&quot;&amp;enigmail.useForSigning.label;&quot;</span>
<a href="#l13.15"></a><span id="l13.15" class="difflineminus">-            checked=&quot;true&quot; /&gt;</span>
<a href="#l13.16"></a><span id="l13.16"> &lt;/vbox&gt;</span>
<a href="#l13.17"></a><span id="l13.17"> </span>
<a href="#l13.18"></a><span id="l13.18"> </span>
<a href="#l13.19"></a><span id="l13.19"> &lt;tabbox flex=&quot;1&quot;&gt;</span>
<a href="#l13.20"></a><span id="l13.20">   &lt;tabs id=&quot;settingsTabBox&quot;&gt;</span>
<a href="#l13.21"></a><span id="l13.21">     &lt;tab id=&quot;basicTab&quot;    label=&quot;&amp;enigmail.keyGen.expiry.title;&quot;/&gt;</span>
<a href="#l13.22"></a><span id="l13.22">     &lt;tab id=&quot;advancedTab&quot; label=&quot;&amp;enigmail.advancedPrefsButton.label;&quot;/&gt;</span>
<a href="#l13.23"></a><span id="l13.23">   &lt;/tabs&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mail/extensions/openpgp/content/ui/enigmailMessengerOverlay.js</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/ui/enigmailMessengerOverlay.js</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -88,19 +88,16 @@ var EnigmailDecryption = ChromeUtils.imp</span>
<a href="#l14.4"></a><span id="l14.4">   &quot;chrome://openpgp/content/modules/decryption.jsm&quot;</span>
<a href="#l14.5"></a><span id="l14.5"> ).EnigmailDecryption;</span>
<a href="#l14.6"></a><span id="l14.6"> var EnigmailAttachment = ChromeUtils.import(</span>
<a href="#l14.7"></a><span id="l14.7">   &quot;chrome://openpgp/content/modules/attachment.jsm&quot;</span>
<a href="#l14.8"></a><span id="l14.8"> ).EnigmailAttachment;</span>
<a href="#l14.9"></a><span id="l14.9"> var EnigmailConstants = ChromeUtils.import(</span>
<a href="#l14.10"></a><span id="l14.10">   &quot;chrome://openpgp/content/modules/constants.jsm&quot;</span>
<a href="#l14.11"></a><span id="l14.11"> ).EnigmailConstants;</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-var EnigmailKeyUsability = ChromeUtils.import(</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineminus">-  &quot;chrome://openpgp/content/modules/keyUsability.jsm&quot;</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineminus">-).EnigmailKeyUsability;</span>
<a href="#l14.15"></a><span id="l14.15"> var EnigmailURIs = ChromeUtils.import(</span>
<a href="#l14.16"></a><span id="l14.16">   &quot;chrome://openpgp/content/modules/uris.jsm&quot;</span>
<a href="#l14.17"></a><span id="l14.17"> ).EnigmailURIs;</span>
<a href="#l14.18"></a><span id="l14.18"> var EnigmailProtocolHandler = ChromeUtils.import(</span>
<a href="#l14.19"></a><span id="l14.19">   &quot;chrome://openpgp/content/modules/protocolHandler.jsm&quot;</span>
<a href="#l14.20"></a><span id="l14.20"> ).EnigmailProtocolHandler;</span>
<a href="#l14.21"></a><span id="l14.21"> var EnigmailAutocrypt = ChromeUtils.import(</span>
<a href="#l14.22"></a><span id="l14.22">   &quot;chrome://openpgp/content/modules/autocrypt.jsm&quot;</span>
<a href="#l14.23"></a><span id="l14.23" class="difflineat">@@ -577,20 +574,16 @@ Enigmail.msg = {</span>
<a href="#l14.24"></a><span id="l14.24">   isAutocryptEnabled() {</span>
<a href="#l14.25"></a><span id="l14.25">     try {</span>
<a href="#l14.26"></a><span id="l14.26">       let email = EnigmailFuncs.stripEmail(</span>
<a href="#l14.27"></a><span id="l14.27">         gFolderDisplay.selectedMessage.recipients</span>
<a href="#l14.28"></a><span id="l14.28">       );</span>
<a href="#l14.29"></a><span id="l14.29">       let maybeIdent = EnigmailStdlib.getIdentityForEmail(email);</span>
<a href="#l14.30"></a><span id="l14.30"> </span>
<a href="#l14.31"></a><span id="l14.31">       if (maybeIdent &amp;&amp; maybeIdent.identity) {</span>
<a href="#l14.32"></a><span id="l14.32" class="difflineminus">-        if (!maybeIdent.identity.getBoolAttribute(&quot;enablePgp&quot;)) {</span>
<a href="#l14.33"></a><span id="l14.33" class="difflineminus">-          return false;</span>
<a href="#l14.34"></a><span id="l14.34" class="difflineminus">-        }</span>
<a href="#l14.35"></a><span id="l14.35" class="difflineminus">-</span>
<a href="#l14.36"></a><span id="l14.36">         let acct = EnigmailFuncs.getAccountForIdentity(maybeIdent.identity);</span>
<a href="#l14.37"></a><span id="l14.37">         return acct.incomingServer.getBoolValue(&quot;enableAutocrypt&quot;);</span>
<a href="#l14.38"></a><span id="l14.38">       }</span>
<a href="#l14.39"></a><span id="l14.39">     } catch (ex) {}</span>
<a href="#l14.40"></a><span id="l14.40"> </span>
<a href="#l14.41"></a><span id="l14.41">     return false;</span>
<a href="#l14.42"></a><span id="l14.42">   },</span>
<a href="#l14.43"></a><span id="l14.43"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mail/extensions/openpgp/content/ui/enigmailMsgComposeOverlay.js</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/ui/enigmailMsgComposeOverlay.js</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -1031,20 +1031,21 @@ Enigmail.msg = {</span>
<a href="#l15.4"></a><span id="l15.4">       this.attachOwnKeyObj.attachedKey &amp;&amp;</span>
<a href="#l15.5"></a><span id="l15.5">       this.attachOwnKeyObj.attachedKey != id</span>
<a href="#l15.6"></a><span id="l15.6">     ) {</span>
<a href="#l15.7"></a><span id="l15.7">       // remove attached key if user ID changed</span>
<a href="#l15.8"></a><span id="l15.8">       this.removeAttachedKey();</span>
<a href="#l15.9"></a><span id="l15.9">     }</span>
<a href="#l15.10"></a><span id="l15.10"> </span>
<a href="#l15.11"></a><span id="l15.11">     if (!this.attachOwnKeyObj.attachedKey) {</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-      var attachedObj = this.extractAndAttachKey([id], true);</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineplus">+      let hex = &quot;0x&quot; + id;</span>
<a href="#l15.14"></a><span id="l15.14" class="difflineplus">+      var attachedObj = this.extractAndAttachKey([hex], true);</span>
<a href="#l15.15"></a><span id="l15.15">       if (attachedObj) {</span>
<a href="#l15.16"></a><span id="l15.16">         this.attachOwnKeyObj.attachedObj = attachedObj;</span>
<a href="#l15.17"></a><span id="l15.17" class="difflineminus">-        this.attachOwnKeyObj.attachedKey = id;</span>
<a href="#l15.18"></a><span id="l15.18" class="difflineplus">+        this.attachOwnKeyObj.attachedKey = hex;</span>
<a href="#l15.19"></a><span id="l15.19">       }</span>
<a href="#l15.20"></a><span id="l15.20">     }</span>
<a href="#l15.21"></a><span id="l15.21">   },</span>
<a href="#l15.22"></a><span id="l15.22"> </span>
<a href="#l15.23"></a><span id="l15.23">   attachKey() {</span>
<a href="#l15.24"></a><span id="l15.24">     EnigmailLog.DEBUG(</span>
<a href="#l15.25"></a><span id="l15.25">       &quot;enigmailMsgComposeOverlay.js: Enigmail.msg.attachKey: \n&quot;</span>
<a href="#l15.26"></a><span id="l15.26">     );</span>
<a href="#l15.27"></a><span id="l15.27" class="difflineat">@@ -1068,17 +1069,17 @@ Enigmail.msg = {</span>
<a href="#l15.28"></a><span id="l15.28">         return;</span>
<a href="#l15.29"></a><span id="l15.29">       }</span>
<a href="#l15.30"></a><span id="l15.30">       this.extractAndAttachKey(resultObj.userList, true);</span>
<a href="#l15.31"></a><span id="l15.31">     } catch (ex) {</span>
<a href="#l15.32"></a><span id="l15.32">       // cancel pressed -&gt; do nothing</span>
<a href="#l15.33"></a><span id="l15.33">     }</span>
<a href="#l15.34"></a><span id="l15.34">   },</span>
<a href="#l15.35"></a><span id="l15.35"> </span>
<a href="#l15.36"></a><span id="l15.36" class="difflineminus">-  extractAndAttachKey(uid, warnOnError) {</span>
<a href="#l15.37"></a><span id="l15.37" class="difflineplus">+  extractAndAttachKey(uidArray, warnOnError) {</span>
<a href="#l15.38"></a><span id="l15.38">     EnigmailLog.DEBUG(</span>
<a href="#l15.39"></a><span id="l15.39">       &quot;enigmailMsgComposeOverlay.js: Enigmail.msg.extractAndAttachKey: \n&quot;</span>
<a href="#l15.40"></a><span id="l15.40">     );</span>
<a href="#l15.41"></a><span id="l15.41">     var enigmailSvc = EnigmailCore.getService(window);</span>
<a href="#l15.42"></a><span id="l15.42">     if (!enigmailSvc) {</span>
<a href="#l15.43"></a><span id="l15.43">       return null;</span>
<a href="#l15.44"></a><span id="l15.44">     }</span>
<a href="#l15.45"></a><span id="l15.45"> </span>
<a href="#l15.46"></a><span id="l15.46" class="difflineat">@@ -1099,33 +1100,42 @@ Enigmail.msg = {</span>
<a href="#l15.47"></a><span id="l15.47">     }</span>
<a href="#l15.48"></a><span id="l15.48">     tmpFile.append(&quot;key.asc&quot;);</span>
<a href="#l15.49"></a><span id="l15.49">     tmpFile.createUnique(Ci.nsIFile.NORMAL_FILE_TYPE, 0o600);</span>
<a href="#l15.50"></a><span id="l15.50"> </span>
<a href="#l15.51"></a><span id="l15.51">     // save file</span>
<a href="#l15.52"></a><span id="l15.52">     var exitCodeObj = {};</span>
<a href="#l15.53"></a><span id="l15.53">     var errorMsgObj = {};</span>
<a href="#l15.54"></a><span id="l15.54"> </span>
<a href="#l15.55"></a><span id="l15.55" class="difflineminus">-    EnigmailKeyRing.extractKey(false, uid, tmpFile, exitCodeObj, errorMsgObj);</span>
<a href="#l15.56"></a><span id="l15.56" class="difflineplus">+    EnigmailKeyRing.extractKey(</span>
<a href="#l15.57"></a><span id="l15.57" class="difflineplus">+      false,</span>
<a href="#l15.58"></a><span id="l15.58" class="difflineplus">+      uidArray,</span>
<a href="#l15.59"></a><span id="l15.59" class="difflineplus">+      tmpFile,</span>
<a href="#l15.60"></a><span id="l15.60" class="difflineplus">+      exitCodeObj,</span>
<a href="#l15.61"></a><span id="l15.61" class="difflineplus">+      errorMsgObj</span>
<a href="#l15.62"></a><span id="l15.62" class="difflineplus">+    );</span>
<a href="#l15.63"></a><span id="l15.63">     if (exitCodeObj.value !== 0) {</span>
<a href="#l15.64"></a><span id="l15.64">       if (warnOnError) {</span>
<a href="#l15.65"></a><span id="l15.65">         EnigmailDialog.alert(window, errorMsgObj.value);</span>
<a href="#l15.66"></a><span id="l15.66">       }</span>
<a href="#l15.67"></a><span id="l15.67">       return null;</span>
<a href="#l15.68"></a><span id="l15.68">     }</span>
<a href="#l15.69"></a><span id="l15.69"> </span>
<a href="#l15.70"></a><span id="l15.70">     // create attachment</span>
<a href="#l15.71"></a><span id="l15.71">     var ioServ = Services.io;</span>
<a href="#l15.72"></a><span id="l15.72">     var tmpFileURI = ioServ.newFileURI(tmpFile);</span>
<a href="#l15.73"></a><span id="l15.73">     var keyAttachment = Cc[</span>
<a href="#l15.74"></a><span id="l15.74">       &quot;@mozilla.org/messengercompose/attachment;1&quot;</span>
<a href="#l15.75"></a><span id="l15.75">     ].createInstance(Ci.nsIMsgAttachment);</span>
<a href="#l15.76"></a><span id="l15.76">     keyAttachment.url = tmpFileURI.spec;</span>
<a href="#l15.77"></a><span id="l15.77" class="difflineminus">-    if (uid.length == 1 &amp;&amp; uid[0].search(/^(0x)?[a-fA-F0-9]+$/) === 0) {</span>
<a href="#l15.78"></a><span id="l15.78" class="difflineminus">-      keyAttachment.name = uid[0].substr(-16, 16) + &quot;.asc&quot;;</span>
<a href="#l15.79"></a><span id="l15.79" class="difflineplus">+    if (</span>
<a href="#l15.80"></a><span id="l15.80" class="difflineplus">+      uidArray.length == 1 &amp;&amp;</span>
<a href="#l15.81"></a><span id="l15.81" class="difflineplus">+      uidArray[0].search(/^(0x)?[a-fA-F0-9]+$/) === 0</span>
<a href="#l15.82"></a><span id="l15.82" class="difflineplus">+    ) {</span>
<a href="#l15.83"></a><span id="l15.83" class="difflineplus">+      keyAttachment.name = uidArray[0].substr(-16, 16) + &quot;.asc&quot;;</span>
<a href="#l15.84"></a><span id="l15.84">       if (keyAttachment.name.search(/^0x/) &lt; 0) {</span>
<a href="#l15.85"></a><span id="l15.85">         keyAttachment.name = &quot;0x&quot; + keyAttachment.name;</span>
<a href="#l15.86"></a><span id="l15.86">       }</span>
<a href="#l15.87"></a><span id="l15.87">     } else {</span>
<a href="#l15.88"></a><span id="l15.88">       keyAttachment.name = &quot;pgpkeys.asc&quot;;</span>
<a href="#l15.89"></a><span id="l15.89">     }</span>
<a href="#l15.90"></a><span id="l15.90">     keyAttachment.temporary = true;</span>
<a href="#l15.91"></a><span id="l15.91">     keyAttachment.contentType = &quot;application/pgp-keys&quot;;</span>
<a href="#l15.92"></a><span id="l15.92" class="difflineat">@@ -1626,42 +1636,16 @@ Enigmail.msg = {</span>
<a href="#l15.93"></a><span id="l15.93"> </span>
<a href="#l15.94"></a><span id="l15.94">         if (s) s.removeAttribute(&quot;collapsed&quot;);</span>
<a href="#l15.95"></a><span id="l15.95">         if (e) e.removeAttribute(&quot;collapsed&quot;);</span>
<a href="#l15.96"></a><span id="l15.96">         if (s) s.setAttribute(&quot;collapsed&quot;, &quot;true&quot;);</span>
<a href="#l15.97"></a><span id="l15.97">         if (e) e.setAttribute(&quot;collapsed&quot;, &quot;true&quot;);</span>
<a href="#l15.98"></a><span id="l15.98">   },</span>
<a href="#l15.99"></a><span id="l15.99">   */</span>
<a href="#l15.100"></a><span id="l15.100"> </span>
<a href="#l15.101"></a><span id="l15.101" class="difflineminus">-  /**</span>
<a href="#l15.102"></a><span id="l15.102" class="difflineminus">-   * determine if own key may be attached.</span>
<a href="#l15.103"></a><span id="l15.103" class="difflineminus">-   * @result: Number:</span>
<a href="#l15.104"></a><span id="l15.104" class="difflineminus">-   *          -1: account not enabled for Enigmail</span>
<a href="#l15.105"></a><span id="l15.105" class="difflineminus">-   *           0: account enabled but key mode set to &quot;by Email address&quot;</span>
<a href="#l15.106"></a><span id="l15.106" class="difflineminus">-   *           1: account enabled; key specified</span>
<a href="#l15.107"></a><span id="l15.107" class="difflineminus">-   */</span>
<a href="#l15.108"></a><span id="l15.108" class="difflineminus">-  /*</span>
<a href="#l15.109"></a><span id="l15.109" class="difflineminus">-  allowAttachOwnKey: function() {</span>
<a href="#l15.110"></a><span id="l15.110" class="difflineminus">-</span>
<a href="#l15.111"></a><span id="l15.111" class="difflineminus">-    let allow = -1;</span>
<a href="#l15.112"></a><span id="l15.112" class="difflineminus">-</span>
<a href="#l15.113"></a><span id="l15.113" class="difflineminus">-    if (Enigmail.msg.isEnigmailEnabledForIdentity()) {</span>
<a href="#l15.114"></a><span id="l15.114" class="difflineminus">-      allow = 0;</span>
<a href="#l15.115"></a><span id="l15.115" class="difflineminus">-      if (this.identity.getIntAttribute(&quot;pgpKeyMode&quot;) &gt; 0) {</span>
<a href="#l15.116"></a><span id="l15.116" class="difflineminus">-        let keyIdValue = this.identity.getCharAttribute(&quot;pgpkeyId&quot;);</span>
<a href="#l15.117"></a><span id="l15.117" class="difflineminus">-        if (keyIdValue.search(/^ *(0x)?[0-9a-fA-F]* *$/) === 0) {</span>
<a href="#l15.118"></a><span id="l15.118" class="difflineminus">-          allow = 1;</span>
<a href="#l15.119"></a><span id="l15.119" class="difflineminus">-        }</span>
<a href="#l15.120"></a><span id="l15.120" class="difflineminus">-      }</span>
<a href="#l15.121"></a><span id="l15.121" class="difflineminus">-    }</span>
<a href="#l15.122"></a><span id="l15.122" class="difflineminus">-</span>
<a href="#l15.123"></a><span id="l15.123" class="difflineminus">-    return allow;</span>
<a href="#l15.124"></a><span id="l15.124" class="difflineminus">-  },</span>
<a href="#l15.125"></a><span id="l15.125" class="difflineminus">-  */</span>
<a href="#l15.126"></a><span id="l15.126" class="difflineminus">-</span>
<a href="#l15.127"></a><span id="l15.127">   /* check if encryption is possible (have keys for everyone or not)</span>
<a href="#l15.128"></a><span id="l15.128">    */</span>
<a href="#l15.129"></a><span id="l15.129">   determineSendFlags() {</span>
<a href="#l15.130"></a><span id="l15.130">     EnigmailLog.DEBUG(</span>
<a href="#l15.131"></a><span id="l15.131">       &quot;enigmailMsgComposeOverlay.js: Enigmail.msg.focusChange: Enigmail.msg.determineSendFlags\n&quot;</span>
<a href="#l15.132"></a><span id="l15.132">     );</span>
<a href="#l15.133"></a><span id="l15.133"> </span>
<a href="#l15.134"></a><span id="l15.134">     let detailsObj = {};</span>
<a href="#l15.135"></a><span id="l15.135" class="difflineat">@@ -1702,122 +1686,16 @@ Enigmail.msg = {</span>
<a href="#l15.136"></a><span id="l15.136">     // process and signal new resulting state</span>
<a href="#l15.137"></a><span id="l15.137">     //this.processFinalState();</span>
<a href="#l15.138"></a><span id="l15.138">     this.updateStatusBar();</span>
<a href="#l15.139"></a><span id="l15.139"> </span>
<a href="#l15.140"></a><span id="l15.140">     return detailsObj;</span>
<a href="#l15.141"></a><span id="l15.141">   },</span>
<a href="#l15.142"></a><span id="l15.142"> </span>
<a href="#l15.143"></a><span id="l15.143">   /*</span>
<a href="#l15.144"></a><span id="l15.144" class="difflineminus">-  setChecked: function(elementId, checked) {</span>
<a href="#l15.145"></a><span id="l15.145" class="difflineminus">-    let elem = document.getElementById(elementId);</span>
<a href="#l15.146"></a><span id="l15.146" class="difflineminus">-    if (elem) {</span>
<a href="#l15.147"></a><span id="l15.147" class="difflineminus">-      if (checked) {</span>
<a href="#l15.148"></a><span id="l15.148" class="difflineminus">-        elem.setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l15.149"></a><span id="l15.149" class="difflineminus">-      }</span>
<a href="#l15.150"></a><span id="l15.150" class="difflineminus">-      else</span>
<a href="#l15.151"></a><span id="l15.151" class="difflineminus">-        elem.removeAttribute(&quot;checked&quot;);</span>
<a href="#l15.152"></a><span id="l15.152" class="difflineminus">-    }</span>
<a href="#l15.153"></a><span id="l15.153" class="difflineminus">-  },</span>
<a href="#l15.154"></a><span id="l15.154" class="difflineminus">-  */</span>
<a href="#l15.155"></a><span id="l15.155" class="difflineminus">-</span>
<a href="#l15.156"></a><span id="l15.156" class="difflineminus">-  /*</span>
<a href="#l15.157"></a><span id="l15.157" class="difflineminus">-  setMenuSettings: function(postfix) {</span>
<a href="#l15.158"></a><span id="l15.158" class="difflineminus">-    EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.setMenuSettings: postfix=&quot; + postfix + &quot;\n&quot;);</span>
<a href="#l15.159"></a><span id="l15.159" class="difflineminus">-</span>
<a href="#l15.160"></a><span id="l15.160" class="difflineminus">-    let enigmailEnabled = Enigmail.msg.wasEnigmailEnabledForIdentity();</span>
<a href="#l15.161"></a><span id="l15.161" class="difflineminus">-    let smimeEnabled = Enigmail.msg.isSmimeEnabled();</span>
<a href="#l15.162"></a><span id="l15.162" class="difflineminus">-</span>
<a href="#l15.163"></a><span id="l15.163" class="difflineminus">-    const SIGN = EnigmailConstants.SEND_SIGNED;</span>
<a href="#l15.164"></a><span id="l15.164" class="difflineminus">-    const ENCRYPT = EnigmailConstants.SEND_ENCRYPTED;</span>
<a href="#l15.165"></a><span id="l15.165" class="difflineminus">-</span>
<a href="#l15.166"></a><span id="l15.166" class="difflineminus">-    var elem = document.getElementById(&quot;enigmail_compose_sign_item&quot; + postfix);</span>
<a href="#l15.167"></a><span id="l15.167" class="difflineminus">-    if (elem) {</span>
<a href="#l15.168"></a><span id="l15.168" class="difflineminus">-      elem.setAttribute(&quot;label&quot;, this.statusSignedStr);</span>
<a href="#l15.169"></a><span id="l15.169" class="difflineminus">-      switch (gSendSigned) {</span>
<a href="#l15.170"></a><span id="l15.170" class="difflineminus">-          //elem.setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l15.171"></a><span id="l15.171" class="difflineminus">-          //elem.setAttribute(&quot;checked&quot;, &quot;false&quot;);</span>
<a href="#l15.172"></a><span id="l15.172" class="difflineminus">-      }</span>
<a href="#l15.173"></a><span id="l15.173" class="difflineminus">-    }</span>
<a href="#l15.174"></a><span id="l15.174" class="difflineminus">-</span>
<a href="#l15.175"></a><span id="l15.175" class="difflineminus">-    elem = document.getElementById(&quot;enigmail_compose_encrypt_item&quot; + postfix);</span>
<a href="#l15.176"></a><span id="l15.176" class="difflineminus">-    if (elem) {</span>
<a href="#l15.177"></a><span id="l15.177" class="difflineminus">-      elem.setAttribute(&quot;label&quot;, this.statusEncryptedStr);</span>
<a href="#l15.178"></a><span id="l15.178" class="difflineminus">-      switch (gSendEncrypted) {</span>
<a href="#l15.179"></a><span id="l15.179" class="difflineminus">-          //elem.setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l15.180"></a><span id="l15.180" class="difflineminus">-          //elem.setAttribute(&quot;checked&quot;, &quot;false&quot;);</span>
<a href="#l15.181"></a><span id="l15.181" class="difflineminus">-      }</span>
<a href="#l15.182"></a><span id="l15.182" class="difflineminus">-    }</span>
<a href="#l15.183"></a><span id="l15.183" class="difflineminus">-</span>
<a href="#l15.184"></a><span id="l15.184" class="difflineminus">-    elem = document.getElementById(&quot;enigmail_compose_pgpmime_item&quot; + postfix);</span>
<a href="#l15.185"></a><span id="l15.185" class="difflineminus">-    if (elem) {</span>
<a href="#l15.186"></a><span id="l15.186" class="difflineminus">-      elem.setAttribute(&quot;label&quot;, this.statusPGPMimeStr);</span>
<a href="#l15.187"></a><span id="l15.187" class="difflineminus">-      if (enigmailEnabled) {</span>
<a href="#l15.188"></a><span id="l15.188" class="difflineminus">-        elem.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l15.189"></a><span id="l15.189" class="difflineminus">-      }</span>
<a href="#l15.190"></a><span id="l15.190" class="difflineminus">-      else {</span>
<a href="#l15.191"></a><span id="l15.191" class="difflineminus">-        elem.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l15.192"></a><span id="l15.192" class="difflineminus">-      }</span>
<a href="#l15.193"></a><span id="l15.193" class="difflineminus">-</span>
<a href="#l15.194"></a><span id="l15.194" class="difflineminus">-          //elem.setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l15.195"></a><span id="l15.195" class="difflineminus">-          //elem.setAttribute(&quot;checked&quot;, &quot;false&quot;);</span>
<a href="#l15.196"></a><span id="l15.196" class="difflineminus">-</span>
<a href="#l15.197"></a><span id="l15.197" class="difflineminus">-      elem = document.getElementById(&quot;enigmail_compose_inline_item&quot; + postfix);</span>
<a href="#l15.198"></a><span id="l15.198" class="difflineminus">-      if (elem) {</span>
<a href="#l15.199"></a><span id="l15.199" class="difflineminus">-        elem.setAttribute(&quot;label&quot;, this.statusInlinePGPStr);</span>
<a href="#l15.200"></a><span id="l15.200" class="difflineminus">-        if (enigmailEnabled) {</span>
<a href="#l15.201"></a><span id="l15.201" class="difflineminus">-          elem.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l15.202"></a><span id="l15.202" class="difflineminus">-        }</span>
<a href="#l15.203"></a><span id="l15.203" class="difflineminus">-        else {</span>
<a href="#l15.204"></a><span id="l15.204" class="difflineminus">-          elem.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l15.205"></a><span id="l15.205" class="difflineminus">-        }</span>
<a href="#l15.206"></a><span id="l15.206" class="difflineminus">-</span>
<a href="#l15.207"></a><span id="l15.207" class="difflineminus">-            //elem.setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l15.208"></a><span id="l15.208" class="difflineminus">-            //elem.setAttribute(&quot;checked&quot;, &quot;false&quot;);</span>
<a href="#l15.209"></a><span id="l15.209" class="difflineminus">-      }</span>
<a href="#l15.210"></a><span id="l15.210" class="difflineminus">-</span>
<a href="#l15.211"></a><span id="l15.211" class="difflineminus">-      elem = document.getElementById(&quot;enigmail_compose_smime_item&quot; + postfix);</span>
<a href="#l15.212"></a><span id="l15.212" class="difflineminus">-      if (elem) {</span>
<a href="#l15.213"></a><span id="l15.213" class="difflineminus">-        elem.setAttribute(&quot;label&quot;, this.statusSMimeStr);</span>
<a href="#l15.214"></a><span id="l15.214" class="difflineminus">-        if (smimeEnabled) {</span>
<a href="#l15.215"></a><span id="l15.215" class="difflineminus">-          elem.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l15.216"></a><span id="l15.216" class="difflineminus">-        }</span>
<a href="#l15.217"></a><span id="l15.217" class="difflineminus">-        else {</span>
<a href="#l15.218"></a><span id="l15.218" class="difflineminus">-          elem.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l15.219"></a><span id="l15.219" class="difflineminus">-        }</span>
<a href="#l15.220"></a><span id="l15.220" class="difflineminus">-</span>
<a href="#l15.221"></a><span id="l15.221" class="difflineminus">-            //elem.setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l15.222"></a><span id="l15.222" class="difflineminus">-            //elem.setAttribute(&quot;checked&quot;, &quot;false&quot;);</span>
<a href="#l15.223"></a><span id="l15.223" class="difflineminus">-      }</span>
<a href="#l15.224"></a><span id="l15.224" class="difflineminus">-</span>
<a href="#l15.225"></a><span id="l15.225" class="difflineminus">-      elem = document.getElementById(&quot;enigmail_insert_own_key&quot;);</span>
<a href="#l15.226"></a><span id="l15.226" class="difflineminus">-      if (elem) {</span>
<a href="#l15.227"></a><span id="l15.227" class="difflineminus">-        if (this.identity.getIntAttribute(&quot;pgpKeyMode&quot;) &gt; 0) {</span>
<a href="#l15.228"></a><span id="l15.228" class="difflineminus">-          elem.setAttribute(&quot;checked&quot;, gAttachMyPublicPGPKey.toString());</span>
<a href="#l15.229"></a><span id="l15.229" class="difflineminus">-          elem.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l15.230"></a><span id="l15.230" class="difflineminus">-        }</span>
<a href="#l15.231"></a><span id="l15.231" class="difflineminus">-        else {</span>
<a href="#l15.232"></a><span id="l15.232" class="difflineminus">-          elem.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l15.233"></a><span id="l15.233" class="difflineminus">-        }</span>
<a href="#l15.234"></a><span id="l15.234" class="difflineminus">-      }</span>
<a href="#l15.235"></a><span id="l15.235" class="difflineminus">-</span>
<a href="#l15.236"></a><span id="l15.236" class="difflineminus">-      elem = document.getElementById(&quot;enigmail_encrypt_subject&quot;);</span>
<a href="#l15.237"></a><span id="l15.237" class="difflineminus">-      if (elem) {</span>
<a href="#l15.238"></a><span id="l15.238" class="difflineminus">-        if (enigmailEnabled) {</span>
<a href="#l15.239"></a><span id="l15.239" class="difflineminus">-          elem.setAttribute(&quot;checked&quot;, this.protectHeaders ? &quot;true&quot; : &quot;false&quot;);</span>
<a href="#l15.240"></a><span id="l15.240" class="difflineminus">-          elem.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l15.241"></a><span id="l15.241" class="difflineminus">-        }</span>
<a href="#l15.242"></a><span id="l15.242" class="difflineminus">-        else {</span>
<a href="#l15.243"></a><span id="l15.243" class="difflineminus">-          elem.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l15.244"></a><span id="l15.244" class="difflineminus">-        }</span>
<a href="#l15.245"></a><span id="l15.245" class="difflineminus">-      }</span>
<a href="#l15.246"></a><span id="l15.246" class="difflineminus">-  },</span>
<a href="#l15.247"></a><span id="l15.247" class="difflineminus">-  */</span>
<a href="#l15.248"></a><span id="l15.248" class="difflineminus">-</span>
<a href="#l15.249"></a><span id="l15.249" class="difflineminus">-  /*</span>
<a href="#l15.250"></a><span id="l15.250">   displaySecuritySettings: function() {</span>
<a href="#l15.251"></a><span id="l15.251">     EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.displaySecuritySettings\n&quot;);</span>
<a href="#l15.252"></a><span id="l15.252"> </span>
<a href="#l15.253"></a><span id="l15.253">     var inputObj = {</span>
<a href="#l15.254"></a><span id="l15.254">       gSendEncrypted: gSendEncrypted,</span>
<a href="#l15.255"></a><span id="l15.255">       gSendSigned: gSendSigned,</span>
<a href="#l15.256"></a><span id="l15.256">       success: false,</span>
<a href="#l15.257"></a><span id="l15.257">       resetDefaults: false</span>
<a href="#l15.258"></a><span id="l15.258" class="difflineat">@@ -1877,56 +1755,18 @@ Enigmail.msg = {</span>
<a href="#l15.259"></a><span id="l15.259">       (gSendSigned) + </span>
<a href="#l15.260"></a><span id="l15.260">       (gAttachMyPublicPGPKey ? &quot;1&quot; : &quot;0&quot;) + (doEncrypt &amp;&amp; this.protectHeaders ? &quot;1&quot; : &quot;0&quot;);</span>
<a href="#l15.261"></a><span id="l15.261"> </span>
<a href="#l15.262"></a><span id="l15.262">     this.setAdditionalHeader(&quot;X-Enigmail-Draft-Status&quot;, draftStatus);</span>
<a href="#l15.263"></a><span id="l15.263">     */</span>
<a href="#l15.264"></a><span id="l15.264">   },</span>
<a href="#l15.265"></a><span id="l15.265"> </span>
<a href="#l15.266"></a><span id="l15.266">   getSenderUserId() {</span>
<a href="#l15.267"></a><span id="l15.267" class="difflineminus">-    var userIdValue = null;</span>
<a href="#l15.268"></a><span id="l15.268" class="difflineminus">-</span>
<a href="#l15.269"></a><span id="l15.269" class="difflineminus">-    if (this.identity.getIntAttribute(&quot;pgpKeyMode&quot;) &gt; 0) {</span>
<a href="#l15.270"></a><span id="l15.270" class="difflineminus">-      userIdValue = this.identity.getCharAttribute(&quot;pgpkeyId&quot;);</span>
<a href="#l15.271"></a><span id="l15.271" class="difflineminus">-</span>
<a href="#l15.272"></a><span id="l15.272" class="difflineminus">-      if (!userIdValue) {</span>
<a href="#l15.273"></a><span id="l15.273" class="difflineminus">-        var mesg = EnigmailLocale.getString(&quot;composeSpecifyEmail&quot;);</span>
<a href="#l15.274"></a><span id="l15.274" class="difflineminus">-</span>
<a href="#l15.275"></a><span id="l15.275" class="difflineminus">-        var valueObj = {</span>
<a href="#l15.276"></a><span id="l15.276" class="difflineminus">-          value: userIdValue,</span>
<a href="#l15.277"></a><span id="l15.277" class="difflineminus">-        };</span>
<a href="#l15.278"></a><span id="l15.278" class="difflineminus">-</span>
<a href="#l15.279"></a><span id="l15.279" class="difflineminus">-        if (EnigmailDialog.promptValue(window, mesg, valueObj)) {</span>
<a href="#l15.280"></a><span id="l15.280" class="difflineminus">-          userIdValue = valueObj.value;</span>
<a href="#l15.281"></a><span id="l15.281" class="difflineminus">-        }</span>
<a href="#l15.282"></a><span id="l15.282" class="difflineminus">-      }</span>
<a href="#l15.283"></a><span id="l15.283" class="difflineminus">-</span>
<a href="#l15.284"></a><span id="l15.284" class="difflineminus">-      if (userIdValue) {</span>
<a href="#l15.285"></a><span id="l15.285" class="difflineminus">-        this.identity.setCharAttribute(&quot;pgpkeyId&quot;, userIdValue);</span>
<a href="#l15.286"></a><span id="l15.286" class="difflineminus">-      } else {</span>
<a href="#l15.287"></a><span id="l15.287" class="difflineminus">-        this.identity.setIntAttribute(&quot;pgpKeyMode&quot;, 0);</span>
<a href="#l15.288"></a><span id="l15.288" class="difflineminus">-      }</span>
<a href="#l15.289"></a><span id="l15.289" class="difflineminus">-    }</span>
<a href="#l15.290"></a><span id="l15.290" class="difflineminus">-</span>
<a href="#l15.291"></a><span id="l15.291" class="difflineminus">-    if (typeof userIdValue != &quot;string&quot;) {</span>
<a href="#l15.292"></a><span id="l15.292" class="difflineminus">-      EnigmailLog.DEBUG(</span>
<a href="#l15.293"></a><span id="l15.293" class="difflineminus">-        &quot;enigmailMsgComposeOverlay.js: Enigmail.msg.getSenderUserId: type of userIdValue=&quot; +</span>
<a href="#l15.294"></a><span id="l15.294" class="difflineminus">-          typeof userIdValue +</span>
<a href="#l15.295"></a><span id="l15.295" class="difflineminus">-          &quot;\n&quot;</span>
<a href="#l15.296"></a><span id="l15.296" class="difflineminus">-      );</span>
<a href="#l15.297"></a><span id="l15.297" class="difflineminus">-      userIdValue = this.identity.email;</span>
<a href="#l15.298"></a><span id="l15.298" class="difflineminus">-    }</span>
<a href="#l15.299"></a><span id="l15.299" class="difflineminus">-</span>
<a href="#l15.300"></a><span id="l15.300" class="difflineminus">-    if (this.identity.getIntAttribute(&quot;pgpKeyMode&quot;) === 0) {</span>
<a href="#l15.301"></a><span id="l15.301" class="difflineminus">-      let key = EnigmailKeyRing.getSecretKeyByEmail(userIdValue);</span>
<a href="#l15.302"></a><span id="l15.302" class="difflineminus">-      if (key) {</span>
<a href="#l15.303"></a><span id="l15.303" class="difflineminus">-        userIdValue = &quot;0x&quot; + key.fpr;</span>
<a href="#l15.304"></a><span id="l15.304" class="difflineminus">-      }</span>
<a href="#l15.305"></a><span id="l15.305" class="difflineminus">-    }</span>
<a href="#l15.306"></a><span id="l15.306" class="difflineminus">-    return userIdValue;</span>
<a href="#l15.307"></a><span id="l15.307" class="difflineplus">+    let keyId = this.identity.getUnicharAttribute(&quot;openpgp_key_id&quot;);</span>
<a href="#l15.308"></a><span id="l15.308" class="difflineplus">+    return &quot;0x&quot; + keyId;</span>
<a href="#l15.309"></a><span id="l15.309">   },</span>
<a href="#l15.310"></a><span id="l15.310"> </span>
<a href="#l15.311"></a><span id="l15.311">   /* process rules and find keys for passed email addresses</span>
<a href="#l15.312"></a><span id="l15.312">    * This is THE core method to prepare sending encryptes emails.</span>
<a href="#l15.313"></a><span id="l15.313">    * - it processes the recipient rules (if not disabled)</span>
<a href="#l15.314"></a><span id="l15.314">    * - it</span>
<a href="#l15.315"></a><span id="l15.315">    *</span>
<a href="#l15.316"></a><span id="l15.316">    * @sendFlags:    Longint - all current combined/processed send flags (incl. optSendFlags)</span>
<a href="#l15.317"></a><span id="l15.317" class="difflineat">@@ -2836,17 +2676,18 @@ Enigmail.msg = {</span>
<a href="#l15.318"></a><span id="l15.318">       }</span>
<a href="#l15.319"></a><span id="l15.319"> </span>
<a href="#l15.320"></a><span id="l15.320">       sendFlags = result.sendFlags;</span>
<a href="#l15.321"></a><span id="l15.321">       let toAddrStr = result.toAddrStr;</span>
<a href="#l15.322"></a><span id="l15.322">       let bccAddrStr = result.bccAddrStr;</span>
<a href="#l15.323"></a><span id="l15.323">       let keyMap = result.keyMap;</span>
<a href="#l15.324"></a><span id="l15.324"> </span>
<a href="#l15.325"></a><span id="l15.325">       if (gAttachMyPublicPGPKey) {</span>
<a href="#l15.326"></a><span id="l15.326" class="difflineminus">-        this.attachOwnKey(rcpt.fromAddr);</span>
<a href="#l15.327"></a><span id="l15.327" class="difflineplus">+        let keyId = this.identity.getUnicharAttribute(&quot;openpgp_key_id&quot;);</span>
<a href="#l15.328"></a><span id="l15.328" class="difflineplus">+        this.attachOwnKey(keyId);</span>
<a href="#l15.329"></a><span id="l15.329">       }</span>
<a href="#l15.330"></a><span id="l15.330"> </span>
<a href="#l15.331"></a><span id="l15.331">       /*</span>
<a href="#l15.332"></a><span id="l15.332">       if (this.preferPgpOverSmime(sendFlags) === 0) {</span>
<a href="#l15.333"></a><span id="l15.333">         // use S/MIME</span>
<a href="#l15.334"></a><span id="l15.334">         Attachments2CompFields(gMsgCompose.compFields); // update list of attachments</span>
<a href="#l15.335"></a><span id="l15.335">         sendFlags = 0;</span>
<a href="#l15.336"></a><span id="l15.336">         return true;</span>
<a href="#l15.337"></a><span id="l15.337" class="difflineat">@@ -3416,49 +3257,16 @@ Enigmail.msg = {</span>
<a href="#l15.338"></a><span id="l15.338"> </span>
<a href="#l15.339"></a><span id="l15.339">   getCurrentIncomingServer() {</span>
<a href="#l15.340"></a><span id="l15.340">     let currentAccountKey = getCurrentAccountKey();</span>
<a href="#l15.341"></a><span id="l15.341">     let account = MailServices.accounts.getAccount(currentAccountKey);</span>
<a href="#l15.342"></a><span id="l15.342"> </span>
<a href="#l15.343"></a><span id="l15.343">     return account.incomingServer; /* returns nsIMsgIncomingServer */</span>
<a href="#l15.344"></a><span id="l15.344">   },</span>
<a href="#l15.345"></a><span id="l15.345"> </span>
<a href="#l15.346"></a><span id="l15.346" class="difflineminus">-  /*</span>
<a href="#l15.347"></a><span id="l15.347" class="difflineminus">-  setAutocryptHeader: function() {</span>
<a href="#l15.348"></a><span id="l15.348" class="difflineminus">-    if (!this.isAutocryptEnabled()) return;</span>
<a href="#l15.349"></a><span id="l15.349" class="difflineminus">-</span>
<a href="#l15.350"></a><span id="l15.350" class="difflineminus">-    this.identity = getCurrentIdentity();</span>
<a href="#l15.351"></a><span id="l15.351" class="difflineminus">-    let fromMail = this.identity.email;</span>
<a href="#l15.352"></a><span id="l15.352" class="difflineminus">-</span>
<a href="#l15.353"></a><span id="l15.353" class="difflineminus">-    try {</span>
<a href="#l15.354"></a><span id="l15.354" class="difflineminus">-      fromMail = EnigmailFuncs.stripEmail(gMsgCompose.compFields.from);</span>
<a href="#l15.355"></a><span id="l15.355" class="difflineminus">-    }</span>
<a href="#l15.356"></a><span id="l15.356" class="difflineminus">-    catch (ex) {}</span>
<a href="#l15.357"></a><span id="l15.357" class="difflineminus">-</span>
<a href="#l15.358"></a><span id="l15.358" class="difflineminus">-    let key;</span>
<a href="#l15.359"></a><span id="l15.359" class="difflineminus">-    if (this.identity.getIntAttribute(&quot;pgpKeyMode&quot;) &gt; 0) {</span>
<a href="#l15.360"></a><span id="l15.360" class="difflineminus">-      key = EnigmailKeyRing.getKeyById(this.identity.getCharAttribute(&quot;pgpkeyId&quot;));</span>
<a href="#l15.361"></a><span id="l15.361" class="difflineminus">-    }</span>
<a href="#l15.362"></a><span id="l15.362" class="difflineminus">-    else {</span>
<a href="#l15.363"></a><span id="l15.363" class="difflineminus">-      key = EnigmailKeyRing.getSecretKeyByEmail(this.identity.email);</span>
<a href="#l15.364"></a><span id="l15.364" class="difflineminus">-    }</span>
<a href="#l15.365"></a><span id="l15.365" class="difflineminus">-</span>
<a href="#l15.366"></a><span id="l15.366" class="difflineminus">-    if (key) {</span>
<a href="#l15.367"></a><span id="l15.367" class="difflineminus">-      let srv = this.getCurrentIncomingServer();</span>
<a href="#l15.368"></a><span id="l15.368" class="difflineminus">-      let prefMutual = (srv.getIntValue(&quot;acPreferEncrypt&quot;) &gt; 0 ? &quot;; prefer-encrypt=mutual&quot; : &quot;&quot;);</span>
<a href="#l15.369"></a><span id="l15.369" class="difflineminus">-</span>
<a href="#l15.370"></a><span id="l15.370" class="difflineminus">-      let k = key.getMinimalPubKey(fromMail);</span>
<a href="#l15.371"></a><span id="l15.371" class="difflineminus">-      if (k.exitCode === 0) {</span>
<a href="#l15.372"></a><span id="l15.372" class="difflineminus">-        let keyData = &quot; &quot; + k.keyData.replace(/(.{72})/g, &quot;$1\r\n &quot;).replace(/\r\n $/, &quot;&quot;);</span>
<a href="#l15.373"></a><span id="l15.373" class="difflineminus">-        this.setAdditionalHeader('Autocrypt', 'addr=' + fromMail + prefMutual + '; keydata=\r\n' + keyData);</span>
<a href="#l15.374"></a><span id="l15.374" class="difflineminus">-      }</span>
<a href="#l15.375"></a><span id="l15.375" class="difflineminus">-    }</span>
<a href="#l15.376"></a><span id="l15.376" class="difflineminus">-  },</span>
<a href="#l15.377"></a><span id="l15.377" class="difflineminus">-  */</span>
<a href="#l15.378"></a><span id="l15.378" class="difflineminus">-</span>
<a href="#l15.379"></a><span id="l15.379">   fromChangedListener(event) {</span>
<a href="#l15.380"></a><span id="l15.380">     EnigmailLog.DEBUG(</span>
<a href="#l15.381"></a><span id="l15.381">       &quot;enigmailMsgComposeOverlay.js: Enigmail.msg.fromChangedListener\n&quot;</span>
<a href="#l15.382"></a><span id="l15.382">     );</span>
<a href="#l15.383"></a><span id="l15.383"> </span>
<a href="#l15.384"></a><span id="l15.384">     /* TODO:</span>
<a href="#l15.385"></a><span id="l15.385">      * reset gSendSigned, gAttachMyPublicPGPKey, gSendEncrypted, gOptionalEncryption</span>
<a href="#l15.386"></a><span id="l15.386">      * to account's default setting, but only if settings haven't been touched</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:33Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

