<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 539:18acf6d3435f9bed0f91df91efbe600eb68e5ef9</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 18acf6d3435f9bed0f91df91efbe600eb68e5ef9" />
<meta property="og:url" content="/comm-central/rev/18acf6d3435f9bed0f91df91efbe600eb68e5ef9" />
<meta property="og:description" content="Bug 455728 - Consolidate sort mechanisms in different views and trees; r=berend" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 18acf6d3435f9bed0f91df91efbe600eb68e5ef9 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/18acf6d3435f9bed0f91df91efbe600eb68e5ef9">shortlog</a> |
<a href="/comm-central/log/18acf6d3435f9bed0f91df91efbe600eb68e5ef9">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/18acf6d3435f9bed0f91df91efbe600eb68e5ef9">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/18acf6d3435f9bed0f91df91efbe600eb68e5ef9">files</a> |
changeset |
<a href="/comm-central/raw-rev/18acf6d3435f9bed0f91df91efbe600eb68e5ef9">raw</a>  | <a href="/comm-central/archive/18acf6d3435f9bed0f91df91efbe600eb68e5ef9.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=455728">Bug 455728</a> - Consolidate sort mechanisms in different views and trees; r=berend
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#70;&#114;&#101;&#100;&#32;&#74;&#101;&#110;&#100;&#114;&#122;&#101;&#106;&#101;&#119;&#115;&#107;&#105;&#32;&#60;&#102;&#114;&#101;&#100;&#46;&#106;&#101;&#110;&#64;&#119;&#101;&#98;&#46;&#100;&#101;&#62;</td></tr>
<tr><td></td><td class="date age">Tue, 07 Oct 2008 10:23:37 +0200</td></tr>

<tr>
 <td>changeset 539</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/18acf6d3435f9bed0f91df91efbe600eb68e5ef9">18acf6d3435f9bed0f91df91efbe600eb68e5ef9</a></td>
</tr>



<tr>
<td>parent 538</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/67de2617c1dcd720aee30bde3cb3d8bdbb9f9efd">67de2617c1dcd720aee30bde3cb3d8bdbb9f9efd</a>
</td>
</tr>

<tr>
<td>child 540</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/02e0f61d243191d1265aa31592403b9bad7a3a7a">02e0f61d243191d1265aa31592403b9bad7a3a7a</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=18acf6d3435f9bed0f91df91efbe600eb68e5ef9">476</a></td></tr>
<tr><td>push user</td><td>Berend.Cornelius@sun.com</td></tr>
<tr><td>push date</td><td class="date age">Tue, 07 Oct 2008 08:24:07 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@18acf6d3435f [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=18acf6d3435f9bed0f91df91efbe600eb68e5ef9">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=18acf6d3435f9bed0f91df91efbe600eb68e5ef9&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=18acf6d3435f9bed0f91df91efbe600eb68e5ef9&newProject=comm-central&newRevision=18acf6d3435f9bed0f91df91efbe600eb68e5ef9&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=18acf6d3435f9bed0f91df91efbe600eb68e5ef9&newProject=comm-central&newRevision=18acf6d3435f9bed0f91df91efbe600eb68e5ef9&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=18acf6d3435f9bed0f91df91efbe600eb68e5ef9&newProject=comm-central&newRevision=18acf6d3435f9bed0f91df91efbe600eb68e5ef9&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28berend%29&revcount=50">berend</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=455728">455728</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=455728">Bug 455728</a> - Consolidate sort mechanisms in different views and trees; r=berend</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/18acf6d3435f9bed0f91df91efbe600eb68e5ef9/calendar/base/content/calendar-task-tree.xml">calendar/base/content/calendar-task-tree.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/18acf6d3435f9bed0f91df91efbe600eb68e5ef9/calendar/base/content/calendar-task-tree.xml">file</a> |
<a href="/comm-central/annotate/18acf6d3435f9bed0f91df91efbe600eb68e5ef9/calendar/base/content/calendar-task-tree.xml">annotate</a> |
<a href="/comm-central/diff/18acf6d3435f9bed0f91df91efbe600eb68e5ef9/calendar/base/content/calendar-task-tree.xml">diff</a> |
<a href="/comm-central/comparison/18acf6d3435f9bed0f91df91efbe600eb68e5ef9/calendar/base/content/calendar-task-tree.xml">comparison</a> |
<a href="/comm-central/log/18acf6d3435f9bed0f91df91efbe600eb68e5ef9/calendar/base/content/calendar-task-tree.xml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/18acf6d3435f9bed0f91df91efbe600eb68e5ef9/calendar/base/content/calendar-ui-utils.js">calendar/base/content/calendar-ui-utils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/18acf6d3435f9bed0f91df91efbe600eb68e5ef9/calendar/base/content/calendar-ui-utils.js">file</a> |
<a href="/comm-central/annotate/18acf6d3435f9bed0f91df91efbe600eb68e5ef9/calendar/base/content/calendar-ui-utils.js">annotate</a> |
<a href="/comm-central/diff/18acf6d3435f9bed0f91df91efbe600eb68e5ef9/calendar/base/content/calendar-ui-utils.js">diff</a> |
<a href="/comm-central/comparison/18acf6d3435f9bed0f91df91efbe600eb68e5ef9/calendar/base/content/calendar-ui-utils.js">comparison</a> |
<a href="/comm-central/log/18acf6d3435f9bed0f91df91efbe600eb68e5ef9/calendar/base/content/calendar-ui-utils.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/18acf6d3435f9bed0f91df91efbe600eb68e5ef9/calendar/base/content/calendar-unifinder-todo.xul">calendar/base/content/calendar-unifinder-todo.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/18acf6d3435f9bed0f91df91efbe600eb68e5ef9/calendar/base/content/calendar-unifinder-todo.xul">file</a> |
<a href="/comm-central/annotate/18acf6d3435f9bed0f91df91efbe600eb68e5ef9/calendar/base/content/calendar-unifinder-todo.xul">annotate</a> |
<a href="/comm-central/diff/18acf6d3435f9bed0f91df91efbe600eb68e5ef9/calendar/base/content/calendar-unifinder-todo.xul">diff</a> |
<a href="/comm-central/comparison/18acf6d3435f9bed0f91df91efbe600eb68e5ef9/calendar/base/content/calendar-unifinder-todo.xul">comparison</a> |
<a href="/comm-central/log/18acf6d3435f9bed0f91df91efbe600eb68e5ef9/calendar/base/content/calendar-unifinder-todo.xul">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/18acf6d3435f9bed0f91df91efbe600eb68e5ef9/calendar/base/content/calendar-unifinder.js">calendar/base/content/calendar-unifinder.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/18acf6d3435f9bed0f91df91efbe600eb68e5ef9/calendar/base/content/calendar-unifinder.js">file</a> |
<a href="/comm-central/annotate/18acf6d3435f9bed0f91df91efbe600eb68e5ef9/calendar/base/content/calendar-unifinder.js">annotate</a> |
<a href="/comm-central/diff/18acf6d3435f9bed0f91df91efbe600eb68e5ef9/calendar/base/content/calendar-unifinder.js">diff</a> |
<a href="/comm-central/comparison/18acf6d3435f9bed0f91df91efbe600eb68e5ef9/calendar/base/content/calendar-unifinder.js">comparison</a> |
<a href="/comm-central/log/18acf6d3435f9bed0f91df91efbe600eb68e5ef9/calendar/base/content/calendar-unifinder.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/18acf6d3435f9bed0f91df91efbe600eb68e5ef9/calendar/base/content/calendar-unifinder.xul">calendar/base/content/calendar-unifinder.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/18acf6d3435f9bed0f91df91efbe600eb68e5ef9/calendar/base/content/calendar-unifinder.xul">file</a> |
<a href="/comm-central/annotate/18acf6d3435f9bed0f91df91efbe600eb68e5ef9/calendar/base/content/calendar-unifinder.xul">annotate</a> |
<a href="/comm-central/diff/18acf6d3435f9bed0f91df91efbe600eb68e5ef9/calendar/base/content/calendar-unifinder.xul">diff</a> |
<a href="/comm-central/comparison/18acf6d3435f9bed0f91df91efbe600eb68e5ef9/calendar/base/content/calendar-unifinder.xul">comparison</a> |
<a href="/comm-central/log/18acf6d3435f9bed0f91df91efbe600eb68e5ef9/calendar/base/content/calendar-unifinder.xul">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/18acf6d3435f9bed0f91df91efbe600eb68e5ef9/calendar/base/content/preferences/categories.js">calendar/base/content/preferences/categories.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/18acf6d3435f9bed0f91df91efbe600eb68e5ef9/calendar/base/content/preferences/categories.js">file</a> |
<a href="/comm-central/annotate/18acf6d3435f9bed0f91df91efbe600eb68e5ef9/calendar/base/content/preferences/categories.js">annotate</a> |
<a href="/comm-central/diff/18acf6d3435f9bed0f91df91efbe600eb68e5ef9/calendar/base/content/preferences/categories.js">diff</a> |
<a href="/comm-central/comparison/18acf6d3435f9bed0f91df91efbe600eb68e5ef9/calendar/base/content/preferences/categories.js">comparison</a> |
<a href="/comm-central/log/18acf6d3435f9bed0f91df91efbe600eb68e5ef9/calendar/base/content/preferences/categories.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/18acf6d3435f9bed0f91df91efbe600eb68e5ef9/calendar/base/src/calUtils.js">calendar/base/src/calUtils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/18acf6d3435f9bed0f91df91efbe600eb68e5ef9/calendar/base/src/calUtils.js">file</a> |
<a href="/comm-central/annotate/18acf6d3435f9bed0f91df91efbe600eb68e5ef9/calendar/base/src/calUtils.js">annotate</a> |
<a href="/comm-central/diff/18acf6d3435f9bed0f91df91efbe600eb68e5ef9/calendar/base/src/calUtils.js">diff</a> |
<a href="/comm-central/comparison/18acf6d3435f9bed0f91df91efbe600eb68e5ef9/calendar/base/src/calUtils.js">comparison</a> |
<a href="/comm-central/log/18acf6d3435f9bed0f91df91efbe600eb68e5ef9/calendar/base/src/calUtils.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/18acf6d3435f9bed0f91df91efbe600eb68e5ef9/calendar/base/src/calUtils.jsm">calendar/base/src/calUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/18acf6d3435f9bed0f91df91efbe600eb68e5ef9/calendar/base/src/calUtils.jsm">file</a> |
<a href="/comm-central/annotate/18acf6d3435f9bed0f91df91efbe600eb68e5ef9/calendar/base/src/calUtils.jsm">annotate</a> |
<a href="/comm-central/diff/18acf6d3435f9bed0f91df91efbe600eb68e5ef9/calendar/base/src/calUtils.jsm">diff</a> |
<a href="/comm-central/comparison/18acf6d3435f9bed0f91df91efbe600eb68e5ef9/calendar/base/src/calUtils.jsm">comparison</a> |
<a href="/comm-central/log/18acf6d3435f9bed0f91df91efbe600eb68e5ef9/calendar/base/src/calUtils.jsm">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/calendar/base/content/calendar-task-tree.xml</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/calendar/base/content/calendar-task-tree.xml</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -66,62 +66,76 @@</span>
<a href="#l1.4"></a><span id="l1.4">                 flex=&quot;1&quot;</span>
<a href="#l1.5"></a><span id="l1.5">                 enableColumnDrag=&quot;false&quot;&gt;</span>
<a href="#l1.6"></a><span id="l1.6">         &lt;xul:treecols anonid=&quot;calendar-task-tree-cols&quot;&gt;</span>
<a href="#l1.7"></a><span id="l1.7">           &lt;xul:treecol anonid=&quot;calendar-task-tree-col-completed&quot;</span>
<a href="#l1.8"></a><span id="l1.8">                        class=&quot;calendar-task-tree-col-completed&quot; </span>
<a href="#l1.9"></a><span id="l1.9">                        minwidth=&quot;19&quot;</span>
<a href="#l1.10"></a><span id="l1.10">                        fixed=&quot;true&quot;</span>
<a href="#l1.11"></a><span id="l1.11">                        cycler=&quot;true&quot;</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+                       sortKey=&quot;completedDate&quot;</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+                       itemproperty=&quot;completed&quot;</span>
<a href="#l1.14"></a><span id="l1.14">                        label=&quot;&amp;calendar.unifinder.tree.done.label;&quot;&gt;</span>
<a href="#l1.15"></a><span id="l1.15">             &lt;xul:image anonid=&quot;checkboximg&quot; /&gt;</span>
<a href="#l1.16"></a><span id="l1.16">           &lt;/xul:treecol&gt;</span>
<a href="#l1.17"></a><span id="l1.17">           &lt;xul:splitter class=&quot;tree-splitter&quot; ordinal=&quot;2&quot;/&gt;</span>
<a href="#l1.18"></a><span id="l1.18">           &lt;xul:treecol anonid=&quot;calendar-task-tree-col-priority&quot;</span>
<a href="#l1.19"></a><span id="l1.19">                        class=&quot;calendar-task-tree-col-priority&quot;</span>
<a href="#l1.20"></a><span id="l1.20">                        minwidth=&quot;17&quot;</span>
<a href="#l1.21"></a><span id="l1.21">                        fixed=&quot;true&quot;</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineplus">+                       itemproperty=&quot;priority&quot;</span>
<a href="#l1.23"></a><span id="l1.23">                        label=&quot;&amp;calendar.unifinder.tree.priority.label;&quot;&gt;</span>
<a href="#l1.24"></a><span id="l1.24">             &lt;xul:image anonid=&quot;priorityimg&quot;/&gt;</span>
<a href="#l1.25"></a><span id="l1.25">           &lt;/xul:treecol&gt;</span>
<a href="#l1.26"></a><span id="l1.26">           &lt;xul:splitter class=&quot;tree-splitter&quot; ordinal=&quot;4&quot;/&gt;</span>
<a href="#l1.27"></a><span id="l1.27">           &lt;xul:treecol anonid=&quot;calendar-task-tree-col-title&quot;</span>
<a href="#l1.28"></a><span id="l1.28">                        flex=&quot;1&quot; </span>
<a href="#l1.29"></a><span id="l1.29" class="difflineplus">+                       itemproperty=&quot;title&quot;</span>
<a href="#l1.30"></a><span id="l1.30">                        label=&quot;&amp;calendar.unifinder.tree.title.label;&quot;/&gt;</span>
<a href="#l1.31"></a><span id="l1.31">           &lt;xul:splitter class=&quot;tree-splitter&quot; ordinal=&quot;6&quot;/&gt;</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineminus">-          &lt;xul:treecol anonid=&quot;calendar-task-tree-col-startdate&quot;</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineplus">+          &lt;xul:treecol anonid=&quot;calendar-task-tree-col-entrydate&quot;</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineplus">+                       itemproperty=&quot;entryDate&quot;</span>
<a href="#l1.35"></a><span id="l1.35">                        flex=&quot;1&quot; label=&quot;&amp;calendar.unifinder.tree.startdate.label;&quot;/&gt;</span>
<a href="#l1.36"></a><span id="l1.36">           &lt;xul:splitter class=&quot;tree-splitter&quot; ordinal=&quot;8&quot;/&gt;</span>
<a href="#l1.37"></a><span id="l1.37">           &lt;xul:treecol anonid=&quot;calendar-task-tree-col-duedate&quot;</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineplus">+                       itemproperty=&quot;dueDate&quot;</span>
<a href="#l1.39"></a><span id="l1.39">                        flex=&quot;1&quot; label=&quot;&amp;calendar.unifinder.tree.duedate.label;&quot;/&gt;</span>
<a href="#l1.40"></a><span id="l1.40">           &lt;xul:splitter class=&quot;tree-splitter&quot; ordinal=&quot;10&quot;/&gt;</span>
<a href="#l1.41"></a><span id="l1.41">           &lt;xul:treecol anonid=&quot;calendar-task-tree-col-duration&quot;</span>
<a href="#l1.42"></a><span id="l1.42" class="difflineplus">+                       sortKey=&quot;dueDate&quot;</span>
<a href="#l1.43"></a><span id="l1.43" class="difflineplus">+                       itemproperty=&quot;duration&quot;</span>
<a href="#l1.44"></a><span id="l1.44">                        flex=&quot;1&quot; label=&quot;&amp;calendar.unifinder.tree.duration.label;&quot;/&gt;</span>
<a href="#l1.45"></a><span id="l1.45">           &lt;xul:splitter class=&quot;tree-splitter&quot; ordinal=&quot;12&quot;/&gt;</span>
<a href="#l1.46"></a><span id="l1.46">           &lt;xul:treecol anonid=&quot;calendar-task-tree-col-completeddate&quot;</span>
<a href="#l1.47"></a><span id="l1.47" class="difflineplus">+                       itemproperty=&quot;completedDate&quot;</span>
<a href="#l1.48"></a><span id="l1.48">                        flex=&quot;1&quot; label=&quot;&amp;calendar.unifinder.tree.completeddate.label;&quot;/&gt;</span>
<a href="#l1.49"></a><span id="l1.49">           &lt;xul:splitter class=&quot;tree-splitter&quot; ordinal=&quot;14&quot;/&gt;</span>
<a href="#l1.50"></a><span id="l1.50">           &lt;xul:treecol anonid=&quot;calendar-task-tree-col-percentcomplete&quot;</span>
<a href="#l1.51"></a><span id="l1.51">                        flex=&quot;1&quot;</span>
<a href="#l1.52"></a><span id="l1.52">                        type=&quot;progressmeter&quot;</span>
<a href="#l1.53"></a><span id="l1.53">                        minwidth=&quot;19&quot;</span>
<a href="#l1.54"></a><span id="l1.54" class="difflineplus">+                       itemproperty=&quot;percentComplete&quot;</span>
<a href="#l1.55"></a><span id="l1.55">                        label=&quot;&amp;calendar.unifinder.tree.percentcomplete.label;&quot;/&gt;</span>
<a href="#l1.56"></a><span id="l1.56">           &lt;xul:splitter class=&quot;tree-splitter&quot; ordinal=&quot;16&quot;/&gt;</span>
<a href="#l1.57"></a><span id="l1.57">           &lt;xul:treecol anonid=&quot;calendar-task-tree-col-categories&quot;</span>
<a href="#l1.58"></a><span id="l1.58" class="difflineplus">+                       itemproperty=&quot;categories&quot;</span>
<a href="#l1.59"></a><span id="l1.59">                        flex=&quot;1&quot; label=&quot;&amp;calendar.unifinder.tree.categories.label;&quot;/&gt;</span>
<a href="#l1.60"></a><span id="l1.60">           &lt;xul:splitter class=&quot;tree-splitter&quot; ordinal=&quot;18&quot;/&gt;</span>
<a href="#l1.61"></a><span id="l1.61">           &lt;xul:treecol anonid=&quot;calendar-task-tree-col-location&quot;</span>
<a href="#l1.62"></a><span id="l1.62" class="difflineplus">+                       itemproperty=&quot;location&quot;</span>
<a href="#l1.63"></a><span id="l1.63">                        label=&quot;&amp;calendar.unifinder.tree.location.label;&quot;/&gt;</span>
<a href="#l1.64"></a><span id="l1.64">           &lt;xul:splitter class=&quot;tree-splitter&quot; ordinal=&quot;20&quot;/&gt;</span>
<a href="#l1.65"></a><span id="l1.65">           &lt;xul:treecol anonid=&quot;calendar-task-tree-col-status&quot;</span>
<a href="#l1.66"></a><span id="l1.66">                        flex=&quot;1&quot;</span>
<a href="#l1.67"></a><span id="l1.67" class="difflineplus">+                       itemproperty=&quot;status&quot;</span>
<a href="#l1.68"></a><span id="l1.68">                        label=&quot;&amp;calendar.unifinder.tree.status.label;&quot;/&gt;</span>
<a href="#l1.69"></a><span id="l1.69">           &lt;xul:splitter class=&quot;tree-splitter&quot; ordinal=&quot;22&quot;/&gt;</span>
<a href="#l1.70"></a><span id="l1.70">           &lt;xul:treecol anonid=&quot;calendar-task-tree-col-calendarname&quot;</span>
<a href="#l1.71"></a><span id="l1.71">                        flex=&quot;1&quot;</span>
<a href="#l1.72"></a><span id="l1.72" class="difflineplus">+                       itemproperty=&quot;calendar&quot;</span>
<a href="#l1.73"></a><span id="l1.73">                        label=&quot;&amp;calendar.unifinder.tree.calendarname.label;&quot;/&gt;</span>
<a href="#l1.74"></a><span id="l1.74">         &lt;/xul:treecols&gt;</span>
<a href="#l1.75"></a><span id="l1.75">         &lt;xul:treechildren tooltip=&quot;taskTreeTooltip&quot;/&gt;</span>
<a href="#l1.76"></a><span id="l1.76">       &lt;/xul:tree&gt;</span>
<a href="#l1.77"></a><span id="l1.77">     &lt;/content&gt;</span>
<a href="#l1.78"></a><span id="l1.78"> </span>
<a href="#l1.79"></a><span id="l1.79">     &lt;implementation&gt;</span>
<a href="#l1.80"></a><span id="l1.80">       </span>
<a href="#l1.81"></a><span id="l1.81" class="difflineat">@@ -238,17 +252,16 @@</span>
<a href="#l1.82"></a><span id="l1.82">                       // Less than one hour</span>
<a href="#l1.83"></a><span id="l1.83">                       return calGetString(&quot;calendar&quot;, &quot;dueInLessThanOneHour&quot;);</span>
<a href="#l1.84"></a><span id="l1.84">                   }</span>
<a href="#l1.85"></a><span id="l1.85">               }    </span>
<a href="#l1.86"></a><span id="l1.86">           }</span>
<a href="#l1.87"></a><span id="l1.87">           return null;</span>
<a href="#l1.88"></a><span id="l1.88">         ]]&gt;&lt;/body&gt;</span>
<a href="#l1.89"></a><span id="l1.89">       &lt;/method&gt;</span>
<a href="#l1.90"></a><span id="l1.90" class="difflineminus">-</span>
<a href="#l1.91"></a><span id="l1.91">       &lt;method name=&quot;getTaskAtRow&quot;&gt;</span>
<a href="#l1.92"></a><span id="l1.92">         &lt;parameter name=&quot;aRow&quot;/&gt;</span>
<a href="#l1.93"></a><span id="l1.93">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l1.94"></a><span id="l1.94">           return (aRow &gt; -1 ? this.mTaskArray[aRow] : null);</span>
<a href="#l1.95"></a><span id="l1.95">         ]]&gt;&lt;/body&gt;</span>
<a href="#l1.96"></a><span id="l1.96">       &lt;/method&gt;</span>
<a href="#l1.97"></a><span id="l1.97"> </span>
<a href="#l1.98"></a><span id="l1.98">       &lt;method name=&quot;getTaskFromEvent&quot;&gt;</span>
<a href="#l1.99"></a><span id="l1.99" class="difflineat">@@ -263,61 +276,85 @@</span>
<a href="#l1.100"></a><span id="l1.100">           /**</span>
<a href="#l1.101"></a><span id="l1.101">            * Attributes</span>
<a href="#l1.102"></a><span id="l1.102">            */</span>
<a href="#l1.103"></a><span id="l1.103"> </span>
<a href="#l1.104"></a><span id="l1.104">           // back reference to the binding</span>
<a href="#l1.105"></a><span id="l1.105">           binding: this,</span>
<a href="#l1.106"></a><span id="l1.106">           tree: null,</span>
<a href="#l1.107"></a><span id="l1.107">           treebox: null,</span>
<a href="#l1.108"></a><span id="l1.108" class="difflineminus">-          selectedColumn: null,</span>
<a href="#l1.109"></a><span id="l1.109" class="difflineplus">+          mSelectedColumn: null,</span>
<a href="#l1.110"></a><span id="l1.110">           sortDirection: null,</span>
<a href="#l1.111"></a><span id="l1.111" class="difflineminus">-          </span>
<a href="#l1.112"></a><span id="l1.112" class="difflineminus">-          // updated just before sort</span>
<a href="#l1.113"></a><span id="l1.113" class="difflineminus">-          sortStartedTime: now(),</span>
<a href="#l1.114"></a><span id="l1.114" class="difflineplus">+</span>
<a href="#l1.115"></a><span id="l1.115" class="difflineplus">+          get selectedColumn tTV_getSelectedColumn() {</span>
<a href="#l1.116"></a><span id="l1.116" class="difflineplus">+              return this.mSelectedColumn;</span>
<a href="#l1.117"></a><span id="l1.117" class="difflineplus">+          },</span>
<a href="#l1.118"></a><span id="l1.118" class="difflineplus">+</span>
<a href="#l1.119"></a><span id="l1.119" class="difflineplus">+          set selectedColumn tTV_setSelectedColumn(aCol) {</span>
<a href="#l1.120"></a><span id="l1.120" class="difflineplus">+              var tree = document.getAnonymousNodes(this.binding)[0];</span>
<a href="#l1.121"></a><span id="l1.121" class="difflineplus">+              var treecols = tree.getElementsByTagNameNS(tree.namespaceURI, &quot;treecol&quot;);</span>
<a href="#l1.122"></a><span id="l1.122" class="difflineplus">+              for (var i = 0; i &lt; treecols.length; i++) {</span>
<a href="#l1.123"></a><span id="l1.123" class="difflineplus">+                  var col = treecols[i];</span>
<a href="#l1.124"></a><span id="l1.124" class="difflineplus">+                  if (col.getAttribute(&quot;sortActive&quot;)) {</span>
<a href="#l1.125"></a><span id="l1.125" class="difflineplus">+                      col.removeAttribute(&quot;sortActive&quot;);</span>
<a href="#l1.126"></a><span id="l1.126" class="difflineplus">+                      col.removeAttribute(&quot;sortDirection&quot;);</span>
<a href="#l1.127"></a><span id="l1.127" class="difflineplus">+                  }</span>
<a href="#l1.128"></a><span id="l1.128" class="difflineplus">+                  if (aCol.getAttribute(&quot;itemproperty&quot;) == col.getAttribute(&quot;itemproperty&quot;)) {</span>
<a href="#l1.129"></a><span id="l1.129" class="difflineplus">+                      col.setAttribute(&quot;sortActive&quot;, &quot;true&quot;);</span>
<a href="#l1.130"></a><span id="l1.130" class="difflineplus">+                      col.setAttribute(&quot;sortDirection&quot;, this.sortDirection);</span>
<a href="#l1.131"></a><span id="l1.131" class="difflineplus">+                  }</span>
<a href="#l1.132"></a><span id="l1.132" class="difflineplus">+              }</span>
<a href="#l1.133"></a><span id="l1.133" class="difflineplus">+              return (this.mSelectedColumn = aCol);</span>
<a href="#l1.134"></a><span id="l1.134" class="difflineplus">+          }, </span>
<a href="#l1.135"></a><span id="l1.135"> </span>
<a href="#l1.136"></a><span id="l1.136">           /**</span>
<a href="#l1.137"></a><span id="l1.137">            * High-level task tree manipulation</span>
<a href="#l1.138"></a><span id="l1.138">            */</span>
<a href="#l1.139"></a><span id="l1.139"> </span>
<a href="#l1.140"></a><span id="l1.140" class="difflineminus">-          addItem: function tTV_addItem(aItem) {</span>
<a href="#l1.141"></a><span id="l1.141" class="difflineplus">+          addItem: function tTV_addItem(aItem, aDontSort) {</span>
<a href="#l1.142"></a><span id="l1.142">               if (aItem.isCompleted &amp;&amp; !this.binding.showCompleted) {</span>
<a href="#l1.143"></a><span id="l1.143">                   return;</span>
<a href="#l1.144"></a><span id="l1.144">               }</span>
<a href="#l1.145"></a><span id="l1.145">               var index = this.binding.mHash2Index[aItem.hashId];</span>
<a href="#l1.146"></a><span id="l1.146">               if (index === undefined) {</span>
<a href="#l1.147"></a><span id="l1.147">                   var index = this.binding.mTaskArray.length;</span>
<a href="#l1.148"></a><span id="l1.148">                   this.binding.mTaskArray.push(aItem);</span>
<a href="#l1.149"></a><span id="l1.149">                   this.binding.mHash2Index[aItem.hashId] = index;</span>
<a href="#l1.150"></a><span id="l1.150">                   // The rowCountChanged function takes two arguments, the index where the</span>
<a href="#l1.151"></a><span id="l1.151">                   // first row was inserted and the number of rows to insert.</span>
<a href="#l1.152"></a><span id="l1.152">                   this.treebox.rowCountChanged(index, 1);</span>
<a href="#l1.153"></a><span id="l1.153">                   this.tree.view.selection.select(index);</span>
<a href="#l1.154"></a><span id="l1.154">               }</span>
<a href="#l1.155"></a><span id="l1.155">               this.treebox.ensureRowIsVisible(this.rowCount - 1);</span>
<a href="#l1.156"></a><span id="l1.156" class="difflineplus">+</span>
<a href="#l1.157"></a><span id="l1.157" class="difflineplus">+              if(aDontSort) {</span>
<a href="#l1.158"></a><span id="l1.158" class="difflineplus">+                this.binding.recreateHashTable();</span>
<a href="#l1.159"></a><span id="l1.159" class="difflineplus">+              } else {</span>
<a href="#l1.160"></a><span id="l1.160" class="difflineplus">+                this.binding.sortItems();</span>
<a href="#l1.161"></a><span id="l1.161" class="difflineplus">+              }</span>
<a href="#l1.162"></a><span id="l1.162">           },</span>
<a href="#l1.163"></a><span id="l1.163"> </span>
<a href="#l1.164"></a><span id="l1.164" class="difflineminus">-          removeItem: function tTV_removeItem(aItem) {</span>
<a href="#l1.165"></a><span id="l1.165" class="difflineplus">+          removeItem: function tTV_removeItem(aItem, aDontSort) {</span>
<a href="#l1.166"></a><span id="l1.166">               var index = this.binding.mHash2Index[aItem.hashId];</span>
<a href="#l1.167"></a><span id="l1.167">               if (index != undefined) {</span>
<a href="#l1.168"></a><span id="l1.168">                   delete this.binding.mHash2Index[aItem.hashId];</span>
<a href="#l1.169"></a><span id="l1.169">                   this.binding.mTaskArray.splice(index, 1);</span>
<a href="#l1.170"></a><span id="l1.170">                   this.treebox.rowCountChanged(index, -1);</span>
<a href="#l1.171"></a><span id="l1.171"> </span>
<a href="#l1.172"></a><span id="l1.172">                   if (index == this.rowCount) {</span>
<a href="#l1.173"></a><span id="l1.173">                       index--;</span>
<a href="#l1.174"></a><span id="l1.174">                   }</span>
<a href="#l1.175"></a><span id="l1.175"> </span>
<a href="#l1.176"></a><span id="l1.176">                   this.tree.view.selection.select(index);</span>
<a href="#l1.177"></a><span id="l1.177">                   </span>
<a href="#l1.178"></a><span id="l1.178">                   this.binding.recreateHashTable();</span>
<a href="#l1.179"></a><span id="l1.179">               }</span>
<a href="#l1.180"></a><span id="l1.180">           },</span>
<a href="#l1.181"></a><span id="l1.181"> </span>
<a href="#l1.182"></a><span id="l1.182" class="difflineminus">-          modifyItem: function tTV_modifyItem(aNewItem, aOldItem) {</span>
<a href="#l1.183"></a><span id="l1.183" class="difflineplus">+           modifyItem: function tTV_modifyItem(aNewItem, aOldItem, aDontSort) {</span>
<a href="#l1.184"></a><span id="l1.184">               var index = this.binding.mHash2Index[aOldItem.hashId];</span>
<a href="#l1.185"></a><span id="l1.185">               if (index != undefined) {</span>
<a href="#l1.186"></a><span id="l1.186">                   // if a filter is installed we need to make sure that</span>
<a href="#l1.187"></a><span id="l1.187">                   // the item still belongs to the set of valid items before</span>
<a href="#l1.188"></a><span id="l1.188">                   // moving forward. if the filter cuts this item off, we</span>
<a href="#l1.189"></a><span id="l1.189">                   // need to act accordingly.</span>
<a href="#l1.190"></a><span id="l1.190">                   if (this.binding.mFilterFunction &amp;&amp;</span>
<a href="#l1.191"></a><span id="l1.191">                       !this.binding.mFilterFunction(aNewItem)) {</span>
<a href="#l1.192"></a><span id="l1.192" class="difflineat">@@ -331,17 +368,22 @@</span>
<a href="#l1.193"></a><span id="l1.193">                           this.removeItem(aNewItem);</span>
<a href="#l1.194"></a><span id="l1.194">                           return;</span>
<a href="#l1.195"></a><span id="l1.195">                       }</span>
<a href="#l1.196"></a><span id="l1.196">                   }</span>
<a href="#l1.197"></a><span id="l1.197">                   delete this.binding.mHash2Index[aOldItem.hashId];</span>
<a href="#l1.198"></a><span id="l1.198">                   this.binding.mHash2Index[aNewItem.hashId] = index;</span>
<a href="#l1.199"></a><span id="l1.199">                   this.binding.mTaskArray[index] = aNewItem;</span>
<a href="#l1.200"></a><span id="l1.200">                   this.tree.view.selection.select(index);</span>
<a href="#l1.201"></a><span id="l1.201" class="difflineminus">-                  this.treebox.invalidateRow(index);</span>
<a href="#l1.202"></a><span id="l1.202" class="difflineplus">+</span>
<a href="#l1.203"></a><span id="l1.203" class="difflineplus">+                  if(aDontSort) { </span>
<a href="#l1.204"></a><span id="l1.204" class="difflineplus">+                      this.treebox.invalidateRow(index);</span>
<a href="#l1.205"></a><span id="l1.205" class="difflineplus">+                  } else {</span>
<a href="#l1.206"></a><span id="l1.206" class="difflineplus">+                      this.binding.sortItems();</span>
<a href="#l1.207"></a><span id="l1.207" class="difflineplus">+                  }</span>
<a href="#l1.208"></a><span id="l1.208">               }</span>
<a href="#l1.209"></a><span id="l1.209">           },</span>
<a href="#l1.210"></a><span id="l1.210"> </span>
<a href="#l1.211"></a><span id="l1.211">           clear: function tTV_clear() {</span>
<a href="#l1.212"></a><span id="l1.212">               var count = this.binding.mTaskArray.length;</span>
<a href="#l1.213"></a><span id="l1.213">               if (count &gt; 0) {</span>
<a href="#l1.214"></a><span id="l1.214">                   this.binding.mTaskArray = [];</span>
<a href="#l1.215"></a><span id="l1.215">                   this.binding.mHash2Index = {};</span>
<a href="#l1.216"></a><span id="l1.216" class="difflineat">@@ -416,101 +458,84 @@</span>
<a href="#l1.217"></a><span id="l1.217"> </span>
<a href="#l1.218"></a><span id="l1.218">           // Called on the view when a cell in a non-selectable cycling</span>
<a href="#l1.219"></a><span id="l1.219">           // column (e.g., unread/flag/etc.) is clicked.</span>
<a href="#l1.220"></a><span id="l1.220">           cycleCell: function mTV_cycleCell(aRow, aCol) {</span>
<a href="#l1.221"></a><span id="l1.221">               var task = this.binding.mTaskArray[aRow];</span>
<a href="#l1.222"></a><span id="l1.222">               if(!task)</span>
<a href="#l1.223"></a><span id="l1.223">                   return;</span>
<a href="#l1.224"></a><span id="l1.224">               if (aCol != null) {</span>
<a href="#l1.225"></a><span id="l1.225" class="difflineminus">-                  var anonid = aCol.element.getAttribute(&quot;anonid&quot;);</span>
<a href="#l1.226"></a><span id="l1.226" class="difflineminus">-                  if (anonid == &quot;calendar-task-tree-col-completed&quot;)  {</span>
<a href="#l1.227"></a><span id="l1.227" class="difflineplus">+                  var content = aCol.element.getAttribute(&quot;itemproperty&quot;);</span>
<a href="#l1.228"></a><span id="l1.228" class="difflineplus">+                  if (content == &quot;completed&quot;)  {</span>
<a href="#l1.229"></a><span id="l1.229">                       var newTask = task.clone().QueryInterface(Components.interfaces.calITodo);</span>
<a href="#l1.230"></a><span id="l1.230">                       newTask.isCompleted = !task.completedDate;</span>
<a href="#l1.231"></a><span id="l1.231">                       doTransaction('modify', newTask, newTask.calendar, task, null);</span>
<a href="#l1.232"></a><span id="l1.232">                   }</span>
<a href="#l1.233"></a><span id="l1.233">               }</span>
<a href="#l1.234"></a><span id="l1.234">           },</span>
<a href="#l1.235"></a><span id="l1.235"> </span>
<a href="#l1.236"></a><span id="l1.236">           // Called on the view when a header is clicked.</span>
<a href="#l1.237"></a><span id="l1.237">           cycleHeader: function mTV_cycleHeader(aCol) {</span>
<a href="#l1.238"></a><span id="l1.238" class="difflineminus">-              var element = aCol.element;</span>
<a href="#l1.239"></a><span id="l1.239" class="difflineminus">-              var sortActive = element.getAttribute(&quot;sortActive&quot;);</span>
<a href="#l1.240"></a><span id="l1.240" class="difflineminus">-              this.selectedColumn = element.getAttribute(&quot;anonid&quot;);  </span>
<a href="#l1.241"></a><span id="l1.241" class="difflineminus">-              this.sortDirection = element.getAttribute(&quot;sortDirection&quot;);</span>
<a href="#l1.242"></a><span id="l1.242" class="difflineminus">-</span>
<a href="#l1.243"></a><span id="l1.243" class="difflineminus">-              var treeCols;</span>
<a href="#l1.244"></a><span id="l1.244" class="difflineminus">-              if (sortActive != &quot;true&quot;) {</span>
<a href="#l1.245"></a><span id="l1.245" class="difflineminus">-                  var tree = document.getAnonymousNodes(this.binding)[0];</span>
<a href="#l1.246"></a><span id="l1.246" class="difflineminus">-                  var treecols = tree.getElementsByTagNameNS(tree.namespaceURI, &quot;treecol&quot;);</span>
<a href="#l1.247"></a><span id="l1.247" class="difflineminus">-                  for (var i = 0; i &lt; treecols.length; i++) {</span>
<a href="#l1.248"></a><span id="l1.248" class="difflineminus">-                      treecols[i].removeAttribute(&quot;sortActive&quot;);</span>
<a href="#l1.249"></a><span id="l1.249" class="difflineminus">-                      treecols[i].removeAttribute(&quot;sortDirection&quot;);</span>
<a href="#l1.250"></a><span id="l1.250" class="difflineminus">-                  }</span>
<a href="#l1.251"></a><span id="l1.251" class="difflineminus">-                  sortActive = true;</span>
<a href="#l1.252"></a><span id="l1.252" class="difflineplus">+              if (!this.selectedColumn) {</span>
<a href="#l1.253"></a><span id="l1.253">                   this.sortDirection = &quot;ascending&quot;;</span>
<a href="#l1.254"></a><span id="l1.254">               }</span>
<a href="#l1.255"></a><span id="l1.255">               else {</span>
<a href="#l1.256"></a><span id="l1.256" class="difflineminus">-                  sortActive = true;</span>
<a href="#l1.257"></a><span id="l1.257" class="difflineminus">-                  if(this.sortDirection == &quot;&quot; || this.sortDirection == &quot;descending&quot;) {</span>
<a href="#l1.258"></a><span id="l1.258" class="difflineplus">+                  if(!this.sortDirection || this.sortDirection == &quot;descending&quot;) {</span>
<a href="#l1.259"></a><span id="l1.259">                       this.sortDirection = &quot;ascending&quot;;</span>
<a href="#l1.260"></a><span id="l1.260">                   } else {</span>
<a href="#l1.261"></a><span id="l1.261">                       this.sortDirection = &quot;descending&quot;;</span>
<a href="#l1.262"></a><span id="l1.262">                   }</span>
<a href="#l1.263"></a><span id="l1.263">               }</span>
<a href="#l1.264"></a><span id="l1.264" class="difflineminus">-              element.setAttribute(&quot;sortActive&quot;, sortActive);</span>
<a href="#l1.265"></a><span id="l1.265" class="difflineminus">-              element.setAttribute(&quot;sortDirection&quot;, this.sortDirection);</span>
<a href="#l1.266"></a><span id="l1.266" class="difflineminus">-              this.sortStartedTime = now(); // for null dates during sort</span>
<a href="#l1.267"></a><span id="l1.267" class="difflineminus">-              this.binding.sortTaskArray();</span>
<a href="#l1.268"></a><span id="l1.268" class="difflineminus">-              this.binding.recreateHashTable();</span>
<a href="#l1.269"></a><span id="l1.269" class="difflineplus">+              this.selectedColumn = aCol.element;</span>
<a href="#l1.270"></a><span id="l1.270" class="difflineplus">+              this.binding.sortItems();</span>
<a href="#l1.271"></a><span id="l1.271">           },</span>
<a href="#l1.272"></a><span id="l1.272">           </span>
<a href="#l1.273"></a><span id="l1.273">           // The text for a given cell. If a column consists only of an</span>
<a href="#l1.274"></a><span id="l1.274">           // image, then the empty string is returned.</span>
<a href="#l1.275"></a><span id="l1.275">           getCellText: function mTV_getCellText(aRow, aCol) {</span>
<a href="#l1.276"></a><span id="l1.276">               var task = this.binding.mTaskArray[aRow];</span>
<a href="#l1.277"></a><span id="l1.277">               if (!task)</span>
<a href="#l1.278"></a><span id="l1.278">                   return false;</span>
<a href="#l1.279"></a><span id="l1.279" class="difflineminus">-              switch (aCol.element.getAttribute(&quot;anonid&quot;)) {</span>
<a href="#l1.280"></a><span id="l1.280" class="difflineminus">-                  case &quot;calendar-task-tree-col-title&quot;:</span>
<a href="#l1.281"></a><span id="l1.281" class="difflineplus">+              switch (aCol.element.getAttribute(&quot;itemproperty&quot;)) {</span>
<a href="#l1.282"></a><span id="l1.282" class="difflineplus">+                  case &quot;title&quot;:</span>
<a href="#l1.283"></a><span id="l1.283">                       // return title, or &quot;Untitled&quot; if empty/null</span>
<a href="#l1.284"></a><span id="l1.284">                       return task.title || calGetString(&quot;calendar&quot;, &quot;eventUntitled&quot;);</span>
<a href="#l1.285"></a><span id="l1.285" class="difflineminus">-                  case &quot;calendar-task-tree-col-startdate&quot;:</span>
<a href="#l1.286"></a><span id="l1.286" class="difflineplus">+                  case &quot;entryDate&quot;:</span>
<a href="#l1.287"></a><span id="l1.287">                       return this._formatDateTime(task.entryDate);</span>
<a href="#l1.288"></a><span id="l1.288" class="difflineminus">-                  case &quot;calendar-task-tree-col-duedate&quot;:</span>
<a href="#l1.289"></a><span id="l1.289" class="difflineplus">+                  case &quot;dueDate&quot;:</span>
<a href="#l1.290"></a><span id="l1.290">                       return this._formatDateTime(task.dueDate);</span>
<a href="#l1.291"></a><span id="l1.291" class="difflineminus">-                  case &quot;calendar-task-tree-col-completeddate&quot;:</span>
<a href="#l1.292"></a><span id="l1.292" class="difflineplus">+                  case &quot;completedDate&quot;:</span>
<a href="#l1.293"></a><span id="l1.293">                       return this._formatDateTime(task.completedDate);</span>
<a href="#l1.294"></a><span id="l1.294" class="difflineminus">-                  case &quot;calendar-task-tree-col-percentcomplete&quot;:</span>
<a href="#l1.295"></a><span id="l1.295" class="difflineplus">+                  case &quot;percentComplete&quot;:</span>
<a href="#l1.296"></a><span id="l1.296">                       return (task.percentComplete &gt; 0 ? task.percentComplete + &quot;%&quot; : &quot;&quot;);</span>
<a href="#l1.297"></a><span id="l1.297" class="difflineminus">-                  case &quot;calendar-task-tree-col-categories&quot;:</span>
<a href="#l1.298"></a><span id="l1.298" class="difflineplus">+                  case &quot;categories&quot;:</span>
<a href="#l1.299"></a><span id="l1.299">                       return task.getCategories({}).join(&quot;, &quot;); // TODO l10n-unfriendly</span>
<a href="#l1.300"></a><span id="l1.300" class="difflineminus">-                  case &quot;calendar-task-tree-col-location&quot;:</span>
<a href="#l1.301"></a><span id="l1.301" class="difflineplus">+                  case &quot;location&quot;:</span>
<a href="#l1.302"></a><span id="l1.302">                       return task.getProperty(&quot;LOCATION&quot;);</span>
<a href="#l1.303"></a><span id="l1.303" class="difflineminus">-                  case &quot;calendar-task-tree-col-status&quot;:</span>
<a href="#l1.304"></a><span id="l1.304" class="difflineplus">+                  case &quot;status&quot;:</span>
<a href="#l1.305"></a><span id="l1.305">                       return getToDoStatusString(task);</span>
<a href="#l1.306"></a><span id="l1.306" class="difflineminus">-                  case &quot;calendar-task-tree-col-calendarname&quot;:</span>
<a href="#l1.307"></a><span id="l1.307" class="difflineplus">+                  case &quot;calendar&quot;:</span>
<a href="#l1.308"></a><span id="l1.308">                       return task.calendar.name;</span>
<a href="#l1.309"></a><span id="l1.309" class="difflineminus">-                  case &quot;calendar-task-tree-col-duration&quot;:</span>
<a href="#l1.310"></a><span id="l1.310" class="difflineplus">+                  case &quot;duration&quot;:</span>
<a href="#l1.311"></a><span id="l1.311">                       return this.binding.duration(task);</span>
<a href="#l1.312"></a><span id="l1.312" class="difflineminus">-                  case &quot;calendar-task-tree-col-completed&quot;:</span>
<a href="#l1.313"></a><span id="l1.313" class="difflineminus">-                  case &quot;calendar-task-tree-col-priority&quot;:</span>
<a href="#l1.314"></a><span id="l1.314" class="difflineplus">+                  case &quot;completed&quot;:</span>
<a href="#l1.315"></a><span id="l1.315" class="difflineplus">+                  case &quot;priority&quot;:</span>
<a href="#l1.316"></a><span id="l1.316">                   default:</span>
<a href="#l1.317"></a><span id="l1.317">                       return &quot;&quot;;</span>
<a href="#l1.318"></a><span id="l1.318">               }</span>
<a href="#l1.319"></a><span id="l1.319">           },</span>
<a href="#l1.320"></a><span id="l1.320">           </span>
<a href="#l1.321"></a><span id="l1.321">           // This method is only called for columns of type other than text.</span>
<a href="#l1.322"></a><span id="l1.322">           getCellValue: function mTV_getCellValue(aRow, aCol) {</span>
<a href="#l1.323"></a><span id="l1.323">               var task = this.binding.mTaskArray[aRow];</span>
<a href="#l1.324"></a><span id="l1.324">               if (!task) {</span>
<a href="#l1.325"></a><span id="l1.325">                   return null;</span>
<a href="#l1.326"></a><span id="l1.326">               }</span>
<a href="#l1.327"></a><span id="l1.327" class="difflineminus">-              switch (aCol.element.getAttribute(&quot;anonid&quot;)) {</span>
<a href="#l1.328"></a><span id="l1.328" class="difflineminus">-                  case &quot;calendar-task-tree-col-percentcomplete&quot;:</span>
<a href="#l1.329"></a><span id="l1.329" class="difflineplus">+              switch (aCol.element.getAttribute(&quot;itemproperty&quot;)) {</span>
<a href="#l1.330"></a><span id="l1.330" class="difflineplus">+                  case &quot;percentComplete&quot;:</span>
<a href="#l1.331"></a><span id="l1.331">                       return task.percentComplete;</span>
<a href="#l1.332"></a><span id="l1.332">               }</span>
<a href="#l1.333"></a><span id="l1.333">               return null;</span>
<a href="#l1.334"></a><span id="l1.334">           },</span>
<a href="#l1.335"></a><span id="l1.335"> </span>
<a href="#l1.336"></a><span id="l1.336">           // SetCellValue is called when the value of the cell has been set by the user.</span>
<a href="#l1.337"></a><span id="l1.337">           // This method is only called for columns of type other than text.</span>
<a href="#l1.338"></a><span id="l1.338">           setCellValue: function mTV_setCellValue(aRow, aCol, aValue) {</span>
<a href="#l1.339"></a><span id="l1.339" class="difflineat">@@ -583,18 +608,18 @@</span>
<a href="#l1.340"></a><span id="l1.340">           // will be used.</span>
<a href="#l1.341"></a><span id="l1.341">           getImgSrc: function mTV_getImgSrc(aRow, aCol) {</span>
<a href="#l1.342"></a><span id="l1.342">               return null;</span>
<a href="#l1.343"></a><span id="l1.343">           },</span>
<a href="#l1.344"></a><span id="l1.344"> </span>
<a href="#l1.345"></a><span id="l1.345">           // The progress mode for a given cell. This method is only called for</span>
<a href="#l1.346"></a><span id="l1.346">           // columns of type |progressmeter|.</span>
<a href="#l1.347"></a><span id="l1.347">           getProgressMode: function mTV_getProgressMode(aRow, aCol) {</span>
<a href="#l1.348"></a><span id="l1.348" class="difflineminus">-              switch(aCol.element.getAttribute(&quot;anonid&quot;)) {</span>
<a href="#l1.349"></a><span id="l1.349" class="difflineminus">-                  case &quot;calendar-task-tree-col-percentcomplete&quot;:</span>
<a href="#l1.350"></a><span id="l1.350" class="difflineplus">+              switch(aCol.element.getAttribute(&quot;itemproperty&quot;)) {</span>
<a href="#l1.351"></a><span id="l1.351" class="difflineplus">+                  case &quot;percentcomplete&quot;:</span>
<a href="#l1.352"></a><span id="l1.352">                       var task = this.binding.mTaskArray[aRow];</span>
<a href="#l1.353"></a><span id="l1.353">                       if (aCol.element.boxObject.width &gt; 75 &amp;&amp; </span>
<a href="#l1.354"></a><span id="l1.354">                           task.percentComplete &gt; 0 ) {</span>
<a href="#l1.355"></a><span id="l1.355">                           // XXX Would be nice if we could use relative widths,</span>
<a href="#l1.356"></a><span id="l1.356">                           // i.e &quot;15ex&quot;, but there is no scriptable interface.</span>
<a href="#l1.357"></a><span id="l1.357">                           return Components.interfaces.nsITreeView.PROGRESS_NORMAL;</span>
<a href="#l1.358"></a><span id="l1.358">                       }</span>
<a href="#l1.359"></a><span id="l1.359">                       break;</span>
<a href="#l1.360"></a><span id="l1.360" class="difflineat">@@ -608,18 +633,18 @@</span>
<a href="#l1.361"></a><span id="l1.361">            */</span>
<a href="#l1.362"></a><span id="l1.362">           onSelect: function tTV_onSelect(event) {},</span>
<a href="#l1.363"></a><span id="l1.363"> </span>
<a href="#l1.364"></a><span id="l1.364">           onDoubleClick: function tTV_onDoubleClick(event) {</span>
<a href="#l1.365"></a><span id="l1.365">               if (event.button == 0) {</span>
<a href="#l1.366"></a><span id="l1.366">                   var col = {};</span>
<a href="#l1.367"></a><span id="l1.367">                   var item = this._getItemFromEvent(event, col);</span>
<a href="#l1.368"></a><span id="l1.368">                   if (item) {</span>
<a href="#l1.369"></a><span id="l1.369" class="difflineminus">-                      var colAnonId = col.value.element.getAttribute(&quot;anonid&quot;);</span>
<a href="#l1.370"></a><span id="l1.370" class="difflineminus">-                      if (colAnonId == &quot;calendar-task-tree-col-completed&quot;) {</span>
<a href="#l1.371"></a><span id="l1.371" class="difflineplus">+                      var colAnonId = col.value.element.getAttribute(&quot;itemproperty&quot;);</span>
<a href="#l1.372"></a><span id="l1.372" class="difflineplus">+                      if (colAnonId == &quot;completed&quot;) {</span>
<a href="#l1.373"></a><span id="l1.373">                           // item holds checkbox state toggled by first click,</span>
<a href="#l1.374"></a><span id="l1.374">                           // so don't call modifyEventWithDialog</span>
<a href="#l1.375"></a><span id="l1.375">                           // to make sure user notices state changed.</span>
<a href="#l1.376"></a><span id="l1.376">                       } else {</span>
<a href="#l1.377"></a><span id="l1.377">                           modifyEventWithDialog(item, null, true);</span>
<a href="#l1.378"></a><span id="l1.378">                       }</span>
<a href="#l1.379"></a><span id="l1.379">                   } else {</span>
<a href="#l1.380"></a><span id="l1.380">                       createTodoWithDialog();</span>
<a href="#l1.381"></a><span id="l1.381" class="difflineat">@@ -634,17 +659,17 @@</span>
<a href="#l1.382"></a><span id="l1.382">                       document.popupNode = this.binding;</span>
<a href="#l1.383"></a><span id="l1.383">                       document.getElementById('calendar_delete_todo_command').doCommand();</span>
<a href="#l1.384"></a><span id="l1.384">                       event.preventDefault();</span>
<a href="#l1.385"></a><span id="l1.385">                       event.stopPropagation();</span>
<a href="#l1.386"></a><span id="l1.386">                       break;</span>
<a href="#l1.387"></a><span id="l1.387">                   case kKE.DOM_VK_SPACE:</span>
<a href="#l1.388"></a><span id="l1.388">                       if (this.tree.currentIndex &gt; -1) {</span>
<a href="#l1.389"></a><span id="l1.389">                           var col = document.getAnonymousElementByAttribute(</span>
<a href="#l1.390"></a><span id="l1.390" class="difflineminus">-                              this.binding, &quot;anonid&quot;, &quot;calendar-task-tree-col-completed&quot;);</span>
<a href="#l1.391"></a><span id="l1.391" class="difflineplus">+                              this.binding, &quot;itemproperty&quot;, &quot;completed&quot;);</span>
<a href="#l1.392"></a><span id="l1.392">                           this.cycleCell(</span>
<a href="#l1.393"></a><span id="l1.393">                               this.tree.currentIndex,</span>
<a href="#l1.394"></a><span id="l1.394">                               { element: col });</span>
<a href="#l1.395"></a><span id="l1.395">                       }</span>
<a href="#l1.396"></a><span id="l1.396">                       break;</span>
<a href="#l1.397"></a><span id="l1.397">                   case kKE.DOM_VK_RETURN:</span>
<a href="#l1.398"></a><span id="l1.398">                       var index = this.tree.currentIndex;</span>
<a href="#l1.399"></a><span id="l1.399">                       if (index &gt; -1) {</span>
<a href="#l1.400"></a><span id="l1.400" class="difflineat">@@ -725,16 +750,17 @@</span>
<a href="#l1.401"></a><span id="l1.401">           </span>
<a href="#l1.402"></a><span id="l1.402">           onLoad: function tTO_onLoad() {</span>
<a href="#l1.403"></a><span id="l1.403">               if (!this.mInBatch) {</span>
<a href="#l1.404"></a><span id="l1.404">                   this.binding.refresh();</span>
<a href="#l1.405"></a><span id="l1.405">               }</span>
<a href="#l1.406"></a><span id="l1.406">           },</span>
<a href="#l1.407"></a><span id="l1.407">           </span>
<a href="#l1.408"></a><span id="l1.408">           onAddItem: function tTO_onAddItem(aItem) {</span>
<a href="#l1.409"></a><span id="l1.409" class="difflineplus">+              // XXX: we have to use a filter here</span>
<a href="#l1.410"></a><span id="l1.410">               if (isToDo(aItem) &amp;&amp; !this.mInBatch) {</span>
<a href="#l1.411"></a><span id="l1.411">                   this.binding.mTreeView.addItem(aItem);</span>
<a href="#l1.412"></a><span id="l1.412">               }</span>
<a href="#l1.413"></a><span id="l1.413">           },</span>
<a href="#l1.414"></a><span id="l1.414">           </span>
<a href="#l1.415"></a><span id="l1.415">           onModifyItem: function tTO_onModifyItem(aNewItem, aOldItem) {</span>
<a href="#l1.416"></a><span id="l1.416">               if ((isToDo(aNewItem) || isToDo(aOldItem)) &amp;&amp;</span>
<a href="#l1.417"></a><span id="l1.417">                   !this.mInBatch) {</span>
<a href="#l1.418"></a><span id="l1.418" class="difflineat">@@ -807,42 +833,40 @@</span>
<a href="#l1.419"></a><span id="l1.419">         // we want to make several attributes on the column</span>
<a href="#l1.420"></a><span id="l1.420">         // elements persistent, but unfortunately there's no</span>
<a href="#l1.421"></a><span id="l1.421">         // relyable way with the 'persist' feature.</span>
<a href="#l1.422"></a><span id="l1.422">         // that's why we need to store the necessary bits and</span>
<a href="#l1.423"></a><span id="l1.423">         // pieces at the element this binding is attached to.</span>
<a href="#l1.424"></a><span id="l1.424">         var names = this.getAttribute(&quot;visible-columns&quot;).split(' ');</span>
<a href="#l1.425"></a><span id="l1.425">         var ordinals = this.getAttribute(&quot;ordinals&quot;).split(' ');</span>
<a href="#l1.426"></a><span id="l1.426">         var widths = this.getAttribute(&quot;widths&quot;).split(' ');</span>
<a href="#l1.427"></a><span id="l1.427" class="difflineminus">-        var sortActive = this.getAttribute(&quot;sort-active&quot;);</span>
<a href="#l1.428"></a><span id="l1.428" class="difflineplus">+        var sorted = this.getAttribute(&quot;sort-active&quot;);</span>
<a href="#l1.429"></a><span id="l1.429">         var sortDirection = this.getAttribute(&quot;sort-direction&quot;) || &quot;ascending&quot;;</span>
<a href="#l1.430"></a><span id="l1.430">         var tree = document.getAnonymousNodes(this)[0];</span>
<a href="#l1.431"></a><span id="l1.431">         var treecols = tree.getElementsByTagNameNS(tree.namespaceURI, &quot;treecol&quot;);</span>
<a href="#l1.432"></a><span id="l1.432">         for (var i = 0; i &lt; treecols.length; i++) {</span>
<a href="#l1.433"></a><span id="l1.433" class="difflineminus">-            var anonid = treecols[i].getAttribute(&quot;anonid&quot;);</span>
<a href="#l1.434"></a><span id="l1.434" class="difflineplus">+            var content = treecols[i].getAttribute(&quot;itemproperty&quot;); </span>
<a href="#l1.435"></a><span id="l1.435">             if (names.some(</span>
<a href="#l1.436"></a><span id="l1.436">                 function(element) {</span>
<a href="#l1.437"></a><span id="l1.437" class="difflineminus">-                    var pos = anonid.length - element.length;</span>
<a href="#l1.438"></a><span id="l1.438" class="difflineminus">-                    return (anonid.indexOf(element) == pos);</span>
<a href="#l1.439"></a><span id="l1.439" class="difflineplus">+                    return (element == content);</span>
<a href="#l1.440"></a><span id="l1.440">                 })) {</span>
<a href="#l1.441"></a><span id="l1.441">                 treecols[i].removeAttribute(&quot;hidden&quot;);</span>
<a href="#l1.442"></a><span id="l1.442">             } else {</span>
<a href="#l1.443"></a><span id="l1.443">                 treecols[i].setAttribute(&quot;hidden&quot;,&quot;true&quot;);</span>
<a href="#l1.444"></a><span id="l1.444">             }</span>
<a href="#l1.445"></a><span id="l1.445">             if (ordinals &amp;&amp; ordinals.length &gt; 0) {</span>
<a href="#l1.446"></a><span id="l1.446">                treecols[i].ordinal = Number(ordinals.shift());</span>
<a href="#l1.447"></a><span id="l1.447">             }</span>
<a href="#l1.448"></a><span id="l1.448">             if (widths &amp;&amp; widths.length &gt; 0) {</span>
<a href="#l1.449"></a><span id="l1.449">                treecols[i].width = Number(widths.shift());</span>
<a href="#l1.450"></a><span id="l1.450">             }</span>
<a href="#l1.451"></a><span id="l1.451" class="difflineminus">-            if (sortActive &amp;&amp; sortActive.length &gt; 0) {</span>
<a href="#l1.452"></a><span id="l1.452" class="difflineminus">-                var pos = anonid.length - sortActive.length;</span>
<a href="#l1.453"></a><span id="l1.453" class="difflineminus">-                if (anonid.indexOf(sortActive) == pos) {</span>
<a href="#l1.454"></a><span id="l1.454" class="difflineminus">-                    treecols[i].setAttribute(&quot;sortActive&quot;, &quot;true&quot;);</span>
<a href="#l1.455"></a><span id="l1.455" class="difflineminus">-                    treecols[i].setAttribute(&quot;sortDirection&quot;, sortDirection);</span>
<a href="#l1.456"></a><span id="l1.456" class="difflineplus">+            if (sorted &amp;&amp; sorted.length &gt; 0) {</span>
<a href="#l1.457"></a><span id="l1.457" class="difflineplus">+                if (sorted == content) {</span>
<a href="#l1.458"></a><span id="l1.458" class="difflineplus">+                    this.mTreeView.sortDirection = sortDirection;</span>
<a href="#l1.459"></a><span id="l1.459" class="difflineplus">+                    this.mTreeView.selectedColumn = treecols[i];</span>
<a href="#l1.460"></a><span id="l1.460">                 }</span>
<a href="#l1.461"></a><span id="l1.461">             }</span>
<a href="#l1.462"></a><span id="l1.462">         }</span>
<a href="#l1.463"></a><span id="l1.463">       ]]&gt;&lt;/constructor&gt;</span>
<a href="#l1.464"></a><span id="l1.464"> </span>
<a href="#l1.465"></a><span id="l1.465">       &lt;method name=&quot;onLoad&quot;&gt;</span>
<a href="#l1.466"></a><span id="l1.466">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l1.467"></a><span id="l1.467">           if (!this.mLoadCount++) {</span>
<a href="#l1.468"></a><span id="l1.468" class="difflineat">@@ -864,46 +888,37 @@</span>
<a href="#l1.469"></a><span id="l1.469">           if (!--this.mLoadCount) {</span>
<a href="#l1.470"></a><span id="l1.470">               // remove out calendar event observer</span>
<a href="#l1.471"></a><span id="l1.471">               var composite = getCompositeCalendar();</span>
<a href="#l1.472"></a><span id="l1.472">               composite.removeObserver(this.mTaskTreeObserver);</span>
<a href="#l1.473"></a><span id="l1.473">               </span>
<a href="#l1.474"></a><span id="l1.474">               var widths = &quot;&quot;;</span>
<a href="#l1.475"></a><span id="l1.475">               var ordinals = &quot;&quot;;</span>
<a href="#l1.476"></a><span id="l1.476">               var visible = &quot;&quot;;</span>
<a href="#l1.477"></a><span id="l1.477" class="difflineminus">-              var sortActive = null;</span>
<a href="#l1.478"></a><span id="l1.478" class="difflineminus">-              var sortDirection = null;</span>
<a href="#l1.479"></a><span id="l1.479" class="difflineplus">+              var sorted = this.mTreeView.selectedColumn;</span>
<a href="#l1.480"></a><span id="l1.480">               var tree = document.getAnonymousNodes(this)[0];</span>
<a href="#l1.481"></a><span id="l1.481">               var treecols = tree.getElementsByTagNameNS(tree.namespaceURI, &quot;treecol&quot;);</span>
<a href="#l1.482"></a><span id="l1.482">               for (var i = 0; i &lt; treecols.length; i++) {</span>
<a href="#l1.483"></a><span id="l1.483">                   if (treecols[i].getAttribute(&quot;hidden&quot;) != &quot;true&quot;) {</span>
<a href="#l1.484"></a><span id="l1.484" class="difflineminus">-                    var anonid = treecols[i].getAttribute(&quot;anonid&quot;);</span>
<a href="#l1.485"></a><span id="l1.485" class="difflineminus">-                    anonid = anonid.substr(anonid.lastIndexOf(&quot;-&quot;)+1);</span>
<a href="#l1.486"></a><span id="l1.486" class="difflineminus">-                    visible += (visible.length &gt; 0) ? &quot; &quot;+anonid : anonid;</span>
<a href="#l1.487"></a><span id="l1.487" class="difflineplus">+                    var content = treecols[i].getAttribute(&quot;itemproperty&quot;);</span>
<a href="#l1.488"></a><span id="l1.488" class="difflineplus">+                    visible += (visible.length &gt; 0) ? &quot; &quot;+content : content;</span>
<a href="#l1.489"></a><span id="l1.489">                   }</span>
<a href="#l1.490"></a><span id="l1.490">                   if(ordinals.length &gt; 0)</span>
<a href="#l1.491"></a><span id="l1.491">                       ordinals += &quot; &quot;;</span>
<a href="#l1.492"></a><span id="l1.492">                   ordinals += treecols[i].ordinal;</span>
<a href="#l1.493"></a><span id="l1.493">                   if(widths.length &gt; 0)</span>
<a href="#l1.494"></a><span id="l1.494">                       widths += &quot; &quot;;</span>
<a href="#l1.495"></a><span id="l1.495">                   widths += treecols[i].width || 0;</span>
<a href="#l1.496"></a><span id="l1.496" class="difflineminus">-</span>
<a href="#l1.497"></a><span id="l1.497" class="difflineminus">-                  if (treecols[i].getAttribute(&quot;sortActive&quot;) == &quot;true&quot;) {</span>
<a href="#l1.498"></a><span id="l1.498" class="difflineminus">-                    sortActive = treecols[i].getAttribute(&quot;anonid&quot;);</span>
<a href="#l1.499"></a><span id="l1.499" class="difflineminus">-                    sortActive = sortActive.substr(sortActive.lastIndexOf(&quot;-&quot;)+1);</span>
<a href="#l1.500"></a><span id="l1.500" class="difflineminus">-                    sortDirection = treecols[i].getAttribute(&quot;sortDirection&quot;);</span>
<a href="#l1.501"></a><span id="l1.501" class="difflineminus">-                  }</span>
<a href="#l1.502"></a><span id="l1.502" class="difflineminus">-</span>
<a href="#l1.503"></a><span id="l1.503">               }</span>
<a href="#l1.504"></a><span id="l1.504">               this.setAttribute(&quot;visible-columns&quot;,visible);</span>
<a href="#l1.505"></a><span id="l1.505">               this.setAttribute(&quot;ordinals&quot;,ordinals);</span>
<a href="#l1.506"></a><span id="l1.506">               this.setAttribute(&quot;widths&quot;,widths);</span>
<a href="#l1.507"></a><span id="l1.507" class="difflineminus">-              if (sortActive) {</span>
<a href="#l1.508"></a><span id="l1.508" class="difflineminus">-                  this.setAttribute(&quot;sort-active&quot;,sortActive);</span>
<a href="#l1.509"></a><span id="l1.509" class="difflineminus">-                  this.setAttribute(&quot;sort-direction&quot;,sortDirection);</span>
<a href="#l1.510"></a><span id="l1.510" class="difflineplus">+              if (sorted) {</span>
<a href="#l1.511"></a><span id="l1.511" class="difflineplus">+                  this.setAttribute(&quot;sort-active&quot;,sorted.getAttribute(&quot;itemproperty&quot;));</span>
<a href="#l1.512"></a><span id="l1.512" class="difflineplus">+                  this.setAttribute(&quot;sort-direction&quot;,this.mTreeView.sortDirection);</span>
<a href="#l1.513"></a><span id="l1.513">               } else {</span>
<a href="#l1.514"></a><span id="l1.514">                   this.removeAttribute(&quot;sort-active&quot;);</span>
<a href="#l1.515"></a><span id="l1.515">                   this.removeAttribute(&quot;sort-direction&quot;);</span>
<a href="#l1.516"></a><span id="l1.516">               }</span>
<a href="#l1.517"></a><span id="l1.517">           }</span>
<a href="#l1.518"></a><span id="l1.518">         ]]&gt;&lt;/body&gt;</span>
<a href="#l1.519"></a><span id="l1.519">       &lt;/method&gt;</span>
<a href="#l1.520"></a><span id="l1.520"> </span>
<a href="#l1.521"></a><span id="l1.521" class="difflineat">@@ -1037,132 +1052,61 @@</span>
<a href="#l1.522"></a><span id="l1.522">           // signal that the current operation finished.</span>
<a href="#l1.523"></a><span id="l1.523">           this.mPendingRefresh = null;</span>
<a href="#l1.524"></a><span id="l1.524">         </span>
<a href="#l1.525"></a><span id="l1.525">           // immediately start the next job on the queue.</span>
<a href="#l1.526"></a><span id="l1.526">           this.popRefreshQueue();</span>
<a href="#l1.527"></a><span id="l1.527">         </span>
<a href="#l1.528"></a><span id="l1.528">           this.mTreeView.rowCount = this.mTaskArray.length;</span>
<a href="#l1.529"></a><span id="l1.529">           var tree = document.getAnonymousNodes(this)[0];</span>
<a href="#l1.530"></a><span id="l1.530" class="difflineminus">-          var treecols = tree.getElementsByTagNameNS(tree.namespaceURI, &quot;treecol&quot;);</span>
<a href="#l1.531"></a><span id="l1.531" class="difflineminus">-          for (var i = 0; i &lt; treecols.length; i++) {</span>
<a href="#l1.532"></a><span id="l1.532" class="difflineminus">-            if (treecols[i].getAttribute(&quot;sortActive&quot;) == &quot;true&quot;) {</span>
<a href="#l1.533"></a><span id="l1.533" class="difflineminus">-               this.mTreeView.selectedColumn = treecols[i].getAttribute(&quot;anonid&quot;);</span>
<a href="#l1.534"></a><span id="l1.534" class="difflineminus">-               this.mTreeView.sortDirection = treecols[i].getAttribute(&quot;sortDirection&quot;);</span>
<a href="#l1.535"></a><span id="l1.535" class="difflineminus">-               this.mTreeView.sortStartedTime = now(); //for null/0 dates</span>
<a href="#l1.536"></a><span id="l1.536" class="difflineminus">-               this.sortTaskArray();</span>
<a href="#l1.537"></a><span id="l1.537" class="difflineminus">-               break;</span>
<a href="#l1.538"></a><span id="l1.538" class="difflineminus">-            }</span>
<a href="#l1.539"></a><span id="l1.539" class="difflineminus">-          }</span>
<a href="#l1.540"></a><span id="l1.540" class="difflineminus">-          this.recreateHashTable();</span>
<a href="#l1.541"></a><span id="l1.541" class="difflineplus">+          if(this.mTreeView.selectedColumn)</span>
<a href="#l1.542"></a><span id="l1.542" class="difflineplus">+            this.sortItems();</span>
<a href="#l1.543"></a><span id="l1.543">           </span>
<a href="#l1.544"></a><span id="l1.544">           var tree = document.getAnonymousElementByAttribute(</span>
<a href="#l1.545"></a><span id="l1.545">               this, &quot;anonid&quot;, &quot;calendar-task-tree&quot;);</span>
<a href="#l1.546"></a><span id="l1.546">           tree.view = this.mTreeView;</span>
<a href="#l1.547"></a><span id="l1.547"> </span>
<a href="#l1.548"></a><span id="l1.548">           // we also need to notify potential listeners.</span>
<a href="#l1.549"></a><span id="l1.549">           var event = document.createEvent('Events');</span>
<a href="#l1.550"></a><span id="l1.550">           event.initEvent('select', true, false);</span>
<a href="#l1.551"></a><span id="l1.551">           this.dispatchEvent(event);</span>
<a href="#l1.552"></a><span id="l1.552">         ]]&gt;&lt;/body&gt;</span>
<a href="#l1.553"></a><span id="l1.553">       &lt;/method&gt;</span>
<a href="#l1.554"></a><span id="l1.554">       </span>
<a href="#l1.555"></a><span id="l1.555" class="difflineminus">-      &lt;method name=&quot;sortTaskArray&quot;&gt;</span>
<a href="#l1.556"></a><span id="l1.556" class="difflineplus">+      &lt;method name=&quot;sortItems&quot;&gt;</span>
<a href="#l1.557"></a><span id="l1.557">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l1.558"></a><span id="l1.558" class="difflineminus">-          var kStatusOrder = [</span>
<a href="#l1.559"></a><span id="l1.559" class="difflineminus">-              &quot;NEEDS-ACTION&quot;,</span>
<a href="#l1.560"></a><span id="l1.560" class="difflineminus">-              &quot;IN-PROCESS&quot;,</span>
<a href="#l1.561"></a><span id="l1.561" class="difflineminus">-              &quot;COMPLETED&quot;,</span>
<a href="#l1.562"></a><span id="l1.562" class="difflineminus">-              &quot;CANCELLED&quot; ];</span>
<a href="#l1.563"></a><span id="l1.563" class="difflineminus">-          function compareString(a, b) {</span>
<a href="#l1.564"></a><span id="l1.564" class="difflineminus">-              a = nullToEmpty(a);</span>
<a href="#l1.565"></a><span id="l1.565" class="difflineminus">-              b = nullToEmpty(b);</span>
<a href="#l1.566"></a><span id="l1.566" class="difflineminus">-              return ((a &lt; b) ? -1 :</span>
<a href="#l1.567"></a><span id="l1.567" class="difflineminus">-                      (a &gt; b) ?  1 : 0);</span>
<a href="#l1.568"></a><span id="l1.568" class="difflineminus">-          }</span>
<a href="#l1.569"></a><span id="l1.569" class="difflineplus">+          if (this.mTreeView.selectedColumn) {</span>
<a href="#l1.570"></a><span id="l1.570" class="difflineplus">+              var modifier = (this.mTreeView.sortDirection == &quot;descending&quot; ? -1 : 1);</span>
<a href="#l1.571"></a><span id="l1.571" class="difflineplus">+              debugger;</span>
<a href="#l1.572"></a><span id="l1.572" class="difflineplus">+              var sortKey = cal.sortEntry.mSortKey = this.mTreeView.selectedColumn.getAttribute(&quot;sortKey&quot;) ?</span>
<a href="#l1.573"></a><span id="l1.573" class="difflineplus">+                          this.mTreeView.selectedColumn.getAttribute(&quot;sortKey&quot;) : </span>
<a href="#l1.574"></a><span id="l1.574" class="difflineplus">+                          this.mTreeView.selectedColumn.getAttribute(&quot;itemproperty&quot;);</span>
<a href="#l1.575"></a><span id="l1.575" class="difflineplus">+              var sortType = cal.getSortTypeForSortKey(sortKey);</span>
<a href="#l1.576"></a><span id="l1.576"> </span>
<a href="#l1.577"></a><span id="l1.577" class="difflineminus">-          function nullToEmpty(value) {</span>
<a href="#l1.578"></a><span id="l1.578" class="difflineminus">-              return value == null? &quot;&quot; : value;</span>
<a href="#l1.579"></a><span id="l1.579" class="difflineminus">-          }</span>
<a href="#l1.580"></a><span id="l1.580" class="difflineminus">-</span>
<a href="#l1.581"></a><span id="l1.581" class="difflineminus">-          function compareNumber(a, b) {</span>
<a href="#l1.582"></a><span id="l1.582" class="difflineminus">-              // Number converts a date to msecs since 1970, and converts a null to 0.</span>
<a href="#l1.583"></a><span id="l1.583" class="difflineminus">-              a = Number(a); </span>
<a href="#l1.584"></a><span id="l1.584" class="difflineminus">-              b = Number(b);</span>
<a href="#l1.585"></a><span id="l1.585" class="difflineminus">-              return ((a &lt; b) ? -1 :      // avoid underflow problems of subtraction</span>
<a href="#l1.586"></a><span id="l1.586" class="difflineminus">-                      (a &gt; b) ?  1 : 0); </span>
<a href="#l1.587"></a><span id="l1.587" class="difflineplus">+              // sort (key,item) entries</span>
<a href="#l1.588"></a><span id="l1.588" class="difflineplus">+              cal.sortEntry.mSortStartedDate = now();</span>
<a href="#l1.589"></a><span id="l1.589" class="difflineplus">+              var entries = this.mTaskArray.map(cal.sortEntry, cal.sortEntry);</span>
<a href="#l1.590"></a><span id="l1.590" class="difflineplus">+              entries.sort(cal.sortEntryComparer(sortType, modifier));</span>
<a href="#l1.591"></a><span id="l1.591" class="difflineplus">+              this.mTaskArray = entries.map(cal.sortEntryItem);</span>
<a href="#l1.592"></a><span id="l1.592">           }</span>
<a href="#l1.593"></a><span id="l1.593"> </span>
<a href="#l1.594"></a><span id="l1.594" class="difflineminus">-          var sortStartedTime = this.mTreeView.sortStartedTime;</span>
<a href="#l1.595"></a><span id="l1.595" class="difflineminus">-          var sortDirection = this.mTreeView.sortDirection;</span>
<a href="#l1.596"></a><span id="l1.596" class="difflineminus">-          var selectedColumn = this.mTreeView.selectedColumn;</span>
<a href="#l1.597"></a><span id="l1.597" class="difflineminus">-</span>
<a href="#l1.598"></a><span id="l1.598" class="difflineminus">-          // Takes two calDateTimes</span>
<a href="#l1.599"></a><span id="l1.599" class="difflineminus">-          function compareDate(a, b) {</span>
<a href="#l1.600"></a><span id="l1.600" class="difflineminus">-              if (!a)</span>
<a href="#l1.601"></a><span id="l1.601" class="difflineminus">-                  a = sortStartedTime;</span>
<a href="#l1.602"></a><span id="l1.602" class="difflineminus">-              if (!b)</span>
<a href="#l1.603"></a><span id="l1.603" class="difflineminus">-                  b = sortStartedTime;</span>
<a href="#l1.604"></a><span id="l1.604" class="difflineminus">-              return a.compare(b);</span>
<a href="#l1.605"></a><span id="l1.605" class="difflineminus">-          }</span>
<a href="#l1.606"></a><span id="l1.606" class="difflineminus">-                  </span>
<a href="#l1.607"></a><span id="l1.607" class="difflineminus">-          function compareItems(a, b) {</span>
<a href="#l1.608"></a><span id="l1.608" class="difflineminus">-              var modifier = (sortDirection == &quot;descending&quot;) ? -1 : 1;</span>
<a href="#l1.609"></a><span id="l1.609" class="difflineminus">-              switch(selectedColumn) {</span>
<a href="#l1.610"></a><span id="l1.610" class="difflineminus">-                  case &quot;calendar-task-tree-col-priority&quot;:  // 0-9</span>
<a href="#l1.611"></a><span id="l1.611" class="difflineminus">-                      // No priority set (0) should be weighted as &quot;normal&quot; (5).</span>
<a href="#l1.612"></a><span id="l1.612" class="difflineminus">-                      return compareNumber(a.priority || 5, b.priority || 5) * modifier;</span>
<a href="#l1.613"></a><span id="l1.613" class="difflineminus">-                  case &quot;calendar-task-tree-col-title&quot;:</span>
<a href="#l1.614"></a><span id="l1.614" class="difflineminus">-                      return compareString(a.title ? a.title.toLowerCase() : &quot;&quot;, b.title ? b.title.toLowerCase() : &quot;&quot;) * modifier;</span>
<a href="#l1.615"></a><span id="l1.615" class="difflineminus">-                  case &quot;calendar-task-tree-col-startdate&quot;:</span>
<a href="#l1.616"></a><span id="l1.616" class="difflineminus">-                      return compareDate(a.entryDate, b.entryDate) * modifier;</span>
<a href="#l1.617"></a><span id="l1.617" class="difflineminus">-                  case &quot;calendar-task-tree-col-duedate&quot;:</span>
<a href="#l1.618"></a><span id="l1.618" class="difflineminus">-                      return compareDate(a.dueDate, b.dueDate) * modifier;</span>
<a href="#l1.619"></a><span id="l1.619" class="difflineminus">-                  case &quot;calendar-task-tree-col-duration&quot;:</span>
<a href="#l1.620"></a><span id="l1.620" class="difflineminus">-                      return compareDate(a.dueDate, b.dueDate) * modifier;</span>
<a href="#l1.621"></a><span id="l1.621" class="difflineminus">-                  case &quot;calendar-task-tree-col-completed&quot;: // checkbox if date exists</span>
<a href="#l1.622"></a><span id="l1.622" class="difflineminus">-                  case &quot;calendar-task-tree-col-completeddate&quot;:</span>
<a href="#l1.623"></a><span id="l1.623" class="difflineminus">-                      return compareDate(a.completedDate, b.completedDate) * modifier;</span>
<a href="#l1.624"></a><span id="l1.624" class="difflineminus">-                  case &quot;calendar-task-tree-col-percentcomplete&quot;:</span>
<a href="#l1.625"></a><span id="l1.625" class="difflineminus">-                      return compareNumber(a.percentComplete, b.percentComplete) * modifier;</span>
<a href="#l1.626"></a><span id="l1.626" class="difflineminus">-                  case &quot;calendar-task-tree-col-categories&quot;: {</span>
<a href="#l1.627"></a><span id="l1.627" class="difflineminus">-                      function getCompStr(item) {</span>
<a href="#l1.628"></a><span id="l1.628" class="difflineminus">-                          var cats = item.getCategories({});</span>
<a href="#l1.629"></a><span id="l1.629" class="difflineminus">-                          cats.sort();</span>
<a href="#l1.630"></a><span id="l1.630" class="difflineminus">-                          return cats.join(&quot;&quot;);</span>
<a href="#l1.631"></a><span id="l1.631" class="difflineminus">-                      }</span>
<a href="#l1.632"></a><span id="l1.632" class="difflineminus">-                      return compareString(getCompStr(a), getCompStr(b)) * modifier;</span>
<a href="#l1.633"></a><span id="l1.633" class="difflineminus">-                  }</span>
<a href="#l1.634"></a><span id="l1.634" class="difflineminus">-                  case &quot;calendar-task-tree-col-location&quot;:</span>
<a href="#l1.635"></a><span id="l1.635" class="difflineminus">-                      return compareString(a.getProperty(&quot;LOCATION&quot;), b.getProperty(&quot;LOCATION&quot;)) * modifier;</span>
<a href="#l1.636"></a><span id="l1.636" class="difflineminus">-                  case &quot;calendar-task-tree-col-status&quot;:</span>
<a href="#l1.637"></a><span id="l1.637" class="difflineminus">-                      return compareNumber(kStatusOrder.indexOf(a.status), kStatusOrder.indexOf(b.status)) * modifier;</span>
<a href="#l1.638"></a><span id="l1.638" class="difflineminus">-                  case &quot;calendar-task-tree-col-calendarname&quot;:</span>
<a href="#l1.639"></a><span id="l1.639" class="difflineminus">-                      return compareString(a.calendar.name, b.calendar.name) * modifier;</span>
<a href="#l1.640"></a><span id="l1.640" class="difflineminus">-                  default:</span>
<a href="#l1.641"></a><span id="l1.641" class="difflineminus">-                      return 0;</span>
<a href="#l1.642"></a><span id="l1.642" class="difflineminus">-              }</span>
<a href="#l1.643"></a><span id="l1.643" class="difflineminus">-          }</span>
<a href="#l1.644"></a><span id="l1.644" class="difflineminus">-        </span>
<a href="#l1.645"></a><span id="l1.645" class="difflineminus">-          // use above local defined functor</span>
<a href="#l1.646"></a><span id="l1.646" class="difflineminus">-          this.mTaskArray.sort(compareItems);</span>
<a href="#l1.647"></a><span id="l1.647" class="difflineminus">-          var tree = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;calendar-task-tree&quot;);</span>
<a href="#l1.648"></a><span id="l1.648" class="difflineminus">-          if (tree.boxObject.invalidateRange) {</span>
<a href="#l1.649"></a><span id="l1.649" class="difflineminus">-              tree.boxObject.invalidateRange(0, this.mTaskArray.length - 1);</span>
<a href="#l1.650"></a><span id="l1.650" class="difflineminus">-          }</span>
<a href="#l1.651"></a><span id="l1.651" class="difflineplus">+          this.recreateHashTable();</span>
<a href="#l1.652"></a><span id="l1.652">         ]]&gt;&lt;/body&gt;</span>
<a href="#l1.653"></a><span id="l1.653">       &lt;/method&gt;</span>
<a href="#l1.654"></a><span id="l1.654">       </span>
<a href="#l1.655"></a><span id="l1.655">       &lt;method name=&quot;recreateHashTable&quot;&gt;</span>
<a href="#l1.656"></a><span id="l1.656">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l1.657"></a><span id="l1.657">           this.mHash2Index = {};</span>
<a href="#l1.658"></a><span id="l1.658">           for (var i=0; i&lt;this.mTaskArray.length; i++) {</span>
<a href="#l1.659"></a><span id="l1.659">               var item = this.mTaskArray[i];</span>
<a href="#l1.660"></a><span id="l1.660">               this.mHash2Index[item.hashId] = i;</span>
<a href="#l1.661"></a><span id="l1.661">           }</span>
<a href="#l1.662"></a><span id="l1.662" class="difflineplus">+          if (this.mTreeView.treebox) {</span>
<a href="#l1.663"></a><span id="l1.663" class="difflineplus">+            this.mTreeView.treebox.invalidate();</span>
<a href="#l1.664"></a><span id="l1.664" class="difflineplus">+          }</span>
<a href="#l1.665"></a><span id="l1.665">         ]]&gt;&lt;/body&gt;</span>
<a href="#l1.666"></a><span id="l1.666">       &lt;/method&gt;</span>
<a href="#l1.667"></a><span id="l1.667">       </span>
<a href="#l1.668"></a><span id="l1.668">     &lt;/implementation&gt;</span>
<a href="#l1.669"></a><span id="l1.669"> </span>
<a href="#l1.670"></a><span id="l1.670">     &lt;handlers&gt;</span>
<a href="#l1.671"></a><span id="l1.671">       &lt;handler event=&quot;select&quot;&gt;&lt;![CDATA[</span>
<a href="#l1.672"></a><span id="l1.672">         this.mTreeView.onSelect(event);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/calendar/base/content/calendar-ui-utils.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/calendar/base/content/calendar-ui-utils.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -40,16 +40,19 @@</span>
<a href="#l2.4"></a><span id="l2.4">  * Set the value of a property of a XUL element</span>
<a href="#l2.5"></a><span id="l2.5">  *</span>
<a href="#l2.6"></a><span id="l2.6">  * @param aElement      ID of XUL element to set, or the element node itself</span>
<a href="#l2.7"></a><span id="l2.7">  * @param aNewValue     value to set property to ( if undefined no change is made )</span>
<a href="#l2.8"></a><span id="l2.8">  * @param aPropertyName OPTIONAL name of property to set, default is &quot;value&quot;,</span>
<a href="#l2.9"></a><span id="l2.9">  *                        use &quot;checked&quot; for radios &amp; checkboxes, &quot;data&quot; for</span>
<a href="#l2.10"></a><span id="l2.10">  *                        drop-downs</span>
<a href="#l2.11"></a><span id="l2.11">  */</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+</span>
<a href="#l2.15"></a><span id="l2.15"> function setElementValue(aElement, aNewValue, aPropertyName) {</span>
<a href="#l2.16"></a><span id="l2.16">     ASSERT(aElement);</span>
<a href="#l2.17"></a><span id="l2.17">     var undefined;</span>
<a href="#l2.18"></a><span id="l2.18"> </span>
<a href="#l2.19"></a><span id="l2.19">     if (aNewValue !== undefined) {</span>
<a href="#l2.20"></a><span id="l2.20">         if (typeof(aElement) == &quot;string&quot;) {</span>
<a href="#l2.21"></a><span id="l2.21">             aElement = document.getElementById(aElement);</span>
<a href="#l2.22"></a><span id="l2.22">         }</span>
<a href="#l2.23"></a><span id="l2.23" class="difflineat">@@ -285,17 +288,17 @@ function appendCategoryItems(aItem, aCat</span>
<a href="#l2.24"></a><span id="l2.24"> </span>
<a href="#l2.25"></a><span id="l2.25">     // insert the category already in the menulist so it doesn't get lost</span>
<a href="#l2.26"></a><span id="l2.26">     if (aItem) {</span>
<a href="#l2.27"></a><span id="l2.27">         for each (var itemCategory in aItem.getCategories({})) {</span>
<a href="#l2.28"></a><span id="l2.28">             if (!categoriesList.some(function(cat){ return cat == itemCategory; })){</span>
<a href="#l2.29"></a><span id="l2.29">                 categoriesList.push(itemCategory);</span>
<a href="#l2.30"></a><span id="l2.30">             }</span>
<a href="#l2.31"></a><span id="l2.31">         }</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineminus">-        sortArrayByLocaleCollator(categoriesList);</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineplus">+        cal.sortArrayByLocaleCollator(categoriesList);</span>
<a href="#l2.34"></a><span id="l2.34">     }</span>
<a href="#l2.35"></a><span id="l2.35">     </span>
<a href="#l2.36"></a><span id="l2.36">     while (aCategoryMenuList.hasChildNodes()) {</span>
<a href="#l2.37"></a><span id="l2.37">        aCategoryMenuList.removeChild(aCategoryMenuList.lastChild);</span>
<a href="#l2.38"></a><span id="l2.38">     }</span>
<a href="#l2.39"></a><span id="l2.39"> </span>
<a href="#l2.40"></a><span id="l2.40">     var indexToSelect = 0;</span>
<a href="#l2.41"></a><span id="l2.41">     var menuitem = addMenuItem(aCategoryMenuList, calGetString(&quot;calendar&quot;, &quot;None&quot;), &quot;NONE&quot;, aCommand);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/calendar/base/content/calendar-unifinder-todo.xul</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/calendar/base/content/calendar-unifinder-todo.xul</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -74,9 +74,9 @@</span>
<a href="#l3.4"></a><span id="l3.4">                           onselect=&quot;document.commandDispatcher.updateCommands('calendar_commands');&quot;/&gt;</span>
<a href="#l3.5"></a><span id="l3.5">        &lt;textbox id=&quot;unifinder-task-edit-field&quot;</span>
<a href="#l3.6"></a><span id="l3.6">                 class=&quot;task-edit-field&quot;</span>
<a href="#l3.7"></a><span id="l3.7">                 onfocus=&quot;taskEdit.onFocus(event)&quot;</span>
<a href="#l3.8"></a><span id="l3.8">                 onblur=&quot;taskEdit.onBlur(event)&quot;</span>
<a href="#l3.9"></a><span id="l3.9">                 onkeypress=&quot;taskEdit.onKeyPress(event)&quot;/&gt;</span>
<a href="#l3.10"></a><span id="l3.10">     &lt;/vbox&gt;</span>
<a href="#l3.11"></a><span id="l3.11">   &lt;/vbox&gt;</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-&lt;/overlay&gt;</span>
<a href="#l3.13"></a><span id="l3.13">\ No newline at end of file</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+&lt;/overlay&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/calendar/base/content/calendar-unifinder.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/calendar/base/content/calendar-unifinder.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -47,17 +47,18 @@</span>
<a href="#l4.4"></a><span id="l4.4">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l4.5"></a><span id="l4.5"> </span>
<a href="#l4.6"></a><span id="l4.6"> /**</span>
<a href="#l4.7"></a><span id="l4.7">  * U N I F I N D E R</span>
<a href="#l4.8"></a><span id="l4.8">  *</span>
<a href="#l4.9"></a><span id="l4.9">  * This is a hacked in interface to the unifinder. We will need to</span>
<a href="#l4.10"></a><span id="l4.10">  * improve this to make it usable in general.</span>
<a href="#l4.11"></a><span id="l4.11">  */</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-var kEventStatusOrder = [&quot;TENTATIVE&quot;, &quot;CONFIRMED&quot;, &quot;CANCELLED&quot;];</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l4.15"></a><span id="l4.15"> </span>
<a href="#l4.16"></a><span id="l4.16"> // Set this to true when the calendar event tree is clicked to allow for</span>
<a href="#l4.17"></a><span id="l4.17"> // multiple selection</span>
<a href="#l4.18"></a><span id="l4.18"> var gCalendarEventTreeClicked = false;</span>
<a href="#l4.19"></a><span id="l4.19"> </span>
<a href="#l4.20"></a><span id="l4.20"> // Store the start and enddate, because the providers can't be trusted when</span>
<a href="#l4.21"></a><span id="l4.21"> // dealing with all-day events. So we need to filter later. See bug 306157</span>
<a href="#l4.22"></a><span id="l4.22"> var gStartDate;</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineat">@@ -219,23 +220,30 @@ function prepareCalendarUnifinder() {</span>
<a href="#l4.24"></a><span id="l4.24">         unifinderTree.view = unifinderTreeView;</span>
<a href="#l4.25"></a><span id="l4.25"> </span>
<a href="#l4.26"></a><span id="l4.26">         // Listen for changes in the selected day, so we can update if need be</span>
<a href="#l4.27"></a><span id="l4.27">         var viewDeck = getViewDeck();</span>
<a href="#l4.28"></a><span id="l4.28">         viewDeck.addEventListener(&quot;dayselect&quot;, unifinderDaySelect, false);</span>
<a href="#l4.29"></a><span id="l4.29">         viewDeck.addEventListener(&quot;itemselect&quot;, unifinderItemSelect, true);</span>
<a href="#l4.30"></a><span id="l4.30"> </span>
<a href="#l4.31"></a><span id="l4.31">         // Set up sortDirection and sortActive, in case it persisted</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineminus">-        var active = document.getElementById(&quot;unifinder-search-results-tree-cols&quot;)</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineminus">-                             .getElementsByAttribute(&quot;sortActive&quot;, &quot;true&quot;);</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineminus">-        if (active.length &gt; 0) {</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineminus">-            unifinderTreeView.selectedColumn = active[0].id;</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineminus">-            unifinderTreeView.sortDirection = active[0].getAttribute(&quot;sortDirection&quot;);</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineplus">+        var sorted = unifinderTree.getAttribute(&quot;sort-active&quot;);</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineplus">+        var sortDirection = unifinderTree.getAttribute(&quot;sort-direction&quot;) || &quot;ascending&quot;;</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineplus">+        var tree = document.getElementById(&quot;unifinder-search-results-tree&quot;);</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineplus">+        var treecols = tree.getElementsByTagName(&quot;treecol&quot;);</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineplus">+        for (var i = 0; i &lt; treecols.length; i++) {</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineplus">+            var col = treecols[i];</span>
<a href="#l4.43"></a><span id="l4.43" class="difflineplus">+            var content = col.getAttribute(&quot;itemproperty&quot;);</span>
<a href="#l4.44"></a><span id="l4.44" class="difflineplus">+            if (sorted &amp;&amp; sorted.length &gt; 0) {</span>
<a href="#l4.45"></a><span id="l4.45" class="difflineplus">+                if (sorted == content) {</span>
<a href="#l4.46"></a><span id="l4.46" class="difflineplus">+                    unifinderTreeView.sortDirection = sortDirection;</span>
<a href="#l4.47"></a><span id="l4.47" class="difflineplus">+                    unifinderTreeView.selectedColumn = col;</span>
<a href="#l4.48"></a><span id="l4.48" class="difflineplus">+                }</span>
<a href="#l4.49"></a><span id="l4.49" class="difflineplus">+            }</span>
<a href="#l4.50"></a><span id="l4.50">         }</span>
<a href="#l4.51"></a><span id="l4.51" class="difflineminus">-</span>
<a href="#l4.52"></a><span id="l4.52">         // Display something upon first load. onLoad doesn't work properly for</span>
<a href="#l4.53"></a><span id="l4.53">         // observers</span>
<a href="#l4.54"></a><span id="l4.54">         if (!isUnifinderHidden()) {</span>
<a href="#l4.55"></a><span id="l4.55">             gUnifinderNeedsRefresh = false;</span>
<a href="#l4.56"></a><span id="l4.56">             refreshEventTree();</span>
<a href="#l4.57"></a><span id="l4.57">         }</span>
<a href="#l4.58"></a><span id="l4.58">     }</span>
<a href="#l4.59"></a><span id="l4.59"> }</span>
<a href="#l4.60"></a><span id="l4.60" class="difflineat">@@ -247,16 +255,27 @@ function finishCalendarUnifinder() {</span>
<a href="#l4.61"></a><span id="l4.61">     var ccalendar = getCompositeCalendar();</span>
<a href="#l4.62"></a><span id="l4.62">     ccalendar.removeObserver(unifinderObserver);</span>
<a href="#l4.63"></a><span id="l4.63"> </span>
<a href="#l4.64"></a><span id="l4.64">     var viewDeck = getViewDeck();</span>
<a href="#l4.65"></a><span id="l4.65">     if (viewDeck) {</span>
<a href="#l4.66"></a><span id="l4.66">         viewDeck.removeEventListener(&quot;dayselect&quot;, unifinderDaySelect, false);</span>
<a href="#l4.67"></a><span id="l4.67">         viewDeck.removeEventListener(&quot;itemselect&quot;, unifinderItemSelect, true);</span>
<a href="#l4.68"></a><span id="l4.68">     }</span>
<a href="#l4.69"></a><span id="l4.69" class="difflineplus">+</span>
<a href="#l4.70"></a><span id="l4.70" class="difflineplus">+    //persist the sort</span>
<a href="#l4.71"></a><span id="l4.71" class="difflineplus">+    var unifinderTree = document.getElementById(&quot;unifinder-search-results-tree&quot;);</span>
<a href="#l4.72"></a><span id="l4.72" class="difflineplus">+    var sorted = unifinderTreeView.selectedColumn;</span>
<a href="#l4.73"></a><span id="l4.73" class="difflineplus">+    if (sorted) {</span>
<a href="#l4.74"></a><span id="l4.74" class="difflineplus">+        unifinderTree.setAttribute(&quot;sort-active&quot;,sorted.getAttribute(&quot;itemproperty&quot;));</span>
<a href="#l4.75"></a><span id="l4.75" class="difflineplus">+        unifinderTree.setAttribute(&quot;sort-direction&quot;,unifinderTree.sortDirection);</span>
<a href="#l4.76"></a><span id="l4.76" class="difflineplus">+    } else {</span>
<a href="#l4.77"></a><span id="l4.77" class="difflineplus">+        unifinderTree.removeAttribute(&quot;sort-active&quot;);</span>
<a href="#l4.78"></a><span id="l4.78" class="difflineplus">+        unifinderTree.removeAttribute(&quot;sort-direction&quot;);</span>
<a href="#l4.79"></a><span id="l4.79" class="difflineplus">+    }</span>
<a href="#l4.80"></a><span id="l4.80"> }</span>
<a href="#l4.81"></a><span id="l4.81"> </span>
<a href="#l4.82"></a><span id="l4.82"> /**</span>
<a href="#l4.83"></a><span id="l4.83">  * Event listeners for dayselect and itemselect events</span>
<a href="#l4.84"></a><span id="l4.84">  */</span>
<a href="#l4.85"></a><span id="l4.85"> function unifinderDaySelect() {</span>
<a href="#l4.86"></a><span id="l4.86">     if (getCurrentUnifinderFilter() == &quot;current&quot;) {</span>
<a href="#l4.87"></a><span id="l4.87">         refreshEventTree();</span>
<a href="#l4.88"></a><span id="l4.88" class="difflineat">@@ -382,16 +401,40 @@ function unifinderKeyPress(aEvent) {</span>
<a href="#l4.89"></a><span id="l4.89">  * Tree controller for unifinder search results</span>
<a href="#l4.90"></a><span id="l4.90">  */</span>
<a href="#l4.91"></a><span id="l4.91"> var unifinderTreeView = {</span>
<a href="#l4.92"></a><span id="l4.92"> </span>
<a href="#l4.93"></a><span id="l4.93">     tree: null,</span>
<a href="#l4.94"></a><span id="l4.94">     treeElement: null,</span>
<a href="#l4.95"></a><span id="l4.95">     doingSelection: false,</span>
<a href="#l4.96"></a><span id="l4.96"> </span>
<a href="#l4.97"></a><span id="l4.97" class="difflineplus">+    mSelectedColumn: null,</span>
<a href="#l4.98"></a><span id="l4.98" class="difflineplus">+    sortDirection: null,</span>
<a href="#l4.99"></a><span id="l4.99" class="difflineplus">+</span>
<a href="#l4.100"></a><span id="l4.100" class="difflineplus">+    get selectedColumn uTV_getSelectedColumn() {</span>
<a href="#l4.101"></a><span id="l4.101" class="difflineplus">+        return this.mSelectedColumn;</span>
<a href="#l4.102"></a><span id="l4.102" class="difflineplus">+    },</span>
<a href="#l4.103"></a><span id="l4.103" class="difflineplus">+</span>
<a href="#l4.104"></a><span id="l4.104" class="difflineplus">+    set selectedColumn uTV_setSelectedColumn(aCol) {</span>
<a href="#l4.105"></a><span id="l4.105" class="difflineplus">+        var tree = document.getElementById(&quot;unifinder-search-results-tree&quot;);</span>
<a href="#l4.106"></a><span id="l4.106" class="difflineplus">+        var treecols = tree.getElementsByTagName(&quot;treecol&quot;);</span>
<a href="#l4.107"></a><span id="l4.107" class="difflineplus">+        for (var i = 0; i &lt; treecols.length; i++) {</span>
<a href="#l4.108"></a><span id="l4.108" class="difflineplus">+            var col = treecols[i];</span>
<a href="#l4.109"></a><span id="l4.109" class="difflineplus">+            if (col.getAttribute(&quot;sortActive&quot;)) {</span>
<a href="#l4.110"></a><span id="l4.110" class="difflineplus">+                  col.removeAttribute(&quot;sortActive&quot;);</span>
<a href="#l4.111"></a><span id="l4.111" class="difflineplus">+                  col.removeAttribute(&quot;sortDirection&quot;);</span>
<a href="#l4.112"></a><span id="l4.112" class="difflineplus">+            }</span>
<a href="#l4.113"></a><span id="l4.113" class="difflineplus">+            if (aCol.getAttribute(&quot;itemproperty&quot;) == col.getAttribute(&quot;itemproperty&quot;)) {</span>
<a href="#l4.114"></a><span id="l4.114" class="difflineplus">+                col.setAttribute(&quot;sortActive&quot;, &quot;true&quot;);</span>
<a href="#l4.115"></a><span id="l4.115" class="difflineplus">+                col.setAttribute(&quot;sortDirection&quot;, this.sortDirection);</span>
<a href="#l4.116"></a><span id="l4.116" class="difflineplus">+            }</span>
<a href="#l4.117"></a><span id="l4.117" class="difflineplus">+        }</span>
<a href="#l4.118"></a><span id="l4.118" class="difflineplus">+        return (this.mSelectedColumn = aCol);</span>
<a href="#l4.119"></a><span id="l4.119" class="difflineplus">+    },</span>
<a href="#l4.120"></a><span id="l4.120" class="difflineplus">+</span>
<a href="#l4.121"></a><span id="l4.121">     /**</span>
<a href="#l4.122"></a><span id="l4.122">      * Event functions</span>
<a href="#l4.123"></a><span id="l4.123">      */</span>
<a href="#l4.124"></a><span id="l4.124"> </span>
<a href="#l4.125"></a><span id="l4.125">     eventArray: [],</span>
<a href="#l4.126"></a><span id="l4.126">     eventIndexMap: {},</span>
<a href="#l4.127"></a><span id="l4.127"> </span>
<a href="#l4.128"></a><span id="l4.128">     addItems: function uTV_addItems(aItemArray, aDontSort) {</span>
<a href="#l4.129"></a><span id="l4.129" class="difflineat">@@ -433,17 +476,17 @@ var unifinderTreeView = {</span>
<a href="#l4.130"></a><span id="l4.130">     setItems: function uTV_setItems(aItemArray, aDontSort) {</span>
<a href="#l4.131"></a><span id="l4.131">         var oldCount = this.eventArray.length;</span>
<a href="#l4.132"></a><span id="l4.132">         this.eventArray = aItemArray.slice(0);</span>
<a href="#l4.133"></a><span id="l4.133">         if (this.tree) {</span>
<a href="#l4.134"></a><span id="l4.134">             this.tree.rowCountChanged(0, (this.eventArray.length - oldCount));</span>
<a href="#l4.135"></a><span id="l4.135">         }</span>
<a href="#l4.136"></a><span id="l4.136">        </span>
<a href="#l4.137"></a><span id="l4.137">         if (aDontSort) {</span>
<a href="#l4.138"></a><span id="l4.138" class="difflineminus">-            //this.calculateIndexMap();</span>
<a href="#l4.139"></a><span id="l4.139" class="difflineplus">+            this.calculateIndexMap();</span>
<a href="#l4.140"></a><span id="l4.140">         } else {</span>
<a href="#l4.141"></a><span id="l4.141">             this.sortItems();</span>
<a href="#l4.142"></a><span id="l4.142">         }</span>
<a href="#l4.143"></a><span id="l4.143">     },</span>
<a href="#l4.144"></a><span id="l4.144"> </span>
<a href="#l4.145"></a><span id="l4.145">     calculateIndexMap: function uTV_calculateIndexMap() {</span>
<a href="#l4.146"></a><span id="l4.146">         this.eventIndexMap = {};</span>
<a href="#l4.147"></a><span id="l4.147">         for (var i = 0 ; i &lt; this.eventArray.length; i++) {</span>
<a href="#l4.148"></a><span id="l4.148" class="difflineat">@@ -451,36 +494,27 @@ var unifinderTreeView = {</span>
<a href="#l4.149"></a><span id="l4.149">         }</span>
<a href="#l4.150"></a><span id="l4.150"> </span>
<a href="#l4.151"></a><span id="l4.151">         if (this.tree) {</span>
<a href="#l4.152"></a><span id="l4.152">             this.tree.invalidate();</span>
<a href="#l4.153"></a><span id="l4.153">         }</span>
<a href="#l4.154"></a><span id="l4.154">     },</span>
<a href="#l4.155"></a><span id="l4.155"> </span>
<a href="#l4.156"></a><span id="l4.156">     sortItems: function uTV_sortItems() {</span>
<a href="#l4.157"></a><span id="l4.157" class="difflineminus">-        // Get a current locale string collator for compareEvents</span>
<a href="#l4.158"></a><span id="l4.158" class="difflineminus">-        if (!this.localeCollator) {</span>
<a href="#l4.159"></a><span id="l4.159" class="difflineminus">-            var localeService =</span>
<a href="#l4.160"></a><span id="l4.160" class="difflineminus">-                Components</span>
<a href="#l4.161"></a><span id="l4.161" class="difflineminus">-                .classes[&quot;@mozilla.org/intl/nslocaleservice;1&quot;]</span>
<a href="#l4.162"></a><span id="l4.162" class="difflineminus">-                .getService(Components.interfaces.nsILocaleService);</span>
<a href="#l4.163"></a><span id="l4.163" class="difflineminus">-            this.localeCollator =</span>
<a href="#l4.164"></a><span id="l4.164" class="difflineminus">-                Components</span>
<a href="#l4.165"></a><span id="l4.165" class="difflineminus">-                .classes[&quot;@mozilla.org/intl/collation-factory;1&quot;]</span>
<a href="#l4.166"></a><span id="l4.166" class="difflineminus">-                .getService(Components.interfaces.nsICollationFactory)</span>
<a href="#l4.167"></a><span id="l4.167" class="difflineminus">-                .CreateCollation(localeService.getApplicationLocale());</span>
<a href="#l4.168"></a><span id="l4.168" class="difflineplus">+        if( this.selectedColumn) {</span>
<a href="#l4.169"></a><span id="l4.169" class="difflineplus">+            var modifier = (this.sortDirection == &quot;descending&quot; ? -1 : 1);</span>
<a href="#l4.170"></a><span id="l4.170" class="difflineplus">+            var sortKey = unifinderTreeView.selectedColumn.getAttribute(&quot;itemproperty&quot;);</span>
<a href="#l4.171"></a><span id="l4.171" class="difflineplus">+            var sortType = cal.getSortTypeForSortKey(sortKey);</span>
<a href="#l4.172"></a><span id="l4.172" class="difflineplus">+            // sort (key,item) entries</span>
<a href="#l4.173"></a><span id="l4.173" class="difflineplus">+            cal.sortEntry.mSortKey = sortKey;</span>
<a href="#l4.174"></a><span id="l4.174" class="difflineplus">+            cal.sortEntry.mSortStartedDate = now();</span>
<a href="#l4.175"></a><span id="l4.175" class="difflineplus">+            var entries = this.eventArray.map(cal.sortEntry, cal.sortEntry);</span>
<a href="#l4.176"></a><span id="l4.176" class="difflineplus">+            entries.sort(cal.sortEntryComparer(sortType, modifier));</span>
<a href="#l4.177"></a><span id="l4.177" class="difflineplus">+            this.eventArray = entries.map(cal.sortEntryItem);</span>
<a href="#l4.178"></a><span id="l4.178">         }</span>
<a href="#l4.179"></a><span id="l4.179" class="difflineminus">-</span>
<a href="#l4.180"></a><span id="l4.180" class="difflineminus">-        this.sortStartedTime = new Date().getTime(); // for null/0 dates in sort</span>
<a href="#l4.181"></a><span id="l4.181" class="difflineminus">-</span>
<a href="#l4.182"></a><span id="l4.182" class="difflineminus">-        // sort (key,item) entries</span>
<a href="#l4.183"></a><span id="l4.183" class="difflineminus">-        var entries = this.eventArray.map(sortEntry);</span>
<a href="#l4.184"></a><span id="l4.184" class="difflineminus">-        entries.sort(sortEntryComparer(this));</span>
<a href="#l4.185"></a><span id="l4.185" class="difflineminus">-        this.eventArray = entries.map(sortEntryItem);</span>
<a href="#l4.186"></a><span id="l4.186" class="difflineminus">-</span>
<a href="#l4.187"></a><span id="l4.187">         this.calculateIndexMap();</span>
<a href="#l4.188"></a><span id="l4.188">     },</span>
<a href="#l4.189"></a><span id="l4.189"> </span>
<a href="#l4.190"></a><span id="l4.190">     getItemRow: function uTV_getItemRow(item) {</span>
<a href="#l4.191"></a><span id="l4.191">         if (this.eventIndexMap[item.hashId] === undefined) {</span>
<a href="#l4.192"></a><span id="l4.192">             return -1;</span>
<a href="#l4.193"></a><span id="l4.193">         }</span>
<a href="#l4.194"></a><span id="l4.194">         return this.eventIndexMap[item.hashId];</span>
<a href="#l4.195"></a><span id="l4.195" class="difflineat">@@ -644,199 +678,86 @@ var unifinderTreeView = {</span>
<a href="#l4.196"></a><span id="l4.196"> </span>
<a href="#l4.197"></a><span id="l4.197">     getCellValue: function uTV_getCellValue(aRow, aCol) {</span>
<a href="#l4.198"></a><span id="l4.198">         return null;</span>
<a href="#l4.199"></a><span id="l4.199">     },</span>
<a href="#l4.200"></a><span id="l4.200"> </span>
<a href="#l4.201"></a><span id="l4.201">     getCellText: function uTV_getCellText(row, column) {</span>
<a href="#l4.202"></a><span id="l4.202">         calendarEvent = this.eventArray[row];</span>
<a href="#l4.203"></a><span id="l4.203"> </span>
<a href="#l4.204"></a><span id="l4.204" class="difflineminus">-        switch (column.id) {</span>
<a href="#l4.205"></a><span id="l4.205" class="difflineminus">-            case &quot;unifinder-search-results-tree-col-title&quot;:</span>
<a href="#l4.206"></a><span id="l4.206" class="difflineplus">+        switch (column.element.getAttribute(&quot;itemproperty&quot;)) {</span>
<a href="#l4.207"></a><span id="l4.207" class="difflineplus">+            case &quot;title&quot;:</span>
<a href="#l4.208"></a><span id="l4.208">                 return calendarEvent.title;</span>
<a href="#l4.209"></a><span id="l4.209"> </span>
<a href="#l4.210"></a><span id="l4.210" class="difflineminus">-            case &quot;unifinder-search-results-tree-col-startdate&quot;:</span>
<a href="#l4.211"></a><span id="l4.211" class="difflineplus">+            case &quot;startDate&quot;:</span>
<a href="#l4.212"></a><span id="l4.212">                 return formatUnifinderEventDateTime(calendarEvent.startDate);</span>
<a href="#l4.213"></a><span id="l4.213"> </span>
<a href="#l4.214"></a><span id="l4.214" class="difflineminus">-            case &quot;unifinder-search-results-tree-col-enddate&quot;:</span>
<a href="#l4.215"></a><span id="l4.215" class="difflineplus">+            case &quot;endDate&quot;:</span>
<a href="#l4.216"></a><span id="l4.216">                 var eventEndDate = calendarEvent.endDate.clone();</span>
<a href="#l4.217"></a><span id="l4.217">                 // XXX reimplement</span>
<a href="#l4.218"></a><span id="l4.218">                 //var eventEndDate = getCurrentNextOrPreviousRecurrence(calendarEvent);</span>
<a href="#l4.219"></a><span id="l4.219">                 if (calendarEvent.startDate.isDate) {</span>
<a href="#l4.220"></a><span id="l4.220">                     // display enddate is ical enddate - 1</span>
<a href="#l4.221"></a><span id="l4.221">                     eventEndDate.day = eventEndDate.day - 1;</span>
<a href="#l4.222"></a><span id="l4.222">                 }</span>
<a href="#l4.223"></a><span id="l4.223">                 return formatUnifinderEventDateTime(eventEndDate);</span>
<a href="#l4.224"></a><span id="l4.224"> </span>
<a href="#l4.225"></a><span id="l4.225" class="difflineminus">-            case &quot;unifinder-search-results-tree-col-categories&quot;:</span>
<a href="#l4.226"></a><span id="l4.226" class="difflineplus">+            case &quot;categories&quot;:</span>
<a href="#l4.227"></a><span id="l4.227">                 return calendarEvent.getCategories({}).join(&quot;, &quot;);</span>
<a href="#l4.228"></a><span id="l4.228"> </span>
<a href="#l4.229"></a><span id="l4.229" class="difflineminus">-            case &quot;unifinder-search-results-tree-col-location&quot;:</span>
<a href="#l4.230"></a><span id="l4.230" class="difflineplus">+            case &quot;location&quot;:</span>
<a href="#l4.231"></a><span id="l4.231">                 return calendarEvent.getProperty(&quot;LOCATION&quot;);</span>
<a href="#l4.232"></a><span id="l4.232"> </span>
<a href="#l4.233"></a><span id="l4.233" class="difflineminus">-            case &quot;unifinder-search-results-tree-col-status&quot;:</span>
<a href="#l4.234"></a><span id="l4.234" class="difflineplus">+            case &quot;status&quot;:</span>
<a href="#l4.235"></a><span id="l4.235">                 return getEventStatusString(calendarEvent);</span>
<a href="#l4.236"></a><span id="l4.236"> </span>
<a href="#l4.237"></a><span id="l4.237" class="difflineminus">-            case &quot;unifinder-search-results-tree-col-calendarname&quot;:</span>
<a href="#l4.238"></a><span id="l4.238" class="difflineplus">+            case &quot;calendar&quot;:</span>
<a href="#l4.239"></a><span id="l4.239">                 return calendarEvent.calendar.name;</span>
<a href="#l4.240"></a><span id="l4.240"> </span>
<a href="#l4.241"></a><span id="l4.241">             default:</span>
<a href="#l4.242"></a><span id="l4.242">                 return false;</span>
<a href="#l4.243"></a><span id="l4.243">         }</span>
<a href="#l4.244"></a><span id="l4.244">     },</span>
<a href="#l4.245"></a><span id="l4.245"> </span>
<a href="#l4.246"></a><span id="l4.246">     setTree: function uTV_setTree(tree) {</span>
<a href="#l4.247"></a><span id="l4.247">         this.tree = tree;</span>
<a href="#l4.248"></a><span id="l4.248">     },</span>
<a href="#l4.249"></a><span id="l4.249"> </span>
<a href="#l4.250"></a><span id="l4.250">     toggleOpenState: function uTV_toggleOpenState(aRow) {},</span>
<a href="#l4.251"></a><span id="l4.251"> </span>
<a href="#l4.252"></a><span id="l4.252">     cycleHeader: function uTV_cycleHeader(col) {</span>
<a href="#l4.253"></a><span id="l4.253" class="difflineminus">-</span>
<a href="#l4.254"></a><span id="l4.254" class="difflineminus">-        var sortActive = col.element.getAttribute(&quot;sortActive&quot;);</span>
<a href="#l4.255"></a><span id="l4.255" class="difflineminus">-        this.selectedColumn = col.id;</span>
<a href="#l4.256"></a><span id="l4.256" class="difflineminus">-        this.sortDirection = col.element.getAttribute(&quot;sortDirection&quot;);</span>
<a href="#l4.257"></a><span id="l4.257" class="difflineminus">-</span>
<a href="#l4.258"></a><span id="l4.258" class="difflineminus">-        if (sortActive != &quot;true&quot;) {</span>
<a href="#l4.259"></a><span id="l4.259" class="difflineminus">-            var unifinder = document.getElementById(&quot;unifinder-search-results-tree&quot;);</span>
<a href="#l4.260"></a><span id="l4.260" class="difflineminus">-            var treeCols = unifinder.getElementsByTagName(&quot;treecol&quot;);</span>
<a href="#l4.261"></a><span id="l4.261" class="difflineminus">-            for (var i = 0; i &lt; treeCols.length; i++) {</span>
<a href="#l4.262"></a><span id="l4.262" class="difflineminus">-                treeCols[i].removeAttribute(&quot;sortActive&quot;);</span>
<a href="#l4.263"></a><span id="l4.263" class="difflineminus">-                treeCols[i].removeAttribute(&quot;sortDirection&quot;);</span>
<a href="#l4.264"></a><span id="l4.264" class="difflineminus">-            }</span>
<a href="#l4.265"></a><span id="l4.265" class="difflineplus">+        if (!this.selectedColumn) {</span>
<a href="#l4.266"></a><span id="l4.266">             this.sortDirection = &quot;ascending&quot;;</span>
<a href="#l4.267"></a><span id="l4.267">         } else {</span>
<a href="#l4.268"></a><span id="l4.268">             if (!this.sortDirection || this.sortDirection == &quot;descending&quot;) {</span>
<a href="#l4.269"></a><span id="l4.269">                 this.sortDirection = &quot;ascending&quot;;</span>
<a href="#l4.270"></a><span id="l4.270">             } else {</span>
<a href="#l4.271"></a><span id="l4.271">                 this.sortDirection = &quot;descending&quot;;</span>
<a href="#l4.272"></a><span id="l4.272">             }</span>
<a href="#l4.273"></a><span id="l4.273">         }</span>
<a href="#l4.274"></a><span id="l4.274" class="difflineminus">-        col.element.setAttribute(&quot;sortActive&quot;, &quot;true&quot;);</span>
<a href="#l4.275"></a><span id="l4.275" class="difflineminus">-        col.element.setAttribute(&quot;sortDirection&quot;, this.sortDirection);</span>
<a href="#l4.276"></a><span id="l4.276" class="difflineminus">-</span>
<a href="#l4.277"></a><span id="l4.277" class="difflineplus">+        this.selectedColumn = col.element;</span>
<a href="#l4.278"></a><span id="l4.278">         this.sortItems();</span>
<a href="#l4.279"></a><span id="l4.279">     },</span>
<a href="#l4.280"></a><span id="l4.280"> </span>
<a href="#l4.281"></a><span id="l4.281">     isEditable: function uTV_isEditable(aRow, aCol) {</span>
<a href="#l4.282"></a><span id="l4.282">         return false;</span>
<a href="#l4.283"></a><span id="l4.283">     },</span>
<a href="#l4.284"></a><span id="l4.284"> </span>
<a href="#l4.285"></a><span id="l4.285">     setCellValue: function uTV_setCellValue(aRow, aCol, aValue) {},</span>
<a href="#l4.286"></a><span id="l4.286">     setCellText: function uTV_setCellText(aRow, aCol, aValue) {},</span>
<a href="#l4.287"></a><span id="l4.287"> </span>
<a href="#l4.288"></a><span id="l4.288">     performAction: function uTV_performAction(aAction) {},</span>
<a href="#l4.289"></a><span id="l4.289"> </span>
<a href="#l4.290"></a><span id="l4.290">     performActionOnRow: function uTV_performActionOnRow(aAction, aRow) {},</span>
<a href="#l4.291"></a><span id="l4.291"> </span>
<a href="#l4.292"></a><span id="l4.292">     performActionOnCell: function uTV_performActionOnCell(aAction, aRow, aCol) {},</span>
<a href="#l4.293"></a><span id="l4.293"> </span>
<a href="#l4.294"></a><span id="l4.294" class="difflineminus">-    selectedColumn: null,</span>
<a href="#l4.295"></a><span id="l4.295" class="difflineminus">-    sortDirection: null,</span>
<a href="#l4.296"></a><span id="l4.296" class="difflineminus">-    sortStartedTime: new Date().getTime(), // updated just before sort</span>
<a href="#l4.297"></a><span id="l4.297">     outParameter: new Object() // used to obtain dates during sort</span>
<a href="#l4.298"></a><span id="l4.298"> };</span>
<a href="#l4.299"></a><span id="l4.299"> </span>
<a href="#l4.300"></a><span id="l4.300" class="difflineminus">-function getEventSortKey(calEvent) {</span>
<a href="#l4.301"></a><span id="l4.301" class="difflineminus">-    switch(unifinderTreeView.selectedColumn) {</span>
<a href="#l4.302"></a><span id="l4.302" class="difflineminus">-        case &quot;unifinder-search-results-tree-col-title&quot;:</span>
<a href="#l4.303"></a><span id="l4.303" class="difflineminus">-            return calEvent.title || &quot;&quot;;</span>
<a href="#l4.304"></a><span id="l4.304" class="difflineminus">-</span>
<a href="#l4.305"></a><span id="l4.305" class="difflineminus">-        case &quot;unifinder-search-results-tree-col-startdate&quot;:</span>
<a href="#l4.306"></a><span id="l4.306" class="difflineminus">-            return nativeTimeOrNow(calEvent.startDate);</span>
<a href="#l4.307"></a><span id="l4.307" class="difflineminus">-</span>
<a href="#l4.308"></a><span id="l4.308" class="difflineminus">-        case &quot;unifinder-search-results-tree-col-enddate&quot;:</span>
<a href="#l4.309"></a><span id="l4.309" class="difflineminus">-            return nativeTimeOrNow(calEvent.endDate);</span>
<a href="#l4.310"></a><span id="l4.310" class="difflineminus">-</span>
<a href="#l4.311"></a><span id="l4.311" class="difflineminus">-        case &quot;unifinder-search-results-tree-col-categories&quot;:</span>
<a href="#l4.312"></a><span id="l4.312" class="difflineminus">-            return calEvent.getCategories({}).join(&quot;, &quot;);</span>
<a href="#l4.313"></a><span id="l4.313" class="difflineminus">-</span>
<a href="#l4.314"></a><span id="l4.314" class="difflineminus">-        case &quot;unifinder-search-results-tree-col-location&quot;:</span>
<a href="#l4.315"></a><span id="l4.315" class="difflineminus">-            return calEvent.getProperty(&quot;LOCATION&quot;) || &quot;&quot;;</span>
<a href="#l4.316"></a><span id="l4.316" class="difflineminus">-</span>
<a href="#l4.317"></a><span id="l4.317" class="difflineminus">-        case &quot;unifinder-search-results-tree-col-status&quot;:</span>
<a href="#l4.318"></a><span id="l4.318" class="difflineminus">-            return calEvent.status || &quot;&quot;;</span>
<a href="#l4.319"></a><span id="l4.319" class="difflineminus">-</span>
<a href="#l4.320"></a><span id="l4.320" class="difflineminus">-        case &quot;unifinder-search-results-tree-col-calendarname&quot;:</span>
<a href="#l4.321"></a><span id="l4.321" class="difflineminus">-            return calEvent.calendar.name || &quot;&quot;;</span>
<a href="#l4.322"></a><span id="l4.322" class="difflineminus">-</span>
<a href="#l4.323"></a><span id="l4.323" class="difflineminus">-        default:</span>
<a href="#l4.324"></a><span id="l4.324" class="difflineminus">-            return null;</span>
<a href="#l4.325"></a><span id="l4.325" class="difflineminus">-    }</span>
<a href="#l4.326"></a><span id="l4.326" class="difflineminus">-}</span>
<a href="#l4.327"></a><span id="l4.327" class="difflineminus">-</span>
<a href="#l4.328"></a><span id="l4.328" class="difflineminus">-function sortEntry (aItem) {</span>
<a href="#l4.329"></a><span id="l4.329" class="difflineminus">-    return {mSortKey : getEventSortKey(aItem), mItem: aItem};</span>
<a href="#l4.330"></a><span id="l4.330" class="difflineminus">-}</span>
<a href="#l4.331"></a><span id="l4.331" class="difflineminus">-function sortEntryItem(sortEntry) { </span>
<a href="#l4.332"></a><span id="l4.332" class="difflineminus">-    return sortEntry.mItem;</span>
<a href="#l4.333"></a><span id="l4.333" class="difflineminus">-}</span>
<a href="#l4.334"></a><span id="l4.334" class="difflineminus">-function sortEntryKey(sortEntry) {</span>
<a href="#l4.335"></a><span id="l4.335" class="difflineminus">-    return sortEntry.mSortKey;</span>
<a href="#l4.336"></a><span id="l4.336" class="difflineminus">-}</span>
<a href="#l4.337"></a><span id="l4.337" class="difflineminus">-</span>
<a href="#l4.338"></a><span id="l4.338" class="difflineminus">-</span>
<a href="#l4.339"></a><span id="l4.339" class="difflineminus">-function sortEntryComparer(unifinderTreeView) {</span>
<a href="#l4.340"></a><span id="l4.340" class="difflineminus">-    var modifier = (unifinderTreeView.sortDirection == &quot;descending&quot; ? -1 : 1);</span>
<a href="#l4.341"></a><span id="l4.341" class="difflineminus">-    var collator = unifinderTreeView.localeCollator;</span>
<a href="#l4.342"></a><span id="l4.342" class="difflineminus">-    switch (unifinderTreeView.selectedColumn) {</span>
<a href="#l4.343"></a><span id="l4.343" class="difflineminus">-        case &quot;unifinder-search-results-tree-col-startdate&quot;:</span>
<a href="#l4.344"></a><span id="l4.344" class="difflineminus">-        case &quot;unifinder-search-results-tree-col-enddate&quot;:</span>
<a href="#l4.345"></a><span id="l4.345" class="difflineminus">-            function compareTimes(sortEntryA, sortEntryB) { </span>
<a href="#l4.346"></a><span id="l4.346" class="difflineminus">-                var nsA = sortEntryKey(sortEntryA);</span>
<a href="#l4.347"></a><span id="l4.347" class="difflineminus">-                var nsB = sortEntryKey(sortEntryB);</span>
<a href="#l4.348"></a><span id="l4.348" class="difflineminus">-                return compareNativeTime(nsA, nsB) * modifier;</span>
<a href="#l4.349"></a><span id="l4.349" class="difflineminus">-            }</span>
<a href="#l4.350"></a><span id="l4.350" class="difflineminus">-            return compareTimes;</span>
<a href="#l4.351"></a><span id="l4.351" class="difflineminus">-</span>
<a href="#l4.352"></a><span id="l4.352" class="difflineminus">-        case &quot;unifinder-search-results-tree-col-title&quot;:</span>
<a href="#l4.353"></a><span id="l4.353" class="difflineminus">-        case &quot;unifinder-search-results-tree-col-categories&quot;:</span>
<a href="#l4.354"></a><span id="l4.354" class="difflineminus">-        case &quot;unifinder-search-results-tree-col-location&quot;:</span>
<a href="#l4.355"></a><span id="l4.355" class="difflineminus">-        case &quot;unifinder-search-results-tree-col-status&quot;:</span>
<a href="#l4.356"></a><span id="l4.356" class="difflineminus">-        case &quot;unifinder-search-results-tree-col-calendarname&quot;:</span>
<a href="#l4.357"></a><span id="l4.357" class="difflineminus">-            function compareStrings(sortEntryA, sortEntryB) { </span>
<a href="#l4.358"></a><span id="l4.358" class="difflineminus">-                var sA = sortEntryKey(sortEntryA);</span>
<a href="#l4.359"></a><span id="l4.359" class="difflineminus">-                var sB = sortEntryKey(sortEntryB);</span>
<a href="#l4.360"></a><span id="l4.360" class="difflineminus">-                if (sA.length == 0 || sB.length == 0) {</span>
<a href="#l4.361"></a><span id="l4.361" class="difflineminus">-                    // sort empty values to end (so when users first sort by a</span>
<a href="#l4.362"></a><span id="l4.362" class="difflineminus">-                    // column, they can see and find the desired values in that</span>
<a href="#l4.363"></a><span id="l4.363" class="difflineminus">-                    // column without scrolling past all the empty values).</span>
<a href="#l4.364"></a><span id="l4.364" class="difflineminus">-                    return -(sA.length - sB.length) * modifier;</span>
<a href="#l4.365"></a><span id="l4.365" class="difflineminus">-                }</span>
<a href="#l4.366"></a><span id="l4.366" class="difflineminus">-                var comparison = collator.compareString(0, sA, sB);</span>
<a href="#l4.367"></a><span id="l4.367" class="difflineminus">-                return comparison * modifier;</span>
<a href="#l4.368"></a><span id="l4.368" class="difflineminus">-            }</span>
<a href="#l4.369"></a><span id="l4.369" class="difflineminus">-            return compareStrings;</span>
<a href="#l4.370"></a><span id="l4.370" class="difflineminus">-</span>
<a href="#l4.371"></a><span id="l4.371" class="difflineminus">-        default:</span>
<a href="#l4.372"></a><span id="l4.372" class="difflineminus">-            function compareOther(sortEntryA, sortEntryB) {</span>
<a href="#l4.373"></a><span id="l4.373" class="difflineminus">-                return 0;</span>
<a href="#l4.374"></a><span id="l4.374" class="difflineminus">-            }</span>
<a href="#l4.375"></a><span id="l4.375" class="difflineminus">-            return compareOther;</span>
<a href="#l4.376"></a><span id="l4.376" class="difflineminus">-    }</span>
<a href="#l4.377"></a><span id="l4.377" class="difflineminus">-}</span>
<a href="#l4.378"></a><span id="l4.378" class="difflineminus">-</span>
<a href="#l4.379"></a><span id="l4.379" class="difflineminus">-function compareNativeTime(a, b) {</span>
<a href="#l4.380"></a><span id="l4.380" class="difflineminus">-    return (a &lt; b ? -1 :</span>
<a href="#l4.381"></a><span id="l4.381" class="difflineminus">-            a &gt; b ?  1 : 0);</span>
<a href="#l4.382"></a><span id="l4.382" class="difflineminus">-}</span>
<a href="#l4.383"></a><span id="l4.383" class="difflineminus">-</span>
<a href="#l4.384"></a><span id="l4.384" class="difflineminus">-function nativeTimeOrNow(calDateTime) {</span>
<a href="#l4.385"></a><span id="l4.385" class="difflineminus">-    // Treat null/0 as 'now' when sort started, so incomplete tasks stay current.</span>
<a href="#l4.386"></a><span id="l4.386" class="difflineminus">-    // Time is computed once per sort (just before sort) so sort is stable.</span>
<a href="#l4.387"></a><span id="l4.387" class="difflineminus">-    if (calDateTime == null) {</span>
<a href="#l4.388"></a><span id="l4.388" class="difflineminus">-        return unifinderTreeView.sortStartedTime;</span>
<a href="#l4.389"></a><span id="l4.389" class="difflineminus">-    }</span>
<a href="#l4.390"></a><span id="l4.390" class="difflineminus">-    var ns = calDateTime.nativeTime;</span>
<a href="#l4.391"></a><span id="l4.391" class="difflineminus">-    if (ns == -62168601600000000) { // ns value for (0000/00/00 00:00:00)</span>
<a href="#l4.392"></a><span id="l4.392" class="difflineminus">-        return unifinderTreeView.sortStartedTime;</span>
<a href="#l4.393"></a><span id="l4.393" class="difflineminus">-    }</span>
<a href="#l4.394"></a><span id="l4.394" class="difflineminus">-    return ns;</span>
<a href="#l4.395"></a><span id="l4.395" class="difflineminus">-}</span>
<a href="#l4.396"></a><span id="l4.396" class="difflineminus">-</span>
<a href="#l4.397"></a><span id="l4.397"> function refreshEventTree() {</span>
<a href="#l4.398"></a><span id="l4.398">     if (isUnifinderHidden()) {</span>
<a href="#l4.399"></a><span id="l4.399">         // If the unifinder is hidden, don't refresh the events to reduce needed</span>
<a href="#l4.400"></a><span id="l4.400">         // getItems calls.</span>
<a href="#l4.401"></a><span id="l4.401">         return;</span>
<a href="#l4.402"></a><span id="l4.402">     }</span>
<a href="#l4.403"></a><span id="l4.403">     var savedThis = this;</span>
<a href="#l4.404"></a><span id="l4.404">     var refreshListener = {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/calendar/base/content/calendar-unifinder.xul</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/calendar/base/content/calendar-unifinder.xul</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -97,53 +97,61 @@</span>
<a href="#l5.4"></a><span id="l5.4">                        class=&quot;unifinder-closebutton&quot;</span>
<a href="#l5.5"></a><span id="l5.5">                        command=&quot;calendar_show_unifinder_command&quot;</span>
<a href="#l5.6"></a><span id="l5.6">                        tooltiptext=&quot;&amp;calendar.unifinder.close.tooltip;&quot;/&gt;</span>
<a href="#l5.7"></a><span id="l5.7">       &lt;/hbox&gt;</span>
<a href="#l5.8"></a><span id="l5.8">       &lt;tree id=&quot;unifinder-search-results-tree&quot; flex=&quot;1&quot;</span>
<a href="#l5.9"></a><span id="l5.9">             onselect=&quot;unifinderSelect(event); calendarController.onSelectionChanged()&quot;</span>
<a href="#l5.10"></a><span id="l5.10">             onkeypress=&quot;unifinderKeyPress(event)&quot;</span>
<a href="#l5.11"></a><span id="l5.11">             _selectDelay=&quot;500&quot;</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+            persist=&quot;sort-active sort-direction&quot;</span>
<a href="#l5.13"></a><span id="l5.13">             enableColumnDrag=&quot;true&quot;&gt;</span>
<a href="#l5.14"></a><span id="l5.14">         &lt;treecols id=&quot;unifinder-search-results-tree-cols&quot;&gt;</span>
<a href="#l5.15"></a><span id="l5.15">           &lt;treecol id=&quot;unifinder-search-results-tree-col-title&quot;</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineminus">-                   persist=&quot;hidden ordinal width sortDirection sortActive&quot;</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineplus">+                   persist=&quot;hidden ordinal width&quot;</span>
<a href="#l5.18"></a><span id="l5.18">                    flex=&quot;1&quot;</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineplus">+                   itemproperty=&quot;title&quot;</span>
<a href="#l5.20"></a><span id="l5.20">                    label=&quot;&amp;calendar.unifinder.tree.title.label;&quot; /&gt;</span>
<a href="#l5.21"></a><span id="l5.21">           &lt;splitter class=&quot;tree-splitter&quot;/&gt;</span>
<a href="#l5.22"></a><span id="l5.22">           &lt;treecol id=&quot;unifinder-search-results-tree-col-startdate&quot;</span>
<a href="#l5.23"></a><span id="l5.23" class="difflineminus">-                   persist=&quot;hidden ordinal width sortDirection sortActive&quot;</span>
<a href="#l5.24"></a><span id="l5.24" class="difflineplus">+                   persist=&quot;hidden ordinal width&quot;</span>
<a href="#l5.25"></a><span id="l5.25">                    flex=&quot;1&quot;</span>
<a href="#l5.26"></a><span id="l5.26" class="difflineplus">+                   itemproperty=&quot;startDate&quot;</span>
<a href="#l5.27"></a><span id="l5.27">                    label=&quot;&amp;calendar.unifinder.tree.startdate.label;&quot;/&gt;</span>
<a href="#l5.28"></a><span id="l5.28">           &lt;splitter class=&quot;tree-splitter&quot;/&gt;</span>
<a href="#l5.29"></a><span id="l5.29">           &lt;treecol id=&quot;unifinder-search-results-tree-col-enddate&quot;</span>
<a href="#l5.30"></a><span id="l5.30" class="difflineminus">-                   persist=&quot;hidden ordinal width sortDirection sortActive&quot;</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineplus">+                   persist=&quot;hidden ordinal width&quot;</span>
<a href="#l5.32"></a><span id="l5.32">                    flex=&quot;1&quot;</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineplus">+                   itemproperty=&quot;endDate&quot;</span>
<a href="#l5.34"></a><span id="l5.34">                    label=&quot;&amp;calendar.unifinder.tree.enddate.label;&quot;/&gt;</span>
<a href="#l5.35"></a><span id="l5.35">           &lt;splitter class=&quot;tree-splitter&quot;/&gt;</span>
<a href="#l5.36"></a><span id="l5.36">           &lt;treecol id=&quot;unifinder-search-results-tree-col-categories&quot;</span>
<a href="#l5.37"></a><span id="l5.37" class="difflineminus">-                   persist=&quot;hidden ordinal width sortDirection sortActive&quot;</span>
<a href="#l5.38"></a><span id="l5.38" class="difflineplus">+                   persist=&quot;hidden ordinal width&quot;</span>
<a href="#l5.39"></a><span id="l5.39">                    flex=&quot;1&quot;</span>
<a href="#l5.40"></a><span id="l5.40" class="difflineplus">+                   itemproperty=&quot;categories&quot;</span>
<a href="#l5.41"></a><span id="l5.41">                    label=&quot;&amp;calendar.unifinder.tree.categories.label;&quot;/&gt;</span>
<a href="#l5.42"></a><span id="l5.42">           &lt;splitter class=&quot;tree-splitter&quot;/&gt;</span>
<a href="#l5.43"></a><span id="l5.43">           &lt;treecol id=&quot;unifinder-search-results-tree-col-location&quot;</span>
<a href="#l5.44"></a><span id="l5.44" class="difflineminus">-                   persist=&quot;hidden ordinal width sortDirection sortActive&quot;</span>
<a href="#l5.45"></a><span id="l5.45" class="difflineplus">+                   persist=&quot;hidden ordinal width&quot;</span>
<a href="#l5.46"></a><span id="l5.46">                    flex=&quot;1&quot;</span>
<a href="#l5.47"></a><span id="l5.47">                    hidden=&quot;true&quot;</span>
<a href="#l5.48"></a><span id="l5.48" class="difflineplus">+                   itemproperty=&quot;location&quot;</span>
<a href="#l5.49"></a><span id="l5.49">                    label=&quot;&amp;calendar.unifinder.tree.location.label;&quot;/&gt;</span>
<a href="#l5.50"></a><span id="l5.50">           &lt;splitter class=&quot;tree-splitter&quot;/&gt;</span>
<a href="#l5.51"></a><span id="l5.51">           &lt;treecol id=&quot;unifinder-search-results-tree-col-status&quot;</span>
<a href="#l5.52"></a><span id="l5.52" class="difflineminus">-                   persist=&quot;hidden ordinal width sortDirection sortActive&quot;</span>
<a href="#l5.53"></a><span id="l5.53" class="difflineplus">+                   persist=&quot;hidden ordinal width&quot;</span>
<a href="#l5.54"></a><span id="l5.54">                    flex=&quot;1&quot;</span>
<a href="#l5.55"></a><span id="l5.55">                    hidden=&quot;true&quot;</span>
<a href="#l5.56"></a><span id="l5.56" class="difflineplus">+                   itemproperty=&quot;status&quot;</span>
<a href="#l5.57"></a><span id="l5.57">                    label=&quot;&amp;calendar.unifinder.tree.status.label;&quot;/&gt;</span>
<a href="#l5.58"></a><span id="l5.58">           &lt;treecol id=&quot;unifinder-search-results-tree-col-calendarname&quot;</span>
<a href="#l5.59"></a><span id="l5.59" class="difflineminus">-                   persist=&quot;hidden ordinal width sortDirection sortActive&quot;</span>
<a href="#l5.60"></a><span id="l5.60" class="difflineplus">+                   persist=&quot;hidden ordinal width&quot;</span>
<a href="#l5.61"></a><span id="l5.61">                    flex=&quot;1&quot;</span>
<a href="#l5.62"></a><span id="l5.62">                    hidden=&quot;true&quot;</span>
<a href="#l5.63"></a><span id="l5.63" class="difflineplus">+                   itemproperty=&quot;calendar&quot;</span>
<a href="#l5.64"></a><span id="l5.64">                    label=&quot;&amp;calendar.unifinder.tree.calendarname.label;&quot;/&gt;</span>
<a href="#l5.65"></a><span id="l5.65">         &lt;/treecols&gt;</span>
<a href="#l5.66"></a><span id="l5.66"> </span>
<a href="#l5.67"></a><span id="l5.67">         &lt;!-- on mousedown here happens before onclick above --&gt;</span>
<a href="#l5.68"></a><span id="l5.68">         &lt;treechildren tooltip=&quot;eventTreeTooltip&quot;</span>
<a href="#l5.69"></a><span id="l5.69">                       context=&quot;calendar-item-context-menu&quot;</span>
<a href="#l5.70"></a><span id="l5.70">                       onkeypress=&quot;if (event.keyCode == 13) unifinderEditCommand();&quot;</span>
<a href="#l5.71"></a><span id="l5.71">                       ondragover=&quot;return( false );&quot;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/calendar/base/content/preferences/categories.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/calendar/base/content/preferences/categories.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -34,16 +34,17 @@</span>
<a href="#l6.4"></a><span id="l6.4">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l6.5"></a><span id="l6.5">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l6.6"></a><span id="l6.6">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l6.7"></a><span id="l6.7">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l6.8"></a><span id="l6.8">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l6.9"></a><span id="l6.9">  *</span>
<a href="#l6.10"></a><span id="l6.10">  * ***** END LICENSE BLOCK *****</span>
<a href="#l6.11"></a><span id="l6.11">  */</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l6.13"></a><span id="l6.13"> </span>
<a href="#l6.14"></a><span id="l6.14"> var gCategoryList;</span>
<a href="#l6.15"></a><span id="l6.15"> var prefService = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l6.16"></a><span id="l6.16">                     .getService(Components.interfaces.nsIPrefService);</span>
<a href="#l6.17"></a><span id="l6.17"> var categoryPrefBranch = prefService.getBranch(&quot;calendar.category.color.&quot;);</span>
<a href="#l6.18"></a><span id="l6.18"> </span>
<a href="#l6.19"></a><span id="l6.19"> var gCategoriesPane = {</span>
<a href="#l6.20"></a><span id="l6.20"> </span>
<a href="#l6.21"></a><span id="l6.21" class="difflineat">@@ -82,17 +83,17 @@ var gCategoriesPane = {</span>
<a href="#l6.22"></a><span id="l6.22">         if (gCategoryList.length == 1 &amp;&amp; !gCategoryList[0].length) {</span>
<a href="#l6.23"></a><span id="l6.23">             gCategoryList.pop();</span>
<a href="#l6.24"></a><span id="l6.24">         }</span>
<a href="#l6.25"></a><span id="l6.25"> </span>
<a href="#l6.26"></a><span id="l6.26">         this.updateCategoryList();</span>
<a href="#l6.27"></a><span id="l6.27">     },</span>
<a href="#l6.28"></a><span id="l6.28"> </span>
<a href="#l6.29"></a><span id="l6.29">     updateCategoryList: function () {</span>
<a href="#l6.30"></a><span id="l6.30" class="difflineminus">-        sortArrayByLocaleCollator(gCategoryList);</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineplus">+        cal.sortArrayByLocaleCollator(gCategoryList);</span>
<a href="#l6.32"></a><span id="l6.32">         document.getElementById(&quot;calendar.categories.names&quot;).value =</span>
<a href="#l6.33"></a><span id="l6.33">             categoriesArrayToString(gCategoryList);</span>
<a href="#l6.34"></a><span id="l6.34"> </span>
<a href="#l6.35"></a><span id="l6.35">         var listbox = document.getElementById(&quot;categorieslist&quot;);</span>
<a href="#l6.36"></a><span id="l6.36"> </span>
<a href="#l6.37"></a><span id="l6.37">         listbox.clearSelection();</span>
<a href="#l6.38"></a><span id="l6.38">         document.getElementById(&quot;editCButton&quot;).disabled = &quot;true&quot;;</span>
<a href="#l6.39"></a><span id="l6.39">         document.getElementById(&quot;deleteCButton&quot;).disabled = &quot;true&quot;;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/calendar/base/src/calUtils.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/calendar/base/src/calUtils.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -106,16 +106,26 @@ function createAlarm() {</span>
<a href="#l7.4"></a><span id="l7.4"> }</span>
<a href="#l7.5"></a><span id="l7.5"> </span>
<a href="#l7.6"></a><span id="l7.6"> /* Returns a clean new calIRelation */</span>
<a href="#l7.7"></a><span id="l7.7"> function createRelation() {</span>
<a href="#l7.8"></a><span id="l7.8">     return Components.classes[&quot;@mozilla.org/calendar/relation;1&quot;].</span>
<a href="#l7.9"></a><span id="l7.9">            createInstance(Components.interfaces.calIRelation);</span>
<a href="#l7.10"></a><span id="l7.10"> }</span>
<a href="#l7.11"></a><span id="l7.11"> </span>
<a href="#l7.12"></a><span id="l7.12" class="difflineplus">+function createLocaleCollator() {</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+  var localeService = Components</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+        .classes[&quot;@mozilla.org/intl/nslocaleservice;1&quot;]</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+        .getService(Components.interfaces.nsILocaleService);</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineplus">+  return Components</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineplus">+        .classes[&quot;@mozilla.org/intl/collation-factory;1&quot;]</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineplus">+        .getService(Components.interfaces.nsICollationFactory)</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineplus">+        .CreateCollation(localeService.getApplicationLocale());</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineplus">+ }</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineplus">+ </span>
<a href="#l7.22"></a><span id="l7.22"> /* Shortcut to the console service */</span>
<a href="#l7.23"></a><span id="l7.23"> function getConsoleService() {</span>
<a href="#l7.24"></a><span id="l7.24">     if (getConsoleService.mObject === undefined) {</span>
<a href="#l7.25"></a><span id="l7.25">         getConsoleService.mObject = Components.classes[&quot;@mozilla.org/consoleservice;1&quot;]</span>
<a href="#l7.26"></a><span id="l7.26">                                               .getService(Components.interfaces.nsIConsoleService);</span>
<a href="#l7.27"></a><span id="l7.27">     }</span>
<a href="#l7.28"></a><span id="l7.28">     return getConsoleService.mObject;</span>
<a href="#l7.29"></a><span id="l7.29"> }</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineat">@@ -605,36 +615,16 @@ function setPrefCategoriesFromArray(aCat</span>
<a href="#l7.31"></a><span id="l7.31">  * may contain unescaped commas, which will be escaped in combined string.</span>
<a href="#l7.32"></a><span id="l7.32">  */</span>
<a href="#l7.33"></a><span id="l7.33"> function categoriesArrayToString(aSortedCategoriesArray) {</span>
<a href="#l7.34"></a><span id="l7.34">     function escapeComma(category) { return category.replace(/,/g,&quot;\\,&quot;); }</span>
<a href="#l7.35"></a><span id="l7.35">     return aSortedCategoriesArray.map(escapeComma).join(&quot;,&quot;);</span>
<a href="#l7.36"></a><span id="l7.36"> }</span>
<a href="#l7.37"></a><span id="l7.37"> </span>
<a href="#l7.38"></a><span id="l7.38"> /**</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineminus">- * Sort an array of strings according to the current locale.</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineminus">- * Modifies aStringArray, returning it sorted.</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineminus">- */</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineminus">-function sortArrayByLocaleCollator(aStringArray) {</span>
<a href="#l7.43"></a><span id="l7.43" class="difflineminus">-    // get a current locale string collator for compareEvents</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineminus">-    var localeService =</span>
<a href="#l7.45"></a><span id="l7.45" class="difflineminus">-        Components</span>
<a href="#l7.46"></a><span id="l7.46" class="difflineminus">-        .classes[&quot;@mozilla.org/intl/nslocaleservice;1&quot;]</span>
<a href="#l7.47"></a><span id="l7.47" class="difflineminus">-        .getService(Components.interfaces.nsILocaleService);</span>
<a href="#l7.48"></a><span id="l7.48" class="difflineminus">-    var localeCollator =</span>
<a href="#l7.49"></a><span id="l7.49" class="difflineminus">-        Components</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineminus">-        .classes[&quot;@mozilla.org/intl/collation-factory;1&quot;]</span>
<a href="#l7.51"></a><span id="l7.51" class="difflineminus">-        .getService(Components.interfaces.nsICollationFactory)</span>
<a href="#l7.52"></a><span id="l7.52" class="difflineminus">-        .CreateCollation(localeService.getApplicationLocale());</span>
<a href="#l7.53"></a><span id="l7.53" class="difflineminus">-    function compare(a, b) { return localeCollator.compareString(0, a, b); }</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineminus">-    aStringArray.sort(compare);</span>
<a href="#l7.55"></a><span id="l7.55" class="difflineminus">-    return aStringArray;</span>
<a href="#l7.56"></a><span id="l7.56" class="difflineminus">-}</span>
<a href="#l7.57"></a><span id="l7.57" class="difflineminus">-</span>
<a href="#l7.58"></a><span id="l7.58" class="difflineminus">-/**</span>
<a href="#l7.59"></a><span id="l7.59">  * Creates a string bundle.</span>
<a href="#l7.60"></a><span id="l7.60">  *</span>
<a href="#l7.61"></a><span id="l7.61">  * @param bundleURL The bundle URL</span>
<a href="#l7.62"></a><span id="l7.62">  * @return string bundle</span>
<a href="#l7.63"></a><span id="l7.63">  */</span>
<a href="#l7.64"></a><span id="l7.64"> function calGetStringBundle(bundleURL) {</span>
<a href="#l7.65"></a><span id="l7.65">     if (calGetStringBundle.mService === undefined) {</span>
<a href="#l7.66"></a><span id="l7.66">         calGetStringBundle.mService = Components.classes[&quot;@mozilla.org/intl/stringbundle;1&quot;]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/calendar/base/src/calUtils.jsm</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/calendar/base/src/calUtils.jsm</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -46,17 +46,182 @@ let cal = {</span>
<a href="#l8.4"></a><span id="l8.4">     getIOService: generateServiceAccessor(&quot;@mozilla.org/network/io-service;1&quot;,</span>
<a href="#l8.5"></a><span id="l8.5">                                           Components.interfaces.nsIIOService2),</span>
<a href="#l8.6"></a><span id="l8.6"> </span>
<a href="#l8.7"></a><span id="l8.7">     /**</span>
<a href="#l8.8"></a><span id="l8.8">      * Checks whether a timezone lacks a definition.</span>
<a href="#l8.9"></a><span id="l8.9">      */</span>
<a href="#l8.10"></a><span id="l8.10">     isPhantomTimezone: function cal_isPhantomTimezone(tz) {</span>
<a href="#l8.11"></a><span id="l8.11">         return (!tz.icalComponent &amp;&amp; !tz.isUTC &amp;&amp; !tz.isFloating);</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+    },</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineplus">+    // The below functions will move to some different place once the</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineplus">+    // unifinder tress are consolidated.</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineplus">+</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineplus">+    compareNativeTime: function cal_compareNativeTime(a, b) {</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineplus">+      return (a &lt; b ? -1 :</span>
<a href="#l8.19"></a><span id="l8.19" class="difflineplus">+              a &gt; b ?  1 : 0);</span>
<a href="#l8.20"></a><span id="l8.20" class="difflineplus">+    },</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineplus">+</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineplus">+    compareNumber: function cal_compareNumber(a, b) {</span>
<a href="#l8.23"></a><span id="l8.23" class="difflineplus">+      a = Number(a);</span>
<a href="#l8.24"></a><span id="l8.24" class="difflineplus">+      b = Number(b);</span>
<a href="#l8.25"></a><span id="l8.25" class="difflineplus">+      return ((a &lt; b) ? -1 :      // avoid underflow problems of subtraction</span>
<a href="#l8.26"></a><span id="l8.26" class="difflineplus">+              (a &gt; b) ?  1 : 0);</span>
<a href="#l8.27"></a><span id="l8.27" class="difflineplus">+    },</span>
<a href="#l8.28"></a><span id="l8.28" class="difflineplus">+</span>
<a href="#l8.29"></a><span id="l8.29" class="difflineplus">+    sortEntryComparer: function cal_sortEntryComparer(sortType, modifier) {</span>
<a href="#l8.30"></a><span id="l8.30" class="difflineplus">+      switch (sortType) {</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineplus">+        case &quot;number&quot;:</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineplus">+          function compareNumbers(sortEntryA, sortEntryB) {</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineplus">+            var nsA = cal.sortEntryKey(sortEntryA);</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineplus">+            var nsB = cal.sortEntryKey(sortEntryB);</span>
<a href="#l8.35"></a><span id="l8.35" class="difflineplus">+            return cal.compareNumber(nsA, nsB) * modifier;</span>
<a href="#l8.36"></a><span id="l8.36" class="difflineplus">+          }</span>
<a href="#l8.37"></a><span id="l8.37" class="difflineplus">+          return compareNumbers;</span>
<a href="#l8.38"></a><span id="l8.38" class="difflineplus">+        case &quot;date&quot;:</span>
<a href="#l8.39"></a><span id="l8.39" class="difflineplus">+          function compareTimes(sortEntryA, sortEntryB) {</span>
<a href="#l8.40"></a><span id="l8.40" class="difflineplus">+            var nsA = cal.sortEntryKey(sortEntryA);</span>
<a href="#l8.41"></a><span id="l8.41" class="difflineplus">+            var nsB = cal.sortEntryKey(sortEntryB);</span>
<a href="#l8.42"></a><span id="l8.42" class="difflineplus">+            return cal.compareNativeTime(nsA, nsB) * modifier;</span>
<a href="#l8.43"></a><span id="l8.43" class="difflineplus">+          }</span>
<a href="#l8.44"></a><span id="l8.44" class="difflineplus">+          return compareTimes;</span>
<a href="#l8.45"></a><span id="l8.45" class="difflineplus">+        case &quot;string&quot;:</span>
<a href="#l8.46"></a><span id="l8.46" class="difflineplus">+          var collator = cal.createLocaleCollator();</span>
<a href="#l8.47"></a><span id="l8.47" class="difflineplus">+          function compareStrings(sortEntryA, sortEntryB) {</span>
<a href="#l8.48"></a><span id="l8.48" class="difflineplus">+            var sA = cal.sortEntryKey(sortEntryA);</span>
<a href="#l8.49"></a><span id="l8.49" class="difflineplus">+            var sB = cal.sortEntryKey(sortEntryB);</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineplus">+            if (sA.length == 0 || sB.length == 0) {</span>
<a href="#l8.51"></a><span id="l8.51" class="difflineplus">+              // sort empty values to end (so when users first sort by a</span>
<a href="#l8.52"></a><span id="l8.52" class="difflineplus">+              // column, they can see and find the desired values in that</span>
<a href="#l8.53"></a><span id="l8.53" class="difflineplus">+              // column without scrolling past all the empty values).</span>
<a href="#l8.54"></a><span id="l8.54" class="difflineplus">+              return -(sA.length - sB.length) * modifier;</span>
<a href="#l8.55"></a><span id="l8.55" class="difflineplus">+            }</span>
<a href="#l8.56"></a><span id="l8.56" class="difflineplus">+            var comparison = collator.compareString(0, sA, sB);</span>
<a href="#l8.57"></a><span id="l8.57" class="difflineplus">+            return comparison * modifier;</span>
<a href="#l8.58"></a><span id="l8.58" class="difflineplus">+          }</span>
<a href="#l8.59"></a><span id="l8.59" class="difflineplus">+          return compareStrings;</span>
<a href="#l8.60"></a><span id="l8.60" class="difflineplus">+</span>
<a href="#l8.61"></a><span id="l8.61" class="difflineplus">+        default:</span>
<a href="#l8.62"></a><span id="l8.62" class="difflineplus">+          function compareOther(sortEntryA, sortEntryB) {</span>
<a href="#l8.63"></a><span id="l8.63" class="difflineplus">+            return 0;</span>
<a href="#l8.64"></a><span id="l8.64" class="difflineplus">+          }</span>
<a href="#l8.65"></a><span id="l8.65" class="difflineplus">+          return compareOther;</span>
<a href="#l8.66"></a><span id="l8.66" class="difflineplus">+      }</span>
<a href="#l8.67"></a><span id="l8.67" class="difflineplus">+    },</span>
<a href="#l8.68"></a><span id="l8.68" class="difflineplus">+</span>
<a href="#l8.69"></a><span id="l8.69" class="difflineplus">+    getItemSortKey: function cal_getItemSortKey(aItem, aKey, aStartTime) {</span>
<a href="#l8.70"></a><span id="l8.70" class="difflineplus">+      switch(aKey) {</span>
<a href="#l8.71"></a><span id="l8.71" class="difflineplus">+        case &quot;priority&quot;:</span>
<a href="#l8.72"></a><span id="l8.72" class="difflineplus">+          return aItem.priority || 5;</span>
<a href="#l8.73"></a><span id="l8.73" class="difflineplus">+</span>
<a href="#l8.74"></a><span id="l8.74" class="difflineplus">+        case &quot;title&quot;:</span>
<a href="#l8.75"></a><span id="l8.75" class="difflineplus">+          return aItem.title || &quot;&quot;;</span>
<a href="#l8.76"></a><span id="l8.76" class="difflineplus">+</span>
<a href="#l8.77"></a><span id="l8.77" class="difflineplus">+        case &quot;entryDate&quot;:</span>
<a href="#l8.78"></a><span id="l8.78" class="difflineplus">+            return cal.nativeTimeOrNow(aItem.entryDate, aStartTime);</span>
<a href="#l8.79"></a><span id="l8.79" class="difflineplus">+        case &quot;startDate&quot;:</span>
<a href="#l8.80"></a><span id="l8.80" class="difflineplus">+            return cal.nativeTimeOrNow(aItem.startDate, aStartTime);</span>
<a href="#l8.81"></a><span id="l8.81" class="difflineplus">+</span>
<a href="#l8.82"></a><span id="l8.82" class="difflineplus">+        case &quot;dueDate&quot;:</span>
<a href="#l8.83"></a><span id="l8.83" class="difflineplus">+          return cal.nativeTimeOrNow(aItem.dueDate, aStartTime);</span>
<a href="#l8.84"></a><span id="l8.84" class="difflineplus">+</span>
<a href="#l8.85"></a><span id="l8.85" class="difflineplus">+        case &quot;endDate&quot;:</span>
<a href="#l8.86"></a><span id="l8.86" class="difflineplus">+          return cal.nativeTimeOrNow(aItem.endDate, aStartTime);</span>
<a href="#l8.87"></a><span id="l8.87" class="difflineplus">+        case &quot;completedDate&quot;:</span>
<a href="#l8.88"></a><span id="l8.88" class="difflineplus">+                  // XXX: is this right ??</span>
<a href="#l8.89"></a><span id="l8.89" class="difflineplus">+          return cal.nativeTimeOrNow(aItem.completedDate, aStartTime);</span>
<a href="#l8.90"></a><span id="l8.90" class="difflineplus">+</span>
<a href="#l8.91"></a><span id="l8.91" class="difflineplus">+        case &quot;percentComplete&quot;:</span>
<a href="#l8.92"></a><span id="l8.92" class="difflineplus">+          return aItem.percentComplete;</span>
<a href="#l8.93"></a><span id="l8.93" class="difflineplus">+</span>
<a href="#l8.94"></a><span id="l8.94" class="difflineplus">+        case &quot;categories&quot;:</span>
<a href="#l8.95"></a><span id="l8.95" class="difflineplus">+          return aItem.getCategories({}).join(&quot;, &quot;);</span>
<a href="#l8.96"></a><span id="l8.96" class="difflineplus">+</span>
<a href="#l8.97"></a><span id="l8.97" class="difflineplus">+        case &quot;location&quot;:</span>
<a href="#l8.98"></a><span id="l8.98" class="difflineplus">+          return aItem.getProperty(&quot;LOCATION&quot;) || &quot;&quot;;</span>
<a href="#l8.99"></a><span id="l8.99" class="difflineplus">+</span>
<a href="#l8.100"></a><span id="l8.100" class="difflineplus">+        case &quot;status&quot;:</span>
<a href="#l8.101"></a><span id="l8.101" class="difflineplus">+          if (isToDo(aItem))</span>
<a href="#l8.102"></a><span id="l8.102" class="difflineplus">+            return [&quot;NEEDS-ACTION&quot;, &quot;IN-PROCESS&quot;, &quot;COMPLETED&quot;, &quot;CANCELLED&quot; ].indexOf(aItem.status);</span>
<a href="#l8.103"></a><span id="l8.103" class="difflineplus">+          else</span>
<a href="#l8.104"></a><span id="l8.104" class="difflineplus">+            return [&quot;TENTATIVE&quot;, &quot;CONFIRMED&quot;, &quot;CANCELLED&quot;].indexOf(aItem.status);</span>
<a href="#l8.105"></a><span id="l8.105" class="difflineplus">+        case &quot;calendar&quot;:</span>
<a href="#l8.106"></a><span id="l8.106" class="difflineplus">+          return aItem.calendar.name || &quot;&quot;;</span>
<a href="#l8.107"></a><span id="l8.107" class="difflineplus">+</span>
<a href="#l8.108"></a><span id="l8.108" class="difflineplus">+        default:</span>
<a href="#l8.109"></a><span id="l8.109" class="difflineplus">+          return null;</span>
<a href="#l8.110"></a><span id="l8.110" class="difflineplus">+      }</span>
<a href="#l8.111"></a><span id="l8.111" class="difflineplus">+    },</span>
<a href="#l8.112"></a><span id="l8.112" class="difflineplus">+</span>
<a href="#l8.113"></a><span id="l8.113" class="difflineplus">+    getSortTypeForSortKey: function cal_getSortTypeForSortKey(aSortKey) {</span>
<a href="#l8.114"></a><span id="l8.114" class="difflineplus">+      switch(aSortKey) {</span>
<a href="#l8.115"></a><span id="l8.115" class="difflineplus">+        case &quot;title&quot;:</span>
<a href="#l8.116"></a><span id="l8.116" class="difflineplus">+        case &quot;categories&quot;:</span>
<a href="#l8.117"></a><span id="l8.117" class="difflineplus">+        case &quot;location&quot;:</span>
<a href="#l8.118"></a><span id="l8.118" class="difflineplus">+        case &quot;calendar&quot;:</span>
<a href="#l8.119"></a><span id="l8.119" class="difflineplus">+          return &quot;string&quot;;</span>
<a href="#l8.120"></a><span id="l8.120" class="difflineplus">+</span>
<a href="#l8.121"></a><span id="l8.121" class="difflineplus">+        case &quot;completedDate&quot;:</span>
<a href="#l8.122"></a><span id="l8.122" class="difflineplus">+        case &quot;entryDate&quot;:</span>
<a href="#l8.123"></a><span id="l8.123" class="difflineplus">+        case &quot;dueDate&quot;:</span>
<a href="#l8.124"></a><span id="l8.124" class="difflineplus">+        case &quot;startDate&quot;:</span>
<a href="#l8.125"></a><span id="l8.125" class="difflineplus">+        case &quot;endDate&quot;:</span>
<a href="#l8.126"></a><span id="l8.126" class="difflineplus">+          return &quot;date&quot;;</span>
<a href="#l8.127"></a><span id="l8.127" class="difflineplus">+</span>
<a href="#l8.128"></a><span id="l8.128" class="difflineplus">+        case &quot;priority&quot;:</span>
<a href="#l8.129"></a><span id="l8.129" class="difflineplus">+        case &quot;percentComplete&quot;:</span>
<a href="#l8.130"></a><span id="l8.130" class="difflineplus">+        case &quot;status&quot;:</span>
<a href="#l8.131"></a><span id="l8.131" class="difflineplus">+          return &quot;number&quot;;</span>
<a href="#l8.132"></a><span id="l8.132" class="difflineplus">+      }</span>
<a href="#l8.133"></a><span id="l8.133" class="difflineplus">+    },</span>
<a href="#l8.134"></a><span id="l8.134" class="difflineplus">+</span>
<a href="#l8.135"></a><span id="l8.135" class="difflineplus">+    nativeTimeOrNow: function cal_nativeTimeOrNow(calDateTime, sortStartedTime) {</span>
<a href="#l8.136"></a><span id="l8.136" class="difflineplus">+        // Treat null/0 as 'now' when sort started, so incomplete tasks stay current.</span>
<a href="#l8.137"></a><span id="l8.137" class="difflineplus">+        // Time is computed once per sort (just before sort) so sort is stable.</span>
<a href="#l8.138"></a><span id="l8.138" class="difflineplus">+        if (calDateTime == null) {</span>
<a href="#l8.139"></a><span id="l8.139" class="difflineplus">+            return sortStartedTime.nativeTime;</span>
<a href="#l8.140"></a><span id="l8.140" class="difflineplus">+        }</span>
<a href="#l8.141"></a><span id="l8.141" class="difflineplus">+        var ns = calDateTime.nativeTime;</span>
<a href="#l8.142"></a><span id="l8.142" class="difflineplus">+        if (ns == -62168601600000000) { // ns value for (0000/00/00 00:00:00)</span>
<a href="#l8.143"></a><span id="l8.143" class="difflineplus">+            return sortStartedTime;</span>
<a href="#l8.144"></a><span id="l8.144" class="difflineplus">+        }</span>
<a href="#l8.145"></a><span id="l8.145" class="difflineplus">+        return ns;</span>
<a href="#l8.146"></a><span id="l8.146" class="difflineplus">+    },</span>
<a href="#l8.147"></a><span id="l8.147" class="difflineplus">+</span>
<a href="#l8.148"></a><span id="l8.148" class="difflineplus">+    sortEntry: function cal_sortEntry(aItem) {</span>
<a href="#l8.149"></a><span id="l8.149" class="difflineplus">+        var key = cal.getItemSortKey(aItem, this.mSortKey, this.mSortStartedDate);</span>
<a href="#l8.150"></a><span id="l8.150" class="difflineplus">+        return {mSortKey : key, mItem: aItem};</span>
<a href="#l8.151"></a><span id="l8.151" class="difflineplus">+    },</span>
<a href="#l8.152"></a><span id="l8.152" class="difflineplus">+</span>
<a href="#l8.153"></a><span id="l8.153" class="difflineplus">+    sortEntryItem: function cal_sortEntryItem(sortEntry) {</span>
<a href="#l8.154"></a><span id="l8.154" class="difflineplus">+        return sortEntry.mItem;</span>
<a href="#l8.155"></a><span id="l8.155" class="difflineplus">+    },</span>
<a href="#l8.156"></a><span id="l8.156" class="difflineplus">+</span>
<a href="#l8.157"></a><span id="l8.157" class="difflineplus">+    sortEntryKey: function cal_sortEntryKey(sortEntry) {</span>
<a href="#l8.158"></a><span id="l8.158" class="difflineplus">+        return sortEntry.mSortKey;</span>
<a href="#l8.159"></a><span id="l8.159" class="difflineplus">+    },</span>
<a href="#l8.160"></a><span id="l8.160" class="difflineplus">+</span>
<a href="#l8.161"></a><span id="l8.161" class="difflineplus">+    createLocaleCollator: function cal_createLocaleCollator() {</span>
<a href="#l8.162"></a><span id="l8.162" class="difflineplus">+      var localeService = generateServiceAccessor(&quot;@mozilla.org/intl/nslocaleservice;1&quot;);</span>
<a href="#l8.163"></a><span id="l8.163" class="difflineplus">+      return generateServiceAccessor(&quot;@mozilla.org/intl/collation-factory;1&quot;)</span>
<a href="#l8.164"></a><span id="l8.164" class="difflineplus">+            .CreateCollation(localeService.getApplicationLocale());</span>
<a href="#l8.165"></a><span id="l8.165" class="difflineplus">+     },</span>
<a href="#l8.166"></a><span id="l8.166" class="difflineplus">+</span>
<a href="#l8.167"></a><span id="l8.167" class="difflineplus">+    /**</span>
<a href="#l8.168"></a><span id="l8.168" class="difflineplus">+     * Sort an array of strings according to the current locale.</span>
<a href="#l8.169"></a><span id="l8.169" class="difflineplus">+     * Modifies aStringArray, returning it sorted.</span>
<a href="#l8.170"></a><span id="l8.170" class="difflineplus">+     */</span>
<a href="#l8.171"></a><span id="l8.171" class="difflineplus">+    sortArrayByLocaleCollator: function cal_sortArrayByLocaleCollator(aStringArray) {</span>
<a href="#l8.172"></a><span id="l8.172" class="difflineplus">+        var localeCollator = cal.createLocaleCollator();</span>
<a href="#l8.173"></a><span id="l8.173" class="difflineplus">+        function compare(a, b) { return localeCollator.compareString(0, a, b); }</span>
<a href="#l8.174"></a><span id="l8.174" class="difflineplus">+        aStringArray.sort(compare);</span>
<a href="#l8.175"></a><span id="l8.175" class="difflineplus">+        return aStringArray;</span>
<a href="#l8.176"></a><span id="l8.176">     }</span>
<a href="#l8.177"></a><span id="l8.177" class="difflineplus">+</span>
<a href="#l8.178"></a><span id="l8.178"> };</span>
<a href="#l8.179"></a><span id="l8.179"> </span>
<a href="#l8.180"></a><span id="l8.180"> // local to this module;</span>
<a href="#l8.181"></a><span id="l8.181"> // will be used to generate service accessor functions, getIOService()</span>
<a href="#l8.182"></a><span id="l8.182"> function generateServiceAccessor(id, iface) {</span>
<a href="#l8.183"></a><span id="l8.183">     return function this_() {</span>
<a href="#l8.184"></a><span id="l8.184">         if (this_.mService === undefined) {</span>
<a href="#l8.185"></a><span id="l8.185">             this_.mService = Components.classes[id].getService(iface);</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

