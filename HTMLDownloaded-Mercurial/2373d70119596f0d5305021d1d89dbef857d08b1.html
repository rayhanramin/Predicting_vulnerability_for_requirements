<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 29130:2373d70119596f0d5305021d1d89dbef857d08b1</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 2373d70119596f0d5305021d1d89dbef857d08b1" />
<meta property="og:url" content="/comm-central/rev/2373d70119596f0d5305021d1d89dbef857d08b1" />
<meta property="og:description" content="Bug 1621213 - Request user's permission to do anything with a WebExtension experiment. r=mkmelin" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 2373d70119596f0d5305021d1d89dbef857d08b1 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/2373d70119596f0d5305021d1d89dbef857d08b1">shortlog</a> |
<a href="/comm-central/log/2373d70119596f0d5305021d1d89dbef857d08b1">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/2373d70119596f0d5305021d1d89dbef857d08b1">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/2373d70119596f0d5305021d1d89dbef857d08b1">files</a> |
changeset |
<a href="/comm-central/raw-rev/2373d70119596f0d5305021d1d89dbef857d08b1">raw</a>  | <a href="/comm-central/archive/2373d70119596f0d5305021d1d89dbef857d08b1.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1621213">Bug 1621213</a> - Request user's permission to do anything with a WebExtension experiment. r=mkmelin
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#71;&#101;&#111;&#102;&#102;&#32;&#76;&#97;&#110;&#107;&#111;&#119;&#32;&#60;&#103;&#101;&#111;&#102;&#102;&#64;&#100;&#97;&#114;&#107;&#116;&#114;&#111;&#106;&#97;&#110;&#46;&#110;&#101;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Fri, 20 Mar 2020 11:18:26 +1300</td></tr>

<tr>
 <td>changeset 29130</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/2373d70119596f0d5305021d1d89dbef857d08b1">2373d70119596f0d5305021d1d89dbef857d08b1</a></td>
</tr>



<tr>
<td>parent 29129</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/7ba40e153105efa78c68c2e922056ed117b01154">7ba40e153105efa78c68c2e922056ed117b01154</a>
</td>
</tr>

<tr>
<td>child 29131</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/6b562736cc9ad74d5de34e6325902df74cdf4b39">6b562736cc9ad74d5de34e6325902df74cdf4b39</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=2373d70119596f0d5305021d1d89dbef857d08b1">17217</a></td></tr>
<tr><td>push user</td><td>geoff@darktrojan.net</td></tr>
<tr><td>push date</td><td class="date age">Tue, 31 Mar 2020 08:56:49 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@6b562736cc9a [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=6b562736cc9ad74d5de34e6325902df74cdf4b39">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=6b562736cc9ad74d5de34e6325902df74cdf4b39&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=6b562736cc9ad74d5de34e6325902df74cdf4b39&newProject=comm-central&newRevision=2373d70119596f0d5305021d1d89dbef857d08b1&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=6b562736cc9ad74d5de34e6325902df74cdf4b39&newProject=comm-central&newRevision=2373d70119596f0d5305021d1d89dbef857d08b1&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=6b562736cc9ad74d5de34e6325902df74cdf4b39&newProject=comm-central&newRevision=2373d70119596f0d5305021d1d89dbef857d08b1&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28mkmelin%29&revcount=50">mkmelin</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1621213">1621213</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1621213">Bug 1621213</a> - Request user's permission to do anything with a WebExtension experiment. r=mkmelin</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2373d70119596f0d5305021d1d89dbef857d08b1/mail/base/content/messenger.xhtml">mail/base/content/messenger.xhtml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2373d70119596f0d5305021d1d89dbef857d08b1/mail/base/content/messenger.xhtml">file</a> |
<a href="/comm-central/annotate/2373d70119596f0d5305021d1d89dbef857d08b1/mail/base/content/messenger.xhtml">annotate</a> |
<a href="/comm-central/diff/2373d70119596f0d5305021d1d89dbef857d08b1/mail/base/content/messenger.xhtml">diff</a> |
<a href="/comm-central/comparison/2373d70119596f0d5305021d1d89dbef857d08b1/mail/base/content/messenger.xhtml">comparison</a> |
<a href="/comm-central/log/2373d70119596f0d5305021d1d89dbef857d08b1/mail/base/content/messenger.xhtml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2373d70119596f0d5305021d1d89dbef857d08b1/mail/base/modules/ExtensionsUI.jsm">mail/base/modules/ExtensionsUI.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2373d70119596f0d5305021d1d89dbef857d08b1/mail/base/modules/ExtensionsUI.jsm">file</a> |
<a href="/comm-central/annotate/2373d70119596f0d5305021d1d89dbef857d08b1/mail/base/modules/ExtensionsUI.jsm">annotate</a> |
<a href="/comm-central/diff/2373d70119596f0d5305021d1d89dbef857d08b1/mail/base/modules/ExtensionsUI.jsm">diff</a> |
<a href="/comm-central/comparison/2373d70119596f0d5305021d1d89dbef857d08b1/mail/base/modules/ExtensionsUI.jsm">comparison</a> |
<a href="/comm-central/log/2373d70119596f0d5305021d1d89dbef857d08b1/mail/base/modules/ExtensionsUI.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2373d70119596f0d5305021d1d89dbef857d08b1/mail/base/test/webextensions/browser.ini">mail/base/test/webextensions/browser.ini</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2373d70119596f0d5305021d1d89dbef857d08b1/mail/base/test/webextensions/browser.ini">file</a> |
<a href="/comm-central/annotate/2373d70119596f0d5305021d1d89dbef857d08b1/mail/base/test/webextensions/browser.ini">annotate</a> |
<a href="/comm-central/diff/2373d70119596f0d5305021d1d89dbef857d08b1/mail/base/test/webextensions/browser.ini">diff</a> |
<a href="/comm-central/comparison/2373d70119596f0d5305021d1d89dbef857d08b1/mail/base/test/webextensions/browser.ini">comparison</a> |
<a href="/comm-central/log/2373d70119596f0d5305021d1d89dbef857d08b1/mail/base/test/webextensions/browser.ini">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2373d70119596f0d5305021d1d89dbef857d08b1/mail/base/test/webextensions/browser_extension_install_experiment.js">mail/base/test/webextensions/browser_extension_install_experiment.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2373d70119596f0d5305021d1d89dbef857d08b1/mail/base/test/webextensions/browser_extension_install_experiment.js">file</a> |
<a href="/comm-central/annotate/2373d70119596f0d5305021d1d89dbef857d08b1/mail/base/test/webextensions/browser_extension_install_experiment.js">annotate</a> |
<a href="/comm-central/diff/2373d70119596f0d5305021d1d89dbef857d08b1/mail/base/test/webextensions/browser_extension_install_experiment.js">diff</a> |
<a href="/comm-central/comparison/2373d70119596f0d5305021d1d89dbef857d08b1/mail/base/test/webextensions/browser_extension_install_experiment.js">comparison</a> |
<a href="/comm-central/log/2373d70119596f0d5305021d1d89dbef857d08b1/mail/base/test/webextensions/browser_extension_install_experiment.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2373d70119596f0d5305021d1d89dbef857d08b1/mail/base/test/webextensions/browser_extension_update_background.js">mail/base/test/webextensions/browser_extension_update_background.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2373d70119596f0d5305021d1d89dbef857d08b1/mail/base/test/webextensions/browser_extension_update_background.js">file</a> |
<a href="/comm-central/annotate/2373d70119596f0d5305021d1d89dbef857d08b1/mail/base/test/webextensions/browser_extension_update_background.js">annotate</a> |
<a href="/comm-central/diff/2373d70119596f0d5305021d1d89dbef857d08b1/mail/base/test/webextensions/browser_extension_update_background.js">diff</a> |
<a href="/comm-central/comparison/2373d70119596f0d5305021d1d89dbef857d08b1/mail/base/test/webextensions/browser_extension_update_background.js">comparison</a> |
<a href="/comm-central/log/2373d70119596f0d5305021d1d89dbef857d08b1/mail/base/test/webextensions/browser_extension_update_background.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2373d70119596f0d5305021d1d89dbef857d08b1/mail/base/test/webextensions/browser_legacy_webext.xpi">mail/base/test/webextensions/browser_legacy_webext.xpi</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/2373d70119596f0d5305021d1d89dbef857d08b1/mail/base/test/webextensions/browser_legacy_webext.xpi">diff</a> |
<a href="/comm-central/comparison/2373d70119596f0d5305021d1d89dbef857d08b1/mail/base/test/webextensions/browser_legacy_webext.xpi">comparison</a> |
<a href="/comm-central/log/2373d70119596f0d5305021d1d89dbef857d08b1/mail/base/test/webextensions/browser_legacy_webext.xpi">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2373d70119596f0d5305021d1d89dbef857d08b1/mail/base/test/webextensions/browser_webext_experiment.xpi">mail/base/test/webextensions/browser_webext_experiment.xpi</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2373d70119596f0d5305021d1d89dbef857d08b1/mail/base/test/webextensions/browser_webext_experiment.xpi">file</a> |
<a href="/comm-central/annotate/2373d70119596f0d5305021d1d89dbef857d08b1/mail/base/test/webextensions/browser_webext_experiment.xpi">annotate</a> |
<a href="/comm-central/diff/2373d70119596f0d5305021d1d89dbef857d08b1/mail/base/test/webextensions/browser_webext_experiment.xpi">diff</a> |
<a href="/comm-central/comparison/2373d70119596f0d5305021d1d89dbef857d08b1/mail/base/test/webextensions/browser_webext_experiment.xpi">comparison</a> |
<a href="/comm-central/log/2373d70119596f0d5305021d1d89dbef857d08b1/mail/base/test/webextensions/browser_webext_experiment.xpi">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2373d70119596f0d5305021d1d89dbef857d08b1/mail/base/test/webextensions/browser_webext_experiment_permissions.xpi">mail/base/test/webextensions/browser_webext_experiment_permissions.xpi</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2373d70119596f0d5305021d1d89dbef857d08b1/mail/base/test/webextensions/browser_webext_experiment_permissions.xpi">file</a> |
<a href="/comm-central/annotate/2373d70119596f0d5305021d1d89dbef857d08b1/mail/base/test/webextensions/browser_webext_experiment_permissions.xpi">annotate</a> |
<a href="/comm-central/diff/2373d70119596f0d5305021d1d89dbef857d08b1/mail/base/test/webextensions/browser_webext_experiment_permissions.xpi">diff</a> |
<a href="/comm-central/comparison/2373d70119596f0d5305021d1d89dbef857d08b1/mail/base/test/webextensions/browser_webext_experiment_permissions.xpi">comparison</a> |
<a href="/comm-central/log/2373d70119596f0d5305021d1d89dbef857d08b1/mail/base/test/webextensions/browser_webext_experiment_permissions.xpi">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2373d70119596f0d5305021d1d89dbef857d08b1/mail/base/test/webextensions/browser_webext_update.json">mail/base/test/webextensions/browser_webext_update.json</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2373d70119596f0d5305021d1d89dbef857d08b1/mail/base/test/webextensions/browser_webext_update.json">file</a> |
<a href="/comm-central/annotate/2373d70119596f0d5305021d1d89dbef857d08b1/mail/base/test/webextensions/browser_webext_update.json">annotate</a> |
<a href="/comm-central/diff/2373d70119596f0d5305021d1d89dbef857d08b1/mail/base/test/webextensions/browser_webext_update.json">diff</a> |
<a href="/comm-central/comparison/2373d70119596f0d5305021d1d89dbef857d08b1/mail/base/test/webextensions/browser_webext_update.json">comparison</a> |
<a href="/comm-central/log/2373d70119596f0d5305021d1d89dbef857d08b1/mail/base/test/webextensions/browser_webext_update.json">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2373d70119596f0d5305021d1d89dbef857d08b1/mail/base/test/webextensions/head.js">mail/base/test/webextensions/head.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2373d70119596f0d5305021d1d89dbef857d08b1/mail/base/test/webextensions/head.js">file</a> |
<a href="/comm-central/annotate/2373d70119596f0d5305021d1d89dbef857d08b1/mail/base/test/webextensions/head.js">annotate</a> |
<a href="/comm-central/diff/2373d70119596f0d5305021d1d89dbef857d08b1/mail/base/test/webextensions/head.js">diff</a> |
<a href="/comm-central/comparison/2373d70119596f0d5305021d1d89dbef857d08b1/mail/base/test/webextensions/head.js">comparison</a> |
<a href="/comm-central/log/2373d70119596f0d5305021d1d89dbef857d08b1/mail/base/test/webextensions/head.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2373d70119596f0d5305021d1d89dbef857d08b1/mail/locales/en-US/chrome/messenger/addons.properties">mail/locales/en-US/chrome/messenger/addons.properties</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2373d70119596f0d5305021d1d89dbef857d08b1/mail/locales/en-US/chrome/messenger/addons.properties">file</a> |
<a href="/comm-central/annotate/2373d70119596f0d5305021d1d89dbef857d08b1/mail/locales/en-US/chrome/messenger/addons.properties">annotate</a> |
<a href="/comm-central/diff/2373d70119596f0d5305021d1d89dbef857d08b1/mail/locales/en-US/chrome/messenger/addons.properties">diff</a> |
<a href="/comm-central/comparison/2373d70119596f0d5305021d1d89dbef857d08b1/mail/locales/en-US/chrome/messenger/addons.properties">comparison</a> |
<a href="/comm-central/log/2373d70119596f0d5305021d1d89dbef857d08b1/mail/locales/en-US/chrome/messenger/addons.properties">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2373d70119596f0d5305021d1d89dbef857d08b1/mail/themes/shared/mail/messenger.css">mail/themes/shared/mail/messenger.css</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2373d70119596f0d5305021d1d89dbef857d08b1/mail/themes/shared/mail/messenger.css">file</a> |
<a href="/comm-central/annotate/2373d70119596f0d5305021d1d89dbef857d08b1/mail/themes/shared/mail/messenger.css">annotate</a> |
<a href="/comm-central/diff/2373d70119596f0d5305021d1d89dbef857d08b1/mail/themes/shared/mail/messenger.css">diff</a> |
<a href="/comm-central/comparison/2373d70119596f0d5305021d1d89dbef857d08b1/mail/themes/shared/mail/messenger.css">comparison</a> |
<a href="/comm-central/log/2373d70119596f0d5305021d1d89dbef857d08b1/mail/themes/shared/mail/messenger.css">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/base/content/messenger.xhtml</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/base/content/messenger.xhtml</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -475,16 +475,17 @@</span>
<a href="#l1.4"></a><span id="l1.4">     &lt;popupnotificationcontent id=&quot;addon-install-confirmation-content&quot; orient=&quot;vertical&quot;/&gt;</span>
<a href="#l1.5"></a><span id="l1.5">   &lt;/popupnotification&gt;</span>
<a href="#l1.6"></a><span id="l1.6"> </span>
<a href="#l1.7"></a><span id="l1.7">   &lt;popupnotification id=&quot;addon-webext-permissions-notification&quot; hidden=&quot;true&quot;&gt;</span>
<a href="#l1.8"></a><span id="l1.8">     &lt;popupnotificationcontent class=&quot;addon-webext-perm-notification-content&quot; orient=&quot;vertical&quot;&gt;</span>
<a href="#l1.9"></a><span id="l1.9">       &lt;description id=&quot;addon-webext-perm-text&quot; class=&quot;addon-webext-perm-text&quot;/&gt;</span>
<a href="#l1.10"></a><span id="l1.10">       &lt;label id=&quot;addon-webext-perm-intro&quot; class=&quot;addon-webext-perm-text&quot;/&gt;</span>
<a href="#l1.11"></a><span id="l1.11">       &lt;html:ul id=&quot;addon-webext-perm-list&quot; class=&quot;addon-webext-perm-list&quot;/&gt;</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+      &lt;description id=&quot;addon-webext-experiment-warning&quot; class=&quot;addon-webext-experiment-warning&quot;/&gt;</span>
<a href="#l1.13"></a><span id="l1.13">       &lt;hbox&gt;</span>
<a href="#l1.14"></a><span id="l1.14">         &lt;label id=&quot;addon-webext-perm-info&quot; is=&quot;text-link&quot; class=&quot;popup-notification-learnmore-link&quot;/&gt;</span>
<a href="#l1.15"></a><span id="l1.15">       &lt;/hbox&gt;</span>
<a href="#l1.16"></a><span id="l1.16">     &lt;/popupnotificationcontent&gt;</span>
<a href="#l1.17"></a><span id="l1.17">   &lt;/popupnotification&gt;</span>
<a href="#l1.18"></a><span id="l1.18"> </span>
<a href="#l1.19"></a><span id="l1.19">   &lt;popupnotification id=&quot;addon-installed-notification&quot; hidden=&quot;true&quot;&gt;</span>
<a href="#l1.20"></a><span id="l1.20">     &lt;popupnotificationcontent class=&quot;addon-installed-notification-content&quot; orient=&quot;vertical&quot;&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/base/modules/ExtensionsUI.jsm</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/base/modules/ExtensionsUI.jsm</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -570,23 +570,16 @@ var gXPInstallObserver = {</span>
<a href="#l2.4"></a><span id="l2.4">               extensionSettings &amp;&amp;</span>
<a href="#l2.5"></a><span id="l2.5">               &quot;blocked_install_message&quot; in extensionSettings</span>
<a href="#l2.6"></a><span id="l2.6">             ) {</span>
<a href="#l2.7"></a><span id="l2.7">               message = &quot; &quot; + extensionSettings.blocked_install_message;</span>
<a href="#l2.8"></a><span id="l2.8">             }</span>
<a href="#l2.9"></a><span id="l2.9">             args = [install.name, install.addon.id, message];</span>
<a href="#l2.10"></a><span id="l2.10">           }</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-          // Add Learn More link when refusing to install an unsigned add-on</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-          if (install.error == AddonManager.ERROR_SIGNEDSTATE_REQUIRED) {</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineminus">-            options.learnMoreURL =</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineminus">-              Services.urlFormatter.formatURLPref(&quot;app.support.baseURL&quot;) +</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineminus">-              &quot;unsigned-addons&quot;;</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineminus">-          }</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineminus">-</span>
<a href="#l2.19"></a><span id="l2.19">           messageString = addonsBundle.getFormattedString(error, args);</span>
<a href="#l2.20"></a><span id="l2.20"> </span>
<a href="#l2.21"></a><span id="l2.21">           showNotification(</span>
<a href="#l2.22"></a><span id="l2.22">             browser,</span>
<a href="#l2.23"></a><span id="l2.23">             notificationID,</span>
<a href="#l2.24"></a><span id="l2.24">             messageString,</span>
<a href="#l2.25"></a><span id="l2.25">             anchorID,</span>
<a href="#l2.26"></a><span id="l2.26">             action,</span>
<a href="#l2.27"></a><span id="l2.27" class="difflineat">@@ -804,42 +797,47 @@ var ExtensionsUI = {</span>
<a href="#l2.28"></a><span id="l2.28">       }</span>
<a href="#l2.29"></a><span id="l2.29">       // At the moment, this prompt will re-appear next time we do an update</span>
<a href="#l2.30"></a><span id="l2.30">       // check.  See bug 1332360 for proposal to avoid this.</span>
<a href="#l2.31"></a><span id="l2.31">       this.updates.delete(info);</span>
<a href="#l2.32"></a><span id="l2.32">       this._updateNotifications();</span>
<a href="#l2.33"></a><span id="l2.33">     });</span>
<a href="#l2.34"></a><span id="l2.34">   },</span>
<a href="#l2.35"></a><span id="l2.35"> </span>
<a href="#l2.36"></a><span id="l2.36" class="difflineminus">-  observe(subject, topic, data) {</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineplus">+  async observe(subject, topic, data) {</span>
<a href="#l2.38"></a><span id="l2.38">     if (topic == &quot;webextension-permission-prompt&quot;) {</span>
<a href="#l2.39"></a><span id="l2.39">       let { target, info } = subject.wrappedJSObject;</span>
<a href="#l2.40"></a><span id="l2.40"> </span>
<a href="#l2.41"></a><span id="l2.41">       let { browser } = getTabBrowser(target);</span>
<a href="#l2.42"></a><span id="l2.42"> </span>
<a href="#l2.43"></a><span id="l2.43">       // Dismiss the progress notification.  Note that this is bad if</span>
<a href="#l2.44"></a><span id="l2.44">       // there are multiple simultaneous installs happening, see</span>
<a href="#l2.45"></a><span id="l2.45">       // bug 1329884 for a longer explanation.</span>
<a href="#l2.46"></a><span id="l2.46">       let progressNotification = getNotification(&quot;addon-progress&quot;, browser);</span>
<a href="#l2.47"></a><span id="l2.47">       if (progressNotification) {</span>
<a href="#l2.48"></a><span id="l2.48">         progressNotification.remove();</span>
<a href="#l2.49"></a><span id="l2.49">       }</span>
<a href="#l2.50"></a><span id="l2.50"> </span>
<a href="#l2.51"></a><span id="l2.51" class="difflineminus">-      info.unsigned =</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineminus">-        info.addon.signedState &lt;= AddonManager.SIGNEDSTATE_MISSING;</span>
<a href="#l2.53"></a><span id="l2.53" class="difflineminus">-      if (</span>
<a href="#l2.54"></a><span id="l2.54" class="difflineminus">-        info.unsigned &amp;&amp;</span>
<a href="#l2.55"></a><span id="l2.55" class="difflineminus">-        Cu.isInAutomation &amp;&amp;</span>
<a href="#l2.56"></a><span id="l2.56" class="difflineminus">-        Services.prefs.getBoolPref(&quot;extensions.ui.ignoreUnsigned&quot;, false)</span>
<a href="#l2.57"></a><span id="l2.57" class="difflineminus">-      ) {</span>
<a href="#l2.58"></a><span id="l2.58" class="difflineminus">-        info.unsigned = false;</span>
<a href="#l2.59"></a><span id="l2.59" class="difflineplus">+      let strings = this._buildStrings(info);</span>
<a href="#l2.60"></a><span id="l2.60" class="difflineplus">+      let data = new ExtensionData(info.addon.getResourceURI());</span>
<a href="#l2.61"></a><span id="l2.61" class="difflineplus">+      await data.loadManifest();</span>
<a href="#l2.62"></a><span id="l2.62" class="difflineplus">+      if (data.manifest.experiment_apis) {</span>
<a href="#l2.63"></a><span id="l2.63" class="difflineplus">+        strings.msgs = [</span>
<a href="#l2.64"></a><span id="l2.64" class="difflineplus">+          addonsBundle.getFormattedString(</span>
<a href="#l2.65"></a><span id="l2.65" class="difflineplus">+            &quot;webextPerms.description.experiment&quot;,</span>
<a href="#l2.66"></a><span id="l2.66" class="difflineplus">+            [brandShortName]</span>
<a href="#l2.67"></a><span id="l2.67" class="difflineplus">+          ),</span>
<a href="#l2.68"></a><span id="l2.68" class="difflineplus">+        ];</span>
<a href="#l2.69"></a><span id="l2.69" class="difflineplus">+        if (info.source != &quot;AMO&quot;) {</span>
<a href="#l2.70"></a><span id="l2.70" class="difflineplus">+          strings.experimentWarning = addonsBundle.getString(</span>
<a href="#l2.71"></a><span id="l2.71" class="difflineplus">+            &quot;webextPerms.experimentWarning&quot;</span>
<a href="#l2.72"></a><span id="l2.72" class="difflineplus">+          );</span>
<a href="#l2.73"></a><span id="l2.73" class="difflineplus">+        }</span>
<a href="#l2.74"></a><span id="l2.74">       }</span>
<a href="#l2.75"></a><span id="l2.75"> </span>
<a href="#l2.76"></a><span id="l2.76" class="difflineminus">-      let strings = this._buildStrings(info);</span>
<a href="#l2.77"></a><span id="l2.77" class="difflineminus">-</span>
<a href="#l2.78"></a><span id="l2.78">       // If this is an update with no promptable permissions, just apply it</span>
<a href="#l2.79"></a><span id="l2.79">       if (info.type == &quot;update&quot; &amp;&amp; !strings.msgs.length) {</span>
<a href="#l2.80"></a><span id="l2.80">         info.resolve();</span>
<a href="#l2.81"></a><span id="l2.81">         return;</span>
<a href="#l2.82"></a><span id="l2.82">       }</span>
<a href="#l2.83"></a><span id="l2.83"> </span>
<a href="#l2.84"></a><span id="l2.84">       let histkey;</span>
<a href="#l2.85"></a><span id="l2.85">       if (info.type == &quot;sideload&quot;) {</span>
<a href="#l2.86"></a><span id="l2.86" class="difflineat">@@ -961,24 +959,16 @@ var ExtensionsUI = {</span>
<a href="#l2.87"></a><span id="l2.87">   // Create a set of formatted strings for a permission prompt</span>
<a href="#l2.88"></a><span id="l2.88">   _buildStrings(info) {</span>
<a href="#l2.89"></a><span id="l2.89">     let bundle = Services.strings.createBundle(ADDONS_PROPERTIES);</span>
<a href="#l2.90"></a><span id="l2.90">     let info2 = Object.assign({ appName: brandShortName }, info);</span>
<a href="#l2.91"></a><span id="l2.91"> </span>
<a href="#l2.92"></a><span id="l2.92">     let strings = ExtensionData.formatPermissionStrings(info2, bundle, {</span>
<a href="#l2.93"></a><span id="l2.93">       collapseOrigins: true,</span>
<a href="#l2.94"></a><span id="l2.94">     });</span>
<a href="#l2.95"></a><span id="l2.95" class="difflineminus">-    // Silence the unsigned add-on warning. We can't stop</span>
<a href="#l2.96"></a><span id="l2.96" class="difflineminus">-    // formatPermissionStrings returning this string without changing it in</span>
<a href="#l2.97"></a><span id="l2.97" class="difflineminus">-    // addons.properties, and it might be wanted in future.</span>
<a href="#l2.98"></a><span id="l2.98" class="difflineminus">-    if (</span>
<a href="#l2.99"></a><span id="l2.99" class="difflineminus">-      strings.text == bundle.GetStringFromName(&quot;webextPerms.unsignedWarning&quot;)</span>
<a href="#l2.100"></a><span id="l2.100" class="difflineminus">-    ) {</span>
<a href="#l2.101"></a><span id="l2.101" class="difflineminus">-      strings.text = &quot;&quot;;</span>
<a href="#l2.102"></a><span id="l2.102" class="difflineminus">-    }</span>
<a href="#l2.103"></a><span id="l2.103">     strings.addonName = info.addon.name;</span>
<a href="#l2.104"></a><span id="l2.104">     strings.learnMore = addonsBundle.getString(&quot;webextPerms.learnMore&quot;);</span>
<a href="#l2.105"></a><span id="l2.105">     return strings;</span>
<a href="#l2.106"></a><span id="l2.106">   },</span>
<a href="#l2.107"></a><span id="l2.107"> </span>
<a href="#l2.108"></a><span id="l2.108">   async showPermissionsPrompt(target, strings, icon, histkey) {</span>
<a href="#l2.109"></a><span id="l2.109">     let { browser, window } = getTabBrowser(target);</span>
<a href="#l2.110"></a><span id="l2.110"> </span>
<a href="#l2.111"></a><span id="l2.111" class="difflineat">@@ -1013,16 +1003,22 @@ var ExtensionsUI = {</span>
<a href="#l2.112"></a><span id="l2.112">             list.firstChild.remove();</span>
<a href="#l2.113"></a><span id="l2.113">           }</span>
<a href="#l2.114"></a><span id="l2.114"> </span>
<a href="#l2.115"></a><span id="l2.115">           for (let msg of strings.msgs) {</span>
<a href="#l2.116"></a><span id="l2.116">             let item = doc.createElementNS(HTML_NS, &quot;li&quot;);</span>
<a href="#l2.117"></a><span id="l2.117">             item.textContent = msg;</span>
<a href="#l2.118"></a><span id="l2.118">             list.appendChild(item);</span>
<a href="#l2.119"></a><span id="l2.119">           }</span>
<a href="#l2.120"></a><span id="l2.120" class="difflineplus">+</span>
<a href="#l2.121"></a><span id="l2.121" class="difflineplus">+          let experimentsEl = doc.getElementById(</span>
<a href="#l2.122"></a><span id="l2.122" class="difflineplus">+            &quot;addon-webext-experiment-warning&quot;</span>
<a href="#l2.123"></a><span id="l2.123" class="difflineplus">+          );</span>
<a href="#l2.124"></a><span id="l2.124" class="difflineplus">+          experimentsEl.textContent = strings.experimentWarning;</span>
<a href="#l2.125"></a><span id="l2.125" class="difflineplus">+          experimentsEl.hidden = !strings.experimentWarning;</span>
<a href="#l2.126"></a><span id="l2.126">         } else if (topic == &quot;swapping&quot;) {</span>
<a href="#l2.127"></a><span id="l2.127">           return true;</span>
<a href="#l2.128"></a><span id="l2.128">         }</span>
<a href="#l2.129"></a><span id="l2.129">         if (topic == &quot;removed&quot;) {</span>
<a href="#l2.130"></a><span id="l2.130">           Services.tm.dispatchToMainThread(() =&gt; {</span>
<a href="#l2.131"></a><span id="l2.131">             resolve(false);</span>
<a href="#l2.132"></a><span id="l2.132">           });</span>
<a href="#l2.133"></a><span id="l2.133">         }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/base/test/webextensions/browser.ini</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/base/test/webextensions/browser.ini</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -6,30 +6,32 @@ prefs =</span>
<a href="#l3.4"></a><span id="l3.4">   mail.winsearch.firstRunDone=true</span>
<a href="#l3.5"></a><span id="l3.5">   mailnews.start_page.override_url=about:blank</span>
<a href="#l3.6"></a><span id="l3.6">   mailnews.start_page.url=about:blank</span>
<a href="#l3.7"></a><span id="l3.7">   toolkit.telemetry.testing.overrideProductsCheck=true</span>
<a href="#l3.8"></a><span id="l3.8"> subsuite = thunderbird</span>
<a href="#l3.9"></a><span id="l3.9"> support-files =</span>
<a href="#l3.10"></a><span id="l3.10">   head.js</span>
<a href="#l3.11"></a><span id="l3.11">   file_install_extensions.html</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-  browser_legacy_webext.xpi</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+  browser_webext_experiment.xpi</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+  browser_webext_experiment_permissions.xpi</span>
<a href="#l3.15"></a><span id="l3.15">   browser_webext_permissions.xpi</span>
<a href="#l3.16"></a><span id="l3.16">   browser_webext_nopermissions.xpi</span>
<a href="#l3.17"></a><span id="l3.17">   browser_webext_unsigned.xpi</span>
<a href="#l3.18"></a><span id="l3.18">   browser_webext_update1.xpi</span>
<a href="#l3.19"></a><span id="l3.19">   browser_webext_update2.xpi</span>
<a href="#l3.20"></a><span id="l3.20">   browser_webext_update_icon1.xpi</span>
<a href="#l3.21"></a><span id="l3.21">   browser_webext_update_icon2.xpi</span>
<a href="#l3.22"></a><span id="l3.22">   browser_webext_update_perms1.xpi</span>
<a href="#l3.23"></a><span id="l3.23">   browser_webext_update_perms2.xpi</span>
<a href="#l3.24"></a><span id="l3.24">   browser_webext_update_origins1.xpi</span>
<a href="#l3.25"></a><span id="l3.25">   browser_webext_update_origins2.xpi</span>
<a href="#l3.26"></a><span id="l3.26">   browser_webext_update.json</span>
<a href="#l3.27"></a><span id="l3.27"> </span>
<a href="#l3.28"></a><span id="l3.28" class="difflineplus">+[browser_extension_install_experiment.js]</span>
<a href="#l3.29"></a><span id="l3.29"> [browser_extension_sideloading.js]</span>
<a href="#l3.30"></a><span id="l3.30"> [browser_extension_update_background.js]</span>
<a href="#l3.31"></a><span id="l3.31"> [browser_extension_update_background_noprompt.js]</span>
<a href="#l3.32"></a><span id="l3.32"> [browser_permissions_installTrigger.js]</span>
<a href="#l3.33"></a><span id="l3.33"> [browser_permissions_local_file.js]</span>
<a href="#l3.34"></a><span id="l3.34"> [browser_permissions_mozAddonManager.js]</span>
<a href="#l3.35"></a><span id="l3.35"> [browser_permissions_optional.js]</span>
<a href="#l3.36"></a><span id="l3.36"> [browser_permissions_pointerevent.js]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1">new file mode 100644</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineminus">--- /dev/null</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineplus">+++ b/mail/base/test/webextensions/browser_extension_install_experiment.js</span>
<a href="#l4.4"></a><span id="l4.4" class="difflineat">@@ -0,0 +1,83 @@</span>
<a href="#l4.5"></a><span id="l4.5" class="difflineplus">+&quot;use strict&quot;;</span>
<a href="#l4.6"></a><span id="l4.6" class="difflineplus">+</span>
<a href="#l4.7"></a><span id="l4.7" class="difflineplus">+async function installFile(filename) {</span>
<a href="#l4.8"></a><span id="l4.8" class="difflineplus">+  const ChromeRegistry = Cc[&quot;@mozilla.org/chrome/chrome-registry;1&quot;].getService(</span>
<a href="#l4.9"></a><span id="l4.9" class="difflineplus">+    Ci.nsIChromeRegistry</span>
<a href="#l4.10"></a><span id="l4.10" class="difflineplus">+  );</span>
<a href="#l4.11"></a><span id="l4.11" class="difflineplus">+  let chromeUrl = Services.io.newURI(gTestPath);</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+  let fileUrl = ChromeRegistry.convertChromeURL(chromeUrl);</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+  let file = fileUrl.QueryInterface(Ci.nsIFileURL).file;</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+  file.leafName = filename;</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineplus">+  let MockFilePicker = SpecialPowers.MockFilePicker;</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineplus">+  MockFilePicker.init(window);</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineplus">+  MockFilePicker.setFiles([file]);</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineplus">+  MockFilePicker.afterOpenCallback = MockFilePicker.cleanup;</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineplus">+</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineplus">+  let managerWin = await openAddonsMgr(&quot;addons://list/extension&quot;);</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineplus">+</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineplus">+  // Do the install...</span>
<a href="#l4.24"></a><span id="l4.24" class="difflineplus">+  if (managerWin.gViewController.isLoading) {</span>
<a href="#l4.25"></a><span id="l4.25" class="difflineplus">+    await BrowserTestUtils.waitForEvent(managerWin.document, &quot;ViewChanged&quot;);</span>
<a href="#l4.26"></a><span id="l4.26" class="difflineplus">+  }</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineplus">+  let installButton = managerWin</span>
<a href="#l4.28"></a><span id="l4.28" class="difflineplus">+    .getHtmlBrowser()</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineplus">+    .contentDocument.querySelector('[action=&quot;install-from-file&quot;]');</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineplus">+  installButton.click();</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineplus">+}</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineplus">+</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineplus">+async function testExperimentPrompt(filename) {</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineplus">+  let installPromise = new Promise(resolve =&gt; {</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineplus">+    let listener = {</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineplus">+      onDownloadCancelled() {</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineplus">+        AddonManager.removeInstallListener(listener);</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineplus">+        resolve(false);</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineplus">+      },</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineplus">+</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineplus">+      onDownloadFailed() {</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineplus">+        AddonManager.removeInstallListener(listener);</span>
<a href="#l4.43"></a><span id="l4.43" class="difflineplus">+        resolve(false);</span>
<a href="#l4.44"></a><span id="l4.44" class="difflineplus">+      },</span>
<a href="#l4.45"></a><span id="l4.45" class="difflineplus">+</span>
<a href="#l4.46"></a><span id="l4.46" class="difflineplus">+      onInstallCancelled() {</span>
<a href="#l4.47"></a><span id="l4.47" class="difflineplus">+        AddonManager.removeInstallListener(listener);</span>
<a href="#l4.48"></a><span id="l4.48" class="difflineplus">+        resolve(false);</span>
<a href="#l4.49"></a><span id="l4.49" class="difflineplus">+      },</span>
<a href="#l4.50"></a><span id="l4.50" class="difflineplus">+</span>
<a href="#l4.51"></a><span id="l4.51" class="difflineplus">+      onInstallEnded() {</span>
<a href="#l4.52"></a><span id="l4.52" class="difflineplus">+        AddonManager.removeInstallListener(listener);</span>
<a href="#l4.53"></a><span id="l4.53" class="difflineplus">+        resolve(true);</span>
<a href="#l4.54"></a><span id="l4.54" class="difflineplus">+      },</span>
<a href="#l4.55"></a><span id="l4.55" class="difflineplus">+</span>
<a href="#l4.56"></a><span id="l4.56" class="difflineplus">+      onInstallFailed() {</span>
<a href="#l4.57"></a><span id="l4.57" class="difflineplus">+        AddonManager.removeInstallListener(listener);</span>
<a href="#l4.58"></a><span id="l4.58" class="difflineplus">+        resolve(false);</span>
<a href="#l4.59"></a><span id="l4.59" class="difflineplus">+      },</span>
<a href="#l4.60"></a><span id="l4.60" class="difflineplus">+    };</span>
<a href="#l4.61"></a><span id="l4.61" class="difflineplus">+    AddonManager.addInstallListener(listener);</span>
<a href="#l4.62"></a><span id="l4.62" class="difflineplus">+  });</span>
<a href="#l4.63"></a><span id="l4.63" class="difflineplus">+</span>
<a href="#l4.64"></a><span id="l4.64" class="difflineplus">+  await installFile(filename);</span>
<a href="#l4.65"></a><span id="l4.65" class="difflineplus">+</span>
<a href="#l4.66"></a><span id="l4.66" class="difflineplus">+  let panel = await promisePopupNotificationShown(&quot;addon-webext-permissions&quot;);</span>
<a href="#l4.67"></a><span id="l4.67" class="difflineplus">+  checkNotification(</span>
<a href="#l4.68"></a><span id="l4.68" class="difflineplus">+    panel,</span>
<a href="#l4.69"></a><span id="l4.69" class="difflineplus">+    isDefaultIcon,</span>
<a href="#l4.70"></a><span id="l4.70" class="difflineplus">+    [[&quot;webextPerms.description.experiment&quot;]],</span>
<a href="#l4.71"></a><span id="l4.71" class="difflineplus">+    true</span>
<a href="#l4.72"></a><span id="l4.72" class="difflineplus">+  );</span>
<a href="#l4.73"></a><span id="l4.73" class="difflineplus">+  panel.secondaryButton.click();</span>
<a href="#l4.74"></a><span id="l4.74" class="difflineplus">+</span>
<a href="#l4.75"></a><span id="l4.75" class="difflineplus">+  let result = await installPromise;</span>
<a href="#l4.76"></a><span id="l4.76" class="difflineplus">+  ok(!result, &quot;Installation was cancelled&quot;);</span>
<a href="#l4.77"></a><span id="l4.77" class="difflineplus">+  let addon = await AddonManager.getAddonByID(&quot;thisisatest@test.invalid&quot;);</span>
<a href="#l4.78"></a><span id="l4.78" class="difflineplus">+  is(addon, null, &quot;Extension is not installed&quot;);</span>
<a href="#l4.79"></a><span id="l4.79" class="difflineplus">+</span>
<a href="#l4.80"></a><span id="l4.80" class="difflineplus">+  let tabmail = document.getElementById(&quot;tabmail&quot;);</span>
<a href="#l4.81"></a><span id="l4.81" class="difflineplus">+  tabmail.closeTab(tabmail.currentTabInfo);</span>
<a href="#l4.82"></a><span id="l4.82" class="difflineplus">+}</span>
<a href="#l4.83"></a><span id="l4.83" class="difflineplus">+</span>
<a href="#l4.84"></a><span id="l4.84" class="difflineplus">+add_task(async () =&gt; {</span>
<a href="#l4.85"></a><span id="l4.85" class="difflineplus">+  await testExperimentPrompt(&quot;browser_webext_experiment.xpi&quot;);</span>
<a href="#l4.86"></a><span id="l4.86" class="difflineplus">+  await testExperimentPrompt(&quot;browser_webext_experiment_permissions.xpi&quot;);</span>
<a href="#l4.87"></a><span id="l4.87" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mail/base/test/webextensions/browser_extension_update_background.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mail/base/test/webextensions/browser_extension_update_background.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -6,17 +6,16 @@ const { AddonTestUtils } = ChromeUtils.i</span>
<a href="#l5.4"></a><span id="l5.4">   &quot;resource://testing-common/AddonTestUtils.jsm&quot;</span>
<a href="#l5.5"></a><span id="l5.5"> );</span>
<a href="#l5.6"></a><span id="l5.6"> </span>
<a href="#l5.7"></a><span id="l5.7"> AddonTestUtils.initMochitest(this);</span>
<a href="#l5.8"></a><span id="l5.8"> </span>
<a href="#l5.9"></a><span id="l5.9"> const ID = &quot;update2@tests.mozilla.org&quot;;</span>
<a href="#l5.10"></a><span id="l5.10"> const ID_ICON = &quot;update_icon2@tests.mozilla.org&quot;;</span>
<a href="#l5.11"></a><span id="l5.11"> const ID_PERMS = &quot;update_perms@tests.mozilla.org&quot;;</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-const ID_LEGACY = &quot;legacy_update@tests.mozilla.org&quot;;</span>
<a href="#l5.13"></a><span id="l5.13"> const FAKE_INSTALL_TELEMETRY_SOURCE = &quot;fake-install-source&quot;;</span>
<a href="#l5.14"></a><span id="l5.14"> </span>
<a href="#l5.15"></a><span id="l5.15"> requestLongerTimeout(2);</span>
<a href="#l5.16"></a><span id="l5.16"> </span>
<a href="#l5.17"></a><span id="l5.17"> function promiseViewLoaded(tab, viewid) {</span>
<a href="#l5.18"></a><span id="l5.18">   let win = tab.linkedBrowser.contentWindow;</span>
<a href="#l5.19"></a><span id="l5.19">   if (</span>
<a href="#l5.20"></a><span id="l5.20">     win.gViewController &amp;&amp;</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineat">@@ -38,16 +37,33 @@ function promiseViewLoaded(tab, viewid) </span>
<a href="#l5.22"></a><span id="l5.22">   });</span>
<a href="#l5.23"></a><span id="l5.23"> }</span>
<a href="#l5.24"></a><span id="l5.24"> </span>
<a href="#l5.25"></a><span id="l5.25"> function getBadgeStatus() {</span>
<a href="#l5.26"></a><span id="l5.26">   let menuButton = document.getElementById(&quot;button-appmenu&quot;);</span>
<a href="#l5.27"></a><span id="l5.27">   return menuButton.getAttribute(&quot;badge-status&quot;);</span>
<a href="#l5.28"></a><span id="l5.28"> }</span>
<a href="#l5.29"></a><span id="l5.29"> </span>
<a href="#l5.30"></a><span id="l5.30" class="difflineplus">+function promiseBadgeChange() {</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineplus">+  return new Promise(resolve =&gt; {</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineplus">+    let menuButton = document.getElementById(&quot;button-appmenu&quot;);</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineplus">+    new MutationObserver((mutationsList, observer) =&gt; {</span>
<a href="#l5.34"></a><span id="l5.34" class="difflineplus">+      for (let mutation of mutationsList) {</span>
<a href="#l5.35"></a><span id="l5.35" class="difflineplus">+        if (mutation.attributeName == &quot;badge-status&quot;) {</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineplus">+          observer.disconnect();</span>
<a href="#l5.37"></a><span id="l5.37" class="difflineplus">+          resolve();</span>
<a href="#l5.38"></a><span id="l5.38" class="difflineplus">+          return;</span>
<a href="#l5.39"></a><span id="l5.39" class="difflineplus">+        }</span>
<a href="#l5.40"></a><span id="l5.40" class="difflineplus">+      }</span>
<a href="#l5.41"></a><span id="l5.41" class="difflineplus">+    }).observe(menuButton, {</span>
<a href="#l5.42"></a><span id="l5.42" class="difflineplus">+      attributes: true,</span>
<a href="#l5.43"></a><span id="l5.43" class="difflineplus">+    });</span>
<a href="#l5.44"></a><span id="l5.44" class="difflineplus">+  });</span>
<a href="#l5.45"></a><span id="l5.45" class="difflineplus">+}</span>
<a href="#l5.46"></a><span id="l5.46" class="difflineplus">+</span>
<a href="#l5.47"></a><span id="l5.47"> // Set some prefs that apply to all the tests in this file</span>
<a href="#l5.48"></a><span id="l5.48"> add_task(async function setup() {</span>
<a href="#l5.49"></a><span id="l5.49">   await SpecialPowers.pushPrefEnv({</span>
<a href="#l5.50"></a><span id="l5.50">     set: [</span>
<a href="#l5.51"></a><span id="l5.51">       // We don't have pre-pinned certificates for the local mochitest server</span>
<a href="#l5.52"></a><span id="l5.52">       [&quot;extensions.install.requireBuiltInCerts&quot;, false],</span>
<a href="#l5.53"></a><span id="l5.53">       [&quot;extensions.update.requireBuiltInCerts&quot;, false],</span>
<a href="#l5.54"></a><span id="l5.54">     ],</span>
<a href="#l5.55"></a><span id="l5.55" class="difflineat">@@ -79,19 +95,20 @@ async function backgroundUpdateTest(url,</span>
<a href="#l5.56"></a><span id="l5.56">   let addonId = addon.id;</span>
<a href="#l5.57"></a><span id="l5.57"> </span>
<a href="#l5.58"></a><span id="l5.58">   ok(addon, &quot;Addon was installed&quot;);</span>
<a href="#l5.59"></a><span id="l5.59">   is(getBadgeStatus(), &quot;&quot;, &quot;Should not start out with an addon alert badge&quot;);</span>
<a href="#l5.60"></a><span id="l5.60"> </span>
<a href="#l5.61"></a><span id="l5.61">   // Trigger an update check and wait for the update for this addon</span>
<a href="#l5.62"></a><span id="l5.62">   // to be downloaded.</span>
<a href="#l5.63"></a><span id="l5.63">   let updatePromise = promiseInstallEvent(addon, &quot;onDownloadEnded&quot;);</span>
<a href="#l5.64"></a><span id="l5.64" class="difflineplus">+  let badgePromise = promiseBadgeChange();</span>
<a href="#l5.65"></a><span id="l5.65"> </span>
<a href="#l5.66"></a><span id="l5.66">   AddonManagerPrivate.backgroundUpdateCheck();</span>
<a href="#l5.67"></a><span id="l5.67" class="difflineminus">-  await updatePromise;</span>
<a href="#l5.68"></a><span id="l5.68" class="difflineplus">+  await Promise.all([updatePromise, badgePromise]);</span>
<a href="#l5.69"></a><span id="l5.69"> </span>
<a href="#l5.70"></a><span id="l5.70">   is(getBadgeStatus(), &quot;addon-alert&quot;, &quot;Should have addon alert badge&quot;);</span>
<a href="#l5.71"></a><span id="l5.71"> </span>
<a href="#l5.72"></a><span id="l5.72">   // Find the menu entry for the update</span>
<a href="#l5.73"></a><span id="l5.73">   await gCUITestUtils.openMainMenu();</span>
<a href="#l5.74"></a><span id="l5.74"> </span>
<a href="#l5.75"></a><span id="l5.75">   let addons = PanelUI.addonNotificationContainer;</span>
<a href="#l5.76"></a><span id="l5.76">   is(addons.children.length, 1, &quot;Have a menu entry for the update&quot;);</span>
<a href="#l5.77"></a><span id="l5.77" class="difflineat">@@ -124,18 +141,19 @@ async function backgroundUpdateTest(url,</span>
<a href="#l5.78"></a><span id="l5.78"> </span>
<a href="#l5.79"></a><span id="l5.79">   await gCUITestUtils.openMainMenu();</span>
<a href="#l5.80"></a><span id="l5.80">   addons = PanelUI.addonNotificationContainer;</span>
<a href="#l5.81"></a><span id="l5.81">   is(addons.children.length, 0, &quot;Update menu entries should be gone&quot;);</span>
<a href="#l5.82"></a><span id="l5.82">   await gCUITestUtils.hideMainMenu();</span>
<a href="#l5.83"></a><span id="l5.83"> </span>
<a href="#l5.84"></a><span id="l5.84">   // Re-check for an update</span>
<a href="#l5.85"></a><span id="l5.85">   updatePromise = promiseInstallEvent(addon, &quot;onDownloadEnded&quot;);</span>
<a href="#l5.86"></a><span id="l5.86" class="difflineplus">+  badgePromise = promiseBadgeChange();</span>
<a href="#l5.87"></a><span id="l5.87">   await AddonManagerPrivate.backgroundUpdateCheck();</span>
<a href="#l5.88"></a><span id="l5.88" class="difflineminus">-  await updatePromise;</span>
<a href="#l5.89"></a><span id="l5.89" class="difflineplus">+  await Promise.all([updatePromise, badgePromise]);</span>
<a href="#l5.90"></a><span id="l5.90"> </span>
<a href="#l5.91"></a><span id="l5.91">   is(getBadgeStatus(), &quot;addon-alert&quot;, &quot;Should have addon alert badge&quot;);</span>
<a href="#l5.92"></a><span id="l5.92"> </span>
<a href="#l5.93"></a><span id="l5.93">   // Find the menu entry for the update</span>
<a href="#l5.94"></a><span id="l5.94">   await gCUITestUtils.openMainMenu();</span>
<a href="#l5.95"></a><span id="l5.95"> </span>
<a href="#l5.96"></a><span id="l5.96">   addons = PanelUI.addonNotificationContainer;</span>
<a href="#l5.97"></a><span id="l5.97">   is(addons.children.length, 1, &quot;Have a menu entry for the update&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1">deleted file mode 100644</span>
<a href="#l6.2"></a><span id="l6.2">index a3bdf6f8325851964f6d61b6f3bc716b645ab87e..e69de29bb2d1d6434b8b29ae775ad8c2e48c5391</span>
<a href="#l6.3"></a><span id="l6.3">GIT binary patch
literal 0
Hc$@&lt;O00001</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1">new file mode 100644</span>
<a href="#l7.2"></a><span id="l7.2">index e69de29bb2d1d6434b8b29ae775ad8c2e48c5391..92ee46d52af6e7dcc2654a9505961efeb725c175</span>
<a href="#l7.3"></a><span id="l7.3">GIT binary patch
literal 2466
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
Q?y&amp;Fff9!(p;rizN0Wg&amp;^qW}N^</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1">new file mode 100644</span>
<a href="#l8.2"></a><span id="l8.2">index e69de29bb2d1d6434b8b29ae775ad8c2e48c5391..db1aca7f2a6a8203594a44ffb76c9cd860d58509</span>
<a href="#l8.3"></a><span id="l8.3">GIT binary patch
literal 2482
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/span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mail/base/test/webextensions/browser_webext_update.json</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mail/base/test/webextensions/browser_webext_update.json</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -34,30 +34,16 @@</span>
<a href="#l9.4"></a><span id="l9.4">           &quot;applications&quot;: {</span>
<a href="#l9.5"></a><span id="l9.5">             &quot;gecko&quot;: {</span>
<a href="#l9.6"></a><span id="l9.6">               &quot;strict_min_version&quot;: &quot;1&quot;</span>
<a href="#l9.7"></a><span id="l9.7">             }</span>
<a href="#l9.8"></a><span id="l9.8">           }</span>
<a href="#l9.9"></a><span id="l9.9">         }</span>
<a href="#l9.10"></a><span id="l9.10">       ]</span>
<a href="#l9.11"></a><span id="l9.11">     },</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-    &quot;legacy_update@tests.mozilla.org&quot;: {</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineminus">-      &quot;updates&quot;: [</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineminus">-        {</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineminus">-          &quot;version&quot;: &quot;2.0&quot;,</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineminus">-          &quot;update_link&quot;: &quot;https://example.com/browser/comm/mail/base/test/webextensions/browser_legacy_webext.xpi&quot;,</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineminus">-          &quot;applications&quot;: {</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineminus">-            &quot;gecko&quot;: {</span>
<a href="#l9.19"></a><span id="l9.19" class="difflineminus">-              &quot;strict_min_version&quot;: &quot;1&quot;,</span>
<a href="#l9.20"></a><span id="l9.20" class="difflineminus">-              &quot;advisory_max_version&quot;: &quot;*&quot;</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineminus">-            }</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineminus">-          }</span>
<a href="#l9.23"></a><span id="l9.23" class="difflineminus">-        }</span>
<a href="#l9.24"></a><span id="l9.24" class="difflineminus">-      ]</span>
<a href="#l9.25"></a><span id="l9.25" class="difflineminus">-    },</span>
<a href="#l9.26"></a><span id="l9.26">     &quot;update_origins@tests.mozilla.org&quot;: {</span>
<a href="#l9.27"></a><span id="l9.27">       &quot;updates&quot;: [</span>
<a href="#l9.28"></a><span id="l9.28">         {</span>
<a href="#l9.29"></a><span id="l9.29">           &quot;version&quot;: &quot;2.0&quot;,</span>
<a href="#l9.30"></a><span id="l9.30">           &quot;update_link&quot;: &quot;https://example.com/browser/comm/mail/base/test/webextensions/browser_webext_update_origins2.xpi&quot;,</span>
<a href="#l9.31"></a><span id="l9.31">           &quot;applications&quot;: {</span>
<a href="#l9.32"></a><span id="l9.32">             &quot;gecko&quot;: {</span>
<a href="#l9.33"></a><span id="l9.33">               &quot;strict_min_version&quot;: &quot;1&quot;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mail/base/test/webextensions/head.js</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mail/base/test/webextensions/head.js</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -216,20 +216,23 @@ function checkPermissionString(string, k</span>
<a href="#l10.4"></a><span id="l10.4">  *        it is a function, it is called with the icon url and returns</span>
<a href="#l10.5"></a><span id="l10.5">  *        true if the url is correct.</span>
<a href="#l10.6"></a><span id="l10.6">  * @param {array} permissions</span>
<a href="#l10.7"></a><span id="l10.7">  *        The expected entries in the permissions list.  Each element</span>
<a href="#l10.8"></a><span id="l10.8">  *        in this array is itself a 2-element array with the string key</span>
<a href="#l10.9"></a><span id="l10.9">  *        for the item (e.g., &quot;webextPerms.description.foo&quot;) and an</span>
<a href="#l10.10"></a><span id="l10.10">  *        optional formatting parameter.</span>
<a href="#l10.11"></a><span id="l10.11">  */</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-function checkNotification(panel, checkIcon, permissions) {</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+function checkNotification(panel, checkIcon, permissions, warning = false) {</span>
<a href="#l10.14"></a><span id="l10.14">   let icon = panel.getAttribute(&quot;icon&quot;);</span>
<a href="#l10.15"></a><span id="l10.15">   let ul = document.getElementById(&quot;addon-webext-perm-list&quot;);</span>
<a href="#l10.16"></a><span id="l10.16">   let header = document.getElementById(&quot;addon-webext-perm-intro&quot;);</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineplus">+  let experimentWarning = document.getElementById(</span>
<a href="#l10.18"></a><span id="l10.18" class="difflineplus">+    &quot;addon-webext-experiment-warning&quot;</span>
<a href="#l10.19"></a><span id="l10.19" class="difflineplus">+  );</span>
<a href="#l10.20"></a><span id="l10.20">   let learnMoreLink = document.getElementById(&quot;addon-webext-perm-info&quot;);</span>
<a href="#l10.21"></a><span id="l10.21"> </span>
<a href="#l10.22"></a><span id="l10.22">   if (checkIcon instanceof RegExp) {</span>
<a href="#l10.23"></a><span id="l10.23">     ok(</span>
<a href="#l10.24"></a><span id="l10.24">       checkIcon.test(icon),</span>
<a href="#l10.25"></a><span id="l10.25">       `Notification icon is correct ${JSON.stringify(icon)} ~= ${checkIcon}`</span>
<a href="#l10.26"></a><span id="l10.26">     );</span>
<a href="#l10.27"></a><span id="l10.27">   } else if (typeof checkIcon == &quot;function&quot;) {</span>
<a href="#l10.28"></a><span id="l10.28" class="difflineat">@@ -263,16 +266,30 @@ function checkNotification(panel, checkI</span>
<a href="#l10.29"></a><span id="l10.29">     let [key, param] = permissions[i];</span>
<a href="#l10.30"></a><span id="l10.30">     checkPermissionString(</span>
<a href="#l10.31"></a><span id="l10.31">       ul.children[i].textContent,</span>
<a href="#l10.32"></a><span id="l10.32">       key,</span>
<a href="#l10.33"></a><span id="l10.33">       param,</span>
<a href="#l10.34"></a><span id="l10.34">       `Permission number ${i + 1} is correct`</span>
<a href="#l10.35"></a><span id="l10.35">     );</span>
<a href="#l10.36"></a><span id="l10.36">   }</span>
<a href="#l10.37"></a><span id="l10.37" class="difflineplus">+</span>
<a href="#l10.38"></a><span id="l10.38" class="difflineplus">+  if (warning) {</span>
<a href="#l10.39"></a><span id="l10.39" class="difflineplus">+    is(</span>
<a href="#l10.40"></a><span id="l10.40" class="difflineplus">+      experimentWarning.getAttribute(&quot;hidden&quot;),</span>
<a href="#l10.41"></a><span id="l10.41" class="difflineplus">+      &quot;&quot;,</span>
<a href="#l10.42"></a><span id="l10.42" class="difflineplus">+      &quot;Experiments warning is visible&quot;</span>
<a href="#l10.43"></a><span id="l10.43" class="difflineplus">+    );</span>
<a href="#l10.44"></a><span id="l10.44" class="difflineplus">+  } else {</span>
<a href="#l10.45"></a><span id="l10.45" class="difflineplus">+    is(</span>
<a href="#l10.46"></a><span id="l10.46" class="difflineplus">+      experimentWarning.getAttribute(&quot;hidden&quot;),</span>
<a href="#l10.47"></a><span id="l10.47" class="difflineplus">+      &quot;true&quot;,</span>
<a href="#l10.48"></a><span id="l10.48" class="difflineplus">+      &quot;Experiments warning is hidden&quot;</span>
<a href="#l10.49"></a><span id="l10.49" class="difflineplus">+    );</span>
<a href="#l10.50"></a><span id="l10.50" class="difflineplus">+  }</span>
<a href="#l10.51"></a><span id="l10.51"> }</span>
<a href="#l10.52"></a><span id="l10.52"> </span>
<a href="#l10.53"></a><span id="l10.53"> /**</span>
<a href="#l10.54"></a><span id="l10.54">  * Test that install-time permission prompts work for a given</span>
<a href="#l10.55"></a><span id="l10.55">  * installation method.</span>
<a href="#l10.56"></a><span id="l10.56">  *</span>
<a href="#l10.57"></a><span id="l10.57">  * @param {Function} installFn</span>
<a href="#l10.58"></a><span id="l10.58">  *        Callable that takes the name of an xpi file to install and</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mail/locales/en-US/chrome/messenger/addons.properties</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mail/locales/en-US/chrome/messenger/addons.properties</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -106,16 +106,18 @@ addonInstallErrorBlocklisted=%S could no</span>
<a href="#l11.4"></a><span id="l11.4"> # LOCALIZATION NOTE (webextPerms.header)</span>
<a href="#l11.5"></a><span id="l11.5"> # This string is used as a header in the webextension permissions dialog,</span>
<a href="#l11.6"></a><span id="l11.6"> # %S is replaced with the localized name of the extension being installed.</span>
<a href="#l11.7"></a><span id="l11.7"> # See https://bug1308309.bmoattachments.org/attachment.cgi?id=8814612</span>
<a href="#l11.8"></a><span id="l11.8"> # for an example of the full dialog.</span>
<a href="#l11.9"></a><span id="l11.9"> # Note, this string will be used as raw markup. Avoid characters like &lt;, &gt;, &amp;</span>
<a href="#l11.10"></a><span id="l11.10"> webextPerms.header=Add %S?</span>
<a href="#l11.11"></a><span id="l11.11"> </span>
<a href="#l11.12"></a><span id="l11.12" class="difflineplus">+# %S is brandShortName</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+webextPerms.experimentWarning=Malicious add-ons can steal your private information or compromise your computer. Only install this add-on if you trust the source.</span>
<a href="#l11.14"></a><span id="l11.14"> webextPerms.unsignedWarning=Caution: This add-on is unverified. Malicious add-ons can steal your private information or compromise your computer. Only install this add-on if you trust the source.</span>
<a href="#l11.15"></a><span id="l11.15"> </span>
<a href="#l11.16"></a><span id="l11.16"> # LOCALIZATION NOTE (webextPerms.listIntro)</span>
<a href="#l11.17"></a><span id="l11.17"> # This string will be followed by a list of permissions requested</span>
<a href="#l11.18"></a><span id="l11.18"> # by the webextension.</span>
<a href="#l11.19"></a><span id="l11.19"> webextPerms.listIntro=It requires your permission to:</span>
<a href="#l11.20"></a><span id="l11.20"> webextPerms.learnMore=Learn more about permissions</span>
<a href="#l11.21"></a><span id="l11.21"> webextPerms.add.label=Add</span>
<a href="#l11.22"></a><span id="l11.22" class="difflineat">@@ -174,16 +176,19 @@ webextPerms.description.browserSettings=</span>
<a href="#l11.23"></a><span id="l11.23"> webextPerms.description.browsingData=Clear recent browsing history, cookies, and related data</span>
<a href="#l11.24"></a><span id="l11.24"> webextPerms.description.clipboardRead=Get data from the clipboard</span>
<a href="#l11.25"></a><span id="l11.25"> webextPerms.description.clipboardWrite=Input data to the clipboard</span>
<a href="#l11.26"></a><span id="l11.26"> webextPerms.description.compose=Read and modify your email messages as you compose and send them</span>
<a href="#l11.27"></a><span id="l11.27"> webextPerms.description.devtools=Extend developer tools to access your data in open tabs</span>
<a href="#l11.28"></a><span id="l11.28"> webextPerms.description.dns=Access IP address and hostname information</span>
<a href="#l11.29"></a><span id="l11.29"> webextPerms.description.downloads=Download files and read and modify the browser’s download history</span>
<a href="#l11.30"></a><span id="l11.30"> webextPerms.description.downloads.open=Open files downloaded to your computer</span>
<a href="#l11.31"></a><span id="l11.31" class="difflineplus">+# LOCALIZATION NOTE (webextPerms.description.experiment)</span>
<a href="#l11.32"></a><span id="l11.32" class="difflineplus">+# %S will be replaced with the name of the application</span>
<a href="#l11.33"></a><span id="l11.33" class="difflineplus">+webextPerms.description.experiment=Have full, unrestricted access to %S, and your computer</span>
<a href="#l11.34"></a><span id="l11.34"> webextPerms.description.find=Read the text of all open tabs</span>
<a href="#l11.35"></a><span id="l11.35"> webextPerms.description.geolocation=Access your location</span>
<a href="#l11.36"></a><span id="l11.36"> webextPerms.description.history=Access browsing history</span>
<a href="#l11.37"></a><span id="l11.37"> webextPerms.description.management=Monitor extension usage and manage themes</span>
<a href="#l11.38"></a><span id="l11.38"> webextPerms.description.messagesMove=Move, copy, or delete your email messages</span>
<a href="#l11.39"></a><span id="l11.39"> webextPerms.description.messagesRead=Read your email messages and mark or tag them</span>
<a href="#l11.40"></a><span id="l11.40"> # LOCALIZATION NOTE (webextPerms.description.nativeMessaging)</span>
<a href="#l11.41"></a><span id="l11.41"> # %S will be replaced with the name of the application</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mail/themes/shared/mail/messenger.css</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mail/themes/shared/mail/messenger.css</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -187,16 +187,20 @@ description.error {</span>
<a href="#l12.4"></a><span id="l12.4"> .popup-notification-icon[popupid=&quot;app-update&quot;].updates-unsupported {</span>
<a href="#l12.5"></a><span id="l12.5">   background-color: #FFE900;</span>
<a href="#l12.6"></a><span id="l12.6"> }</span>
<a href="#l12.7"></a><span id="l12.7"> </span>
<a href="#l12.8"></a><span id="l12.8"> html|ul.addon-installed-list {</span>
<a href="#l12.9"></a><span id="l12.9">   margin-top: 0;</span>
<a href="#l12.10"></a><span id="l12.10"> }</span>
<a href="#l12.11"></a><span id="l12.11"> </span>
<a href="#l12.12"></a><span id="l12.12" class="difflineplus">+html|ul.addon-webext-perm-list:empty {</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+  display: none;</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineplus">+}</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineplus">+</span>
<a href="#l12.16"></a><span id="l12.16"> #tabbar-toolbar {</span>
<a href="#l12.17"></a><span id="l12.17">   -moz-appearance: none;</span>
<a href="#l12.18"></a><span id="l12.18">   padding: 0;</span>
<a href="#l12.19"></a><span id="l12.19"> }</span>
<a href="#l12.20"></a><span id="l12.20"> </span>
<a href="#l12.21"></a><span id="l12.21"> #tabbar-toolbar[customizing=&quot;true&quot;] {</span>
<a href="#l12.22"></a><span id="l12.22">   min-width: 16px;</span>
<a href="#l12.23"></a><span id="l12.23">   min-height: 10px;</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:33Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

