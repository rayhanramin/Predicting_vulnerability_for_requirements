<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 22540:bc4dff04bede39d57bc4353f8eeae800fb470877</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ bc4dff04bede39d57bc4353f8eeae800fb470877" />
<meta property="og:url" content="/comm-central/rev/bc4dff04bede39d57bc4353f8eeae800fb470877" />
<meta property="og:description" content="Bug 1410973 - make nsMsgI18NFileSystemCharset() return an nsCString and related clean-up. r=erahm" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / bc4dff04bede39d57bc4353f8eeae800fb470877 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/bc4dff04bede39d57bc4353f8eeae800fb470877">shortlog</a> |
<a href="/comm-central/log/bc4dff04bede39d57bc4353f8eeae800fb470877">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/bc4dff04bede39d57bc4353f8eeae800fb470877">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/bc4dff04bede39d57bc4353f8eeae800fb470877">files</a> |
changeset |
<a href="/comm-central/raw-rev/bc4dff04bede39d57bc4353f8eeae800fb470877">raw</a>  | <a href="/comm-central/archive/bc4dff04bede39d57bc4353f8eeae800fb470877.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1410973">Bug 1410973</a> - make nsMsgI18NFileSystemCharset() return an nsCString and related clean-up. r=erahm
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#74;&#111;&#114;&#103;&#32;&#75;&#32;&#60;&#106;&#111;&#114;&#103;&#107;&#64;&#106;&#111;&#114;&#103;&#107;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Mon, 13 Nov 2017 23:48:53 +0100</td></tr>

<tr>
 <td>changeset 22540</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/bc4dff04bede39d57bc4353f8eeae800fb470877">bc4dff04bede39d57bc4353f8eeae800fb470877</a></td>
</tr>



<tr>
<td>parent 22539</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/b78d73bcd985069e7def132f00540e2cea19be92">b78d73bcd985069e7def132f00540e2cea19be92</a>
</td>
</tr>

<tr>
<td>child 22541</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/0b656c52b5465d8de6bc3bd42a66d3d26cf056cb">0b656c52b5465d8de6bc3bd42a66d3d26cf056cb</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=bc4dff04bede39d57bc4353f8eeae800fb470877">13745</a></td></tr>
<tr><td>push user</td><td>mozilla@jorgk.com</td></tr>
<tr><td>push date</td><td class="date age">Mon, 13 Nov 2017 23:20:12 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@c412f40f1eec [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=c412f40f1eecf46cb25ad3b47e7323ed360c0028">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=c412f40f1eecf46cb25ad3b47e7323ed360c0028&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=c412f40f1eecf46cb25ad3b47e7323ed360c0028&newProject=comm-central&newRevision=bc4dff04bede39d57bc4353f8eeae800fb470877&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=c412f40f1eecf46cb25ad3b47e7323ed360c0028&newProject=comm-central&newRevision=bc4dff04bede39d57bc4353f8eeae800fb470877&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=c412f40f1eecf46cb25ad3b47e7323ed360c0028&newProject=comm-central&newRevision=bc4dff04bede39d57bc4353f8eeae800fb470877&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28erahm%29&revcount=50">erahm</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1410973">1410973</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1410973">Bug 1410973</a> - make nsMsgI18NFileSystemCharset() return an nsCString and related clean-up. r=erahm</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/addrbook/src/nsAbManager.cpp">mailnews/addrbook/src/nsAbManager.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/addrbook/src/nsAbManager.cpp">file</a> |
<a href="/comm-central/annotate/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/addrbook/src/nsAbManager.cpp">annotate</a> |
<a href="/comm-central/diff/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/addrbook/src/nsAbManager.cpp">diff</a> |
<a href="/comm-central/comparison/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/addrbook/src/nsAbManager.cpp">comparison</a> |
<a href="/comm-central/log/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/addrbook/src/nsAbManager.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/base/search/src/nsMsgSearchAdapter.cpp">mailnews/base/search/src/nsMsgSearchAdapter.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/base/search/src/nsMsgSearchAdapter.cpp">file</a> |
<a href="/comm-central/annotate/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/base/search/src/nsMsgSearchAdapter.cpp">annotate</a> |
<a href="/comm-central/diff/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/base/search/src/nsMsgSearchAdapter.cpp">diff</a> |
<a href="/comm-central/comparison/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/base/search/src/nsMsgSearchAdapter.cpp">comparison</a> |
<a href="/comm-central/log/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/base/search/src/nsMsgSearchAdapter.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/base/search/src/nsMsgSearchTerm.cpp">mailnews/base/search/src/nsMsgSearchTerm.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/base/search/src/nsMsgSearchTerm.cpp">file</a> |
<a href="/comm-central/annotate/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/base/search/src/nsMsgSearchTerm.cpp">annotate</a> |
<a href="/comm-central/diff/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/base/search/src/nsMsgSearchTerm.cpp">diff</a> |
<a href="/comm-central/comparison/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/base/search/src/nsMsgSearchTerm.cpp">comparison</a> |
<a href="/comm-central/log/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/base/search/src/nsMsgSearchTerm.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/base/util/nsMsgDBFolder.cpp">mailnews/base/util/nsMsgDBFolder.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/base/util/nsMsgDBFolder.cpp">file</a> |
<a href="/comm-central/annotate/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/base/util/nsMsgDBFolder.cpp">annotate</a> |
<a href="/comm-central/diff/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/base/util/nsMsgDBFolder.cpp">diff</a> |
<a href="/comm-central/comparison/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/base/util/nsMsgDBFolder.cpp">comparison</a> |
<a href="/comm-central/log/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/base/util/nsMsgDBFolder.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/base/util/nsMsgI18N.cpp">mailnews/base/util/nsMsgI18N.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/base/util/nsMsgI18N.cpp">file</a> |
<a href="/comm-central/annotate/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/base/util/nsMsgI18N.cpp">annotate</a> |
<a href="/comm-central/diff/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/base/util/nsMsgI18N.cpp">diff</a> |
<a href="/comm-central/comparison/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/base/util/nsMsgI18N.cpp">comparison</a> |
<a href="/comm-central/log/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/base/util/nsMsgI18N.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/base/util/nsMsgI18N.h">mailnews/base/util/nsMsgI18N.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/base/util/nsMsgI18N.h">file</a> |
<a href="/comm-central/annotate/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/base/util/nsMsgI18N.h">annotate</a> |
<a href="/comm-central/diff/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/base/util/nsMsgI18N.h">diff</a> |
<a href="/comm-central/comparison/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/base/util/nsMsgI18N.h">comparison</a> |
<a href="/comm-central/log/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/base/util/nsMsgI18N.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/compose/src/nsMsgAttachmentHandler.cpp">mailnews/compose/src/nsMsgAttachmentHandler.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/compose/src/nsMsgAttachmentHandler.cpp">file</a> |
<a href="/comm-central/annotate/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/compose/src/nsMsgAttachmentHandler.cpp">annotate</a> |
<a href="/comm-central/diff/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/compose/src/nsMsgAttachmentHandler.cpp">diff</a> |
<a href="/comm-central/comparison/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/compose/src/nsMsgAttachmentHandler.cpp">comparison</a> |
<a href="/comm-central/log/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/compose/src/nsMsgAttachmentHandler.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/compose/src/nsMsgCompUtils.cpp">mailnews/compose/src/nsMsgCompUtils.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/compose/src/nsMsgCompUtils.cpp">file</a> |
<a href="/comm-central/annotate/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/compose/src/nsMsgCompUtils.cpp">annotate</a> |
<a href="/comm-central/diff/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/compose/src/nsMsgCompUtils.cpp">diff</a> |
<a href="/comm-central/comparison/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/compose/src/nsMsgCompUtils.cpp">comparison</a> |
<a href="/comm-central/log/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/compose/src/nsMsgCompUtils.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/compose/src/nsMsgCompose.cpp">mailnews/compose/src/nsMsgCompose.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/compose/src/nsMsgCompose.cpp">file</a> |
<a href="/comm-central/annotate/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/compose/src/nsMsgCompose.cpp">annotate</a> |
<a href="/comm-central/diff/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/compose/src/nsMsgCompose.cpp">diff</a> |
<a href="/comm-central/comparison/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/compose/src/nsMsgCompose.cpp">comparison</a> |
<a href="/comm-central/log/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/compose/src/nsMsgCompose.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/compose/src/nsMsgComposeService.cpp">mailnews/compose/src/nsMsgComposeService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/compose/src/nsMsgComposeService.cpp">file</a> |
<a href="/comm-central/annotate/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/compose/src/nsMsgComposeService.cpp">annotate</a> |
<a href="/comm-central/diff/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/compose/src/nsMsgComposeService.cpp">diff</a> |
<a href="/comm-central/comparison/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/compose/src/nsMsgComposeService.cpp">comparison</a> |
<a href="/comm-central/log/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/compose/src/nsMsgComposeService.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/compose/src/nsMsgSend.cpp">mailnews/compose/src/nsMsgSend.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/compose/src/nsMsgSend.cpp">file</a> |
<a href="/comm-central/annotate/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/compose/src/nsMsgSend.cpp">annotate</a> |
<a href="/comm-central/diff/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/compose/src/nsMsgSend.cpp">diff</a> |
<a href="/comm-central/comparison/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/compose/src/nsMsgSend.cpp">comparison</a> |
<a href="/comm-central/log/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/compose/src/nsMsgSend.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/import/becky/src/nsBeckyUtils.cpp">mailnews/import/becky/src/nsBeckyUtils.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/import/becky/src/nsBeckyUtils.cpp">file</a> |
<a href="/comm-central/annotate/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/import/becky/src/nsBeckyUtils.cpp">annotate</a> |
<a href="/comm-central/diff/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/import/becky/src/nsBeckyUtils.cpp">diff</a> |
<a href="/comm-central/comparison/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/import/becky/src/nsBeckyUtils.cpp">comparison</a> |
<a href="/comm-central/log/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/import/becky/src/nsBeckyUtils.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/import/outlook/src/MapiMessage.cpp">mailnews/import/outlook/src/MapiMessage.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/import/outlook/src/MapiMessage.cpp">file</a> |
<a href="/comm-central/annotate/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/import/outlook/src/MapiMessage.cpp">annotate</a> |
<a href="/comm-central/diff/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/import/outlook/src/MapiMessage.cpp">diff</a> |
<a href="/comm-central/comparison/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/import/outlook/src/MapiMessage.cpp">comparison</a> |
<a href="/comm-central/log/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/import/outlook/src/MapiMessage.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/import/outlook/src/nsOutlookCompose.cpp">mailnews/import/outlook/src/nsOutlookCompose.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/import/outlook/src/nsOutlookCompose.cpp">file</a> |
<a href="/comm-central/annotate/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/import/outlook/src/nsOutlookCompose.cpp">annotate</a> |
<a href="/comm-central/diff/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/import/outlook/src/nsOutlookCompose.cpp">diff</a> |
<a href="/comm-central/comparison/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/import/outlook/src/nsOutlookCompose.cpp">comparison</a> |
<a href="/comm-central/log/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/import/outlook/src/nsOutlookCompose.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/import/text/src/nsTextAddress.cpp">mailnews/import/text/src/nsTextAddress.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/import/text/src/nsTextAddress.cpp">file</a> |
<a href="/comm-central/annotate/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/import/text/src/nsTextAddress.cpp">annotate</a> |
<a href="/comm-central/diff/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/import/text/src/nsTextAddress.cpp">diff</a> |
<a href="/comm-central/comparison/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/import/text/src/nsTextAddress.cpp">comparison</a> |
<a href="/comm-central/log/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/import/text/src/nsTextAddress.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/mapi/mapihook/src/msgMapiHook.cpp">mailnews/mapi/mapihook/src/msgMapiHook.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/mapi/mapihook/src/msgMapiHook.cpp">file</a> |
<a href="/comm-central/annotate/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/mapi/mapihook/src/msgMapiHook.cpp">annotate</a> |
<a href="/comm-central/diff/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/mapi/mapihook/src/msgMapiHook.cpp">diff</a> |
<a href="/comm-central/comparison/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/mapi/mapihook/src/msgMapiHook.cpp">comparison</a> |
<a href="/comm-central/log/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/mapi/mapihook/src/msgMapiHook.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/mime/src/mimedrft.cpp">mailnews/mime/src/mimedrft.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/mime/src/mimedrft.cpp">file</a> |
<a href="/comm-central/annotate/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/mime/src/mimedrft.cpp">annotate</a> |
<a href="/comm-central/diff/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/mime/src/mimedrft.cpp">diff</a> |
<a href="/comm-central/comparison/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/mime/src/mimedrft.cpp">comparison</a> |
<a href="/comm-central/log/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/mime/src/mimedrft.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/mime/src/mimehdrs.cpp">mailnews/mime/src/mimehdrs.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/mime/src/mimehdrs.cpp">file</a> |
<a href="/comm-central/annotate/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/mime/src/mimehdrs.cpp">annotate</a> |
<a href="/comm-central/diff/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/mime/src/mimehdrs.cpp">diff</a> |
<a href="/comm-central/comparison/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/mime/src/mimehdrs.cpp">comparison</a> |
<a href="/comm-central/log/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/mime/src/mimehdrs.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/mime/src/mimemsg.cpp">mailnews/mime/src/mimemsg.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/mime/src/mimemsg.cpp">file</a> |
<a href="/comm-central/annotate/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/mime/src/mimemsg.cpp">annotate</a> |
<a href="/comm-central/diff/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/mime/src/mimemsg.cpp">diff</a> |
<a href="/comm-central/comparison/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/mime/src/mimemsg.cpp">comparison</a> |
<a href="/comm-central/log/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/mime/src/mimemsg.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/mime/src/mimetpfl.cpp">mailnews/mime/src/mimetpfl.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/mime/src/mimetpfl.cpp">file</a> |
<a href="/comm-central/annotate/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/mime/src/mimetpfl.cpp">annotate</a> |
<a href="/comm-central/diff/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/mime/src/mimetpfl.cpp">diff</a> |
<a href="/comm-central/comparison/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/mime/src/mimetpfl.cpp">comparison</a> |
<a href="/comm-central/log/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/mime/src/mimetpfl.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/mime/src/mimetpla.cpp">mailnews/mime/src/mimetpla.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/mime/src/mimetpla.cpp">file</a> |
<a href="/comm-central/annotate/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/mime/src/mimetpla.cpp">annotate</a> |
<a href="/comm-central/diff/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/mime/src/mimetpla.cpp">diff</a> |
<a href="/comm-central/comparison/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/mime/src/mimetpla.cpp">comparison</a> |
<a href="/comm-central/log/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/mime/src/mimetpla.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/news/src/nsNNTPProtocol.cpp">mailnews/news/src/nsNNTPProtocol.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/news/src/nsNNTPProtocol.cpp">file</a> |
<a href="/comm-central/annotate/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/news/src/nsNNTPProtocol.cpp">annotate</a> |
<a href="/comm-central/diff/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/news/src/nsNNTPProtocol.cpp">diff</a> |
<a href="/comm-central/comparison/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/news/src/nsNNTPProtocol.cpp">comparison</a> |
<a href="/comm-central/log/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/news/src/nsNNTPProtocol.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/news/src/nsNewsFolder.cpp">mailnews/news/src/nsNewsFolder.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/news/src/nsNewsFolder.cpp">file</a> |
<a href="/comm-central/annotate/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/news/src/nsNewsFolder.cpp">annotate</a> |
<a href="/comm-central/diff/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/news/src/nsNewsFolder.cpp">diff</a> |
<a href="/comm-central/comparison/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/news/src/nsNewsFolder.cpp">comparison</a> |
<a href="/comm-central/log/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/news/src/nsNewsFolder.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/news/src/nsNntpIncomingServer.cpp">mailnews/news/src/nsNntpIncomingServer.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/news/src/nsNntpIncomingServer.cpp">file</a> |
<a href="/comm-central/annotate/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/news/src/nsNntpIncomingServer.cpp">annotate</a> |
<a href="/comm-central/diff/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/news/src/nsNntpIncomingServer.cpp">diff</a> |
<a href="/comm-central/comparison/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/news/src/nsNntpIncomingServer.cpp">comparison</a> |
<a href="/comm-central/log/bc4dff04bede39d57bc4353f8eeae800fb470877/mailnews/news/src/nsNntpIncomingServer.cpp">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbManager.cpp</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbManager.cpp</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -729,18 +729,20 @@ nsAbManager::ExportDirectoryToDelimitedT</span>
<a href="#l1.4"></a><span id="l1.4">   for (i = 0; i &lt; ArrayLength(EXPORT_ATTRIBUTES_TABLE); i++) {</span>
<a href="#l1.5"></a><span id="l1.5">     if (EXPORT_ATTRIBUTES_TABLE[i].plainTextStringID != 0) {</span>
<a href="#l1.6"></a><span id="l1.6"> </span>
<a href="#l1.7"></a><span id="l1.7">       // We don't need to truncate the string here as getter_Copies will</span>
<a href="#l1.8"></a><span id="l1.8">       // do that for us.</span>
<a href="#l1.9"></a><span id="l1.9">       if (NS_FAILED(bundle-&gt;GetStringFromID(EXPORT_ATTRIBUTES_TABLE[i].plainTextStringID, columnName)))</span>
<a href="#l1.10"></a><span id="l1.10">         columnName.AppendInt(EXPORT_ATTRIBUTES_TABLE[i].plainTextStringID);</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-      rv = nsMsgI18NConvertFromUnicode(useUTF8 ? &quot;UTF-8&quot; : nsMsgI18NFileSystemCharset(),</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-                                       columnName, revisedName);</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+      rv = nsMsgI18NConvertFromUnicode(useUTF8 ? NS_LITERAL_CSTRING(&quot;UTF-8&quot;) :</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+                                                 nsMsgI18NFileSystemCharset(),</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineplus">+                                       columnName,</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineplus">+                                       revisedName);</span>
<a href="#l1.18"></a><span id="l1.18">       NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l1.19"></a><span id="l1.19"> </span>
<a href="#l1.20"></a><span id="l1.20">       rv = outputStream-&gt;Write(revisedName.get(),</span>
<a href="#l1.21"></a><span id="l1.21">                                revisedName.Length(),</span>
<a href="#l1.22"></a><span id="l1.22">                                &amp;writeCount);</span>
<a href="#l1.23"></a><span id="l1.23">       NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l1.24"></a><span id="l1.24"> </span>
<a href="#l1.25"></a><span id="l1.25">       if (revisedName.Length() != writeCount)</span>
<a href="#l1.26"></a><span id="l1.26" class="difflineat">@@ -820,18 +822,20 @@ nsAbManager::ExportDirectoryToDelimitedT</span>
<a href="#l1.27"></a><span id="l1.27">                   needsQuotes = true;</span>
<a href="#l1.28"></a><span id="l1.28"> </span>
<a href="#l1.29"></a><span id="l1.29">               if (needsQuotes)</span>
<a href="#l1.30"></a><span id="l1.30">               {</span>
<a href="#l1.31"></a><span id="l1.31">                 newValue.InsertLiteral(u&quot;\&quot;&quot;, 0);</span>
<a href="#l1.32"></a><span id="l1.32">                 newValue.Append(u'&quot;');</span>
<a href="#l1.33"></a><span id="l1.33">               }</span>
<a href="#l1.34"></a><span id="l1.34"> </span>
<a href="#l1.35"></a><span id="l1.35" class="difflineminus">-              rv = nsMsgI18NConvertFromUnicode(useUTF8 ? &quot;UTF-8&quot; : nsMsgI18NFileSystemCharset(),</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineminus">-                                               newValue, valueCStr);</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineplus">+              rv = nsMsgI18NConvertFromUnicode(useUTF8 ? NS_LITERAL_CSTRING(&quot;UTF-8&quot;) :</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineplus">+                                                         nsMsgI18NFileSystemCharset(),</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineplus">+                                               newValue,</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineplus">+                                               valueCStr);</span>
<a href="#l1.41"></a><span id="l1.41">               NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l1.42"></a><span id="l1.42"> </span>
<a href="#l1.43"></a><span id="l1.43">               if (NS_FAILED(rv)) {</span>
<a href="#l1.44"></a><span id="l1.44">                 NS_ERROR(&quot;failed to convert string to system charset.  use LDIF&quot;);</span>
<a href="#l1.45"></a><span id="l1.45">                 valueCStr = &quot;?&quot;;</span>
<a href="#l1.46"></a><span id="l1.46">               }</span>
<a href="#l1.47"></a><span id="l1.47"> </span>
<a href="#l1.48"></a><span id="l1.48">               length = valueCStr.Length();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/base/search/src/nsMsgSearchAdapter.cpp</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/base/search/src/nsMsgSearchAdapter.cpp</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -544,17 +544,18 @@ nsresult nsMsgSearchAdapter::EncodeImapT</span>
<a href="#l2.4"></a><span id="l2.4">         // do all sorts of crazy escaping</span>
<a href="#l2.5"></a><span id="l2.5">         convertedValue = reallyDredd ? EscapeSearchUrl (searchTermValue.get()) :</span>
<a href="#l2.6"></a><span id="l2.6">         EscapeImapSearchProtocol(searchTermValue.get());</span>
<a href="#l2.7"></a><span id="l2.7">         useQuotes = ((!reallyDredd ||</span>
<a href="#l2.8"></a><span id="l2.8">                     (nsDependentString(convertedValue).FindChar(char16_t(' ')) != -1)) &amp;&amp;</span>
<a href="#l2.9"></a><span id="l2.9">            (attrib != nsMsgSearchAttrib::Keywords));</span>
<a href="#l2.10"></a><span id="l2.10">         // now convert to char* and escape quoted_specials</span>
<a href="#l2.11"></a><span id="l2.11">         nsAutoCString valueStr;</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-        nsresult rv = ConvertFromUnicode(NS_LossyConvertUTF16toASCII(destCharset).get(),</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+        nsresult rv = nsMsgI18NConvertFromUnicode(</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+          NS_LossyConvertUTF16toASCII(destCharset),</span>
<a href="#l2.15"></a><span id="l2.15">           nsDependentString(convertedValue), valueStr);</span>
<a href="#l2.16"></a><span id="l2.16">         if (NS_SUCCEEDED(rv))</span>
<a href="#l2.17"></a><span id="l2.17">         {</span>
<a href="#l2.18"></a><span id="l2.18">           const char *vptr = valueStr.get();</span>
<a href="#l2.19"></a><span id="l2.19">           // max escaped length is one extra character for every character in the cmd.</span>
<a href="#l2.20"></a><span id="l2.20">           mozilla::UniquePtr&lt;char[]&gt; newValue = mozilla::MakeUnique&lt;char[]&gt;(2*strlen(vptr) + 1);</span>
<a href="#l2.21"></a><span id="l2.21">           if (newValue)</span>
<a href="#l2.22"></a><span id="l2.22">           {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/base/search/src/nsMsgSearchTerm.cpp</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/base/search/src/nsMsgSearchTerm.cpp</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -1111,17 +1111,19 @@ nsresult nsMsgSearchTerm::MatchString(co</span>
<a href="#l3.4"></a><span id="l3.4">     if (!stringToMatch.IsEmpty())</span>
<a href="#l3.5"></a><span id="l3.5">       result = true;</span>
<a href="#l3.6"></a><span id="l3.6">   }</span>
<a href="#l3.7"></a><span id="l3.7">   else</span>
<a href="#l3.8"></a><span id="l3.8">   {</span>
<a href="#l3.9"></a><span id="l3.9">     nsAutoString utf16StrToMatch;</span>
<a href="#l3.10"></a><span id="l3.10">     if (charset != nullptr)</span>
<a href="#l3.11"></a><span id="l3.11">     {</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-      ConvertToUnicode(charset, nsCString(stringToMatch), utf16StrToMatch);</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+      nsMsgI18NConvertToUnicode(nsDependentCString(charset),</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+                                stringToMatch,</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+                                utf16StrToMatch);</span>
<a href="#l3.16"></a><span id="l3.16">     }</span>
<a href="#l3.17"></a><span id="l3.17">     else {</span>
<a href="#l3.18"></a><span id="l3.18">       NS_ASSERTION(MsgIsUTF8(stringToMatch), &quot;stringToMatch is not UTF-8&quot;);</span>
<a href="#l3.19"></a><span id="l3.19">       CopyUTF8toUTF16(stringToMatch, utf16StrToMatch);</span>
<a href="#l3.20"></a><span id="l3.20">     }</span>
<a href="#l3.21"></a><span id="l3.21">     rv = MatchString(utf16StrToMatch, &amp;result);</span>
<a href="#l3.22"></a><span id="l3.22">   }</span>
<a href="#l3.23"></a><span id="l3.23"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/base/util/nsMsgDBFolder.cpp</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgDBFolder.cpp</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -5620,17 +5620,17 @@ NS_IMETHODIMP nsMsgDBFolder::GetMsgTextF</span>
<a href="#l4.4"></a><span id="l4.4"> </span>
<a href="#l4.5"></a><span id="l4.5">   // if the snippet is encoded, decode it</span>
<a href="#l4.6"></a><span id="l4.6">   if (!encoding.IsEmpty())</span>
<a href="#l4.7"></a><span id="l4.7">     decodeMsgSnippet(NS_ConvertUTF16toUTF8(encoding), !reachedEndBody, msgText);</span>
<a href="#l4.8"></a><span id="l4.8"> </span>
<a href="#l4.9"></a><span id="l4.9">   // In order to turn our snippet into unicode, we need to convert it from the charset we</span>
<a href="#l4.10"></a><span id="l4.10">   // detected earlier.</span>
<a href="#l4.11"></a><span id="l4.11">   nsString unicodeMsgBodyStr;</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-  ConvertToUnicode(charset.get(), msgText, unicodeMsgBodyStr);</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+  nsMsgI18NConvertToUnicode(charset, msgText, unicodeMsgBodyStr);</span>
<a href="#l4.14"></a><span id="l4.14"> </span>
<a href="#l4.15"></a><span id="l4.15">   // now we've got a msg body. If it's html, convert it to plain text.</span>
<a href="#l4.16"></a><span id="l4.16">   if (msgBodyIsHtml &amp;&amp; aStripHTMLTags)</span>
<a href="#l4.17"></a><span id="l4.17">     ConvertMsgSnippetToPlainText(unicodeMsgBodyStr, unicodeMsgBodyStr);</span>
<a href="#l4.18"></a><span id="l4.18"> </span>
<a href="#l4.19"></a><span id="l4.19">   // We want to remove any whitespace from the beginning and end of the string</span>
<a href="#l4.20"></a><span id="l4.20">   unicodeMsgBodyStr.Trim(&quot; \t\r\n&quot;, true, true);</span>
<a href="#l4.21"></a><span id="l4.21"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/base/util/nsMsgI18N.cpp</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgI18N.cpp</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -28,27 +28,27 @@</span>
<a href="#l5.4"></a><span id="l5.4"> #include &quot;nsIFileStreams.h&quot;</span>
<a href="#l5.5"></a><span id="l5.5"> #include &quot;../../intl/nsMUTF7ToUnicode.h&quot;</span>
<a href="#l5.6"></a><span id="l5.6"> #include &quot;../../intl/nsUnicodeToMUTF7.h&quot;</span>
<a href="#l5.7"></a><span id="l5.7"> </span>
<a href="#l5.8"></a><span id="l5.8"> //</span>
<a href="#l5.9"></a><span id="l5.9"> // International functions necessary for composition</span>
<a href="#l5.10"></a><span id="l5.10"> //</span>
<a href="#l5.11"></a><span id="l5.11"> </span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-nsresult nsMsgI18NConvertFromUnicode(const char* aCharset,</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineminus">-                                     const nsString&amp; inString,</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+nsresult nsMsgI18NConvertFromUnicode(const nsACString&amp; aCharset,</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineplus">+                                     const nsAString&amp; inString,</span>
<a href="#l5.16"></a><span id="l5.16">                                      nsACString&amp; outString,</span>
<a href="#l5.17"></a><span id="l5.17">                                      bool aReportUencNoMapping)</span>
<a href="#l5.18"></a><span id="l5.18"> {</span>
<a href="#l5.19"></a><span id="l5.19">   if (inString.IsEmpty()) {</span>
<a href="#l5.20"></a><span id="l5.20">     outString.Truncate();</span>
<a href="#l5.21"></a><span id="l5.21">     return NS_OK;</span>
<a href="#l5.22"></a><span id="l5.22">   }</span>
<a href="#l5.23"></a><span id="l5.23"> </span>
<a href="#l5.24"></a><span id="l5.24" class="difflineminus">-  auto encoding = mozilla::Encoding::ForLabelNoReplacement(nsDependentCString(aCharset));</span>
<a href="#l5.25"></a><span id="l5.25" class="difflineplus">+  auto encoding = mozilla::Encoding::ForLabelNoReplacement(aCharset);</span>
<a href="#l5.26"></a><span id="l5.26">   if (!encoding) {</span>
<a href="#l5.27"></a><span id="l5.27">     return NS_ERROR_UCONV_NOCONV;</span>
<a href="#l5.28"></a><span id="l5.28">   } else if (encoding == UTF_16LE_ENCODING || encoding == UTF_16BE_ENCODING) {</span>
<a href="#l5.29"></a><span id="l5.29">     // We shouldn't ever ship anything in these encodings.</span>
<a href="#l5.30"></a><span id="l5.30">     return NS_ERROR_UCONV_NOCONV;</span>
<a href="#l5.31"></a><span id="l5.31">   }</span>
<a href="#l5.32"></a><span id="l5.32"> </span>
<a href="#l5.33"></a><span id="l5.33">   const mozilla::Encoding* actualEncoding;</span>
<a href="#l5.34"></a><span id="l5.34" class="difflineat">@@ -58,34 +58,34 @@ nsresult nsMsgI18NConvertFromUnicode(con</span>
<a href="#l5.35"></a><span id="l5.35"> </span>
<a href="#l5.36"></a><span id="l5.36">   if (rv == NS_OK_HAD_REPLACEMENTS) {</span>
<a href="#l5.37"></a><span id="l5.37">     rv = aReportUencNoMapping ? NS_ERROR_UENC_NOMAPPING : NS_OK;</span>
<a href="#l5.38"></a><span id="l5.38">   }</span>
<a href="#l5.39"></a><span id="l5.39"> </span>
<a href="#l5.40"></a><span id="l5.40">   return rv;</span>
<a href="#l5.41"></a><span id="l5.41"> }</span>
<a href="#l5.42"></a><span id="l5.42"> </span>
<a href="#l5.43"></a><span id="l5.43" class="difflineminus">-nsresult nsMsgI18NConvertToUnicode(const char* aCharset,</span>
<a href="#l5.44"></a><span id="l5.44" class="difflineminus">-                                   const nsCString&amp; inString,</span>
<a href="#l5.45"></a><span id="l5.45" class="difflineplus">+nsresult nsMsgI18NConvertToUnicode(const nsACString&amp; aCharset,</span>
<a href="#l5.46"></a><span id="l5.46" class="difflineplus">+                                   const nsACString&amp; inString,</span>
<a href="#l5.47"></a><span id="l5.47">                                    nsAString&amp; outString)</span>
<a href="#l5.48"></a><span id="l5.48"> {</span>
<a href="#l5.49"></a><span id="l5.49">   if (inString.IsEmpty()) {</span>
<a href="#l5.50"></a><span id="l5.50">     outString.Truncate();</span>
<a href="#l5.51"></a><span id="l5.51">     return NS_OK;</span>
<a href="#l5.52"></a><span id="l5.52">   }</span>
<a href="#l5.53"></a><span id="l5.53" class="difflineminus">-  else if (!*aCharset) {</span>
<a href="#l5.54"></a><span id="l5.54" class="difflineplus">+  else if (aCharset.IsEmpty()) {</span>
<a href="#l5.55"></a><span id="l5.55">     // Despite its name, it also works for Latin-1.</span>
<a href="#l5.56"></a><span id="l5.56">     CopyASCIItoUTF16(inString, outString);</span>
<a href="#l5.57"></a><span id="l5.57">     return NS_OK;</span>
<a href="#l5.58"></a><span id="l5.58">   }</span>
<a href="#l5.59"></a><span id="l5.59" class="difflineminus">-  else if (!PL_strcasecmp(aCharset, &quot;UTF-8&quot;)) {</span>
<a href="#l5.60"></a><span id="l5.60" class="difflineplus">+  else if (aCharset.Equals(&quot;UTF-8&quot;, nsCaseInsensitiveCStringComparator())) {</span>
<a href="#l5.61"></a><span id="l5.61">     return UTF_8_ENCODING-&gt;DecodeWithBOMRemoval(inString, outString);</span>
<a href="#l5.62"></a><span id="l5.62">   }</span>
<a href="#l5.63"></a><span id="l5.63"> </span>
<a href="#l5.64"></a><span id="l5.64" class="difflineminus">-  auto encoding = mozilla::Encoding::ForLabelNoReplacement(nsDependentCString(aCharset));</span>
<a href="#l5.65"></a><span id="l5.65" class="difflineplus">+  auto encoding = mozilla::Encoding::ForLabelNoReplacement(aCharset);</span>
<a href="#l5.66"></a><span id="l5.66">   if (!encoding)</span>
<a href="#l5.67"></a><span id="l5.67">     return NS_ERROR_UCONV_NOCONV;</span>
<a href="#l5.68"></a><span id="l5.68">   return encoding-&gt;DecodeWithoutBOMHandlingAndWithoutReplacement(inString,</span>
<a href="#l5.69"></a><span id="l5.69">                                                                  outString);</span>
<a href="#l5.70"></a><span id="l5.70"> }</span>
<a href="#l5.71"></a><span id="l5.71"> </span>
<a href="#l5.72"></a><span id="l5.72"> nsresult CopyUTF16toMUTF7(const nsString &amp;aSrc, nsACString&amp; aDest)</span>
<a href="#l5.73"></a><span id="l5.73"> {</span>
<a href="#l5.74"></a><span id="l5.74" class="difflineat">@@ -120,42 +120,43 @@ nsresult CopyMUTF7toUTF16(const nsCStrin</span>
<a href="#l5.75"></a><span id="l5.75">   aDest.SetCapacity(outLen);</span>
<a href="#l5.76"></a><span id="l5.76">   converter.ConvertNoBuff(aSrc.get(), &amp;inLen, aDest.BeginWriting(), &amp;outLen);</span>
<a href="#l5.77"></a><span id="l5.77">   MOZ_ASSERT(inLen == (int32_t)aSrc.Length(), &quot;UTF-7 should not produce a longer output&quot;);</span>
<a href="#l5.78"></a><span id="l5.78">   aDest.SetLength(outLen);</span>
<a href="#l5.79"></a><span id="l5.79">   return NS_OK;</span>
<a href="#l5.80"></a><span id="l5.80"> }</span>
<a href="#l5.81"></a><span id="l5.81"> </span>
<a href="#l5.82"></a><span id="l5.82"> // Charset used by the file system.</span>
<a href="#l5.83"></a><span id="l5.83" class="difflineminus">-const char * nsMsgI18NFileSystemCharset()</span>
<a href="#l5.84"></a><span id="l5.84" class="difflineplus">+const nsACString&amp; nsMsgI18NFileSystemCharset()</span>
<a href="#l5.85"></a><span id="l5.85"> {</span>
<a href="#l5.86"></a><span id="l5.86">   /* Get a charset used for the file. */</span>
<a href="#l5.87"></a><span id="l5.87">   static nsAutoCString fileSystemCharset;</span>
<a href="#l5.88"></a><span id="l5.88"> </span>
<a href="#l5.89"></a><span id="l5.89">   if (fileSystemCharset.IsEmpty())</span>
<a href="#l5.90"></a><span id="l5.90">     mozilla::dom::FallbackEncoding::FromLocale()-&gt;Name(fileSystemCharset);</span>
<a href="#l5.91"></a><span id="l5.91"> </span>
<a href="#l5.92"></a><span id="l5.92" class="difflineminus">-  return fileSystemCharset.get();</span>
<a href="#l5.93"></a><span id="l5.93" class="difflineplus">+  return fileSystemCharset;</span>
<a href="#l5.94"></a><span id="l5.94"> }</span>
<a href="#l5.95"></a><span id="l5.95"> </span>
<a href="#l5.96"></a><span id="l5.96"> // Charset used by the text file.</span>
<a href="#l5.97"></a><span id="l5.97"> void nsMsgI18NTextFileCharset(nsACString&amp; aCharset)</span>
<a href="#l5.98"></a><span id="l5.98"> {</span>
<a href="#l5.99"></a><span id="l5.99">   mozilla::dom::FallbackEncoding::FromLocale()-&gt;Name(aCharset);</span>
<a href="#l5.100"></a><span id="l5.100"> }</span>
<a href="#l5.101"></a><span id="l5.101"> </span>
<a href="#l5.102"></a><span id="l5.102"> // MIME encoder, output string should be freed by PR_FREE</span>
<a href="#l5.103"></a><span id="l5.103"> // XXX : fix callers later to avoid allocation and copy</span>
<a href="#l5.104"></a><span id="l5.104"> char * nsMsgI18NEncodeMimePartIIStr(const char *header, bool structured, const char *charset, int32_t fieldnamelen, bool usemime)</span>
<a href="#l5.105"></a><span id="l5.105"> {</span>
<a href="#l5.106"></a><span id="l5.106">   // No MIME, convert to the outgoing mail charset.</span>
<a href="#l5.107"></a><span id="l5.107">   if (false == usemime) {</span>
<a href="#l5.108"></a><span id="l5.108">     nsAutoCString convertedStr;</span>
<a href="#l5.109"></a><span id="l5.109" class="difflineminus">-    if (NS_SUCCEEDED(ConvertFromUnicode(charset, NS_ConvertUTF8toUTF16(header),</span>
<a href="#l5.110"></a><span id="l5.110" class="difflineminus">-                                        convertedStr)))</span>
<a href="#l5.111"></a><span id="l5.111" class="difflineplus">+    if (NS_SUCCEEDED(nsMsgI18NConvertFromUnicode(nsDependentCString(charset),</span>
<a href="#l5.112"></a><span id="l5.112" class="difflineplus">+                                                 NS_ConvertUTF8toUTF16(header),</span>
<a href="#l5.113"></a><span id="l5.113" class="difflineplus">+                                                 convertedStr)))</span>
<a href="#l5.114"></a><span id="l5.114">       return PL_strdup(convertedStr.get());</span>
<a href="#l5.115"></a><span id="l5.115">     else</span>
<a href="#l5.116"></a><span id="l5.116">       return PL_strdup(header);</span>
<a href="#l5.117"></a><span id="l5.117">   }</span>
<a href="#l5.118"></a><span id="l5.118"> </span>
<a href="#l5.119"></a><span id="l5.119">   nsAutoCString encodedString;</span>
<a href="#l5.120"></a><span id="l5.120">   nsresult res;</span>
<a href="#l5.121"></a><span id="l5.121">   nsCOMPtr&lt;nsIMimeConverter&gt; converter = do_GetService(NS_MIME_CONVERTER_CONTRACTID, &amp;res);</span>
<a href="#l5.122"></a><span id="l5.122" class="difflineat">@@ -324,53 +325,53 @@ nsresult nsMsgI18NShrinkUTF8Str(const ns</span>
<a href="#l5.123"></a><span id="l5.123">     return NS_OK;</span>
<a href="#l5.124"></a><span id="l5.124">   }</span>
<a href="#l5.125"></a><span id="l5.125">   uint32_t len = prev - start;</span>
<a href="#l5.126"></a><span id="l5.126">   outString.Assign(Substring(inString, 0, len));</span>
<a href="#l5.127"></a><span id="l5.127">   return NS_OK;</span>
<a href="#l5.128"></a><span id="l5.128"> }</span>
<a href="#l5.129"></a><span id="l5.129"> </span>
<a href="#l5.130"></a><span id="l5.130"> void nsMsgI18NConvertRawBytesToUTF16(const nsCString&amp; inString,</span>
<a href="#l5.131"></a><span id="l5.131" class="difflineminus">-                                     const char* charset,</span>
<a href="#l5.132"></a><span id="l5.132" class="difflineplus">+                                     const nsACString&amp; charset,</span>
<a href="#l5.133"></a><span id="l5.133">                                      nsAString&amp; outString)</span>
<a href="#l5.134"></a><span id="l5.134"> {</span>
<a href="#l5.135"></a><span id="l5.135">   if (MsgIsUTF8(inString))</span>
<a href="#l5.136"></a><span id="l5.136">   {</span>
<a href="#l5.137"></a><span id="l5.137">     CopyUTF8toUTF16(inString, outString);</span>
<a href="#l5.138"></a><span id="l5.138">     return;</span>
<a href="#l5.139"></a><span id="l5.139">   }</span>
<a href="#l5.140"></a><span id="l5.140"> </span>
<a href="#l5.141"></a><span id="l5.141" class="difflineminus">-  nsresult rv = ConvertToUnicode(charset, inString, outString);</span>
<a href="#l5.142"></a><span id="l5.142" class="difflineplus">+  nsresult rv = nsMsgI18NConvertToUnicode(charset, inString, outString);</span>
<a href="#l5.143"></a><span id="l5.143">   if (NS_SUCCEEDED(rv))</span>
<a href="#l5.144"></a><span id="l5.144">     return;</span>
<a href="#l5.145"></a><span id="l5.145"> </span>
<a href="#l5.146"></a><span id="l5.146">   const char* cur = inString.BeginReading();</span>
<a href="#l5.147"></a><span id="l5.147">   const char* end = inString.EndReading();</span>
<a href="#l5.148"></a><span id="l5.148">   outString.Truncate();</span>
<a href="#l5.149"></a><span id="l5.149">   while (cur &lt; end) {</span>
<a href="#l5.150"></a><span id="l5.150">     char c = *cur++;</span>
<a href="#l5.151"></a><span id="l5.151">     if (c &amp; char(0x80))</span>
<a href="#l5.152"></a><span id="l5.152">       outString.Append(UCS2_REPLACEMENT_CHAR);</span>
<a href="#l5.153"></a><span id="l5.153">     else</span>
<a href="#l5.154"></a><span id="l5.154">       outString.Append(c);</span>
<a href="#l5.155"></a><span id="l5.155">   }</span>
<a href="#l5.156"></a><span id="l5.156"> }</span>
<a href="#l5.157"></a><span id="l5.157"> </span>
<a href="#l5.158"></a><span id="l5.158"> void nsMsgI18NConvertRawBytesToUTF8(const nsCString&amp; inString,</span>
<a href="#l5.159"></a><span id="l5.159" class="difflineminus">-                                    const char* charset,</span>
<a href="#l5.160"></a><span id="l5.160" class="difflineplus">+                                    const nsACString&amp; charset,</span>
<a href="#l5.161"></a><span id="l5.161">                                     nsACString&amp; outString)</span>
<a href="#l5.162"></a><span id="l5.162"> {</span>
<a href="#l5.163"></a><span id="l5.163">   if (MsgIsUTF8(inString))</span>
<a href="#l5.164"></a><span id="l5.164">   {</span>
<a href="#l5.165"></a><span id="l5.165">     outString.Assign(inString);</span>
<a href="#l5.166"></a><span id="l5.166">     return;</span>
<a href="#l5.167"></a><span id="l5.167">   }</span>
<a href="#l5.168"></a><span id="l5.168"> </span>
<a href="#l5.169"></a><span id="l5.169">   nsAutoString utf16Text;</span>
<a href="#l5.170"></a><span id="l5.170" class="difflineminus">-  nsresult rv = ConvertToUnicode(charset, inString, utf16Text);</span>
<a href="#l5.171"></a><span id="l5.171" class="difflineplus">+  nsresult rv = nsMsgI18NConvertToUnicode(charset, inString, utf16Text);</span>
<a href="#l5.172"></a><span id="l5.172">   if (NS_SUCCEEDED(rv))</span>
<a href="#l5.173"></a><span id="l5.173">   {</span>
<a href="#l5.174"></a><span id="l5.174">     CopyUTF16toUTF8(utf16Text, outString);</span>
<a href="#l5.175"></a><span id="l5.175">     return;</span>
<a href="#l5.176"></a><span id="l5.176">   }</span>
<a href="#l5.177"></a><span id="l5.177"> </span>
<a href="#l5.178"></a><span id="l5.178">   // EF BF BD (UTF-8 encoding of U+FFFD)</span>
<a href="#l5.179"></a><span id="l5.179">   NS_NAMED_LITERAL_CSTRING(utf8ReplacementChar, &quot;\357\277\275&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/base/util/nsMsgI18N.h</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgI18N.h</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -54,17 +54,17 @@ NS_MSG_BASE bool nsMsgI18Nmultibyte_char</span>
<a href="#l6.4"></a><span id="l6.4">  */</span>
<a href="#l6.5"></a><span id="l6.5"> NS_MSG_BASE bool      nsMsgI18Ncheck_data_in_charset_range(const char *charset, const char16_t* inString);</span>
<a href="#l6.6"></a><span id="l6.6"> </span>
<a href="#l6.7"></a><span id="l6.7"> /**</span>
<a href="#l6.8"></a><span id="l6.8">  * Return charset name of file system (OS dependent).</span>
<a href="#l6.9"></a><span id="l6.9">  *</span>
<a href="#l6.10"></a><span id="l6.10">  * @return            File system charset name.</span>
<a href="#l6.11"></a><span id="l6.11">  */</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-NS_MSG_BASE const char * nsMsgI18NFileSystemCharset(void);</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+NS_MSG_BASE const nsACString&amp; nsMsgI18NFileSystemCharset(void);</span>
<a href="#l6.14"></a><span id="l6.14"> </span>
<a href="#l6.15"></a><span id="l6.15"> /**</span>
<a href="#l6.16"></a><span id="l6.16">  * Return charset name of text file (OS dependent).</span>
<a href="#l6.17"></a><span id="l6.17">  *</span>
<a href="#l6.18"></a><span id="l6.18">  * @param aCharset    [OUT] Text file charset name.</span>
<a href="#l6.19"></a><span id="l6.19">  */</span>
<a href="#l6.20"></a><span id="l6.20"> NS_MSG_BASE void nsMsgI18NTextFileCharset(nsACString&amp; aCharset);</span>
<a href="#l6.21"></a><span id="l6.21"> </span>
<a href="#l6.22"></a><span id="l6.22" class="difflineat">@@ -76,31 +76,31 @@ NS_MSG_BASE void nsMsgI18NTextFileCharse</span>
<a href="#l6.23"></a><span id="l6.23">  * @param outString   [OUT] Converted output string.</span>
<a href="#l6.24"></a><span id="l6.24">  * @param aReportUencNoMapping [IN] Set encoder to report (instead of using</span>
<a href="#l6.25"></a><span id="l6.25">  *                                  replacement char on errors). Set to true</span>
<a href="#l6.26"></a><span id="l6.26">  *                                  to receive NS_ERROR_UENC_NOMAPPING when</span>
<a href="#l6.27"></a><span id="l6.27">  *                                  that happens. Note that</span>
<a href="#l6.28"></a><span id="l6.28">  *                                  NS_ERROR_UENC_NOMAPPING is a success code!</span>
<a href="#l6.29"></a><span id="l6.29">  * @return            nsresult.</span>
<a href="#l6.30"></a><span id="l6.30">  */</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineminus">-NS_MSG_BASE nsresult nsMsgI18NConvertFromUnicode(const char* aCharset,</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineminus">-                                                 const nsString&amp; inString,</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineplus">+NS_MSG_BASE nsresult nsMsgI18NConvertFromUnicode(const nsACString&amp; aCharset,</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineplus">+                                                 const nsAString&amp; inString,</span>
<a href="#l6.35"></a><span id="l6.35">                                                  nsACString&amp; outString,</span>
<a href="#l6.36"></a><span id="l6.36">                                                  bool reportUencNoMapping =</span>
<a href="#l6.37"></a><span id="l6.37">                                                         false);</span>
<a href="#l6.38"></a><span id="l6.38"> /**</span>
<a href="#l6.39"></a><span id="l6.39">  * Convert from charset to unicode.</span>
<a href="#l6.40"></a><span id="l6.40">  *</span>
<a href="#l6.41"></a><span id="l6.41">  * @param charset     [IN] Charset name.</span>
<a href="#l6.42"></a><span id="l6.42">  * @param inString    [IN] Input string to convert.</span>
<a href="#l6.43"></a><span id="l6.43">  * @param outString   [OUT] Output unicode string.</span>
<a href="#l6.44"></a><span id="l6.44">  * @return            nsresult.</span>
<a href="#l6.45"></a><span id="l6.45">  */</span>
<a href="#l6.46"></a><span id="l6.46" class="difflineminus">-NS_MSG_BASE nsresult nsMsgI18NConvertToUnicode(const char* aCharset,</span>
<a href="#l6.47"></a><span id="l6.47" class="difflineminus">-                                               const nsCString&amp; inString,</span>
<a href="#l6.48"></a><span id="l6.48" class="difflineplus">+NS_MSG_BASE nsresult nsMsgI18NConvertToUnicode(const nsACString&amp; aCharset,</span>
<a href="#l6.49"></a><span id="l6.49" class="difflineplus">+                                               const nsACString&amp; inString,</span>
<a href="#l6.50"></a><span id="l6.50">                                                nsAString&amp; outString);</span>
<a href="#l6.51"></a><span id="l6.51"> /**</span>
<a href="#l6.52"></a><span id="l6.52">  * Parse for META charset.</span>
<a href="#l6.53"></a><span id="l6.53">  *</span>
<a href="#l6.54"></a><span id="l6.54">  * @param file    [IN] A nsIFile.</span>
<a href="#l6.55"></a><span id="l6.55">  * @return            A charset name or empty string if not found.</span>
<a href="#l6.56"></a><span id="l6.56">  */</span>
<a href="#l6.57"></a><span id="l6.57"> NS_MSG_BASE const char *nsMsgI18NParseMetaCharset(nsIFile* file);</span>
<a href="#l6.58"></a><span id="l6.58" class="difflineat">@@ -120,64 +120,26 @@ NS_MSG_BASE nsresult nsMsgI18NShrinkUTF8</span>
<a href="#l6.59"></a><span id="l6.59"> </span>
<a href="#l6.60"></a><span id="l6.60"> /*</span>
<a href="#l6.61"></a><span id="l6.61">  * Convert raw bytes in header to UTF-16</span>
<a href="#l6.62"></a><span id="l6.62">  *</span>
<a href="#l6.63"></a><span id="l6.63">  * @param inString   [IN] Input raw octets</span>
<a href="#l6.64"></a><span id="l6.64">  * @param outString  [OUT] Output UTF-16 string</span>
<a href="#l6.65"></a><span id="l6.65">  */</span>
<a href="#l6.66"></a><span id="l6.66"> NS_MSG_BASE void nsMsgI18NConvertRawBytesToUTF16(const nsCString&amp; inString,</span>
<a href="#l6.67"></a><span id="l6.67" class="difflineminus">-                                                 const char* charset,</span>
<a href="#l6.68"></a><span id="l6.68" class="difflineplus">+                                                 const nsACString&amp; charset,</span>
<a href="#l6.69"></a><span id="l6.69">                                                  nsAString&amp; outString);</span>
<a href="#l6.70"></a><span id="l6.70"> </span>
<a href="#l6.71"></a><span id="l6.71"> /*</span>
<a href="#l6.72"></a><span id="l6.72">  * Convert raw bytes in header to UTF-8</span>
<a href="#l6.73"></a><span id="l6.73">  *</span>
<a href="#l6.74"></a><span id="l6.74">  * @param inString   [IN] Input raw octets</span>
<a href="#l6.75"></a><span id="l6.75">  * @param outString  [OUT] Output UTF-8 string</span>
<a href="#l6.76"></a><span id="l6.76">  */</span>
<a href="#l6.77"></a><span id="l6.77"> NS_MSG_BASE void nsMsgI18NConvertRawBytesToUTF8(const nsCString&amp; inString,</span>
<a href="#l6.78"></a><span id="l6.78" class="difflineminus">-                                                const char* charset,</span>
<a href="#l6.79"></a><span id="l6.79" class="difflineplus">+                                                const nsACString&amp; charset,</span>
<a href="#l6.80"></a><span id="l6.80">                                                 nsACString&amp; outString);</span>
<a href="#l6.81"></a><span id="l6.81"> </span>
<a href="#l6.82"></a><span id="l6.82"> // Convert between UTF-16 and modified UTF-7 used for IMAP.</span>
<a href="#l6.83"></a><span id="l6.83"> NS_MSG_BASE nsresult CopyUTF16toMUTF7(const nsString &amp;aSrc, nsACString&amp; aDest);</span>
<a href="#l6.84"></a><span id="l6.84"> NS_MSG_BASE nsresult CopyMUTF7toUTF16(const nsCString&amp; aSrc, nsAString&amp; aDest);</span>
<a href="#l6.85"></a><span id="l6.85"> </span>
<a href="#l6.86"></a><span id="l6.86" class="difflineminus">-inline nsresult ConvertToUnicode(const char* charset,</span>
<a href="#l6.87"></a><span id="l6.87" class="difflineminus">-                                 const nsCString &amp;aSrc, nsAString&amp; aDest)</span>
<a href="#l6.88"></a><span id="l6.88" class="difflineminus">-{</span>
<a href="#l6.89"></a><span id="l6.89" class="difflineminus">-    return nsMsgI18NConvertToUnicode(charset, aSrc, aDest);</span>
<a href="#l6.90"></a><span id="l6.90" class="difflineminus">-}</span>
<a href="#l6.91"></a><span id="l6.91" class="difflineminus">-</span>
<a href="#l6.92"></a><span id="l6.92" class="difflineminus">-inline nsresult ConvertToUnicode(const char* charset,</span>
<a href="#l6.93"></a><span id="l6.93" class="difflineminus">-                                 const char* aSrc, nsAString&amp; aDest)</span>
<a href="#l6.94"></a><span id="l6.94" class="difflineminus">-{</span>
<a href="#l6.95"></a><span id="l6.95" class="difflineminus">-    return nsMsgI18NConvertToUnicode(charset, nsDependentCString(aSrc), aDest);</span>
<a href="#l6.96"></a><span id="l6.96" class="difflineminus">-}</span>
<a href="#l6.97"></a><span id="l6.97" class="difflineminus">-</span>
<a href="#l6.98"></a><span id="l6.98" class="difflineminus">-inline nsresult ConvertFromUnicode(const char* charset,</span>
<a href="#l6.99"></a><span id="l6.99" class="difflineminus">-                                   const nsString &amp;aSrc, nsACString&amp; aDest)</span>
<a href="#l6.100"></a><span id="l6.100" class="difflineminus">-{</span>
<a href="#l6.101"></a><span id="l6.101" class="difflineminus">-    return nsMsgI18NConvertFromUnicode(charset, aSrc, aDest);</span>
<a href="#l6.102"></a><span id="l6.102" class="difflineminus">-}</span>
<a href="#l6.103"></a><span id="l6.103" class="difflineminus">-</span>
<a href="#l6.104"></a><span id="l6.104" class="difflineminus">-inline void ConvertRawBytesToUTF16(const nsCString&amp; inString,</span>
<a href="#l6.105"></a><span id="l6.105" class="difflineminus">-                                   const char* charset, nsAString&amp; outString)</span>
<a href="#l6.106"></a><span id="l6.106" class="difflineminus">-{</span>
<a href="#l6.107"></a><span id="l6.107" class="difflineminus">-    return nsMsgI18NConvertRawBytesToUTF16(inString, charset, outString);</span>
<a href="#l6.108"></a><span id="l6.108" class="difflineminus">-}</span>
<a href="#l6.109"></a><span id="l6.109" class="difflineminus">-</span>
<a href="#l6.110"></a><span id="l6.110" class="difflineminus">-inline void ConvertRawBytesToUTF16(const char* inString,</span>
<a href="#l6.111"></a><span id="l6.111" class="difflineminus">-                                   const char* charset, nsAString&amp; outString)</span>
<a href="#l6.112"></a><span id="l6.112" class="difflineminus">-{</span>
<a href="#l6.113"></a><span id="l6.113" class="difflineminus">-    return nsMsgI18NConvertRawBytesToUTF16(nsDependentCString(inString),</span>
<a href="#l6.114"></a><span id="l6.114" class="difflineminus">-                                           charset,</span>
<a href="#l6.115"></a><span id="l6.115" class="difflineminus">-                                           outString);</span>
<a href="#l6.116"></a><span id="l6.116" class="difflineminus">-}</span>
<a href="#l6.117"></a><span id="l6.117" class="difflineminus">-</span>
<a href="#l6.118"></a><span id="l6.118" class="difflineminus">-inline void ConvertRawBytesToUTF8(const nsCString&amp; inString,</span>
<a href="#l6.119"></a><span id="l6.119" class="difflineminus">-                                  const char* charset, nsACString&amp; outString)</span>
<a href="#l6.120"></a><span id="l6.120" class="difflineminus">-{</span>
<a href="#l6.121"></a><span id="l6.121" class="difflineminus">-    return nsMsgI18NConvertRawBytesToUTF8(inString, charset, outString);</span>
<a href="#l6.122"></a><span id="l6.122" class="difflineminus">-}</span>
<a href="#l6.123"></a><span id="l6.123" class="difflineminus">-</span>
<a href="#l6.124"></a><span id="l6.124"> #endif /* _nsMsgI18N_H_ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgAttachmentHandler.cpp</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgAttachmentHandler.cpp</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -1043,17 +1043,17 @@ nsMsgAttachmentHandler::LoadDataFromFile</span>
<a href="#l7.4"></a><span id="l7.4"> </span>
<a href="#l7.5"></a><span id="l7.5">   uint32_t bytesRead;</span>
<a href="#l7.6"></a><span id="l7.6">   inputFile-&gt;Read(readBuf, readSize, &amp;bytesRead);</span>
<a href="#l7.7"></a><span id="l7.7">   inputFile-&gt;Close();</span>
<a href="#l7.8"></a><span id="l7.8"> </span>
<a href="#l7.9"></a><span id="l7.9">   nsDependentCString cstringReadBuf(readBuf, bytesRead);</span>
<a href="#l7.10"></a><span id="l7.10">   if (charsetConversion)</span>
<a href="#l7.11"></a><span id="l7.11">   {</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-    if (NS_FAILED(ConvertToUnicode(m_charset.get(), cstringReadBuf, sigData)))</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+    if (NS_FAILED(nsMsgI18NConvertToUnicode(m_charset, cstringReadBuf, sigData)))</span>
<a href="#l7.14"></a><span id="l7.14">       CopyASCIItoUTF16(cstringReadBuf, sigData);</span>
<a href="#l7.15"></a><span id="l7.15">   }</span>
<a href="#l7.16"></a><span id="l7.16">   else</span>
<a href="#l7.17"></a><span id="l7.17">     CopyASCIItoUTF16(cstringReadBuf, sigData);</span>
<a href="#l7.18"></a><span id="l7.18"> </span>
<a href="#l7.19"></a><span id="l7.19">   PR_FREEIF(readBuf);</span>
<a href="#l7.20"></a><span id="l7.20">   return NS_OK;</span>
<a href="#l7.21"></a><span id="l7.21"> }</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineat">@@ -1222,17 +1222,17 @@ nsMsgAttachmentHandler::UrlExit(nsresult</span>
<a href="#l7.23"></a><span id="l7.23"> </span>
<a href="#l7.24"></a><span id="l7.24">         nsCOMPtr&lt;nsIOutputStream&gt; outputStream;</span>
<a href="#l7.25"></a><span id="l7.25">         nsresult rv = MsgNewBufferedFileOutputStream(getter_AddRefs(outputStream), mTmpFile,</span>
<a href="#l7.26"></a><span id="l7.26">                                                      PR_WRONLY | PR_CREATE_FILE, 00600);</span>
<a href="#l7.27"></a><span id="l7.27"> </span>
<a href="#l7.28"></a><span id="l7.28">         if (NS_SUCCEEDED(rv))</span>
<a href="#l7.29"></a><span id="l7.29">         {</span>
<a href="#l7.30"></a><span id="l7.30">           nsAutoCString tData;</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineminus">-          if (NS_FAILED(ConvertFromUnicode(m_charset.get(), conData, tData)))</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineplus">+          if (NS_FAILED(nsMsgI18NConvertFromUnicode(m_charset, conData, tData)))</span>
<a href="#l7.33"></a><span id="l7.33">             LossyCopyUTF16toASCII(conData, tData);</span>
<a href="#l7.34"></a><span id="l7.34">           if (!tData.IsEmpty())</span>
<a href="#l7.35"></a><span id="l7.35">           {</span>
<a href="#l7.36"></a><span id="l7.36">             uint32_t bytesWritten;</span>
<a href="#l7.37"></a><span id="l7.37">             (void) outputStream-&gt;Write(tData.get(), tData.Length(), &amp;bytesWritten);</span>
<a href="#l7.38"></a><span id="l7.38">           }</span>
<a href="#l7.39"></a><span id="l7.39">           outputStream-&gt;Close();</span>
<a href="#l7.40"></a><span id="l7.40">           // this silliness is because Windows nsIFile caches its file size</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgCompUtils.cpp</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgCompUtils.cpp</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -605,17 +605,17 @@ mime_generate_attachment_headers (const </span>
<a href="#l8.4"></a><span id="l8.4">     // first try main body's charset to encode the file name,</span>
<a href="#l8.5"></a><span id="l8.5">     // then try local file system charset if fails</span>
<a href="#l8.6"></a><span id="l8.6">     CopyUTF8toUTF16(nsDependentCString(real_name), realName);</span>
<a href="#l8.7"></a><span id="l8.7">     if (bodyCharset &amp;&amp; *bodyCharset &amp;&amp;</span>
<a href="#l8.8"></a><span id="l8.8">         nsMsgI18Ncheck_data_in_charset_range(bodyCharset, realName.get()))</span>
<a href="#l8.9"></a><span id="l8.9">       charset.Assign(bodyCharset);</span>
<a href="#l8.10"></a><span id="l8.10">     else</span>
<a href="#l8.11"></a><span id="l8.11">     {</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-      charset.Assign(nsMsgI18NFileSystemCharset());</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+      charset = nsMsgI18NFileSystemCharset();</span>
<a href="#l8.14"></a><span id="l8.14">       if (!nsMsgI18Ncheck_data_in_charset_range(charset.get(), realName.get()))</span>
<a href="#l8.15"></a><span id="l8.15">         charset.AssignLiteral(&quot;UTF-8&quot;); // set to UTF-8 if fails again</span>
<a href="#l8.16"></a><span id="l8.16">     }</span>
<a href="#l8.17"></a><span id="l8.17"> </span>
<a href="#l8.18"></a><span id="l8.18">     encodedRealName = RFC2231ParmFolding(&quot;filename&quot;, charset, nullptr,</span>
<a href="#l8.19"></a><span id="l8.19">                                          realName);</span>
<a href="#l8.20"></a><span id="l8.20">     // somehow RFC2231ParamFolding failed. fall back to legacy method</span>
<a href="#l8.21"></a><span id="l8.21">     if (!encodedRealName || !*encodedRealName) {</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineat">@@ -975,17 +975,17 @@ RFC2231ParmFolding(const char *parmName,</span>
<a href="#l8.23"></a><span id="l8.23">   NS_ENSURE_TRUE(parmName &amp;&amp; *parmName &amp;&amp; !parmValue.IsEmpty(), nullptr);</span>
<a href="#l8.24"></a><span id="l8.24"> </span>
<a href="#l8.25"></a><span id="l8.25">   bool needEscape;</span>
<a href="#l8.26"></a><span id="l8.26">   nsCString dupParm;</span>
<a href="#l8.27"></a><span id="l8.27"> </span>
<a href="#l8.28"></a><span id="l8.28">   if (!NS_IsAscii(parmValue.get()) || is7bitCharset(charset)) {</span>
<a href="#l8.29"></a><span id="l8.29">     needEscape = true;</span>
<a href="#l8.30"></a><span id="l8.30">     nsAutoCString nativeParmValue;</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineminus">-    ConvertFromUnicode(charset.get(), parmValue, nativeParmValue);</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineplus">+    nsMsgI18NConvertFromUnicode(charset, parmValue, nativeParmValue);</span>
<a href="#l8.33"></a><span id="l8.33">     MsgEscapeString(nativeParmValue, nsINetUtil::ESCAPE_ALL, dupParm);</span>
<a href="#l8.34"></a><span id="l8.34">   }</span>
<a href="#l8.35"></a><span id="l8.35">   else {</span>
<a href="#l8.36"></a><span id="l8.36">     needEscape = false;</span>
<a href="#l8.37"></a><span id="l8.37">     dupParm.Adopt(</span>
<a href="#l8.38"></a><span id="l8.38">       msg_make_filename_qtext(NS_LossyConvertUTF16toASCII(parmValue).get(),</span>
<a href="#l8.39"></a><span id="l8.39">                               true));</span>
<a href="#l8.40"></a><span id="l8.40">   }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgCompose.cpp</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgCompose.cpp</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -1329,18 +1329,18 @@ NS_IMETHODIMP nsMsgCompose::SendMsg(MSG_</span>
<a href="#l9.4"></a><span id="l9.4">   else</span>
<a href="#l9.5"></a><span id="l9.5">   {</span>
<a href="#l9.6"></a><span id="l9.6">     m_compFields-&gt;GetBody(msgBody);</span>
<a href="#l9.7"></a><span id="l9.7">   }</span>
<a href="#l9.8"></a><span id="l9.8">   if (!msgBody.IsEmpty())</span>
<a href="#l9.9"></a><span id="l9.9">   {</span>
<a href="#l9.10"></a><span id="l9.10">     // Convert body to mail charset</span>
<a href="#l9.11"></a><span id="l9.11">     nsCString outCString;</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-    rv = nsMsgI18NConvertFromUnicode(m_compFields-&gt;GetCharacterSet(),</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineminus">-      msgBody, outCString, true);</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineplus">+    rv = nsMsgI18NConvertFromUnicode(nsDependentCString(m_compFields-&gt;GetCharacterSet()),</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineplus">+                                     msgBody, outCString, true);</span>
<a href="#l9.16"></a><span id="l9.16">     bool isAsciiOnly = NS_IsAscii(outCString.get()) &amp;&amp;</span>
<a href="#l9.17"></a><span id="l9.17">       !nsMsgI18Nstateful_charset(m_compFields-&gt;GetCharacterSet());</span>
<a href="#l9.18"></a><span id="l9.18">     if (m_compFields-&gt;GetForceMsgEncoding())</span>
<a href="#l9.19"></a><span id="l9.19">       isAsciiOnly = false;</span>
<a href="#l9.20"></a><span id="l9.20">     if (NS_SUCCEEDED(rv) &amp;&amp; !outCString.IsEmpty())</span>
<a href="#l9.21"></a><span id="l9.21">     {</span>
<a href="#l9.22"></a><span id="l9.22">       // If the body contains characters outside the repertoire of the current</span>
<a href="#l9.23"></a><span id="l9.23">       // charset, just convert to UTF-8 and be done with it</span>
<a href="#l9.24"></a><span id="l9.24" class="difflineat">@@ -2538,35 +2538,35 @@ NS_IMETHODIMP QuotingOutputStreamListene</span>
<a href="#l9.25"></a><span id="l9.25">               NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.26"></a><span id="l9.26">               compFields-&gt;SetCharacterSet(charset.get());</span>
<a href="#l9.27"></a><span id="l9.27">             }</span>
<a href="#l9.28"></a><span id="l9.28">           }</span>
<a href="#l9.29"></a><span id="l9.29">         }</span>
<a href="#l9.30"></a><span id="l9.30">       }</span>
<a href="#l9.31"></a><span id="l9.31"> </span>
<a href="#l9.32"></a><span id="l9.32">       mHeaders-&gt;ExtractHeader(HEADER_FROM, true, outCString);</span>
<a href="#l9.33"></a><span id="l9.33" class="difflineminus">-      ConvertRawBytesToUTF16(outCString, charset.get(), from);</span>
<a href="#l9.34"></a><span id="l9.34" class="difflineplus">+      nsMsgI18NConvertRawBytesToUTF16(outCString, charset, from);</span>
<a href="#l9.35"></a><span id="l9.35"> </span>
<a href="#l9.36"></a><span id="l9.36">       mHeaders-&gt;ExtractHeader(HEADER_TO, true, outCString);</span>
<a href="#l9.37"></a><span id="l9.37" class="difflineminus">-      ConvertRawBytesToUTF16(outCString, charset.get(), to);</span>
<a href="#l9.38"></a><span id="l9.38" class="difflineplus">+      nsMsgI18NConvertRawBytesToUTF16(outCString, charset, to);</span>
<a href="#l9.39"></a><span id="l9.39"> </span>
<a href="#l9.40"></a><span id="l9.40">       mHeaders-&gt;ExtractHeader(HEADER_CC, true, outCString);</span>
<a href="#l9.41"></a><span id="l9.41" class="difflineminus">-      ConvertRawBytesToUTF16(outCString, charset.get(), cc);</span>
<a href="#l9.42"></a><span id="l9.42" class="difflineplus">+      nsMsgI18NConvertRawBytesToUTF16(outCString, charset, cc);</span>
<a href="#l9.43"></a><span id="l9.43"> </span>
<a href="#l9.44"></a><span id="l9.44">       mHeaders-&gt;ExtractHeader(HEADER_BCC, true, outCString);</span>
<a href="#l9.45"></a><span id="l9.45" class="difflineminus">-      ConvertRawBytesToUTF16(outCString, charset.get(), bcc);</span>
<a href="#l9.46"></a><span id="l9.46" class="difflineplus">+      nsMsgI18NConvertRawBytesToUTF16(outCString, charset, bcc);</span>
<a href="#l9.47"></a><span id="l9.47"> </span>
<a href="#l9.48"></a><span id="l9.48">       mHeaders-&gt;ExtractHeader(HEADER_MAIL_FOLLOWUP_TO, true, outCString);</span>
<a href="#l9.49"></a><span id="l9.49" class="difflineminus">-      ConvertRawBytesToUTF16(outCString, charset.get(), mailFollowupTo);</span>
<a href="#l9.50"></a><span id="l9.50" class="difflineplus">+      nsMsgI18NConvertRawBytesToUTF16(outCString, charset, mailFollowupTo);</span>
<a href="#l9.51"></a><span id="l9.51"> </span>
<a href="#l9.52"></a><span id="l9.52">       mHeaders-&gt;ExtractHeader(HEADER_REPLY_TO, false, outCString);</span>
<a href="#l9.53"></a><span id="l9.53" class="difflineminus">-      ConvertRawBytesToUTF16(outCString, charset.get(), replyTo);</span>
<a href="#l9.54"></a><span id="l9.54" class="difflineplus">+      nsMsgI18NConvertRawBytesToUTF16(outCString, charset, replyTo);</span>
<a href="#l9.55"></a><span id="l9.55"> </span>
<a href="#l9.56"></a><span id="l9.56">       mHeaders-&gt;ExtractHeader(HEADER_MAIL_REPLY_TO, true, outCString);</span>
<a href="#l9.57"></a><span id="l9.57" class="difflineminus">-      ConvertRawBytesToUTF16(outCString, charset.get(), mailReplyTo);</span>
<a href="#l9.58"></a><span id="l9.58" class="difflineplus">+      nsMsgI18NConvertRawBytesToUTF16(outCString, charset, mailReplyTo);</span>
<a href="#l9.59"></a><span id="l9.59"> </span>
<a href="#l9.60"></a><span id="l9.60">       mHeaders-&gt;ExtractHeader(HEADER_NEWSGROUPS, false, outCString);</span>
<a href="#l9.61"></a><span id="l9.61">       if (!outCString.IsEmpty())</span>
<a href="#l9.62"></a><span id="l9.62">         mMimeConverter-&gt;DecodeMimeHeader(outCString.get(), charset.get(),</span>
<a href="#l9.63"></a><span id="l9.63">                                          false, true, newgroups);</span>
<a href="#l9.64"></a><span id="l9.64"> </span>
<a href="#l9.65"></a><span id="l9.65">       mHeaders-&gt;ExtractHeader(HEADER_FOLLOWUP_TO, false, outCString);</span>
<a href="#l9.66"></a><span id="l9.66">       if (!outCString.IsEmpty())</span>
<a href="#l9.67"></a><span id="l9.67" class="difflineat">@@ -4180,17 +4180,17 @@ nsMsgCompose::LoadDataFromFile(nsIFile *</span>
<a href="#l9.68"></a><span id="l9.68">     }</span>
<a href="#l9.69"></a><span id="l9.69">   }</span>
<a href="#l9.70"></a><span id="l9.70"> </span>
<a href="#l9.71"></a><span id="l9.71">   nsAutoCString readStr(readBuf, (int32_t) fileSize);</span>
<a href="#l9.72"></a><span id="l9.72">   PR_FREEIF(readBuf);</span>
<a href="#l9.73"></a><span id="l9.73"> </span>
<a href="#l9.74"></a><span id="l9.74">   // XXX: ^^^ could really use nsContentUtils::SlurpFileToString instead!</span>
<a href="#l9.75"></a><span id="l9.75"> </span>
<a href="#l9.76"></a><span id="l9.76" class="difflineminus">-  if (NS_FAILED(ConvertToUnicode(sigEncoding.get(), readStr, sigData)))</span>
<a href="#l9.77"></a><span id="l9.77" class="difflineplus">+  if (NS_FAILED(nsMsgI18NConvertToUnicode(sigEncoding, readStr, sigData)))</span>
<a href="#l9.78"></a><span id="l9.78">     CopyASCIItoUTF16(readStr, sigData);</span>
<a href="#l9.79"></a><span id="l9.79"> </span>
<a href="#l9.80"></a><span id="l9.80">   //remove sig meta charset to allow user charset override during composition</span>
<a href="#l9.81"></a><span id="l9.81">   if (removeSigCharset)</span>
<a href="#l9.82"></a><span id="l9.82">   {</span>
<a href="#l9.83"></a><span id="l9.83">     nsAutoCString metaCharset(&quot;charset=&quot;);</span>
<a href="#l9.84"></a><span id="l9.84">     metaCharset.Append(sigEncoding);</span>
<a href="#l9.85"></a><span id="l9.85">     int32_t pos = sigData.Find(metaCharset.BeginReading(), true);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgComposeService.cpp</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgComposeService.cpp</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -744,17 +744,17 @@ NS_IMETHODIMP nsMsgTemplateReplyHelper::</span>
<a href="#l10.4"></a><span id="l10.4"> </span>
<a href="#l10.5"></a><span id="l10.5">   compFields-&gt;SetSubject(subject);</span>
<a href="#l10.6"></a><span id="l10.6">   compFields-&gt;SetRawHeader(&quot;Auto-Submitted&quot;, NS_LITERAL_CSTRING(&quot;auto-replied&quot;), nullptr);</span>
<a href="#l10.7"></a><span id="l10.7"> </span>
<a href="#l10.8"></a><span id="l10.8">   nsCString charset;</span>
<a href="#l10.9"></a><span id="l10.9">   rv = mTemplateHdr-&gt;GetCharset(getter_Copies(charset));</span>
<a href="#l10.10"></a><span id="l10.10">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.11"></a><span id="l10.11">   compFields-&gt;SetCharacterSet(charset.get());</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-  rv = nsMsgI18NConvertToUnicode(charset.get(), mTemplateBody, body);</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+  rv = nsMsgI18NConvertToUnicode(charset, mTemplateBody, body);</span>
<a href="#l10.14"></a><span id="l10.14">   NS_WARNING_ASSERTION(NS_SUCCEEDED(rv), &quot;couldn't convert templ body to unicode&quot;);</span>
<a href="#l10.15"></a><span id="l10.15">   compFields-&gt;SetBody(body);</span>
<a href="#l10.16"></a><span id="l10.16"> </span>
<a href="#l10.17"></a><span id="l10.17">   nsCString msgUri;</span>
<a href="#l10.18"></a><span id="l10.18">   nsCOMPtr &lt;nsIMsgFolder&gt; folder;</span>
<a href="#l10.19"></a><span id="l10.19">   mHdrToReplyTo-&gt;GetFolder(getter_AddRefs(folder));</span>
<a href="#l10.20"></a><span id="l10.20">   folder-&gt;GetUriForMsg(mHdrToReplyTo, msgUri);</span>
<a href="#l10.21"></a><span id="l10.21">   // populate the compose params</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgSend.cpp</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgSend.cpp</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -1578,17 +1578,20 @@ nsMsgComposeAndSend::GetBodyFromEditor()</span>
<a href="#l11.4"></a><span id="l11.4">   nsCString attachment1_body;</span>
<a href="#l11.5"></a><span id="l11.5"> </span>
<a href="#l11.6"></a><span id="l11.6">   // Convert body to mail charset</span>
<a href="#l11.7"></a><span id="l11.7">   nsCString    outCString;</span>
<a href="#l11.8"></a><span id="l11.8">   const char  *aCharset = mCompFields-&gt;GetCharacterSet();</span>
<a href="#l11.9"></a><span id="l11.9"> </span>
<a href="#l11.10"></a><span id="l11.10">   if (aCharset &amp;&amp; *aCharset)</span>
<a href="#l11.11"></a><span id="l11.11">   {</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-    rv = nsMsgI18NConvertFromUnicode(aCharset, nsDependentString(bodyText), outCString, true);</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+    rv = nsMsgI18NConvertFromUnicode(nsDependentCString(aCharset),</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineplus">+                                     nsDependentString(bodyText),</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineplus">+                                     outCString,</span>
<a href="#l11.16"></a><span id="l11.16" class="difflineplus">+                                     true);</span>
<a href="#l11.17"></a><span id="l11.17">     bool isAsciiOnly = NS_IsAscii(outCString.get()) &amp;&amp;</span>
<a href="#l11.18"></a><span id="l11.18">       !nsMsgI18Nstateful_charset(mCompFields-&gt;GetCharacterSet());</span>
<a href="#l11.19"></a><span id="l11.19">     if (mCompFields-&gt;GetForceMsgEncoding())</span>
<a href="#l11.20"></a><span id="l11.20">       isAsciiOnly = false;</span>
<a href="#l11.21"></a><span id="l11.21">     mCompFields-&gt;SetBodyIsAsciiOnly(isAsciiOnly);</span>
<a href="#l11.22"></a><span id="l11.22"> </span>
<a href="#l11.23"></a><span id="l11.23">     // If the body contains characters outside the current mail charset,</span>
<a href="#l11.24"></a><span id="l11.24">     // convert to UTF-8.</span>
<a href="#l11.25"></a><span id="l11.25" class="difflineat">@@ -1620,18 +1623,20 @@ nsMsgComposeAndSend::GetBodyFromEditor()</span>
<a href="#l11.26"></a><span id="l11.26">       attachment1_body = outCString;</span>
<a href="#l11.27"></a><span id="l11.27"> </span>
<a href="#l11.28"></a><span id="l11.28">     // If we have an origHTMLBody that is not null, this means that it is</span>
<a href="#l11.29"></a><span id="l11.29">     // different than the bodyText because of formatting conversions. Because of</span>
<a href="#l11.30"></a><span id="l11.30">     // this we need to do the charset conversion on this part separately</span>
<a href="#l11.31"></a><span id="l11.31">     if (origHTMLBody)</span>
<a href="#l11.32"></a><span id="l11.32">     {</span>
<a href="#l11.33"></a><span id="l11.33">       nsCString newBody;</span>
<a href="#l11.34"></a><span id="l11.34" class="difflineminus">-      rv = nsMsgI18NConvertFromUnicode(aCharset,</span>
<a href="#l11.35"></a><span id="l11.35" class="difflineminus">-        nsDependentString(origHTMLBody), newBody, true);</span>
<a href="#l11.36"></a><span id="l11.36" class="difflineplus">+      rv = nsMsgI18NConvertFromUnicode(nsDependentCString(aCharset),</span>
<a href="#l11.37"></a><span id="l11.37" class="difflineplus">+                                       nsDependentString(origHTMLBody),</span>
<a href="#l11.38"></a><span id="l11.38" class="difflineplus">+                                       newBody,</span>
<a href="#l11.39"></a><span id="l11.39" class="difflineplus">+                                       true);</span>
<a href="#l11.40"></a><span id="l11.40">       if (NS_SUCCEEDED(rv))</span>
<a href="#l11.41"></a><span id="l11.41">       {</span>
<a href="#l11.42"></a><span id="l11.42">         mOriginalHTMLBody = ToNewCString(newBody);</span>
<a href="#l11.43"></a><span id="l11.43">       }</span>
<a href="#l11.44"></a><span id="l11.44">     }</span>
<a href="#l11.45"></a><span id="l11.45">     else {</span>
<a href="#l11.46"></a><span id="l11.46">       mOriginalHTMLBody = ToNewCString(attachment1_body);</span>
<a href="#l11.47"></a><span id="l11.47">     }</span>
<a href="#l11.48"></a><span id="l11.48" class="difflineat">@@ -2525,17 +2530,19 @@ nsMsgComposeAndSend::HackAttachments(nsI</span>
<a href="#l11.49"></a><span id="l11.49">          we need to avoid to call it ourself.</span>
<a href="#l11.50"></a><span id="l11.50">       */</span>
<a href="#l11.51"></a><span id="l11.51">       needToCallGatherMimeAttachments = false;</span>
<a href="#l11.52"></a><span id="l11.52"> </span>
<a href="#l11.53"></a><span id="l11.53">       nsresult status = m_attachments[i]-&gt;SnarfAttachment(mCompFields);</span>
<a href="#l11.54"></a><span id="l11.54">       if (NS_FAILED(status))</span>
<a href="#l11.55"></a><span id="l11.55">       {</span>
<a href="#l11.56"></a><span id="l11.56">         nsString errorMsg;</span>
<a href="#l11.57"></a><span id="l11.57" class="difflineminus">-        nsresult rv = ConvertToUnicode(nsMsgI18NFileSystemCharset(), m_attachments[i]-&gt;m_realName, attachmentFileName);</span>
<a href="#l11.58"></a><span id="l11.58" class="difflineplus">+        nsresult rv = nsMsgI18NConvertToUnicode(nsMsgI18NFileSystemCharset(),</span>
<a href="#l11.59"></a><span id="l11.59" class="difflineplus">+                                                m_attachments[i]-&gt;m_realName,</span>
<a href="#l11.60"></a><span id="l11.60" class="difflineplus">+                                                attachmentFileName);</span>
<a href="#l11.61"></a><span id="l11.61">         if (attachmentFileName.IsEmpty() &amp;&amp; m_attachments[i]-&gt;mURL) {</span>
<a href="#l11.62"></a><span id="l11.62">           nsCString asciiSpec;</span>
<a href="#l11.63"></a><span id="l11.63">           m_attachments[i]-&gt;mURL-&gt;GetAsciiSpec(asciiSpec);</span>
<a href="#l11.64"></a><span id="l11.64">           attachmentFileName.AssignASCII(asciiSpec.get());</span>
<a href="#l11.65"></a><span id="l11.65">           rv = NS_OK;</span>
<a href="#l11.66"></a><span id="l11.66">         }</span>
<a href="#l11.67"></a><span id="l11.67">         if (NS_SUCCEEDED(rv))</span>
<a href="#l11.68"></a><span id="l11.68">         {</span>
<a href="#l11.69"></a><span id="l11.69" class="difflineat">@@ -5016,17 +5023,19 @@ nsMsgComposeAndSend::GetSendBody(nsAStri</span>
<a href="#l11.70"></a><span id="l11.70"> {</span>
<a href="#l11.71"></a><span id="l11.71">   nsCString charSet;</span>
<a href="#l11.72"></a><span id="l11.72">   if (mCompFields)</span>
<a href="#l11.73"></a><span id="l11.73">     mCompFields-&gt;GetCharacterSet(getter_Copies(charSet));</span>
<a href="#l11.74"></a><span id="l11.74">   if (!m_attachment1_body) {</span>
<a href="#l11.75"></a><span id="l11.75">     aBody.Truncate();</span>
<a href="#l11.76"></a><span id="l11.76">     return NS_OK;</span>
<a href="#l11.77"></a><span id="l11.77">   }</span>
<a href="#l11.78"></a><span id="l11.78" class="difflineminus">-  return ConvertToUnicode(charSet.get(), m_attachment1_body, aBody);</span>
<a href="#l11.79"></a><span id="l11.79" class="difflineplus">+  return nsMsgI18NConvertToUnicode(charSet,</span>
<a href="#l11.80"></a><span id="l11.80" class="difflineplus">+                                   nsDependentCString(m_attachment1_body),</span>
<a href="#l11.81"></a><span id="l11.81" class="difflineplus">+                                   aBody);</span>
<a href="#l11.82"></a><span id="l11.82"> }</span>
<a href="#l11.83"></a><span id="l11.83"> </span>
<a href="#l11.84"></a><span id="l11.84"> NS_IMETHODIMP</span>
<a href="#l11.85"></a><span id="l11.85"> nsMsgComposeAndSend::GetSendBodyType(nsACString&amp; aBodyType)</span>
<a href="#l11.86"></a><span id="l11.86"> {</span>
<a href="#l11.87"></a><span id="l11.87">   if (m_attachment1_type &amp;&amp; *m_attachment1_type)</span>
<a href="#l11.88"></a><span id="l11.88">     aBodyType.Assign(nsDependentCString(m_attachment1_type));</span>
<a href="#l11.89"></a><span id="l11.89">   return NS_OK;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mailnews/import/becky/src/nsBeckyUtils.cpp</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mailnews/import/becky/src/nsBeckyUtils.cpp</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -290,17 +290,20 @@ nsBeckyUtils::ConvertToUTF8File(nsIFile </span>
<a href="#l12.4"></a><span id="l12.4">   rv = NS_NewLocalFileOutputStream(getter_AddRefs(destination),</span>
<a href="#l12.5"></a><span id="l12.5">                                    convertedFile);</span>
<a href="#l12.6"></a><span id="l12.6">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.7"></a><span id="l12.7"> </span>
<a href="#l12.8"></a><span id="l12.8">   const uint32_t kBlock = 8192;</span>
<a href="#l12.9"></a><span id="l12.9"> </span>
<a href="#l12.10"></a><span id="l12.10">   nsCOMPtr&lt;nsIConverterInputStream&gt; convertedInput =</span>
<a href="#l12.11"></a><span id="l12.11">     do_CreateInstance(&quot;@mozilla.org/intl/converter-input-stream;1&quot;);</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-  convertedInput-&gt;Init(source, nsMsgI18NFileSystemCharset(), kBlock, 0x0000);</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+  convertedInput-&gt;Init(source,</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineplus">+                       PromiseFlatCString(nsMsgI18NFileSystemCharset()).get(),</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineplus">+                       kBlock,</span>
<a href="#l12.16"></a><span id="l12.16" class="difflineplus">+                       0x0000);</span>
<a href="#l12.17"></a><span id="l12.17"> </span>
<a href="#l12.18"></a><span id="l12.18">   nsCOMPtr&lt;nsIConverterOutputStream&gt; convertedOutput =</span>
<a href="#l12.19"></a><span id="l12.19">     do_CreateInstance(&quot;@mozilla.org/intl/converter-output-stream;1&quot;);</span>
<a href="#l12.20"></a><span id="l12.20">   convertedOutput-&gt;Init(destination, &quot;UTF-8&quot;);</span>
<a href="#l12.21"></a><span id="l12.21"> </span>
<a href="#l12.22"></a><span id="l12.22">   char16_t *line = (char16_t *)moz_xmalloc(kBlock);</span>
<a href="#l12.23"></a><span id="l12.23">   uint32_t readBytes = kBlock;</span>
<a href="#l12.24"></a><span id="l12.24">   bool writtenBytes;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mailnews/import/outlook/src/MapiMessage.cpp</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mailnews/import/outlook/src/MapiMessage.cpp</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -719,35 +719,35 @@ bool CMapiMessage::FetchBody(void)</span>
<a href="#l13.4"></a><span id="l13.4">     const char* charset = CpToCharset(codepage);</span>
<a href="#l13.5"></a><span id="l13.5">     if (charset) {</span>
<a href="#l13.6"></a><span id="l13.6">       bFoundCharset = CheckBodyInCharsetRange(charset);</span>
<a href="#l13.7"></a><span id="l13.7">       if (bFoundCharset)</span>
<a href="#l13.8"></a><span id="l13.8">         m_mimeCharset.Assign(charset);</span>
<a href="#l13.9"></a><span id="l13.9">     }</span>
<a href="#l13.10"></a><span id="l13.10">   }</span>
<a href="#l13.11"></a><span id="l13.11">   if (!bFoundCharset) { // Use system default</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-    const char* charset = nsMsgI18NFileSystemCharset();</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineminus">-    if (charset) {</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineminus">-      bFoundCharset = CheckBodyInCharsetRange(charset);</span>
<a href="#l13.15"></a><span id="l13.15" class="difflineplus">+    const nsCString charset(nsMsgI18NFileSystemCharset());</span>
<a href="#l13.16"></a><span id="l13.16" class="difflineplus">+    if (!charset.IsEmpty()) {</span>
<a href="#l13.17"></a><span id="l13.17" class="difflineplus">+      bFoundCharset = CheckBodyInCharsetRange(charset.get());</span>
<a href="#l13.18"></a><span id="l13.18">       if (bFoundCharset)</span>
<a href="#l13.19"></a><span id="l13.19" class="difflineminus">-        m_mimeCharset.Assign(charset);</span>
<a href="#l13.20"></a><span id="l13.20" class="difflineplus">+        m_mimeCharset = charset;</span>
<a href="#l13.21"></a><span id="l13.21">     }</span>
<a href="#l13.22"></a><span id="l13.22">   }</span>
<a href="#l13.23"></a><span id="l13.23">   if (!bFoundCharset) // Everything else failed, let's use the lossless utf-8...</span>
<a href="#l13.24"></a><span id="l13.24">     m_mimeCharset.AssignLiteral(&quot;utf-8&quot;);</span>
<a href="#l13.25"></a><span id="l13.25"> </span>
<a href="#l13.26"></a><span id="l13.26">   MAPI_DUMP_STRING(m_body.get());</span>
<a href="#l13.27"></a><span id="l13.27">   MAPI_TRACE0(&quot;\r\n&quot;);</span>
<a href="#l13.28"></a><span id="l13.28"> </span>
<a href="#l13.29"></a><span id="l13.29">   return true;</span>
<a href="#l13.30"></a><span id="l13.30"> }</span>
<a href="#l13.31"></a><span id="l13.31"> </span>
<a href="#l13.32"></a><span id="l13.32"> void CMapiMessage::GetBody(nsCString&amp; dest) const</span>
<a href="#l13.33"></a><span id="l13.33"> {</span>
<a href="#l13.34"></a><span id="l13.34" class="difflineminus">-  nsMsgI18NConvertFromUnicode(m_mimeCharset.get(), m_body, dest);</span>
<a href="#l13.35"></a><span id="l13.35" class="difflineplus">+  nsMsgI18NConvertFromUnicode(m_mimeCharset, m_body, dest);</span>
<a href="#l13.36"></a><span id="l13.36"> }</span>
<a href="#l13.37"></a><span id="l13.37"> </span>
<a href="#l13.38"></a><span id="l13.38"> void CMapiMessage::FetchFlags(void)</span>
<a href="#l13.39"></a><span id="l13.39"> {</span>
<a href="#l13.40"></a><span id="l13.40">   LPSPropValue pVal = CMapiApi::GetMapiProperty(m_lpMsg, PR_MESSAGE_FLAGS);</span>
<a href="#l13.41"></a><span id="l13.41">   if (pVal)</span>
<a href="#l13.42"></a><span id="l13.42">     m_msgFlags = CMapiApi::GetLongFromProp(pVal);</span>
<a href="#l13.43"></a><span id="l13.43">   pVal = CMapiApi::GetMapiProperty(m_lpMsg, PR_LAST_VERB_EXECUTED);</span>
<a href="#l13.44"></a><span id="l13.44" class="difflineat">@@ -1265,17 +1265,19 @@ void CMapiMessageHeaders::CHeaderField::</span>
<a href="#l13.45"></a><span id="l13.45">     if ((*pos == nsCRT::CR) &amp;&amp; (*(pos+1) == nsCRT::LF) &amp;&amp; IsWSP(*(pos+2)))</span>
<a href="#l13.46"></a><span id="l13.46">       pos += 2; // Skip CRLF if it is followed by SPACE or TAB</span>
<a href="#l13.47"></a><span id="l13.47">     else</span>
<a href="#l13.48"></a><span id="l13.48">       unfolded.Append(*(pos++));</span>
<a href="#l13.49"></a><span id="l13.49">   }</span>
<a href="#l13.50"></a><span id="l13.50">   if (m_fbody_utf8)</span>
<a href="#l13.51"></a><span id="l13.51">     CopyUTF8toUTF16(unfolded, dest);</span>
<a href="#l13.52"></a><span id="l13.52">   else</span>
<a href="#l13.53"></a><span id="l13.53" class="difflineminus">-    nsMsgI18NConvertToUnicode(fallbackCharset, unfolded, dest);</span>
<a href="#l13.54"></a><span id="l13.54" class="difflineplus">+    nsMsgI18NConvertToUnicode(nsDependentCString(fallbackCharset),</span>
<a href="#l13.55"></a><span id="l13.55" class="difflineplus">+                                                 unfolded,</span>
<a href="#l13.56"></a><span id="l13.56" class="difflineplus">+                                                 dest);</span>
<a href="#l13.57"></a><span id="l13.57"> }</span>
<a href="#l13.58"></a><span id="l13.58"> </span>
<a href="#l13.59"></a><span id="l13.59"> ////////////////////////////////////////</span>
<a href="#l13.60"></a><span id="l13.60"> </span>
<a href="#l13.61"></a><span id="l13.61"> const char* CMapiMessageHeaders::Specials[hdrMax] = {</span>
<a href="#l13.62"></a><span id="l13.62">   &quot;Date:&quot;,</span>
<a href="#l13.63"></a><span id="l13.63">   &quot;From:&quot;,</span>
<a href="#l13.64"></a><span id="l13.64">   &quot;Sender:&quot;,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mailnews/import/outlook/src/nsOutlookCompose.cpp</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mailnews/import/outlook/src/nsOutlookCompose.cpp</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -282,17 +282,17 @@ nsresult nsOutlookCompose::ComposeTheMes</span>
<a href="#l14.4"></a><span id="l14.4">           new nsImportEmbeddedImageData(uri, nsDependentCString(cid),</span>
<a href="#l14.5"></a><span id="l14.5">                                      nsDependentCString(name));</span>
<a href="#l14.6"></a><span id="l14.6">         embeddedObjects-&gt;AppendElement(imageData);</span>
<a href="#l14.7"></a><span id="l14.7">       }</span>
<a href="#l14.8"></a><span id="l14.8">     }</span>
<a href="#l14.9"></a><span id="l14.9">   }</span>
<a href="#l14.10"></a><span id="l14.10"> </span>
<a href="#l14.11"></a><span id="l14.11">   nsCString bodyA;</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-  nsMsgI18NConvertFromUnicode(msg.GetBodyCharset(), bodyW, bodyA);</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+  nsMsgI18NConvertFromUnicode(nsDependentCString(msg.GetBodyCharset()), bodyW, bodyA);</span>
<a href="#l14.14"></a><span id="l14.14"> </span>
<a href="#l14.15"></a><span id="l14.15">   nsCOMPtr&lt;nsIImportService&gt; impService(do_GetService(NS_IMPORTSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l14.16"></a><span id="l14.16">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l14.17"></a><span id="l14.17"> </span>
<a href="#l14.18"></a><span id="l14.18">   // nsIImportService::CreateRFC822Message creates a runnable and dispatches to the main thread.</span>
<a href="#l14.19"></a><span id="l14.19">   rv = impService-&gt;CreateRFC822Message(</span>
<a href="#l14.20"></a><span id="l14.20">                         m_pIdentity,                  // dummy identity</span>
<a href="#l14.21"></a><span id="l14.21">                         m_pMsgFields,                 // message fields</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mailnews/import/text/src/nsTextAddress.cpp</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mailnews/import/text/src/nsTextAddress.cpp</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -37,17 +37,17 @@ nsTextAddress::~nsTextAddress()</span>
<a href="#l15.4"></a><span id="l15.4"> </span>
<a href="#l15.5"></a><span id="l15.5"> nsresult nsTextAddress::GetUnicharLineStreamForFile(nsIFile *aFile,</span>
<a href="#l15.6"></a><span id="l15.6">                                                     nsIInputStream *aInputStream,</span>
<a href="#l15.7"></a><span id="l15.7">                                                     nsIUnicharLineInputStream **aStream)</span>
<a href="#l15.8"></a><span id="l15.8"> {</span>
<a href="#l15.9"></a><span id="l15.9">   nsAutoCString charset;</span>
<a href="#l15.10"></a><span id="l15.10">   nsresult rv = MsgDetectCharsetFromFile(aFile, charset);</span>
<a href="#l15.11"></a><span id="l15.11">   if (NS_FAILED(rv)) {</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-    charset.Assign(nsMsgI18NFileSystemCharset());</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineplus">+    charset = nsMsgI18NFileSystemCharset();</span>
<a href="#l15.14"></a><span id="l15.14">   }</span>
<a href="#l15.15"></a><span id="l15.15"> </span>
<a href="#l15.16"></a><span id="l15.16">   nsCOMPtr&lt;nsIConverterInputStream&gt; converterStream =</span>
<a href="#l15.17"></a><span id="l15.17">     do_CreateInstance(&quot;@mozilla.org/intl/converter-input-stream;1&quot;, &amp;rv);</span>
<a href="#l15.18"></a><span id="l15.18">   if (NS_SUCCEEDED(rv)) {</span>
<a href="#l15.19"></a><span id="l15.19">     rv = converterStream-&gt;Init(aInputStream,</span>
<a href="#l15.20"></a><span id="l15.20">                                charset.get(),</span>
<a href="#l15.21"></a><span id="l15.21">                                8192,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mailnews/mapi/mapihook/src/msgMapiHook.cpp</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mailnews/mapi/mapihook/src/msgMapiHook.cpp</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -477,17 +477,19 @@ nsresult nsMapiHook::HandleAttachments (</span>
<a href="#l16.4"></a><span id="l16.4">             // leafName already contains a unicode leafName from lpszPathName. If we were given</span>
<a href="#l16.5"></a><span id="l16.5">             // a value for lpszFileName, use it. Otherwise stick with leafName</span>
<a href="#l16.6"></a><span id="l16.6">             if (aFiles[i].lpszFileName)</span>
<a href="#l16.7"></a><span id="l16.7">             {</span>
<a href="#l16.8"></a><span id="l16.8">               nsAutoString wholeFileName;</span>
<a href="#l16.9"></a><span id="l16.9">                 if (aIsUnicode)</span>
<a href="#l16.10"></a><span id="l16.10">                     wholeFileName.Assign(aFiles[i].lpszFileName);</span>
<a href="#l16.11"></a><span id="l16.11">                 else</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-                    ConvertToUnicode(nsMsgI18NFileSystemCharset(), (char *) aFiles[i].lpszFileName, wholeFileName);</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineplus">+                    nsMsgI18NConvertToUnicode(nsMsgI18NFileSystemCharset(),</span>
<a href="#l16.14"></a><span id="l16.14" class="difflineplus">+                                              nsDependentCString((char *) aFiles[i].lpszFileName),</span>
<a href="#l16.15"></a><span id="l16.15" class="difflineplus">+                                              wholeFileName);</span>
<a href="#l16.16"></a><span id="l16.16">                 // need to find the last '\' and find the leafname from that.</span>
<a href="#l16.17"></a><span id="l16.17">                 int32_t lastSlash = wholeFileName.RFindChar(char16_t('\\'));</span>
<a href="#l16.18"></a><span id="l16.18">                 if (lastSlash != kNotFound)</span>
<a href="#l16.19"></a><span id="l16.19">                   leafName.Assign(Substring(wholeFileName, lastSlash + 1));</span>
<a href="#l16.20"></a><span id="l16.20">                 else</span>
<a href="#l16.21"></a><span id="l16.21">                   leafName.Assign(wholeFileName);</span>
<a href="#l16.22"></a><span id="l16.22">             }</span>
<a href="#l16.23"></a><span id="l16.23">             else</span>
<a href="#l16.24"></a><span id="l16.24" class="difflineat">@@ -600,33 +602,37 @@ nsresult nsMapiHook::PopulateCompFieldsW</span>
<a href="#l16.25"></a><span id="l16.25">   MOZ_LOG(MAPI, mozilla::LogLevel::Debug, (&quot;to: %s cc: %s bcc: %s \n&quot;, NS_ConvertUTF16toUTF8(To).get(), NS_ConvertUTF16toUTF8(Cc).get(), NS_ConvertUTF16toUTF8(Bcc).get()));</span>
<a href="#l16.26"></a><span id="l16.26"> </span>
<a href="#l16.27"></a><span id="l16.27">   nsAutoCString platformCharSet;</span>
<a href="#l16.28"></a><span id="l16.28">   // set subject</span>
<a href="#l16.29"></a><span id="l16.29">   if (aMessage-&gt;lpszSubject)</span>
<a href="#l16.30"></a><span id="l16.30">   {</span>
<a href="#l16.31"></a><span id="l16.31">     nsAutoString Subject ;</span>
<a href="#l16.32"></a><span id="l16.32">     if (platformCharSet.IsEmpty())</span>
<a href="#l16.33"></a><span id="l16.33" class="difflineminus">-      platformCharSet.Assign(nsMsgI18NFileSystemCharset());</span>
<a href="#l16.34"></a><span id="l16.34" class="difflineminus">-    rv = ConvertToUnicode(platformCharSet.get(), (char *) aMessage-&gt;lpszSubject, Subject);</span>
<a href="#l16.35"></a><span id="l16.35" class="difflineplus">+      platformCharSet = nsMsgI18NFileSystemCharset();</span>
<a href="#l16.36"></a><span id="l16.36" class="difflineplus">+    rv = nsMsgI18NConvertToUnicode(platformCharSet,</span>
<a href="#l16.37"></a><span id="l16.37" class="difflineplus">+                                   nsDependentCString((char *) aMessage-&gt;lpszSubject),</span>
<a href="#l16.38"></a><span id="l16.38" class="difflineplus">+                                   Subject);</span>
<a href="#l16.39"></a><span id="l16.39">     if (NS_FAILED(rv)) return rv;</span>
<a href="#l16.40"></a><span id="l16.40">     aCompFields-&gt;SetSubject(Subject);</span>
<a href="#l16.41"></a><span id="l16.41">   }</span>
<a href="#l16.42"></a><span id="l16.42"> </span>
<a href="#l16.43"></a><span id="l16.43">   // handle attachments as File URL</span>
<a href="#l16.44"></a><span id="l16.44">   rv = HandleAttachments (aCompFields, aMessage-&gt;nFileCount, aMessage-&gt;lpFiles, false) ;</span>
<a href="#l16.45"></a><span id="l16.45">   if (NS_FAILED(rv)) return rv ;</span>
<a href="#l16.46"></a><span id="l16.46"> </span>
<a href="#l16.47"></a><span id="l16.47">   // set body</span>
<a href="#l16.48"></a><span id="l16.48">   if (aMessage-&gt;lpszNoteText)</span>
<a href="#l16.49"></a><span id="l16.49">   {</span>
<a href="#l16.50"></a><span id="l16.50">     nsAutoString Body ;</span>
<a href="#l16.51"></a><span id="l16.51">     if (platformCharSet.IsEmpty())</span>
<a href="#l16.52"></a><span id="l16.52" class="difflineminus">-      platformCharSet.Assign(nsMsgI18NFileSystemCharset());</span>
<a href="#l16.53"></a><span id="l16.53" class="difflineminus">-    rv = ConvertToUnicode(platformCharSet.get(), (char *) aMessage-&gt;lpszNoteText, Body);</span>
<a href="#l16.54"></a><span id="l16.54" class="difflineplus">+      platformCharSet = nsMsgI18NFileSystemCharset();</span>
<a href="#l16.55"></a><span id="l16.55" class="difflineplus">+    rv = nsMsgI18NConvertToUnicode(platformCharSet,</span>
<a href="#l16.56"></a><span id="l16.56" class="difflineplus">+                                   nsDependentCString((char *) aMessage-&gt;lpszNoteText),</span>
<a href="#l16.57"></a><span id="l16.57" class="difflineplus">+                                   Body);</span>
<a href="#l16.58"></a><span id="l16.58">     if (NS_FAILED(rv)) return rv ;</span>
<a href="#l16.59"></a><span id="l16.59">     if (Body.IsEmpty() || Body.Last() != '\n')</span>
<a href="#l16.60"></a><span id="l16.60">       Body.AppendLiteral(CRLF);</span>
<a href="#l16.61"></a><span id="l16.61"> </span>
<a href="#l16.62"></a><span id="l16.62">     // This is needed when Simple MAPI is used without a compose window.</span>
<a href="#l16.63"></a><span id="l16.63">     // See bug 1366196.</span>
<a href="#l16.64"></a><span id="l16.64">     if (Body.Find(&quot;&lt;html&gt;&quot;) == kNotFound)</span>
<a href="#l16.65"></a><span id="l16.65">       aCompFields-&gt;SetForcePlainText(true);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mailnews/mime/src/mimedrft.cpp</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mailnews/mime/src/mimedrft.cpp</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -183,17 +183,19 @@ nsresult CreateComposeParams(nsCOMPtr&lt;ns</span>
<a href="#l17.4"></a><span id="l17.4">     {</span>
<a href="#l17.5"></a><span id="l17.5">       rv = curAttachment-&gt;m_url-&gt;GetSpec(spec);</span>
<a href="#l17.6"></a><span id="l17.6">       if (NS_SUCCEEDED(rv))</span>
<a href="#l17.7"></a><span id="l17.7">       {</span>
<a href="#l17.8"></a><span id="l17.8">         nsCOMPtr&lt;nsIMsgAttachment&gt; attachment = do_CreateInstance(NS_MSGATTACHMENT_CONTRACTID, &amp;rv);</span>
<a href="#l17.9"></a><span id="l17.9">         if (NS_SUCCEEDED(rv) &amp;&amp; attachment)</span>
<a href="#l17.10"></a><span id="l17.10">         {</span>
<a href="#l17.11"></a><span id="l17.11">           nsAutoString nameStr;</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-          rv = ConvertToUnicode(&quot;UTF-8&quot;, curAttachment-&gt;m_realName.get(), nameStr);</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineplus">+          rv = nsMsgI18NConvertToUnicode(NS_LITERAL_CSTRING(&quot;UTF-8&quot;),</span>
<a href="#l17.14"></a><span id="l17.14" class="difflineplus">+                                         curAttachment-&gt;m_realName,</span>
<a href="#l17.15"></a><span id="l17.15" class="difflineplus">+                                         nameStr);</span>
<a href="#l17.16"></a><span id="l17.16">           if (NS_FAILED(rv))</span>
<a href="#l17.17"></a><span id="l17.17">             CopyASCIItoUTF16(curAttachment-&gt;m_realName, nameStr);</span>
<a href="#l17.18"></a><span id="l17.18">           attachment-&gt;SetName(nameStr);</span>
<a href="#l17.19"></a><span id="l17.19">           attachment-&gt;SetUrl(spec);</span>
<a href="#l17.20"></a><span id="l17.20">           attachment-&gt;SetTemporary(true);</span>
<a href="#l17.21"></a><span id="l17.21">           attachment-&gt;SetContentType(curAttachment-&gt;m_realType.get());</span>
<a href="#l17.22"></a><span id="l17.22">           attachment-&gt;SetMacType(curAttachment-&gt;m_xMacType.get());</span>
<a href="#l17.23"></a><span id="l17.23">           attachment-&gt;SetMacCreator(curAttachment-&gt;m_xMacCreator.get());</span>
<a href="#l17.24"></a><span id="l17.24" class="difflineat">@@ -342,42 +344,52 @@ CreateCompositionFields(const char      </span>
<a href="#l17.25"></a><span id="l17.25"> </span>
<a href="#l17.26"></a><span id="l17.26">   // Now set all of the passed in stuff...</span>
<a href="#l17.27"></a><span id="l17.27">   cFields-&gt;SetCharacterSet(!PL_strcasecmp(&quot;us-ascii&quot;, charset) ? &quot;ISO-8859-1&quot; : charset);</span>
<a href="#l17.28"></a><span id="l17.28"> </span>
<a href="#l17.29"></a><span id="l17.29">   nsAutoCString val;</span>
<a href="#l17.30"></a><span id="l17.30">   nsAutoString outString;</span>
<a href="#l17.31"></a><span id="l17.31"> </span>
<a href="#l17.32"></a><span id="l17.32">   if (from) {</span>
<a href="#l17.33"></a><span id="l17.33" class="difflineminus">-    ConvertRawBytesToUTF16(from, charset, outString);</span>
<a href="#l17.34"></a><span id="l17.34" class="difflineplus">+    nsMsgI18NConvertRawBytesToUTF16(nsDependentCString(from),</span>
<a href="#l17.35"></a><span id="l17.35" class="difflineplus">+                                    nsDependentCString(charset),</span>
<a href="#l17.36"></a><span id="l17.36" class="difflineplus">+                                    outString);</span>
<a href="#l17.37"></a><span id="l17.37">     cFields-&gt;SetFrom(outString);</span>
<a href="#l17.38"></a><span id="l17.38">   }</span>
<a href="#l17.39"></a><span id="l17.39"> </span>
<a href="#l17.40"></a><span id="l17.40">   if (subject) {</span>
<a href="#l17.41"></a><span id="l17.41">     MIME_DecodeMimeHeader(subject, charset, false, true, val);</span>
<a href="#l17.42"></a><span id="l17.42">     cFields-&gt;SetSubject(NS_ConvertUTF8toUTF16(!val.IsEmpty() ? val.get() : subject));</span>
<a href="#l17.43"></a><span id="l17.43">   }</span>
<a href="#l17.44"></a><span id="l17.44"> </span>
<a href="#l17.45"></a><span id="l17.45">   if (reply_to) {</span>
<a href="#l17.46"></a><span id="l17.46" class="difflineminus">-    ConvertRawBytesToUTF16(reply_to, charset, outString);</span>
<a href="#l17.47"></a><span id="l17.47" class="difflineplus">+    nsMsgI18NConvertRawBytesToUTF16(nsDependentCString(reply_to),</span>
<a href="#l17.48"></a><span id="l17.48" class="difflineplus">+                                    nsDependentCString(charset),</span>
<a href="#l17.49"></a><span id="l17.49" class="difflineplus">+                                    outString);</span>
<a href="#l17.50"></a><span id="l17.50">     cFields-&gt;SetReplyTo(outString);</span>
<a href="#l17.51"></a><span id="l17.51">   }</span>
<a href="#l17.52"></a><span id="l17.52"> </span>
<a href="#l17.53"></a><span id="l17.53">   if (to) {</span>
<a href="#l17.54"></a><span id="l17.54" class="difflineminus">-    ConvertRawBytesToUTF16(to, charset, outString);</span>
<a href="#l17.55"></a><span id="l17.55" class="difflineplus">+    nsMsgI18NConvertRawBytesToUTF16(nsDependentCString(to),</span>
<a href="#l17.56"></a><span id="l17.56" class="difflineplus">+                                    nsDependentCString(charset),</span>
<a href="#l17.57"></a><span id="l17.57" class="difflineplus">+                                    outString);</span>
<a href="#l17.58"></a><span id="l17.58">     cFields-&gt;SetTo(outString);</span>
<a href="#l17.59"></a><span id="l17.59">   }</span>
<a href="#l17.60"></a><span id="l17.60"> </span>
<a href="#l17.61"></a><span id="l17.61">   if (cc) {</span>
<a href="#l17.62"></a><span id="l17.62" class="difflineminus">-    ConvertRawBytesToUTF16(cc, charset, outString);</span>
<a href="#l17.63"></a><span id="l17.63" class="difflineplus">+    nsMsgI18NConvertRawBytesToUTF16(nsDependentCString(cc),</span>
<a href="#l17.64"></a><span id="l17.64" class="difflineplus">+                                    nsDependentCString(charset),</span>
<a href="#l17.65"></a><span id="l17.65" class="difflineplus">+                                    outString);</span>
<a href="#l17.66"></a><span id="l17.66">     cFields-&gt;SetCc(outString);</span>
<a href="#l17.67"></a><span id="l17.67">   }</span>
<a href="#l17.68"></a><span id="l17.68"> </span>
<a href="#l17.69"></a><span id="l17.69">   if (bcc) {</span>
<a href="#l17.70"></a><span id="l17.70" class="difflineminus">-    ConvertRawBytesToUTF16(bcc, charset, outString);</span>
<a href="#l17.71"></a><span id="l17.71" class="difflineplus">+    nsMsgI18NConvertRawBytesToUTF16(nsDependentCString(bcc),</span>
<a href="#l17.72"></a><span id="l17.72" class="difflineplus">+                                    nsDependentCString(charset),</span>
<a href="#l17.73"></a><span id="l17.73" class="difflineplus">+                                    outString);</span>
<a href="#l17.74"></a><span id="l17.74">     cFields-&gt;SetBcc(outString);</span>
<a href="#l17.75"></a><span id="l17.75">   }</span>
<a href="#l17.76"></a><span id="l17.76"> </span>
<a href="#l17.77"></a><span id="l17.77">   if (fcc) {</span>
<a href="#l17.78"></a><span id="l17.78">     MIME_DecodeMimeHeader(fcc, charset, false, true, val);</span>
<a href="#l17.79"></a><span id="l17.79">     cFields-&gt;SetFcc(NS_ConvertUTF8toUTF16(!val.IsEmpty() ? val.get() : fcc));</span>
<a href="#l17.80"></a><span id="l17.80">   }</span>
<a href="#l17.81"></a><span id="l17.81"> </span>
<a href="#l17.82"></a><span id="l17.82" class="difflineat">@@ -1521,17 +1533,19 @@ mime_parse_stream_complete(nsMIMESession</span>
<a href="#l17.83"></a><span id="l17.83">           // Get a charset from the header if no override is set.</span>
<a href="#l17.84"></a><span id="l17.84">           if (!charsetOverride)</span>
<a href="#l17.85"></a><span id="l17.85">             mimeCharset = MimeHeaders_get_parameter(mdd-&gt;messageBody-&gt;m_type.get(), &quot;charset&quot;, nullptr, nullptr);</span>
<a href="#l17.86"></a><span id="l17.86">           // If no charset is specified in the header then use the default.</span>
<a href="#l17.87"></a><span id="l17.87">           char *bodyCharset = mimeCharset ? mimeCharset : mdd-&gt;mailcharset;</span>
<a href="#l17.88"></a><span id="l17.88">           if (bodyCharset)</span>
<a href="#l17.89"></a><span id="l17.89">           {</span>
<a href="#l17.90"></a><span id="l17.90">             nsAutoString tmpUnicodeBody;</span>
<a href="#l17.91"></a><span id="l17.91" class="difflineminus">-            rv = ConvertToUnicode(bodyCharset, body, tmpUnicodeBody);</span>
<a href="#l17.92"></a><span id="l17.92" class="difflineplus">+            rv = nsMsgI18NConvertToUnicode(nsDependentCString(bodyCharset),</span>
<a href="#l17.93"></a><span id="l17.93" class="difflineplus">+                                           nsDependentCString(body),</span>
<a href="#l17.94"></a><span id="l17.94" class="difflineplus">+                                           tmpUnicodeBody);</span>
<a href="#l17.95"></a><span id="l17.95">             if (NS_FAILED(rv)) // Tough luck, ASCII/ISO-8859-1 then...</span>
<a href="#l17.96"></a><span id="l17.96">               CopyASCIItoUTF16(nsDependentCString(body), tmpUnicodeBody);</span>
<a href="#l17.97"></a><span id="l17.97"> </span>
<a href="#l17.98"></a><span id="l17.98">             char *newBody = ToNewUTF8String(tmpUnicodeBody);</span>
<a href="#l17.99"></a><span id="l17.99">             if (newBody)</span>
<a href="#l17.100"></a><span id="l17.100">             {</span>
<a href="#l17.101"></a><span id="l17.101">               PR_Free(body);</span>
<a href="#l17.102"></a><span id="l17.102">               body = newBody;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/mailnews/mime/src/mimehdrs.cpp</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/mailnews/mime/src/mimehdrs.cpp</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -34,17 +34,19 @@ MimeHeaders_convert_header_value(MimeDis</span>
<a href="#l18.4"></a><span id="l18.4">                                  bool convert_charset_only)</span>
<a href="#l18.5"></a><span id="l18.5"> {</span>
<a href="#l18.6"></a><span id="l18.6">   if (value.IsEmpty())</span>
<a href="#l18.7"></a><span id="l18.7">     return;</span>
<a href="#l18.8"></a><span id="l18.8"> </span>
<a href="#l18.9"></a><span id="l18.9">   if (convert_charset_only)</span>
<a href="#l18.10"></a><span id="l18.10">   {</span>
<a href="#l18.11"></a><span id="l18.11">     nsAutoCString output;</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-    ConvertRawBytesToUTF8(value, opt-&gt;default_charset, output);</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineplus">+    nsMsgI18NConvertRawBytesToUTF8(value,</span>
<a href="#l18.14"></a><span id="l18.14" class="difflineplus">+                                   nsDependentCString(opt-&gt;default_charset),</span>
<a href="#l18.15"></a><span id="l18.15" class="difflineplus">+                                   output);</span>
<a href="#l18.16"></a><span id="l18.16">     value.Assign(output);</span>
<a href="#l18.17"></a><span id="l18.17">     return;</span>
<a href="#l18.18"></a><span id="l18.18">   }</span>
<a href="#l18.19"></a><span id="l18.19"> </span>
<a href="#l18.20"></a><span id="l18.20">   if (opt &amp;&amp; opt-&gt;rfc1522_conversion_p)</span>
<a href="#l18.21"></a><span id="l18.21">   {</span>
<a href="#l18.22"></a><span id="l18.22">     nsAutoCString temporary;</span>
<a href="#l18.23"></a><span id="l18.23">     MIME_DecodeMimeHeader(value.get(), opt-&gt;default_charset,</span>
<a href="#l18.24"></a><span id="l18.24" class="difflineat">@@ -600,17 +602,18 @@ MimeHeaders_write_all_headers (MimeHeade</span>
<a href="#l18.25"></a><span id="l18.25">           MsgLowerCaseEqualsLiteral(name, &quot;to&quot;) || MsgLowerCaseEqualsLiteral(name, &quot;from&quot;) ||</span>
<a href="#l18.26"></a><span id="l18.26">           MsgLowerCaseEqualsLiteral(name, &quot;cc&quot;) || MsgLowerCaseEqualsLiteral(name, &quot;bcc&quot;) ||</span>
<a href="#l18.27"></a><span id="l18.27">           MsgLowerCaseEqualsLiteral(name, &quot;reply-to&quot;) || MsgLowerCaseEqualsLiteral(name, &quot;sender&quot;);</span>
<a href="#l18.28"></a><span id="l18.28">     MimeHeaders_convert_header_value(opt, hdr_value, convert_charset_only);</span>
<a href="#l18.29"></a><span id="l18.29">     // if we're saving as html, we need to convert headers from utf8 to message charset, if any</span>
<a href="#l18.30"></a><span id="l18.30">     if (opt-&gt;format_out == nsMimeOutput::nsMimeMessageSaveAs &amp;&amp; charset)</span>
<a href="#l18.31"></a><span id="l18.31">     {</span>
<a href="#l18.32"></a><span id="l18.32">       nsAutoCString convertedStr;</span>
<a href="#l18.33"></a><span id="l18.33" class="difflineminus">-      if (NS_SUCCEEDED(ConvertFromUnicode(charset, NS_ConvertUTF8toUTF16(hdr_value),</span>
<a href="#l18.34"></a><span id="l18.34" class="difflineplus">+      if (NS_SUCCEEDED(nsMsgI18NConvertFromUnicode(nsDependentCString(charset),</span>
<a href="#l18.35"></a><span id="l18.35" class="difflineplus">+                       NS_ConvertUTF8toUTF16(hdr_value),</span>
<a href="#l18.36"></a><span id="l18.36">                        convertedStr)))</span>
<a href="#l18.37"></a><span id="l18.37">       {</span>
<a href="#l18.38"></a><span id="l18.38">         hdr_value = convertedStr;</span>
<a href="#l18.39"></a><span id="l18.39">       }</span>
<a href="#l18.40"></a><span id="l18.40">     }</span>
<a href="#l18.41"></a><span id="l18.41"> </span>
<a href="#l18.42"></a><span id="l18.42">     if (attachment) {</span>
<a href="#l18.43"></a><span id="l18.43">       if (NS_FAILED(mimeEmitterAddAttachmentField(opt, name.get(), hdr_value.get())))</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/mailnews/mime/src/mimemsg.cpp</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/mailnews/mime/src/mimemsg.cpp</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -280,17 +280,17 @@ MimeMessage_close_headers (MimeObject *o</span>
<a href="#l19.4"></a><span id="l19.4">     nsCString contentType;</span>
<a href="#l19.5"></a><span id="l19.5">     contentType.Adopt(MimeHeaders_get(msg-&gt;hdrs, HEADER_CONTENT_TYPE, false, false));</span>
<a href="#l19.6"></a><span id="l19.6">     if (!contentType.IsEmpty())</span>
<a href="#l19.7"></a><span id="l19.7">       charset.Adopt(MimeHeaders_get_parameter(contentType.get(), &quot;charset&quot;, nullptr, nullptr));</span>
<a href="#l19.8"></a><span id="l19.8"> </span>
<a href="#l19.9"></a><span id="l19.9">     // If we've got a charset, use nsMsgI18NConvertToUnicode to magically decode</span>
<a href="#l19.10"></a><span id="l19.10">     // the munged subject.</span>
<a href="#l19.11"></a><span id="l19.11">     if (!charset.IsEmpty()) {</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-      nsresult rv = nsMsgI18NConvertToUnicode(charset.get(), orig, dest);</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineplus">+      nsresult rv = nsMsgI18NConvertToUnicode(charset, orig, dest);</span>
<a href="#l19.14"></a><span id="l19.14">       // If we managed to convert the string, replace munged_subject with the</span>
<a href="#l19.15"></a><span id="l19.15">       // UTF8 version of it, otherwise, just forget about it (maybe there was an</span>
<a href="#l19.16"></a><span id="l19.16">       // improperly encoded string in there).</span>
<a href="#l19.17"></a><span id="l19.17">       PR_Free(obj-&gt;headers-&gt;munged_subject);</span>
<a href="#l19.18"></a><span id="l19.18">       if (NS_SUCCEEDED(rv))</span>
<a href="#l19.19"></a><span id="l19.19">         obj-&gt;headers-&gt;munged_subject = ToNewUTF8String(dest);</span>
<a href="#l19.20"></a><span id="l19.20">       else</span>
<a href="#l19.21"></a><span id="l19.21">         obj-&gt;headers-&gt;munged_subject = nullptr;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/mailnews/mime/src/mimetpfl.cpp</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/mailnews/mime/src/mimetpfl.cpp</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -366,17 +366,19 @@ MimeInlineTextPlainFlowed_parse_line (co</span>
<a href="#l20.4"></a><span id="l20.4">       if (obj-&gt;options-&gt;format_out == nsMimeOutput::nsMimeMessageSaveAs)</span>
<a href="#l20.5"></a><span id="l20.5">       {</span>
<a href="#l20.6"></a><span id="l20.6">         // Get the mail charset of this message.</span>
<a href="#l20.7"></a><span id="l20.7">         MimeInlineText  *inlinetext = (MimeInlineText *) obj;</span>
<a href="#l20.8"></a><span id="l20.8">         if (!inlinetext-&gt;initializeCharset)</span>
<a href="#l20.9"></a><span id="l20.9">           ((MimeInlineTextClass*)&amp;mimeInlineTextClass)-&gt;initialize_charset(obj);</span>
<a href="#l20.10"></a><span id="l20.10">         mailCharset = inlinetext-&gt;charset;</span>
<a href="#l20.11"></a><span id="l20.11">         if (mailCharset &amp;&amp; *mailCharset) {</span>
<a href="#l20.12"></a><span id="l20.12" class="difflineminus">-          rv = nsMsgI18NConvertToUnicode(mailCharset, PromiseFlatCString(inputStr), lineSource);</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineplus">+          rv = nsMsgI18NConvertToUnicode(nsDependentCString(mailCharset),</span>
<a href="#l20.14"></a><span id="l20.14" class="difflineplus">+                                         PromiseFlatCString(inputStr),</span>
<a href="#l20.15"></a><span id="l20.15" class="difflineplus">+                                         lineSource);</span>
<a href="#l20.16"></a><span id="l20.16">           NS_ENSURE_SUCCESS(rv, -1);</span>
<a href="#l20.17"></a><span id="l20.17">         }</span>
<a href="#l20.18"></a><span id="l20.18">         else // this probably never happens...</span>
<a href="#l20.19"></a><span id="l20.19">           CopyUTF8toUTF16(inputStr, lineSource);</span>
<a href="#l20.20"></a><span id="l20.20">       }</span>
<a href="#l20.21"></a><span id="l20.21">       else   // line is in UTF-8</span>
<a href="#l20.22"></a><span id="l20.22">         CopyUTF8toUTF16(inputStr, lineSource);</span>
<a href="#l20.23"></a><span id="l20.23"> </span>
<a href="#l20.24"></a><span id="l20.24" class="difflineat">@@ -465,17 +467,19 @@ MimeInlineTextPlainFlowed_parse_line (co</span>
<a href="#l20.25"></a><span id="l20.25">     status = MimeObject_write(obj, preface.get(), preface.Length(), true);</span>
<a href="#l20.26"></a><span id="l20.26">     if (status &lt; 0) return status;</span>
<a href="#l20.27"></a><span id="l20.27">     nsAutoCString outString;</span>
<a href="#l20.28"></a><span id="l20.28">     if (obj-&gt;options-&gt;format_out != nsMimeOutput::nsMimeMessageSaveAs ||</span>
<a href="#l20.29"></a><span id="l20.29">         !mailCharset || !*mailCharset)</span>
<a href="#l20.30"></a><span id="l20.30">       CopyUTF16toUTF8(lineResult2, outString);</span>
<a href="#l20.31"></a><span id="l20.31">     else</span>
<a href="#l20.32"></a><span id="l20.32">     { // convert back to mailCharset before writing.</span>
<a href="#l20.33"></a><span id="l20.33" class="difflineminus">-      rv = nsMsgI18NConvertFromUnicode(mailCharset, lineResult2, outString);</span>
<a href="#l20.34"></a><span id="l20.34" class="difflineplus">+      rv = nsMsgI18NConvertFromUnicode(nsDependentCString(mailCharset),</span>
<a href="#l20.35"></a><span id="l20.35" class="difflineplus">+                                       lineResult2,</span>
<a href="#l20.36"></a><span id="l20.36" class="difflineplus">+                                       outString);</span>
<a href="#l20.37"></a><span id="l20.37">       NS_ENSURE_SUCCESS(rv, -1);</span>
<a href="#l20.38"></a><span id="l20.38">     }</span>
<a href="#l20.39"></a><span id="l20.39">     status = MimeObject_write(obj, outString.get(), outString.Length(), true);</span>
<a href="#l20.40"></a><span id="l20.40">     return status;</span>
<a href="#l20.41"></a><span id="l20.41">   }</span>
<a href="#l20.42"></a><span id="l20.42">   return 0;</span>
<a href="#l20.43"></a><span id="l20.43"> }</span>
<a href="#l20.44"></a><span id="l20.44"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/mailnews/mime/src/mimetpla.cpp</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/mailnews/mime/src/mimetpla.cpp</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -313,17 +313,19 @@ MimeInlineTextPlain_parse_line (const ch</span>
<a href="#l21.4"></a><span id="l21.4">     // convert |line| to UTF-16 before 'html'izing (calling ScanTXT())</span>
<a href="#l21.5"></a><span id="l21.5">     if (obj-&gt;options-&gt;format_out == nsMimeOutput::nsMimeMessageSaveAs)</span>
<a href="#l21.6"></a><span id="l21.6">     { // Get the mail charset of this message.</span>
<a href="#l21.7"></a><span id="l21.7">       MimeInlineText  *inlinetext = (MimeInlineText *) obj;</span>
<a href="#l21.8"></a><span id="l21.8">       if (!inlinetext-&gt;initializeCharset)</span>
<a href="#l21.9"></a><span id="l21.9">          ((MimeInlineTextClass*)&amp;mimeInlineTextClass)-&gt;initialize_charset(obj);</span>
<a href="#l21.10"></a><span id="l21.10">       mailCharset = inlinetext-&gt;charset;</span>
<a href="#l21.11"></a><span id="l21.11">       if (mailCharset &amp;&amp; *mailCharset) {</span>
<a href="#l21.12"></a><span id="l21.12" class="difflineminus">-        rv = nsMsgI18NConvertToUnicode(mailCharset, inputStr, lineSourceStr);</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineplus">+        rv = nsMsgI18NConvertToUnicode(nsDependentCString(mailCharset),</span>
<a href="#l21.14"></a><span id="l21.14" class="difflineplus">+                                       inputStr,</span>
<a href="#l21.15"></a><span id="l21.15" class="difflineplus">+                                       lineSourceStr);</span>
<a href="#l21.16"></a><span id="l21.16">         NS_ENSURE_SUCCESS(rv, -1);</span>
<a href="#l21.17"></a><span id="l21.17">       }</span>
<a href="#l21.18"></a><span id="l21.18">       else // this probably never happens ...</span>
<a href="#l21.19"></a><span id="l21.19">         CopyUTF8toUTF16(inputStr, lineSourceStr);</span>
<a href="#l21.20"></a><span id="l21.20">     }</span>
<a href="#l21.21"></a><span id="l21.21">     else  // line is in UTF-8</span>
<a href="#l21.22"></a><span id="l21.22">       CopyUTF8toUTF16(inputStr, lineSourceStr);</span>
<a href="#l21.23"></a><span id="l21.23"> </span>
<a href="#l21.24"></a><span id="l21.24" class="difflineat">@@ -424,18 +426,19 @@ MimeInlineTextPlain_parse_line (const ch</span>
<a href="#l21.25"></a><span id="l21.25">       status = MimeObject_write(obj, prefaceResultStr.get(), prefaceResultStr.Length(), true);</span>
<a href="#l21.26"></a><span id="l21.26">       if (status &lt; 0) return status;</span>
<a href="#l21.27"></a><span id="l21.27">       nsAutoCString outString;</span>
<a href="#l21.28"></a><span id="l21.28">       if (obj-&gt;options-&gt;format_out != nsMimeOutput::nsMimeMessageSaveAs ||</span>
<a href="#l21.29"></a><span id="l21.29">           !mailCharset || !*mailCharset)</span>
<a href="#l21.30"></a><span id="l21.30">         CopyUTF16toUTF8(lineResultUnichar, outString);</span>
<a href="#l21.31"></a><span id="l21.31">       else</span>
<a href="#l21.32"></a><span id="l21.32">       { // convert back to mailCharset before writing.</span>
<a href="#l21.33"></a><span id="l21.33" class="difflineminus">-        rv = nsMsgI18NConvertFromUnicode(mailCharset,</span>
<a href="#l21.34"></a><span id="l21.34" class="difflineminus">-                                         lineResultUnichar, outString);</span>
<a href="#l21.35"></a><span id="l21.35" class="difflineplus">+        rv = nsMsgI18NConvertFromUnicode(nsDependentCString(mailCharset),</span>
<a href="#l21.36"></a><span id="l21.36" class="difflineplus">+                                         lineResultUnichar,</span>
<a href="#l21.37"></a><span id="l21.37" class="difflineplus">+                                         outString);</span>
<a href="#l21.38"></a><span id="l21.38">         NS_ENSURE_SUCCESS(rv, -1);</span>
<a href="#l21.39"></a><span id="l21.39">       }</span>
<a href="#l21.40"></a><span id="l21.40"> </span>
<a href="#l21.41"></a><span id="l21.41">       status = MimeObject_write(obj, outString.get(), outString.Length(), true);</span>
<a href="#l21.42"></a><span id="l21.42">     }</span>
<a href="#l21.43"></a><span id="l21.43">     else</span>
<a href="#l21.44"></a><span id="l21.44">     {</span>
<a href="#l21.45"></a><span id="l21.45">       status = 0;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/mailnews/news/src/nsNNTPProtocol.cpp</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/mailnews/news/src/nsNNTPProtocol.cpp</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -1552,17 +1552,17 @@ nsresult nsNNTPProtocol::SendListSearche</span>
<a href="#l22.4"></a><span id="l22.4">   if (!line)</span>
<a href="#l22.5"></a><span id="l22.5">     return rv;  /* no line yet */</span>
<a href="#l22.6"></a><span id="l22.6"> </span>
<a href="#l22.7"></a><span id="l22.7">   if ('.' != line[0])</span>
<a href="#l22.8"></a><span id="l22.8">   {</span>
<a href="#l22.9"></a><span id="l22.9">         nsAutoCString charset;</span>
<a href="#l22.10"></a><span id="l22.10">         nsAutoString lineUtf16;</span>
<a href="#l22.11"></a><span id="l22.11">         if (NS_FAILED(m_nntpServer-&gt;GetCharset(charset)) ||</span>
<a href="#l22.12"></a><span id="l22.12" class="difflineminus">-            NS_FAILED(nsMsgI18NConvertToUnicode(charset.get(),</span>
<a href="#l22.13"></a><span id="l22.13" class="difflineplus">+            NS_FAILED(nsMsgI18NConvertToUnicode(charset,</span>
<a href="#l22.14"></a><span id="l22.14">                                                 nsDependentCString(line),</span>
<a href="#l22.15"></a><span id="l22.15">                                                 lineUtf16)))</span>
<a href="#l22.16"></a><span id="l22.16">             CopyUTF8toUTF16(nsDependentCString(line), lineUtf16);</span>
<a href="#l22.17"></a><span id="l22.17"> </span>
<a href="#l22.18"></a><span id="l22.18">     m_nntpServer-&gt;AddSearchableGroup(lineUtf16);</span>
<a href="#l22.19"></a><span id="l22.19">   }</span>
<a href="#l22.20"></a><span id="l22.20">   else</span>
<a href="#l22.21"></a><span id="l22.21">   {</span>
<a href="#l22.22"></a><span id="l22.22" class="difflineat">@@ -2657,17 +2657,17 @@ nsresult nsNNTPProtocol::ProcessNewsgrou</span>
<a href="#l22.23"></a><span id="l22.23"> </span>
<a href="#l22.24"></a><span id="l22.24">   bool xactive=false;</span>
<a href="#l22.25"></a><span id="l22.25">   rv = m_nntpServer-&gt;QueryExtension(&quot;XACTIVE&quot;,&amp;xactive);</span>
<a href="#l22.26"></a><span id="l22.26">   if (NS_SUCCEEDED(rv) &amp;&amp; xactive)</span>
<a href="#l22.27"></a><span id="l22.27">   {</span>
<a href="#l22.28"></a><span id="l22.28">     nsAutoCString charset;</span>
<a href="#l22.29"></a><span id="l22.29">     nsAutoString lineUtf16;</span>
<a href="#l22.30"></a><span id="l22.30">     if (NS_SUCCEEDED(m_nntpServer-&gt;GetCharset(charset)) &amp;&amp;</span>
<a href="#l22.31"></a><span id="l22.31" class="difflineminus">-        NS_SUCCEEDED(nsMsgI18NConvertToUnicode(charset.get(),</span>
<a href="#l22.32"></a><span id="l22.32" class="difflineplus">+        NS_SUCCEEDED(nsMsgI18NConvertToUnicode(charset,</span>
<a href="#l22.33"></a><span id="l22.33">                                                nsDependentCString(line),</span>
<a href="#l22.34"></a><span id="l22.34">                                                lineUtf16)))</span>
<a href="#l22.35"></a><span id="l22.35">       m_nntpServer-&gt;SetGroupNeedsExtraInfo(NS_ConvertUTF16toUTF8(lineUtf16),</span>
<a href="#l22.36"></a><span id="l22.36">                                            true);</span>
<a href="#l22.37"></a><span id="l22.37">     else</span>
<a href="#l22.38"></a><span id="l22.38">       m_nntpServer-&gt;SetGroupNeedsExtraInfo(nsDependentCString(line), true);</span>
<a href="#l22.39"></a><span id="l22.39">   }</span>
<a href="#l22.40"></a><span id="l22.40"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/mailnews/news/src/nsNewsFolder.cpp</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/mailnews/news/src/nsNewsFolder.cpp</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -1489,17 +1489,17 @@ nsMsgNewsFolder::GetRawName(nsACString &amp;</span>
<a href="#l23.4"></a><span id="l23.4">     // convert to the server-side encoding</span>
<a href="#l23.5"></a><span id="l23.5">     nsCOMPtr &lt;nsINntpIncomingServer&gt; nntpServer;</span>
<a href="#l23.6"></a><span id="l23.6">     rv = GetNntpServer(getter_AddRefs(nntpServer));</span>
<a href="#l23.7"></a><span id="l23.7">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l23.8"></a><span id="l23.8"> </span>
<a href="#l23.9"></a><span id="l23.9">     nsAutoCString dataCharset;</span>
<a href="#l23.10"></a><span id="l23.10">     rv = nntpServer-&gt;GetCharset(dataCharset);</span>
<a href="#l23.11"></a><span id="l23.11">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l23.12"></a><span id="l23.12" class="difflineminus">-    rv = nsMsgI18NConvertFromUnicode(dataCharset.get(), name, mRawName);</span>
<a href="#l23.13"></a><span id="l23.13" class="difflineplus">+    rv = nsMsgI18NConvertFromUnicode(dataCharset, name, mRawName);</span>
<a href="#l23.14"></a><span id="l23.14"> </span>
<a href="#l23.15"></a><span id="l23.15">     if (NS_FAILED(rv))</span>
<a href="#l23.16"></a><span id="l23.16">       LossyCopyUTF16toASCII(name, mRawName);</span>
<a href="#l23.17"></a><span id="l23.17">   }</span>
<a href="#l23.18"></a><span id="l23.18">   aRawName = mRawName;</span>
<a href="#l23.19"></a><span id="l23.19">   return NS_OK;</span>
<a href="#l23.20"></a><span id="l23.20"> }</span>
<a href="#l23.21"></a><span id="l23.21"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1" class="difflineminus">--- a/mailnews/news/src/nsNntpIncomingServer.cpp</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineplus">+++ b/mailnews/news/src/nsNntpIncomingServer.cpp</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineat">@@ -980,17 +980,17 @@ nsNntpIncomingServer::AddNewsgroupToList</span>
<a href="#l24.4"></a><span id="l24.4"> {</span>
<a href="#l24.5"></a><span id="l24.5">     nsresult rv;</span>
<a href="#l24.6"></a><span id="l24.6"> </span>
<a href="#l24.7"></a><span id="l24.7">     nsAutoString newsgroupName;</span>
<a href="#l24.8"></a><span id="l24.8">     nsAutoCString dataCharset;</span>
<a href="#l24.9"></a><span id="l24.9">     rv = GetCharset(dataCharset);</span>
<a href="#l24.10"></a><span id="l24.10">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l24.11"></a><span id="l24.11"> </span>
<a href="#l24.12"></a><span id="l24.12" class="difflineminus">-    rv = nsMsgI18NConvertToUnicode(dataCharset.get(),</span>
<a href="#l24.13"></a><span id="l24.13" class="difflineplus">+    rv = nsMsgI18NConvertToUnicode(dataCharset,</span>
<a href="#l24.14"></a><span id="l24.14">                                    nsDependentCString(aName),</span>
<a href="#l24.15"></a><span id="l24.15">                                    newsgroupName);</span>
<a href="#l24.16"></a><span id="l24.16"> #ifdef DEBUG_jungshik</span>
<a href="#l24.17"></a><span id="l24.17">     NS_ASSERTION(NS_SUCCEEDED(rv), &quot;newsgroup name conversion failed&quot;);</span>
<a href="#l24.18"></a><span id="l24.18"> #endif</span>
<a href="#l24.19"></a><span id="l24.19">     if (NS_FAILED(rv)) {</span>
<a href="#l24.20"></a><span id="l24.20">         CopyASCIItoUTF16(nsDependentCString(aName), newsgroupName);</span>
<a href="#l24.21"></a><span id="l24.21">     }</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

