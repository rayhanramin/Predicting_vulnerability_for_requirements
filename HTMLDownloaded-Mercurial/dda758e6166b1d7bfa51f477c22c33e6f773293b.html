<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 910:dda758e6166b1d7bfa51f477c22c33e6f773293b</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ dda758e6166b1d7bfa51f477c22c33e6f773293b" />
<meta property="og:url" content="/comm-central/rev/dda758e6166b1d7bfa51f477c22c33e6f773293b" />
<meta property="og:description" content="* added tests for read/starred attributes, with event-driven modifications" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / dda758e6166b1d7bfa51f477c22c33e6f773293b 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/dda758e6166b1d7bfa51f477c22c33e6f773293b">shortlog</a> |
<a href="/comm-central/log/dda758e6166b1d7bfa51f477c22c33e6f773293b">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/dda758e6166b1d7bfa51f477c22c33e6f773293b">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/dda758e6166b1d7bfa51f477c22c33e6f773293b">files</a> |
changeset |
<a href="/comm-central/raw-rev/dda758e6166b1d7bfa51f477c22c33e6f773293b">raw</a>  | <a href="/comm-central/archive/dda758e6166b1d7bfa51f477c22c33e6f773293b.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
* added tests for read/starred attributes, with event-driven modifications
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#65;&#110;&#100;&#114;&#101;&#119;&#32;&#83;&#117;&#116;&#104;&#101;&#114;&#108;&#97;&#110;&#100;&#32;&#60;&#97;&#115;&#117;&#116;&#104;&#101;&#114;&#108;&#97;&#110;&#100;&#64;&#97;&#115;&#117;&#116;&#104;&#101;&#114;&#108;&#97;&#110;&#100;&#46;&#111;&#114;&#103;&#62;</td></tr>
<tr><td></td><td class="date age">Thu, 04 Sep 2008 00:48:35 -0700</td></tr>

<tr>
 <td>changeset 910</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/dda758e6166b1d7bfa51f477c22c33e6f773293b">dda758e6166b1d7bfa51f477c22c33e6f773293b</a></td>
</tr>



<tr>
<td>parent 909</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/2d1bf9dff696e6c044701d3d4f6ede7121500b2f">2d1bf9dff696e6c044701d3d4f6ede7121500b2f</a>
</td>
</tr>

<tr>
<td>child 911</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/8fbc91720994765c93399f64171b599d0f8287bb">8fbc91720994765c93399f64171b599d0f8287bb</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=dda758e6166b1d7bfa51f477c22c33e6f773293b">743</a></td></tr>
<tr><td>push user</td><td>dmosedale@mozilla.com</td></tr>
<tr><td>push date</td><td class="date age">Tue, 04 Nov 2008 20:01:44 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@a79b923a9cba [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=a79b923a9cba395cb3911b27c9599ffb8c997caf">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=a79b923a9cba395cb3911b27c9599ffb8c997caf&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=a79b923a9cba395cb3911b27c9599ffb8c997caf&newProject=comm-central&newRevision=d32b4cc6f46d1195ae66fd0cf8395c60b9259ca6&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=a79b923a9cba395cb3911b27c9599ffb8c997caf&newProject=comm-central&newRevision=d32b4cc6f46d1195ae66fd0cf8395c60b9259ca6&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=a79b923a9cba395cb3911b27c9599ffb8c997caf&newProject=comm-central&newRevision=d32b4cc6f46d1195ae66fd0cf8395c60b9259ca6&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>






</table></div>

<div class="page_body description">* added tests for read/starred attributes, with event-driven modifications
 * we now support event-driven re-indexing based on reading/starring messages.
   at least if the unit tests are to be believed!  hooray
   test-driven-development, perhaps!
 * item added / modified notifications for messages now (exist and) are sane.</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/dda758e6166b1d7bfa51f477c22c33e6f773293b/modules/datamodel.js">modules/datamodel.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dda758e6166b1d7bfa51f477c22c33e6f773293b/modules/datamodel.js">file</a> |
<a href="/comm-central/annotate/dda758e6166b1d7bfa51f477c22c33e6f773293b/modules/datamodel.js">annotate</a> |
<a href="/comm-central/diff/dda758e6166b1d7bfa51f477c22c33e6f773293b/modules/datamodel.js">diff</a> |
<a href="/comm-central/comparison/dda758e6166b1d7bfa51f477c22c33e6f773293b/modules/datamodel.js">comparison</a> |
<a href="/comm-central/log/dda758e6166b1d7bfa51f477c22c33e6f773293b/modules/datamodel.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/dda758e6166b1d7bfa51f477c22c33e6f773293b/modules/datastore.js">modules/datastore.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dda758e6166b1d7bfa51f477c22c33e6f773293b/modules/datastore.js">file</a> |
<a href="/comm-central/annotate/dda758e6166b1d7bfa51f477c22c33e6f773293b/modules/datastore.js">annotate</a> |
<a href="/comm-central/diff/dda758e6166b1d7bfa51f477c22c33e6f773293b/modules/datastore.js">diff</a> |
<a href="/comm-central/comparison/dda758e6166b1d7bfa51f477c22c33e6f773293b/modules/datastore.js">comparison</a> |
<a href="/comm-central/log/dda758e6166b1d7bfa51f477c22c33e6f773293b/modules/datastore.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/dda758e6166b1d7bfa51f477c22c33e6f773293b/modules/gloda.js">modules/gloda.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dda758e6166b1d7bfa51f477c22c33e6f773293b/modules/gloda.js">file</a> |
<a href="/comm-central/annotate/dda758e6166b1d7bfa51f477c22c33e6f773293b/modules/gloda.js">annotate</a> |
<a href="/comm-central/diff/dda758e6166b1d7bfa51f477c22c33e6f773293b/modules/gloda.js">diff</a> |
<a href="/comm-central/comparison/dda758e6166b1d7bfa51f477c22c33e6f773293b/modules/gloda.js">comparison</a> |
<a href="/comm-central/log/dda758e6166b1d7bfa51f477c22c33e6f773293b/modules/gloda.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/dda758e6166b1d7bfa51f477c22c33e6f773293b/modules/indexer.js">modules/indexer.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dda758e6166b1d7bfa51f477c22c33e6f773293b/modules/indexer.js">file</a> |
<a href="/comm-central/annotate/dda758e6166b1d7bfa51f477c22c33e6f773293b/modules/indexer.js">annotate</a> |
<a href="/comm-central/diff/dda758e6166b1d7bfa51f477c22c33e6f773293b/modules/indexer.js">diff</a> |
<a href="/comm-central/comparison/dda758e6166b1d7bfa51f477c22c33e6f773293b/modules/indexer.js">comparison</a> |
<a href="/comm-central/log/dda758e6166b1d7bfa51f477c22c33e6f773293b/modules/indexer.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/dda758e6166b1d7bfa51f477c22c33e6f773293b/test/resources/glodaTestHelper.js">test/resources/glodaTestHelper.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dda758e6166b1d7bfa51f477c22c33e6f773293b/test/resources/glodaTestHelper.js">file</a> |
<a href="/comm-central/annotate/dda758e6166b1d7bfa51f477c22c33e6f773293b/test/resources/glodaTestHelper.js">annotate</a> |
<a href="/comm-central/diff/dda758e6166b1d7bfa51f477c22c33e6f773293b/test/resources/glodaTestHelper.js">diff</a> |
<a href="/comm-central/comparison/dda758e6166b1d7bfa51f477c22c33e6f773293b/test/resources/glodaTestHelper.js">comparison</a> |
<a href="/comm-central/log/dda758e6166b1d7bfa51f477c22c33e6f773293b/test/resources/glodaTestHelper.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/dda758e6166b1d7bfa51f477c22c33e6f773293b/test/unit/test_index_messages.js">test/unit/test_index_messages.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dda758e6166b1d7bfa51f477c22c33e6f773293b/test/unit/test_index_messages.js">file</a> |
<a href="/comm-central/annotate/dda758e6166b1d7bfa51f477c22c33e6f773293b/test/unit/test_index_messages.js">annotate</a> |
<a href="/comm-central/diff/dda758e6166b1d7bfa51f477c22c33e6f773293b/test/unit/test_index_messages.js">diff</a> |
<a href="/comm-central/comparison/dda758e6166b1d7bfa51f477c22c33e6f773293b/test/unit/test_index_messages.js">comparison</a> |
<a href="/comm-central/log/dda758e6166b1d7bfa51f477c22c33e6f773293b/test/unit/test_index_messages.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/modules/datamodel.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/modules/datamodel.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -342,16 +342,53 @@ GlodaMessage.prototype = {</span>
<a href="#l1.4"></a><span id="l1.4">                    &quot; value: &quot; + attrParamVal[2]);</span>
<a href="#l1.5"></a><span id="l1.5">         }</span>
<a href="#l1.6"></a><span id="l1.6">       }</span>
<a href="#l1.7"></a><span id="l1.7">     }</span>
<a href="#l1.8"></a><span id="l1.8">     </span>
<a href="#l1.9"></a><span id="l1.9">     return attribs;</span>
<a href="#l1.10"></a><span id="l1.10">   },</span>
<a href="#l1.11"></a><span id="l1.11">   </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+  /**</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+   * Replace the set of attributes on us.  We need to make sure we purge</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+   *  existing cached values off this instance.  For simplicity and because of</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+   *  how we cache things currently (we define getters on the instance), we</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineplus">+   *  force the prototype-resident getters to be activated and to cache</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineplus">+   *  everything anew.  This is arguably wasteful; it might be better to go</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineplus">+   *  back to just using storage properties, possibly on a sub-object that</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineplus">+   *  we could just replace with a new one...</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineplus">+   * Note: We actually avoid doing this if the attributes weren't previously</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineplus">+   *  fetched.  Of course, since we do set _attributes with these new</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineplus">+   *  attributes, this check does not steady-state.</span>
<a href="#l1.23"></a><span id="l1.23" class="difflineplus">+   *</span>
<a href="#l1.24"></a><span id="l1.24" class="difflineplus">+   * @XXX Try and avoid compelling ourselves to cache every bound attribute.</span>
<a href="#l1.25"></a><span id="l1.25" class="difflineplus">+   */</span>
<a href="#l1.26"></a><span id="l1.26" class="difflineplus">+  _replaceAttributes: function gloda_message_replaceAttributes(aNewAttribs) {</span>
<a href="#l1.27"></a><span id="l1.27" class="difflineplus">+    let hadAttributes = this._attributes !== null;</span>
<a href="#l1.28"></a><span id="l1.28" class="difflineplus">+    this._attributes = aNewAttribs;</span>
<a href="#l1.29"></a><span id="l1.29" class="difflineplus">+    // if this guy didn't already have attributes, we don't actually need to</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineplus">+    //  do any caching work.</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineplus">+    if (!hadAttributes)</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineplus">+      return;</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineplus">+      </span>
<a href="#l1.34"></a><span id="l1.34" class="difflineplus">+    let seenDefs = {};</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineplus">+    for each (let attrParamVal in this._attributes) {</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineplus">+      let attrDef = attrParamVal[0];</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineplus">+      if (!(attrDef in seenDefs)) {</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineplus">+        if (attrDef.isBound) {</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineplus">+          // get the getter from our _prototype_ (not us!)</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineplus">+          let getterFunc = this.__proto__.__lookupGetter__(attrDef.boundName);</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineplus">+          // force the getter to do his work (on us)</span>
<a href="#l1.42"></a><span id="l1.42" class="difflineplus">+          getterFunc.call(this);</span>
<a href="#l1.43"></a><span id="l1.43" class="difflineplus">+          seenDefs[attrDef] = true;</span>
<a href="#l1.44"></a><span id="l1.44" class="difflineplus">+        }</span>
<a href="#l1.45"></a><span id="l1.45" class="difflineplus">+      }</span>
<a href="#l1.46"></a><span id="l1.46" class="difflineplus">+    }</span>
<a href="#l1.47"></a><span id="l1.47" class="difflineplus">+  },</span>
<a href="#l1.48"></a><span id="l1.48" class="difflineplus">+  </span>
<a href="#l1.49"></a><span id="l1.49">   getAttributeInstances: function gloda_message_getAttributeInstances(aAttr) {</span>
<a href="#l1.50"></a><span id="l1.50">     return [attrParamVal for each (attrParamVal in this.rawAttributes) if</span>
<a href="#l1.51"></a><span id="l1.51">             (attrParamVal[0] == aAttr)];</span>
<a href="#l1.52"></a><span id="l1.52">   },</span>
<a href="#l1.53"></a><span id="l1.53">   </span>
<a href="#l1.54"></a><span id="l1.54">   getSingleAttribute: function gloda_message_getSingleAttribute(aAttr) {</span>
<a href="#l1.55"></a><span id="l1.55">     let instances = this.getAttributeInstances(aAttr);</span>
<a href="#l1.56"></a><span id="l1.56">     if (instances.length &gt; 0)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/modules/datastore.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/modules/datastore.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -910,17 +910,22 @@ let GlodaDatastore = {</span>
<a href="#l2.4"></a><span id="l2.4">                this.dbConnection.lastErrorString + &quot; - &quot; + ex);</span>
<a href="#l2.5"></a><span id="l2.5">       }</span>
<a href="#l2.6"></a><span id="l2.6">     }</span>
<a href="#l2.7"></a><span id="l2.7">     </span>
<a href="#l2.8"></a><span id="l2.8">     let message = new GlodaMessage(this, messageID, folderID,</span>
<a href="#l2.9"></a><span id="l2.9">                             aMessageKey, aConversationID, null,</span>
<a href="#l2.10"></a><span id="l2.10">                             aDatePRTime ? new Date(aDatePRTime / 1000) : null,</span>
<a href="#l2.11"></a><span id="l2.11">                             aHeaderMessageID);</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-    GlodaCollectionManager.itemsAdded(message.NOUN_ID, [message]);</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+    </span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+    // We would love to notify the collection manager about the message at this</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+    //  point (at least if it's not a ghost), but we can't yet.  We need to wait</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineplus">+    //  until the attributes have been indexed, which means it's out of our</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineplus">+    //  hands.  (Gloda.processMessage does it.)</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineplus">+    </span>
<a href="#l2.19"></a><span id="l2.19">     return message;</span>
<a href="#l2.20"></a><span id="l2.20">   },</span>
<a href="#l2.21"></a><span id="l2.21">   </span>
<a href="#l2.22"></a><span id="l2.22">   get _updateMessageStatement() {</span>
<a href="#l2.23"></a><span id="l2.23">     let statement = this._createStatement(</span>
<a href="#l2.24"></a><span id="l2.24">       &quot;UPDATE messages SET folderID = :folderID, \</span>
<a href="#l2.25"></a><span id="l2.25">                            messageKey = :messageKey, \</span>
<a href="#l2.26"></a><span id="l2.26">                            conversationID = :conversationID, \</span>
<a href="#l2.27"></a><span id="l2.27" class="difflineat">@@ -949,16 +954,21 @@ let GlodaDatastore = {</span>
<a href="#l2.28"></a><span id="l2.28">     </span>
<a href="#l2.29"></a><span id="l2.29">     if (aBody) {</span>
<a href="#l2.30"></a><span id="l2.30">       let imts = this._insertMessageTextStatement;</span>
<a href="#l2.31"></a><span id="l2.31">       imts.params.docid = aMessage.id;</span>
<a href="#l2.32"></a><span id="l2.32">       imts.params.body = aBody;</span>
<a href="#l2.33"></a><span id="l2.33">       </span>
<a href="#l2.34"></a><span id="l2.34">       imts.execute();</span>
<a href="#l2.35"></a><span id="l2.35">     }</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineplus">+    </span>
<a href="#l2.37"></a><span id="l2.37" class="difflineplus">+    // In completely abstract theory, this is where we would call</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineplus">+    //  GlodaCollectionManager.itemsModified, except that the attributes may</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineplus">+    //  also have changed, so it's out of our hands.  (Gloda.processMessage</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineplus">+    //  handles it.)</span>
<a href="#l2.41"></a><span id="l2.41">   },</span>
<a href="#l2.42"></a><span id="l2.42"> </span>
<a href="#l2.43"></a><span id="l2.43">   updateMessageFoldersByKeyPurging:</span>
<a href="#l2.44"></a><span id="l2.44">       function gloda_ds_updateMessageFoldersByKeyPurging(aSrcFolderURI,</span>
<a href="#l2.45"></a><span id="l2.45">         aMessageKeys, aDestFolderURI) {</span>
<a href="#l2.46"></a><span id="l2.46">     let srcFolderID = this._mapFolderURI(aSrcFolderURI);</span>
<a href="#l2.47"></a><span id="l2.47">     let destFolderID = this._mapFolderURI(aDestFolderURI);</span>
<a href="#l2.48"></a><span id="l2.48">     </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/modules/gloda.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/modules/gloda.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -1276,45 +1276,64 @@ let Gloda = {</span>
<a href="#l3.4"></a><span id="l3.4">     let allAttribs = [];</span>
<a href="#l3.5"></a><span id="l3.5">   </span>
<a href="#l3.6"></a><span id="l3.6">     for(let i = 0; i &lt; this._attrProviderOrder.length; i++) {</span>
<a href="#l3.7"></a><span id="l3.7">       let attribs = this._attrProviderOrder[i].process(aMessage, aMsgHdr,</span>
<a href="#l3.8"></a><span id="l3.8">                                                        aMimeMsg, aIsNew);</span>
<a href="#l3.9"></a><span id="l3.9">       allAttribs = allAttribs.concat(attribs);</span>
<a href="#l3.10"></a><span id="l3.10">     }</span>
<a href="#l3.11"></a><span id="l3.11">     </span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+    // [attribute id, value] for for the database</span>
<a href="#l3.13"></a><span id="l3.13">     let outAttribs = [];</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+    // [attribute def, parameter, value] for memory usage</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+    let memAttribs = [];</span>
<a href="#l3.16"></a><span id="l3.16">     </span>
<a href="#l3.17"></a><span id="l3.17">     for(let iAttrib=0; iAttrib &lt; allAttribs.length; iAttrib++) {</span>
<a href="#l3.18"></a><span id="l3.18">       let attribDesc = allAttribs[iAttrib];</span>
<a href="#l3.19"></a><span id="l3.19">       </span>
<a href="#l3.20"></a><span id="l3.20">       // is it an (attributedef / attribute def id, value) tuple?</span>
<a href="#l3.21"></a><span id="l3.21">       if (attribDesc.length == 2) {</span>
<a href="#l3.22"></a><span id="l3.22">         // if it's already an attrib id, we can use the tuple outright</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineminus">-        if (typeof attribDesc[0] == &quot;number&quot;)</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineplus">+        if (typeof attribDesc[0] == &quot;number&quot;) {</span>
<a href="#l3.25"></a><span id="l3.25">           outAttribs.push(attribDesc);</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineminus">-        else</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineplus">+          let [attribDef, attribParam] =</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineplus">+            GlodaDatastore._attributeIDToDef[attribDesc[0]];</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineplus">+          memAttribs.push([attribDef, attribParam, attribDesc[1]]);</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineplus">+        }</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineplus">+        else {</span>
<a href="#l3.32"></a><span id="l3.32">           outAttribs.push([attribDesc[0].id, attribDesc[1]]);</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineplus">+          // the parameter is null if they just pass an attribute def</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineplus">+          memAttribs.push([attribDesc[0], null, attribDesc[1]]);</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineplus">+        }</span>
<a href="#l3.36"></a><span id="l3.36">       }</span>
<a href="#l3.37"></a><span id="l3.37">       // it must be an (attrib, parameter value, attrib value) tuple</span>
<a href="#l3.38"></a><span id="l3.38">       else {</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineplus">+        // just store it verbatim for memory purposes</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineplus">+        memAttribs.push(attribDesc);</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineplus">+      </span>
<a href="#l3.42"></a><span id="l3.42">         let attrib = attribDesc[0];</span>
<a href="#l3.43"></a><span id="l3.43">         let parameterValue = attribDesc[1];</span>
<a href="#l3.44"></a><span id="l3.44">         let attribID;</span>
<a href="#l3.45"></a><span id="l3.45">         if (parameterValue != null)</span>
<a href="#l3.46"></a><span id="l3.46">           attribID = attrib.bindParameter(parameterValue);</span>
<a href="#l3.47"></a><span id="l3.47">         else</span>
<a href="#l3.48"></a><span id="l3.48">           attribID = attrib.id;</span>
<a href="#l3.49"></a><span id="l3.49">         outAttribs.push([attribID, attribDesc[2]]);</span>
<a href="#l3.50"></a><span id="l3.50">       }</span>
<a href="#l3.51"></a><span id="l3.51">     }</span>
<a href="#l3.52"></a><span id="l3.52">     </span>
<a href="#l3.53"></a><span id="l3.53">     this._log.debug(&quot;about to insert: &quot; + outAttribs);</span>
<a href="#l3.54"></a><span id="l3.54">     </span>
<a href="#l3.55"></a><span id="l3.55">     GlodaDatastore.insertMessageAttributes(aMessage, outAttribs);</span>
<a href="#l3.56"></a><span id="l3.56" class="difflineplus">+    aMessage._replaceAttributes(memAttribs);</span>
<a href="#l3.57"></a><span id="l3.57" class="difflineplus">+    </span>
<a href="#l3.58"></a><span id="l3.58" class="difflineplus">+    if (aIsNew)</span>
<a href="#l3.59"></a><span id="l3.59" class="difflineplus">+      GlodaCollectionManager.itemsAdded(aMessage.NOUN_ID, [aMessage]);</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineplus">+    else</span>
<a href="#l3.61"></a><span id="l3.61" class="difflineplus">+      GlodaCollectionManager.itemsModified(aMessage.NOUN_ID, [aMessage]);</span>
<a href="#l3.62"></a><span id="l3.62">   },</span>
<a href="#l3.63"></a><span id="l3.63">   </span>
<a href="#l3.64"></a><span id="l3.64">   /**</span>
<a href="#l3.65"></a><span id="l3.65">    * Deprecated mechanism for querying for messages.  Use newQuery now,</span>
<a href="#l3.66"></a><span id="l3.66">    *  specifying the message noun id.  Still works for now, but not for long.</span>
<a href="#l3.67"></a><span id="l3.67">    */</span>
<a href="#l3.68"></a><span id="l3.68">   queryMessagesAPV: function gloda_ns_queryMessagesAPV(aAPVs) {</span>
<a href="#l3.69"></a><span id="l3.69">     return GlodaDatastore.queryMessagesAPV(aAPVs);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/modules/indexer.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/modules/indexer.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -222,21 +222,26 @@ let GlodaIndexer = {</span>
<a href="#l4.4"></a><span id="l4.4">     if (this._inited)</span>
<a href="#l4.5"></a><span id="l4.5">       return;</span>
<a href="#l4.6"></a><span id="l4.6">     </span>
<a href="#l4.7"></a><span id="l4.7">     this._inited = true;</span>
<a href="#l4.8"></a><span id="l4.8">     </span>
<a href="#l4.9"></a><span id="l4.9">     // create the timer that drives our intermittent indexing</span>
<a href="#l4.10"></a><span id="l4.10">     this._timer = Cc[&quot;@mozilla.org/timer;1&quot;].createInstance(Ci.nsITimer);</span>
<a href="#l4.11"></a><span id="l4.11"> </span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-    // register for folder loaded events...</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+    // register for:</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+    // - folder loaded events, so we know when updateFolder has finished</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+    //   updating the index/what not (if it was't immediately available)</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineplus">+    // - property changes (so we know when a message's read/starred state have</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineplus">+    //   changed.)</span>
<a href="#l4.18"></a><span id="l4.18">     let mailSession = Cc[&quot;@mozilla.org/messenger/services/session;1&quot;].</span>
<a href="#l4.19"></a><span id="l4.19">                         getService(Ci.nsIMsgMailSession);</span>
<a href="#l4.20"></a><span id="l4.20">     this._folderListener._init(this);</span>
<a href="#l4.21"></a><span id="l4.21">     mailSession.AddFolderListener(this._folderListener,</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineplus">+                                  Ci.nsIFolderListener.propertyFlagChanged |</span>
<a href="#l4.23"></a><span id="l4.23">                                   Ci.nsIFolderListener.event);</span>
<a href="#l4.24"></a><span id="l4.24"> </span>
<a href="#l4.25"></a><span id="l4.25">     // register for shutdown notification</span>
<a href="#l4.26"></a><span id="l4.26">     let observerService = Cc[&quot;@mozilla.org/observer-service;1&quot;].</span>
<a href="#l4.27"></a><span id="l4.27">                             getService(Ci.nsIObserverService);</span>
<a href="#l4.28"></a><span id="l4.28">     observerService.addObserver(this, &quot;xpcom-shutdown&quot;, false);</span>
<a href="#l4.29"></a><span id="l4.29"> </span>
<a href="#l4.30"></a><span id="l4.30">     // figure out if event-driven indexing should be enabled...</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineat">@@ -1128,16 +1133,40 @@ let GlodaIndexer = {</span>
<a href="#l4.32"></a><span id="l4.32">     indexer: null,</span>
<a href="#l4.33"></a><span id="l4.33">     _kFolderLoadedAtom: null,</span>
<a href="#l4.34"></a><span id="l4.34">     </span>
<a href="#l4.35"></a><span id="l4.35">     _init: function gloda_indexer_fl_init(aIndexer) {</span>
<a href="#l4.36"></a><span id="l4.36">       this.indexer = aIndexer;</span>
<a href="#l4.37"></a><span id="l4.37">       let atomService = Cc[&quot;@mozilla.org/atom-service;1&quot;].</span>
<a href="#l4.38"></a><span id="l4.38">                         getService(Ci.nsIAtomService);</span>
<a href="#l4.39"></a><span id="l4.39">       this._kFolderLoadedAtom = atomService.getAtom(&quot;FolderLoaded&quot;);</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineplus">+      // we explicitly know about these things rather than bothering with some</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineplus">+      //  form of registration scheme because these aren't going to change much.</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineplus">+      this._kStatusAtom = atomService.getAtom(&quot;Status&quot;);</span>
<a href="#l4.43"></a><span id="l4.43" class="difflineplus">+      this._kFlaggedAtom = atomService.getAtom(&quot;Flagged&quot;);</span>
<a href="#l4.44"></a><span id="l4.44" class="difflineplus">+      this._kJunkStatusChangedAtom = atomService.getAtom(&quot;JunkStatusChanged&quot;);</span>
<a href="#l4.45"></a><span id="l4.45" class="difflineplus">+    },</span>
<a href="#l4.46"></a><span id="l4.46" class="difflineplus">+    </span>
<a href="#l4.47"></a><span id="l4.47" class="difflineplus">+    /**</span>
<a href="#l4.48"></a><span id="l4.48" class="difflineplus">+     * Helper method to do the leg-work associated with flagging a message</span>
<a href="#l4.49"></a><span id="l4.49" class="difflineplus">+     *  for re-indexing because of some change in meta-state that happened to</span>
<a href="#l4.50"></a><span id="l4.50" class="difflineplus">+     *  it.  Job-wise, we treat this as a message addition; we are uniquely</span>
<a href="#l4.51"></a><span id="l4.51" class="difflineplus">+     *  identifying the message by providing its folder ID and message key, and</span>
<a href="#l4.52"></a><span id="l4.52" class="difflineplus">+     *  the indexer will cleanly map this to the existing gloda message.</span>
<a href="#l4.53"></a><span id="l4.53" class="difflineplus">+     */</span>
<a href="#l4.54"></a><span id="l4.54" class="difflineplus">+    _reindexChangedMessage: function(aMsgHdr) {</span>
<a href="#l4.55"></a><span id="l4.55" class="difflineplus">+      if (this.indexer._pendingAddJob === null) {</span>
<a href="#l4.56"></a><span id="l4.56" class="difflineplus">+        this.indexer._pendingAddJob = new IndexingJob(&quot;message&quot;, 1, null);</span>
<a href="#l4.57"></a><span id="l4.57" class="difflineplus">+        this.indexer._indexQueue.push(this.indexer._pendingAddJob);</span>
<a href="#l4.58"></a><span id="l4.58" class="difflineplus">+        this.indexer._indexingJobGoal++;</span>
<a href="#l4.59"></a><span id="l4.59" class="difflineplus">+      }</span>
<a href="#l4.60"></a><span id="l4.60" class="difflineplus">+      this.indexer._pendingAddJob.items.push(</span>
<a href="#l4.61"></a><span id="l4.61" class="difflineplus">+        [GlodaDatastore._mapFolderURI(aMsgHdr.folder.URI),</span>
<a href="#l4.62"></a><span id="l4.62" class="difflineplus">+         aMsgHdr.messageKey]);</span>
<a href="#l4.63"></a><span id="l4.63" class="difflineplus">+      this.indexer.indexing = true;</span>
<a href="#l4.64"></a><span id="l4.64">     },</span>
<a href="#l4.65"></a><span id="l4.65">   </span>
<a href="#l4.66"></a><span id="l4.66">     /**</span>
<a href="#l4.67"></a><span id="l4.67">      * Find out when folders are added or new messages show up in a newsgroup.</span>
<a href="#l4.68"></a><span id="l4.68">      */</span>
<a href="#l4.69"></a><span id="l4.69">     OnItemAdded: function gloda_indexer_OnItemAdded(aParentItem, aItem) {</span>
<a href="#l4.70"></a><span id="l4.70">     },</span>
<a href="#l4.71"></a><span id="l4.71">     </span>
<a href="#l4.72"></a><span id="l4.72" class="difflineat">@@ -1161,17 +1190,23 @@ let GlodaIndexer = {</span>
<a href="#l4.73"></a><span id="l4.73">                                 aItem, aProperty, aOldValue, aNewValue) {</span>
<a href="#l4.74"></a><span id="l4.74">     },</span>
<a href="#l4.75"></a><span id="l4.75">     OnItemUnicharPropertyChanged:</span>
<a href="#l4.76"></a><span id="l4.76">         function gloda_indexer_OnItemUnicharPropertyChanged(</span>
<a href="#l4.77"></a><span id="l4.77">           aItem, aProperty, aOldValue, aNewValue) {</span>
<a href="#l4.78"></a><span id="l4.78">       </span>
<a href="#l4.79"></a><span id="l4.79">     },</span>
<a href="#l4.80"></a><span id="l4.80">     OnItemPropertyFlagChanged: function gloda_indexer_OnItemPropertyFlagChanged(</span>
<a href="#l4.81"></a><span id="l4.81" class="difflineminus">-                                aItem, aProperty, aOldValue, aNewValue) {</span>
<a href="#l4.82"></a><span id="l4.82" class="difflineplus">+                                aMsgHdr, aProperty, aOldValue, aNewValue) {</span>
<a href="#l4.83"></a><span id="l4.83" class="difflineplus">+      if (aProperty == this._kStatusAtom ||</span>
<a href="#l4.84"></a><span id="l4.84" class="difflineplus">+          aProperty == this._kFlaggedAtom ||</span>
<a href="#l4.85"></a><span id="l4.85" class="difflineplus">+          aProperty == this._kJunkStatusChangedAtom) {</span>
<a href="#l4.86"></a><span id="l4.86" class="difflineplus">+        this.indexer._log.debug(&quot;ItemPropertyFlagChanged notification&quot;);</span>
<a href="#l4.87"></a><span id="l4.87" class="difflineplus">+        this._reindexChangedMessage(aMsgHdr);</span>
<a href="#l4.88"></a><span id="l4.88" class="difflineplus">+      }</span>
<a href="#l4.89"></a><span id="l4.89">     },</span>
<a href="#l4.90"></a><span id="l4.90">     </span>
<a href="#l4.91"></a><span id="l4.91">     /**</span>
<a href="#l4.92"></a><span id="l4.92">      * Get folder loaded notifications for folders that had to do some</span>
<a href="#l4.93"></a><span id="l4.93">      *  (asynchronous) processing before they could be opened.</span>
<a href="#l4.94"></a><span id="l4.94">      */</span>
<a href="#l4.95"></a><span id="l4.95">     OnItemEvent: function gloda_indexer_OnItemEvent(aFolder, aEvent) {</span>
<a href="#l4.96"></a><span id="l4.96">       if (aEvent == this._kFolderLoadedAtom)</span>
<a href="#l4.97"></a><span id="l4.97" class="difflineat">@@ -1207,17 +1242,18 @@ let GlodaIndexer = {</span>
<a href="#l4.98"></a><span id="l4.98">     onHdrPropertyChanged: function (aHdrToChange, aPreChange, aStatus,</span>
<a href="#l4.99"></a><span id="l4.99">                                     aInstigator) {},</span>
<a href="#l4.100"></a><span id="l4.100">   },</span>
<a href="#l4.101"></a><span id="l4.101">   </span>
<a href="#l4.102"></a><span id="l4.102">   /* ***** MailNews Shutdown ***** */</span>
<a href="#l4.103"></a><span id="l4.103">   // TODO: implement a shutdown/pre-shutdown listener that attempts to either</span>
<a href="#l4.104"></a><span id="l4.104">   //  drain the indexing queue or persist it.</span>
<a href="#l4.105"></a><span id="l4.105">   /**</span>
<a href="#l4.106"></a><span id="l4.106" class="difflineminus">-   * Shutdown task.  THIS IS NOT HOOKED UP TO ANYTHING YET.</span>
<a href="#l4.107"></a><span id="l4.107" class="difflineplus">+   * Shutdown task.  THIS IS NOT HOOKED UP TO ANYTHING YET.  THIS IS PROBABLY</span>
<a href="#l4.108"></a><span id="l4.108" class="difflineplus">+   *  NOT HOW WE WANT TO HANDLE THINGS EITHER.</span>
<a href="#l4.109"></a><span id="l4.109">    *</span>
<a href="#l4.110"></a><span id="l4.110">    * We implement nsIMsgShutdownTask, served up by nsIMsgShutdownService.  We</span>
<a href="#l4.111"></a><span id="l4.111">    *  offer our services by registering ourselves as a &quot;msg-shutdown&quot; observer</span>
<a href="#l4.112"></a><span id="l4.112">    *  with the observer service.</span>
<a href="#l4.113"></a><span id="l4.113">    */</span>
<a href="#l4.114"></a><span id="l4.114">   _shutdownTask: {</span>
<a href="#l4.115"></a><span id="l4.115">     indexer: null,</span>
<a href="#l4.116"></a><span id="l4.116">     </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/test/resources/glodaTestHelper.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/test/resources/glodaTestHelper.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -68,16 +68,19 @@ function indexMessages(aSynthMessages, a</span>
<a href="#l5.4"></a><span id="l5.4">     prefSvc.setBoolPref(&quot;mail.biff.show_alert&quot;, false);</span>
<a href="#l5.5"></a><span id="l5.5">     prefSvc.setBoolPref(&quot;mail.biff.show_tray_icon&quot;, false);</span>
<a href="#l5.6"></a><span id="l5.6">     prefSvc.setBoolPref(&quot;mail.biff.animate_dock_icon&quot;, false);</span>
<a href="#l5.7"></a><span id="l5.7">   </span>
<a href="#l5.8"></a><span id="l5.8">     Gloda.addIndexerListener(messageIndexerListener.onIndexNotification);</span>
<a href="#l5.9"></a><span id="l5.9">     ims.catchAllCollection = Gloda._wildcardCollection(Gloda.NOUN_MESSAGE);</span>
<a href="#l5.10"></a><span id="l5.10">     ims.catchAllCollection.listener = messageCollectionListener;</span>
<a href="#l5.11"></a><span id="l5.11">     </span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+    // The indexer doesn't need to worry about load; zero his rescheduling time. </span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+    //GlodaIndexer._indexInterval = 0;</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+    </span>
<a href="#l5.15"></a><span id="l5.15">     // set up POP3 fakeserver to feed things in...</span>
<a href="#l5.16"></a><span id="l5.16">     [ims.daemon, ims.server] = setupServerDaemon();</span>
<a href="#l5.17"></a><span id="l5.17">     ims.incomingServer = createPop3ServerAndLocalFolders();</span>
<a href="#l5.18"></a><span id="l5.18"> </span>
<a href="#l5.19"></a><span id="l5.19">     ims.pop3Service = Cc[&quot;@mozilla.org/messenger/popservice;1&quot;]</span>
<a href="#l5.20"></a><span id="l5.20">                         .getService(Ci.nsIPop3Service);</span>
<a href="#l5.21"></a><span id="l5.21">     </span>
<a href="#l5.22"></a><span id="l5.22">     ims.inited = true;</span>
<a href="#l5.23"></a><span id="l5.23" class="difflineat">@@ -152,17 +155,17 @@ var indexMessageState = {</span>
<a href="#l5.24"></a><span id="l5.24">  * </span>
<a href="#l5.25"></a><span id="l5.25">  * @param aMessages The messages that will be modified and we should expect</span>
<a href="#l5.26"></a><span id="l5.26">  *   notifications about.  We currently don't do anything with these other than</span>
<a href="#l5.27"></a><span id="l5.27">  *   count them, so pass whatever you want and it will be the 'source message'</span>
<a href="#l5.28"></a><span id="l5.28">  *   (1st argument) to your verifier function.</span>
<a href="#l5.29"></a><span id="l5.29">  * @param aVerifier See indexMessage's aVerifier argument.</span>
<a href="#l5.30"></a><span id="l5.30">  * @param aDone The (optional) callback to call on completion.</span>
<a href="#l5.31"></a><span id="l5.31">  */</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineminus">-function expectModifiedMessages(aMessages, aVerifier, aDone) {</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineplus">+function expectModifiedMessages(aMessages, aVerifier, aOnDone) {</span>
<a href="#l5.34"></a><span id="l5.34">   let ims = indexMessageState;</span>
<a href="#l5.35"></a><span id="l5.35">   </span>
<a href="#l5.36"></a><span id="l5.36">   ims.inputMessages = aMessages;</span>
<a href="#l5.37"></a><span id="l5.37">   ims.glodaMessages = [];</span>
<a href="#l5.38"></a><span id="l5.38">   ims.verifier = aVerifier;</span>
<a href="#l5.39"></a><span id="l5.39">   ims.previousValue = undefined;</span>
<a href="#l5.40"></a><span id="l5.40">   ims.onDone = aOnDone;</span>
<a href="#l5.41"></a><span id="l5.41">   </span>
<a href="#l5.42"></a><span id="l5.42" class="difflineat">@@ -259,16 +262,19 @@ var messageCollectionListener = {</span>
<a href="#l5.43"></a><span id="l5.43">  *  been processed.</span>
<a href="#l5.44"></a><span id="l5.44">  */</span>
<a href="#l5.45"></a><span id="l5.45"> var messageIndexerListener = {</span>
<a href="#l5.46"></a><span id="l5.46">   onIndexNotification: function(aStatus, aPrettyName, aJobIndex, aJobTotal,</span>
<a href="#l5.47"></a><span id="l5.47">                                 aJobItemIndex, aJobItemGoal) {</span>
<a href="#l5.48"></a><span id="l5.48">     // we only care if indexing has just completed...</span>
<a href="#l5.49"></a><span id="l5.49">     if (!GlodaIndexer.indexing) {</span>
<a href="#l5.50"></a><span id="l5.50">       let ims = indexMessageState;</span>
<a href="#l5.51"></a><span id="l5.51" class="difflineplus">+</span>
<a href="#l5.52"></a><span id="l5.52" class="difflineplus">+dump(&quot;indexing check: &quot; + ims.glodaMessages.length + &quot; vs &quot; +</span>
<a href="#l5.53"></a><span id="l5.53" class="difflineplus">+     ims.inputMessages.length + &quot;\n&quot;);</span>
<a href="#l5.54"></a><span id="l5.54">       </span>
<a href="#l5.55"></a><span id="l5.55">       // if we haven't seen all the messages we should see, assume that the</span>
<a href="#l5.56"></a><span id="l5.56">       //  rest are on their way, and are just coming in a subsequent job...</span>
<a href="#l5.57"></a><span id="l5.57">       // (Also, the first time we register our listener, we will get a synthetic</span>
<a href="#l5.58"></a><span id="l5.58">       //  idle status; at least if the indexer is idle.)</span>
<a href="#l5.59"></a><span id="l5.59">       if (ims.glodaMessages.length &lt; ims.inputMessages.length) {</span>
<a href="#l5.60"></a><span id="l5.60">         return;</span>
<a href="#l5.61"></a><span id="l5.61">       }</span>
<a href="#l5.62"></a><span id="l5.62" class="difflineat">@@ -415,30 +421,31 @@ function permute(aArray, aPermutationId)</span>
<a href="#l5.63"></a><span id="l5.63"> </span>
<a href="#l5.64"></a><span id="l5.64"> var glodaHelperTests = [];</span>
<a href="#l5.65"></a><span id="l5.65"> var glodaHelperIterator = null;</span>
<a href="#l5.66"></a><span id="l5.66"> </span>
<a href="#l5.67"></a><span id="l5.67"> function _gh_test_iterator() {</span>
<a href="#l5.68"></a><span id="l5.68">   do_test_pending();</span>
<a href="#l5.69"></a><span id="l5.69"> </span>
<a href="#l5.70"></a><span id="l5.70">   for (let iTest=0; iTest &lt; glodaHelperTests.length; iTest++) {</span>
<a href="#l5.71"></a><span id="l5.71" class="difflineplus">+    dump(&quot;====== Test function: &quot; + glodaHelperTests[iTest].name + &quot;\n&quot;);</span>
<a href="#l5.72"></a><span id="l5.72">     yield glodaHelperTests[iTest]();</span>
<a href="#l5.73"></a><span id="l5.73">   }</span>
<a href="#l5.74"></a><span id="l5.74"> </span>
<a href="#l5.75"></a><span id="l5.75">   killFakeServer();</span>
<a href="#l5.76"></a><span id="l5.76">   do_test_finished();</span>
<a href="#l5.77"></a><span id="l5.77">   </span>
<a href="#l5.78"></a><span id="l5.78">   // once the control flow hits the root after do_test_finished, we're done,</span>
<a href="#l5.79"></a><span id="l5.79">   //  so let's just yield something to avoid callers having to deal with an</span>
<a href="#l5.80"></a><span id="l5.80">   //  exception indicating completion.</span>
<a href="#l5.81"></a><span id="l5.81">   glodaHelperIterator = null;</span>
<a href="#l5.82"></a><span id="l5.82">   yield null;</span>
<a href="#l5.83"></a><span id="l5.83"> }</span>
<a href="#l5.84"></a><span id="l5.84"> </span>
<a href="#l5.85"></a><span id="l5.85" class="difflineminus">-function gh_next_test() {</span>
<a href="#l5.86"></a><span id="l5.86" class="difflineplus">+function next_test() {</span>
<a href="#l5.87"></a><span id="l5.87">   glodaHelperIterator.next();</span>
<a href="#l5.88"></a><span id="l5.88"> }</span>
<a href="#l5.89"></a><span id="l5.89"> </span>
<a href="#l5.90"></a><span id="l5.90"> function glodaHelperRunTests(aTests) {</span>
<a href="#l5.91"></a><span id="l5.91">   glodaHelperTests = aTests;</span>
<a href="#l5.92"></a><span id="l5.92">   glodaHelperIterator = _gh_test_iterator();</span>
<a href="#l5.93"></a><span id="l5.93" class="difflineminus">-  gh_next_test();</span>
<a href="#l5.94"></a><span id="l5.94" class="difflineplus">+  next_test();</span>
<a href="#l5.95"></a><span id="l5.95"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/test/unit/test_index_messages.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/test/unit/test_index_messages.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -1,18 +1,15 @@</span>
<a href="#l6.4"></a><span id="l6.4"> /* This file tests our indexing prowess.  This includes both our ability to</span>
<a href="#l6.5"></a><span id="l6.5">  *  properly be triggered by events taking place in thunderbird as well as our</span>
<a href="#l6.6"></a><span id="l6.6">  *  ability to correctly extract/index the right data.</span>
<a href="#l6.7"></a><span id="l6.7">  * In general, if these tests pass, things are probably working quite well.</span>
<a href="#l6.8"></a><span id="l6.8" class="difflineminus">- */</span>
<a href="#l6.9"></a><span id="l6.9" class="difflineminus">-</span>
<a href="#l6.10"></a><span id="l6.10" class="difflineminus">-/*</span>
<a href="#l6.11"></a><span id="l6.11" class="difflineminus">- * NOTE: This file currently has a bunch of helper logic that needs to be pushed</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">- *  into glodaTestHelper.js or someplace else nice.  (glodaTestHelper is also</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">- *  going to need some refactoring to be sane inside.)</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+ *</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineplus">+ * Things we don't test that you think we might test:</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineplus">+ * - Full-text search.  Happens in query testing.</span>
<a href="#l6.17"></a><span id="l6.17">  */</span>
<a href="#l6.18"></a><span id="l6.18"> </span>
<a href="#l6.19"></a><span id="l6.19"> do_import_script(&quot;../mailnews/db/global/test/resources/messageGenerator.js&quot;);</span>
<a href="#l6.20"></a><span id="l6.20"> </span>
<a href="#l6.21"></a><span id="l6.21"> do_import_script(&quot;../mailnews/test/resources/mailDirService.js&quot;);</span>
<a href="#l6.22"></a><span id="l6.22"> do_import_script(&quot;../mailnews/test/resources/mailTestUtils.js&quot;);</span>
<a href="#l6.23"></a><span id="l6.23"> do_import_script(&quot;../mailnews/db/global/test/resources/glodaTestHelper.js&quot;);</span>
<a href="#l6.24"></a><span id="l6.24"> </span>
<a href="#l6.25"></a><span id="l6.25" class="difflineat">@@ -107,68 +104,70 @@ function expl_attr_verify_tags(smsg, gms</span>
<a href="#l6.26"></a><span id="l6.26"> }</span>
<a href="#l6.27"></a><span id="l6.27"> </span>
<a href="#l6.28"></a><span id="l6.28"> var explicitAttributeTwiddlings = [</span>
<a href="#l6.29"></a><span id="l6.29">   // toggle starred</span>
<a href="#l6.30"></a><span id="l6.30">   [expl_attr_twiddle_star, expl_attr_verify_star, true],</span>
<a href="#l6.31"></a><span id="l6.31">   [expl_attr_twiddle_star, expl_attr_verify_star, false],</span>
<a href="#l6.32"></a><span id="l6.32">   // toggle read/unread</span>
<a href="#l6.33"></a><span id="l6.33">   [expl_attr_twiddle_read, expl_attr_verify_read, true],</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineminus">-  [expl_attr_twiddle_read, expl_attr_verify_read, false],</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineplus">+  [expl_attr_twiddle_read, expl_attr_verify_read, false]/*,</span>
<a href="#l6.36"></a><span id="l6.36">   // twiddle tags</span>
<a href="#l6.37"></a><span id="l6.37">   [expl_attr_twiddle_tags, expl_attr_verify_tags,</span>
<a href="#l6.38"></a><span id="l6.38">    [1, &quot;funky&quot;], [&quot;funky&quot;]],</span>
<a href="#l6.39"></a><span id="l6.39">   [expl_attr_twiddle_tags, expl_attr_verify_tags,</span>
<a href="#l6.40"></a><span id="l6.40">    [1, &quot;town&quot;], [&quot;funky&quot;, &quot;town&quot;]],</span>
<a href="#l6.41"></a><span id="l6.41">   [expl_attr_twiddle_tags, expl_attr_verify_tags,</span>
<a href="#l6.42"></a><span id="l6.42">    [-1, &quot;funky&quot;], [&quot;town&quot;]],</span>
<a href="#l6.43"></a><span id="l6.43">   [expl_attr_twiddle_tags, expl_attr_verify_tags,</span>
<a href="#l6.44"></a><span id="l6.44">    [-1, &quot;town&quot;], []],</span>
<a href="#l6.45"></a><span id="l6.45" class="difflineplus">+*/</span>
<a href="#l6.46"></a><span id="l6.46"> ];</span>
<a href="#l6.47"></a><span id="l6.47"> </span>
<a href="#l6.48"></a><span id="l6.48"> </span>
<a href="#l6.49"></a><span id="l6.49"> function test_attributes_explicit() {</span>
<a href="#l6.50"></a><span id="l6.50">   // create a synthetic message</span>
<a href="#l6.51"></a><span id="l6.51">   let smsg = msgGen.makeMessage();</span>
<a href="#l6.52"></a><span id="l6.52"> </span>
<a href="#l6.53"></a><span id="l6.53">   let iTwiddling = 0;</span>
<a href="#l6.54"></a><span id="l6.54">   function twiddle_next_attr(smsg, gmsg) {</span>
<a href="#l6.55"></a><span id="l6.55" class="difflineplus">+dump(&quot;twiddle next\n&quot;);</span>
<a href="#l6.56"></a><span id="l6.56">     let curTwiddling = explicitAttributeTwiddlings[iTwiddling];</span>
<a href="#l6.57"></a><span id="l6.57">     let twiddleFunc = curTwiddling[0];</span>
<a href="#l6.58"></a><span id="l6.58">     let desiredState = curTwiddling[2];</span>
<a href="#l6.59"></a><span id="l6.59">     </span>
<a href="#l6.60"></a><span id="l6.60">     // the underlying nsIMsgDBHdr should exist at this point...</span>
<a href="#l6.61"></a><span id="l6.61">     do_check_neq(gmsg.folderMessage, null);</span>
<a href="#l6.62"></a><span id="l6.62">     // prepare </span>
<a href="#l6.63"></a><span id="l6.63">     expectModifiedMessages([gmsg.folderMessage], verify_next_attr);</span>
<a href="#l6.64"></a><span id="l6.64">     // tell the function to perform its mutation to the desired state</span>
<a href="#l6.65"></a><span id="l6.65">     twiddleFunc(gmsg.folderMessage, desiredState);</span>
<a href="#l6.66"></a><span id="l6.66">   }</span>
<a href="#l6.67"></a><span id="l6.67">   function verify_next_attr(smsg, gmsg) {</span>
<a href="#l6.68"></a><span id="l6.68" class="difflineplus">+dump(&quot;verify next\n&quot;);</span>
<a href="#l6.69"></a><span id="l6.69">     let curTwiddling = explicitAttributeTwiddlings[iTwiddling];</span>
<a href="#l6.70"></a><span id="l6.70">     let verifyFunc = curTwiddling[1];</span>
<a href="#l6.71"></a><span id="l6.71">     let expectedVal = curTwiddling[curTwiddling.length == 3 ? 2 : 3];</span>
<a href="#l6.72"></a><span id="l6.72">     verifyFunc(smsg, gmsg, expectedVal);</span>
<a href="#l6.73"></a><span id="l6.73">     </span>
<a href="#l6.74"></a><span id="l6.74" class="difflineminus">-    iTwiddling++;</span>
<a href="#l6.75"></a><span id="l6.75" class="difflineminus">-    if (iTwiddling &lt; explicitAttributeTwiddlings.length)</span>
<a href="#l6.76"></a><span id="l6.76" class="difflineminus">-      twiddle_next_attr();</span>
<a href="#l6.77"></a><span id="l6.77" class="difflineplus">+    if (++iTwiddling &lt; explicitAttributeTwiddlings.length)</span>
<a href="#l6.78"></a><span id="l6.78" class="difflineplus">+      twiddle_next_attr(smsg, gmsg);</span>
<a href="#l6.79"></a><span id="l6.79">     else</span>
<a href="#l6.80"></a><span id="l6.80">       next_test();</span>
<a href="#l6.81"></a><span id="l6.81">   }</span>
<a href="#l6.82"></a><span id="l6.82">   </span>
<a href="#l6.83"></a><span id="l6.83">   indexMessages([smsg], twiddle_next_attr);</span>
<a href="#l6.84"></a><span id="l6.84"> }</span>
<a href="#l6.85"></a><span id="l6.85"> </span>
<a href="#l6.86"></a><span id="l6.86" class="difflineminus">-/**</span>
<a href="#l6.87"></a><span id="l6.87" class="difflineminus">- * Test our full-text searching support for messages.</span>
<a href="#l6.88"></a><span id="l6.88" class="difflineminus">- */</span>
<a href="#l6.89"></a><span id="l6.89" class="difflineminus">-function test_message_fulltext() {</span>
<a href="#l6.90"></a><span id="l6.90" class="difflineminus">-  </span>
<a href="#l6.91"></a><span id="l6.91" class="difflineminus">-}</span>
<a href="#l6.92"></a><span id="l6.92" class="difflineplus">+/* ===== Message Moving ===== */</span>
<a href="#l6.93"></a><span id="l6.93" class="difflineplus">+</span>
<a href="#l6.94"></a><span id="l6.94" class="difflineplus">+/* ===== Message Deletion ===== */</span>
<a href="#l6.95"></a><span id="l6.95" class="difflineplus">+</span>
<a href="#l6.96"></a><span id="l6.96" class="difflineplus">+/* ===== Folder Move/Rename/Copy (Single and Nested) ===== */</span>
<a href="#l6.97"></a><span id="l6.97" class="difflineplus">+</span>
<a href="#l6.98"></a><span id="l6.98"> </span>
<a href="#l6.99"></a><span id="l6.99"> var tests = [</span>
<a href="#l6.100"></a><span id="l6.100">   test_threading,</span>
<a href="#l6.101"></a><span id="l6.101">   test_attributes_fundamental,</span>
<a href="#l6.102"></a><span id="l6.102">   test_attributes_explicit,</span>
<a href="#l6.103"></a><span id="l6.103"> ];</span>
<a href="#l6.104"></a><span id="l6.104"> </span>
<a href="#l6.105"></a><span id="l6.105"> function run_test() {</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

